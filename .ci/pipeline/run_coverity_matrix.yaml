---
job: "run-coverity"

credentials:
  - {
      credentialsId: "bc9a18d3-1153-449c-b924-7fc9249c9cc0",
      usernameVariable: "UCC_USERNAME",
      passwordVariable: "UCC_PASSWORD",
    }

registry_host: "harbor.mellanox.com"
registry_path: "/torch-ucc"
registry_auth: "ucc-harbor-credentials"

kubernetes:
  cloud: il-ipp-blossom-prod
  namespace: hpcx
  limits: "{memory: 16Gi, cpu: 16000m}"
  requests: "{memory: 16Gi, cpu: 16000m}"

# Mount host Coverity install so container can use it (set COVERITY_HOME to path under /hpc/local if needed)
volumes:
  - {mountPath: /hpc/local, hostPath: /hpc/local}

runs_on_dockers:
  - {
      file: ".ci/dockerfiles/Dockerfile.coverity",
      # url: "harbor.mellanox.com/torch-ucc/x86_64/coverity:20260223",
      name: "coverity",
      tag: "20260223",
      arch: "x86_64",
      build_args: "--build-arg CUDA_VER=${CUDA_VER}",
    }

env:
  CUDA_VER: 13.1.0

timeout_minutes: 60

steps:
  - name: Run Coverity
    credentialsId: "bc9a18d3-1153-449c-b924-7fc9249c9cc0"
    containerSelector: "{name: 'coverity'}"
    run: |
      export UCC_PASSWORD=$UCC_PASSWORD
      export UCC_USERNAME=$UCC_USERNAME
      export MODULEPATH="${MODULEPATH:+${MODULEPATH}:}/hpc/local/etc/modulefiles"
      echo "Running coverity"
      sleep 4h
      ${WORKSPACE}/.ci/scripts/coverity.sh
    archiveArtifacts: .ci/scripts/cov-build/*
