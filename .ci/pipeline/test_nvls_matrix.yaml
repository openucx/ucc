---
job: "ucc-test-nvls"

step_allow_single_selector: true

registry_host: "harbor.mellanox.com"
registry_path: "/torch-ucc"
registry_auth: "ucc-harbor-credentials"

credentials:
  - {
      credentialsId: "ucc-harbor-credentials",
      usernameVariable: "REGISTRY_USERNAME",
      passwordVariable: "REGISTRY_PASSWORD",
    }

volumes:
  - { mountPath: "/home/svcnbu-swx-hpcx", hostPath: "/labhome/svcnbu-swx-hpcx" }

env:
  CUDA_VER: 13.0
  UCC_URI_SUFFIX: "ucc/${UCC_VERSION}/aarch64/ubuntu24.04/cuda${CUDA_VER}"
  DOCKER_IMAGE_TAG: "${BUILD_NUMBER}"
  SLURM_NODES: 2
  SLURM_PARTITION: 'gb300nvl72_ci'
  SLURM_HEAD_NODE: 'dlcluster.nvidia.com'
  SLURM_ACCOUNT: 'blackwell-ci'
  SLURM_JOB_NAME: 'ucc-ci-test-nvls-${BUILD_NUMBER}'
  SLURM_JOB_TIMEOUT: '00:30:00'
  TEST_TIMEOUT_MINUTES: 35

kubernetes:
  cloud: il-ipp-blossom-prod
  namespace: hpcx
  limits: "{memory: 16Gi, cpu: 16000m}"
  requests: "{memory: 8Gi, cpu: 8000m}"

# cloud pod to build the shared docker image
runs_on_dockers:
  - {
      file: ".ci/Dockerfile.ngc_pytorch",
      name: "ngc_pytorch",
      tag: "${DOCKER_IMAGE_TAG}",
      arch: "aarch64",
      uri: "${UCC_URI_SUFFIX}",
      build_args: "--no-cache --build-arg ARCH=aarch64 --build-arg OS=ubuntu24.04 --build-arg CUDA_VER=${CUDA_VER} --build-arg _UID=149917 --build-arg _GID=30 --build-arg _LOGIN=svcnbu-swx-hpcx --build-arg _GROUP=svcnbu-swx-hpcx --build-arg UCC_ENABLE_NVLS=yes --build-arg UCC_ENABLE_GTEST=no",
    }
  - {
      file: ".ci/dockerfiles/Dockerfile.build_helper",
      name: "build_helper",
      tag: "nvls",
      arch: "x86_64",
      uri: "$arch/$name",
      build_args: "--build-arg _UID=149917 --build-arg _GID=30 --build-arg _LOGIN=svcnbu-swx-hpcx --build-arg _GROUP=svcnbu-swx-hpcx",
    }

timeout_minutes: 180

steps:
  - name: Allocate Environment
    containerSelector: "{name: 'build_helper'}"
    credentialsId: "ucc-harbor-credentials"
    run: |
      export ENROOT_USERNAME=${REGISTRY_USERNAME}
      export ENROOT_PASSWORD=${REGISTRY_PASSWORD}
      export ENROOT_REGISTRY=${registry_host}
      set -x
      touch job_id.txt && chown svcnbu-swx-hpcx job_id.txt
      sudo -E -u svcnbu-swx-hpcx ${WORKSPACE}/.ci/scripts/run_slurm_allocation.sh

  - name: Run UCC NVLS tests
    containerSelector: "{name: 'build_helper'}"
    timeout: "${TEST_TIMEOUT_MINUTES}"
    run: |
      set -x
      export DOCKER_IMAGE_NAME="${registry_host}#torch-ucc/${UCC_URI_SUFFIX}:${DOCKER_IMAGE_TAG}"
      export SLURM_JOB_ID=$(cat ${WORKSPACE}/job_id.txt)
      sudo -E -u svcnbu-swx-hpcx ${WORKSPACE}/.ci/scripts/run_tests_ucc_nvls_slurm.sh
    always: |
      sudo -E -u svcnbu-swx-hpcx ${WORKSPACE}/.ci/scripts/stop_slurm_allocation.sh
