# Jenkins Job Builder (JJB) configuration for UCC project
# This file defines the CI/CD pipeline structure using Jenkins Job Builder templates
# The configuration is split into two main job templates and a project definition

# Template for the dispatcher job that handles GitHub webhook events
# This job acts as the entry point for CI/CD pipeline and manages the build process
- job-template:
    name: "{jjb_proj}-dispatcher"  # Will be expanded to 'ucc-ci-dispatcher'
    project-type: pipeline
    folder: "{jjb_folder}"
    properties:
        # GitHub integration settings
        - github:
            url: "{jjb_gh_url}"
        # Build history retention policy
        - build-discarder:
            days-to-keep: 14        # Keep builds for 14 days
            num-to-keep: 1000        # Or keep last 1000 builds, whichever comes first
        # Inject project-specific variables
        - inject:
            keep-system-variables: true
            properties-content: |
              jjb_proj={jjb_proj}-dispatcher
    # Configure webhook trigger for GitHub events
    triggers:
        - generic-webhook-trigger:
            token: "{jjb_proj}-dispatcher"  # Unique token for webhook identification
            print-contributors: true        # Log who triggered the build
            print-posted-content: true      # Log webhook payload
            silent-response: false          # Return detailed response
            cause: "Generic Cause"
            # Extract data from webhook payload
            post-content-params:
            - type: JSONPath
              key: githubData
              value: $
            - type: JSONPath
              key: VARIABLE_FROM_POST
              value: $
    description: Do NOT edit this job through the Web GUI !  # Manual edits will be overwritten
    concurrent: true    # Allow multiple builds to run simultaneously
    sandbox: true      # Run in sandbox mode for security
    parameters:
        - string:
            name: "VARIABLE_FROM_POST"
            default: ""
            description: ""
    # Pipeline script that handles the build process
    dsl: |
        @Library('blossom-github-lib@master')  // Use custom GitHub library
        import ipp.blossom.*
        // Authenticate with GitHub using stored credentials
        withCredentials([usernamePassword(credentialsId: 'svcnbu-swx-hpcx-github-token', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {{
          githubHelper = GithubHelper.getInstance("${{GIT_PASSWORD}}", VARIABLE_FROM_POST)
        }}
        // Update GitHub commit status
        githubHelper.updateCommitStatus("$BUILD_URL", "Blossom CI started", GitHubCommitState.PENDING)
        currentBuild.description = githubHelper.getBuildDescription()
        try {{
            parallel build: {{
                // Trigger the 'ucc' job
                def buildJob = 'ucc'
                def build = build job: buildJob, parameters: [
                    string(name: 'sha1', value: githubHelper.getMergedSHA())
                ], propagate: false
                currentBuild.description += "<br>Job: <a href='${{JENKINS_URL}}blue/organizations/jenkins/UCC%2F${{buildJob}}/detail/${{buildJob}}/${{build.number}}/pipeline/'>${{buildJob}}</a> Result: <b style='color:${{build.result == 'SUCCESS' ? 'green' : 'red'}}'>${{build.result}}</b>"
                if (!build.resultIsBetterOrEqualTo('SUCCESS')) {{
                  currentBuild.result = build.result
                  error("Job ${{buildJob}} failed")
                }}
            }}, hpcsdk: {{
                // Trigger the 'ucc-build-hpcsdk' job
                def buildJob = 'ucc-build-hpcsdk'
                def build = build job: buildJob, parameters: [
                    string(name: 'sha1', value: githubHelper.getMergedSHA())
                ], propagate: false
                currentBuild.description += "<br>Job: <a href='${{JENKINS_URL}}blue/organizations/jenkins/UCC%2F${{buildJob}}/detail/${{buildJob}}/${{build.number}}/pipeline/'>${{buildJob}}</a> Result: <b style='color:${{build.result == 'SUCCESS' ? 'green' : 'red'}}'>${{build.result}}</b>"
                if (!build.resultIsBetterOrEqualTo('SUCCESS')) {{
                  currentBuild.result = build.result
                  error("Job ${{buildJob}} failed")
                }}
            }}

            githubHelper.updateCommitStatus("$BUILD_URL", "Blossom CI successeded", GitHubCommitState.SUCCESS)
        }} catch(Exception ex) {{
            // Handle build failures
            currentBuild.result = 'FAILURE'
            println ex
            githubHelper.updateCommitStatus("$BUILD_URL", "Blossom CI failed", GitHubCommitState.FAILURE)
            error("failed")
        }}

# Project definition that instantiates the job templates
# This section defines the actual jobs that will be created
- project:
    name: ucc
    jjb_proj: 'ucc-ci'           # Project prefix for job names
    jjb_git: 'git@github.com:openucx/ucc.git'  # Repository URL
    # jjb_jenkinsfile not needed for dispatcher only project
    jjb_folder: 'UCC'
    jjb_branch: 'master'            # Default branch
    jjb_gh_url: 'https://github.com/openucx/ucc'  # GitHub web URL
    jobs:
        - "{jjb_proj}-dispatcher"  # Create dispatcher job
