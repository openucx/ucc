- job-template:
    name: "{jjb_proj}"
    project-type: pipeline
    properties:
      - github:
          url: "{jjb_git_web}"
      - build-discarder:
          days-to-keep: 30
          num-to-keep: 20
      - inject:
          keep-system-variables: true
          properties-content: |
            jjb_proj={jjb_proj}
    description: Do NOT edit this job through the Web GUI !
    concurrent: true
    sandbox: true
    parameters:
      - string:
          name: "sha1"
          default: "master"
          description: "Commit to be checked, set by PR"
      - bool:
          name: "build_dockers"
          default: true
          description: "Rebuild docker containers"
      - string:
          name: "conf_file"
          default: ".ci/job_matrix.yaml"
          description: "Regex to select job config file"
      - string:
          name: "script"
          default: "{jjb_jenkinsfile}"
          description: "Jenkinsfile to load on trigger"
      - string:
          name: "DEBUG"
          default: 0
          description: "Enable debug prints and traces, valid values are 0-9"
      - string:
          name: "UCC_VERSION"
          default: "1.0.0"
          description: "UCC version"
      - string:
          name: "githubData"
          default: ""
          description: "Variables from post"
    pipeline-scm:
      scm:
        - git:
            url: "{jjb_git}"
            credentials-id: "{jjb_gh_auth_id}"
            branches: [ '$sha1' ]
            shallow-clone: true
            depth: 10
            refspec: "+refs/heads/*:refs/remotes/origin/* +refs/pull/*:refs/remotes/origin/pr/*"
            browser: githubweb
            browser-url: "{jjb_git}"
      script-path: "$script"

- job-template:
    name: "{jjb_proj}-build-hpcsdk"
    folder: "{jjb_folder}"
    project-type: pipeline
    properties:
      - github:
          url: "{jjb_git_web}"
      - build-discarder:
          days-to-keep: 30
          num-to-keep: 20
      - inject:
          keep-system-variables: true
          properties-content: |
            jjb_proj="{jjb_proj}-build-hpcsdk"
    description: Do NOT edit this job through the Web GUI !
    concurrent: true
    sandbox: true
    parameters:
      - string:
          name: "sha1"
          default: "master"
          description: "Commit to be checked, set by PR"
      - string:
          name: "DEBUG"
          default: 0
          description: "Enable debug prints and traces, valid values are 0-9"
      - bool:
          name: "BUILD_DOCKERS"
          default: false
          description: "Rebuild docker containers"
      - string:
          name: "CONF_FILE"
          default: ".ci/pipeline/build_hpcsdk_matrix.yaml"
          description: "Regex to select job config file"
      - string:
          name: "githubData"
          default: ""
          description: "Variables from post"
    pipeline-scm:
      scm:
        - git:
            url: "{jjb_git}"
            credentials-id: "{jjb_gh_auth_id}"
            branches: [ '$sha1' ]
            shallow-clone: true
            depth: 10
            refspec: "+refs/heads/*:refs/remotes/origin/* +refs/pull/*:refs/remotes/origin/pr/*"
            browser: githubweb
            browser-url: "{jjb_git}"
      script-path: "{jjb_jenkinsfile}"

- job-template:
    name: "{jjb_proj}-ci-dispatcher"
    project-type: pipeline
    folder: "{jjb_folder}"
    properties:
      - github:
          url: "{jjb_git_web}"
      - build-discarder:
          days-to-keep: 14
          num-to-keep: 1000
      - inject:
          keep-system-variables: true
          properties-content: |
            jjb_proj={jjb_proj}-ci-dispatcher
    triggers:
      - generic-webhook-trigger:
          token: "{jjb_proj}-ci-dispatcher"
          print-contributors: true
          print-posted-content: true
          silent-response: false
          cause: "Generic Cause"
          post-content-params:
            - type: JSONPath
              key: githubData
              value: $
            - type: JSONPath
              key: VARIABLE_FROM_POST
              value: $
    description: Do NOT edit this job through the Web GUI !
    concurrent: true
    sandbox: true
    parameters:
      - string:
          name: "VARIABLE_FROM_POST"
          default: ""
          description: ""
    dsl: |
        @Library('blossom-github-lib@master')
        import ipp.blossom.*

        withCredentials([usernamePassword(credentialsId: 'svcnbu-swx-hpcx-github-token', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {{
          githubHelper = GithubHelper.getInstance("${{GIT_PASSWORD}}", VARIABLE_FROM_POST)
        }}

        def blueOceanUrl = "${{JENKINS_URL}}blue/organizations/jenkins/{jjb_folder}%2F{jjb_proj}-ci-dispatcher/detail/{jjb_proj}-ci-dispatcher/${{BUILD_NUMBER}}/pipeline/"
        githubHelper.updateCommitStatus(blueOceanUrl, "Blossom CI started", GitHubCommitState.PENDING)
        currentBuild.description = githubHelper.getBuildDescription()

        try {{
            parallel UCC: {{
                def jobName = 'ucc'
                def run = build job: jobName, parameters: [
                    string(name: 'sha1', value: githubHelper.getMergedSHA()),
                    string(name: 'githubData', value: VARIABLE_FROM_POST)
                ], propagate: false
                def jobUrl = "${{JENKINS_URL}}blue/organizations/jenkins/{jjb_folder}%2F${{jobName}}/detail/${{jobName}}/${{run.number}}/pipeline"
                if (run.resultIsBetterOrEqualTo('SUCCESS')) {{
                    echo "${{jobName}} SUCCESS: ${{jobUrl}}"
                }} else {{
                    error("${{jobName}} FAILED: ${{jobUrl}}")
                }}
            }}, 'ucc-build-hpcsdk': {{
                def jobName = 'ucc-build-hpcsdk'
                def run = build job: jobName, parameters: [
                    string(name: 'sha1', value: githubHelper.getMergedSHA()),
                    string(name: 'githubData', value: VARIABLE_FROM_POST)
                ], propagate: false
                def jobUrl = "${{JENKINS_URL}}blue/organizations/jenkins/{jjb_folder}%2F${{jobName}}/detail/${{jobName}}/${{run.number}}/pipeline"
                if (run.resultIsBetterOrEqualTo('SUCCESS')) {{
                    echo "${{jobName}} SUCCESS: ${{jobUrl}}"
                }} else {{
                    error("${{jobName}} FAILED: ${{jobUrl}}")
                }}
            }}

            githubHelper.updateCommitStatus(blueOceanUrl, "Blossom CI succeeded", GitHubCommitState.SUCCESS)
        }} catch(Exception ex) {{
            println ex
            githubHelper.updateCommitStatus(blueOceanUrl, "Blossom CI failed", GitHubCommitState.FAILURE)
            error("failed")
        }}

- project:
    name: ucc-build
    jjb_proj: 'ucc'
    jjb_git: 'git@github.com:openucx/ucc.git'
    jjb_git_web: 'https://github.com/openucx/ucc'
    jjb_branch: 'master'
    jjb_folder: "UCC"
    jjb_owner: 'artemry'
    jjb_jenkinsfile: '.ci/Jenkinsfile.shlib'
    jjb_gh_auth_id: 'svcnbu-swx-hpcx_ssh_with_key'
    jobs:
      - "{jjb_proj}"
      - "{jjb_proj}-build-hpcsdk"
      - "{jjb_proj}-ci-dispatcher"
