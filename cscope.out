cscope 15 $HOME/Work/ucc-mcast/ucc               0003494878
	@contrib/doca_urom_ucc_plugin/common/urom_ucc.h

14 #iâdeà
UROM_UCC_H_


15 
	#UROM_UCC_H_


	)

17 
	~<uı/­i/uı.h
>

18 
	~<ucc/­i/ucc.h
>

20 #ifdeà
__ılu¥lus


26 
	#urom_ucc_£rŸlize_Ãxt_¿w
(
_™”
, 
_ty³
, 
_off£t
) \

28 
_ty³
 *
_»suÉ
 = (_ty³ *)(*(
_™”
)); \

29 *(
_™”
èğ
	`UCS_PTR_BYTE_OFFSET
(*(_™”), 
_off£t
); \

30 
_»suÉ
; \

31 })

	)

34 
	eurom_wÜk”_ucc_cmd_ty³
 {

35 
UROM_WORKER_CMD_UCC_LIB_CREATE
,

36 
UROM_WORKER_CMD_UCC_LIB_DESTROY
,

37 
UROM_WORKER_CMD_UCC_CONTEXT_CREATE
,

38 
UROM_WORKER_CMD_UCC_CONTEXT_DESTROY
,

39 
UROM_WORKER_CMD_UCC_TEAM_CREATE
,

40 
UROM_WORKER_CMD_UCC_COLL
,

41 
UROM_WORKER_CMD_UCC_CREATE_PASSIVE_DATA_CHANNEL
,

54 
	surom_wÜk”_cmd_ucc_lib_ü—‹
 {

55 *
·¿ms
;

59 
	surom_wÜk”_cmd_ucc_cÚ‹xt_ü—‹
 {

61 
št64_t
 
¡¬t
;

62 
št64_t
 *
¬¿y
;

64 
št64_t
 
¡ride
;

65 
št64_t
 
size
;

66 *
ba£_va
;

67 
ušt64_t
 
Ën
;

71 
	surom_wÜk”_cmd_ucc_·ss_dc
 {

72 *
uı_addr
;

73 
size_t
 
addr_Ën
;

77 
	surom_wÜk”_cmd_ucc_cÚ‹xt_de¡roy
 {

78 
ucc_cÚ‹xt_h
 
cÚ‹xt_h
;

82 
	surom_wÜk”_cmd_ucc_‹am_ü—‹
 {

83 
št64_t
 
¡¬t
;

84 
št64_t
 
¡ride
;

85 
št64_t
 
size
;

86 
ucc_cÚ‹xt_h
 
cÚ‹xt_h
;

90 
	surom_wÜk”_cmd_ucc_cŞl
 {

91 
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
;

92 
ucc_‹am_h
 
‹am
;

93 
u£_xgvmi
;

94 *
wÜk_bufãr
;

95 
size_t
 
wÜk_bufãr_size
;

96 
size_t
 
‹am_size
;

100 
	surom_wÜk”_ucc_cmd
 {

101 
urom_wÜk”_ucc_cmd_ty³
 
cmd_ty³
;

102 
ušt64_t
 
dpu_wÜk”_id
;

104 
urom_wÜk”_cmd_ucc_lib_ü—‹
 
lib_ü—‹_cmd
;

105 
urom_wÜk”_cmd_ucc_cÚ‹xt_ü—‹
 
cÚ‹xt_ü—‹_cmd
;

106 
urom_wÜk”_cmd_ucc_cÚ‹xt_de¡roy
 
cÚ‹xt_de¡roy_cmd
;

107 
urom_wÜk”_cmd_ucc_‹am_ü—‹
 
‹am_ü—‹_cmd
;

108 
urom_wÜk”_cmd_ucc_cŞl
 
cŞl_cmd
;

109 
urom_wÜk”_cmd_ucc_·ss_dc
 
·ss_dc_ü—‹_cmd
;

114 
	eurom_wÜk”_ucc_nÙify_ty³
 {

115 
UROM_WORKER_NOTIFY_UCC_LIB_CREATE_COMPLETE
,

116 
UROM_WORKER_NOTIFY_UCC_LIB_DESTROY_COMPLETE
,

117 
UROM_WORKER_NOTIFY_UCC_CONTEXT_CREATE_COMPLETE
,

118 
UROM_WORKER_NOTIFY_UCC_CONTEXT_DESTROY_COMPLETE
,

119 
UROM_WORKER_NOTIFY_UCC_TEAM_CREATE_COMPLETE
,

120 
UROM_WORKER_NOTIFY_UCC_COLLECTIVE_COMPLETE
,

121 
UROM_WORKER_NOTIFY_UCC_PASSIVE_DATA_CHANNEL_COMPLETE
,

125 
	surom_wÜk”_ucc_nÙify_cÚ‹xt_ü—‹
 {

126 
ucc_cÚ‹xt_h
 
cÚ‹xt
;

130 
	surom_wÜk”_ucc_nÙify_‹am_ü—‹
 {

131 
ucc_‹am_h
 
‹am
;

135 
	surom_wÜk”_ucc_nÙify_cŞËùive
 {

136 
ucc_¡©us_t
 
¡©us
;

140 
	surom_wÜk”_ucc_nÙify_·ss_dc
 {

141 
ucc_¡©us_t
 
¡©us
;

145 
	surom_wÜk”_nÙify_ucc
 {

146 
urom_wÜk”_ucc_nÙify_ty³
 
nÙify_ty³
;

147 
ušt64_t
 
dpu_wÜk”_id
;

149 
urom_wÜk”_ucc_nÙify_cÚ‹xt_ü—‹
 
cÚ‹xt_ü—‹_nqe
;

150 
urom_wÜk”_ucc_nÙify_‹am_ü—‹
 
‹am_ü—‹_nqe
;

151 
urom_wÜk”_ucc_nÙify_cŞËùive
 
cŞl_nqe
;

152 
urom_wÜk”_ucc_nÙify_·ss_dc
 
·ss_dc_nqe
;

156 
	succ_wÜk”_key_buf
 {

157 
size_t
 
¤c_Ën
;

158 
size_t
 
d¡_Ën
;

159 
rkeys
[1024];

160 } 
	tucc_wÜk”_key_buf
;

162 #ifdeà
__ılu¥lus


	@contrib/doca_urom_ucc_plugin/dpu/worker_ucc.c

14 
	#_GNU_SOURCE


	)

16 
	~<¡dšt.h
>

17 
	~<¡dlib.h
>

18 
	~<±h»ad.h
>

19 
	~<sched.h
>

21 
	~<sigÇl.h
>

22 
	~<uni¡d.h
>

24 
	~<ucs/¬ch/©omic.h
>

26 
	~"wÜk”_ucc.h
"

27 
	~"../commÚ/urom_ucc.h
"

29 
DOCA_LOG_REGISTER
(
UROM
::
WORKER
::
UCC
);

31 
ušt64_t
 
	g¶ugš_v”siÚ
 = 0x01;

32 vŞ©
ušt64_t
 *
	gqueue_äÚt
;

33 vŞ©
ušt64_t
 *
	gqueue_
;

34 vŞ©
ušt64_t
 *
	gqueue_size
;

35 
	gucc_compÚ’t_’abËd
;

36 
±h»ad_t
 
	gcÚ‹xt_´og»ss_th»ad
;

37 
ušt64_t
 
	gqueue_lock
 = 0;

38 
±h»ad_t
 *
	g´og»ss_th»ad
 = 
NULL
;

41 
wÜk”_ucc_İts
 
	gwÜk”_ucc_İts
 = {

42 .
num_´og»ss_th»ads
 = 1,

43 .
	gµw
 = 32,

44 .
	gp
 = 1,

45 .
	gli¡_size
 = 64,

46 .
	gnum_psync
 = 128,

47 .
	gdpu_wÜk”_bšdšg_¡ride
 = 1,

51 
	sth»ad_¬gs
 {

52 
ušt64_t
 
	mth»ad_id
;

53 
urom_wÜk”_ucc
 *
	mucc_wÜk”
;

58 
	$g‘_ncÜes
()

60 
cÜe_couÁ
 = 0;

61 
couÁ
 = 0;

62 
FILE
 *
åŒ
;

63 
¡r
[100];

64 *
pos
;

65 
šdex
;

68 ià(
cÜe_couÁ
 != 0) {

69  
cÜe_couÁ
;

72 
åŒ
 = 
	`fİ’
("/proc/cpuinfo", "rb");

74 ià(
åŒ
 =ğ
NULL
) {

75 
	`´štf
("Failedo open /proc/cpuinfo\n");

76 
	`ex™
(
EXIT_FAILURE
);

79 (
	`fg‘s
(
¡r
, 100, 
åŒ
)è!ğ
NULL
) {

80 
šdex
 = 0;

81 (
pos
 = 
	`¡r¡r
(
¡r
 + 
šdex
, "´oûssÜ")è!ğ
NULL
) {

82 
šdex
 = (
pos
 - 
¡r
) + 1;

83 
couÁ
++;

87 
	`fşo£
(
åŒ
);

88 
cÜe_couÁ
 = 
couÁ
;

89  
couÁ
;

90 
	}
}

92 
	$dpu_th»ad_£t_affš™y_¥ecific_cÜe
(
cÜe_id
)

94 
ıu_£t_t
 
ıu£t
;

95 
	`CPU_ZERO
(&
ıu£t
);

97 ià(
cÜe_id
 >=0 && cÜe_id < 
	`g‘_ncÜes
()) {

98 
	`CPU_SET
(
cÜe_id
, &
ıu£t
);

99 
	`±h»ad_£ffš™y_Å
(
	`±h»ad_£lf
(), (
ıu£t
), &cpuset);

101 
	`´štf
("bad cÜid: %d\n", 
cÜe_id
);

102 
	`ex™
(-1);

104 
	}
}

106 
	$dpu_th»ad_£t_affš™y
(
th»ad_id
)

108 
cÜeid
 = 
th»ad_id
;

109 
do_¡ride
 = 
wÜk”_ucc_İts
.
dpu_wÜk”_bšdšg_¡ride
;

110 
num_th»ads
 = 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
;

111 
num_cÜes
;

112 
¡ride
;

113 
ıu_£t_t
 
ıu£t
;

115 
num_cÜes
 = 
	`g‘_ncÜes
();

116 
¡ride
 = 
num_cÜes
 / 
num_th»ads
;

118 
	`CPU_ZERO
(&
ıu£t
);

120 if(
do_¡ride
) {

121 
¡ride
 = 
do_¡ride
;

122 ià(
num_th»ads
 % 2 != 0) {

123 
¡ride
 = 1;

125 
cÜeid
 *ğ
¡ride
;

128 ià(
cÜeid
 >=0 && cÜeid < 
num_cÜes
) {

129 
	`CPU_SET
(
cÜeid
, &
ıu£t
);

130 
	`±h»ad_£ffš™y_Å
(
´og»ss_th»ad
[
th»ad_id
],

131 (
ıu£t
), &cpuset);

133 
	}
}

143 
doÿ_”rÜ_t
 
	$fšd_qe_¦Ù
(
ušt64_t
 
ùx_id
,

144 
urom_wÜk”_ucc
 *
ucc_wÜk”
,

145 
ucc_queue_–em’t
 **
»t_qe
)

147 
th»ad_id
 = 
ùx_id
 % 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
;

148 
ušt64_t
 
Ãxt
 = (
queue_
[
th»ad_id
] + 1è% 
wÜk”_ucc_İts
.
li¡_size
;

149 
cu¼
 = 
queue_
[
th»ad_id
];

151 ià(
Ãxt
 =ğ
queue_äÚt
[
th»ad_id
]) {

152 *
»t_qe
 = 
NULL
;

153  
DOCA_ERROR_FULL
;

156 *
»t_qe
 = &
ucc_wÜk”
->
queue
[
th»ad_id
][
cu¼
];

157 ià((*
»t_qe
)->
š_u£
 != 0) {

158 *
»t_qe
 = 
NULL
;

159  
DOCA_ERROR_BAD_STATE
;

161 
queue_
[
th»ad_id
] = 
Ãxt
;

162  
DOCA_SUCCESS
;

163 
	}
}

171 
doÿ_”rÜ_t
 
	$urom_wÜk”_ucc_İ’
(
urom_wÜk”_ùx
 *
ùx
)

173 
ušt64_t
 
i
, 
j
;

174 
doÿ_”rÜ_t
 
»suÉ
;

175 
ucs_¡©us_t
 
¡©us
;

176 
uı_·¿ms_t
 
uı_·¿ms
;

177 
uı_cÚfig_t
 *
uı_cÚfig
;

178 
uı_wÜk”_·¿ms_t
 
wÜk”_·¿ms
;

179 
urom_wÜk”_ucc
 *
ucc_wÜk”
;

181 ià(
ùx
 =ğ
NULL
) {

182  
DOCA_ERROR_INVALID_VALUE
;

185 
ucc_wÜk”
 = 
	`ÿÎoc
(1, (*ucc_worker));

186 ià(
ucc_wÜk”
 =ğ
NULL
) {

187 
	`DOCA_LOG_ERR
("Failedo‡llocate UCC worker context");

188  
DOCA_ERROR_NO_MEMORY
;

191 ià(
wÜk”_ucc_İts
.
num_´og»ss_th»ads
 < 
MIN_THREADS
) {

192 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
 = 
MIN_THREADS
;

193 
	`DOCA_LOG_WARN
("Number ofhreads for UCC Offload "

197 
ucc_wÜk”
->
ùx_id
 = 0;

198 
ucc_wÜk”
->
Ä_cÚÃùiÚs
 = 0;

199 
ucc_wÜk”
->
ucc_d©a
 = 
	`ÿÎoc
(
wÜk”_ucc_İts
.
µw
 * wÜk”_ucc_İts.
p
,

200 (
ucc_d©a
));

201 ià(
ucc_wÜk”
->
ucc_d©a
 =ğ
NULL
) {

202 
	`DOCA_LOG_ERR
("Failedo‡llocate UCC worker context");

203 
»suÉ
 = 
DOCA_ERROR_NO_MEMORY
;

204 
ucc_ä“
;

207 
ucc_wÜk”
->
queue
 = (
ucc_queue_–em’t
 **)

208 
	`m®loc
((
ucc_queue_–em’t
 *) *

209 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
);

210 ià(
ucc_wÜk”
->
queue
 =ğ
NULL
) {

211 
	`DOCA_LOG_ERR
("Failedo‡llocate UCCƒlements queue");

212 
»suÉ
 = 
DOCA_ERROR_NO_MEMORY
;

213 
ucc_d©a_ä“
;

215 
i
 = 0; i < 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
; i++) {

216 
ucc_wÜk”
->
queue
[
i
] = 
	`ÿÎoc
(
wÜk”_ucc_İts
.
li¡_size
,

217 (
ucc_queue_–em’t
));

218 ià(
ucc_wÜk”
->
queue
[
i
] =ğ
NULL
) {

219 
	`DOCA_LOG_ERR
("Failedo‡llocate queueƒlements");

220 
»suÉ
 = 
DOCA_ERROR_NO_MEMORY
;

221 
queue_ä“
;

225 
queue_äÚt
 = (vŞ©
ušt64_t
 *)

226 
	`ÿÎoc
(
wÜk”_ucc_İts
.
num_´og»ss_th»ads
, (
ušt64_t
));

227 ià(
queue_äÚt
 =ğ
NULL
) {

228 
»suÉ
 = 
DOCA_ERROR_NO_MEMORY
;

229 
queue_ä“
;

232 
queue_
 = (vŞ©
ušt64_t
 *)

233 
	`ÿÎoc
(
wÜk”_ucc_İts
.
num_´og»ss_th»ads
, (
ušt64_t
));

234 ià(
queue_
 =ğ
NULL
) {

235 
»suÉ
 = 
DOCA_ERROR_NO_MEMORY
;

236 
queue_äÚt_ä“
;

239 
queue_size
 = (vŞ©
ušt64_t
 *)

240 
	`ÿÎoc
(
wÜk”_ucc_İts
.
num_´og»ss_th»ads
, (
ušt64_t
));

241 ià(
queue_size
 =ğ
NULL
) {

242 
»suÉ
 = 
DOCA_ERROR_NO_MEMORY
;

243 
queue__ä“
;

246 
¡©us
 = 
	`uı_cÚfig_»ad
(
NULL
, NULL, &
uı_cÚfig
);

247 ià(
¡©us
 !ğ
UCS_OK
) {

248 
	`DOCA_LOG_ERR
("Failedo„ead UCP config");

249 
queue_size_ä“
;

252 
¡©us
 = 
	`uı_cÚfig_modify
(
uı_cÚfig
, "PROTO_ENABLE", "y");

253 ià(
¡©us
 !ğ
UCS_OK
) {

254 
	`DOCA_LOG_ERR
("Failedo„ead UCP config");

255 
	`uı_cÚfig_»Ëa£
(
uı_cÚfig
);

256 
queue_size_ä“
;

259 
uı_·¿ms
.
f›ld_mask
 = 
UCP_PARAM_FIELD_FEATURES
;

260 
uı_·¿ms
.
ã©u»s
 = 
UCP_FEATURE_TAG
 | 
UCP_FEATURE_RMA
 |

261 
UCP_FEATURE_AMO64
 | 
UCP_FEATURE_EXPORTED_MEMH
;

262 
¡©us
 = 
	`uı_š™
(&
uı_·¿ms
, 
uı_cÚfig
,

263 &
ucc_wÜk”
->
uı_d©a
.
uı_cÚ‹xt
);

264 
	`uı_cÚfig_»Ëa£
(
uı_cÚfig
);

265 ià(
¡©us
 !ğ
UCS_OK
) {

266 
	`DOCA_LOG_ERR
("Failedo initialized UCP");

267 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

268 
queue_size_ä“
;

271 
wÜk”_·¿ms
.
f›ld_mask
 = 
UCP_WORKER_PARAM_FIELD_THREAD_MODE
;

272 
wÜk”_·¿ms
.
th»ad_mode
 = 
UCS_THREAD_MODE_MULTI
;

273 
¡©us
 = 
	`uı_wÜk”_ü—‹
(
ucc_wÜk”
->
uı_d©a
.
uı_cÚ‹xt
,

274 &
wÜk”_·¿ms
,

275 &
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
);

276 ià(
¡©us
 !ğ
UCS_OK
) {

277 
	`DOCA_LOG_ERR
("Unableo create ucp worker");

278 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

279 
uı_ş—nup
;

282 
ucc_wÜk”
->
uı_d©a
.
•s
 = 
	`kh_š™
(
•
);

283 ià(
ucc_wÜk”
->
uı_d©a
.
•s
 =ğ
NULL
) {

284 
	`DOCA_LOG_ERR
("Failedo init EP hashtable map");

285 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

286 
wÜk”_de¡roy
;

289 
ucc_wÜk”
->
uı_d©a
.
memh
 = 
	`kh_š™
(memh);

290 ià(
ucc_wÜk”
->
uı_d©a
.
memh
 =ğ
NULL
) {

291 
	`DOCA_LOG_ERR
("Failedo init memh hashtable map");

292 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

293 
•s_de¡roy
;

296 
ucc_wÜk”
->
uı_d©a
.
rkeys
 = 
	`kh_š™
(rkeys);

297 ià(
ucc_wÜk”
->
uı_d©a
.
rkeys
 =ğ
NULL
) {

298 
	`DOCA_LOG_ERR
("Failedo init„keys hashtable map");

299 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

300 
memh_de¡roy
;

303 
ucc_wÜk”
->
ids
 = 
	`kh_š™
(
ùx_id
);

304 ià(
ucc_wÜk”
->
ids
 =ğ
NULL
) {

305 
	`DOCA_LOG_ERR
("Failedo init ids hashtable map");

306 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

307 
rkeys_de¡roy
;

310 
ucc_wÜk”
->
su³r
 = 
ùx
;

311 
ucc_wÜk”
->
li¡_lock
 = 0;

312 
ucc_compÚ’t_’abËd
 = 1;

313 
	`ucs_li¡_h—d_š™
(&
ucc_wÜk”
->
com¶‘ed_»qs
);

315 
ùx
->
¶ugš_ùx
 = 
ucc_wÜk”
;

316 
	`DOCA_LOG_INFO
("UCC worker open flow is done");

317  
DOCA_SUCCESS
;

319 
rkeys_de¡roy
:

320 
	`kh_de¡roy
(
rkeys
, 
ucc_wÜk”
->
uı_d©a
.rkeys);

321 
memh_de¡roy
:

322 
	`kh_de¡roy
(
memh
, 
ucc_wÜk”
->
uı_d©a
.memh);

323 
•s_de¡roy
:

324 
	`kh_de¡roy
(
•
, 
ucc_wÜk”
->
uı_d©a
.
•s
);

325 
wÜk”_de¡roy
:

326 
	`uı_wÜk”_de¡roy
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
);

327 
uı_ş—nup
:

328 
	`uı_ş—nup
(
ucc_wÜk”
->
uı_d©a
.
uı_cÚ‹xt
);

329 
queue_size_ä“
:

330 
	`ä“
((*)
queue_size
);

331 
queue__ä“
:

332 
	`ä“
((*)
queue_
);

333 
queue_äÚt_ä“
:

334 
	`ä“
((*)
queue_äÚt
);

335 
queue_ä“
:

336 
j
 = 0; j < 
i
; j++)

337 
	`ä“
(
ucc_wÜk”
->
queue
[
j
]);

338 
	`ä“
(
ucc_wÜk”
->
queue
);

339 
ucc_d©a_ä“
:

340 
	`ä“
(
ucc_wÜk”
->
ucc_d©a
);

341 
ucc_ä“
:

342 
	`ä“
(
ucc_wÜk”
);

343  
»suÉ
;

344 
	}
}

346 
	$ucc_wÜk”_još_ªd_ä“_th»ads
()

348 
ušt64_t
 
i
;

349 ià(
´og»ss_th»ad
) {

350 
i
 = 0; i < 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
; i++) {

351 
	`±h»ad_još
(
´og»ss_th»ad
[
i
], 
NULL
);

353 
	`ä“
(
´og»ss_th»ad
);

354 
´og»ss_th»ad
 = 
NULL
;

356 
	}
}

363 
	$urom_wÜk”_ucc_şo£
(
urom_wÜk”_ùx
 *
wÜk”_ùx
)

365 
urom_wÜk”_ucc
 *
ucc_wÜk”
 = 
wÜk”_ùx
->
¶ugš_ùx
;

366 
ušt64_t
 
i
;

368 ià(
wÜk”_ùx
 =ğ
NULL
)

371 
ucc_compÚ’t_’abËd
 = 0;

373 
	`ucc_wÜk”_još_ªd_ä“_th»ads
();

376 
	`kh_de¡roy
(
rkeys
, 
ucc_wÜk”
->
uı_d©a
.rkeys);

377 
	`kh_de¡roy
(
memh
, 
ucc_wÜk”
->
uı_d©a
.memh);

378 
	`kh_de¡roy
(
•
, 
ucc_wÜk”
->
uı_d©a
.
•s
);

379 
	`kh_de¡roy
(
ùx_id
, 
ucc_wÜk”
->
ids
);

382 
	`uı_wÜk”_de¡roy
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
);

383 
	`uı_ş—nup
(
ucc_wÜk”
->
uı_d©a
.
uı_cÚ‹xt
);

386 
	`ä“
((*)
queue_size
);

387 
	`ä“
((*)
queue_
);

388 
	`ä“
((*)
queue_äÚt
);

389 
	`ä“
(
ucc_wÜk”
->
ucc_d©a
);

392 
i
 = 0; i < 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
; i++)

393 
	`ä“
(
ucc_wÜk”
->
queue
[
i
]);

395 
	`ä“
(
ucc_wÜk”
->
queue
);

398 
	`ä“
(
ucc_wÜk”
);

399 
	}
}

409 
doÿ_”rÜ_t
 
	$urom_wÜk”_ucc_cmd_uÅack
(*
·cked_cmd
,

410 
size_t
 
·cked_cmd_Ën
,

411 
urom_wÜk”_cmd
 **
cmd
)

413 
ušt64_t
 
ex‹nded_mem
 = 0;

414 *
±r
;

415 
is_couÁ_64
;

416 
is_di¥_64
;

417 
size_t
 
‹am_size
;

418 
size_t
 
di¥_·ck_size
;

419 
size_t
 
couÁ_·ck_size
;

420 
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
;

421 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
;

423 ià(
·cked_cmd_Ën
 < (
urom_wÜk”_ucc_cmd
)) {

424 
	`DOCA_LOG_INFO
("Invalid…acked command†ength");

425  
DOCA_ERROR_INVALID_VALUE
;

428 *
cmd
 = 
·cked_cmd
;

429 
±r
 = 
·cked_cmd
 +

430 
	`ucs_off£tof
(
urom_wÜk”_cmd
, 
¶ugš_cmd
) +

431 (
urom_wÜk”_ucc_cmd
);

432 
ucc_cmd
 = (
urom_wÜk”_ucc_cmd
 *)(*
cmd
)->
¶ugš_cmd
;

434 
ucc_cmd
->
cmd_ty³
) {

435 
UROM_WORKER_CMD_UCC_LIB_CREATE
:

436 
ucc_cmd
->
lib_ü—‹_cmd
.
·¿ms
 = 
±r
;

437 
ex‹nded_mem
 +ğ(
ucc_lib_·¿ms_t
);

439 
UROM_WORKER_CMD_UCC_COLL
:

440 
cŞl_¬gs
 = 
±r
;

441 
ucc_cmd
->
cŞl_cmd
.
cŞl_¬gs
 = 
±r
;

442 
±r
 +ğ(
ucc_cŞl_¬gs_t
);

443 
ex‹nded_mem
 +ğ(
ucc_cŞl_¬gs_t
);

444 ià(
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr_size
 > 0) {

445 
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr
 = 
±r
;

446 
±r
 +ğ
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr_size
;

447 
ex‹nded_mem
 +ğ
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr_size
;

449 ià(
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLTOALLV
 ||

450 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHERV
 ||

451 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHERV
 ||

452 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE_SCATTERV
 ||

453 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTERV
) {

455 
‹am_size
 = 
ucc_cmd
->
cŞl_cmd
.team_size;

456 
is_couÁ_64
 =

457 ((
cŞl_¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) &&

458 (
cŞl_¬gs
->
æags
 & 
UCC_COLL_ARGS_FLAG_COUNT_64BIT
));

459 
is_di¥_64
 =

460 ((
cŞl_¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) &&

461 (
cŞl_¬gs
->
æags
 & 
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
));

463 
couÁ_·ck_size
 = ((
is_couÁ_64
) ?

464 (
ušt64_t
) :

465 (
ušt32_t
)è* 
‹am_size
;

466 
di¥_·ck_size
 = ((
is_di¥_64
) ?

467 (
ušt64_t
) :

468 (
ušt32_t
)è* 
‹am_size
;

470 
cŞl_¬gs
->
¤c
.
šfo_v
.
couÁs
 = 
±r
;

471 
±r
 +ğ
couÁ_·ck_size
;

472 
ex‹nded_mem
 +ğ
couÁ_·ck_size
;

473 
cŞl_¬gs
->
d¡
.
šfo_v
.
couÁs
 = 
±r
;

474 
±r
 +ğ
couÁ_·ck_size
;

475 
ex‹nded_mem
 +ğ
couÁ_·ck_size
;

477 
cŞl_¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
 = 
±r
;

478 
±r
 +ğ
di¥_·ck_size
;

479 
ex‹nded_mem
 +ğ
di¥_·ck_size
;

480 
cŞl_¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
 = 
±r
;

481 
±r
 +ğ
di¥_·ck_size
;

482 
ex‹nded_mem
 +ğ
di¥_·ck_size
;

486 
UROM_WORKER_CMD_UCC_CREATE_PASSIVE_DATA_CHANNEL
:

487 
ucc_cmd
->
·ss_dc_ü—‹_cmd
.
uı_addr
 = 
±r
;

488 
ex‹nded_mem
 +ğ
ucc_cmd
->
·ss_dc_ü—‹_cmd
.
addr_Ën
;

492 
	`DOCA_LOG_ERR
("Inv®id UCC cmd: %u", 
ucc_cmd
->
cmd_ty³
);

496 ià((*
cmd
)->
Ën
 !ğ
ex‹nded_mem
 + (
urom_wÜk”_ucc_cmd
)) {

497 
	`DOCA_LOG_ERR
("Invalid UCC command†ength");

498  
DOCA_ERROR_INVALID_VALUE
;

501  
DOCA_SUCCESS
;

502 
	}
}

511 
	$ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

512 
urom_wÜk”_nÙif_desc
 *
nd
)

514 
ušt64_t
 
lv®ue
 = 0;

516 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
ucc_wÜk”
->
li¡_lock
, 0, 1);

517 
lv®ue
 != 0)

518 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
ucc_wÜk”
->
li¡_lock
, 0, 1);

520 
	`ucs_li¡_add_
(&
ucc_wÜk”
->
com¶‘ed_»qs
, &
nd
->
’Œy
);

522 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
ucc_wÜk”
->
li¡_lock
, 1, 0);

523 
	}
}

531 
	$wÜk”_ucc_de¡_»move
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

532 
ušt64_t
 
de¡_id
)

534 
khšt_t
 
k
;

536 
k
 = 
	`kh_g‘
(
ùx_id
, 
ucc_wÜk”
->
ids
, 
de¡_id
);

537 ià(
k
 =ğ
	`kh_’d
(
ucc_wÜk”
->
ids
)) {

538 
	`DOCA_LOG_ERR
("De¡š©iÚ id - %lu dÛ nÙƒxi¡", 
de¡_id
);

541 
	`kh_d–
(
ùx_id
, 
ucc_wÜk”
->
ids
, 
k
);

542 
ucc_wÜk”
->
ùx_id
--;

543 
	}
}

553 
doÿ_”rÜ_t
 
	$wÜk”_ucc_de¡_lookup
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

554 
ušt64_t
 
de¡_id
,

555 
ušt64_t
 *
ùx_id
)

557 
»t
;

558 
khšt_t
 
k
;

560 
k
 = 
	`kh_g‘
(
ùx_id
, 
ucc_wÜk”
->
ids
, 
de¡_id
);

561 ià(
k
 !ğ
	`kh_’d
(
ucc_wÜk”
->
ids
)) {

562 *
ùx_id
 = 
	`kh_v®ue
(
ucc_wÜk”
->
ids
, 
k
);

563  
DOCA_SUCCESS
;

566 *
ùx_id
 = 
ucc_wÜk”
->ctx_id;

567 
k
 = 
	`kh_put
(
ùx_id
, 
ucc_wÜk”
->
ids
, 
de¡_id
, &
»t
);

568 ià(
»t
 < 0) {

569 
	`DOCA_LOG_ERR
("Failedo…ut‚ew context id");

570  
DOCA_ERROR_DRIVER
;

573 
ucc_wÜk”
->
ùx_id
++;

575 
	`kh_v®ue
(
ucc_wÜk”
->
ids
, 
k
èğ*
ùx_id
;

576 
	`DOCA_LOG_DBG
("UCC wÜk”‡dded cÚÃùiÚ %ld", *
ùx_id
);

577  
DOCA_SUCCESS
;

578 
	}
}

587 
doÿ_”rÜ_t


588 
	$urom_wÜk”_ucc_lib_ü—‹
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

589 
urom_wÜk”_cmd_desc
 *
cmd_desc
)

591 
urom_wÜk”_cmd
 *
cmd
 = (urom_worker_cmd *)

592 &
cmd_desc
->
wÜk”_cmd
;

593 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
 = (urom_worker_ucc_cmd *)

594 
cmd
->
¶ugš_cmd
;

595 
ušt64_t
 
ùx_id
;

596 
ušt64_t
 
i
;

597 
doÿ_”rÜ_t
 
»suÉ
;

598 
ucc_¡©us_t
 
ucc_¡©us
;

599 
ucc_lib_cÚfig_h
 
lib_cÚfig
;

600 
ucc_lib_·¿ms_t
 *
lib_·¿ms
;

601 
urom_wÜk”_nÙify
 *
nÙif
;

602 
urom_wÜk”_nÙif_desc
 *
nd
;

603 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
;

606 
nd
 = 
	`ÿÎoc
(1, (*ndè+ (*
ucc_nÙif
));

607 ià(
nd
 =ğ
NULL
)

608  
DOCA_ERROR_NO_MEMORY
;

610 
nd
->
de¡_id
 = 
cmd_desc
->dest_id;

612 
nÙif
 = (
urom_wÜk”_nÙify
 *)&
nd
->
wÜk”_nÙif
;

613 
nÙif
->
ty³
 = 
cmd
->type;

614 
nÙif
->
urom_cÚ‹xt
 = 
cmd
->urom_context;

615 
nÙif
->
Ën
 = (*
ucc_nÙif
);

616 
nÙif
->
¡©us
 = 
DOCA_SUCCESS
;

618 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)
nÙif
->
¶ugš_nÙif
;

619 
ucc_nÙif
->
nÙify_ty³
 = 
UROM_WORKER_NOTIFY_UCC_LIB_CREATE_COMPLETE
;

620 
ucc_nÙif
->
dpu_wÜk”_id
 = 
ucc_cmd
->dpu_worker_id;

622 
lib_·¿ms
 = 
ucc_cmd
->
lib_ü—‹_cmd
.
·¿ms
;

623 
lib_·¿ms
->
mask
 |ğ
UCC_LIB_PARAM_FIELD_THREAD_MODE
;

624 
lib_·¿ms
->
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

626 
»suÉ
 = 
	`wÜk”_ucc_de¡_lookup
(
ucc_wÜk”
, 
cmd_desc
->
de¡_id
, &
ùx_id
);

627 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

628 
	`DOCA_LOG_ERR
("Failedo†ookup command destination");

629 
ç
;

632 
ucc_wÜk”
->
Ä_cÚÃùiÚs
++;

634 ià(
ucc_wÜk”
->
Ä_cÚÃùiÚs
 > 
wÜk”_ucc_İts
.
µw
) {

635 
	`DOCA_LOG_ERR
("Too many…rocesses connectedo‡ single worker");

636 
»suÉ
 = 
DOCA_ERROR_FULL
;

637 
de¡_»move
;

640 ià(
UCC_OK
 !ğ
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
lib_cÚfig
)) {

641 
	`DOCA_LOG_ERR
("Failedo„ead UCC†ib config");

642 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

643 
»duû_cÚn
;

646 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

647 
ucc_¡©us
 = 
	`ucc_š™
(
lib_·¿ms
, 
lib_cÚfig
,

648 &
ucc_wÜk”
->
ucc_d©a
[
ùx_id
*
wÜk”_ucc_İts
.
p
 + 
i
].
ucc_lib
);

649 ià(
ucc_¡©us
 !ğ
UCC_OK
) {

650 
	`DOCA_LOG_ERR
("Failedo init UCC†ib");

651 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

652 
»duû_cÚn
;

655 
	`ucc_lib_cÚfig_»Ëa£
(
lib_cÚfig
);

657 
	`DOCA_LOG_DBG
("Created UCC†ib successfully");

658 
nÙif
->
¡©us
 = 
DOCA_SUCCESS
;

659 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

660  
nÙif
->
¡©us
;

662 
»duû_cÚn
:

663 
ucc_wÜk”
->
Ä_cÚÃùiÚs
--;

664 
de¡_»move
:

665 
	`wÜk”_ucc_de¡_»move
(
ucc_wÜk”
, 
cmd_desc
->
de¡_id
);

666 
ç
:

667 
	`DOCA_LOG_ERR
("Failedo create UCC†ib");

668 
nÙif
->
¡©us
 = 
»suÉ
;

669 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

670  
»suÉ
;

671 
	}
}

679 
doÿ_”rÜ_t
 
	$ucc_wÜk”_lib_de¡roy
(
urom_wÜk”_ucc
 *
ucc_wÜk”
)

681 
doÿ_”rÜ_t
 
»suÉ
 = 
DOCA_SUCCESS
;

682 
ušt64_t
 
j
, 
k
;

683 
št64_t
 
i
;

684 
ucc_¡©us_t
 
¡©us
;

686 
ucc_compÚ’t_’abËd
 = 0;

688 
	`ucc_wÜk”_još_ªd_ä“_th»ads
();

690 
j
 = 0; j < 
ucc_wÜk”
->
Ä_cÚÃùiÚs
; j++) {

691 
k
 = 0; k < 
wÜk”_ucc_İts
.
p
; k++) {

692 
ucc_d©a
 *
ucc_±r
 =

693 &
ucc_wÜk”
->
ucc_d©a
[
j
*
wÜk”_ucc_İts
.
p
 + 
k
];

694 
i
 = 0; i < 
ucc_±r
->
n_‹ams
; i++) {

695 ià(!
ucc_±r
->
ucc_‹am
[
i
]) {

698 
¡©us
 = 
	`ucc_‹am_de¡roy
(
ucc_±r
->
ucc_‹am
[
i
]);

699 ià(
¡©us
 !ğ
UCC_OK
) {

700 
	`DOCA_LOG_ERR
("Failedo destroy UCCeam of "

701 "d©¨šdex %lu‡nd—m index %ld", 
j
, 
i
);

702 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

704 
	`ä“
(
ucc_±r
->
pSync
);

706 ià(
ucc_±r
->
ucc_cÚ‹xt
) {

707 
¡©us
 = 
	`ucc_cÚ‹xt_de¡roy
(
ucc_±r
->
ucc_cÚ‹xt
);

708 ià(
¡©us
 !ğ
UCC_OK
) {

709 
	`DOCA_LOG_ERR
("Failedo destroy UCC context of "

710 "UCC d©¨šdex %lu", 
j
);

711 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

713 
ucc_±r
->
ucc_cÚ‹xt
 = 
NULL
;

715 ià(
ucc_±r
->
ucc_lib
) {

716 
¡©us
 = 
	`ucc_fš®ize
(
ucc_±r
->
ucc_lib
);

717 ià(
¡©us
 !ğ
UCC_OK
) {

718 
	`DOCA_LOG_ERR
("Failedo finalize UCC†ib "

719 "oàUCC d©¨šdex %lu", 
j
);

720 
»suÉ
 = 
DOCA_ERROR_DRIVER
;

726  
»suÉ
;

727 
	}
}

736 
doÿ_”rÜ_t


737 
	$urom_wÜk”_ucc_lib_de¡roy
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

738 
urom_wÜk”_cmd_desc
 *
cmd_desc
)

740 
urom_wÜk”_cmd
 *
cmd
 = (urom_worker_cmd *)

741 &
cmd_desc
->
wÜk”_cmd
;

742 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
 = (urom_worker_ucc_cmd *)

743 
cmd
->
¶ugš_cmd
;

744 
urom_wÜk”_nÙify
 *
nÙif
;

745 
urom_wÜk”_nÙif_desc
 *
nd
;

746 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
;

749 
nd
 = 
	`ÿÎoc
(1, (*ndè+ (*
ucc_nÙif
));

750 ià(
nd
 =ğ
NULL
)

751  
DOCA_ERROR_NO_MEMORY
;

753 
nd
->
de¡_id
 = 
cmd_desc
->dest_id;

755 
nÙif
 = (
urom_wÜk”_nÙify
 *)&
nd
->
wÜk”_nÙif
;

756 
nÙif
->
ty³
 = 
cmd
->type;

757 
nÙif
->
urom_cÚ‹xt
 = 
cmd
->urom_context;

758 
nÙif
->
Ën
 = (*
ucc_nÙif
);

760 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)
nÙif
->
¶ugš_nÙif
;

761 
ucc_nÙif
->
nÙify_ty³
 = 
UROM_WORKER_NOTIFY_UCC_LIB_DESTROY_COMPLETE
;

762 
ucc_nÙif
->
dpu_wÜk”_id
 = 
ucc_cmd
->dpu_worker_id;

764 
nÙif
->
¡©us
 = 
	`ucc_wÜk”_lib_de¡roy
(
ucc_wÜk”
);

765 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

766  
nÙif
->
¡©us
;

767 
	}
}

777 
doÿ_”rÜ_t


778 
	$hªdË_´og»ss_th»ad_cŞl_–em’t
(
ucc_queue_–em’t
 *
qe
,

779 
urom_wÜk”_ucc
 *
ucc_wÜk”
,

780 
th»ad_id
)

782 
št64_t
 
lv®ue
 = 0;

783 
ucc_¡©us_t
 
ucc_¡©us
 = 
UCC_OK
;

784 
doÿ_”rÜ_t
 
¡©us
 = 
DOCA_SUCCESS
;

785 
ucc_¡©us_t
 
tmp_¡©us
;

786 
ucc_queue_–em’t
 *
qe_back
;

787 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
;

789 ià(!
qe
->
po¡ed
) {

790 
ucc_¡©us
 = 
	`ucc_cŞËùive_po¡
(
qe
->
cŞl_»q
);

791 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

792 
	`DOCA_LOG_ERR
("Failedo…ost UCC collective: %s",

793 
	`ucc_¡©us_¡ršg
(
ucc_¡©us
));

794 
¡©us
 = 
DOCA_ERROR_DRIVER
;

795 
ex™
;

797 
qe
->
po¡ed
 = 1;

800 
ucc_¡©us
 = 
	`ucc_cŞËùive_‹¡
(
qe
->
cŞl_»q
);

801 ià(
ucc_¡©us
 =ğ
UCC_INPROGRESS
) {

802 
	`ucc_cÚ‹xt_´og»ss
(
ucc_wÜk”
->
ucc_d©a
[
qe
->
ùx_id
].
ucc_cÚ‹xt
);

803 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

804 
lv®ue
 != 0)

805 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

806 
¡©us
 = 
	`fšd_qe_¦Ù
(
qe
->
ùx_id
, 
ucc_wÜk”
, &
qe_back
);

807 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 1, 0);

808 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

809 
	`DOCA_LOG_ERR
("Failedo find queue slot foream creation");

810 
ucc_¡©us
 = 
UCC_ERR_NO_RESOURCE
;

811 
ex™
;

813 *
qe_back
 = *
qe
;

814 
qe
->
š_u£
 = 0;

815 
queue_äÚt
[
th»ad_id
] = (queue_front[thread_id] + 1)

816 % 
wÜk”_ucc_İts
.
li¡_size
;

817  
DOCA_ERROR_IN_PROGRESS
;

818 } ià(
ucc_¡©us
 =ğ
UCC_OK
) {

819 ià(
qe
->
b¬r›r
) {

820 
	`±h»ad_b¬r›r_wa™
(
qe
->
b¬r›r
);

821 ià(
qe
->
nd
 !ğ
NULL
) {

822 
	`±h»ad_b¬r›r_de¡roy
(
qe
->
b¬r›r
);

823 
	`ä“
(
qe
->
b¬r›r
);

824 
qe
->
b¬r›r
 = 
NULL
;

827 ià(
qe
->
key_du¶iÿ‹_³r_¿nk
) {

828 
	`ä“
(
qe
->
key_du¶iÿ‹_³r_¿nk
);

829 
qe
->
key_du¶iÿ‹_³r_¿nk
 = 
NULL
;

831 ià(
qe
->
Şd_de¡
) {

832 
	`DOCA_LOG_DBG
("Putting data backo host %p with size %lu",

833 
qe
->
Şd_de¡
, qe->
d©a_size
);

834 ià(
qe
->
de¡_·cked_key
 !ğ
NULL
) {

835 
¡©us
 = 
	`ucc_rma_put_ho¡
(

836 
ucc_wÜk”
->
ucc_d©a
[
qe
->
ùx_id
].
loÿl_wÜk_bufãr


837 + 
qe
->
d©a_size
,

838 
qe
->
Şd_de¡
,

839 
qe
->
d©a_size
,

840 
qe
->
ùx_id
,

841 
qe
->
de¡_·cked_key
,

842 
ucc_wÜk”
);

843 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

844 
	`DOCA_LOG_ERR
("Failedo find queue slot foream creation");

845 
ex™
;

848 
¡©us
 = 
	`ucc_rma_put
(

849 
ucc_wÜk”
->
ucc_d©a
[
qe
->
ùx_id
].
loÿl_wÜk_bufãr


850 + 
qe
->
d©a_size
,

851 
qe
->
Şd_de¡
,

852 
qe
->
d©a_size
,

853 
MAX_HOST_DEST_ID
,

854 
qe
->
my¿nk
,

855 
qe
->
ùx_id
,

856 
ucc_wÜk”
);

857 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

858 
	`DOCA_LOG_ERR
("Failedo find queue slot foream creation");

859 
ex™
;

863 ià(
qe
->
gwbi
 !ğ
NULL
 && qe->
nd
 != NULL) {

864 
	`ä“
(
qe
->
gwbi
);

867 
	`DOCA_LOG_ERR
("ucc_cŞËùive_‹¡(è»tuºed fau» (%d)", 
ucc_¡©us
);

868 
¡©us
 = 
DOCA_ERROR_DRIVER
;

869 
ex™
;

872 
¡©us
 = 
DOCA_SUCCESS
;

873 
tmp_¡©us
 = 
	`ucc_cŞËùive_‹¡
(
qe
->
cŞl_»q
);

874 ià(
tmp_¡©us
 !ğ
UCC_OK
) {

875 
ucc_¡©us
 = (ucc_¡©u =ğ
UCC_OK
è? 
tmp_¡©us
 : ucc_status;

876 
¡©us
 = 
DOCA_ERROR_DRIVER
;

878 
tmp_¡©us
 = 
	`ucc_cŞËùive_fš®ize
(
qe
->
cŞl_»q
);

879 ià(
tmp_¡©us
 !ğ
UCC_OK
) {

880 
ucc_¡©us
 = (ucc_¡©u =ğ
UCC_OK
è? 
tmp_¡©us
 : ucc_status;

881 
¡©us
 = 
DOCA_ERROR_DRIVER
;

884 
ex™
:

885 ià(
qe
->
nd
 !ğ
NULL
) {

886 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)

887 
qe
->
nd
->
wÜk”_nÙif
.
¶ugš_nÙif
;

888 
ucc_nÙif
->
cŞl_nqe
.
¡©us
 = 
ucc_¡©us
;

889 
qe
->
nd
->
wÜk”_nÙif
.
¡©us
 = status;

890 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
qe
->
nd
);

892 
queue_äÚt
[
th»ad_id
] = (queue_front[thread_id] + 1)

893 % 
wÜk”_ucc_İts
.
li¡_size
;

894 
	`ucs_©omic_add64
(&
queue_size
[
th»ad_id
], -1);

895 
qe
->
š_u£
 = 0;

896  
¡©us
;

897 
	}
}

907 
doÿ_”rÜ_t


908 
	$hªdË_´og»ss_th»ad_‹am_–em’t
(
ucc_queue_–em’t
 *
qe
,

909 
urom_wÜk”_ucc
 *
ucc_wÜk”
,

910 
th»ad_id
)

912 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
 = 
NULL
;

913 
št64_t
 
lv®ue
 = 0;

914 
ucc_¡©us_t
 
ucc_¡©us
 = 
UCC_OK
;

915 
doÿ_”rÜ_t
 
¡©us
 = 
DOCA_SUCCESS
;

916 
ucc_queue_–em’t
 *
qe_back
;

918 if(
qe
->
nd
 !ğ
NULL
) {

919 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)

920 
qe
->
nd
->
wÜk”_nÙif
.
¶ugš_nÙif
;

923 
ucc_¡©us
 = 
	`ucc_‹am_ü—‹_‹¡
(

924 
ucc_wÜk”
->
ucc_d©a
[
qe
->
ùx_id
].
ucc_‹am
[qe->
‹am_id
]);

925 ià(
ucc_¡©us
 =ğ
UCC_INPROGRESS
) {

926 
ucc_¡©us
 = 
	`ucc_cÚ‹xt_´og»ss
(

927 
ucc_wÜk”
->
ucc_d©a
[
qe
->
ùx_id
].
ucc_cÚ‹xt
);

928 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

929 
lv®ue
 != 0)

930 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

931 
¡©us
 = 
	`fšd_qe_¦Ù
(
qe
->
ùx_id
, 
ucc_wÜk”
, &
qe_back
);

932 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 1, 0);

933 ià(
¡©us
 !ğ
DOCA_SUCCESS
)

934 
ex™
;

935 *
qe_back
 = *
qe
;

936 
queue_äÚt
[
th»ad_id
] = (queue_front[thread_id] + 1)

937 % 
wÜk”_ucc_İts
.
li¡_size
;

938 
qe
->
š_u£
 = 0;

939  
DOCA_ERROR_IN_PROGRESS
;

940 } ià(
ucc_¡©us
 !ğ
UCC_OK
) {

941 
	`DOCA_LOG_ERR
("UCCeam createest failed (%d) oneam %ld for ctx %ld",

942 
ucc_¡©us
,

943 
qe
->
‹am_id
,

944 
qe
->
ùx_id
);

945 ià(
ucc_nÙif
)

946 
ucc_nÙif
->
‹am_ü—‹_nqe
.
‹am
 = 
NULL
;

947 
¡©us
 = 
DOCA_ERROR_DRIVER
;

949 ià(
qe
->
b¬r›r
) {

950 
	`±h»ad_b¬r›r_wa™
(
qe
->
b¬r›r
);

951 ià(
qe
->
nd
 !ğ
NULL
) {

952 
	`±h»ad_b¬r›r_de¡roy
(
qe
->
b¬r›r
);

953 
	`ä“
(
qe
->
b¬r›r
);

954 
qe
->
b¬r›r
 = 
NULL
;

957 
	`DOCA_LOG_INFO
("Finishedeam creation (%ld:%ld)",

958 
qe
->
ùx_id
, qe->
‹am_id
);

959 ià(
ucc_nÙif
) {

960 
ucc_nÙif
->
‹am_ü—‹_nqe
.
‹am
 =

961 
ucc_wÜk”
->
ucc_d©a
[
qe
->
ùx_id
].
ucc_‹am
[qe->
‹am_id
];

963 
¡©us
 = 
DOCA_SUCCESS
;

966 
ex™
:

967 
	`ä“
(
qe
->
cŞl_ùx
);

968 ià(
qe
->
nd
 !ğ
NULL
) {

969 
qe
->
nd
->
wÜk”_nÙif
.
¡©us
 = status;

970 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
qe
->
nd
);

972 
queue_äÚt
[
th»ad_id
] = (queue_front[thread_id] + 1)

973 % 
wÜk”_ucc_İts
.
li¡_size
;

974 
	`ucs_©omic_add64
(&
queue_size
[
th»ad_id
], -1);

975 
qe
->
š_u£
 = 0;

976  
¡©us
;

977 
	}
}

985 *
	$urom_wÜk”_ucc_´og»ss_th»ad
(*
¬g
)

987 
th»ad_¬gs
 *
rgs
 = (th»ad_¬g *)
¬g
;

988 
th»ad_id
 = 
rgs
->thread_id;

989 
urom_wÜk”_ucc
 *
ucc_wÜk”
 = 
rgs
->ucc_worker;

990 
doÿ_”rÜ_t
 
¡©us
 = 
DOCA_SUCCESS
;

991 
i
;

992 
äÚt
;

993 
size
;

994 
ucc_queue_–em’t
 *
qe
;

996 
ucc_compÚ’t_’abËd
) {

997 
size
 = 
queue_size
[
th»ad_id
];

998 
i
 = 0; i < 
size
; i++) {

999 
äÚt
 = 
queue_äÚt
[
th»ad_id
];

1000 
qe
 = &
ucc_wÜk”
->
queue
[
th»ad_id
][
äÚt
];

1001 ià(
qe
->
š_u£
 != 1) {

1002 
	`DOCA_LOG_WARN
("Found queueƒlement in "

1006 ià(
qe
->
ty³
 =ğ
UCC_WORKER_QUEUE_ELEMENT_TYPE_TEAM_CREATE
) {

1007 
¡©us
 = 
	`hªdË_´og»ss_th»ad_‹am_–em’t
(
qe
,

1008 
ucc_wÜk”
,

1009 
th»ad_id
);

1010 ià(
¡©us
 =ğ
DOCA_ERROR_IN_PROGRESS
)

1013 ià(
¡©us
 !ğ
DOCA_SUCCESS
)

1014 
ex™
;

1015 } ià(
qe
->
ty³
 =ğ
UCC_WORKER_QUEUE_ELEMENT_TYPE_COLLECTIVE
) {

1016 
¡©us
 = 
	`hªdË_´og»ss_th»ad_cŞl_–em’t
(
qe
,

1017 
ucc_wÜk”
,

1018 
th»ad_id
);

1019 ià(
¡©us
 =ğ
DOCA_ERROR_IN_PROGRESS
)

1022 ià(
¡©us
 !ğ
DOCA_SUCCESS
)

1023 
ex™
;

1025 
	`DOCA_LOG_ERR
("Unknown queueƒlementype");

1027 
	`sched_y›ld
();

1029 
ex™
:

1030 
	`±h»ad_ex™
(
NULL
);

1031 
	}
}

1039 
ucc_¡©us_t
 
	$urom_wÜk”_ucc_oob_®lg©h”_ä“
(*
»q
)

1041 
	`ä“
(
»q
);

1042  
UCC_OK
;

1043 
	}
}

1055 
ucc_¡©us_t
 
	$urom_wÜk”_ucc_oob_®lg©h”
(*
sbuf
,

1056 *
rbuf
,

1057 
size_t
 
msgËn
,

1058 *
oob_cŞl_ùx
,

1059 **
»q
)

1061 
cŞl_ùx
 *
ùx
 = (cŞl_ùx *è
oob_cŞl_ùx
;

1062 *
»cv_buf
;

1063 
šdex
;

1064 
size
;

1065 
i
;

1066 
oob_®lg©h”_»q
 *
oob_»q
;

1068 
size
 = 
ùx
->size;

1069 
šdex
 = 
ùx
->index;

1071 
oob_»q
 = 
	`m®loc
((*oob_req));

1072 ià(
oob_»q
 =ğ
NULL
) {

1073 
	`DOCA_LOG_ERR
("Failedo‡llocate OOB UCC„equest");

1074  
UCC_ERR_NO_MEMORY
;

1077 
oob_»q
->
sbuf
 = sbuf;

1078 
oob_»q
->
rbuf
 =„buf;

1079 
oob_»q
->
msgËn
 = msglen;

1080 
oob_»q
->
oob_cŞl_ùx
 = oob_coll_ctx;

1081 
oob_»q
->
™”
 = 0;

1083 
oob_»q
->
¡©us
 = 
	`ÿÎoc
(
ùx
->
size
 * 2, ());

1084 *
»q
 = 
oob_»q
;

1086 
i
 = 0; i < 
size
; i++) {

1087 
»cv_buf
 = (*)
rbuf
 + 
i
 * 
msgËn
;

1088 
	`ucc_»cv_nb
(
»cv_buf
, 
msgËn
, 
i
, 
ùx
->
ucc_wÜk”
, &
oob_»q
->
¡©us
[i]);

1091 
i
 = 0; i < 
size
; i++) {

1092 
	`ucc_£nd_nb
(
sbuf
, 
msgËn
, 
šdex
, 
i
, 
ùx
->
ucc_wÜk”
,

1093 &
oob_»q
->
¡©us
[
i
 + 
size
]);

1096  
UCC_OK
;

1097 
	}
}

1105 
ucc_¡©us_t
 
	$urom_wÜk”_ucc_oob_®lg©h”_‹¡
(*
»q
)

1107 
Ä_´obes
 = 5;

1108 
cŞl_ùx
 *
ùx
;

1109 
oob_®lg©h”_»q
 *
oob_»q
;

1110 
i
;

1111 
´obe_couÁ
;

1112 
Ä_dÚe
;

1113 
size
;

1115 
oob_»q
 = (
oob_®lg©h”_»q
 *)
»q
;

1116 
ùx
 = (
cŞl_ùx
 *)
oob_»q
->
oob_cŞl_ùx
;

1117 
size
 = 
ùx
->size;

1119 
´obe_couÁ
 = 0;…robe_couÁ < 
Ä_´obes
;…robe_count++) {

1120 
Ä_dÚe
 = 0;

1121 
i
 = 0; i < 
size
 * 2; i++) {

1122 ià(
oob_»q
->
¡©us
[
i
] != 1 &&

1123 
ùx
->
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
 !ğ
NULL
) {

1124 
	`uı_wÜk”_´og»ss
(
ùx
->
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
);

1126 ++
Ä_dÚe
;

1129 ià(
Ä_dÚe
 =ğ
size
 * 2)

1130  
UCC_OK
;

1133  
UCC_INPROGRESS
;

1134 
	}
}

1142 *
	$urom_wÜk”_ucc_ùx_´og»ss_th»ad
(*
¬g
)

1144 
ùx_th»ad_¬gs
 *
¬gs
 = (ùx_th»ad_¬g *)
¬g
;

1145 
ucc_mem_m­_t
 **
m­s
 = 
NULL
;

1146 
size_t
 
Ën
 = 
¬gs
->len;

1147 
št64_t
 
size
 = 
¬gs
->size;

1148 
št64_t
 
¡¬t
 = 
¬gs
->start;

1149 
št64_t
 
¡ride
 = 
¬gs
->stride;

1150 
št64_t
 
my¿nk
 = 
¬gs
->myrank;

1151 
ušt64_t
 
de¡_id
 = 
¬gs
->dest_id;

1152 
urom_wÜk”_ucc
 *
ucc_wÜk”
 = 
¬gs
->ucc_worker;

1153 
ucc_cÚ‹xt_·¿ms_t
 
ùx_·¿ms
 = {0};

1154 
urom_wÜk”_nÙif_desc
 *
nd
;

1155 
urom_wÜk”_nÙify
 *
nÙif
;

1156 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
;

1157 
th»ad_¬gs
 *
rgs
;

1158 
ušt64_t
 
n_th»ads
, 
i
, 
j
;

1159 
»t
;

1160 
ušt64_t
 
ùx_id
;

1161 
¡r_buf
[256];

1162 
ucc_¡©us_t
 
ucc_¡©us
;

1163 
doÿ_”rÜ_t
 
¡©us
;

1164 
cŞl_ùx
 **coll_ctx;

1165 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

1167 
nd
 = 
	`ÿÎoc
(1, (*ndè+ (*
ucc_nÙif
));

1168 ià(
nd
 =ğ
NULL
) {

1169 
¡©us
 = 
DOCA_ERROR_NO_MEMORY
;

1170 
ex™
;

1173 
nd
->
de¡_id
 = 
¬gs
->dest_id;

1174 
nÙif
 = (
urom_wÜk”_nÙify
 *)&
nd
->
wÜk”_nÙif
;

1175 
nÙif
->
ty³
 = 
¬gs
->
nÙif_ty³
;

1176 
nÙif
->
Ën
 = (*
ucc_nÙif
);

1177 
nÙif
->
urom_cÚ‹xt
 = 
¬gs
->urom_context;

1179 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)

1180 
nÙif
->
¶ugš_nÙif
;

1181 
ucc_nÙif
->
nÙify_ty³
 = 
UROM_WORKER_NOTIFY_UCC_CONTEXT_CREATE_COMPLETE
;

1182 
ucc_nÙif
->
dpu_wÜk”_id
 = 
¬gs
->
my¿nk
;

1184 
¡©us
 = 
	`wÜk”_ucc_de¡_lookup
(
ucc_wÜk”
, 
de¡_id
, &
ùx_id
);

1185 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

1186 
	`DOCA_LOG_ERR
("Failedo†ookup command destination");

1187 
ç
;

1190 
m­s
 = (
ucc_mem_m­_t
 **)

1191 
	`ÿÎoc
(
wÜk”_ucc_İts
.
p
, (
ucc_mem_m­_t
 *));

1192 
cŞl_ùx
 = (coll_ctx **)

1193 
	`ÿÎoc
(
wÜk”_ucc_İts
.
p
, (
cŞl_ùx
 *));

1195 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

1196 
ušt64_t
 
th»ad_ùx_id
 = 
ùx_id
 * 
wÜk”_ucc_İts
.
p
 + 
i
;

1198 ià(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_lib
 =ğ
NULL
) {

1199 
	`DOCA_LOG_ERR
("Attemptingo create UCC context "

1201 
¡©us
 = 
DOCA_ERROR_BAD_STATE
;

1202 
ç
;

1205 ià(
	`ucc_cÚ‹xt_cÚfig_»ad
(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_lib
,

1206 
NULL
, &
ùx_cÚfig
è!ğ
UCC_OK
) {

1207 
	`DOCA_LOG_ERR
("Failedo„ead UCC context config");

1208 
¡©us
 = 
DOCA_ERROR_DRIVER
;

1209 
ç
;

1213 ià(
UCC_OK
 !ğ
	`ucc_cÚ‹xt_cÚfig_modify
(

1214 
ùx_cÚfig
,

1217 
	`DOCA_LOG_ERR
("Failedo modify TL_UCP_TUNE UCC†ib config");

1218 
¡©us
 = 
DOCA_ERROR_DRIVER
;

1219 
cfg_»Ëa£
;

1223 
	`¥rštf
(
¡r_buf
, "%ld", 
size
);

1224 
ucc_¡©us
 = 
	`ucc_cÚ‹xt_cÚfig_modify
(
ùx_cÚfig
, 
NULL
,

1225 "ESTIMATED_NUM_EPS", 
¡r_buf
);

1226 ià(
ucc_¡©us
 !ğ
UCC_OK
) {

1227 
	`DOCA_LOG_ERR
("UCC context config modify "

1229 
¡©us
 = 
DOCA_ERROR_DRIVER
;

1230 
cfg_»Ëa£
;

1233 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
loÿl_wÜk_bufãr
 =

1234 
	`ÿÎoc
(1, 
Ën
 * 2);

1235 ià(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
loÿl_wÜk_bufãr
 =ğ
NULL
) {

1236 
	`DOCA_LOG_ERR
("Failedo‡llocate†ocal work buffer");

1237 
¡©us
 = 
DOCA_ERROR_NO_MEMORY
;

1238 
cfg_»Ëa£
;

1241 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
pSync
 =

1242 
	`ÿÎoc
(
wÜk”_ucc_İts
.
num_psync
, ());

1243 ià(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
pSync
 =ğ
NULL
) {

1244 
	`DOCA_LOG_ERR
("Failedo…Sync‡rray");

1245 
¡©us
 = 
DOCA_ERROR_NO_MEMORY
;

1246 
buf_ä“
;

1248 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
Ën
 =†en * 2;

1250 
m­s
[
i
] = (
ucc_mem_m­_t
 *)
	`ÿÎoc
(3, (ucc_mem_map_t));

1251 ià(
m­s
[
i
] =ğ
NULL
) {

1252 
	`DOCA_LOG_ERR
("Failedo‡llocate UCC memory map‡rray");

1253 
¡©us
 = 
DOCA_ERROR_NO_MEMORY
;

1254 
psync_ä“
;

1257 
m­s
[
i
][0].
add»ss
 =

1258 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
loÿl_wÜk_bufãr
;

1259 
m­s
[
i
][0].
Ën
 =†en * 2;

1260 
m­s
[
i
][1].
add»ss
 = 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
pSync
;

1261 
m­s
[
i
][1].
Ën
 = 
wÜk”_ucc_İts
.
num_psync
 * ();

1263 
cŞl_ùx
[
i
] = (cŞl_ùx *)
	`m®loc
((coll_ctx));

1264 ià(
cŞl_ùx
[
i
] =ğ
NULL
) {

1265 
	`DOCA_LOG_ERR
("Failedo‡llocate UCC worker coll context");

1266 
¡©us
 = 
DOCA_ERROR_NO_MEMORY
;

1267 
m­s_ä“
;

1270 ià(
¡ride
 <= 0) {

1271 
cŞl_ùx
[
i
]->
pids
 = (
št64_t
 *)
¡¬t
;

1273 
cŞl_ùx
[
i
]->
¡¬t
 = start;

1276 
cŞl_ùx
[
i
]->
¡ride
 = stride;

1277 
cŞl_ùx
[
i
]->
size
 = size;

1278 
cŞl_ùx
[
i
]->
šdex
 = 
my¿nk
;

1279 
cŞl_ùx
[
i
]->
ucc_wÜk”
 = ucc_worker;

1281 
ùx_·¿ms
.
mask
 = 
UCC_CONTEXT_PARAM_FIELD_OOB
 |

1282 
UCC_CONTEXT_PARAM_FIELD_MEM_PARAMS
;

1283 
ùx_·¿ms
.
oob
.
®lg©h”
 = 
urom_wÜk”_ucc_oob_®lg©h”
;

1284 
ùx_·¿ms
.
oob
.
»q_‹¡
 = 
urom_wÜk”_ucc_oob_®lg©h”_‹¡
;

1285 
ùx_·¿ms
.
oob
.
»q_ä“
 = 
urom_wÜk”_ucc_oob_®lg©h”_ä“
;

1286 
ùx_·¿ms
.
oob
.
cŞl_šfo
 = (*)
cŞl_ùx
[
i
];

1287 
ùx_·¿ms
.
oob
.
n_oob_•s
 = 
size
;

1288 
ùx_·¿ms
.
oob
.
oob_•
 = 
my¿nk
;

1289 
ùx_·¿ms
.
mem_·¿ms
.
£gm’ts
 = 
m­s
[
i
];

1290 
ùx_·¿ms
.
mem_·¿ms
.
n_£gm’ts
 = 2;

1292 
ucc_¡©us
 = 
	`ucc_cÚ‹xt_ü—‹
(

1293 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_lib
,

1294 &
ùx_·¿ms
,

1295 
ùx_cÚfig
,

1296 &
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_cÚ‹xt
);

1297 ià(
ucc_¡©us
 !ğ
UCC_OK
) {

1298 
	`DOCA_LOG_ERR
("Failedo create UCC context");

1299 
¡©us
 = 
DOCA_ERROR_DRIVER
;

1300 
cŞl_ä“
;

1302 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

1305 ià(
ùx_id
 == 0) {

1306 
n_th»ads
 = 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
;

1307 
rgs
 = 
	`ÿÎoc
(
n_th»ads
, (*targs));

1308 ià(
rgs
 =ğ
NULL
) {

1309 
	`DOCA_LOG_ERR
("Failedo createhreads‡rgs");

1310 
¡©us
 = 
DOCA_ERROR_NO_MEMORY
;

1311 
cÚ‹xt_de¡roy
;

1313 
´og»ss_th»ad
 = 
	`ÿÎoc
(
n_th»ads
, (*progress_thread));

1314 ià(
´og»ss_th»ad
 =ğ
NULL
) {

1315 
	`DOCA_LOG_ERR
("Failedo createhreads‡rgs");

1316 
¡©us
 = 
DOCA_ERROR_NO_MEMORY
;

1317 
rgs_ä“
;

1320 
	`DOCA_LOG_DBG
("C»©šg [%ld]…rog»s %luh»ads", 
my¿nk
, 
n_th»ads
);

1321 
i
 = 0; i < 
n_th»ads
; i++) {

1322 
rgs
[
i
].
th»ad_id
 = i;

1323 
rgs
[
i
].
ucc_wÜk”
 = ucc_worker;

1324 
»t
 = 
	`±h»ad_ü—‹
(&
´og»ss_th»ad
[
i
],

1325 
NULL
,

1326 
urom_wÜk”_ucc_´og»ss_th»ad
,

1327 (*)&
rgs
[
i
]);

1328 ià(
»t
 != 0) {

1329 
	`DOCA_LOG_ERR
("Failedo create…rogresshread");

1330 
¡©us
 = 
DOCA_ERROR_IO_FAILED
;

1331 
th»ads_ä“
;

1336 
¡©us
 = 
DOCA_SUCCESS
;

1337 
ucc_nÙif
->
cÚ‹xt_ü—‹_nqe
.
cÚ‹xt
 =

1338 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ucc_cÚ‹xt
;

1339 
	`DOCA_LOG_DBG
("UCC context created, ctx_id %lu, context %p",

1340 
ùx_id
, 
ucc_wÜk”
->
ucc_d©a
[ùx_id].
ucc_cÚ‹xt
);

1341 
ex™
;

1343 
th»ads_ä“
:

1344 
j
 = 0; j < 
i
; j++) {

1345 
	`±h»ad_ÿnûl
(
´og»ss_th»ad
[
j
]);

1347 
	`ä“
(
´og»ss_th»ad
);

1348 
rgs_ä“
:

1349 
	`ä“
(
rgs
);

1350 
cÚ‹xt_de¡roy
:

1351 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

1352 if(
ucc_wÜk”
->
ucc_d©a
[
ùx_id
*
wÜk”_ucc_İts
.
p
 + 
i
].
ucc_cÚ‹xt
) {

1353 
	`ucc_cÚ‹xt_de¡roy
(

1354 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
*
wÜk”_ucc_İts
.
p
 + 
i
].
ucc_cÚ‹xt
);

1357 
cŞl_ä“
:

1358 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

1359 if(
cŞl_ùx
[
i
]) {

1360 
	`ä“
(
cŞl_ùx
[
i
]);

1363 
	`ä“
(
cŞl_ùx
);

1364 
m­s_ä“
:

1365 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

1366 if(
m­s
[
i
]) {

1367 
	`ä“
(
m­s
[
i
]);

1370 
	`ä“
(
m­s
);

1371 
psync_ä“
:

1372 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

1373 if(
ucc_wÜk”
->
ucc_d©a
[
ùx_id
*
wÜk”_ucc_İts
.
p
 + 
i
].
pSync
) {

1374 
	`ä“
(
ucc_wÜk”
->
ucc_d©a
[
ùx_id
*
wÜk”_ucc_İts
.
p
 + 
i
].
pSync
);

1377 
buf_ä“
:

1378 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

1379 if(
ucc_wÜk”
->
ucc_d©a
[
ùx_id
*
wÜk”_ucc_İts
.
p
 + 
i
].

1380 
loÿl_wÜk_bufãr
) {

1381 
	`ä“
(
ucc_wÜk”
->
ucc_d©a
[
ùx_id
*
wÜk”_ucc_İts
.
p
 + 
i
].

1382 
loÿl_wÜk_bufãr
);

1385 
cfg_»Ëa£
:

1386 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

1387 
ç
:

1388 
ex™
:

1389 
nd
->
wÜk”_nÙif
.
¡©us
 = status;

1390 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

1391 
	`ä“
(
¬gs
);

1392 
	`±h»ad_ex™
(
NULL
);

1393 
	}
}

1402 
doÿ_”rÜ_t


1403 
	$urom_wÜk”_ucc_cÚ‹xt_ü—‹
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

1404 
urom_wÜk”_cmd_desc
 *
cmd_desc
)

1406 
urom_wÜk”_cmd
 *
cmd
 = (urom_worker_cmd *)

1407 &
cmd_desc
->
wÜk”_cmd
;

1408 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
 = (urom_worker_ucc_cmd *)

1409 
cmd
->
¶ugš_cmd
;

1410 
urom_wÜk”_nÙif_desc
 *
nd
;

1411 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
;

1412 
»t
;

1413 
ùx_th»ad_¬gs
 *
¬gs
;

1415 
¬gs
 = 
	`ÿÎoc
(1, (*args));

1416 ià(
¬gs
 =ğ
NULL
) {

1417  
DOCA_ERROR_NO_MEMORY
;

1420 
¬gs
->
nÙif_ty³
 = 
cmd
->
ty³
;

1421 
¬gs
->
urom_cÚ‹xt
 = 
cmd
->urom_context;

1422 
¬gs
->
¡¬t
 = 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.start;

1423 
¬gs
->
¡ride
 = 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.stride;

1424 
¬gs
->
size
 = 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.size;

1425 
¬gs
->
my¿nk
 = 
ucc_cmd
->
dpu_wÜk”_id
;

1426 
¬gs
->
ba£_va
 = 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.base_va;

1427 
¬gs
->
Ën
 = 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.len;

1428 
¬gs
->
de¡_id
 = 
cmd_desc
->dest_id;

1429 
¬gs
->
ucc_wÜk”
 = ucc_worker;

1431 
»t
 = 
	`±h»ad_ü—‹
(&
cÚ‹xt_´og»ss_th»ad
, 
NULL
,

1432 
urom_wÜk”_ucc_ùx_´og»ss_th»ad
, (*)
¬gs
);

1433 ià(
»t
 != 0) {

1434 
nd
 = 
	`ÿÎoc
(1, (*ndè+ (*
ucc_nÙif
));

1435 ià(
nd
 =ğ
NULL
) {

1436  
DOCA_ERROR_NO_MEMORY
;

1439 
nd
->
de¡_id
 = 
cmd_desc
->dest_id;

1440 
nd
->
wÜk”_nÙif
.
¡©us
 = 
DOCA_ERROR_IO_FAILED
;

1441 
nd
->
wÜk”_nÙif
.
ty³
 = 
cmd
->type;

1442 
nd
->
wÜk”_nÙif
.
Ën
 = (*
ucc_nÙif
);

1443 
nd
->
wÜk”_nÙif
.
urom_cÚ‹xt
 = 
cmd
->urom_context;

1444 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)

1445 
nd
->
wÜk”_nÙif
.
¶ugš_nÙif
;

1446 
ucc_nÙif
->
dpu_wÜk”_id
 = 
ucc_cmd
->dpu_worker_id;

1447 
ucc_nÙif
->
nÙify_ty³
 = 
UROM_WORKER_NOTIFY_UCC_CONTEXT_CREATE_COMPLETE
;

1448 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

1449  
DOCA_ERROR_IO_FAILED
;

1452  
DOCA_SUCCESS
;

1453 
	}
}

1462 
doÿ_”rÜ_t


1463 
	$urom_wÜk”_ucc_cÚ‹xt_de¡roy
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

1464 
urom_wÜk”_cmd_desc
 *
cmd_desc
)

1466 
urom_wÜk”_cmd
 *
cmd
 = (urom_worker_cmd *)

1467 &
cmd_desc
->
wÜk”_cmd
;

1468 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
 = (urom_worker_ucc_cmd *)

1469 
cmd
->
¶ugš_cmd
;

1470 
ušt64_t
 
ùx_id
, 
i
;

1471 
doÿ_”rÜ_t
 
¡©us
;

1472 
urom_wÜk”_nÙify
 *
nÙif
;

1473 
urom_wÜk”_nÙif_desc
 *
nd
;

1474 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
;

1477 
nd
 = 
	`ÿÎoc
(1, (*ndè+ (*
ucc_nÙif
));

1478 ià(
nd
 =ğ
NULL
) {

1479  
DOCA_ERROR_NO_MEMORY
;

1482 
nd
->
de¡_id
 = 
cmd_desc
->dest_id;

1483 
nÙif
 = (
urom_wÜk”_nÙify
 *)&
nd
->
wÜk”_nÙif
;

1484 
nÙif
->
ty³
 = 
cmd
->type;

1485 
nÙif
->
urom_cÚ‹xt
 = 
cmd
->urom_context;

1486 
nÙif
->
Ën
 = (*
ucc_nÙif
);

1488 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)

1489 
nÙif
->
¶ugš_nÙif
;

1490 
ucc_nÙif
->
nÙify_ty³
 = 
UROM_WORKER_NOTIFY_UCC_CONTEXT_DESTROY_COMPLETE
;

1491 
ucc_nÙif
->
dpu_wÜk”_id
 = 
ucc_cmd
->dpu_worker_id;

1493 
¡©us
 = 
	`wÜk”_ucc_de¡_lookup
(
ucc_wÜk”
, 
cmd_desc
->
de¡_id
, &
ùx_id
);

1494 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

1495 
	`DOCA_LOG_ERR
("Failedo†ookup command destination");

1496 
ex™
;

1499 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

1500 
ušt64_t
 
th»ad_ùx_id
 = 
ùx_id
 * 
wÜk”_ucc_İts
.
p
 + 
i
;

1502 ià(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_cÚ‹xt
) {

1503 ià(
	`ucc_cÚ‹xt_de¡roy
(

1504 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_cÚ‹xt
è!ğ
UCC_OK
) {

1505 
	`DOCA_LOG_ERR
("Failedo destroy UCC context");

1506 
¡©us
 = 
DOCA_ERROR_DRIVER
;

1507 
ex™
;

1509 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_cÚ‹xt
 = 
NULL
;

1513 
¡©us
 = 
DOCA_SUCCESS
;

1514 
ex™
:

1515 
nÙif
->
¡©us
 = status;

1516 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

1517  
¡©us
;

1518 
	}
}

1527 
doÿ_”rÜ_t


1528 
	$urom_wÜk”_ucc_‹am_ü—‹
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

1529 
urom_wÜk”_cmd_desc
 *
cmd_desc
)

1531 
urom_wÜk”_cmd
 *
cmd
 = (urom_worker_cmd *)

1532 &
cmd_desc
->
wÜk”_cmd
;

1533 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
 = (urom_worker_ucc_cmd *)

1534 
cmd
->
¶ugš_cmd
;

1535 
size_t
 
cu¼_‹am
 = 0;

1536 
urom_wÜk”_nÙif_desc
 *
nd
;

1537 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
;

1538 
ušt64_t
 
ùx_id
, 
i
;

1539 
ucc_•_m­_t
 
m­
;

1540 
doÿ_”rÜ_t
 
¡©us
;

1541 
ucc_¡©us_t
 
ucc_¡©us
;

1542 
cŞl_ùx
 *coll_ctx;

1543 
ucc_queue_–em’t
 *
qe
;

1544 
ucc_‹am_·¿ms_t
 
‹am_·¿ms
;

1545 
urom_wÜk”_nÙify
 *
nÙif
;

1546 
±h»ad_b¬r›r_t
 *
b¬r›r
;

1547 
ušt64_t
 
lv®ue
;

1550 
nd
 = 
	`ÿÎoc
(1, (*ndè+ (*
ucc_nÙif
));

1551 ià(
nd
 =ğ
NULL
) {

1552  
DOCA_ERROR_NO_MEMORY
;

1555 
nd
->
de¡_id
 = 
cmd_desc
->dest_id;

1556 
nÙif
 = (
urom_wÜk”_nÙify
 *)&
nd
->
wÜk”_nÙif
;

1557 
nÙif
->
ty³
 = 
cmd
->type;

1558 
nÙif
->
urom_cÚ‹xt
 = 
cmd
->urom_context;

1559 
nÙif
->
Ën
 = (*
ucc_nÙif
);

1560 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)

1561 
nÙif
->
¶ugš_nÙif
;

1562 
ucc_nÙif
->
nÙify_ty³
 = 
UROM_WORKER_NOTIFY_UCC_TEAM_CREATE_COMPLETE
;

1563 
ucc_nÙif
->
dpu_wÜk”_id
 = 
ucc_cmd
->dpu_worker_id;

1565 
¡©us
 = 
	`wÜk”_ucc_de¡_lookup
(
ucc_wÜk”
, 
cmd_desc
->
de¡_id
, &
ùx_id
);

1566 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

1567 
	`DOCA_LOG_ERR
("Failedo†ookup command destination");

1568 
ex™
;

1571 
b¬r›r
 = 
	`m®loc
((
±h»ad_b¬r›r_t
));

1572 
	`±h»ad_b¬r›r_š™
(
b¬r›r
, 
NULL
, 
wÜk”_ucc_İts
.
p
);

1574 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

1575 
ušt64_t
 
th»ad_ùx_id
 = 
ùx_id
 * 
wÜk”_ucc_İts
.
p
 + 
i
;

1577 
cu¼_‹am
 = 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
n_‹ams
;

1578 ià(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_cÚ‹xt
 =ğ
NULL
 ||

1579 
ucc_cmd
->
‹am_ü—‹_cmd
.
cÚ‹xt_h
 !=

1580 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ucc_cÚ‹xt
) {

1581 
	`DOCA_LOG_ERR
("Attemptingo create UCC "

1583 
¡©us
 = 
DOCA_ERROR_INVALID_VALUE
;

1584 
ex™
;

1587 ià(
ucc_cmd
->
‹am_ü—‹_cmd
.
¡ride
 <= 0) {

1588 
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

1589 
m­
.
•_num
 = 
ucc_cmd
->
‹am_ü—‹_cmd
.
size
;

1590 
m­
.
¬¿y
.m­ = (*)
ucc_cmd
->
‹am_ü—‹_cmd
.
¡¬t
;

1591 
m­
.
¬¿y
.
–em_size
 = 8;

1593 
m­
.
ty³
 = 
UCC_EP_MAP_STRIDED
;

1594 
m­
.
•_num
 = 
ucc_cmd
->
‹am_ü—‹_cmd
.
size
;

1595 
m­
.
¡rided
.
¡¬t
 = 
ucc_cmd
->
‹am_ü—‹_cmd
.start;

1596 
m­
.
¡rided
.
¡ride
 = 
ucc_cmd
->
‹am_ü—‹_cmd
.stride;

1599 
‹am_·¿ms
.
mask
 = 
UCC_TEAM_PARAM_FIELD_EP
 |

1600 
UCC_TEAM_PARAM_FIELD_TEAM_SIZE
 |

1601 
UCC_TEAM_PARAM_FIELD_EP_MAP
 |

1602 
UCC_TEAM_PARAM_FIELD_EP_RANGE
;

1603 
‹am_·¿ms
.
•
 = 
ucc_cmd
->
dpu_wÜk”_id
;

1604 
‹am_·¿ms
.
•_m­
 = 
m­
;

1605 
‹am_·¿ms
.
•_¿nge
 = 
UCC_COLLECTIVE_EP_RANGE_CONTIG
;

1606 
‹am_·¿ms
.
‹am_size
 = 
ucc_cmd
->
‹am_ü—‹_cmd
.
size
;

1608 
cŞl_ùx
 = (cŞl_ùx *è
	`m®loc
((*coll_ctx));

1609 ià(
cŞl_ùx
 =ğ
NULL
) {

1610 
	`DOCA_LOG_ERR
("Failedo‡llocate collective context");

1611 
¡©us
 = 
DOCA_ERROR_NO_MEMORY
;

1612 
ex™
;

1615 
cŞl_ùx
->
¡¬t
 = 
ucc_cmd
->
‹am_ü—‹_cmd
.start;

1616 
cŞl_ùx
->
¡ride
 = 
ucc_cmd
->
‹am_ü—‹_cmd
.stride;

1617 
cŞl_ùx
->
size
 = 
ucc_cmd
->
‹am_ü—‹_cmd
.size;

1618 
cŞl_ùx
->
šdex
 = 
ucc_cmd
->
dpu_wÜk”_id
;

1619 
cŞl_ùx
->
ucc_wÜk”
 = ucc_worker;

1621 ià(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_‹am
 =ğ
NULL
) {

1622 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_‹am
 =

1623 
	`m®loc
((
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_‹am
));

1624 ià(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_‹am
 =ğ
NULL
) {

1625 
¡©us
 = 
DOCA_ERROR_NO_MEMORY
;

1626 
cŞl_ä“
;

1630 
ucc_¡©us
 = 
	`ucc_‹am_ü—‹_po¡
(

1631 &
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_cÚ‹xt
,

1633 &
‹am_·¿ms
,

1634 &
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_‹am
[
cu¼_‹am
]);

1636 ià(
ucc_¡©us
 !ğ
UCC_OK
) {

1637 
	`DOCA_LOG_ERR
("ucc_team_create_post() failed");

1638 
¡©us
 = 
DOCA_ERROR_DRIVER
;

1639 
‹am_ä“
;

1641 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
n_‹ams
++;

1643 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

1644 
lv®ue
 != 0) {

1645 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

1647 
¡©us
 = 
	`fšd_qe_¦Ù
(
th»ad_ùx_id
, 
ucc_wÜk”
, &
qe
);

1648 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 1, 0);

1649 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

1650 
	`DOCA_LOG_ERR
("Failedo find queue slot foream creation");

1651 
‹am_ä“
;

1654 
qe
->
ty³
 = 
UCC_WORKER_QUEUE_ELEMENT_TYPE_TEAM_CREATE
;

1655 
qe
->
cŞl_ùx
 = coll_ctx;

1656 
qe
->
de¡_id
 = 
cmd_desc
->dest_id;

1657 
qe
->
ùx_id
 = 
th»ad_ùx_id
;

1658 
qe
->
‹am_id
 = 
cu¼_‹am
;

1659 
qe
->
my¿nk
 = 
ucc_cmd
->
dpu_wÜk”_id
;

1660 
qe
->
š_u£
 = 1;

1661 
qe
->
b¬r›r
 = barrier;

1662 ià(
i
 == 0) {

1663 
qe
->
nd
 =‚d;

1665 
qe
->
nd
 = 
NULL
;

1667 
	`ucs_©omic_add64
(

1668 &
queue_size
[
th»ad_ùx_id
 % 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
],

1673 
‹am_ä“
:

1674 
	`ä“
(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_‹am
);

1675 
cŞl_ä“
:

1676 
	`ä“
(
cŞl_ùx
);

1677 
ex™
;

1680  
DOCA_SUCCESS
;

1682 
ex™
:

1683 
nÙif
->
¡©us
 = status;

1684 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

1685  
¡©us
;

1686 
	}
}

1688 
size_t
 
	$urom_wÜk”_g‘_dt_size
(
ucc_d©©y³_t
 
dt
)

1690 
size_t
 
size_mod
 = 8;

1691 
dt
) {

1692 
UCC_DT_INT8
:

1693 
UCC_DT_UINT8
:

1694 
size_mod
 = ();

1696 
UCC_DT_INT32
:

1697 
UCC_DT_UINT32
:

1698 
UCC_DT_FLOAT32
:

1699 
size_mod
 = ();

1701 
UCC_DT_INT64
:

1702 
UCC_DT_UINT64
:

1703 
UCC_DT_FLOAT64
:

1704 
size_mod
 = (
ušt64_t
);

1706 
UCC_DT_INT128
:

1707 
UCC_DT_UINT128
:

1708 
UCC_DT_FLOAT128
:

1709 
size_mod
 = (
__št128_t
);

1714  
size_mod
;

1715 
	}
}

1718 
doÿ_”rÜ_t
 
	$po¡_Áh»ads_cŞls
(

1719 
ušt64_t
 
ùx_id
, 
urom_wÜk”_ucc
 *
ucc_wÜk”
,

1720 
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
,

1721 
ucc_‹am_h
 
ucc_‹am
, 
ušt64_t
 
my¿nk
, 
š_¶aû
,

1722 
ucc__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo_t
 *
gwbi
,

1723 
urom_wÜk”_nÙif_desc
 *
nd
,

1724 
urom_wÜk”_cmd_desc
 *
cmd_desc
,

1725 
urom_wÜk”_nÙify
 *
nÙif
,

1726 
ucc_wÜk”_key_buf
 *
key_du¶iÿ‹_³r_¿nk
)

1728 
doÿ_”rÜ_t
 
¡©us
 = 
DOCA_SUCCESS
;

1729 
±h»ad_b¬r›r_t
 *
b¬r›r
 = 
NULL
;

1730 
št64_t
 
‹am_idx
 = 0;

1731 
size_t
 
th»ads
 = 
wÜk”_ucc_İts
.
p
;

1732 
size_t
 
¤c_couÁ
 = 
cŞl_¬gs
->
¤c
.
šfo
.
couÁ
;

1733 
size_t
 
d¡_couÁ
 = 
cŞl_¬gs
->
d¡
.
šfo
.
couÁ
;

1734 
size_t
 
¤c_th»ad_couÁ
 = 
¤c_couÁ
 / 
th»ads
;

1735 
size_t
 
d¡_th»ad_couÁ
 = 
d¡_couÁ
 / 
th»ads
;

1736 
size_t
 
¤c_th»ad_size
 = 
¤c_th»ad_couÁ
 *

1737 
	`urom_wÜk”_g‘_dt_size
(

1738 
cŞl_¬gs
->
¤c
.
šfo
.
d©©y³
);

1739 
size_t
 
d¡_th»ad_size
 = 
d¡_th»ad_couÁ
 *

1740 
	`urom_wÜk”_g‘_dt_size
(

1741 
cŞl_¬gs
->
d¡
.
šfo
.
d©©y³
);

1742 *
¤c_buf
 = 
cŞl_¬gs
->
¤c
.
šfo
.
bufãr
;

1743 *
d¡_buf
 = 
cŞl_¬gs
->
d¡
.
šfo
.
bufãr
;

1744 
ucc_cŞl_»q_h
 
cŞl_»q
;

1745 
ucc_queue_–em’t
 *
qe
;

1746 
ucc_¡©us_t
 
ucc_¡©us
;

1747 
size_t
 
i
;

1748 
ušt64_t
 
lv®ue
;

1749 
št64_t
 
j
;

1751 
cŞl_¬gs
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
 |

1752 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
;

1753 
cŞl_¬gs
->
æags
 |ğ
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
;

1755 
cŞl_¬gs
->
glob®_wÜk_bufãr
 = 
gwbi
;

1757 
b¬r›r
 = 
	`m®loc
((
±h»ad_b¬r›r_t
));

1758 
	`±h»ad_b¬r›r_š™
(
b¬r›r
, 
NULL
, 
wÜk”_ucc_İts
.
p
);

1760 
i
 = 0; i < 
th»ads
; i++) {

1761 
ušt64_t
 
th»ad_ùx_id
 = 
ùx_id
*
wÜk”_ucc_İts
.
p
 + 
i
;

1763 
gwbi
 = 
	`m®loc
((
ucc__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo_t
));

1764 ià(
gwbi
 =ğ
NULL
) {

1765 
	`DOCA_LOG_ERR
("Failedo initialize UCC collective: "

1767 
¡©us
 = 
DOCA_ERROR_DRIVER
;

1768 
ç
;

1771 
gwbi
->
·cked_¤c_memh
 = 
key_du¶iÿ‹_³r_¿nk
[
i
].
rkeys
;

1772 
gwbi
->
·cked_d¡_memh
 = 
key_du¶iÿ‹_³r_¿nk
[
i
].
rkeys
 +

1773 
key_du¶iÿ‹_³r_¿nk
[
i
].
¤c_Ën
;

1775 
cŞl_¬gs
->
glob®_wÜk_bufãr
 = 
gwbi
;

1777 if(!
š_¶aû
) {

1778 
cŞl_¬gs
->
¤c
.
šfo
.
couÁ
 = 
¤c_th»ad_couÁ
;

1780 
cŞl_¬gs
->
d¡
.
šfo
.
couÁ
 = 
d¡_th»ad_couÁ
;

1782 if(!
š_¶aû
) {

1783 
cŞl_¬gs
->
¤c
.
šfo
.
bufãr
 = 
¤c_buf
 + 
i
 * 
¤c_th»ad_size
;

1785 
cŞl_¬gs
->
d¡
.
šfo
.
bufãr
 = 
d¡_buf
 + 
i
 * 
d¡_th»ad_size
;

1787 ià(
i
 =ğ
th»ads
 - 1) {

1788 if(!
š_¶aû
) {

1789 
cŞl_¬gs
->
¤c
.
šfo
.
couÁ
 +ğ
¤c_couÁ
 % 
th»ads
;

1791 
cŞl_¬gs
->
d¡
.
šfo
.
couÁ
 +ğ
d¡_couÁ
 % 
th»ads
;

1794 ià(
i
 == 0) {

1797 
j
 = 0; j < 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
n_‹ams
; j++) {

1798 ià(
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].
ucc_‹am
[
j
] == ucc_team) {

1799 
‹am_idx
 = 
j
;

1805 
ucc_¡©us
 = 
	`ucc_cŞËùive_š™
(
cŞl_¬gs
, &
cŞl_»q
,

1806 
ucc_wÜk”
->
ucc_d©a
[
th»ad_ùx_id
].

1807 
ucc_‹am
[
‹am_idx
]);

1808 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

1809 
	`DOCA_LOG_ERR
("Failedo initialize UCC collective: %s",

1810 
	`ucc_¡©us_¡ršg
(
ucc_¡©us
));

1811 
¡©us
 = 
DOCA_ERROR_DRIVER
;

1812 
ç
;

1815 ià(
th»ad_ùx_id
 >ğ
wÜk”_ucc_İts
.
num_´og»ss_th»ads
) {

1816 
	`DOCA_LOG_ERR
("Warning--possible deadlock: multiplehreads…osting"

1821 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

1822 
lv®ue
 != 0)

1823 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

1824 
¡©us
 = 
	`fšd_qe_¦Ù
(
th»ad_ùx_id
, 
ucc_wÜk”
, &
qe
);

1825 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 1, 0);

1826 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

1827 
	`DOCA_LOG_ERR
("Failedo find queue slot foream creation");

1828 
»q_de¡roy
;

1831 
qe
->
ty³
 = 
UCC_WORKER_QUEUE_ELEMENT_TYPE_COLLECTIVE
;

1832 
qe
->
cŞl_»q
 = coll_req;

1833 
qe
->
my¿nk
 = myrank;

1834 
qe
->
de¡_id
 = 
cmd_desc
->dest_id;

1835 
qe
->
Şd_de¡
 = 
NULL
;

1836 
qe
->
d©a_size
 = 0;

1837 
qe
->
gwbi
 = gwbi;

1838 
qe
->
de¡_·cked_key
 = 
NULL
;

1839 
qe
->
ùx_id
 = 
th»ad_ùx_id
;

1840 
qe
->
š_u£
 = 1;

1841 
qe
->
po¡ed
 = 0;

1842 
qe
->
b¬r›r
 = barrier;

1843 
qe
->
key_du¶iÿ‹_³r_¿nk
 = key_duplicate_per_rank;

1845 ià(
i
 == 0) {

1846 
qe
->
nd
 =‚d;

1848 
qe
->
nd
 = 
NULL
;

1851 
	`ucs_©omic_add64
(

1852 &
queue_size
[
th»ad_ùx_id
 % 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
],

1856  
DOCA_SUCCESS
;

1858 
»q_de¡roy
:

1859 
	`ucc_cŞËùive_fš®ize
(
cŞl_»q
);

1860 
ç
:

1861 
nÙif
->
¡©us
 = status;

1862 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

1863  
¡©us
;

1864 
	}
}

1874 
doÿ_”rÜ_t


1875 
	$urom_wÜk”_ucc_cŞl_š™
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

1876 
urom_wÜk”_cmd_desc
 *
cmd_desc
)

1878 
size_t
 
size
 = 0;

1879 
size_t
 
size_mod
 = 8;

1880 *
Şd_de¡
 = 
NULL
;

1881 *
·cked_key
 = 
NULL
;

1882 
urom_wÜk”_cmd
 *
cmd
 =

1883 (
urom_wÜk”_cmd
 *)&
cmd_desc
->
wÜk”_cmd
;

1884 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
 =

1885 (
urom_wÜk”_ucc_cmd
 *)
cmd
->
¶ugš_cmd
;

1886 
ucc__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo_t
 *
gwbi
 = 
NULL
;

1887 
š_¶aû
 = 0;

1888 
ucc_wÜk”_key_buf
 *
key_du¶iÿ‹_³r_¿nk
;

1889 
ucc_wÜk”_key_buf
 *
keys
;

1890 
ušt64_t
 
ùx_id
, 
my¿nk
, 
lv®ue
, 
i
;

1891 
ucc_‹am_h
 
‹am
;

1892 *
wÜk_bufãr
;

1893 
doÿ_”rÜ_t
 
¡©us
;

1894 
ucc_cŞl_»q_h
 
cŞl_»q
;

1895 
ucc_¡©us_t
 
ucc_¡©us
;

1896 
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
;

1897 
ucc_queue_–em’t
 *
qe
;

1898 
urom_wÜk”_nÙify
 *
nÙif
;

1899 
urom_wÜk”_nÙif_desc
 *
nd
;

1900 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
;

1903 
nd
 = 
	`ÿÎoc
(1, (*ndè+ (*
ucc_nÙif
));

1904 ià(
nd
 =ğ
NULL
) {

1905  
DOCA_ERROR_NO_MEMORY
;

1908 
nd
->
de¡_id
 = 
cmd_desc
->dest_id;

1910 
nÙif
 = (
urom_wÜk”_nÙify
 *)

1911 &
nd
->
wÜk”_nÙif
;

1912 
nÙif
->
ty³
 = 
cmd
->type;

1913 
nÙif
->
urom_cÚ‹xt
 = 
cmd
->urom_context;

1914 
nÙif
->
Ën
 = (*
ucc_nÙif
);

1916 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)

1917 
nÙif
->
¶ugš_nÙif
;

1918 
ucc_nÙif
->
nÙify_ty³
 = 
UROM_WORKER_NOTIFY_UCC_COLLECTIVE_COMPLETE
;

1919 
ucc_nÙif
->
dpu_wÜk”_id
 = 
ucc_cmd
->dpu_worker_id;

1921 ià(
ucc_cmd
->
cŞl_cmd
.
‹am
 =ğ
NULL
) {

1922 
	`DOCA_LOG_ERR
("Attemptingo…erform UCC collective without‡ UCCeam");

1923 
¡©us
 = 
DOCA_ERROR_INVALID_VALUE
;

1924 
ç
;

1927 
¡©us
 = 
	`wÜk”_ucc_de¡_lookup
(
ucc_wÜk”
, 
cmd_desc
->
de¡_id
, &
ùx_id
);

1928 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

1929 
	`DOCA_LOG_ERR
("Failedo†ookup command destination");

1930 
ç
;

1933 ià(
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr_size
 > 0 &&

1934 
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr
) {

1935 
wÜk_bufãr
 = 
ucc_cmd
->
cŞl_cmd
.work_buffer;

1937 
wÜk_bufãr
 = 
NULL
;

1940 
‹am
 = 
ucc_cmd
->
cŞl_cmd
.team;

1941 
cŞl_¬gs
 = 
ucc_cmd
->
cŞl_cmd
.coll_args;

1942 
my¿nk
 = 
ucc_cmd
->
dpu_wÜk”_id
;

1944 
	`COLL_CHECK
(
ucc_wÜk”
, 
ùx_id
, 
¡©us
);

1946 iàĞ(
cŞl_¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
 ) &&

1947 (
cŞl_¬gs
->
æags
 & 
UCC_COLL_ARGS_FLAG_IN_PLACE
) ) {

1948 
š_¶aû
 = 1;

1951 ià(
cŞl_¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_CB
)

1953 
cŞl_¬gs
->
mask
 = cŞl_¬gs->mask & (~
UCC_COLL_ARGS_FIELD_CB
);

1955 ià(
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLTOALL
 ||

1956 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLTOALLV
) {

1957 ià(!
ucc_cmd
->
cŞl_cmd
.
u£_xgvmi
) {

1958 
size_mod
 = 
	`urom_wÜk”_g‘_dt_size
(
cŞl_¬gs
->
¤c
.
šfo
.
d©©y³
);

1959 
size
 = 
cŞl_¬gs
->
¤c
.
šfo
.
couÁ
 * 
size_mod
;

1960 ià(
cŞl_¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
) {

1962 
keys
 = 
wÜk_bufãr
;

1963 
¡©us
 = 
	`ucc_rma_g‘_ho¡
(

1964 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
loÿl_wÜk_bufãr
,

1965 
cŞl_¬gs
->
¤c
.
šfo
.
bufãr
,

1966 
size
,

1967 
ùx_id
,

1968 
keys
->
rkeys
,

1969 
ucc_wÜk”
);

1970 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

1971 
	`DOCA_LOG_ERR
("UCC component unableo obtain source buffer");

1972 
ç
;

1974 
·cked_key
 = 
keys
->
rkeys
 + keys->
¤c_Ën
;

1977 
¡©us
 = 
	`ucc_rma_g‘
(

1978 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
loÿl_wÜk_bufãr
,

1979 
cŞl_¬gs
->
¤c
.
šfo
.
bufãr
,

1980 
size
,

1981 
MAX_HOST_DEST_ID
,

1982 
my¿nk
,

1983 
ùx_id
,

1984 
ucc_wÜk”
);

1985 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

1986 
	`DOCA_LOG_ERR
("UCC component unableo obtain source buffer");

1987 
ç
;

1990 
cŞl_¬gs
->
¤c
.
šfo
.
bufãr
 =

1991 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
loÿl_wÜk_bufãr
;

1992 
Şd_de¡
 = 
cŞl_¬gs
->
d¡
.
šfo
.
bufãr
;

1993 
cŞl_¬gs
->
d¡
.
šfo
.
bufãr
 =

1994 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
loÿl_wÜk_bufãr
 + 
size
;

1996 ià(!(
cŞl_¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
) ||

1997 !
wÜk_bufãr
) {

1998 
cŞl_¬gs
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
 |

1999 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
;

2000 
cŞl_¬gs
->
æags
 |ğ
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
;

2001 
cŞl_¬gs
->
glob®_wÜk_bufãr
 =

2002 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
pSync
 +

2003 (
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
psync_off£t
 %

2004 
wÜk”_ucc_İts
.
num_psync
);

2005 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
psync_off£t
++;

2007 ià(
wÜk_bufãr
 !ğ
NULL
) {

2008 
cŞl_¬gs
->
glob®_wÜk_bufãr
 = 
wÜk_bufãr
;

2011 } ià(
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLREDUCE
 ||

2012 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHER
) {

2013 ià(!
ucc_cmd
->
cŞl_cmd
.
u£_xgvmi
) {

2014 
	`DOCA_LOG_ERR
("Failedo initialize UCC collective:"

2016 
¡©us
 = 
DOCA_ERROR_DRIVER
;

2017 
ç
;

2019 ià(!(
cŞl_¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
) ||

2020 !
wÜk_bufãr
) {

2021 
	`DOCA_LOG_ERR
("Failedo initialize UCC collective:"

2023 
¡©us
 = 
DOCA_ERROR_DRIVER
;

2024 
ç
;

2027 
keys
 = 
wÜk_bufãr
;

2029 
gwbi
 = 
	`m®loc
((
ucc__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo_t
));

2030 ià(
gwbi
 =ğ
NULL
) {

2031 
	`DOCA_LOG_ERR
("Failedo initialize UCC collective: "

2033 
¡©us
 = 
DOCA_ERROR_DRIVER
;

2034 
ç
;

2037 
gwbi
->
·cked_¤c_memh
 = 
keys
->
rkeys
;

2038 
gwbi
->
·cked_d¡_memh
 = 
keys
->
rkeys
 + keys->
¤c_Ën
;

2040 
key_du¶iÿ‹_³r_¿nk
 = 
	`m®loc
((
ucc_wÜk”_key_buf
) *

2041 
wÜk”_ucc_İts
.
p
);

2042 ià(
key_du¶iÿ‹_³r_¿nk
 =ğ
NULL
) {

2043 
	`´štf
("couldnt malloc key_duplicate_per_rank\n");

2045 
i
 = 0; i < 
wÜk”_ucc_İts
.
p
; i++) {

2046 
	`memıy
(
key_du¶iÿ‹_³r_¿nk
[
i
].
rkeys
, 
keys
->rkeys,

2047 
keys
->
¤c_Ën
 + keys->
d¡_Ën
);

2048 
key_du¶iÿ‹_³r_¿nk
[
i
].
¤c_Ën
 = 
keys
->src_len;

2049 
key_du¶iÿ‹_³r_¿nk
[
i
].
d¡_Ën
 = 
keys
->dst_len;

2052 
¡©us
 = 
	`po¡_Áh»ads_cŞls
(

2053 
ùx_id
, 
ucc_wÜk”
, 
cŞl_¬gs
,

2054 
‹am
, 
my¿nk
, 
š_¶aû
,

2055 
gwbi
, 
nd
, 
cmd_desc
, 
nÙif
, 
key_du¶iÿ‹_³r_¿nk
);

2057  
¡©us
;

2060 
ucc_¡©us
 = 
	`ucc_cŞËùive_š™
(
cŞl_¬gs
, &
cŞl_»q
, 
‹am
);

2061 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

2062 
	`DOCA_LOG_ERR
("Failedo initialize UCC collective: %s",

2063 
	`ucc_¡©us_¡ršg
(
ucc_¡©us
));

2064 
¡©us
 = 
DOCA_ERROR_DRIVER
;

2065 
ç
;

2068 
ucc_¡©us
 = 
	`ucc_cŞËùive_po¡
(
cŞl_»q
);

2069 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

2070 
	`DOCA_LOG_ERR
("Failedo…ost UCC collective: %s",

2071 
	`ucc_¡©us_¡ršg
(
ucc_¡©us
));

2072 
¡©us
 = 
DOCA_ERROR_DRIVER
;

2073 
»q_de¡roy
;

2076 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

2077 
lv®ue
 != 0) {

2078 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 0, 1);

2080 
¡©us
 = 
	`fšd_qe_¦Ù
(
ùx_id
, 
ucc_wÜk”
, &
qe
);

2081 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
queue_lock
, 1, 0);

2082 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

2083 
	`DOCA_LOG_ERR
("Failedo find queue slot foream creation");

2084 
»q_de¡roy
;

2087 
qe
->
ty³
 = 
UCC_WORKER_QUEUE_ELEMENT_TYPE_COLLECTIVE
;

2088 
qe
->
cŞl_»q
 = coll_req;

2089 
qe
->
my¿nk
 = myrank;

2090 
qe
->
de¡_id
 = 
cmd_desc
->dest_id;

2091 ià(!
ucc_cmd
->
cŞl_cmd
.
u£_xgvmi
) {

2092 
	`DOCA_LOG_DBG
("S‘tšg old de¡Ø%p", 
Şd_de¡
);

2093 
qe
->
Şd_de¡
 = old_dest;

2094 
qe
->
d©a_size
 = 
size
;

2096 
qe
->
Şd_de¡
 = 
NULL
;

2097 
qe
->
d©a_size
 = 0;

2099 
qe
->
gwbi
 = gwbi;

2100 
qe
->
de¡_·cked_key
 = 
·cked_key
;

2101 
qe
->
ùx_id
 = ctx_id;

2102 
qe
->
š_u£
 = 1;

2103 
qe
->
po¡ed
 = 1;

2104 
qe
->
b¬r›r
 = 
NULL
;

2105 
qe
->
nd
 =‚d;

2106 
	`ucs_©omic_add64
(&
queue_size
[
ùx_id
 % 
wÜk”_ucc_İts
.
num_´og»ss_th»ads
],

2108  
DOCA_SUCCESS
;

2109 
»q_de¡roy
:

2110 
	`ucc_cŞËùive_fš®ize
(
cŞl_»q
);

2111 
ç
:

2112 
nÙif
->
¡©us
 = status;

2113 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

2114  
¡©us
;

2115 
	}
}

2124 
doÿ_”rÜ_t


2125 
	$urom_wÜk”_ucc_·ss_dc_ü—‹
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

2126 
urom_wÜk”_cmd_desc
 *
cmd_desc
)

2128 
urom_wÜk”_cmd
 *
cmd
 = (urom_worker_cmd *)

2129 &
cmd_desc
->
wÜk”_cmd
;

2130 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
 = (urom_worker_ucc_cmd *)

2131 
cmd
->
¶ugš_cmd
;

2132 
ušt64_t
 
ùx_id
;

2133 
uı_•_h
 
Ãw_•
;

2134 
doÿ_”rÜ_t
 
¡©us
;

2135 
ucs_¡©us_t
 
ucs_¡©us
;

2136 
uı_•_·¿ms_t
 
•_·¿ms
;

2137 
urom_wÜk”_nÙify
 *
nÙif
;

2138 
urom_wÜk”_nÙif_desc
 *
nd
;

2139 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙif
;

2142 
nd
 = 
	`ÿÎoc
(1, (*ndè+ (*
ucc_nÙif
));

2143 ià(
nd
 =ğ
NULL
)

2144  
DOCA_ERROR_NO_MEMORY
;

2146 
nd
->
de¡_id
 = 
cmd_desc
->dest_id;

2148 
nÙif
 = (
urom_wÜk”_nÙify
 *)&
nd
->
wÜk”_nÙif
;

2149 
nÙif
->
ty³
 = 
cmd
->type;

2150 
nÙif
->
urom_cÚ‹xt
 = 
cmd
->urom_context;

2151 
nÙif
->
Ën
 = (*
ucc_nÙif
);

2152 
ucc_nÙif
 = (
urom_wÜk”_nÙify_ucc
 *)

2153 
nÙif
->
¶ugš_nÙif
;

2154 
ucc_nÙif
->
nÙify_ty³
 =

2155 
UROM_WORKER_NOTIFY_UCC_PASSIVE_DATA_CHANNEL_COMPLETE
;

2156 
ucc_nÙif
->
dpu_wÜk”_id
 = 
ucc_cmd
->dpu_worker_id;

2158 
¡©us
 = 
	`wÜk”_ucc_de¡_lookup
(
ucc_wÜk”
, 
cmd_desc
->
de¡_id
, &
ùx_id
);

2159 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

2160 
	`DOCA_LOG_ERR
("Failedo†ookup command destination");

2161 
ç
;

2164 ià(
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ho¡
 =ğ
NULL
) {

2165 
•_·¿ms
.
f›ld_mask
 = 
UCP_EP_PARAM_FIELD_REMOTE_ADDRESS
 |

2166 
UCP_EP_PARAM_FIELD_ERR_HANDLER
 |

2167 
UCP_EP_PARAM_FIELD_ERR_HANDLING_MODE
;

2168 
•_·¿ms
.
”r_hªdËr
.
cb
 = 
urom_•_”r_cb
;

2169 
•_·¿ms
.
”r_hªdËr
.
¬g
 = 
NULL
;

2170 
•_·¿ms
.
”r_mode
 = 
UCP_ERR_HANDLING_MODE_PEER
;

2171 
•_·¿ms
.
add»ss
 = 
ucc_cmd
->
·ss_dc_ü—‹_cmd
.
uı_addr
;

2173 
ucs_¡©us
 = 
	`uı_•_ü—‹
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
,

2174 &
•_·¿ms
, &
Ãw_•
);

2175 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

2176 
	`DOCA_LOG_ERR
("ucp_ep_create()„eturned: %s",

2177 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
));

2178 
¡©us
 = 
DOCA_ERROR_DRIVER
;

2179 
ç
;

2182 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ho¡
 = 
Ãw_•
;

2183 
	`DOCA_LOG_DBG
("Created…assive data channel for host for„ank %lu",

2184 
ucc_cmd
->
dpu_wÜk”_id
);

2186 
	`DOCA_LOG_DBG
("Passive data channel‡lready created");

2188 
¡©us
 = 
DOCA_SUCCESS
;

2189 
ç
:

2190 
nÙif
->
¡©us
 = status;

2191 
	`ucc_wÜk”_§ã_push_nÙifiÿtiÚ
(
ucc_wÜk”
, 
nd
);

2192  
¡©us
;

2193 
	}
}

2202 
doÿ_”rÜ_t


2203 
	$urom_wÜk”_ucc_wÜk”_cmd
(
urom_wÜk”_ùx
 *
ùx
,

2204 
ucs_li¡_lšk_t
 *
cmd_li¡
)

2206 
doÿ_”rÜ_t
 
¡©us
 = 
DOCA_SUCCESS
;

2207 
urom_wÜk”_ucc
 *
ucc_wÜk”
 = (urom_worker_ucc *)

2208 
ùx
->
¶ugš_ùx
;

2209 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
;

2210 
urom_wÜk”_cmd_desc
 *
cmd_desc
;

2211 
urom_wÜk”_cmd
 *
cmd
;

2213 !
	`ucs_li¡_is_em±y
(
cmd_li¡
)) {

2214 
cmd_desc
 = 
	`ucs_li¡_exŒaù_h—d
(
cmd_li¡
,

2215 
urom_wÜk”_cmd_desc
, 
’Œy
);

2216 
¡©us
 = 
	`urom_wÜk”_ucc_cmd_uÅack
(&
cmd_desc
->
wÜk”_cmd
,

2217 
cmd_desc
->
wÜk”_cmd
.
Ën
, &
cmd
);

2218 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

2219 
	`ä“
(
cmd_desc
);

2220  
¡©us
;

2222 
ucc_cmd
 = (
urom_wÜk”_ucc_cmd
 *)
cmd
->
¶ugš_cmd
;

2223 
ucc_cmd
->
cmd_ty³
) {

2224 
UROM_WORKER_CMD_UCC_LIB_CREATE
:

2225 
¡©us
 = 
	`urom_wÜk”_ucc_lib_ü—‹
(
ucc_wÜk”
, 
cmd_desc
);

2227 
UROM_WORKER_CMD_UCC_LIB_DESTROY
:

2228 
¡©us
 = 
	`urom_wÜk”_ucc_lib_de¡roy
(
ucc_wÜk”
, 
cmd_desc
);

2230 
UROM_WORKER_CMD_UCC_CONTEXT_CREATE
:

2231 
¡©us
 = 
	`urom_wÜk”_ucc_cÚ‹xt_ü—‹
(
ucc_wÜk”
, 
cmd_desc
);

2233 
UROM_WORKER_CMD_UCC_CONTEXT_DESTROY
:

2234 
¡©us
 = 
	`urom_wÜk”_ucc_cÚ‹xt_de¡roy
(
ucc_wÜk”
, 
cmd_desc
);

2236 
UROM_WORKER_CMD_UCC_TEAM_CREATE
:

2237 
¡©us
 = 
	`urom_wÜk”_ucc_‹am_ü—‹
(
ucc_wÜk”
, 
cmd_desc
);

2239 
UROM_WORKER_CMD_UCC_COLL
:

2240 
¡©us
 = 
	`urom_wÜk”_ucc_cŞl_š™
(
ucc_wÜk”
, 
cmd_desc
);

2242 
UROM_WORKER_CMD_UCC_CREATE_PASSIVE_DATA_CHANNEL
:

2243 
¡©us
 = 
	`urom_wÜk”_ucc_·ss_dc_ü—‹
(
ucc_wÜk”
, 
cmd_desc
);

2246 
	`DOCA_LOG_INFO
("Inv®id UCC commªdy³: %u", 
ucc_cmd
->
cmd_ty³
);

2247 
¡©us
 = 
DOCA_ERROR_INVALID_VALUE
;

2250 
	`ä“
(
cmd_desc
);

2251 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

2252  
¡©us
;

2256  
¡©us
;

2257 
	}
}

2269 
doÿ_”rÜ_t


2270 
	$urom_wÜk”_ucc_addr
(
urom_wÜk”_ùx
 *
wÜk”_ùx
,

2271 *
addr
, 
ušt64_t
 *
addr_Ën
)

2273 
urom_wÜk”_ucc
 *
ucc_wÜk”
 = (urom_worker_ucc *)

2274 
wÜk”_ùx
->
¶ugš_ùx
;

2275 
ucs_¡©us_t
 
¡©us
;

2277 ià(
ucc_wÜk”
->
uı_d©a
.
wÜk”_add»ss
 =ğ
NULL
) {

2278 
¡©us
 = 
	`uı_wÜk”_g‘_add»ss
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
,

2279 &
ucc_wÜk”
->
uı_d©a
.
wÜk”_add»ss
,

2280 &
ucc_wÜk”
->
uı_d©a
.
uı_add¾’
);

2281 ià(
¡©us
 !ğ
UCS_OK
) {

2282 
	`DOCA_LOG_ERR
("Failedo get ucp worker‡ddress");

2283  
DOCA_ERROR_INITIALIZATION
;

2287 ià(*
addr_Ën
 < 
ucc_wÜk”
->
uı_d©a
.
uı_add¾’
) {

2289 *
addr_Ën
 = 
ucc_wÜk”
->
uı_d©a
.
uı_add¾’
;

2290  
DOCA_ERROR_INVALID_VALUE
;

2293 *
addr_Ën
 = 
ucc_wÜk”
->
uı_d©a
.
uı_add¾’
;

2294 
	`memıy
(
addr
, 
ucc_wÜk”
->
uı_d©a
.
wÜk”_add»ss
, *
addr_Ën
);

2295  
DOCA_SUCCESS
;

2296 
	}
}

2305 
doÿ_”rÜ_t


2306 
	$urom_wÜk”_ucc_´og»ss
(
urom_wÜk”_ùx
 *
ùx
,

2307 
ucs_li¡_lšk_t
 *
nÙif_li¡
)

2309 
ušt64_t
 
lv®ue
 = 0;

2310 
urom_wÜk”_ucc
 *
ucc_wÜk”
 = (urom_worker_ucc *)

2311 
ùx
->
¶ugš_ùx
;

2312 
urom_wÜk”_nÙif_desc
 *
nd
;

2314 ià(
	`ucs_li¡_is_em±y
(&
ucc_wÜk”
->
com¶‘ed_»qs
)) {

2315  
DOCA_ERROR_EMPTY
;

2318 ià(
ucc_compÚ’t_’abËd
) {

2319 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
ucc_wÜk”
->
li¡_lock
, 0, 1);

2320 
lv®ue
 != 0) {

2321 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
ucc_wÜk”
->
li¡_lock
, 0, 1);

2325 !
	`ucs_li¡_is_em±y
(&
ucc_wÜk”
->
com¶‘ed_»qs
)) {

2326 
nd
 = 
	`ucs_li¡_exŒaù_h—d
(&
ucc_wÜk”
->
com¶‘ed_»qs
,

2327 
urom_wÜk”_nÙif_desc
, 
’Œy
);

2328 
	`ucs_li¡_add_
(
nÙif_li¡
, &
nd
->
’Œy
);

2331 ià(
ucc_compÚ’t_’abËd
) {

2332 
lv®ue
 = 
	`ucs_©omic_csw­64
(&
ucc_wÜk”
->
li¡_lock
, 1, 0);

2335  
DOCA_SUCCESS
;

2336 
	}
}

2346 
doÿ_”rÜ_t


2347 
	$urom_wÜk”_ucc_nÙif_·ck
(
urom_wÜk”_nÙify
 *
nÙif
,

2348 
size_t
 *
·cked_nÙif_Ën
,

2349 *
·cked_nÙif
)

2351 *
·ck_
 = 
·cked_nÙif
;

2352 
·ck_Ën
;

2353 *
·ck_h—d
;

2356 
·ck_Ën
 = 
	`ucs_off£tof
(
urom_wÜk”_nÙify
, 
¶ugš_nÙif
)

2357 + (
urom_wÜk”_nÙify_ucc
);

2358 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

2360 
	`memıy
(
·ck_h—d
, 
nÙif
, 
·ck_Ën
);

2361 *
·cked_nÙif_Ën
 = 
·ck_Ën
;

2363  
DOCA_SUCCESS
;

2364 
	}
}

2367 
urom_wÜk”_ucc_içû
 
	gurom_wÜk”_ucc
 = {

2368 .
su³r
.
İ’
 = 
urom_wÜk”_ucc_İ’
,

2369 .
	gsu³r
.
	gşo£
 = 
urom_wÜk”_ucc_şo£
,

2370 .
	gsu³r
.
	gaddr
 = 
urom_wÜk”_ucc_addr
,

2371 .
	gsu³r
.
	gwÜk”_cmd
 = 
urom_wÜk”_ucc_wÜk”_cmd
,

2372 .
	gsu³r
.
	g´og»ss
 = 
urom_wÜk”_ucc_´og»ss
,

2373 .
	gsu³r
.
	gnÙif_·ck
 = 
urom_wÜk”_ucc_nÙif_·ck
,

2376 
doÿ_”rÜ_t
 
	$urom_¶ugš_g‘_içû
(
urom_¶ugš_içû
 *
içû
)

2378 ià(
içû
 =ğ
NULL
) {

2379  
DOCA_ERROR_INVALID_VALUE
;

2381 
	`DOCA_STRUCT_CTOR
(
urom_wÜk”_ucc
.
su³r
);

2382 *
içû
 = 
urom_wÜk”_ucc
.
su³r
;

2383  
DOCA_SUCCESS
;

2384 
	}
}

2386 
doÿ_”rÜ_t
 
	$urom_¶ugš_g‘_v”siÚ
(
ušt64_t
 *
v”siÚ
)

2388 ià(
v”siÚ
 =ğ
NULL
) {

2389  
DOCA_ERROR_INVALID_VALUE
;

2391 *
v”siÚ
 = 
¶ugš_v”siÚ
;

2392  
DOCA_SUCCESS
;

2393 
	}
}

	@contrib/doca_urom_ucc_plugin/dpu/worker_ucc.h

14 #iâdeà
WORKER_UCC_H_


15 
	#WORKER_UCC_H_


	)

17 
	~<ucc/­i/ucc.h
>

18 
	~<uı/­i/uı.h
>

19 
	~<ucs/d©a¡ruù/khash.h
>

21 
	~<doÿ_log.h
>

22 
	~<doÿ_”rÜ.h
>

23 
	~<doÿ_urom_¶ugš.h
>

25 
	~"../commÚ/urom_ucc.h
"

27 
	#MAX_HOST_DEST_ID
 
INT_MAX


	)

28 
	#MIN_THREADS
 1

	)

31 
	#COLL_CHECK
(
ucc_wÜk”
, 
ùx_id
, 
¡©us
) \

33 ià(
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ucc_lib
 =ğ
NULL
) { \

34 
	`DOCA_LOG_ERR
("Attemptingo…erform ucc collective " \

36 
¡©us
 = 
DOCA_ERROR_NOT_FOUND
; \

37 
ç
; \

40 ià(
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ucc_cÚ‹xt
 =ğ
NULL
) { \

41 
	`DOCA_LOG_ERR
("Attemptingo…erform ucc collective " \

43 
¡©us
 = 
DOCA_ERROR_NOT_FOUND
; \

44 
ç
; \

46 }

	)

50 
	#urom_ucc_£rŸlize_Ãxt_¿w
(
_™”
, 
_ty³
, 
_off£t
) \

52 
_ty³
 *
_»suÉ
 = (_ty³ *)(*(
_™”
)); \

53 *(
_™”
èğ
	`UCS_PTR_BYTE_OFFSET
(*(_™”), 
_off£t
); \

54 
_»suÉ
; \

55 })

	)

58 
	swÜk”_ucc_İts
 {

59 
ušt64_t
 
	mnum_´og»ss_th»ads
;

60 
ušt64_t
 
	mdpu_wÜk”_bšdšg_¡ride
;

61 
ušt64_t
 
	mµw
;

62 
ušt64_t
 
	mp
;

63 
ušt64_t
 
	mli¡_size
;

64 
ušt64_t
 
	mnum_psync
;

68 
	eucc_wÜk”_queue_–em’t_ty³
 {

69 
	mUCC_WORKER_QUEUE_ELEMENT_TYPE_TEAM_CREATE
,

70 
	mUCC_WORKER_QUEUE_ELEMENT_TYPE_COLLECTIVE
,

74 
	surom_wÜk”_ucc_içû
 {

75 
urom_¶ugš_içû
 
	msu³r
;

79 
	succ_d©a
 {

80 
ucc_lib_h
 
	mucc_lib
;

81 
ucc_lib_©Œ_t
 
	mucc_lib_©Œ
;

82 
ucc_cÚ‹xt_h
 
	mucc_cÚ‹xt
;

83 
ucc_‹am_h
 *
	mucc_‹am
;

84 
št64_t
 
	mn_‹ams
;

85 *
	mpSync
;

86 
ušt64_t
 
	mpsync_off£t
;

87 *
	mloÿl_wÜk_bufãr
;

88 
size_t
 
	mËn
;

89 
uı_•_h
 
	mho¡
;

93 
KHASH_MAP_INIT_INT64
(
•
, 
uı_•_h
);

95 
KHASH_MAP_INIT_INT64
(
memh
, 
uı_mem_h
);

97 
KHASH_MAP_INIT_INT64
(
rkeys
, 
uı_rkey_h
);

100 
	succ_uı_d©a
 {

101 
uı_cÚ‹xt_h
 
	muı_cÚ‹xt
;

102 
uı_wÜk”_h
 
	muı_wÜk”
;

103 
uı_add»ss_t
 *
	mwÜk”_add»ss
;

104 
size_t
 
	muı_add¾’
;

105 
khash_t
(
•
è*
	m•s
;

106 
khash_t
(
memh
è*
	mmemh
;

107 
khash_t
(
rkeys
è*
	mrkeys
;

111 
KHASH_MAP_INIT_INT64
(
ùx_id
, 
ušt64_t
);

113 
	surom_wÜk”_ucc
 {

114 
urom_wÜk”_ùx
 *
	msu³r
;

115 
ucc_d©a
 *
	mucc_d©a
;

116 
ucc_uı_d©a
 
	muı_d©a
;

117 
ušt64_t
 
	mli¡_lock
;

118 
ucs_li¡_lšk_t
 
	mcom¶‘ed_»qs
;

119 
ucc_queue_–em’t
 **
	mqueue
;

120 
khash_t
(
ùx_id
è*
	mids
;

121 
ušt64_t
 
	mùx_id
;

122 
ušt64_t
 
	mÄ_cÚÃùiÚs
;

126 
	sùx_th»ad_¬gs
 {

127 
ušt64_t
 
	mnÙif_ty³
;

128 
ušt64_t
 
	murom_cÚ‹xt
;

129 
št64_t
 
	m¡¬t
;

130 
št64_t
 
	m¡ride
;

131 
št64_t
 
	msize
;

132 
št64_t
 
	mmy¿nk
;

133 *
	mba£_va
;

134 
size_t
 
	mËn
;

135 
ušt64_t
 
	mde¡_id
;

136 
urom_wÜk”_ucc
 *
	mucc_wÜk”
;

140 
	scŞl_ùx
 {

142 
št64_t
 
	m¡¬t
;

143 
št64_t
 *
	mpids
;

145 
št64_t
 
	m¡ride
;

146 
št64_t
 
	msize
;

147 
št64_t
 
	mšdex
;

148 
urom_wÜk”_ucc
 *
	mucc_wÜk”
;

151 
	succ__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo
 {

152 *
	m·cked_¤c_memh
;

153 *
	m·cked_d¡_memh
;

154 } 
	tucc__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo_t
;

157 
	succ_queue_–em’t
 {

158 
ucc_wÜk”_queue_–em’t_ty³
 
	mty³
;

159 vŞ©
št64_t
 
	mš_u£
;

160 vŞ©
št64_t
 
	mpo¡ed
;

161 
ušt64_t
 
	mde¡_id
;

162 
ušt64_t
 
	mùx_id
;

163 
ušt64_t
 
	mmy¿nk
;

164 
±h»ad_b¬r›r_t
 *
	mb¬r›r
;

165 *
	mŞd_de¡
;

166 
size_t
 
	md©a_size
;

167 
ucc_cŞl_»q_h
 
	mcŞl_»q
;

168 
cŞl_ùx
 *
	mcŞl_ùx
;

169 
ušt64_t
 
	m‹am_id
;

170 *
	mde¡_·cked_key
;

171 
urom_wÜk”_nÙif_desc
 *
	mnd
;

172 
ucc_wÜk”_key_buf
 *
	mkey_du¶iÿ‹_³r_¿nk
;

173 
ucc__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo_t
 *
	mgwbi
;

177 
	soob_®lg©h”_»q
 {

178 *
	msbuf
;

179 *
	mrbuf
;

180 
size_t
 
	mmsgËn
;

181 *
	moob_cŞl_ùx
;

182 
	m™”
;

183 
	mšdex
;

184 *
	m¡©us
;

199 
doÿ_”rÜ_t
 
ucc_rma_put
(*
bufãr
,

200 *
rg‘
,

201 
size_t
 
msgËn
,

202 
ušt64_t
 
de¡
,

203 
ušt64_t
 
my¿nk
,

204 
ušt64_t
 
ùx_id
,

205 
urom_wÜk”_ucc
 *
ucc_wÜk”
);

219 
doÿ_”rÜ_t
 
ucc_rma_g‘
(*
bufãr
,

220 *
rg‘
,

221 
size_t
 
msgËn
,

222 
ušt64_t
 
de¡
,

223 
ušt64_t
 
my¿nk
,

224 
ušt64_t
 
ùx_id
,

225 
urom_wÜk”_ucc
 *
ucc_wÜk”
);

238 
doÿ_”rÜ_t
 
ucc_£nd_nb
(*
msg
,

239 
size_t
 
Ën
,

240 
št64_t
 
my¿nk
,

241 
št64_t
 
de¡
,

242 
urom_wÜk”_ucc
 *
ucc_wÜk”
,

243 *
»q
);

255 
doÿ_”rÜ_t
 
ucc_»cv_nb
(*
msg
,

256 
size_t
 
Ën
,

257 
št64_t
 
de¡
,

258 
urom_wÜk”_ucc
 *
ucc_wÜk”
,

259 *
»q
);

272 
doÿ_”rÜ_t
 
ucc_rma_g‘_ho¡
(*
bufãr
,

273 *
rg‘
,

274 
size_t
 
msgËn
,

275 
ušt64_t
 
ùx_id
,

276 *
·cked_key
,

277 
urom_wÜk”_ucc
 *
ucc_wÜk”
);

290 
doÿ_”rÜ_t
 
ucc_rma_put_ho¡
(*
bufãr
,

291 *
rg‘
,

292 
size_t
 
msgËn
,

293 
ušt64_t
 
ùx_id
,

294 *
·cked_key
,

295 
urom_wÜk”_ucc
 *
ucc_wÜk”
);

304 
urom_•_”r_cb
(*
¬g
, 
uı_•_h
 
•
, 
ucs_¡©us_t
 
ucs_¡©us
);

313 
doÿ_”rÜ_t
 
urom_¶ugš_g‘_içû
(
urom_¶ugš_içû
 *
içû
);

321 
doÿ_”rÜ_t
 
urom_¶ugš_g‘_v”siÚ
(
ušt64_t
 *
v”siÚ
);

	@contrib/doca_urom_ucc_plugin/dpu/worker_ucc_p2p.c

14 
	~<¡dšt.h
>

15 
	~<¡dlib.h
>

17 
	~"wÜk”_ucc.h
"

18 
	~"../commÚ/urom_ucc.h
"

20 
DOCA_LOG_REGISTER
(
UCC
::
DOCA_CL
 : 
WORKER_UCC_P2P
);

22 
	$urom_•_”r_cb
(*
¬g
, 
uı_•_h
 
•
, 
ucs_¡©us_t
 
ucs_¡©us
)

24 ()
¬g
;

25 ()
•
;

27 
	`DOCA_LOG_ERR
("Endpointƒrror detected, status: %s",

28 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
));

29 
	}
}

39 
doÿ_”rÜ_t
 
	$wÜk”_ucc_•_lookup
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

40 
ušt64_t
 
de¡
, 
uı_•_h
 *
•
)

42 
»t
;

43 
khšt_t
 
k
;

44 *
addr
;

45 
uı_•_h
 
Ãw_•
;

46 
doÿ_”rÜ_t
 
¡©us
;

47 
ucs_¡©us_t
 
ucs_¡©us
;

48 
uı_•_·¿ms_t
 
•_·¿ms
;

50 
k
 = 
	`kh_g‘
(
•
, 
ucc_wÜk”
->
uı_d©a
.
•s
, 
de¡
);

51 ià(
k
 !ğ
	`kh_’d
(
ucc_wÜk”
->
uı_d©a
.
•s
)) {

52 *
•
 = 
	`kh_v®ue
(
ucc_wÜk”
->
uı_d©a
.
•s
, 
k
);

53  
DOCA_SUCCESS
;

57 
¡©us
 = 
	`doÿ_urom_wÜk”_domaš_addr_lookup
(
ucc_wÜk”
->
su³r
,

58 
de¡
, &
addr
);

59 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

60 
	`DOCA_LOG_ERR
("Id‚Ù found iÀdomaš:: %#lx", 
de¡
);

61  
DOCA_ERROR_NOT_FOUND
;

64 
•_·¿ms
.
f›ld_mask
 = 
UCP_EP_PARAM_FIELD_REMOTE_ADDRESS
 |

65 
UCP_EP_PARAM_FIELD_ERR_HANDLER
 |

66 
UCP_EP_PARAM_FIELD_ERR_HANDLING_MODE
;

67 
•_·¿ms
.
”r_hªdËr
.
cb
 = 
urom_•_”r_cb
;

68 
•_·¿ms
.
”r_hªdËr
.
¬g
 = 
NULL
;

69 
•_·¿ms
.
”r_mode
 = 
UCP_ERR_HANDLING_MODE_PEER
;

70 
•_·¿ms
.
add»ss
 = 
addr
;

72 
ucs_¡©us
 = 
	`uı_•_ü—‹
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
,

73 &
•_·¿ms
, &
Ãw_•
);

74 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

75 
	`DOCA_LOG_ERR
("ucp_ep_create()„eturned: %s",

76 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
));

77  
DOCA_ERROR_INITIALIZATION
;

80 
k
 = 
	`kh_put
(
•
, 
ucc_wÜk”
->
uı_d©a
.
•s
, 
de¡
, &
»t
);

81 ià(
»t
 <= 0) {

82  
DOCA_ERROR_DRIVER
;

84 
	`kh_v®ue
(
ucc_wÜk”
->
uı_d©a
.
•s
, 
k
èğ
Ãw_•
;

86 *
•
 = 
Ãw_•
;

87 
	`DOCA_LOG_DBG
("C»©ed EP fÜ de¡: %#lx", 
de¡
);

88  
DOCA_SUCCESS
;

89 
	}
}

99 
doÿ_”rÜ_t
 
	$wÜk”_ucc_memh_lookup
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

100 
ušt64_t
 
de¡
, 
uı_mem_h
 *
memh
)

102 
uı_mem_m­_·¿ms_t
 
mm­_·¿ms
 = {0};

103 
size_t
 
memh_Ën
 = 0;

104 
»t
;

105 
khšt_t
 
k
;

106 *
mem_hªdË
;

107 
uı_mem_h
 
memh_id
;

108 
doÿ_”rÜ_t
 
¡©us
;

109 
ucs_¡©us_t
 
ucs_¡©us
;

111 
k
 = 
	`kh_g‘
(
memh
, 
ucc_wÜk”
->
uı_d©a
.memh, 
de¡
);

112 ià(
k
 !ğ
	`kh_’d
(
ucc_wÜk”
->
uı_d©a
.
memh
)) {

113 *
memh
 = 
	`kh_v®ue
(
ucc_wÜk”
->
uı_d©a
.memh, 
k
);

114  
DOCA_SUCCESS
;

118 
¡©us
 = 
	`doÿ_urom_wÜk”_domaš_memh_lookup
(
ucc_wÜk”
->
su³r
, 
de¡
, 0,

119 &
memh_Ën
, &
mem_hªdË
);

120 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

121 
	`DOCA_LOG_ERR
("Id‚Ù found iÀdomaš:: %#lx", 
de¡
);

122  
DOCA_ERROR_NOT_FOUND
;

125 
mm­_·¿ms
.
f›ld_mask
 = 
UCP_MEM_MAP_PARAM_FIELD_EXPORTED_MEMH_BUFFER
;

126 
mm­_·¿ms
.
expÜ‹d_memh_bufãr
 = 
mem_hªdË
;

128 
ucs_¡©us
 = 
	`uı_mem_m­
(
ucc_wÜk”
->
uı_d©a
.
uı_cÚ‹xt
, &
mm­_·¿ms
,

129 &
memh_id
);

130 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

131 
	`DOCA_LOG_ERR
("FaedØm­…acked memh %p", 
mem_hªdË
);

132  
DOCA_ERROR_NOT_FOUND
;

135 
k
 = 
	`kh_put
(
memh
, 
ucc_wÜk”
->
uı_d©a
.memh, 
de¡
, &
»t
);

136 ià(
»t
 <= 0) {

137 
	`DOCA_LOG_ERR
("Failedo‡dd memho hashtable map");

138 ià(
	`uı_mem_unm­
(
ucc_wÜk”
->
uı_d©a
.
uı_cÚ‹xt
, 
memh_id
è!ğ
UCS_OK
) {

139 
	`DOCA_LOG_ERR
("Failedo unmap memh");

141  
DOCA_ERROR_DRIVER
;

143 
	`kh_v®ue
(
ucc_wÜk”
->
uı_d©a
.
memh
, 
k
èğ
memh_id
;

145 *
memh
 = 
memh_id
;

146 
	`DOCA_LOG_DBG
("AssigÃd memh %°fÜ de¡: %#lx", 
memh_id
, 
de¡
);

147  
DOCA_SUCCESS
;

148 
	}
}

160 
doÿ_”rÜ_t
 
	$wÜk”_ucc_key_lookup
(
urom_wÜk”_ucc
 *
ucc_wÜk”
,

161 
ušt64_t
 
de¡
,

162 
uı_•_h
 
•
,

163 
ušt64_t
 
va
,

164 **
»t_rkey
)

166 
khšt_t
 
k
;

167 
»t
;

168 *
·cked_key
;

169 
size_t
 
·cked_key_Ën
;

170 
uı_rkey_h
 
rkey
;

171 
doÿ_”rÜ_t
 
¡©us
;

172 
ucs_¡©us_t
 
ucs_¡©us
;

173 
£g
;

175 
k
 = 
	`kh_g‘
(
rkeys
, 
ucc_wÜk”
->
uı_d©a
.rkeys, 
de¡
);

176 ià(
k
 !ğ
	`kh_’d
(
ucc_wÜk”
->
uı_d©a
.
rkeys
)) {

177 *
»t_rkey
 = 
	`kh_v®ue
(
ucc_wÜk”
->
uı_d©a
.
rkeys
, 
k
);

178  
DOCA_SUCCESS
;

181 
¡©us
 = 
	`doÿ_urom_wÜk”_domaš_£g_lookup
(
ucc_wÜk”
->
su³r
, 
de¡
,

182 
va
, &
£g
);

183 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

184 
	`DOCA_LOG_ERR
("Id‚Ù found iÀdomaš: %#lx", 
de¡
);

185  
DOCA_ERROR_NOT_FOUND
;

188 
¡©us
 = 
	`doÿ_urom_wÜk”_domaš_mkey_lookup
(
ucc_wÜk”
->
su³r
, 
de¡
, 
£g
,

189 &
·cked_key_Ën
, &
·cked_key
);

190 ià(
¡©us
 !ğ
DOCA_SUCCESS
) {

191 
	`DOCA_LOG_ERR
("Id‚Ù found iÀdomaš: %#lx", 
de¡
);

192  
DOCA_ERROR_NOT_FOUND
;

195 
ucs_¡©us
 = 
	`uı_•_rkey_uÅack
(
•
, 
·cked_key
, &
rkey
);

196 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

197  
DOCA_ERROR_NOT_FOUND
;

200 
k
 = 
	`kh_put
(
rkeys
, 
ucc_wÜk”
->
uı_d©a
.rkeys, 
de¡
, &
»t
);

201 ià(
»t
 <= 0) {

202  
DOCA_ERROR_DRIVER
;

204 
	`kh_v®ue
(
ucc_wÜk”
->
uı_d©a
.
rkeys
, 
k
èğ
rkey
;

206 *
»t_rkey
 = 
rkey
;

207 
	`DOCA_LOG_DBG
("AssigÃd„key fÜ de¡: %#lx", 
de¡
);

208  
DOCA_SUCCESS
;

209 
	}
}

218 
	$£nd_com¶‘iÚ_cb
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

219 *
u£r_d©a
)

221 *
»q
 = (*)
u£r_d©a
;

223 ià(
¡©us
 !ğ
UCS_OK
) {

224 *
»q
 = -1;

226 *
»q
 = 1;

229 
	`uı_»que¡_ä“
(
»que¡
);

230 
	}
}

240 
	$»cv_com¶‘iÚ_cb
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

241 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

242 *
u£r_d©a
)

244 *
»q
 = (*)
u£r_d©a
;

245 ()
šfo
;

247 ià(
¡©us
 !ğ
UCS_OK
) {

248 *
»q
 = -1;

250 *
»q
 = 1;

253 
	`uı_»que¡_ä“
(
»que¡
);

254 
	}
}

256 
doÿ_”rÜ_t
 
	$ucc_£nd_nb
(*
msg
,

257 
size_t
 
Ën
,

258 
št64_t
 
my¿nk
,

259 
št64_t
 
de¡
,

260 
urom_wÜk”_ucc
 *
ucc_wÜk”
,

261 *
»q
)

263 
uı_•_h
 
•
 = 
NULL
;

264 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

265 
doÿ_”rÜ_t
 
urom_¡©us
;

266 
ucs_¡©us_±r_t
 
uı_¡©us
;

268 *
»q
 = 0;

269 
»q_·¿m
.
İ_©Œ_mask
 = 
UCP_OP_ATTR_FIELD_DATATYPE
 |

270 
UCP_OP_ATTR_FIELD_CALLBACK
 |

271 
UCP_OP_ATTR_FIELD_USER_DATA
;

272 
»q_·¿m
.
d©©y³
 = 
	`uı_dt_make_cÚtig
(
Ën
);

273 
»q_·¿m
.
cb
.
£nd
 = 
£nd_com¶‘iÚ_cb
;

274 
»q_·¿m
.
u£r_d©a
 = (*)
»q
;

276 
urom_¡©us
 = 
	`wÜk”_ucc_•_lookup
(
ucc_wÜk”
, 
de¡
, &
•
);

277 ià(
urom_¡©us
 !ğ
DOCA_SUCCESS
) {

278 
	`DOCA_LOG_ERR
("FaedØ£ndØ%ld iÀUCC oob", 
de¡
);

279  
DOCA_ERROR_NOT_FOUND
;

283 
uı_¡©us
 = 
	`uı_g_£nd_nbx
(
•
, 
msg
, 1, 
my¿nk
, &
»q_·¿m
);

284 ià(
uı_¡©us
 !ğ
UCS_OK
) {

285 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

286 
	`uı_»que¡_ÿnûl
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
, 
uı_¡©us
);

287 
	`uı_»que¡_ä“
(
uı_¡©us
);

288  
DOCA_ERROR_NOT_FOUND
;

291 *
»q
 = 1;

294  
DOCA_SUCCESS
;

295 
	}
}

297 
doÿ_”rÜ_t
 
	$ucc_»cv_nb
(*
msg
, 
size_t
 
Ën
, 
št64_t
 
de¡
, 
urom_wÜk”_ucc
 *
ucc_wÜk”
, *
»q
)

299 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {};

300 
ucs_¡©us_±r_t
 
uı_¡©us
;

302 *
»q
 = 0;

303 
»q_·¿m
.
İ_©Œ_mask
 = 
UCP_OP_ATTR_FIELD_DATATYPE
 |

304 
UCP_OP_ATTR_FIELD_CALLBACK
 |

305 
UCP_OP_ATTR_FIELD_USER_DATA
;

306 
»q_·¿m
.
d©©y³
 = 
	`uı_dt_make_cÚtig
(
Ën
);

307 
»q_·¿m
.
cb
.
»cv
 = 
»cv_com¶‘iÚ_cb
;

308 
»q_·¿m
.
u£r_d©a
 = (*)
»q
;

311 
uı_¡©us
 = 
	`uı_g_»cv_nbx
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
, 
msg
, 1, 
de¡
,

312 0xffff, &
»q_·¿m
);

313 ià(
uı_¡©us
 !ğ
UCS_OK
) {

314 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

315 
	`uı_»que¡_ÿnûl
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
, 
uı_¡©us
);

316 
	`uı_»que¡_ä“
(
uı_¡©us
);

317  
DOCA_ERROR_NOT_FOUND
;

320 *
»q
 = 1;

322  
DOCA_SUCCESS
;

323 
	}
}

325 
doÿ_”rÜ_t
 
	$ucc_rma_put
(*
bufãr
,

326 *
rg‘
,

327 
size_t
 
msgËn
,

328 
ušt64_t
 
de¡
,

329 
ušt64_t
 
my¿nk
,

330 
ušt64_t
 
ùx_id
,

331 
urom_wÜk”_ucc
 *
ucc_wÜk”
)

333 
ušt64_t
 
rva
 = (ušt64_t)
rg‘
;

334 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

335 
uı_mem_h
 
memh
 = 
NULL
;

336 
uı_•_h
 
•
;

337 
uı_rkey_h
 
rkey
;

338 
doÿ_”rÜ_t
 
urom_¡©us
;

339 
ucs_¡©us_±r_t
 
uı_¡©us
;

341 ià(
de¡
 =ğ
MAX_HOST_DEST_ID
) {

342 
•
 = 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ho¡
;

344 
urom_¡©us
 = 
	`wÜk”_ucc_•_lookup
(
ucc_wÜk”
, 
de¡
, &
•
);

345 ià(
urom_¡©us
 !ğ
DOCA_SUCCESS
) {

346 
	`DOCA_LOG_ERR
("Failedo find…eer %ldo complete collective",

347 
de¡
);

348  
DOCA_ERROR_NOT_FOUND
;

352 ià(
de¡
 !ğ
MAX_HOST_DEST_ID
) {

353 
urom_¡©us
 = 
	`wÜk”_ucc_memh_lookup
(
ucc_wÜk”
, 
de¡
, &
memh
);

354 ià(
urom_¡©us
 !ğ
DOCA_SUCCESS
)

355 
	`DOCA_LOG_ERR
("FaedØlooku°key fÜ…“¸%ld", 
de¡
);

358 ià(
de¡
 =ğ
MAX_HOST_DEST_ID
) {

359 
urom_¡©us
 = 
	`wÜk”_ucc_key_lookup
(
ucc_wÜk”
, 
my¿nk
, 
•
, 
rva
,

360 (**)&
rkey
);

361 ià(
urom_¡©us
 !ğ
DOCA_SUCCESS
) {

362 
	`DOCA_LOG_ERR
("FaedØlooku°rkey fÜ…“¸%ld", 
de¡
);

363  
DOCA_ERROR_NOT_FOUND
;

366 
urom_¡©us
 = 
	`wÜk”_ucc_key_lookup
(
ucc_wÜk”
, 
de¡
, 
•
, 
rva
,

367 (**)&
rkey
);

368 ià(
urom_¡©us
 !ğ
DOCA_SUCCESS
) {

369 
	`DOCA_LOG_ERR
("FaedØlooku°rkey fÜ…“¸%ld", 
de¡
);

370  
DOCA_ERROR_NOT_FOUND
;

374 ià(
memh
 !ğ
NULL
) {

375 
»q_·¿m
.
İ_©Œ_mask
 = 
UCP_OP_ATTR_FIELD_MEMH
;

376 
»q_·¿m
.
memh
 = memh;

379 
uı_¡©us
 = 
	`uı_put_nbx
(
•
, 
bufãr
, 
msgËn
, 
rva
, 
rkey
, &
»q_·¿m
);

380 ià(
uı_¡©us
 !ğ
UCS_OK
) {

381 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

382 
	`uı_»que¡_ä“
(
uı_¡©us
);

383  
DOCA_ERROR_NOT_FOUND
;

385 
	`uı_»que¡_check_¡©us
(
uı_¡©us
è=ğ
UCS_INPROGRESS
) {

386 
	`uı_wÜk”_´og»ss
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
);

388 
	`uı_»que¡_ä“
(
uı_¡©us
);

390  
DOCA_SUCCESS
;

391 
	}
}

393 
doÿ_”rÜ_t
 
	$ucc_rma_g‘
(*
bufãr
,

394 *
rg‘
,

395 
size_t
 
msgËn
,

396 
ušt64_t
 
de¡
,

397 
ušt64_t
 
my¿nk
,

398 
ušt64_t
 
ùx_id
,

399 
urom_wÜk”_ucc
 *
ucc_wÜk”
)

401 
uı_•_h
 
•
 = 
NULL
;

402 
uı_mem_h
 
memh
 = 
NULL
;

403 
uı_rkey_h
 
rkey
 = 
NULL
;

404 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

405 
ušt64_t
 
rva
 = (ušt64_t)
rg‘
;

406 
doÿ_”rÜ_t
 
urom_¡©us
;

407 
ucs_¡©us_±r_t
 
uı_¡©us
;

409 ià(
de¡
 =ğ
MAX_HOST_DEST_ID
) {

410 
•
 = 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ho¡
;

412 
urom_¡©us
 = 
	`wÜk”_ucc_•_lookup
(
ucc_wÜk”
, 
de¡
, &
•
);

413 ià(
urom_¡©us
 !ğ
DOCA_SUCCESS
) {

414 
	`DOCA_LOG_ERR
("Failedo find…eer %ldo complete collective",

415 
de¡
);

416  
DOCA_ERROR_NOT_FOUND
;

420 ià(
de¡
 !ğ
MAX_HOST_DEST_ID
) {

421 
urom_¡©us
 = 
	`wÜk”_ucc_memh_lookup
(
ucc_wÜk”
, 
de¡
, &
memh
);

422 ià(
urom_¡©us
 !ğ
DOCA_SUCCESS
) {

423 
	`DOCA_LOG_ERR
("FaedØlooku°key fÜ…“¸%ld", 
de¡
);

424  
DOCA_ERROR_NOT_FOUND
;

428 ià(
de¡
 =ğ
MAX_HOST_DEST_ID
) {

429 
urom_¡©us
 = 
	`wÜk”_ucc_key_lookup
(
ucc_wÜk”
, 
my¿nk
, 
•
, 
rva
,

430 (**)&
rkey
);

431 ià(
urom_¡©us
 !ğ
DOCA_SUCCESS
) {

432 
	`DOCA_LOG_ERR
("FaedØlooku°rkey fÜ…“¸%ld", 
de¡
);

433  
DOCA_ERROR_NOT_FOUND
;

436 
urom_¡©us
 = 
	`wÜk”_ucc_key_lookup
(
ucc_wÜk”
, 
de¡
, 
•
, 
rva
,

437 (**)&
rkey
);

438 ià(
urom_¡©us
 !ğ
DOCA_SUCCESS
) {

439 
	`DOCA_LOG_ERR
("FaedØlooku°rkey fÜ…“¸%ld", 
de¡
);

440  
DOCA_ERROR_NOT_FOUND
;

444 ià(
memh
 !ğ
NULL
) {

445 
»q_·¿m
.
İ_©Œ_mask
 = 
UCP_OP_ATTR_FIELD_MEMH
;

446 
»q_·¿m
.
memh
 = memh;

449 
uı_¡©us
 = 
	`uı_g‘_nbx
(
•
, 
bufãr
, 
msgËn
, 
rva
, 
rkey
, &
»q_·¿m
);

450 ià(
uı_¡©us
 !ğ
UCS_OK
) {

451 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

452 
	`uı_»que¡_ä“
(
uı_¡©us
);

453 
	`uı_rkey_de¡roy
(
rkey
);

454  
DOCA_ERROR_NOT_FOUND
;

456 
	`uı_»que¡_check_¡©us
(
uı_¡©us
è=ğ
UCS_INPROGRESS
) {

457 
	`uı_wÜk”_´og»ss
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
);

459 
	`uı_»que¡_ä“
(
uı_¡©us
);

461 
	`uı_rkey_de¡roy
(
rkey
);

462  
DOCA_SUCCESS
;

463 
	}
}

465 
doÿ_”rÜ_t
 
	$ucc_rma_g‘_ho¡
(*
bufãr
,

466 *
rg‘
,

467 
size_t
 
msgËn
,

468 
ušt64_t
 
ùx_id
,

469 *
·cked_key
,

470 
urom_wÜk”_ucc
 *
ucc_wÜk”
)

472 
uı_•_h
 
•
 = 
NULL
;

473 
uı_rkey_h
 
rkey
 = 
NULL
;

474 
ušt64_t
 
rva
 = (ušt64_t)
rg‘
;

475 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

476 
ucs_¡©us_t
 
ucs_¡©us
;

477 
ucs_¡©us_±r_t
 
uı_¡©us
;

479 ià(
·cked_key
 =ğ
NULL
) {

480  
DOCA_ERROR_INVALID_VALUE
;

483 
•
 = 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ho¡
;

485 
ucs_¡©us
 = 
	`uı_•_rkey_uÅack
(
•
, 
·cked_key
, &
rkey
);

486 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

487 
	`DOCA_LOG_ERR
("Failedo unpack„key");

488  
DOCA_ERROR_NOT_FOUND
;

491 
uı_¡©us
 = 
	`uı_g‘_nbx
(
•
, 
bufãr
, 
msgËn
, 
rva
, 
rkey
, &
»q_·¿m
);

492 ià(
UCS_OK
 !ğ
uı_¡©us
) {

493 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

494 
	`DOCA_LOG_ERR
("Failedo…erform ucp_get_nbx(): %s\n",

495 
	`ucs_¡©us_¡ršg
(
	`UCS_PTR_STATUS
(
uı_¡©us
)));

496 
	`uı_»que¡_ä“
(
uı_¡©us
);

497 
	`uı_rkey_de¡roy
(
rkey
);

498  
DOCA_ERROR_NOT_FOUND
;

500 
UCS_INPROGRESS
 =ğ
	`uı_»que¡_check_¡©us
(
uı_¡©us
)) {

501 
	`uı_wÜk”_´og»ss
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
);

503 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

504 
	`DOCA_LOG_ERR
("Failedo…erform ucp_get_nbx(): %s\n",

505 
	`ucs_¡©us_¡ršg
(
	`UCS_PTR_STATUS
(
uı_¡©us
)));

506 
	`uı_»que¡_ä“
(
uı_¡©us
);

507 
	`uı_rkey_de¡roy
(
rkey
);

508  
DOCA_ERROR_NOT_FOUND
;

510 
	`uı_»que¡_ä“
(
uı_¡©us
);

512 
	`uı_rkey_de¡roy
(
rkey
);

513  
DOCA_SUCCESS
;

514 
	}
}

516 
doÿ_”rÜ_t
 
	$ucc_rma_put_ho¡
(*
bufãr
,

517 *
rg‘
,

518 
size_t
 
msgËn
,

519 
ušt64_t
 
ùx_id
,

520 *
·cked_key
,

521 
urom_wÜk”_ucc
 *
ucc_wÜk”
)

523 
uı_•_h
 
•
 = 
NULL
;

524 
uı_rkey_h
 
rkey
 = 
NULL
;

525 
ušt64_t
 
rva
 = (ušt64_t)
rg‘
;

526 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

527 
ucs_¡©us_t
 
ucs_¡©us
;

528 
ucs_¡©us_±r_t
 
uı_¡©us
;

530 ià(
·cked_key
 =ğ
NULL
) {

531  
DOCA_ERROR_INVALID_VALUE
;

534 
•
 = 
ucc_wÜk”
->
ucc_d©a
[
ùx_id
].
ho¡
;

536 
ucs_¡©us
 = 
	`uı_•_rkey_uÅack
(
•
, 
·cked_key
, &
rkey
);

537 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

538 
	`DOCA_LOG_ERR
("Failedo unpack„key");

539  
DOCA_ERROR_NOT_FOUND
;

542 
uı_¡©us
 = 
	`uı_put_nbx
(
•
, 
bufãr
, 
msgËn
, 
rva
, 
rkey
, &
»q_·¿m
);

543 ià(
UCS_OK
 !ğ
uı_¡©us
) {

544 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

545 
	`DOCA_LOG_ERR
("Failedo…erform ucp_put_nbx(): %s\n",

546 
	`ucs_¡©us_¡ršg
(
	`UCS_PTR_STATUS
(
uı_¡©us
)));

547 
	`uı_»que¡_ä“
(
uı_¡©us
);

548 
	`uı_rkey_de¡roy
(
rkey
);

549  
DOCA_ERROR_NOT_FOUND
;

551 
UCS_INPROGRESS
 =ğ
	`uı_»que¡_check_¡©us
(
uı_¡©us
)) {

552 
	`uı_wÜk”_´og»ss
(
ucc_wÜk”
->
uı_d©a
.
uı_wÜk”
);

554 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

555 
	`DOCA_LOG_ERR
("Failedo…erform ucp_put_nbx(): %s\n",

556 
	`ucs_¡©us_¡ršg
(
	`UCS_PTR_STATUS
(
uı_¡©us
)));

557 
	`uı_»que¡_ä“
(
uı_¡©us
);

558 
	`uı_rkey_de¡roy
(
rkey
);

559  
DOCA_ERROR_NOT_FOUND
;

561 
	`uı_»que¡_ä“
(
uı_¡©us
);

563 
	`uı_rkey_de¡roy
(
rkey
);

564  
DOCA_SUCCESS
;

565 
	}
}

	@src/coll_patterns/bruck_alltoall.h

7 #iâdeà
BRUCK_ALLTOALL_H_


8 
	#BRUCK_ALLTOALL_H_


	)

10 
	~"uts/ucc_m©h.h
"

12 
	#GET_NEXT_BRUCK_NUM
(
_num
, 
_¿dix
, 
_pow
) \

13 ((((
_num
è+ 1è% (
_pow
))?((_numè+ 1):(((_numè+ 1è+ (_powè* ((
_¿dix
è- 1)))

	)

15 
	#GET_PREV_BRUCK_NUM
(
_num
, 
_¿dix
, 
_pow
) \

16 (((
_num
è% (
_pow
))?((_numè- 1):(((_numè- 1è- (_powè* ((
_¿dix
è- 1)))

	)

18 
šlše
 
ucc_¿nk_t
 
	$g‘_bruck_¡•_¡¬t
(
ušt32_t
 
pow
, ušt32_ˆ
d
)

20  
pow
 * 
d
;

21 
	}
}

23 
šlše
 
ucc_¿nk_t
 
	$g‘_bruck_¡•_fšish
(
ucc_¿nk_t
 
n
, 
ušt32_t
 
¿dix
,

24 
ušt32_t
 
d
, ušt32_ˆ
pow
)

26 
	`ucc_assume
(
pow
 > 0 && 
¿dix
 > 0);

27  
	`ucc_mš
(
n
 + 
pow
 - 1 - (À- 
d
 *…owè% (pow * 
¿dix
),‚);

28 
	}
}

30 
šlše
 
ucc_¿nk_t
 
	$g‘_bruck_»cv_³”
(
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
,

31 
ucc_¿nk_t
 
¡•
, 
ušt32_t
 
dig™
)

33  (
Œªk
 - 
¡•
 * 
dig™
 + 
tsize
 * digit) %size;

34 
	}
}

36 
šlše
 
ucc_¿nk_t
 
	$g‘_bruck_£nd_³”
(
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
,

37 
ucc_¿nk_t
 
¡•
, 
ušt32_t
 
dig™
)

39  (
Œªk
 + 
¡•
 * 
dig™
è% 
tsize
;

40 
	}
}

	@src/coll_patterns/double_binary_tree.h

7 #iâdeà
DOUBLE_BINARY_TREE_H_


8 
	#DOUBLE_BINARY_TREE_H_


	)

11 
	mLEFT_CHILD
,

12 
	mRIGHT_CHILD


15 
	succ_dbt_sšgË_Œ“
 {

16 
ucc_¿nk_t
 
	m¿nk
;

17 
ucc_¿nk_t
 
	msize
;

18 
ucc_¿nk_t
 
	mroÙ
;

19 
ucc_¿nk_t
 
	m·»Á
;

20 
ucc_¿nk_t
 
	mchd»n
[2];

21 
	mn_chd»n
;

22 
	mheight
;

23 
	m»cv
;

24 } 
	tucc_dbt_sšgË_Œ“_t
;

26 
šlše
 
ucc_¿nk_t
 
	$g‘_roÙ
(
ucc_¿nk_t
 
size
)

28 
ucc_¿nk_t
 
r
 = 1;

30 
r
 <ğ
size
) {

31 
r
 *= 2;

33  
r
/2 - 1;

34 
	}
}

36 
šlše
 
	$g‘_height
(
ucc_¿nk_t
 
¿nk
)

38 
h
 = 1;

40 ià(
¿nk
 % 2 == 0) {

44 
¿nk
++;

45 (
¿nk
 & (1 << 
h
)) == 0) {

46 
h
++;

48  
h
;

49 
	}
}

51 
šlše
 
ucc_¿nk_t
 
	$g‘_Ëá_chd
(
ucc_¿nk_t
 
¿nk
, 
height
)

53 
ucc_¿nk_t
 
sub_height
;

55 ià(
height
 == 0) {

56  
UCC_RANK_INVALID
;

59 
sub_height
 = 1 << (
height
 - 1);

60  
¿nk
 - 
sub_height
;

61 
	}
}

63 
šlše
 
ucc_¿nk_t
 
	$g‘_right_chd
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
,

64 
height
, 
ucc_¿nk_t
 
roÙ
)

66 
ucc_¿nk_t
 
sub_right_roÙ
, 
sub_height
;

68 ià(
¿nk
 =ğ
size
 - 1 || 
height
 == 0) {

69  
UCC_RANK_INVALID
;

72 
sub_right_roÙ
 = 
	`g‘_roÙ
(
size
 - 
¿nk
 - 1) + 1;

73 
sub_height
 = 1 << (
height
 - 1);

75 ià(
¿nk
 =ğ
roÙ
) {

76  
¿nk
 + 
sub_right_roÙ
;

78  (
¿nk
 + 
sub_height
 < 
size
) ?„ank + sub_height

79 : 
¿nk
 + 
sub_right_roÙ
;

80 
	}
}

82 
šlše
 
	$g‘_chd»n
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
, 
height
,

83 
ucc_¿nk_t
 
roÙ
, ucc_¿nk_ˆ*
l_c
,

84 
ucc_¿nk_t
 *
r_c
)

86 *
l_c
 = 
	`g‘_Ëá_chd
(
¿nk
, 
height
);

87 *
r_c
 = 
	`g‘_right_chd
(
size
, 
¿nk
, 
height
, 
roÙ
);

88 
	}
}

90 
šlše
 
	$g‘_n_chd»n
(
ucc_¿nk_t
 
l_c
, ucc_¿nk_ˆ
r_c
)

92 
n_chd»n
 = 0;

94 ià(
l_c
 !ğ
UCC_RANK_INVALID
) {

95 
n_chd»n
++;

98 ià(
r_c
 !ğ
UCC_RANK_INVALID
) {

99 
n_chd»n
++;

102  
n_chd»n
;

103 
	}
}

105 
šlše
 
ucc_¿nk_t
 
	$g‘_·»Á
(
vsize
, 
v¿nk
, 
height
, 
ŒoÙ
)

107 ià(
v¿nk
 =ğ
ŒoÙ
) {

108  
UCC_RANK_INVALID
;

109 } ià(
height
 == 0) {

110  ((((
v¿nk
/2è% 2 =ğ0è&& (v¿nk + 1 !ğ
vsize
))) ? vrank + 1

111 : 
v¿nk
 - 1;

113 
v¿nk
++;

114 ià((((1<<(
height
+1)è& 
v¿nk
è> 0è|| (v¿nk + (1<<height)è> 
vsize
) {

115  
v¿nk
 - (1<<
height
) - 1;

117  
v¿nk
 + (1<<
height
) - 1;

120 
	}
}

122 
šlše
 
	$ucc_dbt_bud_t2_mœrÜ
(
ucc_dbt_sšgË_Œ“_t
 
t1
,

123 
ucc_dbt_sšgË_Œ“_t
 *
t2
)

125 
ucc_¿nk_t
 
size
 = 
t1
.size;

126 
ucc_dbt_sšgË_Œ“_t
 
t
;

128 
t
.
size
 = size;

129 
t
.
height
 = 
t1
.height;

130 
t
.
¿nk
 = 
size
 - 1 - 
t1
.rank;

131 
t
.
roÙ
 = 
size
 - 1 - 
t1
.root;

132 
t
.
·»Á
 = (
t1
.·»Á =ğ
UCC_RANK_INVALID
) ?

133 
UCC_RANK_INVALID
 : 
size
 - 1 - 
t1
.
·»Á
;

134 
t
.
chd»n
[
LEFT_CHILD
] = (
t1
.chd»n[
RIGHT_CHILD
] =ğ
UCC_RANK_INVALID
) ?

135 
UCC_RANK_INVALID
 :

136 
size
 - 1 - 
t1
.
chd»n
[
RIGHT_CHILD
];

137 
t
.
chd»n
[
RIGHT_CHILD
] = (
t1
.chd»n[
LEFT_CHILD
] =ğ
UCC_RANK_INVALID
) ?

138 
UCC_RANK_INVALID
 :

139 
size
 - 1 - 
t1
.
chd»n
[
LEFT_CHILD
];

140 
t
.
n_chd»n
 = 
	`g‘_n_chd»n
Ñ.
chd»n
[
LEFT_CHILD
],

141 
t
.
chd»n
[
RIGHT_CHILD
]);

142 
t
.
»cv
 = 0;

144 *
t2
 = 
t
;

145 
	}
}

147 
šlše
 
	$ucc_dbt_bud_t2_shiá
(
ucc_dbt_sšgË_Œ“_t
 
t1
,

148 
ucc_dbt_sšgË_Œ“_t
 *
t2
)

150 
ucc_¿nk_t
 
size
 = 
t1
.size;

151 
ucc_dbt_sšgË_Œ“_t
 
t
;

153 
t
.
size
 = size;

154 
t
.
height
 = 
t1
.height;

155 
t
.
¿nk
 = (
t1
.¿nk + 1è% 
size
;

156 
t
.
roÙ
 = (
t1
.roÙ + 1è% 
size
;

157 
t
.
·»Á
 = (
t1
.·»Á =ğ
UCC_RANK_INVALID
) ?

158 
UCC_RANK_INVALID
 : (
t1
.
·»Á
 + 1è% 
size
;

159 
t
.
chd»n
[
LEFT_CHILD
] = (
t1
.chd»n[LEFT_CHILD] =ğ
UCC_RANK_INVALID
) ?

160 
UCC_RANK_INVALID
 :

161 (
t1
.
chd»n
[
LEFT_CHILD
] + 1è% 
size
;

162 
t
.
chd»n
[
RIGHT_CHILD
] = (
t1
.chd»n[RIGHT_CHILD] =ğ
UCC_RANK_INVALID
) ?

163 
UCC_RANK_INVALID
 :

164 (
t1
.
chd»n
[
RIGHT_CHILD
] + 1è% 
size
;

165 
t
.
n_chd»n
 = 
	`g‘_n_chd»n
Ñ.
chd»n
[
LEFT_CHILD
],

166 
t
.
chd»n
[
RIGHT_CHILD
]);

167 
t
.
»cv
 = 0;

169 *
t2
 = 
t
;

170 
	}
}

172 
šlše
 
	$ucc_dbt_bud_t1
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
,

173 
ucc_dbt_sšgË_Œ“_t
 *
t1
)

175 
height
 = 
	`g‘_height
(
¿nk
);

176 
ucc_¿nk_t
 
roÙ
 = 
	`g‘_roÙ
(
size
);

177 
ucc_¿nk_t
 
·»Á
 = 
	`g‘_·»Á
(
size
, 
¿nk
, 
height
, 
roÙ
);

179 
	`g‘_chd»n
(
size
, 
¿nk
, 
height
, 
roÙ
, &
t1
->
chd»n
[
LEFT_CHILD
],

180 &
t1
->
chd»n
[
RIGHT_CHILD
]);

181 
t1
->
n_chd»n
 = 
	`g‘_n_chd»n
Ñ1->
chd»n
[
LEFT_CHILD
],

182 
t1
->
chd»n
[
RIGHT_CHILD
]);

183 
t1
->
height
 = height;

184 
t1
->
·»Á
 =…arent;

185 
t1
->
size
 = size;

186 
t1
->
¿nk
 =„ank;

187 
t1
->
roÙ
 =„oot;

188 
t1
->
»cv
 = 0;

189 
	}
}

191 
šlše
 
ucc_¿nk_t
 
	$ucc_dbt_cÚv”t_¿nk_fÜ_shiá
(
ucc_¿nk_t
 
¿nk
,

192 
ucc_¿nk_t
 
size
)

194 
ucc_¿nk_t
 
i
;

195 
i
 = 0; i < 
size
; i++) {

196 ià(
¿nk
 =ğ(
i
 + 1è% 
size
) {

200  
i
;

201 
	}
}

203 
šlše
 
ucc_¿nk_t
 
	$ucc_dbt_cÚv”t_¿nk_fÜ_mœrÜ
(
ucc_¿nk_t
 
¿nk
,

204 
ucc_¿nk_t
 
size
)

206 
ucc_¿nk_t
 
i
;

207 
i
 = 0; i < 
size
; i++) {

208 ià(
¿nk
 =ğ
size
 - 1 - 
i
) {

212  
i
;

213 
	}
}

215 
šlše
 
	$ucc_dbt_bud_t2
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
,

216 
ucc_dbt_sšgË_Œ“_t
 *
t2
) {

217 
ucc_¿nk_t
 
‹mp_¿nk
 = (
size
 % 2) ?

218 
	`ucc_dbt_cÚv”t_¿nk_fÜ_shiá
(
¿nk
, 
size
) :

219 
	`ucc_dbt_cÚv”t_¿nk_fÜ_mœrÜ
(
¿nk
, 
size
);

220 
ucc_dbt_sšgË_Œ“_t
 
t1_‹mp
;

222 
	`ucc_dbt_bud_t1
(
‹mp_¿nk
, 
size
, &
t1_‹mp
);

223 ià(
size
 % 2) {

224 
	`ucc_dbt_bud_t2_shiá
(
t1_‹mp
, 
t2
);

226 
	`ucc_dbt_bud_t2_mœrÜ
(
t1_‹mp
, 
t2
);

228 
	}
}

230 
šlše
 
	$ucc_dbt_bud_Œ“s
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
,

231 
ucc_dbt_sšgË_Œ“_t
 *
t1
,

232 
ucc_dbt_sšgË_Œ“_t
 *
t2
)

234 
	`ucc_dbt_bud_t1
(
¿nk
, 
size
, 
t1
);

235 
	`ucc_dbt_bud_t2
(
¿nk
, 
size
, 
t2
);

236 
	}
}

	@src/coll_patterns/recursive_knomial.h

7 #iâdeà
RECURSIVE_KNOMIAL_H_


8 
	#RECURSIVE_KNOMIAL_H_


	)

10 
	#UCC_KN_PEER_NULL
 ((
ucc_¿nk_t
)-1)

	)

11 
ušt16_t
 
	tucc_kn_¿dix_t
;

14 
	mKN_NODE_BASE
,

15 
	mKN_NODE_PROXY
,

16 
	mKN_NODE_EXTRA


20 
	mKN_PATTERN_REDUCE_SCATTER
 = 1,

21 
	mKN_PATTERN_REDUCE_SCATTERX
,

22 
	mKN_PATTERN_REDUCE_SCATTERV
,

23 
	mKN_PATTERN_ALLGATHER
,

24 
	mKN_PATTERN_ALLGATHERV
,

25 
	mKN_PATTERN_ALLGATHERX
,

26 
	mKN_PATTERN_GATHER
,

27 
	mKN_PATTERN_GATHERX
,

30 
	succ_knomŸl_·‰”n
 {

32 
ucc_kn_¿dix_t
 
	m¿dix
;

33 
ušt8_t
 
	mty³
;

34 
ušt8_t
 
	m™”©iÚ
;

35 
ušt8_t
 
	mn_™”s
;

36 
ušt8_t
 
	mpow_¿dix_sup
;

37 
ušt8_t
 
	mnode_ty³
;

38 
ušt8_t
 
	mbackw¬d
;

39 
ucc_¿nk_t
 
	m¿dix_pow
;

44 
ucc_¿nk_t
 
	mfuÎ_pow_size
;

48 
ucc_¿nk_t
 
	msize
;

49 
ucc_¿nk_t
 
	m¿nk
;

50 
ucc_¿nk_t
 
	mn_exŒa
;

51 
size_t
 
	mblock_size_couÁs
;

52 
size_t
 
	mcouÁ
;

53 
ucc_couÁ_t
 *
	mcouÁs
;

54 
ucc_¿nk_t
 
	mblock_size
;

55 
±rdiff_t
 
	mblock_off£t
;

56 
	mis64
;

57 } 
	tucc_knomŸl_·‰”n_t
;

64 
šlše
 
ucc_¿nk_t
 
	$ucc_kn_·‰”n_n_fuÎ
(
ucc_knomŸl_·‰”n_t
 *
p
)

66  
p
->
size
 /…->
fuÎ_pow_size
;

67 
	}
}

69 
šlše
 
ucc_¿nk_t
 
	$ucc_kn_·‰”n_¿dix_pow_š™
(
ucc_knomŸl_·‰”n_t
 *
p
,

70 
backw¬d
)

72 
ucc_¿nk_t
 
n_fuÎ
 = 
	`ucc_kn_·‰”n_n_fuÎ
(
p
);

74  
backw¬d
 ? ((
n_fuÎ
 =ğ1è? 
p
->
fuÎ_pow_size
 /…->
¿dix


75 : 
p
->
fuÎ_pow_size
) : 1;

76 
	}
}

85 
šlše
 

86 
	$ucc_knomŸl_·‰”n_š™_im¶
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
,

87 
ucc_kn_¿dix_t
 
¿dix
, 
ucc_knomŸl_·‰”n_t
 *
p
,

88 
backw¬d
, 
has_exŒa
)

90 
ucc_¿nk_t
 
fs
 = 
¿dix
;

91 
ucc_¿nk_t
 
n_fuÎ_subŒ“s
;

93 
p
->
pow_¿dix_sup
 = 1;

94 
fs
 < 
size
) {

95 
p
->
pow_¿dix_sup
++;

96 
fs
 *ğ
¿dix
;

98 
p
->
fuÎ_pow_size
 = (
fs
 !ğ
size
è? f / 
¿dix
 : fs;

99 
p
->
¿dix
 =„adix;

100 
p
->
size
 = size;

101 
p
->
¿nk
 =„ank;

102 
p
->
backw¬d
 = backward;

103 
p
->
™”©iÚ
 = 0;

104 
n_fuÎ_subŒ“s
 = 
	`ucc_kn_·‰”n_n_fuÎ
(
p
);

105 
p
->
n_exŒa
 = 
has_exŒa
 ? 
size
 - 
n_fuÎ_subŒ“s
 *…->
fuÎ_pow_size
 : 0;

106 
p
->
n_™”s
 = (p->
n_exŒa
 && 
n_fuÎ_subŒ“s
 == 1) ?

107 
p
->
pow_¿dix_sup
 - 1 :…->pow_radix_sup;

108 
p
->
¿dix_pow
 = 
	`ucc_kn_·‰”n_¿dix_pow_š™
Õ, 
backw¬d
);

109 
p
->
node_ty³
 = 
KN_NODE_BASE
;

110 ià(
¿nk
 < 
p
->
n_exŒa
 * 2) {

111 
p
->
node_ty³
 = (
¿nk
 % 2è? 
KN_NODE_EXTRA
 : 
KN_NODE_PROXY
;

113 
	}
}

115 
šlše
 

116 
	$ucc_knomŸl_·‰”n_š™_backw¬d
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
,

117 
ucc_kn_¿dix_t
 
¿dix
,

118 
ucc_knomŸl_·‰”n_t
 *
p
)

120 
	`ucc_knomŸl_·‰”n_š™_im¶
(
size
, 
¿nk
, 
¿dix
, 
p
, 1, 1);

121 
	}
}

123 
šlše
 

124 
	$ucc_knomŸl_·‰”n_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
, 
ucc_kn_¿dix_t
 
¿dix
,

125 
ucc_knomŸl_·‰”n_t
 *
p
)

127 
	`ucc_knomŸl_·‰”n_š™_im¶
(
size
, 
¿nk
, 
¿dix
, 
p
, 0, 1);

128 
	}
}

130 
šlše
 

131 
	$ucc_knomŸl_·‰”n_š™_no_exŒa
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
,

132 
ucc_kn_¿dix_t
 
¿dix
,

133 
ucc_knomŸl_·‰”n_t
 *
p
)

135 
	`ucc_knomŸl_·‰”n_š™_im¶
(
size
, 
¿nk
, 
¿dix
, 
p
, 0, 0);

136 
	}
}

138 
šlše
 
ucc_¿nk_t


139 
	$ucc_knomŸl_·‰”n_g‘_´oxy
(
ucc_knomŸl_·‰”n_t
 *
p
, 
ucc_¿nk_t
 
¿nk
)

141  
¿nk
 - 1;

142 
	}
}

144 
šlše
 
ucc_¿nk_t


145 
	$ucc_knomŸl_·‰”n_g‘_exŒa
(
ucc_knomŸl_·‰”n_t
 *
p
, 
ucc_¿nk_t
 
¿nk
)

147  
¿nk
 + 1;

148 
	}
}

150 
šlše
 

151 
	$ucc_knomŸl_·‰”n_loİ_dÚe
(
ucc_knomŸl_·‰”n_t
 *
p
)

153  
p
->
™”©iÚ
 =ğp->
n_™”s
;

154 
	}
}

156 
šlše
 

157 
	$ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
ucc_knomŸl_·‰”n_t
 *
p
)

159  
p
->
™”©iÚ
 == 0;

160 
	}
}

162 
šlše
 

163 
	$ucc_knomŸl_·‰”n_loİ_Ï¡_™”©iÚ
(
ucc_knomŸl_·‰”n_t
 *
p
)

165  
p
->
™”©iÚ
 =ğp->
n_™”s
 - 1;

166 
	}
}

169 
šlše
 
ucc_¿nk_t


170 
	$ucc_knomŸl_·‰”n_loİ_¿nk
(
ucc_knomŸl_·‰”n_t
 *
p
, 
ucc_¿nk_t
 
¿nk
)

172  (
¿nk
 < 
p
->
n_exŒa
 * 2) ?„ank / 2 :„ank -…->n_extra;

173 
	}
}

176 
šlše
 
ucc_¿nk_t


177 
	$ucc_knomŸl_·‰”n_loİ_¿nk_šv
(
ucc_knomŸl_·‰”n_t
 *
p
, 
ucc_¿nk_t
 
¿nk
)

179  (
¿nk
 < 
p
->
n_exŒa
) ?„ank * 2 :„ank +…->n_extra;

180 
	}
}

182 
šlše
 
ucc_¿nk_t


183 
	$ucc_knomŸl_·‰”n_g‘_loİ_³”
(
ucc_knomŸl_·‰”n_t
 *
p
, 
ucc_¿nk_t
 
¿nk
,

184 
ucc_kn_¿dix_t
 
loİ_¡•
)

186 
	`ucc_as£¹
(
p
->
node_ty³
 =ğ
KN_NODE_BASE
 ||…->node_ty³ =ğ
KN_NODE_PROXY
);

187 
	`ucc_as£¹
(
loİ_¡•
 >ğ1 &&†oİ_¡• < 
p
->
¿dix
);

188 
	`ucc_as£¹
((
¿nk
 >ğ
p
->
n_exŒa
 * 2) || ((rank % 2) == 0));

190 
ucc_¿nk_t
 
loİ_¿nk
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
¿nk
);

191 
ucc_¿nk_t
 
¡•_size
 = 
p
->
¿dix_pow
 *…->
¿dix
;

192 
ucc_¿nk_t
 
³”
 = (
loİ_¿nk
 + 
loİ_¡•
 * 
p
->
¿dix_pow
è% 
¡•_size
 +

193 
	`ucc_®ign_down
(
loİ_¿nk
, 
¡•_size
);

195  (
³”
 >ğ(
p
->
size
 -…->
n_exŒa
)è? 
UCC_KN_PEER_NULL
:

196 
	`ucc_knomŸl_·‰”n_loİ_¿nk_šv
(
p
, 
³”
);

197 
	}
}

199 
šlše
 
ucc_¿nk_t


200 
	$ucc_knomŸl_·‰”n_g‘_ba£_¿nk
(
ucc_knomŸl_·‰”n_t
 *
p
, 
ucc_¿nk_t
 
¿nk
)

202 
ucc_¿nk_t
 
¡•_size
 = 
p
->
¿dix_pow
 *…->
¿dix
;

203 
ucc_¿nk_t
 
Ìªk
;

204 
ucc_kn_¿dix_t
 
s
;

206 
Ìªk
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
¿nk
);

207 
s
 = 
	`ucc_div_round_up
(
¡•_size
 - (
Ìªk
 % s‹p_size), 
p
->
¿dix_pow
);

209 ià(
s
 =ğ
p
->
¿dix
) {

210  
¿nk
;

212  
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
s
);

214 
	}
}

217 
šlše
 
ucc_kn_¿dix_t


218 
	$ucc_knomŸl_·‰”n_g‘_loİ_šdex
(
ucc_knomŸl_·‰”n_t
 *
p
, 
ucc_¿nk_t
 
¿nk
)

220 
ucc_¿nk_t
 
ba£_¿nk
 = 
	`ucc_knomŸl_·‰”n_g‘_ba£_¿nk
(
p
, 
¿nk
);

221 
ucc_¿nk_t
 
¿nk0
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
ba£_¿nk
);

222 
ucc_¿nk_t
 
cur_¿nk
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
¿nk
);

224  (
cur_¿nk
 - 
¿nk0
è/ 
p
->
¿dix_pow
;

225 
	}
}

227 
šlše
 

228 
	$ucc_knomŸl_·‰”n_Ãxt_™”©iÚ
(
ucc_knomŸl_·‰”n_t
 *
p
)

230 
p
->
™”©iÚ
++;

231 
p
->
¿dix_pow
 *ğp->
¿dix
;

232 
	}
}

234 
šlše
 
	$ucc_knomŸl_·‰”n_´ev_™”©iÚ
(
ucc_knomŸl_·‰”n_t
 *
p
)

236 
p
->
™”©iÚ
--;

237 
p
->
¿dix_pow
 /ğp->
¿dix
;

238 
	}
}

240 
šlše
 

241 
	$ucc_knomŸl_·‰”n_Ãxt_™”©iÚ_backw¬d
(
ucc_knomŸl_·‰”n_t
 *
p
)

243 
p
->
™”©iÚ
++;

244 
p
->
¿dix_pow
 /ğp->
¿dix
;

245 
	}
}

247 
šlše
 
ucc_kn_¿dix_t


248 
	$ucc_knomŸl_·‰”n_g‘_mš_¿dix
(
ucc_kn_¿dix_t
 
cfg_¿dix
,

249 
ucc_¿nk_t
 
‹am_size
, 
size_t
 
couÁ
)

251 
ucc_kn_¿dix_t
 
¿dix
 = 
	`ucc_mš
(
cfg_¿dix
, 
‹am_size
);

253 ià(((
couÁ
 + 
¿dix
 - 1) /„adix * (radix - 1) > count) ||

254 ((
¿dix
 - 1è> 
couÁ
)) {

255 
¿dix
 = 2;

257  
¿dix
;

258 
	}
}

261 
šlše
 
ucc_¿nk_t


262 
	$ucc_knomŸl_ÿlc_»cv_di¡
(
ucc_¿nk_t
 
‹am_size
, ucc_¿nk_ˆ
¿nk
,

263 
ucc_¿nk_t
 
¿dix
, ucc_¿nk_ˆ
roÙ
)

265 
ucc_¿nk_t
 
roÙ_ba£
 = 0;

266 
ucc_¿nk_t
 
di¡
 = 1;

268 ià(
¿nk
 =ğ
roÙ
) {

272 
di¡
 <ğ
‹am_size
) {

273 ià(
¿nk
 < 
roÙ_ba£
 + 
¿dix
 * 
di¡
) {

276 
di¡
 *ğ
¿dix
;

278  
di¡
;

279 
	}
}

283 
šlše
 
ucc_¿nk_t
 
	$ucc_kn_g‘_İt_¿dix
(
ucc_¿nk_t
 
‹am_size
,

284 
ucc_kn_¿dix_t
 
mš_¿dix
,

285 
ucc_kn_¿dix_t
 
max_¿dix
)

287 
ucc_¿nk_t
 
n_exŒa
 = 0, 
mš_v®
 = 
‹am_size
;

288 
ucc_kn_¿dix_t
 
mš_i
 = 
mš_¿dix
;

289 
ucc_kn_¿dix_t
 
max_r
 = 
	`ucc_max
(
max_¿dix
, 
mš_¿dix
);

290 
ucc_kn_¿dix_t
 
r
;

291 
ucc_¿nk_t
 
fs
;

293 
r
 = 
mš_¿dix
;„ <ğ
max_r
;„++) {

294 
fs
 = 
r
;

295 
fs
 < 
‹am_size
) {

296 
fs
 = f * 
r
;

298 
fs
 = (f =ğ
‹am_size
è? f : f / 
r
;

299 
n_exŒa
 = 
‹am_size
 - (‹am_siz/ 
fs
) * fs;

300 ià(
n_exŒa
 == 0) {

301  
r
;

303 ià(
n_exŒa
 < 
mš_v®
) {

304 
mš_v®
 = 
n_exŒa
;

305 
mš_i
 = 
r
;

308  
mš_i
;

309 
	}
}

314 
	mUCC_KN_PHASE_INIT
,

315 
	mUCC_KN_PHASE_LOOP
,

316 
	mUCC_KN_PHASE_REDUCE
,

317 
	mUCC_KN_PHASE_EXTRA
,

318 
	mUCC_KN_PHASE_EXTRA_REDUCE
,

319 
	mUCC_KN_PHASE_PROXY
,

320 
	mUCC_KN_PHASE_COMPLETE
,

323 
	#UCC_KN_CHECK_PHASE
(
_p
) \

324 
_p
: \

325 
_p
;

	)

327 
	#UCC_KN_REDUCE_GOTO_PHASE
(
_pha£
) \

329 
_pha£
) { \

330 
	`UCC_KN_CHECK_PHASE
(
UCC_KN_PHASE_EXTRA
); \

331 
	`UCC_KN_CHECK_PHASE
(
UCC_KN_PHASE_EXTRA_REDUCE
); \

332 
	`UCC_KN_CHECK_PHASE
(
UCC_KN_PHASE_LOOP
); \

333 
	`UCC_KN_CHECK_PHASE
(
UCC_KN_PHASE_REDUCE
); \

334 
	`UCC_KN_CHECK_PHASE
(
UCC_KN_PHASE_PROXY
); \

335 
	`UCC_KN_CHECK_PHASE
(
UCC_KN_PHASE_COMPLETE
); \

336 
UCC_KN_PHASE_INIT
: \

339 } 0)

	)

341 
	#UCC_KN_GOTO_PHASE
(
_pha£
) \

343 
_pha£
) { \

344 
	`UCC_KN_CHECK_PHASE
(
UCC_KN_PHASE_EXTRA
); \

345 
	`UCC_KN_CHECK_PHASE
(
UCC_KN_PHASE_LOOP
); \

346 
	`UCC_KN_CHECK_PHASE
(
UCC_KN_PHASE_PROXY
); \

347 
UCC_KN_PHASE_INIT
: \

350 } 0)

	)

	@src/coll_patterns/sra_knomial.h

7 #iâdeà
SRA_KNOMIAL_H_


8 
	#SRA_KNOMIAL_H_


	)

10 
	~"»cursive_knomŸl.h
"

17 
šlše


18 
ucc_¿nk_t
 
	$ucc_kn_compu‹_¡•_¿dix
(
ucc_knomŸl_·‰”n_t
 *
p
)

20 
n_fuÎ
 = 
	`ucc_kn_·‰”n_n_fuÎ
(
p
);

22  
p
->
¿dix_pow
 *…->
¿dix
 >ğp->
size
 ? (
n_fuÎ
 > 1 ?‚_full :…->radix)

23 : 
p
->
¿dix
;

24 
	}
}

27 
šlše
 
ucc_¿nk_t


28 
	$ucc_kn_compu‹_£g_šdex
(
ucc_¿nk_t
 
³”
, ucc_¿nk_ˆ
kpow_num
,

29 
ucc_knomŸl_·‰”n_t
 *
p
)

31 
ucc_¿nk_t
 
³”_pos™iÚ
, 
³”_ba£_¿nk
, 
³”_šdex
;

33 
³”
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
,…eer);

34 
³”_ba£_¿nk
 = 
	`ucc_®ign_down
(
³”
, 
kpow_num
 * 
p
->
¿dix
);

35 
³”_pos™iÚ
 = 
³”_ba£_¿nk
 =ğ0 ? 
³”
 :…eer % (peer_base_rank);

36 
³”_šdex
 = 
³”_pos™iÚ
 / 
kpow_num
;

38  
³”_šdex
;

39 
	}
}

48 
šlše
 
size_t


49 
	$ucc_¤a_kn_compu‹_£g_size
(
size_t
 
block_couÁ
, 
ucc_kn_¿dix_t
 
¿dix
,

50 
ucc_¿nk_t
 
si
)

52  
	`ucc_bufãr_block_couÁ
(
block_couÁ
, 
¿dix
, 
si
);

53 
	}
}

62 
šlše
 
size_t


63 
	$ucc_¤a_kn_compu‹_£g_off£t
(
size_t
 
block_couÁ
, 
ucc_kn_¿dix_t
 
¿dix
,

64 
ucc_¿nk_t
 
si
)

66  
	`ucc_bufãr_block_off£t
(
block_couÁ
, 
¿dix
, 
si
);

67 
	}
}

69 
šlše
 
size_t


70 
	$ucc_¤a_kn_compu‹_block_couÁ
(
size_t
 
couÁ
, 
ucc_¿nk_t
 
¿nk
,

71 
ucc_knomŸl_·‰”n_t
 *
p
)

73 
size_t
 
block_couÁ
 = 
couÁ
;

74 
ucc_¿nk_t
 
k_pow
 = 1;

75 
ucc_¿nk_t
 
i
, 
my_si
, 
my_£g_Ën
, 
¡•s
;

77 
¡•s
 = 
p
->
backw¬d
 ?…->
n_™”s
 -…->
™”©iÚ
 - 1 :…->iteration;

78 
i
 = 0; i < 
¡•s
; i++) {

79 
my_si
 = 
	`ucc_kn_compu‹_£g_šdex
(
¿nk
, 
k_pow
, 
p
);

80 
my_£g_Ën
 = 
	`ucc_¤a_kn_compu‹_£g_size
(
block_couÁ
, 
p
->
¿dix
, 
my_si
);

81 
block_couÁ
 = 
my_£g_Ën
;

82 
k_pow
 *ğ
p
->
¿dix
;

84  
block_couÁ
;

85 
	}
}

87 
šlše
 

88 
	$ucc_¤a_kn_g‘_off£t_ªd_£gËn
(
size_t
 
couÁ
, size_ˆ
dt_size
, 
ucc_¿nk_t
 
¿nk
,

89 
ucc_¿nk_t
 
size
, 
ucc_kn_¿dix_t
 
¿dix
,

90 
±rdiff_t
 *
off£t
, 
size_t
 *
£gËn
)

92 
±rdiff_t
 
_off£t
 = 0;

93 
size_t
 
my_£g_Ën
 = 0;

94 
ucc_¿nk_t
 
my_si
, 
¡•_¿dix
;

95 
size_t
 
my_£g_off£t
;

96 
ucc_knomŸl_·‰”n_t
 
p
;

98 
	`ucc_knomŸl_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
, &
p
);

99 ià(
KN_NODE_EXTRA
 =ğ
p
.
node_ty³
) {

100 
out
;

103 !
	`ucc_knomŸl_·‰”n_loİ_dÚe
(&
p
)) {

104 
¡•_¿dix
 = 
	`ucc_kn_compu‹_¡•_¿dix
(&
p
);

105 
my_si
 = 
	`ucc_kn_compu‹_£g_šdex
(
¿nk
, 
p
.
¿dix_pow
, &p);

106 
my_£g_off£t
 = 
	`ucc_¤a_kn_compu‹_£g_off£t
(
couÁ
, 
¡•_¿dix
, 
my_si
);

107 
couÁ
 = 
	`ucc_¤a_kn_compu‹_£g_size
(couÁ, 
¡•_¿dix
, 
my_si
);

108 
_off£t
 +ğ
my_£g_off£t
 * 
dt_size
;

109 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ
(&
p
);

111 
my_£g_Ën
 = 
couÁ
;

113 
out
:

114 ià(
off£t
)

115 *
off£t
 = 
_off£t
;

116 ià(
£gËn
)

117 *
£gËn
 = 
my_£g_Ën
;

118 
	}
}

120 
šlše
 
±rdiff_t


121 
	$ucc_¤a_kn_g‘_off£t
(
size_t
 
couÁ
, size_ˆ
dt_size
, 
ucc_¿nk_t
 
¿nk
,

122 
ucc_¿nk_t
 
size
, 
ucc_kn_¿dix_t
 
¿dix
)

124 
±rdiff_t
 
off£t
;

125 
	`ucc_¤a_kn_g‘_off£t_ªd_£gËn
(
couÁ
, 
dt_size
, 
¿nk
, 
size
, 
¿dix
, &
off£t
,

126 
NULL
);

127  
off£t
;

128 
	}
}

130 
	succ_kn_£g_desc
 {

131 
ucc_¿nk_t
 
	m£g_size
;

132 
ucc_¿nk_t
 
	m£g_off£t
;

133 
ucc_¿nk_t
 
	m£g_¡¬t_¿nk_loİ
;

134 
ucc_¿nk_t
 
	m£g_’d_¿nk_loİ
;

135 
ucc_¿nk_t
 
	m£g_¡¬t
;

136 
ucc_¿nk_t
 
	m£g_’d
;

137 } 
	tucc_kn_£g_desc_t
;

139 
šlše
 

140 
	$ucc_kn_£g_desc_compu‹
(
ucc_knomŸl_·‰”n_t
 *
p
, 
ucc_kn_£g_desc_t
 *
£g
,

141 
ucc_¿nk_t
 
³”
)

143 
ucc_¿nk_t
 
¡•_¿dix
 = 
	`ucc_kn_compu‹_¡•_¿dix
(
p
);

144 
ucc_¿nk_t
 
£g_šdex
 = 
	`ucc_kn_compu‹_£g_šdex
(
³”
, 
p
->
¿dix_pow
,…);

148 
£g
->
£g_size
 = 
p
->
block_size
 / 
¡•_¿dix
;

150 
£g
->
£g_off£t
 = seg->
£g_size
 * 
£g_šdex
;

152 
£g
->
£g_¡¬t_¿nk_loİ
 = seg->
£g_off£t
 + 
p
->
block_off£t
;

153 
£g
->
£g_’d_¿nk_loİ
 = seg->
£g_¡¬t_¿nk_loİ
 + seg->
£g_size
;

155 
£g
->
£g_¡¬t
 =

156 
	`ucc_knomŸl_·‰”n_loİ_¿nk_šv
(
p
, 
£g
->
£g_¡¬t_¿nk_loİ
);

157 
£g
->
£g_’d
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk_šv
(
p
, seg->
£g_’d_¿nk_loİ
);

158 
	}
}

160 
šlše
 

161 
	$ucc_knx_block
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
, 
ucc_kn_¿dix_t
 
¿dix
,

162 
size_t
 
couÁ
, 
™”
, size_ˆ*
b_couÁ
, 
±rdiff_t
 *
b_off£t
)

164 
ucc_¿nk_t
 
off£t
 = 0;

165 
ucc_¿nk_t
 
block_couÁ
;

166 
ucc_kn_¿dix_t
 
¡•_¿dix
;

167 
ucc_¿nk_t
 
my_si
;

168 
ucc_knomŸl_·‰”n_t
 
p
;

170 
	`ucc_knomŸl_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
, &
p
);

171 ià(
KN_NODE_EXTRA
 =ğ
p
.
node_ty³
) {

172 *
b_couÁ
 = *
b_off£t
 = 0;

175 
block_couÁ
 = 
couÁ
;

176 
p
.
™”©iÚ
 < 
™”
) {

177 
¡•_¿dix
 = 
	`ucc_kn_compu‹_¡•_¿dix
(&
p
);

178 
my_si
 = 
	`ucc_kn_compu‹_£g_šdex
(
¿nk
, 
p
.
¿dix_pow
, &p);

179 
off£t
 +ğ
	`ucc_bufãr_block_off£t
(
block_couÁ
, 
¡•_¿dix
, 
my_si
);

180 
block_couÁ
 = 
	`ucc_bufãr_block_couÁ
(block_couÁ, 
¡•_¿dix
, 
my_si
);

181 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ
(&
p
);

183 *
b_couÁ
 = 
block_couÁ
;

184 *
b_off£t
 = 
off£t
;

185 
	}
}

187 
šlše
 

188 
	$ucc_kn_g_·‰”n_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
, 
ucc_kn_¿dix_t
 
¿dix
,

189 
size_t
 
couÁ
, 
ucc_knomŸl_·‰”n_t
 *
p
)

191 
	`ucc_knomŸl_·‰”n_š™_no_exŒa
(
size
, 
¿nk
, 
¿dix
, 
p
);

192 
p
->
ty³
 = 
KN_PATTERN_GATHER
;

193 
p
->
couÁ
 = count;

194 
p
->
block_size
 =…->
¿dix_pow
 * 
¿dix
;

195 
p
->
block_off£t
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
Õ, 
¿nk
è/…->
block_size
 *

196 
p
->
block_size
;

197 
	}
}

199 
šlše
 

200 
	$ucc_kn_gx_·‰”n_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
, 
ucc_kn_¿dix_t
 
¿dix
,

201 
size_t
 
couÁ
, 
ucc_knomŸl_·‰”n_t
 *
p
)

203 
	`ucc_knomŸl_·‰”n_š™_backw¬d
(
size
, 
¿nk
, 
¿dix
, 
p
);

204 
p
->
ty³
 = 
KN_PATTERN_GATHERX
;

205 
p
->
couÁ
 = count;

206 ià(
p
->
node_ty³
 !ğ
KN_NODE_EXTRA
) {

207 
p
->
block_size
 = 
	`ucc_kn_compu‹_¡•_¿dix
(p);

208 
	`ucc_knx_block
(
¿nk
, 
size
, 
¿dix
, 
couÁ
, 
p
->
n_™”s
 - 1,

209 &
p
->
block_size_couÁs
, &p->
block_off£t
);

213 
	}
}

215 
šlše
 

216 
	$ucc_kn_g_·‰”n_³”_£g
(
ucc_¿nk_t
 
³”
, 
ucc_knomŸl_·‰”n_t
 *
p
,

217 
size_t
 *
£g_couÁ
, 
±rdiff_t
 *
£g_off£t
)

219 
ucc_¿nk_t
 
¡•_¿dix
, 
£g_šdex
;

221 *
£g_couÁ
 = 0;

222 *
£g_off£t
 = 0;

223 
p
->
ty³
) {

224 
KN_PATTERN_GATHER
:

225 *
£g_couÁ
 = 
	`ucc_mš
(
p
->
¿dix_pow
,…->
size
 - 
³”
è* (p->
couÁ
 /…->size);

226 *
£g_off£t
 = 
³”
 * (
p
->
couÁ
 /…->
size
);

228 
KN_PATTERN_GATHERX
:

229 
¡•_¿dix
 = 
	`ucc_kn_compu‹_¡•_¿dix
(
p
);

230 
£g_šdex
 = 
	`ucc_kn_compu‹_£g_šdex
(
³”
, 
p
->
¿dix_pow
,…);

231 *
£g_off£t
 = 
	`ucc_bufãr_block_off£t
(
p
->
block_size_couÁs
, 
¡•_¿dix
,

232 
£g_šdex
è+ 
p
->
block_off£t
;

233 *
£g_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
p
->
block_size_couÁs
, 
¡•_¿dix
,

234 
£g_šdex
);

237 
	`ucc_as£¹
(0);

239 
	}
}

241 
šlše
 
	$ucc_kn_g_·‰”n_Ãxt_™”
(
ucc_knomŸl_·‰”n_t
 *
p
)

243 
ucc_¿nk_t
 
¿nk
;

244 ià(
p
->
ty³
 =ğ
KN_PATTERN_GATHERX
) {

245 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ_backw¬d
(
p
);

247 ià(!
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

248 
	`ucc_knx_block
(
p
->
¿nk
,…->
size
,…->
¿dix
,…->
couÁ
,

249 
p
->
n_™”s
 - 1 -…->
™”©iÚ
,

250 &
p
->
block_size_couÁs
, &p->
block_off£t
);

253 
¿nk
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
,…->rank);

254 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ
(
p
);

256 ià(!
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

257 
p
->
block_size
 *ğ
	`ucc_kn_compu‹_¡•_¿dix
(p);

258 
p
->
block_off£t
 = 
¿nk
 /…->
block_size
 *…->block_size;

261 
	}
}

263 
šlše
 

264 
	$ucc_kn_ag_·‰”n_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
, 
ucc_kn_¿dix_t
 
¿dix
,

265 
size_t
 
couÁ
, 
ucc_knomŸl_·‰”n_t
 *
p
)

267 
	`ucc_knomŸl_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
, 
p
);

268 
p
->
ty³
 = 
KN_PATTERN_ALLGATHER
;

269 
p
->
couÁ
 = count;

270 
p
->
block_size
 =…->
¿dix_pow
 * 
¿dix
;

271 
p
->
block_off£t
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
Õ, 
¿nk
è/…->
block_size
 *

272 
p
->
block_size
;

273 
	}
}

275 
šlše
 

276 
	$ucc_kn_agx_·‰”n_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
, 
ucc_kn_¿dix_t
 
¿dix
,

277 
size_t
 
couÁ
, 
ucc_knomŸl_·‰”n_t
 *
p
)

279 
	`ucc_knomŸl_·‰”n_š™_backw¬d
(
size
, 
¿nk
, 
¿dix
, 
p
);

280 
p
->
ty³
 = 
KN_PATTERN_ALLGATHERX
;

281 
p
->
couÁ
 = count;

282 ià(
p
->
node_ty³
 !ğ
KN_NODE_EXTRA
) {

283 
p
->
block_size
 = 
	`ucc_kn_compu‹_¡•_¿dix
(p);

284 
	`ucc_knx_block
(
¿nk
, 
size
, 
¿dix
, 
couÁ
, 
p
->
n_™”s
 - 1,

285 &
p
->
block_size_couÁs
, &p->
block_off£t
);

288 
	}
}

290 
šlše
 

291 
	$ucc_kn_agv_·‰”n_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
, 
ucc_kn_¿dix_t
 
¿dix
,

292 
ucc_couÁ_t
 *
couÁs
, 
is64
,

293 
ucc_knomŸl_·‰”n_t
 *
p
)

295 
	`ucc_knomŸl_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
, 
p
);

296 
p
->
ty³
 = 
KN_PATTERN_ALLGATHERV
;

297 
p
->
couÁs
 = counts;

298 
p
->
is64
 = is64;

299 
p
->
block_size
 =…->
¿dix_pow
 * 
¿dix
;

300 
p
->
block_off£t
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
Õ, 
¿nk
è/…->
block_size
 *

301 
p
->
block_size
;

302 
	}
}

304 
šlše
 

305 
	$ucc_kn_ag_·‰”n_³”_£g
(
ucc_¿nk_t
 
³”
, 
ucc_knomŸl_·‰”n_t
 *
p
,

306 
size_t
 *
£g_couÁ
, 
±rdiff_t
 *
£g_off£t
)

308 
ucc_¿nk_t
 
¡•_¿dix
, 
£g_šdex
;

309 
ucc_kn_£g_desc_t
 
s
;

311 *
£g_couÁ
 = 0;

312 *
£g_off£t
 = 0;

313 
p
->
ty³
) {

314 
KN_PATTERN_ALLGATHERX
:

315 
¡•_¿dix
 = 
	`ucc_kn_compu‹_¡•_¿dix
(
p
);

316 
£g_šdex
 = 
	`ucc_kn_compu‹_£g_šdex
(
³”
, 
p
->
¿dix_pow
,…);

317 *
£g_off£t
 = 
	`ucc_bufãr_block_off£t
(
p
->
block_size_couÁs
, 
¡•_¿dix
,

318 
£g_šdex
è+ 
p
->
block_off£t
;

319 *
£g_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
p
->
block_size_couÁs
, 
¡•_¿dix
,

320 
£g_šdex
);

322 
KN_PATTERN_ALLGATHER
:

323 
	`ucc_kn_£g_desc_compu‹
(
p
, &
s
, 
³”
);

324 *
£g_off£t
 = 
	`ucc_bufãr_block_off£t
(
p
->
couÁ
,…->
size
, 
s
.
£g_¡¬t
);

325 *
£g_couÁ
 = 
	`ucc_bufãr_block_off£t
(
p
->
couÁ
,…->
size
, 
s
.
£g_’d
) -

326 *
£g_off£t
;

328 
KN_PATTERN_ALLGATHERV
:

329 
	`ucc_kn_£g_desc_compu‹
(
p
, &
s
, 
³”
);

330 *
£g_off£t
 = 
	`ucc_bufãr_veùÜ_block_off£t
(
p
->
couÁs
,…->
is64
,

331 
s
.
£g_¡¬t
);

332 *
£g_couÁ
 = 
	`ucc_bufãr_veùÜ_block_off£t
(
p
->
couÁs
,…->
is64
,

333 
s
.
£g_’d
è- *
£g_off£t
;

336 
	`ucc_as£¹
(0);

338 
	}
}

340 
šlše
 
	$ucc_kn_ag_·‰”n_Ãxt_™”
(
ucc_knomŸl_·‰”n_t
 *
p
)

342 
ucc_¿nk_t
 
¿nk
;

343 ià(
p
->
ty³
 =ğ
KN_PATTERN_ALLGATHERX
) {

344 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ_backw¬d
(
p
);

346 ià(!
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

347 
	`ucc_knx_block
(
p
->
¿nk
,…->
size
,…->
¿dix
,…->
couÁ
,

348 
p
->
n_™”s
 - 1 -…->
™”©iÚ
,

349 &
p
->
block_size_couÁs
, &p->
block_off£t
);

352 
¿nk
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
,…->rank);

353 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ
(
p
);

355 ià(!
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

356 
p
->
block_size
 *ğ
	`ucc_kn_compu‹_¡•_¿dix
(p);

357 
p
->
block_off£t
 = 
¿nk
 /…->
block_size
 *…->block_size;

360 
	}
}

362 
šlše
 
	$ucc_kn_rs_·‰”n_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
,

363 
ucc_kn_¿dix_t
 
¿dix
, 
size_t
 
couÁ
,

364 
ucc_knomŸl_·‰”n_t
 *
p
)

366 
	`ucc_knomŸl_·‰”n_š™_backw¬d
(
size
, 
¿nk
, 
¿dix
, 
p
);

367 
p
->
ty³
 = 
KN_PATTERN_REDUCE_SCATTER
;

368 
p
->
couÁ
 = count;

369 
p
->
block_size_couÁs
 = 
couÁ
;

370 
p
->
block_size
 = 
size
 -…->
n_exŒa
;

371 
p
->
block_off£t
 = 0;

372 
	}
}

374 
šlše
 
	$ucc_kn_rsx_·‰”n_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
,

375 
ucc_kn_¿dix_t
 
¿dix
, 
size_t
 
couÁ
,

376 
ucc_knomŸl_·‰”n_t
 *
p
)

378 
	`ucc_knomŸl_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
, 
p
);

379 
p
->
ty³
 = 
KN_PATTERN_REDUCE_SCATTERX
;

380 
p
->
couÁ
 = count;

381 
p
->
block_size_couÁs
 = 
couÁ
;

382 
p
->
block_size
 = 
size
 -…->
n_exŒa
;

383 
	}
}

385 
šlše
 

386 
	$ucc_kn_rs_·‰”n_³”_£g
(
ucc_¿nk_t
 
³”
, 
ucc_knomŸl_·‰”n_t
 *
p
,

387 
size_t
 *
³”_£g_couÁ
, 
±rdiff_t
 *
³”_£g_off£t
)

389 
ucc_¿nk_t
 
¡•_¿dix
, 
£g_šdex
;

390 
ucc_kn_£g_desc_t
 
s
;

391 
ucc_¿nk_t
 
block_off£t_šv
;

394 
size_t
 
³”_£g_off£t_ba£
;

397 
size_t
 
block_off£t_couÁs
;

399 *
³”_£g_couÁ
 = 0;

400 *
³”_£g_off£t
 = 0;

402 
p
->
ty³
) {

403 
KN_PATTERN_REDUCE_SCATTERX
:

404 
¡•_¿dix
 = 
	`ucc_kn_compu‹_¡•_¿dix
(
p
);

405 
£g_šdex
 = 
	`ucc_kn_compu‹_£g_šdex
(
³”
, 
p
->
¿dix_pow
,…);

406 *
³”_£g_off£t
 = 
	`ucc_bufãr_block_off£t
(
p
->
block_size_couÁs
,

407 
¡•_¿dix
, 
£g_šdex
);

408 *
³”_£g_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
p
->
block_size_couÁs
,

409 
¡•_¿dix
, 
£g_šdex
);

411 
KN_PATTERN_REDUCE_SCATTER
:

412 
	`ucc_kn_£g_desc_compu‹
(
p
, &
s
, 
³”
);

413 
block_off£t_šv
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk_šv
(
p
,…->
block_off£t
);

414 
³”_£g_off£t_ba£
 = 
	`ucc_bufãr_block_off£t
(
p
->
couÁ
,…->
size
,

415 
s
.
£g_¡¬t
);

416 *
³”_£g_couÁ
 = 
	`ucc_bufãr_block_off£t
(
p
->
couÁ
,…->
size
,

417 
s
.
£g_’d
) -

418 
³”_£g_off£t_ba£
;

419 
block_off£t_couÁs
 = 
	`ucc_bufãr_block_off£t
(
p
->
couÁ
,…->
size
,

420 
block_off£t_šv
);

421 *
³”_£g_off£t
 = 
³”_£g_off£t_ba£
 - 
block_off£t_couÁs
;

423 
KN_PATTERN_REDUCE_SCATTERV
:

425 
	`ucc_as£¹
(0);

427 
	`ucc_as£¹
(0);

429 
	}
}

431 
šlše
 
	$ucc_kn_rs_·‰”n_Ãxt_™”
(
ucc_knomŸl_·‰”n_t
 *
p
)

433 
size_t
 
bs
;

434 
±rdiff_t
 
off£t
;

435 
ucc_kn_£g_desc_t
 
s
;

437 
	`ucc_kn_rs_·‰”n_³”_£g
(
p
->
¿nk
,…, &
bs
, &
off£t
);

438 
p
->
block_size_couÁs
 = 
bs
;

440 
p
->
ty³
) {

441 
KN_PATTERN_REDUCE_SCATTERX
:

442 
p
->
block_off£t
 +ğ
off£t
;

443 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ
(
p
);

445 
KN_PATTERN_REDUCE_SCATTER
:

446 
	`ucc_kn_£g_desc_compu‹
(
p
, &
s
,…->
¿nk
);

447 
p
->
block_size
 = 
s
.
£g_size
;

448 
p
->
block_off£t
 +ğ
s
.
£g_off£t
;

449 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ_backw¬d
(
p
);

451 
KN_PATTERN_REDUCE_SCATTERV
:

453 
	`ucc_as£¹
(0);

455 
	`ucc_as£¹
(0);

457 
	}
}

459 
šlše
 
	$ucc_kn_rs_·‰”n_exŒa_£g
(
ucc_knomŸl_·‰”n_t
 *
p
,

460 
size_t
 *
£g_couÁ
,

461 
±rdiff_t
 *
£g_off£t
)

463 
p
->
ty³
) {

464 
KN_PATTERN_REDUCE_SCATTER
:

465 *
£g_off£t
 = 
	`ucc_bufãr_block_couÁ
(
p
->
couÁ
,…->
size
,…->
¿nk
);

466 *
£g_couÁ
 = 
	`ucc_bufãr_block_couÁ
(

467 
p
->
couÁ
,…->
size
, 
	`ucc_knomŸl_·‰”n_g‘_exŒa
Õ,…->
¿nk
));

470 
	`ucc_as£¹
(0);

472 
	}
}

	@src/coll_score/ucc_coll_score.c

7 
	~"ucc_cŞl_scÜe.h
"

8 
	~"uts/ucc_¡ršg.h
"

9 
	~"uts/ucc_log.h
"

10 
	~"uts/ucc_cŞl_uts.h
"

12 *
	$ucc_scÜe_to_¡r
(
ucc_scÜe_t
 
scÜe
, *
buf
, 
size_t
 
max
) {

13 ià(
scÜe
 =ğ
UCC_SCORE_MAX
) {

14 
	`ucc_¡ºıy_§ã
(
buf
, "šf", 
max
);

16 
	`ucc_¢´štf_§ã
(
buf
, 
max
, "%d", 
scÜe
);

19  
buf
;

20 
	}
}

22 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_®loc
(
ucc_cŞl_scÜe_t
 **
scÜe
)

24 
ucc_cŞl_scÜe_t
 *
s
 = 
	`ucc_m®loc
((*s), "ucc_coll_score");

25 
i
, 
j
;

26 ià(!
s
) {

27 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ucc_coll_score",

28 (*
s
));

29 *
scÜe
 = 
NULL
;

30  
UCC_ERR_NO_MEMORY
;

32 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

33 
j
 = 0; j < 
UCC_MEMORY_TYPE_LAST
; j++) {

34 
	`ucc_li¡_h—d_š™
(&
s
->
scÜes
[
i
][
j
]);

37 *
scÜe
 = 
s
;

38  
UCC_OK
;

39 
	}
}

41 
šlše
 
	$ucc_msg_¿nge_ä“
(
ucc_msg_¿nge_t
 *
r
)

43 
	`ucc_li¡_de¡ruù
(&
r
->
çÎback
, 
ucc_cŞl_’Œy_t
, 
ucc_ä“
, 
li¡_–em
);

44 
	`ucc_ä“
(
r
);

45 
	}
}

47 
šlše
 
ucc_¡©us_t


48 
	$cŞl_scÜe_add_¿nge
(
ucc_cŞl_scÜe_t
 *
scÜe
, 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

49 
ucc_memÜy_ty³_t
 
mem_ty³
, 
size_t
 
¡¬t
, size_ˆ
’d
,

50 
ucc_scÜe_t
 
msg_scÜe
, 
ucc_ba£_cŞl_š™_â_t
 
š™
,

51 
ucc_ba£_‹am_t
 *
‹am
)

53 
ucc_msg_¿nge_t
 *
r
;

54 
ucc_msg_¿nge_t
 *
¿nge
;

55 
ucc_li¡_lšk_t
 *
li¡
, *
š£¹_pos
, *
Ãxt
;

57 ià(
¡¬t
 >ğ
’d
) {

58  
UCC_ERR_INVALID_PARAM
;

60 
r
 = 
	`ucc_m®loc
((*r), "ucc_msg_range");

61 ià(!
r
) {

62 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜ ucc_msg_¿nge", (*
r
));

63  
UCC_ERR_NO_MEMORY
;

66 
	`ucc_li¡_h—d_š™
(&
r
->
çÎback
);

68 
r
->
¡¬t
 = start;

69 
r
->
’d
 =ƒnd;

70 
r
->
su³r
.
scÜe
 = 
msg_scÜe
;

71 
r
->
su³r
.
š™
 = init;

72 
r
->
su³r
.
‹am
 =eam;

73 
li¡
 = &
scÜe
->
scÜes
[
	`ucc_og2
(
cŞl_ty³
)][
mem_ty³
];

74 
š£¹_pos
 = 
li¡
;

75 
	`ucc_li¡_fÜ_—ch
(
¿nge
, 
li¡
, 
su³r
.
li¡_–em
) {

76 ià(
¡¬t
 >ğ
¿nge
->
’d
) {

77 
š£¹_pos
 = &
¿nge
->
su³r
.
li¡_–em
;

82 
	`ucc_li¡_š£¹_aá”
(
š£¹_pos
, &
r
->
su³r
.
li¡_–em
);

84 
Ãxt
 = 
r
->
su³r
.
li¡_–em
.next;

85 ià((
Ãxt
 !ğ
li¡
) &&

86 (
	`ucc_cÚš”_of
(
Ãxt
, 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
)->
¡¬t
 <

87 
r
->
’d
)) {

88 
	`ucc_”rÜ
("attempto‡dd overlaping„ange");

89 
	`ucc_li¡_d–
(&
r
->
su³r
.
li¡_–em
);

90 
	`ucc_msg_¿nge_ä“
(
r
);

91  
UCC_ERR_INVALID_PARAM
;

93  
UCC_OK
;

94 
	}
}

95 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_add_¿nge
(
ucc_cŞl_scÜe_t
 *
scÜe
,

96 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

97 
ucc_memÜy_ty³_t
 
mem_ty³
, 
size_t
 
¡¬t
,

98 
size_t
 
’d
, 
ucc_scÜe_t
 
msg_scÜe
,

99 
ucc_ba£_cŞl_š™_â_t
 
š™
,

100 
ucc_ba£_‹am_t
 * 
‹am
)

102 ià(
msg_scÜe
 == 0) {

104  
UCC_OK
;

106  
	`cŞl_scÜe_add_¿nge
(
scÜe
, 
cŞl_ty³
, 
mem_ty³
, 
¡¬t
, 
’d
,

107 
msg_scÜe
, 
š™
, 
‹am
);

108 
	}
}

110 
	$ucc_cŞl_scÜe_ä“
(
ucc_cŞl_scÜe_t
 *
scÜe
)

112 
i
, 
j
;

113 ià(!
scÜe
) {

116 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

117 
j
 = 0; j < 
UCC_MEMORY_TYPE_LAST
; j++) {

118 
	`ucc_li¡_de¡ruù
(&
scÜe
->
scÜes
[
i
][
j
], 
ucc_msg_¿nge_t
,

119 
ucc_msg_¿nge_ä“
, 
su³r
.
li¡_–em
);

122 
	`ucc_ä“
(
scÜe
);

123 
	}
}

125 
ucc_¡©us_t
 
	$ucc_çÎback_®loc
(
ucc_scÜe_t
 
scÜe
,

126 
ucc_ba£_cŞl_š™_â_t
 
š™
,

127 
ucc_ba£_‹am_t
 *
‹am
,

128 
ucc_cŞl_’Œy_t
 **
_fb
)

130 
ucc_cŞl_’Œy_t
 *
fb
;

132 
fb
 = 
	`ucc_m®loc
((*fb), "fallback");

133 ià(
	`ucc_uÆik–y
(!
fb
)) {

134 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for fallback",

135 (
ucc_cŞl_’Œy_t
));

136 *
_fb
 = 
NULL
;

137  
UCC_ERR_NO_MEMORY
;

139 
fb
->
scÜe
 = score;

140 
fb
->
š™
 = init;

141 
fb
->
‹am
 =eam;

142 *
_fb
 = 
fb
;

143  
UCC_OK
;

144 
	}
}

146 
šlše
 
	$ucc_çÎback_š£¹
(
ucc_li¡_lšk_t
 *
li¡
,

147 
ucc_cŞl_’Œy_t
 *
fb
)

149 
ucc_li¡_lšk_t
 *
š£¹_pos
;

150 
ucc_cŞl_’Œy_t
 *
f
;

152 
š£¹_pos
 = 
li¡
;

153 
	`ucc_li¡_fÜ_—ch
(
f
, 
li¡
, 
li¡_–em
) {

154 ià(
fb
->
scÜe
 =ğ
f
->scÜ&& fb->
š™
 == f->init &&

155 
fb
->
‹am
 =ğ
f
->team) {

156 
	`ucc_ä“
(
fb
);

160 ià(
fb
->
scÜe
 < 
f
->score) {

161 
š£¹_pos
 = &
f
->
li¡_–em
;

166 
	`ucc_li¡_š£¹_aá”
(
š£¹_pos
, &
fb
->
li¡_–em
);

167 
	}
}

169 
	#FB_ALLOC_INSERT
(
_fb_š
, 
_fb_out
, 
_de¡
, 
_¡©us
, 
_Ïb–
) do { \

170 
_¡©us
 = \

171 
	`ucc_çÎback_®loc
((
_fb_š
)->
scÜe
, (_fb_š)->
š™
, \

172 (
_fb_š
)->
‹am
, &(
_fb_out
)); \

173 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
_¡©us
)) { \

174 
_Ïb–
; \

176 
	`ucc_çÎback_š£¹
(&(
_de¡
)->
çÎback
, 
_fb_out
); \

177 } 0)

	)

179 
ucc_¡©us_t
 
	$ucc_çÎback_cİy
(cÚ¡ 
ucc_msg_¿nge_t
 *
š
,

180 
ucc_msg_¿nge_t
 *
out
)

182 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

183 
ucc_cŞl_’Œy_t
 *
fb_š
, *
fb
;

185 
	`ucc_li¡_fÜ_—ch
(
fb_š
, &
š
->
çÎback
, 
li¡_–em
) {

186 
	`FB_ALLOC_INSERT
(
fb_š
, 
fb
, 
out
, 
¡©us
, out);

188 
out
:

189  
¡©us
;

190 
	}
}

192 
ucc_¡©us_t
 
	$ucc_msg_¿nge_dup
(cÚ¡ 
ucc_msg_¿nge_t
 *
š
,

193 
ucc_msg_¿nge_t
 **
out
)

195 
ucc_msg_¿nge_t
 *
r
;

196 
ucc_¡©us_t
 
¡©us
;

198 
r
 = 
	`ucc_m®loc
((*r), "msg_range");

199 ià(
	`ucc_uÆik–y
(!
r
)) {

200 *
out
 = 
NULL
;

201 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜ msg¿nge", (*
r
));

202  
UCC_ERR_NO_MEMORY
;

204 
	`memıy
(
r
, 
š
, (*r));

205 
	`ucc_li¡_h—d_š™
(&
r
->
çÎback
);

206 
¡©us
 = 
	`ucc_çÎback_cİy
(
š
, 
r
);

207 ià(
¡©us
 !ğ
UCC_OK
) {

208 
	`ucc_msg_¿nge_ä“
(
r
);

209 
r
 = 
NULL
;

211 *
out
 = 
r
;

212  
¡©us
;

213 
	}
}

215 
	#MSG_RANGE_DUP
(
_r
) \

217 
ucc_msg_¿nge_t
 *
_dup
; \

218 
¡©us
 = 
	`ucc_msg_¿nge_dup
(
_r
, &
_dup
); \

219 ià(
UCC_OK
 !ğ
¡©us
) { \

220 
out
; \

222 
_dup
; \

223 })

	)

225 
ucc_¡©us_t
 
	$ucc_msg_¿nge_add_çÎback
(cÚ¡ 
ucc_msg_¿nge_t
 *
š
,

226 
ucc_msg_¿nge_t
 *
out
)

228 
ucc_cŞl_’Œy_t
 *
fb
;

229 
ucc_¡©us_t
 
¡©us
;

231 ià(
š
->
su³r
.
š™
 =ğ
out
->super.init &&

232 
š
->
su³r
.
‹am
 =ğ
out
->super.team) {

233  
UCC_OK
;

236 
¡©us
 = 
	`ucc_çÎback_®loc
(
š
->
su³r
.
scÜe
, in->su³r.
š™
, in->su³r.
‹am
,

237 &
fb
);

238 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

239  
¡©us
;

241 
¡©us
 = 
	`ucc_çÎback_cİy
(
š
, 
out
);

242 
	`ucc_çÎback_š£¹
(&
out
->
çÎback
, 
fb
);

243  
¡©us
;

244 
	}
}

246 
	#ADD_FALLBACK
(
_š
, 
_out
) \

248 
¡©us
 = 
	`ucc_msg_¿nge_add_çÎback
(
_š
, 
_out
); \

249 ià(
UCC_OK
 !ğ
¡©us
) { \

250 
out
; \

252 } 0)

	)

254 
ucc_¡©us_t
 
	$ucc_scÜe_li¡_dup
(cÚ¡ 
ucc_li¡_lšk_t
 *
¤c
,

255 
ucc_li¡_lšk_t
 *
d¡
)

257 
ucc_msg_¿nge_t
 *
¿nge
, *
r
;

258 
ucc_¡©us_t
 
¡©us
;

260 
	`ucc_li¡_h—d_š™
(
d¡
);

261 
	`ucc_li¡_fÜ_—ch
(
¿nge
, 
¤c
, 
su³r
.
li¡_–em
) {

262 
r
 = 
	`MSG_RANGE_DUP
(
¿nge
);

263 
	`ucc_li¡_add_
(
d¡
, &
r
->
su³r
.
li¡_–em
);

265  
UCC_OK
;

266 
out
:

267 
	`ucc_li¡_fÜ_—ch_§ã
(
¿nge
, 
r
, 
d¡
, 
su³r
.
li¡_–em
) {

268 
	`ucc_li¡_d–
(&
¿nge
->
su³r
.
li¡_–em
);

269 
	`ucc_msg_¿nge_ä“
(
¿nge
);

271 
	`ucc_as£¹
(
	`ucc_li¡_is_em±y
(
d¡
));

272  
UCC_ERR_NO_MEMORY
;

273 
	}
}

275 
šlše
 
	$ucc_msg_¿nge_fb_com·»
(
ucc_msg_¿nge_t
 *
r1
,

276 
ucc_msg_¿nge_t
 *
r2
)

278 
ucc_li¡_lšk_t
 *
l1
, *
l2
;

279 
ucc_cŞl_’Œy_t
 *
fb1
, *
fb2
;

281 
l1
 = &
r1
->
çÎback
;

282 
l2
 = &
r2
->
çÎback
;

284 ià(
	`ucc_li¡_Ëngth
(
l1
è!ğucc_li¡_Ëngth(
l2
)) {

288 
fb2
 = 
	`ucc_li¡_h—d
(
l2
, 
ucc_cŞl_’Œy_t
, 
li¡_–em
);

289 
	`ucc_li¡_fÜ_—ch
(
fb1
, 
l1
, 
li¡_–em
) {

290 ià(
fb1
->
scÜe
 !ğ
fb2
->scÜ|| fb1->
š™
 != fb2->init ||

291 
fb1
->
‹am
 !ğ
fb2
->team) {

294 
fb2
 = 
	`ucc_li¡_Ãxt
(&fb2->
li¡_–em
, 
ucc_cŞl_’Œy_t
,†ist_elem);

297 
	}
}

299 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_m”ge_Úe
(
ucc_li¡_lšk_t
 *
li¡1
,

300 
ucc_li¡_lšk_t
 *
li¡2
,

301 
ucc_li¡_lšk_t
 *
out
)

303 
ucc_li¡_lšk_t
 
l¡1
, 
l¡2
;

304 
ucc_msg_¿nge_t
 *
r1
, *
r2
, *
Ëá
, *
right
, *
be¡
, *
Ãw
;

305 
ucc_msg_¿nge_t
 *
¿nge
, *
‹mp
, *
Ãxt
;

306 
ucc_¡©us_t
 
¡©us
;

308 ià(
	`ucc_li¡_is_em±y
(
li¡1
è&& ucc_li¡_is_em±y(
li¡2
)) {

309  
UCC_OK
;

310 } ià(
	`ucc_li¡_is_em±y
(
li¡1
)) {

311  
	`ucc_scÜe_li¡_dup
(
li¡2
, 
out
);

312 } ià(
	`ucc_li¡_is_em±y
(
li¡2
)) {

313  
	`ucc_scÜe_li¡_dup
(
li¡1
, 
out
);

316 
¡©us
 = 
	`ucc_scÜe_li¡_dup
(
li¡1
, &
l¡1
);

317 ià(
UCC_OK
 !ğ
¡©us
) {

318  
¡©us
;

320 
¡©us
 = 
	`ucc_scÜe_li¡_dup
(
li¡2
, &
l¡2
);

321 ià(
UCC_OK
 !ğ
¡©us
) {

322 
out
;

325 !(
	`ucc_li¡_is_em±y
(&
l¡1
è&& ucc_li¡_is_em±y(&
l¡2
))) {

326 ià(
	`ucc_li¡_is_em±y
(&
l¡1
)) {

327 
	`ucc_li¡_add_
(
out
, &(
	`ucc_li¡_exŒaù_h—d
(&
l¡2
,

328 
ucc_cŞl_’Œy_t
, 
li¡_–em
)->list_elem));

331 ià(
	`ucc_li¡_is_em±y
(&
l¡2
)) {

332 
	`ucc_li¡_add_
(
out
, &(
	`ucc_li¡_exŒaù_h—d
(&
l¡1
,

333 
ucc_cŞl_’Œy_t
, 
li¡_–em
)->list_elem));

336 
r1
 = 
	`ucc_li¡_h—d
(&
l¡1
, 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
);

337 
r2
 = 
	`ucc_li¡_h—d
(&
l¡2
, 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
);

338 
Ëá
 = (
r1
->
¡¬t
 < 
r2
->start) ?„1 :„2;

340 ià(
r1
->
¡¬t
 =ğ
r2
->start) {

341 ià(
r1
->
’d
 =ğ
r2
->end) {

342 
be¡
 = (
r1
->
su³r
.
scÜe
 > 
r2
->super.score) ?„1 :„2;

343 
Ëá
 = (
be¡
 =ğ
r1
è? 
r2
 :„1;

344 
	`ucc_li¡_d–
(&
r1
->
su³r
.
li¡_–em
);

345 
	`ucc_li¡_d–
(&
r2
->
su³r
.
li¡_–em
);

346 
	`ucc_li¡_add_
(
out
, &
be¡
->
su³r
.
li¡_–em
);

347 
	`ADD_FALLBACK
(
Ëá
, 
be¡
);

348 
	`ucc_msg_¿nge_ä“
(
Ëá
);

351 
Ëá
 = (
r1
->
’d
 < 
r2
->end) ?„1 :„2;

352 
right
 = (
Ëá
 =ğ
r1
è? 
r2
 :„1;

353 
Ãw
 = 
	`MSG_RANGE_DUP
(
right
);

354 
right
->
¡¬t
 = 
Ãw
->
’d
 = 
Ëá
->end;

355 
	`ucc_li¡_d–
(&
Ëá
->
su³r
.
li¡_–em
);

356 ià(
Ëá
->
su³r
.
scÜe
 < 
Ãw
->super.score) {

357 
	`SWAP
(
Ëá
, 
Ãw
, *);

359 
	`ADD_FALLBACK
(
Ãw
, 
Ëá
);

360 
	`ucc_msg_¿nge_ä“
(
Ãw
);

362 
	`ucc_li¡_add_
(
out
, &
Ëá
->
su³r
.
li¡_–em
);

365 
right
 = (
Ëá
 =ğ
r1
è? 
r2
 :„1;

366 ià(
Ëá
->
’d
 <ğ
right
->
¡¬t
) {

368 
	`ucc_li¡_d–
(&
Ëá
->
su³r
.
li¡_–em
);

369 
	`ucc_li¡_add_
(
out
, &
Ëá
->
su³r
.
li¡_–em
);

371 
Ãw
 = 
	`MSG_RANGE_DUP
(
Ëá
);

372 
Ãw
->
’d
 = 
right
->
¡¬t
;

373 
	`ucc_li¡_add_
(
out
, &
Ãw
->
su³r
.
li¡_–em
);

374 
Ëá
->
¡¬t
 = 
right
->start;

381 
	`ucc_li¡_fÜ_—ch_§ã
(
¿nge
, 
‹mp
, 
out
, 
su³r
.
li¡_–em
) {

382 ià(
¿nge
->
su³r
.
li¡_–em
.
Ãxt
 !ğ
out
) {

383 
Ãxt
 = 
	`ucc_cÚš”_of
(
¿nge
->
su³r
.
li¡_–em
.next,

384 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
);

385 ià(
¿nge
->
su³r
.
scÜe
 =ğ
Ãxt
->super.score &&

386 
¿nge
->
’d
 =ğ
Ãxt
->
¡¬t
 &&

387 
¿nge
->
su³r
.
š™
 =ğ
Ãxt
->super.init &&

388 
¿nge
->
su³r
.
‹am
 =ğ
Ãxt
->super.team &&

389 1 =ğ
	`ucc_msg_¿nge_fb_com·»
(
¿nge
, 
Ãxt
)) {

390 
Ãxt
->
¡¬t
 = 
¿nge
->start;

391 
	`ucc_li¡_d–
(&
¿nge
->
su³r
.
li¡_–em
);

392 
	`ucc_msg_¿nge_ä“
(
¿nge
);

396  
UCC_OK
;

398 
out
:

399 
	`ucc_li¡_de¡ruù
(&
l¡2
, 
ucc_msg_¿nge_t
, 
ucc_msg_¿nge_ä“
,

400 
su³r
.
li¡_–em
);

401 
	`ucc_li¡_de¡ruù
(&
l¡1
, 
ucc_msg_¿nge_t
, 
ucc_msg_¿nge_ä“
,

402 
su³r
.
li¡_–em
);

403 
	`ucc_li¡_de¡ruù
(
out
, 
ucc_msg_¿nge_t
, 
ucc_msg_¿nge_ä“
,

404 
su³r
.
li¡_–em
);

405  
¡©us
;

406 
	}
}

408 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_m”ge
(
ucc_cŞl_scÜe_t
 * 
scÜe1
,

409 
ucc_cŞl_scÜe_t
 * 
scÜe2
,

410 
ucc_cŞl_scÜe_t
 **
r¡
, 
ä“_šputs
)

412 
ucc_cŞl_scÜe_t
 *
out
;

413 
ucc_¡©us_t
 
¡©us
;

414 
i
, 
j
;

415 
¡©us
 = 
	`ucc_cŞl_scÜe_®loc
(&
out
);

416 ià(
UCC_OK
 !ğ
¡©us
) {

417 
out
;

419 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

420 
j
 = 0; j < 
UCC_MEMORY_TYPE_LAST
; j++) {

421 
¡©us
 = 
	`ucc_cŞl_scÜe_m”ge_Úe
(&
scÜe1
->
scÜes
[
i
][
j
],

422 &
scÜe2
->
scÜes
[
i
][
j
],

423 &
out
->
scÜes
[
i
][
j
]);

424 ià(
UCC_OK
 !ğ
¡©us
) {

425 
	`ucc_cŞl_scÜe_ä“
(
out
);

426 
out
;

430 *
r¡
 = 
out
;

431 
out
:

432 ià(
ä“_šputs
) {

433 
	`ucc_cŞl_scÜe_ä“
(
scÜe1
);

434 
	`ucc_cŞl_scÜe_ä“
(
scÜe2
);

436  
¡©us
;

437 
	}
}

439 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_m”ge_š
(
ucc_cŞl_scÜe_t
 **
d¡
,

440 
ucc_cŞl_scÜe_t
 *
¤c
)

442 
ucc_cŞl_scÜe_t
 *
tmp
 = 
NULL
;

443 
ucc_¡©us_t
 
¡©us
;

445 
¡©us
 = 
	`ucc_cŞl_scÜe_m”ge
(
¤c
, *
d¡
, &
tmp
, 1);

446 *
d¡
 = 
tmp
;

447  
¡©us
;

448 
	}
}

450 
ucc_¡©us_t
 
	$¡r_to_cŞl_ty³
(cÚ¡ *
¡r
, *
ù_n
,

451 
ucc_cŞl_ty³_t
 **
ù
)

453 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

454 **
tok’s
;

455 
i
, 
n_tok’s
;

456 
ucc_cŞl_ty³_t
 
t
;

457 
tok’s
 = 
	`ucc_¡r_¥l™
(
¡r
, ",");

458 ià(!
tok’s
) {

459 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

460 
out
;

462 
n_tok’s
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s
);

463 *
ù
 = 
	`ucc_m®loc
(
n_tok’s
 * (
ucc_cŞl_ty³_t
), "ucc_coll_types");

464 ià(!(*
ù
)) {

465 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ucc_coll_types",

466 (
ucc_cŞl_ty³_t
è* 
n_tok’s
);

467 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

468 
out
;

470 *
ù_n
 = 0;

471 
i
 = 0; i < 
n_tok’s
; i++) {

472 
t
 = 
	`ucc_cŞl_ty³_äom_¡r
(
tok’s
[
i
]);

473 ià(
t
 =ğ
UCC_COLL_TYPE_LAST
) {

475 
	`ucc_ä“
(*
ù
);

476 *
ù
 = 
NULL
;

477 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

478 
out
;

480 (*
ù
)[*
ù_n
] = 
t
;

481 (*
ù_n
)++;

483 
out
:

484 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

485  
¡©us
;

486 
	}
}

488 
ucc_¡©us_t
 
	$¡r_to_scÜe
(cÚ¡ *
¡r
, 
ucc_scÜe_t
 *
scÜe
)

490 ià(0 =ğ
	`¡rÿ£cmp
("šf", 
¡r
)) {

491 *
scÜe
 = 
UCC_SCORE_MAX
;

492 } ià(
UCC_OK
 !ğ
	`ucc_¡r_is_numb”
(
¡r
)) {

493  
UCC_ERR_NOT_FOUND
;

495 *
scÜe
 = (
ucc_scÜe_t
)
	`©oi
(
¡r
);

497  
UCC_OK
;

498 
	}
}

500 
ucc_¡©us_t
 
	$¡r_to_®g_id
(cÚ¡ *
¡r
, cÚ¡ **
®g_id
)

502 ià('@' !ğ
¡r
[0]) {

503  
UCC_ERR_NOT_FOUND
;

505 *
®g_id
 = 
¡r
 + 1;

506  
UCC_OK
;

507 
	}
}

509 
ucc_¡©us_t
 
	$¡r_to_msg¿nges
(cÚ¡ *
¡r
, 
size_t
 **
¿nges
,

510 *
n_¿nges
)

512 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

513 **
tok’s
;

514 **
tok’s2
;

515 
i
, 
n_tok’s
, 
n_tok’s2
;

516 
size_t
 
m1
, 
m2
;

517 
tok’s
 = 
	`ucc_¡r_¥l™
(
¡r
, ",");

518 ià(!
tok’s
) {

519 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

520 
out
;

522 
n_tok’s
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s
);

523 *
¿nges
 = 
	`ucc_m®loc
(2 * 
n_tok’s
 * (
size_t
), "ucc_msgsize_ranges");

524 ià(!(*
¿nges
)) {

525 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ucc_msgsize_ranges",

526 (
size_t
è* 2 * 
n_tok’s
);

527 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

528 
out
;

531 
i
 = 0; i < 
n_tok’s
; i++) {

532 
tok’s2
 = 
	`ucc_¡r_¥l™
(
tok’s
[
i
], "-");

533 ià(!
tok’s2
) {

534 
”r
;

536 
n_tok’s2
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s2
);

537 ià(
n_tok’s2
 != 2) {

538 
”r
;

540 ià(
UCC_OK
 !ğ
	`ucc_¡r_to_memun™s
(
tok’s2
[0], &
m1
) ||

541 
UCC_OK
 !ğ
	`ucc_¡r_to_memun™s
(
tok’s2
[1], &
m2
)) {

542 
”r
;

544 
	`ucc_¡r_¥l™_ä“
(
tok’s2
);

545 (*
¿nges
)[2 * 
i
] = 
m1
;

546 (*
¿nges
)[2 * 
i
 + 1] = 
m2
;

548 *
n_¿nges
 = 
i
;

549 
out
:

550 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

551  
¡©us
;

552 
”r
:

553 
	`ucc_¡r_¥l™_ä“
(
tok’s2
);

554 
	`ucc_ä“
(*
¿nges
);

555 *
¿nges
 = 
NULL
;

556 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

557 
out
;

558 
	}
}

560 
ucc_¡©us_t
 
	$¡r_to_tsizes
(cÚ¡ *
¡r
, 
ucc_¿nk_t
 **
tsizes
,

561 *
n_tsizes
)

563 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

564 ** 
tok’s
;

565 ** 
tok’s2
;

566 
i
, 
n_tok’s
, 
n_tok’s2
;

571 ià('[' !ğ
¡r
[0] || ']' !ğ¡r[
	`¡¾’
(str) - 1]) {

572  
UCC_ERR_NOT_FOUND
;

574 
tok’s
 = 
	`ucc_¡r_¥l™
(
¡r
 + 1, ",");

575 ià(!
tok’s
) {

576 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

577 
out
;

579 
n_tok’s
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s
);

580 *
tsizes
 = 
	`ucc_m®loc
(2 * 
n_tok’s
 * (
ucc_¿nk_t
), "ucc_tsize_ranges");

581 ià(!(*
tsizes
)) {

582 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ucc_tsize_ranges",

583 (
ucc_¿nk_t
è* 2 * 
n_tok’s
);

584 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

585 
out
;

587 
	`ucc_as£¹
(']' =ğ
tok’s
[
n_tok’s
 - 1][
	`¡¾’
(tokens[n_tokens - 1]) - 1]);

589 
tok’s
[
n_tok’s
 - 1][
	`¡¾’
(tokens[n_tokens - 1]) - 1] = '\0';

590 
i
 = 0; i < 
n_tok’s
; i++) {

591 
tok’s2
 = 
	`ucc_¡r_¥l™
(
tok’s
[
i
], "-");

592 ià(!
tok’s2
) {

593 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

594 
”r
;

596 
n_tok’s2
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s2
);

597 ià(
n_tok’s2
 == 1) {

599 ià(
UCC_OK
 !ğ
	`ucc_¡r_is_numb”
(
tok’s2
[0])) {

600 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

601 
”r
;

603 (*
tsizes
)[2 * 
i
] = (
ucc_¿nk_t
)
	`©oi
(
tok’s2
[0]);

604 (*
tsizes
)[2 * 
i
 + 1] = (
ucc_¿nk_t
)
	`©oi
(
tok’s2
[0]);

606 ià(
n_tok’s2
 != 2) {

607 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

608 
”r
;

610 ià(
UCC_OK
 =ğ
	`ucc_¡r_is_numb”
(
tok’s2
[0])) {

611 (*
tsizes
)[2 * 
i
] = (
ucc_¿nk_t
)
	`©oi
(
tok’s2
[0]);

613 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

614 
”r
;

616 ià(0 =ğ
	`¡rÿ£cmp
("šf", 
tok’s2
[1])) {

617 (*
tsizes
)[2 * 
i
 + 1] = 
UCC_RANK_MAX
;

618 } ià(
UCC_OK
 =ğ
	`ucc_¡r_is_numb”
(
tok’s2
[1])) {

619 (*
tsizes
)[2 * 
i
 + 1] = (
ucc_¿nk_t
)
	`©oi
(
tok’s2
[1]);

621 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

622 
”r
;

624 ià((*
tsizes
)[2 * 
i
 + 1] < (*tsizes)[2 * i]) {

625 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

626 
”r
;

629 
	`ucc_¡r_¥l™_ä“
(
tok’s2
);

631 *
n_tsizes
 = 
i
;

632 
out
:

633 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

634  
¡©us
;

635 
”r
:

636 
	`ucc_¡r_¥l™_ä“
(
tok’s2
);

637 
	`ucc_ä“
(*
tsizes
);

638 *
tsizes
 = 
NULL
;

639 
out
;

640 
	}
}

642 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_·r£_¡r
(cÚ¡ *
¡r
,

643 
ucc_cŞl_scÜe_t
 *
scÜe
,

644 
ucc_¿nk_t
 
‹am_size
,

645 
ucc_ba£_cŞl_š™_â_t
 
š™
,

646 
ucc_ba£_‹am_t
 *
‹am
,

647 
ucc_®g_id_to_š™_â_t
 
®g_â
)

649 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

650 
ucc_cŞl_ty³_t
 *
ù
 = 
NULL
;

651 
size_t
 *
msg
 = 
NULL
;

652 
ucc_¿nk_t
 *
tsizes
 = 
NULL
;

653 
ucc_ba£_cŞl_š™_â_t
 
®g_š™
 = 
NULL
;

654 cÚ¡ * 
®g_id
 = 
NULL
;

655 
ucc_scÜe_t
 
scÜe_v
 = 
UCC_SCORE_INVALID
;

656 
ts_sk
 = 0;

657 
ušt32_t
 
mty³s
 = 0;

658 **
tok’s
;

659 
i
, 
n_tok’s
, 
ù_n
, 
c
, 
m
, 
n_¿nges
, 
r
, 
n_tsizes
;

661 
ù_n
 = 
n_¿nges
 = 
n_tsizes
 = 0;

662 
tok’s
 = 
	`ucc_¡r_¥l™
(
¡r
, ":");

663 ià(!
tok’s
) {

664 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

665 
out
;

667 
n_tok’s
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s
);

668 
i
 = 0; i < 
n_tok’s
; i++) {

669 ià(!
ù
 && 
UCC_OK
 =ğ
	`¡r_to_cŞl_ty³
(
tok’s
[
i
], &
ù_n
, &ct)) {

672 ià(!
mty³s
 && 
UCC_OK
 =ğ
	`ucc_¡r_to_mty³_m­
(
tok’s
[
i
], ",",

673 &
mty³s
)) {

676 ià((
UCC_SCORE_INVALID
 =ğ
scÜe_v
) &&

677 
UCC_OK
 =ğ
	`¡r_to_scÜe
(
tok’s
[
i
], &
scÜe_v
)) {

680 ià(!
msg
 && 
UCC_OK
 =ğ
	`¡r_to_msg¿nges
(
tok’s
[
i
], &msg, &
n_¿nges
)) {

683 ià(!
tsizes
 && 
UCC_OK
 =ğ
	`¡r_to_tsizes
(
tok’s
[
i
], &tsizes, &
n_tsizes
)) {

686 ià(!
®g_id
 && 
UCC_OK
 =ğ
	`¡r_to_®g_id
(
tok’s
[
i
], &alg_id)) {

690 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

691 
	`ucc_”rÜ
("çedØ·r£ok’ \'%s\' iÀ\'%s\'", 
tok’s
[
i
], 
¡r
);

693 
out
;

695 ià(
tsizes
) {

698 
ts_sk
 = 1;

699 
i
 = 0; i < 
n_tsizes
; i++) {

700 ià(
‹am_size
 >ğ
tsizes
[2 * 
i
] &&eam_size <=sizes[2 * i + 1]) {

701 
ts_sk
 = 0;

706 ià(!
ts_sk
 && (
UCC_SCORE_INVALID
 !ğ
scÜe_v
 || 
NULL
 !ğ
®g_id
)) {

709 ià(!
ù
) {

710 
ù_n
 = 
UCC_COLL_TYPE_NUM
;

712 ià(!
mty³s
) {

713 
mty³s
 = 
UCC_MEM_TYPE_MASK_FULL
;

715 ià(!
msg
) {

716 
n_¿nges
 = 1;

718 
c
 = 0; c < 
ù_n
; c++) {

719 
m
 = 0; m < 
UCC_MEMORY_TYPE_LAST
; m++) {

720 ià(!(
	`UCC_BIT
(
m
è& 
mty³s
)) {

723 
ucc_cŞl_ty³_t
 
cŞl_ty³
 = 
ù
 ? ct[
c
] :

724 (
ucc_cŞl_ty³_t
)
	`UCC_BIT
(
c
);

725 
ucc_memÜy_ty³_t
 
mem_ty³
 = (ucc_memÜy_ty³_t)
m
;

726 ià(
®g_id
) {

727 ià(!
®g_â
) {

728 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

729 
	`ucc_”rÜ
("modifying‡lgorithm id is‚ot supported by "

731 
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
);

732 
out
;

734 
	`ucc_as£¹
(
NULL
 !ğ
‹am
);

735 cÚ¡ *
®g_id_¡r
 = 
NULL
;

736 
®g_id_n
 = 0;

737 ià(
UCC_OK
 =ğ
	`ucc_¡r_is_numb”
(
®g_id
)) {

738 
®g_id_n
 = 
	`©oi
(
®g_id
);

740 
®g_id_¡r
 = 
®g_id
;

742 
¡©us
 = 
	`®g_â
(
®g_id_n
, 
®g_id_¡r
, 
cŞl_ty³
, 
mem_ty³
,

743 &
®g_š™
);

744 ià(
UCC_ERR_INVALID_PARAM
 =ğ
¡©us
) {

745 
	`ucc_”rÜ
("incorrect‡lgorithm id…rovided: %s, %s, "

747 
®g_id
, 
¡r
,

748 
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
);

749 
out
;

750 } ià(
UCC_ERR_NOT_SUPPORTED
 =ğ
¡©us
) {

751 
	`ucc_”rÜ
("modifying‡lgorithm id is‚ot supported for "

753 
	`ucc_cŞl_ty³_¡r
(
cŞl_ty³
), 
®g_id
,

754 
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
);

755 
out
;

756 } ià(
¡©us
 < 0) {

757 
	`ucc_”rÜ
("failedo map‡lg ido init: %s, %s, "

759 
®g_id
, 
¡r
, 
	`ucc_¡©us_¡ršg
(
¡©us
),

760 
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
);

761 
out
;

764 
r
 = 0;„ < 
n_¿nges
;„++) {

765 
size_t
 
m_¡¬t
 = 0;

766 
size_t
 
m_’d
 = 
UCC_MSG_MAX
;

767 ià(
msg
) {

768 
m_¡¬t
 = 
msg
[
r
 * 2];

769 
m_’d
 = 
msg
[
r
 * 2 + 1];

771 
¡©us
 = 
	`cŞl_scÜe_add_¿nge
(

772 
scÜe
, 
cŞl_ty³
, 
mem_ty³
, 
m_¡¬t
, 
m_’d
, 
scÜe_v
,

773 
®g_š™
 ?‡lg_š™ : 
š™
, 
‹am
);

778 
out
:

779 
	`ucc_ä“
(
ù
);

780 
	`ucc_ä“
(
msg
);

781 
	`ucc_ä“
(
tsizes
);

782 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

783  
¡©us
;

784 
	}
}

786 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_®loc_äom_¡r
(cÚ¡ * 
¡r
,

787 
ucc_cŞl_scÜe_t
 ** 
scÜe_p
,

788 
ucc_¿nk_t
 
‹am_size
,

789 
ucc_ba£_cŞl_š™_â_t
 
š™
,

790 
ucc_ba£_‹am_t
 * 
‹am
,

791 
ucc_®g_id_to_š™_â_t
 
®g_â
)

793 
ucc_cŞl_scÜe_t
 *
scÜe
;

794 
ucc_¡©us_t
 
¡©us
;

795 **
tok’s
;

796 
n_tok’s
, 
i
;

797 
¡©us
 = 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
);

798 ià(
UCC_OK
 !ğ
¡©us
) {

799  
¡©us
;

801 
tok’s
 = 
	`ucc_¡r_¥l™
(
¡r
, "#");

802 ià(!
tok’s
) {

803 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

804 
”rÜ
;

806 
n_tok’s
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s
);

807 
i
 = 0; i < 
n_tok’s
; i++) {

808 
¡©us
 = 
	`ucc_cŞl_scÜe_·r£_¡r
(
tok’s
[
i
], 
scÜe
, 
‹am_size
, 
š™
,

809 
‹am
, 
®g_â
);

810 ià(
UCC_OK
 !ğ
¡©us
) {

811 
”rÜ_msg
;

814 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

815 *
scÜe_p
 = 
scÜe
;

816  
UCC_OK
;

817 
”rÜ_msg
:

818 
	`ucc_”rÜ
("çedØ·r£ UCC_*_TUNE…¬am‘”: %s", 
tok’s
[
i
]);

819 
”rÜ
:

820 *
scÜe_p
 = 
NULL
;

821 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

822 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

823  
¡©us
;

824 
	}
}

826 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_upd©e_Úe
(
ucc_li¡_lšk_t
 *
de¡
,

827 
ucc_li¡_lšk_t
 *
¤c
,

828 
ucc_scÜe_t
 
deçuÉ_scÜe
)

830 
ucc_li¡_lšk_t
 *
s
 = 
¤c
->
Ãxt
;

831 
ucc_li¡_lšk_t
 *
d
 = 
de¡
->
Ãxt
;

832 
ucc_msg_¿nge_t
 *
¿nge
, *
tmp
, *
Ãxt
, *
rs
, *
rd
, *
Ãw
;

833 
ucc_cŞl_’Œy_t
 *
fb
;

834 
ucc_¡©us_t
 
¡©us
;

836 ià(
	`ucc_li¡_is_em±y
(
¤c
è&& ucc_li¡_is_em±y(
de¡
)) {

837  
UCC_OK
;

840 
s
 !ğ
¤c
 && 
d
 !ğ
de¡
) {

841 
rs
 = 
	`ucc_cÚš”_of
(
s
, 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
);

842 
rd
 = 
	`ucc_cÚš”_of
(
d
, 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
);

843 
	`ucc_as£¹
((
NULL
 =ğ
rs
->
su³r
.
š™
è|| (NULL !ğrs->su³r.
‹am
));

844 ià(
rd
->
¡¬t
 >ğ
rs
->
’d
) {

846 
s
 = s->
Ãxt
;

847 ià(
rs
->
su³r
.
š™
) {

848 
Ãw
 = 
	`MSG_RANGE_DUP
(
rs
);

849 ià(
Ãw
->
su³r
.
scÜe
 =ğ
UCC_SCORE_INVALID
) {

850 
Ãw
->
su³r
.
scÜe
 = 
deçuÉ_scÜe
;

852 
	`ucc_li¡_š£¹_befÜe
(
d
, &
Ãw
->
su³r
.
li¡_–em
);

854 } ià(
rd
->
’d
 <ğ
rs
->
¡¬t
) {

856 
d
 = d->
Ãxt
;

857 } ià(
rd
->
¡¬t
 < 
rs
->start) {

858 
Ãw
 = 
	`MSG_RANGE_DUP
(
rd
);

859 
Ãw
->
’d
 = 
rs
->
¡¬t
;

860 
rd
->
¡¬t
 = 
rs
->start;

861 
	`ucc_li¡_š£¹_befÜe
(
d
, &
Ãw
->
su³r
.
li¡_–em
);

862 } ià(
rd
->
¡¬t
 > 
rs
->start) {

863 ià(
rs
->
su³r
.
š™
) {

864 
Ãw
 = 
	`MSG_RANGE_DUP
(
rs
);

865 ià(
Ãw
->
su³r
.
scÜe
 =ğ
UCC_SCORE_INVALID
) {

866 
Ãw
->
su³r
.
scÜe
 = 
deçuÉ_scÜe
;

868 
Ãw
->
’d
 = 
rd
->
¡¬t
;

869 
	`ucc_li¡_š£¹_befÜe
(
d
, &
Ãw
->
su³r
.
li¡_–em
);

871 
rs
->
¡¬t
 = 
rd
->start;

874 ià(
rs
->
’d
 > 
rd
->end) {

875 ià(
UCC_SCORE_INVALID
 !ğ
rs
->
su³r
.
scÜe
) {

876 
rd
->
su³r
.
scÜe
 = 
rs
->super.score;

878 ià(
rs
->
su³r
.
š™
) {

879 ià(
rs
->
su³r
.
š™
 !ğ
rd
->super.init) {

881 
	`FB_ALLOC_INSERT
(&
rd
->
su³r
, 
fb
,„d, 
¡©us
, 
out
);

883 
rd
->
su³r
.
š™
 = 
rs
->super.init;

884 
rd
->
su³r
.
‹am
 = 
rs
->super.team;

886 
rs
->
¡¬t
 = 
rd
->
’d
;

887 
d
 = d->
Ãxt
;

888 } ià(
rs
->
’d
 < 
rd
->end) {

889 
Ãw
 = 
	`MSG_RANGE_DUP
(
rd
);

890 
Ãw
->
’d
 = 
rs
->end;

891 ià(
UCC_SCORE_INVALID
 !ğ
rs
->
su³r
.
scÜe
) {

892 
Ãw
->
su³r
.
scÜe
 = 
rs
->super.score;

894 ià(
rs
->
su³r
.
š™
) {

895 ià(
rs
->
su³r
.
š™
 !ğ
rd
->super.init) {

897 
	`FB_ALLOC_INSERT
(&
rd
->
su³r
, 
fb
, 
Ãw
, 
¡©us
, 
out
);

899 
Ãw
->
su³r
.
š™
 = 
rs
->super.init;

900 
Ãw
->
su³r
.
‹am
 = 
rs
->super.team;

902 
	`ucc_li¡_š£¹_befÜe
(
d
, &
Ãw
->
su³r
.
li¡_–em
);

903 
rd
->
¡¬t
 = 
rs
->
’d
;

904 
s
 = s->
Ãxt
;

906 ià(
UCC_SCORE_INVALID
 !ğ
rs
->
su³r
.
scÜe
) {

907 
rd
->
su³r
.
scÜe
 = 
rs
->super.score;

909 ià(
rs
->
su³r
.
š™
) {

910 ià(
rs
->
su³r
.
š™
 !ğ
rd
->super.init) {

912 
	`FB_ALLOC_INSERT
(&
rd
->
su³r
, 
fb
,„d, 
¡©us
, 
out
);

914 
rd
->
su³r
.
š™
 = 
rs
->super.init;

915 
rd
->
su³r
.
‹am
 = 
rs
->super.team;

917 
s
 = s->
Ãxt
;

918 
d
 = d->
Ãxt
;

922 
s
 !ğ
¤c
) {

923 
rs
 = 
	`ucc_cÚš”_of
(
s
, 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
);

924 ià(
rs
->
su³r
.
š™
) {

925 
Ãw
 = 
	`MSG_RANGE_DUP
(
rs
);

926 ià(
Ãw
->
su³r
.
scÜe
 =ğ
UCC_SCORE_INVALID
) {

927 
Ãw
->
su³r
.
scÜe
 = 
deçuÉ_scÜe
;

929 
	`ucc_li¡_add_
(
de¡
, &
Ãw
->
su³r
.
li¡_–em
);

931 
s
 = s->
Ãxt
;

934 
	`ucc_li¡_fÜ_—ch_§ã
(
¿nge
, 
tmp
, 
de¡
, 
su³r
.
li¡_–em
) {

935 ià(0 =ğ
¿nge
->
su³r
.
scÜe
) {

936 
	`ucc_li¡_d–
(&
¿nge
->
su³r
.
li¡_–em
);

937 
	`ucc_msg_¿nge_ä“
(
¿nge
);

944 
	`ucc_li¡_fÜ_—ch_§ã
(
¿nge
, 
tmp
, 
de¡
, 
su³r
.
li¡_–em
) {

945 ià(
¿nge
->
su³r
.
li¡_–em
.
Ãxt
 !ğ
de¡
) {

946 
Ãxt
 = 
	`ucc_cÚš”_of
(
¿nge
->
su³r
.
li¡_–em
.next,

947 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
);

949 ià(
¿nge
->
su³r
.
scÜe
 =ğ
Ãxt
->super.score &&

950 
¿nge
->
’d
 =ğ
Ãxt
->
¡¬t
 &&

951 
¿nge
->
su³r
.
š™
 =ğ
Ãxt
->super.init &&

952 
¿nge
->
su³r
.
‹am
 =ğ
Ãxt
->super.team &&

953 1 =ğ
	`ucc_msg_¿nge_fb_com·»
(
¿nge
, 
Ãxt
)) {

954 
Ãxt
->
¡¬t
 = 
¿nge
->start;

955 
	`ucc_li¡_d–
(&
¿nge
->
su³r
.
li¡_–em
);

956 
	`ucc_msg_¿nge_ä“
(
¿nge
);

960  
UCC_OK
;

961 
out
:

962  
¡©us
;

963 
	}
}

965 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_upd©e
(
ucc_cŞl_scÜe_t
 *
scÜe
,

966 
ucc_cŞl_scÜe_t
 *
upd©e
,

967 
ucc_scÜe_t
 
deçuÉ_scÜe
,

968 
ucc_memÜy_ty³_t
 *
mty³s
,

969 
mt_n
,

970 
ušt64_t
 
cŞls
)

972 
ucc_¡©us_t
 
¡©us
;

973 
i
, 
j
;

974 
ucc_memÜy_ty³_t
 
mt
;

976 ià(
mt_n
 == 0) {

977 
mt_n
 = 
UCC_MEMORY_TYPE_LAST
;

980 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

981 ià(!(
cŞls
 & 
	`UCS_BIT
(
i
))) {

984 
j
 = 0; j < 
mt_n
; j++) {

985 
mt
 = (
mty³s
 =ğ
NULL
è? (
ucc_memÜy_ty³_t
)
j
 : mtypes[j];

986 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_Úe
(

987 &
scÜe
->
scÜes
[
i
][
mt
],

988 &
upd©e
->
scÜes
[
i
][
mt
], 
deçuÉ_scÜe
);

989 ià(
UCC_OK
 !ğ
¡©us
) {

990  
¡©us
;

994  
UCC_OK
;

995 
	}
}

997 
ucc_¡©us_t


998 
	$ucc_cŞl_scÜe_upd©e_äom_¡r
(cÚ¡ *
¡r
,

999 cÚ¡ 
ucc_cŞl_scÜe_‹am_šfo_t
 *
šfo
,

1000 
ucc_ba£_‹am_t
 *
‹am
,

1001 
ucc_cŞl_scÜe_t
 *
scÜe
)

1003 
ucc_¡©us_t
 
¡©us
;

1004 
ucc_cŞl_scÜe_t
 *
scÜe_¡r
;

1006 
¡©us
 = 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
, &
scÜe_¡r
, 
šfo
->
size
,

1007 
šfo
->
š™
, 
‹am
, info->
®g_â
);

1008 ià(
UCC_OK
 !ğ
¡©us
) {

1009  
¡©us
;

1012 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
scÜe_¡r
,

1013 
šfo
->
deçuÉ_scÜe
,

1014 
šfo
->
suµÜ‹d_mem_ty³s
,

1015 
šfo
->
num_mem_ty³s
,

1016 
šfo
->
suµÜ‹d_cŞls
);

1017 
	`ucc_cŞl_scÜe_ä“
(
scÜe_¡r
);

1019  
¡©us
;

1020 
	}
}

1022 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_bud_deçuÉ
(
ucc_ba£_‹am_t
 *
‹am
,

1023 
ucc_scÜe_t
 
deçuÉ_scÜe
,

1024 
ucc_ba£_cŞl_š™_â_t
 
deçuÉ_š™
,

1025 
ušt64_t
 
cŞl_ty³s
,

1026 
ucc_memÜy_ty³_t
 *
mem_ty³s
,

1027 
mt_n
, 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

1029 
ucc_cŞl_scÜe_t
 *
scÜe
;

1030 
ucc_¡©us_t
 
¡©us
;

1031 
ucc_memÜy_ty³_t
 
m
;

1032 
ušt64_t
 
c
;

1033 
ucc_cŞl_ty³_t
 
ù
;

1035 
¡©us
 = 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
);

1036 ià(
UCC_OK
 !ğ
¡©us
) {

1037  
¡©us
;

1040 ià(!
mem_ty³s
) {

1041 
mt_n
 = 
UCC_MEMORY_TYPE_LAST
;

1044 
	`ucc_fÜ_—ch_b™
(
c
, 
cŞl_ty³s
) {

1045 
m
 = 
UCC_MEMORY_TYPE_HOST
; m < 
mt_n
; m++) {

1046 
ù
 = (
ucc_cŞl_ty³_t
)
	`UCC_BIT
(
c
);

1047 
¡©us
 = 
	`ucc_cŞl_scÜe_add_¿nge
(

1048 
scÜe
, 
ù
, 
mem_ty³s
 ? mem_ty³s[
m
] : m, 0, 
UCC_MSG_MAX
,

1049 
deçuÉ_scÜe
, 
deçuÉ_š™
, 
‹am
);

1050 ià(
UCC_OK
 !ğ
¡©us
) {

1051 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

1052  
¡©us
;

1056 *
scÜe_p
 = 
scÜe
;

1057  
UCC_OK
;

1058 
	}
}

1060 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_dup
(cÚ¡ 
ucc_cŞl_scÜe_t
 *
š
,

1061 
ucc_cŞl_scÜe_t
 ** 
out
)

1063 
ucc_cŞl_scÜe_t
 *
scÜe
;

1064 
ucc_¡©us_t
 
¡©us
;

1065 
i
, 
j
;

1067 
¡©us
 = 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
);

1068 ià(
UCC_OK
 !ğ
¡©us
) {

1069  
¡©us
;

1071 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

1072 
j
 = 0; j < 
UCC_MEMORY_TYPE_LAST
; j++) {

1073 
¡©us
 =

1074 
	`ucc_scÜe_li¡_dup
(&
š
->
scÜes
[
i
][
j
], &
scÜe
->scores[i][j]);

1075 ià(
UCC_OK
 !ğ
¡©us
) {

1076  
¡©us
;

1080 *
out
 = 
scÜe
;

1081  
¡©us
;

1082 
	}
}

1084 
	$ucc_cŞl_scÜe_£t
(
ucc_cŞl_scÜe_t
 *
scÜe
,

1085 
ucc_scÜe_t
 
v®ue
)

1087 
i
, 
j
;

1088 
ucc_msg_¿nge_t
 *
¿nge
;

1090 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

1091 
j
 = 0; j < 
UCC_MEMORY_TYPE_LAST
; j++) {

1092 
	`ucc_li¡_fÜ_—ch
(
¿nge
, &
scÜe
->
scÜes
[
i
][
j
], 
su³r
.
li¡_–em
) {

1093 
¿nge
->
su³r
.
scÜe
 = 
v®ue
;

1097 
	}
}

	@src/coll_score/ucc_coll_score.h

7 #iâdeà
UCC_COLL_SCORE_H_


8 
	#UCC_COLL_SCORE_H_


	)

9 
	~"cÚfig.h
"

10 
	~"uts/ucc_li¡.h
"

11 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"uts/ucc_comp”_def.h
"

14 
	~<lim™s.h
>

16 
	#UCC_SCORE_MAX
 
INT_MAX


	)

17 
	#UCC_SCORE_MIN
 0

	)

18 
	#UCC_SCORE_INVALID
 -1

	)

20 
	#UCC_MSG_MAX
 
UINT64_MAX


	)

30 
	$ucc_¡©us_t
 (*
	tucc_®g_id_to_š™_â_t
)(
	t®g_id
,

31 cÚ¡ *
	t®g_id_¡r
,

32 
	tucc_cŞl_ty³_t
 
	tcŞl_ty³
,

33 
	tucc_memÜy_ty³_t
 
	tmem_ty³
,

34 
	tucc_ba£_cŞl_š™_â_t
 *
	tš™
);

36 
	succ_cŞl_scÜe_‹am_šfo
 {

37 
ucc_scÜe_t
 
deçuÉ_scÜe
;

38 
ucc_¿nk_t
 
size
;

39 
ušt64_t
 
suµÜ‹d_cŞls
;

40 
ucc_memÜy_ty³_t
 *
suµÜ‹d_mem_ty³s
;

41 
num_mem_ty³s
;

42 
ucc_ba£_cŞl_š™_â_t
 
š™
;

43 
ucc_®g_id_to_š™_â_t
 
®g_â
;

44 } 
	tucc_cŞl_scÜe_‹am_šfo_t
;

46 
	succ_cŞl_’Œy
 {

47 
ucc_li¡_lšk_t
 
li¡_–em
;

48 
ucc_scÜe_t
 
scÜe
;

49 
ucc_ba£_cŞl_š™_â_t
 
š™
;

50 
ucc_ba£_‹am_t
 *
‹am
;

51 } 
	tucc_cŞl_’Œy_t
;

53 
	succ_msg_¿nge
 {

54 
ucc_cŞl_’Œy_t
 
su³r
;

55 
ucc_li¡_lšk_t
 
çÎback
;

56 
size_t
 
¡¬t
;

57 
size_t
 
’d
;

58 } 
	tucc_msg_¿nge_t
;

60 
	succ_cŞl_scÜe
 {

61 
ucc_li¡_lšk_t
 
scÜes
[
UCC_COLL_TYPE_NUM
][
UCC_MEMORY_TYPE_LAST
];

62 } 
	tucc_cŞl_scÜe_t
;

64 
ucc_scÜe_m­
 
	tucc_scÜe_m­_t
;

66 *
	`ucc_scÜe_to_¡r
(
ucc_scÜe_t
 
scÜe
, *
buf
, 
size_t
 
max
);

69 
ucc_¡©us_t
 
	`ucc_cŞl_scÜe_®loc
(
ucc_cŞl_scÜe_t
 **
scÜe
);

73 
ucc_¡©us_t
 
	`ucc_cŞl_scÜe_add_¿nge
(
ucc_cŞl_scÜe_t
 *
scÜe
,

74 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

75 
ucc_memÜy_ty³_t
 
mem_ty³
, 
size_t
 
¡¬t
,

76 
size_t
 
’d
, 
ucc_scÜe_t
 
msg_scÜe
,

77 
ucc_ba£_cŞl_š™_â_t
 
š™
,

78 
ucc_ba£_‹am_t
 *
‹am
);

82 
	`ucc_cŞl_scÜe_ä“
(
ucc_cŞl_scÜe_t
 *
scÜe
);

92 
ucc_¡©us_t
 
	`ucc_cŞl_scÜe_m”ge
(
ucc_cŞl_scÜe_t
 * 
scÜe1
,

93 
ucc_cŞl_scÜe_t
 * 
scÜe2
,

94 
ucc_cŞl_scÜe_t
 **
r¡
, 
ä“_šputs
);

101 
ucc_¡©us_t
 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(cÚ¡ * 
¡r
,

102 
ucc_cŞl_scÜe_t
 ** 
scÜe
,

103 
ucc_¿nk_t
 
‹am_size
,

104 
ucc_ba£_cŞl_š™_â_t
 
š™
,

105 
ucc_ba£_‹am_t
 * 
‹am
,

106 
ucc_®g_id_to_š™_â_t
 
®g_â
);

129 
ucc_¡©us_t


130 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(cÚ¡ *
¡r
,

131 cÚ¡ 
ucc_cŞl_scÜe_‹am_šfo_t
 *
šfo
,

132 
ucc_ba£_‹am_t
 *
‹am
,

133 
ucc_cŞl_scÜe_t
 *
scÜe
);

135 
ucc_¡©us_t
 
	`ucc_cŞl_scÜe_m”ge_š
(
ucc_cŞl_scÜe_t
 **
d¡
,

136 
ucc_cŞl_scÜe_t
 *
¤c
);

141 
ucc_¡©us_t
 
	`ucc_cŞl_scÜe_bud_deçuÉ
(
ucc_ba£_‹am_t
 *
‹am
,

142 
ucc_scÜe_t
 
deçuÉ_scÜe
,

143 
ucc_ba£_cŞl_š™_â_t
 
deçuÉ_š™
,

144 
ušt64_t
 
cŞl_ty³s
,

145 
ucc_memÜy_ty³_t
 *
mem_ty³s
,

146 
mt_n
, 
ucc_cŞl_scÜe_t
 **
scÜe_p
);

149 
ucc_¡©us_t
 
	`ucc_cŞl_scÜe_bud_m­
(
ucc_cŞl_scÜe_t
 *
scÜe
,

150 
ucc_scÜe_m­_t
 **
m­
);

152 
	`ucc_cŞl_scÜe_ä“_m­
(
ucc_scÜe_m­_t
 *
m­
);

156 
ucc_¡©us_t
 
	`ucc_cŞl_š™
(
ucc_scÜe_m­_t
 *
m­
,

157 
ucc_ba£_cŞl_¬gs_t
 *
b¬gs
,

158 
ucc_cŞl_sk_t
 **
sk
);

160 
ucc_¡©us_t
 
	`ucc_cŞl_scÜe_dup
(cÚ¡ 
ucc_cŞl_scÜe_t
 *
š
,

161 
ucc_cŞl_scÜe_t
 **
out
);

163 
	`ucc_cŞl_scÜe_£t
(
ucc_cŞl_scÜe_t
 *
scÜe
,

164 
ucc_scÜe_t
 
v®ue
);

166 
	`ucc_cŞl_scÜe_m­_´št_šfo
(cÚ¡ 
ucc_scÜe_m­_t
 *
scÜe
, 
v”bos™y
);

168 
ucc_¡©us_t
 
	`ucc_cŞl_scÜe_upd©e
(
ucc_cŞl_scÜe_t
 *
scÜe
,

169 
ucc_cŞl_scÜe_t
 *
upd©e
,

170 
ucc_scÜe_t
 
deçuÉ_scÜe
,

171 
ucc_memÜy_ty³_t
 *
mty³s
,

172 
mt_n
,

173 
ušt64_t
 
cŞls
);

	@src/coll_score/ucc_coll_score_map.c

7 
	~"ucc_cŞl_scÜe.h
"

8 
	~"uts/ucc_cŞl_uts.h
"

9 
	~"uts/ucc_¡ršg.h
"

10 
	~"scheduË/ucc_scheduË.h
"

12 
	~<dlfú.h
>

14 
	succ_scÜe_m­
 {

15 
ucc_cŞl_scÜe_t
 *
	mscÜe
;

19 
ucc_¿nk_t
 
	m‹am_size
;

20 
ucc_¿nk_t
 
	m‹am_¿nk
;

21 } 
	tucc_scÜe_m­_t
;

23 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_bud_m­
(
ucc_cŞl_scÜe_t
 *
scÜe
,

24 
ucc_scÜe_m­_t
 **
m­_p
)

26 
ucc_scÜe_m­_t
 *
m­
;

27 
ucc_msg_¿nge_t
 *
¿nge
, *
‹mp
, *
Ãxt
;

28 
ucc_li¡_lšk_t
 *
l¡
;

29 
i
, 
j
;

31 
m­
 = 
	`ucc_ÿÎoc
(1, (*map), "ucc_score_map");

32 ià(!
m­
) {

33 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜ scÜm­", (*
m­
));

34  
UCC_ERR_NO_MEMORY
;

41 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

42 
j
 = 0; j < 
UCC_MEMORY_TYPE_LAST
; j++) {

43 
l¡
 = &
scÜe
->
scÜes
[
i
][
j
];

44 ià(!
	`ucc_li¡_is_em±y
(
l¡
è&& 
m­
->
‹am_size
 == 0) {

47 
¿nge
 = 
	`ucc_li¡_h—d
(
l¡
, 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
);

48 
m­
->
‹am_size
 = 
¿nge
->
su³r
.
‹am
->
·¿ms
.
size
;

49 
m­
->
‹am_¿nk
 = 
¿nge
->
su³r
.
‹am
->
·¿ms
.
¿nk
;

51 
	`ucc_li¡_fÜ_—ch_§ã
(
¿nge
, 
‹mp
, 
l¡
, 
su³r
.
li¡_–em
) {

52 ià(
¿nge
->
su³r
.
li¡_–em
.
Ãxt
 !ğ
l¡
) {

53 
Ãxt
 = 
	`ucc_cÚš”_of
(
¿nge
->
su³r
.
li¡_–em
.next,

54 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
);

56 ià(
¿nge
->
’d
 =ğ
Ãxt
->
¡¬t
) {

57 ià(
¿nge
->
su³r
.
scÜe
 > 
Ãxt
->super.score) {

58 
Ãxt
->
¡¬t
++;

60 
¿nge
->
’d
--;

68 
m­
->
scÜe
 = score;

69 *
m­_p
 = 
m­
;

70  
UCC_OK
;

71 
	}
}

73 
	$ucc_cŞl_scÜe_ä“_m­
(
ucc_scÜe_m­_t
 *
m­
)

75 
	`ucc_cŞl_scÜe_ä“
(
m­
->
scÜe
);

76 
	`ucc_ä“
(
m­
);

77 
	}
}

79 
ucc_¡©us_t
 
	$ucc_cŞl_scÜe_m­_lookup
(
ucc_scÜe_m­_t
 *
m­
,

80 
ucc_ba£_cŞl_¬gs_t
 *
b¬gs
,

81 
ucc_msg_¿nge_t
 **
¿nge
)

83 
ucc_memÜy_ty³_t
 
mt
 = 
	`ucc_cŞl_¬gs_mem_ty³
(&
b¬gs
->
¬gs
,

84 
m­
->
‹am_¿nk
);

85 
ù
 = 
	`ucc_og2
(
b¬gs
->
¬gs
.
cŞl_ty³
);

86 
size_t
 
msgsize
 = 
	`ucc_cŞl_¬gs_msgsize
(&
b¬gs
->
¬gs
,

87 
m­
->
‹am_¿nk
,

88 
m­
->
‹am_size
);

89 
ucc_li¡_lšk_t
 *
li¡
;

90 
ucc_msg_¿nge_t
 *
r
;

92 ià(
mt
 =ğ
UCC_MEMORY_TYPE_NOT_APPLY
) {

95 
mt
 = 
UCC_MEMORY_TYPE_HOST
;

97 
	`ucc_as£¹
(
	`ucc_cŞl_¬gs_is_mem_symm‘ric
(&
b¬gs
->
¬gs
, 
m­
->
‹am_¿nk
));

98 ià(
msgsize
 =ğ
UCC_MSG_SIZE_INVALID
 || msgsiz=ğ
UCC_MSG_SIZE_ASYMMETRIC
) {

102 
msgsize
 = 0;

104 
li¡
 = &
m­
->
scÜe
->
scÜes
[
ù
][
mt
];

105 
	`ucc_li¡_fÜ_—ch
(
r
, 
li¡
, 
su³r
.
li¡_–em
) {

106 ià(
msgsize
 >ğ
r
->
¡¬t
 && msgsiz<ğr->
’d
) {

107 *
¿nge
 = 
r
;

108  
UCC_OK
;

111  
UCC_ERR_NOT_SUPPORTED
;

112 
	}
}

114 
ucc_¡©us_t
 
	$ucc_cŞl_š™
(
ucc_scÜe_m­_t
 *
m­
,

115 
ucc_ba£_cŞl_¬gs_t
 *
b¬gs
,

116 
ucc_cŞl_sk_t
 **
sk
)

118 
ucc_msg_¿nge_t
 *
r
;

119 
ucc_cŞl_’Œy_t
 *
fb
;

120 
ucc_ba£_‹am_t
 *
‹am
;

121 
ucc_¡©us_t
 
¡©us
;

123 
¡©us
 = 
	`ucc_cŞl_scÜe_m­_lookup
(
m­
, 
b¬gs
, &
r
);

124 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

125 
	`ucc_debug
("coll_score_map†ookup failed %d (%s)",

126 
¡©us
, 
	`ucc_¡©us_¡ršg
(status));

127  
¡©us
;

130 
‹am
 = 
r
->
su³r
.team;

131 
¡©us
 = 
r
->
su³r
.
	`š™
(
b¬gs
, 
‹am
, 
sk
);

132 ià(
UCC_OK
 =ğ
¡©us
) {

133  
UCC_OK
;

136 
fb
 = 
	`ucc_li¡_h—d
(&
r
->
çÎback
, 
ucc_cŞl_’Œy_t
, 
li¡_–em
);

137 &
fb
->
li¡_–em
 !ğ&
r
->
çÎback
 &&

138 (
¡©us
 =ğ
UCC_ERR_NOT_SUPPORTED
 ||

139 
¡©us
 =ğ
UCC_ERR_NOT_IMPLEMENTED
)) {

140 
	`ucc_debug
("coll %s is‚ot supported for %s, fallback %s",

141 
	`ucc_cŞl_ty³_¡r
(
b¬gs
->
¬gs
.
cŞl_ty³
),

142 
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
,

143 
fb
->
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
);

144 
‹am
 = 
fb
->team;

145 
¡©us
 = 
fb
->
	`š™
(
b¬gs
, 
‹am
, 
sk
);

146 
fb
 = 
	`ucc_li¡_Ãxt
(&fb->
li¡_–em
, 
ucc_cŞl_’Œy_t
,†ist_elem);

149  
¡©us
;

150 
	}
}

152 
	#STR_APPEND
(
_¡r
, 
_Ëá
, 
_tmp_size
, 
_fÜm©
, ...) { \

153 
_tmp
[
_tmp_size
]; \

154 
	`ucc_¢´štf_§ã
(
_tmp
, 
_tmp_size
, 
_fÜm©
, ## 
__VA_ARGS__
 ); \

155 
	`¡ºÿt
(
_¡r
, 
_tmp
, 
_Ëá
 - 1); \

156 
_Ëá
 = (
_¡r
è- 
	`¡¾’
(_str); \

157 ià(!
_Ëá
) { \

160 }

	)

162 cÚ¡ *
	$g‘_â_Çme
(
ucc_ba£_cŞl_š™_â_t
 
š™_â
)

164 
¡©us
;

165 
Dl_šfo
 
šfo
;

166 cÚ¡ *
â_±r_¡r
 = "?";

167 
¡©us
 = 
	`dÏddr
(
š™_â
, &
šfo
);

168 ià(
¡©us
 && 
šfo
.
dli_¢ame
 !ğ
NULL
) {

169 
â_±r_¡r
 = 
šfo
.
dli_¢ame
;

171  
â_±r_¡r
;

172 
	}
}

174 
	$ucc_cŞl_scÜe_m­_´št_šfo
(cÚ¡ 
ucc_scÜe_m­_t
 *
m­
, 
v”bos™y
)

176 
size_t
 
Ëá
;

177 
ucc_msg_¿nge_t
 *
¿nge
;

178 
i
, 
j
, 
®l_em±y
;

179 
scÜe_¡r
[32];

180 
¿nge_¡r
[128];

181 
cŞl_¡r
[1024];

183 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

184 
®l_em±y
 = 1;

185 
j
 = 0; j < 
UCC_MEMORY_TYPE_LAST
; j++) {

186 ià(!
	`ucc_li¡_is_em±y
(&
m­
->
scÜe
->
scÜes
[
i
][
j
])) {

187 
®l_em±y
 = 0;

191 ià(
®l_em±y
) {

194 
cŞl_¡r
[0] = '\0';

195 
Ëá
 = (
cŞl_¡r
);

196 
	`STR_APPEND
(
cŞl_¡r
, 
Ëá
, 32, "%s:\n",

197 
	`ucc_cŞl_ty³_¡r
((
ucc_cŞl_ty³_t
)
	`UCC_BIT
(
i
)));

198 
j
 = 0; j < 
UCC_MEMORY_TYPE_LAST
; j++) {

199 ià(
	`ucc_li¡_is_em±y
(&
m­
->
scÜe
->
scÜes
[
i
][
j
])) {

202 
	`STR_APPEND
(
cŞl_¡r
, 
Ëá
, 32, "\t%s: ",

203 
	`ucc_mem_ty³_¡r
((
ucc_memÜy_ty³_t
)
j
));

204 
	`ucc_li¡_fÜ_—ch
(
¿nge
, &
m­
->
scÜe
->
scÜes
[
i
][
j
],

205 
su³r
.
li¡_–em
) {

206 
	`ucc_memun™s_¿nge_¡r
(
¿nge
->
¡¬t
,„ªge->
’d
, 
¿nge_¡r
,

207 (
¿nge_¡r
));

208 
	`ucc_scÜe_to_¡r
(
¿nge
->
su³r
.
scÜe
, 
scÜe_¡r
,

209 (
scÜe_¡r
));

210 ià(
v”bos™y
 >ğ
UCC_LOG_LEVEL_DEBUG
) {

212 
	`STR_APPEND
(
cŞl_¡r
, 
Ëá
, 256, "{%s}:%s:%s=%s ",

213 
¿nge_¡r
,

214 
¿nge
->
su³r
.
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
,

215 
scÜe_¡r
, 
	`g‘_â_Çme
(
¿nge
->
su³r
.
š™
));

217 
	`STR_APPEND
(
cŞl_¡r
, 
Ëá
, 256, "{%s}:%s:%s ",

218 
¿nge_¡r
,

219 
¿nge
->
su³r
.
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
,

220 
scÜe_¡r
);

223 
	`STR_APPEND
(
cŞl_¡r
, 
Ëá
, 4, "\n");

225 
	`ucc_šfo
("%s", 
cŞl_¡r
);

227 
	}
}

	@src/components/base/ucc_base_iface.c

7 
	~"ucc_ba£_içû.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"uts/ucc_log.h
"

11 
ucc_cÚfig_f›ld_t
 
	gucc_ba£_lib_cÚfig_bË
[] = {

17 
ucc_off£tof
(
ucc_ba£_lib_cÚfig_t
, 
log_compÚ’t
),

18 
UCC_CONFIG_TYPE_LOG_COMP
},

22 
ucc_off£tof
(
ucc_ba£_lib_cÚfig_t
, 
u£_tunšg
), 
UCC_CONFIG_TYPE_BOOL
},

26 
ucc_off£tof
(
ucc_ba£_lib_cÚfig_t
, 
mš_‹am_size
),

27 
UCC_CONFIG_TYPE_ULUNITS
},

29 {
NULL
}};

31 
ucc_cÚfig_f›ld_t
 
	gucc_ba£_ùx_cÚfig_bË
[] = {

52 
ucc_off£tof
(
ucc_ba£_ùx_cÚfig_t
, 
scÜe_¡r
), 
UCC_CONFIG_TYPE_STRING
},

54 {
NULL
}};

56 
ucc_¡©us_t
 
	$ucc_ba£_cÚfig_»ad
(cÚ¡ *
fuÎ_´efix
,

57 
ucc_cÚfig_glob®_li¡_’Œy_t
 *
cfg_’Œy
,

58 
ucc_ba£_cÚfig_t
 **
cÚfig
)

60 
ucc_ba£_cÚfig_t
 *
cfg
;

61 
ucc_¡©us_t
 
¡©us
;

62 
cfg
 = 
	`ucc_m®loc
(
cfg_’Œy
->
size
, "cl_ctx_cfg");

63 ià(!
cfg
) {

64 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for cl context config",

65 
cfg_’Œy
->
size
);

66  
UCC_ERR_NO_MEMORY
;

68 
cfg
->
cfg_’Œy
 = cfg_entry;

69 
¡©us
 = 
	`ucc_cÚfig_·r£r_fl_İts
(
cfg
, 
cfg_’Œy
, 
fuÎ_´efix
, 0);

70 ià(
UCC_OK
 !ğ
¡©us
) {

71 
	`ucc_ä“
(
cfg
);

72 *
cÚfig
 = 
NULL
;

74 *
cÚfig
 = 
cfg
;

77  
¡©us
;

78 
	}
}

	@src/components/base/ucc_base_iface.h

7 
	~"cÚfig.h
"

9 #iâdeà
UCC_BASE_IFACE_H_


10 
	#UCC_BASE_IFACE_H_


	)

11 
	~"ucc/­i/ucc.h
"

12 
	~"cÜe/ucc_lib.h
"

13 
	~"uts/ucc_compÚ’t.h
"

14 
	~"uts/ucc_·r£r.h
"

15 
	~"uts/ucc_şass.h
"

16 
	~"uts/ucc_m®loc.h
"

17 
	~"uts/ucc_log.h
"

18 
	~"uts/ucc_cŞl_uts.h
"

20 
ucc_‹am
 
	tucc_‹am_t
;

21 
ucc_cÚ‹xt
 
	tucc_cÚ‹xt_t
;

22 
ucc_cŞl_scÜe
 
	tucc_cŞl_scÜe_t
;

23 
ucc_cŞl_sk
 
	tucc_cŞl_sk_t
;

24 
ucc_mem_m­_memh_t
 
	tucc_mem_m­_memh_t
;

25 
ucc_mem_m­__t
 
	tucc_mem_m­__t
;

27 
	succ_ba£_lib
 {

28 
ucc_log_compÚ’t_cÚfig_t
 
	mlog_compÚ’t
;

29 
	mu£_tunšg
;

30 
	mmš_‹am_size
;

31 } 
	tucc_ba£_lib_t
;

33 
	succ_ba£_cÚfig
 {

34 
ucc_cÚfig_glob®_li¡_’Œy_t
 *
	mcfg_’Œy
;

35 } 
	tucc_ba£_cÚfig_t
;

37 
	succ_ba£_lib_cÚfig
 {

38 
ucc_ba£_cÚfig_t
 
	msu³r
;

39 
ucc_log_compÚ’t_cÚfig_t
 
	mlog_compÚ’t
;

40 
	mu£_tunšg
;

41 
	mmš_‹am_size
;

42 } 
	tucc_ba£_lib_cÚfig_t
;

44 
	succ_ba£_ùx_cÚfig
 {

45 
ucc_ba£_cÚfig_t
 
	msu³r
;

46 *
	mscÜe_¡r
;

47 } 
	tucc_ba£_ùx_cÚfig_t
;

50 
	mUCC_BASE_LIB_FLAG_TEAM_ID_REQUIRED
 = 
UCC_BIT
(1),

51 
	mUCC_BASE_LIB_FLAG_SERVICE_TEAM_REQUIRED
 = 
UCC_BIT
(2),

52 
	mUCC_BASE_LIB_FLAG_CTX_SERVICE_TEAM_REQUIRED
 = 
UCC_BIT
(3)

56 
	mUCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
 = 
UCC_BIT
(0),

57 
	mUCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
 = 
UCC_BIT
(1),

58 
	mUCC_BASE_LIB_ATTR_FIELD_FLAGS
 = 
UCC_BIT
(2),

61 
	succ_ba£_lib_©Œ_t
 {

62 
ušt64_t
 
	mmask
;

63 
ucc_lib_©Œ_t
 
	m©Œ
;

64 
ucc_¿nk_t
 
	mmš_‹am_size
;

65 
ucc_¿nk_t
 
	mmax_‹am_size
;

66 
ušt64_t
 
	mæags
;

67 } 
	tucc_ba£_lib_©Œ_t
;

69 
	succ_ba£_lib_´İ”t›s
 {

70 
ucc_¿nk_t
 
	mmš_‹am_size
;

71 
ucc_¿nk_t
 
	mmax_‹am_size
;

72 
ucc_¿nk_t
 
	mdeçuÉ_‹am_size
;

73 } 
	tucc_ba£_lib_´İ”t›s_t
;

75 
	succ_ba£_lib_·¿ms
 {

76 
ucc_lib_·¿ms_t
 
	m·¿ms
;

77 *
	mfuÎ_´efix
;

78 } 
	tucc_ba£_lib_·¿ms_t
;

80 
ucc_cÚfig_f›ld_t
 
ucc_ba£_lib_cÚfig_bË
[];

81 
ucc_cÚfig_f›ld_t
 
ucc_ba£_ùx_cÚfig_bË
[];

83 
	succ_ba£_lib_içû
 {

84 
ucc_¡©us_t
 (*
š™
)(cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
	m·¿ms
,

85 cÚ¡ 
ucc_ba£_cÚfig_t
 *
	mcÚfig
,

86 
ucc_ba£_lib_t
 **
	mlib
);

87 (*
	mfš®ize
)(
ucc_ba£_lib_t
 *
	mlib
);

88 
ucc_¡©us_t
 (*
g‘_©Œ
)(cÚ¡ 
ucc_ba£_lib_t
 *
	mlib
,

89 
ucc_ba£_lib_©Œ_t
 *
	m©Œ
);

90 
ucc_¡©us_t
 (*
g‘_´İ”t›s
)(
ucc_ba£_lib_´İ”t›s_t
 *
	m´İ
);

91 } 
	tucc_ba£_lib_içû_t
;

93 
	succ_ba£_cÚ‹xt_·¿ms
 {

94 
ucc_cÚ‹xt_·¿ms_t
 
	m·¿ms
;

95 
	me¡im©ed_num_•s
;

96 
	me¡im©ed_num_µn
;

97 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

98 cÚ¡ *
	m´efix
;

99 
ucc_cÚ‹xt_t
 *
	mcÚ‹xt
;

100 } 
	tucc_ba£_cÚ‹xt_·¿ms_t
;

102 
	succ_ba£_cÚ‹xt
 {

103 
ucc_cÚ‹xt_t
 *
	mucc_cÚ‹xt
;

104 
ucc_ba£_lib_t
 *
	mlib
;

105 *
	mscÜe_¡r
;

106 } 
	tucc_ba£_cÚ‹xt_t
;

108 
	succ_ba£_ùx_©Œ_t
 {

109 
ucc_cÚ‹xt_©Œ_t
 
	m©Œ
;

110 
ušt32_t
 
	mtİo_»quœed
;

111 } 
	tucc_ba£_ùx_©Œ_t
;

113 
šlše
 
	$ucc_ba£_ùx_©Œ_ş—r
(
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

115 
ušt64_t
 
mask
 = 
©Œ
->attr.mask;

116 
	`mem£t
(
©Œ
, 0, (
ucc_ba£_ùx_©Œ_t
));

117 
©Œ
->©Œ.
mask
 = mask;

118 
	}
}

120 
	succ_ba£_cÚ‹xt_içû
 {

121 
ucc_¡©us_t
 (*
ü—‹
)(cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
	m·¿ms
,

122 cÚ¡ 
ucc_ba£_cÚfig_t
 *
	mcÚfig
,

123 
ucc_ba£_cÚ‹xt_t
 **
	mùx
);

124 
ucc_¡©us_t
 (*
ü—‹_•og
)(
ucc_ba£_cÚ‹xt_t
 *
	mùx
);

125 (*
	mde¡roy
)(
ucc_ba£_cÚ‹xt_t
 *
	mùx
);

126 
ucc_¡©us_t
 (*
g‘_©Œ
)(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
	mcÚ‹xt
,

127 
ucc_ba£_ùx_©Œ_t
 *
	m©Œ
);

134 
ucc_¡©us_t
 (*
mem_m­
)(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
	mcÚ‹xt
, 
ucc_mem_m­_mode_t
 
	mmode
,

135 
ucc_mem_m­_memh_t
 *
	mmemh
, 
ucc_mem_m­__t
 *
	m_h
);

138 
ucc_¡©us_t
 (*
mem_unm­
)(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
	mcÚ‹xt
, 
ucc_mem_m­_mode_t
 
	mmode
, 
ucc_mem_m­__t
 *
	m_h
);

143 
ucc_¡©us_t
 (*
memh_·ck
)(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
	mcÚ‹xt
, 
ucc_mem_m­_mode_t
 
	mmode
, 
ucc_mem_m­__t
 *
	m_h
,

144 **
	m·ck_bufãr
);

145 } 
	tucc_ba£_cÚ‹xt_içû_t
;

148 
	succ_ba£_‹am_·¿ms
 {

149 
ucc_‹am_·¿ms_t
 
	m·¿ms
;

150 
	mscİe
;

153 
	mscİe_id
;

157 
ucc_¿nk_t
 
	m¿nk
;

160 
ucc_¿nk_t
 
	msize
;

162 
ušt16_t
 
	mid
;

163 
ucc_‹am_t
 * 
	m‹am
;

164 
ucc_•_m­_t
 
	mm­
;

165 } 
	tucc_ba£_‹am_·¿ms_t
;

167 
	succ_ba£_‹am
 {

168 
ucc_ba£_cÚ‹xt_t
 *
	mcÚ‹xt
;

169 
ucc_ba£_‹am_·¿ms_t
 
	m·¿ms
;

170 } 
	tucc_ba£_‹am_t
;

172 
	$ucc_¡©us_t
 (*
	tucc_g‘_cŞl_scÜes_â_t
)(
	tucc_ba£_‹am_t
 *
	t‹am
,

173 
	tucc_cŞl_scÜe_t
 **
	tscÜe
);

175 
	succ_ba£_‹am_içû
 {

176 
	`ucc_¡©us_t
 (*
ü—‹_po¡
)(
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

177 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
,

178 
ucc_ba£_‹am_t
 **
‹am
);

179 
	`ucc_¡©us_t
 (*
ü—‹_‹¡
)(
ucc_ba£_‹am_t
 *
‹am
);

180 
	`ucc_¡©us_t
 (*
de¡roy
)(
ucc_ba£_‹am_t
 *
‹am
);

181 
ucc_g‘_cŞl_scÜes_â_t
 
g‘_scÜes
;

182 } 
	tucc_ba£_‹am_içû_t
;

185 
UCC_BASE_CARGS_MAX_FRAG_COUNT
 = 
	`UCC_BIT
(0),

187 
UCC_BASE_CARGS_NONROOT_INFO
 = 
	`UCC_BIT
(1)

190 
	succ_bufãr_šfo_asymm‘ric_memty³
 {

192 
ucc_cŞl_bufãr_šfo_t
 
šfo
;

193 
ucc_cŞl_bufãr_šfo_v_t
 
šfo_v
;

194 } 
Şd_asymm‘ric_bufãr
;

195 
ucc_mc_bufãr_h—d”_t
 *
sü©ch
;

196 } 
	tucc_bufãr_šfo_asymm‘ric_memty³_t
;

198 
	succ_ba£_cŞl_¬gs
 {

199 
ušt64_t
 
mask
;

200 
ucc_cŞl_¬gs_t
 
¬gs
;

201 
ucc_‹am_t
 *
‹am
;

202 
size_t
 
max_äag_couÁ
;

204 
ucc_bufãr_šfo_asymm‘ric_memty³_t
 
asymm‘ric_§ve_šfo
;

205 } 
	tucc_ba£_cŞl_¬gs_t
;

207 
	$ucc_¡©us_t
 (*
	tucc_ba£_cŞl_š™_â_t
)(
	tucc_ba£_cŞl_¬gs_t
 *
	tcŞl_¬gs
,

208 
	tucc_ba£_‹am_t
 *
	t‹am
,

209 
	tucc_cŞl_sk_t
 **
	tsk
);

211 
	succ_ba£_cŞl_içû
 {

212 
ucc_ba£_cŞl_š™_â_t
 
š™
;

213 } 
	tucc_ba£_cŞl_içû_t
;

215 
ucc_¡©us_t
 
	`ucc_ba£_cÚfig_»ad
(cÚ¡ *
fuÎ_´efix
,

216 
ucc_cÚfig_glob®_li¡_’Œy_t
 *
cfg_’Œy
,

217 
ucc_ba£_cÚfig_t
 **
cÚfig
);

219 
šlše
 
	$ucc_ba£_cÚfig_»Ëa£
(
ucc_ba£_cÚfig_t
 *
cÚfig
)

221 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(
cÚfig
, cÚfig->
cfg_’Œy
->
bË
);

222 
	`ucc_ä“
(
cÚfig
);

223 
	}
}

225 
	succ_ba£_cŞl_®g_šfo
 {

226 
	mid
;

227 cÚ¡ *
	mÇme
;

228 cÚ¡ *
	mdesc
;

229 } 
	tucc_ba£_cŞl_®g_šfo_t
;

231 
	#UCC_IFACE_NAME_PREFIX
(
_F
, 
_NAME
, 
_cfg
) \

232 .
Çme
 = 
	`UCC_PP_MAKE_STRING
(
_F
##
_NAME
), \

233 .
´efix
 = 
	`UCC_PP_MAKE_STRING
(
_F
##
_NAME
##
_
)

	)

235 
	#UCC_IFACE_CFG
(
_F
, 
_f
, 
_cfg
, 
_Çme
, 
_NAME
) \

236 .
su³r
.
_f
##
_cfg
##
_cÚfig
 = { \

237 
	`UCC_IFACE_NAME_PREFIX
(
_F
, 
_NAME
, 
_cfg
), \

238 .
bË
 = 
ucc_
##
_f
##
_Çme
##
_
##
_cfg
##
_cÚfig_bË
, \

239 .
size
 = (
ucc_
##
_f
##
_Çme
##
_
##
_cfg
##
_cÚfig_t
)}

	)

241 
	#UCC_BASE_IFACE_DECLARE
(
_F
, 
_f
, 
_Çme
, 
_NAME
) \

242 
ucc_
##
_f
##
_Çme
##
_içû_t
 ucc_##_f##_name = { \

243 
	`UCC_IFACE_CFG
(
_F
, 
_f
, 
lib
, 
_Çme
, 
_NAME
), \

244 
	`UCC_IFACE_CFG
(
_F
, 
_f
, 
cÚ‹xt
, 
_Çme
, 
_NAME
), \

245 .
su³r
.su³r.
scÜe
 = 
UCC_
##
_F
##
_NAME
##
_DEFAULT_SCORE
, \

246 .
su³r
.su³r.
Çme
 = 
	`UCC_PP_MAKE_STRING
(
_Çme
), \

247 .
su³r
.
lib
.
š™
 = 
	`UCC_CLASS_NEW_FUNC_NAME
(
ucc_
##
_f
##
_Çme
##
_lib_t
), \

248 .
su³r
.
lib
.
fš®ize
 = \

249 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc_
##
_f
##
_Çme
##
_lib_t
), \

250 .
su³r
.
lib
.
g‘_©Œ
 = 
ucc_
##
_f
##
_Çme
##
_g‘_lib_©Œ
, \

251 .
su³r
.
lib
.
g‘_´İ”t›s
 = 
ucc_
##
_f
##
_Çme
##
_g‘_lib_´İ”t›s
, \

252 .
su³r
.
cÚ‹xt
.
ü—‹
 = \

253 
	`UCC_CLASS_NEW_FUNC_NAME
(
ucc_
##
_f
##
_Çme
##
_cÚ‹xt_t
), \

254 .
su³r
.
cÚ‹xt
.
ü—‹_•og
 = 
NULL
, \

255 .
su³r
.
cÚ‹xt
.
de¡roy
 = \

256 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc_
##
_f
##
_Çme
##
_cÚ‹xt_t
), \

257 .
su³r
.
cÚ‹xt
.
g‘_©Œ
 = 
ucc_
##
_f
##
_Çme
##
_g‘_cÚ‹xt_©Œ
, \

258 .
su³r
.
cÚ‹xt
.
mem_m­
 = 
ucc_
##
_f
##
_Çme
##
_mem_m­
, \

259 .
su³r
.
cÚ‹xt
.
mem_unm­
 = 
ucc_
##
_f
##
_Çme
##
_mem_unm­
, \

260 .
su³r
.
cÚ‹xt
.
memh_·ck
 = 
ucc_
##
_f
##
_Çme
##
_memh_·ck
, \

261 .
su³r
.
‹am
.
ü—‹_po¡
 = \

262 
	`UCC_CLASS_NEW_FUNC_NAME
(
ucc_
##
_f
##
_Çme
##
_‹am_t
), \

263 .
su³r
.
‹am
.
ü—‹_‹¡
 = 
ucc_
##
_f
##
_Çme
##
_‹am_ü—‹_‹¡
, \

264 .
su³r
.
‹am
.
de¡roy
 = 
ucc_
##
_f
##
_Çme
##
_‹am_de¡roy
, \

265 .
su³r
.
‹am
.
g‘_scÜes
 = 
ucc_
##
_f
##
_Çme
##
_‹am_g‘_scÜes
, \

266 .
su³r
.
cŞl
.
š™
 = 
ucc_
##
_f
##
_Çme
##
_cŞl_š™
, \

267 .
su³r
.
®g_šfo
 = {
NULL
}}; \

268 
	`UCC_CONFIG_REGISTER_TABLE_ENTRY
(&
ucc_
##
_f
##
_Çme
.
su³r
._f##
lib_cÚfig
, \

269 &
ucc_cÚfig_glob®_li¡
); \

270 
	`UCC_CONFIG_REGISTER_TABLE_ENTRY
(&
ucc_
##
_f
##
_Çme
.
su³r
._f##
cÚ‹xt_cÚfig
, \

271 &
ucc_cÚfig_glob®_li¡
)

	)

273 
	#ucc_ba£_log
(
_lib
, 
_Ëv–
, 
fmt
, ...) \

274 
	`ucc_log_compÚ’t
(
_Ëv–
, (
_lib
)->
log_compÚ’t
, 
fmt
, \

275 ##
__VA_ARGS__
)

	)

277 
	#ba£_”rÜ
(
_lib
, 
_fmt
, ...) \

278 
	`ucc_ba£_log
(
_lib
, 
UCC_LOG_LEVEL_ERROR
, 
_fmt
, ##
__VA_ARGS__
)

	)

279 
	#ba£_w¬n
(
_lib
, 
_fmt
, ...) \

280 
	`ucc_ba£_log
(
_lib
, 
UCC_LOG_LEVEL_WARN
, 
_fmt
, ##
__VA_ARGS__
)

	)

281 
	#ba£_šfo
(
_lib
, 
_fmt
, ...) \

282 
	`ucc_ba£_log
(
_lib
, 
UCC_LOG_LEVEL_INFO
, 
_fmt
, ##
__VA_ARGS__
)

	)

283 
	#ba£_debug
(
_lib
, 
_fmt
, ...) \

284 
	`ucc_ba£_log
(
_lib
, 
UCC_LOG_LEVEL_DEBUG
, 
_fmt
, ##
__VA_ARGS__
)

	)

285 
	#ba£_Œaû
(
_lib
, 
_fmt
, ...) \

286 
	`ucc_ba£_log
(
_lib
, 
UCC_LOG_LEVEL_TRACE
, 
_fmt
, ##
__VA_ARGS__
)

	)

	@src/components/cl/basic/cl_basic.c

7 
	~"ş_basic.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
ucc_¡©us_t
 
ucc_ş_basic_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

10 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
);

11 
ucc_¡©us_t
 
ucc_ş_basic_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

12 
ucc_ba£_ùx_©Œ_t
 *
ba£_©Œ
);

13 
ucc_¡©us_t
 
ucc_ş_basic_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

14 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
);

15 
ucc_¡©us_t
 
ucc_ş_basic_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

16 
ucc_mem_m­__t
 *
_h
);

17 
ucc_¡©us_t
 
ucc_ş_basic_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

18 
ucc_mem_m­__t
 *
_h
, **
·cked_bufãr
);

20 
ucc_¡©us_t
 
ucc_ş_basic_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

22 
ucc_cÚfig_f›ld_t
 
	gucc_ş_basic_lib_cÚfig_bË
[] = {

23 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ş_basic_lib_cÚfig_t
, 
su³r
),

24 
UCC_CONFIG_TYPE_TABLE
(
ucc_ş_lib_cÚfig_bË
)},

26 {
NULL
}

29 
ucs_cÚfig_f›ld_t
 
	gucc_ş_basic_cÚ‹xt_cÚfig_bË
[] = {

30 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ş_basic_cÚ‹xt_cÚfig_t
, 
su³r
),

31 
UCC_CONFIG_TYPE_TABLE
(
ucc_ş_cÚ‹xt_cÚfig_bË
)},

33 {
NULL
}

36 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc_ş_basic_lib_t
, 
ucc_ba£_lib_t
,

37 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

38 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

40 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc_ş_basic_lib_t
, 
ucc_ba£_lib_t
);

42 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc_ş_basic_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

43 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

44 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

46 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc_ş_basic_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

48 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc_ş_basic_‹am_t
, 
ucc_ba£_‹am_t
,

49 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

51 
ucc_¡©us_t
 
ucc_ş_basic_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
ş_‹am
);

53 
ucc_¡©us_t
 
ucc_ş_basic_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
ş_‹am
);

55 
ucc_¡©us_t
 
ucc_ş_basic_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

56 
ucc_ba£_‹am_t
 *
‹am
,

57 
ucc_cŞl_sk_t
 **
sk
);

59 
ucc_¡©us_t
 
ucc_ş_basic_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
ş_‹am
,

60 
ucc_cŞl_scÜe_t
 **
scÜe
);

61 
UCC_CL_IFACE_DECLARE
(
basic
, 
BASIC
);

	@src/components/cl/basic/cl_basic.h

7 #iâdeà
UCC_CL_BASIC_H_


8 
	#UCC_CL_BASIC_H_


	)

9 
	~"compÚ’ts/ş/ucc_ş.h
"

10 
	~"compÚ’ts/ş/ucc_ş_log.h
"

11 
	~"compÚ’ts//ucc_.h
"

12 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

14 #iâdeà
UCC_CL_BASIC_DEFAULT_SCORE


15 
	#UCC_CL_BASIC_DEFAULT_SCORE
 10

	)

18 
	succ_ş_basic_içû
 {

19 
ucc_ş_içû_t
 
	msu³r
;

20 } 
	tucc_ş_basic_içû_t
;

22 
ucc_ş_basic_içû_t
 
ucc_ş_basic
;

24 
	succ_ş_basic_lib_cÚfig
 {

25 
ucc_ş_lib_cÚfig_t
 
	msu³r
;

26 } 
	tucc_ş_basic_lib_cÚfig_t
;

28 
	succ_ş_basic_cÚ‹xt_cÚfig
 {

29 
ucc_ş_cÚ‹xt_cÚfig_t
 
	msu³r
;

30 } 
	tucc_ş_basic_cÚ‹xt_cÚfig_t
;

32 
	succ_ş_basic_lib
 {

33 
ucc_ş_lib_t
 
	msu³r
;

34 } 
	tucc_ş_basic_lib_t
;

35 
UCC_CLASS_DECLARE
(
ucc_ş_basic_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

36 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

38 
	succ_ş_basic_cÚ‹xt
 {

39 
ucc_ş_cÚ‹xt_t
 
	msu³r
;

40 } 
	tucc_ş_basic_cÚ‹xt_t
;

41 
UCC_CLASS_DECLARE
(
ucc_ş_basic_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

42 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

44 
	succ_ş_basic_‹am
 {

45 
ucc_ş_‹am_t
 
	msu³r
;

46 
ucc_‹am_muÉË_»q_t
 *
	m‹am_ü—‹_»q
;

47 
ucc__‹am_t
 **
	m_‹ams
;

48 
	mn__‹ams
;

49 
ucc_cŞl_scÜe_t
 *
	mscÜe
;

50 
ucc_scÜe_m­_t
 *
	mscÜe_m­
;

51 } 
	tucc_ş_basic_‹am_t
;

52 
UCC_CLASS_DECLARE
(
ucc_ş_basic_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

53 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

55 
	#UCC_CL_BASIC_TEAM_CTX
(
_‹am
) \

56 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
, 
ucc_ş_basic_cÚ‹xt_t
))

	)

	@src/components/cl/basic/cl_basic_coll.c

7 
	~"ş_basic.h
"

8 
	~"uts/ucc_cŞl_uts.h
"

10 
ucc_¡©us_t
 
	$ucc_ş_basic_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

11 
ucc_ba£_‹am_t
 *
‹am
,

12 
ucc_cŞl_sk_t
 **
sk
)

14 
ucc_ş_basic_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_cl_basic_team_t);

15 
ucc_¡©us_t
 
¡©us
;

17 
¡©us
 = 
	`ucc_cŞl_š™
(
ş_‹am
->
scÜe_m­
, 
cŞl_¬gs
, 
sk
);

18 ià(
UCC_ERR_NOT_FOUND
 =ğ
¡©us
) {

19 
	`ş_w¬n
(
	`UCC_CL_TEAM_LIB
(
ş_‹am
),

21  
UCC_ERR_NOT_SUPPORTED
;

23  
¡©us
;

24 
	}
}

	@src/components/cl/basic/cl_basic_context.c

7 
	~"ş_basic.h
"

8 
	~"uts/ucc_m®loc.h
"

10 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_basic_cÚ‹xt_t
,

11 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

12 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

14 cÚ¡ 
ucc_ş_cÚ‹xt_cÚfig_t
 *
ş_cÚfig
 =

15 
	`ucc_d”ived_of
(
cÚfig
, 
ucc_ş_cÚ‹xt_cÚfig_t
);

16 
ucc_cÚfig_Çmes_¬¿y_t
 *
s
 = &
ş_cÚfig
->
ş_lib
->s.
¬¿y
;

17 
ucc_¡©us_t
 
¡©us
;

18 
i
;

20 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc_ş_cÚ‹xt_t
, 
ş_cÚfig
,

21 
·¿ms
->
cÚ‹xt
);

22 ià(
s
->
couÁ
 =ğ1 && !
	`¡rcmp
Ñls->
Çmes
[0], "all")) {

23 
s
 = &
·¿ms
->
cÚ‹xt
->
®l_s
;

26 
£lf
->
su³r
.
_ùxs
 = 
	`ucc_m®loc
((
ucc__cÚ‹xt_t
*è* 
s
->
couÁ
,

28 ià(!
£lf
->
su³r
.
_ùxs
) {

29 
	`ş_”rÜ
(
ş_cÚfig
->
ş_lib
, "failedo‡llocate %zd bytes forl_ctxs",

30 (
ucc__cÚ‹xt_t
**è* 
s
->
couÁ
);

31  
UCC_ERR_NO_MEMORY
;

33 
£lf
->
su³r
.
n__ùxs
 = 0;

34 
i
 = 0; i < 
s
->
couÁ
; i++) {

35 
¡©us
 = 
	`ucc__cÚ‹xt_g‘
(
·¿ms
->
cÚ‹xt
, 
s
->
Çmes
[
i
],

36 &
£lf
->
su³r
.
_ùxs
[£lf->su³r.
n__ùxs
]);

37 ià(
UCC_OK
 !ğ
¡©us
) {

38 
	`ş_debug
(
ş_cÚfig
->
ş_lib
,

39 "TL % cÚ‹xˆi nÙ‡vaabË, skpšg", 
s
->
Çmes
[
i
]);

41 
£lf
->
su³r
.
n__ùxs
++;

44 ià(0 =ğ
£lf
->
su³r
.
n__ùxs
) {

45 
	`ş_”rÜ
(
ş_cÚfig
->
ş_lib
, "no TL contexts‡re‡vailable");

46 
	`ucc_ä“
(
£lf
->
su³r
.
_ùxs
);

47 
£lf
->
su³r
.
_ùxs
 = 
NULL
;

48  
UCC_ERR_NOT_FOUND
;

50 
	`ş_debug
(
ş_cÚfig
->
ş_lib
, "š™Ÿlized cÈcÚ‹xt: %p", 
£lf
);

51  
UCC_OK
;

52 
	}
}

54 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_basic_cÚ‹xt_t
)

56 
i
;

57 
	`ş_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizing cl context: %p", self);

58 
i
 = 0; i < 
£lf
->
su³r
.
n__ùxs
; i++) {

59 
	`ucc__cÚ‹xt_put
(
£lf
->
su³r
.
_ùxs
[
i
]);

61 
	`ucc_ä“
(
£lf
->
su³r
.
_ùxs
);

62 
	}
}

64 
ucc_¡©us_t
 
	$ucc_ş_basic_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

65 *
memh
, *
_h
)

67  
UCC_ERR_NOT_SUPPORTED
;

68 
	}
}

70 
ucc_¡©us_t
 
	$ucc_ş_basic_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

71 *
_h
)

73  
UCC_ERR_NOT_SUPPORTED
;

74 
	}
}

76 
ucc_¡©us_t
 
	$ucc_ş_basic_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

77 
ty³
, *
memh
, **
·cked_bufãr
)

79  
UCC_ERR_NOT_SUPPORTED
;

80 
	}
}

82 
UCC_CLASS_DEFINE
(
ucc_ş_basic_cÚ‹xt_t
, 
ucc_ş_cÚ‹xt_t
);

84 
ucc_¡©us_t


85 
	$ucc_ş_basic_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

86 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

88 cÚ¡ 
ucc_ş_basic_cÚ‹xt_t
 *
ùx
 =

89 
	`ucc_d”ived_of
(
cÚ‹xt
, 
ucc_ş_basic_cÚ‹xt_t
);

90 
ucc_ba£_ùx_©Œ_t
 
_©Œ
;

91 
ucc_¡©us_t
 
¡©us
;

92 
i
;

94 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

99 
i
 = 0; i < 
ùx
->
su³r
.
n__ùxs
; i++) {

100 
	`mem£t
(&
_©Œ
, 0, (tl_attr));

101 
¡©us
 = 
	`UCC_TL_CTX_IFACE
(
ùx
->
su³r
.
_ùxs
[
i
])

102 ->
cÚ‹xt
.
	`g‘_©Œ
(&
ùx
->
su³r
.
_ùxs
[
i
]->su³r, &
_©Œ
);

103 ià(
UCC_OK
 !ğ
¡©us
) {

104 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo get %s ctx‡ttr",

105 
	`UCC_TL_CTX_IFACE
(
ùx
->
su³r
.
_ùxs
[
i
])->su³r.
Çme
);

106  
¡©us
;

108 ià(
_©Œ
.
tİo_»quœed
) {

109 
©Œ
->
tİo_»quœed
 = 1;

114  
UCC_OK
;

115 
	}
}

	@src/components/cl/basic/cl_basic_lib.c

7 
	~"ş_basic.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"compÚ’ts//ucc_.h
"

10 
	~"cÜe/ucc_glob®_İts.h
"

11 
	~"uts/ucc_m©h.h
"

14 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_basic_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

15 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

17 cÚ¡ 
ucc_ş_lib_cÚfig_t
 *
ş_cÚfig
 =

18 
	`ucc_d”ived_of
(
cÚfig
, 
ucc_ş_lib_cÚfig_t
);

19 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc_ş_lib_t
, &
ucc_ş_basic
.
su³r
, 
ş_cÚfig
);

20 
	`ş_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

21  
UCC_OK
;

22 
	}
}

24 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_basic_lib_t
)

26 
	`ş_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

27 
	}
}

29 
UCC_CLASS_DEFINE
(
ucc_ş_basic_lib_t
, 
ucc_ş_lib_t
);

31 
šlše
 
ucc_¡©us_t
 
	$check__lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

32 
ucc__içû_t
 *
_içû
,

33 
ucc_ş_lib_©Œ_t
 *
©Œ
)

35 
ucc__lib_©Œ_t
 
_©Œ
;

36 
ucc_¡©us_t
 
¡©us
;

38 
	`mem£t
(&
_©Œ
, 0, (tl_attr));

39 
¡©us
 = 
_içû
->
lib
.
	`g‘_©Œ
(
NULL
, &
_©Œ
.
su³r
);

40 ià(
UCC_OK
 !ğ
¡©us
) {

41 
	`ş_”rÜ
(
lib
, "failedo queryl %s†ib‡ttributes",

42 
_içû
->
su³r
.
Çme
);

43  
¡©us
;

45 
©Œ
->
su³r
.©Œ.
th»ad_mode
 =

46 
	`ucc_mš
(
©Œ
->
su³r
.©Œ.
th»ad_mode
, 
_©Œ
.super.attr.thread_mode);

47 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 |ğ
_©Œ
.super.attr.coll_types;

48 
©Œ
->
su³r
.
æags
 |ğ
_©Œ
.super.flags;

49  
UCC_OK
;

50 
	}
}

52 
ucc_¡©us_t
 
	$ucc_ş_basic_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

53 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
)

55 
ucc_ş_lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_cl_lib_attr_t);

56 
ucc_ş_basic_lib_t
 *
ş_lib
 = 
	`ucc_d”ived_of
(
lib
, ucc_cl_basic_lib_t);

57 
ucc_cÚfig_Çmes_li¡_t
 *
s
 = &
ş_lib
->
su³r
.tls;

58 
ucc__içû_t
 *
_içû
;

59 
i
;

60 
ucc_¡©us_t
 
¡©us
;

62 
©Œ
->
s
 = &
ş_lib
->
su³r
.s.
¬¿y
;

63 ià(
ş_lib
->
su³r
.
s
.
»que¡ed
) {

64 
¡©us
 = 
	`ucc_cÚfig_Çmes_¬¿y_dup
(&
ş_lib
->
su³r
.
s_fÜûd
,

65 &
ş_lib
->
su³r
.
s
.
¬¿y
);

66 ià(
UCC_OK
 !ğ
¡©us
) {

67  
¡©us
;

70 
©Œ
->
s_fÜûd
 = &
ş_lib
->
su³r
.tls_forced;

71 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

72 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 0;

73 
©Œ
->
su³r
.
æags
 = 0;

75 
	`ucc_as£¹
(
s
->
¬¿y
.
couÁ
 >= 1);

76 
i
 = 0; i < 
s
->
¬¿y
.
couÁ
; i++) {

79 
_içû
 =

80 
	`ucc_d”ived_of
(
	`ucc_g‘_compÚ’t
(&
ucc_glob®_cÚfig
.
_äamewÜk
,

81 
s
->
¬¿y
.
Çmes
[
i
]),

82 
ucc__içû_t
);

83 ià(!
_içû
) {

84 
	`ş_w¬n
(
lib
, " % i nÙ‡vaabË", 
s
->
¬¿y
.
Çmes
[
i
]);

87 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`check__lib_©Œ
(
lib
, 
_içû
, 
©Œ
))) {

88  
¡©us
;

91  
UCC_OK
;

92 
	}
}

94 
ucc_¡©us_t
 
	$ucc_ş_basic_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

96 
´İ
->
deçuÉ_‹am_size
 = 1;

97 
´İ
->
mš_‹am_size
 = 1;

98 
´İ
->
max_‹am_size
 = 
UCC_RANK_MAX
;

99  
UCC_OK
;

100 
	}
}

	@src/components/cl/basic/cl_basic_team.c

7 
	~"ş_basic.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"cÜe/ucc_‹am.h
"

11 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_basic_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
ş_cÚ‹xt
,

12 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

14 
ucc_ş_basic_cÚ‹xt_t
 *
ùx
 =

15 
	`ucc_d”ived_of
(
ş_cÚ‹xt
, 
ucc_ş_basic_cÚ‹xt_t
);

16 
n__ùxs
 = 
ùx
->
su³r
.n_tl_ctxs;

17 
i
;

18 
ucc_¡©us_t
 
¡©us
;

20 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc_ş_‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

21 
£lf
->
_‹ams
 = 
	`ucc_m®loc
((
ucc__‹am_t
 *è* 
n__ùxs
,

23 ià(!
£lf
->
_‹ams
) {

24 
	`ş_”rÜ
(
ş_cÚ‹xt
->
lib
, "failedo‡llocate %zd bytes forl_teams",

25 (
ucc__‹am_t
 *è* 
n__ùxs
);

26 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

27 
”r
;

29 
£lf
->
n__‹ams
 = 0;

30 
£lf
->
scÜe_m­
 = 
NULL
;

31 
¡©us
 = 
	`ucc_‹am_muÉË_»q_®loc
(&
£lf
->
‹am_ü—‹_»q
,

32 
n__ùxs
);

33 ià(
UCC_OK
 !ğ
¡©us
) {

34 
	`ş_”rÜ
(
ş_cÚ‹xt
->
lib
, "failedo‡llocateeam„eq multiple");

35 
”r
;

37 
i
 = 0; i < 
n__ùxs
; i++) {

38 
	`memıy
(&
£lf
->
‹am_ü—‹_»q
->
descs
[
i
].
·¿m
, 
·¿ms
,

39 (
ucc_ba£_‹am_·¿ms_t
));

40 
£lf
->
‹am_ü—‹_»q
->
descs
[
i
].
ùx
 = ctx->
su³r
.
_ùxs
[i];

41 
£lf
->
‹am_ü—‹_»q
->
descs
[
i
].
·¿m
.
scİe
 = 
UCC_CL_BASIC
;

42 
£lf
->
‹am_ü—‹_»q
->
descs
[
i
].
·¿m
.
scİe_id
 = 0;

44 
£lf
->
‹am_ü—‹_»q
->
n_‹ams
 = 
n__ùxs
;

46 
¡©us
 = 
	`ucc__‹am_ü—‹_muÉË
(
£lf
->
‹am_ü—‹_»q
);

47 ià(
¡©us
 < 0) {

48 
	`ş_”rÜ
(
ş_cÚ‹xt
->
lib
, "failedo…ostleam create (%d)",

49 
¡©us
);

50 
”r
;

52 
	`ş_debug
(
ş_cÚ‹xt
->
lib
, "po¡ed cÈ‹am: %p", 
£lf
);

53  
UCC_OK
;

54 
”r
:

55 
	`ucc_ä“
(
£lf
->
_‹ams
);

56  
¡©us
;

57 
	}
}

59 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_basic_‹am_t
)

61 
	`ş_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizing cleam: %p", self);

62 
	}
}

64 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc_ş_basic_‹am_t
, 
ucc_ba£_‹am_t
);

65 
UCC_CLASS_DEFINE
(
ucc_ş_basic_‹am_t
, 
ucc_ş_‹am_t
);

67 
ucc_¡©us_t
 
	$ucc_ş_basic_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
ş_‹am
)

69 
ucc_ş_basic_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
ş_‹am
, ucc_cl_basic_team_t);

70 
ucc_ş_basic_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_BASIC_TEAM_CTX
(
‹am
);

71 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

72 
i
;

74 ià(
NULL
 =ğ
‹am
->
‹am_ü—‹_»q
) {

75 
¡©us
 = 
	`ucc_‹am_muÉË_»q_®loc
(&
‹am
->
‹am_ü—‹_»q
,

76 
‹am
->
n__‹ams
);

77 ià(
UCC_OK
 !ğ
¡©us
) {

78 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo‡llocateeam„eq multiple");

79  
¡©us
;

81 
‹am
->
‹am_ü—‹_»q
->
n_‹ams
 =—m->
n__‹ams
;

82 
i
 = 0; i < 
‹am
->
n__‹ams
; i++) {

83 
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].‹am =—m->
_‹ams
[i];

86 
¡©us
 = 
	`ucc__‹am_de¡roy_muÉË
(
‹am
->
‹am_ü—‹_»q
);

87 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

88  
¡©us
;

90 
i
 = 0; i < 
‹am
->
n__‹ams
; i++) {

91 ià(
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].
¡©us
 !ğ
UCC_OK
) {

92 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "tleam destroy failed (%d)",

93 
¡©us
);

94 
¡©us
 = 
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].status;

97 
	`ucc_‹am_muÉË_»q_ä“
(
‹am
->
‹am_ü—‹_»q
);

98 ià(
‹am
->
scÜe_m­
) {

99 
	`ucc_cŞl_scÜe_ä“_m­
(
‹am
->
scÜe_m­
);

101 
	`ucc_ä“
(
‹am
->
_‹ams
);

102 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc_ş_basic_‹am_t
)(
ş_‹am
);

103  
¡©us
;

104 
	}
}

106 
ucc_¡©us_t
 
	$ucc_ş_basic_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
ş_‹am
)

108 
ucc_ş_basic_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
ş_‹am
, ucc_cl_basic_team_t);

109 
ucc_ş_basic_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_BASIC_TEAM_CTX
(
‹am
);

110 
ucc_¡©us_t
 
¡©us
;

111 
i
;

112 
ucc_cŞl_scÜe_t
 *
scÜe
, *
scÜe_Ãxt
, *
scÜe_m”ge
;

114 
¡©us
 = 
	`ucc__‹am_ü—‹_muÉË
(
‹am
->
‹am_ü—‹_»q
);

115 ià(
¡©us
 =ğ
UCC_OK
) {

116 
i
 = 0; i < 
ùx
->
su³r
.
n__ùxs
; i++) {

117 ià(
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].
¡©us
 =ğ
UCC_OK
) {

118 
‹am
->
_‹ams
[‹am->
n__‹ams
++] =

119 
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].team;

120 
	`ş_debug
(
ùx
->
su³r
.su³r.
lib
, "initializedl %seam",

121 
	`UCC_TL_CTX_IFACE
(
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].
ùx
)->

122 
su³r
.
Çme
);

124 
	`ş_debug
(
ùx
->
su³r
.su³r.
lib
, "failedo createl %seam: (%d)",

125 
	`UCC_TL_CTX_IFACE
(
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].
ùx
)->

126 
su³r
.
Çme
, 
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].
¡©us
);

129 
	`ucc_‹am_muÉË_»q_ä“
(
‹am
->
‹am_ü—‹_»q
);

130 
‹am
->
‹am_ü—‹_»q
 = 
NULL
;

131 ià(0 =ğ
‹am
->
n__‹ams
) {

132 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "noleams were created");

133  
UCC_ERR_NOT_FOUND
;

135 
¡©us
 =

136 
	`UCC_TL_TEAM_IFACE
(
‹am
->
_‹ams
[0])

137 ->
‹am
.
	`g‘_scÜes
(&‹am->
_‹ams
[0]->
su³r
, &
scÜe
);

138 ià(
UCC_OK
 !ğ
¡©us
) {

139 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo getl %s scores",

140 
	`UCC_TL_TEAM_IFACE
(
‹am
->
_‹ams
[0])->
su³r
.
Çme
);

141  
¡©us
;

143 
i
 = 1; i < 
‹am
->
n__‹ams
; i++) {

144 
¡©us
 =

145 
	`UCC_TL_TEAM_IFACE
(
‹am
->
_‹ams
[
i
])

146 ->
‹am
.
	`g‘_scÜes
(&‹am->
_‹ams
[
i
]->
su³r
, &
scÜe_Ãxt
);

147 ià(
UCC_OK
 !ğ
¡©us
) {

148 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo getl %s scores",

149 
	`UCC_TL_TEAM_IFACE
(
‹am
->
_‹ams
[
i
])->
su³r
.
Çme
);

150  
¡©us
;

152 
¡©us
 =

153 
	`ucc_cŞl_scÜe_m”ge
(
scÜe
, 
scÜe_Ãxt
, &
scÜe_m”ge
, 1);

154 ià(
UCC_OK
 !ğ
¡©us
) {

155 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo merge scores");

156  
¡©us
;

158 
scÜe
 = 
scÜe_m”ge
;

160 
¡©us
 = 
	`ucc_cŞl_scÜe_bud_m­
(
scÜe
, &
‹am
->
scÜe_m­
);

161 ià(
UCC_OK
 !ğ
¡©us
) {

162 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo build score map");

164 
‹am
->
scÜe
 = score;

165 
	`ucc_cŞl_scÜe_£t
(
‹am
->
scÜe
, 
UCC_CL_BASIC_DEFAULT_SCORE
);

167  
¡©us
;

168 
	}
}

170 
ucc_¡©us_t
 
	$ucc_ş_basic_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
ş_‹am
,

171 
ucc_cŞl_scÜe_t
 **
scÜe
)

173 
ucc_ş_basic_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
ş_‹am
, ucc_cl_basic_team_t);

174 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_TEAM_CTX
(
‹am
);

175 
ucc_¡©us_t
 
¡©us
;

176 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

178 
¡©us
 = 
	`ucc_cŞl_scÜe_dup
(
‹am
->
scÜe
, score);

179 ià(
UCC_OK
 !ğ
¡©us
) {

180  
¡©us
;

183 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

184 
‹am_šfo
.
®g_â
 = 
NULL
;

185 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_CL_BASIC_DEFAULT_SCORE
;

186 
‹am_šfo
.
š™
 = 
NULL
;

187 
‹am_šfo
.
num_mem_ty³s
 = 0;

188 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = 
NULL
;

189 
‹am_šfo
.
suµÜ‹d_cŞls
 = 
UCC_COLL_TYPE_ALL
;

190 
‹am_šfo
.
size
 = 
	`UCC_CL_TEAM_SIZE
(
‹am
);

192 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

193 &
‹am
->
su³r
.su³r, *
scÜe
);

195 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

196 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

197 
”r
;

200  
UCC_OK
;

202 
”r
:

203 
	`ucc_cŞl_scÜe_ä“
(*
scÜe
);

204 *
scÜe
 = 
NULL
;

205  
¡©us
;

206 
	}
}

	@src/components/cl/doca_urom/cl_doca_urom.c

7 
	~"ş_doÿ_urom.h
"

8 
	~"uts/ucc_m®loc.h
"

10 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

11 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
);

13 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

14 
ucc_ba£_ùx_©Œ_t
 *
ba£_©Œ
);

16 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

17 
ty³
, *
memh
, *
_h
);

19 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

20 
ty³
, *
_h
);

22 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

23 
ty³
, *
memh
, **
·cked_bufãr
);

25 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

27 
ucc_cÚfig_f›ld_t
 
	gucc_ş_doÿ_urom_lib_cÚfig_bË
[] = {

28 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ş_doÿ_urom_lib_cÚfig_t
, 
su³r
),

29 
UCC_CONFIG_TYPE_TABLE
(
ucc_ş_lib_cÚfig_bË
)},

31 {
NULL
}};

33 
ucs_cÚfig_f›ld_t
 
	gucc_ş_doÿ_urom_cÚ‹xt_cÚfig_bË
[] = {

34 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ş_doÿ_urom_cÚ‹xt_cÚfig_t
, 
su³r
),

35 
UCC_CONFIG_TYPE_TABLE
(
ucc_ş_cÚ‹xt_cÚfig_bË
)},

39 
ucc_off£tof
(
ucc_ş_doÿ_urom_cÚ‹xt_cÚfig_t
, 
¶ugš_’vs
),

40 
UCC_CONFIG_TYPE_STRING_ARRAY
},

44 
ucc_off£tof
(
ucc_ş_doÿ_urom_cÚ‹xt_cÚfig_t
, 
deviû
),

45 
UCC_CONFIG_TYPE_STRING
},

49 
ucc_off£tof
(
ucc_ş_doÿ_urom_cÚ‹xt_cÚfig_t
, 
¶ugš_Çme
),

50 
UCC_CONFIG_TYPE_STRING
},

54 
ucc_off£tof
(
ucc_ş_doÿ_urom_cÚ‹xt_cÚfig_t
, 
doÿ_log_Ëv–
),

55 
UCC_CONFIG_TYPE_INT
},

57 {
NULL
}};

59 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc_ş_doÿ_urom_lib_t
, 
ucc_ba£_lib_t
,

60 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

61 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

63 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc_ş_doÿ_urom_lib_t
, 
ucc_ba£_lib_t
);

65 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc_ş_doÿ_urom_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

66 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

67 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

69 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc_ş_doÿ_urom_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

71 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc_ş_doÿ_urom_‹am_t
, 
ucc_ba£_‹am_t
,

72 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

74 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
ş_‹am
);

76 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
ş_‹am
);

78 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

79 
ucc_ba£_‹am_t
 *
‹am
,

80 
ucc_cŞl_sk_t
 **
sk
);

82 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
ş_‹am
,

83 
ucc_cŞl_scÜe_t
 **
scÜe
);

85 
UCC_CL_IFACE_DECLARE
(
doÿ_urom
, 
DOCA_UROM
);

	@src/components/cl/doca_urom/cl_doca_urom.h

7 #iâdeà
UCC_CL_DOCA_UROM_H_


8 
	#UCC_CL_DOCA_UROM_H_


	)

10 
	~"compÚ’ts/ş/ucc_ş.h
"

11 
	~"compÚ’ts/ş/ucc_ş_log.h
"

12 
	~"compÚ’ts//ucc_.h
"

13 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

14 
	~"uts/ucc_mpoŞ.h
"

16 
	~<doÿ_dev.h
>

17 
	~<doÿ_urom.h
>

18 
	~<doÿ_³.h
>

19 
	~<doÿ_ùx.h
>

20 
	~<doÿ_buf.h
>

22 
	~"ş_doÿ_urom_commÚ.h
"

23 
	~"ş_doÿ_urom_wÜk”_ucc.h
"

25 
	~<urom_ucc.h
>

27 #iâdeà
UCC_CL_DOCA_UROM_DEFAULT_SCORE


28 
	#UCC_CL_DOCA_UROM_DEFAULT_SCORE
 100

	)

31 
	#UCC_CL_DOCA_UROM_ADDR_MAX_LEN
 1024

	)

32 
	#UCC_CL_DOCA_UROM_MAX_TEAMS
 16

	)

34 
	succ_ş_doÿ_urom_içû
 {

35 
ucc_ş_içû_t
 
	msu³r
;

36 } 
	tucc_ş_doÿ_urom_içû_t
;

39 
ucc_ş_doÿ_urom_içû_t
 
ucc_ş_doÿ_urom
;

41 
	succ_ş_doÿ_urom_lib_cÚfig
 {

42 
ucc_ş_lib_cÚfig_t
 
	msu³r
;

43 } 
	tucc_ş_doÿ_urom_lib_cÚfig_t
;

45 
	succ_ş_doÿ_urom_cÚ‹xt_cÚfig
 {

46 
ucc_ş_cÚ‹xt_cÚfig_t
 
	msu³r
;

47 
ucs_cÚfig_Çmes_¬¿y_t
 
	m¶ugš_’vs
;

48 *
	mdeviû
;

49 *
	m¶ugš_Çme
;

50 
	mdoÿ_log_Ëv–
;

51 } 
	tucc_ş_doÿ_urom_cÚ‹xt_cÚfig_t
;

53 
	succ_ş_doÿ_urom_ùx
 {

54 
doÿ_urom_£rviû
 *
	murom_£rviû
;

55 
doÿ_urom_wÜk”
 *
	murom_wÜk”
;

56 
doÿ_urom_domaš
 *
	murom_domaš
;

57 
doÿ_³
 *
	murom_³
;

58 cÚ¡ 
doÿ_urom_£rviû_¶ugš_šfo
 *
	mucc_šfo
;

59 *
	murom_wÜk”_addr
;

60 
size_t
 
	murom_wÜk”_Ën
;

61 
ušt64_t
 
	mwÜk”_id
;

62 *
	murom_ucc_cÚ‹xt
;

63 
ucc_¿nk_t
 
	mùx_¿nk
;

64 
doÿ_dev
 *
	mdev
;

65 } 
	tucc_ş_doÿ_urom_ùx_t
;

67 
	succ_ş_doÿ_urom_lib
 {

68 
ucc_ş_lib_t
 
	msu³r
;

69 
ucc_ş_doÿ_urom_lib_cÚfig_t
 
	mcfg
;

70 
	m_uı_šdex
;

71 } 
	tucc_ş_doÿ_urom_lib_t
;

72 
UCC_CLASS_DECLARE
(
ucc_ş_doÿ_urom_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

73 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

75 
	succ_ş_doÿ_urom_cÚ‹xt
 {

76 
ucc_ş_cÚ‹xt_t
 
	msu³r
;

77 
ucc_mpoŞ_t
 
	msched_mp
;

78 
ucc_ş_doÿ_urom_ùx_t
 
	murom_ùx
;

79 
ucc_ş_doÿ_urom_cÚ‹xt_cÚfig_t
 
	mcfg
;

80 } 
	tucc_ş_doÿ_urom_cÚ‹xt_t
;

81 
UCC_CLASS_DECLARE
(
ucc_ş_doÿ_urom_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

82 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

84 
	succ_ş_doÿ_urom_‹am
 {

85 
ucc_ş_‹am_t
 
	msu³r
;

86 
ucc_‹am_h
 **
	m‹ams
;

87 
	mn_‹ams
;

88 
ucc_cŞl_scÜe_t
 *
	mscÜe
;

89 
ucc_scÜe_m­_t
 *
	mscÜe_m­
;

90 
ucc_ş_doÿ_urom_»suÉ
 
	m»s
;

91 } 
	tucc_ş_doÿ_urom_‹am_t
;

92 
UCC_CLASS_DECLARE
(
ucc_ş_doÿ_urom_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

93 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

95 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

96 
ucc_ba£_‹am_t
 *
‹am
,

97 
ucc_cŞl_sk_t
 **
sk
);

99 
	#UCC_CL_DOCA_UROM_TEAM_CTX
(
_‹am
) \

100 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
, 
ucc_ş_doÿ_urom_cÚ‹xt_t
))

	)

	@src/components/cl/doca_urom/cl_doca_urom_coll.c

7 
	~"ş_doÿ_urom.h
"

8 
	~"ş_doÿ_urom_cŞl.h
"

9 
	~"uts/ucc_cŞl_uts.h
"

11 
	~<doÿ_urom.h
>

12 
	~<urom_ucc.h
>

14 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_Œigg”ed_po¡_£tup
(
ucc_cŞl_sk_t
 *
sk
)

16  
UCC_OK
;

17 
	}
}

19 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_cŞl_fuÎ_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

21 
ucc_ş_doÿ_urom_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
sk
->
‹am
,

22 
ucc_ş_doÿ_urom_‹am_t
);

23 
ucc_ş_doÿ_urom_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_DOCA_UROM_TEAM_CTX
(
ş_‹am
);

24 
ucc_ş_doÿ_urom_lib_t
 *
ş_lib
 = 
	`ucc_d”ived_of
(
ùx
->
su³r
.su³r.
lib
,

25 
ucc_ş_doÿ_urom_lib_t
);

26 
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
 = &
sk
->
b¬gs
.
¬gs
;

27 
doÿ_d©a
 
cook›
 = {0};

28 
u£_xgvmi
 = 0;

29 
š_¶aû
 = 
	`UCC_IS_INPLACE
(*
cŞl_¬gs
);

30 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_CL_TEAM_RANK
(
ş_‹am
);

31 
ucc_ş_doÿ_urom_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
,

32 
ucc_ş_doÿ_urom_scheduË_t
);

33 
expÜt_buf
 *
¤c_ebuf
 = &
scheduË
->src_ebuf;

34 
expÜt_buf
 *
d¡_ebuf
 = &
scheduË
->dst_ebuf;

35 
doÿ_”rÜ_t
 
»suÉ
;

36 
ucc_wÜk”_key_buf
 
keys
;

38 
cook›
.
±r
 = &
scheduË
->
»s
;

40 
cŞl_¬gs
->
cŞl_ty³
) {

41 
UCC_COLL_TYPE_ALLREDUCE
:

43 ià(!
š_¶aû
) {

44 
keys
.
¤c_Ën
 = 
¤c_ebuf
->
·cked_memh_Ën
;

45 
	`memıy
(
keys
.
rkeys
, 
¤c_ebuf
->
·cked_memh
, keys.
¤c_Ën
);

47 
keys
.
¤c_Ën
 = 0;

49 
keys
.
d¡_Ën
 = 
d¡_ebuf
->
·cked_memh_Ën
;

50 
	`memıy
(
keys
.
rkeys
 + keys.
¤c_Ën
,

51 
d¡_ebuf
->
·cked_memh
,

52 
keys
.
d¡_Ën
);

53 
u£_xgvmi
 = 1;

57 
	`ş_”rÜ
(&
ş_lib
->
su³r
, "coll_type %s is‚ot supported",

58 
	`ucc_cŞl_ty³_¡r
(
cŞl_¬gs
->
cŞl_ty³
));

59  
UCC_ERR_NOT_IMPLEMENTED
;

63 
cŞl_¬gs
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
;

66 
»suÉ
 = 
	`ucc_ş_doÿ_urom_sk_cŞËùive
(
ùx
->
urom_ùx
.
urom_wÜk”
,

67 
cook›
,

68 
¿nk
,

69 
cŞl_¬gs
,

70 
ş_‹am
->
‹ams
[0],

71 
u£_xgvmi
,

72 &
keys
,

73 (
ucc_wÜk”_key_buf
),

75 
ucc_ş_doÿ_urom_cŞËùive_fšished
);

76 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

77 
	`ş_”rÜ
(&
ş_lib
->
su³r
, "failedo create UCC collectiveask");

80 
sk
->
¡©us
 = 
UCC_INPROGRESS
;

82 
	`ş_debug
(&
ş_lib
->
su³r
, "pushedhe collectiveo urom");

83  
	`ucc_´og»ss_queue_’queue
(
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
->
pq
, 
sk
);

84 
	}
}

86 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_cŞl_fuÎ_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

88 
ucc_ş_doÿ_urom_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
,

89 
ucc_ş_doÿ_urom_scheduË_t
);

90 
ucc_ş_doÿ_urom_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
sk
->
‹am
,

91 
ucc_ş_doÿ_urom_‹am_t
);

92 
ucc_ş_doÿ_urom_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_DOCA_UROM_TEAM_CTX
(
ş_‹am
);

93 
ucc_ş_doÿ_urom_lib_t
 *
ş_lib
 = 
	`ucc_d”ived_of
(
ùx
->
su³r
.su³r.
lib
,

94 
ucc_ş_doÿ_urom_lib_t
);

95 
uı_šdex
 = 
ş_lib
->
_uı_šdex
;

96 
ucc__uı_cÚ‹xt_t
 *
_ùx
 = 
	`ucc_d”ived_of
(

97 
ùx
->
su³r
.
_ùxs
[
uı_šdex
],

98 
ucc__uı_cÚ‹xt_t
);

99 
expÜt_buf
 *
¤c_ebuf
 = &
scheduË
->src_ebuf;

100 
expÜt_buf
 *
d¡_ebuf
 = &
scheduË
->dst_ebuf;

101 
ucc_¡©us_t
 
¡©us
;

104 ià(
¤c_ebuf
->
memh
) {

105 
	`uı_mem_unm­
(
_ùx
->
wÜk”
.
uı_cÚ‹xt
, 
¤c_ebuf
->
memh
);

107 
	`uı_mem_unm­
(
_ùx
->
wÜk”
.
uı_cÚ‹xt
, 
d¡_ebuf
->
memh
);

109 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

110 
	`ucc_ş_doÿ_urom_put_scheduË
(&
scheduË
->
su³r
.super);

112  
¡©us
;

113 
	}
}

115 
	$ucc_ş_doÿ_urom_cŞl_fuÎ_´og»ss
(
ucc_cŞl_sk_t
 *
ùask
)

117 
ucc_ş_doÿ_urom_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
ùask
->
‹am
,

118 
ucc_ş_doÿ_urom_‹am_t
);

119 
ucc_ş_doÿ_urom_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_DOCA_UROM_TEAM_CTX
(
ş_‹am
);

120 
ucc_ş_doÿ_urom_lib_t
 *
ş_lib
 = 
	`ucc_d”ived_of
(

121 
ùx
->
su³r
.su³r.
lib
,

122 
ucc_ş_doÿ_urom_lib_t
);

123 
ucc_ş_doÿ_urom_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
ùask
,

124 
ucc_ş_doÿ_urom_scheduË_t
);

125 
uı_šdex
 = 
ş_lib
->
_uı_šdex
;

126 
ucc__uı_cÚ‹xt_t
 *
_ùx
 = 
	`ucc_d”ived_of
(

127 
ùx
->
su³r
.
_ùxs
[
uı_šdex
],

128 
ucc__uı_cÚ‹xt_t
);

129 
ucc_ş_doÿ_urom_»suÉ
 *
»s
 = &
scheduË
->res;

130 
»t
;

132 ià(
»s
 =ğ
NULL
) {

133 
	`ş_”rÜ
(
ş_lib
, "error in UROM");

134 
ùask
->
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

138 
	`uı_wÜk”_´og»ss
(
_ùx
->
wÜk”
.
uı_wÜk”
);

141 
»t
 = 
	`doÿ_³_´og»ss
(
ùx
->
urom_ùx
.
urom_³
);

142 ià(
»t
 =ğ0 && 
»s
->
»suÉ
 =ğ
DOCA_SUCCESS
) {

143 
ùask
->
¡©us
 = 
UCC_INPROGRESS
;

147 ià(
»s
->
»suÉ
 !ğ
DOCA_SUCCESS
) {

148 
	`ş_”rÜ
(&
ş_lib
->
su³r
, "error in DOCA_UROM, UCC collectiveask failed");

151 
ùask
->
¡©us
 = 
»s
->
cŞËùive
.status;

152 
	`ş_debug
(&
ş_lib
->
su³r
, "completedhe collective from urom");

153 
	}
}

155 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_cŞl_fuÎ_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

156 
ucc_ba£_‹am_t
 *
‹am
,

157 
ucc_cŞl_sk_t
 **
sk
)

159 
ucc_ş_doÿ_urom_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
‹am
,

160 
ucc_ş_doÿ_urom_‹am_t
);

161 
ucc_ş_doÿ_urom_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_DOCA_UROM_TEAM_CTX
(
ş_‹am
);

162 
ucc_ş_doÿ_urom_lib_t
 *
ş_lib
 = 
	`ucc_d”ived_of
(
ùx
->
su³r
.su³r.
lib
,

163 
ucc_ş_doÿ_urom_lib_t
);

164 
uı_idx
 = 
ş_lib
->
_uı_šdex
;

165 
ucc__uı_cÚ‹xt_t
 *
_ùx
 = 
	`ucc_d”ived_of
(

166 
ùx
->
su³r
.
_ùxs
[
uı_idx
],

167 
ucc__uı_cÚ‹xt_t
);

168 
š_¶aû
 = 
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
);

169 
expÜt_buf
 *
¤c_ebuf
;

170 
expÜt_buf
 *
d¡_ebuf
;

171 
ucc_¡©us_t
 
¡©us
;

172 
ucc_ş_doÿ_urom_scheduË_t
 *
ş_scheduË
;

173 
ucc_scheduË_t
 *
scheduË
;

176 
ş_scheduË
 = 
	`ucc_ş_doÿ_urom_g‘_scheduË
(
ş_‹am
);

177 ià(
	`ucc_uÆik–y
(!
ş_scheduË
)) {

178  
UCC_ERR_NO_MEMORY
;

180 
scheduË
 = &
ş_scheduË
->
su³r
.super;

181 
¡©us
 = 
	`ucc_scheduË_š™
(
scheduË
, 
cŞl_¬gs
, 
‹am
);

182 ià(
UCC_OK
 !ğ
¡©us
) {

183 
	`ucc_ş_doÿ_urom_put_scheduË
(
scheduË
);

184  
¡©us
;

187 
scheduË
->
su³r
.
po¡
 = 
ucc_ş_doÿ_urom_cŞl_fuÎ_¡¬t
;

188 
scheduË
->
su³r
.
´og»ss
 = 
ucc_ş_doÿ_urom_cŞl_fuÎ_´og»ss
;

189 
scheduË
->
su³r
.
fš®ize
 = 
ucc_ş_doÿ_urom_cŞl_fuÎ_fš®ize
;

190 
scheduË
->
su³r
.
Œigg”ed_po¡
 = 
ucc_Œigg”ed_po¡
;

191 
scheduË
->
su³r
.
Œigg”ed_po¡_£tup
 = 
ucc_ş_doÿ_urom_Œigg”ed_po¡_£tup
;

193 *
sk
 = &
scheduË
->
su³r
;

195 
¤c_ebuf
 = &
ş_scheduË
->src_ebuf;

196 
d¡_ebuf
 = &
ş_scheduË
->dst_ebuf;

198 
¤c_ebuf
->
memh
 = 
NULL
;

199 
d¡_ebuf
->
memh
 = 
NULL
;

202 ià(!
š_¶aû
) {

203 
	`ucc_ş_doÿ_urom_bufãr_expÜt_ucc
(

204 
_ùx
->
wÜk”
.
uı_cÚ‹xt
,

205 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
bufãr
,

206 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
couÁ
 *

207 
	`ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
d©©y³
),

208 
¤c_ebuf
);

212 
	`ucc_ş_doÿ_urom_bufãr_expÜt_ucc
(

213 
_ùx
->
wÜk”
.
uı_cÚ‹xt
,

214 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
bufãr
,

215 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
couÁ
 *

216 
	`ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
),

217 
d¡_ebuf
);

219 
	`ş_debug
(
ş_lib
, "cl doca urom coll initialized");

220  
UCC_OK
;

221 
	}
}

223 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

224 
ucc_ba£_‹am_t
 *
‹am
,

225 
ucc_cŞl_sk_t
 **
sk
)

227 
ucc_ş_doÿ_urom_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
‹am
,

228 
ucc_ş_doÿ_urom_‹am_t
);

229 
ucc_ş_doÿ_urom_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_DOCA_UROM_TEAM_CTX
(
ş_‹am
);

230 
ucc_ş_doÿ_urom_lib_t
 *
doÿ_urom_lib
 = 
	`ucc_d”ived_of
(

231 
ùx
->
su³r
.su³r.
lib
,

232 
ucc_ş_doÿ_urom_lib_t
);

234 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
) {

235 
UCC_COLL_TYPE_ALLREDUCE
:

236 
UCC_COLL_TYPE_ALLGATHER
:

237 
UCC_COLL_TYPE_ALLTOALL
:

238  
	`ucc_ş_doÿ_urom_cŞl_fuÎ_š™
(
cŞl_¬gs
, 
‹am
, 
sk
);

240 
	`ş_”rÜ
(
doÿ_urom_lib
, "coll_type %s is‚ot supported",

241 
	`ucc_cŞl_ty³_¡r
(
cŞl_¬gs
->
¬gs
.
cŞl_ty³
));

244  
UCC_OK
;

245 
	}
}

	@src/components/cl/doca_urom/cl_doca_urom_coll.h

6 #iâdeà
UCC_CL_DOCA_UROM_COLL_H_


7 
	#UCC_CL_DOCA_UROM_COLL_H_


	)

9 
	~"ş_doÿ_urom.h
"

10 
	~"scheduË/ucc_scheduË_p–šed.h
"

11 
	~"compÚ’ts/mc/ucc_mc.h
"

13 
	~"../..//uı/_uı.h
"

15 
	#UCC_CL_DOCA_UROM_N_DEFAULT_ALG_SELECT_STR
 2

	)

18 *
ucc_ş_doÿ_urom_deçuÉ_®g_£Ëù_¡r
[
UCC_CL_DOCA_UROM_N_DEFAULT_ALG_SELECT_STR
];

20 
	succ_ş_doÿ_urom_scheduË_t
 {

21 
ucc_scheduË_p–šed_t
 
	msu³r
;

22 
ucc_ş_doÿ_urom_»suÉ
 
	m»s
;

23 
expÜt_buf
 
	m¤c_ebuf
;

24 
expÜt_buf
 
	md¡_ebuf
;

25 } 
	tucc_ş_doÿ_urom_scheduË_t
;

27 
šlše
 
ucc_ş_doÿ_urom_scheduË_t
 *

28 
	$ucc_ş_doÿ_urom_g‘_scheduË
(
ucc_ş_doÿ_urom_‹am_t
 *
‹am
)

30 
ucc_ş_doÿ_urom_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_DOCA_UROM_TEAM_CTX
(
‹am
);

31 
ucc_ş_doÿ_urom_scheduË_t
 *
scheduË
 = 
	`ucc_mpoŞ_g‘
(&
ùx
->
sched_mp
);

33  
scheduË
;

34 
	}
}

36 
šlše
 
	$ucc_ş_doÿ_urom_put_scheduË
(
ucc_scheduË_t
 *
scheduË
)

38 
	`ucc_mpoŞ_put
(
scheduË
);

39 
	}
}

	@src/components/cl/doca_urom/cl_doca_urom_common.c

14 #iâdeà
_GNU_SOURCE


15 
	#_GNU_SOURCE


	)

18 
	~<¬·/š‘.h
>

19 
	~<Ãtdb.h
>

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<uni¡d.h
>

25 
	~<doÿ_¬gp.h
>

26 
	~<doÿ_ùx.h
>

27 
	~<doÿ_log.h
>

29 
	~"ş_doÿ_urom_commÚ.h
"

31 
DOCA_LOG_REGISTER
(
UCC
::
DOCA_CL
 : 
UROM_COMMON
);

33 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_¡¬t_urom_£rviû
(

34 
doÿ_³
 *
³
, 
doÿ_dev
 *
dev
, 
ušt64_t
 
nb_wÜk”s
,

35 
doÿ_urom_£rviû
 **
£rviû
)

37 
doÿ_ùx_¡©es
 
¡©e
;

38 
doÿ_urom_£rviû
 *
š¡
;

39 
doÿ_”rÜ_t
 
»suÉ
, 
tmp_»suÉ
;

42 
»suÉ
 = 
	`doÿ_urom_£rviû_ü—‹
(&
š¡
);

43 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

44  
»suÉ
;

46 
»suÉ
 = 
	`doÿ_³_cÚÃù_ùx
(
³
, 
	`doÿ_urom_£rviû_as_ùx
(
š¡
));

47 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

48 
£rviû_ş—nup
;

50 
»suÉ
 = 
	`doÿ_urom_£rviû_£t_max_wÜk”s
(
š¡
, 
nb_wÜk”s
);

51 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

52 
£rviû_ş—nup
;

54 
»suÉ
 = 
	`doÿ_urom_£rviû_£t_dev
(
š¡
, 
dev
);

55 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

56 
£rviû_ş—nup
;

58 
»suÉ
 = 
	`doÿ_ùx_¡¬t
(
	`doÿ_urom_£rviû_as_ùx
(
š¡
));

59 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

60 
£rviû_ş—nup
;

62 
»suÉ
 = 
	`doÿ_ùx_g‘_¡©e
(
	`doÿ_urom_£rviû_as_ùx
(
š¡
), &
¡©e
);

63 ià(
»suÉ
 !ğ
DOCA_SUCCESS
 || 
¡©e
 !ğ
DOCA_CTX_STATE_RUNNING
)

64 
£rviû_¡İ
;

66 *
£rviû
 = 
š¡
;

67  
DOCA_SUCCESS
;

69 
£rviû_¡İ
:

70 
tmp_»suÉ
 = 
	`doÿ_ùx_¡İ
(
	`doÿ_urom_£rviû_as_ùx
(
š¡
));

71 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

72 
	`DOCA_LOG_ERR
("failedo stop UROM service");

73 
	`DOCA_ERROR_PROPAGATE
(
»suÉ
, 
tmp_»suÉ
);

76 
£rviû_ş—nup
:

77 
tmp_»suÉ
 = 
	`doÿ_urom_£rviû_de¡roy
(
š¡
);

78 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

79 
	`DOCA_LOG_ERR
("failedo destroy UROM service");

80 
	`DOCA_ERROR_PROPAGATE
(
»suÉ
, 
tmp_»suÉ
);

82  
»suÉ
;

83 
	}
}

85 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_¡¬t_urom_wÜk”
(

86 
doÿ_³
 *
³
, 
doÿ_urom_£rviû
 *
£rviû
,

87 
ušt64_t
 
wÜk”_id
, 
ušt32_t
 *
gid
, ušt64_ˆ
nb_sks
,

88 
doÿ_ıu_£t_t
 *
ıu£t
, **
’v
, 
size_t
 
’v_couÁ
, 
ušt64_t
 
¶ugšs
,

89 
doÿ_urom_wÜk”
 **
wÜk”
)

91 
doÿ_ùx_¡©es
 
¡©e
;

92 
doÿ_urom_wÜk”
 *
š¡
;

93 
doÿ_”rÜ_t
 
»suÉ
, 
tmp_»suÉ
;

95 
»suÉ
 = 
	`doÿ_urom_wÜk”_ü—‹
(&
š¡
);

96 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

97  
»suÉ
;

99 
»suÉ
 = 
	`doÿ_urom_wÜk”_£t_£rviû
(
š¡
, 
£rviû
);

100 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

101 
wÜk”_ş—nup
;

103 
»suÉ
 = 
	`doÿ_³_cÚÃù_ùx
(
³
, 
	`doÿ_urom_wÜk”_as_ùx
(
š¡
));

104 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

105 
wÜk”_ş—nup
;

107 
»suÉ
 = 
	`doÿ_urom_wÜk”_£t_id
(
š¡
, 
wÜk”_id
);

108 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

109 
wÜk”_ş—nup
;

111 ià(
gid
 !ğ
NULL
) {

112 
»suÉ
 = 
	`doÿ_urom_wÜk”_£t_gid
(
š¡
, *
gid
);

113 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

114 
wÜk”_ş—nup
;

117 ià(
’v
 !ğ
NULL
) {

118 
»suÉ
 = 
	`doÿ_urom_wÜk”_£t_’v
(
š¡
, 
’v
, 
’v_couÁ
);

119 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

120 
wÜk”_ş—nup
;

123 
»suÉ
 = 
	`doÿ_urom_wÜk”_£t_max_šæight_sks
(
š¡
, 
nb_sks
);

124 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

125 
wÜk”_ş—nup
;

127 
»suÉ
 = 
	`doÿ_urom_wÜk”_£t_¶ugšs
(
š¡
, 
¶ugšs
);

128 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

129 
wÜk”_ş—nup
;

131 ià(
ıu£t
 !ğ
NULL
) {

132 
»suÉ
 = 
	`doÿ_urom_wÜk”_£t_ıu£t
(
š¡
, *
ıu£t
);

133 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

134 
wÜk”_ş—nup
;

137 
»suÉ
 = 
	`doÿ_ùx_¡¬t
(
	`doÿ_urom_wÜk”_as_ùx
(
š¡
));

138 ià(
»suÉ
 !ğ
DOCA_ERROR_IN_PROGRESS
)

139 
wÜk”_ş—nup
;

141 
»suÉ
 = 
	`doÿ_ùx_g‘_¡©e
(
	`doÿ_urom_wÜk”_as_ùx
(
š¡
), &
¡©e
);

142 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

143 
wÜk”_¡İ
;

145 ià(
¡©e
 !ğ
DOCA_CTX_STATE_STARTING
) {

146 
»suÉ
 = 
DOCA_ERROR_BAD_STATE
;

147 
wÜk”_¡İ
;

150 *
wÜk”
 = 
š¡
;

151  
DOCA_SUCCESS
;

153 
wÜk”_¡İ
:

154 
tmp_»suÉ
 = 
	`doÿ_ùx_¡İ
(
	`doÿ_urom_wÜk”_as_ùx
(
š¡
));

155 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
 &&mp_»suÉ !ğ
DOCA_ERROR_IN_PROGRESS
) {

156 
	`DOCA_LOG_ERR
("failedo„equest stop UROM worker");

157 
	`DOCA_ERROR_PROPAGATE
(
»suÉ
, 
tmp_»suÉ
);

161 
	`doÿ_³_´og»ss
(
³
);

162 
	`doÿ_ùx_g‘_¡©e
(
	`doÿ_urom_wÜk”_as_ùx
(
š¡
), &
¡©e
);

163 } 
¡©e
 !ğ
DOCA_CTX_STATE_IDLE
);

165 
wÜk”_ş—nup
:

166 
tmp_»suÉ
 = 
	`doÿ_urom_wÜk”_de¡roy
(
š¡
);

167 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

168 
	`DOCA_LOG_ERR
("failedo destroy UROM worker");

169 
	`DOCA_ERROR_PROPAGATE
(
»suÉ
, 
tmp_»suÉ
);

172  
»suÉ
;

173 
	}
}

175 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_¡¬t_urom_domaš
(

176 
doÿ_³
 *
³
, 
doÿ_urom_domaš_oob_cŞl
 *
oob
,

177 
ušt64_t
 *
wÜk”_ids
, 
doÿ_urom_wÜk”
 **
wÜk”s
,

178 
size_t
 
nb_wÜk”s
, 
ucc_ş_doÿ_urom_domaš_bufãr_©Œs
 *
bufãrs
,

179 
size_t
 
nb_bufãrs
, 
doÿ_urom_domaš
 **
domaš
)

181 
doÿ_urom_domaš
 *
š¡
;

182 
doÿ_ùx_¡©es
 
¡©e
;

183 
doÿ_”rÜ_t
 
»suÉ
, 
tmp_»suÉ
;

184 
size_t
 
i
;

186 
»suÉ
 = 
	`doÿ_urom_domaš_ü—‹
(&
š¡
);

187 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

188 
	`DOCA_LOG_ERR
("failedo create domain");

189  
»suÉ
;

192 
»suÉ
 = 
	`doÿ_³_cÚÃù_ùx
(
³
, 
	`doÿ_urom_domaš_as_ùx
(
š¡
));

193 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

194 
domaš_de¡roy
;

196 
»suÉ
 = 
	`doÿ_urom_domaš_£t_oob
(
š¡
, 
oob
);

197 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

198 
domaš_de¡roy
;

200 
»suÉ
 = 
	`doÿ_urom_domaš_£t_wÜk”s
(
š¡
, 
wÜk”_ids
, 
wÜk”s
, 
nb_wÜk”s
);

201 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

202 
domaš_de¡roy
;

207 ià(
nb_wÜk”s
 !ğ0 && 
bufãrs
 !ğ
NULL
) {

208 
»suÉ
 = 
	`doÿ_urom_domaš_£t_bufãrs_couÁ
(
š¡
, 
nb_bufãrs
);

209 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

210 
domaš_de¡roy
;

212 
i
 = 0; i < 
nb_bufãrs
; i++) {

213 
»suÉ
 = 
	`doÿ_urom_domaš_add_bufãr
(
š¡
,

214 
bufãrs
[
i
].
bufãr
,

215 
bufãrs
[
i
].
buf_Ën
,

216 
bufãrs
[
i
].
memh
,

217 
bufãrs
[
i
].
memh_Ën
,

218 
bufãrs
[
i
].
mkey
,

219 
bufãrs
[
i
].
mkey_Ën
);

220 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

221 
domaš_de¡roy
;

225 
»suÉ
 = 
	`doÿ_ùx_¡¬t
(
	`doÿ_urom_domaš_as_ùx
(
š¡
));

226 ià(
»suÉ
 !ğ
DOCA_ERROR_IN_PROGRESS
)

227 
domaš_¡İ
;

229 
»suÉ
 = 
	`doÿ_ùx_g‘_¡©e
(
	`doÿ_urom_domaš_as_ùx
(
š¡
), &
¡©e
);

230 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

231 
domaš_¡İ
;

233 ià(
¡©e
 !ğ
DOCA_CTX_STATE_STARTING
) {

234 
»suÉ
 = 
DOCA_ERROR_BAD_STATE
;

235 
domaš_¡İ
;

238 *
domaš
 = 
š¡
;

239  
DOCA_SUCCESS
;

241 
domaš_¡İ
:

242 
tmp_»suÉ
 = 
	`doÿ_ùx_¡İ
(
	`doÿ_urom_domaš_as_ùx
(
š¡
));

243 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

244 
	`DOCA_LOG_ERR
("failedo stop UROM domain");

245 
	`DOCA_ERROR_PROPAGATE
(
»suÉ
, 
tmp_»suÉ
);

248 
domaš_de¡roy
:

249 
tmp_»suÉ
 = 
	`doÿ_urom_domaš_de¡roy
(
š¡
);

250 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

251 
	`DOCA_LOG_ERR
("failedo destroy UROM domain");

252 
	`DOCA_ERROR_PROPAGATE
(
»suÉ
, 
tmp_»suÉ
);

254  
»suÉ
;

255 
	}
}

258 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_İ’_doÿ_deviû_w™h_ibdev_Çme
(

259 cÚ¡ 
ušt8_t
 *
v®ue
, 
size_t
 
v®_size
,

260 
ucc_ş_doÿ_urom_sks_check
 
func
, 
doÿ_dev
 **
»tv®
)

262 
buf
[
DOCA_DEVINFO_IBDEV_NAME_SIZE
] = {};

263 
v®_cİy
[
DOCA_DEVINFO_IBDEV_NAME_SIZE
] = {};

264 
doÿ_devšfo
 **
dev_li¡
;

265 
ušt32_t
 
nb_devs
;

266 
»s
;

267 
size_t
 
i
;

270 *
»tv®
 = 
NULL
;

273 ià(
v®_size
 > 
DOCA_DEVINFO_IBDEV_NAME_SIZE
) {

274 
	`DOCA_LOG_ERR
("Value sizeoo†arge. failedo†ocate device");

275  
DOCA_ERROR_INVALID_VALUE
;

277 
	`memıy
(
v®_cİy
, 
v®ue
, 
v®_size
);

279 
»s
 = 
	`doÿ_devšfo_ü—‹_li¡
(&
dev_li¡
, &
nb_devs
);

280 ià(
»s
 !ğ
DOCA_SUCCESS
) {

281 
	`DOCA_LOG_ERR
("çedØlßd doÿ deviû li¡: %s", 
	`doÿ_”rÜ_g‘_desü
(
»s
));

282  
»s
;

286 
i
 = 0; i < 
nb_devs
; i++) {

287 
»s
 = 
	`doÿ_devšfo_g‘_ibdev_Çme
(
dev_li¡
[
i
], 
buf
, 
DOCA_DEVINFO_IBDEV_NAME_SIZE
);

288 ià(
»s
 =ğ
DOCA_SUCCESS
 && 
	`¡ºcmp
(
buf
, 
v®_cİy
, 
v®_size
) == 0) {

290 ià(
func
 !ğ
NULL
 && 
	`func
(
dev_li¡
[
i
]è!ğ
DOCA_SUCCESS
)

294 
»s
 = 
	`doÿ_dev_İ’
(
dev_li¡
[
i
], 
»tv®
);

295 ià(
»s
 =ğ
DOCA_SUCCESS
) {

296 
	`doÿ_devšfo_de¡roy_li¡
(
dev_li¡
);

297  
»s
;

302 
	`DOCA_LOG_WARN
("Matching device‚ot found");

303 
»s
 = 
DOCA_ERROR_NOT_FOUND
;

305 
	`doÿ_devšfo_de¡roy_li¡
(
dev_li¡
);

306  
»s
;

307 
	}
}

	@src/components/cl/doca_urom/cl_doca_urom_common.h

14 #iâdeà
_GNU_SOURCE


15 
	#_GNU_SOURCE


	)

18 #iâdeà
UCC_CL_DOCA_UROM_COMMON_H_


19 
	#UCC_CL_DOCA_UROM_COMMON_H_


	)

21 
	~<doÿ_dev.h
>

22 
	~<doÿ_urom.h
>

23 
	~<doÿ_³.h
>

24 
	~<doÿ_”rÜ.h
>

27 
	$doÿ_”rÜ_t
 (*
	tucc_ş_doÿ_urom_sks_check
)(
	tdoÿ_devšfo
 *);

32 
	succ_ş_doÿ_urom_domaš_bufãr_©Œs
 {

33 *
bufãr
;

34 
size_t
 
buf_Ën
;

35 *
memh
;

36 
size_t
 
memh_Ën
;

37 *
mkey
;

38 
size_t
 
mkey_Ën
;

50 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_İ’_doÿ_deviû_w™h_ibdev_Çme
(

51 cÚ¡ 
ušt8_t
 *
v®ue
,

52 
size_t
 
v®_size
,

53 
ucc_ş_doÿ_urom_sks_check
 
func
,

54 
doÿ_dev
 **
»tv®
);

65 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_¡¬t_urom_£rviû
(
doÿ_³
 *
³
,

66 
doÿ_dev
 *
dev
,

67 
ušt64_t
 
nb_wÜk”s
,

68 
doÿ_urom_£rviû
 **
£rviû
);

85 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_¡¬t_urom_wÜk”
(
doÿ_³
 *
³
,

86 
doÿ_urom_£rviû
 *
£rviû
,

87 
ušt64_t
 
wÜk”_id
,

88 
ušt32_t
 *
gid
,

89 
ušt64_t
 
nb_sks
,

90 
doÿ_ıu_£t_t
 *
ıu£t
,

91 **
’v
,

92 
size_t
 
’v_couÁ
,

93 
ušt64_t
 
¶ugšs
,

94 
doÿ_urom_wÜk”
 **
wÜk”
);

109 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_¡¬t_urom_domaš
(
doÿ_³
 *
³
,

110 
doÿ_urom_domaš_oob_cŞl
 *
oob
,

111 
ušt64_t
 *
wÜk”_ids
,

112 
doÿ_urom_wÜk”
 **
wÜk”s
,

113 
size_t
 
nb_wÜk”s
,

114 
ucc_ş_doÿ_urom_domaš_bufãr_©Œs
 *
bufãrs
,

115 
size_t
 
nb_bufãrs
,

116 
doÿ_urom_domaš
 **
domaš
);

	@src/components/cl/doca_urom/cl_doca_urom_context.c

7 
	~"ş_doÿ_urom.h
"

8 
	~"ş_doÿ_urom_cŞl.h
"

9 
	~"uts/ucc_m®loc.h
"

11 
doÿ_”rÜ_t
 
	$ucc_¡©us_to_doÿ_”rÜ
(
ucc_¡©us_t
 
¡©us
)

13 
doÿ_”rÜ_t
 
doÿ_”r
 = 
DOCA_ERROR_UNKNOWN
;

15 
¡©us
) {

16 
UCC_OK
:

17 
doÿ_”r
 = 
DOCA_SUCCESS
;

19 
UCC_INPROGRESS
:

20 
UCC_OPERATION_INITIALIZED
:

21 
doÿ_”r
 = 
DOCA_ERROR_IN_PROGRESS
;

23 
UCC_ERR_NOT_SUPPORTED
:

24 
UCC_ERR_NOT_IMPLEMENTED
:

25 
doÿ_”r
 = 
DOCA_ERROR_NOT_SUPPORTED
;

27 
UCC_ERR_INVALID_PARAM
:

28 
doÿ_”r
 = 
DOCA_ERROR_INVALID_VALUE
;

30 
UCC_ERR_NO_MEMORY
:

31 
doÿ_”r
 = 
DOCA_ERROR_NO_MEMORY
;

33 
UCC_ERR_NO_RESOURCE
:

34 
doÿ_”r
 = 
DOCA_ERROR_FULL
;

36 
UCC_ERR_NO_MESSAGE
:

37 
UCC_ERR_LAST
:

38 
doÿ_”r
 = 
DOCA_ERROR_UNKNOWN
;

40 
UCC_ERR_NOT_FOUND
:

41 
doÿ_”r
 = 
DOCA_ERROR_NOT_FOUND
;

43 
UCC_ERR_TIMED_OUT
:

44 
doÿ_”r
 = 
DOCA_ERROR_TIME_OUT
;

48  
doÿ_”r
;

49 
	}
}

54 
	$ucc_¡©us_t
 (*
·¿ms_oob_®lg©h”_‹¡
)(*
»q
);

55 
doÿ_”rÜ_t
 
	$oob_®lg©h”_‹¡_doÿf›d
(*
»q
)

57  
	`ucc_¡©us_to_doÿ_”rÜ
(
	`·¿ms_oob_®lg©h”_‹¡
(
»q
));

58 
	}
}

60 
	$ucc_¡©us_t
 (*
·¿ms_oob_®lg©h”_ä“
)(*
»q
);

61 
doÿ_”rÜ_t
 
	$oob_®lg©h”_ä“_doÿf›d
(*
»q
)

63  
	`ucc_¡©us_to_doÿ_”rÜ
(
	`·¿ms_oob_®lg©h”_ä“
(
»q
));

64 
	}
}

66 
	$ucc_¡©us_t
 (*
·¿ms_oob_®lg©h”
)(*, *, 
size_t
, *, **);

67 
doÿ_”rÜ_t
 
	$oob_®lg©h”_doÿf›d
(* 
s
, * 
r
, 
size_t
 
z
,

68 * 
i
, **
»q_p
)

70  
	`ucc_¡©us_to_doÿ_”rÜ
(
	`·¿ms_oob_®lg©h”
(
s
,
r
,
z
,
i
,
»q_p
));

71 
	}
}

73 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_doÿ_urom_cÚ‹xt_t
,

74 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

75 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

77 
ucc_ş_doÿ_urom_domaš_bufãr_©Œs
 
buf_©Œs
 = {0};

78 
doÿ_urom_domaš_oob_cŞl
 
oob_cŞl
 = {0};

79 
doÿ_”rÜ_t
 
tmp_»suÉ
 = 
DOCA_SUCCESS
;

80 
doÿ_d©a
 
cook›
 = {0};

81 
ucc_ş_doÿ_urom_»suÉ
 
»s
 = {0};

82 
doÿ_”rÜ_t
 
»suÉ
 = 
DOCA_SUCCESS
;

83 
size_t
 
Ëngth
 = 4096;

84 
uı_šdex
 = -1;

85 
num_’vs
 = 0;

86 **
’vs
 = 
NULL
;

87 
size_t
 
¶ugšs_couÁ
 = 0;

88 
doÿ_log_back’d
 *
sdk_log
 = 
NULL
;

89 cÚ¡ 
ucc_ş_doÿ_urom_cÚ‹xt_cÚfig_t
 *
ş_cÚfig
 =

90 
	`ucc_d”ived_of
(
cÚfig
, 
ucc_ş_doÿ_urom_cÚ‹xt_cÚfig_t
);

91 
ucc_ş_doÿ_urom_lib_t
 *
doÿ_urom_lib
 =

92 
	`ucc_d”ived_of
(
ş_cÚfig
->
su³r
.
ş_lib
, 
ucc_ş_doÿ_urom_lib_t
);

93 
ucc_cÚfig_Çmes_¬¿y_t
 *
s
 =

94 &
ş_cÚfig
->
su³r
.
ş_lib
->
s
.
¬¿y
;

95 
ucc_lib_·¿ms_t
 
lib_·¿ms
 = {

96 .
mask
 = 
UCC_LIB_PARAM_FIELD_THREAD_MODE
,

97 .
th»ad_mode
 = 
UCC_THREAD_SINGLE
,

99 cÚ¡ 
doÿ_urom_£rviû_¶ugš_šfo
 *
¶ugšs
;

100 
ucc__uı_cÚ‹xt_t
 *
_ùx
;

101 
doÿ_ùx_¡©es
 
¡©e
;

102 
expÜt_buf
 
ebuf
;

103 
ucc_¡©us_t
 
¡©us
;

104 
ucs_¡©us_t
 
ucs_¡©us
;

105 
ucc_¿nk_t
 
¿nk
;

106 
ušt64_t
 
¿nk_u64
;

107 
size_t
 
i
;

108 *
bufãr
;

109 
»t
;

110 *
¶ugš_Çme
;

111 *
deviû
;

113 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc_ş_cÚ‹xt_t
, &
ş_cÚfig
->
su³r
,

114 
·¿ms
->
cÚ‹xt
);

115 
	`memıy
(&
£lf
->
cfg
, 
ş_cÚfig
, (*cl_config));

117 ià(
s
->
couÁ
 =ğ1 && !
	`¡rcmp
Ñls->
Çmes
[0], "all")) {

118 
s
 = &
·¿ms
->
cÚ‹xt
->
®l_s
;

120 
£lf
->
su³r
.
_ùxs
 = 
	`ucc_m®loc
((
ucc__cÚ‹xt_t
*è* 
s
->
couÁ
,

122 ià(!
£lf
->
su³r
.
_ùxs
) {

123 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
,

125 (
ucc__cÚ‹xt_t
**è* 
s
->
couÁ
);

126  
UCC_ERR_NO_MEMORY
;

128 
£lf
->
su³r
.
n__ùxs
 = 0;

129 
i
 = 0; i < 
s
->
couÁ
; i++) {

130 
	`ucc_debug
("TL NAME[%zu]: %s", 
i
, 
s
->
Çmes
[i]);

131 ià(
	`¡rcmp
(
s
->
Çmes
[
i
], "ucp") == 0) {

132 
¡©us
 = 
	`ucc__cÚ‹xt_g‘
(
·¿ms
->
cÚ‹xt
, 
s
->
Çmes
[
i
],

133 &
£lf
->
su³r
.
_ùxs
[£lf->su³r.
n__ùxs
]);

134 ià(
UCC_OK
 !ğ
¡©us
) {

135 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "TL ucp‚ot‡vailable");

137 
uı_šdex
 = 
£lf
->
su³r
.
n__ùxs
;

138 
doÿ_urom_lib
->
_uı_šdex
 = 
uı_šdex
;

139 
£lf
->
su³r
.
n__ùxs
++;

142 ià(0 =ğ
£lf
->
su³r
.
n__ùxs
) {

143 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "no TL contexts‡re‡vailable");

144 
	`ucc_ä“
(
£lf
->
su³r
.
_ùxs
);

145 
£lf
->
su³r
.
_ùxs
 = 
NULL
;

146  
UCC_ERR_NOT_FOUND
;

149 
	`ucc_as£¹
(
uı_šdex
 != -1);

150 
_ùx
 = 
	`ucc_d”ived_of
(
£lf
->
su³r
.
_ùxs
[
uı_šdex
],

151 
ucc__uı_cÚ‹xt_t
);

153 
	`mem£t
(&
£lf
->
urom_ùx
, 0, (
ucc_ş_doÿ_urom_ùx_t
));

155 
	`ucc_as£¹
(
·¿ms
->·¿ms.
mask
 | 
UCC_CONTEXT_PARAM_FIELD_OOB
);

156 
£lf
->
urom_ùx
.
ùx_¿nk
 = 
·¿ms
->·¿ms.
oob
.
oob_•
;

157 
¿nk
 = 
£lf
->
urom_ùx
.
ùx_¿nk
;

159 ià(
£lf
->
cfg
.
¶ugš_’vs
.
couÁ
 > 0) {

160 
num_’vs
 = 
£lf
->
cfg
.
¶ugš_’vs
.
couÁ
;

161 
’vs
 = 
£lf
->
cfg
.
¶ugš_’vs
.
Çmes
;

164 
¶ugš_Çme
 = 
£lf
->
cfg
.plugin_name;

165 
deviû
 = 
£lf
->
cfg
.device;

167 
»suÉ
 = 
	`doÿ_log_back’d_ü—‹_w™h_fe_sdk
(
¡d”r
, &
sdk_log
);

168 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

169 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
,

171  
UCC_ERR_NO_RESOURCE
;

173 
»suÉ
 = 
	`doÿ_log_back’d_£t_sdk_Ëv–
(
sdk_log
, 
ş_cÚfig
->
doÿ_log_Ëv–
);

174 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

175 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo set backend sdk†evel");

176  
UCC_ERR_NO_RESOURCE
;

179 
»suÉ
 = 
	`ucc_ş_doÿ_urom_İ’_doÿ_deviû_w™h_ibdev_Çme
(

180 (
ušt8_t
 *)
deviû
, 
	`¡¾’
(device),

181 
NULL
, &
£lf
->
urom_ùx
.
dev
);

182 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

183 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "çedØİ’ deviû %s", 
deviû
);

184  
UCC_ERR_NO_RESOURCE
;

187 
»suÉ
 = 
	`doÿ_³_ü—‹
(&
£lf
->
urom_ùx
.
urom_³
);

188 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

189 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo create DOCA PE");

190 
dev_şo£
;

193 
»suÉ
 = 
	`ucc_ş_doÿ_urom_¡¬t_urom_£rviû
(

194 
£lf
->
urom_ùx
.
urom_³
, s–f->urom_ùx.
dev
, 2,

195 &
£lf
->
urom_ùx
.
urom_£rviû
);

196 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

197 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
,

199 
³_de¡roy
;

202 
»suÉ
 = 
	`doÿ_urom_£rviû_g‘_¶ugšs_li¡
(
£lf
->
urom_ùx
.
urom_£rviû
,

203 &
¶ugšs
, &
¶ugšs_couÁ
);

204 ià(
»suÉ
 !ğ
DOCA_SUCCESS
 || 
¶ugšs_couÁ
 == 0) {

205 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
,

207 
¶ugšs_couÁ
);

208 
£rviû_¡İ
;

211 
i
 = 0; i < 
¶ugšs_couÁ
; i++) {

212 ià(
	`¡rcmp
(
¶ugš_Çme
, 
¶ugšs
[
i
].plugin_name) == 0) {

213 
£lf
->
urom_ùx
.
ucc_šfo
 = &
¶ugšs
[
i
];

218 ià(
£lf
->
urom_ùx
.
ucc_šfo
 =ğ
NULL
) {

219 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo match UCC…lugin");

220 
»suÉ
 = 
DOCA_ERROR_INVALID_VALUE
;

221 
£rviû_¡İ
;

225 
»suÉ
 = 
	`ucc_ş_doÿ_urom_§ve_¶ugš_id
(
£lf
->
urom_ùx
.
ucc_šfo
->
id
,

226 
£lf
->
urom_ùx
.
ucc_šfo
->
v”siÚ
);

227 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

228 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo init UCC worker…lugin");

229 
£rviû_¡İ
;

232 
£lf
->
urom_ùx
.
urom_wÜk”_addr
 = 
	`ucc_ÿÎoc
(1,

233 
UCC_CL_DOCA_UROM_ADDR_MAX_LEN
,

235 ià(!
£lf
->
urom_ùx
.
urom_wÜk”_addr
) {

236 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo‡llocate %d bytes",

237 
UCC_CL_DOCA_UROM_ADDR_MAX_LEN
);

238  
UCC_ERR_NO_MEMORY
;

242 
»suÉ
 = 
	`ucc_ş_doÿ_urom_¡¬t_urom_wÜk”
(
£lf
->
urom_ùx
.
urom_³
,

243 
£lf
->
urom_ùx
.
urom_£rviû
, 
¿nk
, 
NULL
,

244 16, 
NULL
, 
’vs
, 
num_’vs
,

245 
£lf
->
urom_ùx
.
ucc_šfo
->
id
,

246 &
£lf
->
urom_ùx
.
urom_wÜk”
);

247 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

248 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo start urom worker");

252 
	`doÿ_³_´og»ss
(
£lf
->
urom_ùx
.
urom_³
);

253 
»suÉ
 = 
	`doÿ_ùx_g‘_¡©e
(

254 
	`doÿ_urom_wÜk”_as_ùx
(
£lf
->
urom_ùx
.
urom_wÜk”
),

255 &
¡©e
);

256 } 
¡©e
 =ğ
DOCA_CTX_STATE_STARTING
 && 
»suÉ
 =ğ
DOCA_SUCCESS
);

257 ià(
¡©e
 !ğ
DOCA_CTX_STATE_RUNNING
 || 
»suÉ
 !ğ
DOCA_SUCCESS
) {

258 
wÜk”_ş—nup
;

262 
bufãr
 = 
	`ucc_ÿÎoc
(1, 
Ëngth
, "doca_urom domain buffer");

263 ià(
bufãr
 =ğ
NULL
) {

264 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
,

266 
»suÉ
 = 
DOCA_ERROR_NO_MEMORY
;

267 
wÜk”_ş—nup
;

270 
·¿ms_oob_®lg©h”
 = 
·¿ms
->·¿ms.
oob
.
®lg©h”
;

271 
oob_cŞl
.
®lg©h”
 = 
oob_®lg©h”_doÿf›d
;

272 
·¿ms_oob_®lg©h”_‹¡
 = 
·¿ms
->·¿ms.
oob
.
»q_‹¡
;

273 
oob_cŞl
.
»q_‹¡
 = 
oob_®lg©h”_‹¡_doÿf›d
;

274 
·¿ms_oob_®lg©h”_ä“
 = 
·¿ms
->·¿ms.
oob
.
»q_ä“
;

275 
oob_cŞl
.
»q_ä“
 = 
oob_®lg©h”_ä“_doÿf›d
;

276 
oob_cŞl
.
cŞl_šfo
 = 
·¿ms
->·¿ms.
oob
.coll_info;

277 
oob_cŞl
.
n_oob_šdexes
 = 
·¿ms
->·¿ms.
oob
.
n_oob_•s
;

278 
oob_cŞl
.
oob_šdex
 = 
¿nk
;

280 
ucs_¡©us
 = 
	`uı_wÜk”_g‘_add»ss
(
_ùx
->
wÜk”
.
uı_wÜk”
,

281 &
_ùx
->
wÜk”
.
wÜk”_add»ss
,

282 &
_ùx
->
wÜk”
.
uı_add¾’
);

283 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

284 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo get ucp worker‡ddress");

285 
wÜk”_ş—nup
;

288 
»suÉ
 = (
doÿ_”rÜ_t
è
	`ucc_ş_doÿ_urom_bufãr_expÜt_ucc
(

289 
_ùx
->
wÜk”
.
uı_cÚ‹xt
, 
bufãr
,

290 
Ëngth
, &
ebuf
);

291 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

292 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedoƒxport buffer");

293 
wÜk”_ş—nup
;

299 
buf_©Œs
.
bufãr
 = buffer;

300 
buf_©Œs
.
buf_Ën
 = 
Ëngth
;

301 
buf_©Œs
.
memh
 = 
ebuf
.
·cked_memh
;

302 
buf_©Œs
.
memh_Ën
 = 
ebuf
.
·cked_memh_Ën
;

303 
buf_©Œs
.
mkey
 = 
ebuf
.
·cked_key
;

304 
buf_©Œs
.
mkey_Ën
 = 
ebuf
.
·cked_key_Ën
;

307 
¿nk_u64
 = (
ušt64_t
)
¿nk
;

308 
»suÉ
 = 
	`ucc_ş_doÿ_urom_¡¬t_urom_domaš
(

309 
£lf
->
urom_ùx
.
urom_³
,

310 &
oob_cŞl
,

311 &
¿nk_u64
, &
£lf
->
urom_ùx
.
urom_wÜk”
,

312 1, &
buf_©Œs
, 1,

313 &
£lf
->
urom_ùx
.
urom_domaš
);

314 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

315 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo start domain");

316 
wÜk”_unm­
;

321 
	`doÿ_³_´og»ss
(
£lf
->
urom_ùx
.
urom_³
);

322 
»suÉ
 = 
	`doÿ_ùx_g‘_¡©e
(

323 
	`doÿ_urom_domaš_as_ùx
(

324 
£lf
->
urom_ùx
.
urom_domaš
),

325 &
¡©e
);

326 } 
¡©e
 =ğ
DOCA_CTX_STATE_STARTING
 && 
»suÉ
 =ğ
DOCA_SUCCESS
);

328 ià(
¡©e
 !ğ
DOCA_CTX_STATE_RUNNING
 || 
»suÉ
 !ğ
DOCA_SUCCESS
) {

329 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo start domain");

330 
»suÉ
 = 
DOCA_ERROR_BAD_STATE
;

331 
wÜk”_unm­
;

335 
cook›
.
±r
 = &
»s
;

336 
»suÉ
 = 
	`ucc_ş_doÿ_urom_sk_lib_ü—‹
(

337 
£lf
->
urom_ùx
.
urom_wÜk”
,

338 
cook›
, 
¿nk
, &
lib_·¿ms
,

339 
ucc_ş_doÿ_urom_lib_ü—‹_fšished
);

340 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

341 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo create†ib creationask");

342 
domaš_¡İ
;

345 
»t
 = 
	`doÿ_³_´og»ss
(
£lf
->
urom_ùx
.
urom_³
);

346 } 
»t
 =ğ0 && 
»s
.
»suÉ
 =ğ
DOCA_SUCCESS
);

348 ià(
»s
.
»suÉ
 !ğ
DOCA_SUCCESS
) {

349 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo finish†ib createask");

350 
»suÉ
 = 
»s
.result;

351 
domaš_¡İ
;

353 
	`ş_debug
(
ş_cÚfig
->
su³r
.
ş_lib
, "UCC†ib create is done");

355 
	`ş_debug
(
ş_cÚfig
->
su³r
.
ş_lib
, "Creating…d channel");

356 
»suÉ
 = 
	`ucc_ş_doÿ_urom_sk_pd_chªÃl
(
£lf
->
urom_ùx
.
urom_wÜk”
,

357 
cook›
,

358 
¿nk
,

359 
_ùx
->
wÜk”
.
wÜk”_add»ss
,

360 
_ùx
->
wÜk”
.
uı_add¾’
,

361 
ucc_ş_doÿ_urom_pss_dc_fšished
);

362 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

363 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo create data channelask");

364 
lib_de¡roy
;

368 
»t
 = 
	`doÿ_³_´og»ss
(
£lf
->
urom_ùx
.
urom_³
);

369 } 
»t
 =ğ0 && 
»s
.
»suÉ
 =ğ
DOCA_SUCCESS
);

371 ià(
»s
.
»suÉ
 !ğ
DOCA_SUCCESS
) {

372 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "passive data channelask failed");

373 
»suÉ
 = 
»s
.result;

374 
lib_de¡roy
;

376 
	`ş_debug
(
ş_cÚfig
->
su³r
.
ş_lib
, "passive data channel is done");

378 
	`ş_debug
(
ş_cÚfig
->
su³r
.
ş_lib
, "creatingask ctx");

379 
»suÉ
 = 
	`ucc_ş_doÿ_urom_sk_ùx_ü—‹
(
£lf
->
urom_ùx
.
urom_wÜk”
,

380 
cook›
, 
¿nk
, 0, 
NULL
, 1,

381 
·¿ms
->·¿ms.
oob
.
n_oob_•s
, 0x0,

382 
Ëngth
,

383 
ucc_ş_doÿ_urom_ùx_ü—‹_fšished
);

384 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

385 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo create UCC contextask");

386 
lib_de¡roy
;

390 
»t
 = 
	`doÿ_³_´og»ss
(
£lf
->
urom_ùx
.
urom_³
);

391 } 
»t
 =ğ0 && 
»s
.
»suÉ
 =ğ
DOCA_SUCCESS
);

393 ià(
»s
.
»suÉ
 !ğ
DOCA_SUCCESS
 ||„es.
cÚ‹xt_ü—‹
.
cÚ‹xt
 =ğ
NULL
) {

394 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "UCC context createask failed");

395 
»suÉ
 = 
»s
.result;

396 
lib_de¡roy
;

398 
	`ş_debug
(
ş_cÚfig
->
su³r
.
ş_lib
,

400 
»s
.
cÚ‹xt_ü—‹
.
cÚ‹xt
);

401 
£lf
->
urom_ùx
.
urom_ucc_cÚ‹xt
 = 
»s
.
cÚ‹xt_ü—‹
.
cÚ‹xt
;

403 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
£lf
->
sched_mp
, 0,

404 (
ucc_ş_doÿ_urom_scheduË_t
),

405 0, 
UCC_CACHE_LINE_SIZE
, 2, 
UINT_MAX
,

406 &
ucc_cŞl_sk_mpoŞ_İs
, 
·¿ms
->
th»ad_mode
,

408 ià(
UCC_OK
 !ğ
¡©us
) {

409 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
,

411 
lib_de¡roy
;

414 
	`ş_debug
(
ş_cÚfig
->
su³r
.
ş_lib
, "š™Ÿlized cÈcÚ‹xt: %p", 
£lf
);

415  
UCC_OK
;

417 
lib_de¡roy
:

418 
»suÉ
 = 
	`ucc_ş_doÿ_urom_sk_lib_de¡roy
(
£lf
->
urom_ùx
.
urom_wÜk”
,

419 
cook›
, 
¿nk
, 
ucc_ş_doÿ_urom_lib_de¡roy_fšished
);

420 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

421 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

426 
»t
 = 
	`doÿ_³_´og»ss
(
£lf
->
urom_ùx
.
urom_³
);

427 } 
»t
 =ğ0 && 
»s
.
»suÉ
 =ğ
DOCA_SUCCESS
);

429 ià(
»s
.
»suÉ
 !ğ
DOCA_SUCCESS
) {

430 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "UCC†ib destroy failed");

431 
»suÉ
 = 
»s
.result;

434 
domaš_¡İ
:

435 
»suÉ
 = 
	`doÿ_ùx_¡İ
(

436 
	`doÿ_urom_domaš_as_ùx
(
£lf
->
urom_ùx
.
urom_domaš
));

437 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

438 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo stop UROM domain");

441 
»suÉ
 = 
	`doÿ_urom_domaš_de¡roy
(
£lf
->
urom_ùx
.
urom_domaš
);

442 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

443 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo destroy UROM domain");

446 
wÜk”_unm­
:

447 
ucs_¡©us
 = 
	`uı_mem_unm­
(
_ùx
->
wÜk”
.
uı_cÚ‹xt
, 
ebuf
.
memh
);

448 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

449 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo unmap memh");

451 
	`ä“
(
bufãr
);

453 
wÜk”_ş—nup
:

454 
tmp_»suÉ
 = 
	`doÿ_urom_wÜk”_de¡roy
(
£lf
->
urom_ùx
.
urom_wÜk”
);

455 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

456 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo destroy UROM worker");

459 
£rviû_¡İ
:

460 
tmp_»suÉ
 = 
	`doÿ_ùx_¡İ
(

461 
	`doÿ_urom_£rviû_as_ùx
(
£lf
->
urom_ùx
.
urom_£rviû
));

462 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

463 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo stop UROM service");

465 
tmp_»suÉ
 = 
	`doÿ_urom_£rviû_de¡roy
(
£lf
->
urom_ùx
.
urom_£rviû
);

466 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

467 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo destroy UROM service");

470 
³_de¡roy
:

471 
tmp_»suÉ
 = 
	`doÿ_³_de¡roy
(
£lf
->
urom_ùx
.
urom_³
);

472 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

473 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo destroy PE");

476 
dev_şo£
:

477 
tmp_»suÉ
 = 
	`doÿ_dev_şo£
(
£lf
->
urom_ùx
.
dev
);

478 ià(
tmp_»suÉ
 !ğ
DOCA_SUCCESS
) {

479 
	`ş_”rÜ
(
ş_cÚfig
->
su³r
.
ş_lib
, "failedo close device");

482  
UCC_ERR_NO_MESSAGE
;

483 
	}
}

485 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_doÿ_urom_cÚ‹xt_t
)

487 
ucc_ş_doÿ_urom_»suÉ
 
»s
 = {0};

488 
doÿ_d©a
 
cook›
 = {0};

489 
doÿ_”rÜ_t
 
»suÉ
 = 
DOCA_SUCCESS
;

490 
ucc_¿nk_t
 
¿nk
;

491 
i
, 
»t
;

493 
¿nk
 = 
£lf
->
urom_ùx
.
ùx_¿nk
;

494 
cook›
.
±r
 = &
»s
;

496 
»suÉ
 = 
	`ucc_ş_doÿ_urom_sk_lib_de¡roy
(
£lf
->
urom_ùx
.
urom_wÜk”
,

497 
cook›
, 
¿nk
, 
ucc_ş_doÿ_urom_lib_de¡roy_fšished
);

498 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

499 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

504 
»t
 = 
	`doÿ_³_´og»ss
(
£lf
->
urom_ùx
.
urom_³
);

505 } 
»t
 =ğ0 && 
»s
.
»suÉ
 =ğ
DOCA_SUCCESS
);

507 ià(
»s
.
»suÉ
 !ğ
DOCA_SUCCESS
) {

508 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "UCC†ib destroy failed");

509 
»suÉ
 = 
»s
.result;

512 
»suÉ
 = 
	`doÿ_ùx_¡İ
(

513 
	`doÿ_urom_domaš_as_ùx
(
£lf
->
urom_ùx
.
urom_domaš
));

514 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

515 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo stop UROM domain");

518 
»suÉ
 = 
	`doÿ_urom_domaš_de¡roy
(
£lf
->
urom_ùx
.
urom_domaš
);

519 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

520 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo destroy UROM domain");

523 
»suÉ
 = 
	`doÿ_ùx_¡İ
(

524 
	`doÿ_urom_£rviû_as_ùx
(
£lf
->
urom_ùx
.
urom_£rviû
));

525 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

526 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo stop UROM service");

528 
»suÉ
 = 
	`doÿ_urom_£rviû_de¡roy
(
£lf
->
urom_ùx
.
urom_£rviû
);

529 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

530 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo destroy UROM service");

533 
»suÉ
 = 
	`doÿ_³_de¡roy
(
£lf
->
urom_ùx
.
urom_³
);

534 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

535 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo destroy PE");

538 
»suÉ
 = 
	`doÿ_dev_şo£
(
£lf
->
urom_ùx
.
dev
);

539 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

540 
	`ş_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo close device");

543 
	`ş_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizing cl context: %p", self);

544 
i
 = 0; i < 
£lf
->
su³r
.
n__ùxs
; i++) {

545 
	`ucc__cÚ‹xt_put
(
£lf
->
su³r
.
_ùxs
[
i
]);

547 
	`ucc_ä“
(
£lf
->
su³r
.
_ùxs
);

548 
	}
}

550 
UCC_CLASS_DEFINE
(
ucc_ş_doÿ_urom_cÚ‹xt_t
, 
ucc_ş_cÚ‹xt_t
);

552 
ucc_¡©us_t


553 
	$ucc_ş_doÿ_urom_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

554 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

556 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

557  
UCC_OK
;

558 
	}
}

560 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

561 
ty³
, *
memh
, *
_h
)

563  
UCC_ERR_NOT_SUPPORTED
;

564 
	}
}

566 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

567 
ty³
, *
_h
)

569  
UCC_ERR_NOT_SUPPORTED
;

570 
	}
}

572 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

573 
ty³
, *
memh
, **
·cked_bufãr
)

575  
UCC_ERR_NOT_SUPPORTED
;

576 
	}
}

	@src/components/cl/doca_urom/cl_doca_urom_lib.c

7 
	~"ş_doÿ_urom.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"compÚ’ts//ucc_.h
"

10 
	~"cÜe/ucc_glob®_İts.h
"

11 
	~"uts/ucc_m©h.h
"

13 
	~<doÿ_log.h
>

16 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_doÿ_urom_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

17 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

19 cÚ¡ 
ucc_ş_doÿ_urom_lib_cÚfig_t
 *
ş_cÚfig
 =

20 
	`ucc_d”ived_of
(
cÚfig
, 
ucc_ş_doÿ_urom_lib_cÚfig_t
);

22 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc_ş_lib_t
, &
ucc_ş_doÿ_urom
.
su³r
,

23 &
ş_cÚfig
->
su³r
);

24 
	`memıy
(&
£lf
->
cfg
, 
ş_cÚfig
, (*cl_config));

26 
	`ş_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

28  
UCC_OK
;

29 
	}
}

31 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_doÿ_urom_lib_t
)

33 
	`ş_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

34 
	}
}

36 
UCC_CLASS_DEFINE
(
ucc_ş_doÿ_urom_lib_t
, 
ucc_ş_lib_t
);

37 
šlše
 
ucc_¡©us_t
 
	$check__lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

38 
ucc__içû_t
 *
_içû
,

39 
ucc_ş_lib_©Œ_t
 *
©Œ
)

41 
ucc__lib_©Œ_t
 
_©Œ
;

42 
ucc_¡©us_t
 
¡©us
;

44 
	`mem£t
(&
_©Œ
, 0, (tl_attr));

45 
¡©us
 = 
_içû
->
lib
.
	`g‘_©Œ
(
NULL
, &
_©Œ
.
su³r
);

46 ià(
UCC_OK
 !ğ
¡©us
) {

47 
	`ş_”rÜ
(
lib
, "failedo queryl %s†ib‡ttributes",

48 
_içû
->
su³r
.
Çme
);

49  
¡©us
;

52 
©Œ
->
su³r
.©Œ.
th»ad_mode
 =

53 
	`ucc_mš
(
©Œ
->
su³r
.©Œ.
th»ad_mode
, 
_©Œ
.super.attr.thread_mode);

54 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 |ğ
_©Œ
.super.attr.coll_types;

55 
©Œ
->
su³r
.
æags
 |ğ
_©Œ
.super.flags;

57  
UCC_OK
;

58 
	}
}

60 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

61 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
)

63 
ucc_ş_doÿ_urom_lib_t
 *
ş_lib
 = 
	`ucc_d”ived_of
(
lib
, ucc_cl_doca_urom_lib_t);

64 
ucc_ş_lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_cl_lib_attr_t);

65 
ucc_¡©us_t
 
¡©us
;

67 
©Œ
->
s
 = &
ş_lib
->
su³r
.s.
¬¿y
;

69 ià(
ş_lib
->
su³r
.
s
.
»que¡ed
) {

70 
¡©us
 = 
	`ucc_cÚfig_Çmes_¬¿y_dup
(&
ş_lib
->
su³r
.
s_fÜûd
,

71 &
ş_lib
->
su³r
.
s
.
¬¿y
);

72 ià(
UCC_OK
 !ğ
¡©us
) {

73  
¡©us
;

77 
©Œ
->
s_fÜûd
 = &
ş_lib
->
su³r
.tls_forced;

78 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

79 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 
UCC_COLL_TYPE_ALLREDUCE
;

80 
©Œ
->
su³r
.
æags
 = 0;

82 
	`ucc_as£¹
(
s
->
¬¿y
.
couÁ
 >= 1);

84  
UCC_OK
;

85 
	}
}

87 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

89 
´İ
->
deçuÉ_‹am_size
 = 2;

90 
´İ
->
mš_‹am_size
 = 2;

91 
´İ
->
max_‹am_size
 = 
UCC_RANK_MAX
;

93  
UCC_OK
;

94 
	}
}

	@src/components/cl/doca_urom/cl_doca_urom_team.c

7 
	~"ş_doÿ_urom.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"cÜe/ucc_‹am.h
"

11 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_doÿ_urom_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
ş_cÚ‹xt
,

12 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

14 
doÿ_d©a
 
cook›
 = {0};

15 
doÿ_”rÜ_t
 
»suÉ
 = 
DOCA_SUCCESS
;

16 
ucc_ş_doÿ_urom_cÚ‹xt_t
 *
ùx
 =

17 
	`ucc_d”ived_of
(
ş_cÚ‹xt
, 
ucc_ş_doÿ_urom_cÚ‹xt_t
);

18 
ucc_¡©us_t
 
¡©us
;

20 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc_ş_‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

22 
£lf
->
‹ams
 = (
ucc_‹am_h
 **è
	`ucc_m®loc
(

23 (
ucc_‹am_h
 *è* 
UCC_CL_DOCA_UROM_MAX_TEAMS
);

25 ià(!
£lf
->
‹ams
) {

26 
	`ş_”rÜ
(
ş_cÚ‹xt
->
lib
,

28 (
ucc_‹am_h
 *è* 
UCC_CL_DOCA_UROM_MAX_TEAMS
);

29 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

30  
¡©us
;

33 
£lf
->
n_‹ams
 = 0;

34 
£lf
->
scÜe_m­
 = 
NULL
;

36 
cook›
.
±r
 = &
£lf
->
»s
;

39 
»suÉ
 = 
	`ucc_ş_doÿ_urom_sk_‹am_ü—‹
(

40 
ùx
->
urom_ùx
.
urom_wÜk”
,

41 
cook›
,

42 
ùx
->
urom_ùx
.
ùx_¿nk
,

45 
·¿ms
->·¿ms.
oob
.
n_oob_•s
 ,

46 
ùx
->
urom_ùx
.
urom_ucc_cÚ‹xt
,

47 
ucc_ş_doÿ_urom_‹am_ü—‹_fšished
);

49 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

50 
	`ş_”rÜ
(
ş_cÚ‹xt
->
lib
, "failedo create UCCeamask");

51  
UCC_ERR_NO_RESOURCE
;

54 
£lf
->
»s
.
»suÉ
 = 
DOCA_ERROR_IN_PROGRESS
;

56 
	`ş_debug
(
ş_cÚ‹xt
->
lib
, "po¡ed cÈ‹am: %p", 
£lf
);

57  
UCC_OK
;

58 
	}
}

60 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_doÿ_urom_‹am_t
)

62 
	`ş_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizing cleam: %p", self);

63 
	}
}

65 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc_ş_doÿ_urom_‹am_t
, 
ucc_ba£_‹am_t
);

66 
UCC_CLASS_DEFINE
(
ucc_ş_doÿ_urom_‹am_t
, 
ucc_ş_‹am_t
);

68 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
ş_‹am
)

70  
UCC_OK
;

71 
	}
}

73 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
ş_‹am
)

75 
ucc_ş_doÿ_urom_‹am_t
 *
‹am
 =

76 
	`ucc_d”ived_of
(
ş_‹am
, 
ucc_ş_doÿ_urom_‹am_t
);

77 
ucc_ş_doÿ_urom_cÚ‹xt_t
 *
ùx
 =

78 
	`UCC_CL_DOCA_UROM_TEAM_CTX
(
‹am
);

79 
ucc_memÜy_ty³_t
 
mem_ty³s
[2] =

80 {
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
};

81 
ucc_ş_doÿ_urom_»suÉ
 *
»s
 = &
‹am
->res;

82 
ucc_ş_doÿ_urom_‹am_ü—‹_»suÉ
 *
‹am_ü—‹
 =

83 &
»s
->
‹am_ü—‹
;

84 
ucc_cŞl_scÜe_t
 *
scÜe
 = 
NULL
;

85 
mt_n
 = 2;

86 
ucc_¡©us_t
 
ucc_¡©us
;

87 
»t
;

89 
»t
 = 
	`doÿ_³_´og»ss
(
ùx
->
urom_ùx
.
urom_³
);

91 ià(
»t
 =ğ0 && 
»s
->
»suÉ
 =ğ
DOCA_ERROR_IN_PROGRESS
) {

92  
UCC_INPROGRESS
;

95 ià(
»s
->
»suÉ
 !ğ
DOCA_SUCCESS
) {

96 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

97 "UCC—m c»©sk faed: DOCA stu %d", 
»s
->
»suÉ
);

98  
UCC_ERR_NO_MESSAGE
;

101 
‹am
->
‹ams
[‹am->
n_‹ams
] = 
‹am_ü—‹
->team;

102 ++
‹am
->
n_‹ams
;

103 
ucc_¡©us
 = 
	`ucc_cŞl_scÜe_bud_deçuÉ
(

104 
ş_‹am
, 
UCC_CL_DOCA_UROM_DEFAULT_SCORE
,

105 
ucc_ş_doÿ_urom_cŞl_š™
,

106 
UCC_COLL_TYPE_ALLREDUCE
,

107 
mem_ty³s
, 
mt_n
, &
scÜe
);

108 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

109  
ucc_¡©us
;

112 
ucc_¡©us
 = 
	`ucc_cŞl_scÜe_bud_m­
(
scÜe
, &
‹am
->
scÜe_m­
);

113 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

114 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo build score map");

116 
‹am
->
scÜe
 = score;

117 
	`ucc_cŞl_scÜe_£t
(
‹am
->
scÜe
, 
UCC_CL_DOCA_UROM_DEFAULT_SCORE
);

119  
UCC_OK
;

120 
	}
}

122 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
ş_‹am
,

123 
ucc_cŞl_scÜe_t
 **
scÜe
)

125 
ucc_ş_doÿ_urom_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
ş_‹am
,

126 
ucc_ş_doÿ_urom_‹am_t
);

127 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_TEAM_CTX
(
‹am
);

128 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

129 
ucc_¡©us_t
 
¡©us
;

131 
¡©us
 = 
	`ucc_cŞl_scÜe_dup
(
‹am
->
scÜe
, score);

132 ià(
UCC_OK
 !ğ
¡©us
) {

133  
¡©us
;

136 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

137 
‹am_šfo
.
®g_â
 = 
NULL
;

138 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_CL_DOCA_UROM_DEFAULT_SCORE
;

139 
‹am_šfo
.
š™
 = 
NULL
;

140 
‹am_šfo
.
num_mem_ty³s
 = 0;

141 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = 
NULL
;

142 
‹am_šfo
.
suµÜ‹d_cŞls
 = 
UCC_COLL_TYPE_ALLREDUCE
;

143 
‹am_šfo
.
size
 = 
	`UCC_CL_TEAM_SIZE
(
‹am
);

145 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

146 &
‹am
->
su³r
.su³r, *
scÜe
);

149 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

150 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

151 
”r
;

155  
UCC_OK
;

157 
”r
:

158 
	`ucc_cŞl_scÜe_ä“
(*
scÜe
);

159 *
scÜe
 = 
NULL
;

160  
¡©us
;

161 
	}
}

	@src/components/cl/doca_urom/cl_doca_urom_worker_ucc.c

14 
	~<¡dšt.h
>

15 
	~<¡dlib.h
>

17 
	~<doÿ_buf.h
>

18 
	~<doÿ_³.h
>

20 
	~"ş_doÿ_urom_wÜk”_ucc.h
"

22 
DOCA_LOG_REGISTER
(
UCC
::
DOCA_CL
 : 
WORKER_UCC
);

24 
ušt64_t
 
	gucc_id
;

26 
ušt64_t
 
	gucc_v”siÚ
 = 0x01;

29 
	succ_ş_doÿ_urom_sk_d©a
 {

30 
doÿ_d©a
 
	mcook›
;

32 
ucc_ş_doÿ_urom_lib_ü—‹_fšished_cb
 
	mlib_ü—‹
;

33 
ucc_ş_doÿ_urom_lib_de¡roy_fšished_cb
 
	mlib_de¡roy
;

34 
ucc_ş_doÿ_urom_ùx_ü—‹_fšished_cb
 
	mùx_ü—‹
;

35 
ucc_ş_doÿ_urom_ùx_de¡roy_fšished_cb
 
	mùx_de¡roy
;

36 
ucc_ş_doÿ_urom_‹am_ü—‹_fšished_cb
 
	m‹am_ü—‹
;

37 
ucc_ş_doÿ_urom_cŞËùive_fšished_cb
 
	mcŞËùive
;

38 
ucc_ş_doÿ_urom_pd_chªÃl_fšished_cb
 
	mpd_chªÃl
;

49 
doÿ_”rÜ_t
 
	$nÙif_uÅack
(*
·cked_nÙif
,

50 
urom_wÜk”_nÙify_ucc
 **
ucc_nÙif
)

52 *
ucc_nÙif
 = 
·cked_nÙif
;

53  
DOCA_SUCCESS
;

54 
	}
}

62 
	$com¶‘iÚ
(
doÿ_urom_wÜk”_cmd_sk
 *
sk
,

63 
urom_wÜk”_ucc_nÙify_ty³
 
ty³
)

65 
urom_wÜk”_nÙify_ucc
 
nÙify_”rÜ
 = {0};

66 
urom_wÜk”_nÙify_ucc
 *
ucc_nÙify
 = &
nÙify_”rÜ
;

67 
ucc_ş_doÿ_urom_sk_d©a
 *
sk_d©a
;

68 
doÿ_buf
 *
»¥Ú£
;

69 
doÿ_”rÜ_t
 
»suÉ
;

70 
size_t
 
d©a_Ën
;

72 
nÙify_”rÜ
.
nÙify_ty³
 = 
ty³
;

74 
sk_d©a
 = (
ucc_ş_doÿ_urom_sk_d©a
 *)

75 
	`doÿ_urom_wÜk”_cmd_sk_g‘_u£r_d©a
(
sk
);

76 ià(
sk_d©a
 =ğ
NULL
) {

77 
	`DOCA_LOG_ERR
("Failedo getask data buffer");

78 
sk_»Ëa£
;

81 
»¥Ú£
 = 
	`doÿ_urom_wÜk”_cmd_sk_g‘_»¥Ú£
(
sk
);

82 ià(
»¥Ú£
 =ğ
NULL
) {

83 
	`DOCA_LOG_ERR
("Failedo getask„esponse buffer");

84 
»suÉ
 = 
DOCA_ERROR_INVALID_VALUE
;

85 
”rÜ_ex™
;

88 
»suÉ
 = 
	`doÿ_buf_g‘_d©a
(
»¥Ú£
, (**)&
ucc_nÙify
);

89 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

90 
”rÜ_ex™
;

92 
»suÉ
 = 
	`nÙif_uÅack
((*)
ucc_nÙify
, &ucc_notify);

93 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

94 
”rÜ_ex™
;

96 
»suÉ
 = 
	`doÿ_buf_g‘_d©a_Ën
(
»¥Ú£
, &
d©a_Ën
);

97 ià(
»suÉ
 !ğ
DOCA_SUCCESS
) {

98 
	`DOCA_LOG_ERR
("Failedo get„esponse data†ength");

99 
”rÜ_ex™
;

102 
»suÉ
 = 
	`doÿ_sk_g‘_¡©us
(
	`doÿ_urom_wÜk”_cmd_sk_as_sk
(
sk
));

103 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

104 
”rÜ_ex™
;

106 ià(
d©a_Ën
 !ğ(*
ucc_nÙify
)) {

107 
	`DOCA_LOG_ERR
("Task„esponse data†ength is different"

109 
»suÉ
 = 
DOCA_ERROR_INVALID_VALUE
;

110 
”rÜ_ex™
;

113 
”rÜ_ex™
:

114 
ucc_nÙify
->
nÙify_ty³
) {

115 
UROM_WORKER_NOTIFY_UCC_LIB_CREATE_COMPLETE
:

116 (
sk_d©a
->
lib_ü—‹
)(
»suÉ
,ask_d©a->
cook›
,

117 
ucc_nÙify
->
dpu_wÜk”_id
);

119 
UROM_WORKER_NOTIFY_UCC_LIB_DESTROY_COMPLETE
:

120 (
sk_d©a
->
lib_de¡roy
)(
»suÉ
,ask_d©a->
cook›
,

121 
ucc_nÙify
->
dpu_wÜk”_id
);

123 
UROM_WORKER_NOTIFY_UCC_CONTEXT_CREATE_COMPLETE
:

124 (
sk_d©a
->
ùx_ü—‹
)(
»suÉ
,

125 
sk_d©a
->
cook›
,

126 
ucc_nÙify
->
dpu_wÜk”_id
,

127 
ucc_nÙify
->
cÚ‹xt_ü—‹_nqe
.
cÚ‹xt
);

129 
UROM_WORKER_NOTIFY_UCC_CONTEXT_DESTROY_COMPLETE
:

130 (
sk_d©a
->
ùx_de¡roy
)(
»suÉ
,ask_d©a->
cook›
,

131 
ucc_nÙify
->
dpu_wÜk”_id
);

133 
UROM_WORKER_NOTIFY_UCC_TEAM_CREATE_COMPLETE
:

134 (
sk_d©a
->
‹am_ü—‹
)(
»suÉ
,

135 
sk_d©a
->
cook›
,

136 
ucc_nÙify
->
dpu_wÜk”_id
,

137 
ucc_nÙify
->
‹am_ü—‹_nqe
.
‹am
);

139 
UROM_WORKER_NOTIFY_UCC_COLLECTIVE_COMPLETE
:

140 (
sk_d©a
->
cŞËùive
)(
»suÉ
,

141 
sk_d©a
->
cook›
,

142 
ucc_nÙify
->
dpu_wÜk”_id
,

143 
ucc_nÙify
->
cŞl_nqe
.
¡©us
);

145 
UROM_WORKER_NOTIFY_UCC_PASSIVE_DATA_CHANNEL_COMPLETE
:

146 (
sk_d©a
->
pd_chªÃl
)(
»suÉ
,

147 
sk_d©a
->
cook›
,

148 
ucc_nÙify
->
dpu_wÜk”_id
,

149 
ucc_nÙify
->
·ss_dc_nqe
.
¡©us
);

152 
	`DOCA_LOG_ERR
("Invalid UCC‚otificationype %u",

153 
ucc_nÙify
->
nÙify_ty³
);

157 
sk_»Ëa£
:

158 
»suÉ
 = 
	`doÿ_urom_wÜk”_cmd_sk_»Ëa£
(
sk
);

159 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

160 
	`DOCA_LOG_ERR
("Failedo„elease worker commandask %s",

161 
	`doÿ_”rÜ_g‘_desü
(
»suÉ
));

162 
	}
}

172 
doÿ_”rÜ_t
 
	$cmd_·ck
(
urom_wÜk”_ucc_cmd
 *
ucc_cmd
,

173 
size_t
 *
·cked_cmd_Ën
,

174 *
·cked_cmd
)

176 *
·ck_
 = 
·cked_cmd
;

177 *
·ck_h—d
;

178 
size_t
 
·ck_Ën
;

179 
size_t
 
‹am_size
;

180 
size_t
 
di¥_·ck_size
;

181 
size_t
 
couÁ_·ck_size
;

182 
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
;

183 
is_couÁ_64
, 
is_di¥_64
;

185 
·ck_Ën
 = (
urom_wÜk”_ucc_cmd
);

186 ià(
·ck_Ën
 > *
·cked_cmd_Ën
)

187  
DOCA_ERROR_INITIALIZATION
;

190 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

191 
	`memıy
(
·ck_h—d
, 
ucc_cmd
, 
·ck_Ën
);

192 *
·cked_cmd_Ën
 = 
·ck_Ën
;

194 
ucc_cmd
->
cmd_ty³
) {

195 
UROM_WORKER_CMD_UCC_LIB_CREATE
:

196 
·ck_Ën
 = (
ucc_lib_·¿ms_t
);

197 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

198 
	`memıy
(
·ck_h—d
, 
ucc_cmd
->
lib_ü—‹_cmd
.
·¿ms
, 
·ck_Ën
);

199 *
·cked_cmd_Ën
 +ğ
·ck_Ën
;

201 
UROM_WORKER_CMD_UCC_CONTEXT_CREATE
:

202 ià(
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.
¡ride
 <= 0) {

203 
·ck_Ën
 = (
št64_t
è* 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.
size
;

204 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

205 
	`memıy
(
·ck_h—d
, 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.
¬¿y
, 
·ck_Ën
);

206 *
·cked_cmd_Ën
 +ğ
·ck_Ën
;

209 
UROM_WORKER_CMD_UCC_COLL
:

210 
cŞl_¬gs
 = 
ucc_cmd
->
cŞl_cmd
.coll_args;

211 
·ck_Ën
 = (
ucc_cŞl_¬gs_t
);

212 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

213 
	`memıy
(
·ck_h—d
, 
ucc_cmd
->
cŞl_cmd
.
cŞl_¬gs
, 
·ck_Ën
);

214 *
·cked_cmd_Ën
 +ğ
·ck_Ën
;

215 
·ck_Ën
 = 
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr_size
;

216 ià(
·ck_Ën
 > 0 && 
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr
) {

217 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

218 
	`memıy
(
·ck_h—d
, 
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr
, 
·ck_Ën
);

219 *
·cked_cmd_Ën
 +ğ
·ck_Ën
;

222 ià(
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLTOALLV
 ||

223 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHERV
 ||

224 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHERV
 ||

225 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE_SCATTERV
 ||

226 
cŞl_¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTERV
) {

227 
‹am_size
 = 
ucc_cmd
->
cŞl_cmd
.team_size;

228 
is_couÁ_64
 = ((
cŞl_¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) &&

229 (
cŞl_¬gs
->
æags
 & 
UCC_COLL_ARGS_FLAG_COUNT_64BIT
));

230 
is_di¥_64
 = ((
cŞl_¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) &&

231 (
cŞl_¬gs
->
æags
 & 
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
));

232 
couÁ_·ck_size
 = 
‹am_size
 * ((
is_couÁ_64
è? (
ušt64_t
è: (
ušt32_t
));

233 
di¥_·ck_size
 = 
‹am_size
 * ((
is_di¥_64
è? (
ušt64_t
è: (
ušt32_t
));

234 
·ck_Ën
 = 
couÁ_·ck_size
;

235 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

236 
	`memıy
(
·ck_h—d
, 
cŞl_¬gs
->
¤c
.
šfo_v
.
couÁs
, 
·ck_Ën
);

237 *
·cked_cmd_Ën
 +ğ
·ck_Ën
;

238 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

239 
	`memıy
(
·ck_h—d
, 
cŞl_¬gs
->
d¡
.
šfo_v
.
couÁs
, 
·ck_Ën
);

240 *
·cked_cmd_Ën
 +ğ
·ck_Ën
;

242 
·ck_Ën
 = 
di¥_·ck_size
;

243 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

244 
	`memıy
(
·ck_h—d
, 
cŞl_¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
, 
·ck_Ën
);

245 *
·cked_cmd_Ën
 +ğ
·ck_Ën
;

246 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

247 
	`memıy
(
·ck_h—d
, 
cŞl_¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
·ck_Ën
);

248 *
·cked_cmd_Ën
 +ğ
·ck_Ën
;

251 
UROM_WORKER_CMD_UCC_CREATE_PASSIVE_DATA_CHANNEL
:

252 
·ck_Ën
 = 
ucc_cmd
->
·ss_dc_ü—‹_cmd
.
addr_Ën
;

253 
·ck_h—d
 = 
	`urom_ucc_£rŸlize_Ãxt_¿w
(&
·ck_
, , 
·ck_Ën
);

254 
	`memıy
(
·ck_h—d
, 
ucc_cmd
->
·ss_dc_ü—‹_cmd
.
uı_addr
, 
·ck_Ën
);

255 *
·cked_cmd_Ën
 +ğ
·ck_Ën
;

258 
	`DOCA_LOG_ERR
("Invalid UCC cmdype %u",

259 
ucc_cmd
->
cmd_ty³
);

262  
DOCA_SUCCESS
;

263 
	}
}

272 
	$lib_ü—‹_com¶‘ed
(
doÿ_urom_wÜk”_cmd_sk
 *
sk
,

273 
doÿ_d©a
 
sk_u£r_d©a
,

274 
doÿ_d©a
 
ùx_u£r_d©a
)

276 ()
sk_u£r_d©a
;

277 ()
ùx_u£r_d©a
;

278 
	`com¶‘iÚ
(
sk
, 
UROM_WORKER_NOTIFY_UCC_LIB_CREATE_COMPLETE
);

279 
	}
}

281 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_sk_lib_ü—‹
(

282 
doÿ_urom_wÜk”
 *
wÜk”_ùx
,

283 
doÿ_d©a
 
cook›
,

284 
ušt64_t
 
dpu_wÜk”_id
,

285 *
·¿ms
,

286 
ucc_ş_doÿ_urom_lib_ü—‹_fšished_cb
 
cb
)

288 
size_t
 
·ck_Ën
 = 0;

289 
doÿ_buf
 *
·ylßd
;

290 
doÿ_urom_wÜk”_cmd_sk
 *
sk
;

291 
ucc_ş_doÿ_urom_sk_d©a
 *
sk_d©a
;

292 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
;

293 
doÿ_”rÜ_t
 
»suÉ
;

296 
»suÉ
 = 
	`doÿ_urom_wÜk”_cmd_sk_®loÿ‹_š™
(
wÜk”_ùx
, 
ucc_id
, &
sk
);

297 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

298  
»suÉ
;

300 
·ylßd
 = 
	`doÿ_urom_wÜk”_cmd_sk_g‘_·ylßd
(
sk
);

301 
»suÉ
 = 
	`doÿ_buf_g‘_d©a
(
·ylßd
, (**)&
ucc_cmd
);

302 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

303 
sk_de¡roy
;

305 
»suÉ
 = 
	`doÿ_buf_g‘_d©a_Ën
(
·ylßd
, &
·ck_Ën
);

306 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

307 
sk_de¡roy
;

310 
ucc_cmd
->
cmd_ty³
 = 
UROM_WORKER_CMD_UCC_LIB_CREATE
;

311 
ucc_cmd
->
dpu_wÜk”_id
 = dpu_worker_id;

312 
ucc_cmd
->
lib_ü—‹_cmd
.
·¿ms
 =…arams;

314 
»suÉ
 = 
	`cmd_·ck
(
ucc_cmd
, &
·ck_Ën
, (*)ucc_cmd);

315 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

316 
sk_de¡roy
;

318 
»suÉ
 = 
	`doÿ_buf_£t_d©a
(
·ylßd
, 
ucc_cmd
, 
·ck_Ën
);

319 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

320 
sk_de¡roy
;

322 
sk_d©a
 = (
ucc_ş_doÿ_urom_sk_d©a
 *)

323 
	`doÿ_urom_wÜk”_cmd_sk_g‘_u£r_d©a
(
sk
);

324 
sk_d©a
->
lib_ü—‹
 = 
cb
;

325 
sk_d©a
->
cook›
 = cookie;

327 
	`doÿ_urom_wÜk”_cmd_sk_£t_cb
(
sk
, 
lib_ü—‹_com¶‘ed
);

329 
»suÉ
 = 
	`doÿ_sk_subm™
(
	`doÿ_urom_wÜk”_cmd_sk_as_sk
(
sk
));

330 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

331 
sk_de¡roy
;

333  
DOCA_SUCCESS
;

335 
sk_de¡roy
:

336 
	`doÿ_urom_wÜk”_cmd_sk_»Ëa£
(
sk
);

337  
»suÉ
;

338 
	}
}

348 
	$lib_de¡roy_com¶‘ed
(
doÿ_urom_wÜk”_cmd_sk
 *
sk
,

349 
doÿ_d©a
 
sk_u£r_d©a
,

350 
doÿ_d©a
 
ùx_u£r_d©a
)

352 ()
sk_u£r_d©a
;

353 ()
ùx_u£r_d©a
;

354 
	`com¶‘iÚ
(
sk
, 
UROM_WORKER_NOTIFY_UCC_LIB_DESTROY_COMPLETE
);

355 
	}
}

357 
doÿ_”rÜ_t
 
	$doÿ_urom_ucc_sk_lib_de¡roy
(

358 
doÿ_urom_wÜk”
 *
wÜk”_ùx
,

359 
doÿ_d©a
 
cook›
,

360 
ušt64_t
 
dpu_wÜk”_id
,

361 
ucc_ş_doÿ_urom_lib_de¡roy_fšished_cb
 
cb
)

363 
size_t
 
·ck_Ën
 = 0;

364 
doÿ_buf
 *
·ylßd
;

365 
doÿ_urom_wÜk”_cmd_sk
 *
sk
;

366 
ucc_ş_doÿ_urom_sk_d©a
 *
sk_d©a
;

367 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
;

368 
doÿ_”rÜ_t
 
»suÉ
;

371 
»suÉ
 = 
	`doÿ_urom_wÜk”_cmd_sk_®loÿ‹_š™
(
wÜk”_ùx
, 
ucc_id
, &
sk
);

372 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

373  
»suÉ
;

375 
·ylßd
 = 
	`doÿ_urom_wÜk”_cmd_sk_g‘_·ylßd
(
sk
);

376 
»suÉ
 = 
	`doÿ_buf_g‘_d©a
(
·ylßd
, (**)&
ucc_cmd
);

377 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

378 
sk_de¡roy
;

380 
»suÉ
 = 
	`doÿ_buf_g‘_d©a_Ën
(
·ylßd
, &
·ck_Ën
);

381 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

382 
sk_de¡roy
;

385 
ucc_cmd
->
cmd_ty³
 = 
UROM_WORKER_CMD_UCC_LIB_DESTROY
;

386 
ucc_cmd
->
dpu_wÜk”_id
 = dpu_worker_id;

388 
»suÉ
 = 
	`cmd_·ck
(
ucc_cmd
, &
·ck_Ën
, (*)ucc_cmd);

389 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

390 
sk_de¡roy
;

392 
»suÉ
 = 
	`doÿ_buf_£t_d©a
(
·ylßd
, 
ucc_cmd
, 
·ck_Ën
);

393 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

394 
sk_de¡roy
;

396 
sk_d©a
 = (
ucc_ş_doÿ_urom_sk_d©a
 *)

397 
	`doÿ_urom_wÜk”_cmd_sk_g‘_u£r_d©a
(
sk
);

398 
sk_d©a
->
lib_de¡roy
 = 
cb
;

399 
sk_d©a
->
cook›
 = cookie;

401 
	`doÿ_urom_wÜk”_cmd_sk_£t_cb
(
sk
, 
lib_de¡roy_com¶‘ed
);

403 
»suÉ
 = 
	`doÿ_sk_subm™
(
	`doÿ_urom_wÜk”_cmd_sk_as_sk
(
sk
));

404 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

405 
sk_de¡roy
;

407  
DOCA_SUCCESS
;

409 
sk_de¡roy
:

410 
	`doÿ_urom_wÜk”_cmd_sk_»Ëa£
(
sk
);

411  
»suÉ
;

412 
	}
}

422 
	$ùx_ü—‹_com¶‘ed
(
doÿ_urom_wÜk”_cmd_sk
 *
sk
,

423 
doÿ_d©a
 
sk_u£r_d©a
,

424 
doÿ_d©a
 
ùx_u£r_d©a
)

426 ()
sk_u£r_d©a
;

427 ()
ùx_u£r_d©a
;

428 
	`com¶‘iÚ
(
sk
, 
UROM_WORKER_NOTIFY_UCC_CONTEXT_CREATE_COMPLETE
);

429 
	}
}

431 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_sk_ùx_ü—‹
(

432 
doÿ_urom_wÜk”
 *
wÜk”_ùx
,

433 
doÿ_d©a
 
cook›
,

434 
ušt64_t
 
dpu_wÜk”_id
,

435 
št64_t
 
¡¬t
,

436 
št64_t
 *
¬¿y
,

437 
št64_t
 
¡ride
,

438 
št64_t
 
size
,

439 *
ba£_va
,

440 
ušt64_t
 
Ën
,

441 
ucc_ş_doÿ_urom_ùx_ü—‹_fšished_cb
 
cb
)

443 
size_t
 
·ck_Ën
 = 0;

444 
ucc_ş_doÿ_urom_sk_d©a
 *
sk_d©a
;

445 
doÿ_urom_wÜk”_cmd_sk
 *
sk
;

446 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
;

447 
doÿ_buf
 *
·ylßd
;

448 
doÿ_”rÜ_t
 
»suÉ
;

451 
»suÉ
 = 
	`doÿ_urom_wÜk”_cmd_sk_®loÿ‹_š™
(
wÜk”_ùx
, 
ucc_id
, &
sk
);

452 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

453  
»suÉ
;

455 
·ylßd
 = 
	`doÿ_urom_wÜk”_cmd_sk_g‘_·ylßd
(
sk
);

456 
»suÉ
 = 
	`doÿ_buf_g‘_d©a
(
·ylßd
, (**)&
ucc_cmd
);

457 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

458 
sk_de¡roy
;

460 
»suÉ
 = 
	`doÿ_buf_g‘_d©a_Ën
(
·ylßd
, &
·ck_Ën
);

461 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

462 
sk_de¡roy
;

465 
ucc_cmd
->
cmd_ty³
 = 
UROM_WORKER_CMD_UCC_CONTEXT_CREATE
;

466 
ucc_cmd
->
dpu_wÜk”_id
 = dpu_worker_id;

467 ià(
¬¿y
 =ğ
NULL
) {

468 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.
¡¬t
 = start;

470 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.
¬¿y
 =‡rray;

473 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.
¡ride
 = stride;

474 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.
size
 = size;

475 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.
ba£_va
 = base_va;

476 
ucc_cmd
->
cÚ‹xt_ü—‹_cmd
.
Ën
 =†en;

478 
»suÉ
 = 
	`cmd_·ck
(
ucc_cmd
, &
·ck_Ën
, (*)ucc_cmd);

479 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

480 
sk_de¡roy
;

482 
»suÉ
 = 
	`doÿ_buf_£t_d©a
(
·ylßd
, 
ucc_cmd
, 
·ck_Ën
);

483 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

484 
sk_de¡roy
;

486 
sk_d©a
 = (
ucc_ş_doÿ_urom_sk_d©a
 *)

487 
	`doÿ_urom_wÜk”_cmd_sk_g‘_u£r_d©a
(
sk
);

488 
sk_d©a
->
ùx_ü—‹
 = 
cb
;

489 
sk_d©a
->
cook›
 = cookie;

491 
	`doÿ_urom_wÜk”_cmd_sk_£t_cb
(
sk
, 
ùx_ü—‹_com¶‘ed
);

493 
»suÉ
 = 
	`doÿ_sk_subm™
(
	`doÿ_urom_wÜk”_cmd_sk_as_sk
(
sk
));

494 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

495 
sk_de¡roy
;

497  
DOCA_SUCCESS
;

499 
sk_de¡roy
:

500 
	`doÿ_urom_wÜk”_cmd_sk_»Ëa£
(
sk
);

501  
»suÉ
;

502 
	}
}

512 
	$ùx_de¡roy_com¶‘ed
(
doÿ_urom_wÜk”_cmd_sk
 *
sk
,

513 
doÿ_d©a
 
sk_u£r_d©a
,

514 
doÿ_d©a
 
ùx_u£r_d©a
)

516 ()
sk_u£r_d©a
;

517 ()
ùx_u£r_d©a
;

518 
	`com¶‘iÚ
(
sk
, 
UROM_WORKER_NOTIFY_UCC_CONTEXT_DESTROY_COMPLETE
);

519 
	}
}

521 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_sk_ùx_de¡roy
(

522 
doÿ_urom_wÜk”
 *
wÜk”_ùx
,

523 
doÿ_d©a
 
cook›
,

524 
ušt64_t
 
dpu_wÜk”_id
,

525 *
cÚ‹xt
,

526 
ucc_ş_doÿ_urom_ùx_de¡roy_fšished_cb
 
cb
)

528 
size_t
 
·ck_Ën
 = 0;

529 
ucc_ş_doÿ_urom_sk_d©a
 *
sk_d©a
;

530 
doÿ_urom_wÜk”_cmd_sk
 *
sk
;

531 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
;

532 
doÿ_buf
 *
·ylßd
;

533 
doÿ_”rÜ_t
 
»suÉ
;

536 
»suÉ
 = 
	`doÿ_urom_wÜk”_cmd_sk_®loÿ‹_š™
(
wÜk”_ùx
, 
ucc_id
, &
sk
);

537 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

538  
»suÉ
;

540 
·ylßd
 = 
	`doÿ_urom_wÜk”_cmd_sk_g‘_·ylßd
(
sk
);

541 
»suÉ
 = 
	`doÿ_buf_g‘_d©a
(
·ylßd
, (**)&
ucc_cmd
);

542 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

543 
sk_de¡roy
;

545 
»suÉ
 = 
	`doÿ_buf_g‘_d©a_Ën
(
·ylßd
, &
·ck_Ën
);

546 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

547 
sk_de¡roy
;

550 
ucc_cmd
->
cmd_ty³
 = 
UROM_WORKER_CMD_UCC_CONTEXT_DESTROY
;

551 
ucc_cmd
->
dpu_wÜk”_id
 = dpu_worker_id;

552 
ucc_cmd
->
cÚ‹xt_de¡roy_cmd
.
cÚ‹xt_h
 = 
cÚ‹xt
;

554 
»suÉ
 = 
	`cmd_·ck
(
ucc_cmd
, &
·ck_Ën
, (*)ucc_cmd);

555 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

556 
sk_de¡roy
;

558 
»suÉ
 = 
	`doÿ_buf_£t_d©a
(
·ylßd
, 
ucc_cmd
, 
·ck_Ën
);

559 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

560 
sk_de¡roy
;

562 
sk_d©a
 = (
ucc_ş_doÿ_urom_sk_d©a
 *)

563 
	`doÿ_urom_wÜk”_cmd_sk_g‘_u£r_d©a
(
sk
);

564 
sk_d©a
->
ùx_de¡roy
 = 
cb
;

565 
sk_d©a
->
cook›
 = cookie;

567 
	`doÿ_urom_wÜk”_cmd_sk_£t_cb
(
sk
, 
ùx_de¡roy_com¶‘ed
);

569 
»suÉ
 = 
	`doÿ_sk_subm™
(
	`doÿ_urom_wÜk”_cmd_sk_as_sk
(
sk
));

570 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

571 
sk_de¡roy
;

573  
DOCA_SUCCESS
;

575 
sk_de¡roy
:

576 
	`doÿ_urom_wÜk”_cmd_sk_»Ëa£
(
sk
);

577  
»suÉ
;

578 
	}
}

587 
	$‹am_ü—‹_com¶‘ed
(
doÿ_urom_wÜk”_cmd_sk
 *
sk
,

588 
doÿ_d©a
 
sk_u£r_d©a
,

589 
doÿ_d©a
 
ùx_u£r_d©a
)

591 ()
sk_u£r_d©a
;

592 ()
ùx_u£r_d©a
;

593 
	`com¶‘iÚ
(
sk
, 
UROM_WORKER_NOTIFY_UCC_TEAM_CREATE_COMPLETE
);

594 
	}
}

596 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_sk_‹am_ü—‹
(

597 
doÿ_urom_wÜk”
 *
wÜk”_ùx
,

598 
doÿ_d©a
 
cook›
,

599 
ušt64_t
 
dpu_wÜk”_id
,

600 
št64_t
 
¡¬t
,

601 
št64_t
 
¡ride
,

602 
št64_t
 
size
,

603 *
cÚ‹xt
,

604 
ucc_ş_doÿ_urom_‹am_ü—‹_fšished_cb
 
cb
)

606 
size_t
 
·ck_Ën
 = 0;

607 
ucc_ş_doÿ_urom_sk_d©a
 *
sk_d©a
;

608 
doÿ_urom_wÜk”_cmd_sk
 *
sk
;

609 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
;

610 
doÿ_buf
 *
·ylßd
;

611 
doÿ_”rÜ_t
 
»suÉ
;

614 
»suÉ
 = 
	`doÿ_urom_wÜk”_cmd_sk_®loÿ‹_š™
(
wÜk”_ùx
, 
ucc_id
, &
sk
);

615 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

616  
»suÉ
;

618 
·ylßd
 = 
	`doÿ_urom_wÜk”_cmd_sk_g‘_·ylßd
(
sk
);

619 
»suÉ
 = 
	`doÿ_buf_g‘_d©a
(
·ylßd
, (**)&
ucc_cmd
);

620 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

621 
sk_de¡roy
;

623 
»suÉ
 = 
	`doÿ_buf_g‘_d©a_Ën
(
·ylßd
, &
·ck_Ën
);

624 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

625 
sk_de¡roy
;

628 
ucc_cmd
->
cmd_ty³
 = 
UROM_WORKER_CMD_UCC_TEAM_CREATE
;

629 
ucc_cmd
->
dpu_wÜk”_id
 = dpu_worker_id;

630 
ucc_cmd
->
‹am_ü—‹_cmd
.
¡¬t
 = start;

631 
ucc_cmd
->
‹am_ü—‹_cmd
.
¡ride
 = stride;

632 
ucc_cmd
->
‹am_ü—‹_cmd
.
size
 = size;

633 
ucc_cmd
->
‹am_ü—‹_cmd
.
cÚ‹xt_h
 = 
cÚ‹xt
;

635 
»suÉ
 = 
	`cmd_·ck
(
ucc_cmd
, &
·ck_Ën
, (*)ucc_cmd);

636 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

637 
sk_de¡roy
;

639 
»suÉ
 = 
	`doÿ_buf_£t_d©a
(
·ylßd
, 
ucc_cmd
, 
·ck_Ën
);

640 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

641 
sk_de¡roy
;

643 
sk_d©a
 = (
ucc_ş_doÿ_urom_sk_d©a
 *)

644 
	`doÿ_urom_wÜk”_cmd_sk_g‘_u£r_d©a
(
sk
);

645 
sk_d©a
->
‹am_ü—‹
 = 
cb
;

646 
sk_d©a
->
cook›
 = cookie;

648 
	`doÿ_urom_wÜk”_cmd_sk_£t_cb
(
sk
, 
‹am_ü—‹_com¶‘ed
);

650 
»suÉ
 = 
	`doÿ_sk_subm™
(
	`doÿ_urom_wÜk”_cmd_sk_as_sk
(
sk
));

651 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

652 
sk_de¡roy
;

654  
DOCA_SUCCESS
;

656 
sk_de¡roy
:

657 
	`doÿ_urom_wÜk”_cmd_sk_»Ëa£
(
sk
);

658  
»suÉ
;

659 
	}
}

669 
	$cŞËùive_com¶‘ed
(
doÿ_urom_wÜk”_cmd_sk
 *
sk
,

670 
doÿ_d©a
 
sk_u£r_d©a
,

671 
doÿ_d©a
 
ùx_u£r_d©a
)

673 ()
sk_u£r_d©a
;

674 ()
ùx_u£r_d©a
;

675 
	`com¶‘iÚ
(
sk
, 
UROM_WORKER_NOTIFY_UCC_COLLECTIVE_COMPLETE
);

676 
	}
}

678 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_sk_cŞËùive
(

679 
doÿ_urom_wÜk”
 *
wÜk”_ùx
,

680 
doÿ_d©a
 
cook›
,

681 
ušt64_t
 
dpu_wÜk”_id
,

682 *
cŞl_¬gs
,

683 *
‹am
,

684 
u£_xgvmi
,

685 *
wÜk_bufãr
,

686 
size_t
 
wÜk_bufãr_size
,

687 
size_t
 
‹am_size
,

688 
ucc_ş_doÿ_urom_cŞËùive_fšished_cb
 
cb
)

690 
size_t
 
·ck_Ën
 = 0;

691 
ucc_ş_doÿ_urom_sk_d©a
 *
sk_d©a
;

692 
doÿ_urom_wÜk”_cmd_sk
 *
sk
;

693 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
;

694 
doÿ_buf
 *
·ylßd
;

695 
doÿ_”rÜ_t
 
»suÉ
;

698 
»suÉ
 = 
	`doÿ_urom_wÜk”_cmd_sk_®loÿ‹_š™
(
wÜk”_ùx
, 
ucc_id
, &
sk
);

699 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

700  
»suÉ
;

702 
·ylßd
 = 
	`doÿ_urom_wÜk”_cmd_sk_g‘_·ylßd
(
sk
);

703 
»suÉ
 = 
	`doÿ_buf_g‘_d©a
(
·ylßd
, (**)&
ucc_cmd
);

704 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

705 
sk_de¡roy
;

707 
»suÉ
 = 
	`doÿ_buf_g‘_d©a_Ën
(
·ylßd
, &
·ck_Ën
);

708 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

709 
sk_de¡roy
;

712 
ucc_cmd
->
cmd_ty³
 = 
UROM_WORKER_CMD_UCC_COLL
;

713 
ucc_cmd
->
dpu_wÜk”_id
 = dpu_worker_id;

714 
ucc_cmd
->
cŞl_cmd
.
cŞl_¬gs
 = coll_args;

715 
ucc_cmd
->
cŞl_cmd
.
‹am
 =eam;

716 
ucc_cmd
->
cŞl_cmd
.
u£_xgvmi
 = use_xgvmi;

717 
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr
 = work_buffer;

718 
ucc_cmd
->
cŞl_cmd
.
wÜk_bufãr_size
 = work_buffer_size;

719 
ucc_cmd
->
cŞl_cmd
.
‹am_size
 =eam_size;

721 
»suÉ
 = 
	`cmd_·ck
(
ucc_cmd
, &
·ck_Ën
, (*)ucc_cmd);

722 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

723 
sk_de¡roy
;

725 
»suÉ
 = 
	`doÿ_buf_£t_d©a
(
·ylßd
, 
ucc_cmd
, 
·ck_Ën
);

726 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

727 
sk_de¡roy
;

729 
sk_d©a
 = (
ucc_ş_doÿ_urom_sk_d©a
 *)

730 
	`doÿ_urom_wÜk”_cmd_sk_g‘_u£r_d©a
(
sk
);

731 
sk_d©a
->
cŞËùive
 = 
cb
;

732 
sk_d©a
->
cook›
 = cookie;

734 
	`doÿ_urom_wÜk”_cmd_sk_£t_cb
(
sk
, 
cŞËùive_com¶‘ed
);

736 
»suÉ
 = 
	`doÿ_sk_subm™
(
	`doÿ_urom_wÜk”_cmd_sk_as_sk
(
sk
));

737 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

738 
sk_de¡roy
;

740  
DOCA_SUCCESS
;

742 
sk_de¡roy
:

743 
	`doÿ_urom_wÜk”_cmd_sk_»Ëa£
(
sk
);

744  
»suÉ
;

745 
	}
}

755 
	$pd_chªÃl_com¶‘ed
(
doÿ_urom_wÜk”_cmd_sk
 *
sk
,

756 
doÿ_d©a
 
sk_u£r_d©a
,

757 
doÿ_d©a
 
ùx_u£r_d©a
)

759 ()
sk_u£r_d©a
;

760 ()
ùx_u£r_d©a
;

761 
	`com¶‘iÚ
(
sk
, 
UROM_WORKER_NOTIFY_UCC_PASSIVE_DATA_CHANNEL_COMPLETE
);

762 
	}
}

764 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_sk_pd_chªÃl
(

765 
doÿ_urom_wÜk”
 *
wÜk”_ùx
,

766 
doÿ_d©a
 
cook›
,

767 
ušt64_t
 
dpu_wÜk”_id
,

768 *
uı_addr
,

769 
size_t
 
addr_Ën
,

770 
ucc_ş_doÿ_urom_pd_chªÃl_fšished_cb
 
cb
)

772 
size_t
 
·ck_Ën
 = 0;

773 
ucc_ş_doÿ_urom_sk_d©a
 *
sk_d©a
;

774 
doÿ_urom_wÜk”_cmd_sk
 *
sk
;

775 
urom_wÜk”_ucc_cmd
 *
ucc_cmd
;

776 
doÿ_buf
 *
·ylßd
;

777 
doÿ_”rÜ_t
 
»suÉ
;

780 
»suÉ
 = 
	`doÿ_urom_wÜk”_cmd_sk_®loÿ‹_š™
(
wÜk”_ùx
, 
ucc_id
, &
sk
);

781 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

782  
»suÉ
;

784 
·ylßd
 = 
	`doÿ_urom_wÜk”_cmd_sk_g‘_·ylßd
(
sk
);

785 
»suÉ
 = 
	`doÿ_buf_g‘_d©a
(
·ylßd
, (**)&
ucc_cmd
);

786 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

787 
sk_de¡roy
;

789 
»suÉ
 = 
	`doÿ_buf_g‘_d©a_Ën
(
·ylßd
, &
·ck_Ën
);

790 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

791 
sk_de¡roy
;

794 
ucc_cmd
->
cmd_ty³
 =

795 
UROM_WORKER_CMD_UCC_CREATE_PASSIVE_DATA_CHANNEL
;

796 
ucc_cmd
->
dpu_wÜk”_id
 = dpu_worker_id;

797 
ucc_cmd
->
·ss_dc_ü—‹_cmd
.
uı_addr
 = ucp_addr;

798 
ucc_cmd
->
·ss_dc_ü—‹_cmd
.
addr_Ën
 =‡ddr_len;

800 
»suÉ
 = 
	`cmd_·ck
(
ucc_cmd
, &
·ck_Ën
, (*)ucc_cmd);

801 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

802 
sk_de¡roy
;

804 
»suÉ
 = 
	`doÿ_buf_£t_d©a
(
·ylßd
, 
ucc_cmd
, 
·ck_Ën
);

805 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

806 
sk_de¡roy
;

808 
sk_d©a
 = (
ucc_ş_doÿ_urom_sk_d©a
 *)

809 
	`doÿ_urom_wÜk”_cmd_sk_g‘_u£r_d©a
(
sk
);

810 
sk_d©a
->
pd_chªÃl
 = 
cb
;

811 
sk_d©a
->
cook›
 = cookie;

813 
	`doÿ_urom_wÜk”_cmd_sk_£t_cb
(
sk
, 
pd_chªÃl_com¶‘ed
);

815 
»suÉ
 = 
	`doÿ_sk_subm™
(
	`doÿ_urom_wÜk”_cmd_sk_as_sk
(
sk
));

816 ià(
»suÉ
 !ğ
DOCA_SUCCESS
)

817 
sk_de¡roy
;

819  
DOCA_SUCCESS
;

821 
sk_de¡roy
:

822 
	`doÿ_urom_wÜk”_cmd_sk_»Ëa£
(
sk
);

823  
»suÉ
;

824 
	}
}

826 
doÿ_”rÜ_t
 
	$ucc_ş_doÿ_urom_§ve_¶ugš_id
(
ušt64_t
 
¶ugš_id
,

827 
ušt64_t
 
v”siÚ
)

829 ià(
v”siÚ
 !ğ
ucc_v”siÚ
) {

830  
DOCA_ERROR_UNSUPPORTED_VERSION
;

833 
ucc_id
 = 
¶ugš_id
;

834  
DOCA_SUCCESS
;

835 
	}
}

844 
	$ucc_ş_doÿ_urom_lib_ü—‹_fšished
(

845 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
, 
ušt64_t
 
dpu_wÜk”_id
)

847 
ucc_ş_doÿ_urom_»suÉ
 *
»s
 =

848 (
ucc_ş_doÿ_urom_»suÉ
 *)
cook›
.
±r
;

849 ià(
»s
 =ğ
NULL
) {

853 
»s
->
dpu_wÜk”_id
 = dpu_worker_id;

854 
»s
->
»suÉ
 =„esult;

855 
	}
}

865 
	$ucc_ş_doÿ_urom_pss_dc_fšished
(

866 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
,

867 
ušt64_t
 
dpu_wÜk”_id
, 
ucc_¡©us_t
 
¡©us
)

869 
ucc_ş_doÿ_urom_»suÉ
 *
»s
 =

870 (
ucc_ş_doÿ_urom_»suÉ
 *)
cook›
.
±r
;

871 ià(
»s
 =ğ
NULL
) {

875 
»s
->
dpu_wÜk”_id
 = dpu_worker_id;

876 
»s
->
»suÉ
 =„esult;

877 
»s
->
·ss_dc
.
¡©us
 = status;

878 
	}
}

887 
	$ucc_ş_doÿ_urom_lib_de¡roy_fšished
(

888 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
,

889 
ušt64_t
 
dpu_wÜk”_id
)

891 
ucc_ş_doÿ_urom_»suÉ
 *
»s
 =

892 (
ucc_ş_doÿ_urom_»suÉ
 *)
cook›
.
±r
;

893 ià(
»s
 =ğ
NULL
) {

897 
»s
->
dpu_wÜk”_id
 = dpu_worker_id;

898 
»s
->
»suÉ
 =„esult;

899 
	}
}

909 
	$ucc_ş_doÿ_urom_ùx_ü—‹_fšished
(

910 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
,

911 
ušt64_t
 
dpu_wÜk”_id
, *
cÚ‹xt
)

913 
ucc_ş_doÿ_urom_»suÉ
 *
»s
 =

914 (
ucc_ş_doÿ_urom_»suÉ
 *)
cook›
.
±r
;

915 ià(
»s
 =ğ
NULL
) {

919 
»s
->
dpu_wÜk”_id
 = dpu_worker_id;

920 
»s
->
»suÉ
 =„esult;

921 
»s
->
cÚ‹xt_ü—‹
.
cÚ‹xt
 = context;

922 
	}
}

932 
	$ucc_ş_doÿ_urom_cŞËùive_fšished
(

933 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
,

934 
ušt64_t
 
dpu_wÜk”_id
, 
ucc_¡©us_t
 
¡©us
)

936 
ucc_ş_doÿ_urom_»suÉ
 *
»s
 =

937 (
ucc_ş_doÿ_urom_»suÉ
 *)
cook›
.
±r
;

938 ià(
»s
 =ğ
NULL
) {

942 
»s
->
dpu_wÜk”_id
 = dpu_worker_id;

943 
»s
->
»suÉ
 =„esult;

944 
»s
->
cŞËùive
.
¡©us
 = status;

945 
	}
}

955 
	$ucc_ş_doÿ_urom_‹am_ü—‹_fšished
(

956 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
,

957 
ušt64_t
 
dpu_wÜk”_id
, *
‹am
)

959 
ucc_ş_doÿ_urom_»suÉ
 *
»s
 =

960 (
ucc_ş_doÿ_urom_»suÉ
 *)
cook›
.
±r
;

961 ià(
»s
 =ğ
NULL
) {

965 
»s
->
dpu_wÜk”_id
 = dpu_worker_id;

966 
»s
->
»suÉ
 =„esult;

967 
»s
->
‹am_ü—‹
.
‹am
 =eam;

968 
	}
}

970 
ucc_¡©us_t
 
	$ucc_ş_doÿ_urom_bufãr_expÜt_ucc
(

971 
uı_cÚ‹xt_h
 
uı_cÚ‹xt
, *
buf
,

972 
size_t
 
Ën
, 
expÜt_buf
 *
ebuf
)

974 
ucs_¡©us_t
 
ucs_¡©us
;

975 
uı_mem_m­_·¿ms_t
 
·¿ms
;

976 
uı_memh_·ck_·¿ms_t
 
·ck_·¿ms
;

978 
ebuf
->
uı_cÚ‹xt
 = ucp_context;

980 
·¿ms
.
f›ld_mask
 =

981 
UCP_MEM_MAP_PARAM_FIELD_ADDRESS
 | 
UCP_MEM_MAP_PARAM_FIELD_LENGTH
;

982 
·¿ms
.
add»ss
 = 
buf
;

983 
·¿ms
.
Ëngth
 = 
Ën
;

985 
ucs_¡©us
 = 
	`uı_mem_m­
(
uı_cÚ‹xt
, &
·¿ms
, &
ebuf
->
memh
);

986 
	`as£¹
(
ucs_¡©us
 =ğ
UCS_OK
);

988 
·ck_·¿ms
.
f›ld_mask
 = 
UCP_MEMH_PACK_PARAM_FIELD_FLAGS
;

989 
·ck_·¿ms
.
æags
 = 
UCP_MEMH_PACK_FLAG_EXPORT
;

991 
ucs_¡©us
 = 
	`uı_memh_·ck
(
ebuf
->
memh
, &
·ck_·¿ms
, &ebuf->
·cked_memh
,

992 &
ebuf
->
·cked_memh_Ën
);

993 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

994 
	`´štf
("ucp_memh_pack()„eturnedƒrror: %s\n",

995 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
));

996 
ebuf
->
·cked_memh
 = 
NULL
;

997 
ebuf
->
·cked_memh_Ën
 = 0;

998  
UCC_ERR_NO_RESOURCE
;

1000 
ucs_¡©us
 = 
	`uı_rkey_·ck
(
uı_cÚ‹xt
, 
ebuf
->
memh
, &ebuf->
·cked_key
,

1001 &
ebuf
->
·cked_key_Ën
);

1002 ià(
UCS_OK
 !ğ
ucs_¡©us
) {

1003 
	`´štf
("ucp_rkey_pack()„eturnedƒrror: %s\n",

1004 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
));

1005  
UCC_ERR_NO_RESOURCE
;

1008  
UCC_OK
;

1009 
	}
}

	@src/components/cl/doca_urom/cl_doca_urom_worker_ucc.h

14 #iâdeà
UCC_CL_DOCA_UROM_WORKER_UCC_H_


15 
	#UCC_CL_DOCA_UROM_WORKER_UCC_H_


	)

17 
	~<ucc/­i/ucc.h
>

19 
	~<doÿ_log.h
>

20 
	~<doÿ_”rÜ.h
>

22 
	~<doÿ_urom.h
>

24 
	~"urom_ucc.h
"

26 
	sexpÜt_buf
 {

27 
uı_cÚ‹xt_h
 
	muı_cÚ‹xt
;

28 
uı_mem_h
 
	mmemh
;

29 *
	m·cked_memh
;

30 
size_t
 
	m·cked_memh_Ën
;

31 *
	m·cked_key
;

32 
size_t
 
	m·cked_key_Ën
;

33 
ušt64_t
 
	mmemh_id
;

37 
	succ_ş_doÿ_urom_cÚ‹xt_ü—‹_»suÉ
 {

38 *
	mcÚ‹xt
;

42 
	succ_ş_doÿ_urom_‹am_ü—‹_»suÉ
 {

43 *
	m‹am
;

47 
	succ_ş_doÿ_urom_cŞËùive_»suÉ
 {

48 
ucc_¡©us_t
 
	m¡©us
;

52 
	succ_ş_doÿ_urom_·ss_dc_»suÉ
 {

53 
ucc_¡©us_t
 
	m¡©us
;

57 
	succ_ş_doÿ_urom_»suÉ
 {

58 
doÿ_”rÜ_t
 
	m»suÉ
;

59 
ušt64_t
 
	mdpu_wÜk”_id
;

61 
ucc_ş_doÿ_urom_cÚ‹xt_ü—‹_»suÉ
 
	mcÚ‹xt_ü—‹
;

62 
ucc_ş_doÿ_urom_‹am_ü—‹_»suÉ
 
	m‹am_ü—‹
;

63 
ucc_ş_doÿ_urom_cŞËùive_»suÉ
 
	mcŞËùive
;

64 
ucc_ş_doÿ_urom_·ss_dc_»suÉ
 
	m·ss_dc
;

68 
ucc_ş_doÿ_urom_cŞËùive_fšished
(

69 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
,

70 
ušt64_t
 
dpu_wÜk”_id
, 
ucc_¡©us_t
 
¡©us
);

72 
ucc_¡©us_t
 
ucc_ş_doÿ_urom_bufãr_expÜt_ucc
(

73 
uı_cÚ‹xt_h
 
uı_cÚ‹xt
, *
buf
,

74 
size_t
 
Ën
, 
expÜt_buf
 *
ebuf
);

84 
ucc_ş_doÿ_urom_‹am_ü—‹_fšished
(

85 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
,

86 
ušt64_t
 
dpu_wÜk”_id
, *
‹am
);

95 
ucc_ş_doÿ_urom_lib_ü—‹_fšished
(

96 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
, 
ušt64_t
 
dpu_wÜk”_id
);

106 
ucc_ş_doÿ_urom_pss_dc_fšished
(

107 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
,

108 
ušt64_t
 
dpu_wÜk”_id
, 
ucc_¡©us_t
 
¡©us
);

117 
ucc_ş_doÿ_urom_lib_de¡roy_fšished
(

118 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
, 
ušt64_t
 
dpu_wÜk”_id
);

128 
ucc_ş_doÿ_urom_ùx_ü—‹_fšished
(

129 
doÿ_”rÜ_t
 
»suÉ
, 
doÿ_d©a
 
cook›
,

130 
ušt64_t
 
dpu_wÜk”_id
, *
cÚ‹xt
);

139 (*
	tucc_ş_doÿ_urom_lib_ü—‹_fšished_cb
)(

140 
	tdoÿ_”rÜ_t
 
	t»suÉ
, 
	tdoÿ_d©a
 
	tcook›
, 
	tušt64_t
 
	tdpu_wÜk”_id
);

149 (*
	tucc_ş_doÿ_urom_lib_de¡roy_fšished_cb
)(

150 
	tdoÿ_”rÜ_t
 
	t»suÉ
, 
	tdoÿ_d©a
 
	tcook›
, 
	tušt64_t
 
	tdpu_wÜk”_id
);

160 (*
	tucc_ş_doÿ_urom_ùx_ü—‹_fšished_cb
)(

161 
	tdoÿ_”rÜ_t
 
	t»suÉ
, 
	tdoÿ_d©a
 
	tcook›
,

162 
	tušt64_t
 
	tdpu_wÜk”_id
, *
	tcÚ‹xt
);

171 (*
	tucc_ş_doÿ_urom_ùx_de¡roy_fšished_cb
)(

172 
	tdoÿ_”rÜ_t
 
	t»suÉ
, 
	tdoÿ_d©a
 
	tcook›
, 
	tušt64_t
 
	tdpu_wÜk”_id
);

182 (*
	tucc_ş_doÿ_urom_‹am_ü—‹_fšished_cb
)(

183 
	tdoÿ_”rÜ_t
 
	t»suÉ
, 
	tdoÿ_d©a
 
	tcook›
,

184 
	tušt64_t
 
	tdpu_wÜk”_id
, *
	t‹am
);

194 (*
	tucc_ş_doÿ_urom_cŞËùive_fšished_cb
)(

195 
	tdoÿ_”rÜ_t
 
	t»suÉ
, 
	tdoÿ_d©a
 
	tcook›
,

196 
	tušt64_t
 
	tdpu_wÜk”_id
, 
	tucc_¡©us_t
 
	t¡©us
);

206 (*
	tucc_ş_doÿ_urom_pd_chªÃl_fšished_cb
)(

207 
	tdoÿ_”rÜ_t
 
	t»suÉ
, 
	tdoÿ_d©a
 
	tcook›
,

208 
	tušt64_t
 
	tdpu_wÜk”_id
, 
	tucc_¡©us_t
 
	t¡©us
);

220 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_sk_lib_ü—‹
(

221 
doÿ_urom_wÜk”
 *
wÜk”_ùx
, 
doÿ_d©a
 
cook›
,

222 
ušt64_t
 
dpu_wÜk”_id
, *
·¿ms
,

223 
ucc_ş_doÿ_urom_lib_ü—‹_fšished_cb
 
cb
);

234 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_sk_lib_de¡roy
(

235 
doÿ_urom_wÜk”
 *
wÜk”_ùx
, 
doÿ_d©a
 
cook›
,

236 
ušt64_t
 
dpu_wÜk”_id
,

237 
ucc_ş_doÿ_urom_lib_de¡roy_fšished_cb
 
cb
);

254 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_sk_ùx_ü—‹
(

255 
doÿ_urom_wÜk”
 *
wÜk”_ùx
, 
doÿ_d©a
 
cook›
,

256 
ušt64_t
 
dpu_wÜk”_id
, 
št64_t
 
¡¬t
, iÁ64_ˆ*
¬¿y
,

257 
št64_t
 
¡ride
, iÁ64_ˆ
size
, *
ba£_va
, 
ušt64_t
 
Ën
,

258 
ucc_ş_doÿ_urom_ùx_ü—‹_fšished_cb
 
cb
);

270 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_sk_ùx_de¡roy
(

271 
doÿ_urom_wÜk”
 *
wÜk”_ùx
, 
doÿ_d©a
 
cook›
,

272 
ušt64_t
 
dpu_wÜk”_id
, *
cÚ‹xt
,

273 
ucc_ş_doÿ_urom_ùx_de¡roy_fšished_cb
 
cb
);

288 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_sk_‹am_ü—‹
(

289 
doÿ_urom_wÜk”
 *
wÜk”_ùx
, 
doÿ_d©a
 
cook›
,

290 
ušt64_t
 
dpu_wÜk”_id
, 
št64_t
 
¡¬t
, iÁ64_ˆ
¡ride
, iÁ64_ˆ
size
,

291 *
cÚ‹xt
, 
ucc_ş_doÿ_urom_‹am_ü—‹_fšished_cb
 
cb
);

308 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_sk_cŞËùive
(

309 
doÿ_urom_wÜk”
 *
wÜk”_ùx
, 
doÿ_d©a
 
cook›
,

310 
ušt64_t
 
dpu_wÜk”_id
, *
cŞl_¬gs
, *
‹am
, 
u£_xgvmi
,

311 *
wÜk_bufãr
, 
size_t
 
wÜk_bufãr_size
, size_ˆ
‹am_size
,

312 
ucc_ş_doÿ_urom_cŞËùive_fšished_cb
 
cb
);

325 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_sk_pd_chªÃl
(

326 
doÿ_urom_wÜk”
 *
wÜk”_ùx
, 
doÿ_d©a
 
cook›
,

327 
ušt64_t
 
dpu_wÜk”_id
, *
uı_addr
, 
size_t
 
addr_Ën
,

328 
ucc_ş_doÿ_urom_pd_chªÃl_fšished_cb
 
cb
);

337 
doÿ_”rÜ_t
 
	`ucc_ş_doÿ_urom_§ve_¶ugš_id
(

338 
ušt64_t
 
¶ugš_id
, ušt64_ˆ
v”siÚ
);

	@src/components/cl/hier/allgatherv/allgatherv.c

7 
	~"®lg©h”v.h
"

8 
	~"uÅack.h
"

9 
	~"../ş_h›r_cŞl.h
"

10 
	~"cÜe/ucc_‹am.h
"

12 
	#MAX_ALLGATHERV_TASKS
 4

	)

14 
ucc_ba£_cŞl_®g_šfo_t


15 
	gucc_ş_h›r_®lg©h”v_®gs
[
UCC_CL_HIER_ALLGATHERV_ALG_LAST
 + 1] = {

16 [
UCC_CL_HIER_ALLGATHERV_ALG_GAB
] =

17 {.
id
 = 
UCC_CL_HIER_ALLGATHERV_ALG_GAB
,

18 .
	gÇme
 = "gab",

19 .
	gdesc
 = "gatherv +‡llgatherv + bcast"},

20 [
UCC_CL_HIER_ALLGATHERV_ALG_LAST
] = {

21 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

23 
ucc_¡©us_t
 
	$ucc_ş_h›r_®lg©h”v_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

25 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_allgatherv_start", 0);

26  
	`ucc_scheduË_¡¬t
(
sk
);

27 
	}
}

29 
ucc_¡©us_t
 
	$ucc_ş_h›r_®lg©h”v_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

31 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

32 
ucc_ş_h›r_scheduË_t
 *
ş_scheduË
 = 
	`ucc_d”ived_of
(
sk
,

33 
ucc_ş_h›r_scheduË_t
);

34 
ucc_¡©us_t
 
¡©us
;

36 
	`ucc_mc_ä“
(
ş_scheduË
->
sü©ch
);

38 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_allgatherv_finalize", 0);

39 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

40 
	`ucc_ş_h›r_put_scheduË
(
scheduË
);

41  
¡©us
;

42 
	}
}

45 
šlše
 
ucc_¡©us_t
 
	$fšd_Ëad”_¿nk
(
ucc_ba£_‹am_t
 *
‹am
,

46 
ucc_¿nk_t
 
‹am_¿nk
,

47 
ucc_¿nk_t
 *
¿nk_out
)

49 
ucc_ş_h›r_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

50 
ucc_‹am_t
 *
cÜe_‹am
 = 
ş_‹am
->
su³r
.su³r.
·¿ms
.
‹am
;

51 
ucc_¿nk_t
 *
node_Ëad”s
 = 
NULL
;

52 
ucc_¡©us_t
 
¡©us
;

54 
	`ucc_as£¹
(
‹am_¿nk
 < 
	`UCC_CL_TEAM_SIZE
(
ş_‹am
));

55 
	`ucc_as£¹
(
	`SBGP_EXISTS
(
ş_‹am
, 
NODE_LEADERS
));

57 
¡©us
 = 
	`ucc_tİo_g‘_node_Ëad”s
(
cÜe_‹am
->
tİo
, &
node_Ëad”s
);

58 ià(
UCC_OK
 !ğ
¡©us
) {

59 
	`ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "Could‚ot get‚ode†eaders");

60  
¡©us
;

63 *
¿nk_out
 = 
node_Ëad”s
[
‹am_¿nk
];

64  
UCC_OK
;

65 
	}
}

70 
šlše
 
ucc_¡©us_t
 
	$is_block_Üd”ed
(
ucc_ş_h›r_‹am_t
 *
ş_‹am
, *
Üd”ed
)

72 
ucc_tİo_t
 *
tİo
 = 
ş_‹am
->
su³r
.su³r.
·¿ms
.
‹am
->topo;

73 
ucc_sbgp_t
 *
®l_nodes
 = 
NULL
;

74 
is_block_Üd”ed
 = 1;

75 
n_nodes
;

76 
ucc_¡©us_t
 
¡©us
;

77 
ucc_¿nk_t
 
´ev_¿nk
, 
cu¼_¿nk
;

78 
ucc_¿nk_t
 
i
, 
j
;

80 ià(
ş_‹am
->
is_block_Üd”ed
 != -1) {

81 
is_block_Üd”ed
 = 
ş_‹am
->is_block_ordered;

83 
¡©us
 = 
	`ucc_tİo_g‘_®l_nodes
(
tİo
, &
®l_nodes
, &
n_nodes
);

84 ià(
¡©us
 !ğ
UCC_OK
) {

85  
¡©us
;

89 
i
 = 0; i < 
n_nodes
; i++) {

90 ià(
®l_nodes
[
i
].
¡©us
 =ğ
UCC_SBGP_ENABLED


91 && 
®l_nodes
[
i
].
group_size
 > 1) {

93 
´ev_¿nk
 = 
	`ucc_•_m­_ev®
(
®l_nodes
[
i
].
m­
, 0);

96 
j
 = 1; j < 
®l_nodes
[
i
].
group_size
; j++) {

97 
cu¼_¿nk
 = 
	`ucc_•_m­_ev®
(
®l_nodes
[
i
].
m­
, 
j
);

100 ià(
cu¼_¿nk
 !ğ
´ev_¿nk
 + 1) {

101 
is_block_Üd”ed
 = 0;

102 
b»ak_ou‹r
;

104 
´ev_¿nk
 = 
cu¼_¿nk
;

109 
b»ak_ou‹r
:

111 
ş_‹am
->
is_block_Üd”ed
 = is_block_ordered;

114 *
Üd”ed
 = 
is_block_Üd”ed
;

116  
UCC_OK
;

117 
	}
}

119 
UCC_CL_HIER_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_ş_h›r_®lg©h”v_š™
,

120 (
cŞl_¬gs
, 
‹am
, 
sk
),

121 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

122 
ucc_cŞl_sk_t
 **
sk
)

124 
ucc_ş_h›r_‹am_t
 *
	gş_‹am
 = 
ucc_d”ived_of
(
‹am
,

125 
ucc_ş_h›r_‹am_t
);

126 
ucc_cŞl_sk_t
 *
	gsks
[
MAX_ALLGATHERV_TASKS
]

127 ğ{
NULL
};

128 
ucc_¿nk_t
 
	g¿nk
 = 
UCC_CL_TEAM_RANK
(
ş_‹am
);

129 
ucc_¿nk_t
 
	gnode_sbgp_size
 = 
SBGP_SIZE
(
ş_‹am
, 
NODE
);

130 
ucc_¿nk_t
 
	gËad”_sbgp_size
 = 
SBGP_SIZE
(
ş_‹am
, 
NODE_LEADERS
);

131 
ucc_¿nk_t
 
	g‹am_size
 = 
UCC_CL_TEAM_SIZE
(
ş_‹am
);

132 
ucc_tİo_t
 *
	gtİo
 = 
‹am
->
·¿ms
.‹am->
tİo
;

133 
ucc_ašt_t
 *
	gnode_di¥s
 = 
NULL
;

134 
ucc_couÁ_t
 *
	gnode_couÁs
 = 
NULL
;

135 
ucc_ašt_t
 *
	gËad”_di¥s
 = 
NULL
;

136 
ucc_couÁ_t
 *
	gËad”_couÁs
 = 
NULL
;

137 
size_t
 
	gdt_size
 = 
ucc_dt_size
(
cŞl_¬gs
->
¬gs
.

138 
d¡
.
šfo_v
.
d©©y³
);

139 
	gš_¶aû
 = 0;

140 
	gis_cÚtig
 = 1;

141 
size_t
 
	gdi¥_couÁ”
 = 0;

142 
ucc_scheduË_t
 *
	gscheduË
;

143 
ucc_ş_h›r_scheduË_t
 *
	gş_scheduË
;

144 
ucc_¡©us_t
 
	g¡©us
;

145 
ucc_ba£_cŞl_¬gs_t
 
	g¬gs
, 
	g¬gs_Şd
;

146 
	gn_sks
, 
	gi
;

147 
size_t
 
	gsü©ch_size
;

148 
size_t
 
	gnode_couÁs_size
;

149 
size_t
 
	gnode_di¥s_size
;

150 
size_t
 
	gËad”_couÁs_size
;

151 
size_t
 
	gËad”_di¥s_size
;

152 
size_t
 
	gtÙ®_couÁ
;

153 *
	gbufãr
;

154 *
	gnode_g©h”ed_d©a
;

155 
ucc_¿nk_t
 
	gËad”_‹am_¿nk
;

156 
ucc_¿nk_t
 
	gËad”_sbgp_¿nk
;

157 
ucc_¿nk_t
 
	g‹am_¿nk
;

158 
size_t
 
	gËad”_Şd_couÁ
;

159 
size_t
 
	gadd_couÁ
, 
	gÃw_couÁ
;

160 
	gblock_Üd”ed
;

161 
	gldr_sbgp_Úly
;

163 
memıy
(&
¬gs
, 
cŞl_¬gs
, (args));

164 
memıy
(&
¬gs_Şd
, 
cŞl_¬gs
, (
¬gs
));

166 
	gš_¶aû
 = 
UCC_IS_INPLACE
(
¬gs
.args);

168 ià(
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gmem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
 ||

169 (!
š_¶aû
 && 
¬gs
.¬gs.
¤c
.
šfo
.
mem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
) ||

170 
UCC_IS_PERSISTENT
(
¬gs
.args)) {

171  
UCC_ERR_NOT_SUPPORTED
;

174 
	gscheduË
 = &
ucc_ş_h›r_g‘_scheduË
(
ş_‹am
)->
su³r
.super;

175 ià(
ucc_uÆik–y
(!
scheduË
)) {

176  
	gUCC_ERR_NO_MEMORY
;

178 
	gş_scheduË
 = 
ucc_d”ived_of
(
scheduË
, 
ucc_ş_h›r_scheduË_t
);

180 
	gn_sks
 = 0;

181 
UCC_CHECK_GOTO
(
is_block_Üd”ed
(
ş_‹am
, &
block_Üd”ed
), 
ä“_sched
, 
¡©us
);

182 
	gis_cÚtig
 = 
block_Üd”ed
 && 
ucc_cŞl_¬gs_is_di¥_cÚtig
(&
¬gs
.¬gs, 
‹am_size
);

185 
	gldr_sbgp_Úly
 = !
SBGP_ENABLED
(
ş_‹am
, 
NODE
è&& SBGP_ENABLED(ş_‹am, 
NODE_LEADERS
);

187 
UCC_CHECK_GOTO
(
ucc_scheduË_š™
(
scheduË
, &
¬gs
, 
‹am
), 
ä“_sched
, 
¡©us
);

189 
	gnode_couÁs_size
 = 
node_sbgp_size
 * (
ucc_couÁ_t
);

190 
	gnode_di¥s_size
 = 
node_sbgp_size
 * (
ucc_ašt_t
);

191 
	gËad”_couÁs_size
 = 
Ëad”_sbgp_size
 * (
ucc_couÁ_t
);

192 
	gËad”_di¥s_size
 = 
Ëad”_sbgp_size
 * (
ucc_ašt_t
);

193 
	gtÙ®_couÁ
 = 
ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(&
¬gs
.args,

194 
¬gs
.¬gs.
d¡
.
šfo_v
.
couÁs
, 
‹am_size
);

195 
	gsü©ch_size
 = 
node_couÁs_size
 + 
node_di¥s_size


196 + 
Ëad”_couÁs_size
 + 
Ëad”_di¥s_size
;

198 
	gsü©ch_size
 +ğ(
is_cÚtig
 ? 0 : (
tÙ®_couÁ
 * 
dt_size
));

200 
UCC_CHECK_GOTO
(

201 
ucc_mc_®loc
(&
ş_scheduË
->
sü©ch
, 
sü©ch_size
, 
UCC_MEMORY_TYPE_HOST
),

202 
ä“_sched
, 
¡©us
);

203 
mem£t
(
ş_scheduË
->
sü©ch
->
addr
, 0, 
sü©ch_size
);

205 
	gnode_couÁs
 = 
PTR_OFFSET
(
ş_scheduË
->
sü©ch
->
addr
, 0);

206 
	gnode_di¥s
 = 
PTR_OFFSET
(
node_couÁs
, 
node_couÁs_size
);

207 
	gËad”_couÁs
 = 
PTR_OFFSET
(
node_di¥s
, 
node_di¥s_size
);

208 
	gËad”_di¥s
 = 
PTR_OFFSET
(
Ëad”_couÁs
, 
Ëad”_couÁs_size
);

209 ià(
	gis_cÚtig
) {

210 
	gbufãr
 = 
¬gs
.¬gs.
d¡
.
šfo_v
.
bufãr
;

212 
	gbufãr
 = 
PTR_OFFSET
(
Ëad”_di¥s
, 
Ëad”_di¥s_size
);

214 
	gnode_g©h”ed_d©a
 = 
NULL
;

220 if((
SBGP_ENABLED
(
ş_‹am
, 
NODE
è&& 
SBGP_EXISTS
(ş_‹am, 
NODE_LEADERS
)è|| 
	gldr_sbgp_Úly
) {

222 
	gi
 = 0; i < 
	g‹am_size
; i++) {

223 
UCC_CHECK_GOTO
(

224 
fšd_Ëad”_¿nk
(
‹am
, 
i
, &
Ëad”_‹am_¿nk
),

225 
ä“_sü©ch
, 
¡©us
);

226 
	gËad”_sbgp_¿nk
 = 
ucc_•_m­_loÿl_¿nk
(

227 
SBGP_MAP
(
ş_‹am
, 
NODE_LEADERS
),

228 
Ëad”_‹am_¿nk
);

229 
	gËad”_Şd_couÁ
 = 
ucc_cŞl_¬gs_g‘_couÁ
(

230 &
¬gs
.¬gs, 
Ëad”_couÁs
,

231 
Ëad”_sbgp_¿nk
);

232 
	gadd_couÁ
 = 
ucc_cŞl_¬gs_g‘_couÁ
(

233 &
¬gs
.args,

234 
¬gs
.¬gs.
d¡
.
šfo_v
.
couÁs
, 
i
);

235 
	gÃw_couÁ
 = 
add_couÁ
 + 
Ëad”_Şd_couÁ
;

236 
ucc_cŞl_¬gs_£t_couÁ
(&
¬gs
.¬gs, 
Ëad”_couÁs
,

237 
Ëad”_sbgp_¿nk
, 
Ãw_couÁ
);

242 
	gdi¥_couÁ”
 = 0;

243 
	gi
 = 0; i < 
	gËad”_sbgp_size
; i++) {

244 
ucc_cŞl_¬gs_£t_di¥Ïûm’t
(&
¬gs
.¬gs, 
Ëad”_di¥s
,

245 
i
, 
di¥_couÁ”
);

246 
	gdi¥_couÁ”
 +ğ
ucc_cŞl_¬gs_g‘_couÁ
(&
¬gs
.args,

247 
Ëad”_couÁs
,

248 
i
);

251 ià(
SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
)) {

252 
	gnode_g©h”ed_d©a
 = 
PTR_OFFSET
(
bufãr
,

253 
dt_size
 *

254 
ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

255 &
¬gs
.args,

256 
Ëad”_di¥s
,

257 
SBGP_RANK
(
ş_‹am
, 
NODE_LEADERS
))

262 ià(
SBGP_ENABLED
(
ş_‹am
, 
NODE
)) {

263 
ucc_as£¹
(
n_sks
 == 0);

264 ià(
	gş_‹am
->
	gtİ_sbgp
 =ğ
UCC_HIER_SBGP_NODE
) {

265 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLGATHERV
;

267 
	gdi¥_couÁ”
 = 0;

268 
	gi
 = 0; i < 
	gnode_sbgp_size
; i++) {

269 
	g‹am_¿nk
 =

270 
ucc_•_m­_ev®
(
SBGP_MAP
(
ş_‹am
, 
NODE
), 
i
);

271 
ucc_cŞl_¬gs_£t_couÁ
(

272 &
¬gs
.¬gs, 
node_couÁs
, 
i
,

273 
ucc_cŞl_¬gs_g‘_couÁ
(&
¬gs
.args,

274 
¬gs
.¬gs.
d¡
.
šfo_v
.
couÁs
,

275 
‹am_¿nk
));

276 
ucc_cŞl_¬gs_£t_di¥Ïûm’t
(&
¬gs
.¬gs, 
node_di¥s
,

277 
i
, 
di¥_couÁ”
);

278 
	gdi¥_couÁ”
 +ğ
ucc_cŞl_¬gs_g‘_couÁ
(&
¬gs
.args,

279 
node_couÁs
, 
i
);

282 ià(
	gš_¶aû
) {

283 
	g¬gs
.¬gs.
	g¤c
.
	gšfo
.
	gbufãr
 =

284 
PTR_OFFSET
(
¬gs
.¬gs.
d¡
.
šfo_v
.
bufãr
,

285 
dt_size
 * 
ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

286 &
¬gs
.args,

287 
¬gs
.¬gs.
d¡
.
šfo_v
.
di¥Ïûm’ts
,

288 
¿nk
));

289 
	g¬gs
.¬gs.
	g¤c
.
	gšfo
.
	gcouÁ
 =

290 
ucc_cŞl_¬gs_g‘_couÁ
(&
¬gs
.args,

291 
¬gs
.¬gs.
d¡
.
šfo_v
.
couÁs
,

292 
¿nk
);

293 
	g¬gs
.¬gs.
	g¤c
.
	gšfo
.
	gd©©y³
 = 
¬gs
.¬gs.
d¡
.
šfo_v
.
d©©y³
;

294 
	g¬gs
.¬gs.
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
¬gs
.¬gs.
d¡
.
šfo_v
.
mem_ty³
;

297 
	g¬gs
.¬gs.
	gcŞl_ty³
 = 
UCC_COLL_TYPE_GATHERV
;

298 
	g¬gs
.¬gs.
	groÙ
 = 
tİo
->
node_Ëad”_¿nk_id
;

299 
	g¬gs
.¬gs.
	gæags
 &ğ~
UCC_COLL_ARGS_FLAG_IN_PLACE
;

300 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = 
node_di¥s
;

301 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gcouÁs
 = 
node_couÁs
;

302 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gbufãr
 = 
node_g©h”ed_d©a
;

304 
	g¬gs
.
	gmask
 |ğ
UCC_BASE_CARGS_NONROOT_INFO
;

306 
UCC_CHECK_GOTO
(

307 
ucc_cŞl_š™
(
SCORE_MAP
(
ş_‹am
, 
NODE
), &
¬gs
, &
sks
[
n_sks
]),

308 
ä“_sü©ch
, 
¡©us
);

309 
	gn_sks
++;

312 
	g¬gs
 = 
¬gs_Şd
;

315 ià(
	gldr_sbgp_Úly
) {

318 
ucc_as£¹
(
node_g©h”ed_d©a
 !ğ
NULL
);

319 ià(!
	gš_¶aû
) {

321 
memıy
(
node_g©h”ed_d©a
, 
¬gs
.¬gs.
¤c
.
šfo
.
bufãr
,‡rgs.¬gs.¤c.šfo.
couÁ
 * 
ucc_dt_size
×rgs.¬gs.¤c.šfo.
d©©y³
));

322 } ià(!
	gis_cÚtig
) {

324 
memıy
(
node_g©h”ed_d©a
,

325 
PTR_OFFSET
(
¬gs
.¬gs.
d¡
.
šfo_v
.
bufãr
,

326 
dt_size
 * 
ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(&
¬gs
.¬gs,‡rgs.¬gs.
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
¿nk
)),

327 
dt_size
 * 
ucc_cŞl_¬gs_g‘_couÁ
(&
¬gs
.¬gs,‡rgs.¬gs.
d¡
.
šfo_v
.
couÁs
, 
¿nk
));

331 
	g¬gs
 = 
¬gs_Şd
;

333 ià(
SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
)) {

334 
ucc_as£¹
(
ş_‹am
->
tİ_sbgp
 =ğ
UCC_HIER_SBGP_NODE_LEADERS
);

335 
	g¬gs
.¬gs.
	gcŞl_ty³
 = 
UCC_COLL_TYPE_ALLGATHERV
;

336 
	g¬gs
.¬gs.
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

337 
	g¬gs
.¬gs.
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

338 
	g¬gs
.¬gs.
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
;

339 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gbufãr
 = 
bufãr
;

340 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = 
Ëad”_di¥s
;

341 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gcouÁs
 = 
Ëad”_couÁs
;

342 
UCC_CHECK_GOTO
(
ucc_cŞl_š™
(
SCORE_MAP
(
ş_‹am
, 
NODE_LEADERS
), &
¬gs
,

343 &
sks
[
n_sks
]),

344 
ä“_sü©ch
, 
¡©us
);

345 
	gn_sks
++;

348 ià(
	gş_‹am
->
	gtİ_sbgp
 !ğ
UCC_HIER_SBGP_NODE
) {

349 
¬gs
 = 
¬gs_Şd
;

350 ià(
SBGP_ENABLED
(
ş_‹am
, 
NODE
)) {

351 
	g¬gs
.¬gs.
	gcŞl_ty³
 = 
UCC_COLL_TYPE_BCAST
;

352 
	g¬gs
.¬gs.
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

353 
	g¬gs
.¬gs.
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

354 
	g¬gs
.¬gs.
	groÙ
 = 
tİo
->
node_Ëad”_¿nk_id
;

355 
	g¬gs
.¬gs.
	g¤c
.
	gšfo
.
	gbufãr
 = 
bufãr
;

356 
	g¬gs
.¬gs.
	g¤c
.
	gšfo
.
	gcouÁ
 = 
tÙ®_couÁ
;

357 
	g¬gs
.¬gs.
	g¤c
.
	gšfo
.
	gd©©y³
 = 
¬gs_Şd
.
¬gs
.
d¡
.
šfo_v
.
d©©y³
;

358 
	g¬gs
.¬gs.
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
¬gs_Şd
.
¬gs
.
d¡
.
šfo_v
.
mem_ty³
;

362 
UCC_CHECK_GOTO
(

363 
ucc_cŞl_š™
(
SCORE_MAP
(
ş_‹am
, 
NODE
), &
¬gs
, &
sks
[
n_sks
]),

364 
ä“_sü©ch
, 
¡©us
);

365 
	gn_sks
++;

368 ià(!
	gis_cÚtig
) {

369 
	g¬gs
 = 
¬gs_Şd
;

370 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gd©©y³
 = 
¬gs
.¬gs.
d¡
.
šfo_v
.
d©©y³
;

371 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gmem_ty³
 = 
¬gs
.¬gs.
d¡
.
šfo_v
.
mem_ty³
;

372 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gbufãr
 = 
bufãr
;

375 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = 
Ëad”_di¥s
;

376 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gcouÁs
 = 
Ëad”_couÁs
;

378 
UCC_CHECK_GOTO
(

379 
ucc_ş_h›r_®lg©h”v_uÅack_š™
(&
¬gs
, 
‹am
, &
sks
[
n_sks
]),

380 
ä“_sü©ch
, 
¡©us
);

381 
	gn_sks
++;

385 
UCC_CHECK_GOTO
(
ucc_ev’t_mªag”_subsüibe
(

386 &
scheduË
->
su³r
, 
UCC_EVENT_SCHEDULE_STARTED
, 
sks
[0],

387 
ucc_sk_¡¬t_hªdËr
),

388 
ä“_sü©ch
, 
¡©us
);

389 
UCC_CHECK_GOTO
(

390 
ucc_scheduË_add_sk
(
scheduË
, 
sks
[0]), 
ä“_sü©ch
, 
¡©us
);

391 
	gi
 = 1; i < 
	gn_sks
; i++) {

392 
UCC_CHECK_GOTO
(

393 
ucc_ev’t_mªag”_subsüibe
(
sks
[
i
 - 1], 
UCC_EVENT_COMPLETED
,

394 
sks
[
i
], 
ucc_sk_¡¬t_hªdËr
),

395 
ä“_sü©ch
, 
¡©us
);

396 
UCC_CHECK_GOTO
(

397 
ucc_scheduË_add_sk
(
scheduË
, 
sks
[
i
]), 
ä“_sü©ch
, 
¡©us
);

400 
	gscheduË
->
	gsu³r
.
	gæags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

401 
	gscheduË
->
	gsu³r
.
	gpo¡
 = 
ucc_ş_h›r_®lg©h”v_¡¬t
;

402 
	gscheduË
->
	gsu³r
.
	gfš®ize
 = 
ucc_ş_h›r_®lg©h”v_fš®ize
;

403 *
	gsk
 = &
scheduË
->
su³r
;

404  
	gUCC_OK
;

406 
	gä“_sü©ch
:

407 
ucc_mc_ä“
(
ş_scheduË
->
sü©ch
);

408 
	gä“_sched
:

409 
i
 = 0; 
	gi
 < 
	gn_sks
; i++) {

410 
	gsks
[
i
]->
fš®ize
(
sks
[i]);

412 
ucc_ş_h›r_put_scheduË
(
scheduË
);

413 
ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "failedo init cl hier‡llgatherv");

414  
	g¡©us
;

	@src/components/cl/hier/allgatherv/allgatherv.h

7 #iâdeà
ALLGATHERV_H_


8 
	#ALLGATHERV_H_


	)

9 
	~"../ş_h›r.h
"

13 
	mUCC_CL_HIER_ALLGATHERV_ALG_GAB
,

14 
	mUCC_CL_HIER_ALLGATHERV_ALG_LAST
,

17 
ucc_ba£_cŞl_®g_šfo_t


18 
ucc_ş_h›r_®lg©h”v_®gs
[
UCC_CL_HIER_ALLGATHERV_ALG_LAST
 + 1];

20 
	#UCC_CL_HIER_ALLGATHERV_DEFAULT_ALG_SELECT_STR
 "®lg©h”v:0-8m:ho¡:@gab"

	)

22 
ucc_¡©us_t
 
ucc_ş_h›r_®lg©h”v_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

23 
ucc_ba£_‹am_t
 *
‹am
,

24 
ucc_cŞl_sk_t
 **
sk
);

26 
šlše
 
	$ucc_ş_h›r_®lg©h”v_®g_äom_¡r
(cÚ¡ *
¡r
)

28 
i
;

29 
i
 = 0; i < 
UCC_CL_HIER_ALLGATHERV_ALG_LAST
; i++) {

30 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc_ş_h›r_®lg©h”v_®gs
[
i
].
Çme
)) {

34  
i
;

35 
	}
}

	@src/components/cl/hier/allgatherv/unpack.c

7 
	~"uÅack.h
"

9 
ucc_¡©us_t
 
	$ucc_ş_h›r_®lg©h”v_uÅack_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

11 
ucc_ş_h›r_scheduË_t
 *
ş_scheduË
 = 
	`ucc_d”ived_of
(
sk
,

12 
ucc_ş_h›r_scheduË_t
);

14 
	`ucc_mc_ä“
(
ş_scheduË
->
sü©ch
);

15 
	`ucc_ş_h›r_put_scheduË
(&
ş_scheduË
->
su³r
.super);

17  
UCC_OK
;

18 
	}
}

20 
	$ucc_ş_h›r_®lg©h”v_uÅack_´og»ss
(
ucc_cŞl_sk_t
 *
sk
)

22 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

23 
ucc_ş_h›r_scheduË_t
 *
ş_scheduË
 = 
	`ucc_d”ived_of
(
scheduË
,

24 
ucc_ş_h›r_scheduË_t
);

25 
ucc_¿nk_t
 *
n_sks
 = 
ş_scheduË
->
sü©ch
->
addr
;

26 
ucc_“_executÜ_sk_t
 **
sks
 = 
	`PTR_OFFSET
(

27 
ş_scheduË
->
sü©ch
->
addr
,

28 (
ucc_¿nk_t
));

29 
ucc_¡©us_t
 
¡
 = 
UCC_OK
;

30 
ucc_¿nk_t
 
i
;

31 
ucc_“_executÜ_sk_t
 *
‘ask
;

33 
i
 = 0; i < *
n_sks
; i++) {

34 
‘ask
 = 
sks
[
i
];

35 ià(
‘ask
 !ğ
NULL
) {

36 
¡
 = 
	`ucc_“_executÜ_sk_‹¡
(
‘ask
);

37 ià(
¡
 =ğ
UCC_OK
) {

38 
	`ucc_“_executÜ_sk_fš®ize
(
‘ask
);

39 
sks
[
i
] = 
NULL
;

41 ià(
	`ucc_lik–y
(
¡
 > 0)) {

42 
¡
 = 
UCC_INPROGRESS
;

44 
out
;

49 
out
:

50 
scheduË
->
su³r
.
¡©us
 = 
¡
;

51 
	}
}

53 
ucc_¡©us_t
 
	$ucc_ş_h›r_®lg©h”v_uÅack_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

55 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
,

56 
ucc_scheduË_t
);

57 
ucc_ş_h›r_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
sk
->
‹am
,

58 
ucc_ş_h›r_‹am_t
);

59 
ucc_¿nk_t
 
‹am_size
 = 
	`UCC_CL_TEAM_SIZE
(
ş_‹am
);

60 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
sk
->
b¬gs
.args;

61 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
 = {0};

62 
ucc_ş_h›r_scheduË_t
 *
ş_scheduË
 = 
	`ucc_d”ived_of
(
scheduË
,

63 
ucc_ş_h›r_scheduË_t
);

64 
ucc_¿nk_t
 *
n_sks
 = 
ş_scheduË
->
sü©ch
->
addr
;

65 
ucc_“_executÜ_sk_t
 **
sks
 = 
	`PTR_OFFSET
(

66 
ş_scheduË
->
sü©ch
->
addr
,

67 (
ucc_¿nk_t
));

68 
size_t
 
¤c_dt_size
 = 
	`ucc_dt_size
(

69 
¬gs
->
¤c
.
šfo_v
.
d©©y³
);

70 
size_t
 
d¡_dt_size
 = 
	`ucc_dt_size
(

71 
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

72 
ucc_¿nk_t
 *
node_Ëad”s
 = 
NULL
;

73 
ucc_sbgp_t
 *
®l_nodes
 = 
NULL
;

74 
ucc_sbgp_t
 *
node_Ëad”s_sbgp
 = 
NULL
;

75 
ucc_tİo_t
 *
tİo
 = 
sk
->
‹am
->
·¿ms
.team->topo;

76 
ucc_“_executÜ_t
 *
exec
;

77 
ucc_¡©us_t
 
¡©us
;

78 
ucc_¿nk_t
 
i
;

79 
size_t
 
d¡_¿nk_couÁ
;

80 
size_t
 
d¡_¿nk_di¥
;

81 
ucc_¿nk_t
 
cu¼_‹am_¿nk
;

82 
n_nodes
;

83 
ucc_¿nk_t
 
node_Ëad”_idx
;

84 
size_t
 
¤c_¿nk_di¥
;

86 
	`UCC_CHECK_GOTO
(

87 
	`ucc_cŞl_sk_g‘_executÜ
(&
scheduË
->
su³r
, &
exec
),

88 
out
, 
¡©us
);

89 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

91 *
n_sks
 = 0;

94 
	`UCC_CHECK_GOTO
(

95 
	`ucc_tİo_g‘_node_Ëad”s
(
tİo
, &
node_Ëad”s
),

96 
out
, 
¡©us
);

99 
node_Ëad”s_sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

100 ià(!
	`SBGP_EXISTS
(
ş_‹am
, 
NODE_LEADERS
)) {

101 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

102 
out
;

105 
	`UCC_CHECK_GOTO
(

106 
	`ucc_tİo_g‘_®l_nodes
(
tİo
, &
®l_nodes
, &
n_nodes
),

107 
out
, 
¡©us
);

109 
i
 = 0; i < 
‹am_size
; i++) {

111 
d¡_¿nk_couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(

112 
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
i
);

113 
d¡_¿nk_di¥
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

114 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
i
);

117 
ucc_¿nk_t
 
Ëad”_‹am_¿nk
 = 
node_Ëad”s
[
i
];

120 
node_Ëad”_idx
 = 
	`ucc_•_m­_loÿl_¿nk
(
node_Ëad”s_sbgp
->
m­
,

121 
Ëad”_‹am_¿nk
);

124 
¤c_¿nk_di¥
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

125 
¬gs
,‡rgs->
¤c
.
šfo_v
.
di¥Ïûm’ts
, 
node_Ëad”_idx
);

127 
ucc_¿nk_t
 
j
 = 0; j < 
®l_nodes
[
node_Ëad”_idx
].
group_size
; j++) {

128 ià(
®l_nodes
[
node_Ëad”_idx
].
group_size
 == 1) {

132 
cu¼_‹am_¿nk
 = 
	`ucc_•_m­_ev®
(
®l_nodes
[
node_Ëad”_idx
].
m­
, 
j
);

133 ià(
cu¼_‹am_¿nk
 =ğ
i
) {

138 
¤c_¿nk_di¥
 +ğ
	`ucc_cŞl_¬gs_g‘_couÁ
(

139 
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
,

140 
cu¼_‹am_¿nk
);

143 
—rgs
.
cİy
.
¤c
 = 
	`PTR_OFFSET
(
¬gs
->¤c.
šfo_v
.
bufãr
,

144 
¤c_¿nk_di¥
 * 
¤c_dt_size
);

145 
—rgs
.
cİy
.
d¡
 = 
	`PTR_OFFSET
(
¬gs
->d¡.
šfo_v
.
bufãr
,

146 
d¡_¿nk_di¥
 * 
d¡_dt_size
);

147 
—rgs
.
cİy
.
Ën
 = 
d¡_¿nk_couÁ
 * 
d¡_dt_size
;

149 ià(
—rgs
.
cİy
.
¤c
 !ğ—rgs.cİy.
d¡
) {

150 
	`UCC_CHECK_GOTO
(

151 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
, &
sks
[*
n_sks
]),

152 
out
, 
¡©us
);

153 (*
n_sks
)++;

157 
scheduË
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

159 
	`ucc_´og»ss_queue_’queue
(
ş_‹am
->
su³r
.su³r.
cÚ‹xt
->
ucc_cÚ‹xt
->
pq
,

160 
sk
);

162  
UCC_OK
;

163 
out
:

164  
¡©us
;

165 
	}
}

167 
ucc_¡©us_t
 
	$ucc_ş_h›r_®lg©h”v_uÅack_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

168 
ucc_ba£_‹am_t
 *
‹am
,

169 
ucc_cŞl_sk_t
 **
sk_h
)

171 
ucc_ş_h›r_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

172 
ucc_¿nk_t
 
‹am_size
 = 
	`UCC_CL_TEAM_SIZE
(
ş_‹am
);

173 
ucc_¡©us_t
 
¡©us
;

174 
ucc_scheduË_t
 *
scheduË
;

175 
ucc_ş_h›r_scheduË_t
 *
ş_scheduË
;

176 
size_t
 
sü©ch_size
;

178 
scheduË
 = &
	`ucc_ş_h›r_g‘_scheduË
(
ş_‹am
)->
su³r
.super;

179 ià(
	`ucc_uÆik–y
(!
scheduË
)) {

180  
UCC_ERR_NO_MEMORY
;

182 
ş_scheduË
 = 
	`ucc_d”ived_of
(
scheduË
, 
ucc_ş_h›r_scheduË_t
);

184 
	`UCC_CHECK_GOTO
(

185 
	`ucc_scheduË_š™
(
scheduË
, 
cŞl_¬gs
, 
‹am
), 
ä“_scheduË
, 
¡©us
);

188 
sü©ch_size
 = (
ucc_¿nk_t
è+ 
‹am_size
 * (
ucc_“_executÜ_sk_t
*);

189 
	`UCC_CHECK_GOTO
(

190 
	`ucc_mc_®loc
(&
ş_scheduË
->
sü©ch
, 
sü©ch_size
, 
UCC_MEMORY_TYPE_HOST
),

191 
ä“_scheduË
, 
¡©us
);

193 
scheduË
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

194 
scheduË
->
su³r
.
po¡
 = 
ucc_ş_h›r_®lg©h”v_uÅack_¡¬t
;

195 
scheduË
->
su³r
.
´og»ss
 = 
ucc_ş_h›r_®lg©h”v_uÅack_´og»ss
;

196 
scheduË
->
su³r
.
fš®ize
 = 
ucc_ş_h›r_®lg©h”v_uÅack_fš®ize
;

198 *
sk_h
 = &
scheduË
->
su³r
;

200  
UCC_OK
;

202 
ä“_scheduË
:

203 
	`ucc_ş_h›r_put_scheduË
(
scheduË
);

204  
¡©us
;

205 
	}
}

	@src/components/cl/hier/allgatherv/unpack.h

7 
	~"../ş_h›r_cŞl.h
"

8 
	~"cÜe/ucc_‹am.h
"

10 
ucc_¡©us_t
 
ucc_ş_h›r_®lg©h”v_uÅack_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

11 
ucc_ba£_‹am_t
 *
‹am
,

12 
ucc_cŞl_sk_t
 **
sk_h
);

13 
ucc_¡©us_t
 
ucc_ş_h›r_®lg©h”v_uÅack_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

14 
ucc_ş_h›r_®lg©h”v_uÅack_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

15 
ucc_¡©us_t
 
ucc_ş_h›r_®lg©h”v_uÅack_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

	@src/components/cl/hier/allreduce/allreduce.c

7 
	~"®Ìeduû.h
"

8 
	~"../®Ìeduû/®Ìeduû.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc_ş_h›r_®Ìeduû_®gs
[
UCC_CL_HIER_ALLREDUCE_ALG_LAST
 + 1] = {

12 [
UCC_CL_HIER_ALLREDUCE_ALG_RAB
] =

13 {.
id
 = 
UCC_CL_HIER_ALLREDUCE_ALG_RAB
,

14 .
	gÇme
 = "rab",

15 .
	gdesc
 = "intra-node„educe, followed by inter-node‡llreduce,"

17 [
UCC_CL_HIER_ALLREDUCE_ALG_SPLIT_RAIL
] =

18 {.
id
 = 
UCC_CL_HIER_ALLREDUCE_ALG_SPLIT_RAIL
,

19 .
	gÇme
 = "split_rail",

20 .
	gdesc
 = "intra-node„educe_scatter, followed by PPN concurrent "

22 [
UCC_CL_HIER_ALLREDUCE_ALG_LAST
] = {

23 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

	@src/components/cl/hier/allreduce/allreduce.h

7 #iâdeà
ALLREDUCE_H_


8 
	#ALLREDUCE_H_


	)

9 
	~"../ş_h›r.h
"

13 
	mUCC_CL_HIER_ALLREDUCE_ALG_RAB
,

14 
	mUCC_CL_HIER_ALLREDUCE_ALG_SPLIT_RAIL
,

15 
	mUCC_CL_HIER_ALLREDUCE_ALG_LAST
,

18 
ucc_ba£_cŞl_®g_šfo_t


19 
ucc_ş_h›r_®Ìeduû_®gs
[
UCC_CL_HIER_ALLREDUCE_ALG_LAST
 + 1];

21 
	#UCC_CL_HIER_ALLREDUCE_DEFAULT_ALG_SELECT_STR
 "®Ìeduû:0-4k:@¿b"

	)

23 
ucc_¡©us_t
 
ucc_ş_h›r_®Ìeduû_¿b_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

24 
ucc_ba£_‹am_t
 *
‹am
,

25 
ucc_cŞl_sk_t
 **
sk
);

27 
ucc_¡©us_t


28 
ucc_ş_h›r_®Ìeduû_¥l™_¿_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

29 
ucc_ba£_‹am_t
 *
‹am
,

30 
ucc_cŞl_sk_t
 **
sk
);

32 
šlše
 
	$ucc_ş_h›r_®Ìeduû_®g_äom_¡r
(cÚ¡ *
¡r
)

34 
i
;

36 
i
 = 0; i < 
UCC_CL_HIER_ALLREDUCE_ALG_LAST
; i++) {

37 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc_ş_h›r_®Ìeduû_®gs
[
i
].
Çme
)) {

41  
i
;

42 
	}
}

	@src/components/cl/hier/allreduce/allreduce_rab.c

7 
	~"®Ìeduû.h
"

8 
	~"../ş_h›r_cŞl.h
"

10 
	#MAX_AR_RAB_TASKS
 3

	)

12 
ucc_¡©us_t
 
	$ucc_ş_h›r_®Ìeduû_¿b_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

14 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_allreduce_rab_start", 0);

15  
	`ucc_scheduË_¡¬t
(
sk
);

16 
	}
}

18 
ucc_¡©us_t
 
	$ucc_ş_h›r_®Ìeduû_¿b_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

20 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

21 
ucc_¡©us_t
 
¡©us
;

23 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_allreduce_rab_finalize",

25 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

26 
	`ucc_ş_h›r_put_scheduË
(
scheduË
);

27  
¡©us
;

28 
	}
}

30 
ucc_¡©us_t
 
	$ucc_ş_h›r_¬_¿b_scheduË_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

32 
ucc_ş_h›r_scheduË_t
 *
scheduË
 =

33 
	`ucc_d”ived_of
(
sk
, 
ucc_ş_h›r_scheduË_t
);

34 
ucc_¡©us_t
 
¡©us
;

36 
¡©us
 = 
	`ucc_scheduË_p–šed_fš®ize
(&
scheduË
->
su³r
.super.super);

37 
	`ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

38  
¡©us
;

39 
	}
}

41 
ucc_¡©us_t


42 
	$ucc_ş_h›r_®Ìeduû_¿b_äag_£tup
(
ucc_scheduË_p–šed_t
 *
scheduË_p
,

43 
ucc_scheduË_t
 *
äag
, 
äag_num
)

45 
ucc_ş_h›r_‹am_t
 *
ş_‹am
 =

46 
	`ucc_d”ived_of
(
scheduË_p
->
su³r
.su³r.
‹am
, 
ucc_ş_h›r_‹am_t
);

47 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
scheduË_p
->
su³r
.su³r.
b¬gs
.args;

48 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

49 
n_äags
 = 
scheduË_p
->
su³r
.
n_sks
;

50 
š¶aû
 = 
	`UCC_IS_INPLACE
(*
¬gs
);

51 
size_t
 
äag_couÁ
, 
äag_off£t
;

52 
ucc_cŞl_sk_t
 *
sk
;

53 
i
;

55 
äag_couÁ
 =

56 
	`ucc_bufãr_block_couÁ
(
¬gs
->
d¡
.
šfo
.
couÁ
, 
n_äags
, 
äag_num
);

57 
äag_off£t
 =

58 
	`ucc_bufãr_block_off£t
(
¬gs
->
d¡
.
šfo
.
couÁ
, 
n_äags
, 
äag_num
);

60 
i
 = 0; i < 
äag
->
n_sks
; i++) {

61 
sk
 = 
äag
->
sks
[
i
];

62 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 = 
äag_couÁ
;

63 
sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
 = 
äag_couÁ
;

64 
sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
bufãr
 =

65 
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.
bufãr
, 
äag_off£t
 * 
dt_size
);

66 ià((
sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
) ||

67 (
sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE
 && 
š¶aû
 &&

68 (
	`SBGP_RANK
(
ş_‹am
, 
NODE
è!ğ
¬gs
->
roÙ
))) {

69 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 =

70 
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.
bufãr
, 
äag_off£t
 * 
dt_size
);

72 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 =

73 
	`PTR_OFFSET
(
¬gs
->
¤c
.
šfo
.
bufãr
, 
äag_off£t
 * 
dt_size
);

76  
UCC_OK
;

77 
	}
}

79 
ucc_¡©us_t


80 
	$ucc_ş_h›r_®Ìeduû_¿b_š™_scheduË
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

81 
ucc_ba£_‹am_t
 *
‹am
,

82 
ucc_scheduË_t
 **
sched_p
, 
n_äags
)

84 
ucc_ş_h›r_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

85 
ucc_cŞl_sk_t
 *
sks
[
MAX_AR_RAB_TASKS
] = {
NULL
};

86 
ucc_scheduË_t
 *
scheduË
;

87 
ucc_¡©us_t
 
¡©us
;

88 
ucc_ba£_cŞl_¬gs_t
 
¬gs
;

89 
n_sks
, 
i
;

91 
scheduË
 = &
	`ucc_ş_h›r_g‘_scheduË
(
ş_‹am
)->
su³r
.super;

92 ià(
	`ucc_uÆik–y
(!
scheduË
)) {

93  
UCC_ERR_NO_MEMORY
;

96 
¬gs
 = *
cŞl_¬gs
;

97 
¬gs
.¬gs.
roÙ
 = 0;

98 
n_sks
 = 0;

99 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_š™
(
scheduË
, &
¬gs
, 
‹am
), 
out
, 
¡©us
);

101 ià(
n_äags
 > 1) {

102 
¬gs
.
max_äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
×rgs.¬gs.
d¡
.
šfo
.
couÁ
,

103 
n_äags
, 0);

104 
¬gs
.
mask
 |ğ
UCC_BASE_CARGS_MAX_FRAG_COUNT
;

106 
	`ucc_as£¹
(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE
) ||

107 
	`SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
));

109 ià(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE
)) {

110 
	`ucc_as£¹
(
n_sks
 == 0);

111 ià(
ş_‹am
->
tİ_sbgp
 =ğ
UCC_HIER_SBGP_NODE
) {

112 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLREDUCE
;

114 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_REDUCE
;

115 ià(
	`UCC_IS_INPLACE
(
¬gs
.args) &&

116 (
	`SBGP_RANK
(
ş_‹am
, 
NODE
è!ğ
¬gs
.¬gs.
roÙ
)) {

117 
¬gs
.¬gs.
¤c
.
šfo
 =‡rgs.¬gs.
d¡
.info;

120 
	`UCC_CHECK_GOTO
(

121 
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NODE
), &
¬gs
, &
sks
[
n_sks
]),

122 
out
, 
¡©us
);

123 
n_sks
++;

124 
¬gs
.¬gs.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

125 
¬gs
.¬gs.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

128 ià(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
)) {

129 
	`ucc_as£¹
(
ş_‹am
->
tİ_sbgp
 =ğ
UCC_HIER_SBGP_NODE_LEADERS
);

130 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLREDUCE
;

131 
	`UCC_CHECK_GOTO
(
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NODE_LEADERS
), &
¬gs
,

132 &
sks
[
n_sks
]),

133 
out
, 
¡©us
);

134 
n_sks
++;

138 ià(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE
) &&

139 
ş_‹am
->
tİ_sbgp
 !ğ
UCC_HIER_SBGP_NODE
) {

141 
¬gs
.¬gs.
¤c
.
šfo
 =‡rgs.¬gs.
d¡
.info;

142 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_BCAST
;

143 
	`UCC_CHECK_GOTO
(

144 
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NODE
), &
¬gs
, &
sks
[
n_sks
]),

145 
out
, 
¡©us
);

146 
n_sks
++;

152 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sks
[0]), 
out
, 
¡©us
);

153 ià(
n_äags
 > 1) {

154 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(&
scheduË
->
su³r
, 
sks
[0],

155 
UCC_EVENT_SCHEDULE_STARTED
),

156 
out
, 
¡©us
);

157 
i
 = 1; i < 
n_sks
; i++) {

158 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sks
[
i
]), 
out
, 
¡©us
);

159 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(
sks
[
i
-1],asks[i],

160 
UCC_EVENT_COMPLETED
),

161 
out
, 
¡©us
);

164 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(

165 &
scheduË
->
su³r
, 
UCC_EVENT_SCHEDULE_STARTED
, 
sks
[0],

166 
ucc_sk_¡¬t_hªdËr
),

167 
out
, 
¡©us
);

168 
i
 = 1; i < 
n_sks
; i++) {

169 
	`UCC_CHECK_GOTO
(

170 
	`ucc_ev’t_mªag”_subsüibe
(
sks
[
i
 - 1], 
UCC_EVENT_COMPLETED
,

171 
sks
[
i
], 
ucc_sk_¡¬t_hªdËr
),

172 
out
, 
¡©us
);

173 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sks
[
i
]), 
out
,

174 
¡©us
);

178 
scheduË
->
su³r
.
po¡
 = 
ucc_ş_h›r_®Ìeduû_¿b_¡¬t
;

179 
scheduË
->
su³r
.
´og»ss
 = 
NULL
;

180 
scheduË
->
su³r
.
fš®ize
 = 
ucc_ş_h›r_®Ìeduû_¿b_fš®ize
;

181 *
sched_p
 = 
scheduË
;

182  
UCC_OK
;

184 
out
:

185 
i
 = 0; i < 
n_sks
; i++) {

186 
sks
[
i
]->
	`fš®ize
(tasks[i]);

188 
	`ucc_ş_h›r_put_scheduË
(
scheduË
);

189  
¡©us
;

190 
	}
}

192 
ucc_¡©us_t
 
	$ucc_ş_h›r_®Ìeduû_¿b_äag_š™
(

193 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_scheduË_p–šed_t
 *
¥
,

194 
ucc_ba£_‹am_t
 *
‹am
, 
ucc_scheduË_t
 **
äag_p
)

196 
n_äags
 = 
¥
->
su³r
.
n_sks
;

197 
ucc_¡©us_t
 
¡©us
;

199 
¡©us
 = 
	`ucc_ş_h›r_®Ìeduû_¿b_š™_scheduË
(
cŞl_¬gs
, 
‹am
, 
äag_p
,

200 
n_äags
);

201  
¡©us
;

202 
	}
}

204 
ucc_¡©us_t
 
	$ucc_ş_h›r_¿b_®Ìeduû_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

206 
ucc_scheduË_p–šed_t
 *
scheduË
 =

207 
	`ucc_d”ived_of
(
sk
, 
ucc_scheduË_p–šed_t
);

209 
	`ş_debug
(
sk
->
‹am
->
cÚ‹xt
->
lib
,

212 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
,ask->b¬gs.¬gs.
d¡
.info.buffer,

213 
sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
,

214 
	`ucc_d©©y³_¡r
(
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
d©©y³
),

215 
	`ucc_»duùiÚ_İ_¡r
(
sk
->
b¬gs
.
¬gs
.
İ
),

216 
	`UCC_IS_INPLACE
(
sk
->
b¬gs
.
¬gs
), 
scheduË
->
n_äags
,

217 
scheduË
->
su³r
.
n_sks
);

219  
	`ucc_scheduË_p–šed_po¡
(
sk
);

220 
	}
}

222 
UCC_CL_HIER_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_ş_h›r_®Ìeduû_¿b_š™
,

223 (
cŞl_¬gs
, 
‹am
, 
sk
),

224 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

225 
ucc_cŞl_sk_t
 **
sk
)

227 
ucc_ş_h›r_‹am_t
 *
	gş_‹am
 = 
ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

228 
ucc_ş_h›r_lib_cÚfig_t
 *
	gcfg
 = &
UCC_CL_HIER_TEAM_LIB
(
ş_‹am
)->
cfg
;

229 
ucc_ş_h›r_scheduË_t
 *
	gscheduË
;

230 
	gn_äags
, 
	gp–še_d•th
;

231 
ucc_¡©us_t
 
	g¡©us
;

233 ià(
	gcŞl_¬gs
->
	g¬gs
.
	gİ
 =ğ
UCC_OP_AVG
) {

234  
UCC_ERR_NOT_SUPPORTED
;

236 
ucc_p–še_näags_pd•th
(&
cfg
->
®Ìeduû_¿b_p–še
,

237 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
couÁ
 *

238 
ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
),

239 &
n_äags
, &
p–še_d•th
);

241 ià(
	gn_äags
 == 1) {

242  
ucc_ş_h›r_®Ìeduû_¿b_š™_scheduË
(

243 
cŞl_¬gs
, 
‹am
, (
ucc_scheduË_t
 **)
sk
, 
n_äags
);

246 
	gscheduË
 = 
ucc_ş_h›r_g‘_scheduË
(
ş_‹am
);

247 ià(
ucc_uÆik–y
(!
scheduË
)) {

248  
	gUCC_ERR_NO_MEMORY
;

251 
	g¡©us
 = 
ucc_scheduË_p–šed_š™
(

252 
cŞl_¬gs
, 
‹am
, 
ucc_ş_h›r_®Ìeduû_¿b_äag_š™
,

253 
ucc_ş_h›r_®Ìeduû_¿b_äag_£tup
, 
p–še_d•th
, 
n_äags
,

254 
cfg
->
®Ìeduû_¿b_p–še
.
Üd”
, &
scheduË
->
su³r
);

256 ià(
ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

257 
ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
,

259 
	g”r_pe_š™
;

262 
	gscheduË
->
	gsu³r
.su³r.su³r.
	gpo¡
 = 
ucc_ş_h›r_¿b_®Ìeduû_¡¬t
;

263 
	gscheduË
->
	gsu³r
.su³r.su³r.
	gfš®ize
 = 
ucc_ş_h›r_¬_¿b_scheduË_fš®ize
;

264 *
	gsk
 = &
scheduË
->
su³r
.super.super;

265  
	gUCC_OK
;

267 
	g”r_pe_š™
:

268 
ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

269  
	g¡©us
;

	@src/components/cl/hier/allreduce/allreduce_split_rail.c

7 
	~"®Ìeduû.h
"

8 
	~"../ş_h›r_cŞl.h
"

9 
	~"cÜe/ucc_‹am.h
"

11 
ucc_¡©us_t


12 
	$ucc_ş_h›r_®Ìeduû_¥l™_¿_äag_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

14 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

15 
ucc_ş_h›r_scheduË_t
 *
scheduË
 =

16 
	`ucc_d”ived_of
(
sk
, 
ucc_ş_h›r_scheduË_t
);

18 
¡©us
 = 
	`ucc_scheduË_fš®ize
(&
scheduË
->
su³r
.super.super);

19 
	`ucc_ä“
(
scheduË
->
®Ìeduû_¥l™_¿
.
couÁs
);

20 
	`ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

21  
¡©us
;

22 
	}
}

24 
ucc_¡©us_t


25 
	$ucc_ş_h›r_¬_¥l™_¿_scheduË_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

27 
ucc_ş_h›r_scheduË_t
 *
scheduË
 =

28 
	`ucc_d”ived_of
(
sk
, 
ucc_ş_h›r_scheduË_t
);

29 
ucc_¡©us_t
 
¡©us
;

31 
¡©us
 = 
	`ucc_scheduË_p–šed_fš®ize
(&
scheduË
->
su³r
.super.super);

32 
	`ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

33  
¡©us
;

34 
	}
}

36 
ucc_¡©us_t
 
	$ucc_ş_h›r_®Ìeduû_¥l™_¿_äag_£tup
(

37 
ucc_scheduË_p–šed_t
 *
scheduË_p
, 
ucc_scheduË_t
 *
äag
, 
äag_num
)

39 
ucc_ş_h›r_‹am_t
 *
ş_‹am
 =

40 
	`ucc_d”ived_of
(
scheduË_p
->
su³r
.su³r.
‹am
, 
ucc_ş_h›r_‹am_t
);

41 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
scheduË_p
->
su³r
.su³r.
b¬gs
.args;

42 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

43 
n_äags
 = 
scheduË_p
->
su³r
.
n_sks
;

44 
š¶aû
 = 
	`UCC_IS_INPLACE
(*
¬gs
);

45 
size_t
 
äag_couÁ
, 
äag_off£t
, 
¬_couÁ
, 
¬_off£t
;

46 
ucc_¿nk_t
 
node_size
, 
node_¿nk
;

47 
ucc_cŞl_sk_t
 *
sk_rs
, *
sk_¬
, *
sk_ag
;

48 
i
;

49 
ušt64_t
 * 
couÁs
, *
di¥ls
;

51 
node_size
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE
].
sbgp
->
group_size
;

52 
node_¿nk
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE
].
sbgp
->
group_¿nk
;

53 
äag_couÁ
 =

54 
	`ucc_bufãr_block_couÁ
(
¬gs
->
d¡
.
šfo
.
couÁ
, 
n_äags
, 
äag_num
);

55 
äag_off£t
 =

56 
	`ucc_bufãr_block_off£t
(
¬gs
->
d¡
.
šfo
.
couÁ
, 
n_äags
, 
äag_num
);

57 
couÁs
 = 
	`ucc_d”ived_of
(
äag
, 
ucc_ş_h›r_scheduË_t
)

58 ->
®Ìeduû_¥l™_¿
.
couÁs
;

59 
di¥ls
 = 
couÁs
 + 
node_size
;

60 
i
 = 0; i < 
node_size
; i++) {

61 
couÁs
[
i
] = 
	`ucc_bufãr_block_couÁ
(
äag_couÁ
, 
node_size
, i);

62 
di¥ls
[
i
] = 
	`ucc_bufãr_block_off£t
(
äag_couÁ
, 
node_size
, i);

65 
¬_couÁ
 = 
couÁs
[
node_¿nk
];

66 
¬_off£t
 = 
di¥ls
[
node_¿nk
];

68 
sk_rs
 = 
äag
->
sks
[0];

69 
sk_¬
 = 
äag
->
sks
[1];

70 
sk_ag
 = 
äag
->
sks
[2];

72 
	`ucc_as£¹
(
sk_rs
->
b¬gs
.
¬gs
.
d¡
.
šfo_v
.
couÁs
 == counts);

74 ià(
š¶aû
) {

75 
sk_rs
->
b¬gs
.
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
	`PTR_OFFSET
(

76 
¬gs
->
d¡
.
šfo
.
bufãr
, 
äag_off£t
 * 
dt_size
);

78 
sk_rs
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 =

79 
	`PTR_OFFSET
(
¬gs
->
¤c
.
šfo
.
bufãr
, 
äag_off£t
 * 
dt_size
);

80 
sk_rs
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 = 
äag_couÁ
;

81 
sk_rs
->
b¬gs
.
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
	`PTR_OFFSET
(

82 
¬gs
->
d¡
.
šfo
.
bufãr
, (
äag_off£t
 + 
¬_off£t
è* 
dt_size
);

86 
sk_¬
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
 = 
¬_couÁ
;

87 
sk_¬
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(

88 
¬gs
->
d¡
.
šfo
.
bufãr
, (
äag_off£t
 + 
¬_off£t
è* 
dt_size
);

90 
	`ucc_as£¹
(
	`UCC_IS_INPLACE
(
sk_ag
->
b¬gs
.
¬gs
));

91 
sk_ag
->
b¬gs
.
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
	`PTR_OFFSET
(

92 
¬gs
->
d¡
.
šfo
.
bufãr
, 
äag_off£t
 * 
dt_size
);

93 
sk_ag
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 = 
äag_couÁ
;

94 
	`ucc_as£¹
(
sk_ag
->
b¬gs
.
¬gs
.
d¡
.
šfo_v
.
couÁs
 == counts);

95 
	`ucc_as£¹
(
sk_ag
->
b¬gs
.
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 =ğ
di¥ls
);

96  
UCC_OK
;

97 
	}
}

99 
ucc_¡©us_t
 
	$ucc_ş_h›r_®Ìeduû_¥l™_¿_äag_š™
(

100 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_scheduË_p–šed_t
 *
¥
,

101 
ucc_ba£_‹am_t
 *
‹am
, 
ucc_scheduË_t
 **
äag_p
)

103 
ucc_ş_h›r_‹am_t
 * 
ş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

104 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
);

105 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

106 
š¶aû
 = 
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
);

107 
n_äags
 = 
¥
->
su³r
.
n_sks
;

108 
ucc_cŞl_sk_t
 *
sk_rs
, *
sk_ag
, *
sk_¬
;

109 
ucc_ba£_cŞl_¬gs_t
 
rs_¬gs
, 
¬_¬gs
, 
ag_¬gs
;

110 
ucc_ş_h›r_scheduË_t
 *
ş_scheduË
;

111 
ucc_scheduË_t
 * 
scheduË
;

112 
size_t
 
tÙ®_couÁ
;

113 
ucc_¿nk_t
 
node_size
, 
node_¿nk
;

114 
i
;

115 
ušt64_t
 *
couÁs
, *
di¥ls
;

117 
ş_scheduË
 = 
	`ucc_ş_h›r_g‘_scheduË
(
ş_‹am
);

119 ià(
	`ucc_uÆik–y
(!
ş_scheduË
)) {

120  
UCC_ERR_NO_MEMORY
;

123 
scheduË
 = &
ş_scheduË
->
su³r
.super;

124 
¡©us
 = 
	`ucc_scheduË_š™
(
scheduË
, 
cŞl_¬gs
, 
‹am
);

125 ià(
UCC_OK
 !ğ
¡©us
) {

126  
¡©us
;

129 
node_size
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE
].
sbgp
->
group_size
;

130 ià(
	`ucc_uÆik–y
(0 =ğ
node_size
)) {

134 
”r_rs
;

136 
node_¿nk
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE
].
sbgp
->
group_¿nk
;

137 
tÙ®_couÁ
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
couÁ
;

139 
ş_scheduË
->
®Ìeduû_¥l™_¿
.
couÁs
 =

140 
	`ucc_m®loc
(
node_size
 * 2 * (
ušt64_t
), "counts");

141 ià(
	`ucc_uÆik–y
(!
ş_scheduË
->
®Ìeduû_¥l™_¿
.
couÁs
)) {

142 
	`ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
,

144 
node_size
 * 2 * (
ušt64_t
));

145 
”r_rs
;

147 
couÁs
 = 
ş_scheduË
->
®Ìeduû_¥l™_¿
.counts;

148 
di¥ls
 = 
couÁs
 + 
node_size
;

149 
i
 = 0; i < 
node_size
; i++) {

150 
couÁs
[
i
] = 
	`ucc_bufãr_block_couÁ
(
tÙ®_couÁ
, 
node_size
, i);

151 
di¥ls
[
i
] = 
	`ucc_bufãr_block_off£t
(
tÙ®_couÁ
, 
node_size
, i);

153 
	`memıy
(&
rs_¬gs
, 
cŞl_¬gs
, (rs_args));

154 
	`memıy
(&
¬_¬gs
, 
cŞl_¬gs
, (ar_args));

155 
	`memıy
(&
ag_¬gs
, 
cŞl_¬gs
, (ag_args));

157 
rs_¬gs
.
¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

158 
rs_¬gs
.
¬gs
.
æags
 &ğ(~
UCC_COLL_ARGS_FLAG_IN_PLACE
);

159 
rs_¬gs
.
¬gs
.
æags
 |ğ(
UCC_COLL_ARGS_FLAG_COUNT_64BIT
 |

160 
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
);

163 
rs_¬gs
.
¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_REDUCE_SCATTERV
;

164 
rs_¬gs
.
¬gs
.
d¡
.
šfo_v
.
couÁs
 = counts;

165 
rs_¬gs
.
¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = 
cŞl_¬gs
->¬gs.d¡.
šfo
.mem_type;

166 
rs_¬gs
.
¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
cŞl_¬gs
->¬gs.d¡.
šfo
.datatype;

168 
rs_¬gs
.
max_äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(

169 
	`ucc_bufãr_block_couÁ
(
tÙ®_couÁ
, 
n_äags
, 0), 
node_size
, 0);

170 
rs_¬gs
.
mask
 |ğ
UCC_BASE_CARGS_MAX_FRAG_COUNT
;

173 ià(
š¶aû
) {

174 
rs_¬gs
.
¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

175 
rs_¬gs
.
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

176 
rs_¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 = 
cŞl_¬gs
->¬gs.
d¡
.info.buffer;

177 
rs_¬gs
.
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
cŞl_¬gs
->¬gs.
d¡
.info.datatype;

178 
rs_¬gs
.
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
cŞl_¬gs
->¬gs.d¡.
šfo
.buffer;

181 
rs_¬gs
.
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
	`PTR_OFFSET
(

182 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
bufãr
, 
di¥ls
[
node_¿nk
] * 
dt_size
);

183 
rs_¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 = 
cŞl_¬gs
->¬gs.
d¡
.info.count;

186 
¡©us
 = 
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NODE
), &
rs_¬gs
, &
sk_rs
);

187 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

188 
	`ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "failedo init„sask");

189 
”r_rs
;

193 
¬_¬gs
.
mask
 |ğ
UCC_BASE_CARGS_MAX_FRAG_COUNT
;

194 
¬_¬gs
.
max_äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
tÙ®_couÁ
,

195 
n_äags
, 0);

196 
¬_¬gs
.
¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLREDUCE
;

197 
¬_¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 = 
couÁs
[
node_¿nk
];

198 
¬_¬gs
.
¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

199 
¬_¬gs
.
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

200 
¬_¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
 = 
couÁs
[
node_¿nk
];

202 
¡©us
 = 
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NET
), &
¬_¬gs
, &
sk_¬
);

203 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

204 
	`ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "failedo init‡rask");

205 
”r_¬
;

209 
ag_¬gs
.
¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

210 
ag_¬gs
.
¬gs
.
æags
 |ğ(
UCC_COLL_ARGS_FLAG_COUNT_64BIT
 |

211 
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
);

212 
ag_¬gs
.
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

213 
ag_¬gs
.
¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLGATHERV
;

214 
ag_¬gs
.
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
cŞl_¬gs
->¬gs.d¡.
šfo
.buffer;

215 
ag_¬gs
.
¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = 
cŞl_¬gs
->¬gs.d¡.
šfo
.mem_type;

216 
ag_¬gs
.
¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
cŞl_¬gs
->¬gs.d¡.
šfo
.datatype;

217 
ag_¬gs
.
¬gs
.
d¡
.
šfo_v
.
couÁs
 = counts;

218 
ag_¬gs
.
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = 
di¥ls
;

220 
¡©us
 = 
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NODE
), &
ag_¬gs
, &
sk_ag
);

221 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

222 
	`ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "failedo init‡gask");

223 
”r_ag
;

226 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sk_rs
), 
”r_ag
, 
¡©us
);

227 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(&
scheduË
->
su³r
, 
sk_rs
,

228 
UCC_EVENT_SCHEDULE_STARTED
),

229 
”r_ag
, 
¡©us
);

231 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sk_¬
), 
”r_ag
, 
¡©us
);

232 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(
sk_rs
, 
sk_¬
,

233 
UCC_EVENT_COMPLETED
),

234 
”r_ag
, 
¡©us
);

236 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sk_ag
), 
”r_ag
, 
¡©us
);

237 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(
sk_¬
, 
sk_ag
,

238 
UCC_EVENT_COMPLETED
),

239 
”r_ag
, 
¡©us
);

241 
scheduË
->
su³r
.
po¡
 = 
ucc_scheduË_¡¬t
;

242 
scheduË
->
su³r
.
´og»ss
 = 
NULL
;

243 
scheduË
->
su³r
.
fš®ize
 = 
ucc_ş_h›r_®Ìeduû_¥l™_¿_äag_fš®ize
;

245 *
äag_p
 = 
scheduË
;

246  
¡©us
;

248 
”r_ag
:

249 ià(
sk_¬
) {

250 
	`ucc_cŞËùive_fš®ize
(&
sk_¬
->
su³r
);

252 
”r_¬
:

253 ià(
sk_rs
) {

254 
	`ucc_cŞËùive_fš®ize
(&
sk_rs
->
su³r
);

256 
”r_rs
:

257 
	`ucc_ş_h›r_put_scheduË
(
scheduË
);

258  
¡©us
;

259 
	}
}

261 
ucc_¡©us_t


262 
	$ucc_ş_h›r_¥l™_¿_®Ìeduû_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

264 
ucc_scheduË_p–šed_t
 *
scheduË
 =

265 
	`ucc_d”ived_of
(
sk
, 
ucc_scheduË_p–šed_t
);

267 
	`ş_debug
(
sk
->
‹am
->
cÚ‹xt
->
lib
,

270 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
,ask->b¬gs.¬gs.
d¡
.info.buffer,

271 
sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
,

272 
	`ucc_d©©y³_¡r
(
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
d©©y³
),

273 
	`ucc_»duùiÚ_İ_¡r
(
sk
->
b¬gs
.
¬gs
.
İ
),

274 
	`UCC_IS_INPLACE
(
sk
->
b¬gs
.
¬gs
), 
scheduË
->
n_äags
,

275 
scheduË
->
su³r
.
n_sks
);

277  
	`ucc_scheduË_p–šed_po¡
(
sk
);

278 
	}
}

280 
UCC_CL_HIER_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_ş_h›r_®Ìeduû_¥l™_¿_š™
,

281 (
cŞl_¬gs
, 
‹am
, 
sk
),

282 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

283 
ucc_cŞl_sk_t
 **
sk
)

285 
ucc_ş_h›r_‹am_t
 *
	gş_‹am
 = 
ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

286 
ucc_ş_h›r_lib_cÚfig_t
 *
	gcfg
 = &
UCC_CL_HIER_TEAM_LIB
(
ş_‹am
)->
cfg
;

287 
ucc_ş_h›r_scheduË_t
 *
	gscheduË
;

288 
	gn_äags
, 
	gp–še_d•th
;

289 
ucc_¡©us_t
 
	g¡©us
;

291 ià(
	gcŞl_¬gs
->
	g¬gs
.
	gİ
 =ğ
UCC_OP_AVG
) {

292  
UCC_ERR_NOT_SUPPORTED
;

295 ià(!
SBGP_ENABLED
(
ş_‹am
, 
NODE
è|| !SBGP_ENABLED(ş_‹am, 
NET
)) {

296  
	gUCC_ERR_NOT_SUPPORTED
;

299 ià(!
ucc_tİo_isİ²
(
‹am
->
·¿ms
.‹am->
tİo
)) {

300 
ş_debug
(
‹am
->
cÚ‹xt
->
lib
, "split_rail‡lgorithm does‚ot support "

302  
	gUCC_ERR_NOT_SUPPORTED
;

305 
	gscheduË
 = 
ucc_ş_h›r_g‘_scheduË
(
ş_‹am
);

306 ià(
ucc_uÆik–y
(!
scheduË
)) {

307  
	gUCC_ERR_NO_MEMORY
;

310 
ucc_p–še_näags_pd•th
(&
cfg
->
®Ìeduû_¥l™_¿_p–še
,

311 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
couÁ
 *

312 
ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
),

313 &
n_äags
, &
p–še_d•th
);

315 
	g¡©us
 = 
ucc_scheduË_p–šed_š™
(

316 
cŞl_¬gs
, 
‹am
, 
ucc_ş_h›r_®Ìeduû_¥l™_¿_äag_š™
,

317 
ucc_ş_h›r_®Ìeduû_¥l™_¿_äag_£tup
, 
p–še_d•th
, 
n_äags
,

318 
cfg
->
®Ìeduû_¥l™_¿_p–še
.
Üd”
, &
scheduË
->
su³r
);

320 ià(
ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

321 
ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
,

323 
	g”r_pe_š™
;

326 
	gscheduË
->
	gsu³r
.su³r.su³r.
	gpo¡
 = 
ucc_ş_h›r_¥l™_¿_®Ìeduû_¡¬t
;

327 
	gscheduË
->
	gsu³r
.su³r.su³r.
	gfš®ize
 =

328 
ucc_ş_h›r_¬_¥l™_¿_scheduË_fš®ize
;

329 *
	gsk
 = &
scheduË
->
su³r
.super.super;

330  
	gUCC_OK
;

332 
	g”r_pe_š™
:

333 
ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

334  
	g¡©us
;

	@src/components/cl/hier/alltoall/alltoall.c

7 
	~"®ÉßÎ.h
"

8 
	~"../®ÉßÎv/®ÉßÎv.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc_ş_h›r_®ÉßÎ_®gs
[
UCC_CL_HIER_ALLTOALL_ALG_LAST
 + 1] = {

12 [
UCC_CL_HIER_ALLTOALL_ALG_NODE_SPLIT
] =

13 {.
id
 = 
UCC_CL_HIER_ALLTOALL_ALG_NODE_SPLIT
,

14 .
	gÇme
 = "node_split",

15 .
	gdesc
 = "splitting‡lltoall intowo concurrent‡2av calls"

17 [
UCC_CL_HIER_ALLTOALL_ALG_LAST
] = {

18 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

20 
UCC_CL_HIER_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_ş_h›r_®ÉßÎ_š™
,

21 (
cŞl_¬gs
, 
‹am
, 
sk
),

22 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

23 
ucc_cŞl_sk_t
 **
sk
)

25 
ucc_ş_h›r_‹am_t
 *
	gş_‹am
 = 
ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

26 
ucc_¿nk_t
 
	gtsize
 = 
UCC_CL_TEAM_SIZE
(
ş_‹am
);

27 
ušt64_t
 *
	gcouÁs
, *
	gdi¥ls
;

28 
ucc_¡©us_t
 
	g¡©us
;

29 
ucc_ba£_cŞl_¬gs_t
 
	g¬gs
;

30 
	gi
;

31 
size_t
 
	gcouÁ
;

32 
ucc_mc_bufãr_h—d”_t
 *
	gh
;

34 ià(
UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
)) {

35 
ş_debug
(
‹am
->
cÚ‹xt
->
lib
, "inplace‡lltoall is‚ot supported");

36  
	gUCC_ERR_NOT_SUPPORTED
;

39 ià(!
SBGP_ENABLED
(
ş_‹am
, 
FULL
)) {

40 
ş_debug
(
‹am
->
cÚ‹xt
->
lib
, "alltoall„equires FULL sbgps");

41  
	gUCC_ERR_NOT_SUPPORTED
;

44 
memıy
(&
¬gs
, 
cŞl_¬gs
, (args));

45 
	g¬gs
.¬gs.
	gcŞl_ty³
 = 
UCC_COLL_TYPE_ALLTOALLV
;

46 ià(!(
	g¬gs
.¬gs.
	gmask
 & 
	gUCC_COLL_ARGS_FIELD_FLAGS
)) {

47 
	g¬gs
.¬gs.
	gmask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

48 
	g¬gs
.¬gs.
	gæags
 = 0;

51 
	g¬gs
.¬gs.
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_CONTIG_SRC_BUFFER
 |

52 
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
 |

53 
UCC_COLL_ARGS_FLAG_COUNT_64BIT
 |

54 
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
;

55 
	g¡©us
 = 
ucc_mc_®loc
(&
h
, (
ušt64_t
è* 
tsize
 * 2,

56 
UCC_MEMORY_TYPE_HOST
);

57 ià(
ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

58 
ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
,

60 (
ušt64_t
è* 
tsize
 * 2);

61  
	g¡©us
;

64 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gbufãr
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
bufãr
;

65 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gbufãr
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
bufãr
;

66 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gd©©y³
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
d©©y³
;

67 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gd©©y³
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

68 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gmem_ty³
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
mem_ty³
;

69 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gmem_ty³
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
mem_ty³
;

70 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gcouÁs
 = 
h
->
addr
;

71 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = 
PTR_OFFSET
(
h
->
addr
,

72 (
ušt64_t
è* 
tsize
);

73 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gcouÁs
 = 
¬gs
.¬gs.
¤c
.
šfo_v
.
couÁs
;

74 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = 
¬gs
.¬gs.
¤c
.
šfo_v
.
di¥Ïûm’ts
;

76 
	gcouÁs
 = (
ušt64_t
 *)
¬gs
.¬gs.
¤c
.
šfo_v
.
couÁs
;

77 
	gdi¥ls
 = (
ušt64_t
 *)
¬gs
.¬gs.
¤c
.
šfo_v
.
di¥Ïûm’ts
;

79 
	gcouÁ
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
couÁ
 / 
tsize
;

80 
	gcouÁs
[0] = 
couÁ
;

81 
	gdi¥ls
[0] = 0;

82 
	gi
 = 1; i < 
	gtsize
; i++) {

83 
	gcouÁs
[
i
] = 
couÁ
;

84 
	gdi¥ls
[
i
] = 
di¥ls
[˜- 1] + 
couÁ
;

87 
	g¡©us
 = 
ucc_ş_h›r_®ÉßÎv_š™
(&
¬gs
, 
‹am
, 
sk
);

88 ià(
	gUCC_OK
 !ğ
¡©us
) {

89 
ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "failedo init split‚ode‡2avask");

92 
ucc_mc_ä“
(
h
);

93  
	g¡©us
;

	@src/components/cl/hier/alltoall/alltoall.h

7 #iâdeà
ALLTOALL_H_


8 
	#ALLTOALL_H_


	)

9 
	~"../ş_h›r_cŞl.h
"

13 
	mUCC_CL_HIER_ALLTOALL_ALG_NODE_SPLIT
,

14 
	mUCC_CL_HIER_ALLTOALL_ALG_LAST
,

17 
ucc_ba£_cŞl_®g_šfo_t


18 
ucc_ş_h›r_®ÉßÎ_®gs
[
UCC_CL_HIER_ALLTOALL_ALG_LAST
 + 1];

20 
ucc_¡©us_t
 
ucc_ş_h›r_®ÉßÎ_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

21 
ucc_ba£_‹am_t
 * 
‹am
,

22 
ucc_cŞl_sk_t
 ** 
sk
);

24 
šlše
 
	$ucc_ş_h›r_®ÉßÎ_®g_äom_¡r
(cÚ¡ *
¡r
)

26 
i
;

27 
i
 = 0; i < 
UCC_CL_HIER_ALLTOALL_ALG_LAST
; i++) {

28 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc_ş_h›r_®ÉßÎ_®gs
[
i
].
Çme
)) {

32  
i
;

33 
	}
}

	@src/components/cl/hier/alltoallv/alltoallv.c

8 
	~"®ÉßÎv.h
"

9 
	~"../ş_h›r_cŞl.h
"

10 
	~"cÜe/ucc_‹am.h
"

12 
ucc_ba£_cŞl_®g_šfo_t


13 
	gucc_ş_h›r_®ÉßÎv_®gs
[
UCC_CL_HIER_ALLTOALLV_ALG_LAST
 + 1] = {

14 [
UCC_CL_HIER_ALLTOALLV_ALG_NODE_SPLIT
] =

15 {.
id
 = 
UCC_CL_HIER_ALLTOALLV_ALG_NODE_SPLIT
,

16 .
	gÇme
 = "node_split",

17 .
	gdesc
 = "splitting‡lltoallv intowo concurrent‡2av calls"

19 [
UCC_CL_HIER_ALLTOALLV_ALG_LAST
] = {

20 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

22 
ucc_¡©us_t
 
	$ucc_ş_h›r_®ÉßÎv_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

24 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_alltoallv_start", 0);

25  
	`ucc_scheduË_¡¬t
(
sk
);

26 
	}
}

28 
ucc_¡©us_t
 
	$ucc_ş_h›r_®ÉßÎv_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

30 
ucc_ş_h›r_scheduË_t
 *
scheduË
 =

31 
	`ucc_d”ived_of
(
sk
, 
ucc_ş_h›r_scheduË_t
);

32 
ucc_¡©us_t
 
¡©us
;

34 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_alltoallv_finalize", 0);

35 
	`ucc_as£¹
(
scheduË
->
su³r
.su³r.
n_sks
 == 1 ||

36 
scheduË
->
su³r
.su³r.
n_sks
 == 2);

37 ià(
scheduË
->
sü©ch
) {

38 
	`ucc_mc_ä“
(
scheduË
->
sü©ch
);

40 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

41 
	`ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

42  
¡©us
;

43 
	}
}

45 
	#SET_FULL_COUNTS
(
_ty³
, 
_sbgp
, 
_cŞl_¬gs
, 
_‹am
, 
_node_th»sh
, \

46 
_sdt_size
, 
_rdt_size
, 
_sc_fuÎ
, 
_sd_fuÎ
, 
_rc_fuÎ
, \

47 
_rd_fuÎ
) \

49 
_i
, 
_is_loÿl
; \

50 
_ty³
 
_scouÁ
, 
_rcouÁ
; \

52 
_i
 = 0; _˜< (
_sbgp
)->
group_size
; _i++) { \

53 
_scouÁ
 = ((
_ty³
 *)(
_cŞl_¬gs
)->
¬gs
.
¤c
.
šfo_v
.
couÁs
)[
_i
]; \

54 
_rcouÁ
 = ((
_ty³
 *)(
_cŞl_¬gs
)->
¬gs
.
d¡
.
šfo_v
.
couÁs
)[
_i
]; \

55 
_is_loÿl
 = \

56 
	`ucc_¿nk_Ú_loÿl_node
(
_i
, (
_‹am
)->
·¿ms
.
‹am
->
tİo
); \

57 ià((
_scouÁ
 * 
_sdt_size
 > (
_node_th»sh
)è&& 
_is_loÿl
) { \

58 ((
_ty³
 *)
_sc_fuÎ
)[
_i
] = 0; \

60 ((
_ty³
 *)
_sc_fuÎ
)[
_i
] = 
_scouÁ
; \

61 ((
_ty³
 *)
_sd_fuÎ
)[
_i
] = \

62 ((
_ty³
 *)(
_cŞl_¬gs
) \

63 ->
¬gs
.
¤c
.
šfo_v
.
di¥Ïûm’ts
)[
_i
]; \

65 ià((
_rcouÁ
 * 
_rdt_size
 > (
_node_th»sh
)è&& 
_is_loÿl
) { \

66 ((
_ty³
 *)
_rc_fuÎ
)[
_i
] = 0; \

68 ((
_ty³
 *)
_rc_fuÎ
)[
_i
] = 
_rcouÁ
; \

69 ((
_ty³
 *)
_rd_fuÎ
)[
_i
] = \

70 ((
_ty³
 *)(
_cŞl_¬gs
) \

71 ->
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
)[
_i
]; \

74 } 0)

	)

76 
	#SET_NODE_COUNTS
(
_ty³
, 
_sbgp
, 
_cŞl_¬gs
, 
_node_th»sh
, 
_sdt_size
, \

77 
_rdt_size
, 
_sc_node
, 
_sd_node
, 
_rc_node
, 
_rd_node
) \

79 
_i
; \

80 
_ty³
 
_scouÁ
, 
_rcouÁ
; \

82 
_i
 = 0; _˜< (
_sbgp
)->
group_size
; _i++) { \

83 
ucc_¿nk_t
 
r
 = 
	`ucc_•_m­_ev®
((
_sbgp
)->
m­
, 
_i
); \

84 
_scouÁ
 = ((
_ty³
 *)(
_cŞl_¬gs
)->
¬gs
.
¤c
.
šfo_v
.
couÁs
)[
r
]; \

85 
_rcouÁ
 = ((
_ty³
 *)(
_cŞl_¬gs
)->
¬gs
.
d¡
.
šfo_v
.
couÁs
)[
r
]; \

86 ià(
_scouÁ
 * 
_sdt_size
 <ğ(
_node_th»sh
)) { \

87 ((
_ty³
 *)
_sc_node
)[
_i
] = 0; \

89 ((
_ty³
 *)
_sc_node
)[
_i
] = 
_scouÁ
; \

90 ((
_ty³
 *)
_sd_node
)[
_i
] = \

91 ((
_ty³
 *)(
_cŞl_¬gs
)->
¬gs
.
¤c
.
šfo_v
.
di¥Ïûm’ts
)[
r
]; \

93 ià(
_rcouÁ
 * 
_rdt_size
 <ğ(
_node_th»sh
)) { \

94 ((
_ty³
 *)
_rc_node
)[
_i
] = 0; \

96 ((
_ty³
 *)
_rc_node
)[
_i
] = 
_rcouÁ
; \

97 ((
_ty³
 *)
_rd_node
)[
_i
] = \

98 ((
_ty³
 *)(
_cŞl_¬gs
)->
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
)[
r
]; \

101 } 0)

	)

103 
ucc_¡©us_t
 
	$ucc_ş_h›r_®ÉßÎv_Œigg”ed_po¡_£tup
(
ucc_cŞl_sk_t
 *
sk
)

105 
ucc_ş_h›r_scheduË_t
 *
scheduË
 =

106 
	`ucc_d”ived_of
(
sk
, 
ucc_ş_h›r_scheduË_t
);

107 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

108 
n_sks
 = 
scheduË
->
su³r
.super.n_tasks;

109 
i
 = 0;

111 
i
 = 0; i < 
n_sks
; ++i) {

112 
ucc_cŞl_sk_t
 *
sub_sk
 = 
scheduË
->
su³r
.su³r.
sks
[
i
];

113 ià(
sub_sk
->
Œigg”ed_po¡_£tup
 !ğ
NULL
) {

114 
sub_sk
->
“
 = 
sk
->ee;

115 
sub_sk
->
	`Œigg”ed_po¡_£tup
(sub_task);

118  
¡©us
;

119 
	}
}

121 
UCC_CL_HIER_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_ş_h›r_®ÉßÎv_š™
,

122 (
cŞl_¬gs
, 
‹am
, 
sk
),

123 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

124 
ucc_cŞl_sk_t
 **
sk
)

126 
ucc_ş_h›r_‹am_t
 *
	gş_‹am
 = 
ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

127 
ucc_ş_h›r_lib_t
 *
	gş_lib
 = 
UCC_CL_HIER_TEAM_LIB
(
ş_‹am
);

128 
	gfuÎ_Úly
 = 0;

129 
ucc_ş_h›r_scheduË_t
 *
	gş_scheduË
;

130 
ucc_scheduË_t
 *
	gscheduË
;

131 
ucc_¡©us_t
 
	g¡©us
;

132 
ucc_ba£_cŞl_¬gs_t
 
	g¬gs
;

133 
ucc_cŞl_sk_t
 *
	gsk_node
, *
	gsk_fuÎ
;

134 
	gc64
, 
	gd64
;

135 *
	gsc_fuÎ
, *
	gsd_fuÎ
, *
	grc_fuÎ
, *
	grd_fuÎ
;

136 *
	gsc_node
, *
	gsd_node
, *
	grc_node
, *
	grd_node
;

137 
ucc_¿nk_t
 
	gfuÎ_size
, 
	gnode_size
;

138 
size_t
 
	gsdt_size
, 
	grdt_size
;

139 
ucc_sbgp_t
 *
	gsbgp
;

140 
size_t
 
	g–em_size
;

142 ià(
UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
)) {

143 
ş_debug
(
‹am
->
cÚ‹xt
->
lib
, "inplace‡lltoallv is‚ot supported");

144  
	gUCC_ERR_NOT_SUPPORTED
;

147 ià(
	gcŞl_¬gs
->
	g¬gs
.
	gmask
 & 
	gUCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
) {

148 
ş_debug
(
‹am
->
cÚ‹xt
->
lib
, "onesided‡lltoallv is‚ot supported");

149  
	gUCC_ERR_NOT_SUPPORTED
;

152 ià(!
SBGP_ENABLED
(
ş_‹am
, 
FULL
)) {

153 
ş_debug
(
‹am
->
cÚ‹xt
->
lib
, "alltoallv„equires FULL sbgp");

154  
	gUCC_ERR_NOT_SUPPORTED
;

157 
	gc64
 = 
UCC_COLL_ARGS_COUNT64
(&
cŞl_¬gs
->
¬gs
);

158 
	gd64
 = 
UCC_COLL_ARGS_DISPL64
(&
cŞl_¬gs
->
¬gs
);

160 ià(
	gc64
 ^ 
	gd64
) {

161 
ş_debug
(
‹am
->
cÚ‹xt
->
lib
,

163  
	gUCC_ERR_NOT_SUPPORTED
;

166 
	gş_scheduË
 = 
ucc_ş_h›r_g‘_scheduË
(
ş_‹am
);

167 ià(
ucc_uÆik–y
(!
ş_scheduË
)) {

168  
	gUCC_ERR_NO_MEMORY
;

170 
	gscheduË
 = &
ş_scheduË
->
su³r
.super;

171 
memıy
(&
¬gs
, 
cŞl_¬gs
, (args));

172 
UCC_CHECK_GOTO
(
ucc_scheduË_š™
(
scheduË
, &
¬gs
, 
‹am
), 
”rÜ
, 
¡©us
);

174 
	gfuÎ_size
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_FULL
].
sbgp
->
group_size
;

175 
	gnode_size
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE
].
sbgp
->
group_size
;

176 
	g–em_size
 = 
c64
 ? 8 : 4;

178 ià(!
SBGP_ENABLED
(
ş_‹am
, 
NODE
)) {

179 
	gfuÎ_Úly
 = 1;

180 
UCC_CHECK_GOTO
(
ucc_cŞl_š™
(

181 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_FULL
].
scÜe_m­
,

182 &
¬gs
, &
sk_fuÎ
),

183 
”rÜ
, 
¡©us
);

184 
	gfuÎ
;

187 
	g¡©us
 = 
ucc_mc_®loc
(&
ş_scheduË
->
sü©ch
,

188 
–em_size
 * (
fuÎ_size
 + 
node_size
) * 4,

189 
UCC_MEMORY_TYPE_HOST
);

190 ià(
ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

191 
ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
,

193 
–em_size
 * (
fuÎ_size
 + 
node_size
) * 4);

194 
	g”rÜ
;

197 
	gsc_fuÎ
 = 
ş_scheduË
->
sü©ch
->
addr
;

198 
	gsd_fuÎ
 = 
PTR_OFFSET
(
sc_fuÎ
, 
fuÎ_size
 * 
–em_size
);

199 
	grc_fuÎ
 = 
PTR_OFFSET
(
sc_fuÎ
, 
fuÎ_size
 * 
–em_size
 * 2);

200 
	grd_fuÎ
 = 
PTR_OFFSET
(
sc_fuÎ
, 
fuÎ_size
 * 
–em_size
 * 3);

202 
	gsc_node
 = 
PTR_OFFSET
(
sc_fuÎ
, 
fuÎ_size
 * 
–em_size
 * 4);

203 
	gsd_node
 = 
PTR_OFFSET
(
sc_node
, 
node_size
 * 
–em_size
);

204 
	grc_node
 = 
PTR_OFFSET
(
sc_node
, 
node_size
 * 
–em_size
 * 2);

205 
	grd_node
 = 
PTR_OFFSET
(
sc_node
, 
node_size
 * 
–em_size
 * 3);

208 
	gsbgp
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_FULL
].
sbgp
;

209 
ucc_as£¹
(
sbgp
->
group_size
 =ğ
‹am
->
·¿ms
.
size
);

210 
	gsdt_size
 = 
ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
¤c
.
šfo_v
.
d©©y³
);

211 
	grdt_size
 = 
ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
d¡
.
šfo_v
.
d©©y³
);

213 ià(
	gc64
) {

214 
SET_FULL_COUNTS
(
ušt64_t
, 
sbgp
, 
cŞl_¬gs
, 
‹am
,

215 
ş_lib
->
cfg
.
a2av_node_th»sh
, 
sdt_size
, 
rdt_size
,

216 
sc_fuÎ
, 
sd_fuÎ
, 
rc_fuÎ
, 
rd_fuÎ
);

218 
SET_FULL_COUNTS
(
ušt32_t
, 
sbgp
, 
cŞl_¬gs
, 
‹am
,

219 
ş_lib
->
cfg
.
a2av_node_th»sh
, 
sdt_size
, 
rdt_size
,

220 
sc_fuÎ
, 
sd_fuÎ
, 
rc_fuÎ
, 
rd_fuÎ
);

222 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
 *)
sc_fuÎ
;

223 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
 *)
rc_fuÎ
;

224 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
 *)
sd_fuÎ
;

225 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
 *)
rd_fuÎ
;

227 
UCC_CHECK_GOTO
(
ucc_cŞl_š™
(
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_FULL
].
scÜe_m­
,

228 &
¬gs
, &
sk_fuÎ
),

229 
”r_š™_1
, 
¡©us
);

232 
	gsbgp
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE
].
sbgp
;

234 ià(
	gc64
) {

235 
SET_NODE_COUNTS
(
ušt64_t
, 
sbgp
, 
cŞl_¬gs
,

236 
ş_lib
->
cfg
.
a2av_node_th»sh
, 
sdt_size
, 
rdt_size
,

237 
sc_node
, 
sd_node
, 
rc_node
, 
rd_node
);

239 
SET_NODE_COUNTS
(
ušt32_t
, 
sbgp
, 
cŞl_¬gs
,

240 
ş_lib
->
cfg
.
a2av_node_th»sh
, 
sdt_size
, 
rdt_size
,

241 
sc_node
, 
sd_node
, 
rc_node
, 
rd_node
);

244 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
 *)
sc_node
;

245 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
 *)
rc_node
;

246 
	g¬gs
.¬gs.
	g¤c
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
 *)
sd_node
;

247 
	g¬gs
.¬gs.
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
 *)
rd_node
;

248 
UCC_CHECK_GOTO
(
ucc_cŞl_š™
(
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE
].
scÜe_m­
,

249 &
¬gs
, &
sk_node
),

250 
”r_š™_2
, 
¡©us
);

252 
UCC_CHECK_GOTO
(
ucc_scheduË_add_sk
(
scheduË
, 
sk_node
), 
”r_š™_3
,

253 
¡©us
);

254 
UCC_CHECK_GOTO
(
ucc_sk_subsüibe_d•
(&
scheduË
->
su³r
, 
sk_node
,

255 
UCC_EVENT_SCHEDULE_STARTED
),

256 
”r_š™_3
, 
¡©us
);

257 
	gfuÎ
:

258 
UCC_CHECK_GOTO
(
ucc_scheduË_add_sk
(
scheduË
, 
sk_fuÎ
), 
”r_š™_3
,

259 
¡©us
);

261 
UCC_CHECK_GOTO
(
ucc_sk_subsüibe_d•
(&
scheduË
->
su³r
, 
sk_fuÎ
,

262 
UCC_EVENT_SCHEDULE_STARTED
),

263 
”r_š™_3
, 
¡©us
);

265 
	gscheduË
->
	gsu³r
.
	gpo¡
 = 
ucc_ş_h›r_®ÉßÎv_¡¬t
;

266 
	gscheduË
->
	gsu³r
.
	g´og»ss
 = 
NULL
;

267 
	gscheduË
->
	gsu³r
.
	gfš®ize
 = 
ucc_ş_h›r_®ÉßÎv_fš®ize
;

268 
	gscheduË
->
	gsu³r
.
	gŒigg”ed_po¡_£tup
 =

269 
ucc_ş_h›r_®ÉßÎv_Œigg”ed_po¡_£tup
;

270 *
	gsk
 = &
scheduË
->
su³r
;

271  
	gUCC_OK
;

273 
	g”r_š™_3
:

274 ià(!
fuÎ_Úly
) {

275 
ucc_cŞËùive_fš®ize
(&
sk_node
->
su³r
);

277 
	g”r_š™_2
:

278 
ucc_cŞËùive_fš®ize
(&
sk_fuÎ
->
su³r
);

279 
	g”r_š™_1
:

280 ià(!
fuÎ_Úly
) {

281 
ucc_mc_ä“
(
ş_scheduË
->
sü©ch
);

283 
	g”rÜ
:

284 
ucc_ş_h›r_put_scheduË
(
scheduË
);

285  
	g¡©us
;

	@src/components/cl/hier/alltoallv/alltoallv.h

7 #iâdeà
ALLTOALLV_H_


8 
	#ALLTOALLV_H_


	)

9 
	~"../ş_h›r.h
"

13 
	mUCC_CL_HIER_ALLTOALLV_ALG_NODE_SPLIT
,

14 
	mUCC_CL_HIER_ALLTOALLV_ALG_LAST
,

17 
ucc_ba£_cŞl_®g_šfo_t


18 
ucc_ş_h›r_®ÉßÎv_®gs
[
UCC_CL_HIER_ALLTOALLV_ALG_LAST
 + 1];

20 
ucc_¡©us_t
 
ucc_ş_h›r_®ÉßÎv_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

21 
ucc_ba£_‹am_t
 *
‹am
,

22 
ucc_cŞl_sk_t
 **
sk
);

24 
šlše
 
	$ucc_ş_h›r_®ÉßÎv_®g_äom_¡r
(cÚ¡ *
¡r
)

26 
i
;

27 
i
 = 0; i < 
UCC_CL_HIER_ALLTOALLV_ALG_LAST
; i++) {

28 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc_ş_h›r_®ÉßÎv_®gs
[
i
].
Çme
)) {

32  
i
;

33 
	}
}

	@src/components/cl/hier/barrier/barrier.c

7 
	~"b¬r›r.h
"

8 
	~"../ş_h›r_cŞl.h
"

10 
	#MAX_BARRIER_TASKS
 3

	)

12 
ucc_¡©us_t
 
	$ucc_ş_h›r_b¬r›r_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

14 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_barrier_start", 0);

15  
	`ucc_scheduË_¡¬t
(
sk
);

16 
	}
}

18 
ucc_¡©us_t
 
	$ucc_ş_h›r_b¬r›r_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

20 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

21 
ucc_¡©us_t
 
¡©us
;

23 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_barrier_finalize",

25 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

26 
	`ucc_ş_h›r_put_scheduË
(
scheduË
);

27  
¡©us
;

28 
	}
}

30 
UCC_CL_HIER_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_ş_h›r_b¬r›r_š™
,

31 (
cŞl_¬gs
, 
‹am
, 
sk
),

32 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

33 
ucc_cŞl_sk_t
 **
sk
)

35 
ucc_ş_h›r_‹am_t
 *
	gş_‹am
 = 
ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

36 
ucc_cŞl_sk_t
 *
	gsks
[
MAX_BARRIER_TASKS
] = {
NULL
};

37 
ucc_scheduË_t
 *
	gscheduË
;

38 
ucc_¡©us_t
 
	g¡©us
;

39 
ucc_ba£_cŞl_¬gs_t
 
	g¬gs
;

40 
	gn_sks
, 
	gi
;

42 
	gscheduË
 = &
ucc_ş_h›r_g‘_scheduË
(
ş_‹am
)->
su³r
.super;

43 ià(
ucc_uÆik–y
(!
scheduË
)) {

44  
	gUCC_ERR_NO_MEMORY
;

47 
memıy
(&
¬gs
, 
cŞl_¬gs
, (args));

48 
	g¬gs
.¬gs.
	groÙ
 = 0;

49 
	gn_sks
 = 0;

50 
UCC_CHECK_GOTO
(
ucc_scheduË_š™
(
scheduË
, &
¬gs
, 
‹am
), 
out
, 
¡©us
);

52 ià(
SBGP_ENABLED
(
ş_‹am
, 
NODE
)) {

53 
ucc_as£¹
(
n_sks
 == 0);

54 ià(
	gş_‹am
->
	gtİ_sbgp
 =ğ
UCC_HIER_SBGP_NODE
) {

55 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_BARRIER
;

57 
	g¬gs
.¬gs.
	gcŞl_ty³
 = 
UCC_COLL_TYPE_FANIN
;

59 
UCC_CHECK_GOTO
(

60 
ucc_cŞl_š™
(
SCORE_MAP
(
ş_‹am
, 
NODE
), &
¬gs
, &
sks
[
n_sks
]),

61 
out
, 
¡©us
);

62 
	gn_sks
++;

65 ià(
SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
)) {

66 
ucc_as£¹
(
ş_‹am
->
tİ_sbgp
 =ğ
UCC_HIER_SBGP_NODE_LEADERS
);

67 
	g¬gs
.¬gs.
	gcŞl_ty³
 = 
UCC_COLL_TYPE_BARRIER
;

68 
UCC_CHECK_GOTO
(
ucc_cŞl_š™
(
SCORE_MAP
(
ş_‹am
, 
NODE_LEADERS
), &
¬gs
,

69 &
sks
[
n_sks
]),

70 
out
, 
¡©us
);

71 
	gn_sks
++;

75 ià(
SBGP_ENABLED
(
ş_‹am
, 
NODE
) &&

76 
	gş_‹am
->
	gtİ_sbgp
 !ğ
UCC_HIER_SBGP_NODE
) {

77 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_FANOUT
;

78 
UCC_CHECK_GOTO
(

79 
ucc_cŞl_š™
(
SCORE_MAP
(
ş_‹am
, 
NODE
), &
¬gs
, &
sks
[
n_sks
]),

80 
out
, 
¡©us
);

81 
	gn_sks
++;

84 
UCC_CHECK_GOTO
(
ucc_ev’t_mªag”_subsüibe
(

85 &
scheduË
->
su³r
, 
UCC_EVENT_SCHEDULE_STARTED
, 
sks
[0],

86 
ucc_sk_¡¬t_hªdËr
),

87 
out
, 
¡©us
);

88 
UCC_CHECK_GOTO
(
ucc_scheduË_add_sk
(
scheduË
, 
sks
[0]), 
out
, 
¡©us
);

89 
	gi
 = 1; i < 
	gn_sks
; i++) {

90 
UCC_CHECK_GOTO
(

91 
ucc_ev’t_mªag”_subsüibe
(
sks
[
i
 - 1], 
UCC_EVENT_COMPLETED
,

92 
sks
[
i
], 
ucc_sk_¡¬t_hªdËr
),

93 
out
, 
¡©us
);

94 
UCC_CHECK_GOTO
(
ucc_scheduË_add_sk
(
scheduË
, 
sks
[
i
]), 
out
, 
¡©us
);

97 
	gscheduË
->
	gsu³r
.
	gpo¡
 = 
ucc_ş_h›r_b¬r›r_¡¬t
;

98 
	gscheduË
->
	gsu³r
.
	gfš®ize
 = 
ucc_ş_h›r_b¬r›r_fš®ize
;

99 *
	gsk
 = &
scheduË
->
su³r
;

100  
	gUCC_OK
;

102 
	gout
:

103 
i
 = 0; 
	gi
 < 
	gn_sks
; i++) {

104 
	gsks
[
i
]->
fš®ize
(
sks
[i]);

106 
ucc_ş_h›r_put_scheduË
(
scheduË
);

107  
	g¡©us
;

	@src/components/cl/hier/barrier/barrier.h

7 #iâdeà
BARRIER_H_


8 
	#BARRIER_H_


	)

9 
	~"../ş_h›r.h
"

11 
ucc_¡©us_t
 
ucc_ş_h›r_b¬r›r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

12 
ucc_ba£_‹am_t
 *
‹am
,

13 
ucc_cŞl_sk_t
 **
sk
);

	@src/components/cl/hier/bcast/bcast.c

7 
	~"bÿ¡.h
"

8 
	~"../bÿ¡/bÿ¡.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc_ş_h›r_bÿ¡_®gs
[
UCC_CL_HIER_BCAST_ALG_LAST
 + 1] = {

12 [
UCC_CL_HIER_BCAST_ALG_2STEP
] =

13 {.
id
 = 
UCC_CL_HIER_BCAST_ALG_2STEP
,

14 .
	gÇme
 = "2step",

15 .
	gdesc
 = "intra-node‡nd inter-node bcastsƒxecuted in…arallel"},

16 [
UCC_CL_HIER_BCAST_ALG_LAST
] = {

17 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

	@src/components/cl/hier/bcast/bcast.h

7 #iâdeà
BCAST_H_


8 
	#BCAST_H_


	)

9 
	~"../ş_h›r.h
"

13 
	mUCC_CL_HIER_BCAST_ALG_2STEP
,

14 
	mUCC_CL_HIER_BCAST_ALG_LAST
,

17 
ucc_ba£_cŞl_®g_šfo_t


18 
ucc_ş_h›r_bÿ¡_®gs
[
UCC_CL_HIER_BCAST_ALG_LAST
 + 1];

20 
	#UCC_CL_HIER_BCAST_DEFAULT_ALG_SELECT_STR
 "bÿ¡:0-4k:@2¡•"

	)

22 
ucc_¡©us_t
 
ucc_ş_h›r_bÿ¡_2¡•_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

23 
ucc_ba£_‹am_t
 *
‹am
,

24 
ucc_cŞl_sk_t
 **
sk
);

26 
šlše
 
	$ucc_ş_h›r_bÿ¡_®g_äom_¡r
(cÚ¡ *
¡r
)

28 
i
;

30 
i
 = 0; i < 
UCC_CL_HIER_BCAST_ALG_LAST
; i++) {

31 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc_ş_h›r_bÿ¡_®gs
[
i
].
Çme
)) {

35  
i
;

36 
	}
}

	@src/components/cl/hier/bcast/bcast_2step.c

7 
	~"bÿ¡.h
"

8 
	~"cÜe/ucc_‹am.h
"

9 
	~"../ş_h›r_cŞl.h
"

11 
ucc_¡©us_t
 
	$ucc_ş_h›r_bÿ¡_2¡•_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

13 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_bcast_2step_start", 0);

14  
	`ucc_scheduË_¡¬t
(
sk
);

15 
	}
}

17 
ucc_¡©us_t
 
	$ucc_ş_h›r_bÿ¡_2¡•_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

19 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

20 
ucc_¡©us_t
 
¡©us
;

22 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_bcast_2step_finalize",

24 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

25 
	`ucc_ş_h›r_put_scheduË
(
scheduË
);

26  
¡©us
;

27 
	}
}

29 
ucc_¡©us_t


30 
	$ucc_ş_h›r_bÿ¡_2¡•_scheduË_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

32 
ucc_ş_h›r_scheduË_t
 *
scheduË
 =

33 
	`ucc_d”ived_of
(
sk
, 
ucc_ş_h›r_scheduË_t
);

34 
ucc_¡©us_t
 
¡©us
;

36 
¡©us
 = 
	`ucc_scheduË_p–šed_fš®ize
(&
scheduË
->
su³r
.super.super);

37 
	`ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

38  
¡©us
;

39 
	}
}

41 
ucc_¡©us_t


42 
	$ucc_ş_h›r_bÿ¡_2¡•_äag_£tup
(
ucc_scheduË_p–šed_t
 *
scheduË_p
,

43 
ucc_scheduË_t
 *
äag
, 
äag_num
)

45 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
scheduË_p
->
su³r
.su³r.
b¬gs
.args;

46 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

47 
n_äags
 = 
scheduË_p
->
su³r
.
n_sks
;

48 
size_t
 
äag_couÁ
, 
äag_off£t
;

49 
ucc_cŞl_sk_t
 *
sk
;

50 
i
;

52 
äag_couÁ
 =

53 
	`ucc_bufãr_block_couÁ
(
¬gs
->
¤c
.
šfo
.
couÁ
, 
n_äags
, 
äag_num
);

54 
äag_off£t
 =

55 
	`ucc_bufãr_block_off£t
(
¬gs
->
¤c
.
šfo
.
couÁ
, 
n_äags
, 
äag_num
);

57 
i
 = 0; i < 
äag
->
n_sks
; i++) {

58 
sk
 = 
äag
->
sks
[
i
];

59 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 = 
äag_couÁ
;

60 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 =

61 
	`PTR_OFFSET
(
¬gs
->
¤c
.
šfo
.
bufãr
, 
äag_off£t
 * 
dt_size
);

63  
UCC_OK
;

64 
	}
}

66 
šlše
 
ucc_¿nk_t


67 
	$fšd_roÙ_Ãt_¿nk
(
ucc_ho¡_id_t
 
roÙ_ho¡_id
, 
ucc_ş_h›r_‹am_t
 *
ş_‹am
)

69 
ucc_sbgp_t
 *
sbgp
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE_LEADERS
].sbgp;

70 
ucc_‹am_t
 *
cÜe_‹am
 = 
ş_‹am
->
su³r
.su³r.
·¿ms
.
‹am
;

71 
ucc_¿nk_t
 
i
, 
¿nk
;

73 
i
 = 0; i < 
sbgp
->
group_size
; i++) {

74 
¿nk
 = 
	`ucc_•_m­_ev®
(
sbgp
->
m­
, 
i
);

75 ià(
	`ucc_‹am_¿nk_ho¡_id
(
¿nk
, 
cÜe_‹am
è=ğ
roÙ_ho¡_id
) {

76  
i
;

79  
UCC_RANK_INVALID
;

80 
	}
}

82 
šlše
 
ucc_¿nk_t


83 
	$fšd_roÙ_node_¿nk
(
ucc_¿nk_t
 
roÙ
, 
ucc_ş_h›r_‹am_t
 *
ş_‹am
)

85 
ucc_sbgp_t
 *
sbgp
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE
].sbgp;

86 
ucc_¿nk_t
 
i
;

88 
i
 = 0; i < 
sbgp
->
group_size
; i++) {

89 ià(
	`ucc_•_m­_ev®
(
sbgp
->
m­
, 
i
è=ğ
roÙ
) {

90  
i
;

93  
UCC_RANK_INVALID
;

94 
	}
}

96 
ucc_¡©us_t


97 
	$ucc_ş_h›r_bÿ¡_2¡•_š™_scheduË
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

98 
ucc_ba£_‹am_t
 *
‹am
,

99 
ucc_scheduË_t
 **
sched_p
, 
n_äags
)

101 
ucc_ş_h›r_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

102 
ucc_‹am_t
 *
cÜe_‹am
 = 
‹am
->
·¿ms
.team;

103 
ucc_cŞl_sk_t
 *
sks
[2] = {
NULL
, NULL};

104 
ucc_¿nk_t
 
roÙ
 = 
cŞl_¬gs
->
¬gs
.root;

105 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
ş_‹am
);

106 
roÙ_Ú_loÿl_node
 = 
	`ucc_‹am_¿nks_Ú_§me_node
(
roÙ
, 
¿nk
,

107 
cÜe_‹am
);

108 
ucc_ba£_cŞl_¬gs_t
 
¬gs
 = *
cŞl_¬gs
;

109 
n_sks
 = 0;

110 
fœ¡_sk
 = 0;

111 
ucc_scheduË_t
 *
scheduË
;

112 
ucc_¡©us_t
 
¡©us
;

113 
i
;

115 
scheduË
 = &
	`ucc_ş_h›r_g‘_scheduË
(
ş_‹am
)->
su³r
.super;

116 ià(
	`ucc_uÆik–y
(!
scheduË
)) {

117  
UCC_ERR_NO_MEMORY
;

119 
¡©us
 = 
	`ucc_scheduË_š™
(
scheduË
, &
¬gs
, 
‹am
);

120 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

121 
out
;

124 ià(
n_äags
 > 1) {

125 
¬gs
.
max_äag_couÁ
 =

126 
	`ucc_bufãr_block_couÁ
(
¬gs
.¬gs.
¤c
.
šfo
.
couÁ
, 
n_äags
, 0);

127 
¬gs
.
mask
 |ğ
UCC_BASE_CARGS_MAX_FRAG_COUNT
;

130 
	`ucc_as£¹
(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
) ||

131 
	`SBGP_ENABLED
(
ş_‹am
, 
NODE
));

132 ià(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
)) {

133 
¬gs
.¬gs.
roÙ
 = 
	`fšd_roÙ_Ãt_¿nk
(

134 
	`ucc_‹am_¿nk_ho¡_id
(
roÙ
, 
cÜe_‹am
), 
ş_‹am
);

135 
¡©us
 = 
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NODE_LEADERS
), &
¬gs
,

136 &
sks
[
n_sks
]);

137 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

138 
out
;

140 
n_sks
++;

141 ià(
roÙ_Ú_loÿl_node
 && (
roÙ
 !ğ
¿nk
)) {

142 
fœ¡_sk
 = 1;

146 ià(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE
)) {

147 
¬gs
.¬gs.
roÙ
 = 
roÙ_Ú_loÿl_node


148 ? 
	`fšd_roÙ_node_¿nk
(
roÙ
, 
ş_‹am
)

149 : 
cÜe_‹am
->
tİo
->
node_Ëad”_¿nk_id
;

150 
¡©us
 =

151 
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NODE
), &
¬gs
, &
sks
[
n_sks
]);

152 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

153 
out
;

155 
n_sks
++;

158 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(&
scheduË
->
su³r
, 
sks
[
fœ¡_sk
],

159 
UCC_EVENT_SCHEDULE_STARTED
),

160 
out
, 
¡©us
);

161 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sks
[
fœ¡_sk
]),

162 
out
, 
¡©us
);

163 ià(
n_sks
 > 1) {

164 ià(
roÙ
 =ğ
¿nk
) {

165 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(&
scheduË
->
su³r
,

166 
sks
[(
fœ¡_sk
 + 1) % 2],

167 
UCC_EVENT_SCHEDULE_STARTED
),

168 
out
, 
¡©us
);

170 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(
sks
[
fœ¡_sk
],

171 
sks
[(
fœ¡_sk
 + 1) % 2],

172 
UCC_EVENT_COMPLETED
),

173 
out
, 
¡©us
);

175 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
,

176 
sks
[(
fœ¡_sk
 + 1) % 2]),

177 
out
, 
¡©us
);

180 
scheduË
->
su³r
.
po¡
 = 
ucc_ş_h›r_bÿ¡_2¡•_¡¬t
;

181 
scheduË
->
su³r
.
´og»ss
 = 
NULL
;

182 
scheduË
->
su³r
.
fš®ize
 = 
ucc_ş_h›r_bÿ¡_2¡•_fš®ize
;

183 *
sched_p
 = 
scheduË
;

184  
UCC_OK
;

186 
out
:

187 
i
 = 0; i < 
n_sks
; i++) {

188 
sks
[
i
]->
	`fš®ize
(tasks[i]);

190 
	`ucc_ş_h›r_put_scheduË
(
scheduË
);

191  
¡©us
;

192 
	}
}

194 
ucc_¡©us_t
 
	$ucc_ş_h›r_bÿ¡_2¡•_äag_š™
(

195 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_scheduË_p–šed_t
 *
¥
,

196 
ucc_ba£_‹am_t
 *
‹am
, 
ucc_scheduË_t
 **
äag_p
)

198 
n_äags
 = 
¥
->
su³r
.
n_sks
;

200  
	`ucc_ş_h›r_bÿ¡_2¡•_š™_scheduË
(
cŞl_¬gs
, 
‹am
, 
äag_p
,

201 
n_äags
);

202 
	}
}

204 
ucc_¡©us_t
 
	$ucc_ş_h›r_2¡•_bÿ¡_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

206 
ucc_scheduË_p–šed_t
 *
scheduË
 =

207 
	`ucc_d”ived_of
(
sk
, 
ucc_scheduË_p–šed_t
);

209 
	`ş_debug
(
sk
->
‹am
->
cÚ‹xt
->
lib
,

212 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
,

213 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
,

214 
	`ucc_d©©y³_¡r
(
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
d©©y³
),

215 
scheduË
->
n_äags
, scheduË->
su³r
.
n_sks
);

217  
	`ucc_scheduË_p–šed_po¡
(
sk
);

218 
	}
}

220 
UCC_CL_HIER_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_ş_h›r_bÿ¡_2¡•_š™
,

221 (
cŞl_¬gs
, 
‹am
, 
sk
),

222 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

223 
ucc_cŞl_sk_t
 **
sk
)

225 
ucc_ş_h›r_‹am_t
 *
	gş_‹am
 = 
ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

226 
ucc_ş_h›r_lib_cÚfig_t
 *
	gcfg
 = &
UCC_CL_HIER_TEAM_LIB
(
ş_‹am
)->
cfg
;

227 
ucc_ş_h›r_scheduË_t
 * 
	gscheduË
;

228 
	gn_äags
, 
	gp–še_d•th
;

229 
ucc_¡©us_t
 
	g¡©us
;

231 ià(
UCC_IS_PERSISTENT
(
cŞl_¬gs
->
¬gs
)) {

232  
	gUCC_ERR_NOT_SUPPORTED
;

234 
ucc_p–še_näags_pd•th
(&
cfg
->
bÿ¡_2¡•_p–še
,

235 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
couÁ
 *

236 
ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
d©©y³
),

237 &
n_äags
, &
p–še_d•th
);

239 ià(
	gn_äags
 == 1) {

240  
ucc_ş_h›r_bÿ¡_2¡•_š™_scheduË
(

241 
cŞl_¬gs
, 
‹am
, (
ucc_scheduË_t
 **)
sk
, 
n_äags
);

244 
	gscheduË
 = 
ucc_ş_h›r_g‘_scheduË
(
ş_‹am
);

245 ià(
ucc_uÆik–y
(!
scheduË
)) {

246  
	gUCC_ERR_NO_MEMORY
;

249 
	g¡©us
 = 
ucc_scheduË_p–šed_š™
(

250 
cŞl_¬gs
, 
‹am
, 
ucc_ş_h›r_bÿ¡_2¡•_äag_š™
,

251 
ucc_ş_h›r_bÿ¡_2¡•_äag_£tup
, 
p–še_d•th
, 
n_äags
,

252 
cfg
->
bÿ¡_2¡•_p–še
.
Üd”
, &
scheduË
->
su³r
);

254 ià(
ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

255 
ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
,

257 
	g”r_pe_š™
;

260 
	gscheduË
->
	gsu³r
.su³r.su³r.
	gpo¡
 = 
ucc_ş_h›r_2¡•_bÿ¡_¡¬t
;

261 
	gscheduË
->
	gsu³r
.su³r.su³r.
	gfš®ize
 =

262 
ucc_ş_h›r_bÿ¡_2¡•_scheduË_fš®ize
;

263 *
	gsk
 = &
scheduË
->
su³r
.super.super;

264  
	gUCC_OK
;

266 
	g”r_pe_š™
:

267 
ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

268  
	g¡©us
;

	@src/components/cl/hier/cl_hier.c

7 
	~"ş_h›r.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"®Ìeduû/®Ìeduû.h
"

10 
	~"®ÉßÎ/®ÉßÎ.h
"

11 
	~"®ÉßÎv/®ÉßÎv.h
"

13 
ucc_¡©us_t
 
ucc_ş_h›r_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

14 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
);

16 
ucc_¡©us_t
 
ucc_ş_h›r_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

18 
ucc_¡©us_t
 
ucc_ş_h›r_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

19 
ucc_ba£_ùx_©Œ_t
 *
ba£_©Œ
);

21 
ucc_¡©us_t
 
ucc_ş_h›r_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

22 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
);

24 
ucc_¡©us_t
 
ucc_ş_h›r_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

25 
ucc_mem_m­__t
 *
_h
);

27 
ucc_¡©us_t
 
ucc_ş_h›r_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

28 
ucc_mem_m­_mode_t
 
mode
, 
ucc_mem_m­__t
 *
_h
, **
·cked_bufãr
);

30 
ucc_cÚfig_f›ld_t
 
	gucc_ş_h›r_lib_cÚfig_bË
[] = {

31 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
, 
su³r
),

32 
UCC_CONFIG_TYPE_TABLE
(
ucc_ş_lib_cÚfig_bË
)},

37 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
, 
sbgp_s
[
UCC_HIER_SBGP_NODE
]),

38 
UCC_CONFIG_TYPE_ALLOW_LIST
},

44 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
,

45 
sbgp_s
[
UCC_HIER_SBGP_NODE_LEADERS
]),

46 
UCC_CONFIG_TYPE_ALLOW_LIST
},

54 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
, 
sbgp_s
[
UCC_HIER_SBGP_NET
]),

55 
UCC_CONFIG_TYPE_ALLOW_LIST
},

60 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
, 
sbgp_s
[
UCC_HIER_SBGP_FULL
]),

61 
UCC_CONFIG_TYPE_ALLOW_LIST
},

65 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
, 
a2av_node_th»sh
),

66 
UCC_CONFIG_TYPE_MEMUNITS
},

70 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
, 
®Ìeduû_¥l™_¿_p–še
),

71 
UCC_CONFIG_TYPE_PIPELINE_PARAMS
},

75 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
, 
®Ìeduû_¿b_p–še
),

76 
UCC_CONFIG_TYPE_PIPELINE_PARAMS
},

80 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
, 
bÿ¡_2¡•_p–še
),

81 
UCC_CONFIG_TYPE_PIPELINE_PARAMS
},

85 
ucc_off£tof
(
ucc_ş_h›r_lib_cÚfig_t
, 
»duû_2¡•_p–še
),

86 
UCC_CONFIG_TYPE_PIPELINE_PARAMS
},

88 {
NULL
}};

90 
ucs_cÚfig_f›ld_t
 
	gucc_ş_h›r_cÚ‹xt_cÚfig_bË
[] = {

91 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ş_h›r_cÚ‹xt_cÚfig_t
, 
su³r
),

92 
UCC_CONFIG_TYPE_TABLE
(
ucc_ş_cÚ‹xt_cÚfig_bË
)},

94 {
NULL
}};

96 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc_ş_h›r_lib_t
, 
ucc_ba£_lib_t
,

97 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

98 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

100 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc_ş_h›r_lib_t
, 
ucc_ba£_lib_t
);

102 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc_ş_h›r_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

103 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

104 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

106 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc_ş_h›r_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

108 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc_ş_h›r_‹am_t
, 
ucc_ba£_‹am_t
,

109 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

111 
ucc_¡©us_t
 
ucc_ş_h›r_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
ş_‹am
);

113 
ucc_¡©us_t
 
ucc_ş_h›r_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
ş_‹am
);

115 
ucc_¡©us_t
 
ucc_ş_h›r_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
ş_‹am
,

116 
ucc_cŞl_scÜe_t
 **
scÜe
);

117 
UCC_CL_IFACE_DECLARE
(
h›r
, 
HIER
);

119 
__©Œibu‹__
((
cÚ¡ruùÜ
)è
	$ş_h›r_içû_š™
()

121 
ucc_ş_h›r
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLREDUCE
)] =

122 
ucc_ş_h›r_®Ìeduû_®gs
;

123 
ucc_ş_h›r
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLTOALL
)] =

124 
ucc_ş_h›r_®ÉßÎ_®gs
;

125 
ucc_ş_h›r
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLTOALLV
)] =

126 
ucc_ş_h›r_®ÉßÎv_®gs
;

127 
ucc_ş_h›r
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_BCAST
)] =

128 
ucc_ş_h›r_bÿ¡_®gs
;

129 
ucc_ş_h›r
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLGATHERV
)] =

130 
ucc_ş_h›r_®lg©h”v_®gs
;

131 
	}
}

	@src/components/cl/hier/cl_hier.h

8 #iâdeà
UCC_CL_HIER_H_


9 
	#UCC_CL_HIER_H_


	)

10 
	~"compÚ’ts/ş/ucc_ş.h
"

11 
	~"compÚ’ts/ş/ucc_ş_log.h
"

12 
	~"compÚ’ts//ucc_.h
"

13 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

14 
	~"uts/ucc_mpoŞ.h
"

15 
	~"scheduË/ucc_scheduË_p–šed.h
"

17 #ifdeà
HAVE_PROFILING_CL_HIER


18 
	~"uts/´ofe/ucc_´ofe_Ú.h
"

20 
	~"uts/´ofe/ucc_´ofe_off.h
"

23 
	#UCC_CL_HIER_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

24 
	#UCC_CL_HIER_PROFILE_REQUEST_NEW
 
UCC_PROFILE_REQUEST_NEW


	)

25 
	#UCC_CL_HIER_PROFILE_REQUEST_EVENT
 
UCC_PROFILE_REQUEST_EVENT


	)

26 
	#UCC_CL_HIER_PROFILE_REQUEST_FREE
 
UCC_PROFILE_REQUEST_FREE


	)

28 #iâdeà
UCC_CL_HIER_DEFAULT_SCORE


29 
	#UCC_CL_HIER_DEFAULT_SCORE
 50

	)

32 
	succ_ş_h›r_içû
 {

33 
ucc_ş_içû_t
 
	msu³r
;

34 } 
	tucc_ş_h›r_içû_t
;

36 
ucc_ş_h›r_içû_t
 
ucc_ş_h›r
;

39 
	mUCC_HIER_SBGP_NODE
,

40 
	mUCC_HIER_SBGP_NODE_LEADERS
,

41 
	mUCC_HIER_SBGP_NET
,

42 
	mUCC_HIER_SBGP_FULL
,

43 
	mUCC_HIER_SBGP_LAST
,

44 } 
	tucc_h›r_sbgp_ty³_t
;

47 
	succ_ş_h›r_lib_cÚfig
 {

48 
ucc_ş_lib_cÚfig_t
 
	msu³r
;

51 
ucc_cÚfig_Çmes_li¡_t
 
	msbgp_s
[
UCC_HIER_SBGP_LAST
];

52 
size_t
 
	ma2av_node_th»sh
;

53 
ucc_p–še_·¿ms_t
 
	m®Ìeduû_¥l™_¿_p–še
;

54 
ucc_p–še_·¿ms_t
 
	m®Ìeduû_¿b_p–še
;

55 
ucc_p–še_·¿ms_t
 
	mbÿ¡_2¡•_p–še
;

56 
ucc_p–še_·¿ms_t
 
	m»duû_2¡•_p–še
;

57 } 
	tucc_ş_h›r_lib_cÚfig_t
;

59 
	succ_ş_h›r_cÚ‹xt_cÚfig
 {

60 
ucc_ş_cÚ‹xt_cÚfig_t
 
	msu³r
;

61 } 
	tucc_ş_h›r_cÚ‹xt_cÚfig_t
;

63 
	succ_ş_h›r_lib
 {

64 
ucc_ş_lib_t
 
	msu³r
;

65 
ucc_ş_h›r_lib_cÚfig_t
 
	mcfg
;

66 
ucc_cÚfig_®low_li¡_t
 
	ms
;

68 } 
	tucc_ş_h›r_lib_t
;

69 
UCC_CLASS_DECLARE
(
ucc_ş_h›r_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

70 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

72 
	succ_ş_h›r_cÚ‹xt
 {

73 
ucc_ş_cÚ‹xt_t
 
	msu³r
;

74 
ucc_mpoŞ_t
 
	msched_mp
;

75 } 
	tucc_ş_h›r_cÚ‹xt_t
;

76 
UCC_CLASS_DECLARE
(
ucc_ş_h›r_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

77 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

80 
	mUCC_HIER_SBGP_DISABLED
,

81 
	mUCC_HIER_SBGP_ENABLED


82 } 
	tucc_h›r_sbgp_¡©e_t
;

84 
	#CL_HIER_MAX_SBGP_TLS
 4

	)

91 
	succ_h›r_sbgp
 {

92 
ucc_h›r_sbgp_¡©e_t
 
	m¡©e
;

93 
ucc_sbgp_ty³_t
 
	msbgp_ty³
;

94 
ucc_sbgp_t
 *
	msbgp
;

95 
ucc_scÜe_m­_t
 *
	mscÜe_m­
;

96 
ucc_cŞl_scÜe_t
 *
	mscÜe
;

97 
ucc__‹am_t
 *
	m_‹ams
[
CL_HIER_MAX_SBGP_TLS
];

98 
ucc__cÚ‹xt_t
 *
	m_ùxs
[
CL_HIER_MAX_SBGP_TLS
];

99 
	mn_s
;

100 } 
	tucc_h›r_sbgp_t
;

102 
	succ_ş_h›r_‹am
 {

103 
ucc_ş_‹am_t
 
	msu³r
;

104 
ucc_‹am_muÉË_»q_t
 *
	m‹am_ü—‹_»q
;

105 
	mn__‹ams
;

106 
ucc_cŞl_scÜe_t
 *
	mscÜe
;

107 
ucc_h›r_sbgp_t
 
	msbgps
[
UCC_HIER_SBGP_LAST
];

108 
ucc_h›r_sbgp_ty³_t
 
	mtİ_sbgp
;

109 
	mis_block_Üd”ed
;

110 } 
	tucc_ş_h›r_‹am_t
;

111 
UCC_CLASS_DECLARE
(
ucc_ş_h›r_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

112 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

114 
	#UCC_CL_HIER_SUPPORTED_COLLS
 \

115 (
UCC_COLL_TYPE_ALLTOALL
 | \

116 
UCC_COLL_TYPE_ALLTOALLV
 | \

117 
UCC_COLL_TYPE_ALLGATHERV
 | \

118 
UCC_COLL_TYPE_ALLREDUCE
 | \

119 
UCC_COLL_TYPE_BARRIER
 | \

120 
UCC_COLL_TYPE_BCAST
 | \

121 
UCC_COLL_TYPE_REDUCE
)

	)

123 
ucc_¡©us_t
 
ucc_ş_h›r_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

124 
ucc_ba£_‹am_t
 *
‹am
,

125 
ucc_cŞl_sk_t
 **
sk
);

127 
	#UCC_CL_HIER_TEAM_CTX
(
_‹am
) \

128 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
, 
ucc_ş_h›r_cÚ‹xt_t
))

	)

130 
	#UCC_CL_HIER_TEAM_LIB
(
_‹am
) \

131 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
->
lib
, 
ucc_ş_h›r_lib_t
))

	)

133 
	#SBGP_ENABLED
(
_‹am
, 
_sbgp
) \

134 ((
_‹am
)->
sbgps
[
UCC_HIER_SBGP_
##
_sbgp
].
¡©e
 =ğ
UCC_HIER_SBGP_ENABLED
)

	)

136 
	#SBGP_RANK
(
_‹am
, 
_sbgp
) \

137 ((
_‹am
)->
sbgps
[
UCC_HIER_SBGP_
##
_sbgp
].
sbgp
->
group_¿nk
)

	)

139 
	#SBGP_SIZE
(
_‹am
, 
_sbgp
) \

140 ((
_‹am
)->
sbgps
[
UCC_HIER_SBGP_
##
_sbgp
].
sbgp
->
group_size
)

	)

142 
	#SBGP_MAP
(
_‹am
, 
_sbgp
) \

143 ((
_‹am
)->
sbgps
[
UCC_HIER_SBGP_
##
_sbgp
].
sbgp
->
m­
)

	)

145 
	#SBGP_EXISTS
(
_‹am
, 
_sbgp
) \

146 ((
NULL
 !ğ(
_‹am
)->
sbgps
[
UCC_HIER_SBGP_
##
_sbgp
].
sbgp
) && \

147 ((
_‹am
)->
sbgps
[
UCC_HIER_SBGP_
##
_sbgp
].
sbgp
->
¡©us
 != \

148 
UCC_SBGP_NOT_EXISTS
))

	)

150 
	#SCORE_MAP
(
_‹am
, 
_sbgp
è(_‹am)->
sbgps
[
UCC_HIER_SBGP_
##_sbgp].
scÜe_m­


	)

	@src/components/cl/hier/cl_hier_coll.c

7 
	~"ş_h›r.h
"

8 
	~"compÚ’ts/mc/ucc_mc.h
"

9 
	~"cÜe/ucc_‹am.h
"

10 
	~"uts/ucc_cŞl_uts.h
"

11 
	~"ş_h›r_cŞl.h
"

14 
	gucc_ş_h›r_deçuÉ_®g_£Ëù_¡r
[
UCC_CL_HIER_N_DEFAULT_ALG_SELECT_STR
] = {

15 
UCC_CL_HIER_ALLREDUCE_DEFAULT_ALG_SELECT_STR
,

16 
UCC_CL_HIER_BCAST_DEFAULT_ALG_SELECT_STR
,

17 
UCC_CL_HIER_REDUCE_DEFAULT_ALG_SELECT_STR
,

18 
UCC_CL_HIER_ALLGATHERV_DEFAULT_ALG_SELECT_STR
};

20 
ucc_¡©us_t
 
	$ucc_ş_h›r_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

21 
ucc_ba£_‹am_t
 *
‹am
,

22 
ucc_cŞl_sk_t
 **
sk
)

24 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
) {

25 
UCC_COLL_TYPE_ALLREDUCE
:

26  
	`ucc_ş_h›r_®Ìeduû_¿b_š™
(
cŞl_¬gs
, 
‹am
, 
sk
);

27 
UCC_COLL_TYPE_ALLTOALL
:

28  
	`ucc_ş_h›r_®ÉßÎ_š™
(
cŞl_¬gs
, 
‹am
, 
sk
);

29 
UCC_COLL_TYPE_ALLTOALLV
:

30  
	`ucc_ş_h›r_®ÉßÎv_š™
(
cŞl_¬gs
, 
‹am
, 
sk
);

31 
UCC_COLL_TYPE_BARRIER
:

32  
	`ucc_ş_h›r_b¬r›r_š™
(
cŞl_¬gs
, 
‹am
, 
sk
);

33 
UCC_COLL_TYPE_BCAST
:

34  
	`ucc_ş_h›r_bÿ¡_2¡•_š™
(
cŞl_¬gs
, 
‹am
, 
sk
);

35 
UCC_COLL_TYPE_REDUCE
:

36  
	`ucc_ş_h›r_»duû_2¡•_š™
(
cŞl_¬gs
, 
‹am
, 
sk
);

38 
	`ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "coll_type %s is‚ot supported",

39 
	`ucc_cŞl_ty³_¡r
(
cŞl_¬gs
->
¬gs
.
cŞl_ty³
));

42  
UCC_ERR_NOT_SUPPORTED
;

43 
	}
}

45 
šlše
 
	$®g_id_äom_¡r
(
ucc_cŞl_ty³_t
 
cŞl_ty³
, cÚ¡ *
¡r
)

47 
cŞl_ty³
) {

48 
UCC_COLL_TYPE_ALLREDUCE
:

49  
	`ucc_ş_h›r_®Ìeduû_®g_äom_¡r
(
¡r
);

50 
UCC_COLL_TYPE_ALLTOALLV
:

51  
	`ucc_ş_h›r_®ÉßÎv_®g_äom_¡r
(
¡r
);

52 
UCC_COLL_TYPE_ALLTOALL
:

53  
	`ucc_ş_h›r_®ÉßÎ_®g_äom_¡r
(
¡r
);

54 
UCC_COLL_TYPE_BCAST
:

55  
	`ucc_ş_h›r_bÿ¡_®g_äom_¡r
(
¡r
);

56 
UCC_COLL_TYPE_REDUCE
:

57  
	`ucc_ş_h›r_»duû_®g_äom_¡r
(
¡r
);

58 
UCC_COLL_TYPE_ALLGATHERV
:

59  
	`ucc_ş_h›r_®lg©h”v_®g_äom_¡r
(
¡r
);

64 
	}
}

66 
ucc_¡©us_t
 
	$ucc_ş_h›r_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

67 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

68 
ucc_memÜy_ty³_t
 
mem_ty³
,

69 
ucc_ba£_cŞl_š™_â_t
 *
š™
)

71 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

72 ià(
®g_id_¡r
) {

73 
®g_id
 = 
	`®g_id_äom_¡r
(
cŞl_ty³
, 
®g_id_¡r
);

76 
cŞl_ty³
) {

77 
UCC_COLL_TYPE_ALLREDUCE
:

78 
®g_id
) {

79 
UCC_CL_HIER_ALLREDUCE_ALG_RAB
:

80 *
š™
 = 
ucc_ş_h›r_®Ìeduû_¿b_š™
;

82 
UCC_CL_HIER_ALLREDUCE_ALG_SPLIT_RAIL
:

83 *
š™
 = 
ucc_ş_h›r_®Ìeduû_¥l™_¿_š™
;

86 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

90 
UCC_COLL_TYPE_ALLTOALLV
:

91 
®g_id
) {

92 
UCC_CL_HIER_ALLTOALLV_ALG_NODE_SPLIT
:

93 *
š™
 = 
ucc_ş_h›r_®ÉßÎv_š™
;

96 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

100 
UCC_COLL_TYPE_ALLTOALL
:

101 
®g_id
) {

102 
UCC_CL_HIER_ALLTOALL_ALG_NODE_SPLIT
:

103 *
š™
 = 
ucc_ş_h›r_®ÉßÎ_š™
;

106 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

110 
UCC_COLL_TYPE_BCAST
:

111 
®g_id
) {

112 
UCC_CL_HIER_BCAST_ALG_2STEP
:

113 *
š™
 = 
ucc_ş_h›r_bÿ¡_2¡•_š™
;

116 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

120 
UCC_COLL_TYPE_REDUCE
:

121 
®g_id
) {

122 
UCC_CL_HIER_REDUCE_ALG_2STEP
:

123 *
š™
 = 
ucc_ş_h›r_»duû_2¡•_š™
;

126 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

130 
UCC_COLL_TYPE_ALLGATHERV
:

131 
®g_id
) {

132 
UCC_CL_HIER_ALLGATHERV_ALG_GAB
:

133 *
š™
 = 
ucc_ş_h›r_®lg©h”v_š™
;

136 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

141 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

144  
¡©us
;

145 
	}
}

	@src/components/cl/hier/cl_hier_coll.h

6 #iâdeà
UCC_CL_HIER_COLL_H_


7 
	#UCC_CL_HIER_COLL_H_


	)

9 
	~"ş_h›r.h
"

10 
	~"scheduË/ucc_scheduË_p–šed.h
"

11 
	~"compÚ’ts/mc/ucc_mc.h
"

12 
	~"®Ìeduû/®Ìeduû.h
"

13 
	~"®ÉßÎv/®ÉßÎv.h
"

14 
	~"®ÉßÎ/®ÉßÎ.h
"

15 
	~"b¬r›r/b¬r›r.h
"

16 
	~"bÿ¡/bÿ¡.h
"

17 
	~"»duû/»duû.h
"

18 
	~"®lg©h”v/®lg©h”v.h
"

20 
	#UCC_CL_HIER_N_DEFAULT_ALG_SELECT_STR
 4

	)

23 *
ucc_ş_h›r_deçuÉ_®g_£Ëù_¡r
[
UCC_CL_HIER_N_DEFAULT_ALG_SELECT_STR
];

25 
	succ_ş_h›r_scheduË_t
 {

26 
ucc_scheduË_p–šed_t
 
	msu³r
;

27 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch
;

30 
ušt64_t
 *
	mcouÁs
;

31 } 
	m®Ìeduû_¥l™_¿
;

33 } 
	tucc_ş_h›r_scheduË_t
;

35 
šlše
 
ucc_ş_h›r_scheduË_t
 *

36 
	$ucc_ş_h›r_g‘_scheduË
(
ucc_ş_h›r_‹am_t
 *
‹am
)

38 
ucc_ş_h›r_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_HIER_TEAM_CTX
(
‹am
);

39 
ucc_ş_h›r_scheduË_t
 *
scheduË
 = 
	`ucc_mpoŞ_g‘
(&
ùx
->
sched_mp
);

41 
scheduË
->
sü©ch
 = 
NULL
;

42 
	`UCC_CL_HIER_PROFILE_REQUEST_NEW
(
scheduË
, "cl_hier_sched_p", 0);

43  
scheduË
;

44 
	}
}

46 
šlše
 
	$ucc_ş_h›r_put_scheduË
(
ucc_scheduË_t
 *
scheduË
)

48 
	`UCC_CL_HIER_PROFILE_REQUEST_FREE
(
scheduË
);

49 
	`ucc_mpoŞ_put
(
scheduË
);

50 
	}
}

52 
ucc_¡©us_t
 
ucc_ş_h›r_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

53 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

54 
ucc_memÜy_ty³_t
 
mem_ty³
,

55 
ucc_ba£_cŞl_š™_â_t
 *
š™
);

	@src/components/cl/hier/cl_hier_context.c

7 
	~"ş_h›r.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"uts/¬ch/ıu.h
"

10 
	~"ş_h›r_cŞl.h
"

12 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_h›r_cÚ‹xt_t
,

13 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

14 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

16 cÚ¡ 
ucc_ş_cÚ‹xt_cÚfig_t
 *
ş_cÚfig
 =

17 
	`ucc_d”ived_of
(
cÚfig
, 
ucc_ş_cÚ‹xt_cÚfig_t
);

18 
ucc_ş_h›r_lib_t
 *
lib
 = 
	`ucc_d”ived_of
(
ş_cÚfig
->
ş_lib
,

19 
ucc_ş_h›r_lib_t
);

20 
ucc_cÚfig_Çmes_¬¿y_t
 *
s
 = &
lib
->s.
¬¿y
;

21 
ucc_¡©us_t
 
¡©us
;

22 
i
;

24 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc_ş_cÚ‹xt_t
, 
ş_cÚfig
,

25 
·¿ms
->
cÚ‹xt
);

26 ià(
s
->
couÁ
 =ğ1 && !
	`¡rcmp
Ñls->
Çmes
[0], "all")) {

27 
s
 = &
·¿ms
->
cÚ‹xt
->
®l_s
;

30 
£lf
->
su³r
.
_ùxs
 =

31 
	`ucc_m®loc
((
ucc__cÚ‹xt_t
 *è* 
s
->
couÁ
, "cl_hier_tl_ctxs");

32 ià(!
£lf
->
su³r
.
_ùxs
) {

33 
	`ş_”rÜ
(
ş_cÚfig
->
ş_lib
, "failedo‡llocate %zd bytes forl_ctxs",

34 (
ucc__cÚ‹xt_t
 **è* 
s
->
couÁ
);

35  
UCC_ERR_NO_MEMORY
;

37 
£lf
->
su³r
.
n__ùxs
 = 0;

38 
i
 = 0; i < 
s
->
couÁ
; i++) {

39 
¡©us
 = 
	`ucc__cÚ‹xt_g‘
(
·¿ms
->
cÚ‹xt
, 
s
->
Çmes
[
i
],

40 &
£lf
->
su³r
.
_ùxs
[£lf->su³r.
n__ùxs
]);

41 ià(
UCC_OK
 !ğ
¡©us
) {

42 
	`ş_debug
(
ş_cÚfig
->
ş_lib
,

43 "TL % cÚ‹xˆi nÙ‡vaabË, skpšg", 
s
->
Çmes
[
i
]);

45 
£lf
->
su³r
.
n__ùxs
++;

49 ià(0 =ğ
£lf
->
su³r
.
n__ùxs
) {

50 
	`ş_”rÜ
(
ş_cÚfig
->
ş_lib
, "no TL contexts‡re‡vailable");

51 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

52 
out
;

55 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
£lf
->
sched_mp
, 0, (
ucc_ş_h›r_scheduË_t
),

56 0, 
UCC_CACHE_LINE_SIZE
, 2, 
UINT_MAX
,

57 &
ucc_cŞl_sk_mpoŞ_İs
, 
·¿ms
->
th»ad_mode
,

59 ià(
UCC_OK
 !ğ
¡©us
) {

60 
	`ş_”rÜ
(
ş_cÚfig
->
ş_lib
, "failedo initialize cl_hier_sched mpool");

61 
out
;

64 
	`ş_debug
(
ş_cÚfig
->
ş_lib
, "š™Ÿlized cÈcÚ‹xt: %p", 
£lf
);

65  
UCC_OK
;

67 
out
:

68 
	`ucc_ä“
(
£lf
->
su³r
.
_ùxs
);

69  
¡©us
;

70 
	}
}

72 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_h›r_cÚ‹xt_t
)

74 
i
;

75 
	`ş_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizing cl context: %p", self);

77 
	`ucc_mpoŞ_ş—nup
(&
£lf
->
sched_mp
, 1);

78 
i
 = 0; i < 
£lf
->
su³r
.
n__ùxs
; i++) {

79 
	`ucc__cÚ‹xt_put
(
£lf
->
su³r
.
_ùxs
[
i
]);

81 
	`ucc_ä“
(
£lf
->
su³r
.
_ùxs
);

82 
	}
}

84 
UCC_CLASS_DEFINE
(
ucc_ş_h›r_cÚ‹xt_t
, 
ucc_ş_cÚ‹xt_t
);

86 
ucc_¡©us_t


87 
	$ucc_ş_h›r_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

88 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

90 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

91 
©Œ
->
tİo_»quœed
 = 1;

92  
UCC_OK
;

93 
	}
}

95 
ucc_¡©us_t
 
	$ucc_ş_h›r_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

96 *
add»ss
, 
size_t
 
Ën
, *
memh
,

97 *
_h
)

99  
UCC_ERR_NOT_SUPPORTED
;

100 
	}
}

102 
ucc_¡©us_t
 
	$ucc_ş_h›r_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

103 *
_h
)

105  
UCC_ERR_NOT_SUPPORTED
;

106 
	}
}

108 
ucc_¡©us_t
 
	$ucc_ş_h›r_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

109 
ty³
, *
memh
, **
·cked_bufãr
)

111  
UCC_ERR_NOT_SUPPORTED
;

112 
	}
}

	@src/components/cl/hier/cl_hier_lib.c

7 
	~"ş_h›r.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"compÚ’ts//ucc_.h
"

10 
	~"cÜe/ucc_glob®_İts.h
"

11 
	~"uts/ucc_m©h.h
"

14 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_h›r_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

15 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

17 cÚ¡ 
ucc_ş_h›r_lib_cÚfig_t
 *
ş_h›r_cÚfig
 =

18 
	`ucc_d”ived_of
(
cÚfig
, 
ucc_ş_h›r_lib_cÚfig_t
);

19 
ucc_cÚfig_Çmes_¬¿y_t
 
»que¡ed_sbgp_s
;

20 
ucc_¡©us_t
 
¡©us
;

21 
i
;

23 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc_ş_lib_t
, &
ucc_ş_h›r
.
su³r
,

24 &
ş_h›r_cÚfig
->
su³r
);

25 
	`memıy
(&
£lf
->
cfg
, 
ş_h›r_cÚfig
, (*cl_hier_config));

27 
»que¡ed_sbgp_s
.
couÁ
 = 0;

29 
i
 = 0; i < 
UCC_HIER_SBGP_LAST
; i++) {

30 
¡©us
 = 
	`ucc_cÚfig_®low_li¡_´oûss
(&
ş_h›r_cÚfig
->
sbgp_s
[
i
].
li¡
,

31 &
£lf
->
su³r
.
s
.
¬¿y
,

32 &
£lf
->
cfg
.
sbgp_s
[
i
]);

34 ià(
UCC_OK
 !ğ
¡©us
) {

35 
	`ş_”rÜ
(&
£lf
->
su³r
, "failedo…rocess sbgpls‡rray");

36  
¡©us
;

38 ià(
£lf
->
cfg
.
sbgp_s
[
i
].
¬¿y
.
couÁ
 == 0) {

39 
	`ş_”rÜ
(&
£lf
->
su³r
, "no TLs‡re‡vailable for sbgp");

40  
UCC_ERR_INVALID_PARAM
;

42 
¡©us
 = 
	`ucc_cÚfig_Çmes_¬¿y_m”ge
(&
»que¡ed_sbgp_s
,

43 &
£lf
->
cfg
.
sbgp_s
[
i
].
¬¿y
);

44 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

45 
	`ş_”rÜ
(&
£lf
->
su³r
, "failedo mergels config‚ames‡rrays");

46  
¡©us
;

49 
	`ucc_as£¹
(
»que¡ed_sbgp_s
.
couÁ
 > 0);

50 
£lf
->
s
.
¬¿y
.
couÁ
 = 
»que¡ed_sbgp_s
.count;

51 
£lf
->
s
.
¬¿y
.
Çmes
 = 
»que¡ed_sbgp_s
.names;

53 
	`ş_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

54  
¡©us
;

55 
	}
}

57 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_h›r_lib_t
)

59 
i
;

61 
	`ş_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

62 
i
 = 0; i < 
UCC_HIER_SBGP_LAST
; i++) {

63 
	`ucc_cÚfig_Çmes_¬¿y_ä“
(&
£lf
->
cfg
.
sbgp_s
[
i
].
¬¿y
);

65 
	`ucc_cÚfig_Çmes_¬¿y_ä“
(&
£lf
->
s
.
¬¿y
);

66 
	}
}

68 
UCC_CLASS_DEFINE
(
ucc_ş_h›r_lib_t
, 
ucc_ş_lib_t
);

70 
šlše
 
ucc_¡©us_t
 
	$check__lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

71 
ucc__içû_t
 * 
_içû
,

72 
ucc_ş_lib_©Œ_t
 * 
©Œ
)

74 
ucc__lib_©Œ_t
 
_©Œ
;

75 
ucc_¡©us_t
 
¡©us
;

77 
	`mem£t
(&
_©Œ
, 0, (tl_attr));

78 
¡©us
 = 
_içû
->
lib
.
	`g‘_©Œ
(
NULL
, &
_©Œ
.
su³r
);

79 ià(
UCC_OK
 !ğ
¡©us
) {

80 
	`ş_”rÜ
(
lib
, "failedo queryl %s†ib‡ttributes",

81 
_içû
->
su³r
.
Çme
);

82  
¡©us
;

84 
©Œ
->
su³r
.©Œ.
th»ad_mode
 =

85 
	`ucc_mš
(
©Œ
->
su³r
.©Œ.
th»ad_mode
, 
_©Œ
.super.attr.thread_mode);

86 
©Œ
->
su³r
.
æags
 |ğ
_©Œ
.super.flags;

87  
UCC_OK
;

88 
	}
}

90 
ucc_¡©us_t
 
	$ucc_ş_h›r_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

91 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
)

93 
ucc_ş_lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_cl_lib_attr_t);

94 
ucc_ş_h›r_lib_t
 *
ş_lib
 = 
	`ucc_d”ived_of
(
lib
, ucc_cl_hier_lib_t);

95 
ucc_cÚfig_®low_li¡_t
 *
s
 = &
ş_lib
->tls;

96 
ucc__içû_t
 *
_içû
;

97 
i
;

98 
ucc_¡©us_t
 
¡©us
;

100 
©Œ
->
s
 = &
ş_lib
->s.
¬¿y
;

101 
i
 = 0; i < 
UCC_HIER_SBGP_LAST
; i++) {

102 ià(
ş_lib
->
cfg
.
sbgp_s
[
i
].
»que¡ed
) {

103 
¡©us
 = 
	`ucc_cÚfig_Çmes_¬¿y_m”ge
(

104 &
ş_lib
->
su³r
.
s_fÜûd
, &ş_lib->
cfg
.
sbgp_s
[
i
].
¬¿y
);

105 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

106  
¡©us
;

110 
©Œ
->
s_fÜûd
 = &
ş_lib
->
su³r
.tls_forced;

111 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

112 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 
UCC_CL_HIER_SUPPORTED_COLLS
;

113 
©Œ
->
su³r
.
æags
 = 0;

115 
	`ucc_as£¹
(
s
->
¬¿y
.
couÁ
 >= 1);

116 
i
 = 0; i < 
s
->
¬¿y
.
couÁ
; i++) {

119 
_içû
 =

120 
	`ucc_d”ived_of
(
	`ucc_g‘_compÚ’t
(&
ucc_glob®_cÚfig
.
_äamewÜk
,

121 
s
->
¬¿y
.
Çmes
[
i
]),

122 
ucc__içû_t
);

123 ià(!
_içû
) {

124 
	`ş_w¬n
(
lib
, " % i nÙ‡vaabË", 
s
->
¬¿y
.
Çmes
[
i
]);

127 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`check__lib_©Œ
(
lib
, 
_içû
, 
©Œ
))) {

128  
¡©us
;

131  
UCC_OK
;

132 
	}
}

134 
ucc_¡©us_t
 
	$ucc_ş_h›r_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

136 
´İ
->
deçuÉ_‹am_size
 = 2;

137 
´İ
->
mš_‹am_size
 = 2;

138 
´İ
->
max_‹am_size
 = 
UCC_RANK_MAX
;

139  
UCC_OK
;

140 
	}
}

	@src/components/cl/hier/cl_hier_team.c

7 
	~"ş_h›r.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"cÜe/ucc_‹am.h
"

10 
	~"cÜe/ucc_£rviû_cŞl.h
"

11 
	~"ş_h›r_cŞl.h
"

13 
	#SBGP_SET
(
_‹am
, 
_sbgp
, 
_’abË
) \

14 
_‹am
->
sbgps
[
UCC_HIER_SBGP_
##
_sbgp
].
sbgp_ty³
 = 
UCC_SBGP_
##_sbgp; \

15 
_‹am
->
sbgps
[
UCC_HIER_SBGP_
##
_sbgp
].
¡©e
 = UCC_HIER_SBGP_##
_’abË
;

	)

17 
	#N_MT
 3

	)

25 
	$ucc_ş_h›r_’abË_sbgps
(
ucc_ş_h›r_‹am_t
 *
‹am
)

27 
	`SBGP_SET
(
‹am
, 
NET
, 
ENABLED
);

28 
	`SBGP_SET
(
‹am
, 
NODE
, 
ENABLED
);

29 
	`SBGP_SET
(
‹am
, 
NODE_LEADERS
, 
ENABLED
);

30 
	`SBGP_SET
(
‹am
, 
FULL
, 
ENABLED
);

31 
	}
}

33 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_h›r_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
ş_cÚ‹xt
,

34 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

36 
ucc_ş_h›r_cÚ‹xt_t
 *
ùx
 = 
	`ucc_d”ived_of
(
ş_cÚ‹xt
,

37 
ucc_ş_h›r_cÚ‹xt_t
);

38 
ucc_ş_h›r_lib_t
 *
lib
 = 
	`ucc_d”ived_of
(
ş_cÚ‹xt
->lib,

39 
ucc_ş_h›r_lib_t
);

40 
i
, 
j
, 
t
, 
n_sbgp_‹ams
;

41 
ucc_¡©us_t
 
¡©us
;

42 
ucc_h›r_sbgp_t
 *
hs
;

43 
ucc_cÚfig_Çmes_¬¿y_t
 *
s
;

44 
ucc_sub£t_t
 
sub£t
;

45 
ucc_‹am_‹am_desc
 *
d
;

46 
ucc__cÚ‹xt_t
 *
_ùx
;

47 
ucc__lib_t
 *
_lib
;

48 
ucc_ba£_lib_©Œ_t
 
©Œ
;

50 ià(!
·¿ms
->
‹am
->
tİo
) {

51 
	`ş_debug
(
ş_cÚ‹xt
->
lib
,

53  
UCC_ERR_INVALID_PARAM
;

56 ià(
	`ucc_tİo_is_sšgË_node
(
·¿ms
->
‹am
->
tİo
)) {

57 
	`ş_debug
(
ş_cÚ‹xt
->
lib
, "skipping single‚odeeam");

58  
UCC_ERR_INVALID_PARAM
;

61 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc_ş_‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

62 
	`mem£t
(
£lf
->
sbgps
, 0, (self->sbgps));

63 
	`ucc_ş_h›r_’abË_sbgps
(
£lf
);

64 
n_sbgp_‹ams
 = 0;

65 
i
 = 0; i < 
UCC_HIER_SBGP_LAST
; i++) {

66 
hs
 = &
£lf
->
sbgps
[
i
];

67 ià(
hs
->
¡©e
 =ğ
UCC_HIER_SBGP_ENABLED
) {

68 
hs
->
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
·¿ms
->
‹am
->
tİo
, hs->
sbgp_ty³
);

69 ià(
hs
->
sbgp
->
¡©us
 !ğ
UCC_SBGP_ENABLED
) {

73 
	`ş_debug
(
ş_cÚ‹xt
->
lib
, "sbgp %s is‚otƒnabled",

74 
	`ucc_sbgp_¡r
(
hs
->
sbgp_ty³
));

75 
hs
->
¡©e
 = 
UCC_HIER_SBGP_DISABLED
;

78 
hs
->
n_s
 = 0;

79 
s
 = &
lib
->
cfg
.
sbgp_s
[
i
].
¬¿y
;

80 
j
 = 0; j < 
s
->
couÁ
; j++) {

81 ià(
hs
->
n_s
 =ğ
CL_HIER_MAX_SBGP_TLS
) {

82 
	`ş_debug
(
ş_cÚ‹xt
->
lib
,

85 
s
->
Çmes
[
j
], 
	`ucc_sbgp_¡r
(
hs
->
sbgp_ty³
));

88 
¡©us
 = 
	`ucc__cÚ‹xt_g‘
(
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
,

89 
s
->
Çmes
[
j
],

90 &
hs
->
_ùxs
[hs->
n_s
]);

91 ià(
UCC_OK
 !ğ
¡©us
) {

92 
	`ş_debug
(
ş_cÚ‹xt
->
lib
,

94 
s
->
Çmes
[
j
], 
	`ucc_sbgp_¡r
(
hs
->
sbgp_ty³
));

97 
©Œ
.
mask
 = 
UCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
 |

98 
UCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
;

99 
_ùx
 = 
hs
->
_ùxs
[hs->
n_s
];

100 
_lib
 = 
	`ucc_d”ived_of
(
_ùx
->
su³r
.
lib
, 
ucc__lib_t
);

101 
¡©us
 = 
_lib
->
içû
->
lib
.
	`g‘_©Œ
(
_ùx
->
su³r
.lib,

102 &
©Œ
);

103 ià(
¡©us
 !ğ
UCC_OK
) {

104 
	`ş_debug
(
ş_cÚ‹xt
->
lib
,

106 
s
->
Çmes
[
j
]);

107 
	`ucc__cÚ‹xt_put
(
_ùx
);

111 ià(
hs
->
sbgp
->
group_size
 < 
©Œ
.
mš_‹am_size
 ||

112 
hs
->
sbgp
->
group_size
 > 
©Œ
.
max_‹am_size
) {

113 
	`ş_debug
(
ş_cÚ‹xt
->
lib
,

116 
s
->
Çmes
[
j
], 
	`ucc_sbgp_¡r
(
hs
->
sbgp_ty³
),

117 
hs
->
sbgp
->
group_size
,

118 
©Œ
.
mš_‹am_size
,‡‰r.
max_‹am_size
);

119 
	`ucc__cÚ‹xt_put
(
_ùx
);

123 
hs
->
n_s
++;

124 
n_sbgp_‹ams
++;

125 
	`ucc_as£¹
(
hs
->
n_s
 <ğ
CL_HIER_MAX_SBGP_TLS
);

130 
¡©us
 = 
	`ucc_‹am_muÉË_»q_®loc
(&
£lf
->
‹am_ü—‹_»q
, 
n_sbgp_‹ams
);

131 ià(
UCC_OK
 !ğ
¡©us
) {

132 
	`ş_”rÜ
(
ş_cÚ‹xt
->
lib
, "failedo‡llocateeam„eq multiple");

133 
”r
;

139 
j
 = 0;

140 
i
 = 0; i < 
UCC_HIER_SBGP_LAST
; i++) {

141 
hs
 = &
£lf
->
sbgps
[
i
];

142 ià(
hs
->
¡©e
 =ğ
UCC_HIER_SBGP_ENABLED
) {

143 
t
 = 0; < 
hs
->
n_s
;++) {

144 
d
 = &
£lf
->
‹am_ü—‹_»q
->
descs
[
j
];

145 
d
->
·¿m
.
·¿ms
.
mask
 = 
UCC_TEAM_PARAM_FIELD_EP_RANGE
 |

146 
UCC_TEAM_PARAM_FIELD_EP
 |

147 
UCC_TEAM_PARAM_FIELD_TEAM_SIZE
 |

148 
UCC_TEAM_PARAM_FIELD_OOB
;

149 
d
->
·¿m
.
‹am
 = 
·¿ms
->team;

150 
d
->
·¿m
.
¿nk
 = 
hs
->
sbgp
->
group_¿nk
;

151 
d
->
·¿m
.
size
 = 
hs
->
sbgp
->
group_size
;

152 
d
->
·¿m
.
·¿ms
.
•
 = (
ušt64_t
)
hs
->
sbgp
->
group_¿nk
;

153 
d
->
·¿m
.
·¿ms
.
•_¿nge
 = 
UCC_COLLECTIVE_EP_RANGE_CONTIG
;

154 
d
->
·¿m
.
scİe
 = 
UCC_CL_HIER
;

155 
d
->
·¿m
.
id
 = 
·¿ms
->id;

156 
d
->
·¿m
.
scİe_id
 = 
i
;

157 
d
->
·¿m
.
m­
 = 
hs
->
sbgp
->map;

158 
d
->
ùx
 = 
hs
->
_ùxs
[
t
];

159 
sub£t
.
my¿nk
 = 
hs
->
sbgp
->
group_¿nk
;

160 
sub£t
.
m­
 = 
hs
->
sbgp
->map;

162 
¡©us
 = 
	`ucc_š‹º®_oob_š™
(
·¿ms
->
‹am
, 
sub£t
,

163 &
d
->
·¿m
.
·¿ms
.
oob
);

164 ià(
UCC_OK
 !ğ
¡©us
) {

165 
	`ş_”rÜ
(
ş_cÚ‹xt
->
lib
, "failedo init oob for sbgp %s",

166 
	`ucc_sbgp_¡r
(
hs
->
sbgp
->
ty³
));

167 
”r
;

169 
d
->
¬gs
[0] = 
i
;

170 
d
->
¬gs
[1] = 
t
;

171 
j
++;

176 
¡©us
 = 
	`ucc__‹am_ü—‹_muÉË
(
£lf
->
‹am_ü—‹_»q
);

177 ià(
¡©us
 < 0) {

178 
	`ş_”rÜ
(
ş_cÚ‹xt
->
lib
, "çedØpo¡È‹am c»©(%d)", 
¡©us
);

179 
”r
;

181 
	`ş_debug
(
ş_cÚ‹xt
->
lib
, "po¡ed cÈ‹am: %p", 
£lf
);

182  
UCC_OK
;

183 
”r
:

184 
	`ucc_‹am_muÉË_»q_ä“
(
£lf
->
‹am_ü—‹_»q
);

185  
¡©us
;

186 
	}
}

188 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_h›r_‹am_t
)

190 
	`ş_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizing cleam: %p", self);

191 
	}
}

193 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc_ş_h›r_‹am_t
, 
ucc_ba£_‹am_t
);

194 
UCC_CLASS_DEFINE
(
ucc_ş_h›r_‹am_t
, 
ucc_ş_‹am_t
);

196 
ucc_¡©us_t
 
	$ucc_ş_h›r_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
ş_‹am
)

198 
ucc_ş_h›r_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
ş_‹am
, ucc_cl_hier_team_t);

199 
ucc_ş_h›r_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_HIER_TEAM_CTX
(
‹am
);

200 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

201 
i
, 
j
;

202 
ucc_h›r_sbgp_t
 *
hs
;

203 
ucc_‹am_‹am_desc
 *
d
;

205 ià(
NULL
 =ğ
‹am
->
‹am_ü—‹_»q
) {

206 
¡©us
 = 
	`ucc_‹am_muÉË_»q_®loc
(&
‹am
->
‹am_ü—‹_»q
,

207 
‹am
->
n__‹ams
);

208 ià(
UCC_OK
 !ğ
¡©us
) {

209 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

211  
¡©us
;

213 
‹am
->
‹am_ü—‹_»q
->
n_‹ams
 = 0;

214 
i
 = 0; i < 
UCC_HIER_SBGP_LAST
; i++) {

215 
hs
 = &
‹am
->
sbgps
[
i
];

216 ià(
hs
->
¡©e
 =ğ
UCC_HIER_SBGP_ENABLED
) {

217 ià(
hs
->
scÜe_m­
) {

218 
	`ucc_cŞl_scÜe_ä“_m­
(
hs
->
scÜe_m­
);

220 
j
 = 0; j < 
hs
->
n_s
; j++) {

221 ià(
hs
->
_‹ams
[
j
]) {

222 
	`ucc__cÚ‹xt_put
(
hs
->
_ùxs
[
j
]);

223 
d
 = &
‹am
->
‹am_ü—‹_»q
->
descs
[

224 
‹am
->
‹am_ü—‹_»q
->
n_‹ams
++];

225 
d
->
‹am
 = 
hs
->
_‹ams
[
j
];

226 
d
->
·¿m
.
·¿ms
.
oob
 = d->
‹am
->
su³r
.params.params.oob;

232 
¡©us
 = 
	`ucc__‹am_de¡roy_muÉË
(
‹am
->
‹am_ü—‹_»q
);

233 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

234  
¡©us
;

236 
i
 = 0; i < 
‹am
->
‹am_ü—‹_»q
->
n_‹ams
; i++) {

237 
	`ucc_š‹º®_oob_fš®ize
(&
‹am
->
‹am_ü—‹_»q
->

238 
descs
[
i
].
·¿m
.
·¿ms
.
oob
);

239 ià(
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].
¡©us
 !ğ
UCC_OK
) {

240 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "tleam destroy failed (%d)",

241 
¡©us
);

242 
¡©us
 = 
‹am
->
‹am_ü—‹_»q
->
descs
[
i
].status;

245 
	`ucc_‹am_muÉË_»q_ä“
(
‹am
->
‹am_ü—‹_»q
);

246 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc_ş_h›r_‹am_t
)(
ş_‹am
);

247  
¡©us
;

248 
	}
}

250 
ucc_¡©us_t
 
	$ucc_ş_h›r_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
ş_‹am
)

252 
ucc_ş_h›r_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
ş_‹am
, ucc_cl_hier_team_t);

253 
ucc_ş_h›r_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_HIER_TEAM_CTX
(
‹am
);

254 
ucc_¡©us_t
 
¡©us
;

255 
i
;

256 
ucc_cŞl_scÜe_t
 *
scÜe
, *
scÜe_m”ge
;

257 
ucc_‹am_‹am_desc
 *
d
;

258 
ucc_h›r_sbgp_t
 *
hs
;

260 
¡©us
 = 
	`ucc__‹am_ü—‹_muÉË
(
‹am
->
‹am_ü—‹_»q
);

261 ià(
¡©us
 !ğ
UCC_OK
) {

262  
¡©us
;

265 
‹am
->
is_block_Üd”ed
 = -1;

266 
‹am
->
n__‹ams
 = 0;

271 
i
 = 0; i < 
‹am
->
‹am_ü—‹_»q
->
n_‹ams
; i++) {

272 
d
 = &
‹am
->
‹am_ü—‹_»q
->
descs
[
i
];

273 
ucc_h›r_sbgp_ty³_t
 
¡
 = (ucc_h›r_sbgp_ty³_t)
d
->
¬gs
[0];

274 

 = ()
d
->
¬gs
[1];

276 
hs
 = &
‹am
->
sbgps
[
¡
];

277 ià(
d
->
¡©us
 =ğ
UCC_OK
) {

278 
hs
->
_‹ams
[

] = 
d
->
‹am
;

279 
‹am
->
n__‹ams
++;

280 
¡©us
 = 
	`UCC_TL_TEAM_IFACE
(
d
->
‹am
)->‹am.
	`g‘_scÜes
(

281 &
d
->
‹am
->
su³r
, &
scÜe
);

282 ià(
UCC_OK
 !ğ
¡©us
) {

283 
	`ş_w¬n
(
ùx
->
su³r
.su³r.
lib
, "failedo getl %s scores",

284 
	`UCC_TL_TEAM_IFACE
(
d
->
‹am
)->
su³r
.
Çme
);

288 ià(
hs
->
scÜe
 =ğ
NULL
) {

289 
hs
->
scÜe
 = score;

291 
¡©us
 =

292 
	`ucc_cŞl_scÜe_m”ge
(
hs
->
scÜe
, scÜe, &
scÜe_m”ge
, 1);

293 ià(
UCC_OK
 !ğ
¡©us
) {

294 
	`ş_w¬n
(
ùx
->
su³r
.su³r.
lib
, "failedo merge scores");

296 
hs
->
scÜe
 = 
scÜe_m”ge
;

299 
	`ş_debug
(
ùx
->
su³r
.su³r.
lib
, "initializedl %seam for sbgp %s",

300 
	`UCC_TL_CTX_IFACE
(
d
->
ùx
)->
su³r
.
Çme
,

301 
	`ucc_sbgp_¡r
(
hs
->
sbgp_ty³
));

303 
	`ş_debug
(
ùx
->
su³r
.su³r.
lib
, "failedo createl %seam",

304 
	`UCC_TL_CTX_IFACE
(
d
->
ùx
)->
su³r
.
Çme
);

305 
hs
->
_‹ams
[

] = 
NULL
;

306 
hs
->
_ùxs
[

] = 
NULL
;

307 
	`ucc__cÚ‹xt_put
(
d
->
ùx
);

311 
i
 = 0; i < 
UCC_HIER_SBGP_LAST
; i++) {

312 
hs
 = &
‹am
->
sbgps
[
i
];

313 ià(
hs
->
scÜe
 =ğ
NULL
) {

314 ià(
hs
->
¡©e
 =ğ
UCC_HIER_SBGP_ENABLED
) {

318 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

320 
	`ucc_sbgp_¡r
(
hs
->
sbgp_ty³
));

321 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

324 
hs
->
¡©e
 = 
UCC_HIER_SBGP_DISABLED
;

326 
¡©us
 = 
	`ucc_cŞl_scÜe_bud_m­
(
hs
->
scÜe
, &hs->
scÜe_m­
);

327 ià(
UCC_OK
 !ğ
¡©us
) {

328 
	`ş_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo build score map");

329 
hs
->
¡©e
 = 
UCC_HIER_SBGP_DISABLED
;

330 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

335 
	`ucc_‹am_muÉË_»q_ä“
(
‹am
->
‹am_ü—‹_»q
);

336 
‹am
->
‹am_ü—‹_»q
 = 
NULL
;

338 ià(
	`SBGP_EXISTS
(
‹am
, 
NODE_LEADERS
)) {

339 
‹am
->
tİ_sbgp
 = 
UCC_HIER_SBGP_NODE_LEADERS
;

341 
	`ucc_as£¹
(
	`SBGP_EXISTS
(
‹am
, 
NODE
));

342 
‹am
->
tİ_sbgp
 = 
UCC_HIER_SBGP_NODE
;

345  
¡©us
;

346 
	}
}

348 
ucc_¡©us_t
 
	$ucc_ş_h›r_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
ş_‹am
,

349 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

351 
ucc_ş_h›r_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
ş_‹am
, ucc_cl_hier_team_t);

352 
ucc_ba£_lib_t
 *
lib
 = 
	`UCC_CL_TEAM_LIB
(
‹am
);

353 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_CL_TEAM_CTX
(
‹am
);

354 
ucc_memÜy_ty³_t
 
mt
[
N_MT
] = {
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

355 
UCC_MEMORY_TYPE_CUDA_MANAGED
};

356 
ucc_cŞl_scÜe_t
 *
scÜe
;

357 
ucc_¡©us_t
 
¡©us
;

358 
i
;

359 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

361 
‹am_šfo
.
®g_â
 = 
ucc_ş_h›r_®g_id_to_š™
;

362 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_CL_HIER_DEFAULT_SCORE
;

363 
‹am_šfo
.
š™
 = 
ucc_ş_h›r_cŞl_š™
;

364 
‹am_šfo
.
num_mem_ty³s
 = 0;

365 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = 
NULL
;

366 
‹am_šfo
.
suµÜ‹d_cŞls
 = 
UCC_CL_HIER_SUPPORTED_COLLS
;

367 
‹am_šfo
.
size
 = 
	`UCC_CL_TEAM_SIZE
(
‹am
);

369 
¡©us
 = 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
);

370 ià(
UCC_OK
 !ğ
¡©us
) {

371 
	`ş_”rÜ
(
lib
, "faildo‡lloc score_t");

372  
¡©us
;

375 
i
 = 0; i < 
N_MT
; i++) {

376 
¡©us
 = 
	`ucc_cŞl_scÜe_add_¿nge
(

377 
scÜe
, 
UCC_COLL_TYPE_ALLTOALLV
, 
mt
[
i
], 0, 
UCC_MSG_MAX
,

379 1, 
ucc_ş_h›r_®ÉßÎv_š™
, 
ş_‹am
);

380 ià(
UCC_OK
 !ğ
¡©us
) {

381 
	`ş_”rÜ
(
lib
, "failedo‡dd„angeo score_t");

382  
¡©us
;

385 
¡©us
 = 
	`ucc_cŞl_scÜe_add_¿nge
(

386 
scÜe
, 
UCC_COLL_TYPE_ALLTOALL
, 
mt
[
i
], 0, 
UCC_MSG_MAX
,

388 1, 
ucc_ş_h›r_®ÉßÎ_š™
, 
ş_‹am
);

389 ià(
UCC_OK
 !ğ
¡©us
) {

390 
	`ş_”rÜ
(
lib
, "failedo‡dd„angeo score_t");

391  
¡©us
;

395 
¡©us
 = 
	`ucc_cŞl_scÜe_add_¿nge
(

396 
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

397 0, 
UCC_MSG_MAX
, 
UCC_CL_HIER_DEFAULT_SCORE
,

398 
ucc_ş_h›r_b¬r›r_š™
, 
ş_‹am
);

399 ià(
UCC_OK
 !ğ
¡©us
) {

400 
	`ş_”rÜ
(
lib
, "failedo‡dd„angeo score_t");

401  
¡©us
;

405 
i
 = 0; i < 
UCC_CL_HIER_N_DEFAULT_ALG_SELECT_STR
; i++) {

406 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(

407 
ucc_ş_h›r_deçuÉ_®g_£Ëù_¡r
[
i
], &
‹am_šfo
,

408 &
‹am
->
su³r
.su³r, 
scÜe
);

409 ià(
UCC_OK
 !ğ
¡©us
) {

410 
	`ş_”rÜ
(
lib
, "failedo‡pply default coll select setting: %s",

411 
ucc_ş_h›r_deçuÉ_®g_£Ëù_¡r
[
i
]);

412 
”r
;

416 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

417 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

418 &
‹am
->
su³r
.su³r, 
scÜe
);

420 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

421 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

422 
”r
;

425 *
scÜe_p
 = 
scÜe
;

426  
UCC_OK
;

427 
”r
:

428 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

429 *
scÜe_p
 = 
NULL
;

430  
¡©us
;

431 
	}
}

	@src/components/cl/hier/reduce/reduce.c

7 
	~"»duû.h
"

8 
	~"../»duû/»duû.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc_ş_h›r_»duû_®gs
[
UCC_CL_HIER_REDUCE_ALG_LAST
 + 1] = {

12 [
UCC_CL_HIER_REDUCE_ALG_2STEP
] =

13 {.
id
 = 
UCC_CL_HIER_REDUCE_ALG_2STEP
,

14 .
	gÇme
 = "2step",

15 .
	gdesc
 = "intra-node‡nd inter-node„educesƒxecuted in…arallel"},

16 [
UCC_CL_HIER_REDUCE_ALG_LAST
] = {

17 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

	@src/components/cl/hier/reduce/reduce.h

7 #iâdeà
REDUCE_H_


8 
	#REDUCE_H_


	)

9 
	~"../ş_h›r.h
"

13 
	mUCC_CL_HIER_REDUCE_ALG_2STEP
,

14 
	mUCC_CL_HIER_REDUCE_ALG_LAST
,

17 
ucc_ba£_cŞl_®g_šfo_t


18 
ucc_ş_h›r_»duû_®gs
[
UCC_CL_HIER_REDUCE_ALG_LAST
 + 1];

20 
	#UCC_CL_HIER_REDUCE_DEFAULT_ALG_SELECT_STR
 "»duû:0-4k:@2¡•"

	)

22 
ucc_¡©us_t
 
ucc_ş_h›r_»duû_2¡•_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

23 
ucc_ba£_‹am_t
 *
‹am
,

24 
ucc_cŞl_sk_t
 **
sk
);

26 
šlše
 
	$ucc_ş_h›r_»duû_®g_äom_¡r
(cÚ¡ *
¡r
)

28 
i
;

30 
i
 = 0; i < 
UCC_CL_HIER_REDUCE_ALG_LAST
; i++) {

31 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc_ş_h›r_»duû_®gs
[
i
].
Çme
)) {

35  
i
;

36 
	}
}

	@src/components/cl/hier/reduce/reduce_2step.c

7 
	~"»duû.h
"

8 
	~"cÜe/ucc_‹am.h
"

9 
	~"../ş_h›r_cŞl.h
"

11 
	#MAX_AR_2STEP_TASKS
 3

	)

13 
ucc_¡©us_t
 
	$ucc_ş_h›r_»duû_2¡•_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

15 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_reduce_2step_start", 0);

16  
	`ucc_scheduË_¡¬t
(
sk
);

17 
	}
}

19 
ucc_¡©us_t
 
	$ucc_ş_h›r_»duû_2¡•_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

21 
ucc_ş_h›r_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_cl_hier_schedule_t);

22 
ucc_¡©us_t
 
¡©us
;

24 
	`UCC_CL_HIER_PROFILE_REQUEST_EVENT
(
sk
, "cl_hier_reduce_2step_finalize", 0);

25 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

26 ià(
scheduË
->
sü©ch
) {

27 
	`ucc_mc_ä“
(
scheduË
->
sü©ch
);

29 
	`ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

30  
¡©us
;

31 
	}
}

33 
šlše
 
ucc_¿nk_t


34 
	$fšd_roÙ_Ãt_¿nk
(
ucc_ho¡_id_t
 
roÙ_ho¡_id
, 
ucc_ş_h›r_‹am_t
 *
ş_‹am
)

36 
ucc_¿nk_t
 
Ãt_¿nk
 = 
UCC_RANK_INVALID
;

37 
ucc_sbgp_t
 *
sbgp
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE_LEADERS
].sbgp;

38 
ucc_‹am_t
 *
cÜe_‹am
 = 
ş_‹am
->
su³r
.su³r.
·¿ms
.
‹am
;

39 
ucc_¿nk_t
 
i
, 
¿nk
;

41 
i
 = 0; i < 
sbgp
->
group_size
; i++) {

42 
¿nk
 = 
	`ucc_•_m­_ev®
(
sbgp
->
m­
, 
i
);

43 ià(
	`ucc_‹am_¿nk_ho¡_id
(
¿nk
, 
cÜe_‹am
è=ğ
roÙ_ho¡_id
) {

44 
Ãt_¿nk
 = 
i
;

48  
Ãt_¿nk
;

49 
	}
}

51 
šlše
 
ucc_¿nk_t


52 
	$fšd_roÙ_node_¿nk
(
ucc_¿nk_t
 
roÙ
, 
ucc_ş_h›r_‹am_t
 *
ş_‹am
)

54 
ucc_¿nk_t
 
node_¿nk
 = 
UCC_RANK_INVALID
;

55 
ucc_sbgp_t
 *
sbgp
 = 
ş_‹am
->
sbgps
[
UCC_HIER_SBGP_NODE
].sbgp;

56 
ucc_¿nk_t
 
i
;

58 
i
 = 0; i < 
sbgp
->
group_size
; i++) {

59 ià(
	`ucc_•_m­_ev®
(
sbgp
->
m­
, 
i
è=ğ
roÙ
) {

60 
node_¿nk
 = 
i
;

64  
node_¿nk
;

65 
	}
}

67 
ucc_¡©us_t


68 
	$ucc_ş_h›r_»duû_2¡•_š™_scheduË
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

69 
ucc_ba£_‹am_t
 *
‹am
,

70 
ucc_scheduË_t
 **
sched_p
, 
n_äags
)

72 
ucc_ş_h›r_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

73 
ucc_‹am_t
 *
cÜe_‹am
 = 
‹am
->
·¿ms
.team;

74 
ucc_cŞl_sk_t
 *
sks
[2] = {
NULL
, NULL};

75 
ucc_¿nk_t
 
roÙ
 = 
cŞl_¬gs
->
¬gs
.root;

76 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
ş_‹am
);

77 
ucc_ba£_cŞl_¬gs_t
 
¬gs
 = *
cŞl_¬gs
;

78 
size_t
 
couÁ
 = (
¿nk
 =ğ
roÙ
) ?

79 
¬gs
.¬gs.
d¡
.
šfo
.
couÁ
 :

80 
¬gs
.¬gs.
¤c
.
šfo
.
couÁ
;

81 
ucc_ş_h›r_scheduË_t
 *
ş_scheduË
;

82 
ucc_scheduË_t
 *
scheduË
;

83 
ucc_¡©us_t
 
¡©us
;

84 
n_sks
, 
i
, 
fœ¡_sk
, 
roÙ_Ú_loÿl_node
;

86 
roÙ_Ú_loÿl_node
 = 
	`ucc_‹am_¿nks_Ú_§me_node
(
roÙ
, 
¿nk
, 
cÜe_‹am
);

87 
n_sks
 = 0;

88 
fœ¡_sk
 = 0;

90 ià(
roÙ
 !ğ
¿nk
) {

91 
¬gs
.¬gs.
d¡
.
šfo
.
couÁ
 =‡rgs.¬gs.
¤c
.info.count;

92 
¬gs
.¬gs.
d¡
.
šfo
.
mem_ty³
 =‡rgs.¬gs.
¤c
.info.mem_type;

93 
¬gs
.¬gs.
d¡
.
šfo
.
d©©y³
 =‡rgs.¬gs.
¤c
.info.datatype;

94 
¬gs
.¬gs.
mask
 &ğ(~
UCC_COLL_ARGS_FLAG_IN_PLACE
);

97 
ş_scheduË
 = 
	`ucc_ş_h›r_g‘_scheduË
(
ş_‹am
);

98 ià(
	`ucc_uÆik–y
(!
ş_scheduË
)) {

99  
UCC_ERR_NO_MEMORY
;

102 
scheduË
 = &
ş_scheduË
->
su³r
.super;

103 
¡©us
 = 
	`ucc_scheduË_š™
(
scheduË
, &
¬gs
, 
‹am
);

104 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

105 
out
;

108 
¬gs
.
max_äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
couÁ
, 
n_äags
, 0);

109 ià(
n_äags
 > 1) {

110 
¬gs
.
mask
 |ğ
UCC_BASE_CARGS_MAX_FRAG_COUNT
;

113 
	`ucc_as£¹
(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
) ||

114 
	`SBGP_ENABLED
(
ş_‹am
, 
NODE
));

115 ià(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE
)) {

116 
¬gs
.¬gs.
roÙ
 = 
roÙ_Ú_loÿl_node


117 ? 
	`fšd_roÙ_node_¿nk
(
roÙ
, 
ş_‹am
) : 0;

119 ià((
roÙ
 !ğ
¿nk
è&& 
	`SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
)) {

120 
¡©us
 = 
	`ucc_mc_®loc
(&
ş_scheduË
->
sü©ch
,

121 
¬gs
.
max_äag_couÁ
 *

122 
	`ucc_dt_size
(
¬gs
.¬gs.
¤c
.
šfo
.
d©©y³
),

123 
¬gs
.¬gs.
¤c
.
šfo
.
mem_ty³
);

124 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

125 
out
;

127 
¬gs
.¬gs.
d¡
.
šfo
.
bufãr
 = 
ş_scheduË
->
sü©ch
->
addr
;

128 ià(
roÙ_Ú_loÿl_node
) {

129 
fœ¡_sk
 = 1;

130 
¬gs
.¬gs.
¤c
.
šfo
.
bufãr
 = 
ş_scheduË
->
sü©ch
->
addr
;

133 
¡©us
 = 
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NODE
), &
¬gs
, &
sks
[
n_sks
]);

134 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

135 
out
;

137 
n_sks
++;

140 ià(
	`SBGP_ENABLED
(
ş_‹am
, 
NODE_LEADERS
)) {

141 ià(
n_sks
 == 1) {

142 ià(
roÙ
 !ğ
¿nk
) {

143 
¬gs
.¬gs.
¤c
.
šfo
.
bufãr
 = 
roÙ_Ú_loÿl_node
 ?

144 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
bufãr
 : 
ş_scheduË
->
sü©ch
->
addr
;

146 
¬gs
.¬gs.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

147 
¬gs
.¬gs.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

150 
¬gs
.¬gs.
roÙ
 = 
	`fšd_roÙ_Ãt_¿nk
(
	`ucc_‹am_¿nk_ho¡_id
ÔoÙ, 
cÜe_‹am
),

151 
ş_‹am
);

152 
¡©us
 = 
	`ucc_cŞl_š™
(
	`SCORE_MAP
(
ş_‹am
, 
NODE_LEADERS
),

153 &
¬gs
, &
sks
[
n_sks
]);

154 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

155 
out
;

157 
n_sks
++;

160 
	`ucc_sk_subsüibe_d•
(&
scheduË
->
su³r
, 
sks
[
fœ¡_sk
],

161 
UCC_EVENT_SCHEDULE_STARTED
);

162 
	`ucc_scheduË_add_sk
(
scheduË
, 
sks
[
fœ¡_sk
]);

164 ià(
n_sks
 > 1) {

165 
	`ucc_sk_subsüibe_d•
(
sks
[
fœ¡_sk
],

166 
sks
[(
fœ¡_sk
 + 1è% 2], 
UCC_EVENT_COMPLETED
);

167 
	`ucc_scheduË_add_sk
(
scheduË
, 
sks
[(
fœ¡_sk
 + 1) % 2]);

170 
scheduË
->
su³r
.
po¡
 = 
ucc_ş_h›r_»duû_2¡•_¡¬t
;

171 
scheduË
->
su³r
.
´og»ss
 = 
NULL
;

172 
scheduË
->
su³r
.
fš®ize
 = 
ucc_ş_h›r_»duû_2¡•_fš®ize
;

173 
scheduË
->
su³r
.
Œigg”ed_po¡
 = 
ucc_Œigg”ed_po¡
;

174 *
sched_p
 = 
scheduË
;

175  
UCC_OK
;

177 
out
:

178 
i
 = 0; i < 
n_sks
; i++) {

179 
sks
[
i
]->
	`fš®ize
(tasks[i]);

181 
	`ucc_ş_h›r_put_scheduË
(
scheduË
);

182  
¡©us
;

183 
	}
}

185 
ucc_¡©us_t


186 
	$ucc_ş_h›r_»duû_2¡•_äag_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

187 
ucc_scheduË_p–šed_t
 *
¥
,

188 
ucc_ba£_‹am_t
 *
‹am
,

189 
ucc_scheduË_t
 **
äag_p
)

191 
n_äags
 = 
¥
->
su³r
.
n_sks
;

192 
ucc_¡©us_t
 
¡©us
;

194 
¡©us
 = 
	`ucc_ş_h›r_»duû_2¡•_š™_scheduË
(
cŞl_¬gs
, 
‹am
, 
äag_p
,

195 
n_äags
);

196  
¡©us
;

197 
	}
}

199 
ucc_¡©us_t


200 
	$ucc_ş_h›r_»duû_2¡•_äag_£tup
(
ucc_scheduË_p–šed_t
 *
scheduË_p
,

201 
ucc_scheduË_t
 *
äag
, 
äag_num
)

203 
ucc_ş_h›r_‹am_t
 *
ş_‹am
 = 
	`ucc_d”ived_of
(
scheduË_p
->
su³r
.su³r.
‹am
,

204 
ucc_ş_h›r_‹am_t
);

205 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
scheduË_p
->
su³r
.su³r.
b¬gs
.args;

206 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

207 
n_äags
 = 
scheduË_p
->
su³r
.
n_sks
;

208 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

209 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
ş_‹am
);

210 
size_t
 
couÁ
 = (
¿nk
 =ğ
roÙ
è? 
¬gs
->
d¡
.
šfo
.count :

211 
¬gs
->
¤c
.
šfo
.
couÁ
;

212 
size_t
 
äag_couÁ
, 
äag_off£t
;

213 
ucc_cŞl_sk_t
 *
sk
;

214 
i
;

215 
ucc_ş_h›r_scheduË_t
 *
ş_scheduË
;

216 *
sü©ch
;

218 
ş_scheduË
 = 
	`ucc_d”ived_of
(
äag
, 
ucc_ş_h›r_scheduË_t
);

219 
sü©ch
 = 
ş_scheduË
->sü©ch ? cl_scheduË->sü©ch->
addr
 : 
NULL
;

220 
äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
couÁ
, 
n_äags
, 
äag_num
);

221 
äag_off£t
 = 
	`ucc_bufãr_block_off£t
(
couÁ
, 
n_äags
, 
äag_num
);

223 
i
 = 0; i < 
äag
->
n_sks
; i++) {

224 
sk
 = 
äag
->
sks
[
i
];

225 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 = 
äag_couÁ
;

226 
sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
 = 
äag_couÁ
;

227 ià(
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 !ğ
sü©ch
) {

228 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 =

229 
	`PTR_OFFSET
(
¬gs
->
¤c
.
šfo
.
bufãr
, 
äag_off£t
 * 
dt_size
);

231 ià(
sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
bufãr
 !ğ
sü©ch
) {

232 
sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
bufãr
 =

233 
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.
bufãr
, 
äag_off£t
 * 
dt_size
);

236  
UCC_OK
;

237 
	}
}

239 
ucc_¡©us_t


240 
	$ucc_ş_h›r_»duû_2¡•_p–šed_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

242 
ucc_scheduË_p–šed_t
 *
scheduË
 =

243 
	`ucc_d”ived_of
(
sk
, 
ucc_scheduË_p–šed_t
);

245 
	`ş_debug
(
sk
->
‹am
->
cÚ‹xt
->
lib
,

248 
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
,

249 
	`ucc_d©©y³_¡r
(
sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
d©©y³
),

250 
scheduË
->
n_äags
, scheduË->
su³r
.
n_sks
);

252  
	`ucc_scheduË_p–šed_po¡
(
sk
);

253 
	}
}

255 
ucc_¡©us_t


256 
	$ucc_ş_h›r_»duû_2¡•_p–šed_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

258 
ucc_ş_h›r_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
,

259 
ucc_ş_h›r_scheduË_t
);

260 
ucc_¡©us_t
 
¡©us
;

262 
¡©us
 = 
	`ucc_scheduË_p–šed_fš®ize
(&
scheduË
->
su³r
.super.super);

263 
	`ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

264  
¡©us
;

265 
	}
}

267 
UCC_CL_HIER_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_ş_h›r_»duû_2¡•_š™
,

268 (
cŞl_¬gs
, 
‹am
, 
sk
),

269 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

270 
ucc_cŞl_sk_t
 **
sk
)

272 
ucc_ş_h›r_‹am_t
 *
	gş_‹am
 = 
ucc_d”ived_of
(
‹am
, ucc_cl_hier_team_t);

273 
ucc_ş_h›r_lib_cÚfig_t
 *
	gcfg
 = &
UCC_CL_HIER_TEAM_LIB
(
ş_‹am
)->
cfg
;

274 
ucc_ş_h›r_scheduË_t
 *
	gscheduË
;

275 
	gn_äags
, 
	gp–še_d•th
;

276 
ucc_¡©us_t
 
	g¡©us
;

278 ià(
UCC_IS_PERSISTENT
(
cŞl_¬gs
->
¬gs
) ||

279 (
	gcŞl_¬gs
->
	g¬gs
.
	gİ
 =ğ
UCC_OP_AVG
)) {

280  
UCC_ERR_NOT_SUPPORTED
;

283 
ucc_p–še_näags_pd•th
(&
cfg
->
»duû_2¡•_p–še
,

284 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
couÁ
 *

285 
ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
d©©y³
),

286 &
n_äags
, &
p–še_d•th
);

288 ià(
	gn_äags
 == 1) {

289  
ucc_ş_h›r_»duû_2¡•_š™_scheduË
(

290 
cŞl_¬gs
, 
‹am
, (
ucc_scheduË_t
 **)
sk
, 
n_äags
);

293 
	gscheduË
 = 
ucc_ş_h›r_g‘_scheduË
(
ş_‹am
);

294 ià(
ucc_uÆik–y
(!
scheduË
)) {

295  
	gUCC_ERR_NO_MEMORY
;

298 
	g¡©us
 = 
ucc_scheduË_p–šed_š™
(

299 
cŞl_¬gs
, 
‹am
, 
ucc_ş_h›r_»duû_2¡•_äag_š™
,

300 
ucc_ş_h›r_»duû_2¡•_äag_£tup
, 
p–še_d•th
, 
n_äags
,

301 
cfg
->
»duû_2¡•_p–še
.
Üd”
, &
scheduË
->
su³r
);

303 ià(
ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

304 
ş_”rÜ
(
‹am
->
cÚ‹xt
->
lib
,

306 
	g”r_pe_š™
;

309 
	gscheduË
->
	gsu³r
.su³r.su³r.
	gpo¡
 = 
ucc_ş_h›r_»duû_2¡•_p–šed_¡¬t
;

310 
	gscheduË
->
	gsu³r
.su³r.su³r.
	gfš®ize
 = 
ucc_ş_h›r_»duû_2¡•_p–šed_fš®ize
;

311 
	gscheduË
->
	gsu³r
.su³r.su³r.
	gŒigg”ed_po¡
 = 
ucc_Œigg”ed_po¡
;

312 *
	gsk
 = &
scheduË
->
su³r
.super.super;

313  
	gUCC_OK
;

315 
	g”r_pe_š™
:

316 
ucc_ş_h›r_put_scheduË
(&
scheduË
->
su³r
.super);

317  
	g¡©us
;

	@src/components/cl/ucc_cl.c

7 
	~"ucc_ş.h
"

8 
	~"uts/ucc_log.h
"

9 
	~"uts/ucc_m®loc.h
"

10 
	~"cÜe/ucc_glob®_İts.h
"

12 * 
	gucc_ş_s_doc_¡r
 = "List of TLs used by‡ given CL component.\n"

14 
	#TLS_CONFIG_ENTRY
 1

	)

15 
ucc_cÚfig_f›ld_t
 
	gucc_ş_lib_cÚfig_bË
[] = {

16 [0] = {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ş_lib_cÚfig_t
, 
su³r
),

17 
UCC_CONFIG_TYPE_TABLE
(
ucc_ba£_lib_cÚfig_bË
)},

19 [
TLS_CONFIG_ENTRY
] = {"TLS", "®l", 
NULL
,

20 
ucc_off£tof
(
ucc_ş_lib_cÚfig_t
, 
s
),

21 
UCC_CONFIG_TYPE_ALLOW_LIST
},

23 {
	gNULL
}};

25 
ucc_cÚfig_f›ld_t
 
	gucc_ş_cÚ‹xt_cÚfig_bË
[] = {

26 [0] = {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ş_cÚ‹xt_cÚfig_t
, 
su³r
),

27 
UCC_CONFIG_TYPE_TABLE
(
ucc_ba£_ùx_cÚfig_bË
)},

29 {
	gNULL
}

32 cÚ¡ *
	gucc_ş_Çmes
[] = {

33 [
UCC_CL_BASIC
] = "basic",

34 [
UCC_CL_HIER
] = "hier",

35 [
UCC_CL_DOCA_UROM
] = "doca_urom",

36 [
UCC_CL_ALL
] = "all",

37 [
UCC_CL_LAST
] = 
NULL


40 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_lib_t
, 
ucc_ş_içû_t
 *
ş_içû
,

41 cÚ¡ 
ucc_ş_lib_cÚfig_t
 *
ş_cÚfig
)

43 
ucc_¡©us_t
 
¡©us
;

45 
	`UCC_CLASS_CALL_BASE_INIT
();

46 
£lf
->
içû
 = 
ş_içû
;

47 
£lf
->
su³r
.
u£_tunšg
 = 
ş_cÚfig
->super.use_tuning;

48 
£lf
->
su³r
.
log_compÚ’t
 = 
ş_cÚfig
->super.log_component;

49 
	`ucc_¡ºıy_§ã
(
£lf
->
su³r
.
log_compÚ’t
.
Çme
,

50 
ş_içû
->
ş_lib_cÚfig
.
Çme
,

51 (
£lf
->
su³r
.
log_compÚ’t
.
Çme
));

53 
¡©us
 = 
	`ucc_cÚfig_®low_li¡_´oûss
(

54 &
ş_cÚfig
->
s
, &
ucc_glob®_cÚfig
.
_äamewÜk
.
Çmes
, &
£lf
->tls);

55 ià(
¡©us
 !ğ
UCC_OK
) {

56  
¡©us
;

58 ià(
£lf
->
s
.
¬¿y
.
couÁ
 == 0) {

59 
	`ucc_”rÜ
("nØTL ¬£Ëùed fÜ %s", 
ş_içû
->
ş_lib_cÚfig
.
Çme
);

60 
	`ucc_ä“
(
£lf
->
s
.
¬¿y
.
Çmes
);

61  
UCC_ERR_NOT_FOUND
;

63 
£lf
->
s_fÜûd
.
couÁ
 = 0;

64 
£lf
->
s_fÜûd
.
Çmes
 = 
NULL
;

65  
UCC_OK
;

66 
	}
}

68 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_lib_t
)

70 
	`ucc_cÚfig_Çmes_¬¿y_ä“
(&
£lf
->
s
.
¬¿y
);

71 
	`ucc_cÚfig_Çmes_¬¿y_ä“
(&
£lf
->
s_fÜûd
);

72 
	}
}

74 
UCC_CLASS_DEFINE
(
ucc_ş_lib_t
, );

76 
ucc_¡©us_t
 
	$ucc_·r£_şs_¡ršg
(cÚ¡ *
şs_¡r
,

77 
ucc_ş_ty³_t
 **
şs_¬¿y
, *
n_şs
)

79 
şs_£Ëùed
[
UCC_CL_LAST
] = {0};

80 
n_şs_£Ëùed
 = 0;

81 *
şs_cİy
, *
§v•Œ
, *
ş
;

82 
ucc_ş_ty³_t
 *
şs
;

83 
ucc_ş_ty³_t
 
ş_ty³
;

84 
şs_cİy
 = 
	`¡rdup
(
şs_¡r
);

85 ià(!
şs_cİy
) {

86 
	`ucc_”rÜ
("failedo create‡ copy cls string");

87  
UCC_ERR_NO_MEMORY
;

89 
ş
 = 
	`¡¹ok_r
(
şs_cİy
, ",", &
§v•Œ
);

90 
NULL
 !ğ
ş
) {

91 
ş_ty³
 = 
	`ucc_ş_Çme_to_ty³
(
ş
);

92 ià(
ş_ty³
 =ğ
UCC_CL_LAST
) {

93 
	`ucc_”rÜ
("incorrect value is…assed‡s…art of UCC_CLS†ist: %s",

94 
ş
);

95 
	`ucc_ä“
(
şs_cİy
);

96  
UCC_ERR_INVALID_PARAM
;

98 
n_şs_£Ëùed
++;

99 
şs_£Ëùed
[
ş_ty³
] = 1;

100 
ş
 = 
	`¡¹ok_r
(
NULL
, ",", &
§v•Œ
);

102 
	`ucc_ä“
(
şs_cİy
);

103 ià(
n_şs_£Ëùed
 == 0) {

104 
	`ucc_”rÜ
("incorrect value is…assed‡s…art of UCC_CLS†ist: %s",

105 
şs_¡r
);

106  
UCC_ERR_INVALID_PARAM
;

108 
şs
 = 
	`ucc_m®loc
(
n_şs_£Ëùed
 * (
ucc_ş_ty³_t
), "cls_array");

109 ià(!
şs
) {

110 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for cls_array",

111 
n_şs_£Ëùed
 * ());

112  
UCC_ERR_NO_MEMORY
;

114 
n_şs_£Ëùed
 = 0;

115 
ş_ty³
 = (
ucc_ş_ty³_t
)0; cl_ty³ < 
UCC_CL_LAST
; cl_type++) {

116 ià(
şs_£Ëùed
[
ş_ty³
]) {

117 
şs
[
n_şs_£Ëùed
++] = 
ş_ty³
;

120 *
şs_¬¿y
 = 
şs
;

121 *
n_şs
 = 
n_şs_£Ëùed
;

122  
UCC_OK
;

123 
	}
}

125 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_cÚ‹xt_t
, cÚ¡ 
ucc_ş_cÚ‹xt_cÚfig_t
 *
ş_cÚfig
,

126 
ucc_cÚ‹xt_t
 *
ucc_cÚ‹xt
)

128 
	`UCC_CLASS_CALL_BASE_INIT
();

129 
£lf
->
su³r
.
lib
 = &
ş_cÚfig
->
ş_lib
->super;

130 
£lf
->
su³r
.
ucc_cÚ‹xt
 = ucc_context;

132 ià(0 =ğ
	`¡rcmp
(
ş_cÚfig
->
su³r
.
scÜe_¡r
, "0")) {

133  
UCC_ERR_LAST
;

135 
£lf
->
su³r
.
scÜe_¡r
 = 
	`¡rdup
(
ş_cÚfig
->super.score_str);

137  
UCC_OK
;

138 
	}
}

140 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_cÚ‹xt_t
)

142 
	`ucc_ä“
(
£lf
->
su³r
.
scÜe_¡r
);

143 
	}
}

145 
UCC_CLASS_DEFINE
(
ucc_ş_cÚ‹xt_t
, );

147 
ucc_¡©us_t
 
	$ucc_ş_cÚ‹xt_cÚfig_»ad
(
ucc_ş_lib_t
 *
ş_lib
,

148 cÚ¡ 
ucc_cÚ‹xt_cÚfig_t
 *
cÚfig
,

149 
ucc_ş_cÚ‹xt_cÚfig_t
 **
ş_cÚfig
)

151 
ucc_¡©us_t
 
¡©us
;

152 
¡©us
 = 
	`ucc_ba£_cÚfig_»ad
(
cÚfig
->
lib
->
fuÎ_´efix
,

153 &
ş_lib
->
içû
->
ş_cÚ‹xt_cÚfig
,

154 (
ucc_ba£_cÚfig_t
 **)
ş_cÚfig
);

155 ià(
UCC_OK
 =ğ
¡©us
) {

156 (*
ş_cÚfig
)->
ş_lib
 = cl_lib;

158  
¡©us
;

159 
	}
}

161 
ucc_¡©us_t
 
	$ucc_ş_lib_cÚfig_»ad
(
ucc_ş_içû_t
 *
içû
,

162 cÚ¡ *
fuÎ_´efix
,

163 
ucc_ş_lib_cÚfig_t
 **
ş_cÚfig
)

165 *
s_li¡
;

166 *
doc_¡r
;

167 
size_t
 
doc_Ën
;

168 ià(!
ucc_ş_lib_cÚfig_bË
[
TLS_CONFIG_ENTRY
].
doc
) {

169 
s_li¡
 = 
	`ucc_g‘_äamewÜk_compÚ’ts_li¡
(

170 &
ucc_glob®_cÚfig
.
_äamewÜk
, ",");

171 ià(
s_li¡
) {

172 
doc_Ën
 = 
	`¡¾’
(
ucc_ş_s_doc_¡r
è+ sŒËn(
s_li¡
) + 1;

173 
doc_¡r
 = 
	`ucc_m®loc
(
doc_Ën
, "cl_tls_doc");

174 ià(!
doc_¡r
) {

175 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for cl_tls_doc",

176 
doc_Ën
);

178 
	`ucc_¢´štf_§ã
(
doc_¡r
, 
doc_Ën
, "%s%s", 
ucc_ş_s_doc_¡r
,

179 
s_li¡
);

180 
ucc_ş_lib_cÚfig_bË
[
TLS_CONFIG_ENTRY
].
doc
 = 
doc_¡r
;

182 
	`ucc_ä“
(
s_li¡
);

185  
	`ucc_ba£_cÚfig_»ad
(
fuÎ_´efix
, &
içû
->
ş_lib_cÚfig
,

186 (
ucc_ba£_cÚfig_t
 **)
ş_cÚfig
);

187 
	}
}

189 
	$UCC_CLASS_INIT_FUNC
(
ucc_ş_‹am_t
, 
ucc_ş_cÚ‹xt_t
 *
ş_cÚ‹xt
,

190 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

192 
	`UCC_CLASS_CALL_BASE_INIT
();

193 
£lf
->
su³r
.
cÚ‹xt
 = &
ş_cÚ‹xt
->super;

194 
£lf
->
su³r
.
·¿ms
 = *params;

195  
UCC_OK
;

196 
	}
}

198 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc_ş_‹am_t
)

200 
	}
}

202 
UCC_CLASS_DEFINE
(
ucc_ş_‹am_t
, );

	@src/components/cl/ucc_cl.h

7 
	~"cÚfig.h
"

9 #iâdeà
UCC_CL_H_


10 
	#UCC_CL_H_


	)

12 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

13 
	~"ucc_ş_ty³.h
"

14 
	~"uts/ucc_·r£r.h
"

15 
	~"cÜe/ucc_cÚ‹xt.h
"

34 
ucc_ş_lib
 
	tucc_ş_lib_t
;

35 
ucc_ş_içû
 
	tucc_ş_içû_t
;

36 
ucc_ş_cÚ‹xt
 
	tucc_ş_cÚ‹xt_t
;

37 
ucc_ş_‹am
 
	tucc_ş_‹am_t
;

38 
ucc__cÚ‹xt
 
	tucc__cÚ‹xt_t
;

40 
	succ_ş_lib_cÚfig
 {

41 
ucc_ba£_lib_cÚfig_t
 
	msu³r
;

42 
ucc_ş_içû_t
 *
	miçû
;

43 
ucc_cÚfig_®low_li¡_t
 
	ms
;

44 } 
	tucc_ş_lib_cÚfig_t
;

45 
ucc_cÚfig_f›ld_t
 
ucc_ş_lib_cÚfig_bË
[];

48 
	succ_ş_cÚ‹xt_cÚfig
 {

49 
ucc_ba£_ùx_cÚfig_t
 
	msu³r
;

50 
ucc_ş_lib_t
 *
	mş_lib
;

51 } 
	tucc_ş_cÚ‹xt_cÚfig_t
;

52 
ucc_cÚfig_f›ld_t
 
ucc_ş_cÚ‹xt_cÚfig_bË
[];

54 
ucc_¡©us_t
 
ucc_ş_cÚ‹xt_cÚfig_»ad
(
ucc_ş_lib_t
 *
ş_lib
,

55 cÚ¡ 
ucc_cÚ‹xt_cÚfig_t
 *
cÚfig
,

56 
ucc_ş_cÚ‹xt_cÚfig_t
 **
ş_cÚfig
);

58 
ucc_¡©us_t
 
ucc_ş_lib_cÚfig_»ad
(
ucc_ş_içû_t
 *
içû
,

59 cÚ¡ *
fuÎ_´efix
,

60 
ucc_ş_lib_cÚfig_t
 **
ş_cÚfig
);

62 
	succ_ş_içû
 {

63 
ucc_compÚ’t_içû_t
 
	msu³r
;

64 
ucc_ş_ty³_t
 
	mty³
;

65 
ucc_cÚfig_glob®_li¡_’Œy_t
 
	mş_lib_cÚfig
;

66 
ucc_cÚfig_glob®_li¡_’Œy_t
 
	mş_cÚ‹xt_cÚfig
;

67 
ucc_ba£_lib_içû_t
 
	mlib
;

68 
ucc_ba£_cÚ‹xt_içû_t
 
	mcÚ‹xt
;

69 
ucc_ba£_‹am_içû_t
 
	m‹am
;

70 
ucc_ba£_cŞl_içû_t
 
	mcŞl
;

71 
ucc_ba£_cŞl_®g_šfo_t
 * 
	m®g_šfo
[
UCC_COLL_TYPE_NUM
];

72 } 
	tucc_ş_içû_t
;

74 
	succ_ş_lib
 {

75 
ucc_ba£_lib_t
 
	msu³r
;

76 
ucc_ş_içû_t
 *
	miçû
;

77 
ucc_cÚfig_Çmes_li¡_t
 
	ms
;

78 
ucc_cÚfig_Çmes_¬¿y_t
 
	ms_fÜûd
;

80 } 
	tucc_ş_lib_t
;

81 
UCC_CLASS_DECLARE
(
ucc_ş_lib_t
, 
ucc_ş_içû_t
 *, cÚ¡ 
ucc_ş_lib_cÚfig_t
 *);

83 
	succ_ş_cÚ‹xt
 {

84 
ucc_ba£_cÚ‹xt_t
 
	msu³r
;

85 
ucc__cÚ‹xt_t
 **
	m_ùxs
;

86 
	mn__ùxs
;

87 } 
	tucc_ş_cÚ‹xt_t
;

88 
UCC_CLASS_DECLARE
(
ucc_ş_cÚ‹xt_t
, cÚ¡ 
ucc_ş_cÚ‹xt_cÚfig_t
 *,

89 
ucc_cÚ‹xt_t
 *);

91 
	succ_ş_‹am
 {

92 
ucc_ba£_‹am_t
 
	msu³r
;

93 } 
	tucc_ş_‹am_t
;

94 
UCC_CLASS_DECLARE
(
ucc_ş_‹am_t
, 
ucc_ş_cÚ‹xt_t
 *,

95 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

97 
	succ_ş_lib_©Œ
 {

98 
ucc_ba£_lib_©Œ_t
 
	msu³r
;

99 
ucc_cÚfig_Çmes_¬¿y_t
 *
	ms
;

100 
ucc_cÚfig_Çmes_¬¿y_t
 *
	ms_fÜûd
;

101 } 
	tucc_ş_lib_©Œ_t
;

103 
	#UCC_CL_IFACE_DECLARE
(
_Çme
, 
_NAME
) \

104 
	`UCC_BASE_IFACE_DECLARE
(
CL_
, 
ş_
, 
_Çme
, 
_NAME
) \

105 
	`__©Œibu‹__
((
cÚ¡ruùÜ
)è
ucc_ş_
 ## 
_Çme
 ## \

106 
	`_içû_cÚ¡ruù
() { \

107 
ucc_ş_
 ## 
_Çme
 .
su³r
.
ty³
 = 
UCC_CL_
 ## 
_NAME
; \

109 

	)

110 
	#UCC_CL_CTX_IFACE
(
_ş_ùx
) \

111 (
	`ucc_d”ived_of
((
_ş_ùx
)->
su³r
.
lib
, 
ucc_ş_lib_t
))->
içû


	)

113 
	#UCC_CL_TEAM_IFACE
(
_ş_‹am
) \

114 (
	`ucc_d”ived_of
((
_ş_‹am
)->
su³r
.
cÚ‹xt
->
lib
, 
ucc_ş_lib_t
))->
içû


	)

116 
	#UCC_CL_TEAM_LIB
(
_ş_‹am
è(_ş_‹am)->
su³r
.su³r.
cÚ‹xt
->
lib


	)

118 
	#UCC_CL_TEAM_CTX
(
_ş_‹am
è(_ş_‹am)->
su³r
.su³r.
cÚ‹xt


	)

120 
	#UCC_CL_TEAM_SIZE
(
_ş_‹am
è(_ş_‹am)->
su³r
.su³r.
·¿ms
.
size


	)

122 
	#UCC_CL_TEAM_RANK
(
_ş_‹am
è(_ş_‹am)->
su³r
.su³r.
·¿ms
.
¿nk


	)

	@src/components/cl/ucc_cl_log.h

7 #iâdeà
UCC_CL_LOG_H_


8 
	#UCC_CL_LOG_H_


	)

9 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

11 
	#ş_”rÜ
(
_ş_lib
, 
_fmt
, ...è
	`ba£_”rÜ
((
ucc_ba£_lib_t
*)(_ş_lib), _fmt, ## 
__VA_ARGS__
)

	)

12 
	#ş_w¬n
(
_ş_lib
, 
_fmt
, ...è
	`ba£_w¬n
((
ucc_ba£_lib_t
*)(_ş_lib), _fmt, ## 
__VA_ARGS__
)

	)

13 
	#ş_šfo
(
_ş_lib
, 
_fmt
, ...è
	`ba£_šfo
((
ucc_ba£_lib_t
*)(_ş_lib), _fmt, ## 
__VA_ARGS__
)

	)

14 
	#ş_debug
(
_ş_lib
, 
_fmt
, ...è
	`ba£_debug
((
ucc_ba£_lib_t
*)(_ş_lib), _fmt, ## 
__VA_ARGS__
)

	)

15 
	#ş_Œaû
(
_ş_lib
, 
_fmt
, ...è
	`ba£_Œaû
((
ucc_ba£_lib_t
*)(_ş_lib), _fmt, ## 
__VA_ARGS__
)

	)

	@src/components/cl/ucc_cl_type.h

6 #iâdeà
UCC_CL_TYPE_H_


7 
	#UCC_CL_TYPE_H_


	)

9 
	~<¡ršg.h
>

12 
	mUCC_CL_BASIC
,

13 
	mUCC_CL_HIER
,

14 
	mUCC_CL_DOCA_UROM
,

15 
	mUCC_CL_ALL
,

16 
	mUCC_CL_LAST


17 } 
	tucc_ş_ty³_t
;

19 cÚ¡ *
ucc_ş_Çmes
[];

21 
šlše
 
ucc_ş_ty³_t
 
	$ucc_ş_Çme_to_ty³
(cÚ¡ *
ş_Çme
)

23 
i
;

24 
i
 = 0; i < 
UCC_CL_LAST
; i++) {

25 ià(0 =ğ
	`¡rcmp
(
ş_Çme
, 
ucc_ş_Çmes
[
i
])) {

29  (
ucc_ş_ty³_t
)
i
;

30 
	}
}

35 
ucc_¡©us_t
 
ucc_·r£_şs_¡ršg
(cÚ¡ *
şs_¡r
,

36 
ucc_ş_ty³_t
 **
şs_¬¿y
, *
n_şs
);

	@src/components/ec/base/ucc_ec_base.c

7 
	~"ucc_ec_ba£.h
"

9 
ucc_cÚfig_f›ld_t
 
	gucc_ec_cÚfig_bË
[] = {

15 
ucc_off£tof
(
ucc_ec_cÚfig_t
, 
log_compÚ’t
), 
UCC_CONFIG_TYPE_LOG_COMP
},

17 {
NULL
}};

	@src/components/ec/base/ucc_ec_base.h

7 #iâdeà
UCC_EC_BASE_H_


8 
	#UCC_EC_BASE_H_


	)

10 
	~"cÚfig.h
"

11 
	~"uts/ucc_compÚ’t.h
"

12 
	~"uts/ucc_şass.h
"

13 
	~"uts/ucc_·r£r.h
"

15 
	succ_ec_cÚfig
 {

16 
ucc_log_compÚ’t_cÚfig_t
 
	mlog_compÚ’t
;

17 } 
	tucc_ec_cÚfig_t
;

18 
ucc_cÚfig_f›ld_t
 
ucc_ec_cÚfig_bË
[];

20 
	succ_ec_·¿ms
 {

21 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

22 } 
	tucc_ec_·¿ms_t
;

27 
	eucc_ec_©Œ_f›ld
 {

28 
	mUCC_EC_ATTR_FIELD_THREAD_MODE
 = 
UCC_BIT
(0),

29 
	mUCC_EC_ATTR_FILED_MAX_EXECUTORS_BUFS
 = 
UCC_BIT
(1)

30 } 
	tucc_ec_©Œ_f›ld_t
;

32 
	succ_ec_©Œ
 {

37 
ušt64_t
 
	mf›ld_mask
;

38 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

43 
	mmax_“_bufs
;

44 } 
	tucc_ec_©Œ_t
;

46 
	succ_ec_İs
 {

47 
ucc_¡©us_t
 (*
ü—‹_ev’t
)(**
	mev’t
);

48 
ucc_¡©us_t
 (*
de¡roy_ev’t
)(*
	mev’t
);

49 
ucc_¡©us_t
 (*
ev’t_po¡
)(*
	m“_cÚ‹xt
, *
	mev’t
);

50 
ucc_¡©us_t
 (*
ev’t_‹¡
)(*
	mev’t
);

51 } 
	tucc_ec_İs_t
;

53 
	succ_“_executÜ
 {

54 
ucc_“_ty³_t
 
	m“_ty³
;

55 *
	m“_cÚ‹xt
;

56 } 
	tucc_“_executÜ_t
;

58 
	eucc_“_executÜ_·¿ms_f›ld
 {

59 
	mUCC_EE_EXECUTOR_PARAM_FIELD_TYPE
 = 
UCC_BIT
(0),

60 
	mUCC_EE_EXECUTOR_PARAM_FIELD_TASK_TYPES
 = 
UCC_BIT
(1),

63 
	eucc_“_executÜ_sk_ty³
 {

64 
	mUCC_EE_EXECUTOR_TASK_REDUCE
 = 
UCC_BIT
(0),

65 
	mUCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
 = 
UCC_BIT
(1),

66 
	mUCC_EE_EXECUTOR_TASK_REDUCE_MULTI_DST
 = 
UCC_BIT
(2),

67 
	mUCC_EE_EXECUTOR_TASK_COPY
 = 
UCC_BIT
(3),

68 
	mUCC_EE_EXECUTOR_TASK_COPY_MULTI
 = 
UCC_BIT
(4),

69 
	mUCC_EE_EXECUTOR_TASK_LAST


70 } 
	tucc_“_executÜ_sk_ty³_t
;

72 
	succ_“_executÜ_·¿ms
 {

73 
ušt64_t
 
	mmask
;

74 
ucc_“_ty³_t
 
	m“_ty³
;

75 
ušt64_t
 
	msk_ty³s
;

76 } 
	tucc_“_executÜ_·¿ms_t
;

78 
	#UCC_EE_EXECUTOR_NUM_BUFS
 9

	)

82 
	#UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
 7

	)

98 
	succ_“e_sk_»duû
 {

99 * 
	md¡
;

101 * 
	m¤cs
[
UCC_EE_EXECUTOR_NUM_BUFS
];

102 **
	m¤cs_ext
;

104 
size_t
 
	mcouÁ
;

105 
	m®pha
;

106 
ucc_d©©y³_t
 
	mdt
;

107 
ucc_»duùiÚ_İ_t
 
	mİ
;

108 
ušt16_t
 
	mn_¤cs
;

109 } 
	tucc_“e_sk_»duû_t
;

113 
	succ_“e_sk_»duû_muÉi_d¡
 {

114 *
	md¡
[
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
];

115 *
	m¤c1
[
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
];

116 *
	m¤c2
[
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
];

117 
size_t
 
	mcouÁs
[
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
];

118 
ucc_d©©y³_t
 
	mdt
;

119 
ucc_»duùiÚ_İ_t
 
	mİ
;

120 
ušt16_t
 
	mn_bufs
;

121 } 
	tucc_“e_sk_»duû_muÉi_d¡_t
;

131 
	succ_“e_sk_»duû_¡rided
 {

132 * 
	md¡
;

133 * 
	m¤c1
;

134 * 
	m¤c2
;

135 
size_t
 
	m¡ride
;

136 
size_t
 
	mcouÁ
;

137 
	m®pha
;

138 
ucc_d©©y³_t
 
	mdt
;

139 
ucc_»duùiÚ_İ_t
 
	mİ
;

140 
ušt16_t
 
	mn_¤c2
;

141 } 
	tucc_“e_sk_»duû_¡rided_t
;

144 
	succ_“e_sk_cİy
 {

145 * 
	m¤c
;

146 * 
	md¡
;

147 
size_t
 
	mËn
;

148 } 
	tucc_“e_sk_cİy_t
;

150 
	eucc_“e_sk_æags
 {

151 
	mUCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
 = 
UCC_BIT
(0),

152 
	mUCC_EEE_TASK_FLAG_REDUCE_SRCS_EXT
 = 
UCC_BIT
(1)

156 
	succ_“e_sk_cİy_muÉi
{

157 *
	m¤c
[
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
];

158 *
	md¡
[
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
];

159 
size_t
 
	mcouÁs
[
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
];

160 
size_t
 
	mnum_veùÜs
;

161 } 
	tucc_“e_sk_cİy_muÉi_t
;

163 
	succ_“_executÜ_sk_¬gs
 {

164 
ušt16_t
 
	msk_ty³
;

165 
ušt16_t
 
	mæags
;

167 
ucc_“e_sk_»duû_t
 
	m»duû
;

168 
ucc_“e_sk_»duû_¡rided_t
 
	m»duû_¡rided
;

169 
ucc_“e_sk_»duû_muÉi_d¡_t
 
	m»duû_muÉi_d¡
;

170 
ucc_“e_sk_cİy_t
 
	mcİy
;

171 
ucc_“e_sk_cİy_muÉi_t
 
	mcİy_muÉi
;

173 } 
	tucc_“_executÜ_sk_¬gs_t
;

175 
	succ_“_executÜ_sk
 {

176 
ucc_“_executÜ_t
 *
	m“e
;

177 
ucc_“_executÜ_sk_¬gs_t
 
	m¬gs
;

178 
ucc_¡©us_t
 
	m¡©us
;

179 } 
	tucc_“_executÜ_sk_t
;

181 
	succ_“_executÜ_İs
 {

182 
ucc_¡©us_t
 (*
š™
)(cÚ¡ 
ucc_“_executÜ_·¿ms_t
 *
	m·¿ms
,

183 
ucc_“_executÜ_t
 **
	mexecutÜ
);

184 
ucc_¡©us_t
 (*
¡©us
)(cÚ¡ 
ucc_“_executÜ_t
 *
	mexecutÜ
);

185 
ucc_¡©us_t
 (*
¡¬t
)(
ucc_“_executÜ_t
 *
	mexecutÜ
,

186 *
	m“_cÚ‹xt
);

187 
ucc_¡©us_t
 (*
¡İ
)(
ucc_“_executÜ_t
 *
	mexecutÜ
);

188 
ucc_¡©us_t
 (*
fš®ize
)(
ucc_“_executÜ_t
 *
	mexecutÜ
);

189 
ucc_¡©us_t
 (*
sk_po¡
)(
ucc_“_executÜ_t
 *
	mexecutÜ
,

190 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
	msk_¬gs
,

191 
ucc_“_executÜ_sk_t
 **
	msk
);

192 
ucc_¡©us_t
 (*
sk_‹¡
)(cÚ¡ 
ucc_“_executÜ_sk_t
 *
	msk
);

193 
ucc_¡©us_t
 (*
sk_fš®ize
)(
ucc_“_executÜ_sk_t
 *
	msk
);

194 } 
	tucc_“_executÜ_İs_t
;

196 
	succ_ec_ba£
 {

197 
ucc_compÚ’t_içû_t
 
	msu³r
;

198 
ušt32_t
 
	m»f_út
;

199 
ucc_“_ty³_t
 
	mty³
;

200 
ucc_ec_cÚfig_t
 *
	mcÚfig
;

201 
ucc_cÚfig_glob®_li¡_’Œy_t
 
	mcÚfig_bË
;

202 
ucc_¡©us_t
 (*
š™
)(cÚ¡ 
ucc_ec_·¿ms_t
 *
	mec_·¿ms
);

203 
ucc_¡©us_t
 (*
g‘_©Œ
)(
ucc_ec_©Œ_t
 *
	mec_©Œ
);

204 
ucc_¡©us_t
 (*
fš®ize
)();

205 
ucc_ec_İs_t
 
	mİs
;

206 
ucc_“_executÜ_İs_t
 
	mexecutÜ_İs
;

207 } 
	tucc_ec_ba£_t
;

	@src/components/ec/cpu/ec_cpu.c

7 
	~"ec_ıu.h
"

8 
	~"uts/¬ch/ıu.h
"

9 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
	~<lim™s.h
>

12 
ucc_cÚfig_f›ld_t
 
	gucc_ec_ıu_cÚfig_bË
[] = {

13 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ec_ıu_cÚfig_t
, 
su³r
),

14 
UCC_CONFIG_TYPE_TABLE
(
ucc_ec_cÚfig_bË
)},

16 {
NULL
}

20 
ucc_¡©us_t
 
	$ucc_ec_ıu_š™
(cÚ¡ 
ucc_ec_·¿ms_t
 *
ec_·¿ms
)

22 
ucc_¡©us_t
 
¡©us
;

24 
	`ucc_¡ºıy_§ã
(
ucc_ec_ıu
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
,

25 
ucc_ec_ıu
.
su³r
.su³r.
Çme
,

26 (
ucc_ec_ıu
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
));

27 
ucc_ec_ıu
.
th»ad_mode
 = 
ec_·¿ms
->thread_mode;

29 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
ucc_ec_ıu
.
executÜs
, 0, (
ucc_“_executÜ_t
),

30 0, 
UCC_CACHE_LINE_SIZE
, 16, 
UINT_MAX
, 
NULL
,

31 
ec_·¿ms
->
th»ad_mode
, "ec cpuƒxecutors");

32 ià(
¡©us
 !ğ
UCC_OK
) {

33 
	`ec_”rÜ
(&
ucc_ec_ıu
.
su³r
, "failedo createdƒc cpuƒxecutors mpool");

34  
¡©us
;

37 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
ucc_ec_ıu
.
executÜ_sks
, 0,

38 (
ucc_“_executÜ_sk_t
),

39 0, 
UCC_CACHE_LINE_SIZE
, 16, 
UINT_MAX
, 
NULL
,

40 
ec_·¿ms
->
th»ad_mode
, "ec cpuƒxecutorasks");

41 ià(
¡©us
 !ğ
UCC_OK
) {

42 
	`ec_”rÜ
(&
ucc_ec_ıu
.
su³r
,

44 
	`ucc_mpoŞ_ş—nup
(&
ucc_ec_ıu
.
executÜs
, 1);

45  
¡©us
;

48  
UCC_OK
;

49 
	}
}

51 
ucc_¡©us_t
 
	$ucc_ec_ıu_g‘_©Œ
(
ucc_ec_©Œ_t
 *
ec_©Œ
)

53 ià(
ec_©Œ
->
f›ld_mask
 & 
UCC_EC_ATTR_FIELD_THREAD_MODE
) {

54 
ec_©Œ
->
th»ad_mode
 = 
ucc_ec_ıu
.thread_mode;

57  
UCC_OK
;

58 
	}
}

60 
ucc_¡©us_t
 
	$ucc_ec_ıu_fš®ize
()

62 
	`ucc_mpoŞ_ş—nup
(&
ucc_ec_ıu
.
executÜs
, 1);

63 
	`ucc_mpoŞ_ş—nup
(&
ucc_ec_ıu
.
executÜ_sks
, 1);

65  
UCC_OK
;

66 
	}
}

68 
ucc_¡©us_t
 
	$ucc_ıu_executÜ_š™
(cÚ¡ 
ucc_“_executÜ_·¿ms_t
 *
·¿ms
,

69 
ucc_“_executÜ_t
 **
executÜ
)

71 
ucc_“_executÜ_t
 *
“e
 = 
	`ucc_mpoŞ_g‘
(&
ucc_ec_ıu
.
executÜs
);

73 
	`ec_Œaû
(&
ucc_ec_ıu
.
su³r
, "executÜ in™,ƒ“: %p", 
“e
);

74 ià(
	`ucc_uÆik–y
(!
“e
)) {

75 
	`ec_”rÜ
(&
ucc_ec_ıu
.
su³r
, "failedo‡llocateƒxecutor");

76  
UCC_ERR_NO_MEMORY
;

79 
“e
->
“_ty³
 = 
·¿ms
->ee_type;

80 *
executÜ
 = 
“e
;

82  
UCC_OK
;

83 
	}
}

85 
ucc_¡©us_t
 
	$ucc_ıu_executÜ_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

86 *
“_cÚ‹xt
)

88  
UCC_OK
;

89 
	}
}

91 
ucc_¡©us_t
 
	$ucc_ıu_executÜ_¡©us
(cÚ¡ 
ucc_“_executÜ_t
 *
executÜ
)

93  
UCC_OK
;

94 
	}
}

96 
ucc_¡©us_t
 
	$ucc_ıu_executÜ_¡İ
(
ucc_“_executÜ_t
 *
executÜ
)

98  
UCC_OK
;

99 
	}
}

101 
ucc_¡©us_t
 
	$ucc_ıu_executÜ_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

102 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

103 
ucc_“_executÜ_sk_t
 **
sk
)

105 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

106 
ucc_“_executÜ_sk_t
 *
“e_sk
;

108 
“e_sk
 = 
	`ucc_mpoŞ_g‘
(&
ucc_ec_ıu
.
executÜ_sks
);

109 ià(
	`ucc_uÆik–y
(!
“e_sk
)) {

110  
UCC_ERR_NO_MEMORY
;

113 
“e_sk
->
“e
 = 
executÜ
;

114 
sk_¬gs
->
sk_ty³
) {

115 
UCC_EE_EXECUTOR_TASK_REDUCE
:

116 
¡©us
 = 
	`ucc_ec_ıu_»duû
((
ucc_“e_sk_»duû_t
 *)&
sk_¬gs
->
»duû
,ask_¬gs->»duû.
d¡
,

117 (
sk_¬gs
->
æags
 &

118 
UCC_EEE_TASK_FLAG_REDUCE_SRCS_EXT
) ?

119 
sk_¬gs
->
»duû
.
¤cs_ext
 :

120 
sk_¬gs
->
»duû
.
¤cs
,

121 
sk_¬gs
->
æags
);

122 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

123 
ä“_sk
;

126 
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
:

128 
ucc_“e_sk_»duû_¡rided_t
 *
Œs
 =

129 (
ucc_“e_sk_»duû_¡rided_t
 *)&
sk_¬gs
->
»duû_¡rided
;

130 
size_t
 
n_¤cs
 = 
Œs
->
n_¤c2
 + 1;

131 
ušt16_t
 
æags
 = 
sk_¬gs
->flags;

132 ** 
¤cs
;

133 
ucc_“e_sk_»duû_t
 
Œ
;

134 
i
;

136 ià(
n_¤cs
 <ğ
UCC_EE_EXECUTOR_NUM_BUFS
) {

137 
¤cs
 = &
Œ
.srcs[0];

139 
¤cs
 = 
	`®loÿ
(
n_¤cs
 * (*));

140 
æags
 |ğ
UCC_EEE_TASK_FLAG_REDUCE_SRCS_EXT
;

141 
Œ
.
¤cs_ext
 = 
¤cs
;

143 
¤cs
[0] = 
Œs
->
¤c1
;

144 
i
 = 0; i < 
n_¤cs
 - 1; i++) {

145 
¤cs
[
i
 + 1] = 
	`PTR_OFFSET
(
Œs
->
¤c2
,rs->
¡ride
 * i);

147 
Œ
.
couÁ
 = 
Œs
->count;

148 
Œ
.
dt
 = 
Œs
->dt;

149 
Œ
.
İ
 = 
Œs
->op;

150 
Œ
.
n_¤cs
 =‚_srcs;

151 
Œ
.
d¡
 = 
Œs
->dst;

152 
Œ
.
®pha
 = 
Œs
->alpha;

154 
¡©us
 = 
	`ucc_ec_ıu_»duû
(&
Œ
,r.
d¡
, 
¤cs
, 
æags
);

155 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

156 
ä“_sk
;

159 
UCC_EE_EXECUTOR_TASK_COPY
:

160 
	`memıy
(
sk_¬gs
->
cİy
.
d¡
,ask_¬gs->cİy.
¤c
,ask_¬gs->cİy.
Ën
);

162 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
:

164 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

165 
ä“_sk
;

167 
“e_sk
->
¡©us
 = status;

168 *
sk
 = 
“e_sk
;

170  
¡©us
;

172 
ä“_sk
:

173 
	`ucc_mpoŞ_put
(
“e_sk
);

174  
¡©us
;

175 
	}
}

177 
ucc_¡©us_t
 
	$ucc_ıu_executÜ_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
)

179  
sk
->
¡©us
;

180 
	}
}

182 
ucc_¡©us_t
 
	$ucc_ıu_executÜ_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
)

184 
	`ucc_mpoŞ_put
(
sk
);

185  
UCC_OK
;

186 
	}
}

188 
ucc_¡©us_t
 
	$ucc_ıu_executÜ_fš®ize
(
ucc_“_executÜ_t
 *
executÜ
)

190 
	`ec_Œaû
(&
ucc_ec_ıu
.
su³r
, "executÜ fš®ize,ƒ“: %p", 
executÜ
);

191 
	`ucc_mpoŞ_put
(
executÜ
);

193  
UCC_OK
;

194 
	}
}

196 
ucc_ec_ıu_t
 
	gucc_ec_ıu
 = {

197 .
su³r
.su³r.
Çme
 = "cpuƒc",

198 .
	gsu³r
.
	g»f_út
 = 0,

199 .
	gsu³r
.
	gty³
 = 
UCC_EE_CPU_THREAD
,

200 .
	gsu³r
.
	gš™
 = 
ucc_ec_ıu_š™
,

201 .
	gsu³r
.
	gg‘_©Œ
 = 
ucc_ec_ıu_g‘_©Œ
,

202 .
	gsu³r
.
	gfš®ize
 = 
ucc_ec_ıu_fš®ize
,

203 .
	gsu³r
.
	gcÚfig_bË
 =

205 .
Çme
 = "CPUƒxecution component",

206 .
	g´efix
 = "EC_CPU_",

207 .
	gbË
 = 
ucc_ec_ıu_cÚfig_bË
,

208 .
	gsize
 = (
ucc_ec_ıu_cÚfig_t
),

210 .
	gsu³r
.
	gİs
.
	gü—‹_ev’t
 = 
NULL
,

211 .
	gsu³r
.
	gİs
.
	gde¡roy_ev’t
 = 
NULL
,

212 .
	gsu³r
.
	gİs
.
	gev’t_po¡
 = 
NULL
,

213 .
	gsu³r
.
	gİs
.
	gev’t_‹¡
 = 
NULL
,

214 .
	gsu³r
.
	gexecutÜ_İs
.
	gš™
 = 
ucc_ıu_executÜ_š™
,

215 .
	gsu³r
.
	gexecutÜ_İs
.
	g¡¬t
 = 
ucc_ıu_executÜ_¡¬t
,

216 .
	gsu³r
.
	gexecutÜ_İs
.
	g¡©us
 = 
ucc_ıu_executÜ_¡©us
,

217 .
	gsu³r
.
	gexecutÜ_İs
.
	g¡İ
 = 
ucc_ıu_executÜ_¡İ
,

218 .
	gsu³r
.
	gexecutÜ_İs
.
	gsk_po¡
 = 
ucc_ıu_executÜ_sk_po¡
,

219 .
	gsu³r
.
	gexecutÜ_İs
.
	gsk_‹¡
 = 
ucc_ıu_executÜ_sk_‹¡
,

220 .
	gsu³r
.
	gexecutÜ_İs
.
	gsk_fš®ize
 = 
ucc_ıu_executÜ_sk_fš®ize
,

221 .
	gsu³r
.
	gexecutÜ_İs
.
	gfš®ize
 = 
ucc_ıu_executÜ_fš®ize
,

224 
UCC_CONFIG_REGISTER_TABLE_ENTRY
(&
ucc_ec_ıu
.
su³r
.
cÚfig_bË
,

225 &
ucc_cÚfig_glob®_li¡
);

	@src/components/ec/cpu/ec_cpu.h

7 #iâdeà
UCC_EC_CPU_H_


8 
	#UCC_EC_CPU_H_


	)

10 
	~"compÚ’ts/ec/ba£/ucc_ec_ba£.h
"

11 
	~"compÚ’ts/ec/ucc_ec_log.h
"

12 
	~"uts/ucc_mpoŞ.h
"

14 
	succ_ec_ıu_cÚfig
 {

15 
ucc_ec_cÚfig_t
 
	msu³r
;

16 } 
	tucc_ec_ıu_cÚfig_t
;

18 
	succ_ec_ıu
 {

19 
ucc_ec_ba£_t
 
	msu³r
;

20 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

21 
ucc_mpoŞ_t
 
	mexecutÜs
;

22 
ucc_mpoŞ_t
 
	mexecutÜ_sks
;

23 
ucc_¥šlock_t
 
	mš™_¥šlock
;

24 } 
	tucc_ec_ıu_t
;

26 
ucc_ec_ıu_t
 
ucc_ec_ıu
;

28 
ucc_¡©us_t
 
ucc_ec_ıu_»duû
(
ucc_“e_sk_»duû_t
 *
sk
, * 
»¡riù
 
d¡
, * cÚ¡ *„e¡riù 
¤cs
, 
ušt16_t
 
æags
);

	@src/components/ec/cpu/ec_cpu_reduce.c

7 
	~"uts/ucc_m©h_İ.h
"

8 
	~"ec_ıu.h
"

9 
	~<com¶ex.h
>

11 
	#DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
OP
) \

13 
size_t
 
_i
, 
_j
; \

14 
ty³
 
_tmp
; \

15 
size_t
 
__couÁ
 = 
_couÁ
; \

16 
_n_¤cs
) { \

18 
_i
 = 0; _˜< 
__couÁ
; _i++) { \

19 
d
[
_i
] = 
OP
##
	`_2
(
s
[0][_i], s[1][_i]); \

23 
_i
 = 0; _˜< 
__couÁ
; _i++) { \

24 
d
[
_i
] = 
OP
##
	`_3
(
s
[0][_i], s[1][_i], s[2][_i]); \

28 
_i
 = 0; _˜< 
__couÁ
; _i++) { \

29 
d
[
_i
] = 
OP
##
	`_4
(
s
[0][_i], s[1][_i], s[2][_i], s[3][_i]); \

33 
_i
 = 0; _˜< 
__couÁ
; _i++) { \

34 
d
[
_i
] = \

35 
OP
##
	`_5
(
s
[0][
_i
], s[1][_i], s[2][_i], s[3][_i], s[4][_i]); \

39 
_i
 = 0; _˜< 
__couÁ
; _i++) { \

40 
d
[
_i
] = 
OP
##
	`_6
(
s
[0][_i], s[1][_i], s[2][_i], s[3][_i], \

41 
s
[4][
_i
], s[5][_i]); \

45 
_i
 = 0; _˜< 
__couÁ
; _i++) { \

46 
d
[
_i
] = 
OP
##
	`_7
(
s
[0][_i], s[1][_i], s[2][_i], s[3][_i], \

47 
s
[4][
_i
], s[5][_i], s[6][_i]); \

51 
_i
 = 0; _˜< 
__couÁ
; _i++) { \

52 
d
[
_i
] = 
OP
##
	`_8
(
s
[0][_i], s[1][_i], s[2][_i], s[3][_i], \

53 
s
[4][
_i
], s[5][_i], s[6][_i], s[7][_i]); \

57 
_i
 = 0; _˜< 
__couÁ
; _i++) { \

58 
_tmp
 = 
OP
##
	`_8
(
s
[0][
_i
], s[1][_i], s[2][_i], s[3][_i], \

59 
s
[4][
_i
], s[5][_i], s[6][_i], s[7][_i]); \

60 
_j
 = 8; _j < 
_n_¤cs
; _j++) { \

61 
_tmp
 = 
OP
##
	`_2
(_tmp, 
s
[
_j
][
_i
]); \

63 
d
[
_i
] = 
_tmp
; \

67 } 0)

	)

69 
	#VEC_OP
(
_d
, 
_couÁ
, 
_®pha
) \

71 
size_t
 
_i
; \

72 
_i
 = 0; _˜< 
_couÁ
; _i++) { \

73 
_d
[
_i
] = _d[_i] * 
_®pha
; \

75 } 0)

	)

77 
	#DO_DT_REDUCE_INT
(
ty³
, 
_¤cs
, 
_d¡
, 
_İ
, 
_couÁ
, 
_n_¤cs
) \

79 cÚ¡ 
ty³
 **
»¡riù
 
s
 = (cÚ¡y³ **)
_¤cs
; \

80 
ty³
 *
»¡riù
 
d
 = (ty³ * ) 
_d¡
; \

81 
_İ
) { \

82 
UCC_OP_AVG
: \

83 
UCC_OP_SUM
: \

84 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_SUM
); \

85 ià(
æags
 & 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
) { \

86 
	`VEC_OP
(
d
, 
_couÁ
, 
sk
->
®pha
); \

89 
UCC_OP_MIN
: \

90 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_MIN
); \

92 
UCC_OP_MAX
: \

93 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_MAX
); \

95 
UCC_OP_PROD
: \

96 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_PROD
); \

98 
UCC_OP_LAND
: \

99 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_LAND
); \

101 
UCC_OP_BAND
: \

102 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_BAND
); \

104 
UCC_OP_LOR
: \

105 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_LOR
); \

107 
UCC_OP_BOR
: \

108 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_BOR
); \

110 
UCC_OP_LXOR
: \

111 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_LXOR
); \

113 
UCC_OP_BXOR
: \

114 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_BXOR
); \

117 
	`ec_”rÜ
(&
ucc_ec_ıu
.
su³r
, \

120 
	`ucc_»duùiÚ_İ_¡r
(
_İ
)); \

121  
UCC_ERR_NOT_SUPPORTED
; \

123 } 0)

	)

125 
	#DO_DT_REDUCE_WITH_OP_BFLOAT16
(
_¤cs
, 
_d¡
, 
_couÁ
, 
_n_¤cs
, 
_OP
, \

126 
_®pha
) \

128 
_tmp
; \

129 
size_t
 
_i
, 
_j
; \

130 
št16_t
 **
_s
 = (št16_ˆ**)
_¤cs
; \

131 
št16_t
 * 
_d
 = (št16_ˆ*)
_d¡
; \

132 
_i
 = 0; _˜< 
_couÁ
; _i++) { \

133 
_tmp
 = 
	`_OP
(
	`bæßt16toæßt32
(&
_s
[0][
_i
]), \

134 
	`bæßt16toæßt32
(&
_s
[1][
_i
])); \

135 
_j
 = 2; _j < 
_n_¤cs
; _j++) { \

136 
_tmp
 = 
	`_OP
(_tmp, 
	`bæßt16toæßt32
(&
_s
[
_j
][
_i
])); \

138 
	`æßt32tobæßt16
(
_tmp
 *
_®pha
, &
_d
[
_i
]); \

140 } 0)

	)

142 
	#DO_DT_REDUCE_BFLOAT16
(
_¤cs
, 
_d¡
, 
_İ
, 
_couÁ
, 
_n_¤cs
) \

144 
_a
 = (
æags
 & 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
è? 
sk
->
®pha
 \

146 
_İ
) { \

147 
UCC_OP_AVG
: \

148 
UCC_OP_SUM
: \

149 
	`DO_DT_REDUCE_WITH_OP_BFLOAT16
(
_¤cs
, 
_d¡
, 
_couÁ
, 
_n_¤cs
, \

150 
DO_OP_SUM
, 
_a
); \

152 
UCC_OP_PROD
: \

153 
	`DO_DT_REDUCE_WITH_OP_BFLOAT16
(
_¤cs
, 
_d¡
, 
_couÁ
, 
_n_¤cs
, \

154 
DO_OP_PROD
, 
_a
); \

156 
UCC_OP_MIN
: \

157 
	`DO_DT_REDUCE_WITH_OP_BFLOAT16
(
_¤cs
, 
_d¡
, 
_couÁ
, 
_n_¤cs
, \

158 
DO_OP_MIN
, 
_a
); \

160 
UCC_OP_MAX
: \

161 
	`DO_DT_REDUCE_WITH_OP_BFLOAT16
(
_¤cs
, 
_d¡
, 
_couÁ
, 
_n_¤cs
, \

162 
DO_OP_MAX
, 
_a
); \

165 
	`ec_”rÜ
(&
ucc_ec_ıu
.
su³r
, \

168 
	`ucc_»duùiÚ_İ_¡r
(
_İ
)); \

169  
UCC_ERR_NOT_SUPPORTED
; \

171 } 0)

	)

173 
	#DO_DT_REDUCE_FLOAT
(
ty³
, 
_¤cs
, 
_d¡
, 
_İ
, 
_couÁ
, 
_n_¤cs
) \

175 cÚ¡ 
ty³
 **
»¡riù
 
s
 = (cÚ¡y³ **)
_¤cs
; \

176 
ty³
 *
»¡riù
 
d
 = (ty³ *è
_d¡
; \

177 
_İ
) { \

178 
UCC_OP_AVG
: \

179 
UCC_OP_SUM
: \

180 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_SUM
); \

182 
UCC_OP_PROD
: \

183 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_PROD
); \

185 
UCC_OP_MIN
: \

186 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_MIN
); \

188 
UCC_OP_MAX
: \

189 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_MAX
); \

192 
	`ec_”rÜ
(&
ucc_ec_ıu
.
su³r
, \

195 
	`ucc_»duùiÚ_İ_¡r
(
_İ
)); \

196  
UCC_ERR_NOT_SUPPORTED
; \

198 ià(
æags
 & 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
) { \

199 
	`VEC_OP
(
d
, 
_couÁ
, 
sk
->
®pha
); \

201 } 0)

	)

203 
	#DO_DT_REDUCE_FLOAT_COMPLEX
(
ty³
, 
_¤cs
, 
_d¡
, 
_İ
, 
_couÁ
, 
_n_¤cs
) \

205 cÚ¡ 
ty³
 **
»¡riù
 
s
 = (cÚ¡y³ **)
_¤cs
; \

206 
ty³
 *
»¡riù
 
d
 = (ty³ *è
_d¡
; \

207 
_İ
) { \

208 
UCC_OP_AVG
: \

209 
UCC_OP_SUM
: \

210 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_SUM
); \

212 
UCC_OP_PROD
: \

213 
	`DO_DT_REDUCE_WITH_OP
(
ty³
, 
s
, 
d
, 
_couÁ
, 
_n_¤cs
, 
DO_OP_PROD
); \

216 
	`ec_”rÜ
(&
ucc_ec_ıu
.
su³r
, \

219 
	`ucc_»duùiÚ_İ_¡r
(
_İ
)); \

220  
UCC_ERR_NOT_SUPPORTED
; \

222 ià(
æags
 & 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
) { \

223 
	`VEC_OP
(
d
, 
_couÁ
, 
sk
->
®pha
); \

225 } 0)

	)

227 
ucc_¡©us_t
 
	$ucc_ec_ıu_»duû
(
ucc_“e_sk_»duû_t
 *
sk
, * 
»¡riù
 
d¡
,

228 * cÚ¡ * 
»¡riù
 
¤cs
, 
ušt16_t
 
æags
)

230 
sk
->
dt
) {

231 
UCC_DT_INT8
:

232 
	`DO_DT_REDUCE_INT
(
št8_t
, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

233 
sk
->
n_¤cs
);

235 
UCC_DT_INT16
:

236 
	`DO_DT_REDUCE_INT
(
št16_t
, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

237 
sk
->
n_¤cs
);

239 
UCC_DT_INT32
:

240 
	`DO_DT_REDUCE_INT
(
št32_t
, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

241 
sk
->
n_¤cs
);

243 
UCC_DT_INT64
:

244 
	`DO_DT_REDUCE_INT
(
št64_t
, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

245 
sk
->
n_¤cs
);

247 
UCC_DT_UINT8
:

248 
	`DO_DT_REDUCE_INT
(
ušt8_t
, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

249 
sk
->
n_¤cs
);

251 
UCC_DT_UINT16
:

252 
	`DO_DT_REDUCE_INT
(
ušt16_t
, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

253 
sk
->
n_¤cs
);

255 
UCC_DT_UINT32
:

256 
	`DO_DT_REDUCE_INT
(
ušt32_t
, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

257 
sk
->
n_¤cs
);

259 
UCC_DT_UINT64
:

260 
	`DO_DT_REDUCE_INT
(
ušt64_t
, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

261 
sk
->
n_¤cs
);

263 
UCC_DT_FLOAT32
:

264 #ià
SIZEOF_FLOAT
 == 4

265 
	`DO_DT_REDUCE_FLOAT
(, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

266 
sk
->
n_¤cs
);

269  
UCC_ERR_NOT_SUPPORTED
;

271 
UCC_DT_FLOAT64
:

272 #ià
SIZEOF_DOUBLE
 == 8

273 
	`DO_DT_REDUCE_FLOAT
(, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

274 
sk
->
n_¤cs
);

277  
UCC_ERR_NOT_SUPPORTED
;

279 
UCC_DT_FLOAT128
:

280 #ià
SIZEOF_LONG_DOUBLE
 == 16

281 
	`DO_DT_REDUCE_FLOAT
(, 
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

282 
sk
->
n_¤cs
);

285  
UCC_ERR_NOT_SUPPORTED
;

287 
UCC_DT_BFLOAT16
:

288 
	`DO_DT_REDUCE_BFLOAT16
(
¤cs
, 
d¡
, 
sk
->
İ
,ask->
couÁ
,

289 
sk
->
n_¤cs
);

291 
UCC_DT_FLOAT32_COMPLEX
:

292 #ià
SIZEOF_FLOAT__COMPLEX
 == 8

293 
	`DO_DT_REDUCE_FLOAT_COMPLEX
(
com¶ex
, 
¤cs
, 
d¡
, 
sk
->
İ
,

294 
sk
->
couÁ
,ask->
n_¤cs
);

297  
UCC_ERR_NOT_SUPPORTED
;

299 
UCC_DT_FLOAT64_COMPLEX
:

300 #ià
SIZEOF_DOUBLE__COMPLEX
 == 16

301 
	`DO_DT_REDUCE_FLOAT_COMPLEX
(
com¶ex
, 
¤cs
, 
d¡
, 
sk
->
İ
,

302 
sk
->
couÁ
,ask->
n_¤cs
);

305  
UCC_ERR_NOT_SUPPORTED
;

307 
UCC_DT_FLOAT128_COMPLEX
:

308 #ià
SIZEOF_LONG_DOUBLE__COMPLEX
 == 32

309 
	`DO_DT_REDUCE_FLOAT_COMPLEX
(
com¶ex
, 
¤cs
, 
d¡
,

310 
sk
->
İ
,ask->
couÁ
,ask->
n_¤cs
);

313  
UCC_ERR_NOT_SUPPORTED
;

316 
	`ec_”rÜ
(&
ucc_ec_ıu
.
su³r
, "unsupported„eductionype (%s)",

317 
	`ucc_d©©y³_¡r
(
sk
->
dt
));

318  
UCC_ERR_NOT_SUPPORTED
;

321  
UCC_OK
;

322 
	}
}

	@src/components/ec/cuda/ec_cuda.c

7 
	~"ec_cuda.h
"

8 
	~"ec_cuda_executÜ.h
"

9 
	~"uts/ucc_m®loc.h
"

10 
	~"uts/¬ch/ıu.h
"

11 
	~<cuda_ruÁime.h
>

12 
	~<cuda.h
>

14 cÚ¡ *
	g¡»am_sk_modes
[] = {

15 [
UCC_EC_CUDA_TASK_KERNEL
] = "kernel",

16 [
UCC_EC_CUDA_TASK_MEM_OPS
] = "driver",

17 [
UCC_EC_CUDA_TASK_AUTO
] = "auto",

18 [
UCC_EC_CUDA_TASK_LAST
] = 
NULL


21 
ucc_cÚfig_f›ld_t
 
	gucc_ec_cuda_cÚfig_bË
[] = {

22 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
su³r
),

23 
UCC_CONFIG_TYPE_TABLE
(
ucc_ec_cÚfig_bË
)},

30 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
¡rm_sk_mode
),

31 
UCC_CONFIG_TYPE_ENUM
(
¡»am_sk_modes
)},

35 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
exec_num_wÜk”s
),

36 
UCC_CONFIG_TYPE_ULUNITS
},

40 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
exec_num_th»ads
),

41 
UCC_CONFIG_TYPE_ULUNITS
},

45 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
exec_max_sks
),

46 
UCC_CONFIG_TYPE_ULUNITS
},

50 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
exec_num_¡»ams
),

51 
UCC_CONFIG_TYPE_ULUNITS
},

55 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
exec_cİy_th»sh
),

56 
UCC_CONFIG_TYPE_MEMUNITS
},

60 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
»duû_num_blocks
),

61 
UCC_CONFIG_TYPE_ULUNITS
},

66 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
»duû_num_th»ads
),

67 
UCC_CONFIG_TYPE_ULUNITS
},

71 
ucc_off£tof
(
ucc_ec_cuda_cÚfig_t
, 
u£_coİ”©ive_Ïunch
),

72 
UCC_CONFIG_TYPE_BOOL
},

74 {
NULL
}

78 
šlše
 
	$ucc_ec_cuda_£t_th»ads_nbr
(*
Á
, 
maxTh»adsP”Block
)

80 ià(*
Á
 !ğ
UCC_ULUNITS_AUTO
) {

81 ià(
maxTh»adsP”Block
 < *
Á
) {

82 
	`ec_w¬n
(

83 &
ucc_ec_cuda
.
su³r
,

85 
maxTh»adsP”Block
);

86 } ià((*
Á
 % 
WARP_SIZE
) != 0) {

87 
	`ec_w¬n
(&
ucc_ec_cuda
.
su³r
,

90 
WARP_SIZE
);

96 *
Á
 = (
maxTh»adsP”Block
 / 
WARP_SIZE
) * WARP_SIZE;

97 
	}
}

99 
ucc_¡©us_t
 
	$ucc_ec_cuda_š™
(cÚ¡ 
ucc_ec_·¿ms_t
 *
ec_·¿ms
)

101 
ucc_ec_cuda_cÚfig_t
 *
cfg
 = 
EC_CUDA_CONFIG
;

102 
suµÜts_coİ_Ïunch
 = 0;

103 
deviû
, 
num_deviûs
;

104 
cudaE¼Ü_t
 
cuda_¡
;

105 
cudaDeviûPrİ
 
´İ
;

107 
ucc_ec_cuda_cÚfig
 = 
	`ucc_d”ived_of
(
ucc_ec_cuda
.
su³r
.
cÚfig
,

108 
ucc_ec_cuda_cÚfig_t
);

109 
ucc_ec_cuda
.
exec_¡»ams_š™Ÿlized
 = 0;

110 
	`ucc_¡ºıy_§ã
(
ucc_ec_cuda
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
,

111 
ucc_ec_cuda
.
su³r
.su³r.
Çme
,

112 (
ucc_ec_cuda
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
));

113 
ucc_ec_cuda
.
th»ad_mode
 = 
ec_·¿ms
->thread_mode;

114 
cuda_¡
 = 
	`cudaG‘DeviûCouÁ
(&
num_deviûs
);

115 ià((
cuda_¡
 !ğ
cudaSucûss
è|| (
num_deviûs
 == 0)) {

116 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
, "CUDA devices‡re‚ot found");

117  
UCC_ERR_NO_RESOURCE
;

119 
	`CUDA_CHECK
(
	`cudaG‘Deviû
(&
deviû
));

120 
	`CUDA_CHECK
(
	`cudaG‘DeviûPrİ”t›s
(&
´İ
, 
deviû
));

121 
	`ucc_ec_cuda_£t_th»ads_nbr
((*)&
cfg
->
exec_num_th»ads
,

122 
´İ
.
maxTh»adsP”Block
);

123 
	`ucc_ec_cuda_£t_th»ads_nbr
(&
cfg
->
»duû_num_th»ads
,

124 
´İ
.
maxTh»adsP”Block
);

126 ià(
cfg
->
»duû_num_blocks
 !ğ
UCC_ULUNITS_AUTO
) {

127 ià(
´İ
.
maxGridSize
[0] < 
cfg
->
»duû_num_blocks
) {

128 
	`ec_w¬n
(&
ucc_ec_cuda
.
su³r
,

130 
´İ
.
maxGridSize
[0]);

131 
cfg
->
»duû_num_blocks
 = 
´İ
.
maxGridSize
[0];

134 
cfg
->
»duû_num_blocks
 = 
´İ
.
maxGridSize
[0];

137 ià(
cfg
->
exec_num_¡»ams
 < 1) {

138 
	`ec_w¬n
(&
ucc_ec_cuda
.
su³r
,

140 
cfg
->
exec_num_¡»ams
 = 1;

143 ià(
cfg
->
¡rm_sk_mode
 =ğ
UCC_EC_CUDA_TASK_KERNEL
) {

144 
ucc_ec_cuda
.
¡rm_sk_mode
 = 
UCC_EC_CUDA_TASK_KERNEL
;

146 
ucc_ec_cuda
.
¡rm_sk_mode
 = 
UCC_EC_CUDA_TASK_MEM_OPS
;

147 #ià
CUDA_VERSION
 < 12000

148 
CU»suÉ
 
cu_¡
;

149 
CUdeviû
 
cu_dev
;

150 
©Œ
;

151 
cu_¡
 = 
	`cuCtxG‘Deviû
(&
cu_dev
);

152 ià(
cu_¡
 !ğ
CUDA_SUCCESS
){

153 cÚ¡ *
cu_”r_¡_¡r
;

154 
	`cuG‘E¼ÜSŒšg
(
cu_¡
, &
cu_”r_¡_¡r
);

155 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
, "cuCtxGetDevice() failed: %s",

156 
cu_”r_¡_¡r
);

157 
©Œ
 = 0;

159 
	`CUDADRV_FUNC
(
	`cuDeviûG‘A‰ribu‹
(&
©Œ
,

160 
CU_DEVICE_ATTRIBUTE_CAN_USE_STREAM_MEM_OPS
,

161 
cu_dev
));

164 ià(
cfg
->
¡rm_sk_mode
 =ğ
UCC_EC_CUDA_TASK_AUTO
) {

165 ià(
©Œ
 == 0) {

166 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
,

168 
ucc_ec_cuda
.
¡rm_sk_mode
 = 
UCC_EC_CUDA_TASK_KERNEL
;

170 } ià(
©Œ
 == 0) {

171 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
,

173  
UCC_ERR_NOT_SUPPORTED
;

178 ià(
cfg
->
u£_coİ”©ive_Ïunch
 == 1) {

179 
	`cudaDeviûG‘A‰ribu‹
(&
suµÜts_coİ_Ïunch
,

180 
cudaDevA‰rCoİ”©iveLaunch
, 
deviû
);

181 ià(!
suµÜts_coİ_Ïunch
) {

182 
cfg
->
u£_coİ”©ive_Ïunch
 = 0;

183 
	`ec_w¬n
(&
ucc_ec_cuda
.
su³r
,

189 
ucc_ec_cuda
.
»sourûs_hash
 = 
	`kh_š™
(
ucc_ec_cuda_»sourûs_hash
);

190 
	`ucc_¥šlock_š™
(&
ucc_ec_cuda
.
š™_¥šlock
, 0);

191  
UCC_OK
;

192 
	}
}

194 
ucc_¡©us_t
 
	$ucc_ec_cuda_g‘_©Œ
(
ucc_ec_©Œ_t
 *
ec_©Œ
)

196 ià(
ec_©Œ
->
f›ld_mask
 & 
UCC_EC_ATTR_FIELD_THREAD_MODE
) {

197 
ec_©Œ
->
th»ad_mode
 = 
ucc_ec_cuda
.thread_mode;

199  
UCC_OK
;

200 
	}
}

202 
ucc_¡©us_t
 
	$ucc_ec_cuda_ev’t_ü—‹
(**
ev’t
)

204 
ucc_ec_cuda_ev’t_t
 *
cuda_ev’t
;

205 
ucc_ec_cuda_»sourûs_t
 *
»sourûs
;

206 
ucc_¡©us_t
 
¡©us
;

208 
¡©us
 = 
	`ucc_ec_cuda_g‘_»sourûs
(&
»sourûs
);

209 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

210  
¡©us
;

212 
cuda_ev’t
 = 
	`ucc_mpoŞ_g‘
(&
»sourûs
->
ev’ts
);

213 ià(
	`ucc_uÆik–y
(!
cuda_ev’t
)) {

214 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo getƒvent from mpool");

215  
UCC_ERR_NO_MEMORY
;

218 *
ev’t
 = 
cuda_ev’t
;

219  
UCC_OK
;

220 
	}
}

222 
ucc_¡©us_t
 
	$ucc_ec_cuda_ev’t_de¡roy
(*
ev’t
)

224 
ucc_ec_cuda_ev’t_t
 *
cuda_ev’t
 = 
ev’t
;

226 
	`ucc_mpoŞ_put
(
cuda_ev’t
);

227  
UCC_OK
;

228 
	}
}

230 
ucc_¡©us_t
 
	$ucc_ec_cuda_ev’t_po¡
(*
“_cÚ‹xt
, *
ev’t
)

232 
cudaSŒ—m_t
 
¡»am
 = (cudaSŒ—m_ˆ)
“_cÚ‹xt
;

233 
ucc_ec_cuda_ev’t_t
 *
cuda_ev’t
 = 
ev’t
;

235 
	`CUDA_CHECK
(
	`cudaEv’tRecÜd
(
cuda_ev’t
->
ev’t
, 
¡»am
));

236  
UCC_OK
;

237 
	}
}

239 
ucc_¡©us_t
 
	$ucc_ec_cuda_ev’t_‹¡
(*
ev’t
)

241 
ucc_ec_cuda_ev’t_t
 *
cuda_ev’t
 = 
ev’t
;

242 
cudaE¼Ü_t
 
cu_”r
;

244 
cu_”r
 = 
	`cudaEv’tQu”y
(
cuda_ev’t
->
ev’t
);

246 ià(
	`ucc_uÆik–y
((
cu_”r
 !ğ
cudaSucûss
) &&

247 (
cu_”r
 !ğ
cudaE¼ÜNÙR—dy
))) {

248 
	`CUDA_CHECK
(
cu_”r
);

250  
	`cuda_”rÜ_to_ucc_¡©us
(
cu_”r
);

251 
	}
}

253 
ucc_¡©us_t
 
	$ucc_ec_cuda_fš®ize
()

255 
ucc_ec_cuda_»sourûs_t
 *
»sourûs
;

257 
»sourûs
 = 
	`ec_cuda_»sourûs_hash_pİ
(
ucc_ec_cuda
.
»sourûs_hash
);

258 
»sourûs
) {

259 
	`ucc_ec_cuda_»sourûs_ş—nup
(
»sourûs
);

260 
»sourûs
 = 
	`ec_cuda_»sourûs_hash_pİ
(
ucc_ec_cuda
.
»sourûs_hash
);

263 
	`ucc_¥šlock_de¡roy
(&
ucc_ec_cuda
.
š™_¥šlock
);

265  
UCC_OK
;

266 
	}
}

268 
ucc_¡©us_t
 
	$ucc_ec_cuda_g‘_»sourûs
(
ucc_ec_cuda_»sourûs_t
 **
»sourûs
)

270 
CUcÚ‹xt
 
cu_ùx
;

271 
cu_ùx_id
;

272 
ucc_¡©us_t
 
¡©us
;

274 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuCtxG‘Cu¼’t
(&
cu_ùx
));

275 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

276 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo get current CUDA context");

277  
¡©us
;

280 #ià
CUDA_VERSION
 < 12000

281 
cu_ùx_id
 = 1;

283 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuCtxG‘Id
(
cu_ùx
, &
cu_ùx_id
));

284 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

286 
cu_ùx_id
 = 0x12345;

287 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
, "failedo get currect CUDA context ID");

291 *
»sourûs
 = 
	`ec_cuda_»sourûs_hash_g‘
(
ucc_ec_cuda
.
»sourûs_hash
,

292 
cu_ùx_id
);

293 ià(
	`ucc_uÆik–y
(*
»sourûs
 =ğ
NULL
)) {

294 
	`ucc_¥š_lock
(&
ucc_ec_cuda
.
š™_¥šlock
);

295 *
»sourûs
 = 
	`ec_cuda_»sourûs_hash_g‘
(
ucc_ec_cuda
.
»sourûs_hash
,

296 
cu_ùx_id
);

297 ià(*
»sourûs
 =ğ
NULL
) {

298 *
»sourûs
 = 
	`ucc_m®loc
((
ucc_ec_cuda_»sourûs_t
),

300 ià(*
»sourûs
 =ğ
NULL
) {

301 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
,

303 (
ucc_ec_cuda_»sourûs_t
));

304 
	`ucc_¥š_uÆock
(&
ucc_ec_cuda
.
š™_¥šlock
);

305  
UCC_ERR_NO_MEMORY
;

307 
¡©us
 = 
	`ucc_ec_cuda_»sourûs_š™
(&
ucc_ec_cuda
.
su³r
,

308 *
»sourûs
);

309 ià(
¡©us
 !ğ
UCC_OK
) {

310 
	`ucc_ä“
(*
»sourûs
);

311 
	`ucc_¥š_uÆock
(&
ucc_ec_cuda
.
š™_¥šlock
);

312  
¡©us
;

314 
	`ec_cuda_»sourûs_hash_put
(
ucc_ec_cuda
.
»sourûs_hash
, 
cu_ùx_id
,

315 *
»sourûs
);

317 
	`ucc_¥š_uÆock
(&
ucc_ec_cuda
.
š™_¥šlock
);

319  
UCC_OK
;

320 
	}
}

322 
ucc_ec_cuda_t
 
	gucc_ec_cuda
 = {

323 .
su³r
.su³r.
Çme
 = "cudaƒc",

324 .
	gsu³r
.
	g»f_út
 = 0,

325 .
	gsu³r
.
	gty³
 = 
UCC_EE_CUDA_STREAM
,

326 .
	gsu³r
.
	gš™
 = 
ucc_ec_cuda_š™
,

327 .
	gsu³r
.
	gg‘_©Œ
 = 
ucc_ec_cuda_g‘_©Œ
,

328 .
	gsu³r
.
	gfš®ize
 = 
ucc_ec_cuda_fš®ize
,

329 .
	gsu³r
.
	gcÚfig_bË
 =

331 .
Çme
 = "CUDAƒxecution component",

332 .
	g´efix
 = "EC_CUDA_",

333 .
	gbË
 = 
ucc_ec_cuda_cÚfig_bË
,

334 .
	gsize
 = (
ucc_ec_cuda_cÚfig_t
),

336 .
	gsu³r
.
	gİs
.
	gü—‹_ev’t
 = 
ucc_ec_cuda_ev’t_ü—‹
,

337 .
	gsu³r
.
	gİs
.
	gde¡roy_ev’t
 = 
ucc_ec_cuda_ev’t_de¡roy
,

338 .
	gsu³r
.
	gİs
.
	gev’t_po¡
 = 
ucc_ec_cuda_ev’t_po¡
,

339 .
	gsu³r
.
	gİs
.
	gev’t_‹¡
 = 
ucc_ec_cuda_ev’t_‹¡
,

340 .
	gsu³r
.
	gexecutÜ_İs
.
	gš™
 = 
ucc_cuda_executÜ_š™
,

341 .
	gsu³r
.
	gexecutÜ_İs
.
	g¡¬t
 = 
ucc_cuda_executÜ_¡¬t
,

342 .
	gsu³r
.
	gexecutÜ_İs
.
	g¡©us
 = 
ucc_cuda_executÜ_¡©us
,

343 .
	gsu³r
.
	gexecutÜ_İs
.
	g¡İ
 = 
ucc_cuda_executÜ_¡İ
,

344 .
	gsu³r
.
	gexecutÜ_İs
.
	gsk_po¡
 = 
ucc_cuda_executÜ_sk_po¡
,

345 .
	gsu³r
.
	gexecutÜ_İs
.
	gsk_‹¡
 = 
ucc_cuda_executÜ_sk_‹¡
,

346 .
	gsu³r
.
	gexecutÜ_İs
.
	gsk_fš®ize
 = 
ucc_cuda_executÜ_sk_fš®ize
,

347 .
	gsu³r
.
	gexecutÜ_İs
.
	gfš®ize
 = 
ucc_cuda_executÜ_fš®ize
,

350 
ucc_ec_cuda_cÚfig_t
 *
	gucc_ec_cuda_cÚfig
;

352 
UCC_CONFIG_REGISTER_TABLE_ENTRY
(&
ucc_ec_cuda
.
su³r
.
cÚfig_bË
,

353 &
ucc_cÚfig_glob®_li¡
);

	@src/components/ec/cuda/ec_cuda.h

7 #iâdeà
UCC_EC_CUDA_H_


8 
	#UCC_EC_CUDA_H_


	)

10 
	~"compÚ’ts/ec/ba£/ucc_ec_ba£.h
"

11 
	~"compÚ’ts/ec/ucc_ec_log.h
"

12 
	~"uts/¬ch/cuda_def.h
"

13 
	~"uts/ucc_mpoŞ.h
"

14 
	~"ec_cuda_»sourûs.h
"

15 
	~<cuda_ruÁime.h
>

17 
	#WARP_SIZE
 32

	)

19 
	$ucc_¡©us_t
 (*
	tucc_ec_cuda_sk_po¡_â
è(
	tušt32_t
 *
	tdev_¡©us
,

20 
	tblockšg_wa™
,

21 
	tcudaSŒ—m_t
 
	t¡»am
);

23 
	succ_ec_cuda
 {

24 
ucc_ec_ba£_t
 
su³r
;

25 
exec_¡»ams_š™Ÿlized
;

26 
ucc_ec_cuda_»sourûs_hash_t
 *
»sourûs_hash
;

27 
ucc_th»ad_mode_t
 
th»ad_mode
;

28 
ucc_ec_cuda_¡rm_sk_mode_t
 
¡rm_sk_mode
;

29 
ucc_¥šlock_t
 
š™_¥šlock
;

30 } 
	tucc_ec_cuda_t
;

32 
	succ_ec_cuda_¡»am_»que¡
 {

33 
ušt32_t
 
¡©us
;

34 
ušt32_t
 *
dev_¡©us
;

35 
cudaSŒ—m_t
 
¡»am
;

36 } 
	tucc_ec_cuda_¡»am_»que¡_t
;

38 
ucc_¡©us_t
 
	`ucc_ec_cuda_ev’t_ü—‹
(**
ev’t
);

40 
ucc_¡©us_t
 
	`ucc_ec_cuda_ev’t_de¡roy
(*
ev’t
);

42 
ucc_¡©us_t
 
	`ucc_ec_cuda_ev’t_po¡
(*
“_cÚ‹xt
, *
ev’t
);

44 
ucc_¡©us_t
 
	`ucc_ec_cuda_ev’t_‹¡
(*
ev’t
);

46 
ucc_¡©us_t
 
	`ucc_ec_cuda_g‘_»sourûs
(
ucc_ec_cuda_»sourûs_t
 **
»sourûs
);

48 
ucc_ec_cuda_t
 
ucc_ec_cuda
;

50 
	#EC_CUDA_CONFIG
 \

51 (
	`ucc_d”ived_of
(
ucc_ec_cuda
.
su³r
.
cÚfig
, 
ucc_ec_cuda_cÚfig_t
))

	)

	@src/components/ec/cuda/ec_cuda_executor.c

7 
	~"ec_cuda_executÜ.h
"

9 
ucc_¡©us_t
 
ucc_cuda_executÜ_š‹¼u±ibË_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
);

11 
ucc_¡©us_t
 
ucc_cuda_executÜ_š‹¼u±ibË_¡İ
(
ucc_“_executÜ_t
 *
executÜ
);

13 
ucc_¡©us_t
 
ucc_cuda_executÜ_³rsi¡’t_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

14 *
“_cÚ‹xt
);

16 
ucc_¡©us_t
 
ucc_cuda_executÜ_³rsi¡’t_¡İ
(
ucc_“_executÜ_t
 *
executÜ
);

18 
ucc_¡©us_t
 
ucc_cuda_executÜ_³rsi¡’t_wa™_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

19 *
“_cÚ‹xt
);

21 
ucc_¡©us_t
 
ucc_cuda_executÜ_³rsi¡’t_wa™_¡İ
(
ucc_“_executÜ_t
 *
executÜ
);

23 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_š™
(cÚ¡ 
ucc_“_executÜ_·¿ms_t
 *
·¿ms
,

24 
ucc_“_executÜ_t
 **
executÜ
)

26 
ucc_ec_cuda_executÜ_t
 *
“e
;

27 
ucc_ec_cuda_»sourûs_t
 *
»sourûs
;

28 
ucc_¡©us_t
 
¡©us
;

30 
¡©us
 = 
	`ucc_ec_cuda_g‘_»sourûs
(&
»sourûs
);

31 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

32  
¡©us
;

35 
“e
 = 
	`ucc_mpoŞ_g‘
(&
»sourûs
->
executÜs
);

36 ià(
	`ucc_uÆik–y
(!
“e
)) {

37 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo‡llocateƒxecutor");

38  
UCC_ERR_NO_MEMORY
;

41 ià(
·¿ms
->
mask
 & 
UCC_EE_EXECUTOR_PARAM_FIELD_TASK_TYPES
) {

42 
“e
->
»que¡ed_İs
 = 
·¿ms
->
sk_ty³s
;

45 
“e
->
»que¡ed_İs
 = 1;

48 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
, "executÜ in™,ƒ“: %p", 
“e
);

49 
“e
->
su³r
.
“_ty³
 = 
·¿ms
->ee_type;

50 
“e
->
¡©e
 = 
UCC_EC_CUDA_EXECUTOR_INITIALIZED
;

52 *
executÜ
 = &
“e
->
su³r
;

53  
UCC_OK
;

54 
	}
}

56 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_¡©us
(cÚ¡ 
ucc_“_executÜ_t
 *
executÜ
)

58 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

59 
ucc_ec_cuda_executÜ_t
);

61 
“e
->
¡©e
) {

62 
UCC_EC_CUDA_EXECUTOR_INITIALIZED
:

63  
UCC_OPERATION_INITIALIZED
;

64 
UCC_EC_CUDA_EXECUTOR_POSTED
:

65  
UCC_INPROGRESS
;

66 
UCC_EC_CUDA_EXECUTOR_STARTED
:

67  
UCC_OK
;

70  
UCC_ERR_NO_RESOURCE
;

72 
	}
}

74 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_fš®ize
(
ucc_“_executÜ_t
 *
executÜ
)

76 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

77 
ucc_ec_cuda_executÜ_t
);

79 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
, "executÜ f»e,ƒ“: %p", 
“e
);

80 
	`ucc_as£¹
(
“e
->
¡©e
 =ğ
UCC_EC_CUDA_EXECUTOR_INITIALIZED
);

81 
	`ucc_mpoŞ_put
(
“e
);

83  
UCC_OK
;

84 
	}
}

86 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

87 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

88 
ucc_“_executÜ_sk_t
 **
sk
)

90 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

91 
ucc_ec_cuda_executÜ_t
);

92  
“e
->
İs
.
	`sk_po¡
(
executÜ
, 
sk_¬gs
, 
sk
);

93 
	}
}

96 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
)

98 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
sk
->eee,

99 
ucc_ec_cuda_executÜ_t
);

100  
“e
->
İs
.
	`sk_‹¡
(
sk
);

101 
	}
}

103 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
)

105 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
sk
->eee,

106 
ucc_ec_cuda_executÜ_t
);

107  
“e
->
İs
.
	`sk_fš®ize
(
sk
);

108 
	}
}

110 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

111 *
“_cÚ‹xt
)

113 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

114 
ucc_ec_cuda_executÜ_t
);

116 ià(!
“_cÚ‹xt
) {

117  
	`ucc_cuda_executÜ_š‹¼u±ibË_¡¬t
(
executÜ
);

119 ià(
“e
->
»que¡ed_İs
 == 0) {

121  
	`ucc_cuda_executÜ_³rsi¡’t_wa™_¡¬t
(
executÜ
,

122 
“_cÚ‹xt
);

124  
	`ucc_cuda_executÜ_³rsi¡’t_¡¬t
(
executÜ
, 
“_cÚ‹xt
);

127 
	}
}

129 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_¡İ
(
ucc_“_executÜ_t
 *
executÜ
)

131 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

132 
ucc_ec_cuda_executÜ_t
);

133 ià(
“e
->
mode
 =ğ
UCC_EC_CUDA_EXECUTOR_MODE_INTERRUPTIBLE
) {

134  
	`ucc_cuda_executÜ_š‹¼u±ibË_¡İ
(
executÜ
);

136 ià(
“e
->
»que¡ed_İs
 == 0) {

137  
	`ucc_cuda_executÜ_³rsi¡’t_wa™_¡İ
(
executÜ
);

139  
	`ucc_cuda_executÜ_³rsi¡’t_¡İ
(
executÜ
);

142 
	}
}

	@src/components/ec/cuda/ec_cuda_executor.h

7 #iâdeà
UCC_EC_CUDA_EXECUTOR_H_


8 
	#UCC_EC_CUDA_EXECUTOR_H_


	)

10 
	~"ec_cuda.h
"

12 
ucc_¡©us_t
 
ucc_cuda_executÜ_š™
(cÚ¡ 
ucc_“_executÜ_·¿ms_t
 *
·¿ms
,

13 
ucc_“_executÜ_t
 **
executÜ
);

15 
ucc_¡©us_t
 
ucc_cuda_executÜ_¡©us
(cÚ¡ 
ucc_“_executÜ_t
 *
executÜ
);

17 
ucc_¡©us_t
 
ucc_cuda_executÜ_fš®ize
(
ucc_“_executÜ_t
 *
executÜ
);

19 
ucc_¡©us_t
 
ucc_cuda_executÜ_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

20 *
“_cÚ‹xt
);

22 
ucc_¡©us_t
 
ucc_cuda_executÜ_¡İ
(
ucc_“_executÜ_t
 *
executÜ
);

24 
ucc_¡©us_t
 
ucc_cuda_executÜ_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

25 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

26 
ucc_“_executÜ_sk_t
 **
sk
);

28 
ucc_¡©us_t
 
ucc_cuda_executÜ_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
);

30 
ucc_¡©us_t
 
ucc_cuda_executÜ_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
);

33 
ucc_¡©us_t
 
ucc_ec_cuda_³rsi¡’t_k”Ãl_¡¬t
(
ucc_ec_cuda_executÜ_t
 *
“e
);

35 
ucc_¡©us_t
 
ucc_ec_cuda_»duû
(
ucc_“_executÜ_sk_¬gs_t
 *
sk
,

36 
cudaSŒ—m_t
 
¡»am
);

	@src/components/ec/cuda/ec_cuda_executor_interruptible.c

7 
	~"ec_cuda_executÜ.h
"

8 
	~"uts/ucc_©omic.h
"

10 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_š‹¼u±ibË_g‘_¡»am
(
cudaSŒ—m_t
 *
¡»am
)

12 
ušt32_t
 
Ï¡_u£d
 = 0;

13 
num_¡»ams
 = 
EC_CUDA_CONFIG
->
exec_num_¡»ams
;

14 
ucc_ec_cuda_»sourûs_t
 *
»sourûs
;

15 
ucc_¡©us_t
 
¡
;

16 
i
, 
j
;

17 
ušt32_t
 
id
;

19 
	`ucc_as£¹
(
num_¡»ams
 > 0);

20 
¡
 = 
	`ucc_ec_cuda_g‘_»sourûs
(&
»sourûs
);

21 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

22  
¡
;

25 ià(
	`ucc_uÆik–y
(!
»sourûs
->
¡»ams_š™Ÿlized
)) {

26 
	`ucc_¥š_lock
(&
ucc_ec_cuda
.
š™_¥šlock
);

27 ià(
»sourûs
->
¡»ams_š™Ÿlized
) {

28 
uÆock
;

31 
i
 = 0; i < 
num_¡»ams
; i++) {

32 
¡
 = 
	`CUDA_FUNC
(
	`cudaSŒ—mC»©eW™hFÏgs
(&
»sourûs
->
exec_¡»ams
[
i
],

33 
cudaSŒ—mNÚBlockšg
));

34 ià(
¡
 !ğ
UCC_OK
) {

35 
j
 = 0; j < 
i
; j++) {

36 
	`CUDA_FUNC
(
	`cudaSŒ—mDe¡roy
(
»sourûs
->
exec_¡»ams
[
j
]));

38 
	`ucc_¥š_uÆock
(&
ucc_ec_cuda
.
š™_¥šlock
);

39  
¡
;

42 
»sourûs
->
¡»ams_š™Ÿlized
 = 1;

43 
uÆock
:

44 
	`ucc_¥š_uÆock
(&
ucc_ec_cuda
.
š™_¥šlock
);

47 
id
 = 
	`ucc_©omic_çdd32
(&
Ï¡_u£d
, 1);

48 *
¡»am
 = 
»sourûs
->
exec_¡»ams
[
id
 % 
num_¡»ams
];

49  
UCC_OK
;

50 
	}
}

53 
ucc_¡©us_t
 
ucc_ec_cuda_cİy_muÉi_k”Ãl
(cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
¬gs
,

54 
cudaSŒ—m_t
 
¡»am
);

56 
ucc_¡©us_t


57 
	$ucc_cuda_executÜ_š‹¼u±ibË_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

58 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

59 
ucc_“_executÜ_sk_t
 **
sk
)

61 
cudaSŒ—m_t
 
¡»am
 = 
NULL
;

62 
size_t
 
num_nodes
 = 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
;

63 
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
 *
“_sk
;

64 
ucc_¡©us_t
 
¡©us
;

65 
cudaG¿phNode_t
 
nodes
[
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
];

66 
ucc_ec_cuda_»sourûs_t
 *
»sourûs
;

67 
i
;

69 
¡©us
 = 
	`ucc_ec_cuda_g‘_»sourûs
(&
»sourûs
);

70 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

71  
¡©us
;

74 
¡©us
 = 
	`ucc_cuda_executÜ_š‹¼u±ibË_g‘_¡»am
(&
¡»am
);

75 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

76  
¡©us
;

79 
“_sk
 = 
	`ucc_mpoŞ_g‘
(&
»sourûs
->
executÜ_š‹¼u±ibË_sks
);

80 ià(
	`ucc_uÆik–y
(!
“_sk
)) {

81  
UCC_ERR_NO_MEMORY
;

84 
¡©us
 = 
	`ucc_ec_cuda_ev’t_ü—‹
(&
“_sk
->
ev’t
);

85 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

86 
	`ucc_mpoŞ_put
(
“_sk
);

87  
¡©us
;

89 
“_sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

90 
“_sk
->
su³r
.
“e
 = 
executÜ
;

91 
	`memıy
(&
“_sk
->
su³r
.
¬gs
, 
sk_¬gs
, (
ucc_“_executÜ_sk_¬gs_t
));

92 
sk_¬gs
->
sk_ty³
) {

93 
UCC_EE_EXECUTOR_TASK_COPY
:

94 
¡©us
 = 
	`CUDA_FUNC
(

95 
	`cudaMemıyAsync
(
sk_¬gs
->
cİy
.
d¡
,ask_¬gs->cİy.
¤c
,

96 
sk_¬gs
->
cİy
.
Ën
, 
cudaMemıyDeçuÉ
, 
¡»am
));

97 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

98 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo start memcpy op");

99 
ä“_sk
;

102 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
:

103 ià((
sk_¬gs
->
cİy_muÉi
.
couÁs
[0] > 
EC_CUDA_CONFIG
->
exec_cİy_th»sh
) &&

104 (
sk_¬gs
->
cİy_muÉi
.
num_veùÜs
 > 2)) {

105 
¡©us
 = 
	`CUDA_FUNC
(
	`cudaG¿phG‘Nodes
(
“_sk
->
g¿ph
, 
nodes
,

106 &
num_nodes
));

107 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

108 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo get graph‚odes");

109 
ä“_sk
;

111 
i
 = 0; i < 
sk_¬gs
->
cİy_muÉi
.
num_veùÜs
; i++) {

112 
¡©us
 = 
	`CUDA_FUNC
(

113 
	`cudaG¿phExecMemıyNodeS‘P¬ams1D
(
“_sk
->
g¿ph_exec
, 
nodes
[
i
],

114 
sk_¬gs
->
cİy_muÉi
.
d¡
[
i
],

115 
sk_¬gs
->
cİy_muÉi
.
¤c
[
i
],

116 
sk_¬gs
->
cİy_muÉi
.
couÁs
[
i
],

117 
cudaMemıyDeçuÉ
));

118 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

119 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo instantiate graph");

120 
ä“_sk
;

124 ; 
i
 < 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
; i++) {

125 
¡©us
 = 
	`CUDA_FUNC
(

126 
	`cudaG¿phExecMemıyNodeS‘P¬ams1D
(
“_sk
->
g¿ph_exec
, 
nodes
[
i
],

127 
sk_¬gs
->
cİy_muÉi
.
d¡
[0],

128 
sk_¬gs
->
cİy_muÉi
.
¤c
[0],

129 1, 
cudaMemıyDeçuÉ
));

130 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

131 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo instantiate graph");

132 
ä“_sk
;

136 
¡©us
 = 
	`CUDA_FUNC
(
	`cudaG¿phLaunch
(
“_sk
->
g¿ph_exec
, 
¡»am
));

137 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

138 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo instantiate graph");

139 
ä“_sk
;

143 
¡©us
 = 
	`ucc_ec_cuda_cİy_muÉi_k”Ãl
(
sk_¬gs
, 
¡»am
);

144 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

145 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo start copy multi op");

146 
ä“_sk
;

150 
UCC_EE_EXECUTOR_TASK_REDUCE
:

151 
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
:

152 
UCC_EE_EXECUTOR_TASK_REDUCE_MULTI_DST
:

153 
¡©us
 = 
	`ucc_ec_cuda_»duû
((
ucc_“_executÜ_sk_¬gs_t
 *)
sk_¬gs
,

154 
¡»am
);

155 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

156 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo start„educe op");

157 
ä“_sk
;

161 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "executor operation %d is‚ot supported",

162 
sk_¬gs
->
sk_ty³
);

163 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

164 
ä“_sk
;

167 
¡©us
 = 
	`ucc_ec_cuda_ev’t_po¡
(
¡»am
, 
“_sk
->
ev’t
);

168 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

169 
ä“_sk
;

172 *
sk
 = &
“_sk
->
su³r
;

173  
UCC_OK
;

175 
ä“_sk
:

176 
	`ucc_ec_cuda_ev’t_de¡roy
(
“_sk
->
ev’t
);

177 
	`ucc_mpoŞ_put
(
“_sk
);

178  
¡©us
;

179 
	}
}

181 
ucc_¡©us_t


182 
	$ucc_cuda_executÜ_š‹¼u±ibË_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
)

184 
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
 *
“_sk
 =

185 
	`ucc_d”ived_of
(
sk
, 
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
);

187 
“_sk
->
su³r
.
¡©us
 = 
	`ucc_ec_cuda_ev’t_‹¡
Óe_sk->
ev’t
);

188  
“_sk
->
su³r
.
¡©us
;

189 
	}
}

191 
ucc_¡©us_t


192 
	$ucc_cuda_executÜ_š‹¼u±ibË_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
)

194 
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
 *
“_sk
 =

195 
	`ucc_d”ived_of
(
sk
, 
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
);

196 
ucc_¡©us_t
 
¡©us
;

198 
	`ucc_as£¹
(
sk
->
¡©us
 =ğ
UCC_OK
);

199 
¡©us
 = 
	`ucc_ec_cuda_ev’t_de¡roy
(
“_sk
->
ev’t
);

200 
	`ucc_mpoŞ_put
(
sk
);

201  
¡©us
;

202 
	}
}

204 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_š‹¼u±ibË_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
)

206 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

207 
ucc_ec_cuda_executÜ_t
);

209 
“e
->
mode
 = 
UCC_EC_CUDA_EXECUTOR_MODE_INTERRUPTIBLE
;

210 
“e
->
¡©e
 = 
UCC_EC_CUDA_EXECUTOR_STARTED
;

212 
“e
->
İs
.
sk_po¡
 = 
ucc_cuda_executÜ_š‹¼u±ibË_sk_po¡
;

213 
“e
->
İs
.
sk_‹¡
 = 
ucc_cuda_executÜ_š‹¼u±ibË_sk_‹¡
;

214 
“e
->
İs
.
sk_fš®ize
 = 
ucc_cuda_executÜ_š‹¼u±ibË_sk_fš®ize
;

216  
UCC_OK
;

217 
	}
}

219 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_š‹¼u±ibË_¡İ
(
ucc_“_executÜ_t
 *
executÜ
)

221 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

222 
ucc_ec_cuda_executÜ_t
);

224 
“e
->
¡©e
 = 
UCC_EC_CUDA_EXECUTOR_INITIALIZED
;

225  
UCC_OK
;

226 
	}
}

	@src/components/ec/cuda/ec_cuda_executor_persistent.c

7 
	~"ec_cuda_executÜ.h
"

8 
	~"uts/¬ch/ıu.h
"

10 
ucc_¡©us_t


11 
	$ucc_cuda_executÜ_³rsi¡’t_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

12 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

13 
ucc_“_executÜ_sk_t
 **
sk
)

15 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

16 
ucc_ec_cuda_executÜ_t
);

17 
max_sks
 = 
EC_CUDA_CONFIG
->
exec_max_sks
;

18 
ucc_“_executÜ_sk_¬gs_t
 *
subsk_¬gs
;

19 
ucc_ec_cuda_executÜ_³rsi¡’t_sk_t
 *
“_sk
;

20 
i
;

21 
ucc_ec_cuda_»sourûs_t
 *
»sourûs
;

22 
ucc_¡©us_t
 
¡©us
;

24 
¡©us
 = 
	`ucc_ec_cuda_g‘_»sourûs
(&
»sourûs
);

25 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

26  
¡©us
;

29 ià(
ucc_ec_cuda
.
th»ad_mode
 =ğ
UCC_THREAD_MULTIPLE
) {

30 
	`ucc_¥š_lock
(&
“e
->
sks_lock
);

33 
“_sk
 = 
	`ucc_mpoŞ_g‘
(&
»sourûs
->
executÜ_³rsi¡’t_sks
);

34 ià(
	`ucc_uÆik–y
(!
“_sk
)) {

35  
UCC_ERR_NO_MEMORY
;

38 
“_sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

39 
“_sk
->
su³r
.
“e
 = 
executÜ
;

41 ià(
sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_COPY_MULTI
) {

42 
“_sk
->
num_subsks
 = 
sk_¬gs
->
cİy_muÉi
.
num_veùÜs
;

43 
i
 = 0; i < 
“_sk
->
num_subsks
; i++) {

44 
subsk_¬gs
 = &(
“e
->
sks
[Ó“->
pidx
 + 
i
è% 
max_sks
]);

45 
subsk_¬gs
->
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

46 
subsk_¬gs
->
cİy
.
¤c
 = 
sk_¬gs
->
cİy_muÉi
.¤c[
i
];

47 
subsk_¬gs
->
cİy
.
d¡
 = 
sk_¬gs
->
cİy_muÉi
.d¡[
i
];

48 
subsk_¬gs
->
cİy
.
Ën
 = 
sk_¬gs
->
cİy_muÉi
.
couÁs
[
i
];

50 
“_sk
->
subsks
[
i
] = 
subsk_¬gs
;

52 } ià(
sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_REDUCE_MULTI_DST
) {

53 
“_sk
->
num_subsks
 = 
sk_¬gs
->
»duû_muÉi_d¡
.
n_bufs
;

54 
i
 = 0; i < 
“_sk
->
num_subsks
; i++) {

55 
subsk_¬gs
 = &(
“e
->
sks
[Ó“->
pidx
 + 
i
è% 
max_sks
]);

56 
subsk_¬gs
->
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_REDUCE
;

57 
subsk_¬gs
->
»duû
.
¤cs
[0] = 
sk_¬gs
->
»duû_muÉi_d¡
.
¤c1
[
i
];

58 
subsk_¬gs
->
»duû
.
¤cs
[1] = 
sk_¬gs
->
»duû_muÉi_d¡
.
¤c2
[
i
];

59 
subsk_¬gs
->
»duû
.
d¡
 = 
sk_¬gs
->
»duû_muÉi_d¡
.d¡[
i
];

60 
subsk_¬gs
->
»duû
.
couÁ
 = 
sk_¬gs
->
»duû_muÉi_d¡
.
couÁs
[
i
];

61 
subsk_¬gs
->
»duû
.
dt
 = 
sk_¬gs
->
»duû_muÉi_d¡
.dt;

62 
subsk_¬gs
->
»duû
.
İ
 = 
sk_¬gs
->
»duû_muÉi_d¡
.op;

63 
subsk_¬gs
->
»duû
.
n_¤cs
 = 2;

65 
“_sk
->
subsks
[
i
] = 
subsk_¬gs
;

68 
“_sk
->
num_subsks
 = 1;

69 
“_sk
->
subsks
[0] = &(
“e
->
sks
[“e->
pidx
 % 
max_sks
]);

70 
	`memıy
(
“_sk
->
subsks
[0], 
sk_¬gs
,

71 (
ucc_“_executÜ_sk_¬gs_t
));

73 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

74 
“e
->
pidx
 +ğ
“_sk
->
num_subsks
;

75 ià(
ucc_ec_cuda
.
th»ad_mode
 =ğ
UCC_THREAD_MULTIPLE
) {

76 
	`ucc_¥š_uÆock
(&
“e
->
sks_lock
);

78 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
, "executÜask…o¡,ƒ“: %p", 
“e
);

80 *
sk
 = &
“_sk
->
su³r
;

81  
UCC_OK
;

82 
	}
}

84 
ucc_¡©us_t


85 
	$ucc_cuda_executÜ_³rsi¡’t_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
)

87 
ucc_ec_cuda_executÜ_³rsi¡’t_sk_t
 *
“_sk
;

88 
ucc_¡©us_t
 
¡©us
;

89 
i
;

91 
“_sk
 = 
	`ucc_d”ived_of
(
sk
, 
ucc_ec_cuda_executÜ_³rsi¡’t_sk_t
);

93 ià(
“_sk
->
su³r
.
¡©us
 !ğ
UCC_INPROGRESS
) {

94 
ex™
;

97 
¡©us
 = 
	`CUDA_FUNC
(
	`cudaG‘La¡E¼Ü
());

98 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

99 
“_sk
->
su³r
.
¡©us
 = status;

100 
ex™
;

103 
i
 = 0; i < 
“_sk
->
num_subsks
; i++) {

104 ià(
“_sk
->
subsks
[
i
]->
sk_ty³
 !ğ
UCC_EE_EXECUTOR_TASK_LAST
) {

105 
ex™
;

108 
“_sk
->
su³r
.
¡©us
 = 
UCC_OK
;

109 
ex™
:

110  
“_sk
->
su³r
.
¡©us
;

111 
	}
}

113 
ucc_¡©us_t


114 
	$ucc_cuda_executÜ_³rsi¡’t_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
)

116 
	`ucc_as£¹
(
sk
->
¡©us
 =ğ
UCC_OK
);

117 
	`ucc_mpoŞ_put
(
sk
);

118  
UCC_OK
;

119 
	}
}

121 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_³rsi¡’t_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

122 *
“_cÚ‹xt
)

124 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

125 
ucc_ec_cuda_executÜ_t
);

126 
ucc_¡©us_t
 
¡©us
;

128 
	`ucc_as£¹
(
“e
->
¡©e
 =ğ
UCC_EC_CUDA_EXECUTOR_INITIALIZED
);

129 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
, "executÜ s¹,ƒ“: %p", 
“e
);

130 
“e
->
su³r
.
“_cÚ‹xt
 =ƒe_context;

131 
“e
->
¡©e
 = 
UCC_EC_CUDA_EXECUTOR_POSTED
;

132 
“e
->
pidx
 = 0;

133 
“e
->
mode
 = 
UCC_EC_CUDA_EXECUTOR_MODE_PERSISTENT
;

135 
¡©us
 = 
	`ucc_ec_cuda_³rsi¡’t_k”Ãl_¡¬t
(
“e
);

136 ià(
¡©us
 !ğ
UCC_OK
) {

137 
	`ec_”rÜ
(&
ucc_ec_cuda
.
su³r
, "failedo†aunchƒxecutor kernel");

138  
¡©us
;

141 
“e
->
İs
.
sk_po¡
 = 
ucc_cuda_executÜ_³rsi¡’t_sk_po¡
;

142 
“e
->
İs
.
sk_‹¡
 = 
ucc_cuda_executÜ_³rsi¡’t_sk_‹¡
;

143 
“e
->
İs
.
sk_fš®ize
 = 
ucc_cuda_executÜ_³rsi¡’t_sk_fš®ize
;

144  
UCC_OK
;

145 
	}
}

147 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_³rsi¡’t_¡İ
(
ucc_“_executÜ_t
 *
executÜ
)

149 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

150 
ucc_ec_cuda_executÜ_t
);

151 vŞ©
ucc_ec_cuda_executÜ_¡©e_t
 *
¡
 = &
“e
->
¡©e
;

153 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
, "executÜ stİ,ƒ“: %p", 
“e
);

155 
	`ucc_as£¹
((*
¡
 !ğ
UCC_EC_CUDA_EXECUTOR_POSTED
) &&

156 (*
¡
 !ğ
UCC_EC_CUDA_EXECUTOR_SHUTDOWN
));

157 *
¡
 = 
UCC_EC_CUDA_EXECUTOR_SHUTDOWN
;

158 
“e
->
pidx
 = -1;

159 *
¡
 !ğ
UCC_EC_CUDA_EXECUTOR_SHUTDOWN_ACK
) { }

160 
“e
->
su³r
.
“_cÚ‹xt
 = 
NULL
;

161 
“e
->
¡©e
 = 
UCC_EC_CUDA_EXECUTOR_INITIALIZED
;

163  
UCC_OK
;

164 
	}
}

	@src/components/ec/cuda/ec_cuda_executor_persistent_wait.c

7 
	~"ec_cuda_executÜ.h
"

9 
ucc_¡©us_t


10 
ucc_ec_cuda_po¡_k”Ãl_¡»am_sk
(
ucc_ec_cuda_executÜ_¡©e_t
 *
¡©e
,

11 
cudaSŒ—m_t
 
¡»am
);

13 
ucc_¡©us_t


14 
	$ucc_ec_cuda_po¡_driv”_¡»am_sk
(
ucc_ec_cuda_executÜ_¡©e_t
 *
¡©e
,

15 
cudaSŒ—m_t
 
¡»am
)

17 
CUdeviû±r
 
¡©e_±r
 = (CUdeviû±r)
¡©e
;

18 
CU¡»amB©chMemOpP¬ams
 
b©ch_memİs
[3] = {};

20 
b©ch_memİs
[0].
İ”©iÚ
 = 
CU_STREAM_MEM_OP_WRITE_VALUE_32
;

21 
b©ch_memİs
[0].
wr™eV®ue
.
add»ss
 = 
¡©e_±r
;

22 
b©ch_memİs
[0].
wr™eV®ue
.
v®ue
 = 
UCC_EC_CUDA_EXECUTOR_STARTED
;

23 
b©ch_memİs
[0].
wr™eV®ue
.
æags
 = 0;

25 
b©ch_memİs
[1].
İ”©iÚ
 = 
CU_STREAM_MEM_OP_WAIT_VALUE_32
;

26 
b©ch_memİs
[1].
wa™V®ue
.
add»ss
 = 
¡©e_±r
;

27 
b©ch_memİs
[1].
wa™V®ue
.
v®ue
 = 
UCC_EC_CUDA_EXECUTOR_SHUTDOWN
;

28 
b©ch_memİs
[1].
wa™V®ue
.
æags
 = 
CU_STREAM_WAIT_VALUE_EQ
;

30 
b©ch_memİs
[2].
İ”©iÚ
 = 
CU_STREAM_MEM_OP_WRITE_VALUE_32
;

31 
b©ch_memİs
[2].
wr™eV®ue
.
add»ss
 = 
¡©e_±r
;

32 
b©ch_memİs
[2].
wr™eV®ue
.
v®ue
 = 
UCC_EC_CUDA_EXECUTOR_SHUTDOWN_ACK
;

33 
b©ch_memİs
[2].
wr™eV®ue
.
æags
 = 0;

35 
	`CUDADRV_FUNC
(
	`cuSŒ—mB©chMemOp
(
¡»am
, 3, 
b©ch_memİs
, 0));

36  
UCC_OK
;

37 
	}
}

39 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_³rsi¡’t_wa™_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

40 *
“_cÚ‹xt
)

42 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

43 
ucc_ec_cuda_executÜ_t
);

44 
cudaSŒ—m_t
 
¡»am
 = (cudaSŒ—m_t)
“_cÚ‹xt
;

46 
“e
->
su³r
.
“_cÚ‹xt
 =ƒe_context;

47 
“e
->
¡©e
 = 
UCC_EC_CUDA_EXECUTOR_POSTED
;

48 
“e
->
mode
 = 
UCC_EC_CUDA_EXECUTOR_MODE_PERSISTENT
;

50 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

51 ià(
ucc_ec_cuda
.
¡rm_sk_mode
 =ğ
UCC_EC_CUDA_TASK_KERNEL
) {

52  
	`ucc_ec_cuda_po¡_k”Ãl_¡»am_sk
(
“e
->
dev_¡©e
, 
¡»am
);

54  
	`ucc_ec_cuda_po¡_driv”_¡»am_sk
(
“e
->
dev_¡©e
, 
¡»am
);

56 
	}
}

58 
ucc_¡©us_t
 
	$ucc_cuda_executÜ_³rsi¡’t_wa™_¡İ
(
ucc_“_executÜ_t
 *
executÜ
)

60 
ucc_ec_cuda_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

61 
ucc_ec_cuda_executÜ_t
);

62 vŞ©
ucc_ec_cuda_executÜ_¡©e_t
 *
¡
 = &
“e
->
¡©e
;

64 
	`ec_debug
(&
ucc_ec_cuda
.
su³r
, "executÜ stİ,ƒ“: %p", 
“e
);

65 
	`ucc_as£¹
((*
¡
 !ğ
UCC_EC_CUDA_EXECUTOR_POSTED
) &&

66 (*
¡
 !ğ
UCC_EC_CUDA_EXECUTOR_SHUTDOWN
));

67 *
¡
 = 
UCC_EC_CUDA_EXECUTOR_SHUTDOWN
;

68 *
¡
 !ğ
UCC_EC_CUDA_EXECUTOR_SHUTDOWN_ACK
) { }

69 
“e
->
su³r
.
“_cÚ‹xt
 = 
NULL
;

70 
“e
->
¡©e
 = 
UCC_EC_CUDA_EXECUTOR_INITIALIZED
;

72  
UCC_OK
;

73 
	}
}

	@src/components/ec/cuda/ec_cuda_resources.c

1 
	~"ec_cuda_»sourûs.h
"

2 
	~"compÚ’ts/ec/ucc_ec_log.h
"

3 
	~"uts/ucc_m®loc.h
"

5 
	$ucc_ec_cuda_ev’t_š™
(
ucc_mpoŞ_t
 *
mp
, *
obj
, *
chunk
)

7 
ucc_ec_cuda_ev’t_t
 *
ba£
 = (ucc_ec_cuda_ev’t_ˆ*è
obj
;

9 
	`CUDA_FUNC
(
	`cudaEv’tC»©eW™hFÏgs
(&
ba£
->
ev’t
, 
cudaEv’tDi§bËTimšg
));

10 
	}
}

12 
	$ucc_ec_cuda_ev’t_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

14 
ucc_ec_cuda_ev’t_t
 *
ba£
 = (ucc_ec_cuda_ev’t_ˆ*è
obj
;

16 
	`CUDA_FUNC
(
	`cudaEv’tDe¡roy
(
ba£
->
ev’t
));

17 
	}
}

19 
ucc_mpoŞ_İs_t
 
	gucc_ec_cuda_ev’t_mpoŞ_İs
 = {

20 .
chunk_®loc
 = 
ucc_mpoŞ_hug‘lb_m®loc
,

21 .
	gchunk_»Ëa£
 = 
ucc_mpoŞ_hug‘lb_ä“
,

22 .
	gobj_š™
 = 
ucc_ec_cuda_ev’t_š™
,

23 .
	gobj_ş—nup
 = 
ucc_ec_cuda_ev’t_ş—nup
,

26 
ucc_¡©us_t
 
	$ucc_ec_cuda_“_executÜ_mpoŞ_chunk_m®loc
(
ucc_mpoŞ_t
 *
mp
,

27 
size_t
 *
size_p
,

28 ** 
chunk_p
)

30  
	`CUDA_FUNC
(
	`cudaHo¡AÎoc
((**)
chunk_p
, *
size_p
,

31 
cudaHo¡AÎocM­³d
));

32 
	}
}

34 
	$ucc_ec_cuda_“_executÜ_mpoŞ_chunk_ä“
(
ucc_mpoŞ_t
 *
mp
,

35 *
chunk
)

37 
	`CUDA_FUNC
(
	`cudaF»eHo¡
(
chunk
));

38 
	}
}

40 
	$ucc_ec_cuda_executÜ_chunk_š™
(
ucc_mpoŞ_t
 *
mp
, *
obj
,

41 *
chunk
)

43 
ucc_ec_cuda_executÜ_t
 *
“e
 = (ucc_ec_cuda_executÜ_t*è
obj
;

44 
max_sks
 = 
ucc_ec_cuda_cÚfig
->
exec_max_sks
;

46 
	`CUDA_FUNC
(
	`cudaHo¡G‘DeviûPoš‹r
(

47 (**)(&
“e
->
dev_¡©e
), (*)&“e->
¡©e
, 0));

48 
	`CUDA_FUNC
(
	`cudaHo¡G‘DeviûPoš‹r
(

49 (**)(&
“e
->
dev_pidx
), (*)&“e->
pidx
, 0));

50 
	`CUDA_FUNC
(
	`cudaM®loc
((**)&
“e
->
dev_cidx
, (*eee->dev_cidx)));

51 
	`CUDA_FUNC
(
	`cudaHo¡AÎoc
((**)&
“e
->
sks
,

52 
max_sks
 * 
MAX_SUBTASKS
 *

53 (
ucc_“_executÜ_sk_¬gs_t
),

54 
cudaHo¡AÎocM­³d
));

55 
	`CUDA_FUNC
(
	`cudaHo¡G‘DeviûPoš‹r
(

56 (**)(&
“e
->
dev_sks
), (*ë“->
sks
, 0));

57 
	`ucc_¥šlock_š™
(&
“e
->
sks_lock
, 0);

58 
	}
}

60 
	$ucc_ec_cuda_executÜ_chunk_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

62 
ucc_ec_cuda_executÜ_t
 *
“e
 = (ucc_ec_cuda_executÜ_t*è
obj
;

64 
	`CUDA_FUNC
(
	`cudaF»e
((*)
“e
->
dev_cidx
));

65 
	`CUDA_FUNC
(
	`cudaF»eHo¡
((*)
“e
->
sks
));

66 
	`ucc_¥šlock_de¡roy
(&
“e
->
sks_lock
);

67 
	}
}

69 
ucc_mpoŞ_İs_t
 
	gucc_ec_cuda_“_executÜ_mpoŞ_İs
 = {

70 .
chunk_®loc
 = 
ucc_ec_cuda_“_executÜ_mpoŞ_chunk_m®loc
,

71 .
	gchunk_»Ëa£
 = 
ucc_ec_cuda_“_executÜ_mpoŞ_chunk_ä“
,

72 .
	gobj_š™
 = 
ucc_ec_cuda_executÜ_chunk_š™
,

73 .
	gobj_ş—nup
 = 
ucc_ec_cuda_executÜ_chunk_ş—nup
,

76 
	$ucc_ec_cuda_g¿ph_š™
(
ucc_mpoŞ_t
 *
mp
, *
obj
, *
chunk
)

78 
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
 *
sk
 =

79 (
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
 *è
obj
;

80 
cudaG¿phNode_t
 
memıy_node
;

81 
i
;

83 
	`CUDA_FUNC
(
	`cudaG¿phC»©e
(&
sk
->
g¿ph
, 0));

84 
i
 = 0; i < 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
; i++) {

85 
	`CUDA_FUNC
(

86 
	`cudaG¿phAddMemıyNode1D
(&
memıy_node
, 
sk
->
g¿ph
, 
NULL
, 0,

87 (*)1, (*)1, 1, 
cudaMemıyDeçuÉ
));

90 
	`CUDA_FUNC
(

91 
	`cudaG¿phIn¡ªtŸ‹W™hFÏgs
(&
sk
->
g¿ph_exec
,ask->
g¿ph
, 0));

92 
	}
}

94 
	$ucc_ec_cuda_g¿ph_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

96 
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
 *
sk
 =

97 (
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
 *è
obj
;

99 
	`CUDA_FUNC
(
	`cudaG¿phExecDe¡roy
(
sk
->
g¿ph_exec
));

100 
	`CUDA_FUNC
(
	`cudaG¿phDe¡roy
(
sk
->
g¿ph
));

101 
	}
}

103 
ucc_mpoŞ_İs_t
 
	gucc_ec_cuda_š‹¼u±ibË_sk_mpoŞ_İs
 = {

104 .
chunk_®loc
 = 
ucc_mpoŞ_hug‘lb_m®loc
,

105 .
	gchunk_»Ëa£
 = 
ucc_mpoŞ_hug‘lb_ä“
,

106 .
	gobj_š™
 = 
ucc_ec_cuda_g¿ph_š™
,

107 .
	gobj_ş—nup
 = 
ucc_ec_cuda_g¿ph_ş—nup
,

110 
ucc_¡©us_t
 
	$ucc_ec_cuda_»sourûs_š™
(
ucc_ec_ba£_t
 *
ec
,

111 
ucc_ec_cuda_»sourûs_t
 *
»sourûs
)

113 
ucc_¡©us_t
 
¡©us
;

114 
num_¡»ams
;

116 
	`CUDADRV_CHECK
(
	`cuCtxG‘Cu¼’t
(&
»sourûs
->
cu_ùx
));

117 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
»sourûs
->
ev’ts
, 0, (
ucc_ec_cuda_ev’t_t
),

118 0, 
UCC_CACHE_LINE_SIZE
, 16, 
UINT_MAX
,

119 &
ucc_ec_cuda_ev’t_mpoŞ_İs
, 
UCC_THREAD_MULTIPLE
,

121 ià(
¡©us
 !ğ
UCC_OK
) {

122 
	`ec_”rÜ
(
ec
, "failedo create CUDAƒvents…ool");

123 
ex™_”r
;

126 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
»sourûs
->
executÜs
, 0,

127 (
ucc_ec_cuda_executÜ_t
), 0,

128 
UCC_CACHE_LINE_SIZE
, 16, 
UINT_MAX
,

129 &
ucc_ec_cuda_“_executÜ_mpoŞ_İs
,

130 
UCC_THREAD_MULTIPLE
, "CUDA EEƒxecutor objects");

131 ià(
¡©us
 !ğ
UCC_OK
) {

132 
	`ec_”rÜ
(
ec
, "failedo createƒxecutors…ool");

133 
ä“_ev’ts_mpoŞ
;

136 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
»sourûs
->
executÜ_š‹¼u±ibË_sks
, 0,

137 (
ucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
),

138 0, 
UCC_CACHE_LINE_SIZE
, 16, 
UINT_MAX
,

139 &
ucc_ec_cuda_š‹¼u±ibË_sk_mpoŞ_İs
,

140 
UCC_THREAD_MULTIPLE
, "interruptibleƒxecutorasks");

141 ià(
¡©us
 !ğ
UCC_OK
) {

142 
	`ec_”rÜ
(
ec
, "failedo create interruptibleasks…ool");

143 
ä“_executÜs_mpoŞ
;

146 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
»sourûs
->
executÜ_³rsi¡’t_sks
, 0,

147 (
ucc_ec_cuda_executÜ_³rsi¡’t_sk_t
), 0,

148 
UCC_CACHE_LINE_SIZE
, 16, 
UINT_MAX
, 
NULL
,

149 
UCC_THREAD_MULTIPLE
, "persistentƒxecutorasks");

150 ià(
¡©us
 !ğ
UCC_OK
) {

151 
	`ec_”rÜ
(
ec
, "failedo create…ersistentasks…ool");

152 
ä“_š‹¼u±ibË_sks_mpoŞ
;

155 
num_¡»ams
 = 
ucc_ec_cuda_cÚfig
->
exec_num_¡»ams
;

156 
»sourûs
->
exec_¡»ams
 = 
	`ucc_ÿÎoc
(
num_¡»ams
, (
cudaSŒ—m_t
),

158 ià(!
»sourûs
->
exec_¡»ams
) {

159 
	`ec_”rÜ
(
ec
, "failedo‡llocate %zd bytes forƒxecutor streams",

160 (
cudaSŒ—m_t
è* 
num_¡»ams
);

161 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

162 
ä“_³rsi¡’t_sks_mpoŞ
;

165  
UCC_OK
;

167 
ä“_³rsi¡’t_sks_mpoŞ
:

168 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
executÜ_³rsi¡’t_sks
, 0);

169 
ä“_š‹¼u±ibË_sks_mpoŞ
:

170 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
executÜ_³rsi¡’t_sks
, 0);

171 
ä“_executÜs_mpoŞ
:

172 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
executÜs
, 0);

173 
ä“_ev’ts_mpoŞ
:

174 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
ev’ts
, 0);

175 
ex™_”r
:

176  
¡©us
;

177 
	}
}

179 
	$ucc_ec_cuda_»sourûs_ş—nup
(
ucc_ec_cuda_»sourûs_t
 *
»sourûs
)

181 
i
;

182 
CUcÚ‹xt
 
tmp_cÚ‹xt
;

183 #ià
CUDA_VERSION
 >= 12000

184 
CU»suÉ
 
¡©us
;

185 
cu_ùx_id
;

187 
¡©us
 = 
	`cuCtxG‘Id
(
»sourûs
->
cu_ùx
, &
cu_ùx_id
);

188 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
CUDA_SUCCESS
)) {

193 
	`cuCtxPushCu¼’t
(
»sourûs
->
cu_ùx
);

194 
i
 = 0; i < 
ucc_ec_cuda_cÚfig
->
exec_num_¡»ams
; i++) {

195 ià(
»sourûs
->
exec_¡»ams
[
i
] !ğ
NULL
) {

196 
	`CUDA_FUNC
(
	`cudaSŒ—mDe¡roy
(
»sourûs
->
exec_¡»ams
[
i
]));

199 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
ev’ts
, 1);

200 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
executÜs
, 1);

201 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
executÜ_š‹¼u±ibË_sks
, 1);

202 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
executÜ_³rsi¡’t_sks
, 1);

204 
	`ucc_ä“
(
»sourûs
->
exec_¡»ams
);

205 
	`cuCtxPİCu¼’t
(&
tmp_cÚ‹xt
);

206 
	}
}

	@src/components/ec/cuda/ec_cuda_resources.h

7 #iâdeà
UCC_EC_CUDA_RESOURCES_H_


8 
	#UCC_EC_CUDA_RESOURCES_H_


	)

10 
	~"compÚ’ts/ec/ba£/ucc_ec_ba£.h
"

11 
	~"uts/¬ch/cuda_def.h
"

12 
	~"uts/ucc_mpoŞ.h
"

14 
	#MAX_SUBTASKS
 12

	)

16 
	eucc_ec_cuda_executÜ_¡©e
 {

17 
	mUCC_EC_CUDA_EXECUTOR_INITIALIZED
,

18 
	mUCC_EC_CUDA_EXECUTOR_POSTED
,

19 
	mUCC_EC_CUDA_EXECUTOR_STARTED
,

20 
	mUCC_EC_CUDA_EXECUTOR_SHUTDOWN
,

21 
	mUCC_EC_CUDA_EXECUTOR_SHUTDOWN_ACK


22 } 
	tucc_ec_cuda_executÜ_¡©e_t
;

24 
	eucc_ec_cuda_executÜ_mode
 {

25 
	mUCC_EC_CUDA_EXECUTOR_MODE_PERSISTENT
,

26 
	mUCC_EC_CUDA_EXECUTOR_MODE_INTERRUPTIBLE


27 } 
	tucc_ec_cuda_executÜ_mode_t
;

29 
	succ_ec_cuda_ev’t
 {

30 
cudaEv’t_t
 
	mev’t
;

31 } 
	tucc_ec_cuda_ev’t_t
;

33 
	succ_ec_cuda_executÜ_sk_İs
 {

34 
ucc_¡©us_t
 (*
sk_po¡
)(
ucc_“_executÜ_t
 *
	mexecutÜ
,

35 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
	msk_¬gs
,

36 
ucc_“_executÜ_sk_t
 **
	msk
);

37 
ucc_¡©us_t
 (*
sk_‹¡
)(cÚ¡ 
ucc_“_executÜ_sk_t
 *
	msk
);

38 
ucc_¡©us_t
 (*
sk_fš®ize
)(
ucc_“_executÜ_sk_t
 *
	msk
);

39 } 
	tucc_ec_cuda_executÜ_sk_İs_t
;

41 
	succ_ec_cuda_executÜ
 {

42 
ucc_“_executÜ_t
 
	msu³r
;

43 
ucc_ec_cuda_executÜ_mode_t
 
	mmode
;

44 
ušt64_t
 
	m»que¡ed_İs
;

45 
ucc_ec_cuda_executÜ_sk_İs_t
 
	mİs
;

46 
ucc_¥šlock_t
 
	msks_lock
;

47 
ucc_ec_cuda_executÜ_¡©e_t
 
	m¡©e
;

48 
	mpidx
;

49 
ucc_“_executÜ_sk_¬gs_t
 *
	msks
;

50 
ucc_ec_cuda_executÜ_¡©e_t
 *
	mdev_¡©e
;

51 
ucc_“_executÜ_sk_¬gs_t
 *
	mdev_sks
;

52 *
	mdev_pidx
;

53 *
	mdev_cidx
;

54 } 
	tucc_ec_cuda_executÜ_t
;

56 
	succ_ec_cuda_executÜ_š‹¼u±ibË_sk
 {

57 
ucc_“_executÜ_sk_t
 
	msu³r
;

58 *
	mev’t
;

59 
cudaG¿ph_t
 
	mg¿ph
;

60 
cudaG¿phExec_t
 
	mg¿ph_exec
;

61 } 
	tucc_ec_cuda_executÜ_š‹¼u±ibË_sk_t
;

63 
	succ_ec_cuda_executÜ_³rsi¡’t_sk
 {

64 
ucc_“_executÜ_sk_t
 
	msu³r
;

65 
	mnum_subsks
;

66 
ucc_“_executÜ_sk_¬gs_t
 *
	msubsks
[
MAX_SUBTASKS
];

67 } 
	tucc_ec_cuda_executÜ_³rsi¡’t_sk_t
;

69 
	succ_ec_cuda_»sourûs
 {

70 
CUcÚ‹xt
 
	mcu_ùx
;

71 
ucc_mpoŞ_t
 
	mev’ts
;

72 
ucc_mpoŞ_t
 
	mexecutÜs
;

73 
ucc_mpoŞ_t
 
	mexecutÜ_š‹¼u±ibË_sks
;

74 
ucc_mpoŞ_t
 
	mexecutÜ_³rsi¡’t_sks
;

75 
	m¡»ams_š™Ÿlized
;

76 
	mnum_¡»ams
;

77 
cudaSŒ—m_t
 *
	mexec_¡»ams
;

78 } 
	tucc_ec_cuda_»sourûs_t
;

80 
	eucc_ec_cuda_¡rm_sk_mode
 {

81 
	mUCC_EC_CUDA_TASK_KERNEL
,

82 
	mUCC_EC_CUDA_TASK_MEM_OPS
,

83 
	mUCC_EC_CUDA_TASK_AUTO
,

84 
	mUCC_EC_CUDA_TASK_LAST
,

85 } 
	tucc_ec_cuda_¡rm_sk_mode_t
;

87 
	succ_ec_cuda_cÚfig
 {

88 
ucc_ec_cÚfig_t
 
	msu³r
;

89 
ucc_ec_cuda_¡rm_sk_mode_t
 
	m¡rm_sk_mode
;

90 
	mexec_num_wÜk”s
;

91 
	mexec_num_th»ads
;

92 
	mexec_max_sks
;

93 
	mexec_num_¡»ams
;

94 
	m»duû_num_blocks
;

95 
	m»duû_num_th»ads
;

96 
	mu£_coİ”©ive_Ïunch
;

97 
	mexec_cİy_th»sh
;

98 } 
	tucc_ec_cuda_cÚfig_t
;

100 
ucc_ec_cuda_cÚfig_t
 *
ucc_ec_cuda_cÚfig
;

102 
ucc_¡©us_t
 
ucc_ec_cuda_»sourûs_š™
(
ucc_ec_ba£_t
 *
ec
,

103 
ucc_ec_cuda_»sourûs_t
 *
»sourûs
);

105 
ucc_ec_cuda_»sourûs_ş—nup
(
ucc_ec_cuda_»sourûs_t
 *
»sourûs
);

107 
KHASH_INIT
(
ucc_ec_cuda_»sourûs_hash
, , *, 1, \

108 
kh_št64_hash_func
, 
kh_št64_hash_equ®
);

109 
	#ucc_ec_cuda_»sourûs_hash_t
 
	`khash_t
(
ucc_ec_cuda_»sourûs_hash
)

	)

111 
šlše


112 * 
	$ec_cuda_»sourûs_hash_g‘
(
ucc_ec_cuda_»sourûs_hash_t
 *
h
,

113 
key
)

115 
kh™”_t
 
k
;

116 *
v®ue
;

118 
k
 = 
	`kh_g‘
(
ucc_ec_cuda_»sourûs_hash
, 
h
 , 
key
);

119 ià(
k
 =ğ
	`kh_’d
(
h
)) {

120  
NULL
;

122 
v®ue
 = 
	`kh_v®ue
(
h
, 
k
);

123  
v®ue
;

124 
	}
}

126 
šlše


127 
	$ec_cuda_»sourûs_hash_put
(
ucc_ec_cuda_»sourûs_hash_t
 *
h
,

128 
key
,

129 *
v®ue
)

131 
»t
;

132 
kh™”_t
 
k
;

133 
k
 = 
	`kh_put
(
ucc_ec_cuda_»sourûs_hash
, 
h
, 
key
, &
»t
);

134 
	`kh_v®ue
(
h
, 
k
èğ
v®ue
;

135 
	}
}

137 
šlše


138 * 
	$ec_cuda_»sourûs_hash_pİ
(
ucc_ec_cuda_»sourûs_hash_t
 *
h
)

140 *
»sourûs
 = 
NULL
;

141 
kh™”_t
 
k
;

143 
k
 = 
	`kh_begš
(
h
);

144 
k
 !ğ
	`kh_’d
(
h
)) {

145 ià(
	`kh_exi¡
(
h
, 
k
)) {

146 
»sourûs
 = 
	`kh_v®ue
(
h
, 
k
);

149 
k
++;

152 ià(
»sourûs
) {

153 
	`kh_d–
(
ucc_ec_cuda_»sourûs_hash
, 
h
, 
k
);

155  
»sourûs
;

156 
	}
}

	@src/components/ec/cuda/kernel/ec_cuda_half_sm52.h

18 #´agm¨
Úû


20 
	~<cuda_å16.h
>

23 #ià
defšed
(
__CUDACC__
)

27 #ià
defšed
(
__CUDA_ARCH__
è&& (__CUDA_ARCH__ < 530è&& (
CUDA_VERSION
 < 12020)

28 #ià!
defšed
(
__CUDA_NO_HALF_OPERATORS__
)

31 
__deviû__
 
__fÜûšlše__
 
__h®f
 
	gİ”©Ü
+(cÚ¡ 
	g__h®f
 &
	glh
, cÚ¡ __h®à&
	grh
)

33  
__æßt2h®f
(
__h®f2æßt
(
lh
è+ __h®f2æßt(
rh
));

35 
__deviû__
 
__fÜûšlše__
 
__h®f
 
	gİ”©Ü
-(cÚ¡ 
	g__h®f
 &
	glh
, cÚ¡ __h®à&
	grh
)

37  
__æßt2h®f
(
__h®f2æßt
(
lh
è- __h®f2æßt(
rh
));

39 
__deviû__
 
__fÜûšlše__
 
__h®f
 
	gİ”©Ü
*(cÚ¡ 
	g__h®f
 &
	glh
, cÚ¡ __h®à&
	grh
)

41  
__æßt2h®f
(
__h®f2æßt
(
lh
è* __h®f2æßt(
rh
));

43 
__deviû__
 
__fÜûšlše__
 
__h®f
 
	gİ”©Ü
/(cÚ¡ 
	g__h®f
 &
	glh
, cÚ¡ __h®à&
	grh
)

45  
__æßt2h®f
(
__h®f2æßt
(
lh
è/ __h®f2æßt(
rh
));

48 
__deviû__
 
__fÜûšlše__
 
	g__h®f
 &
	gİ”©Ü
+=(
__h®f
 &
lh
, cÚ¡ __h®à&
	grh
)

50 
	glh
 = 
__æßt2h®f
(
__h®f2æßt
(
lh
è+ __h®f2æßt(
rh
));

51  
	glh
;

53 
__deviû__
 
__fÜûšlše__
 
	g__h®f
 &
	gİ”©Ü
-=(
__h®f
 &
lh
, cÚ¡ __h®à&
	grh
)

55 
	glh
 = 
__æßt2h®f
(
__h®f2æßt
(
lh
è- __h®f2æßt(
rh
));

56  
	glh
;

58 
__deviû__
 
__fÜûšlše__
 
	g__h®f
 &
	gİ”©Ü
*=(
__h®f
 &
lh
, cÚ¡ __h®à&
	grh
)

60 
	glh
 = 
__æßt2h®f
(
__h®f2æßt
(
lh
è* __h®f2æßt(
rh
));

61  
	glh
;

63 
__deviû__
 
__fÜûšlše__
 
	g__h®f
 &
	gİ”©Ü
/=(
__h®f
 &
lh
, cÚ¡ __h®à&
	grh
)

65 
	glh
 = 
__æßt2h®f
(
__h®f2æßt
(
lh
è/ __h®f2æßt(
rh
));

66  
	glh
;

70 
__deviû__
 
__fÜûšlše__
 
	g__h®f
 &
	gİ”©Ü
++(__h®à&
	gh
)

72 
__h®f_¿w
 
	gÚe
;

73 
	gÚe
.
	gx
 = 0x3C00U;

74 
	gh
 +ğ
Úe
;

75  
	gh
;

77 
__deviû__
 
__fÜûšlše__
 
	g__h®f
 &
	gİ”©Ü
--(__h®à&
	gh
)

79 
__h®f_¿w
 
	gÚe
;

80 
	gÚe
.
	gx
 = 0x3C00U;

81 
	gh
 -ğ
Úe
;

82  
	gh
;

84 
__deviû__
 
__fÜûšlše__
 
__h®f
 
	gİ”©Ü
++(
	g__h®f
 &
	gh
, cÚ¡ 
	gignÜed
)

87 
	g¡©ic_ÿ¡
<>(
	gignÜed
);

89 cÚ¡ 
__h®f
 
	g»t
 = 
h
;

90 
__h®f_¿w
 
	gÚe
;

91 
	gÚe
.
	gx
 = 0x3C00U;

92 
	gh
 +ğ
Úe
;

93  
	g»t
;

95 
__deviû__
 
__fÜûšlše__
 
__h®f
 
	gİ”©Ü
--(
	g__h®f
 &
	gh
, cÚ¡ 
	gignÜed
)

98 
	g¡©ic_ÿ¡
<>(
	gignÜed
);

100 cÚ¡ 
__h®f
 
	g»t
 = 
h
;

101 
__h®f_¿w
 
	gÚe
;

102 
	gÚe
.
	gx
 = 0x3C00U;

103 
	gh
 -ğ
Úe
;

104  
	g»t
;

108 
__deviû__
 
__fÜûšlše__
 
__h®f
 
	gİ”©Ü
+(cÚ¡ 
	g__h®f
 &
	gh
)

110  
	gh
;

112 
__deviû__
 
__fÜûšlše__
 
__h®f
 
	gİ”©Ü
-(cÚ¡ 
	g__h®f
 &
	gh
)

114  
__æßt2h®f
(-
__h®f2æßt
(
h
));

118 
__deviû__
 
__fÜûšlše__
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
__h®f
 &
lh
, cÚ¡ 
	g__h®f
 &
	grh
)

120  
__h®f2æßt
(
lh
è=ğ__h®f2æßt(
rh
);

122 
__deviû__
 
__fÜûšlše__
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
__h®f
 &
lh
, cÚ¡ 
	g__h®f
 &
	grh
)

124  
__h®f2æßt
(
lh
è!ğ__h®f2æßt(
rh
);

126 
__deviû__
 
__fÜûšlše__
 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	g__h®f
 &
	glh
, cÚ¡ __h®à&
	grh
)

128  
__h®f2æßt
(
lh
è> __h®f2æßt(
rh
);

130 
__deviû__
 
__fÜûšlše__
 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	g__h®f
 &
	glh
, cÚ¡ __h®à&
	grh
)

132  
__h®f2æßt
(
lh
è< __h®f2æßt(
rh
);

134 
__deviû__
 
__fÜûšlše__
 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
__h®f
 &
lh
, cÚ¡ 
	g__h®f
 &
	grh
)

136  
__h®f2æßt
(
lh
è>ğ__h®f2æßt(
rh
);

138 
__deviû__
 
__fÜûšlše__
 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
__h®f
 &
lh
, cÚ¡ 
	g__h®f
 &
	grh
)

140  
__h®f2æßt
(
lh
è<ğ__h®f2æßt(
rh
);

	@src/components/ec/cuda/kernel/ec_cuda_reduce_ops.h

7 #iâdeà
UCC_EC_CUDA_REDUCE_OPS_H_


8 
	#UCC_EC_CUDA_REDUCE_OPS_H_


	)

11 
	~"uts/ucc_m©h_İ.h
"

12 
	~"../ec_cuda.h
"

15 
	~"ec_cuda_h®f_sm52.h
"

16 
	~<cuda_bf16.h
>

17 
	~<cuCom¶ex.h
>

19 
	#COPY_LOOP_UNROLL
 8

	)

20 
	#REDUCE_LOOP_UNROLL_TRIGGERED_FOUR
 4

	)

21 
	#REDUCE_LOOP_UNROLL_TRIGGERED_TWO
 2

	)

22 
	#REDUCE_LOOP_UNROLL_TRIGGERED_ONE
 1

	)

23 
	#REDUCE_LOOP_UNROLL_INTERRUPTIBLE
 1

	)

24 
št4
 
	tveùy³
;

26 
__deviû__
 
šlše


27 
cuDoubËCom¶ex
 
	gİ”©Ü
+ (cÚ¡ 
	gcuDoubËCom¶ex
 & 
	gfœ¡
,

28 cÚ¡ 
	gcuDoubËCom¶ex
 & 
	g£cÚd
) {

29  
cuCadd
(
fœ¡
, 
£cÚd
);

32 
__deviû__
 
šlše


33 
cuDoubËCom¶ex
 
	gİ”©Ü
* (cÚ¡ 
	gcuDoubËCom¶ex
 & 
	gfœ¡
,

34 cÚ¡ 
	gcuDoubËCom¶ex
 & 
	g£cÚd
) {

35  
cuCmul
(
fœ¡
, 
£cÚd
);

38 
__deviû__
 
šlše


39 
cuDoubËCom¶ex
 
	gİ”©Ü
* (cÚ¡ 
	gcuDoubËCom¶ex
 & 
	gfœ¡
,

40 cÚ¡ & 
	g£cÚd
) {

41  
make_cuDoubËCom¶ex
(
cuC»®
(
fœ¡
è* 
£cÚd
,

42 
cuCimag
(
fœ¡
è* 
£cÚd
);

45 
__deviû__
 
šlše


46 
cuFlßtCom¶ex
 
	gİ”©Ü
+ (cÚ¡ 
	gcuFlßtCom¶ex
 & 
	gfœ¡
,

47 cÚ¡ 
	gcuFlßtCom¶ex
 & 
	g£cÚd
) {

48  
cuCaddf
(
fœ¡
, 
£cÚd
);

51 
__deviû__
 
šlše


52 
cuFlßtCom¶ex
 
	gİ”©Ü
* (cÚ¡ 
	gcuFlßtCom¶ex
 & 
	gfœ¡
,

53 cÚ¡ 
	gcuFlßtCom¶ex
 & 
	g£cÚd
) {

54  
cuCmulf
(
fœ¡
, 
£cÚd
);

57 
__deviû__
 
šlše


58 
cuFlßtCom¶ex
 
	gİ”©Ü
* (cÚ¡ 
	gcuFlßtCom¶ex
 & 
	gfœ¡
,

59 cÚ¡ & 
	g£cÚd
) {

60  
make_cuFlßtCom¶ex
(
cuC»®f
(
fœ¡
è* 
£cÚd
,

61 
cuCimagf
(
fœ¡
è* 
£cÚd
);

64 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gVecTy³
> 
__deviû__
 
	$±rAlignVec
(
T
 *
±r
)

66  (
ušt64_t
)
±r
 % (
VecTy³
);

67 
	}
}

69 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gVecTy³
>

70 
__fÜûšlše__
 
__deviû__
 
	$LßdVec
(
T
 *
d
, T *
s
)

72 *(
»š‹½»t_ÿ¡
<
VecTy³
 *>(
d
)èğ*Ôeš‹½»t_ÿ¡<VecTy³ *>(
s
));

73 
	}
}

75 
	#CUDA_REDUCE_WITH_OP_CHUNK
(
uÄŞl
, 
uÄŞl_group_size
, 
_OP
, 
VecTy³
) \

77 cÚ¡ 
veùÜize
 = (
VecTy³
è/ (
Ty³
); \

78 cÚ¡ 
group
 = \

79 
Œigg”ed
 \

80 ? 
th»adIdx
.
x
 / 
uÄŞl_group_size
 \

81 : (
th»adIdx
.
x
 + 
blockIdx
.x * 
blockDim
.xè/ 
uÄŞl_group_size
; \

82 cÚ¡ 
num_groups
 = \

83 
Œigg”ed
 ? 
blockDim
.
x
 / 
uÄŞl_group_size
 \

84 : (
blockDim
.
x
 * 
gridDim
.xè/ 
uÄŞl_group_size
; \

85 cÚ¡ 
idx
 = 
th»adIdx
.
x
 % 
uÄŞl_group_size
; \

86 cÚ¡ 
çùÜ
 = 
uÄŞl_group_size
 * 
uÄŞl
 * 
veùÜize
; \

87 cÚ¡ 
size_t
 
¡¬t
 = \

88 
off£t
 + (
group
 * 
uÄŞl_group_size
 * 
uÄŞl
 + 
idx
è* 
veùÜize
; \

89 cÚ¡ 
size_t
 
¡•
 = 
num_groups
 * 
çùÜ
; \

90 cÚ¡ 
size_t
 
’d
 = 
off£t
 + ((
couÁ
 - off£tè/ 
çùÜ
) * factor; \

91 
Ty³
 
tmp1
[
uÄŞl
][
veùÜize
]; \

92 
Ty³
 
tmp2
[
uÄŞl
][
veùÜize
]; \

93 
	`ucc_as£¹_sy¡em
(
blockDim
.
x
 % 
uÄŞl_group_size
 == 0); \

94 
lše
 = 
¡¬t
;†š< 
’d
;†š+ğ
¡•
) { \

95 
	`_P¿gma
("uÄŞl"è
i
 = 0; i < 
uÄŞl
; i++) \

97 
LßdVec
<
Ty³
, 
VecTy³
>( \

98 
tmp1
[
i
], &
s1
[
lše
 + 
veùÜize
 * 
uÄŞl_group_size
 * i]); \

100 
j
 = 0; j < 
MAXSRCS
 && j < 
n_¤c2
; j++) { \

101 
	`_P¿gma
("uÄŞl"è
i
 = 0; i < 
uÄŞl
; i++) \

103 ià(
¡rided
) { \

104 
LßdVec
<
Ty³
, 
VecTy³
>( \

105 
tmp2
[
i
], \

106 &
s2
[
lše
 + 
veùÜize
 * 
uÄŞl_group_size
 * 
i
 + \

107 
j
 * 
ld
]); \

109 
LßdVec
<
Ty³
, 
VecTy³
>( \

110 
tmp2
[
i
], \

111 &
s
[1 + 
j
] \

112 [
lše
 + 
veùÜize
 * 
uÄŞl_group_size
 * 
i
]); \

115 
	`_P¿gma
("uÄŞl"è
i
 = 0; i < 
uÄŞl
; i++) \

117 
	`_P¿gma
("uÄŞl"è
k
 = 0; k < 
veùÜize
; k++) \

119 
tmp1
[
i
][
k
] = 
	`_OP
Ñmp1[i][k], 
tmp2
[i][k]); \

123 ià(
æags
 & 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
) { \

124 
	`_P¿gma
("uÄŞl"è
i
 = 0; i < 
uÄŞl
; i++) \

126 
	`_P¿gma
("uÄŞl"è
k
 = 0; k < 
veùÜize
; k++) \

128 
tmp1
[
i
][
k
] =mp1[i][k] * (
AÍhaTy³
)
sk
.
®pha
; \

132 
	`_P¿gma
("uÄŞl"è
i
 = 0; i < 
uÄŞl
; i++) \

134 
LßdVec
<
Ty³
, 
VecTy³
>( \

135 &
d
[
lše
 + 
veùÜize
 * 
uÄŞl_group_size
 * 
i
], 
tmp1
[i]); \

138 
off£t
 = 
	`max
(off£t, 
’d
); \

139 ià(
off£t
 =ğ
couÁ
) { \

142 } 0)

	)

144 
	#CUDA_REDUCE_WITH_OP
(
NAME
, 
_OP
) \

145 
‹m¶©e
 <
ty³Çme
 
Ty³
,y³Çm
AÍhaTy³
, 
boŞ
 
Œigg”ed
, boŞ 
¡rided
, \

146 
UNROLL
, 
ty³Çme
 
TaskTy³
> \

147 
__deviû__
 
ucc_»duû_cuda_
##
	`NAME
(
TaskTy³
 
sk
, 
ušt16_t
 
æags
) \

149 
Ty³
 * 
d
 = (Ty³ *)
sk
.
d¡
; \

150 
boŞ
 
®igÃdVec
 = 0; \

151 
size_t
 
off£t
 = 0; \

152 cÚ¡ 
size_t
 
couÁ
 = 
sk
.count; \

153 cÚ¡ 
MAXSRCS
 = 
¡rided
 ? 
USHRT_MAX
 : 
UCC_EE_EXECUTOR_NUM_BUFS
; \

154 cÚ¡ 
ALLOC_SIZE
 = 
¡rided
 ? 1 : 
UCC_EE_EXECUTOR_NUM_BUFS
; \

155 
Ty³
 * 
s
[
ALLOC_SIZE
]; \

156 
Ty³
 * 
s1
; \

157 
Ty³
 * 
s2
; \

158 
__sh¬ed__
 
ušt16_t
 
n_¤c2
; \

159 
size_t
 
ld
; \

160 
size_t
 
i
, 
j
, 
k
, 
lše
; \

161 ià(
¡rided
) { \

162 
ucc_“e_sk_»duû_¡rided_t
 *
sk_¡rided_p
 = \

163 (
ucc_“e_sk_»duû_¡rided_t
 *)&
sk
; \

164 
n_¤c2
 = 
sk_¡rided_p
->n_src2; \

165 
s1
 = (
Ty³
 *)
sk_¡rided_p
->
¤c1
; \

166 
s2
 = (
Ty³
 *)
sk_¡rided_p
->
¤c2
; \

167 
ld
 = 
sk_¡rided_p
->
¡ride
 / (
Ty³
); \

168 
	`ucc_as£¹_sy¡em
(
sk_¡rided_p
->
¡ride
 % (
Ty³
) == 0); \

169 
®igÃdVec
 |ğ
±rAlignVec
<
Ty³
, 
veùy³
>(
s1
); \

170 
®igÃdVec
 |ğ
±rAlignVec
<
Ty³
, 
veùy³
>(
s2
); \

171 
®igÃdVec
 |ğ((
sk_¡rided_p
->
¡ride
 % (
veùy³
)) != 0); \

173 
ucc_“e_sk_»duû_t
 *
sk_deçuÉ_p
 = \

174 (
ucc_“e_sk_»duû_t
 *)&
sk
; \

175 
	`memıy
(
s
, 
sk_deçuÉ_p
->
¤cs
, \

176 
UCC_EE_EXECUTOR_NUM_BUFS
 * (
Ty³
 *)); \

177 
n_¤c2
 = 
sk_deçuÉ_p
->
n_¤cs
 - 1; \

178 
s1
 = 
s
[0]; \

179 
i
 = 0; i < 
MAXSRCS
 && i <ğ
n_¤c2
; i++) \

180 
®igÃdVec
 |ğ
±rAlignVec
<
Ty³
, 
veùy³
>(
s
[
i
]); \

182 
®igÃdVec
 |ğ
±rAlignVec
<
Ty³
, 
veùy³
>(
d
); \

183 
	`ucc_as£¹_sy¡em
((
veùy³
è% (
Ty³
) == 0); \

189 ià(
Œigg”ed
 && 
®igÃdVec
 == 0) { \

191 
	`CUDA_REDUCE_WITH_OP_CHUNK
(
UNROLL
, 
WARP_SIZE
, 
_OP
, 
veùy³
); \

193 
	`CUDA_REDUCE_WITH_OP_CHUNK
(1, 1, 
_OP
, 
veùy³
); \

196 
	`CUDA_REDUCE_WITH_OP_CHUNK
(
UNROLL
, 
WARP_SIZE
, 
_OP
, 
Ty³
); \

198 
	`CUDA_REDUCE_WITH_OP_CHUNK
(1, 1, 
_OP
, 
Ty³
); \

200 
‹m¶©e
 <
ty³Çme
 
Ty³
,y³Çm
AÍhaTy³
, 
boŞ
 
Œigg”ed
, 
UNROLL
> \

201 
__glob®__
 
UCC_REDUCE_CUDA_DEFAULT_
##
	`NAME
(
ucc_“e_sk_»duû_t
 
sk
, \

202 
ušt16_t
 
æags
) \

204 
ucc_»duû_cuda_
##
NAME
<
Ty³
, 
AÍhaTy³
, 
Œigg”ed
, 
çl£
, 
UNROLL
, \

205 
ucc_“e_sk_»duû_t
>(
sk
, 
æags
); \

207 
‹m¶©e
 <
ty³Çme
 
Ty³
,y³Çm
AÍhaTy³
, 
boŞ
 
Œigg”ed
, 
UNROLL
> \

208 
__glob®__
 
UCC_REDUCE_CUDA_STRIDED_
##
	`NAME
( \

209 
ucc_“e_sk_»duû_¡rided_t
 
sk
, 
ušt16_t
 
æags
) \

211 
ucc_»duû_cuda_
##
NAME
<
Ty³
, 
AÍhaTy³
, 
Œigg”ed
, 
Œue
, 
UNROLL
, \

212 
ucc_“e_sk_»duû_¡rided_t
>(
sk
, 
æags
); \

213 }

	)

215 
	#CUDA_REDUCE_WITH_OP_MULTI_DST
(
NAME
, 
_OP
) \

216 
‹m¶©e
 <
ty³Çme
 
_Ty³
, 
boŞ
 
Œigg”ed
> \

217 
__glob®__
 
UCC_REDUCE_CUDA_MULTI_DST_
##
	`NAME
( \

218 
ucc_“e_sk_»duû_muÉi_d¡_t
 
¬g
) \

220 
size_t
 
¡¬t
 = \

221 
Œigg”ed
 ? 
th»adIdx
.
x
 :h»adIdx.x + 
blockIdx
.x * 
blockDim
.x; \

222 
size_t
 
¡•
 = 
Œigg”ed
 ? 
blockDim
.
x
 : blockDim.x * 
gridDim
.x; \

223 
j
 = 0; j < 
¬g
.
n_bufs
; j++) { \

224 
size_t
 
couÁ
 = 
¬g
.
couÁs
[
j
]; \

225 
_Ty³
 *
s2
 = (_Ty³ *)
¬g
.
¤c2
[
j
]; \

226 
_Ty³
 *
s1
 = (_Ty³ *)
¬g
.
¤c1
[
j
]; \

227 
_Ty³
 *
d
 = (_Ty³ *)
¬g
.
d¡
[
j
]; \

228 
size_t
 
i
 = 
¡¬t
; i < 
couÁ
; i +ğ
¡•
) { \

229 
d
[
i
] = 
_OP
##
	`_2
(
s1
[i], 
s2
[i]); \

232 }

	)

234 
CUDA_REDUCE_WITH_OP
(
SUM
, 
DO_OP_SUM
);

235 
CUDA_REDUCE_WITH_OP
(
PROD
, 
DO_OP_PROD
);

236 
CUDA_REDUCE_WITH_OP
(
MIN
, 
DO_OP_MIN
);

237 
CUDA_REDUCE_WITH_OP
(
MAX
, 
DO_OP_MAX
);

238 
CUDA_REDUCE_WITH_OP
(
LAND
, 
DO_OP_LAND
);

239 
CUDA_REDUCE_WITH_OP
(
LOR
, 
DO_OP_LOR
);

240 
CUDA_REDUCE_WITH_OP
(
LXOR
, 
DO_OP_LXOR
);

241 
CUDA_REDUCE_WITH_OP
(
BAND
, 
DO_OP_BAND
);

242 
CUDA_REDUCE_WITH_OP
(
BOR
, 
DO_OP_BOR
);

243 
CUDA_REDUCE_WITH_OP
(
BXOR
, 
DO_OP_BXOR
);

245 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
SUM
, 
DO_OP_SUM
);

246 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
PROD
, 
DO_OP_PROD
);

247 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
MIN
, 
DO_OP_MIN
);

248 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
MAX
, 
DO_OP_MAX
);

249 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
LAND
, 
DO_OP_LAND
);

250 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
LOR
, 
DO_OP_LOR
);

251 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
LXOR
, 
DO_OP_LXOR
);

252 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
BAND
, 
DO_OP_BAND
);

253 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
BOR
, 
DO_OP_BOR
);

254 
CUDA_REDUCE_WITH_OP_MULTI_DST
(
BXOR
, 
DO_OP_BXOR
);

256 
	#DT_REDUCE_INT
(
_Ty³
, 
_sk
, 
_İ
, ...) \

258 
_İ
) { \

259 
UCC_OP_AVG
: \

260 
UCC_OP_SUM
: \

261 
	`LAUNCH_REDUCE
(
SUM
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

263 
UCC_OP_PROD
: \

264 
	`LAUNCH_REDUCE
(
PROD
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

266 
UCC_OP_MIN
: \

267 
	`LAUNCH_REDUCE
(
MIN
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

269 
UCC_OP_MAX
: \

270 
	`LAUNCH_REDUCE
(
MAX
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

272 
UCC_OP_LAND
: \

273 
	`LAUNCH_REDUCE
(
LAND
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

275 
UCC_OP_BAND
: \

276 
	`LAUNCH_REDUCE
(
BAND
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

278 
UCC_OP_LOR
: \

279 
	`LAUNCH_REDUCE
(
LOR
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

281 
UCC_OP_BOR
: \

282 
	`LAUNCH_REDUCE
(
BOR
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

284 
UCC_OP_LXOR
: \

285 
	`LAUNCH_REDUCE
(
LXOR
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

287 
UCC_OP_BXOR
: \

288 
	`LAUNCH_REDUCE
(
BXOR
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

291  
UCC_ERR_NOT_SUPPORTED
; \

293 } 0)

	)

295 
	#DT_REDUCE_FLOAT_COMPLEX
(
_Ty³
, 
_®phaTy³
, 
_sk
, 
_İ
, ...) \

297 
_İ
) { \

298 
UCC_OP_AVG
: \

299 
UCC_OP_SUM
: \

300 
	`LAUNCH_REDUCE_A
(
SUM
, 
_Ty³
, 
_®phaTy³
, 
_sk
, 
__VA_ARGS__
); \

302 
UCC_OP_PROD
: \

303 
	`LAUNCH_REDUCE_A
(
PROD
, 
_Ty³
, 
_®phaTy³
, 
_sk
, 
__VA_ARGS__
); \

306  
UCC_ERR_NOT_SUPPORTED
; \

308 } 0)

	)

310 
	#DT_REDUCE_FLOAT
(
_Ty³
, 
_sk
, 
_İ
, ...) \

312 
_İ
) { \

313 
UCC_OP_AVG
: \

314 
UCC_OP_SUM
: \

315 
	`LAUNCH_REDUCE
(
SUM
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

317 
UCC_OP_PROD
: \

318 
	`LAUNCH_REDUCE
(
PROD
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

320 
UCC_OP_MIN
: \

321 
	`LAUNCH_REDUCE
(
MIN
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

323 
UCC_OP_MAX
: \

324 
	`LAUNCH_REDUCE
(
MAX
, 
_Ty³
, 
_sk
, 
__VA_ARGS__
); \

327  
UCC_ERR_NOT_SUPPORTED
; \

329 } 0)

	)

	@src/components/ec/rocm/ec_rocm.c

8 
	~"ec_rocm.h
"

9 
	~"ec_rocm_executÜ.h
"

10 
	~"uts/ucc_m®loc.h
"

11 
	~"uts/¬ch/ıu.h
"

12 
	~<h/h_ruÁime.h
>

13 
	~<h§/h§.h
>

14 
	~<h§/h§_ext_amd.h
>

16 
ucc_cÚfig_f›ld_t
 
	gucc_ec_rocm_cÚfig_bË
[] = {

17 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_ec_rocm_cÚfig_t
, 
su³r
),

18 
UCC_CONFIG_TYPE_TABLE
(
ucc_ec_cÚfig_bË
)},

22 
ucc_off£tof
(
ucc_ec_rocm_cÚfig_t
, 
exec_num_wÜk”s
),

23 
UCC_CONFIG_TYPE_ULUNITS
},

27 
ucc_off£tof
(
ucc_ec_rocm_cÚfig_t
, 
exec_num_th»ads
),

28 
UCC_CONFIG_TYPE_ULUNITS
},

32 
ucc_off£tof
(
ucc_ec_rocm_cÚfig_t
, 
exec_max_sks
),

33 
UCC_CONFIG_TYPE_ULUNITS
},

37 
ucc_off£tof
(
ucc_ec_rocm_cÚfig_t
, 
exec_num_¡»ams
),

38 
UCC_CONFIG_TYPE_ULUNITS
},

42 
ucc_off£tof
(
ucc_ec_rocm_cÚfig_t
, 
»duû_num_blocks
),

43 
UCC_CONFIG_TYPE_ULUNITS
},

47 
ucc_off£tof
(
ucc_ec_rocm_cÚfig_t
, 
»duû_ho¡_lim™
),

48 
UCC_CONFIG_TYPE_MEMUNITS
},

55 
ucc_off£tof
(
ucc_ec_rocm_cÚfig_t
, 
cİy_ho¡_lim™
),

56 
UCC_CONFIG_TYPE_MEMUNITS
},

58 {
NULL
}

62 
ucc_¡©us_t
 
	$ucc_ec_rocm_“_executÜ_mpoŞ_chunk_m®loc
(
ucc_mpoŞ_t
 *
mp
,

63 
size_t
 *
size_p
,

64 ** 
chunk_p
)

66  
	`ROCM_FUNC
(
	`hHo¡M®loc
((**)
chunk_p
, *
size_p
,

67 
hHo¡M®locM­³d
));

68 
	}
}

70 
	$ucc_ec_rocm_“_executÜ_mpoŞ_chunk_ä“
(
ucc_mpoŞ_t
 *
mp
,

71 *
chunk
)

73 
	`ROCM_FUNC
(
	`hHo¡F»e
(
chunk
));

74 
	}
}

76 
	$ucc_ec_rocm_executÜ_chunk_š™
(
ucc_mpoŞ_t
 *
mp
, *
obj
,

77 *
chunk
)

79 
ucc_ec_rocm_executÜ_t
 *
“e
 = (ucc_ec_rocm_executÜ_t*è
obj
;

80 
max_sks
 = 
EC_ROCM_CONFIG
->
exec_max_sks
;

82 
	`ROCM_FUNC
(
	`hHo¡G‘DeviûPoš‹r
(

83 (**)(&
“e
->
dev_¡©e
), (*)&“e->
¡©e
, 0));

84 
	`ROCM_FUNC
(
	`hHo¡G‘DeviûPoš‹r
(

85 (**)(&
“e
->
dev_pidx
), (*)&“e->
pidx
, 0));

86 
	`ROCM_FUNC
(
	`hM®loc
((**)&
“e
->
dev_cidx
, (*eee->dev_cidx)));

87 
	`ROCM_FUNC
(
	`hHo¡M®loc
((**)&
“e
->
sks
,

88 
max_sks
 * (
ucc_“_executÜ_sk_t
),

89 
hHo¡M®locM­³d
));

90 
	`ROCM_FUNC
(
	`hHo¡G‘DeviûPoš‹r
(

91 (**)(&
“e
->
dev_sks
), (*ë“->
sks
, 0));

92 ià(
ucc_ec_rocm
.
th»ad_mode
 =ğ
UCC_THREAD_MULTIPLE
) {

93 
	`ucc_¥šlock_š™
(&
“e
->
sks_lock
, 0);

95 
	}
}

97 
	$ucc_ec_rocm_executÜ_chunk_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

99 
ucc_ec_rocm_executÜ_t
 *
“e
 = (ucc_ec_rocm_executÜ_t*è
obj
;

101 
	`ROCM_FUNC
(
	`hF»e
((*)
“e
->
dev_cidx
));

102 
	`ROCM_FUNC
(
	`hHo¡F»e
((*)
“e
->
sks
));

103 ià(
ucc_ec_rocm
.
th»ad_mode
 =ğ
UCC_THREAD_MULTIPLE
) {

104 
	`ucc_¥šlock_de¡roy
(&
“e
->
sks_lock
);

106 
	}
}

108 
ucc_mpoŞ_İs_t
 
	gucc_ec_rocm_“_executÜ_mpoŞ_İs
 = {

109 .
chunk_®loc
 = 
ucc_ec_rocm_“_executÜ_mpoŞ_chunk_m®loc
,

110 .
	gchunk_»Ëa£
 = 
ucc_ec_rocm_“_executÜ_mpoŞ_chunk_ä“
,

111 .
	gobj_š™
 = 
ucc_ec_rocm_executÜ_chunk_š™
,

112 .
	gobj_ş—nup
 = 
ucc_ec_rocm_executÜ_chunk_ş—nup
,

115 
	$ucc_ec_rocm_ev’t_š™
(
ucc_mpoŞ_t
 *
mp
, *
obj
, *
chunk
)

117 
ucc_ec_rocm_ev’t_t
 *
ba£
 = (ucc_ec_rocm_ev’t_ˆ*è
obj
;

119 ià(
	`ucc_uÆik–y
(

120 
hSucûss
 !=

121 
	`hEv’tC»©eW™hFÏgs
(&
ba£
->
ev’t
, 
hEv’tDi§bËTimšg
))) {

122 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "hipEventCreateWithFlags Failed");

124 
	}
}

126 
	$ucc_ec_rocm_ev’t_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

128 
ucc_ec_rocm_ev’t_t
 *
ba£
 = (ucc_ec_rocm_ev’t_ˆ*è
obj
;

130 ià(
	`ucc_uÆik–y
(
hSucûss
 !ğ
	`hEv’tDe¡roy
(
ba£
->
ev’t
))) {

131 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "hipEventDestroy Failed");

133 
	}
}

135 
ucc_mpoŞ_İs_t
 
	gucc_ec_rocm_ev’t_mpoŞ_İs
 = {

136 .
chunk_®loc
 = 
ucc_mpoŞ_hug‘lb_m®loc
,

137 .
	gchunk_»Ëa£
 = 
ucc_mpoŞ_hug‘lb_ä“
,

138 .
	gobj_š™
 = 
ucc_ec_rocm_ev’t_š™
,

139 .
	gobj_ş—nup
 = 
ucc_ec_rocm_ev’t_ş—nup
,

142 
ucc_¡©us_t
 
	$ucc_ec_rocm_š™
(cÚ¡ 
ucc_ec_·¿ms_t
 *
ec_·¿ms
)

144 
ucc_ec_rocm_cÚfig_t
 *
cfg
 = 
EC_ROCM_CONFIG
;

145 
ucc_¡©us_t
 
¡©us
;

146 
deviû
, 
num_deviûs
;

147 
hE¼Ü_t
 
rocm_¡
;

148 
hDeviûPrİ_t
 
´İ
;

150 
ucc_ec_rocm
.
¡»am
 = 
NULL
;

151 
ucc_ec_rocm
.
¡»am_š™Ÿlized
 = 0;

152 
ucc_ec_rocm
.
exec_¡»ams_š™Ÿlized
 = 0;

153 
	`ucc_¡ºıy_§ã
(
ucc_ec_rocm
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
,

154 
ucc_ec_rocm
.
su³r
.su³r.
Çme
,

155 (
ucc_ec_rocm
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
));

156 
ucc_ec_rocm
.
th»ad_mode
 = 
ec_·¿ms
->thread_mode;

157 
rocm_¡
 = 
	`hG‘DeviûCouÁ
(&
num_deviûs
);

158 ià((
rocm_¡
 !ğ
hSucûss
è|| (
num_deviûs
 == 0)) {

159 
	`ec_debug
(&
ucc_ec_rocm
.
su³r
, "rocm devices‡re‚ot found");

160  
UCC_ERR_NO_RESOURCE
;

162 
	`ROCMCHECK
(
	`hG‘Deviû
(&
deviû
));

164 
	`ROCMCHECK
(
	`hG‘DeviûPrİ”t›s
(&
´İ
, 
deviû
));

165 
cfg
->
»duû_num_th»ads
 = 
´İ
.
maxTh»adsP”Block
;

167 ià(
cfg
->
»duû_num_blocks
 !ğ
UCC_ULUNITS_AUTO
) {

168 ià(
´İ
.
maxGridSize
[0] < 
cfg
->
»duû_num_blocks
) {

169 
	`ec_w¬n
(&
ucc_ec_rocm
.
su³r
,

171 
´İ
.
maxGridSize
[0]);

172 
cfg
->
»duû_num_blocks
 = 
´İ
.
maxGridSize
[0];

175 
cfg
->
»duû_num_blocks
 = 
´İ
.
maxGridSize
[0];

178 ià(
cfg
->
exec_num_¡»ams
 < 1) {

179 
	`ec_w¬n
(&
ucc_ec_rocm
.
su³r
,

181 
cfg
->
exec_num_¡»ams
 = 1;

185 
ucc_ec_rocm
.
exec_¡»ams
 = 
	`ucc_ÿÎoc
(
cfg
->
exec_num_¡»ams
,

186 (
hSŒ—m_t
),

188 ià(!
ucc_ec_rocm
.
exec_¡»ams
) {

189 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedo‡llocate streams‡rray");

190  
UCC_ERR_NO_MEMORY
;

192 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
ucc_ec_rocm
.
ev’ts
, 0, (
ucc_ec_rocm_ev’t_t
),

193 0, 
UCC_CACHE_LINE_SIZE
, 16, 
UINT_MAX
,

194 &
ucc_ec_rocm_ev’t_mpoŞ_İs
, 
UCC_THREAD_MULTIPLE
,

196 ià(
¡©us
 !ğ
UCC_OK
) {

197 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedo createƒvent…ool");

198  
¡©us
;

201 
¡©us
 = 
	`ucc_mpoŞ_š™
(

202 &
ucc_ec_rocm
.
executÜs
, 0, (
ucc_ec_rocm_executÜ_t
), 0,

203 
UCC_CACHE_LINE_SIZE
, 16, 
UINT_MAX
, &
ucc_ec_rocm_“_executÜ_mpoŞ_İs
,

204 
UCC_THREAD_MULTIPLE
, "EEƒxecutor Objects");

205 ià(
¡©us
 !ğ
UCC_OK
) {

206 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedo createƒxecutors…ool");

207  
¡©us
;

210 
¡©us
 = 
	`ucc_mpoŞ_š™
(

211 &
ucc_ec_rocm
.
executÜ_š‹¼u±ibË_sks
, 0,

212 (
ucc_ec_rocm_executÜ_š‹¼u±ibË_sk_t
), 0, 
UCC_CACHE_LINE_SIZE
,

213 16, 
UINT_MAX
, 
NULL
, 
UCC_THREAD_MULTIPLE
,

215 ià(
¡©us
 !ğ
UCC_OK
) {

216 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedo create interruptibleasks…ool");

217  
¡©us
;

220 
	`ucc_¥šlock_š™
(&
ucc_ec_rocm
.
š™_¥šlock
, 0);

221  
UCC_OK
;

222 
	}
}

224 
ucc_¡©us_t
 
	$ucc_ec_rocm_g‘_©Œ
(
ucc_ec_©Œ_t
 *
ec_©Œ
)

226 ià(
ec_©Œ
->
f›ld_mask
 & 
UCC_EC_ATTR_FIELD_THREAD_MODE
) {

227 
ec_©Œ
->
th»ad_mode
 = 
ucc_ec_rocm
.thread_mode;

229  
UCC_OK
;

230 
	}
}

232 
ucc_¡©us_t
 
	$ucc_ec_rocm_ev’t_ü—‹
(**
ev’t
)

234 
ucc_ec_rocm_ev’t_t
 *
rocm_ev’t
;

236 
rocm_ev’t
 = 
	`ucc_mpoŞ_g‘
(&
ucc_ec_rocm
.
ev’ts
);

237 ià(
	`ucc_uÆik–y
(!
rocm_ev’t
)) {

238 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "Failedo‡llocate„ocmƒvent");

239  
UCC_ERR_NO_MEMORY
;

241 *
ev’t
 = 
rocm_ev’t
;

242  
UCC_OK
;

243 
	}
}

245 
ucc_¡©us_t
 
	$ucc_ec_rocm_ev’t_de¡roy
(*
ev’t
)

247 
ucc_ec_rocm_ev’t_t
 *
rocm_ev’t
 = 
ev’t
;

249 
	`ucc_mpoŞ_put
(
rocm_ev’t
);

250  
UCC_OK
;

251 
	}
}

253 
ucc_¡©us_t
 
	$ucc_ec_rocm_ev’t_po¡
(*
“_cÚ‹xt
, *
ev’t
)

255 
hSŒ—m_t
 
¡»am
 = (hSŒ—m_tè
“_cÚ‹xt
;

256 
ucc_ec_rocm_ev’t_t
 *
rocm_ev’t
 = 
ev’t
;

258 
	`ROCMCHECK
(
	`hEv’tRecÜd
(
rocm_ev’t
->
ev’t
, 
¡»am
));

259  
UCC_OK
;

260 
	}
}

262 
ucc_¡©us_t
 
	$ucc_ec_rocm_ev’t_‹¡
(*
ev’t
)

264 
ucc_ec_rocm_ev’t_t
 *
rocm_ev’t
 = 
ev’t
;

265 
hE¼Ü_t
 
h_”r
;

267 
h_”r
 = 
	`hEv’tQu”y
(
rocm_ev’t
->
ev’t
);

268 ià(
	`ucc_uÆik–y
((
h_”r
 !ğ
hSucûss
) &&

269 (
h_”r
 !ğ
hE¼ÜNÙR—dy
))) {

270 
	`ROCMCHECK
(
h_”r
);

272  
	`h_”rÜ_to_ucc_¡©us
(
h_”r
);

273 
	}
}

275 
ucc_¡©us_t
 
	$ucc_ec_rocm_fš®ize
()

277 
i
;

279 ià(
ucc_ec_rocm
.
¡»am
 !ğ
NULL
) {

280 
	`ROCMCHECK
(
	`hSŒ—mDe¡roy
(
ucc_ec_rocm
.
¡»am
));

281 
ucc_ec_rocm
.
¡»am
 = 
NULL
;

283 ià(
ucc_ec_rocm
.
exec_¡»ams_š™Ÿlized
) {

284 
i
 = 0; i < 
EC_ROCM_CONFIG
->
exec_num_¡»ams
; i++) {

285 
	`ROCM_FUNC
(
	`hSŒ—mDe¡roy
(
ucc_ec_rocm
.
exec_¡»ams
[
i
]));

287 
ucc_ec_rocm
.
exec_¡»ams_š™Ÿlized
 = 0;

290 
	`ucc_mpoŞ_ş—nup
(&
ucc_ec_rocm
.
ev’ts
, 1);

291 
	`ucc_mpoŞ_ş—nup
(&
ucc_ec_rocm
.
executÜs
, 1);

292 
	`ucc_ä“
(
ucc_ec_rocm
.
exec_¡»ams
);

293  
UCC_OK
;

294 
	}
}

296 
ucc_ec_rocm_t
 
	gucc_ec_rocm
 = {

297 .
su³r
.su³r.
Çme
 = "rocmƒc",

298 .
	gsu³r
.
	g»f_út
 = 0,

299 .
	gsu³r
.
	gty³
 = 
UCC_EE_ROCM_STREAM
,

300 .
	gsu³r
.
	gš™
 = 
ucc_ec_rocm_š™
,

301 .
	gsu³r
.
	gg‘_©Œ
 = 
ucc_ec_rocm_g‘_©Œ
,

302 .
	gsu³r
.
	gfš®ize
 = 
ucc_ec_rocm_fš®ize
,

303 .
	gsu³r
.
	gcÚfig_bË
 =

305 .
Çme
 = "ROCMƒxecution component",

306 .
	g´efix
 = "EC_ROCM_",

307 .
	gbË
 = 
ucc_ec_rocm_cÚfig_bË
,

308 .
	gsize
 = (
ucc_ec_rocm_cÚfig_t
),

310 .
	gsu³r
.
	gİs
.
	gü—‹_ev’t
 = 
ucc_ec_rocm_ev’t_ü—‹
,

311 .
	gsu³r
.
	gİs
.
	gde¡roy_ev’t
 = 
ucc_ec_rocm_ev’t_de¡roy
,

312 .
	gsu³r
.
	gİs
.
	gev’t_po¡
 = 
ucc_ec_rocm_ev’t_po¡
,

313 .
	gsu³r
.
	gİs
.
	gev’t_‹¡
 = 
ucc_ec_rocm_ev’t_‹¡
,

314 .
	gsu³r
.
	gexecutÜ_İs
.
	gš™
 = 
ucc_rocm_executÜ_š™
,

315 .
	gsu³r
.
	gexecutÜ_İs
.
	g¡¬t
 = 
ucc_rocm_executÜ_¡¬t
,

316 .
	gsu³r
.
	gexecutÜ_İs
.
	g¡©us
 = 
ucc_rocm_executÜ_¡©us
,

317 .
	gsu³r
.
	gexecutÜ_İs
.
	g¡İ
 = 
ucc_rocm_executÜ_¡İ
,

318 .
	gsu³r
.
	gexecutÜ_İs
.
	gsk_po¡
 = 
ucc_rocm_executÜ_sk_po¡
,

319 .
	gsu³r
.
	gexecutÜ_İs
.
	gsk_‹¡
 = 
ucc_rocm_executÜ_sk_‹¡
,

320 .
	gsu³r
.
	gexecutÜ_İs
.
	gsk_fš®ize
 = 
ucc_rocm_executÜ_sk_fš®ize
,

321 .
	gsu³r
.
	gexecutÜ_İs
.
	gfš®ize
 = 
ucc_rocm_executÜ_fš®ize
,

324 
UCC_CONFIG_REGISTER_TABLE_ENTRY
(&
ucc_ec_rocm
.
su³r
.
cÚfig_bË
,

325 &
ucc_cÚfig_glob®_li¡
);

	@src/components/ec/rocm/ec_rocm.h

8 #iâdeà
UCC_EC_ROCM_H_


9 
	#UCC_EC_ROCM_H_


	)

11 
	~"compÚ’ts/ec/ba£/ucc_ec_ba£.h
"

12 
	~"compÚ’ts/ec/ucc_ec_log.h
"

13 
	~"cÜe/ucc_“.h
"

14 
	~"uts/ucc_mpoŞ.h
"

15 
	~"uts/¬ch/rocm_def.h
"

17 
	~<h/h_ruÁime.h
>

18 
	~<h/h_ruÁime_­i.h
>

19 
	~<h/h_com¶ex.h
>

20 
	~<h/h_bæßt16.h
>

22 #´agm¨
GCC
 
dŸgno¡ic
 
push


23 #ià
defšed
(
__şªg__
)

24 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wunknown-warning-option"

26 
	~<h/h_å16.h
>

27 #´agm¨
GCC
 
dŸgno¡ic
 
pİ


29 
	eucc_ec_sk_¡©us
 {

30 
	mUCC_EC_ROCM_TASK_COMPLETED
,

31 
	mUCC_EC_ROCM_TASK_POSTED
,

32 
	mUCC_EC_ROCM_TASK_STARTED
,

33 
	mUCC_EC_ROCM_TASK_COMPLETED_ACK


34 } 
	tucc_ec_sk_¡©us_t
;

36 
	eucc_ec_rocm_executÜ_¡©e
 {

37 
	mUCC_EC_ROCM_EXECUTOR_INITIALIZED
,

38 
	mUCC_EC_ROCM_EXECUTOR_POSTED
,

39 
	mUCC_EC_ROCM_EXECUTOR_STARTED
,

40 
	mUCC_EC_ROCM_EXECUTOR_SHUTDOWN
,

41 
	mUCC_EC_ROCM_EXECUTOR_SHUTDOWN_ACK


42 } 
	tucc_ec_rocm_executÜ_¡©e_t
;

44 
	eucc_ec_rocm_executÜ_mode
 {

45 
	mUCC_EC_ROCM_EXECUTOR_MODE_PERSISTENT
,

46 
	mUCC_EC_ROCM_EXECUTOR_MODE_INTERRUPTIBLE


47 } 
	tucc_ec_rocm_executÜ_mode_t
;

50 
šlše
 
ucc_¡©us_t
 
	$h_”rÜ_to_ucc_¡©us
(
hE¼Ü_t
 
h_”r
)

52 
h_”r
) {

53 
hSucûss
:

54  
UCC_OK
;

55 
hE¼ÜNÙR—dy
:

56  
UCC_INPROGRESS
;

60  
UCC_ERR_NO_MESSAGE
;

61 
	}
}

63 
	$ucc_¡©us_t
 (*
	tucc_ec_rocm_sk_po¡_â
è(
	tušt32_t
 *
	tdev_¡©us
,

64 
	tblockšg_wa™
,

65 
	thSŒ—m_t
 
	t¡»am
);

67 
	succ_ec_rocm_cÚfig
 {

68 
ucc_ec_cÚfig_t
 
su³r
;

69 
exec_num_wÜk”s
;

70 
exec_num_th»ads
;

71 
exec_max_sks
;

72 
exec_num_¡»ams
;

73 
»duû_num_blocks
;

74 
»duû_num_th»ads
;

75 
»duû_ho¡_lim™
;

76 
cİy_ho¡_lim™
;

77 } 
	tucc_ec_rocm_cÚfig_t
;

79 
	succ_ec_rocm
 {

80 
ucc_ec_ba£_t
 
su³r
;

81 
¡»am_š™Ÿlized
;

82 
hSŒ—m_t
 
¡»am
;

83 
exec_¡»ams_š™Ÿlized
;

84 
hSŒ—m_t
 *
exec_¡»ams
;

85 
ucc_mpoŞ_t
 
ev’ts
;

86 
ucc_mpoŞ_t
 
¡rm_»qs
;

87 
ucc_mpoŞ_t
 
executÜs
;

88 
ucc_mpoŞ_t
 
executÜ_š‹¼u±ibË_sks
;

89 
ucc_th»ad_mode_t
 
th»ad_mode
;

90 
ucc_¥šlock_t
 
š™_¥šlock
;

91 
ucc_“_executÜ_t
 *
ıu_executÜ
;

92 } 
	tucc_ec_rocm_t
;

94 
	succ_rocm_ec_ev’t
 {

95 
hEv’t_t
 
ev’t
;

96 } 
	tucc_ec_rocm_ev’t_t
;

98 
	succ_ec_rocm_¡»am_»que¡
 {

99 
ušt32_t
 
¡©us
;

100 
ušt32_t
 *
dev_¡©us
;

101 
hSŒ—m_t
 
¡»am
;

102 } 
	tucc_ec_rocm_¡»am_»que¡_t
;

104 
	succ_ec_rocm_executÜ_š‹¼u±ibË_sk
 {

105 
ucc_“_executÜ_sk_t
 
su³r
;

106 *
ev’t
;

107 } 
	tucc_ec_rocm_executÜ_š‹¼u±ibË_sk_t
;

109 
	succ_ec_rocm_executÜ_sk_İs
 {

110 
	`ucc_¡©us_t
 (*
sk_po¡
)(
ucc_“_executÜ_t
 *
executÜ
,

111 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

112 
ucc_“_executÜ_sk_t
 **
sk
);

113 
	`ucc_¡©us_t
 (*
sk_‹¡
)(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
);

114 
	`ucc_¡©us_t
 (*
sk_fš®ize
)(
ucc_“_executÜ_sk_t
 *
sk
);

115 } 
	tucc_ec_rocm_executÜ_sk_İs_t
;

117 
	succ_ec_rocm_executÜ
 {

118 
ucc_“_executÜ_t
 
su³r
;

119 
ucc_ec_rocm_executÜ_mode_t
 
mode
;

120 
ucc_ec_rocm_executÜ_sk_İs_t
 
İs
;

121 
ucc_¥šlock_t
 
sks_lock
;

122 
ucc_ec_rocm_executÜ_¡©e_t
 
¡©e
;

123 
pidx
;

124 
ucc_“_executÜ_sk_t
 *
sks
;

125 
ucc_ec_rocm_executÜ_¡©e_t
 *
dev_¡©e
;

126 
ucc_“_executÜ_sk_t
 *
dev_sks
;

127 *
dev_pidx
;

128 *
dev_cidx
;

129 } 
	tucc_ec_rocm_executÜ_t
;

131 
ucc_¡©us_t
 
	`ucc_ec_rocm_ev’t_ü—‹
(**
ev’t
);

133 
ucc_¡©us_t
 
	`ucc_ec_rocm_ev’t_de¡roy
(*
ev’t
);

135 
ucc_¡©us_t
 
	`ucc_ec_rocm_ev’t_po¡
(*
“_cÚ‹xt
, *
ev’t
);

137 
ucc_¡©us_t
 
	`ucc_ec_rocm_ev’t_‹¡
(*
ev’t
);

139 
ucc_ec_rocm_t
 
ucc_ec_rocm
;

141 
	#EC_ROCM_CONFIG
 \

142 (
	`ucc_d”ived_of
(
ucc_ec_rocm
.
su³r
.
cÚfig
, 
ucc_ec_rocm_cÚfig_t
))

	)

144 
	#UCC_EC_ROCM_INIT_STREAM
() do { \

145 ià(!
ucc_ec_rocm
.
¡»am_š™Ÿlized
) { \

146 
hE¼Ü_t
 
h_¡
 = 
hSucûss
; \

147 
	`ucc_¥š_lock
(&
ucc_ec_rocm
.
š™_¥šlock
); \

148 ià(!
ucc_ec_rocm
.
¡»am_š™Ÿlized
) { \

149 
h_¡
 = 
	`hSŒ—mC»©eW™hFÏgs
(&
ucc_ec_rocm
.
¡»am
, \

150 
hSŒ—mNÚBlockšg
); \

151 
ucc_ec_rocm
.
¡»am_š™Ÿlized
 = 1; \

153 
	`ucc_¥š_uÆock
(&
ucc_ec_rocm
.
š™_¥šlock
); \

154 if(
h_¡
 !ğ
hSucûss
) { \

155 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "rocm failed with„et:%d(%s)", \

156 
h_¡
, 
	`hG‘E¼ÜSŒšg
(hip_st)); \

157  
UCC_ERR_NO_MESSAGE
; \

160 
	}
} 0)

	)

	@src/components/ec/rocm/ec_rocm_executor.c

8 
	~"ec_rocm_executÜ.h
"

9 
	~"compÚ’ts/ec/ucc_ec.h
"

11 
ucc_¡©us_t
 
ucc_rocm_executÜ_³rsi¡’t_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

12 *
“_cÚ‹xt
);

14 
ucc_¡©us_t
 
ucc_rocm_executÜ_³rsi¡’t_¡İ
(
ucc_“_executÜ_t
 *
executÜ
);

16 
ucc_¡©us_t
 
ucc_rocm_executÜ_š‹¼u±ibË_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
);

18 
ucc_¡©us_t
 
ucc_rocm_executÜ_š‹¼u±ibË_¡İ
(
ucc_“_executÜ_t
 *
executÜ
);

20 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_š™
(cÚ¡ 
ucc_“_executÜ_·¿ms_t
 *
·¿ms
,

21 
ucc_“_executÜ_t
 **
executÜ
)

23 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_mpoŞ_g‘
(&
ucc_ec_rocm
.
executÜs
);

24 
ucc_¡©us_t
 
¡©us
;

25 
ucc_“_executÜ_·¿ms_t
 
ıu_·¿ms
 = {

26 .
mask
 = 
UCC_EE_EXECUTOR_PARAM_FIELD_TYPE
,

27 .
“_ty³
 = 
UCC_EE_CPU_THREAD


30 ià(
	`ucc_uÆik–y
(!
“e
)) {

31 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedo‡llocateƒxecutor");

32  
UCC_ERR_NO_MEMORY
;

35 
	`ec_debug
(&
ucc_ec_rocm
.
su³r
, "executÜ in™,ƒ“: %p", 
“e
);

36 
“e
->
su³r
.
“_ty³
 = 
·¿ms
->ee_type;

37 
“e
->
¡©e
 = 
UCC_EC_ROCM_EXECUTOR_INITIALIZED
;

39 
¡©us
 = 
	`ucc_“_executÜ_š™
(&
ıu_·¿ms
, &
ucc_ec_rocm
.
ıu_executÜ
);

40 ià(
¡©us
 !ğ
UCC_OK
) {

41 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
,

45 *
executÜ
 = &
“e
->
su³r
;

46  
UCC_OK
;

47 
	}
}

49 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_¡©us
(cÚ¡ 
ucc_“_executÜ_t
 *
executÜ
)

51 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

52 
ucc_ec_rocm_executÜ_t
);

54 
“e
->
¡©e
) {

55 
UCC_EC_ROCM_EXECUTOR_INITIALIZED
:

56  
UCC_OPERATION_INITIALIZED
;

57 
UCC_EC_ROCM_EXECUTOR_POSTED
:

58  
UCC_INPROGRESS
;

59 
UCC_EC_ROCM_EXECUTOR_STARTED
:

60  
UCC_OK
;

63  
UCC_ERR_NO_RESOURCE
;

65 
	}
}

67 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_fš®ize
(
ucc_“_executÜ_t
 *
executÜ
)

69 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

70 
ucc_ec_rocm_executÜ_t
);

71 
ucc_¡©us_t
 
¡©us
;

73 
	`ec_debug
(&
ucc_ec_rocm
.
su³r
, "executÜ f»e,ƒ“: %p", 
“e
);

74 
	`ucc_as£¹
(
“e
->
¡©e
 =ğ
UCC_EC_ROCM_EXECUTOR_INITIALIZED
);

75 
	`ucc_mpoŞ_put
(
“e
);

77 
¡©us
 = 
	`ucc_“_executÜ_fš®ize
(
ucc_ec_rocm
.
ıu_executÜ
);

78 ià(
¡©us
 !ğ
UCC_OK
) {

79 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
,

83  
¡©us
;

84 
	}
}

86 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

87 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

88 
ucc_“_executÜ_sk_t
 **
sk
)

90 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

91 
ucc_ec_rocm_executÜ_t
);

92  
“e
->
İs
.
	`sk_po¡
(
executÜ
, 
sk_¬gs
, 
sk
);

93 
	}
}

96 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
)

98 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
sk
->eee,

99 
ucc_ec_rocm_executÜ_t
);

100  
“e
->
İs
.
	`sk_‹¡
(
sk
);

101 
	}
}

103 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
)

105 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
sk
->eee,

106 
ucc_ec_rocm_executÜ_t
);

107  
“e
->
İs
.
	`sk_fš®ize
(
sk
);

108 
	}
}

110 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

111 *
“_cÚ‹xt
)

113 
ucc_¡©us_t
 
¡©us
;

115 
¡©us
 = 
	`ucc_“_executÜ_¡¬t
(
ucc_ec_rocm
.
ıu_executÜ
, 
“_cÚ‹xt
);

116 ià(
¡©us
 !ğ
UCC_OK
) {

117 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
,

119  
¡©us
;

122 ià(!
“_cÚ‹xt
) {

123  
	`ucc_rocm_executÜ_š‹¼u±ibË_¡¬t
(
executÜ
);

125  
	`ucc_rocm_executÜ_³rsi¡’t_¡¬t
(
executÜ
, 
“_cÚ‹xt
);

127 
	}
}

129 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_¡İ
(
ucc_“_executÜ_t
 *
executÜ
)

131 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

132 
ucc_ec_rocm_executÜ_t
);

133 
ucc_¡©us_t
 
¡©us
;

135 
¡©us
 = 
	`ucc_“_executÜ_¡İ
(
ucc_ec_rocm
.
ıu_executÜ
);

136 ià(
¡©us
 !ğ
UCC_OK
) {

137 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
,

139  
¡©us
;

142 ià(
“e
->
mode
 =ğ
UCC_EC_ROCM_EXECUTOR_MODE_INTERRUPTIBLE
) {

143  
	`ucc_rocm_executÜ_š‹¼u±ibË_¡İ
(
executÜ
);

145  
	`ucc_rocm_executÜ_³rsi¡’t_¡İ
(
executÜ
);

147 
	}
}

	@src/components/ec/rocm/ec_rocm_executor.h

8 #iâdeà
UCC_EC_ROCM_EXECUTOR_H_


9 
	#UCC_EC_ROCM_EXECUTOR_H_


	)

11 
	~"ec_rocm.h
"

13 
ucc_¡©us_t
 
ucc_rocm_executÜ_š™
(cÚ¡ 
ucc_“_executÜ_·¿ms_t
 *
·¿ms
,

14 
ucc_“_executÜ_t
 **
executÜ
);

16 
ucc_¡©us_t
 
ucc_rocm_executÜ_¡©us
(cÚ¡ 
ucc_“_executÜ_t
 *
executÜ
);

18 
ucc_¡©us_t
 
ucc_rocm_executÜ_fš®ize
(
ucc_“_executÜ_t
 *
executÜ
);

20 
ucc_¡©us_t
 
ucc_rocm_executÜ_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

21 *
“_cÚ‹xt
);

23 
ucc_¡©us_t
 
ucc_rocm_executÜ_¡İ
(
ucc_“_executÜ_t
 *
executÜ
);

25 
ucc_¡©us_t
 
ucc_rocm_executÜ_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

26 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

27 
ucc_“_executÜ_sk_t
 **
sk
);

29 
ucc_¡©us_t
 
ucc_rocm_executÜ_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
);

31 
ucc_¡©us_t
 
ucc_rocm_executÜ_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
);

34 
ucc_¡©us_t
 
ucc_ec_rocm_³rsi¡’t_k”Ãl_¡¬t
(
ucc_ec_rocm_executÜ_t
 *
“e
);

36 
ucc_¡©us_t
 
ucc_ec_rocm_»duû
(
ucc_“_executÜ_sk_¬gs_t
 *
sk
,

37 
hSŒ—m_t
 
¡»am
);

	@src/components/ec/rocm/ec_rocm_executor_interruptible.c

8 
	~<¡dboŞ.h
>

9 
	~"ec_rocm_executÜ.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"compÚ’ts/ec/ucc_ec.h
"

12 
	~"uts/ucc_©omic.h
"

14 
boŞ
 
	$ucc_ec_rocm_cİy_muÉi_u£_ho¡
 (cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
* 
sk_¬gs
)

16 
boŞ
 
»suÉ
 = 
Œue
;

18 
i
 = 0; i < 
sk_¬gs
->
cİy_muÉi
.
num_veùÜs
; i++) {

19 ià(
sk_¬gs
->
cİy_muÉi
.
couÁs
[
i
] > 
EC_ROCM_CONFIG
->
cİy_ho¡_lim™
) {

20 
»suÉ
 = 
çl£
;

25  
»suÉ
;

26 
	}
}

28 
	$ucc_ec_rocm_tÙ®_»duû_Ën
(cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
* 
sk_¬gs
)

30 
tÙ®_Ën
 = 0;

31 
ucc_d©©y³_t
 
dt
;

32 
size_t
 
couÁ
;

34 ià(
sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_REDUCE
) {

35 
dt
 = 
sk_¬gs
->
»duû
.dt;

36 
couÁ
 = 
sk_¬gs
->
»duû
.count;

38 
	`ucc_as£¹
(
sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
);

39 
dt
 = 
sk_¬gs
->
»duû_¡rided
.dt;

40 
couÁ
 = 
sk_¬gs
->
»duû_¡rided
.count;

42 
tÙ®_Ën
 +ğ
couÁ
 * 
	`ucc_dt_size
(
dt
);

44  
tÙ®_Ën
;

45 
	}
}

47 
boŞ
 
	$ucc_ec_rocm_ho¡_dt_suµÜ‹d
(cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
* 
sk_¬gs
)

49 
boŞ
 
»suÉ
 = 
çl£
;

50 
ucc_d©©y³_t
 
dt
;

52 ià(
sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_REDUCE
) {

53 
dt
 = 
sk_¬gs
->
»duû
.dt;

55 
	`ucc_as£¹
(
sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
);

56 
dt
 = 
sk_¬gs
->
»duû_¡rided
.dt;

58 ià(
dt
 !ğ
UCC_DT_BFLOAT16
 &&

59 
dt
 !ğ
UCC_DT_FLOAT16
 &&

60 
dt
 !ğ
UCC_DT_FLOAT32_COMPLEX
 &&

61 
dt
 !ğ
UCC_DT_FLOAT64_COMPLEX
) {

62 
»suÉ
 = 
Œue
;

64  
»suÉ
;

65 
	}
}

67 
šlše


68 
boŞ
 
	$ec_rocm_u£_ho¡_İs
(cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
_sk_¬gs
)

70 iàĞ(
_sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_COPY
 &&

71 
_sk_¬gs
->
cİy
.
Ën
 <ğ
EC_ROCM_CONFIG
->
cİy_ho¡_lim™
) ||

72 (
_sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_COPY_MULTI
 &&

73 
	`ucc_ec_rocm_cİy_muÉi_u£_ho¡
(
_sk_¬gs
)) ||

74 ((
_sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_REDUCE
 ||

75 
_sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
) &&

76 
	`ucc_ec_rocm_tÙ®_»duû_Ën
(
_sk_¬gs
è<ğ
EC_ROCM_CONFIG
->
»duû_ho¡_lim™
 &&

77 
	`ucc_ec_rocm_ho¡_dt_suµÜ‹d
(
_sk_¬gs
) )) {

78  
Œue
;

80  
çl£
;

81 
	}
}

83 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_š‹¼u±ibË_g‘_¡»am
(
hSŒ—m_t
 *
¡»am
)

85 
ušt32_t
 
Ï¡_u£d
 = 0;

86 
num_¡»ams
 = 
EC_ROCM_CONFIG
->
exec_num_¡»ams
;

87 
ucc_¡©us_t
 
¡
;

88 
i
, 
j
;

89 
ušt32_t
 
id
;

91 
	`ucc_as£¹
(
num_¡»ams
 > 0);

92 ià(
	`ucc_uÆik–y
(!
ucc_ec_rocm
.
exec_¡»ams_š™Ÿlized
)) {

93 
	`ucc_¥š_lock
(&
ucc_ec_rocm
.
š™_¥šlock
);

94 ià(
ucc_ec_rocm
.
exec_¡»ams_š™Ÿlized
) {

95 
uÆock
;

98 
i
 = 0; i < 
num_¡»ams
; i++) {

99 
¡
 = 
	`ROCM_FUNC
(
	`hSŒ—mC»©eW™hFÏgs
(&
ucc_ec_rocm
.
exec_¡»ams
[
i
],

100 
hSŒ—mNÚBlockšg
));

101 ià(
¡
 !ğ
UCC_OK
) {

102 
j
 = 0; j < 
i
; j++) {

103 
	`ROCM_FUNC
(
	`hSŒ—mDe¡roy
(
ucc_ec_rocm
.
exec_¡»ams
[
j
]));

105 
	`ucc_¥š_uÆock
(&
ucc_ec_rocm
.
š™_¥šlock
);

106  
¡
;

109 
ucc_ec_rocm
.
exec_¡»ams_š™Ÿlized
 = 1;

110 
uÆock
:

111 
	`ucc_¥š_uÆock
(&
ucc_ec_rocm
.
š™_¥šlock
);

114 
id
 = 
	`ucc_©omic_çdd32
(&
Ï¡_u£d
, 1);

115 *
¡»am
 = 
ucc_ec_rocm
.
exec_¡»ams
[
id
 % 
num_¡»ams
];

116  
UCC_OK
;

117 
	}
}

119 
ucc_¡©us_t
 
ucc_ec_rocm_cİy_muÉi_k”Ãl
(cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
¬gs
,

120 
hSŒ—m_t
 
¡»am
);

122 
ucc_¡©us_t


123 
	$ucc_rocm_executÜ_š‹¼u±ibË_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

124 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

125 
ucc_“_executÜ_sk_t
 **
sk
)

127 
ucc_ec_rocm_executÜ_š‹¼u±ibË_sk_t
 *
“_sk
;

128 
hSŒ—m_t
 
¡»am
;

129 
ucc_¡©us_t
 
¡©us
;

131 ià(
	`ec_rocm_u£_ho¡_İs
(
sk_¬gs
)) {

132 
¡©us
 = 
	`ucc_“_executÜ_sk_po¡
(
ucc_ec_rocm
.
ıu_executÜ
, 
sk_¬gs
,

133 
sk
);

134 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

135 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedoƒxecute host ops from ROCm component");

137  
¡©us
;

140 
¡©us
 = 
	`ucc_rocm_executÜ_š‹¼u±ibË_g‘_¡»am
(&
¡»am
);

141 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

142  
¡©us
;

145 
“_sk
 = 
	`ucc_mpoŞ_g‘
(&
ucc_ec_rocm
.
executÜ_š‹¼u±ibË_sks
);

146 ià(
	`ucc_uÆik–y
(!
“_sk
)) {

147  
UCC_ERR_NO_MEMORY
;

150 
¡©us
 = 
	`ucc_ec_rocm_ev’t_ü—‹
(&
“_sk
->
ev’t
);

151 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

152 
	`ucc_mpoŞ_put
(
“_sk
);

153  
¡©us
;

156 
“_sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

157 
“_sk
->
su³r
.
“e
 = 
executÜ
;

158 
	`memıy
(&
“_sk
->
su³r
.
¬gs
, 
sk_¬gs
, (
ucc_“_executÜ_sk_¬gs_t
));

159 
sk_¬gs
->
sk_ty³
) {

160 
UCC_EE_EXECUTOR_TASK_COPY
:

161 
¡©us
 = 
	`ROCM_FUNC
(
	`hMemıyAsync
(
sk_¬gs
->
cİy
.
d¡
,

162 
sk_¬gs
->
cİy
.
¤c
,

163 
sk_¬gs
->
cİy
.
Ën
, 
hMemıyDeçuÉ
,

164 
¡»am
));

165 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

166 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedo start memcpy op");

167 
ä“_sk
;

170 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
:

171 
¡©us
 = 
	`ucc_ec_rocm_cİy_muÉi_k”Ãl
(
sk_¬gs
, 
¡»am
);

172 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

173 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedo start copy multi op");

174 
ä“_sk
;

177 
UCC_EE_EXECUTOR_TASK_REDUCE
:

178 
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
:

179 
¡©us
 = 
	`ucc_ec_rocm_»duû
((
ucc_“_executÜ_sk_¬gs_t
 *)
sk_¬gs
,

180 
¡»am
);

181 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

182 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedo start„educe op");

183 
ä“_sk
;

187 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "executÜ o³¿tiÚ i nÙ suµÜ‹dask_ty³ %d", 
sk_¬gs
->
sk_ty³
);

188 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

189 
ä“_sk
;

192 
¡©us
 = 
	`ucc_ec_rocm_ev’t_po¡
(
¡»am
, 
“_sk
->
ev’t
);

193 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

194 
ä“_sk
;

197 *
sk
 = &
“_sk
->
su³r
;

198  
UCC_OK
;

200 
ä“_sk
:

201 
	`ucc_ec_rocm_ev’t_de¡roy
(
“_sk
->
ev’t
);

202 
	`ucc_mpoŞ_put
(
“_sk
);

203  
¡©us
;

204 
	}
}

206 
ucc_¡©us_t


207 
	$ucc_rocm_executÜ_š‹¼u±ibË_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
)

209 
ucc_ec_rocm_executÜ_š‹¼u±ibË_sk_t
 *
“_sk
 =

210 
	`ucc_d”ived_of
(
sk
, 
ucc_ec_rocm_executÜ_š‹¼u±ibË_sk_t
);

212 
“_sk
->
su³r
.
¡©us
 = 
	`ucc_ec_rocm_ev’t_‹¡
Óe_sk->
ev’t
);

213  
“_sk
->
su³r
.
¡©us
;

214 
	}
}

216 
ucc_¡©us_t


217 
	$ucc_rocm_executÜ_š‹¼u±ibË_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
)

219 
ucc_ec_rocm_executÜ_š‹¼u±ibË_sk_t
 *
“_sk
 =

220 
	`ucc_d”ived_of
(
sk
, 
ucc_ec_rocm_executÜ_š‹¼u±ibË_sk_t
);

221 
ucc_¡©us_t
 
¡©us
;

223 
¡©us
 = 
	`ucc_ec_rocm_ev’t_de¡roy
(
“_sk
->
ev’t
);

224 
	`ucc_mpoŞ_put
(
sk
);

225  
¡©us
;

226 
	}
}

228 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_š‹¼u±ibË_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
)

230 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

231 
ucc_ec_rocm_executÜ_t
);

233 
“e
->
mode
 = 
UCC_EC_ROCM_EXECUTOR_MODE_INTERRUPTIBLE
;

234 
“e
->
¡©e
 = 
UCC_EC_ROCM_EXECUTOR_STARTED
;

236 
“e
->
İs
.
sk_po¡
 = 
ucc_rocm_executÜ_š‹¼u±ibË_sk_po¡
;

237 
“e
->
İs
.
sk_‹¡
 = 
ucc_rocm_executÜ_š‹¼u±ibË_sk_‹¡
;

238 
“e
->
İs
.
sk_fš®ize
 = 
ucc_rocm_executÜ_š‹¼u±ibË_sk_fš®ize
;

240  
UCC_OK
;

241 
	}
}

243 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_š‹¼u±ibË_¡İ
(
ucc_“_executÜ_t
 *
executÜ
)

245 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

246 
ucc_ec_rocm_executÜ_t
);

248 
“e
->
¡©e
 = 
UCC_EC_ROCM_EXECUTOR_INITIALIZED
;

249  
UCC_OK
;

250 
	}
}

	@src/components/ec/rocm/ec_rocm_executor_persistent.c

8 
	~"ec_rocm_executÜ.h
"

9 
	~"uts/¬ch/ıu.h
"

11 
ucc_¡©us_t


12 
	$ucc_rocm_executÜ_³rsi¡’t_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

13 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

14 
ucc_“_executÜ_sk_t
 **
sk
)

16 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

17 
ucc_ec_rocm_executÜ_t
);

18 
max_sks
 = 
EC_ROCM_CONFIG
->
exec_max_sks
;

19 
ucc_“_executÜ_sk_t
 *
“_sk
;

20 
ucc_d©©y³_t
 
dt
;

21 
ucc_»duùiÚ_İ_t
 
İ
;

23 ià(
sk_¬gs
->
sk_ty³
 !ğ
UCC_EE_EXECUTOR_TASK_COPY
 &&

24 
sk_¬gs
->
sk_ty³
 !ğ
UCC_EE_EXECUTOR_TASK_COPY_MULTI
) {

25 ià(
sk_¬gs
->
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_REDUCE
) {

26 
dt
 = 
sk_¬gs
->
»duû
.dt;

27 
İ
 = 
sk_¬gs
->
»duû
.op;

29 
dt
 = 
sk_¬gs
->
»duû_¡rided
.dt;

30 
İ
 = 
sk_¬gs
->
»duû_¡rided
.op;

32 ià(
İ
 !ğ
UCC_OP_SUM
) {

33 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "not supported„eduction op: %s",

34 
	`ucc_»duùiÚ_İ_¡r
(
İ
));

35  
UCC_ERR_NOT_SUPPORTED
;

37 ià((
dt
 !ğ
UCC_DT_FLOAT32
è&& (dˆ!ğ
UCC_DT_FLOAT64
) &&

38 (
dt
 !ğ
UCC_DT_INT32
)) {

39 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "not supported„eduction dtype: %s",

40 
	`ucc_d©©y³_¡r
(
dt
));

41  
UCC_ERR_NOT_SUPPORTED
;

44 ià(
ucc_ec_rocm
.
th»ad_mode
 =ğ
UCC_THREAD_MULTIPLE
) {

45 
	`ucc_¥š_lock
(&
“e
->
sks_lock
);

47 
“_sk
 = &(
“e
->
sks
[“e->
pidx
 % 
max_sks
]);

48 
“_sk
->
“e
 = 
executÜ
;

49 
“_sk
->
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

50 
	`memıy
(&
“_sk
->
¬gs
, 
sk_¬gs
, (
ucc_“_executÜ_sk_¬gs_t
));

51 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

52 
“e
->
pidx
 += 1;

53 ià(
ucc_ec_rocm
.
th»ad_mode
 =ğ
UCC_THREAD_MULTIPLE
) {

54 
	`ucc_¥š_uÆock
(&
“e
->
sks_lock
);

56 
	`ec_debug
(&
ucc_ec_rocm
.
su³r
, "executÜask…o¡,ƒ“: %p", 
“e
);

58 *
sk
 = 
“_sk
;

59  
UCC_OK
;

60 
	}
}

63 
ucc_¡©us_t


64 
	$ucc_rocm_executÜ_³rsi¡’t_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
)

66 
	`ROCMCHECK
(
	`hG‘La¡E¼Ü
());

67  
sk
->
¡©us
;

68 
	}
}

70 
ucc_¡©us_t


71 
	$ucc_rocm_executÜ_³rsi¡’t_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
)

73  
UCC_OK
;

74 
	}
}

76 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_³rsi¡’t_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

77 *
“_cÚ‹xt
)

79 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

80 
ucc_ec_rocm_executÜ_t
);

81 
ucc_¡©us_t
 
¡©us
;

83 
	`ucc_as£¹
(
“e
->
¡©e
 =ğ
UCC_EC_ROCM_EXECUTOR_INITIALIZED
);

84 
	`ec_debug
(&
ucc_ec_rocm
.
su³r
, "executÜ s¹,ƒ“: %p", 
“e
);

85 
“e
->
su³r
.
“_cÚ‹xt
 =ƒe_context;

86 
“e
->
¡©e
 = 
UCC_EC_ROCM_EXECUTOR_POSTED
;

87 
“e
->
pidx
 = 0;

88 
“e
->
mode
 = 
UCC_EC_ROCM_EXECUTOR_MODE_PERSISTENT
;

90 
¡©us
 = 
	`ucc_ec_rocm_³rsi¡’t_k”Ãl_¡¬t
(
“e
);

91 ià(
¡©us
 !ğ
UCC_OK
) {

92 
	`ec_”rÜ
(&
ucc_ec_rocm
.
su³r
, "failedo†aunchƒxecutor kernel");

93  
¡©us
;

96 
“e
->
İs
.
sk_po¡
 = 
ucc_rocm_executÜ_³rsi¡’t_sk_po¡
;

97 
“e
->
İs
.
sk_‹¡
 = 
ucc_rocm_executÜ_³rsi¡’t_sk_‹¡
;

98 
“e
->
İs
.
sk_fš®ize
 = 
ucc_rocm_executÜ_³rsi¡’t_sk_fš®ize
;

99  
UCC_OK
;

100 
	}
}

102 
ucc_¡©us_t
 
	$ucc_rocm_executÜ_³rsi¡’t_¡İ
(
ucc_“_executÜ_t
 *
executÜ
)

104 
ucc_ec_rocm_executÜ_t
 *
“e
 = 
	`ucc_d”ived_of
(
executÜ
,

105 
ucc_ec_rocm_executÜ_t
);

106 vŞ©
ucc_ec_rocm_executÜ_¡©e_t
 *
¡
 = &
“e
->
¡©e
;

108 
	`ec_debug
(&
ucc_ec_rocm
.
su³r
, "executÜ stİ,ƒ“: %p", 
“e
);

110 
	`ucc_as£¹
((*
¡
 !ğ
UCC_EC_ROCM_EXECUTOR_POSTED
) &&

111 (*
¡
 !ğ
UCC_EC_ROCM_EXECUTOR_SHUTDOWN
));

112 *
¡
 = 
UCC_EC_ROCM_EXECUTOR_SHUTDOWN
;

113 
“e
->
pidx
 = -1;

114 *
¡
 !ğ
UCC_EC_ROCM_EXECUTOR_SHUTDOWN_ACK
) { }

115 
“e
->
su³r
.
“_cÚ‹xt
 = 
NULL
;

116 
“e
->
¡©e
 = 
UCC_EC_ROCM_EXECUTOR_INITIALIZED
;

118  
UCC_OK
;

119 
	}
}

	@src/components/ec/ucc_ec.c

7 
	~<±h»ad.h
>

8 
	~"cÚfig.h
"

9 
	~"ba£/ucc_ec_ba£.h
"

10 
	~"ucc_ec.h
"

11 
	~"cÜe/ucc_glob®_İts.h
"

12 
	~"uts/ucc_m®loc.h
"

13 
	~"uts/ucc_log.h
"

15 cÚ¡ 
ucc_ec_İs_t
 *
	gec_İs
[
UCC_EE_LAST
];

16 cÚ¡ 
ucc_“_executÜ_İs_t
 *
	gexecutÜ_İs
[
UCC_EE_LAST
];

17 
±h»ad_mu‹x_t
 
	gucc_ec_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

19 
	#UCC_CHECK_EC_AVAILABLE
(
“
) \

21 ià(
NULL
 =ğ
ec_İs
[
“
]) { \

22  
UCC_ERR_NOT_SUPPORTED
; \

24 } 0)

	)

26 
ucc_¡©us_t
 
	$ucc_ec_š™
(cÚ¡ 
ucc_ec_·¿ms_t
 *
ec_·¿ms
)

28 
i
, 
n_ecs
;

29 
ucc_ec_ba£_t
 *
ec
;

30 
ucc_¡©us_t
 
¡©us
;

31 
ucc_ec_©Œ_t
 
©Œ
;

33 
	`±h»ad_mu‹x_lock
(&
ucc_ec_mu‹x
);

34 
	`mem£t
(
ec_İs
, 0, 
UCC_EE_LAST
 * (
ucc_ec_İs_t
 *));

35 
n_ecs
 = 
ucc_glob®_cÚfig
.
ec_äamewÜk
.
n_compÚ’ts
;

36 
i
 = 0; i < 
n_ecs
; i++) {

37 
ec
 = 
	`ucc_d”ived_of
(
ucc_glob®_cÚfig
.
ec_äamewÜk
.
compÚ’ts
[
i
],

38 
ucc_ec_ba£_t
);

39 ià(
ec
->
»f_út
 == 0) {

40 
ec
->
cÚfig
 = 
	`ucc_m®loc
Óc->
cÚfig_bË
.
size
);

41 ià(!
ec
->
cÚfig
) {

42 
	`ucc_”rÜ
("failedo‡llocate %zd bytes forƒc config",

43 
ec
->
cÚfig_bË
.
size
);

46 
¡©us
 = 
	`ucc_cÚfig_·r£r_fl_İts
(

47 
ec
->
cÚfig
, &ec->
cÚfig_bË
, "UCC_", 1);

48 ià(
UCC_OK
 !ğ
¡©us
) {

49 
	`ucc_debug
("failedo…arse config for EC component: %s (%d)",

50 
ec
->
su³r
.
Çme
, 
¡©us
);

51 
	`ucc_ä“
(
ec
->
cÚfig
);

54 
¡©us
 = 
ec
->
	`š™
(
ec_·¿ms
);

55 ià(
UCC_OK
 !ğ
¡©us
) {

56 
	`ucc_debug
("ec_init failed for component: %s, skipping (%d)",

57 
ec
->
su³r
.
Çme
, 
¡©us
);

58 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(
ec
->
cÚfig
,

59 
ec
->
cÚfig_bË
.
bË
);

60 
	`ucc_ä“
(
ec
->
cÚfig
);

63 
	`ucc_debug
("eø% š™Ÿlized", 
ec
->
su³r
.
Çme
);

65 
©Œ
.
f›ld_mask
 = 
UCC_EC_ATTR_FIELD_THREAD_MODE
;

66 
¡©us
 = 
ec
->
	`g‘_©Œ
(&
©Œ
);

67 ià(
¡©us
 !ğ
UCC_OK
) {

68 
	`±h»ad_mu‹x_uÆock
(&
ucc_ec_mu‹x
);

69  
¡©us
;

71 ià(
©Œ
.
th»ad_mode
 < 
ec_·¿ms
->thread_mode) {

72 
	`ucc_šfo
("ec %s was‡llready initilized with "

74 
ec
->
su³r
.
Çme
, 
©Œ
.
th»ad_mode
,

75 
ec_·¿ms
->
th»ad_mode
);

78 
ec
->
»f_út
++;

79 
ec_İs
[
ec
->
ty³
] = &ec->
İs
;

80 
executÜ_İs
[
ec
->
ty³
] = &ec->executor_ops;

82 
	`±h»ad_mu‹x_uÆock
(&
ucc_ec_mu‹x
);

84  
UCC_OK
;

85 
	}
}

87 
ucc_¡©us_t
 
	$ucc_ec_avaabË
(
ucc_“_ty³_t
 
“_ty³
)

89 ià(
NULL
 =ğ
ec_İs
[
“_ty³
]) {

90  
UCC_ERR_NOT_FOUND
;

93  
UCC_OK
;

94 
	}
}

96 
ucc_¡©us_t
 
	$ucc_ec_g‘_©Œ
(
ucc_ec_©Œ_t
 *
©Œ
)

98 ià(
©Œ
->
f›ld_mask
 & 
UCC_EC_ATTR_FILED_MAX_EXECUTORS_BUFS
) {

99 
©Œ
->
max_“_bufs
 = 
UCC_EE_EXECUTOR_NUM_BUFS
;

102  
UCC_OK
;

103 
	}
}

105 
ucc_¡©us_t
 
	$ucc_ec_fš®ize
()

107 
ucc_“_ty³_t
 
‘
;

108 
ucc_ec_ba£_t
 *
ec
;

110 
	`±h»ad_mu‹x_lock
(&
ucc_ec_mu‹x
);

111 
‘
 = 
UCC_EE_FIRST
;ƒˆ< 
UCC_EE_LAST
;ƒt++) {

112 ià(
NULL
 !ğ
ec_İs
[
‘
]) {

113 
ec
 = 
	`ucc_cÚš”_of
(
ec_İs
[
‘
], 
ucc_ec_ba£_t
, 
İs
);

114 
ec
->
»f_út
--;

115 ià(
ec
->
»f_út
 == 0) {

116 
ec
->
	`fš®ize
();

117 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(
ec
->
cÚfig
,

118 
ec
->
cÚfig_bË
.
bË
);

119 
	`ucc_ä“
(
ec
->
cÚfig
);

120 
ec_İs
[
‘
] = 
NULL
;

124 
	`±h»ad_mu‹x_uÆock
(&
ucc_ec_mu‹x
);

126  
UCC_OK
;

127 
	}
}

129 
ucc_¡©us_t
 
	$ucc_ec_ü—‹_ev’t
(**
ev’t
, 
ucc_“_ty³_t
 
“_ty³
)

131 
	`UCC_CHECK_EC_AVAILABLE
(
“_ty³
);

132  
ec_İs
[
“_ty³
]->
	`ü—‹_ev’t
(
ev’t
);

133 
	}
}

135 
ucc_¡©us_t
 
	$ucc_ec_de¡roy_ev’t
(*
ev’t
, 
ucc_“_ty³_t
 
“_ty³
)

137 
	`UCC_CHECK_EC_AVAILABLE
(
“_ty³
);

138  
ec_İs
[
“_ty³
]->
	`de¡roy_ev’t
(
ev’t
);

139 
	}
}

141 
ucc_¡©us_t
 
	$ucc_ec_ev’t_po¡
(*
“_cÚ‹xt
, *
ev’t
,

142 
ucc_“_ty³_t
 
“_ty³
)

144 
	`UCC_CHECK_EC_AVAILABLE
(
“_ty³
);

145  
ec_İs
[
“_ty³
]->
	`ev’t_po¡
(
“_cÚ‹xt
, 
ev’t
);

146 
	}
}

148 
ucc_¡©us_t
 
	$ucc_ec_ev’t_‹¡
(*
ev’t
, 
ucc_“_ty³_t
 
“_ty³
)

150 
	`UCC_CHECK_EC_AVAILABLE
(
“_ty³
);

151  
ec_İs
[
“_ty³
]->
	`ev’t_‹¡
(
ev’t
);

152 
	}
}

154 
ucc_¡©us_t
 
	$ucc_“_executÜ_š™
(cÚ¡ 
ucc_“_executÜ_·¿ms_t
 *
·¿ms
,

155 
ucc_“_executÜ_t
 **
executÜ
)

157 
	`UCC_CHECK_EC_AVAILABLE
(
·¿ms
->
“_ty³
);

158  
executÜ_İs
[
·¿ms
->
“_ty³
]->
	`š™
Õ¬ams, 
executÜ
);

159 
	}
}

161 
ucc_¡©us_t
 
	$ucc_“_executÜ_¡©us
(cÚ¡ 
ucc_“_executÜ_t
 *
executÜ
)

163 
	`UCC_CHECK_EC_AVAILABLE
(
executÜ
->
“_ty³
);

164  
executÜ_İs
[
executÜ
->
“_ty³
]->
	`¡©us
(executor);

165 
	}
}

167 
ucc_¡©us_t
 
	$ucc_“_executÜ_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

168 *
“_cÚ‹xt
)

170 
	`UCC_CHECK_EC_AVAILABLE
(
executÜ
->
“_ty³
);

171  
executÜ_İs
[
executÜ
->
“_ty³
]->
	`¡¬t
ÓxecutÜ, 
“_cÚ‹xt
);

172 
	}
}

174 
ucc_¡©us_t
 
	$ucc_“_executÜ_¡İ
(
ucc_“_executÜ_t
 *
executÜ
)

176 
	`UCC_CHECK_EC_AVAILABLE
(
executÜ
->
“_ty³
);

177  
executÜ_İs
[
executÜ
->
“_ty³
]->
	`¡İ
(executor);

178 
	}
}

180 
ucc_¡©us_t
 
	$ucc_“_executÜ_fš®ize
(
ucc_“_executÜ_t
 *
executÜ
)

182 
	`UCC_CHECK_EC_AVAILABLE
(
executÜ
->
“_ty³
);

183  
executÜ_İs
[
executÜ
->
“_ty³
]->
	`fš®ize
(executor);

184 
	}
}

186 
ucc_¡©us_t
 
	$ucc_“_executÜ_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

187 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

188 
ucc_“_executÜ_sk_t
 **
sk
)

190 
	`UCC_CHECK_EC_AVAILABLE
(
executÜ
->
“_ty³
);

191  
executÜ_İs
[
executÜ
->
“_ty³
]->
	`sk_po¡
ÓxecutÜ, 
sk_¬gs
, 
sk
);

192 
	}
}

194 
ucc_¡©us_t
 
	$ucc_“_executÜ_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
)

196 
	`UCC_CHECK_EC_AVAILABLE
(
sk
->
“e
->
“_ty³
);

197  
executÜ_İs
[
sk
->
“e
->
“_ty³
]->
	`sk_‹¡
(task);

198 
	}
}

200 
ucc_¡©us_t
 
	$ucc_“_executÜ_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
)

202 
	`UCC_CHECK_EC_AVAILABLE
(
sk
->
“e
->
“_ty³
);

203  
executÜ_İs
[
sk
->
“e
->
“_ty³
]->
	`sk_fš®ize
(task);

204 
	}
}

	@src/components/ec/ucc_ec.h

6 #iâdeà
UCC_EC_H_


7 
	#UCC_EC_H_


	)

9 
	~"ucc/­i/ucc.h
"

10 
	~"compÚ’ts/ec/ba£/ucc_ec_ba£.h
"

12 
ucc_¡©us_t
 
ucc_ec_š™
(cÚ¡ 
ucc_ec_·¿ms_t
 *
ec_·¿ms
);

14 
ucc_¡©us_t
 
ucc_ec_avaabË
(
ucc_“_ty³_t
 
“_ty³
);

16 
ucc_¡©us_t
 
ucc_ec_g‘_©Œ
(
ucc_ec_©Œ_t
 *
©Œ
);

18 
ucc_¡©us_t
 
ucc_ec_fš®ize
();

20 
ucc_¡©us_t
 
ucc_ec_ü—‹_ev’t
(**
ev’t
, 
ucc_“_ty³_t
 
“_ty³
);

22 
ucc_¡©us_t
 
ucc_ec_de¡roy_ev’t
(*
ev’t
, 
ucc_“_ty³_t
 
“_ty³
);

24 
ucc_¡©us_t
 
ucc_ec_ev’t_po¡
(*
“_cÚ‹xt
, *
ev’t
,

25 
ucc_“_ty³_t
 
“_ty³
);

27 
ucc_¡©us_t
 
ucc_ec_ev’t_‹¡
(*
ev’t
, 
ucc_“_ty³_t
 
“_ty³
);

29 
ucc_¡©us_t
 
ucc_“_executÜ_š™
(cÚ¡ 
ucc_“_executÜ_·¿ms_t
 *
·¿ms
,

30 
ucc_“_executÜ_t
 **
executÜ
);

32 
ucc_¡©us_t
 
ucc_“_executÜ_¡©us
(cÚ¡ 
ucc_“_executÜ_t
 *
executÜ
);

34 
ucc_¡©us_t
 
ucc_“_executÜ_¡¬t
(
ucc_“_executÜ_t
 *
executÜ
,

35 *
“_cÚ‹xt
);

37 
ucc_¡©us_t
 
ucc_“_executÜ_¡İ
(
ucc_“_executÜ_t
 *
executÜ
);

39 
ucc_¡©us_t
 
ucc_“_executÜ_fš®ize
(
ucc_“_executÜ_t
 *
executÜ
);

41 
ucc_¡©us_t
 
ucc_“_executÜ_sk_po¡
(
ucc_“_executÜ_t
 *
executÜ
,

42 cÚ¡ 
ucc_“_executÜ_sk_¬gs_t
 *
sk_¬gs
,

43 
ucc_“_executÜ_sk_t
 **
sk
);

45 
ucc_¡©us_t
 
ucc_“_executÜ_sk_‹¡
(cÚ¡ 
ucc_“_executÜ_sk_t
 *
sk
);

47 
ucc_¡©us_t
 
ucc_“_executÜ_sk_fš®ize
(
ucc_“_executÜ_sk_t
 *
sk
);

	@src/components/ec/ucc_ec_log.h

7 #iâdeà
UCC_EC_LOG_H_


8 
	#UCC_EC_LOG_H_


	)

10 
	~"uts/ucc_log.h
"

12 
	#ucc_log_compÚ’t_ec
(
_ec
, 
_Ëv–
, 
fmt
, ...) \

13 
	`ucc_log_compÚ’t
(
_Ëv–
, ((
_ec
)->
cÚfig
)->
log_compÚ’t
, \

14 
fmt
, ##
__VA_ARGS__
)

	)

16 
	#ec_”rÜ
(
_ec
, 
_fmt
, ...) \

17 
	`ucc_log_compÚ’t_ec
(
_ec
, 
UCC_LOG_LEVEL_ERROR
, 
_fmt
, ##
__VA_ARGS__
)

	)

18 
	#ec_w¬n
(
_ec
, 
_fmt
, ...) \

19 
	`ucc_log_compÚ’t_ec
(
_ec
, 
UCC_LOG_LEVEL_WARN
, 
_fmt
, ##
__VA_ARGS__
)

	)

20 
	#ec_šfo
(
_ec
, 
_fmt
, ...) \

21 
	`ucc_log_compÚ’t_ec
(
_ec
, 
UCC_LOG_LEVEL_INFO
, 
_fmt
, ##
__VA_ARGS__
)

	)

22 
	#ec_debug
(
_ec
, 
_fmt
, ...) \

23 
	`ucc_log_compÚ’t_ec
(
_ec
, 
UCC_LOG_LEVEL_DEBUG
, 
_fmt
, ##
__VA_ARGS__
)

	)

24 
	#ec_Œaû
(
_ec
, 
_fmt
, ...) \

25 
	`ucc_log_compÚ’t_ec
(
_ec
, 
UCC_LOG_LEVEL_TRACE
, 
_fmt
, ##
__VA_ARGS__
)

	)

	@src/components/mc/base/ucc_mc_base.c

7 
	~"ucc_mc_ba£.h
"

8 
	~"uts/ucc_cŞl_uts.h
"

10 
ucc_cÚfig_f›ld_t
 
	gucc_mc_cÚfig_bË
[] = {

16 
ucc_off£tof
(
ucc_mc_cÚfig_t
, 
log_compÚ’t
), 
UCC_CONFIG_TYPE_LOG_COMP
},

18 {
NULL
}};

20 cÚ¡ *
	gucc_memÜy_ty³_Çmes
[] = {

21 [
UCC_MEMORY_TYPE_HOST
] = "host",

22 [
UCC_MEMORY_TYPE_CUDA
] = "cuda",

23 [
UCC_MEMORY_TYPE_CUDA_MANAGED
] = "cuda-managed",

24 [
UCC_MEMORY_TYPE_ROCM
] = "rocm",

25 [
UCC_MEMORY_TYPE_ROCM_MANAGED
] = "rocm-managed",

26 [
UCC_MEMORY_TYPE_LAST
] = "unknown",

27 [
UCC_MEMORY_TYPE_NOT_APPLY
] = "not_apply"};

30 cÚ¡ *
	gucc_“_ty³_Çmes
[] = {

31 [
UCC_EE_CUDA_STREAM
] = "cuda stream",

32 [
UCC_EE_CPU_THREAD
] = "cpuhread"};

	@src/components/mc/base/ucc_mc_base.h

7 #iâdeà
UCC_MC_BASE_H_


8 
	#UCC_MC_BASE_H_


	)

10 
	~"cÚfig.h
"

11 
	~"uts/ucc_compÚ’t.h
"

12 
	~"uts/ucc_şass.h
"

13 
	~"uts/ucc_·r£r.h
"

14 
	~"uts/ucc_mpoŞ.h
"

15 
	~"cÜe/ucc_glob®_İts.h
"

17 
	succ_mc_·¿ms
 {

18 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

19 } 
	tucc_mc_·¿ms_t
;

21 
	succ_mc_bufãr_h—d”
 {

22 
ucc_memÜy_ty³_t
 
	mmt
;

23 
	mäom_poŞ
;

24 *
	maddr
;

25 } 
	tucc_mc_bufãr_h—d”_t
;

30 
	eucc_mem_©Œ_f›ld
 {

31 
	mUCC_MEM_ATTR_FIELD_MEM_TYPE
 = 
UCC_BIT
(0),

33 
	mUCC_MEM_ATTR_FIELD_BASE_ADDRESS
 = 
UCC_BIT
(2),

35 
	mUCC_MEM_ATTR_FIELD_ALLOC_LENGTH
 = 
UCC_BIT
(3)

37 } 
	tucc_mem_©Œ_f›ld_t
;

40 
	succ_mem_©Œ
 {

45 
ušt64_t
 
	mf›ld_mask
;

50 
ucc_memÜy_ty³_t
 
	mmem_ty³
;

57 *
	mba£_add»ss
;

66 
size_t
 
	m®loc_Ëngth
;

68 } 
	tucc_mem_©Œ_t
;

73 
	eucc_mc_©Œ_f›ld
 {

74 
	mUCC_MC_ATTR_FIELD_THREAD_MODE
 = 
UCC_BIT
(0),

76 
	mUCC_MC_ATTR_FIELD_FAST_ALLOC_SIZE
 = 
UCC_BIT
(1),

77 } 
	tucc_mc_©Œ_f›ld_t
;

79 
	succ_mc_©Œ
 {

84 
ušt64_t
 
	mf›ld_mask
;

85 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

86 
size_t
 
	mç¡_®loc_size
;

87 } 
	tucc_mc_©Œ_t
;

92 cÚ¡ *
ucc_memÜy_ty³_Çmes
[];

97 cÚ¡ *
ucc_“_ty³_Çmes
[];

99 
	succ_mc_cÚfig
 {

100 
ucc_log_compÚ’t_cÚfig_t
 
	mlog_compÚ’t
;

101 } 
	tucc_mc_cÚfig_t
;

102 
ucc_cÚfig_f›ld_t
 
ucc_mc_cÚfig_bË
[];

104 
	succ_mc_İs
 {

105 
ucc_¡©us_t
 (*
mem_qu”y
)(cÚ¡ *
	m±r
, 
ucc_mem_©Œ_t
 *
	mmem_©Œ
);

106 
ucc_¡©us_t
 (*
mem_®loc
)(
ucc_mc_bufãr_h—d”_t
 **
	mh_±r
, 
size_t
 
	msize
,

107 
ucc_memÜy_ty³_t
 
	mmt
);

108 
ucc_¡©us_t
 (*
mem_ä“
)(
ucc_mc_bufãr_h—d”_t
 *
	mh_±r
);

109 
ucc_¡©us_t
 (*
memıy
)(*
	md¡
, cÚ¡ *
	m¤c
, 
size_t
 
	mËn
,

110 
ucc_memÜy_ty³_t
 
	md¡_mem
,

111 
ucc_memÜy_ty³_t
 
	m¤c_mem
);

112 
ucc_¡©us_t
 (*
mem£t
)(*
	md¡
, 
	mv®ue
, 
size_t
 
	mËn
);

113 
ucc_¡©us_t
 (*
æush
)();

114 } 
	tucc_mc_İs_t
;

116 
	succ_mc_ba£
 {

117 
ucc_compÚ’t_içû_t
 
	msu³r
;

118 
ušt32_t
 
	m»f_út
;

119 
ucc_“_ty³_t
 
	m“_ty³
;

120 
ucc_memÜy_ty³_t
 
	mty³
;

121 
ucc_mc_cÚfig_t
 *
	mcÚfig
;

122 
ucc_cÚfig_glob®_li¡_’Œy_t
 
	mcÚfig_bË
;

123 
ucc_¡©us_t
 (*
š™
)(cÚ¡ 
ucc_mc_·¿ms_t
 *
	mmc_·¿ms
);

124 
ucc_¡©us_t
 (*
g‘_©Œ
)(
ucc_mc_©Œ_t
 *
	mmc_©Œ
);

125 
ucc_¡©us_t
 (*
fš®ize
)();

126 
ucc_mc_İs_t
 
	mİs
;

127 } 
	tucc_mc_ba£_t
;

	@src/components/mc/cpu/mc_cpu.c

7 
	~"mc_ıu.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"uts/ucc_m©h.h
"

10 
	~"uts/¬ch/ıu.h
"

11 
	~<sys/ty³s.h
>

13 
ucc_cÚfig_f›ld_t
 
	gucc_mc_ıu_cÚfig_bË
[] = {

14 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_mc_ıu_cÚfig_t
, 
su³r
),

15 
UCC_CONFIG_TYPE_TABLE
(
ucc_mc_cÚfig_bË
)},

18 
ucc_off£tof
(
ucc_mc_ıu_cÚfig_t
, 
mpoŞ_–em_size
),

19 
UCC_CONFIG_TYPE_MEMUNITS
},

22 
ucc_off£tof
(
ucc_mc_ıu_cÚfig_t
, 
mpoŞ_max_–ems
), 
UCC_CONFIG_TYPE_UINT
},

24 {
NULL
}

28 
ucc_¡©us_t
 
	$ucc_mc_ıu_š™
(cÚ¡ 
ucc_mc_·¿ms_t
 *
mc_·¿ms
)

30 
	`ucc_¡ºıy_§ã
(
ucc_mc_ıu
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
,

31 
ucc_mc_ıu
.
su³r
.su³r.
Çme
,

32 (
ucc_mc_ıu
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
));

33 
ucc_mc_ıu
.
th»ad_mode
 = 
mc_·¿ms
->thread_mode;

36 
	`ucc_¥šlock_š™
(&
ucc_mc_ıu
.
mpoŞ_š™_¥šlock
, 0);

37  
UCC_OK
;

38 
	}
}

40 
ucc_¡©us_t
 
	$ucc_mc_ıu_g‘_©Œ
(
ucc_mc_©Œ_t
 *
mc_©Œ
)

42 ià(
mc_©Œ
->
f›ld_mask
 & 
UCC_MC_ATTR_FIELD_THREAD_MODE
) {

43 
mc_©Œ
->
th»ad_mode
 = 
ucc_mc_ıu
.thread_mode;

45  
UCC_OK
;

46 
	}
}

48 
ucc_¡©us_t
 
	$ucc_mc_ıu_mem_®loc
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
,

49 
size_t
 
size
,

50 
ucc_memÜy_ty³_t
 
mt
)

52 
size_t
 
size_w™h_h
 = 
size
 + (
ucc_mc_bufãr_h—d”_t
);

53 
ucc_mc_bufãr_h—d”_t
 *
h
 =

54 (
ucc_mc_bufãr_h—d”_t
 *)
	`ucc_m®loc
(
size_w™h_h
, "mc cpu");

55 ià(
	`ucc_uÆik–y
(!
h
)) {

56 
	`mc_”rÜ
(&
ucc_mc_ıu
.
su³r
, "failedo‡llocate %zd bytes",

57 
size_w™h_h
);

58  
UCC_ERR_NO_MEMORY
;

60 
h
->
äom_poŞ
 = 0;

61 
h
->
addr
 = 
	`PTR_OFFSET
(h, (
ucc_mc_bufãr_h—d”_t
));

62 
h
->
mt
 = mt;

63 *
h_±r
 = 
h
;

64 
	`mc_Œaû
(&
ucc_mc_ıu
.
su³r
, "®loÿ‹d %ld by‹ w™h ucc_m®loc", 
size
);

65  
UCC_OK
;

66 
	}
}

68 
ucc_¡©us_t
 
	$ucc_mc_ıu_mem_poŞ_®loc
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
,

69 
size_t
 
size
,

70 
ucc_memÜy_ty³_t
 
mt
)

72 
ucc_mc_bufãr_h—d”_t
 *
h
 = 
NULL
;

73 ià(
size
 <ğ
MC_CPU_CONFIG
->
mpoŞ_–em_size
) {

74 
h
 = (
ucc_mc_bufãr_h—d”_t
 *)
	`ucc_mpoŞ_g‘
(&
ucc_mc_ıu
.
mpoŞ
);

76 ià(!
h
) {

78  
	`ucc_mc_ıu_mem_®loc
(
h_±r
, 
size
, 
mt
);

80 
	`mc_Œaû
(&
ucc_mc_ıu
.
su³r
, "®loÿ‹d %ld by‹ äom cpu mpoŞ", 
size
);

81 *
h_±r
 = 
h
;

82  
UCC_OK
;

83 
	}
}

85 
ucc_¡©us_t
 
	$ucc_mc_ıu_chunk_®loc
(
ucc_mpoŞ_t
 *
mp
,

86 
size_t
 *
size_p
,

87 **
chunk_p
)

89 *
chunk_p
 = 
	`ucc_m®loc
(*
size_p
, "mc cpu");

90 ià(!*
chunk_p
) {

91 
	`mc_”rÜ
(&
ucc_mc_ıu
.
su³r
, "çedØ®loÿ‹ %zd by‹s", *
size_p
);

92  
UCC_ERR_NO_MEMORY
;

94  
UCC_OK
;

95 
	}
}

97 
	$ucc_mc_ıu_chunk_š™
(
ucc_mpoŞ_t
 *
mp
,

98 *
obj
, *
chunk
)

100 
ucc_mc_bufãr_h—d”_t
 *
h
 = (ucc_mc_bufãr_h—d”_ˆ*)
obj
;

101 
h
->
äom_poŞ
 = 1;

102 
h
->
addr
 = 
	`PTR_OFFSET
(h, (
ucc_mc_bufãr_h—d”_t
));

103 
h
->
mt
 = 
UCC_MEMORY_TYPE_HOST
;

104 
	}
}

106 
	$ucc_mc_ıu_chunk_»Ëa£
(
ucc_mpoŞ_t
 *
mp
, *
chunk
)

108 
	`ucc_ä“
(
chunk
);

109 
	}
}

111 
ucc_mpoŞ_İs_t
 
	gucc_mc_İs
 = {.
chunk_®loc
 = 
ucc_mc_ıu_chunk_®loc
,

112 .
	gchunk_»Ëa£
 = 
ucc_mc_ıu_chunk_»Ëa£
,

113 .
	gobj_š™
 = 
ucc_mc_ıu_chunk_š™
,

114 .
	gobj_ş—nup
 = 
NULL
};

116 
ucc_¡©us_t
 
	$ucc_mc_ıu_mem_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
)

118 
	`ucc_ä“
(
h_±r
);

119  
UCC_OK
;

120 
	}
}

122 
ucc_¡©us_t
 
	$ucc_mc_ıu_mem_poŞ_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
)

124 ià(!
h_±r
->
äom_poŞ
) {

125  
	`ucc_mc_ıu_mem_ä“
(
h_±r
);

127 
	`ucc_mpoŞ_put
(
h_±r
);

128  
UCC_OK
;

129 
	}
}

131 
ucc_¡©us_t


132 
	$ucc_mc_ıu_mem_poŞ_®loc_w™h_š™
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
,

133 
size_t
 
size
,

134 
ucc_memÜy_ty³_t
 
mt
)

138 
	`ucc_¥š_lock
(&
ucc_mc_ıu
.
mpoŞ_š™_¥šlock
);

140 ià(
MC_CPU_CONFIG
->
mpoŞ_max_–ems
 == 0) {

141 
ucc_mc_ıu
.
su³r
.
İs
.
mem_®loc
 = 
ucc_mc_ıu_mem_®loc
;

142 
ucc_mc_ıu
.
su³r
.
İs
.
mem_ä“
 = 
ucc_mc_ıu_mem_ä“
;

143 
	`ucc_¥š_uÆock
(&
ucc_mc_ıu
.
mpoŞ_š™_¥šlock
);

144  
	`ucc_mc_ıu_mem_®loc
(
h_±r
, 
size
, 
mt
);

147 ià(!
ucc_mc_ıu
.
mpoŞ_š™_æag
) {

148 
ucc_¡©us_t
 
¡©us
 = 
	`ucc_mpoŞ_š™
(

149 &
ucc_mc_ıu
.
mpoŞ
, 0,

150 (
ucc_mc_bufãr_h—d”_t
è+ 
MC_CPU_CONFIG
->
mpoŞ_–em_size
, 0,

151 
UCC_CACHE_LINE_SIZE
, 1, 
MC_CPU_CONFIG
->
mpoŞ_max_–ems
, &
ucc_mc_İs
,

152 
ucc_mc_ıu
.
th»ad_mode
, "mc cpu mpool buffers");

153 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

154 
	`ucc_¥š_uÆock
(&
ucc_mc_ıu
.
mpoŞ_š™_¥šlock
);

155  
¡©us
;

157 
ucc_mc_ıu
.
su³r
.
İs
.
mem_®loc
 = 
ucc_mc_ıu_mem_poŞ_®loc
;

158 
ucc_mc_ıu
.
mpoŞ_š™_æag
 = 1;

160 
	`ucc_¥š_uÆock
(&
ucc_mc_ıu
.
mpoŞ_š™_¥šlock
);

161  
	`ucc_mc_ıu_mem_poŞ_®loc
(
h_±r
, 
size
, 
mt
);

162 
	}
}

164 
ucc_¡©us_t
 
	$ucc_mc_ıu_memıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
Ën
,

165 
ucc_memÜy_ty³_t
 
d¡_mem
,

166 
ucc_memÜy_ty³_t
 
¤c_mem
)

168 
	`ucc_as£¹
((
d¡_mem
 =ğ
UCC_MEMORY_TYPE_HOST
) &&

169 (
¤c_mem
 =ğ
UCC_MEMORY_TYPE_HOST
));

170 
	`memıy
(
d¡
, 
¤c
, 
Ën
);

171  
UCC_OK
;

172 
	}
}

174 
ucc_¡©us_t
 
	$ucc_mc_ıu_mem£t
(*
±r
, 
v®ue
, 
size_t
 
Ën
)

176 
	`mem£t
(
±r
, 
v®ue
, 
Ën
);

177  
UCC_OK
;

178 
	}
}

180 
ucc_¡©us_t
 
	$ucc_mc_ıu_mem_qu”y
(cÚ¡ *
±r
,

181 
ucc_mem_©Œ_t
 *
mem_©Œ
)

184 
	`mc_”rÜ
(&
ucc_mc_ıu
.
su³r
, "host memory component shouldn't be used for"

186  
UCC_ERR_NOT_SUPPORTED
;

187 
	}
}

189 
ucc_¡©us_t
 
	$ucc_mc_ıu_fš®ize
()

191 ià(
ucc_mc_ıu
.
mpoŞ_š™_æag
) {

192 
	`ucc_mpoŞ_ş—nup
(&
ucc_mc_ıu
.
mpoŞ
, 1);

193 
ucc_mc_ıu
.
mpoŞ_š™_æag
 = 0;

194 
ucc_mc_ıu
.
su³r
.
İs
.
mem_®loc
 = 
ucc_mc_ıu_mem_poŞ_®loc_w™h_š™
;

196 
	`ucc_¥šlock_de¡roy
(&
ucc_mc_ıu
.
mpoŞ_š™_¥šlock
);

197  
UCC_OK
;

198 
	}
}

200 
ucc_mc_ıu_t
 
	gucc_mc_ıu
 = {

201 .
su³r
.su³r.
Çme
 = "cpu mc",

202 .
	gsu³r
.
	g»f_út
 = 0,

203 .
	gsu³r
.
	gty³
 = 
UCC_MEMORY_TYPE_HOST
,

204 .
	gsu³r
.
	g“_ty³
 = 
UCC_EE_CPU_THREAD
,

205 .
	gsu³r
.
	gš™
 = 
ucc_mc_ıu_š™
,

206 .
	gsu³r
.
	gg‘_©Œ
 = 
ucc_mc_ıu_g‘_©Œ
,

207 .
	gsu³r
.
	gfš®ize
 = 
ucc_mc_ıu_fš®ize
,

208 .
	gsu³r
.
	gİs
.
	gmem_qu”y
 = 
ucc_mc_ıu_mem_qu”y
,

209 .
	gsu³r
.
	gİs
.
	gmem_®loc
 = 
ucc_mc_ıu_mem_poŞ_®loc_w™h_š™
,

210 .
	gsu³r
.
	gİs
.
	gmem_ä“
 = 
ucc_mc_ıu_mem_poŞ_ä“
,

211 .
	gsu³r
.
	gİs
.
	gmemıy
 = 
ucc_mc_ıu_memıy
,

212 .
	gsu³r
.
	gİs
.
	gmem£t
 = 
ucc_mc_ıu_mem£t
,

213 .
	gsu³r
.
	gİs
.
	gæush
 = 
NULL
,

214 .
	gsu³r
.
	gcÚfig_bË
 =

216 .
Çme
 = "CPU memory component",

217 .
	g´efix
 = "MC_CPU_",

218 .
	gbË
 = 
ucc_mc_ıu_cÚfig_bË
,

219 .
	gsize
 = (
ucc_mc_ıu_cÚfig_t
),

221 .
	gmpoŞ_š™_æag
 = 0,

224 
UCC_CONFIG_REGISTER_TABLE_ENTRY
(&
ucc_mc_ıu
.
su³r
.
cÚfig_bË
,

225 &
ucc_cÚfig_glob®_li¡
);

	@src/components/mc/cpu/mc_cpu.h

7 #iâdeà
UCC_MC_CPU_H_


8 
	#UCC_MC_CPU_H_


	)

10 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

11 
	~"compÚ’ts/mc/ucc_mc_log.h
"

13 
	succ_mc_ıu_cÚfig
 {

14 
ucc_mc_cÚfig_t
 
	msu³r
;

15 
size_t
 
	mmpoŞ_–em_size
;

16 
	mmpoŞ_max_–ems
;

17 } 
	tucc_mc_ıu_cÚfig_t
;

19 
	succ_mc_ıu
 {

20 
ucc_mc_ba£_t
 
	msu³r
;

21 
ucc_mpoŞ_t
 
	mmpoŞ
;

22 
	mmpoŞ_š™_æag
;

23 
ucc_¥šlock_t
 
	mmpoŞ_š™_¥šlock
;

24 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

25 } 
	tucc_mc_ıu_t
;

27 
ucc_mc_ıu_t
 
ucc_mc_ıu
;

28 
	#MC_CPU_CONFIG
 \

29 (
	`ucc_d”ived_of
(
ucc_mc_ıu
.
su³r
.
cÚfig
, 
ucc_mc_ıu_cÚfig_t
))

	)

	@src/components/mc/cuda/mc_cuda.c

7 
	~"mc_cuda.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"uts/¬ch/ıu.h
"

10 
	~<cuda_ruÁime.h
>

11 
	~<cuda.h
>

13 
ucc_cÚfig_f›ld_t
 
	gucc_mc_cuda_cÚfig_bË
[] = {

14 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_mc_cuda_cÚfig_t
, 
su³r
),

15 
UCC_CONFIG_TYPE_TABLE
(
ucc_mc_cÚfig_bË
)},

18 
ucc_off£tof
(
ucc_mc_cuda_cÚfig_t
, 
mpoŞ_–em_size
),

19 
UCC_CONFIG_TYPE_MEMUNITS
},

22 
ucc_off£tof
(
ucc_mc_cuda_cÚfig_t
, 
mpoŞ_max_–ems
), 
UCC_CONFIG_TYPE_UINT
},

24 {
NULL
}

28 
ucc_¡©us_t
 
	$ucc_mc_cuda_æush_nÙ_suµÜ‹d
()

30 
	`mc_”rÜ
(&
ucc_mc_cuda
.
su³r
, "consistency‡pi is‚ot supported");

31  
UCC_ERR_NOT_SUPPORTED
;

32 
	}
}

34 #ià
CUDA_VERSION
 >= 11030

35 
ucc_¡©us_t
 
	$ucc_mc_cuda_æush_no_İ
()

37  
UCC_OK
;

38 
	}
}

40 
ucc_¡©us_t
 
	$ucc_mc_cuda_æush_to_owÃr
()

42 
	`CUDADRV_FUNC
(
	`cuFlushGPUDœeùRDMAWr™es
(
CU_FLUSH_GPU_DIRECT_RDMA_WRITES_TARGET_CURRENT_CTX
,

43 
CU_FLUSH_GPU_DIRECT_RDMA_WRITES_TO_OWNER
));

44  
UCC_OK
;

45 
	}
}

48 
ucc_¡©us_t
 
	$ucc_mc_cuda_š™
(cÚ¡ 
ucc_mc_·¿ms_t
 *
mc_·¿ms
)

50 
num_deviûs
, 
driv”_v”
;

51 
cudaE¼Ü_t
 
cuda_¡
;

53 
ucc_mc_cuda_cÚfig
 = 
	`ucc_d”ived_of
(
ucc_mc_cuda
.
su³r
.
cÚfig
,

54 
ucc_mc_cuda_cÚfig_t
);

55 
	`ucc_¡ºıy_§ã
(
ucc_mc_cuda
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
,

56 
ucc_mc_cuda
.
su³r
.su³r.
Çme
,

57 (
ucc_mc_cuda
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
));

58 
ucc_mc_cuda
.
th»ad_mode
 = 
mc_·¿ms
->thread_mode;

59 
cuda_¡
 = 
	`cudaG‘DeviûCouÁ
(&
num_deviûs
);

60 ià((
cuda_¡
 !ğ
cudaSucûss
è|| (
num_deviûs
 == 0)) {

61 
	`mc_debug
(&
ucc_mc_cuda
.
su³r
, "cuda devices‡re‚ot found");

62  
UCC_ERR_NO_RESOURCE
;

64 
	`CUDADRV_FUNC
(
	`cuDriv”G‘V”siÚ
(&
driv”_v”
));

65 
	`mc_debug
(&
ucc_mc_cuda
.
su³r
, "driv” v”siÚ %d", 
driv”_v”
);

67 #ià
CUDA_VERSION
 >= 11030

68 ià(
driv”_v”
 >= 11030) {

69 
CUdeviû
 
cu_dev
;

70 
CU»suÉ
 
cu_¡
;

71 
©Œ
;

72 cÚ¡ *
cu_”r_¡_¡r
;

74 
cu_¡
 = 
	`cuCtxG‘Deviû
(&
cu_dev
);

75 ià(
cu_¡
 !ğ
CUDA_SUCCESS
){

76 
	`cuG‘E¼ÜSŒšg
(
cu_¡
, &
cu_”r_¡_¡r
);

77 
	`mc_debug
(&
ucc_mc_cuda
.
su³r
, "cuCtxGetDevice() failed: %s",

78 
cu_”r_¡_¡r
);

80 
©Œ
 = 0;

81 
	`CUDADRV_FUNC
(
	`cuDeviûG‘A‰ribu‹
(&
©Œ
,

82 
CU_DEVICE_ATTRIBUTE_GPU_DIRECT_RDMA_FLUSH_WRITES_OPTIONS
,

83 
cu_dev
));

84 ià(
©Œ
 & 
CU_FLUSH_GPU_DIRECT_RDMA_WRITES_OPTION_HOST
) {

85 
	`CUDADRV_FUNC
(
	`cuDeviûG‘A‰ribu‹
(&
©Œ
,

86 
CU_DEVICE_ATTRIBUTE_GPU_DIRECT_RDMA_WRITES_ORDERING
,

87 
cu_dev
));

88 ià(
CU_FLUSH_GPU_DIRECT_RDMA_WRITES_TO_OWNER
 > 
©Œ
) {

89 
ucc_mc_cuda
.
su³r
.
İs
.
æush
 = 
ucc_mc_cuda_æush_to_owÃr
;

91 
ucc_mc_cuda
.
su³r
.
İs
.
æush
 = 
ucc_mc_cuda_æush_no_İ
;

94 
	`mc_debug
(&
ucc_mc_cuda
.
su³r
, "consistency‡pi is‚ot supported");

98 
	`mc_debug
(&
ucc_mc_cuda
.
su³r
,

100 "w™h driv” v”siÚ %d", 
driv”_v”
);

103 
ucc_mc_cuda
.
»sourûs_hash
 = 
	`kh_š™
(
ucc_mc_cuda_»sourûs_hash
);

106 
	`ucc_¥šlock_š™
(&
ucc_mc_cuda
.
š™_¥šlock
, 0);

108  
UCC_OK
;

109 
	}
}

111 
ucc_¡©us_t
 
	$ucc_mc_cuda_g‘_©Œ
(
ucc_mc_©Œ_t
 *
mc_©Œ
)

113 ià(
mc_©Œ
->
f›ld_mask
 & 
UCC_MC_ATTR_FIELD_THREAD_MODE
) {

114 
mc_©Œ
->
th»ad_mode
 = 
ucc_mc_cuda
.thread_mode;

116 ià(
mc_©Œ
->
f›ld_mask
 & 
UCC_MC_ATTR_FIELD_FAST_ALLOC_SIZE
) {

117 ià(
MC_CUDA_CONFIG
->
mpoŞ_max_–ems
 > 0) {

118 
mc_©Œ
->
ç¡_®loc_size
 = 
MC_CUDA_CONFIG
->
mpoŞ_–em_size
;

120 
mc_©Œ
->
ç¡_®loc_size
 = 0;

123  
UCC_OK
;

124 
	}
}

126 
ucc_¡©us_t
 
	$ucc_mc_cuda_mem_®loc
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
,

127 
size_t
 
size
,

128 
ucc_memÜy_ty³_t
 
mt
)

130 
cudaE¼Ü_t
 
¡
;

131 
ucc_mc_bufãr_h—d”_t
 *
h
;

133 
h
 = 
	`ucc_m®loc
((
ucc_mc_bufãr_h—d”_t
), "mc cuda");

134 ià(
	`ucc_uÆik–y
(!
h
)) {

135 
	`mc_”rÜ
(&
ucc_mc_cuda
.
su³r
, "failedo‡llocate %zd bytes",

136 (
ucc_mc_bufãr_h—d”_t
));

137  
UCC_ERR_NO_MEMORY
;

139 
¡
 = (
mt
 =ğ
UCC_MEMORY_TYPE_CUDA
è? 
	`cudaM®loc
(&
h
->
addr
, 
size
) :

140 
	`cudaM®locMªaged
(&
h
->
addr
, 
size
,

141 
cudaMemA‰achGlob®
);

142 ià(
	`ucc_uÆik–y
(
¡
 !ğ
cudaSucûss
)) {

143 
	`cudaG‘La¡E¼Ü
();

144 
	`mc_”rÜ
(&
ucc_mc_cuda
.
su³r
, "failedo‡llocate %zd bytes, "

146 
size
, 
¡
, 
	`cudaG‘E¼ÜSŒšg
(st));

147 
	`ucc_ä“
(
h
);

148  
UCC_ERR_NO_MEMORY
;

151 
h
->
äom_poŞ
 = 0;

152 
h
->
mt
 = 
UCC_MEMORY_TYPE_CUDA
;

153 *
h_±r
 = 
h
;

154 
	`mc_Œaû
(&
ucc_mc_cuda
.
su³r
, "®loÿ‹d %ld by‹ w™h %s", 
size
,

155 
ucc_memÜy_ty³_Çmes
[
mt
]);

156  
UCC_OK
;

157 
	}
}

159 
ucc_¡©us_t
 
	$ucc_mc_cuda_mem_poŞ_®loc
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
,

160 
size_t
 
size
,

161 
ucc_memÜy_ty³_t
 
mt
)

163 
ucc_mc_bufãr_h—d”_t
 *
h
 = 
NULL
;

164 
ucc_mc_cuda_»sourûs_t
 *
»sourûs
;

165 
ucc_¡©us_t
 
¡©us
;

167 ià((
size
 <ğ
MC_CUDA_CONFIG
->
mpoŞ_–em_size
) &&

168 (
mt
 !ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
)) {

169 
¡©us
 = 
	`ucc_mc_cuda_g‘_»sourûs
(&
»sourûs
);

170 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

171  
¡©us
;

174 
h
 = (
ucc_mc_bufãr_h—d”_t
 *)
	`ucc_mpoŞ_g‘
(&
»sourûs
->
sü©ch_mpoŞ
);

177 ià(!
h
) {

179  
	`ucc_mc_cuda_mem_®loc
(
h_±r
, 
size
, 
mt
);

182 ià(
	`ucc_uÆik–y
(!
h
->
addr
)){

183  
UCC_ERR_NO_MEMORY
;

185 *
h_±r
 = 
h
;

186 
	`mc_Œaû
(&
ucc_mc_cuda
.
su³r
, "®loÿ‹d %ld by‹ äom cud¨mpoŞ", 
size
);

187  
UCC_OK
;

188 
	}
}

190 
ucc_¡©us_t
 
	$ucc_mc_cuda_mem_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
)

192 
cudaE¼Ü_t
 
¡
;

193 
¡
 = 
	`cudaF»e
(
h_±r
->
addr
);

194 ià(
	`ucc_uÆik–y
(
¡
 !ğ
cudaSucûss
)) {

195 
	`cudaG‘La¡E¼Ü
();

196 
	`mc_”rÜ
(&
ucc_mc_cuda
.
su³r
,

199 
h_±r
, 
¡
, 
	`cudaG‘E¼ÜSŒšg
(st));

200  
UCC_ERR_NO_MESSAGE
;

202 
	`ucc_ä“
(
h_±r
);

203  
UCC_OK
;

204 
	}
}

206 
ucc_¡©us_t
 
	$ucc_mc_cuda_mem_poŞ_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
)

208 ià(!
h_±r
->
äom_poŞ
) {

209  
	`ucc_mc_cuda_mem_ä“
(
h_±r
);

211 
	`ucc_mpoŞ_put
(
h_±r
);

212  
UCC_OK
;

213 
	}
}

215 
ucc_¡©us_t


216 
	$ucc_mc_cuda_mem_poŞ_®loc_w™h_š™
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
,

217 
size_t
 
size
,

218 
ucc_memÜy_ty³_t
 
mt
)

220 ià(
MC_CUDA_CONFIG
->
mpoŞ_max_–ems
 == 0) {

221 
ucc_mc_cuda
.
su³r
.
İs
.
mem_®loc
 = 
ucc_mc_cuda_mem_®loc
;

222 
ucc_mc_cuda
.
su³r
.
İs
.
mem_ä“
 = 
ucc_mc_cuda_mem_ä“
;

223  
	`ucc_mc_cuda_mem_®loc
(
h_±r
, 
size
, 
mt
);

225 
ucc_mc_cuda
.
su³r
.
İs
.
mem_®loc
 = 
ucc_mc_cuda_mem_poŞ_®loc
;

226 
ucc_mc_cuda
.
su³r
.
İs
.
mem_ä“
 = 
ucc_mc_cuda_mem_poŞ_ä“
;

227  
	`ucc_mc_cuda_mem_poŞ_®loc
(
h_±r
, 
size
, 
mt
);

229 
	}
}

231 
ucc_¡©us_t
 
	$ucc_mc_cuda_memıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
Ën
,

232 
ucc_memÜy_ty³_t
 
d¡_mem
,

233 
ucc_memÜy_ty³_t
 
¤c_mem
)

235 
ucc_¡©us_t
 
¡©us
;

236 
ucc_mc_cuda_»sourûs_t
 *
»sourûs
;

238 
	`ucc_as£¹
(
d¡_mem
 =ğ
UCC_MEMORY_TYPE_CUDA
 ||

239 
¤c_mem
 =ğ
UCC_MEMORY_TYPE_CUDA
 ||

240 
d¡_mem
 =ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
 ||

241 
¤c_mem
 =ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
);

243 
¡©us
 = 
	`ucc_mc_cuda_g‘_»sourûs
(&
»sourûs
);

244 ià(
	`ucc_uÆik–y
(
¡©us
è!ğ
UCC_OK
) {

245  
¡©us
;

248 
¡©us
 = 
	`CUDA_FUNC
(
	`cudaMemıyAsync
(
d¡
, 
¤c
, 
Ën
, 
cudaMemıyDeçuÉ
,

249 
»sourûs
->
¡»am
));

250 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

251 
	`mc_”rÜ
(&
ucc_mc_cuda
.
su³r
,

253 
d¡
, 
¤c
, 
Ën
);

254  
¡©us
;

257 
¡©us
 = 
	`CUDA_FUNC
(
	`cudaSŒ—mSynchrÚize
(
»sourûs
->
¡»am
));

259  
¡©us
;

260 
	}
}

262 
ucc_¡©us_t
 
	$ucc_mc_cuda_mem£t
(*
±r
, 
v®
, 
size_t
 
Ën
)

264 
ucc_¡©us_t
 
¡©us
;

265 
ucc_mc_cuda_»sourûs_t
 *
»sourûs
;

267 
¡©us
 = 
	`ucc_mc_cuda_g‘_»sourûs
(&
»sourûs
);

268 ià(
	`ucc_uÆik–y
(
¡©us
è!ğ
UCC_OK
) {

269  
¡©us
;

272 
¡©us
 = 
	`CUDA_FUNC
(
	`cudaMem£tAsync
(
±r
, 
v®
, 
Ën
, 
»sourûs
->
¡»am
));

273 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

274 
	`mc_”rÜ
(&
ucc_mc_cuda
.
su³r
,

276 
±r
, 
Ën
);

277  
¡©us
;

280 
¡©us
 = 
	`CUDA_FUNC
(
	`cudaSŒ—mSynchrÚize
(
»sourûs
->
¡»am
));

282  
¡©us
;

283 
	}
}

285 
ucc_¡©us_t
 
	$ucc_mc_cuda_mem_qu”y
(cÚ¡ *
±r
,

286 
ucc_mem_©Œ_t
 *
mem_©Œ
)

288 
cudaPoš‹rA‰ribu‹s
 
©Œ
;

289 
cudaE¼Ü_t
 
¡
;

290 
CU»suÉ
 
cu_”r
;

291 
ucc_memÜy_ty³_t
 
mem_ty³
;

292 *
ba£_add»ss
;

293 
size_t
 
®loc_Ëngth
;

295 ià(!(
mem_©Œ
->
f›ld_mask
 & (
UCC_MEM_ATTR_FIELD_MEM_TYPE
 |

296 
UCC_MEM_ATTR_FIELD_BASE_ADDRESS
 |

297 
UCC_MEM_ATTR_FIELD_ALLOC_LENGTH
))) {

298  
UCC_OK
;

301 ià(
mem_©Œ
->
f›ld_mask
 & 
UCC_MEM_ATTR_FIELD_MEM_TYPE
) {

302 
¡
 = 
	`cudaPoš‹rG‘A‰ribu‹s
(&
©Œ
, 
±r
);

303 ià(
¡
 !ğ
cudaSucûss
) {

304 
	`cudaG‘La¡E¼Ü
();

305  
UCC_ERR_NOT_SUPPORTED
;

307 #ià
CUDART_VERSION
 >= 10000

308 
©Œ
.
ty³
) {

309 
cudaMemÜyTy³Ho¡
:

310 
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

312 
cudaMemÜyTy³Deviû
:

313 
mem_ty³
 = 
UCC_MEMORY_TYPE_CUDA
;

315 
cudaMemÜyTy³Mªaged
:

316 
mem_ty³
 = 
UCC_MEMORY_TYPE_CUDA_MANAGED
;

319  
UCC_ERR_NOT_SUPPORTED
;

322 ià(
©Œ
.
memÜyTy³
 =ğ
cudaMemÜyTy³Deviû
) {

323 ià(
©Œ
.
isMªaged
) {

324 
mem_ty³
 = 
UCC_MEMORY_TYPE_CUDA_MANAGED
;

326 
mem_ty³
 = 
UCC_MEMORY_TYPE_CUDA
;

328 } ià(
©Œ
.
memÜyTy³
 =ğ
cudaMemÜyTy³Ho¡
) {

329 
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

331  
UCC_ERR_NOT_SUPPORTED
;

334 
mem_©Œ
->
mem_ty³
 = mem_type;

337 ià(
mem_©Œ
->
f›ld_mask
 & (
UCC_MEM_ATTR_FIELD_ALLOC_LENGTH
 |

338 
UCC_MEM_ATTR_FIELD_BASE_ADDRESS
)) {

339 
cu_”r
 = 
	`cuMemG‘Add»ssRªge
((
CUdeviû±r
*)&
ba£_add»ss
,

340 &
®loc_Ëngth
, (
CUdeviû±r
)
±r
);

341 ià(
cu_”r
 !ğ
CUDA_SUCCESS
) {

342 
	`mc_debug
(&
ucc_mc_cuda
.
su³r
,

343 "cuMemG‘Add»ssRªge(%pè”rÜ: %d", 
±r
, 
cu_”r
);

344  
UCC_ERR_NOT_SUPPORTED
;

347 
mem_©Œ
->
ba£_add»ss
 = base_address;

348 
mem_©Œ
->
®loc_Ëngth
 =‡lloc_length;

351  
UCC_OK
;

352 
	}
}

354 
ucc_¡©us_t
 
	$ucc_mc_cuda_g‘_»sourûs
(
ucc_mc_cuda_»sourûs_t
 **
»sourûs
)

356 
CUcÚ‹xt
 
cu_ùx
;

357 
cu_ùx_id
;

358 
ucc_¡©us_t
 
¡©us
;

360 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuCtxG‘Cu¼’t
(&
cu_ùx
));

361 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

362 
	`mc_”rÜ
(&
ucc_mc_cuda
.
su³r
, "failedo get current CUDA context");

363  
¡©us
;

366 #ià
CUDA_VERSION
 < 12000

367 
cu_ùx_id
 = 1;

369 
CU»suÉ
 
cu_¡©us
;

370 
cu_¡©us
 = 
	`cuCtxG‘Id
(
cu_ùx
, &
cu_ùx_id
);

371 ià(
	`ucc_uÆik–y
(
cu_¡©us
 !ğ
CUDA_SUCCESS
)) {

374 
cu_ùx_id
 = 0x12345;

375 
	`mc_debug
(&
ucc_mc_cuda
.
su³r
,

376 "çedØg‘ cu¼’ˆCUDA cÚ‹xˆID (%d)", 
cu_¡©us
);

380 *
»sourûs
 = 
	`mc_cuda_»sourûs_hash_g‘
(
ucc_mc_cuda
.
»sourûs_hash
,

381 
cu_ùx_id
);

382 ià(
	`ucc_uÆik–y
(*
»sourûs
 =ğ
NULL
)) {

383 
	`ucc_¥š_lock
(&
ucc_mc_cuda
.
š™_¥šlock
);

384 *
»sourûs
 = 
	`mc_cuda_»sourûs_hash_g‘
(
ucc_mc_cuda
.
»sourûs_hash
,

385 
cu_ùx_id
);

386 ià(*
»sourûs
 =ğ
NULL
) {

387 *
»sourûs
 = 
	`ucc_m®loc
((
ucc_mc_cuda_»sourûs_t
),

389 ià(*
»sourûs
 =ğ
NULL
) {

390 
	`mc_”rÜ
(&
ucc_mc_cuda
.
su³r
,

392 (
ucc_mc_cuda_»sourûs_t
));

393 
	`ucc_¥š_uÆock
(&
ucc_mc_cuda
.
š™_¥šlock
);

394  
UCC_ERR_NO_MEMORY
;

396 
¡©us
 = 
	`ucc_mc_cuda_»sourûs_š™
(&
ucc_mc_cuda
.
su³r
,

397 *
»sourûs
);

398 ià(
¡©us
 !ğ
UCC_OK
) {

399 
	`ucc_ä“
(*
»sourûs
);

400 
	`ucc_¥š_uÆock
(&
ucc_mc_cuda
.
š™_¥šlock
);

401  
¡©us
;

403 
	`mc_cuda_»sourûs_hash_put
(
ucc_mc_cuda
.
»sourûs_hash
, 
cu_ùx_id
,

404 *
»sourûs
);

406 
	`ucc_¥š_uÆock
(&
ucc_mc_cuda
.
š™_¥šlock
);

408  
UCC_OK
;

409 
	}
}

411 
ucc_¡©us_t
 
	$ucc_mc_cuda_fš®ize
()

413 
ucc_mc_cuda_»sourûs_t
 *
»sourûs
;

415 
»sourûs
 = 
	`mc_cuda_»sourûs_hash_pİ
(
ucc_mc_cuda
.
»sourûs_hash
);

416 
»sourûs
) {

417 
	`ucc_mc_cuda_»sourûs_ş—nup
(
»sourûs
);

418 
»sourûs
 = 
	`mc_cuda_»sourûs_hash_pİ
(
ucc_mc_cuda
.
»sourûs_hash
);

421 
ucc_mc_cuda
.
su³r
.
İs
.
mem_®loc
 = 
ucc_mc_cuda_mem_poŞ_®loc_w™h_š™
;

422 
	`ucc_¥šlock_de¡roy
(&
ucc_mc_cuda
.
š™_¥šlock
);

423  
UCC_OK
;

424 
	}
}

426 
ucc_mc_cuda_t
 
	gucc_mc_cuda
 = {

427 .
su³r
.su³r.
Çme
 = "cuda mc",

428 .
	gsu³r
.
	g»f_út
 = 0,

429 .
	gsu³r
.
	g“_ty³
 = 
UCC_EE_CUDA_STREAM
,

430 .
	gsu³r
.
	gty³
 = 
UCC_MEMORY_TYPE_CUDA
,

431 .
	gsu³r
.
	gš™
 = 
ucc_mc_cuda_š™
,

432 .
	gsu³r
.
	gg‘_©Œ
 = 
ucc_mc_cuda_g‘_©Œ
,

433 .
	gsu³r
.
	gfš®ize
 = 
ucc_mc_cuda_fš®ize
,

434 .
	gsu³r
.
	gİs
.
	gmem_qu”y
 = 
ucc_mc_cuda_mem_qu”y
,

435 .
	gsu³r
.
	gİs
.
	gmem_®loc
 = 
ucc_mc_cuda_mem_poŞ_®loc_w™h_š™
,

436 .
	gsu³r
.
	gİs
.
	gmem_ä“
 = 
ucc_mc_cuda_mem_poŞ_ä“
,

437 .
	gsu³r
.
	gİs
.
	gmemıy
 = 
ucc_mc_cuda_memıy
,

438 .
	gsu³r
.
	gİs
.
	gmem£t
 = 
ucc_mc_cuda_mem£t
,

439 .
	gsu³r
.
	gİs
.
	gæush
 = 
ucc_mc_cuda_æush_nÙ_suµÜ‹d
,

440 .
	gsu³r
.
	gcÚfig_bË
 =

442 .
Çme
 = "CUDA memory component",

443 .
	g´efix
 = "MC_CUDA_",

444 .
	gbË
 = 
ucc_mc_cuda_cÚfig_bË
,

445 .
	gsize
 = (
ucc_mc_cuda_cÚfig_t
),

449 
ucc_mc_cuda_cÚfig_t
 *
	gucc_mc_cuda_cÚfig
;

451 
UCC_CONFIG_REGISTER_TABLE_ENTRY
(&
ucc_mc_cuda
.
su³r
.
cÚfig_bË
,

452 &
ucc_cÚfig_glob®_li¡
);

	@src/components/mc/cuda/mc_cuda.h

7 #iâdeà
UCC_MC_CUDA_H_


8 
	#UCC_MC_CUDA_H_


	)

10 
	~<cuda_ruÁime.h
>

11 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

12 
	~"compÚ’ts/mc/ucc_mc_log.h
"

13 
	~"uts/ucc_mpoŞ.h
"

14 
	~"uts/¬ch/cuda_def.h
"

15 
	~"mc_cuda_»sourûs.h
"

17 
	succ_mc_cuda
 {

18 
ucc_mc_ba£_t
 
	msu³r
;

19 
ucc_¥šlock_t
 
	mš™_¥šlock
;

20 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

21 
ucc_mc_cuda_»sourûs_hash_t
 *
	m»sourûs_hash
;

22 } 
	tucc_mc_cuda_t
;

24 
ucc_mc_cuda_t
 
ucc_mc_cuda
;

26 
	#MC_CUDA_CONFIG
 \

27 (
	`ucc_d”ived_of
(
ucc_mc_cuda
.
su³r
.
cÚfig
, 
ucc_mc_cuda_cÚfig_t
))

	)

29 
ucc_¡©us_t
 
ucc_mc_cuda_g‘_»sourûs
(
ucc_mc_cuda_»sourûs_t
 **
»sourûs
);

31 
ucc_¡©us_t
 
ucc_mc_cuda_mem£t
(*
±r
, 
v®
, 
size_t
 
Ën
);

	@src/components/mc/cuda/mc_cuda_resources.c

1 
	~"mc_cuda_»sourûs.h
"

2 
	~"compÚ’ts/mc/ucc_mc_log.h
"

3 
	~"uts/ucc_m®loc.h
"

5 
ucc_¡©us_t
 
	$ucc_mc_cuda_chunk_®loc
(
ucc_mpoŞ_t
 *
mp
,

6 
size_t
 *
size_p
,

7 **
chunk_p
)

9 *
chunk_p
 = 
	`ucc_m®loc
(*
size_p
, "mc cuda");

10 ià(!*
chunk_p
) {

11  
UCC_ERR_NO_MEMORY
;

14  
UCC_OK
;

15 
	}
}

17 
	$ucc_mc_cuda_chunk_š™
(
ucc_mpoŞ_t
 *
mp
,

18 *
obj
, *
chunk
)

20 
ucc_mc_bufãr_h—d”_t
 *
h
 = (ucc_mc_bufãr_h—d”_ˆ*)
obj
;

21 
cudaE¼Ü_t
 
¡
;

23 
¡
 = 
	`cudaM®loc
(&
h
->
addr
, 
ucc_mc_cuda_cÚfig
->
mpoŞ_–em_size
);

24 ià(
¡
 !ğ
cudaSucûss
) {

27 
	`cudaG‘La¡E¼Ü
();

29 
h
->
äom_poŞ
 = 1;

30 
h
->
mt
 = 
UCC_MEMORY_TYPE_CUDA
;

31 
	}
}

33 
	$ucc_mc_cuda_chunk_»Ëa£
(
ucc_mpoŞ_t
 *
mp
, *
chunk
)

35 
	`ucc_ä“
(
chunk
);

36 
	}
}

38 
	$ucc_mc_cuda_chunk_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

40 
ucc_mc_bufãr_h—d”_t
 *
h
 = (ucc_mc_bufãr_h—d”_ˆ*)
obj
;

41 
cudaE¼Ü_t
 
¡
;

43 
¡
 = 
	`cudaF»e
(
h
->
addr
);

44 ià(
¡
 !ğ
cudaSucûss
) {

45 
	`cudaG‘La¡E¼Ü
();

47 
	}
}

49 
ucc_mpoŞ_İs_t
 
	gucc_mc_İs
 = {.
chunk_®loc
 = 
ucc_mc_cuda_chunk_®loc
,

50 .
	gchunk_»Ëa£
 = 
ucc_mc_cuda_chunk_»Ëa£
,

51 .
	gobj_š™
 = 
ucc_mc_cuda_chunk_š™
,

52 .
	gobj_ş—nup
 = 
ucc_mc_cuda_chunk_ş—nup
};

54 
ucc_¡©us_t
 
	$ucc_mc_cuda_»sourûs_š™
(
ucc_mc_ba£_t
 *
mc
,

55 
ucc_mc_cuda_»sourûs_t
 *
»sourûs
)

57 
ucc_¡©us_t
 
¡©us
;

59 
	`CUDADRV_CHECK
(
	`cuCtxG‘Cu¼’t
(&
»sourûs
->
cu_ùx
));

60 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
»sourûs
->
sü©ch_mpoŞ
, 0,

61 (
ucc_mc_bufãr_h—d”_t
), 0,

62 
UCC_CACHE_LINE_SIZE
, 1,

63 
ucc_mc_cuda_cÚfig
->
mpoŞ_max_–ems
, &
ucc_mc_İs
,

64 
UCC_THREAD_MULTIPLE
, "mc cuda mpool buffers");

65 ià(
¡©us
 !ğ
UCC_OK
) {

66 
	`mc_”rÜ
(
mc
, "failedo create scratch buffers mpool");

67  
¡©us
;

70 
¡©us
 = 
	`CUDA_FUNC
(
	`cudaSŒ—mC»©eW™hFÏgs
(&
»sourûs
->
¡»am
,

71 
cudaSŒ—mNÚBlockšg
));

72 ià(
¡©us
 !ğ
UCC_OK
) {

73 
	`mc_”rÜ
(
mc
, "failedo create CUDA stream");

74 
ä“_sü©ch_mpoŞ
;

77  
UCC_OK
;

79 
ä“_sü©ch_mpoŞ
:

80 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
sü©ch_mpoŞ
, 0);

81  
¡©us
;

82 
	}
}

84 
	$ucc_mc_cuda_»sourûs_ş—nup
(
ucc_mc_cuda_»sourûs_t
 *
»sourûs
)

86 
CUcÚ‹xt
 
tmp_cÚ‹xt
;

87 #ià
CUDA_VERSION
 >= 12000

88 
CU»suÉ
 
¡©us
;

89 
cu_ùx_id
;

91 
¡©us
 = 
	`cuCtxG‘Id
(
»sourûs
->
cu_ùx
, &
cu_ùx_id
);

92 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
CUDA_SUCCESS
)) {

98 
	`cuCtxPushCu¼’t
(
»sourûs
->
cu_ùx
);

99 
	`ucc_mpoŞ_ş—nup
(&
»sourûs
->
sü©ch_mpoŞ
, 1);

100 
	`CUDA_FUNC
(
	`cudaSŒ—mDe¡roy
(
»sourûs
->
¡»am
));

101 
	`cuCtxPİCu¼’t
(&
tmp_cÚ‹xt
);

102 
	}
}

	@src/components/mc/cuda/mc_cuda_resources.h

7 #iâdeà
UCC_MC_CUDA_RESOURCES_H_


8 
	#UCC_MC_CUDA_RESOURCES_H_


	)

10 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

11 
	~"uts/¬ch/cuda_def.h
"

12 
	~"uts/ucc_mpoŞ.h
"

14 
	succ_mc_cuda_cÚfig
 {

15 
ucc_mc_cÚfig_t
 
	msu³r
;

16 
size_t
 
	mmpoŞ_–em_size
;

17 
	mmpoŞ_max_–ems
;

18 } 
	tucc_mc_cuda_cÚfig_t
;

20 
	succ_mc_cuda_»sourûs
 {

21 
CUcÚ‹xt
 
	mcu_ùx
;

22 
cudaSŒ—m_t
 
	m¡»am
;

23 
ucc_mpoŞ_t
 
	msü©ch_mpoŞ
;

24 } 
	tucc_mc_cuda_»sourûs_t
;

26 
ucc_mc_cuda_cÚfig_t
 *
ucc_mc_cuda_cÚfig
;

28 
ucc_¡©us_t
 
ucc_mc_cuda_»sourûs_š™
(
ucc_mc_ba£_t
 *
mc
,

29 
ucc_mc_cuda_»sourûs_t
 *
»sourûs
);

31 
ucc_mc_cuda_»sourûs_ş—nup
(
ucc_mc_cuda_»sourûs_t
 *
»sourûs
);

33 
KHASH_INIT
(
ucc_mc_cuda_»sourûs_hash
, , *, 1, \

34 
kh_št64_hash_func
, 
kh_št64_hash_equ®
);

35 
	#ucc_mc_cuda_»sourûs_hash_t
 
	`khash_t
(
ucc_mc_cuda_»sourûs_hash
)

	)

37 
šlše


38 * 
	$mc_cuda_»sourûs_hash_g‘
(
ucc_mc_cuda_»sourûs_hash_t
 *
h
,

39 
key
)

41 
kh™”_t
 
k
;

42 *
v®ue
;

44 
k
 = 
	`kh_g‘
(
ucc_mc_cuda_»sourûs_hash
, 
h
 , 
key
);

45 ià(
k
 =ğ
	`kh_’d
(
h
)) {

46  
NULL
;

48 
v®ue
 = 
	`kh_v®ue
(
h
, 
k
);

49  
v®ue
;

50 
	}
}

52 
šlše


53 
	$mc_cuda_»sourûs_hash_put
(
ucc_mc_cuda_»sourûs_hash_t
 *
h
,

54 
key
,

55 *
v®ue
)

57 
»t
;

58 
kh™”_t
 
k
;

59 
k
 = 
	`kh_put
(
ucc_mc_cuda_»sourûs_hash
, 
h
, 
key
, &
»t
);

60 
	`kh_v®ue
(
h
, 
k
èğ
v®ue
;

61 
	}
}

63 
šlše


64 * 
	$mc_cuda_»sourûs_hash_pİ
(
ucc_mc_cuda_»sourûs_hash_t
 *
h
)

66 *
»sourûs
 = 
NULL
;

67 
kh™”_t
 
k
;

69 
k
 = 
	`kh_begš
(
h
);

70 
k
 !ğ
	`kh_’d
(
h
)) {

71 ià(
	`kh_exi¡
(
h
, 
k
)) {

72 
»sourûs
 = 
	`kh_v®ue
(
h
, 
k
);

75 
k
++;

78 ià(
»sourûs
) {

79 
	`kh_d–
(
ucc_mc_cuda_»sourûs_hash
, 
h
, 
k
);

81  
»sourûs
;

82 
	}
}

	@src/components/mc/rocm/mc_rocm.c

8 
	~"mc_rocm.h
"

9 
	~"uts/ucc_m®loc.h
"

10 
	~"uts/¬ch/ıu.h
"

11 
	~<h/h_ruÁime.h
>

12 
	~<h/h_v”siÚ.h
>

13 
	~<h§/h§.h
>

14 
	~<h§/h§_ext_amd.h
>

16 
ucc_cÚfig_f›ld_t
 
	gucc_mc_rocm_cÚfig_bË
[] = {

17 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_mc_rocm_cÚfig_t
, 
su³r
),

18 
UCC_CONFIG_TYPE_TABLE
(
ucc_mc_cÚfig_bË
)},

21 
ucc_off£tof
(
ucc_mc_rocm_cÚfig_t
, 
mpoŞ_–em_size
),

22 
UCC_CONFIG_TYPE_MEMUNITS
},

25 
ucc_off£tof
(
ucc_mc_rocm_cÚfig_t
, 
mpoŞ_max_–ems
), 
UCC_CONFIG_TYPE_UINT
},

27 {
NULL
}

31 
ucc_¡©us_t
 
	$ucc_mc_rocm_š™
(cÚ¡ 
ucc_mc_·¿ms_t
 *
mc_·¿ms
)

33 
num_deviûs
;

34 
hE¼Ü_t
 
rocm_¡
;

36 
ucc_mc_rocm
.
¡»am
 = 
NULL
;

37 
ucc_mc_rocm
.
¡»am_š™Ÿlized
 = 0;

38 
	`ucc_¡ºıy_§ã
(
ucc_mc_rocm
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
,

39 
ucc_mc_rocm
.
su³r
.su³r.
Çme
,

40 (
ucc_mc_rocm
.
su³r
.
cÚfig
->
log_compÚ’t
.
Çme
));

41 
ucc_mc_rocm
.
th»ad_mode
 = 
mc_·¿ms
->thread_mode;

42 
rocm_¡
 = 
	`hG‘DeviûCouÁ
(&
num_deviûs
);

43 ià((
rocm_¡
 !ğ
hSucûss
è|| (
num_deviûs
 == 0)) {

44 
	`mc_debug
(&
ucc_mc_rocm
.
su³r
, "rocm devices‡re‚ot found");

45  
	`h_”rÜ_to_ucc_¡©us
(
rocm_¡
);

50 
	`ucc_¥šlock_š™
(&
ucc_mc_rocm
.
š™_¥šlock
, 0);

52  
UCC_OK
;

53 
	}
}

55 
ucc_¡©us_t
 
	$ucc_mc_rocm_g‘_©Œ
(
ucc_mc_©Œ_t
 *
mc_©Œ
)

57 ià(
mc_©Œ
->
f›ld_mask
 & 
UCC_MC_ATTR_FIELD_THREAD_MODE
) {

58 
mc_©Œ
->
th»ad_mode
 = 
ucc_mc_rocm
.thread_mode;

60  
UCC_OK
;

61 
	}
}

63 
ucc_¡©us_t
 
	$ucc_mc_rocm_mem_®loc
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
,

64 
size_t
 
size
,

65 
ucc_memÜy_ty³_t
 
mt
)

67 
hE¼Ü_t
 
¡
;

69 
ucc_mc_bufãr_h—d”_t
 *
h
 = 
	`ucc_m®loc
((ucc_mc_buffer_header_t), "mc„ocm");

70 ià(
	`ucc_uÆik–y
(!
h
)) {

71 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
, "failedo‡llocate %zd bytes",

72 (
ucc_mc_bufãr_h—d”_t
));

74 
¡
 = 
	`hM®loc
(&
h
->
addr
, 
size
);

75 ià(
	`ucc_uÆik–y
(
¡
 !ğ
hSucûss
)) {

76 
	`hG‘La¡E¼Ü
();

77 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
,

80 
size
, 
¡
, 
	`hG‘E¼ÜSŒšg
(st));

81 
	`ucc_ä“
(
h
);

82  
	`h_”rÜ_to_ucc_¡©us
(
¡
);

84 
h
->
äom_poŞ
 = 0;

85 
h
->
mt
 = mt;

86 *
h_±r
 = 
h
;

87 
	`mc_Œaû
(&
ucc_mc_rocm
.
su³r
, "®loÿ‹d %ld by‹ w™h hM®loc", 
size
);

88  
UCC_OK
;

89 
	}
}

91 
ucc_¡©us_t
 
	$ucc_mc_rocm_mem_poŞ_®loc
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
,

92 
size_t
 
size
,

93 
ucc_memÜy_ty³_t
 
mt
)

95 
ucc_mc_bufãr_h—d”_t
 *
h
 = 
NULL
;

97 ià(
size
 <ğ
MC_ROCM_CONFIG
->
mpoŞ_–em_size
) {

98 
h
 = (
ucc_mc_bufãr_h—d”_t
 *)
	`ucc_mpoŞ_g‘
(&
ucc_mc_rocm
.
mpoŞ
);

100 ià(!
h
) {

102  
	`ucc_mc_rocm_mem_®loc
(
h_±r
, 
size
, 
mt
);

104 ià(
	`ucc_uÆik–y
(!
h
->
addr
)){

105  
UCC_ERR_NO_MEMORY
;

107 *
h_±r
 = 
h
;

108 
	`mc_Œaû
(&
ucc_mc_rocm
.
su³r
, "®loÿ‹d %ld by‹ äom„ocm mpoŞ", 
size
);

109  
UCC_OK
;

110 
	}
}

112 
ucc_¡©us_t
 
	$ucc_mc_rocm_chunk_®loc
(
ucc_mpoŞ_t
 *
mp
,

113 
size_t
 *
size_p
,

114 **
chunk_p
)

116 *
chunk_p
 = 
	`ucc_m®loc
(*
size_p
, "mc„ocm");

117 ià(!*
chunk_p
) {

118 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
, "çedØ®loÿ‹ %zd by‹s", *
size_p
);

119  
UCC_ERR_NO_MEMORY
;

122  
UCC_OK
;

123 
	}
}

125 
	$ucc_mc_rocm_chunk_š™
(
ucc_mpoŞ_t
 *
mp
,

126 *
obj
, *
chunk
)

128 
ucc_mc_bufãr_h—d”_t
 *
h
 = (ucc_mc_bufãr_h—d”_ˆ*)
obj
;

129 
hE¼Ü_t
 
¡
 = 
	`hM®loc
(&
h
->
addr
, 
MC_ROCM_CONFIG
->
mpoŞ_–em_size
);

131 ià(
¡
 !ğ
hSucûss
) {

134 
	`hG‘La¡E¼Ü
();

135 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
,

138 
MC_ROCM_CONFIG
->
mpoŞ_–em_size
, 
¡
, 
	`hG‘E¼ÜSŒšg
(st));

140 
h
->
äom_poŞ
 = 1;

141 
h
->
mt
 = 
UCC_MEMORY_TYPE_ROCM
;

142 
	}
}

144 
	$ucc_mc_rocm_chunk_»Ëa£
(
ucc_mpoŞ_t
 *
mp
, *
chunk
)

146 
	`ucc_ä“
(
chunk
);

147 
	}
}

149 
	$ucc_mc_rocm_chunk_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

151 
ucc_mc_bufãr_h—d”_t
 *
h
 = (ucc_mc_bufãr_h—d”_ˆ*)
obj
;

152 
hE¼Ü_t
 
¡
;

154 
¡
 = 
	`hF»e
(
h
->
addr
);

155 ià(
¡
 !ğ
hSucûss
) {

156 
	`hG‘La¡E¼Ü
();

157 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
,

160 
obj
, 
¡
, 
	`hG‘E¼ÜSŒšg
(st));

162 
	}
}

164 
ucc_mpoŞ_İs_t
 
	gucc_mc_İs
 = {.
chunk_®loc
 = 
ucc_mc_rocm_chunk_®loc
,

165 .
	gchunk_»Ëa£
 = 
ucc_mc_rocm_chunk_»Ëa£
,

166 .
	gobj_š™
 = 
ucc_mc_rocm_chunk_š™
,

167 .
	gobj_ş—nup
 = 
ucc_mc_rocm_chunk_ş—nup
};

169 
ucc_¡©us_t
 
	$ucc_mc_rocm_mem_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
)

171 
hE¼Ü_t
 
¡
;

173 
¡
 = 
	`hF»e
(
h_±r
->
addr
);

174 ià(
	`ucc_uÆik–y
(
¡
 !ğ
hSucûss
)) {

175 
	`hG‘La¡E¼Ü
();

176 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
,

179 
h_±r
->
addr
, 
¡
, 
	`hG‘E¼ÜSŒšg
(st));

180  
	`h_”rÜ_to_ucc_¡©us
(
¡
);

182 
	`ucc_ä“
(
h_±r
);

183  
UCC_OK
;

184 
	}
}

186 
ucc_¡©us_t
 
	$ucc_mc_rocm_mem_poŞ_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
)

188 ià(!
h_±r
->
äom_poŞ
) {

189  
	`ucc_mc_rocm_mem_ä“
(
h_±r
);

191 
	`ucc_mpoŞ_put
(
h_±r
);

192  
UCC_OK
;

193 
	}
}

195 
ucc_¡©us_t


196 
	$ucc_mc_rocm_mem_poŞ_®loc_w™h_š™
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
,

197 
size_t
 
size
,

198 
ucc_memÜy_ty³_t
 
mt
)

202 
	`ucc_¥š_lock
(&
ucc_mc_rocm
.
š™_¥šlock
);

204 ià(
MC_ROCM_CONFIG
->
mpoŞ_max_–ems
 == 0) {

205 
ucc_mc_rocm
.
su³r
.
İs
.
mem_®loc
 = 
ucc_mc_rocm_mem_®loc
;

206 
ucc_mc_rocm
.
su³r
.
İs
.
mem_ä“
 = 
ucc_mc_rocm_mem_ä“
;

207 
	`ucc_¥š_uÆock
(&
ucc_mc_rocm
.
š™_¥šlock
);

208  
	`ucc_mc_rocm_mem_®loc
(
h_±r
, 
size
, 
mt
);

211 ià(!
ucc_mc_rocm
.
mpoŞ_š™_æag
) {

212 
ucc_¡©us_t
 
¡©us
 = 
	`ucc_mpoŞ_š™
(

213 &
ucc_mc_rocm
.
mpoŞ
, 0, (
ucc_mc_bufãr_h—d”_t
), 0,

214 
UCC_CACHE_LINE_SIZE
, 1, 
MC_ROCM_CONFIG
->
mpoŞ_max_–ems
,

215 &
ucc_mc_İs
, 
ucc_mc_rocm
.
th»ad_mode
, "mc„ocm mpool buffers");

216 ià(
¡©us
 !ğ
UCC_OK
) {

217 
	`ucc_¥š_uÆock
(&
ucc_mc_rocm
.
š™_¥šlock
);

218  
¡©us
;

220 
ucc_mc_rocm
.
su³r
.
İs
.
mem_®loc
 = 
ucc_mc_rocm_mem_poŞ_®loc
;

221 
ucc_mc_rocm
.
mpoŞ_š™_æag
 = 1;

223 
	`ucc_¥š_uÆock
(&
ucc_mc_rocm
.
š™_¥šlock
);

224  
	`ucc_mc_rocm_mem_poŞ_®loc
(
h_±r
, 
size
, 
mt
);

225 
	}
}

227 
ucc_¡©us_t
 
	$ucc_mc_rocm_memıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
Ën
,

228 
ucc_memÜy_ty³_t
 
d¡_mem
,

229 
ucc_memÜy_ty³_t
 
¤c_mem
)

231 
hE¼Ü_t
 
¡
;

233 
	`ucc_as£¹
(
d¡_mem
 =ğ
UCC_MEMORY_TYPE_ROCM
 ||

234 
¤c_mem
 =ğ
UCC_MEMORY_TYPE_ROCM
);

236 
	`UCC_MC_ROCM_INIT_STREAM
();

237 
¡
 = 
	`hMemıyAsync
(
d¡
, 
¤c
, 
Ën
, 
hMemıyDeçuÉ
, 
ucc_mc_rocm
.
¡»am
);

238 ià(
	`ucc_uÆik–y
(
¡
 !ğ
hSucûss
)) {

239 
	`hG‘La¡E¼Ü
();

240 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
,

243 
d¡
, 
¤c
, 
Ën
, 
¡
, 
	`hG‘E¼ÜSŒšg
(st));

244  
	`h_”rÜ_to_ucc_¡©us
(
¡
);

246 
¡
 = 
	`hSŒ—mSynchrÚize
(
ucc_mc_rocm
.
¡»am
);

247 ià(
	`ucc_uÆik–y
(
¡
 !ğ
hSucûss
)) {

248 
	`hG‘La¡E¼Ü
();

249 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
,

252 
¡
, 
	`hG‘E¼ÜSŒšg
(st));

253  
	`h_”rÜ_to_ucc_¡©us
(
¡
);

255  
UCC_OK
;

256 
	}
}

258 
ucc_¡©us_t
 
	$ucc_mc_rocm_mem£t
(*
±r
, 
v®
, 
size_t
 
Ën
)

260 
hE¼Ü_t
 
¡
;

262 
	`UCC_MC_ROCM_INIT_STREAM
();

263 
¡
 = 
	`hMem£tAsync
(
±r
, 
v®
, 
Ën
, 
ucc_mc_rocm
.
¡»am
);

264 ià(
	`ucc_uÆik–y
(
¡
 !ğ
hSucûss
)) {

265 
	`hG‘La¡E¼Ü
();

266 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
,

269 
±r
, 
Ën
, 
¡
, 
	`hG‘E¼ÜSŒšg
(st));

270  
	`h_”rÜ_to_ucc_¡©us
(
¡
);

272 
¡
 = 
	`hSŒ—mSynchrÚize
(
ucc_mc_rocm
.
¡»am
);

273 ià(
	`ucc_uÆik–y
(
¡
 !ğ
hSucûss
)) {

274 
	`hG‘La¡E¼Ü
();

275 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
,

278 
¡
, 
	`hG‘E¼ÜSŒšg
(st));

279  
	`h_”rÜ_to_ucc_¡©us
(
¡
);

281  
UCC_OK
;

282 
	}
}

284 
ucc_¡©us_t
 
	$ucc_mc_rocm_mem_qu”y
(cÚ¡ *
±r
,

285 
ucc_mem_©Œ_t
 *
mem_©Œ
)

287 
hPoš‹rA‰ribu‹_t
 
©Œ
;

288 
hE¼Ü_t
 
¡
;

289 
ucc_memÜy_ty³_t
 
mem_ty³
;

290 *
ba£_add»ss
;

291 
size_t
 
®loc_Ëngth
;

293 ià(!(
mem_©Œ
->
f›ld_mask
 & (
UCC_MEM_ATTR_FIELD_MEM_TYPE
 |

294 
UCC_MEM_ATTR_FIELD_BASE_ADDRESS
 |

295 
UCC_MEM_ATTR_FIELD_ALLOC_LENGTH
))) {

296  
UCC_OK
;

299 ià(
mem_©Œ
->
f›ld_mask
 & 
UCC_MEM_ATTR_FIELD_MEM_TYPE
) {

300 
¡
 = 
	`hPoš‹rG‘A‰ribu‹s
(&
©Œ
, 
±r
);

301 ià(
¡
 !ğ
hSucûss
) {

302 
	`hG‘La¡E¼Ü
();

303  
UCC_ERR_NOT_SUPPORTED
;

306 #ià
HIP_VERSION
 >= 50500000

307 
©Œ
.
ty³
) {

309 
©Œ
.
memÜyTy³
) {

311 
hMemÜyTy³Ho¡
:

312 
mem_ty³
 = (
©Œ
.
isMªaged
 ? 
UCC_MEMORY_TYPE_ROCM_MANAGED
 : 
UCC_MEMORY_TYPE_HOST
);

314 
hMemÜyTy³Deviû
:

315 
mem_ty³
 = 
UCC_MEMORY_TYPE_ROCM
;

317 #ià
HIP_VERSION
 >= 50300000

318 
hMemÜyTy³Mªaged
:

319 
mem_ty³
 = 
UCC_MEMORY_TYPE_ROCM_MANAGED
;

323  
UCC_ERR_NOT_SUPPORTED
;

325 
mem_©Œ
->
mem_ty³
 = mem_type;

328 ià(
mem_©Œ
->
f›ld_mask
 & (
UCC_MEM_ATTR_FIELD_ALLOC_LENGTH
 |

329 
UCC_MEM_ATTR_FIELD_BASE_ADDRESS
)) {

330 
¡
 = 
	`hMemG‘Add»ssRªge
((
hDeviû±r_t
*)&
ba£_add»ss
,

331 &
®loc_Ëngth
, (
hDeviû±r_t
)
±r
);

332 ià(
¡
 !ğ
hSucûss
) {

333 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
,

335 
±r
, 
¡
, 
	`hG‘E¼ÜSŒšg
(st));

336  
	`h_”rÜ_to_ucc_¡©us
(
¡
);

339 
mem_©Œ
->
ba£_add»ss
 = base_address;

340 
mem_©Œ
->
®loc_Ëngth
 =‡lloc_length;

343  
UCC_OK
;

344 
	}
}

346 
ucc_¡©us_t
 
	$ucc_mc_rocm_fš®ize
()

348 ià(
ucc_mc_rocm
.
¡»am
 !ğ
NULL
) {

349 
	`ROCMCHECK
(
	`hSŒ—mDe¡roy
(
ucc_mc_rocm
.
¡»am
));

350 
ucc_mc_rocm
.
¡»am
 = 
NULL
;

352 ià(
ucc_mc_rocm
.
mpoŞ_š™_æag
) {

353 
	`ucc_mpoŞ_ş—nup
(&
ucc_mc_rocm
.
mpoŞ
, 1);

354 
ucc_mc_rocm
.
mpoŞ_š™_æag
 = 0;

355 
ucc_mc_rocm
.
su³r
.
İs
.
mem_®loc
 = 
ucc_mc_rocm_mem_poŞ_®loc_w™h_š™
;

357 
	`ucc_¥šlock_de¡roy
(&
ucc_mc_rocm
.
š™_¥šlock
);

358  
UCC_OK
;

359 
	}
}

361 
ucc_mc_rocm_t
 
	gucc_mc_rocm
 = {

362 .
su³r
.su³r.
Çme
 = "rocm mc",

363 .
	gsu³r
.
	g»f_út
 = 0,

364 .
	gsu³r
.
	g“_ty³
 = 
UCC_EE_ROCM_STREAM
,

365 .
	gsu³r
.
	gty³
 = 
UCC_MEMORY_TYPE_ROCM
,

366 .
	gsu³r
.
	gš™
 = 
ucc_mc_rocm_š™
,

367 .
	gsu³r
.
	gg‘_©Œ
 = 
ucc_mc_rocm_g‘_©Œ
,

368 .
	gsu³r
.
	gfš®ize
 = 
ucc_mc_rocm_fš®ize
,

369 .
	gsu³r
.
	gİs
.
	gmem_qu”y
 = 
ucc_mc_rocm_mem_qu”y
,

370 .
	gsu³r
.
	gİs
.
	gmem_®loc
 = 
ucc_mc_rocm_mem_poŞ_®loc_w™h_š™
,

371 .
	gsu³r
.
	gİs
.
	gmem_ä“
 = 
ucc_mc_rocm_mem_poŞ_ä“
,

372 .
	gsu³r
.
	gİs
.
	gmemıy
 = 
ucc_mc_rocm_memıy
,

373 .
	gsu³r
.
	gİs
.
	gmem£t
 = 
ucc_mc_rocm_mem£t
,

374 .
	gsu³r
.
	gcÚfig_bË
 =

376 .
Çme
 = "ROCM memory component",

377 .
	g´efix
 = "MC_ROCM_",

378 .
	gbË
 = 
ucc_mc_rocm_cÚfig_bË
,

379 .
	gsize
 = (
ucc_mc_rocm_cÚfig_t
),

381 .
	gmpoŞ_š™_æag
 = 0,

384 
UCC_CONFIG_REGISTER_TABLE_ENTRY
(&
ucc_mc_rocm
.
su³r
.
cÚfig_bË
,

385 &
ucc_cÚfig_glob®_li¡
);

	@src/components/mc/rocm/mc_rocm.h

8 #iâdeà
UCC_MC_ROCM_H_


9 
	#UCC_MC_ROCM_H_


	)

11 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

12 
	~"compÚ’ts/mc/ucc_mc_log.h
"

13 
	~"uts/ucc_mpoŞ.h
"

14 
	~"uts/¬ch/rocm_def.h
"

15 
	~<h/h_ruÁime_­i.h
>

16 
	~<h/h_com¶ex.h
>

18 
šlše
 
ucc_¡©us_t
 
	$h_”rÜ_to_ucc_¡©us
(
hE¼Ü_t
 
h_”r
)

20 
h_”r
) {

21 
hSucûss
:

22  
UCC_OK
;

23 
hE¼ÜNÙR—dy
:

24  
UCC_INPROGRESS
;

28  
UCC_ERR_NO_MESSAGE
;

29 
	}
}

31 
	$ucc_¡©us_t
 (*
	tucc_mc_rocm_sk_po¡_â
è(
	tušt32_t
 *
	tdev_¡©us
,

32 
	tblockšg_wa™
,

33 
	thSŒ—m_t
 
	t¡»am
);

35 
	succ_mc_rocm_cÚfig
 {

36 
ucc_mc_cÚfig_t
 
su³r
;

37 
size_t
 
mpoŞ_–em_size
;

38 
mpoŞ_max_–ems
;

39 } 
	tucc_mc_rocm_cÚfig_t
;

41 
	succ_mc_rocm
 {

42 
ucc_mc_ba£_t
 
su³r
;

43 
¡»am_š™Ÿlized
;

44 
hSŒ—m_t
 
¡»am
;

45 
ucc_mpoŞ_t
 
ev’ts
;

46 
ucc_mpoŞ_t
 
¡rm_»qs
;

47 
ucc_mpoŞ_t
 
mpoŞ
;

48 
mpoŞ_š™_æag
;

49 
ucc_¥šlock_t
 
š™_¥šlock
;

50 
ucc_th»ad_mode_t
 
th»ad_mode
;

51 } 
	tucc_mc_rocm_t
;

53 
ucc_mc_rocm_t
 
ucc_mc_rocm
;

55 
	#MC_ROCM_CONFIG
 \

56 (
	`ucc_d”ived_of
(
ucc_mc_rocm
.
su³r
.
cÚfig
, 
ucc_mc_rocm_cÚfig_t
))

	)

58 
	#UCC_MC_ROCM_INIT_STREAM
() do { \

59 ià(!
ucc_mc_rocm
.
¡»am_š™Ÿlized
) { \

60 
hE¼Ü_t
 
h_¡
 = 
hSucûss
; \

61 
	`ucc_¥š_lock
(&
ucc_mc_rocm
.
š™_¥šlock
); \

62 ià(!
ucc_mc_rocm
.
¡»am_š™Ÿlized
) { \

63 
h_¡
 = 
	`hSŒ—mC»©eW™hFÏgs
(&
ucc_mc_rocm
.
¡»am
, \

64 
hSŒ—mNÚBlockšg
); \

65 
ucc_mc_rocm
.
¡»am_š™Ÿlized
 = 1; \

67 
	`ucc_¥š_uÆock
(&
ucc_mc_rocm
.
š™_¥šlock
); \

68 if(
h_¡
 !ğ
hSucûss
) { \

69 
	`mc_”rÜ
(&
ucc_mc_rocm
.
su³r
, "rocm failed with„et:%d(%s)", \

70 
h_¡
, 
	`hG‘E¼ÜSŒšg
(hip_st)); \

71  
	`h_”rÜ_to_ucc_¡©us
(
h_¡
); \

74 
	}
} 0)

	)

	@src/components/mc/ucc_mc.c

7 
	~"cÚfig.h
"

8 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

9 
	~"ucc_mc.h
"

10 
	~"uts/ucc_m®loc.h
"

11 
	~"uts/ucc_log.h
"

13 #ifdeà
HAVE_PROFILING_MC


14 
	~"uts/´ofe/ucc_´ofe.h
"

16 
	~"uts/´ofe/ucc_´ofe_off.h
"

18 
	#UCC_MC_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

20 cÚ¡ 
ucc_mc_İs_t
 *
	gmc_İs
[
UCC_MEMORY_TYPE_LAST
];

22 
	#UCC_CHECK_MC_AVAILABLE
(
mc
) \

24 ià(
	`ucc_uÆik–y
(
NULL
 =ğ
mc_İs
[
mc
])) { \

25 
	`ucc_”rÜ
("no components supported memoryype %s‡vailable", \

26 
ucc_memÜy_ty³_Çmes
[
mc
]); \

27  
UCC_ERR_NOT_SUPPORTED
; \

29 } 0)

	)

31 
ucc_¡©us_t
 
	$ucc_mc_š™
(cÚ¡ 
ucc_mc_·¿ms_t
 *
mc_·¿ms
)

33 
i
, 
n_mcs
;

34 
ucc_mc_ba£_t
 *
mc
;

35 
ucc_¡©us_t
 
¡©us
;

36 
ucc_mc_©Œ_t
 
©Œ
;

38 
	`mem£t
(
mc_İs
, 0, 
UCC_MEMORY_TYPE_LAST
 * (
ucc_mc_İs_t
 *));

39 
n_mcs
 = 
ucc_glob®_cÚfig
.
mc_äamewÜk
.
n_compÚ’ts
;

40 
i
 = 0; i < 
n_mcs
; i++) {

41 
mc
 = 
	`ucc_d”ived_of
(
ucc_glob®_cÚfig
.
mc_äamewÜk
.
compÚ’ts
[
i
],

42 
ucc_mc_ba£_t
);

43 ià(
mc
->
»f_út
 == 0) {

44 
mc
->
cÚfig
 = 
	`ucc_m®loc
(mc->
cÚfig_bË
.
size
);

45 ià(!
mc
->
cÚfig
) {

46 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for mc config",

47 
mc
->
cÚfig_bË
.
size
);

50 
¡©us
 = 
	`ucc_cÚfig_·r£r_fl_İts
(

51 
mc
->
cÚfig
, &mc->
cÚfig_bË
, "UCC_", 1);

52 ià(
UCC_OK
 !ğ
¡©us
) {

53 
	`ucc_debug
("failedo…arse config for mc: %s (%d)",

54 
mc
->
su³r
.
Çme
, 
¡©us
);

55 
	`ucc_ä“
(
mc
->
cÚfig
);

58 
¡©us
 = 
mc
->
	`š™
(
mc_·¿ms
);

59 ià(
UCC_OK
 !ğ
¡©us
) {

60 
	`ucc_debug
("mc_init failed for component: %s, skipping (%d)",

61 
mc
->
su³r
.
Çme
, 
¡©us
);

62 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(
mc
->
cÚfig
,

63 
mc
->
cÚfig_bË
.
bË
);

64 
	`ucc_ä“
(
mc
->
cÚfig
);

67 
	`ucc_debug
("mø% š™Ÿlized", 
mc
->
su³r
.
Çme
);

69 
©Œ
.
f›ld_mask
 = 
UCC_MC_ATTR_FIELD_THREAD_MODE
;

70 
¡©us
 = 
mc
->
	`g‘_©Œ
(&
©Œ
);

71 ià(
¡©us
 !ğ
UCC_OK
) {

72  
¡©us
;

74 ià(
©Œ
.
th»ad_mode
 < 
mc_·¿ms
->thread_mode) {

75 
	`ucc_šfo
("mc %s was‡llready initilized with "

77 
mc
->
su³r
.
Çme
, 
©Œ
.
th»ad_mode
,

78 
mc_·¿ms
->
th»ad_mode
);

81 
mc
->
»f_út
++;

82 
mc_İs
[
mc
->
ty³
] = &mc->
İs
;

85  
UCC_OK
;

86 
	}
}

88 
ucc_¡©us_t
 
	$ucc_mc_avaabË
(
ucc_memÜy_ty³_t
 
mem_ty³
)

90 
mem_ty³
 = (mem_ty³ =ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
) ?

91 
UCC_MEMORY_TYPE_CUDA
 : 
mem_ty³
;

93 ià(
NULL
 =ğ
mc_İs
[
mem_ty³
]) {

94  
UCC_ERR_NOT_FOUND
;

97  
UCC_OK
;

98 
	}
}

100 
ucc_¡©us_t
 
	$ucc_mc_g‘_mem_©Œ
(cÚ¡ *
±r
, 
ucc_mem_©Œ_t
 *
mem_©Œ
)

102 
ucc_¡©us_t
 
¡©us
;

103 
ucc_memÜy_ty³_t
 
mt
;

105 
mem_©Œ
->
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

106 
mem_©Œ
->
ba£_add»ss
 = (*)
±r
;

107 ià(
±r
 =ğ
NULL
) {

108 
mem_©Œ
->
®loc_Ëngth
 = 0;

109  
UCC_OK
;

112 
mt
 = (
ucc_memÜy_ty³_t
)(
UCC_MEMORY_TYPE_HOST
 + 1);

113 ; 
mt
 < 
UCC_MEMORY_TYPE_LAST
; mt++) {

114 ià(
NULL
 !ğ
mc_İs
[
mt
]) {

115 
¡©us
 = 
mc_İs
[
mt
]->
	`mem_qu”y
(
±r
, 
mem_©Œ
);

116 ià(
UCC_OK
 =ğ
¡©us
) {

117  
UCC_OK
;

121  
UCC_OK
;

122 
	}
}

124 
ucc_¡©us_t
 
	$ucc_mc_g‘_©Œ
(
ucc_mc_©Œ_t
 *
©Œ
, 
ucc_memÜy_ty³_t
 
mem_ty³
)

126 
ucc_memÜy_ty³_t
 
mt
 = (
mem_ty³
 =ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
) ?

127 
UCC_MEMORY_TYPE_CUDA
 : 
mem_ty³
;

128 
ucc_mc_ba£_t
 *
mc
;

130 
	`UCC_CHECK_MC_AVAILABLE
(
mt
);

131 
mc
 = 
	`ucc_cÚš”_of
(
mc_İs
[
mt
], 
ucc_mc_ba£_t
, 
İs
);

132  
mc
->
	`g‘_©Œ
(
©Œ
);

133 
	}
}

136 
UCC_MC_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_mc_®loc
, (
h_±r
, 
size
, 
mem_ty³
),

137 
ucc_mc_bufãr_h—d”_t
 **
h_±r
, 
size_t
 
size
,

138 
ucc_memÜy_ty³_t
 
mem_ty³
)

140 
ucc_memÜy_ty³_t
 
	gmt
 = (
mem_ty³
 =ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
) ?

141 
UCC_MEMORY_TYPE_CUDA
 : 
mem_ty³
;

143 
UCC_CHECK_MC_AVAILABLE
(
mt
);

144  
	gmc_İs
[
mt
]->
mem_®loc
(
h_±r
, 
size
, 
mem_ty³
);

147 
ucc_¡©us_t
 
	$ucc_mc_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
)

149 
ucc_memÜy_ty³_t
 
mt
 = (
h_±r
->mˆ=ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
) ?

150 
UCC_MEMORY_TYPE_CUDA
 : 
h_±r
->
mt
;

152 
	`UCC_CHECK_MC_AVAILABLE
(
mt
);

153  
mc_İs
[
mt
]->
	`mem_ä“
(
h_±r
);

154 
	}
}

156 
UCC_MC_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_mc_memıy
,

157 (
d¡
, 
¤c
, 
Ën
, 
d¡_mem
, 
¤c_mem
), *dst,

158 cÚ¡ *
¤c
, 
size_t
 
Ën
, 
ucc_memÜy_ty³_t
 
d¡_mem
,

159 
ucc_memÜy_ty³_t
 
¤c_mem
)

162 
ucc_memÜy_ty³_t
 
	gmt
;

163 ià(
	g¤c_mem
 =ğ
UCC_MEMORY_TYPE_UNKNOWN
 ||

164 
d¡_mem
 =ğ
UCC_MEMORY_TYPE_UNKNOWN
) {

165  
UCC_ERR_INVALID_PARAM
;

166 } ià(
	g¤c_mem
 =ğ
UCC_MEMORY_TYPE_HOST
 &&

167 
d¡_mem
 =ğ
UCC_MEMORY_TYPE_HOST
) {

168 
UCC_CHECK_MC_AVAILABLE
(
UCC_MEMORY_TYPE_HOST
);

169  
	gmc_İs
[
UCC_MEMORY_TYPE_HOST
]->
memıy
(
d¡
, 
¤c
, 
Ën
,

170 
UCC_MEMORY_TYPE_HOST
,

171 
UCC_MEMORY_TYPE_HOST
);

174 
	gmt
 = (
d¡_mem
 =ğ
UCC_MEMORY_TYPE_HOST
è? 
¤c_mem
 : dst_mem;

175 
	gmt
 = (
mt
 =ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
è? 
UCC_MEMORY_TYPE_CUDA
 : mt;

176 
UCC_CHECK_MC_AVAILABLE
(
mt
);

177  
	gmc_İs
[
mt
]->
memıy
(
d¡
, 
¤c
, 
Ën
, 
d¡_mem
, 
¤c_mem
);

180 
ucc_¡©us_t
 
	$ucc_mc_mem£t
(*
±r
, 
v®ue
, 
size_t
 
size
,

181 
ucc_memÜy_ty³_t
 
mem_ty³
)

183 
mem_ty³
 = (mem_ty³ =ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
) ?

184 
UCC_MEMORY_TYPE_CUDA
 : 
mem_ty³
;

186 
	`UCC_CHECK_MC_AVAILABLE
(
mem_ty³
);

187  
mc_İs
[
mem_ty³
]->
	`mem£t
(
±r
, 
v®ue
, 
size
);

188 
	}
}

190 
ucc_¡©us_t
 
	$ucc_mc_æush
(
ucc_memÜy_ty³_t
 
mem_ty³
)

192 
mem_ty³
 = (mem_ty³ =ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
) ?

193 
UCC_MEMORY_TYPE_CUDA
 : 
mem_ty³
;

195 
	`UCC_CHECK_MC_AVAILABLE
(
mem_ty³
);

196 ià(
mc_İs
[
mem_ty³
]->
æush
) {

197  
mc_İs
[
mem_ty³
]->
	`æush
();

199  
UCC_OK
;

200 
	}
}

202 
ucc_¡©us_t
 
	$ucc_mc_fš®ize
()

204 
ucc_memÜy_ty³_t
 
mt
;

205 
ucc_mc_ba£_t
 *
mc
;

207 
mt
 = 
UCC_MEMORY_TYPE_HOST
; mˆ< 
UCC_MEMORY_TYPE_LAST
; mt++) {

208 ià(
NULL
 !ğ
mc_İs
[
mt
]) {

209 
mc
 = 
	`ucc_cÚš”_of
(
mc_İs
[
mt
], 
ucc_mc_ba£_t
, 
İs
);

210 
mc
->
»f_út
--;

211 ià(
mc
->
»f_út
 == 0) {

212 
mc
->
	`fš®ize
();

213 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(
mc
->
cÚfig
,

214 
mc
->
cÚfig_bË
.
bË
);

215 
	`ucc_ä“
(
mc
->
cÚfig
);

216 
mc_İs
[
mt
] = 
NULL
;

221  
UCC_OK
;

222 
	}
}

	@src/components/mc/ucc_mc.h

6 #iâdeà
UCC_MC_H_


7 
	#UCC_MC_H_


	)

9 
	~"ucc/­i/ucc.h
"

10 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

11 
	~"cÜe/ucc_dt.h
"

12 
	~"uts/ucc_m©h.h
"

14 
ucc_¡©us_t
 
ucc_mc_š™
(cÚ¡ 
ucc_mc_·¿ms_t
 *
mc_·¿ms
);

16 
ucc_¡©us_t
 
ucc_mc_fš®ize
();

18 
ucc_¡©us_t
 
ucc_mc_avaabË
(
ucc_memÜy_ty³_t
 
mem_ty³
);

25 
ucc_¡©us_t
 
ucc_mc_g‘_mem_©Œ
(cÚ¡ *
±r
, 
ucc_mem_©Œ_t
 *
mem_©Œ
);

27 
ucc_¡©us_t
 
ucc_mc_g‘_©Œ
(
ucc_mc_©Œ_t
 *
©Œ
, 
ucc_memÜy_ty³_t
 
mem_ty³
);

29 
ucc_¡©us_t
 
ucc_mc_®loc
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
, 
size_t
 
Ën
,

30 
ucc_memÜy_ty³_t
 
mem_ty³
);

32 
ucc_¡©us_t
 
ucc_mc_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
);

34 
ucc_¡©us_t
 
ucc_mc_æush
(
ucc_memÜy_ty³_t
 
mem_ty³
);

36 
ucc_¡©us_t
 
ucc_mc_memıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
Ën
,

37 
ucc_memÜy_ty³_t
 
d¡_mem
,

38 
ucc_memÜy_ty³_t
 
¤c_mem
);

40 
ucc_¡©us_t
 
ucc_mc_mem£t
(*
±r
, 
v®ue
, 
size_t
 
size
,

41 
ucc_memÜy_ty³_t
 
mem_ty³
);

	@src/components/mc/ucc_mc_log.h

7 #iâdeà
UCC_MC_LOG_H_


8 
	#UCC_MC_LOG_H_


	)

10 
	~"uts/ucc_log.h
"

12 
	#ucc_log_compÚ’t_mc
(
_mc
, 
_Ëv–
, 
fmt
, ...) \

13 
	`ucc_log_compÚ’t
(
_Ëv–
, ((
_mc
)->
cÚfig
)->
log_compÚ’t
, \

14 
fmt
, ##
__VA_ARGS__
)

	)

16 
	#mc_”rÜ
(
_mc
, 
_fmt
, ...) \

17 
	`ucc_log_compÚ’t_mc
(
_mc
, 
UCC_LOG_LEVEL_ERROR
, 
_fmt
, ##
__VA_ARGS__
)

	)

18 
	#mc_w¬n
(
_mc
, 
_fmt
, ...) \

19 
	`ucc_log_compÚ’t_mc
(
_mc
, 
UCC_LOG_LEVEL_WARN
, 
_fmt
, ##
__VA_ARGS__
)

	)

20 
	#mc_šfo
(
_mc
, 
_fmt
, ...) \

21 
	`ucc_log_compÚ’t_mc
(
_mc
, 
UCC_LOG_LEVEL_INFO
, 
_fmt
, ##
__VA_ARGS__
)

	)

22 
	#mc_debug
(
_mc
, 
_fmt
, ...) \

23 
	`ucc_log_compÚ’t_mc
(
_mc
, 
UCC_LOG_LEVEL_DEBUG
, 
_fmt
, ##
__VA_ARGS__
)

	)

24 
	#mc_Œaû
(
_mc
, 
_fmt
, ...) \

25 
	`ucc_log_compÚ’t_mc
(
_mc
, 
UCC_LOG_LEVEL_TRACE
, 
_fmt
, ##
__VA_ARGS__
)

	)

	@src/components/tl/cuda/allgather/allgather.c

7 
	~"®lg©h”.h
"

8 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__cuda_®lg©h”_®gs
[
UCC_TL_CUDA_ALLGATHER_ALG_LAST
 + 1] = {

12 [
UCC_TL_CUDA_ALLGATHER_ALG_AUTO
] =

13 {.
id
 = 
UCC_TL_CUDA_ALLGATHER_ALG_AUTO
,

14 .
	gÇme
 = "auto",

15 .
	gdesc
 = "choose‡llgather‡lgorithm based on CUDAopology"},

16 [
UCC_TL_CUDA_ALLGATHER_ALG_RING
] =

17 {.
id
 = 
UCC_TL_CUDA_ALLGATHER_ALG_RING
,

18 .
	gÇme
 = "ring",

19 .
	gdesc
 = "multiring‡llgather‡lgorithm"},

20 [
UCC_TL_CUDA_ALLGATHER_ALG_LINEAR
] =

21 {.
id
 = 
UCC_TL_CUDA_ALLGATHER_ALG_LINEAR
,

22 .
	gÇme
 = "linear",

23 .
	gdesc
 = "linear‡llgather‡lgorithm"},

24 [
UCC_TL_CUDA_ALLGATHER_ALG_LAST
] = {

25 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

27 
size_t
 
	$ucc__cuda_®lg©h”_g‘_couÁ
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

28 
ucc_¿nk_t
 
block
)

30  
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
couÁ
 / 
	`UCC_TL_TEAM_SIZE
(
	`TASK_TEAM
(task));

31 
	}
}

33 
size_t
 
	$ucc__cuda_®lg©h”_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

34 
ucc_¿nk_t
 
block
)

36  (
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
couÁ
 /

37 
	`UCC_TL_TEAM_SIZE
(
	`TASK_TEAM
(
sk
))) *

38 
block
;

39 
	}
}

41 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

42 
ucc_ba£_‹am_t
 *
_‹am
,

43 
ucc_cŞl_sk_t
 **
sk_p
)

45 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

47 ià(
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
)) {

48  
	`ucc__cuda_®lg©h”_lš—r_š™
(
cŞl_¬gs
, 
_‹am
, 
sk_p
);

50  
	`ucc__cuda_®lg©h”_ršg_š™
(
cŞl_¬gs
, 
_‹am
, 
sk_p
);

52 
	}
}

	@src/components/tl/cuda/allgather/allgather.h

7 #iâdeà
ALLGATHER_H_


8 
	#ALLGATHER_H_


	)

10 
	~"_cuda.h
"

11 
	~"_cuda_cŞl.h
"

15 
	mUCC_TL_CUDA_ALLGATHER_ALG_AUTO
,

16 
	mUCC_TL_CUDA_ALLGATHER_ALG_RING
,

17 
	mUCC_TL_CUDA_ALLGATHER_ALG_LINEAR
,

18 
	mUCC_TL_CUDA_ALLGATHER_ALG_LAST


21 
ucc_ba£_cŞl_®g_šfo_t


22 
ucc__cuda_®lg©h”_®gs
[
UCC_TL_CUDA_ALLGATHER_ALG_LAST
 + 1];

24 
	#UCC_TL_CUDA_ALLGATHER_DEFAULT_ALG_SELECT_STR
 "®lg©h”:cuda:@0"

	)

26 
size_t
 
ucc__cuda_®lg©h”_g‘_couÁ
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

27 
ucc_¿nk_t
 
block
);

29 
size_t
 
ucc__cuda_®lg©h”_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

30 
ucc_¿nk_t
 
block
);

32 
ucc_¡©us_t
 
ucc__cuda_®lg©h”_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

33 
ucc_ba£_‹am_t
 *
_‹am
,

34 
ucc_cŞl_sk_t
 **
sk_p
);

36 
ucc_¡©us_t
 
ucc__cuda_®lg©h”_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

37 
ucc_ba£_‹am_t
 * 
_‹am
,

38 
ucc_cŞl_sk_t
 ** 
sk_p
);

40 
ucc_¡©us_t
 
ucc__cuda_®lg©h”_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

41 
ucc_ba£_‹am_t
 * 
_‹am
,

42 
ucc_cŞl_sk_t
 ** 
sk_p
);

44 
šlše
 
	$ucc__cuda_®lg©h”_®g_äom_¡r
(cÚ¡ *
¡r
)

46 
i
;

47 
i
 = 0; i < 
UCC_TL_CUDA_ALLGATHER_ALG_LAST
; i++) {

48 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__cuda_®lg©h”_®gs
[
i
].
Çme
)) {

52  
i
;

53 
	}
}

	@src/components/tl/cuda/allgather/allgather_linear.c

7 
	~"®lg©h”v/®lg©h”v.h
"

8 
	~"®lg©h”/®lg©h”.h
"

10 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

11 
ucc_ba£_‹am_t
 * 
_‹am
,

12 
ucc_cŞl_sk_t
 ** 
sk_p
)

14 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

15 
ucc__cuda_sk_t
 *
sk
;

16 
ucc_¡©us_t
 
¡©us
;

18 ià(
	`ucc_uÆik–y
(!
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
) ||

19 
	`UCC_TL_TEAM_SIZE
(
‹am
è- 1 > 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
)) {

20  
UCC_ERR_NOT_SUPPORTED
;

23 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

24 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

25  
¡©us
;

28 
sk
->
®lg©h”v_lš—r
.
g‘_couÁ
 = 
ucc__cuda_®lg©h”_g‘_couÁ
;

29 
sk
->
®lg©h”v_lš—r
.
g‘_off£t
 = 
ucc__cuda_®lg©h”_g‘_off£t
;

30 
sk
->
®lg©h”v_lš—r
.
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

31 
sk
->
®lg©h”v_lš—r
.
sbuf
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
bufãr
;

32 
sk
->
®lg©h”v_lš—r
.
rbuf
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
bufãr
;

34 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

35 
sk
->
su³r
.
po¡
 = 
ucc__cuda_®lg©h”v_lš—r_¡¬t
;

36 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_®lg©h”v_lš—r_´og»ss
;

37 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_®lg©h”v_lš—r_fš®ize
;

38 
sk
->
b¬
 = 
	`TASK_BAR
(task);

40 *
sk_p
 = &
sk
->
su³r
;

41  
UCC_OK
;

42 
	}
}

	@src/components/tl/cuda/allgather/allgather_ring.c

8 
	~"®lg©h”v/®lg©h”v.h
"

9 
	~"®lg©h”/®lg©h”.h
"

11 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

12 
ucc_ba£_‹am_t
 * 
_‹am
,

13 
ucc_cŞl_sk_t
 ** 
sk_p
)

15 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

16 
ucc__cuda_sk_t
 *
sk
;

17 
ucc_¡©us_t
 
¡©us
;

19 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

20 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

21  
¡©us
;

24 
sk
->
®lg©h”v_ršg
.
g‘_couÁ
 = 
ucc__cuda_®lg©h”_g‘_couÁ
;

25 
sk
->
®lg©h”v_ršg
.
g‘_off£t
 = 
ucc__cuda_®lg©h”_g‘_off£t
;

26 
sk
->
®lg©h”v_ršg
.
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

27 
sk
->
®lg©h”v_ršg
.
sbuf
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
bufãr
;

28 
sk
->
®lg©h”v_ršg
.
rbuf
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
bufãr
;

30 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

31 
sk
->
su³r
.
po¡
 = 
ucc__cuda_®lg©h”v_ršg_¡¬t
;

32 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_®lg©h”v_ršg_´og»ss
;

33 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_®lg©h”v_ršg_fš®ize
;

34 
sk
->
b¬
 = 
	`TASK_BAR
(task);

36 *
sk_p
 = &
sk
->
su³r
;

37  
UCC_OK
;

38 
	}
}

	@src/components/tl/cuda/allgatherv/allgatherv.c

7 
	~"®lg©h”v.h
"

8 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__cuda_®lg©h”v_®gs
[
UCC_TL_CUDA_ALLGATHERV_ALG_LAST
 + 1] = {

12 [
UCC_TL_CUDA_ALLGATHERV_ALG_AUTO
] =

13 {.
id
 = 
UCC_TL_CUDA_ALLGATHERV_ALG_AUTO
,

14 .
	gÇme
 = "auto",

15 .
	gdesc
 = "choose‡llgatherv‡lgorithm based on CUDAopology"},

16 [
UCC_TL_CUDA_ALLGATHERV_ALG_RING
] =

17 {.
id
 = 
UCC_TL_CUDA_ALLGATHERV_ALG_RING
,

18 .
	gÇme
 = "ring",

19 .
	gdesc
 = "multiring‡llgatherv‡lgorithm"},

20 [
UCC_TL_CUDA_ALLGATHERV_ALG_LINEAR
] =

21 {.
id
 = 
UCC_TL_CUDA_ALLGATHERV_ALG_LINEAR
,

22 .
	gÇme
 = "linear",

23 .
	gdesc
 = "linear‡llgatherv‡lgorithm"},

24 [
UCC_TL_CUDA_ALLGATHERV_ALG_LAST
] = {

25 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

27 
size_t
 
	$ucc__cuda_®lg©h”v_g‘_couÁ
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

28 
ucc_¿nk_t
 
block
)

30 cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

32  
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
block
);

33 
	}
}

35 
size_t
 
	$ucc__cuda_®lg©h”v_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

36 
ucc_¿nk_t
 
block
)

38 cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

40  
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

41 
block
);

42 
	}
}

44 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

45 
ucc_ba£_‹am_t
 * 
_‹am
,

46 
ucc_cŞl_sk_t
 ** 
sk_p
)

48 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

50 ià(
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
)) {

51  
	`ucc__cuda_®lg©h”v_lš—r_š™
(
cŞl_¬gs
, 
_‹am
, 
sk_p
);

53  
	`ucc__cuda_®lg©h”v_ršg_š™
(
cŞl_¬gs
, 
_‹am
, 
sk_p
);

55 
	}
}

	@src/components/tl/cuda/allgatherv/allgatherv.h

7 #iâdeà
ALLGATHERV_H_


8 
	#ALLGATHERV_H_


	)

10 
	~"_cuda.h
"

11 
	~"_cuda_cŞl.h
"

15 
	mUCC_TL_CUDA_ALLGATHERV_ALG_AUTO
,

16 
	mUCC_TL_CUDA_ALLGATHERV_ALG_RING
,

17 
	mUCC_TL_CUDA_ALLGATHERV_ALG_LINEAR
,

18 
	mUCC_TL_CUDA_ALLGATHERV_ALG_LAST


21 
ucc_ba£_cŞl_®g_šfo_t


22 
ucc__cuda_®lg©h”v_®gs
[
UCC_TL_CUDA_ALLGATHERV_ALG_LAST
 + 1];

24 
	#UCC_TL_CUDA_ALLGATHERV_DEFAULT_ALG_SELECT_STR
 "®lg©h”v:cuda:@0"

	)

26 
ucc_¡©us_t
 
ucc__cuda_®lg©h”v_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

27 
ucc_ba£_‹am_t
 * 
_‹am
,

28 
ucc_cŞl_sk_t
 ** 
sk_p
);

30 
size_t
 
ucc__cuda_®lg©h”v_g‘_couÁ
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

31 
ucc_¿nk_t
 
block
);

33 
size_t
 
ucc__cuda_®lg©h”v_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

34 
ucc_¿nk_t
 
block
);

37 
ucc_¡©us_t
 
ucc__cuda_®lg©h”v_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

38 
ucc_ba£_‹am_t
 * 
_‹am
,

39 
ucc_cŞl_sk_t
 ** 
sk_p
);

41 
ucc_¡©us_t
 
ucc__cuda_®lg©h”v_ršg_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

43 
ucc__cuda_®lg©h”v_ršg_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

45 
ucc_¡©us_t
 
ucc__cuda_®lg©h”v_ršg_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

48 
ucc_¡©us_t
 
ucc__cuda_®lg©h”v_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

49 
ucc_ba£_‹am_t
 * 
_‹am
,

50 
ucc_cŞl_sk_t
 ** 
sk_p
);

52 
ucc_¡©us_t
 
ucc__cuda_®lg©h”v_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

54 
ucc__cuda_®lg©h”v_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

56 
ucc_¡©us_t
 
ucc__cuda_®lg©h”v_lš—r_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

58 
šlše
 
	$ucc__cuda_®lg©h”v_®g_äom_¡r
(cÚ¡ *
¡r
)

60 
i
;

61 
i
 = 0; i < 
UCC_TL_CUDA_ALLGATHERV_ALG_LAST
; i++) {

62 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__cuda_®lg©h”v_®gs
[
i
].
Çme
)) {

66  
i
;

67 
	}
}

	@src/components/tl/cuda/allgatherv/allgatherv_linear.c

7 
	~"®lg©h”v.h
"

8 
	~"compÚ’ts/ec/ucc_ec.h
"

9 
	~"_cuda_ÿche.h
"

10 
	~"uts/¬ch/ıu.h
"

11 
	~"uts/¬ch/cuda_def.h
"

51 
	mSTAGE_SYNC
,

52 
	mSTAGE_SETUP
,

53 
	mSTAGE_COPIES
,

54 
	mSTAGE_BARRIER
,

58 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_lš—r_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

60 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

62 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizingask %p",ask);

63 
	`ucc__cuda_sk_put
(
sk
);

64  
UCC_OK
;

65 
	}
}

67 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_lš—r_£tup_¡¬t
(
ucc__cuda_sk_t
 *
sk
)

69 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

70 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

71 
ucc_¡©us_t
 
¡©us
;

73 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 0, 0);

74 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

75 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

76 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

77 
ex™_”r
;

80  
UCC_OK
;

82 
ex™_”r
:

83  
¡©us
;

84 
	}
}

86 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_lš—r_£tup_‹¡
(
ucc__cuda_sk_t
 *
sk
)

88 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

89  
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

90 
	}
}

92 
šlše
 
size_t
 
	$g‘_sü©ch_size
(
ucc__cuda_‹am_t
 *
‹am
,

93 
ucc_d©©y³_t
 
dt
)

95 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

96 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

97 
size_t
 
div
;

99 
	`ucc_as£¹
((
dt_size
 > 0è&& (
tsize
 > 0));

101 
div
 = 2 * 
dt_size
 * 
tsize
;

102  (
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
)->
cfg
.
sü©ch_size
 / 
div
) * div;

103 
	}
}

105 
šlše
 
size_t
 
	$g‘_sü©ch_off£t
(
ucc__cuda_‹am_t
 *
‹am
,

106 
ucc_d©©y³_t
 
dt
, 
block
)

108 
size_t
 
¡•_ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
dt
) / 2;

109 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

111  
	`ucc_bufãr_block_off£t
(
¡•_ssize
, 
tsize
, 
block
);

112 
	}
}

114 
šlše
 
ucc_¡©us_t
 
	$ecİy
(*
d¡
, *
¤c
, 
size_t
 
size
,

115 
ucc_“_executÜ_t
 * 
exec
,

116 
ucc_“_executÜ_sk_t
 **
‘ask
)

118 
ucc_“_executÜ_sk_¬gs_t
 
exec_¬gs
 = {0};

120 
exec_¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

121 
exec_¬gs
.
cİy
.
d¡
 = dst;

122 
exec_¬gs
.
cİy
.
¤c
 = src;

123 
exec_¬gs
.
cİy
.
Ën
 = 
size
;

124  
	`ucc_“_executÜ_sk_po¡
(
exec
, &
exec_¬gs
, 
‘ask
);

125 
	}
}

127 
ucc_¡©us_t


128 
	$ucc__cuda_®lg©h”v_lš—r_´og»ss_äag
(
ucc__cuda_sk_t
 *
sk
)

130 
ucc__cuda_‹am_t
 * 
‹am
 = 
	`TASK_TEAM
(
sk
);

131 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

132 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

133 
ucc_cŞl_¬gs_t
 * 
¬gs
 = &
	`TASK_ARGS
(
sk
);

134 
ucc_d©©y³_t
 
dt
 = 
sk
->
®lg©h”v_lš—r
.dt;

135 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

136 
size_t
 
ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
dt
);

137 
näags
 = 
sk
->
®lg©h”v_lš—r
.
num_äags
;

138 
num_¡•s
 = 
näags
 + 1;

139 
ucc_“_executÜ_sk_t
 *
‘ask
;

140 
ucc_“_executÜ_t
 * 
exec
;

141 
ucc_¡©us_t
 
¡
;

142 
¡•
, 
i
;

143 * 
sbuf
, *
dbuf
;

144 
ucc_¿nk_t
 
³”
;

145 
size_t
 
£nd_size
, 
äag_size
, 
äag_off£t
, 
loÿl_off£t
, 
»mÙe_off£t
,

146 
sü©ch_off£t
, 
¿nk_off£t
;

147 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

149 
¡
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

150 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

151  
¡
;

154 
¡•
 = 
	`g‘_¿nk_¡•
(
sk
, 
Œªk
, 0);

155 
¡•
 < 
num_¡•s
) {

156 ià((
sk
->
®lg©h”v_lš—r
.
exec_sk
[0] !ğ
NULL
) ||

157 (
sk
->
®lg©h”v_lš—r
.
exec_sk
[1] !ğ
NULL
)) {

158 
i
 = 0; i < 2; i++) {

159 
‘ask
 = 
sk
->
®lg©h”v_lš—r
.
exec_sk
[
i
];

160 ià(
‘ask
 !ğ
NULL
) {

161 
¡
 = 
	`ucc_“_executÜ_sk_‹¡
(
‘ask
);

162 ià(
¡
 =ğ
UCC_OK
) {

163 
	`ucc_“_executÜ_sk_fš®ize
(
‘ask
);

164 
sk
->
®lg©h”v_lš—r
.
exec_sk
[
i
] = 
NULL
;

166 ià(
	`ucc_lik–y
(
¡
 > 0)) {

167  
UCC_INPROGRESS
;

169  
¡
;

173 
¡•
++;

174 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 
¡•
, 0);

178 
i
 = 0; i < 
tsize
; i++) {

179 ià(
	`g‘_¿nk_¡•
(
sk
, 
i
, 0è< 
¡•
) {

180  
UCC_INPROGRESS
;

184 ià(
¡•
 % 2) {

185 
»mÙe_off£t
 = 
ssize
 / 2;

186 
loÿl_off£t
 = 0;

188 
»mÙe_off£t
 = 0;

189 
loÿl_off£t
 = 
ssize
 / 2;

192 ià(
¡•
 == 0) {

193 
£nd_size
 = 
sk
->
®lg©h”v_lš—r
.
	`g‘_couÁ
Ñask, 
Œªk
);

194 
äag_size
 =

195 
	`ucc_bufãr_block_couÁ
(
£nd_size
, 
näags
, 
¡•
è* 
dt_size
;

196 
äag_off£t
 =

197 
	`ucc_bufãr_block_off£t
(
£nd_size
, 
näags
, 
¡•
è* 
dt_size
;

198 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

199 
¿nk_off£t
 =

200 
sk
->
®lg©h”v_lš—r
.
	`g‘_off£t
Ñask, 
Œªk
è* 
dt_size
;

201 
sbuf
 = 
	`PTR_OFFSET
(
sk
->
®lg©h”v_lš—r
.
rbuf
,

202 
äag_off£t
 + 
¿nk_off£t
);

204 
sbuf
 = 
	`PTR_OFFSET
(
sk
->
®lg©h”v_lš—r
.sbuf, 
äag_off£t
);

206 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
;

207 
i
 = 0; i < 
tsize
 - 1; i++) {

208 
³”
 = (
Œªk
 + 
i
 + 1è% 
tsize
;

209 
sü©ch_off£t
 = 
	`g‘_sü©ch_off£t
(
‹am
, 
dt
, 
Œªk
);

210 
dbuf
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
³”
),

211 
»mÙe_off£t
 + 
sü©ch_off£t
);

212 
—rgs
.
cİy_muÉi
.
¤c
[
i
] = 
sbuf
;

213 
—rgs
.
cİy_muÉi
.
d¡
[
i
] = 
dbuf
;

214 
—rgs
.
cİy_muÉi
.
couÁs
[
i
] = 
äag_size
;

216 
—rgs
.
cİy_muÉi
.
num_veùÜs
 = 
tsize
 - 1;

217 
¡
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
,

218 &
sk
->
®lg©h”v_lš—r
.
exec_sk
[0]);

219 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

220  
¡
;

222 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

223 
¿nk_off£t
 =

224 
sk
->
®lg©h”v_lš—r
.
	`g‘_off£t
Ñask, 
Œªk
è* 
dt_size
;

225 
dbuf
 = 
	`PTR_OFFSET
(
sk
->
®lg©h”v_lš—r
.
rbuf
, 
¿nk_off£t
);

227 
¡
 = 
	`ecİy
(
dbuf
, 
sbuf
,

228 
sk
->
®lg©h”v_lš—r
.
	`g‘_couÁ
Ñask, 
Œªk
) *

229 
dt_size
,

230 
exec
, &
sk
->
®lg©h”v_lš—r
.
exec_sk
[1]);

231 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

232  
¡
;

235 } ià(
¡•
 =ğ(
num_¡•s
 - 1)) {

236 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
;

237 
i
 = 0; i < 
tsize
 - 1; i++) {

238 
³”
 = (
Œªk
 + 
i
 + 1è% 
tsize
;

239 
sü©ch_off£t
 = 
	`g‘_sü©ch_off£t
(
‹am
, 
dt
, 
³”
);

240 
¿nk_off£t
 =

241 
sk
->
®lg©h”v_lš—r
.
	`g‘_off£t
Ñask, 
³”
è* 
dt_size
;

242 
£nd_size
 = 
sk
->
®lg©h”v_lš—r
.
	`g‘_couÁ
Ñask, 
³”
);

243 
äag_off£t
 =

244 
	`ucc_bufãr_block_off£t
(
£nd_size
, 
näags
, 
¡•
 - 1) *

245 
dt_size
;

246 
äag_size
 =

247 
	`ucc_bufãr_block_couÁ
(
£nd_size
, 
näags
, 
¡•
 - 1) *

248 
dt_size
;

249 
sbuf
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
Œªk
),

250 
loÿl_off£t
 + 
sü©ch_off£t
);

251 
dbuf
 = 
	`PTR_OFFSET
(
sk
->
®lg©h”v_lš—r
.
rbuf
,

252 
¿nk_off£t
 + 
äag_off£t
);

253 
—rgs
.
cİy_muÉi
.
¤c
[
i
] = 
sbuf
;

254 
—rgs
.
cİy_muÉi
.
d¡
[
i
] = 
dbuf
;

255 
—rgs
.
cİy_muÉi
.
couÁs
[
i
] = 
äag_size
;

257 
—rgs
.
cİy_muÉi
.
num_veùÜs
 = 
tsize
 - 1;

258 
¡
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
,

259 &
sk
->
®lg©h”v_lš—r
.
exec_sk
[0]);

260 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

261  
¡
;

264 
£nd_size
 = 
sk
->
®lg©h”v_lš—r
.
	`g‘_couÁ
Ñask, 
Œªk
);

265 
äag_size
 =

266 
	`ucc_bufãr_block_couÁ
(
£nd_size
, 
näags
, 
¡•
è* 
dt_size
;

267 
äag_off£t
 =

268 
	`ucc_bufãr_block_off£t
(
£nd_size
, 
näags
, 
¡•
è* 
dt_size
;

269 
¿nk_off£t
 =

270 
sk
->
®lg©h”v_lš—r
.
	`g‘_off£t
Ñask, 
Œªk
è* 
dt_size
;

271 
sbuf
 = 
	`PTR_OFFSET
(
sk
->
®lg©h”v_lš—r
.
rbuf
,

272 
¿nk_off£t
 + 
äag_off£t
);

273 
sü©ch_off£t
 = 
	`g‘_sü©ch_off£t
(
‹am
, 
dt
, 
Œªk
);

274 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
;

275 
i
 = 0; i < 
tsize
 - 1; i++) {

276 
³”
 = (
Œªk
 + 
i
 + 1è% 
tsize
;

277 
dbuf
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
³”
),

278 
»mÙe_off£t
 + 
sü©ch_off£t
);

279 
—rgs
.
cİy_muÉi
.
¤c
[
i
] = 
sbuf
;

280 
—rgs
.
cİy_muÉi
.
d¡
[
i
] = 
dbuf
;

281 
—rgs
.
cİy_muÉi
.
couÁs
[
i
] = 
äag_size
;

283 
—rgs
.
cİy_muÉi
.
num_veùÜs
 = 
tsize
 - 1;

284 
¡
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
,

285 &
sk
->
®lg©h”v_lš—r
.
exec_sk
[0]);

286 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

287  
¡
;

290 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
;

291 
i
 = 0; i < 
tsize
 - 1; i++) {

292 
³”
 = (
Œªk
 + 
i
 + 1è% 
tsize
;

293 
sü©ch_off£t
 = 
	`g‘_sü©ch_off£t
(
‹am
, 
dt
, 
³”
);

294 
¿nk_off£t
 =

295 
sk
->
®lg©h”v_lš—r
.
	`g‘_off£t
Ñask, 
³”
è* 
dt_size
;

296 
£nd_size
 = 
sk
->
®lg©h”v_lš—r
.
	`g‘_couÁ
Ñask, 
³”
);

297 
äag_off£t
 =

298 
	`ucc_bufãr_block_off£t
(
£nd_size
, 
näags
, 
¡•
 - 1) *

299 
dt_size
;

300 
äag_size
 =

301 
	`ucc_bufãr_block_couÁ
(
£nd_size
, 
näags
, 
¡•
 - 1) *

302 
dt_size
;

303 
sbuf
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
Œªk
),

304 
loÿl_off£t
 + 
sü©ch_off£t
);

305 
dbuf
 = 
	`PTR_OFFSET
(
sk
->
®lg©h”v_lš—r
.
rbuf
,

306 
¿nk_off£t
 + 
äag_off£t
);

307 
—rgs
.
cİy_muÉi
.
¤c
[
i
] = 
sbuf
;

308 
—rgs
.
cİy_muÉi
.
d¡
[
i
] = 
dbuf
;

309 
—rgs
.
cİy_muÉi
.
couÁs
[
i
] = 
äag_size
;

311 
—rgs
.
cİy_muÉi
.
num_veùÜs
 = 
tsize
 - 1;

312 
¡
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
,

313 &
sk
->
®lg©h”v_lš—r
.
exec_sk
[1]);

314 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

315  
¡
;

320  
UCC_OK
;

321 
	}
}

323 
	$ucc__cuda_®lg©h”v_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

325 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

326 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

327 
ucc_¡©us_t
 
¡
;

329 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

330 
sk
->
®lg©h”v_lš—r
.
¡age
) {

331 
STAGE_SYNC
:

332 ià(
	`ucc__cuda_g‘_sync
(
sk
è!ğ
UCC_OK
) {

333 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

336 
¡
 = 
	`ucc__cuda_®lg©h”v_lš—r_£tup_¡¬t
(
sk
);

337 ià(
¡
 !ğ
UCC_OK
) {

338 
sk
->
su³r
.
¡©us
 = 
¡
;

341 
sk
->
®lg©h”v_lš—r
.
¡age
 = 
STAGE_SETUP
;

342 
STAGE_SETUP
:

343 
¡
 = 
	`ucc__cuda_®lg©h”v_lš—r_£tup_‹¡
(
sk
);

344 ià(
¡
 !ğ
UCC_OK
) {

345 
sk
->
su³r
.
¡©us
 = 
¡
;

348 
sk
->
®lg©h”v_lš—r
.
¡age
 = 
STAGE_COPIES
;

349 
STAGE_COPIES
:

350 
¡
 = 
	`ucc__cuda_®lg©h”v_lš—r_´og»ss_äag
(
sk
);

351 ià(
¡
 !ğ
UCC_OK
) {

352 
sk
->
su³r
.
¡©us
 = 
¡
;

356 
¡
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

357 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

358 
sk
->
su³r
.
¡©us
 = 
¡
;

361 
sk
->
®lg©h”v_lš—r
.
¡age
 = 
STAGE_BARRIER
;

363 
	`ucc_as£¹
(
sk
->
®lg©h”v_lš—r
.
¡age
 =ğ
STAGE_BARRIER
);

366 
sk
->
su³r
.
¡©us
 =

367 
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

368 ià(
sk
->
su³r
.
¡©us
 =ğ
UCC_OK
) {

369 
	`ucc__cuda_put_sync
(
sk
);

371 
	}
}

373 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

375 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

376 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

377 
ucc_cŞl_¬gs_t
 * 
¬gs
 = &
	`TASK_ARGS
(
sk
);

378 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

379 
ucc_d©©y³_t
 
dt
 = 
sk
->
®lg©h”v_lš—r
.dt;

380 
ucc_¿nk_t
 
i
;

381 
size_t
 
£nd_size
, 
äag_size
, 
ssize
;

383 
sk
->
®lg©h”v_lš—r
.
¡age
 = 
STAGE_SYNC
;

384 
sk
->
®lg©h”v_lš—r
.
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

385 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHERV
) {

386 
sk
->
®lg©h”v_lš—r
.
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

388 
sk
->
®lg©h”v_lš—r
.
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

391 
£nd_size
 = 
sk
->
®lg©h”v_lš—r
.
	`g‘_couÁ
(task, 0);

392 
i
 = 1; i < 
tsize
; i++) {

393 
£nd_size
 =

394 
	`ucc_max
(
£nd_size
, 
sk
->
®lg©h”v_lš—r
.
	`g‘_couÁ
Ñask, 
i
));

397 ià(
£nd_size
 == 0) {

398 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

399  
	`ucc_sk_com¶‘e
(&
sk
->
su³r
);

402 
ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
dt
);

403 
äag_size
 = 
	`ucc_mš
(
ssize
 / 2 / 
	`ucc_dt_size
(
dt
è/ 
tsize
, 
£nd_size
);

404 
sk
->
®lg©h”v_lš—r
.
num_äags
 = 
	`ucc_div_round_up
(
£nd_size
, 
äag_size
);

405 
sk
->
®lg©h”v_lš—r
.
exec_sk
[0] = 
NULL
;

406 
sk
->
®lg©h”v_lš—r
.
exec_sk
[1] = 
NULL
;

408  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

409 
	}
}

411 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

412 
ucc_ba£_‹am_t
 * 
_‹am
,

413 
ucc_cŞl_sk_t
 ** 
sk_p
)

415 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

416 
ucc__cuda_sk_t
 *
sk
;

417 
ucc_¡©us_t
 
¡©us
;

419 ià(
	`ucc_uÆik–y
(!
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
) ||

420 
	`UCC_TL_TEAM_SIZE
(
‹am
è- 1 > 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
)) {

421  
UCC_ERR_NOT_SUPPORTED
;

424 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

425 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

426  
¡©us
;

429 
sk
->
®lg©h”v_lš—r
.
g‘_couÁ
 = 
ucc__cuda_®lg©h”v_g‘_couÁ
;

430 
sk
->
®lg©h”v_lš—r
.
g‘_off£t
 = 
ucc__cuda_®lg©h”v_g‘_off£t
;

431 
sk
->
®lg©h”v_lš—r
.
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo_v
.
d©©y³
;

432 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

433 
sk
->
su³r
.
po¡
 = 
ucc__cuda_®lg©h”v_lš—r_¡¬t
;

434 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_®lg©h”v_lš—r_´og»ss
;

435 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_®lg©h”v_lš—r_fš®ize
;

436 
sk
->
b¬
 = 
	`TASK_BAR
(task);

438 *
sk_p
 = &
sk
->
su³r
;

439  
UCC_OK
;

440 
	}
}

	@src/components/tl/cuda/allgatherv/allgatherv_ring.c

7 
	~"®lg©h”v.h
"

8 
	~"compÚ’ts/ec/ucc_ec.h
"

9 
	~"_cuda_ÿche.h
"

10 
	~"_cuda_ršg.h
"

11 
	~"uts/¬ch/ıu.h
"

12 
	~"uts/¬ch/cuda_def.h
"

14 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_ršg_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

16 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

18 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizingask %p",ask);

19 
	`ucc__cuda_sk_put
(
sk
);

20  
UCC_OK
;

21 
	}
}

23 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_ršg_£tup_¡¬t
(
ucc__cuda_sk_t
 *
sk
)

25 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

26 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

27 
ucc_¡©us_t
 
¡©us
;

28 
chunk
;

30 
chunk
 = 0; chunk < 
sk
->
®lg©h”v_ršg
.
num_chunks
; chunk++) {

31 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 0, 
chunk
);

33 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

34 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

35 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

36 
ex™_”r
;

39  
UCC_OK
;

41 
ex™_”r
:

42  
¡©us
;

43 
	}
}

45 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_ršg_£tup_‹¡
(
ucc__cuda_sk_t
 *
sk
)

47 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

48  
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

49 
	}
}

51 
šlše
 

52 
	$ucc__cuda_®lg©h”v_ršg_size_off£t
(
ucc__cuda_sk_t
 *
sk
, 
block
,

53 
äag
, 
chunk
, 
ršg
,

54 
size_t
 *
ršg_äag_size
,

55 
size_t
 *
block_off£t
, size_ˆ*
äag_off£t
,

56 
size_t
 *
chunk_off£t
, size_ˆ*
ršg_äag_off£t
)

58 
ucc_d©©y³_t
 
dt_size
 = 
	`ucc_dt_size
(
sk
->
®lg©h”v_ršg
.
dt
);

59 
Äšgs
 = 
sk
->
®lg©h”v_ršg
.
num_ršgs
;

60 
näags
 = 
sk
->
®lg©h”v_ršg
.
num_äags
;

61 
nchunks
 = 
sk
->
®lg©h”v_ršg
.
num_chunks
;

62 
size_t
 
block_size
, 
äag_size
, 
chunk_size
;

64 
block_size
 = 
sk
->
®lg©h”v_ršg
.
	`g‘_couÁ
Ñask, 
block
è* 
dt_size
;

65 
äag_size
 = 
	`ucc_bufãr_block_couÁ_®igÃd
(
block_size
, 
näags
, 
äag
, 64);

66 
chunk_size
 = 
	`ucc_bufãr_block_couÁ_®igÃd
(
äag_size
, 
nchunks
, 
chunk
, 64);

67 *
ršg_äag_size
 = 
	`ucc_bufãr_block_couÁ_®igÃd
(
chunk_size
, 
Äšgs
, 
ršg
, 64);

69 *
block_off£t
 = 
sk
->
®lg©h”v_ršg
.
	`g‘_off£t
Ñask, 
block
è* 
dt_size
;

70 *
äag_off£t
 = 
	`ucc_bufãr_block_off£t_®igÃd
(
block_size
, 
näags
, 
äag
, 64);

71 *
chunk_off£t
 = 
	`ucc_bufãr_block_off£t_®igÃd
(
äag_size
, 
nchunks
, 
chunk
, 64);

72 *
ršg_äag_off£t
 = 
	`ucc_bufãr_block_off£t_®igÃd
(
chunk_size
, 
Äšgs
, 
ršg
, 64);

73 
	}
}

75 
šlše
 

76 
	$ucc__cuda_check_³”s_»ady
(
ucc__cuda_sk_t
 *
sk
, 
chunk
, 
¡•
)

78 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

79 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

80 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

81 
n¡•s
 = (
tsize
 == 2) ?size:size - 1;

82 
Äšgs
 = 
sk
->
®lg©h”v_ršg
.
num_ršgs
;

83 
ršg
, 
l
, 
Î
, 
r
, 
¼
, 
sub¡•
;

84 
ucc_¿nk_t
 
³”
;

86 
sub¡•
 = 
¡•
 % 
n¡•s
;

87 
ršg
 = 0;„šg < 
Äšgs
;„ing++) {

88 
³”
 = 
	`g‘_£nd_to
(
‹am
, 
Œªk
, 
tsize
, 
ršg
);

89 
r
 = 
	`g‘_¿nk_¡•
(
sk
, 
³”
, 
chunk
);

91 
³”
 = 
	`g‘_£nd_to
(
‹am
,…“r, 
tsize
, 
ršg
);

92 
¼
 = 
	`g‘_¿nk_¡•
(
sk
, 
³”
, 
chunk
);

94 
³”
 = 
	`g‘_»cv_äom
(
‹am
, 
Œªk
, 
tsize
, 
ršg
);

95 
l
 = 
	`g‘_¿nk_¡•
(
sk
, 
³”
, 
chunk
);

97 
³”
 = 
	`g‘_»cv_äom
(
‹am
,…“r, 
tsize
, 
ršg
);

98 
Î
 = 
	`g‘_¿nk_¡•
(
sk
, 
³”
, 
chunk
);

100 ià(
sub¡•
 == 0) {

101 ià((
l
 < 
¡•
è|| (
r
 < s‹pè|| (
¼
 < step)) {

104 } ià(
sub¡•
 =ğ
n¡•s
 - 1) {

105 ià((
l
 < 
¡•
è|| (
r
 < s‹pè|| (
Î
 < step)) {

109 ià((
l
 < 
¡•
è|| (
r
 < step)) {

116 
	}
}

118 
šlše
 
size_t


119 
	$ucc__cuda_®lg©h”v_ršg_sü©ch_off£t
(
ucc__cuda_sk_t
 *
sk
, 
chunk
,

120 
ršg
)

122 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

123 
Äšgs
 = 
sk
->
®lg©h”v_ršg
.
num_ršgs
;

124 
nchunks
 = 
sk
->
®lg©h”v_ršg
.
num_chunks
;

125 
size_t
 
ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
Äšgs
, 
nchunks
, 1);

126 
size_t
 
chunk_size
, 
chunk_off£t
;

128 
chunk_size
 = 
	`ucc_bufãr_block_couÁ
(
ssize
/2, 
nchunks
, 
chunk
);

129 
chunk_off£t
 = 
	`ucc_bufãr_block_off£t
(
ssize
/2, 
nchunks
, 
chunk
);

130  
	`ucc_bufãr_block_off£t
(
chunk_size
, 
Äšgs
, 
ršg
è+ 
chunk_off£t
;

131 
	}
}

133 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_ršg_´og»ss_ršg
(
ucc__cuda_sk_t
 *
sk
,

134 
chunk
)

136 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

137 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

138 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

139 
tsize
 = ()
	`UCC_TL_TEAM_SIZE
(
‹am
);

140 *
rbuf
 = 
sk
->
®lg©h”v_ršg
.rbuf;

141 
n¡•s
 = (
tsize
 == 2) ?size:size - 1;

142 
Äšgs
 = 
sk
->
®lg©h”v_ršg
.
num_ršgs
;

143 
nchunks
 = 
sk
->
®lg©h”v_ršg
.
num_chunks
;

144 
size_t
 
ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
Äšgs
, 
nchunks
, 1);

145 
ucc_“_executÜ_t
 *
exec
;

146 
ucc_“_executÜ_sk_¬gs_t
 
—rgs_loc
, 
—rgs_»m
;

147 
ucc_“_executÜ_sk_t
 *
‘ask
;

148 *
dbuf1
, *
dbuf2
, *
sbuf1
, *
sbuf2
;

149 
¡•
, 
äag
, 
äag_¡•
, 
i
, 
ršg
;

150 
ucc_¿nk_t
 
³”_block
, 
£ndto
, 
»cväom
;

151 
ucc_¡©us_t
 
¡
;

152 
size_t
 
»mÙe_off£t
, 
loÿl_off£t
, 
äag_off£t
,

153 
block_off£t
, 
ršg_äag_off£t
, 
chunk_off£t
, 
ršg_äag_size
,

154 
äag_couÁ1
, 
äag_couÁ2
;

155 
size_t
 
ršg_sü©ch_off£t
;

157 
¡
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

158 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

159  
¡
;

162 
¡•
 = 
	`g‘_¿nk_¡•
(
sk
, 
Œªk
, 
chunk
);

163 
¡•
 < (
n¡•s
 * 
sk
->
®lg©h”v_ršg
.
num_äags
)) {

164 ià((
sk
->
®lg©h”v_ršg
.
exec_sk
[2*
chunk
] !ğ
NULL
) ||

165 (
sk
->
®lg©h”v_ršg
.
exec_sk
[2*
chunk
 + 1] !ğ
NULL
)) {

166 
i
 = 1; i >= 0; i--) {

167 
‘ask
 = 
sk
->
®lg©h”v_ršg
.
exec_sk
[2*
chunk
 + 
i
];

168 ià(
‘ask
 !ğ
NULL
) {

169 
¡
 = 
	`ucc_“_executÜ_sk_‹¡
(
‘ask
);

170 ià(
¡
 =ğ
UCC_OK
) {

171 
	`ucc_“_executÜ_sk_fš®ize
(
‘ask
);

172 
sk
->
®lg©h”v_ršg
.
exec_sk
[2*
chunk
 + 
i
] = 
NULL
;

174 ià(
	`ucc_lik–y
(
¡
 > 0)) {

175  
UCC_INPROGRESS
;

177  
¡
;

181 
¡•
++;

182 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 
¡•
, 
chunk
);

186 
äag
 = 
¡•
 / 
n¡•s
;

187 
äag_¡•
 = 
¡•
 % 
n¡•s
;

188 ià(!
	`ucc__cuda_check_³”s_»ady
(
sk
, 
chunk
, 
¡•
)) {

189  
UCC_INPROGRESS
;

192 ià(
¡•
 % 2) {

193 
»mÙe_off£t
 = 
ssize
 / 2;

194 
loÿl_off£t
 = 0;

196 
»mÙe_off£t
 = 0;

197 
loÿl_off£t
 = 
ssize
 / 2;

199 
—rgs_loc
.
cİy_muÉi
.
num_veùÜs
 = 0;

200 
—rgs_»m
.
cİy_muÉi
.
num_veùÜs
 = 0;

202 
ršg
 = 0;„šg < 
Äšgs
;„ing++) {

203 
ršg_sü©ch_off£t
 = 
	`ucc__cuda_®lg©h”v_ršg_sü©ch_off£t
(
sk
, 
chunk
, 
ršg
);

204 
£ndto
 = 
	`g‘_£nd_to
(
‹am
, 
Œªk
, 
tsize
, 
ršg
);

205 
»cväom
 = 
	`g‘_»cv_äom
(
‹am
, 
Œªk
, 
tsize
, 
ršg
);

206 ià(
äag_¡•
 =ğ
n¡•s
 - 1) {

207 ià(
tsize
 != 2) {

208 
³”_block
 = 
	`g‘_»cv_block
(
‹am
, 
Œªk
, 
tsize
, 
äag_¡•
, 
ršg
);

209 
	`ucc__cuda_®lg©h”v_ršg_size_off£t
(
sk
, 
³”_block
, 
äag
, 
chunk
, 
ršg
,

210 &
ršg_äag_size
, &
block_off£t
,

211 &
äag_off£t
, &
chunk_off£t
,

212 &
ršg_äag_off£t
);

213 
sbuf1
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
»cväom
),

214 
loÿl_off£t
 + 
ršg_sü©ch_off£t
);

215 
dbuf1
 = 
	`PTR_OFFSET
(
rbuf
, 
block_off£t
 + 
chunk_off£t
 +

216 
äag_off£t
 + 
ršg_äag_off£t
);

217 
äag_couÁ1
 = 
ršg_äag_size
;

219 
sbuf1
 = 
NULL
;

220 
dbuf1
 = 
NULL
;

222 
³”_block
 = 
	`g‘_£nd_block
(
‹am
, 
Œªk
, 
tsize
, 
äag_¡•
, 
ršg
);

223 
	`ucc__cuda_®lg©h”v_ršg_size_off£t
(
sk
, 
³”_block
, 
äag
, 
chunk
, 
ršg
,

224 &
ršg_äag_size
, &
block_off£t
,

225 &
äag_off£t
, &
chunk_off£t
,

226 &
ršg_äag_off£t
);

227 
sbuf2
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
Œªk
), 
loÿl_off£t
 + 
ršg_sü©ch_off£t
);

228 
dbuf2
 = 
	`PTR_OFFSET
(
rbuf
, 
block_off£t
 + 
äag_off£t
 +

229 
chunk_off£t
 + 
ršg_äag_off£t
);

230 
äag_couÁ2
 = 
ršg_äag_size
;

232 
³”_block
 = 
	`g‘_£nd_block
(
‹am
, 
Œªk
, 
tsize
, 
äag_¡•
, 
ršg
);

233 
	`ucc__cuda_®lg©h”v_ršg_size_off£t
(
sk
, 
³”_block
, 
äag
, 
chunk
, 
ršg
,

234 &
ršg_äag_size
, &
block_off£t
,

235 &
äag_off£t
, &
chunk_off£t
,

236 &
ršg_äag_off£t
);

237 ià(
äag_¡•
 == 0) {

238 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

239 
sbuf1
 = 
	`PTR_OFFSET
(
rbuf
, 
block_off£t
 + 
äag_off£t
 +

240 
ršg_äag_off£t
 + 
chunk_off£t
);

241 
sbuf2
 = 
NULL
;

242 
dbuf2
 = 
NULL
;

244 
sbuf1
 = 
	`PTR_OFFSET
(
sk
->
®lg©h”v_ršg
.
sbuf
,

245 
äag_off£t
 + 
ršg_äag_off£t
 + 
chunk_off£t
);

246 
sbuf2
 = 
sbuf1
;

247 
dbuf2
 = 
	`PTR_OFFSET
(
rbuf
, 
block_off£t
 + 
äag_off£t
 +

248 
ršg_äag_off£t
 + 
chunk_off£t
);

250 
dbuf1
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
£ndto
),

251 
»mÙe_off£t
 + 
ršg_sü©ch_off£t
);

253 
sbuf1
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
Œªk
),

254 
loÿl_off£t
 + 
ršg_sü©ch_off£t
);

255 
sbuf2
 = 
sbuf1
;

256 
dbuf1
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
£ndto
),

257 
»mÙe_off£t
 + 
ršg_sü©ch_off£t
);

258 
dbuf2
 = 
	`PTR_OFFSET
(
rbuf
, 
block_off£t
 + 
äag_off£t
 +

259 
ršg_äag_off£t
 + 
chunk_off£t
);

261 
äag_couÁ1
 = 
ršg_äag_size
;

262 
äag_couÁ2
 = 
ršg_äag_size
;

265 ià(
dbuf1
 !ğ
NULL
) {

266 
—rgs_»m
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
;

267 
—rgs_»m
.
cİy_muÉi
.
¤c
[
ršg
] = 
sbuf1
;

268 
—rgs_»m
.
cİy_muÉi
.
d¡
[
ršg
] = 
dbuf1
;

269 
—rgs_»m
.
cİy_muÉi
.
couÁs
[
ršg
] = 
äag_couÁ1
;

270 
—rgs_»m
.
cİy_muÉi
.
num_veùÜs
++;

273 ià(
dbuf2
 !ğ
NULL
) {

274 
—rgs_loc
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
;

275 
—rgs_loc
.
cİy_muÉi
.
¤c
[
ršg
] = 
sbuf2
;

276 
—rgs_loc
.
cİy_muÉi
.
d¡
[
ršg
] = 
dbuf2
;

277 
—rgs_loc
.
cİy_muÉi
.
couÁs
[
ršg
] = 
äag_couÁ2
;

278 
—rgs_loc
.
cİy_muÉi
.
num_veùÜs
++;

282 ià(
—rgs_»m
.
cİy_muÉi
.
num_veùÜs
 != 0) {

283 
¡
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs_»m
,

284 &
sk
->
®lg©h”v_ršg
.
exec_sk
[2*
chunk
]);

285 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

286  
¡
;

290 ià(
—rgs_loc
.
cİy_muÉi
.
num_veùÜs
 != 0) {

291 
¡
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs_loc
,

292 &
sk
->
®lg©h”v_ršg
.
exec_sk
[2*
chunk
 + 1]);

293 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

294  
¡
;

299  
UCC_OK
;

300 
	}
}

302 
	$ucc__cuda_®lg©h”v_ršg_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

304 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

305 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

306 
ucc_¡©us_t
 
¡
;

307 
chunk
, 
num_dÚe
;

309 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

310 
sk
->
®lg©h”v_ršg
.
¡age
) {

311 
RING_STAGE_SYNC
:

312 ià(
	`ucc__cuda_g‘_sync
(
sk
è!ğ
UCC_OK
) {

313 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

316 
¡
 = 
	`ucc__cuda_®lg©h”v_ršg_£tup_¡¬t
(
sk
);

317 ià(
¡
 !ğ
UCC_OK
) {

318 
sk
->
su³r
.
¡©us
 = 
¡
;

321 
sk
->
®lg©h”v_ršg
.
¡age
 = 
RING_STAGE_SETUP
;

323 
RING_STAGE_SETUP
:

324 
¡
 = 
	`ucc__cuda_®lg©h”v_ršg_£tup_‹¡
(
sk
);

325 ià(
¡
 !ğ
UCC_OK
) {

326 
sk
->
su³r
.
¡©us
 = 
¡
;

329 
sk
->
®lg©h”v_ršg
.
¡age
 = 
RING_STAGE_RING
;

331 
RING_STAGE_RING
:

332 
num_dÚe
 = 0;

333 
chunk
 = 0; chunk < 
sk
->
®lg©h”v_ršg
.
num_chunks
; chunk++) {

334 
¡
 = 
	`ucc__cuda_®lg©h”v_ršg_´og»ss_ršg
(
sk
, 
chunk
);

335 ià(
	`ucc_uÆik–y
(
¡
 < 0)) {

336 
sk
->
su³r
.
¡©us
 = 
¡
;

338 } ià(
¡
 =ğ
UCC_OK
) {

339 
num_dÚe
++;

343 ià(
num_dÚe
 !ğ
sk
->
®lg©h”v_ršg
.
num_chunks
) {

347 
¡
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

348 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

349 
sk
->
su³r
.
¡©us
 = 
¡
;

353 
sk
->
®lg©h”v_ršg
.
¡age
 = 
RING_STAGE_BARRIER
;

356 
	`ucc_as£¹
(
sk
->
®lg©h”v_ršg
.
¡age
 =ğ
RING_STAGE_BARRIER
);

360 
sk
->
su³r
.
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
),

361 
sk
->
b¬
);

362 ià(
sk
->
su³r
.
¡©us
 =ğ
UCC_OK
) {

363 
	`ucc__cuda_put_sync
(
sk
);

364 
	`UCC_TL_CUDA_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "cuda_agv_ring_done", 0);

366 
	}
}

368 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_ršg_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

370 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

371 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

372 
ucc__cuda_lib_t
 *
lib
 = 
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
);

373 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

374 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

375 
nchunks
 = 
lib
->
cfg
.
®lg©h”_ršg_num_chunks
;

376 
Äšgs
;

377 
size_t
 
ssize
;

378 
size_t
 
£nd_size
;

379 
size_t
 
äag_size
;

380 
ucc_¿nk_t
 
i
;

382 
	`UCC_TL_CUDA_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "cuda_agv_ring_start", 0);

383 
£nd_size
 = 
sk
->
®lg©h”v_ršg
.
	`g‘_couÁ
(task, 0);

384 
i
 = 1; i < 
tsize
; i++) {

385 
£nd_size
 = 
	`ucc_max
(£nd_size, 
sk
->
®lg©h”v_ršg
.
	`g‘_couÁ
Ñask, 
i
));

387 
£nd_size
 = 
	`ucc_dt_size
(
sk
->
®lg©h”v_ršg
.
dt
) * send_size;

389 ià(
£nd_size
 == 0) {

390 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

391  
	`ucc_sk_com¶‘e
(&
sk
->
su³r
);

394 
Äšgs
 = 
	`g‘_num_ršgs
(
‹am
, 
£nd_size
,

395 
lib
->
cfg
.
®lg©h”_ršg_max_ršgs
);

396 
sk
->
®lg©h”v_ršg
.
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

397 
sk
->
®lg©h”v_ršg
.
num_ršgs
 = 
Äšgs
;

398 
sk
->
®lg©h”v_ršg
.
num_chunks
 = 
nchunks
;

399 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHERV
) {

400 
sk
->
®lg©h”v_ršg
.
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

402 
sk
->
®lg©h”v_ršg
.
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

405 
ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
Äšgs
, 
nchunks
, 1);

406 
äag_size
 = 
	`ucc_mš
(
ssize
 / 2, 
£nd_size
);

407 
sk
->
®lg©h”v_ršg
.
num_äags
 = 
	`ucc_div_round_up
(
£nd_size
, 
äag_size
);

408 
sk
->
®lg©h”v_ršg
.
¡age
 = 
RING_STAGE_SYNC
;

409 
	`mem£t
(
sk
->
®lg©h”v_ršg
.
exec_sk
, 0,

410 2 * 
sk
->
®lg©h”v_ršg
.
num_chunks
 *

411 (
ucc_“_executÜ_sk_t
*));

412  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

413 
	}
}

415 
ucc_¡©us_t
 
	$ucc__cuda_®lg©h”v_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

416 
ucc_ba£_‹am_t
 * 
_‹am
,

417 
ucc_cŞl_sk_t
 ** 
sk_p
)

419 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

420 
ucc__cuda_sk_t
 *
sk
;

421 
ucc_¡©us_t
 
¡©us
;

423 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

424 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

425  
¡©us
;

428 
sk
->
®lg©h”v_ršg
.
g‘_couÁ
 = 
ucc__cuda_®lg©h”v_g‘_couÁ
;

429 
sk
->
®lg©h”v_ršg
.
g‘_off£t
 = 
ucc__cuda_®lg©h”v_g‘_off£t
;

430 
sk
->
®lg©h”v_ršg
.
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo_v
.
d©©y³
;

432 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

433 
sk
->
su³r
.
po¡
 = 
ucc__cuda_®lg©h”v_ršg_¡¬t
;

434 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_®lg©h”v_ršg_´og»ss
;

435 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_®lg©h”v_ršg_fš®ize
;

436 
sk
->
b¬
 = 
	`TASK_BAR
(task);

438 *
sk_p
 = &
sk
->
su³r
;

439  
UCC_OK
;

440 
	}
}

	@src/components/tl/cuda/allreduce/allreduce.c

7 
	~"®Ìeduû.h
"

8 
	~"_cuda.h
"

9 
	~"uts/¬ch/cuda_def.h
"

10 
	~"uts/ucc_cŞl_uts.h
"

12 
ucc_ba£_cŞl_®g_šfo_t


13 
	gucc__cuda_®Ìeduû_®gs
[
UCC_TL_CUDA_ALLREDUCE_ALG_LAST
 + 1] = {

14 #ifdeà
HAVE_NVLS


15 [
UCC_TL_CUDA_ALLREDUCE_ALG_NVLS
] = {.
id
 =

16 
UCC_TL_CUDA_ALLREDUCE_ALG_NVLS
,

17 .
	gÇme
 = "nvls",

18 .
	gdesc
 = "NVLINK SHARP‡llreduce"},

20 [
UCC_TL_CUDA_ALLREDUCE_ALG_LAST
] = {

21 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

23 
ucc_¡©us_t
 
	$ucc__cuda_®Ìeduû_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

24 
ucc_ba£_‹am_t
 *
‹am
,

25 
ucc_cŞl_sk_t
 **
sk_h
)

27 
ucc_¡©us_t
 
¡©us
 = 
UCC_ERR_NOT_IMPLEMENTED
;

28 #ifdeà
HAVE_NVLS


29 
ucc__cuda_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_cuda_team_t);

30 
ucc__cuda_sk_t
 *
sk
;

32 
sk
 = 
	`ucc__cuda_sk_g‘
(
_‹am
);

33 ià(
	`ucc_uÆik–y
(!
sk
)) {

34  
UCC_ERR_NO_MEMORY
;

37 
¡©us
 = 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, 
cŞl_¬gs
, &
_‹am
->super.super);

38 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

39 
	`ucc__cuda_sk_put
(
sk
);

40  
¡©us
;

44 
¡©us
 = 
	`ucc__cuda_®Ìeduû_nvls_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

45 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

46 
	`ucc__cuda_sk_put
(
sk
);

49 (è
cŞl_¬gs
;

50 (è
‹am
;

51 (è
sk_h
;

54  
¡©us
;

55 
	}
}

	@src/components/tl/cuda/allreduce/allreduce.h

7 #iâdeà
ALLREDUCE_H_


8 
	#ALLREDUCE_H_


	)

10 
	~"_cuda.h
"

11 
	~"_cuda_cŞl.h
"

14 #ifdeà
HAVE_NVLS


15 
	mUCC_TL_CUDA_ALLREDUCE_ALG_NVLS
,

17 
	mUCC_TL_CUDA_ALLREDUCE_ALG_LAST


20 
ucc_ba£_cŞl_®g_šfo_t


21 
ucc__cuda_®Ìeduû_®gs
[
UCC_TL_CUDA_ALLREDUCE_ALG_LAST
 + 1];

23 #ifdeà
HAVE_NVLS


24 
	#UCC_TL_CUDA_ALLREDUCE_DEFAULT_ALG_SELECT_STR
 "®Ìeduû:cuda:@0"

	)

26 
	#UCC_TL_CUDA_ALLREDUCE_DEFAULT_ALG_SELECT_STR
 ""

	)

29 
ucc_¡©us_t
 
ucc__cuda_®Ìeduû_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

30 
ucc_ba£_‹am_t
 *
‹am
,

31 
ucc_cŞl_sk_t
 **
sk_h
);

33 
ucc_¡©us_t
 
ucc__cuda_®Ìeduû_nvls_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

34 
ucc_ba£_‹am_t
 *
‹am
,

35 
ucc_cŞl_sk_t
 **
sk_h
);

37 
šlše
 
	$ucc__cuda_®Ìeduû_®g_äom_¡r
(cÚ¡ *
¡r
)

39 
i
;

40 
i
 = 0; i < 
UCC_TL_CUDA_ALLREDUCE_ALG_LAST
; i++) {

41 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__cuda_®Ìeduû_®gs
[
i
].
Çme
)) {

45  
i
;

46 
	}
}

	@src/components/tl/cuda/allreduce/allreduce_nvls.c

7 
	~"®Ìeduû/®Ìeduû.h
"

8 
	~"ucc/­i/ucc.h
"

9 
	~"cÜe/ucc_“.h
"

10 
	~"uts/¬ch/cuda_def.h
"

11 
	~"_cuda_nvls.h
"

12 
	~"../k”Ãls/®Ìeduû_k”Ãl.h
"

13 
	~"compÚ’ts/ec/ucc_ec.h
"

14 
	~"compÚ’ts/ec/cuda/ec_cuda_»sourûs.h
"

18 
	mSTAGE_COPY
,

19 
	mSTAGE_COPY_BAR_START
,

20 
	mSTAGE_COPY_BAR_TEST
,

21 
	mSTAGE_KERNEL_START
,

22 
	mSTAGE_KERNEL
,

23 
	mSTAGE_BARRIER_START
,

24 
	mSTAGE_BARRIER_TEST
,

25 
	mSTAGE_COPY_POST
,

26 
	mSTAGE_COPY_POST_WAIT
,

29 
ucc_¡©us_t
 
	$ucc__cuda_®Ìeduû_nvls_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

31 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

32 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

33 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

34 
ucc__cuda_nvls_t
 *
nvls
 = &
‹am
->nvls;

35 
ucc_“_h
 
“
 = 
sk
->
su³r
.ee;

36 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tëe->
“_cÚ‹xt
 : 
‹am
->stream;

37 
ucc_d©©y³_t
 
dt
 = 
sk
->
®Ìeduû_nvls
.dt;

39 
size_t
 
buf_size_by‹s
 = 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
	`ucc_dt_size
(
dt
);

41 
	`ucc_Œaû
("allreduce_nvls_start symmetric uc‡ddr: %p mc‡ddr: %p "

43 (*)
nvls
->
uc_va
, (*êvls->
mc_va
, 
buf_size_by‹s
);

45 
sk
->
®Ìeduû_nvls
.
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

46 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

47 
sk
->
®Ìeduû_nvls
.
sbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

49 
sk
->
®Ìeduû_nvls
.
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

51 
sk
->
®Ìeduû_nvls
.
buf_size_by‹s
 = buf_size_bytes;

54 
	`CUDA_CHECK
(
	`cudaMemıyAsync
((*)
nvls
->
uc_va
, 
sk
->
®Ìeduû_nvls
.
sbuf
,

55 
buf_size_by‹s
, 
cudaMemıyDeviûToDeviû
,

56 
¡»am
));

57 
	`CUDA_CHECK
(
	`cudaEv’tRecÜd
(((
ucc_ec_cuda_ev’t_t
 *)
sk
->
®Ìeduû_nvls
.
evtCom¶‘iÚ
)->
ev’t
, 
¡»am
));

59 
sk
->
®Ìeduû_nvls
.
¡age
 = 
STAGE_COPY
;

61  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

62 
	}
}

64 
	$ucc__cuda_®Ìeduû_nvls_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

66 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

67 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

68 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

69 
ucc_ec_cuda_ev’t_t
 *
ec_ev’t
 = (ucc_ec_cuda_ev’t_ˆ*)
sk
->
®Ìeduû_nvls
.
evtCom¶‘iÚ
;

70 
cudaEv’t_t
 
evt
 = 
ec_ev’t
->
ev’t
;

71 
ucc__cuda_nvls_t
 *
nvls
 = &
‹am
->nvls;

72 
ucc_“_h
 
“
 = 
sk
->
su³r
.ee;

73 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tëe->
“_cÚ‹xt
 : 
‹am
->stream;

75 
ucc_¡©us_t
 
¡©us
;

76 
cudaE¼Ü_t
 
cuda_¡©us
;

77 
sk
->
®Ìeduû_nvls
.
¡age
) {

78 
STAGE_COPY
:

79 
cuda_¡©us
 = 
	`cudaEv’tQu”y
(
evt
);

80 ià(
cuda_¡©us
 =ğ
cudaE¼ÜNÙR—dy
) {

81 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

84 ià(
cuda_¡©us
 !ğ
cudaSucûss
) {

85 
	`ucc_”rÜ
("cudaEventQuery failed %s",

86 
	`cudaG‘E¼ÜSŒšg
(
cuda_¡©us
));

87 
sk
->
su³r
.
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

90 
sk
->
®Ìeduû_nvls
.
¡age
 = 
STAGE_COPY_BAR_START
;

92 
STAGE_COPY_BAR_START
:

93 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
Œªk
, 
sk
->
b¬
);

94 ià(
¡©us
 !ğ
UCC_OK
) {

95 
	`ucc_”rÜ
("allreduce barrier start failed");

96 
sk
->
su³r
.
¡©us
 = status;

99 
sk
->
®Ìeduû_nvls
.
¡age
 = 
STAGE_COPY_BAR_TEST
;

101 
STAGE_COPY_BAR_TEST
:

102 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
Œªk
, 
sk
->
b¬
);

103 ià(
¡©us
 !ğ
UCC_OK
) {

104 
sk
->
su³r
.
¡©us
 = status;

107 
sk
->
®Ìeduû_nvls
.
¡age
 = 
STAGE_KERNEL_START
;

109 
STAGE_KERNEL_START
:

110 
¡©us
 = 
	`po¡_®Ìeduû_k”Ãl
(
¡»am
, 
nvls
->
mc_va
,

111 
sk
->
®Ìeduû_nvls
.
buf_size_by‹s
,

112 
Œªk
, 
	`UCC_TL_TEAM_SIZE
(
‹am
));

113 ià(
¡©us
 !ğ
UCC_OK
) {

114 
	`ucc_”rÜ
("failedo…ost‡llreduce kernel");

115 
sk
->
su³r
.
¡©us
 = status;

118 
cuda_¡©us
 = 
	`cudaEv’tRecÜd
(
evt
, 
¡»am
);

119 ià(
cuda_¡©us
 !ğ
cudaSucûss
) {

120 
	`ucc_”rÜ
("cudaEv’tRecÜd faed: %s", 
	`cudaG‘E¼ÜSŒšg
(
cuda_¡©us
));

121 
sk
->
su³r
.
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

124 
sk
->
®Ìeduû_nvls
.
¡age
 = 
STAGE_KERNEL
;

126 
STAGE_KERNEL
:

127 
cuda_¡©us
 = 
	`cudaEv’tQu”y
(
evt
);

128 ià(
cuda_¡©us
 =ğ
cudaE¼ÜNÙR—dy
) {

129 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

132 ià(
cuda_¡©us
 !ğ
cudaSucûss
) {

133 
	`ucc_”rÜ
("cudaEventQuery failed %s",

134 
	`cudaG‘E¼ÜSŒšg
(
cuda_¡©us
));

135 
sk
->
su³r
.
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

138 
sk
->
®Ìeduû_nvls
.
¡age
 = 
STAGE_BARRIER_START
;

140 
STAGE_BARRIER_START
:

141 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
Œªk
, 
sk
->
b¬
);

142 ià(
¡©us
 !ğ
UCC_OK
) {

143 
	`ucc_”rÜ
("allreduce barrier start failed");

144 
sk
->
su³r
.
¡©us
 = status;

147 
sk
->
®Ìeduû_nvls
.
¡age
 = 
STAGE_BARRIER_TEST
;

149 
STAGE_BARRIER_TEST
:

150 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
Œªk
, 
sk
->
b¬
);

151 ià(
¡©us
 !ğ
UCC_OK
) {

152 
sk
->
su³r
.
¡©us
 = status;

155 
	`ucc_Œaû
("allreduce kernel is completed");

156 
sk
->
®Ìeduû_nvls
.
¡age
 = 
STAGE_COPY_POST
;

158 
STAGE_COPY_POST
:

159 
cuda_¡©us
 = 
	`cudaMemıyAsync
((*)
sk
->
®Ìeduû_nvls
.
rbuf
,

160 (*)
nvls
->
uc_va
,

161 
sk
->
®Ìeduû_nvls
.
buf_size_by‹s
,

162 
cudaMemıyDeviûToDeviû
,

163 
¡»am
);

164 ià(
cuda_¡©us
 !ğ
cudaSucûss
) {

165 
	`ucc_”rÜ
("cudaMemıyAsynøçed: %s", 
	`cudaG‘E¼ÜSŒšg
(
cuda_¡©us
));

166 
sk
->
su³r
.
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

169 
cuda_¡©us
 = 
	`cudaEv’tRecÜd
(
evt
, 
¡»am
);

170 ià(
cuda_¡©us
 !ğ
cudaSucûss
) {

171 
	`ucc_”rÜ
("cudaEv’tRecÜd faed: %s", 
	`cudaG‘E¼ÜSŒšg
(
cuda_¡©us
));

172 
sk
->
su³r
.
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

175 
sk
->
®Ìeduû_nvls
.
¡age
 = 
STAGE_COPY_POST_WAIT
;

177 
STAGE_COPY_POST_WAIT
:

178 
cuda_¡©us
 = 
	`cudaEv’tQu”y
(
evt
);

179 ià(
cuda_¡©us
 =ğ
cudaE¼ÜNÙR—dy
) {

180 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

183 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

187 
	}
}

189 
ucc_¡©us_t
 
	$ucc__cuda_®Ìeduû_nvls_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

191 
ucc__cuda_sk_t
 *
_sk
 = 
	`ucc_d”ived_of
(
sk
, ucc_tl_cuda_task_t);

193 
	`ucc_ec_de¡roy_ev’t
(
_sk
->
®Ìeduû_nvls
.
evtCom¶‘iÚ
, 
UCC_EE_CUDA_STREAM
);

195 
	`ucc__cuda_sk_put
(
_sk
);

196  
UCC_OK
;

197 
	}
}

199 
ucc_¡©us_t
 
	$ucc__cuda_®Ìeduû_nvls_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

200 
ucc_ba£_‹am_t
 *
_‹am
,

201 
ucc_cŞl_sk_t
 **
sk_p
)

203 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

204 
ucc__cuda_sk_t
 *
sk
;

205 
ucc_¡©us_t
 
¡©us
;

207 ià(
cŞl_¬gs
->
¬gs
.
İ
 !ğ
UCC_OP_SUM
 ||

208 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
 !ğ
UCC_DT_FLOAT32
) {

209 
	`ucc_”rÜ
("NVLS‡llreduce is supported only with SUM operation "

211  
UCC_ERR_NOT_SUPPORTED
;

214 ià(
	`ucc_uÆik–y
(!
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
))) {

215 
	`ucc_”rÜ
("NVLS‡llreduce is supported only on fully connected "

217  
UCC_ERR_NOT_SUPPORTED
;

220 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

221 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

222 
	`ucc_”rÜ
("failedo initialize CUDAask");

223  
¡©us
;

226 
¡©us
 = 
	`ucc_ec_ü—‹_ev’t
(&
sk
->
®Ìeduû_nvls
.
evtCom¶‘iÚ
, 
UCC_EE_CUDA_STREAM
);

227 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

228 
	`ucc_”rÜ
("failedo create CUDAƒvent");

229 
	`ucc__cuda_sk_put
(
sk
);

230  
¡©us
;

233 
sk
->
®Ìeduû_nvls
.
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

235 
sk
->
su³r
.
po¡
 = 
ucc__cuda_®Ìeduû_nvls_¡¬t
;

236 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_®Ìeduû_nvls_´og»ss
;

237 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_®Ìeduû_nvls_fš®ize
;

239 
sk
->
b¬
 = 
	`TASK_BAR
(task);

241 *
sk_p
 = &
sk
->
su³r
;

242  
UCC_OK
;

243 
	}
}

	@src/components/tl/cuda/alltoall/alltoall.c

7 
	~"®ÉßÎ.h
"

8 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎ_û_š™
(
ucc__cuda_sk_t
 *
sk
);

12 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎ_û_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

14 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎ_û_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

16 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎ_û_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

18 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎ_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

19 
ucc_ba£_‹am_t
 *
_‹am
,

20 
ucc_cŞl_sk_t
 **
sk_p
)

22 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

23 
ucc__cuda_sk_t
 *
sk
;

24 
ucc_¡©us_t
 
¡©us
;

26 ià(
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
)) {

27  
UCC_ERR_NOT_SUPPORTED
;

30 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

31 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

32  
¡©us
;

35 
¡©us
 = 
	`ucc__cuda_®ÉßÎ_û_š™
(
sk
);

36 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

37 
ä“_sk
;

40 *
sk_p
 = &
sk
->
su³r
;

41  
UCC_OK
;

43 
ä“_sk
:

44 
	`ucc__cuda_sk_put
(
sk
);

45  
¡©us
;

46 
	}
}

	@src/components/tl/cuda/alltoall/alltoall.h

7 #iâdeà
ALLTOALL_H_


8 
	#ALLTOALL_H_


	)

10 
	~"_cuda.h
"

11 
	~"_cuda_cŞl.h
"

13 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎ_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

14 
ucc_ba£_‹am_t
 *
_‹am
,

15 
ucc_cŞl_sk_t
 **
sk_p
);

	@src/components/tl/cuda/alltoall/alltoall_ce.c

8 
	~"../®ÉßÎv/®ÉßÎv.h
"

9 
	~"®ÉßÎ.h
"

10 
	~"compÚ’ts/ec/ucc_ec.h
"

11 
	~"_cuda_ÿche.h
"

12 
	~"uts/¬ch/ıu.h
"

13 
	~"uts/¬ch/cuda_def.h
"

16 
size_t
 
	$ucc__cuda_®ÉßÎ_g‘_size
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

17 
size_t
 *
úts
, 
ucc_¿nk_t
 
block
)

19  
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
) *

20 (
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
couÁ
 / 
	`UCC_TL_TEAM_SIZE
(
	`TASK_TEAM
(task)));

21 
	}
}

23 
size_t
 
	$ucc__cuda_®ÉßÎ_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

24 
size_t
 *
di¥l
, 
ucc_¿nk_t
 
block
)

26  
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
) *

27 (
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
couÁ
 /

28 
	`UCC_TL_TEAM_SIZE
(
	`TASK_TEAM
(
sk
))) *

29 
block
;

30 
	}
}

32 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎ_û_š™
(
ucc__cuda_sk_t
 *
sk
)

34 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

35 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

36 
ucc_¡©us_t
 
¡©us
;

37 
size_t
 
d©a_Ën
;

39 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

41 
sk
->
®ÉßÎv_û
.
g‘_size
 = 
ucc__cuda_®ÉßÎ_g‘_size
;

42 
sk
->
®ÉßÎv_û
.
g‘_off£t
 = 
ucc__cuda_®ÉßÎ_g‘_off£t
;

43 
sk
->
®ÉßÎv_û
.
sdt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

44 
sk
->
®ÉßÎv_û
.
rdt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

45 
sk
->
®ÉßÎv_û
.
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

46 
sk
->
®ÉßÎv_û
.
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

47 
sk
->
®ÉßÎv_û
.
¡age
 = 0;

49 
sk
->
®ÉßÎv_û
.
súts
 = 0;

50 
sk
->
®ÉßÎv_û
.
rúts
 = 0;

51 
sk
->
®ÉßÎv_û
.
sdi¥l
 = 0;

52 
sk
->
®ÉßÎv_û
.
rdi¥l
 = 0;

54 
d©a_Ën
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
è*‡rgs->¤c.šfo.
couÁ
;

55 
¡©us
 = 
	`ucc__cuda_mem_šfo_g‘
(
¬gs
->
¤c
.
šfo
.
bufãr
, 
d©a_Ën
,

56 &
sk
->
®ÉßÎv_û
.
mem_šfo_¤c
);

57 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

58 
ex™_”r
;

61 ià(
‹am
->
tİo
->
´oxy_Ãeded
) {

62 
¡©us
 = 
	`ucc__cuda_mem_šfo_g‘
(
¬gs
->
d¡
.
šfo
.
bufãr
, 
d©a_Ën
,

63 &
sk
->
®ÉßÎv_û
.
mem_šfo_d¡
);

64 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

65 
ex™_”r
;

69 
sk
->
su³r
.
po¡
 = 
ucc__cuda_®ÉßÎv_û_¡¬t
;

70 
sk
->
su³r
.
Œigg”ed_po¡_£tup
 =

71 
ucc__cuda_®ÉßÎv_û_Œigg”ed_po¡_£tup
;

72 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_®ÉßÎv_û_´og»ss
;

73 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_®ÉßÎv_û_fš®ize
;

74 
sk
->
b¬
 = 
	`TASK_BAR
(task);

76  
UCC_OK
;

78 
ex™_”r
:

79  
¡©us
;

80 
	}
}

	@src/components/tl/cuda/alltoallv/alltoallv.c

8 
	~"®ÉßÎv.h
"

9 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎv_û_š™
(
ucc__cuda_sk_t
 *
sk
);

13 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎv_û_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

15 
ucc__cuda_®ÉßÎv_û_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

17 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎv_û_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

19 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎv_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

20 
ucc_ba£_‹am_t
 *
_‹am
,

21 
ucc_cŞl_sk_t
 **
sk_p
)

23 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

24 
ucc__cuda_sk_t
 *
sk
;

25 
ucc_¡©us_t
 
¡©us
;

27 ià(
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
)) {

28  
UCC_ERR_NOT_SUPPORTED
;

31 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

32 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

33  
¡©us
;

36 
¡©us
 = 
	`ucc__cuda_®ÉßÎv_û_š™
(
sk
);

37 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

38 
ä“_sk
;

41 *
sk_p
 = &
sk
->
su³r
;

42  
UCC_OK
;

44 
ä“_sk
:

45 
	`ucc__cuda_sk_put
(
sk
);

46  
¡©us
;

47 
	}
}

	@src/components/tl/cuda/alltoallv/alltoallv.h

8 #iâdeà
ALLTOALLV_H_


9 
	#ALLTOALLV_H_


	)

11 
	~"../_cuda.h
"

12 
	~"../_cuda_cŞl.h
"

14 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎv_û_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

16 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎv_û_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

18 
ucc__cuda_®ÉßÎv_û_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

20 
ucc_¡©us_t


21 
ucc__cuda_®ÉßÎv_û_Œigg”ed_po¡_£tup
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

23 
ucc_¡©us_t
 
ucc__cuda_®ÉßÎv_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

24 
ucc_ba£_‹am_t
 *
_‹am
,

25 
ucc_cŞl_sk_t
 **
sk_p
);

	@src/components/tl/cuda/alltoallv/alltoallv_ce.c

8 
	~"®ÉßÎv.h
"

9 
	~"compÚ’ts/ec/ucc_ec.h
"

10 
	~"cÜe/ucc_“.h
"

11 
	~"_cuda_ÿche.h
"

12 
	~"uts/¬ch/ıu.h
"

13 
	~"uts/¬ch/cuda_def.h
"

16 
	mALLTOALL_CE_STAGE_SYNC
,

17 
	mALLTOALL_CE_STAGE_SETUP
,

18 
	mALLTOALL_CE_STAGE_POST_COPIES
,

19 
	mALLTOALL_CE_STAGE_COPY
,

20 
	mALLTOALL_CE_STAGE_BAR
,

23 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎv_û_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

25 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

27 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizingask %p",ask);

28 
	`ucc__cuda_sk_put
(
sk
);

29  
UCC_OK
;

30 
	}
}

32 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎv_£tup_¡¬t
(
ucc__cuda_sk_t
 *
sk
)

34 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

35 
ucc__cuda_sync_t
 *
sync
 = 
	`TASK_SYNC
(
sk
, 
	`UCC_TL_TEAM_RANK
(
‹am
));

36 
ucc_¡©us_t
 
¡©us
;

37 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

38 
ucc_“_h
 
“
 = 
sk
->
su³r
.ee;

39 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tëe->
“_cÚ‹xt
 : 
‹am
->stream;

42 ià(
UCC_COLL_TYPE_ALLTOALLV
 =ğ
¬gs
->
cŞl_ty³
) {

43 
i
;

44 
size_t
 
rdt_size
 = 
	`ucc_dt_size
(
sk
->
®ÉßÎv_û
.
rdt
);

45 
size_t
 
sdt_size
 = 
	`ucc_dt_size
(
sk
->
®ÉßÎv_û
.
sdt
);

46 
i
 = 0; i < 
	`UCC_TL_TEAM_SIZE
(
‹am
); ++i) {

47 
sync
->
®ÉßÎv_û
.
sby‹s
[
i
] =

48 
sdt_size
 * (
size_t
)
	`ucc_cŞl_¬gs_g‘_couÁ
(

49 
¬gs
, 
sk
->
®ÉßÎv_û
.
súts
, 
i
);

50 
sync
->
®ÉßÎv_û
.
rby‹s
[
i
] =

51 
rdt_size
 * (
size_t
)
	`ucc_cŞl_¬gs_g‘_couÁ
(

52 
¬gs
, 
sk
->
®ÉßÎv_û
.
rúts
, 
i
);

53 
sync
->
®ÉßÎv_û
.
sdi¥l_by‹s
[
i
] =

54 
sdt_size
 * (
size_t
)
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

55 
¬gs
, 
sk
->
®ÉßÎv_û
.
sdi¥l
, 
i
);

56 
sync
->
®ÉßÎv_û
.
rdi¥l_by‹s
[
i
] =

57 
rdt_size
 * (
size_t
)
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

58 
¬gs
, 
sk
->
®ÉßÎv_û
.
rdi¥l
, 
i
);

61 
	`memıy
(&
sync
->
mem_šfo_¤c
, &
sk
->
®ÉßÎv_û
.mem_info_src,

62 (
ucc__cuda_mem_šfo_t
));

63 
	`memıy
(&
sync
->
mem_šfo_d¡
, &
sk
->
®ÉßÎv_û
.mem_info_dst,

64 (
ucc__cuda_mem_šfo_t
));

65 
	`CUDA_CHECK_GOTO
(
	`cudaEv’tRecÜd
(
sync
->
c_ev’t_loÿl
, 
¡»am
), 
ex™_”r
,

66 
¡©us
);

67 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

68 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

69 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

70 
ex™_”r
;

73  
UCC_OK
;

75 
ex™_”r
:

76  
¡©us
;

77 
	}
}

79 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎv_£tup_‹¡
(
ucc__cuda_sk_t
 *
sk
)

81 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

82 vŞ©
ucc__cuda_sync_t
 *
³”_sync
, *
sync
;

83 
ucc__cuda_ÿche_t
 *
ÿche
;

84 
ucc_¡©us_t
 
¡©us
;

85 
ucc_¿nk_t
 
i
, 
d¡
;

86 
ucc_“_h
 
“
 = 
sk
->
su³r
.ee;

87 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tëe->
“_cÚ‹xt
 : 
‹am
->stream;

89 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

90 ià(
¡©us
 !ğ
UCC_OK
) {

91  
¡©us
;

94 
sync
 = 
	`TASK_SYNC
(
sk
, 
	`UCC_TL_TEAM_RANK
(
‹am
));

95 
i
 = 0; i < 
	`UCC_TL_TEAM_SIZE
(
‹am
); i++) {

96 ià(
i
 =ğ
	`UCC_TL_TEAM_RANK
(
‹am
) ||

97 !
	`ucc__cuda_‹am_tİo_is_dœeù
(&
‹am
->
su³r
,—m->
tİo
,

98 
	`UCC_TL_TEAM_RANK
(
‹am
), 
i
)) {

101 
³”_sync
 = 
	`TASK_SYNC
(
sk
, 
i
);

102 
ÿche
 = 
	`ucc__cuda_g‘_ÿche
(
‹am
, 
i
);

103 ià(
	`ucc_uÆik–y
(!
ÿche
)) {

104 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

105 
ex™_”r
;

108 
¡©us
 = 
	`ucc__cuda_m­_memhªdË
(

109 
³”_sync
->
mem_šfo_¤c
.
±r
,…“r_sync->mem_šfo_¤c.
Ëngth
,

110 
³”_sync
->
mem_šfo_¤c
.
hªdË
,

111 &
sk
->
®ÉßÎv_û
.
³”_m­_addr_¤c
[
i
], 
ÿche
);

112 ià(
UCC_OK
 !ğ
¡©us
) {

113 
	`ucc_”rÜ
("ucc_cuda_ipc_map_memhandle failed");

114  
UCC_ERR_INVALID_PARAM
;

117 
	`CUDA_CHECK_GOTO
(

118 
	`cudaSŒ—mWa™Ev’t
(
¡»am
, 
sync
->
d©a
[
i
].
c_ev’t_»mÙe
, 0),

119 
ex™_”r
, 
¡©us
);

122 
i
 = 0; i < 
‹am
->
tİo
->
num_´ox›s
; i++) {

123 
d¡
 = 
‹am
->
tİo
->
´ox›s
[
i
].dst;

124 
³”_sync
 = 
	`TASK_SYNC
(
sk
, 
d¡
);

125 
ÿche
 = 
	`ucc__cuda_g‘_ÿche
(
‹am
, 
d¡
);

126 ià(
	`ucc_uÆik–y
(!
ÿche
)) {

127 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

128 
ex™_”r
;

131 
¡©us
 = 
	`ucc__cuda_m­_memhªdË
(

132 
³”_sync
->
mem_šfo_d¡
.
±r
,…“r_sync->mem_šfo_d¡.
Ëngth
,

133 
³”_sync
->
mem_šfo_d¡
.
hªdË
,

134 &
sk
->
®ÉßÎv_û
.
³”_m­_addr_d¡
[
d¡
], 
ÿche
);

135 ià(
UCC_OK
 !ğ
¡©us
) {

136 
	`ucc_”rÜ
("ucc_cuda_ipc_map_memhandle failed");

137  
UCC_ERR_INVALID_PARAM
;

141  
UCC_OK
;

143 
ex™_”r
:

144  
¡©us
;

145 
	}
}

147 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎv_û_po¡_cİ›s
(
ucc__cuda_sk_t
 *
sk
)

149 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

150 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

151 
ucc__cuda_sync_t
 *
sync
 = 
	`TASK_SYNC
(
sk
, 
¿nk
);

152 
ucc_“_executÜ_sk_¬gs_t
 
exec_¬gs
 = {0};

153 
ucc__cuda_sync_t
 *
³”_sync
;

154 
ucc_“_executÜ_t
 *
exec
;

155 *
¤c
, *
d¡
;

156 
ucc_“_executÜ_sk_t
 **
exec_sk
;

157 
size_t
 
d©a_size
, 
d©a_di¥l
;

158 
ucc_¿nk_t
 
i
, 
³”
, 
p¤c
, 
pd¡
;

159 
ucc_¡©us_t
 
¡©us
;

161 
sk
->
®ÉßÎv_û
.
num_po¡ed
 = 0;

162 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

163 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

164 
ex™
;

167 
i
 = 0; i < 
	`UCC_TL_TEAM_SIZE
(
‹am
); i++) {

168 
³”
 = (
¿nk
 + 
i
è% 
	`UCC_TL_TEAM_SIZE
(
‹am
);

169 ià(!
	`ucc__cuda_‹am_tİo_is_dœeù
(&
‹am
->
su³r
,—m->
tİo
, 
¿nk
,

170 
³”
)) {

173 
³”_sync
 = 
	`TASK_SYNC
(
sk
, 
³”
);

174 ià(
³”
 =ğ
¿nk
) {

175 
¤c
 = 
sk
->
®ÉßÎv_û
.
sbuf
;

177 
¤c
 = 
	`PTR_OFFSET
(
sk
->
®ÉßÎv_û
.
³”_m­_addr_¤c
[
³”
],

178 
³”_sync
->
mem_šfo_¤c
.
off£t
);

180 
d©a_size
 = 
sk
->
®ÉßÎv_û
.
	`g‘_size
(

181 
sk
, 
³”_sync
->
®ÉßÎv_û
.
sby‹s
, 
¿nk
);

182 ià(
d©a_size
 == 0) {

185 
d©a_di¥l
 = 
sk
->
®ÉßÎv_û
.
	`g‘_off£t
(

186 
sk
, 
³”_sync
->
®ÉßÎv_û
.
sdi¥l_by‹s
, 
¿nk
);

187 
¤c
 = 
	`PTR_OFFSET
(¤c, 
d©a_di¥l
);

188 
d©a_di¥l
 = 
sk
->
®ÉßÎv_û
.
	`g‘_off£t
(

189 
sk
, 
sync
->
®ÉßÎv_û
.
rdi¥l_by‹s
, 
³”
);

190 
d¡
 = 
	`PTR_OFFSET
(
sk
->
®ÉßÎv_û
.
rbuf
, 
d©a_di¥l
);

192 
exec_¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

193 
exec_¬gs
.
cİy
.
d¡
 = dst;

194 
exec_¬gs
.
cİy
.
¤c
 = src;

195 
exec_¬gs
.
cİy
.
Ën
 = 
d©a_size
;

196 
exec_sk
 =

197 &
sk
->
®ÉßÎv_û
.
exec_sk
[sk->®ÉßÎv_û.
num_po¡ed
];

198 
¡©us
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
exec_¬gs
, 
exec_sk
);

199 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

200 
ex™
;

202 
sk
->
®ÉßÎv_û
.
num_po¡ed
++;

205 
i
 = 0; i < 
‹am
->
tİo
->
num_´ox›s
; i++) {

206 
p¤c
 = 
‹am
->
tİo
->
´ox›s
[
i
].
¤c
;

207 
pd¡
 = 
‹am
->
tİo
->
´ox›s
[
i
].
d¡
;

208 
³”_sync
 = 
	`TASK_SYNC
(
sk
, 
p¤c
);

209 
d©a_size
 = 
sk
->
®ÉßÎv_û
.
	`g‘_size
(

210 
sk
, 
³”_sync
->
®ÉßÎv_û
.
sby‹s
, 
pd¡
);

211 ià(
d©a_size
 == 0) {

214 
d©a_di¥l
 = 
sk
->
®ÉßÎv_û
.
	`g‘_off£t
(

215 
sk
, 
³”_sync
->
®ÉßÎv_û
.
sdi¥l_by‹s
, 
pd¡
);

216 
¤c
 = 
	`PTR_OFFSET
(
sk
->
®ÉßÎv_û
.
³”_m­_addr_¤c
[
p¤c
],

217 
³”_sync
->
mem_šfo_¤c
.
off£t
);

218 
¤c
 = 
	`PTR_OFFSET
(¤c, 
d©a_di¥l
);

219 
³”_sync
 = 
	`TASK_SYNC
(
sk
, 
pd¡
);

220 
d¡
 = 
	`PTR_OFFSET
(
sk
->
®ÉßÎv_û
.
³”_m­_addr_d¡
[
pd¡
],

221 
³”_sync
->
mem_šfo_d¡
.
off£t
);

222 
d©a_di¥l
 = 
sk
->
®ÉßÎv_û
.
	`g‘_off£t
(

223 
sk
, 
³”_sync
->
®ÉßÎv_û
.
rdi¥l_by‹s
, 
p¤c
);

224 
d¡
 = 
	`PTR_OFFSET
(d¡, 
d©a_di¥l
);

225 
exec_¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

226 
exec_¬gs
.
cİy
.
d¡
 = dst;

227 
exec_¬gs
.
cİy
.
¤c
 = src;

228 
exec_¬gs
.
cİy
.
Ën
 = 
d©a_size
;

229 
exec_sk
 =

230 &
sk
->
®ÉßÎv_û
.
exec_sk
[sk->®ÉßÎv_û.
num_po¡ed
];

231 
¡©us
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
exec_¬gs
, 
exec_sk
);

232 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

233 
ex™
;

235 
sk
->
®ÉßÎv_û
.
num_po¡ed
++;

237 
ex™
:

238  
¡©us
;

239 
	}
}

241 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎv_unm­
(
ucc__cuda_sk_t
 *
sk
)

243 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

244 
ucc_¿nk_t
 
i
, 
d¡
;

245 vŞ©
ucc__cuda_sync_t
 *
³”_sync
;

246 
ucc__cuda_ÿche_t
 *
ÿche
;

247 
ucc_¡©us_t
 
¡©us
;

249 
i
 = 0; i < 
	`UCC_TL_TEAM_SIZE
(
‹am
); i++) {

250 ià(
i
 =ğ
	`UCC_TL_TEAM_RANK
(
‹am
) ||

251 !
	`ucc__cuda_‹am_tİo_is_dœeù
(&
‹am
->
su³r
,—m->
tİo
,

252 
	`UCC_TL_TEAM_RANK
(
‹am
), 
i
)) {

255 
³”_sync
 = 
	`TASK_SYNC
(
sk
, 
i
);

256 
ÿche
 = 
	`ucc__cuda_g‘_ÿche
(
‹am
, 
i
);

258 
¡©us
 = 
	`ucc__cuda_unm­_memhªdË
(

259 (
ušŒ_t
)
³”_sync
->
mem_šfo_¤c
.
±r
,

260 
sk
->
®ÉßÎv_û
.
³”_m­_addr_¤c
[
i
], 
ÿche
, 0);

261 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

262  
¡©us
;

266 
i
 = 0; i < 
‹am
->
tİo
->
num_´ox›s
; i++) {

267 
d¡
 = 
‹am
->
tİo
->
´ox›s
[
i
].dst;

268 
³”_sync
 = 
	`TASK_SYNC
(
sk
, 
d¡
);

269 
ÿche
 = 
	`ucc__cuda_g‘_ÿche
(
‹am
, 
d¡
);

271 
¡©us
 = 
	`ucc__cuda_unm­_memhªdË
(

272 (
ušŒ_t
)
³”_sync
->
mem_šfo_d¡
.
±r
,

273 
sk
->
®ÉßÎv_û
.
³”_m­_addr_d¡
[
d¡
], 
ÿche
, 0);

274 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

275  
¡©us
;

279  
UCC_OK
;

280 
	}
}

282 
	$ucc__cuda_®ÉßÎv_û_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

284 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

285 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

286 
ucc_¡©us_t
 
¡©us
;

287 
i
;

289 
sk
->
®ÉßÎv_û
.
¡age
) {

290 
ALLTOALL_CE_STAGE_SYNC
:

291 ià(
	`ucc__cuda_g‘_sync
(
sk
è!ğ
UCC_OK
) {

292 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

295 
¡©us
 = 
	`ucc__cuda_®ÉßÎv_£tup_¡¬t
(
sk
);

296 ià(
¡©us
 !ğ
UCC_OK
) {

297 
sk
->
su³r
.
¡©us
 = status;

300 
sk
->
®ÉßÎv_û
.
¡age
 = 
ALLTOALL_CE_STAGE_SETUP
;

302 
ALLTOALL_CE_STAGE_SETUP
:

303 
¡©us
 = 
	`ucc__cuda_®ÉßÎv_£tup_‹¡
(
sk
);

304 ià(
¡©us
 !ğ
UCC_OK
) {

305 
sk
->
su³r
.
¡©us
 = status;

309 
ALLTOALL_CE_STAGE_POST_COPIES
:

310 
¡©us
 = 
	`ucc__cuda_®ÉßÎv_û_po¡_cİ›s
(
sk
);

311 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

312 
sk
->
su³r
.
¡©us
 = status;

315 
sk
->
®ÉßÎv_û
.
¡age
 = 
ALLTOALL_CE_STAGE_COPY
;

317 
ALLTOALL_CE_STAGE_COPY
:

318 
i
 = 0; i < 
sk
->
®ÉßÎv_û
.
num_po¡ed
; i++) {

319 ià(!
sk
->
®ÉßÎv_û
.
exec_sk
[
i
]) {

322 
¡©us
 = 
	`ucc_“_executÜ_sk_‹¡
(
sk
->
®ÉßÎv_û
.
exec_sk
[
i
]);

323 ià(
¡©us
 !ğ
UCC_OK
) {

324 ià(
¡©us
 =ğ
UCC_OPERATION_INITIALIZED
) {

325 
¡©us
 = 
UCC_INPROGRESS
;

327 
sk
->
su³r
.
¡©us
 = status;

330 
	`ucc_“_executÜ_sk_fš®ize
(
sk
->
®ÉßÎv_û
.
exec_sk
[
i
]);

331 
sk
->
®ÉßÎv_û
.
exec_sk
[
i
] = 
NULL
;

333 
¡©us
 =

334 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

335 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

336 
sk
->
su³r
.
¡©us
 = status;

339 
sk
->
®ÉßÎv_û
.
¡age
 = 
ALLTOALL_CE_STAGE_BAR
;

342 
	`ucc_as£¹
(
sk
->
®ÉßÎv_û
.
¡age
 =ğ
ALLTOALL_CE_STAGE_BAR
);

346 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

347 ià(
¡©us
 =ğ
UCC_OK
) {

348 
¡©us
 = 
	`ucc__cuda_®ÉßÎv_unm­
(
sk
);

349 
	`ucc__cuda_put_sync
(
sk
);

352 
sk
->
su³r
.
¡©us
 = status;

353 
	}
}

355 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎv_û_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

357 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

358 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

360 ià(
sk
->
®ÉßÎv_û
.
¡age
 !ğ
ALLTOALL_CE_STAGE_POST_COPIES
) {

361 
sk
->
®ÉßÎv_û
.
¡age
 = 
ALLTOALL_CE_STAGE_SYNC
;

364  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

365 
	}
}

367 
ucc_¡©us_t


368 
	$ucc__cuda_®ÉßÎv_û_Œigg”ed_po¡_£tup
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

370 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

371 
ucc_¡©us_t
 
¡©us
;

374 
¡©us
 = 
	`ucc__cuda_g‘_sync
(
sk
);

375 } 
¡©us
 =ğ
UCC_INPROGRESS
);

376 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

377  
¡©us
;

380 
¡©us
 = 
	`ucc__cuda_®ÉßÎv_£tup_¡¬t
(
sk
);

381 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

382 
	`ucc__cuda_put_sync
(
sk
);

383  
¡©us
;

387 
¡©us
 = 
	`ucc__cuda_®ÉßÎv_£tup_‹¡
(
sk
);

388 } 
¡©us
 =ğ
UCC_INPROGRESS
);

389 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

390 
	`ucc__cuda_put_sync
(
sk
);

391  
¡©us
;

393 
sk
->
®ÉßÎv_û
.
¡age
 = 
ALLTOALL_CE_STAGE_POST_COPIES
;

395  
UCC_OK
;

396 
	}
}

399 
size_t
 
	$ucc__cuda_®ÉßÎv_g‘_size
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

400 
size_t
 *
sizes
, 
ucc_¿nk_t
 
block
)

402  
sizes
[
block
];

403 
	}
}

406 
size_t
 
	$ucc__cuda_®ÉßÎv_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

407 
size_t
 *
di¥l
, 
ucc_¿nk_t
 
block
)

409  
di¥l
[
block
];

410 
	}
}

412 
ucc_¡©us_t
 
	$ucc__cuda_®ÉßÎv_û_š™
(
ucc__cuda_sk_t
 *
sk
)

414 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

415 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

416 
ucc_¡©us_t
 
¡©us
;

417 
size_t
 
d©a_Ën
;

419 ià(!
	`UCC_COLL_ARGS_CONTIG_BUFFER
(
¬gs
)) {

420 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "Do‚ot support‚on-contiguous buffer");

421  
UCC_ERR_NOT_SUPPORTED
;

424 
sk
->
®ÉßÎv_û
.
g‘_size
 = 
ucc__cuda_®ÉßÎv_g‘_size
;

425 
sk
->
®ÉßÎv_û
.
g‘_off£t
 = 
ucc__cuda_®ÉßÎv_g‘_off£t
;

426 
sk
->
®ÉßÎv_û
.
sdt
 = 
¬gs
->
¤c
.
šfo_v
.
d©©y³
;

427 
sk
->
®ÉßÎv_û
.
rdt
 = 
¬gs
->
d¡
.
šfo_v
.
d©©y³
;

428 
sk
->
®ÉßÎv_û
.
sbuf
 = 
¬gs
->
¤c
.
šfo_v
.
bufãr
;

429 
sk
->
®ÉßÎv_û
.
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

430 
sk
->
®ÉßÎv_û
.
súts
 = 
¬gs
->
¤c
.
šfo_v
.
couÁs
;

431 
sk
->
®ÉßÎv_û
.
rúts
 = 
¬gs
->
d¡
.
šfo_v
.
couÁs
;

432 
sk
->
®ÉßÎv_û
.
sdi¥l
 = 
¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
;

433 
sk
->
®ÉßÎv_û
.
rdi¥l
 = 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
;

434 
sk
->
®ÉßÎv_û
.
¡age
 = 
ALLTOALL_CE_STAGE_SYNC
;

436 
d©a_Ën
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
) *

437 
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
,

438 
	`UCC_TL_TEAM_SIZE
(
‹am
));

439 
¡©us
 = 
	`ucc__cuda_mem_šfo_g‘
(
¬gs
->
¤c
.
šfo_v
.
bufãr
, 
d©a_Ën
,

440 &
sk
->
®ÉßÎv_û
.
mem_šfo_¤c
);

441 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

442 
ex™_”r
;

445 ià(
‹am
->
tİo
->
´oxy_Ãeded
) {

446 
d©a_Ën
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
) *

447 
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
,

448 
	`UCC_TL_TEAM_SIZE
(
‹am
));

449 
¡©us
 = 
	`ucc__cuda_mem_šfo_g‘
(
¬gs
->
d¡
.
šfo_v
.
bufãr
, 
d©a_Ën
,

450 &
sk
->
®ÉßÎv_û
.
mem_šfo_d¡
);

451 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

452 
ex™_”r
;

456 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

457 
sk
->
su³r
.
po¡
 = 
ucc__cuda_®ÉßÎv_û_¡¬t
;

458 
sk
->
su³r
.
Œigg”ed_po¡_£tup
 =

459 
ucc__cuda_®ÉßÎv_û_Œigg”ed_po¡_£tup
;

460 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_®ÉßÎv_û_´og»ss
;

461 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_®ÉßÎv_û_fš®ize
;

462 
sk
->
b¬
 = 
	`TASK_BAR
(task);

464  
UCC_OK
;

466 
ex™_”r
:

467  
¡©us
;

468 
	}
}

	@src/components/tl/cuda/bcast/bcast.c

7 
	~"bÿ¡.h
"

8 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__cuda_bÿ¡_®gs
[
UCC_TL_CUDA_BCAST_ALG_LAST
 + 1] = {

12 [
UCC_TL_CUDA_BCAST_ALG_LINEAR
] = {.
id
 = UCC_TL_CUDA_BCAST_ALG_LINEAR,

13 .
	gÇme
 = "linear",

14 .
	gdesc
 = "linear bcast‡lgorithm"},

15 [
UCC_TL_CUDA_BCAST_ALG_LAST
] = {.
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

17 
ucc_¡©us_t
 
	$ucc__cuda_bÿ¡_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

18 
ucc_ba£_‹am_t
 *
_‹am
,

19 
ucc_cŞl_sk_t
 **
sk_p
)

21 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

23 ià(
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
)) {

24  
	`ucc__cuda_bÿ¡_lš—r_š™
(
cŞl_¬gs
, 
_‹am
, 
sk_p
);

26  
UCC_ERR_NOT_SUPPORTED
;

28 
	}
}

	@src/components/tl/cuda/bcast/bcast.h

7 #iâdeà
BCAST_H_


8 
	#BCAST_H_


	)

10 
	~"_cuda.h
"

11 
	~"_cuda_cŞl.h
"

15 
	mUCC_TL_CUDA_BCAST_ALG_LINEAR
,

16 
	mUCC_TL_CUDA_BCAST_ALG_LAST


19 
ucc_ba£_cŞl_®g_šfo_t


20 
ucc__cuda_bÿ¡_®gs
[
UCC_TL_CUDA_BCAST_ALG_LAST
 + 1];

22 
	#UCC_TL_CUDA_BCAST_DEFAULT_ALG_SELECT_STR
 "bÿ¡:cuda:@0"

	)

24 
ucc_¡©us_t
 
ucc__cuda_bÿ¡_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

25 
ucc_ba£_‹am_t
 *
_‹am
,

26 
ucc_cŞl_sk_t
 **
sk_p
);

28 
ucc_¡©us_t
 
ucc__cuda_bÿ¡_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

29 
ucc_ba£_‹am_t
 *
_‹am
,

30 
ucc_cŞl_sk_t
 **
sk_p
);

32 
šlše
 
	$ucc__cuda_bÿ¡_®g_äom_¡r
(cÚ¡ *
¡r
)

34 
i
;

35 
i
 = 0; i < 
UCC_TL_CUDA_BCAST_ALG_LAST
; i++) {

36 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__cuda_bÿ¡_®gs
[
i
].
Çme
)) {

40  
i
;

41 
	}
}

	@src/components/tl/cuda/bcast/bcast_linear.c

7 
	~"bÿ¡.h
"

11 
	mSTAGE_INIT_BAR_ROOT
,

12 
	mSTAGE_FIND_BAR_PEER
,

14 
	mSTAGE_SYNC
,

15 
	mSTAGE_SETUP
,

17 
	mSTAGE_COPY
,

18 
	mSTAGE_WAIT_COPY
,

19 
	mSTAGE_WAIT_ALL
,

20 
	mSTAGE_WAIT_COMPLETION
,

22 
	mSTAGE_WAIT_ROOT
,

23 
	mSTAGE_CLIENT_COPY
,

24 
	mSTAGE_CLIENT_COPY_WAIT
,

25 
	mSTAGE_CLIENT_WAIT_COMPLETION
,

28 
šlše
 
ucc_¡©us_t


29 
	$ucc__cuda_bÿ¡_lš—r_£tup_¡¬t
(
ucc__cuda_sk_t
 *
sk
)

31 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

32 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

34 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 0, 0);

35 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

37  
	`ucc__cuda_shm_b¬r›r_¡¬t
(
Œªk
, 
sk
->
b¬
);

38 
	}
}

41 
šlše
 
ucc_¡©us_t


42 
	$ucc__cuda_bÿ¡_lš—r_£tup_‹¡
(
ucc__cuda_sk_t
 *
sk
)

44 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

45  
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

46 
	}
}

49 
šlše
 
size_t
 
	$g‘_¿w_sü©ch_size
(
ucc__cuda_‹am_t
 *
‹am
)

51  
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
)->
cfg
.
sü©ch_size
;

52 
	}
}

55 
šlše
 
ucc_¡©us_t
 
	$ecİy
(*
d¡
, *
¤c
, 
size_t
 
size
,

56 
ucc_“_executÜ_t
 *
exec
,

57 
ucc_“_executÜ_sk_t
 **
‘ask
)

59 
ucc_“_executÜ_sk_¬gs_t
 
exec_¬gs
 = {0};

61 
exec_¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

62 
exec_¬gs
.
cİy
.
d¡
 = dst;

63 
exec_¬gs
.
cİy
.
¤c
 = src;

64 
exec_¬gs
.
cİy
.
Ën
 = 
size
;

65  
	`ucc_“_executÜ_sk_po¡
(
exec
, &
exec_¬gs
, 
‘ask
);

66 
	}
}

69 
šlše
 
ucc_¡©us_t
 
	$roÙ_fšd_ä“_b¬r›r
(
ucc__cuda_sk_t
 *
sk
)

71 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

72 
ušt32_t
 
max_cÚcu¼’t
 = 
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
)->
cfg
.max_concurrent;

73 
ucc__cuda_shm_b¬r›r_t
 *
cu¼_b¬
;

74 
i
;

75 
ucc_¡©us_t
 
¡
;

78 
i
 = 0; i < 
max_cÚcu¼’t
; ++i) {

79 
cu¼_b¬
 = 
	`UCC_TL_CUDA_TEAM_BARRIER
(
‹am
, 
max_cÚcu¼’t
 + 
i
);

81 ià(
	`ucc_©omic_csw­64
(&
cu¼_b¬
->
g
, 
UCC_TL_CUDA_TAG_FREE
,

82 
sk
->
bÿ¡_lš—r
.
key
è=ğ
UCC_TL_CUDA_TAG_FREE
) {

83 
	`ucc_debug
("Acquire barrier: %p idx: %d marked withag: %ld",

84 
cu¼_b¬
, 
i
, cu¼_b¬->
g
);

85 
sk
->
b¬
 = 
cu¼_b¬
;

86 
¡
 = 
	`ucc__cuda_shm_b¬r›r_š™_roÙ
(

87 
sk
->
sub£t
.
m­
.
•_num
,ask->sub£t.
my¿nk
,

88 
sk
->
bÿ¡_lš—r
.
roÙ
,ask->
b¬
);

89 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

90 
	`ucc_”rÜ
("failedo init„oot barrier");

91  
UCC_ERR_NO_RESOURCE
;

94 
sk
->
cŞl_id
 = 
i
 + 
max_cÚcu¼’t
;

95  
UCC_OK
;

99  
UCC_ERR_NOT_FOUND
;

100 
	}
}

103 
šlše
 
ucc_¡©us_t
 
	$³”_fšd_ä“_b¬r›r
(
ucc__cuda_sk_t
 *
sk
)

105 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

106 
ušt32_t
 
max_cÚcu¼’t
 = 
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
)->
cfg
.max_concurrent;

107 
ucc__cuda_shm_b¬r›r_t
 *
cu¼_b¬
;

108 
i
;

109 
ucc_¡©us_t
 
¡
;

111 
i
 = 0; i < 
max_cÚcu¼’t
; ++i) {

112 
cu¼_b¬
 = 
	`UCC_TL_CUDA_TEAM_BARRIER
(
‹am
, 
max_cÚcu¼’t
 + 
i
);

114 ià(
cu¼_b¬
->
g
 =ğ
sk
->
bÿ¡_lš—r
.
key
) {

115 
sk
->
b¬
 = 
cu¼_b¬
;

116 
¡
 = 
	`ucc__cuda_shm_b¬r›r_š™_roÙ
(

117 
sk
->
sub£t
.
m­
.
•_num
,ask->sub£t.
my¿nk
,

118 
sk
->
bÿ¡_lš—r
.
roÙ
,ask->
b¬
);

119 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

120 
	`ucc_”rÜ
("failedo init…eer barrier");

121  
UCC_ERR_NO_RESOURCE
;

123 
sk
->
cŞl_id
 = 
i
 + 
max_cÚcu¼’t
;

124  
UCC_OK
;

128  
UCC_ERR_NOT_FOUND
;

129 
	}
}

131 
ucc_¡©us_t


132 
	$ucc__cuda_bÿ¡_lš—r_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

134 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

136 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizingask %p",ask);

137 
	`ucc__cuda_sk_put
(
sk
);

138  
UCC_OK
;

139 
	}
}

141 
	$ucc__cuda_bÿ¡_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

143 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

144 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

145 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

146 
size_t
 
h®f_sü©ch_size
 = 
	`g‘_¿w_sü©ch_size
(
‹am
) / 2;

147 
ucc_¿nk_t
 
tsize
 = 
	`UCC_COLL_ARGS_ACTIVE_SET
(&
	`TASK_ARGS
(
sk
))

148 ? (
ucc_¿nk_t
)
sk
->
sub£t
.
m­
.
•_num


149 : 
	`UCC_TL_TEAM_SIZE
(
‹am
);

150 
size_t
 
chunk_size
 = 
	`ucc_mš
(

151 
h®f_sü©ch_size
,

152 
sk
->
bÿ¡_lš—r
.
size
 -ask->bÿ¡_lš—r.
¡•
 * 
h®f_sü©ch_size
);

153 
size_t
 
off£t_buff
 = 
sk
->
bÿ¡_lš—r
.
¡•
 * 
h®f_sü©ch_size
;

154 
ucc_“_executÜ_t
 *
exec
;

155 
ucc_“_executÜ_sk_t
 *
‘ask
;

156 *
sbuf
, *
dbuf
;

157 
ucc_¿nk_t
 
³”
;

158 
ucc_¡©us_t
 
¡
;

159 
i
;

161 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

163 
¡
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

164 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

165 
sk
->
su³r
.
¡©us
 = 
¡
;

169 
sk
->
bÿ¡_lš—r
.
¡age
) {

170 
STAGE_INIT_BAR_ROOT
:

171 
¡
 = 
	`roÙ_fšd_ä“_b¬r›r
(
sk
);

172 ià(
¡
 =ğ
UCC_OK
) {

173 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_SYNC
;

174 } ià(
¡
 !ğ
UCC_ERR_NOT_FOUND
) {

175 
sk
->
su³r
.
¡©us
 = 
¡
;

179 
STAGE_FIND_BAR_PEER
:

180 
¡
 = 
	`³”_fšd_ä“_b¬r›r
(
sk
);

181 ià(
¡
 =ğ
UCC_OK
) {

183 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_SYNC
;

184 } ià(
¡
 !ğ
UCC_ERR_NOT_FOUND
) {

185 
sk
->
su³r
.
¡©us
 = 
¡
;

189 
STAGE_SYNC
:

190 ià(
	`ucc__cuda_g‘_sync_roÙ
(
sk
,ask->
bÿ¡_lš—r
.
roÙ
è!ğ
UCC_OK
) {

193 
sk
->
bÿ¡_lš—r
.
¡•
 = 0;

194 
¡
 = 
	`ucc__cuda_bÿ¡_lš—r_£tup_¡¬t
(
sk
);

195 ià(
¡
 !ğ
UCC_OK
) {

196 
sk
->
su³r
.
¡©us
 = 
¡
;

199 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_SETUP
;

201 
STAGE_SETUP
:

202 
¡
 = 
	`ucc__cuda_bÿ¡_lš—r_£tup_‹¡
(
sk
);

203 ià(
¡
 !ğ
UCC_OK
) {

204 
sk
->
su³r
.
¡©us
 = 
¡
;

207 ià(
Œªk
 =ğ
sk
->
bÿ¡_lš—r
.
roÙ
) {

208 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_COPY
;

210 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_WAIT_ROOT
;

217 ià(
Œªk
 =ğ
sk
->
bÿ¡_lš—r
.
roÙ
) {

220 
sk
->
bÿ¡_lš—r
.
¡age
) {

221 
STAGE_COPY
:

223 
dbuf
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
Œªk
),

224 
sk
->
bÿ¡_lš—r
.
¡•
 % 2 * 
h®f_sü©ch_size
);

225 
sbuf
 = 
	`PTR_OFFSET
(
sk
->
bÿ¡_lš—r
.sbuf, 
off£t_buff
);

226 
¡
 = 
	`ecİy
(
dbuf
, 
sbuf
, 
chunk_size
, 
exec
,

227 &
sk
->
bÿ¡_lš—r
.
exec_sk
);

228 ià(
¡
 !ğ
UCC_OK
) {

229 
	`ucc_”rÜ
("failedo…ostƒcopyask");

230 
sk
->
su³r
.
¡©us
 = 
¡
;

233 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_WAIT_COPY
;

235 
STAGE_WAIT_COPY
:

236 
‘ask
 = 
sk
->
bÿ¡_lš—r
.
exec_sk
;

237 
	`ucc_as£¹
(
NULL
 !ğ
‘ask
);

238 
¡
 = 
	`ucc_“_executÜ_sk_‹¡
(
‘ask
);

239 ià(
¡
 !ğ
UCC_OK
) {

242 
	`ucc_“_executÜ_sk_fš®ize
(
‘ask
);

243 
sk
->
bÿ¡_lš—r
.
exec_sk
 = 
NULL
;

245 ++
sk
->
bÿ¡_lš—r
.
¡•
;

246 
	`£t_¿nk_¡•
(
sk
,ask->
bÿ¡_lš—r
.
roÙ
,

247 
sk
->
bÿ¡_lš—r
.
¡•
, 0);

248 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_WAIT_ALL
;

250 
STAGE_WAIT_ALL
:

251 
i
 = 0; i < 
tsize
; ++i) {

252 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(&
	`TASK_ARGS
(
sk
))) {

254 
³”
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, 
i
);

256 
³”
 = 
i
;

259 ià(
	`g‘_¿nk_¡•
(
sk
, 
³”
, 0) <

260 
sk
->
bÿ¡_lš—r
.
¡•
 - 1) {

265 ià(
sk
->
bÿ¡_lš—r
.
¡•
 <ask->bÿ¡_lš—r.
num_¡•s
) {

267 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_COPY
;

271 
¡
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
Œªk
, 
sk
->
b¬
);

272 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

273 
	`ucc_”rÜ
("failedo start barrier from„oot„ank");

274 
sk
->
su³r
.
¡©us
 = 
¡
;

277 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_WAIT_COMPLETION
;

279 
STAGE_WAIT_COMPLETION
:

280 
¡
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
Œªk
, 
sk
->
b¬
);

281 ià(
¡
 !ğ
UCC_OK
) {

283 
sk
->
su³r
.
¡©us
 = 
¡
;

287 
	`ucc_debug
("R–—£ b¬: %°w™hag: %ld", 
sk
->
b¬
,

288 
sk
->
b¬
->
g
);

289 
sk
->
b¬
->
g
 = 
UCC_TL_CUDA_TAG_FREE
;

290 
	`ucc__cuda_put_sync_roÙ
(
sk
,ask->
bÿ¡_lš—r
.
roÙ
);

291 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

294 
	`ucc_as£¹
(0);

300 
sk
->
bÿ¡_lš—r
.
¡age
) {

301 
STAGE_WAIT_ROOT
:

302 ià(
	`g‘_¿nk_¡•
(
sk
,ask->
bÿ¡_lš—r
.
roÙ
, 0) >

303 
sk
->
bÿ¡_lš—r
.
¡•
) {

304 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_CLIENT_COPY
;

310 
STAGE_CLIENT_COPY
:

312 
dbuf
 = 
	`PTR_OFFSET
(
sk
->
bÿ¡_lš—r
.
sbuf
, 
off£t_buff
);

313 
sbuf
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
,ask->
bÿ¡_lš—r
.
roÙ
),

314 
sk
->
bÿ¡_lš—r
.
¡•
 % 2 * 
h®f_sü©ch_size
);

315 
¡
 = 
	`ecİy
(
dbuf
, 
sbuf
, 
chunk_size
, 
exec
,

316 &
sk
->
bÿ¡_lš—r
.
exec_sk
);

317 ià(
¡
 !ğ
UCC_OK
) {

318 
	`ucc_”rÜ
("failedo…ostƒcopyask‡t client");

319 
sk
->
su³r
.
¡©us
 = 
¡
;

322 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_CLIENT_COPY_WAIT
;

324 
STAGE_CLIENT_COPY_WAIT
:

325 
‘ask
 = 
sk
->
bÿ¡_lš—r
.
exec_sk
;

326 
	`ucc_as£¹
(
NULL
 !ğ
‘ask
);

327 
¡
 = 
	`ucc_“_executÜ_sk_‹¡
(
‘ask
);

328 ià(
¡
 !ğ
UCC_OK
) {

331 
	`ucc_“_executÜ_sk_fš®ize
(
‘ask
);

332 
sk
->
bÿ¡_lš—r
.
exec_sk
 = 
NULL
;

333 ++
sk
->
bÿ¡_lš—r
.
¡•
;

334 
	`£t_¿nk_¡•
(
sk
, 
Œªk
,ask->
bÿ¡_lš—r
.
¡•
, 0);

335 ià(
sk
->
bÿ¡_lš—r
.
¡•
 <ask->bÿ¡_lš—r.
num_¡•s
) {

336 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_WAIT_ROOT
;

340 
¡
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
Œªk
, 
sk
->
b¬
);

341 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

342 
	`ucc_”rÜ
("failedo start barrier from…eer„ank");

343 
sk
->
su³r
.
¡©us
 = 
¡
;

346 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_CLIENT_WAIT_COMPLETION
;

348 
STAGE_CLIENT_WAIT_COMPLETION
:

349 
¡
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
Œªk
, 
sk
->
b¬
);

350 ià(
¡
 !ğ
UCC_OK
) {

352 
sk
->
su³r
.
¡©us
 = 
¡
;

355 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

358 
	`ucc_as£¹
(0);

362 
	}
}

364 
ucc_¡©us_t
 
	$ucc__cuda_bÿ¡_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

366 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

367 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

369 
sk
->
bÿ¡_lš—r
.
¡•
 = 0;

370 
sk
->
bÿ¡_lš—r
.
¡age
 = 
STAGE_SYNC
;

372 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(&
	`TASK_ARGS
(
sk
))) {

373 
sk
->
bÿ¡_lš—r
.
¡age
 =

374 
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
sk
->
bÿ¡_lš—r
.
roÙ


375 ? 
STAGE_INIT_BAR_ROOT


376 : 
STAGE_FIND_BAR_PEER
;

379 
	`ucc_debug
("bcast†inear start dt: %s, buffer size: %ld,‚um_steps: %d",

380 
	`ucc_d©©y³_¡r
(
sk
->
bÿ¡_lš—r
.
dt
),ask->bÿ¡_lš—r.
size
,

381 
sk
->
bÿ¡_lš—r
.
num_¡•s
);

383  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

384 
	}
}

386 
ucc_¡©us_t
 
	$ucc__cuda_bÿ¡_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

387 
ucc_ba£_‹am_t
 *
_‹am
,

388 
ucc_cŞl_sk_t
 **
sk_p
)

390 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

391 
ucc__cuda_sk_t
 *
sk
;

392 
ucc_¡©us_t
 
¡©us
;

394 ià(!
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
) ||

395 
	`UCC_TL_TEAM_SIZE
(
‹am
è- 1 > 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
) {

396  
UCC_ERR_NOT_SUPPORTED
;

399 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

400 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

401  
¡©us
;

404 
sk
->
bÿ¡_lš—r
.
roÙ
 = 
cŞl_¬gs
->
¬gs
.root;

405 
sk
->
bÿ¡_lš—r
.
dt
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
d©©y³
;

406 
sk
->
bÿ¡_lš—r
.
sbuf
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
bufãr
;

407 
sk
->
bÿ¡_lš—r
.
size
 =

408 
	`ucc_dt_size
(
sk
->
bÿ¡_lš—r
.
dt
è* 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
couÁ
;

409 
sk
->
bÿ¡_lš—r
.
num_¡•s
 = 
	`ucc_div_round_up
(

410 
sk
->
bÿ¡_lš—r
.
size
, 
	`g‘_¿w_sü©ch_size
(
‹am
) / 2);

412 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

413 
sk
->
su³r
.
po¡
 = 
ucc__cuda_bÿ¡_lš—r_¡¬t
;

414 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_bÿ¡_lš—r_´og»ss
;

415 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_bÿ¡_lš—r_fš®ize
;

417 *
sk_p
 = &
sk
->
su³r
;

418  
UCC_OK
;

419 
	}
}

	@src/components/tl/cuda/kernels/allreduce_kernel.h

7 #iâdeà
UCC_TL_CUDA_ALLREDUCE_KERNEL_H_


8 
	#UCC_TL_CUDA_ALLREDUCE_KERNEL_H_


	)

10 
	~<cuda.h
>

11 
	~"ucc/­i/ucc.h
"

13 #ifdeà
__ılu¥lus


18 
ucc_¡©us_t
 
po¡_®Ìeduû_k”Ãl
(
cudaSŒ—m_t
 
¡»am
, 
CUdeviû±r
 
¤c_addr
,

19 
size_t
 
¤c_size_by‹s
, 
ušt32_t
 
¿nk
,

20 
ušt32_t
 
tsize
);

22 #ifdeà
__ılu¥lus


	@src/components/tl/cuda/kernels/reduce_scatter_kernel.h

7 #iâdeà
UCC_TL_CUDA_REDUCE_SCATTER_KERNEL_H_


8 
	#UCC_TL_CUDA_REDUCE_SCATTER_KERNEL_H_


	)

10 
	~<cuda.h
>

11 
	~"ucc/­i/ucc.h
"

13 #ifdeà
__ılu¥lus


18 
ucc_¡©us_t
 
po¡_»duû_sÿ‰”_k”Ãl
(
cudaSŒ—m_t
 
¡»am
,

19 
CUdeviû±r
 
¤c_addr
,

20 
CUdeviû±r
 
d¡_addr
,

21 
size_t
 
¤c_size_by‹s
, 
ušt32_t
 
¿nk
,

22 
ušt32_t
 
tsize
);

23 #ifdeà
__ılu¥lus


	@src/components/tl/cuda/reduce_scatter/reduce_scatter.c

7 
	~"»duû_sÿ‰”.h
"

8 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__cuda_»duû_sÿ‰”_®gs
[
UCC_TL_CUDA_REDUCE_SCATTER_ALG_LAST
 + 1] = {

12 [
UCC_TL_CUDA_REDUCE_SCATTER_ALG_AUTO
] =

13 {.
id
 = 
UCC_TL_CUDA_REDUCE_SCATTER_ALG_AUTO
,

14 .
	gÇme
 = "auto",

15 .
	gdesc
 = "choose„educe scatter‡lgorithm based on CUDAopology"},

16 [
UCC_TL_CUDA_REDUCE_SCATTER_ALG_RING
] =

17 {.
id
 = 
UCC_TL_CUDA_REDUCE_SCATTER_ALG_RING
,

18 .
	gÇme
 = "ring",

19 .
	gdesc
 = "multiring„educe scatter‡lgorithm"},

20 [
UCC_TL_CUDA_REDUCE_SCATTER_ALG_LINEAR
] =

21 {.
id
 = 
UCC_TL_CUDA_REDUCE_SCATTER_ALG_LINEAR
,

22 .
	gÇme
 = "linear",

23 .
	gdesc
 = "linear„educe scatter‡lgorithm"},

24 #ifdeà
HAVE_NVLS


25 [
UCC_TL_CUDA_REDUCE_SCATTER_ALG_NVLS
] =

26 {.
id
 = 
UCC_TL_CUDA_REDUCE_SCATTER_ALG_NVLS
,

27 .
	gÇme
 = "nvls",

28 .
	gdesc
 = "nvls„educe scatter‡lgorithm"},

30 [
UCC_TL_CUDA_REDUCE_SCATTER_ALG_LAST
] = {

31 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

33 
size_t
 
	$ucc__cuda_»duû_sÿ‰”_g‘_couÁ
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

34 
ucc_¿nk_t
 
block
)

36 cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

37 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

39 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

40 
couÁ
 = 
¬gs
->
d¡
.
šfo
.couÁ / 
	`UCC_TL_TEAM_SIZE
(
	`TASK_TEAM
(
sk
));

42  
couÁ
;

43 
	}
}

45 
size_t
 
	$ucc__cuda_»duû_sÿ‰”_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

46 
ucc_¿nk_t
 
block
)

48  
	`ucc__cuda_»duû_sÿ‰”_g‘_couÁ
(
sk
, 
block
) * block;

49 
	}
}

51 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

52 
ucc_ba£_‹am_t
 *
_‹am
,

53 
ucc_cŞl_sk_t
 **
sk_p
)

55 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

57 ià(
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
)) {

58  
	`ucc__cuda_»duû_sÿ‰”_lš—r_š™
(
cŞl_¬gs
, 
_‹am
,

59 
sk_p
);

61  
	`ucc__cuda_»duû_sÿ‰”_ršg_š™
(
cŞl_¬gs
, 
_‹am
, 
sk_p
);

63 
	}
}

	@src/components/tl/cuda/reduce_scatter/reduce_scatter.h

7 #iâdeà
REDUCE_SCATTER_H_


8 
	#REDUCE_SCATTER_H_


	)

10 
	~"_cuda.h
"

11 
	~"_cuda_cŞl.h
"

15 
	mUCC_TL_CUDA_REDUCE_SCATTER_ALG_AUTO
,

16 
	mUCC_TL_CUDA_REDUCE_SCATTER_ALG_RING
,

17 
	mUCC_TL_CUDA_REDUCE_SCATTER_ALG_LINEAR
,

18 #ifdeà
HAVE_NVLS


19 
	mUCC_TL_CUDA_REDUCE_SCATTER_ALG_NVLS
,

21 
	mUCC_TL_CUDA_REDUCE_SCATTER_ALG_LAST


24 
ucc_ba£_cŞl_®g_šfo_t


25 
ucc__cuda_»duû_sÿ‰”_®gs
[
UCC_TL_CUDA_REDUCE_SCATTER_ALG_LAST
 + 1];

27 
	#UCC_TL_CUDA_REDUCE_SCATTER_DEFAULT_ALG_SELECT_STR
 "»duû_sÿ‰”:cuda:@0"

	)

29 
size_t
 
ucc__cuda_»duû_sÿ‰”_g‘_couÁ
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

30 
ucc_¿nk_t
 
block
);

32 
size_t
 
ucc__cuda_»duû_sÿ‰”_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

33 
ucc_¿nk_t
 
block
);

35 
ucc_¡©us_t
 
ucc__cuda_»duû_sÿ‰”_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

36 
ucc_ba£_‹am_t
 *
_‹am
,

37 
ucc_cŞl_sk_t
 **
sk_p
);

39 
ucc_¡©us_t
 
ucc__cuda_»duû_sÿ‰”_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

40 
ucc_ba£_‹am_t
 * 
_‹am
,

41 
ucc_cŞl_sk_t
 ** 
sk_p
);

43 
ucc_¡©us_t
 
ucc__cuda_»duû_sÿ‰”_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

44 
ucc_ba£_‹am_t
 * 
_‹am
,

45 
ucc_cŞl_sk_t
 ** 
sk_p
);

46 #ifdeà
HAVE_NVLS


47 
ucc_¡©us_t
 
ucc__cuda_»duû_sÿ‰”_nvls_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

48 
ucc_ba£_‹am_t
 * 
_‹am
,

49 
ucc_cŞl_sk_t
 ** 
sk_p
);

52 
šlše
 
	$ucc__cuda_»duû_sÿ‰”_®g_äom_¡r
(cÚ¡ *
¡r
)

54 
i
;

55 
i
 = 0; i < 
UCC_TL_CUDA_REDUCE_SCATTER_ALG_LAST
; i++) {

56 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__cuda_»duû_sÿ‰”_®gs
[
i
].
Çme
)) {

60  
i
;

61 
	}
}

	@src/components/tl/cuda/reduce_scatter/reduce_scatter_linear.c

7 
	~"»duû_sÿ‰”v/»duû_sÿ‰”v.h
"

8 
	~"»duû_sÿ‰”/»duû_sÿ‰”.h
"

10 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

11 
ucc_ba£_‹am_t
 * 
_‹am
,

12 
ucc_cŞl_sk_t
 ** 
sk_p
)

14 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

15 
ucc__cuda_sk_t
 *
sk
;

16 
ucc_¡©us_t
 
¡©us
;

18 ià(
cŞl_¬gs
->
¬gs
.
İ
 =ğ
UCC_OP_AVG
) {

19  
UCC_ERR_NOT_SUPPORTED
;

22 ià(
	`ucc_uÆik–y
(!
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
) ||

23 
	`UCC_TL_TEAM_SIZE
(
‹am
è- 1 > 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
)) {

24  
UCC_ERR_NOT_SUPPORTED
;

27 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

28 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

29  
¡©us
;

32 
sk
->
»duû_sÿ‰”v_lš—r
.
g‘_couÁ
 =

33 
ucc__cuda_»duû_sÿ‰”_g‘_couÁ
;

34 
sk
->
»duû_sÿ‰”v_lš—r
.
g‘_off£t
 =

35 
ucc__cuda_»duû_sÿ‰”_g‘_off£t
;

36 
sk
->
»duû_sÿ‰”v_lš—r
.
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

37 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

38 
sk
->
su³r
.
po¡
 = 
ucc__cuda_»duû_sÿ‰”v_lš—r_¡¬t
;

39 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_»duû_sÿ‰”v_lš—r_´og»ss
;

40 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_»duû_sÿ‰”v_lš—r_fš®ize
;

41 
sk
->
b¬
 = 
	`TASK_BAR
(task);

43 *
sk_p
 = &
sk
->
su³r
;

44  
UCC_OK
;

45 
	}
}

	@src/components/tl/cuda/reduce_scatter/reduce_scatter_nvls.c

7 
	~"»duû_sÿ‰”/»duû_sÿ‰”.h
"

8 
	~<ucc/­i/ucc.h
>

10 
	~"uts/¬ch/cuda_def.h
"

11 
	~"k”Ãls/»duû_sÿ‰”_k”Ãl.h
"

13 
	~<cuda_ruÁime.h
>

14 
	~<cuda.h
>

17 
	mSTAGE_COPY
,

18 
	mSTAGE_COPY_BAR_START
,

19 
	mSTAGE_COPY_BAR_TEST
,

20 
	mSTAGE_KERNEL_START
,

21 
	mSTAGE_KERNEL
,

22 
	mSTAGE_BARRIER_START
,

23 
	mSTAGE_BARRIER_TEST
,

26 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”v_nvls_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

28 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

29 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

30 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

31 
ucc__cuda_nvls_t
 *
nvls
 = &
‹am
->nvls;

32 
cudaSŒ—m_t
 
¡»am
 = 
‹am
->stream;

33 
ucc_d©©y³_t
 
dt
 = 
sk
->
»duû_sÿ‰”v_nvls
.dt;

35 
size_t
 
¤c_size_by‹s
 = 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
	`ucc_dt_size
(
dt
);

36 
size_t
 
d¡_size_by‹s
 = 
¬gs
->
d¡
.
šfo
.
couÁ
 * 
	`ucc_dt_size
(
dt
);

38 
	`ucc_debug
("reduce_scatterv_nvls_start symmetric uc‡ddr: %lld mc‡ddr: "

40 
nvls
->
uc_va
,‚vls->
mc_va
, 
¤c_size_by‹s
, 
d¡_size_by‹s
);

42 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE_SCATTER
) {

43 
sk
->
»duû_sÿ‰”v_nvls
.
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

45 
sk
->
»duû_sÿ‰”v_nvls
.
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

48 
sk
->
»duû_sÿ‰”v_nvls
.
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

49 
sk
->
»duû_sÿ‰”v_nvls
.
¤c_size_by‹s
 = src_size_bytes;

50 
sk
->
»duû_sÿ‰”v_nvls
.
d¡_size_by‹s
 = dst_size_bytes;

52 
sk
->
»duû_sÿ‰”v_nvls
.
¡age
 = 
STAGE_COPY
;

55 
	`CUDA_CHECK
(
	`cudaMemıyAsync
((*)
nvls
->
uc_va
, 
¬gs
->
¤c
.
šfo
.
bufãr
,

56 
¤c_size_by‹s
, 
cudaMemıyDeviûToDeviû
,

57 
¡»am
));

58 
	`CUDA_CHECK
(
	`cudaEv’tRecÜd
(
sk
->
»duû_sÿ‰”v_nvls
.
evtCİy
, 
¡»am
));

60  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

61 
	}
}

63 
	$ucc__cuda_»duû_sÿ‰”v_nvls_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

65 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

66 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

67 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

68 
cudaEv’t_t
 
evt
 = 
sk
->
»duû_sÿ‰”v_nvls
.
evtCom¶‘iÚ
;

69 
ucc__cuda_nvls_t
 *
nvls
 = &
‹am
->nvls;

70 
cudaSŒ—m_t
 
¡»am
 = 
‹am
->stream;

72 
ucc_¡©us_t
 
¡©us
;

73 
cudaE¼Ü_t
 
cuda_¡©us
;

75 
sk
->
»duû_sÿ‰”v_nvls
.
¡age
) {

76 
STAGE_COPY
:

77 
cuda_¡©us
 = 
	`cudaEv’tQu”y
(
sk
->
»duû_sÿ‰”v_nvls
.
evtCİy
);

78 ià(
cuda_¡©us
 =ğ
cudaE¼ÜNÙR—dy
) {

79 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

82 ià(
cuda_¡©us
 !ğ
cudaSucûss
) {

83 
	`ucc_”rÜ
("cudaEventQuery failed %s",

84 
	`cudaG‘E¼ÜSŒšg
(
cuda_¡©us
));

85 
sk
->
su³r
.
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

88 
sk
->
»duû_sÿ‰”v_nvls
.
¡age
 = 
STAGE_COPY_BAR_START
;

90 
STAGE_COPY_BAR_START
:

91 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
Œªk
, 
sk
->
b¬
);

92 ià(
¡©us
 !ğ
UCC_OK
) {

93 
	`ucc_”rÜ
("reduce scatter barrier start failed");

94 
sk
->
su³r
.
¡©us
 = status;

97 
sk
->
»duû_sÿ‰”v_nvls
.
¡age
 = 
STAGE_COPY_BAR_TEST
;

99 
STAGE_COPY_BAR_TEST
:

100 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
Œªk
, 
sk
->
b¬
);

101 ià(
¡©us
 !ğ
UCC_OK
) {

102 
sk
->
su³r
.
¡©us
 = status;

105 
sk
->
»duû_sÿ‰”v_nvls
.
¡age
 = 
STAGE_KERNEL_START
;

107 
STAGE_KERNEL_START
:

108 
¡©us
 = 
	`po¡_»duû_sÿ‰”_k”Ãl
(
¡»am
, 
nvls
->
mc_va
,

109 (
CUdeviû±r
è
sk
->
»duû_sÿ‰”v_nvls
.
rbuf
,

110 
sk
->
»duû_sÿ‰”v_nvls
.
¤c_size_by‹s
, 
Œªk
,

111 
	`UCC_TL_TEAM_SIZE
(
‹am
));

112 ià(
¡©us
 !ğ
UCC_OK
) {

113 
	`ucc_”rÜ
("failedo…ost„educe scatter kernel");

114 
sk
->
su³r
.
¡©us
 = status;

117 
	`ucc_debug
("reduce scatter kernel…osted");

118 
cuda_¡©us
 = 
	`cudaEv’tRecÜd
(
sk
->
»duû_sÿ‰”v_nvls
.
evtCom¶‘iÚ
, 
¡»am
);

119 ià(
cuda_¡©us
 !ğ
cudaSucûss
) {

120 
	`ucc_”rÜ
("cudaEv’tRecÜd faed: %s", 
	`cudaG‘E¼ÜSŒšg
(
cuda_¡©us
));

121 
sk
->
su³r
.
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

124 
sk
->
»duû_sÿ‰”v_nvls
.
¡age
 = 
STAGE_KERNEL
;

126 
STAGE_KERNEL
:

127 
cuda_¡©us
 = 
	`cudaEv’tQu”y
(
evt
);

128 ià(
cuda_¡©us
 =ğ
cudaE¼ÜNÙR—dy
) {

129 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

132 ià(
cuda_¡©us
 !ğ
cudaSucûss
) {

133 
	`ucc_”rÜ
("cudaEventQuery failed %s",

134 
	`cudaG‘E¼ÜSŒšg
(
cuda_¡©us
));

135 
sk
->
su³r
.
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

138 
sk
->
»duû_sÿ‰”v_nvls
.
¡age
 = 
STAGE_BARRIER_START
;

140 
STAGE_BARRIER_START
:

141 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
Œªk
, 
sk
->
b¬
);

142 ià(
¡©us
 !ğ
UCC_OK
) {

143 
	`ucc_”rÜ
("reduce scatter barrier start failed");

144 
sk
->
su³r
.
¡©us
 = status;

147 
sk
->
»duû_sÿ‰”v_nvls
.
¡age
 = 
STAGE_BARRIER_TEST
;

149 
STAGE_BARRIER_TEST
:

150 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
Œªk
, 
sk
->
b¬
);

151 ià(
¡©us
 !ğ
UCC_OK
) {

152 
sk
->
su³r
.
¡©us
 = status;

155 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

156 
	`ucc_debug
("reduce scatter kernel is completed");

160 
	}
}

162 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”v_nvls_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

164 
ucc__cuda_sk_t
 *
_sk
 = 
	`ucc_d”ived_of
(
sk
, ucc_tl_cuda_task_t);

166 
	`CUDA_CHECK
(
	`cudaEv’tDe¡roy
(
_sk
->
»duû_sÿ‰”v_nvls
.
evtCom¶‘iÚ
));

167 
	`CUDA_CHECK
(
	`cudaEv’tDe¡roy
(
_sk
->
»duû_sÿ‰”v_nvls
.
evtCİy
));

169 
	`ucc__cuda_sk_put
(
_sk
);

170  
UCC_OK
;

171 
	}
}

173 
ucc_¡©us_t


174 
	$ucc__cuda_»duû_sÿ‰”_nvls_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

175 
ucc_ba£_‹am_t
 *
_‹am
,

176 
ucc_cŞl_sk_t
 **
sk_p
)

178 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

179 
ucc__cuda_sk_t
 *
sk
;

180 
ucc_¡©us_t
 
¡©us
;

182 ià(
cŞl_¬gs
->
¬gs
.
İ
 !ğ
UCC_OP_SUM
 ||

183 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
 !ğ
UCC_DT_FLOAT32
) {

184 
	`ucc_”rÜ
("NVLS„educe scatter is supported only with SUM operation "

186  
UCC_ERR_NOT_SUPPORTED
;

189 ià(
	`ucc_uÆik–y
(!
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
))) {

190 
	`ucc_”rÜ
("NVLS„educe scatter is supported only on fully connected "

192  
UCC_ERR_NOT_SUPPORTED
;

195 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

196 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

197  
¡©us
;

200 
	`CUDA_CHECK
(
	`cudaEv’tC»©eW™hFÏgs
(

201 &
sk
->
»duû_sÿ‰”v_nvls
.
evtCom¶‘iÚ
, 
cudaEv’tDi§bËTimšg
));

202 
	`CUDA_CHECK
(
	`cudaEv’tC»©eW™hFÏgs
(

203 &
sk
->
»duû_sÿ‰”v_nvls
.
evtCİy
, 
cudaEv’tDi§bËTimšg
));

205 
sk
->
»duû_sÿ‰”v_nvls
.
g‘_couÁ
 = 
ucc__cuda_»duû_sÿ‰”_g‘_couÁ
;

206 
sk
->
»duû_sÿ‰”v_nvls
.
g‘_off£t
 = 
ucc__cuda_»duû_sÿ‰”_g‘_off£t
;

207 
sk
->
»duû_sÿ‰”v_nvls
.
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

209 
sk
->
su³r
.
po¡
 = 
ucc__cuda_»duû_sÿ‰”v_nvls_¡¬t
;

210 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_»duû_sÿ‰”v_nvls_´og»ss
;

211 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_»duû_sÿ‰”v_nvls_fš®ize
;

213 
sk
->
b¬
 = 
	`TASK_BAR
(task);

215 *
sk_p
 = &
sk
->
su³r
;

216  
UCC_OK
;

217 
	}
}

	@src/components/tl/cuda/reduce_scatter/reduce_scatter_ring.c

7 
	~"»duû_sÿ‰”v/»duû_sÿ‰”v.h
"

8 
	~"»duû_sÿ‰”/»duû_sÿ‰”.h
"

10 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

11 
ucc_ba£_‹am_t
 * 
_‹am
,

12 
ucc_cŞl_sk_t
 ** 
sk_p
)

14 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

15 
size_t
 
ssize
 = 
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
)->
cfg
.
sü©ch_size
;

16 
ucc_d©©y³_t
 
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

17 
ucc__cuda_sk_t
 *
sk
;

18 
size_t
 
£nd_size
, 
äag_size
;

19 
ucc_¡©us_t
 
¡©us
;

21 ià(
cŞl_¬gs
->
¬gs
.
İ
 =ğ
UCC_OP_AVG
) {

22  
UCC_ERR_NOT_SUPPORTED
;

25 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

26 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

27  
¡©us
;

30 
sk
->
»duû_sÿ‰”v_ršg
.
g‘_couÁ
 = 
ucc__cuda_»duû_sÿ‰”_g‘_couÁ
;

31 
sk
->
»duû_sÿ‰”v_ršg
.
g‘_off£t
 = 
ucc__cuda_»duû_sÿ‰”_g‘_off£t
;

32 
sk
->
»duû_sÿ‰”v_ršg
.
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

33 
sk
->
»duû_sÿ‰”v_ršg
.
sbuf
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
bufãr
;

34 
sk
->
»duû_sÿ‰”v_ršg
.
rbuf
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
bufãr
;

36 
£nd_size
 = 
sk
->
»duû_sÿ‰”v_ršg
.
	`g‘_couÁ
(task, 0);

37 
äag_size
 = 
	`ucc_mš
(
ssize
 / 
	`ucc_dt_size
(
dt
è/ 2, 
£nd_size
);

39 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

40 
sk
->
»duû_sÿ‰”v_ršg
.
num_äags
 = 
	`ucc_div_round_up
(
£nd_size
, 
äag_size
);

41 
sk
->
su³r
.
po¡
 = 
ucc__cuda_»duû_sÿ‰”v_ršg_¡¬t
;

42 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_»duû_sÿ‰”v_ršg_´og»ss
;

43 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_»duû_sÿ‰”v_ršg_fš®ize
;

44 
sk
->
b¬
 = 
	`TASK_BAR
(task);

46 *
sk_p
 = &
sk
->
su³r
;

47  
UCC_OK
;

48 
	}
}

	@src/components/tl/cuda/reduce_scatterv/reduce_scatterv.c

7 
	~"»duû_sÿ‰”v.h
"

8 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__cuda_»duû_sÿ‰”v_®gs
[
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_LAST
 + 1] = {

12 [
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_AUTO
] =

13 {.
id
 = 
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_AUTO
,

14 .
	gÇme
 = "auto",

15 .
	gdesc
 = "choose„educe scatterv‡lgorithm based on CUDAopology"},

16 [
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_RING
] =

17 {.
id
 = 
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_RING
,

18 .
	gÇme
 = "ring",

19 .
	gdesc
 = "multiring„educe scatterv‡lgorithm"},

20 [
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_LINEAR
] =

21 {.
id
 = 
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_LINEAR
,

22 .
	gÇme
 = "linear",

23 .
	gdesc
 = "linear„educe scatterv‡lgorithm"},

24 [
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_LAST
] = {

25 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

27 
size_t
 
	$ucc__cuda_»duû_sÿ‰”v_g‘_couÁ
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

28 
ucc_¿nk_t
 
¿nk
)

30 cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

32  
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
¿nk
);

33 
	}
}

35 
size_t
 
	$ucc__cuda_»duû_sÿ‰”v_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

36 
ucc_¿nk_t
 
¿nk
)

38 
size_t
 
off£t
 = 0;

39 
ucc_¿nk_t
 
i
;

41 
i
 = 0; i < 
¿nk
; i++) {

42 
off£t
 +ğ
	`ucc__cuda_»duû_sÿ‰”v_g‘_couÁ
(
sk
, 
i
);

45  
off£t
;

46 
	}
}

48 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”v_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

49 
ucc_ba£_‹am_t
 *
_‹am
,

50 
ucc_cŞl_sk_t
 **
sk_p
)

52 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

54 ià(
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
)) {

55  
	`ucc__cuda_»duû_sÿ‰”v_lš—r_š™
(
cŞl_¬gs
, 
_‹am
,

56 
sk_p
);

58  
	`ucc__cuda_»duû_sÿ‰”v_ršg_š™
(
cŞl_¬gs
, 
_‹am
, 
sk_p
);

60 
	}
}

	@src/components/tl/cuda/reduce_scatterv/reduce_scatterv.h

7 #iâdeà
REDUCE_SCATTERV_H_


8 
	#REDUCE_SCATTERV_H_


	)

10 
	~"_cuda.h
"

11 
	~"_cuda_cŞl.h
"

15 
	mUCC_TL_CUDA_REDUCE_SCATTERV_ALG_AUTO
,

16 
	mUCC_TL_CUDA_REDUCE_SCATTERV_ALG_RING
,

17 
	mUCC_TL_CUDA_REDUCE_SCATTERV_ALG_LINEAR
,

18 
	mUCC_TL_CUDA_REDUCE_SCATTERV_ALG_LAST


21 
ucc_ba£_cŞl_®g_šfo_t


22 
ucc__cuda_»duû_sÿ‰”v_®gs
[
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_LAST
 + 1];

24 
	#UCC_TL_CUDA_REDUCE_SCATTERV_DEFAULT_ALG_SELECT_STR
 "»duû_sÿ‰”v:cuda:@0"

	)

26 
ucc_¡©us_t
 
ucc__cuda_»duû_sÿ‰”v_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

27 
ucc_ba£_‹am_t
 *
_‹am
,

28 
ucc_cŞl_sk_t
 **
sk_p
);

30 
size_t
 
ucc__cuda_»duû_sÿ‰”v_g‘_couÁ
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

31 
ucc_¿nk_t
 
block
);

33 
size_t
 
ucc__cuda_»duû_sÿ‰”v_g‘_off£t
(cÚ¡ 
ucc__cuda_sk_t
 *
sk
,

34 
ucc_¿nk_t
 
block
);

36 
ucc_¡©us_t


37 
ucc__cuda_»duû_sÿ‰”v_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

38 
ucc_ba£_‹am_t
 * 
_‹am
,

39 
ucc_cŞl_sk_t
 ** 
sk_p
);

41 
ucc_¡©us_t
 
ucc__cuda_»duû_sÿ‰”v_ršg_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

43 
ucc__cuda_»duû_sÿ‰”v_ršg_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

45 
ucc_¡©us_t
 
ucc__cuda_»duû_sÿ‰”v_ršg_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

48 
ucc_¡©us_t


49 
ucc__cuda_»duû_sÿ‰”v_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

50 
ucc_ba£_‹am_t
 * 
_‹am
,

51 
ucc_cŞl_sk_t
 ** 
sk_p
);

53 
ucc_¡©us_t
 
ucc__cuda_»duû_sÿ‰”v_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

55 
ucc__cuda_»duû_sÿ‰”v_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

57 
ucc_¡©us_t
 
ucc__cuda_»duû_sÿ‰”v_lš—r_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

59 
šlše
 
	$ucc__cuda_»duû_sÿ‰”v_®g_äom_¡r
(cÚ¡ *
¡r
)

61 
i
;

62 
i
 = 0; i < 
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_LAST
; i++) {

63 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__cuda_»duû_sÿ‰”v_®gs
[
i
].
Çme
)) {

67  
i
;

68 
	}
}

	@src/components/tl/cuda/reduce_scatterv/reduce_scatterv_linear.c

7 
	~"»duû_sÿ‰”v.h
"

8 
	~"compÚ’ts/ec/ucc_ec.h
"

9 
	~"_cuda_ÿche.h
"

10 
	~"uts/¬ch/ıu.h
"

11 
	~"uts/¬ch/cuda_def.h
"

55 
	mSTAGE_SYNC
,

56 
	mSTAGE_SETUP
,

57 
	mSTAGE_COPIES
,

58 
	mSTAGE_BARRIER
,

62 
ucc_¡©us_t


63 
	$ucc__cuda_»duû_sÿ‰”v_lš—r_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

65 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

67 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizingask %p",ask);

68 
	`ucc__cuda_sk_put
(
sk
);

69  
UCC_OK
;

70 
	}
}

76 
šlše
 
size_t
 
	$g‘_sü©ch_size
(
ucc__cuda_‹am_t
 *
‹am
,

77 
ucc_d©©y³_t
 
dt
)

79 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

80 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

81 
size_t
 
divisÜ
 = 2 * 
dt_size
 * 
tsize
;

83  (
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
)->
cfg
.
sü©ch_size
 / 
divisÜ
) * divisor;

84 
	}
}

87 
šlše
 
size_t
 
	$g‘_sü©ch_¡ride
(
ucc__cuda_‹am_t
 *
‹am
,

88 
ucc_d©©y³_t
 
dt
)

90 
size_t
 
¡•_ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
dt
) / 2;

91 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

93  
¡•_ssize
 / 
tsize
;

94 
	}
}

97 
šlše
 
size_t
 
	$g‘_sü©ch_off£t
(
ucc__cuda_‹am_t
 *
‹am
,

98 
ucc_d©©y³_t
 
dt
, 
ucc_¿nk_t
 
¿nk
)

100 
size_t
 
¡•_ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
dt
) / 2;

101 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

103  
¿nk
 * 
¡•_ssize
 / 
tsize
;

104 
	}
}

106 
ucc_¡©us_t


107 
	$ucc__cuda_»duû_sÿ‰”v_lš—r_£tup_¡¬t
(
ucc__cuda_sk_t
 *
sk
)

109 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

110 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

111 
ucc_¡©us_t
 
¡©us
;

113 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 0, 0);

114 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

115 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

116 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

117 
ex™_”r
;

120  
UCC_OK
;

122 
ex™_”r
:

123  
¡©us
;

124 
	}
}

126 
ucc_¡©us_t


127 
	$ucc__cuda_»duû_sÿ‰”v_lš—r_£tup_‹¡
(
ucc__cuda_sk_t
 *
sk
)

129 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

131  
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

132 
	}
}

134 
ucc_¡©us_t


135 
	$ucc__cuda_»duû_sÿ‰”v_lš—r_cİy
(
ucc__cuda_sk_t
 *
sk
,

136 
ucc_“_executÜ_t
 *
exec
, *
sbuf
,

137 
¡•
, 
size_t
 
»mÙe_off£t
,

138 
ucc_“_executÜ_sk_t
 **
‘ask
)

140 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

141 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

142 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

143 
ucc_d©©y³_t
 
dt
 = 
sk
->
»duû_sÿ‰”v_lš—r
.dt;

144 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

145 
näags
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
num_äags
;

146 
size_t
 
sü©ch_off£t
, 
sü©ch_¡ride
, 
£nd_size
, 
äag_size
, 
äag_off£t
,

147 
¿nk_off£t
;

148 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

149 
ucc_¿nk_t
 
i
, 
nv
, 
³”
;

151 
sü©ch_off£t
 = 
	`g‘_sü©ch_off£t
(
‹am
, 
dt
, 
Œªk
);

152 
sü©ch_¡ride
 = 
	`g‘_sü©ch_¡ride
(
‹am
, 
dt
);

153 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
;

154 
—rgs
.
æags
 = 0;

155 
i
 = 0, 
nv
 = 0; i < 
tsize
; i++) {

156 
³”
 = (
Œªk
 + 
i
è% 
	`UCC_TL_TEAM_SIZE
(
‹am
);

157 ià(
³”
 =ğ
Œªk
) {

160 
£nd_size
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
	`g‘_couÁ
Ñask, 
³”
);

161 
äag_size
 = 
	`ucc_bufãr_block_couÁ
(
£nd_size
, 
näags
, 
¡•
);

162 
äag_off£t
 = 
	`ucc_bufãr_block_off£t
(
£nd_size
, 
näags
, 
¡•
);

163 
¿nk_off£t
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
	`g‘_off£t
Ñask, 
³”
);

165 ià(
äag_size
 == 0) {

168 
—rgs
.
cİy_muÉi
.
¤c
[
nv
] = 
	`PTR_OFFSET
(
sbuf
, (
¿nk_off£t
 + 
äag_off£t
è* 
dt_size
);

169 
—rgs
.
cİy_muÉi
.
couÁs
[
nv
] = 
äag_size
 * 
dt_size
;

170 ià(
Œªk
 < 
³”
) {

171 
—rgs
.
cİy_muÉi
.
d¡
[
nv
] = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
³”
),

172 
»mÙe_off£t
 + 
sü©ch_off£t
);

174 
—rgs
.
cİy_muÉi
.
d¡
[
nv
] = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
³”
),

175 
»mÙe_off£t
 + 
sü©ch_off£t
 - 
sü©ch_¡ride
);

177 
nv
++;

179 ià(
nv
 == 0) {

180 *
‘ask
 = 
NULL
;

181  
UCC_OK
;

183 
—rgs
.
cİy_muÉi
.
num_veùÜs
 = 
nv
;

184  
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
, 
‘ask
);

185 
	}
}

187 
ucc_¡©us_t


188 
	$ucc__cuda_»duû_sÿ‰”v_lš—r_»duû
(
ucc__cuda_sk_t
 *
sk
,

189 
ucc_“_executÜ_t
 *
exec
, *
sbuf
,

190 *
rbuf
, 
¡•
,

191 
size_t
 
loÿl_off£t
,

192 
ucc_“_executÜ_sk_t
 **
‘ask
)

194 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

195 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

196 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

197 
ucc_d©©y³_t
 
dt
 = 
sk
->
»duû_sÿ‰”v_lš—r
.dt;

198 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

199 
näags
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
num_äags
;

200 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

201 
size_t
 
£nd_size
, 
äag_size
, 
äag_off£t
, 
¿nk_off£t
;

202 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

204 
£nd_size
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
	`g‘_couÁ
Ñask, 
Œªk
);

205 
äag_size
 = 
	`ucc_bufãr_block_couÁ
(
£nd_size
, 
näags
, 
¡•
);

206 
äag_off£t
 = 
	`ucc_bufãr_block_off£t
(
£nd_size
, 
näags
, 
¡•
);

207 
¿nk_off£t
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
	`g‘_off£t
Ñask, 
Œªk
);

209 ià(
äag_size
 == 0) {

210 *
‘ask
 = 
NULL
;

211  
UCC_OK
;

214 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
;

215 
—rgs
.
æags
 = 0;

216 
—rgs
.
»duû_¡rided
.
¤c1
 = 
	`PTR_OFFSET
(
sbuf
, (
¿nk_off£t
 + 
äag_off£t
è* 
dt_size
);

217 
—rgs
.
»duû_¡rided
.
¤c2
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
Œªk
), 
loÿl_off£t
);

218 
—rgs
.
»duû_¡rided
.
¡ride
 = 
	`g‘_sü©ch_¡ride
(
‹am
, 
dt
);

219 
—rgs
.
»duû_¡rided
.
couÁ
 = 
äag_size
;

220 
—rgs
.
»duû_¡rided
.
d¡
 = 
	`PTR_OFFSET
(
rbuf
, 
äag_off£t
 * 
dt_size
);

221 
—rgs
.
»duû_¡rided
.
İ
 = 
¬gs
->op;

222 
—rgs
.
»duû_¡rided
.
n_¤c2
 = 
tsize
 - 1;

223 
—rgs
.
»duû_¡rided
.
dt
 = dt;

224 
—rgs
.
æags
 = 0;

226  
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
, 
‘ask
);

227 
	}
}

229 
ucc_¡©us_t


230 
	$ucc__cuda_»duû_sÿ‰”v_lš—r_´og»ss_äag
(
ucc__cuda_sk_t
 *
sk
)

232 
ucc__cuda_‹am_t
 * 
‹am
 = 
	`TASK_TEAM
(
sk
);

233 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

234 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

235 
ucc_cŞl_¬gs_t
 * 
¬gs
 = &
	`TASK_ARGS
(
sk
);

236 
ucc_d©©y³_t
 
dt
 = 
sk
->
»duû_sÿ‰”v_lš—r
.dt;

237 
size_t
 
ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
dt
);

238 
näags
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
num_äags
;

239 
num_¡•s
 = 
näags
 + 1;

240 
ucc_“_executÜ_sk_t
 *
‘ask
;

241 
ucc_¡©us_t
 
¡
;

242 
ucc_“_executÜ_t
 *
exec
;

243 
¡•
, 
i
;

244 *
sbuf
, *
rbuf
;

245 
size_t
 
loÿl_off£t
, 
»mÙe_off£t
, 
¿nk_off£t
;

247 
¡
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

248 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

249  
¡
;

252 
¡•
 = 
	`g‘_¿nk_¡•
(
sk
, 
Œªk
, 0);

253 
¡•
 < 
num_¡•s
) {

254 ià((
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[0] !ğ
NULL
) ||

255 (
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[1] !ğ
NULL
)) {

256 
i
 = 0; i < 2; i++) {

257 
‘ask
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[
i
];

258 ià(
‘ask
 !ğ
NULL
) {

259 
¡
 = 
	`ucc_“_executÜ_sk_‹¡
(
‘ask
);

260 ià(
¡
 =ğ
UCC_OK
) {

261 
	`ucc_“_executÜ_sk_fš®ize
(
‘ask
);

262 
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[
i
] = 
NULL
;

264 ià(
	`ucc_lik–y
(
¡
 > 0)) {

265  
UCC_INPROGRESS
;

267  
¡
;

271 
¡•
++;

272 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 
¡•
, 0);

276 
i
 = 0; i < 
tsize
; i++) {

277 ià(
	`g‘_¿nk_¡•
(
sk
, 
i
, 0è< 
¡•
) {

278  
UCC_INPROGRESS
;

282 ià(
¡•
 % 2) {

283 
»mÙe_off£t
 = 
ssize
 / 2;

284 
loÿl_off£t
 = 0;

286 
»mÙe_off£t
 = 0;

287 
loÿl_off£t
 = 
ssize
 / 2;

290 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

291 
¿nk_off£t
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
	`g‘_off£t
Ñask, 
Œªk
);

292 
sbuf
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
rbuf
;

293 
rbuf
 = 
	`PTR_OFFSET
(
sbuf
, 
¿nk_off£t
 * 
	`ucc_dt_size
(
dt
));

295 
sbuf
 = 
sk
->
»duû_sÿ‰”v_lš—r
.sbuf;

296 
rbuf
 = 
sk
->
»duû_sÿ‰”v_lš—r
.rbuf;

299 ià(
¡•
 == 0) {

300 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_lš—r_cİy
(
sk
, 
exec
, 
sbuf
, 
¡•
,

301 
»mÙe_off£t
, &
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[0]);

302 } ià(
¡•
 =ğ(
num_¡•s
 - 1)) {

303 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_lš—r_»duû
(
sk
, 
exec
, 
sbuf
, 
rbuf
,

304 
¡•
 - 1, 
loÿl_off£t
, &
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[1]);

306 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_lš—r_cİy
(
sk
, 
exec
, 
sbuf
, 
¡•
,

307 
»mÙe_off£t
, &
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[0]);

308 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

309  
¡
;

311 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_lš—r_»duû
(
sk
, 
exec
, 
sbuf
, 
rbuf
,

312 
¡•
 - 1, 
loÿl_off£t
, &
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[1]);

314 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

315  
¡
;

318 ià((
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[0] =ğ
NULL
) &&

319 (
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
[1] =ğ
NULL
)) {

321 
¡•
++;

322 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 
¡•
, 0);

327  
UCC_OK
;

328 
	}
}

330 
	$ucc__cuda_»duû_sÿ‰”v_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

332 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

333 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

334 
ucc_¡©us_t
 
¡
;

336 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

337 
sk
->
»duû_sÿ‰”v_lš—r
.
¡age
) {

338 
STAGE_SYNC
:

339 ià(
	`ucc__cuda_g‘_sync
(
sk
è!ğ
UCC_OK
) {

340 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

343 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_lš—r_£tup_¡¬t
(
sk
);

344 ià(
¡
 !ğ
UCC_OK
) {

345 
sk
->
su³r
.
¡©us
 = 
¡
;

348 
sk
->
»duû_sÿ‰”v_lš—r
.
¡age
 = 
STAGE_SETUP
;

349 
STAGE_SETUP
:

350 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_lš—r_£tup_‹¡
(
sk
);

351 ià(
¡
 !ğ
UCC_OK
) {

352 
sk
->
su³r
.
¡©us
 = 
¡
;

355 
sk
->
»duû_sÿ‰”v_lš—r
.
¡age
 = 
STAGE_COPIES
;

356 
STAGE_COPIES
:

357 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_lš—r_´og»ss_äag
(
sk
);

358 ià(
¡
 !ğ
UCC_OK
) {

359 
sk
->
su³r
.
¡©us
 = 
¡
;

363 
¡
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

364 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

365 
sk
->
su³r
.
¡©us
 = 
¡
;

368 
sk
->
»duû_sÿ‰”v_lš—r
.
¡age
 = 
STAGE_BARRIER
;

370 
	`ucc_as£¹
(
sk
->
»duû_sÿ‰”v_lš—r
.
¡age
 =ğ
STAGE_BARRIER
);

373 
sk
->
su³r
.
¡©us
 =

374 
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

375 ià(
sk
->
su³r
.
¡©us
 =ğ
UCC_OK
) {

376 
	`ucc__cuda_put_sync
(
sk
);

378 
	}
}

380 
ucc_¡©us_t


381 
	$ucc__cuda_»duû_sÿ‰”v_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

383 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

384 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

385 
ucc_cŞl_¬gs_t
 * 
¬gs
 = &
	`TASK_ARGS
(
sk
);

386 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

387 
ucc_d©©y³_t
 
dt
 = 
sk
->
»duû_sÿ‰”v_lš—r
.dt;

388 
ucc_¿nk_t
 
i
;

389 
size_t
 
£nd_size
, 
äag_size
, 
ssize
;

394 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE_SCATTER
) {

395 
sk
->
»duû_sÿ‰”v_lš—r
.
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

397 
sk
->
»duû_sÿ‰”v_lš—r
.
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

400 
sk
->
»duû_sÿ‰”v_lš—r
.
¡age
 = 
STAGE_SYNC
;

401 
sk
->
»duû_sÿ‰”v_lš—r
.
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

402 
£nd_size
 = 
sk
->
»duû_sÿ‰”v_lš—r
.
	`g‘_couÁ
(task, 0);

403 
i
 = 1; i < 
tsize
; i++) {

404 
£nd_size
 =

405 
	`ucc_max
(
£nd_size
, 
sk
->
»duû_sÿ‰”v_lš—r
.
	`g‘_couÁ
Ñask, 
i
));

408 ià(
£nd_size
 == 0) {

409 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

410  
	`ucc_sk_com¶‘e
(&
sk
->
su³r
);

413 
ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
dt
);

414 
äag_size
 = 
	`ucc_mš
(
ssize
 / 2 / 
	`ucc_dt_size
(
dt
è/ 
tsize
, 
£nd_size
);

415 
sk
->
»duû_sÿ‰”v_lš—r
.
num_äags
 = 
	`ucc_div_round_up
(
£nd_size
, 
äag_size
);

417 
	`mem£t
(
sk
->
»duû_sÿ‰”v_lš—r
.
exec_sk
, 0,

418 2 * (
ucc_“_executÜ_sk_t
*));

419  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

420 
	}
}

422 
ucc_¡©us_t


423 
	$ucc__cuda_»duû_sÿ‰”v_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

424 
ucc_ba£_‹am_t
 * 
_‹am
,

425 
ucc_cŞl_sk_t
 ** 
sk_p
)

427 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

428 
ucc__cuda_sk_t
 *
sk
;

429 
ucc_¡©us_t
 
¡©us
;

431 ià(
cŞl_¬gs
->
¬gs
.
İ
 =ğ
UCC_OP_AVG
) {

432  
UCC_ERR_NOT_SUPPORTED
;

435 ià(
	`ucc_uÆik–y
(!
	`ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(
‹am
->
tİo
) ||

436 
	`UCC_TL_TEAM_SIZE
(
‹am
è- 1 > 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
)) {

437  
UCC_ERR_NOT_SUPPORTED
;

440 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

441 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

442  
¡©us
;

445 
sk
->
»duû_sÿ‰”v_lš—r
.
g‘_couÁ
 =

446 
ucc__cuda_»duû_sÿ‰”v_g‘_couÁ
;

447 
sk
->
»duû_sÿ‰”v_lš—r
.
g‘_off£t
 =

448 
ucc__cuda_»duû_sÿ‰”v_g‘_off£t
;

449 
sk
->
»duû_sÿ‰”v_lš—r
.
dt
 =

450 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo_v
.
d©©y³
;

451 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

452 
sk
->
su³r
.
po¡
 = 
ucc__cuda_»duû_sÿ‰”v_lš—r_¡¬t
;

453 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_»duû_sÿ‰”v_lš—r_´og»ss
;

454 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_»duû_sÿ‰”v_lš—r_fš®ize
;

455 
sk
->
b¬
 = 
	`TASK_BAR
(task);

457 *
sk_p
 = &
sk
->
su³r
;

458  
UCC_OK
;

459 
	}
}

	@src/components/tl/cuda/reduce_scatterv/reduce_scatterv_ring.c

7 
	~"»duû_sÿ‰”v.h
"

8 
	~"compÚ’ts/ec/ucc_ec.h
"

9 
	~"_cuda_ÿche.h
"

10 
	~"_cuda_ršg.h
"

11 
	~"uts/¬ch/ıu.h
"

12 
	~"uts/¬ch/cuda_def.h
"

14 
	#BLOCK_ALIGN
 64

	)

16 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”v_ršg_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

18 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

20 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizingask %p",ask);

21 
	`ucc__cuda_sk_put
(
sk
);

22  
UCC_OK
;

23 
	}
}

25 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”v_ršg_£tup_¡¬t
(
ucc__cuda_sk_t
 *
sk
)

27 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

28 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

29 
chunk
;

31 
chunk
 = 0; chunk < 1; chunk++) {

32 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 0, 
chunk
);

34 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

35  
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

36 
	}
}

38 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”v_ršg_£tup_‹¡
(
ucc__cuda_sk_t
 *
sk
)

40 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

41  
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

42 
	}
}

44 
šlše
 

45 
	$ucc__cuda_check_³”s_»ady
(
ucc__cuda_sk_t
 *
sk
, 
chunk
, 
¡•
)

47 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

48 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

49 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

50 
Äšgs
 = 
sk
->
»duû_sÿ‰”v_ršg
.
num_ršgs
;

51 
ršg
, 
³”_¡•
;

52 
ucc_¿nk_t
 
³”
;

54 
ršg
 = 0;„šg < 
Äšgs
;„ing++) {

55 
³”
 = 
	`g‘_£nd_to
(
‹am
, 
Œªk
, 
tsize
, 
ršg
);

56 
³”_¡•
 = 
	`g‘_¿nk_¡•
(
sk
, 
³”
, 
chunk
);

58 ià(
³”_¡•
 < 
¡•
) {

62 
³”
 = 
	`g‘_»cv_äom
(
‹am
, 
Œªk
, 
tsize
, 
ršg
);

63 
³”_¡•
 = 
	`g‘_¿nk_¡•
(
sk
, 
³”
, 
chunk
);

65 ià(
³”_¡•
 < 
¡•
) {

71 
	}
}

73 
ucc_¡©us_t


74 
	$ucc__cuda_»duû_sÿ‰”v_ršg_´og»ss_ršg
(
ucc__cuda_sk_t
 * 
sk
,

75 
chunk
)

77 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

78 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

79 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

80 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

81 
n¡•s
 = 
tsize
;

82 
Äšgs
 = 
sk
->
»duû_sÿ‰”v_ršg
.
num_ršgs
;

83 
näags
 = 
sk
->
»duû_sÿ‰”v_ršg
.
num_äags
;

84 
ucc_d©©y³_t
 
dt
 = 
sk
->
»duû_sÿ‰”v_ršg
.dt;

85 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

86 *
sbuf
 = 
sk
->
»duû_sÿ‰”v_ršg
.sbuf;

87 *
dbuf
 = 
sk
->
»duû_sÿ‰”v_ršg
.
rbuf
;

88 
size_t
 
ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
Äšgs
, 1, 
dt_size
);

89 
ucc_¿nk_t
 
»cväom
;

90 
ucc_“_executÜ_t
 *
exec
;

91 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

92 
ucc_“_executÜ_sk_t
 *
‘ask
;

93 *
r¤c1
, *
r¤c2
, *
rd¡
;

94 
ucc_¡©us_t
 
¡
;

95 
¡•
, 
ršg
, 
äag
, 
äag_¡•
, 
k
;

96 
size_t
 
ršg_äag_couÁ
, 
äag_couÁ
, 
block_couÁ
, 
block
, 
ršg_äag_off£t
,

97 
»mÙe_off£t
, 
loÿl_off£t
, 
äag_off£t
, 
block_off£t
,

98 
ršg_sü©ch_off£t
;

100 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

101 
sbuf
 = 
dbuf
;

104 
¡
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

105 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

106  
¡
;

109 
¡•
 = 
	`g‘_¿nk_¡•
(
sk
, 
Œªk
, 
chunk
);

110 
¡•
 < (
n¡•s
 * 
näags
)) {

111 
‘ask
 = 
sk
->
»duû_sÿ‰”v_ršg
.
exec_sk
[
chunk
];

112 ià(
‘ask
 !ğ
NULL
) {

113 
¡
 = 
	`ucc_“_executÜ_sk_‹¡
(
‘ask
);

114 ià(
¡
 !ğ
UCC_OK
) {

115 ià(
	`ucc_lik–y
(
¡
 > 0)) {

116 
¡
 = 
UCC_INPROGRESS
;

118  
¡
;

120 
	`ucc_“_executÜ_sk_fš®ize
(
‘ask
);

121 
sk
->
»duû_sÿ‰”v_ršg
.
exec_sk
[
chunk
] = 
NULL
;

122 
¡•
++;

123 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 
¡•
, 
chunk
);

127 ià(!
	`ucc__cuda_check_³”s_»ady
(
sk
, 
chunk
, 
¡•
)) {

128  
UCC_INPROGRESS
;

131 
äag
 = 
¡•
 / 
tsize
;

132 
äag_¡•
 = 
¡•
 % 
tsize
;

134 ià(
¡•
 % 2) {

135 
»mÙe_off£t
 = 0;

136 
loÿl_off£t
 = 
ssize
 / 2;

138 
»mÙe_off£t
 = 
ssize
 / 2;

139 
loÿl_off£t
 = 0;

142 
k
 = 0;

143 
ršg_sü©ch_off£t
 = 
ssize
 / 2 / 
Äšgs
;

144 
ršg
 = 0;„šg < 
Äšgs
;„ing++) {

145 
»cväom
 = 
	`g‘_»cv_äom
(
‹am
, 
Œªk
, 
tsize
, 
ršg
);

146 
block
 = 
	`g‘_»cv_block
(
‹am
, 
Œªk
, 
tsize
, 
äag_¡•
, 
ršg
);

148 
block_couÁ
 = 
sk
->
»duû_sÿ‰”v_ršg
.
	`g‘_couÁ
Ñask, 
block
);

149 
äag_couÁ
 = 
	`ucc_bufãr_block_couÁ_®igÃd
(

150 
block_couÁ
, 
näags
, 
äag
, 
BLOCK_ALIGN
);

151 
ršg_äag_couÁ
 = 
	`ucc_bufãr_block_couÁ_®igÃd
(

152 
äag_couÁ
, 
Äšgs
, 
ršg
, 
BLOCK_ALIGN
);

154 ià(
ršg_äag_couÁ
 == 0) {

158 
block_off£t
 = 
sk
->
»duû_sÿ‰”v_ršg
.
	`g‘_off£t
Ñask, 
block
);

159 
äag_off£t
 = 
	`ucc_bufãr_block_off£t_®igÃd
(

160 
block_couÁ
, 
näags
, 
äag
, 
BLOCK_ALIGN
);

161 
ršg_äag_off£t
 = 
	`ucc_bufãr_block_off£t_®igÃd
(

162 
äag_couÁ
, 
Äšgs
, 
ršg
, 
BLOCK_ALIGN
);

164 ià(
äag_¡•
 == 0) {

166 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
;

167 
—rgs
.
cİy_muÉi
.
¤c
[
k
] = 
	`PTR_OFFSET
(
sbuf
,

168 (
block_off£t
 + 
äag_off£t
 + 
ršg_äag_off£t
è* 
dt_size
);

169 
—rgs
.
cİy_muÉi
.
d¡
[
k
] = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
Œªk
),

170 
loÿl_off£t
 + 
ršg_sü©ch_off£t
 * 
ršg
);

171 
—rgs
.
cİy_muÉi
.
couÁs
[
k
] = 
ršg_äag_couÁ
 * 
dt_size
;

172 
—rgs
.
cİy_muÉi
.
num_veùÜs
 = 
k
 + 1;

175 
r¤c1
 = 
	`PTR_OFFSET
(
sbuf
, (
block_off£t
 + 
äag_off£t
 +

176 
ršg_äag_off£t
è* 
dt_size
);

177 
r¤c2
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
»cväom
), 
»mÙe_off£t
 +

178 
ršg_sü©ch_off£t
 * 
ršg
);

179 ià(
äag_¡•
 =ğ
tsize
 - 1) {

181 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

182 
rd¡
 = 
	`PTR_OFFSET
(
dbuf
, (
block_off£t
 + 
äag_off£t
 +

183 
ršg_äag_off£t
è* 
dt_size
);

185 
rd¡
 = 
	`PTR_OFFSET
(
dbuf
, (
äag_off£t
 + 
ršg_äag_off£t
) *

186 
dt_size
);

190 
rd¡
 = 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
sk
, 
Œªk
), 
loÿl_off£t
 +

191 
ršg_sü©ch_off£t
 * 
ršg
);

193 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_REDUCE_MULTI_DST
;

194 
—rgs
.
»duû_muÉi_d¡
.
d¡
[
k
] = 
rd¡
;

195 
—rgs
.
»duû_muÉi_d¡
.
¤c1
[
k
] = 
r¤c1
;

196 
—rgs
.
»duû_muÉi_d¡
.
¤c2
[
k
] = 
r¤c2
;

197 
—rgs
.
»duû_muÉi_d¡
.
couÁs
[
k
] = 
ršg_äag_couÁ
;

198 
—rgs
.
»duû_muÉi_d¡
.
dt
 = dt;

199 
—rgs
.
»duû_muÉi_d¡
.
İ
 = 
¬gs
->op;

200 
—rgs
.
»duû_muÉi_d¡
.
n_bufs
 = 
k
 + 1;

202 
k
++;

205 ià(
k
 == 0) {

207 
¡•
++;

208 
	`£t_¿nk_¡•
(
sk
, 
Œªk
, 
¡•
, 
chunk
);

211 
¡
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
,

212 &
sk
->
»duû_sÿ‰”v_ršg
.
exec_sk
[
chunk
]);

213 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

214  
¡
;

218  
UCC_OK
;

219 
	}
}

221 
	$ucc__cuda_»duû_sÿ‰”v_ršg_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

223 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

224 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

225 
ucc_¡©us_t
 
¡
;

226 
chunk
, 
num_dÚe
;

228 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

229 
sk
->
»duû_sÿ‰”v_ršg
.
¡age
) {

230 
RING_STAGE_SYNC
:

231 ià(
	`ucc__cuda_g‘_sync
(
sk
è!ğ
UCC_OK
) {

232 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

235 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_ršg_£tup_¡¬t
(
sk
);

236 ià(
¡
 !ğ
UCC_OK
) {

237 
sk
->
su³r
.
¡©us
 = 
¡
;

240 
sk
->
»duû_sÿ‰”v_ršg
.
¡age
 = 
RING_STAGE_SETUP
;

242 
RING_STAGE_SETUP
:

243 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_ršg_£tup_‹¡
(
sk
);

244 ià(
¡
 !ğ
UCC_OK
) {

245 
sk
->
su³r
.
¡©us
 = 
¡
;

248 
sk
->
»duû_sÿ‰”v_ršg
.
¡age
 = 
RING_STAGE_RING
;

250 
RING_STAGE_RING
:

251 
num_dÚe
 = 0;

252 
chunk
 = 0; chunk < 1; chunk++) {

253 
¡
 = 
	`ucc__cuda_»duû_sÿ‰”v_ršg_´og»ss_ršg
(
sk
, 
chunk
);

254 ià(
	`ucc_uÆik–y
(
¡
 < 0)) {

255 
sk
->
su³r
.
¡©us
 = 
¡
;

257 } ià(
¡
 =ğ
UCC_OK
) {

258 
num_dÚe
++;

261 ià(
num_dÚe
 != 1) {

266 
¡
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
sk
->
b¬
);

267 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

268 
sk
->
su³r
.
¡©us
 = 
¡
;

272 
sk
->
»duû_sÿ‰”v_ršg
.
¡age
 = 
RING_STAGE_BARRIER
;

275 
	`ucc_as£¹
(
sk
->
»duû_sÿ‰”v_ršg
.
¡age
 =ğ
RING_STAGE_BARRIER
);

279 
sk
->
su³r
.
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
),

280 
sk
->
b¬
);

281 ià(
sk
->
su³r
.
¡©us
 =ğ
UCC_OK
) {

282 
	`ucc__cuda_put_sync
(
sk
);

283 
	`UCC_TL_CUDA_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "cuda_rsv_ring_done", 0);

285 
	}
}

287 
ucc_¡©us_t
 
	$ucc__cuda_»duû_sÿ‰”v_ršg_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

289 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_cuda_task_t);

290 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

291 
ucc__cuda_lib_t
 *
lib
 = 
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
);

292 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

293 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

294 
ucc_d©©y³_t
 
dt
 = 
sk
->
»duû_sÿ‰”v_ršg
.dt;

295 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

296 
size_t
 
£nd_size
, 
äag_size
, 
ssize
;

297 
Äšgs
;

298 
ucc_¿nk_t
 
i
;

300 
	`UCC_TL_CUDA_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "cuda_rsv_ring_start", 0);

301 
£nd_size
 = 
sk
->
»duû_sÿ‰”v_ršg
.
	`g‘_couÁ
(task, 0);

302 
i
 = 1; i < 
tsize
; i++) {

303 
£nd_size
 = 
	`ucc_max
(send_size,

304 
sk
->
»duû_sÿ‰”v_ršg
.
	`g‘_couÁ
Ñask, 
i
));

307 ià(
£nd_size
 == 0) {

308 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

309  
	`ucc_sk_com¶‘e
(&
sk
->
su³r
);

312 
Äšgs
 = 
	`g‘_num_ršgs
(
‹am
, 
£nd_size
 * 
dt_size
,

313 
lib
->
cfg
.
»duû_sÿ‰”_ršg_max_ršgs
);

315 
sk
->
»duû_sÿ‰”v_ršg
.
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

316 
sk
->
»duû_sÿ‰”v_ršg
.
num_ršgs
 = 
Äšgs
;

317 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE_SCATTERV
) {

318 
sk
->
»duû_sÿ‰”v_ršg
.
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

320 
sk
->
»duû_sÿ‰”v_ršg
.
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

323 
ssize
 = 
	`g‘_sü©ch_size
(
‹am
, 
Äšgs
, 1, 
dt_size
);

324 
äag_size
 = 
	`ucc_mš
(
ssize
 / 
dt_size
 / 2, 
£nd_size
);

325 
sk
->
»duû_sÿ‰”v_ršg
.
num_äags
 = 
	`ucc_div_round_up
(
£nd_size
, 
äag_size
);

326 
sk
->
»duû_sÿ‰”v_ršg
.
¡age
 = 
RING_STAGE_SYNC
;

327 
sk
->
»duû_sÿ‰”v_ršg
.
exec_sk
[0] = 
NULL
;

328  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

329 
	}
}

331 
ucc_¡©us_t


332 
	$ucc__cuda_»duû_sÿ‰”v_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

333 
ucc_ba£_‹am_t
 * 
_‹am
,

334 
ucc_cŞl_sk_t
 ** 
sk_p
)

336 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

337 
ucc__cuda_sk_t
 *
sk
;

338 
ucc_¡©us_t
 
¡©us
;

340 ià(
cŞl_¬gs
->
¬gs
.
İ
 =ğ
UCC_OP_AVG
) {

341  
UCC_ERR_NOT_SUPPORTED
;

344 
¡©us
 = 
	`ucc__cuda_sk_š™
(
cŞl_¬gs
, 
‹am
, &
sk
);

345 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

346  
¡©us
;

349 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

350 
sk
->
su³r
.
po¡
 = 
ucc__cuda_»duû_sÿ‰”v_ršg_¡¬t
;

351 
sk
->
su³r
.
´og»ss
 = 
ucc__cuda_»duû_sÿ‰”v_ršg_´og»ss
;

352 
sk
->
su³r
.
fš®ize
 = 
ucc__cuda_»duû_sÿ‰”v_ršg_fš®ize
;

353 
sk
->
»duû_sÿ‰”v_ršg
.
g‘_couÁ
 = 
ucc__cuda_»duû_sÿ‰”v_g‘_couÁ
;

354 
sk
->
»duû_sÿ‰”v_ršg
.
g‘_off£t
 = 
ucc__cuda_»duû_sÿ‰”v_g‘_off£t
;

355 
sk
->
»duû_sÿ‰”v_ršg
.
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo_v
.
d©©y³
;

356 
sk
->
b¬
 = 
	`TASK_BAR
(task);

358 *
sk_p
 = &
sk
->
su³r
;

359  
UCC_OK
;

360 
	}
}

	@src/components/tl/cuda/tl_cuda.c

7 
	~"_cuda.h
"

8 
	~"cÜe/ucc_‹am.h
"

9 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

10 
	~"®lg©h”/®lg©h”.h
"

11 
	~"®lg©h”v/®lg©h”v.h
"

12 
	~"bÿ¡/bÿ¡.h
"

13 
	~"»duû_sÿ‰”/»duû_sÿ‰”.h
"

14 
	~"»duû_sÿ‰”v/»duû_sÿ‰”v.h
"

16 
ucc_cÚfig_f›ld_t
 
	gucc__cuda_lib_cÚfig_bË
[] = {

17 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__cuda_lib_cÚfig_t
, 
su³r
),

18 
UCC_CONFIG_TYPE_TABLE
(
ucc__lib_cÚfig_bË
)},

22 
ucc_off£tof
(
ucc__cuda_lib_cÚfig_t
, 
max_cÚcu¼’t
),

23 
UCC_CONFIG_TYPE_UINT
},

27 
ucc_off£tof
(
ucc__cuda_lib_cÚfig_t
, 
sü©ch_size
),

28 
UCC_CONFIG_TYPE_MEMUNITS
},

32 
ucc_off£tof
(
ucc__cuda_lib_cÚfig_t
, 
®lg©h”_ršg_max_ršgs
),

33 
UCC_CONFIG_TYPE_ULUNITS
},

37 
ucc_off£tof
(
ucc__cuda_lib_cÚfig_t
, 
®lg©h”_ršg_num_chunks
),

38 
UCC_CONFIG_TYPE_UINT
},

43 
ucc_off£tof
(
ucc__cuda_lib_cÚfig_t
, 
»duû_sÿ‰”_ršg_max_ršgs
),

44 
UCC_CONFIG_TYPE_ULUNITS
},

48 
ucc_off£tof
(
ucc__cuda_lib_cÚfig_t
, 
tİo_ÿche_’abË
),

49 
UCC_CONFIG_TYPE_BOOL
},

51 {
NULL
}};

53 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__cuda_lib_t
, 
ucc_ba£_lib_t
,

54 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

55 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

57 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__cuda_lib_t
, 
ucc_ba£_lib_t
);

59 
ucc_¡©us_t
 
ucc__cuda_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

60 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
);

62 
ucc_¡©us_t
 
ucc__cuda_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

64 
ucs_cÚfig_f›ld_t
 
	gucc__cuda_cÚ‹xt_cÚfig_bË
[] = {

65 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__cuda_cÚ‹xt_cÚfig_t
, 
su³r
),

66 
UCC_CONFIG_TYPE_TABLE
(
ucc__cÚ‹xt_cÚfig_bË
)},

68 {
NULL
}};

70 
ucc_¡©us_t
 
ucc__cuda_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

71 
ucc_ba£_ùx_©Œ_t
 *
ba£_©Œ
);

73 
ucc_¡©us_t
 
ucc__cuda_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

74 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
);

76 
ucc_¡©us_t
 
ucc__cuda_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

77 
ucc_mem_m­__t
 *
_h
);

79 
ucc_¡©us_t
 
ucc__cuda_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

80 
ucc_mem_m­_mode_t
 
mode
, 
ucc_mem_m­__t
 *
_h
, **
·ck_bufãr
);

82 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__cuda_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

83 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

84 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

86 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__cuda_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

88 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__cuda_‹am_t
, 
ucc_ba£_‹am_t
,

89 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

91 
ucc_¡©us_t
 
ucc__cuda_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
);

93 
ucc_¡©us_t
 
ucc__cuda_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
);

95 
ucc_¡©us_t
 
ucc__cuda_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

96 
ucc_ba£_‹am_t
 *
‹am
,

97 
ucc_cŞl_sk_t
 **
sk
);

99 
ucc_¡©us_t
 
ucc__cuda_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

100 
ucc_cŞl_scÜe_t
 **
scÜe_p
);

102 
UCC_TL_IFACE_DECLARE
(
cuda
, 
CUDA
);

104 
__©Œibu‹__
((
cÚ¡ruùÜ
)è
	$_cuda_içû_š™
()

107 
ucc__cuda
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLGATHER
)] =

108 
ucc__cuda_®lg©h”_®gs
;

109 
ucc__cuda
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLGATHERV
)] =

110 
ucc__cuda_®lg©h”v_®gs
;

111 
ucc__cuda
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_BCAST
)] =

112 
ucc__cuda_bÿ¡_®gs
;

113 
ucc__cuda
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_REDUCE_SCATTER
)] =

114 
ucc__cuda_»duû_sÿ‰”_®gs
;

115 
ucc__cuda
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_REDUCE_SCATTERV
)] =

116 
ucc__cuda_»duû_sÿ‰”v_®gs
;

117 
	}
}

	@src/components/tl/cuda/tl_cuda.h

8 #iâdeà
UCC_TL_CUDA_H_


9 
	#UCC_TL_CUDA_H_


	)

11 
	~"compÚ’ts//ucc_.h
"

12 
	~"compÚ’ts//ucc__log.h
"

13 
	~"compÚ’ts/mc/ucc_mc.h
"

14 
	~"uts/ucc_mpoŞ.h
"

15 
	~"uts/ucc_d©a¡ruù.h
"

16 
	~"_cuda_•_hash.h
"

17 
	~"_cuda_tİo.h
"

18 
	~"_cuda_‹am_tİo.h
"

19 #ifdeà
HAVE_TL_CUDA_NVLS


20 
	~"_cuda_nvls.h
"

23 
	~<cuda_ruÁime.h
>

25 #iâdeà
UCC_TL_CUDA_DEFAULT_SCORE


26 
	#UCC_TL_CUDA_DEFAULT_SCORE
 40

	)

29 
	#UCC_TL_CUDA_MAX_PEERS
 8

	)

30 
	#UCC_TL_CUDA_MAX_RING_CHUNKS
 8

	)

32 #ifdeà
HAVE_NVLS


33 
	#UCC_TL_CUDA_SUPPORTED_COLLS
 \

34 (
UCC_COLL_TYPE_ALLTOALL
 | 
UCC_COLL_TYPE_ALLTOALLV
 | \

35 
UCC_COLL_TYPE_ALLGATHER
 | 
UCC_COLL_TYPE_ALLGATHERV
 | \

36 
UCC_COLL_TYPE_BCAST
 | 
UCC_COLL_TYPE_ALLREDUCE
 | \

37 
UCC_COLL_TYPE_REDUCE_SCATTER
 | 
UCC_COLL_TYPE_REDUCE_SCATTERV
)

	)

39 
	#UCC_TL_CUDA_SUPPORTED_COLLS
 \

40 (
UCC_COLL_TYPE_ALLTOALL
 | 
UCC_COLL_TYPE_ALLTOALLV
 | \

41 
UCC_COLL_TYPE_ALLGATHER
 | 
UCC_COLL_TYPE_ALLGATHERV
 | \

42 
UCC_COLL_TYPE_BCAST
 | 
UCC_COLL_TYPE_REDUCE_SCATTER
 | \

43 
UCC_COLL_TYPE_REDUCE_SCATTERV
)

	)

46 
	#UCC_TL_CUDA_TEAM_LIB
(
_‹am
) \

47 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
->
lib
, 
ucc__cuda_lib_t
))

	)

49 
	#UCC_TL_CUDA_TEAM_CTX
(
_‹am
) \

50 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
, 
ucc__cuda_cÚ‹xt_t
))

	)

52 
	#UCC_TL_CUDA_TEAM_SYNC
(
_‹am
, 
_¿nk
, 
_id
) \

54 
size_t
 
_ù¾_size_¿nk
 = \

55 ((
ucc__cuda_sync_t
) + \

56 (
ucc__cuda_sync_d©a_t
è* (
	`UCC_TL_TEAM_SIZE
(
_‹am
) - 1)); \

57 
size_t
 
_ù¾_size
 = 
_ù¾_size_¿nk
 * 
	`UCC_TL_TEAM_SIZE
(
_‹am
); \

58 *
_sync
 = 
	`PTR_OFFSET
(
_‹am
->
sync
, 
_ù¾_size
 * (
_id
) + \

59 
_ù¾_size_¿nk
 * (
_¿nk
)); \

60 (
ucc__cuda_sync_t
 *)
_sync
; \

61 })

	)

63 
	#UCC_TL_CUDA_TEAM_BARRIER
(
_‹am
, 
_id
) \

65 
size_t
 
_b¬_size
 = (
ucc__cuda_shm_b¬r›r_t
); \

66 *
_b¬
 = 
	`PTR_OFFSET
(
_‹am
->
b¬
, 
_b¬_size
 * (
_id
)); \

67 (
ucc__cuda_shm_b¬r›r_t
 *)
_b¬
; \

68 })

	)

70 #ifdeà
HAVE_PROFILING_TL_CUDA


71 
	~"uts/´ofe/ucc_´ofe.h
"

73 
	~"uts/´ofe/ucc_´ofe_off.h
"

76 
	#UCC_TL_CUDA_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

77 
	#UCC_TL_CUDA_PROFILE_REQUEST_NEW
 
UCC_PROFILE_REQUEST_NEW


	)

78 
	#UCC_TL_CUDA_PROFILE_REQUEST_EVENT
 
UCC_PROFILE_REQUEST_EVENT


	)

79 
	#UCC_TL_CUDA_PROFILE_REQUEST_FREE
 
UCC_PROFILE_REQUEST_FREE


	)

81 
	succ__cuda_içû
 {

82 
ucc__içû_t
 
	msu³r
;

83 } 
	tucc__cuda_içû_t
;

85 
ucc__cuda_içû_t
 
ucc__cuda
;

87 
	succ__cuda_lib_cÚfig
 {

88 
ucc__lib_cÚfig_t
 
	msu³r
;

89 
ušt32_t
 
	mmax_cÚcu¼’t
;

90 
size_t
 
	msü©ch_size
;

91 
	m®lg©h”_ršg_max_ršgs
;

92 
ušt32_t
 
	m®lg©h”_ršg_num_chunks
;

93 
	m»duû_sÿ‰”_ršg_max_ršgs
;

94 
	mtİo_ÿche_’abË
;

95 } 
	tucc__cuda_lib_cÚfig_t
;

97 
	succ__cuda_cÚ‹xt_cÚfig
 {

98 
ucc__cÚ‹xt_cÚfig_t
 
	msu³r
;

99 } 
	tucc__cuda_cÚ‹xt_cÚfig_t
;

101 
	succ__cuda_lib
 {

102 
ucc__lib_t
 
	msu³r
;

103 
ucc__cuda_lib_cÚfig_t
 
	mcfg
;

104 
ucc__cuda_tİo_t
 *
	mtİo
;

105 } 
	tucc__cuda_lib_t
;

106 
UCC_CLASS_DECLARE
(
ucc__cuda_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

107 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

109 
	succ__cuda_cÚ‹xt
 {

110 
ucc__cÚ‹xt_t
 
	msu³r
;

111 
ucc__cuda_cÚ‹xt_cÚfig_t
 
	mcfg
;

112 
	mdeviû
;

113 
ucc__cuda_deviû_pci_id_t
 
	mdeviû_id
;

114 
ucc__cuda_tİo_t
 *
	mtİo
;

115 
ucc_mpoŞ_t
 
	m»q_mp
;

116 
_cuda_•_hash_t
 *
	mc_ÿche
;

117 } 
	tucc__cuda_cÚ‹xt_t
;

118 
UCC_CLASS_DECLARE
(
ucc__cuda_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

119 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

121 
ušt32_t
 
	tucc__cuda_sync_¡©e_t
;

123 
	#UCC_TL_CUDA_TAG_FREE
 0xFFFFFFFFFFFFFFFF

	)

125 
	succ__cuda_shm_b¬r›r
 {

126 
ucc_¿nk_t
 
	msize
;

127 
ucc_¿nk_t
 
	mcouÁ
;

128 
ušt64_t
 
	mg
;

129 
	m£n£
;

130 
ucc_¡©us_t
 
	m¡©e
[
UCC_TL_CUDA_MAX_PEERS
];

131 
	mloÿl_£n£
[
UCC_TL_CUDA_MAX_PEERS
];

132 } 
	tucc__cuda_shm_b¬r›r_t
;

134 
	succ__cuda_sync_d©a
 {

135 
cudaEv’t_t
 
	mc_ev’t_»mÙe
;

136 } 
	tucc__cuda_sync_d©a_t
;

138 
	succ__cuda_mem_šfo
 {

139 *
	m±r
;

140 
size_t
 
	mËngth
;

141 
size_t
 
	moff£t
;

142 
cudaIpcMemHªdË_t
 
	mhªdË
;

143 } 
	tucc__cuda_mem_šfo_t
;

145 
	succ__cuda_¿nk_id
 {

146 
ucc__cuda_deviû_pci_id_t
 
	mpci_id
;

147 
ucc__cuda_mem_šfo_t
 
	msü©ch_šfo
;

148 
	mshm
;

149 } 
	tucc__cuda_¿nk_id_t
;

151 
	succ__cuda_sync
 {

152 
	m£q_num
[
UCC_TL_CUDA_MAX_RING_CHUNKS
];

153 
ucc__cuda_mem_šfo_t
 
	mmem_šfo_¤c
;

154 
ucc__cuda_mem_šfo_t
 
	mmem_šfo_d¡
;

155 
cudaEv’t_t
 
	mc_ev’t_loÿl
;

156 
cudaIpcEv’tHªdË_t
 
	mev_hªdË
;

159 
size_t
 
	msby‹s
[
UCC_TL_CUDA_MAX_PEERS
];

160 
size_t
 
	mrby‹s
[
UCC_TL_CUDA_MAX_PEERS
];

161 
size_t
 
	msdi¥l_by‹s
[
UCC_TL_CUDA_MAX_PEERS
];

162 
size_t
 
	mrdi¥l_by‹s
[
UCC_TL_CUDA_MAX_PEERS
];

163 } 
	m®ÉßÎv_û
;

165 
ucc__cuda_sync_d©a_t
 
	md©a
[1];

166 } 
	tucc__cuda_sync_t
;

168 
	succ__cuda_sü©ch
 {

169 *
	mloc
;

170 *
	m»m
[
UCC_TL_CUDA_MAX_PEERS
];

171 
ucc__cuda_mem_šfo_t
 
	m»m_šfo
[
UCC_TL_CUDA_MAX_PEERS
];

172 } 
	tucc__cuda_sü©ch_t
;

175 
	succ__cuda_‹am
 {

176 
ucc__‹am_t
 
	msu³r
;

177 
ušt32_t
 
	m£q_num
;

178 
ušt32_t
 
	m£q_num_aùive_£t
;

179 
ucc__cuda_‹am_tİo_t
 *
	mtİo
;

180 
ucc__cuda_sync_t
 *
	msync
;

181 
ucc__cuda_sync_¡©e_t
 *
	msync_¡©e
;

182 
ucc__cuda_shm_b¬r›r_t
 *
	mb¬
;

183 
ucc__cuda_sü©ch_t
 
	msü©ch
;

184 
cudaSŒ—m_t
 
	m¡»am
;

185 
ucc__cuda_¿nk_id_t
 *
	mids
;

186 *
	msh¬ed_hªdËs
;

187 
ucc_‹am_oob_cŞl_t
 
	moob
;

188 *
	moob_»q
;

189 #ifdeà
HAVE_TL_CUDA_NVLS


190 
ucc__cuda_nvls_t
 
	mnvls
;

192 } 
	tucc__cuda_‹am_t
;

194 
UCC_CLASS_DECLARE
(
ucc__cuda_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

195 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

198 
ucc__cuda_sk
 
	tucc__cuda_sk_t
;

199 
	succ__cuda_sk
 {

200 
ucc_cŞl_sk_t
 
	msu³r
;

201 
ušt32_t
 
	m£q_num
;

202 
ušt32_t
 
	mcŞl_id
;

203 
ucc__cuda_shm_b¬r›r_t
 *
	mb¬
;

204 
ucc_sub£t_t
 
	msub£t
;

207 
	m¡age
;

208 
ucc__cuda_mem_šfo_t
 
	mmem_šfo_¤c
;

209 
ucc__cuda_mem_šfo_t
 
	mmem_šfo_d¡
;

210 *
	m³”_m­_addr_¤c
[
UCC_TL_CUDA_MAX_PEERS
];

211 *
	m³”_m­_addr_d¡
[
UCC_TL_CUDA_MAX_PEERS
];

212 
	mnum_po¡ed
;

213 
ucc_d©©y³_t
 
	msdt
;

214 
ucc_d©©y³_t
 
	mrdt
;

215 *
	msbuf
;

216 *
	mrbuf
;

217 
ucc_couÁ_t
 *
	msúts
;

218 
ucc_couÁ_t
 *
	mrúts
;

219 
ucc_ašt_t
 *
	msdi¥l
;

220 
ucc_ašt_t
 *
	mrdi¥l
;

221 
ucc_“_executÜ_sk_t


222 *
	mexec_sk
[
UCC_TL_CUDA_MAX_PEERS
 * UCC_TL_CUDA_MAX_PEERS];

223 
size_t
 (*
g‘_size
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
, size_ˆ*
	mby‹s
,

224 
ucc_¿nk_t
 
	mblock
);

225 
size_t
 (*
g‘_off£t
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

226 
size_t
 *
	mdi¥l_by‹s
, 
ucc_¿nk_t
 
	mblock
);

227 } 
	m®ÉßÎv_û
;

229 
	m¡age
;

230 
	mnum_äags
;

231 
	mnum_ršgs
;

232 
	mnum_chunks
;

233 
ucc_d©©y³_t
 
	mdt
;

234 *
	msbuf
;

235 *
	mrbuf
;

236 
ucc_“_executÜ_sk_t
 *
	mexec_sk
[2 * 
UCC_TL_CUDA_MAX_RING_CHUNKS
];

237 
size_t
 (*
g‘_couÁ
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

238 
ucc_¿nk_t
 
	mblock
);

239 
size_t
 (*
g‘_off£t
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

240 
ucc_¿nk_t
 
	mblock
);

241 } 
	m®lg©h”v_ršg
;

243 
	m¡age
;

244 
	mnum_äags
;

245 
ucc_d©©y³_t
 
	mdt
;

246 * 
	msbuf
;

247 * 
	mrbuf
;

248 
ucc_“_executÜ_sk_t
 *
	mexec_sk
[2];

249 
size_t
 (*
g‘_couÁ
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

250 
ucc_¿nk_t
 
	mblock
);

251 
size_t
 (*
g‘_off£t
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

252 
ucc_¿nk_t
 
	mblock
);

253 } 
	m®lg©h”v_lš—r
;

255 
	m¡age
;

256 
	m¡•
;

257 *
	msbuf
;

258 
ucc_d©©y³_t
 
	mdt
;

259 
ucc_¿nk_t
 
	mroÙ
;

260 
size_t
 
	msize
;

261 
	mnum_¡•s
;

262 
ucc_“_executÜ_sk_t
 *
	mexec_sk
;

263 
ušt64_t
 
	mkey
;

264 } 
	mbÿ¡_lš—r
;

266 
	m¡age
;

267 
	mnum_äags
;

268 
	mnum_ršgs
;

269 
ucc_d©©y³_t
 
	mdt
;

270 *
	msbuf
;

271 *
	mrbuf
;

272 
ucc_“_executÜ_sk_t
 *
	mexec_sk
[
UCC_TL_CUDA_MAX_RING_CHUNKS
];

273 
size_t
 (*
g‘_couÁ
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

274 
ucc_¿nk_t
 
	mblock
);

275 
size_t
 (*
g‘_off£t
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

276 
ucc_¿nk_t
 
	mblock
);

277 } 
	m»duû_sÿ‰”v_ršg
;

279 
	m¡age
;

280 
	mnum_äags
;

281 
ucc_d©©y³_t
 
	mdt
;

282 * 
	msbuf
;

283 * 
	mrbuf
;

284 
ucc_“_executÜ_sk_t
 *
	mexec_sk
[2];

285 
size_t
 (*
g‘_couÁ
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

286 
ucc_¿nk_t
 
	mblock
);

287 
size_t
 (*
g‘_off£t
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

288 
ucc_¿nk_t
 
	mblock
);

289 } 
	m»duû_sÿ‰”v_lš—r
;

291 
	m¡age
;

292 
	mnum_äags
;

293 
ucc_d©©y³_t
 
	mdt
;

294 * 
	msbuf
;

295 * 
	mrbuf
;

296 
size_t
 
	m¤c_size_by‹s
;

297 
size_t
 
	md¡_size_by‹s
;

298 
size_t
 (*
g‘_couÁ
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

299 
ucc_¿nk_t
 
	mblock
);

300 
size_t
 (*
g‘_off£t
)(cÚ¡ 
ucc__cuda_sk_t
 *
	msk
,

301 
ucc_¿nk_t
 
	mblock
);

302 
cudaEv’t_t
 
	mevtCİy
;

303 
cudaEv’t_t
 
	mevtCom¶‘iÚ
;

304 } 
	m»duû_sÿ‰”v_nvls
;

306 
	m¡age
;

307 
ucc_d©©y³_t
 
	mdt
;

308 *
	msbuf
;

309 *
	mrbuf
;

310 
size_t
 
	mbuf_size_by‹s
;

311 *
	mevtCom¶‘iÚ
;

312 } 
	m®Ìeduû_nvls
;

	@src/components/tl/cuda/tl_cuda_cache.c

7 
	~"cÚfig.h
"

8 
	~"_cuda.h
"

9 
	~"_cuda_ÿche.h
"

10 
	~"_cuda_•_hash.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"uts/¬ch/cuda_def.h
"

14 
	~"cÜe/ucc_‹am.h
"

15 
	~<cuda_ruÁime.h
>

17 
	#ENABLE_CACHE
 1

	)

19 
ucs_pgt_dœ_t
*

20 
	$ucc__cuda_ÿche_pgt_dœ_®loc
(cÚ¡ 
ucs_pgbË_t
 *
pgbË
)

22 *
±r
;

23 
»t
;

25 
»t
 = 
	`posix_mem®ign
(&
±r
, 
	`ucc_max
((*), 
UCS_PGT_ENTRY_MIN_ALIGN
),

26 (
ucs_pgt_dœ_t
));

27  (
»t
 =ğ0è? 
±r
 : 
NULL
;

28 
	}
}

30 
	$ucc__cuda_ÿche_pgt_dœ_»Ëa£
(cÚ¡ 
ucs_pgbË_t
 *
pgbË
,

31 
ucs_pgt_dœ_t
 *
dœ
)

33 
	`ä“
(
dœ
);

34 
	}
}

37 
	$ucc__cuda_ÿche_»giÚ_cŞËù_ÿÎback
(cÚ¡ 
ucs_pgbË_t
 *
pgbË
,

38 
ucs_pgt_»giÚ_t
 *
pgt_»giÚ
,

39 *
¬g
)

41 
ucs_li¡_lšk_t
 *
li¡
 = 
¬g
;

42 
ucc__cuda_ÿche_»giÚ_t
 *
»giÚ
;

44 
»giÚ
 = 
	`ucc_d”ived_of
(
pgt_»giÚ
, 
ucc__cuda_ÿche_»giÚ_t
);

45 
	`ucs_li¡_add_
(
li¡
, &
»giÚ
->list);

46 
	}
}

48 
	$ucc__cuda_ÿche_purge
(
ucc__cuda_ÿche_t
 *
ÿche
)

50 
ucc__cuda_ÿche_»giÚ_t
 *
»giÚ
, *
tmp
;

51 
ucs_li¡_lšk_t
 
»giÚ_li¡
;

53 
	`ucs_li¡_h—d_š™
(&
»giÚ_li¡
);

54 
	`ucs_pgbË_purge
(&
ÿche
->
pgbË
, 
ucc__cuda_ÿche_»giÚ_cŞËù_ÿÎback
,

55 &
»giÚ_li¡
);

56 
	`ucs_li¡_fÜ_—ch_§ã
(
»giÚ
, 
tmp
, &
»giÚ_li¡
, 
li¡
) {

57 
	`CUDA_FUNC
(
	`cudaIpcClo£MemHªdË
(
»giÚ
->
m­³d_addr
));

58 
	`ä“
(
»giÚ
);

60 
	}
}

62 
ucc_¡©us_t
 
	$ucc__cuda_ü—‹_ÿche
(
ucc__cuda_ÿche_t
 **
ÿche
,

63 cÚ¡ *
Çme
)

65 
ucc_¡©us_t
 
¡©us
;

66 
ucs_¡©us_t
 
ucs_¡
;

67 
ucc__cuda_ÿche_t
 *
ÿche_desc
;

68 
»t
;

70 
ÿche_desc
 = 
	`ucc_m®loc
((
ucc__cuda_ÿche_t
), "ucc_tl_cuda_cache_t");

71 ià(
ÿche_desc
 =ğ
NULL
) {

72 
	`ucc_”rÜ
("failedo‡llocate memory forl_cuda cache");

73  
UCC_ERR_NO_MEMORY
;

76 
»t
 = 
	`±h»ad_rwlock_š™
(&
ÿche_desc
->
lock
, 
NULL
);

77 ià(
»t
) {

78 
	`ucc_”rÜ
("pthread_rwlock_init() failed: %m");

79 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

80 
”r
;

83 
ucs_¡
 = 
	`ucs_pgbË_š™
(&
ÿche_desc
->
pgbË
,

84 
ucc__cuda_ÿche_pgt_dœ_®loc
,

85 
ucc__cuda_ÿche_pgt_dœ_»Ëa£
);

86 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
ucs_¡
)) {

87 
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡
);

88 
”r_de¡roy_rwlock
;

91 
ÿche_desc
->
Çme
 = 
	`¡rdup
(name);

92 ià(
ÿche_desc
->
Çme
 =ğ
NULL
) {

93 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

94 
”r_de¡roy_rwlock
;

97 *
ÿche
 = 
ÿche_desc
;

98  
UCC_OK
;

100 
”r_de¡roy_rwlock
:

101 
	`±h»ad_rwlock_de¡roy
(&
ÿche_desc
->
lock
);

102 
”r
:

103 
	`ä“
(
ÿche_desc
);

104  
¡©us
;

105 
	}
}

107 
	$ucc__cuda_de¡roy_ÿche
(
ucc__cuda_ÿche_t
 *
ÿche
)

109 
	`ucc__cuda_ÿche_purge
(
ÿche
);

110 
	`ucs_pgbË_ş—nup
(&
ÿche
->
pgbË
);

111 
	`±h»ad_rwlock_de¡roy
(&
ÿche
->
lock
);

112 
	`ä“
(
ÿche
->
Çme
);

113 
	`ä“
(
ÿche
);

114 
	}
}

116 #ià
ENABLE_CACHE


117 
	$ucc__cuda_ÿche_šv®id©e_»giÚs
(
ucc__cuda_ÿche_t
 *
ÿche
,

118 *
äom
, *
to
)

120 
ucs_li¡_lšk_t
 
»giÚ_li¡
;

121 
ucs_¡©us_t
 
¡©us
;

122 
ucc__cuda_ÿche_»giÚ_t
 *
»giÚ
, *
tmp
;

124 
	`ucs_li¡_h—d_š™
(&
»giÚ_li¡
);

125 
	`ucs_pgbË_£¬ch_¿nge
(&
ÿche
->
pgbË
, (
ucs_pgt_addr_t
)
äom
,

126 (
ucs_pgt_addr_t
)
to
 - 1,

127 
ucc__cuda_ÿche_»giÚ_cŞËù_ÿÎback
,

128 &
»giÚ_li¡
);

129 
	`ucs_li¡_fÜ_—ch_§ã
(
»giÚ
, 
tmp
, &
»giÚ_li¡
, 
li¡
) {

130 
¡©us
 = 
	`ucs_pgbË_»move
(&
ÿche
->
pgbË
, &
»giÚ
->
su³r
);

131 ià(
¡©us
 !ğ
UCS_OK
) {

132 
	`ucc_”rÜ
("failedo„emove‡ddress:%p from cache (%s)",

133 (*)
»giÚ
->
d_±r
, 
	`ucs_¡©us_¡ršg
(
¡©us
));

135 
	`CUDA_FUNC
(
	`cudaIpcClo£MemHªdË
(
»giÚ
->
m­³d_addr
));

136 
	`ä“
(
»giÚ
);

138 
	`ucc_Œaû
("%s: closed memhandles inhe„ange [%p..%p]",

139 
ÿche
->
Çme
, 
äom
, 
to
);

140 
	}
}

143 
ucc_¡©us_t


144 
	$ucc__cuda_m­_memhªdË
(cÚ¡ *
d_±r
, 
size_t
 
size
,

145 
cudaIpcMemHªdË_t
 
mem_hªdË
, **
m­³d_addr
,

146 
ucc__cuda_ÿche_t
 *
ÿche
)

148 ià(
d_±r
 =ğ
NULL
 || 
size
 == 0) {

149 *
m­³d_addr
 = 
NULL
;

150  
UCC_OK
;

152 #ià
ENABLE_CACHE


153 
ucc_¡©us_t
 
¡©us
;

154 
ucs_¡©us_t
 
ucs_¡©us
;

155 
ucs_pgt_»giÚ_t
 *
pgt_»giÚ
;

156 
ucc__cuda_ÿche_»giÚ_t
 *
»giÚ
;

157 
cudaE¼Ü_t
 
cu”r
;

158 
»t
;

160 
	`±h»ad_rwlock_w¾ock
(&
ÿche
->
lock
);

161 
pgt_»giÚ
 = 
	`ucs_pgbË_lookup
(&
ÿche
->
pgbË
, (
ušŒ_t
è
d_±r
);

162 ià(
pgt_»giÚ
 !ğ
NULL
) {

163 
»giÚ
 = 
	`ucc_d”ived_of
(
pgt_»giÚ
, 
ucc__cuda_ÿche_»giÚ_t
);

164 ià(
	`memcmp
((cÚ¡ *)&
mem_hªdË
, (cÚ¡ *)&
»giÚ
->mem_handle,

165 (
cudaIpcMemHªdË_t
)) == 0) {

167 
	`ucc_debug
("%s:l_cuda cache hit‡ddr:%p size:%lu„egion:"

168 
UCS_PGT_REGION_FMT
, 
ÿche
->
Çme
, 
d_±r
,

169 
size
, 
	`UCS_PGT_REGION_ARG
(&
»giÚ
->
su³r
));

171 *
m­³d_addr
 = 
»giÚ
->mapped_addr;

172 
	`ucc_as£¹
(
»giÚ
->
»fcouÁ
 < 
UINT64_MAX
);

173 
»giÚ
->
»fcouÁ
++;

174 
	`±h»ad_rwlock_uÆock
(&
ÿche
->
lock
);

175  
UCC_OK
;

177 
	`ucc_debug
("%s:l_cuda cache„emove stale„egion:"

178 
UCS_PGT_REGION_FMT
 "‚ew_addr:%p‚ew_size:%lu",

179 
ÿche
->
Çme
, 
	`UCS_PGT_REGION_ARG
(&
»giÚ
->
su³r
),

180 
d_±r
, 
size
);

182 
ucs_¡©us
 = 
	`ucs_pgbË_»move
(&
ÿche
->
pgbË
, &
»giÚ
->
su³r
);

183 ià(
	`ucc_uÆik–y
(
ucs_¡©us
 !ğ
UCS_OK
)) {

184 
	`ucc_”rÜ
("%s: failedo„emove‡ddress:%p from cache",

185 
ÿche
->
Çme
, 
d_±r
);

186 
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

187 
”r
;

191 
cu”r
 = 
	`cudaIpcClo£MemHªdË
(
»giÚ
->
m­³d_addr
);

192 ià(
	`ucc_uÆik–y
(
cu”r
 !ğ
cudaSucûss
)) {

193 
	`ucc_”rÜ
("cudaIpcClo£MemHªdËƒ¼Ü %d %s", 
cu”r
,

194 
	`cudaG‘E¼ÜName
(
cu”r
));

195 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

196 
”r
;

198 
	`ä“
(
»giÚ
);

202 
cu”r
 = 
	`cudaIpcO³nMemHªdË
(
m­³d_addr
, 
mem_hªdË
,

203 
cudaIpcMemLazyEÇbËP“rAcûss
);

204 ià(
cu”r
 !ğ
cudaSucûss
) {

205 ià(
cu”r
 =ğ
cudaE¼ÜAÌ—dyM­³d
) {

206 
	`ucc__cuda_ÿche_šv®id©e_»giÚs
(
ÿche
,

207 (*)
	`ucc_®ign_down_pow2
((
ušŒ_t
)
d_±r
,

208 
UCS_PGT_ADDR_ALIGN
),

209 (*)
	`ucc_®ign_up_pow2
((
ušŒ_t
)
d_±r
 + 
size
,

210 
UCS_PGT_ADDR_ALIGN
));

211 
cu”r
 = 
	`cudaIpcO³nMemHªdË
(
m­³d_addr
, 
mem_hªdË
,

212 
cudaIpcMemLazyEÇbËP“rAcûss
);

213 ià(
cu”r
 !ğ
cudaSucûss
) {

214 ià(
cu”r
 =ğ
cudaE¼ÜAÌ—dyM­³d
) {

215 
	`ucc__cuda_ÿche_purge
(
ÿche
);

216 
cu”r
 = 
	`cudaIpcO³nMemHªdË
(
m­³d_addr
, 
mem_hªdË
,

217 
cudaIpcMemLazyEÇbËP“rAcûss
);

218 ià(
	`ucc_uÆik–y
(
cu”r
 !ğ
cudaSucûss
)) {

219 
	`ucc_”rÜ
("cudaIpcO³nMemHªdËƒ¼Ü %d %s", 
cu”r
,

220 
	`cudaG‘E¼ÜSŒšg
(
cu”r
));

221 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

222 
”r
;

225 
	`ucc_”rÜ
("%s: failedo open ipc mem handle.‡ddr:%p†en:%lu",

226 
ÿche
->
Çme
, 
d_±r
, 
size
);

229 
	`cudaG‘La¡E¼Ü
();

231 
	`ucc_”rÜ
("%s: failedo open ipc mem handle.‡ddr:%p†en:%lu "

232 "”r:%d", 
ÿche
->
Çme
, 
d_±r
, 
size
, 
cu”r
);

233 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

234 
”r
;

239 
»t
 = 
	`posix_mem®ign
((**)&
»giÚ
,

240 
	`ucc_max
((*), 
UCS_PGT_ENTRY_MIN_ALIGN
),

241 (
ucc__cuda_ÿche_»giÚ_t
));

242 ià(
»t
 != 0) {

243 
	`ucc_w¬n
("failedo‡llocate uct_tl_cuda_cache„egion");

244 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

245 
”r
;

248 
»giÚ
->
su³r
.
¡¬t
 = 
	`ucc_®ign_down_pow2
((
ušŒ_t
)
d_±r
,

249 
UCS_PGT_ADDR_ALIGN
);

250 
»giÚ
->
su³r
.
’d
 = 
	`ucc_®ign_up_pow2
 ((
ušŒ_t
)
d_±r
 + 
size
,

251 
UCS_PGT_ADDR_ALIGN
);

252 
»giÚ
->
d_±r
 = (*)d_ptr;

253 
»giÚ
->
size
 = size;

254 
»giÚ
->
mem_hªdË
 = mem_handle;

255 
»giÚ
->
m­³d_addr
 = *mapped_addr;

256 
»giÚ
->
»fcouÁ
 = 1;

258 
ucs_¡©us
 = 
	`ucs_pgbË_š£¹
(&
ÿche
->
pgbË
, &
»giÚ
->
su³r
);

259 ià(
ucs_¡©us
 =ğ
UCS_ERR_ALREADY_EXISTS
) {

261 
	`ucc__cuda_ÿche_šv®id©e_»giÚs
(
ÿche
,

262 (*)
»giÚ
->
su³r
.
¡¬t
,

263 (*)
»giÚ
->
su³r
.
’d
);

264 
ucs_¡©us
 = 
	`ucs_pgbË_š£¹
(&
ÿche
->
pgbË
, &
»giÚ
->
su³r
);

267 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

268 
	`ucc_”rÜ
("%s: faedØš£¹„egiÚ:"
UCS_PGT_REGION_FMT
" size:%lu :%s",

269 
ÿche
->
Çme
, 
	`UCS_PGT_REGION_ARG
(&
»giÚ
->
su³r
), 
size
,

270 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
));

271 
	`ä“
(
»giÚ
);

272 
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

273 
”r
;

276 
	`ucc_debug
("%s:l_cud¨ÿchÃw„egiÚ:"
UCS_PGT_REGION_FMT
" size:%lu",

277 
ÿche
->
Çme
, 
	`UCS_PGT_REGION_ARG
(&
»giÚ
->
su³r
), 
size
);

279 
¡©us
 = 
UCC_OK
;

281 
”r
:

282 
	`±h»ad_rwlock_uÆock
(&
ÿche
->
lock
);

284  
¡©us
;

288 
	`CUDA_FUNC
(
	`cudaIpcO³nMemHªdË
(
m­³d_addr
, 
mem_hªdË
,

289 
cudaIpcMemLazyEÇbËP“rAcûss
));

290  
UCC_OK
;

292 
	}
}

294 
ucc_¡©us_t
 
	$ucc__cuda_unm­_memhªdË
(
ušŒ_t
 
d_b±r
, *
m­³d_addr
,

295 
ucc__cuda_ÿche_t
 *
ÿche
, 
fÜû
)

298 ià((
d_b±r
 =ğ0è|| (
m­³d_addr
 == 0)) {

299  
UCC_OK
;

302 #ià
ENABLE_CACHE


303 
ucs_pgt_»giÚ_t
 *
pgt_»giÚ
;

304 
ucc__cuda_ÿche_»giÚ_t
 *
»giÚ
;

307 
	`±h»ad_rwlock_w¾ock
(&
ÿche
->
lock
);

308 
pgt_»giÚ
 = 
	`ucs_pgbË_lookup
(&
ÿche
->
pgbË
, 
d_b±r
);

310 
	`ucc_debug
("%s:l_cuda unmap‡ddr:%p„egion:"

311 
UCS_PGT_REGION_FMT
, 
ÿche
->
Çme
, (*)
d_b±r
,

312 
	`UCS_PGT_REGION_ARG
(
pgt_»giÚ
));

314 
	`ucc_as£¹
(
pgt_»giÚ
 !ğ
NULL
);

315 
»giÚ
 = 
	`ucc_d”ived_of
(
pgt_»giÚ
, 
ucc__cuda_ÿche_»giÚ_t
);

317 
	`ucc_as£¹
(
»giÚ
->
»fcouÁ
 >= 1);

318 
»giÚ
->
»fcouÁ
--;

320 ià((
»giÚ
->
»fcouÁ
 =ğ0 ) && (
fÜû
 == 1)) {

321 
	`ucs_pgbË_»move
(&
ÿche
->
pgbË
, &
»giÚ
->
su³r
);

322 
	`CUDA_FUNC
(
	`cudaIpcClo£MemHªdË
(
m­³d_addr
));

325 
	`±h»ad_rwlock_uÆock
(&
ÿche
->
lock
);

327 
	`CUDA_FUNC
(
	`cudaIpcClo£MemHªdË
(
m­³d_addr
));

329  
UCC_OK
;

330 
	}
}

332 
ucc__cuda_ÿche_t
* 
	$ucc__cuda_g‘_ÿche
(
ucc__cuda_‹am_t
 *
‹am
,

333 
ucc_¿nk_t
 
¿nk
)

335 
ucc__cuda_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_CUDA_TEAM_CTX
(
‹am
);

336 
ucc_cÚ‹xt_addr_h—d”_t
 *
h
 = 
NULL
;

337 
ucc__cuda_ÿche_t
 *
ÿche
;

338 
ucc_¡©us_t
 
¡©us
;

340 
h
 = 
	`ucc_g‘_‹am_•_h—d”
(
	`UCC_TL_CORE_CTX
(
‹am
), 
	`UCC_TL_CORE_TEAM
(team),

341 
¿nk
);

342 
ÿche
 = 
	`_cuda_hash_g‘
(
ùx
->
c_ÿche
, 
h
->
ùx_id
);

343 ià(
	`ucc_uÆik–y
(
NULL
 =ğ
ÿche
)) {

344 
¡©us
 = 
	`ucc__cuda_ü—‹_ÿche
(&
ÿche
, "ipc-cache");

345 ià(
¡©us
 !ğ
UCC_OK
) {

346 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo create ipc cache");

347  
NULL
;

349 
	`_cuda_hash_put
(
ùx
->
c_ÿche
, 
h
->
ùx_id
, 
ÿche
);

351  
ÿche
;

352 
	}
}

	@src/components/tl/cuda/tl_cuda_cache.h

7 #iâdeà
UCC_TL_CUDA_CACHE_H_


8 
	#UCC_TL_CUDA_CACHE_H_


	)

10 
	~<ucs/d©a¡ruù/pgbË.h
>

11 
	~<ucs/d©a¡ruù/li¡.h
>

12 
	~<cuda.h
>

13 
	~<cuda_ruÁime.h
>

15 
	succ__cuda_ÿche_»giÚ
 {

16 
ucs_pgt_»giÚ_t
 
	msu³r
;

17 
ucs_li¡_lšk_t
 
	mli¡
;

18 *
	md_±r
;

19 
size_t
 
	msize
;

20 
cudaIpcMemHªdË_t
 
	mmem_hªdË
;

21 *
	mm­³d_addr
;

22 
ušt64_t
 
	m»fcouÁ
;

23 } 
	tucc__cuda_ÿche_»giÚ_t
;

25 
	succ__cuda_ÿche
 {

26 
±h»ad_rwlock_t
 
	mlock
;

27 
ucs_pgbË_t
 
	mpgbË
;

28 *
	mÇme
;

29 } 
	tucc__cuda_ÿche_t
;

31 
ucc_¡©us_t
 
ucc__cuda_ü—‹_ÿche
(
ucc__cuda_ÿche_t
 **
ÿche
,

32 cÚ¡ *
Çme
);

34 
ucc__cuda_de¡roy_ÿche
(
ucc__cuda_ÿche_t
 *
ÿche
);

36 
ucc_¡©us_t
 
ucc__cuda_m­_memhªdË
(cÚ¡ *
d±r
, 
size_t
 
size
,

37 
cudaIpcMemHªdË_t
 
mem_hªdË
,

38 **
m­³d_addr
,

39 
ucc__cuda_ÿche_t
 *
ÿche
);

41 
ucc_¡©us_t
 
ucc__cuda_unm­_memhªdË
(
ušŒ_t
 
d_b±r
, *
m­³d_addr
,

42 
ucc__cuda_ÿche_t
 *
ÿche
, 
fÜû
);

44 
ucc__cuda_ÿche_t
* 
ucc__cuda_g‘_ÿche
(
ucc__cuda_‹am_t
 *
‹am
,

45 
ucc_¿nk_t
 
¿nk
);

	@src/components/tl/cuda/tl_cuda_coll.c

7 
	~"_cuda_cŞl.h
"

8 
	~"®ÉßÎ/®ÉßÎ.h
"

9 
	~"®ÉßÎv/®ÉßÎv.h
"

10 
	~"®lg©h”/®lg©h”.h
"

11 
	~"®lg©h”v/®lg©h”v.h
"

12 
	~"bÿ¡/bÿ¡.h
"

13 
	~"»duû_sÿ‰”/»duû_sÿ‰”.h
"

14 
	~"»duû_sÿ‰”v/»duû_sÿ‰”v.h
"

15 
	~"®Ìeduû/®Ìeduû.h
"

16 
	~"uts/¬ch/ıu.h
"

17 
	~"uts/¬ch/cuda_def.h
"

20 #ià
ENABLE_DEBUG
 == 1

22 
	#UCC_TL_CUDA_CHECK_DEVICE_MATCH
(
_‹am
) do { \

23 
_dev
; \

24 
	`CUDA_CHECK
(
	`cudaG‘Deviû
(&
_dev
)); \

25 ià(
_dev
 !ğ
	`UCC_TL_CUDA_TEAM_CTX
(
_‹am
)->
deviû
) { \

26 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "CUDA device mismatch, " \

27 "cu¼’ˆdeviû %d,—m deviû %d\n", 
_dev
, \

28 
	`UCC_TL_CUDA_TEAM_CTX
(
_‹am
)->
deviû
); \

29  
UCC_ERR_INVALID_PARAM
; \

31 } 0)

	)

33 
	#UCC_TL_CUDA_CHECK_DEVICE_MATCH
(
_‹am
)

	)

37 
	gucc__cuda_deçuÉ_®g_£Ëù_¡r
[
UCC_TL_CUDA_N_DEFAULT_ALG_SELECT_STR
] = {

38 
UCC_TL_CUDA_ALLGATHER_DEFAULT_ALG_SELECT_STR
,

39 
UCC_TL_CUDA_ALLGATHERV_DEFAULT_ALG_SELECT_STR
,

40 
UCC_TL_CUDA_BCAST_DEFAULT_ALG_SELECT_STR
,

41 
UCC_TL_CUDA_ALLREDUCE_DEFAULT_ALG_SELECT_STR
,

42 
UCC_TL_CUDA_REDUCE_SCATTER_DEFAULT_ALG_SELECT_STR
,

43 
UCC_TL_CUDA_REDUCE_SCATTERV_DEFAULT_ALG_SELECT_STR
};

45 
ucc_¡©us_t
 
	$ucc__cuda_mem_šfo_g‘
(*
±r
, 
size_t
 
Ëngth
,

46 
ucc__cuda_mem_šfo_t
 *
mi
)

48 
ucc_mem_©Œ_t
 
mem_©Œ
;

49 
ucc_¡©us_t
 
¡©us
;

51 ià(
±r
 =ğ
NULL
 || 
Ëngth
 == 0) {

52 
mi
->
±r
 = 
NULL
;

53 
mi
->
Ëngth
 = 0;

54 
mi
->
off£t
 = 0;

55  
UCC_OK
;

58 
mem_©Œ
.
f›ld_mask
 =

59 
UCC_MEM_ATTR_FIELD_BASE_ADDRESS
 | 
UCC_MEM_ATTR_FIELD_ALLOC_LENGTH
;

60 
mem_©Œ
.
®loc_Ëngth
 = 
Ëngth
;

61 
¡©us
 = 
	`ucc_mc_g‘_mem_©Œ
(
±r
, &
mem_©Œ
);

62 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

63  
¡©us
;

65 
mi
->
±r
 = 
mem_©Œ
.
ba£_add»ss
;

66 
mi
->
Ëngth
 = 
mem_©Œ
.
®loc_Ëngth
;

67 
mi
->
off£t
 = (
±rdiff_t
)
±r
 - (ptrdiff_t)mi->ptr;

68 
	`CUDA_CHECK_GOTO
(
	`cudaIpcG‘MemHªdË
(&
mi
->
hªdË
, mi->
±r
), 
ex™
, 
¡©us
);

69 
ex™
:

70  
¡©us
;

71 
	}
}

73 
ucc_¡©us_t
 
	$ucc__cuda_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

74 
ucc_ba£_‹am_t
 *
‹am
,

75 
ucc_cŞl_sk_t
 **
sk_h
)

77 
	`UCC_TL_CUDA_CHECK_DEVICE_MATCH
(
	`ucc_d”ived_of
(
‹am
, 
ucc__cuda_‹am_t
));

78 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
) {

79 
UCC_COLL_TYPE_ALLTOALL
:

80  
	`ucc__cuda_®ÉßÎ_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

81 
UCC_COLL_TYPE_ALLGATHER
:

82  
	`ucc__cuda_®lg©h”_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

83 
UCC_COLL_TYPE_ALLGATHERV
:

84  
	`ucc__cuda_®lg©h”v_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

85 
UCC_COLL_TYPE_BCAST
:

86  
	`ucc__cuda_bÿ¡_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

87 
UCC_COLL_TYPE_REDUCE_SCATTER
:

88  
	`ucc__cuda_»duû_sÿ‰”_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

89 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

90  
	`ucc__cuda_»duû_sÿ‰”v_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

91 
UCC_COLL_TYPE_ALLREDUCE
:

92  
	`ucc__cuda_®Ìeduû_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

93 
UCC_COLL_TYPE_ALLTOALLV
:

94  
	`ucc__cuda_®ÉßÎv_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

96  
UCC_ERR_NOT_SUPPORTED
;

98 
	}
}

100 
ucc_¡©us_t
 
	$ucc__cuda_shm_b¬r›r_š™_roÙ
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
, ucc_¿nk_ˆ
roÙ
,

101 
ucc__cuda_shm_b¬r›r_t
 *
b¬r›r
)

103 ià(
¿nk
 =ğ
roÙ
) {

104 
b¬r›r
->
size
 = size;

105 
b¬r›r
->
couÁ
 = 0;

106 
b¬r›r
->
£n£
 = 0;

108 
b¬r›r
->
¡©e
[
¿nk
] = 
UCC_OK
;

109 
b¬r›r
->
loÿl_£n£
[
¿nk
] = 1;

110  
UCC_OK
;

111 
	}
}

113 
ucc_¡©us_t
 
	$ucc__cuda_shm_b¬r›r_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
,

114 
ucc__cuda_shm_b¬r›r_t
 *
b¬r›r
)

116 ià(
¿nk
 == 0) {

117 
b¬r›r
->
size
 = size;

118 
b¬r›r
->
couÁ
 = 0;

119 
b¬r›r
->
£n£
 = 0;

121 
b¬r›r
->
¡©e
[
¿nk
] = 
UCC_OK
;

122 
b¬r›r
->
loÿl_£n£
[
¿nk
] = 1;

123  
UCC_OK
;

124 
	}
}

126 
ucc_¡©us_t
 
	$ucc__cuda_shm_b¬r›r_¡¬t
(
ucc_¿nk_t
 
¿nk
,

127 
ucc__cuda_shm_b¬r›r_t
 *
b¬r›r
)

129 
ucc_¿nk_t
 
pos
 = 
	`ucc_©omic_çdd32
(&
b¬r›r
->
couÁ
, 1);

131 
b¬r›r
->
¡©e
[
¿nk
] = 
UCC_INPROGRESS
;

132 ià(
pos
 =ğ
b¬r›r
->
size
 - 1) {

133 
b¬r›r
->
couÁ
 = 0;

134 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

135 
b¬r›r
->
£n£
 = b¬r›r->
loÿl_£n£
[
¿nk
];

137  
UCC_OK
;

138 
	}
}

140 
ucc_¡©us_t
 
	$ucc__cuda_shm_b¬r›r_‹¡
(
ucc_¿nk_t
 
¿nk
,

141 
ucc__cuda_shm_b¬r›r_t
 *
b¬r›r
)

143 ià(
b¬r›r
->
£n£
 !ğb¬r›r->
loÿl_£n£
[
¿nk
]) {

144  
UCC_INPROGRESS
;

146 
b¬r›r
->
¡©e
[
¿nk
] = 
UCC_OK
;

147 
b¬r›r
->
loÿl_£n£
[
¿nk
] = 1 - barrier->local_sense[rank];

148  
UCC_OK
;

149 
	}
}

151 
šlše
 
	$®g_id_äom_¡r
(
ucc_cŞl_ty³_t
 
cŞl_ty³
, cÚ¡ *
¡r
)

153 
cŞl_ty³
) {

154 
UCC_COLL_TYPE_ALLGATHER
:

155  
	`ucc__cuda_®lg©h”_®g_äom_¡r
(
¡r
);

156 
UCC_COLL_TYPE_ALLGATHERV
:

157  
	`ucc__cuda_®lg©h”v_®g_äom_¡r
(
¡r
);

158 
UCC_COLL_TYPE_BCAST
:

159  
	`ucc__cuda_bÿ¡_®g_äom_¡r
(
¡r
);

160 
UCC_COLL_TYPE_ALLREDUCE
:

161  
	`ucc__cuda_®Ìeduû_®g_äom_¡r
(
¡r
);

166 
	}
}

168 
ucc_¡©us_t
 
	$ucc__cuda_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

169 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

170 
ucc_memÜy_ty³_t
 
mem_ty³
,

171 
ucc_ba£_cŞl_š™_â_t
 *
š™
)

173 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

174 ià(
®g_id_¡r
) {

175 
®g_id
 = 
	`®g_id_äom_¡r
(
cŞl_ty³
, 
®g_id_¡r
);

178 ià(
mem_ty³
 !ğ
UCC_MEMORY_TYPE_CUDA
) {

179  
UCC_ERR_NOT_SUPPORTED
;

182 
cŞl_ty³
) {

183 
UCC_COLL_TYPE_ALLGATHER
:

184 
®g_id
) {

185 
UCC_TL_CUDA_ALLGATHER_ALG_AUTO
:

186 *
š™
 = 
ucc__cuda_®lg©h”_š™
;

188 
UCC_TL_CUDA_ALLGATHER_ALG_RING
:

189 *
š™
 = 
ucc__cuda_®lg©h”_ršg_š™
;

191 
UCC_TL_CUDA_ALLGATHER_ALG_LINEAR
:

192 *
š™
 = 
ucc__cuda_®lg©h”_lš—r_š™
;

195 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

199 
UCC_COLL_TYPE_ALLGATHERV
:

200 
®g_id
) {

201 
UCC_TL_CUDA_ALLGATHER_ALG_AUTO
:

202 *
š™
 = 
ucc__cuda_®lg©h”v_š™
;

204 
UCC_TL_CUDA_ALLGATHER_ALG_RING
:

205 *
š™
 = 
ucc__cuda_®lg©h”v_ršg_š™
;

207 
UCC_TL_CUDA_ALLGATHER_ALG_LINEAR
:

208 *
š™
 = 
ucc__cuda_®lg©h”v_lš—r_š™
;

211 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

215 
UCC_COLL_TYPE_BCAST
:

216 
®g_id
) {

217 
UCC_TL_CUDA_BCAST_ALG_LINEAR
:

218 *
š™
 = 
ucc__cuda_bÿ¡_lš—r_š™
;

221 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

225 
UCC_COLL_TYPE_ALLREDUCE
:

226 
®g_id
) {

227 #ifdeà
HAVE_NVLS


228 
UCC_TL_CUDA_ALLREDUCE_ALG_NVLS
:

229 *
š™
 = 
ucc__cuda_®Ìeduû_nvls_š™
;

232 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

236 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

241 
UCC_COLL_TYPE_REDUCE_SCATTER
:

242 
®g_id
) {

243 
UCC_TL_CUDA_REDUCE_SCATTER_ALG_AUTO
:

244 *
š™
 = 
ucc__cuda_»duû_sÿ‰”_š™
;

246 
UCC_TL_CUDA_REDUCE_SCATTER_ALG_RING
:

247 *
š™
 = 
ucc__cuda_»duû_sÿ‰”_ršg_š™
;

249 
UCC_TL_CUDA_REDUCE_SCATTER_ALG_LINEAR
:

250 *
š™
 = 
ucc__cuda_»duû_sÿ‰”_lš—r_š™
;

252 #ifdeà
HAVE_NVLS


253 
UCC_TL_CUDA_REDUCE_SCATTER_ALG_NVLS
:

254 *
š™
 = 
ucc__cuda_»duû_sÿ‰”_nvls_š™
;

258 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

262 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

263 
®g_id
) {

264 
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_AUTO
:

265 *
š™
 = 
ucc__cuda_»duû_sÿ‰”v_š™
;

267 
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_RING
:

268 *
š™
 = 
ucc__cuda_»duû_sÿ‰”v_ršg_š™
;

270 
UCC_TL_CUDA_REDUCE_SCATTERV_ALG_LINEAR
:

271 *
š™
 = 
ucc__cuda_»duû_sÿ‰”v_lš—r_š™
;

274 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

279 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

282  
¡©us
;

283 
	}
}

	@src/components/tl/cuda/tl_cuda_coll.h

7 #iâdeà
UCC_TL_CUDA_COLL_H_


8 
	#UCC_TL_CUDA_COLL_H_


	)

10 
	~"_cuda.h
"

11 
	~"compÚ’ts/mc/ucc_mc.h
"

13 
	#UCC_TL_CUDA_N_DEFAULT_ALG_SELECT_STR
 6

	)

15 *
ucc__cuda_deçuÉ_®g_£Ëù_¡r
[
UCC_TL_CUDA_N_DEFAULT_ALG_SELECT_STR
];

17 
	#TASK_TEAM
(
_sk
) \

18 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
, 
ucc__cuda_‹am_t
))

	)

20 
	#TASK_ARGS
(
_sk
è(_sk)->
su³r
.
b¬gs
.
¬gs


	)

22 
	#TASK_SYNC
(
_sk
, 
_¿nk
) \

24 
ucc__cuda_‹am_t
 *
_‹am
 = 
	`TASK_TEAM
(
_sk
); \

25 
	`UCC_TL_CUDA_TEAM_SYNC
(
_‹am
, 
_¿nk
, (
_sk
)->
cŞl_id
); \

26 })

	)

28 
	#TASK_BAR
(
_sk
) \

30 
ucc__cuda_‹am_t
 *
_‹am
 = 
	`TASK_TEAM
(
_sk
); \

31 
	`UCC_TL_CUDA_TEAM_BARRIER
(
_‹am
, (
_sk
)->
cŞl_id
); \

32 })

	)

34 
	#TASK_SCRATCH
(
_sk
, 
_¿nk
) \

36 
ucc__cuda_‹am_t
 *
_‹am
 = 
	`TASK_TEAM
(
_sk
); \

37 
size_t
 
_sü©ch_size
 = 
	`UCC_TL_CUDA_TEAM_LIB
(
_‹am
)->
cfg
.
sü©ch_size
; \

38 *
_sü©ch
; \

39 ià(
_¿nk
 =ğ
	`UCC_TL_TEAM_RANK
(
_‹am
)) { \

40 
_sü©ch
 = 
_‹am
->
sü©ch
.
loc
; \

42 
_sü©ch
 = 
	`PTR_OFFSET
(
_‹am
->
sü©ch
.
»m
[
_¿nk
], \

43 
_‹am
->
sü©ch
.
»m_šfo
[
_¿nk
].
off£t
); \

45 (
	`PTR_OFFSET
(
_sü©ch
, (
_sk
)->
cŞl_id
 * 
_sü©ch_size
)); \

46 })

	)

48 
šlše
 
	$ucc__cuda_sk_»£t
(
ucc__cuda_sk_t
 *
sk
)

50 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

51 
	}
}

53 
ucc_¡©us_t
 
ucc__cuda_shm_b¬r›r_š™_roÙ
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
, ucc_¿nk_ˆ
roÙ
,

54 
ucc__cuda_shm_b¬r›r_t
 *
b¬r›r
);

56 
ucc_¡©us_t
 
ucc__cuda_shm_b¬r›r_š™
(
ucc_¿nk_t
 
size
, ucc_¿nk_ˆ
¿nk
,

57 
ucc__cuda_shm_b¬r›r_t
 *
b¬r›r
);

59 
ucc_¡©us_t
 
ucc__cuda_shm_b¬r›r_¡¬t
(
ucc_¿nk_t
 
¿nk
,

60 
ucc__cuda_shm_b¬r›r_t
 *
b¬r›r
);

62 
ucc_¡©us_t
 
ucc__cuda_shm_b¬r›r_‹¡
(
ucc_¿nk_t
 
¿nk
,

63 
ucc__cuda_shm_b¬r›r_t
 *
b¬r›r
);

66 
šlše
 
ucc__cuda_sk_t
 *
	$ucc__cuda_sk_g‘
(
ucc__cuda_‹am_t
 *
‹am
)

68 
ucc__cuda_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_CUDA_TEAM_CTX
(
‹am
);

69 
ucc__cuda_sk_t
 *
sk
 = 
	`ucc_mpoŞ_g‘
(&
ùx
->
»q_mp
);

71 ià(
	`ucc_uÆik–y
(!
sk
)) {

72 
	`_”rÜ
(
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
), "failedo getask from mpool");

73  
NULL
;

76 
	`UCC_TL_CUDA_PROFILE_REQUEST_NEW
(
sk
, "tl_cuda_task", 0);

77 
sk
->
su³r
.
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

78 
sk
->
su³r
.
æags
 = 0;

79 
sk
->
su³r
.
‹am
 = &team->super.super;

80 
	`ucc__cuda_sk_»£t
(
sk
);

81  
sk
;

82 
	}
}

84 
šlše
 
	$ucc__cuda_sk_put
(
ucc__cuda_sk_t
 *
sk
)

86 
	`UCC_TL_CUDA_PROFILE_REQUEST_FREE
(
sk
);

87 
	`ucc_mpoŞ_put
(
sk
);

88 
	}
}

90 
šlše
 
ušt64_t
 
	$compu‹_key
(
ucc_¿nk_t
 
roÙ
, ucc_¿nk_ˆ
³”
, 
ušt16_t
 
g
)

92 
	`as£¹
(
³”
 < (1 << 24));

93 
	`as£¹
(
roÙ
 < (1 << 24));

94  (
ušt64_t
)
g
 << 48 | 
roÙ
 << 24 | 
³”
;

95 
	}
}

97 
šlše


98 
ucc_¡©us_t
 
	$ucc__cuda_sk_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

99 
ucc__cuda_‹am_t
 *
‹am
,

100 
ucc__cuda_sk_t
 **
sk_h
)

102 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

103 
ucc__cuda_lib_t
 *
lib
 = 
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
);

104 
ušt32_t
 
max_cÚcu¼’t
 = 
lib
->
cfg
.max_concurrent;

105 
ucc_¿nk_t
 
³”
;

106 
ucc__cuda_sk_t
 *
sk
;

107 
ucc_¡©us_t
 
¡©us
;

109 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&
cŞl_¬gs
->
¬gs
, 
Œªk
)) {

110  
UCC_ERR_NOT_SUPPORTED
;

113 
sk
 = 
	`ucc__cuda_sk_g‘
(
‹am
);

114 ià(
	`ucc_uÆik–y
(!
sk
)) {

115  
UCC_ERR_NO_MEMORY
;

118 
¡©us
 = 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, 
cŞl_¬gs
, &
‹am
->super.super);

119 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

120 
	`ucc__cuda_sk_put
(
sk
);

121  
¡©us
;

125 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(&
cŞl_¬gs
->
¬gs
)) {

126 
	`ucc_as£¹
(
cŞl_¬gs
->
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
);

127 
sk
->
sub£t
.
m­
 = 
	`ucc_aùive_£t_to_•_m­
(&
cŞl_¬gs
->
¬gs
);

128 
sk
->
sub£t
.
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

131 
³”
 = (
sk
->
sub£t
.
my¿nk
 =ğ
cŞl_¬gs
->
¬gs
.
roÙ
è? 
	`ucc_•_m­_ev®
Ñask->sub£t.
m­
, 1) :ask->subset.myrank;

132 
sk
->
bÿ¡_lš—r
.
key
 = 
	`compu‹_key
(
cŞl_¬gs
->
¬gs
.
roÙ
, 
³”
, cŞl_¬gs->¬gs.
g
);

133 
sk
->
£q_num
 = 
‹am
->
£q_num_aùive_£t
++;

135 
sk
->
£q_num
 = 
‹am
->seq_num++;

136 
sk
->
cŞl_id
 =ask->
£q_num
 % 
max_cÚcu¼’t
;

137 
sk
->
b¬
 = 
	`TASK_BAR
(task);

140 *
sk_h
 = 
sk
;

141  
UCC_OK
;

142 
	}
}

146 
šlše
 
ucc_¡©us_t
 
	$ucc__cuda_g‘_sync_roÙ
(
ucc__cuda_sk_t
 *
sk
, 
ucc_¿nk_t
 
roÙ
)

148 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

149 vŞ©
ucc__cuda_sync_¡©e_t
 *
¡©e
 = &
‹am
->
sync_¡©e
[
sk
->
cŞl_id
];

151 ià((
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
roÙ
è&& (*
¡©e
 == 0)) {

152 *
¡©e
 = 
sk
->
£q_num
;

154 ià((*
¡©e
 !ğ
sk
->
£q_num
) ||

155 (
sk
->
b¬
->
¡©e
[
	`UCC_TL_TEAM_RANK
(
‹am
)] !ğ
UCC_OK
)) {

156  
UCC_INPROGRESS
;

158  
UCC_OK
;

159 
	}
}

161 
šlše
 
	$ucc__cuda_put_sync_roÙ
(
ucc__cuda_sk_t
 *
sk
, 
ucc_¿nk_t
 
roÙ
)

163 
ucc__cuda_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

164 
ucc__cuda_sync_¡©e_t
 *
¡©e
 = &
‹am
->
sync_¡©e
[
sk
->
cŞl_id
];

166 ià(
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
roÙ
) {

167 
	`ucc_as£¹
(*
¡©e
 =ğ
sk
->
£q_num
);

168 *
¡©e
 = 0;

170 
	}
}

172 
šlše
 
ucc_¡©us_t
 
	$ucc__cuda_g‘_sync
(
ucc__cuda_sk_t
 *
sk
)

174  
	`ucc__cuda_g‘_sync_roÙ
(
sk
, 0);

175 
	}
}

177 
šlše
 
	$ucc__cuda_put_sync
(
ucc__cuda_sk_t
 *
sk
)

179 
	`ucc__cuda_put_sync_roÙ
(
sk
, 0);

180 
	}
}

182 
ucc_¡©us_t
 
ucc__cuda_mem_šfo_g‘
(*
±r
, 
size_t
 
Ëngth
,

183 
ucc__cuda_mem_šfo_t
 *
mi
);

185 
ucc_¡©us_t
 
ucc__cuda_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

186 
ucc_ba£_‹am_t
 *
‹am
,

187 
ucc_cŞl_sk_t
 **
sk_h
);

189 
ucc_¡©us_t
 
ucc__cuda_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

191 
ucc_¡©us_t
 
ucc__cuda_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

192 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

193 
ucc_memÜy_ty³_t
 
mem_ty³
,

194 
ucc_ba£_cŞl_š™_â_t
 *
š™
);

197 
šlše
 
	$g‘_¿nk_¡•
(
ucc__cuda_sk_t
 *
sk
, 
ucc_¿nk_t
 
¿nk
,

198 
¡•_id
)

200 
ucc__cuda_sync_t
 *
sync
 = 
	`TASK_SYNC
(
sk
, 
¿nk
);

202  
sync
->
£q_num
[
¡•_id
];

203 
	}
}

205 
šlše
 
	$£t_¿nk_¡•
(
ucc__cuda_sk_t
 *
sk
, 
ucc_¿nk_t
 
¿nk
,

206 
¡•
, 
¡•_id
)

208 
ucc__cuda_sync_t
 *
sync
 = 
	`TASK_SYNC
(
sk
, 
¿nk
);

210 
sync
->
£q_num
[
¡•_id
] = 
¡•
;

211 
	}
}

	@src/components/tl/cuda/tl_cuda_context.c

7 
	~"_cuda.h
"

8 
	~"uts/¬ch/ıu.h
"

9 
	~"uts/¬ch/cuda_def.h
"

10 
	~<_cuda_tİo.h
>

11 
	~<cuda_ruÁime.h
>

12 
	~<cuda.h
>

25 
	$UCC_CLASS_INIT_FUNC
(
ucc__cuda_cÚ‹xt_t
,

26 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

27 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

29 
ucc__cuda_cÚ‹xt_cÚfig_t
 *
_cuda_cÚfig
 =

30 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__cuda_cÚ‹xt_cÚfig_t
);

31 
ucc_¡©us_t
 
¡©us
;

32 
ucc__cuda_lib_t
 *
lib
;

33 
num_deviûs
;

34 
cudaE¼Ü_t
 
cuda_¡
;

35 
CUcÚ‹xt
 
cu_ùx
;

36 
CU»suÉ
 
cu_¡
;

38 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__cÚ‹xt_t
, &
_cuda_cÚfig
->
su³r
,

39 
·¿ms
->
cÚ‹xt
);

40 
lib
 = 
	`ucc_d”ived_of
(
£lf
->
su³r
.su³r.lib, 
ucc__cuda_lib_t
);

41 
	`memıy
(&
£lf
->
cfg
, 
_cuda_cÚfig
, (*tl_cuda_config));

43 
cuda_¡
 = 
	`cudaG‘DeviûCouÁ
(&
num_deviûs
);

44 ià(
cuda_¡
 !ğ
cudaSucûss
) {

45 
	`_debug
(
£lf
->
su³r
.su³r.
lib
,

46 "çedØg‘‚umb” oàGPU deviûs: %d (%s)", 
cuda_¡
,

47 
	`cudaG‘E¼ÜName
(
cuda_¡
));

48  
UCC_ERR_NO_RESOURCE
;

49 } ià(
num_deviûs
 == 0) {

50 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "no GPU devices found");

51  
UCC_ERR_NO_RESOURCE
;

54 
cu_¡
 = 
	`cuCtxG‘Cu¼’t
(&
cu_ùx
);

55 ià(
cu_ùx
 =ğ
NULL
 || 
cu_¡
 !ğ
CUDA_SUCCESS
) {

56 
	`_debug
(
£lf
->
su³r
.su³r.
lib
,

58  
UCC_ERR_NO_RESOURCE
;

61 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
£lf
->
»q_mp
, 0, (
ucc__cuda_sk_t
), 0,

62 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
,

63 &
ucc_cŞl_sk_mpoŞ_İs
, 
·¿ms
->
th»ad_mode
,

65 ià(
¡©us
 !ğ
UCC_OK
) {

66 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

68  
¡©us
;

71 
	`CUDA_CHECK_GOTO
(
	`cudaG‘Deviû
(&
£lf
->
deviû
), 
ä“_mpoŞ
, 
¡©us
);

74 ià(
lib
->
cfg
.
tİo_ÿche_’abË
 &&†ib->
tİo
 !ğ
NULL
) {

77 
£lf
->
tİo
 = 
lib
->topo;

82 
ucc__cuda_tİo_t
 **
tİo_±r
 =

83 
lib
->
cfg
.
tİo_ÿche_’abË
 ? &lib->
tİo
 : &
£lf
->topo;

86 
¡©us
 = 
	`ucc__cuda_tİo_ü—‹
((cÚ¡ 
ucc_ba£_lib_t
 *)&
lib
->
su³r
,

87 
tİo_±r
);

88 ià(
¡©us
 !ğ
UCC_OK
) {

89 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo initializeopology");

90 
ä“_mpoŞ
;

93 
£lf
->
tİo
 = *
tİo_±r
;

96 
¡©us
 = 
	`ucc__cuda_tİo_g‘_pci_id
(
£lf
->
deviû
, &£lf->
deviû_id
);

97 ià(
¡©us
 !ğ
UCC_OK
) {

98 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

99 "çedØg‘…c˜id fÜ deviû %d, stus: %s", 
£lf
->
deviû
,

100 
	`ucc_¡©us_¡ršg
(
¡©us
));

101 
ä“_mpoŞ
;

104 
£lf
->
c_ÿche
 = 
	`kh_š™
(
_cuda_•_hash
);

105 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "initializedl context: %p", self);

106  
UCC_OK
;

108 
ä“_mpoŞ
:

109 
	`ucc_mpoŞ_ş—nup
(&
£lf
->
»q_mp
, 1);

110  
¡©us
;

111 
	}
}

113 
ucc_¡©us_t
 
	$ucc__cuda_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

114 
ty³
, *
memh
, *
_h
)

116  
UCC_ERR_NOT_IMPLEMENTED
;

117 
	}
}

119 
ucc_¡©us_t
 
	$ucc__cuda_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

120 
ty³
, *
_h
)

122  
UCC_ERR_NOT_IMPLEMENTED
;

123 
	}
}

125 
ucc_¡©us_t
 
	$ucc__cuda_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

126 
ty³
, *
memh
, **
·ck_bufãr
)

128  
UCC_ERR_NOT_IMPLEMENTED
;

129 
	}
}

143 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__cuda_cÚ‹xt_t
)

145 
ucc__cuda_lib_t
 *
lib
 =

146 
	`ucc_d”ived_of
(
£lf
->
su³r
.su³r.
lib
, 
ucc__cuda_lib_t
);

149 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizingl context: %p", self);

152 ià(
£lf
->
c_ÿche
 !ğ
NULL
) {

153 
	`kh_de¡roy
(
_cuda_•_hash
, 
£lf
->
c_ÿche
);

154 
£lf
->
c_ÿche
 = 
NULL
;

159 ià(
£lf
->
tİo
 !ğ
NULL
 && !
lib
->
cfg
.
tİo_ÿche_’abË
) {

160 
	`ucc__cuda_tİo_de¡roy
(
£lf
->
tİo
);

161 
£lf
->
tİo
 = 
NULL
;

165 
	`ucc_mpoŞ_ş—nup
(&
£lf
->
»q_mp
, 1);

166 
	}
}

168 
UCC_CLASS_DEFINE
(
ucc__cuda_cÚ‹xt_t
, 
ucc__cÚ‹xt_t
);

170 
ucc_¡©us_t


171 
	$ucc__cuda_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

172 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

174 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

175 
©Œ
->
tİo_»quœed
 = 1;

176  
UCC_OK
;

177 
	}
}

	@src/components/tl/cuda/tl_cuda_ep_hash.h

7 #iâdeà
UCC_TL_CUDA_EP_HASH_H_


8 
	#UCC_TL_CUDA_EP_HASH_H_


	)

10 
	~"cÚfig.h
"

11 
	~"cÜe/ucc_cÚ‹xt.h
"

12 
	~"uts/khash.h
"

13 
	~<¡dšt.h
>

16 
šlše
 
ušt32_t
 
	$_cuda_ùx_id_hash_â_im¶
(
ušt32_t
 
h
, ušt32_ˆ
k
)

18 
ušt32_t
 
H
 = 
h
 & 0xf8000000;

19 
h
 = h << 5;

20 
h
 = h ^ ( 
H
 >> 27 );

21 
h
 = h ^ 
k
;

22  
h
;

23 
	}
}

26 
šlše
 
khšt32_t
 
	$_cuda_ùx_id_hash_â
(
ucc_cÚ‹xt_id_t
 
k
)

28 
ušt32_t
 
h
 = 0;

30 
	`ucc_as£¹
((
k
.
pi
.
ho¡_hash
) == 8);

31 
h
 = 
	`_cuda_ùx_id_hash_â_im¶
(h,

32 
	`kh_št64_hash_func
(
k
.
pi
.
ho¡_hash
));

33 
h
 = 
	`_cuda_ùx_id_hash_â_im¶
(h, 
k
.
pi
.
pid
);

34 
h
 = 
	`_cuda_ùx_id_hash_â_im¶
(h, 
k
.
£q_num
);

35  (
khšt32_t
)
h
;

36 
	}
}

38 
	#_cuda_ùx_id_equ®_â
(
_a
, 
_b
) \

39 (((
_a
).
pi
.
ho¡_hash
 =ğ(
_b
).pi.host_hash) && \

40 ((
_a
).
pi
.
pid
 =ğ(
_b
).pi.pidè&& ((_a).
£q_num
 =ğ(_b).£q_num))

	)

42 
KHASH_INIT
(
_cuda_•_hash
, 
ucc_cÚ‹xt_id_t
, *, 1, \

43 
_cuda_ùx_id_hash_â
, 
_cuda_ùx_id_equ®_â
);

45 
	#_cuda_•_hash_t
 
	`khash_t
(
_cuda_•_hash
)

	)

47 
šlše
 * 
	$_cuda_hash_g‘
(
_cuda_•_hash_t
 *
h
, 
ucc_cÚ‹xt_id_t
 
key
)

49 
kh™”_t
 
k
;

50 *
v®ue
;

51 
k
 = 
	`kh_g‘
(
_cuda_•_hash
, 
h
 , 
key
);

52 ià(
k
 =ğ
	`kh_’d
(
h
)) {

53  
NULL
;

55 
v®ue
 = 
	`kh_v®ue
(
h
, 
k
);

56  
v®ue
;

57 
	}
}

59 
šlše
 
	$_cuda_hash_put
(
_cuda_•_hash_t
 *
h
, 
ucc_cÚ‹xt_id_t
 
key
,

60 *
v®ue
)

62 
»t
;

63 
kh™”_t
 
k
;

64 
k
 = 
	`kh_put
(
_cuda_•_hash
, 
h
, 
key
, &
»t
);

65 
	`kh_v®ue
(
h
, 
k
èğ
v®ue
;

66 
	}
}

68 
šlše
 * 
	$_cuda_hash_pİ
(
_cuda_•_hash_t
 *
h
)

70 *
•
 = 
NULL
;

71 
kh™”_t
 
k
;

72 
k
 = 
	`kh_begš
(
h
);

73 
k
 !ğ
	`kh_’d
(
h
)) {

74 ià(
	`kh_exi¡
(
h
, 
k
)) {

75 
•
 = 
	`kh_v®ue
(
h
, 
k
);

78 
k
++;

80 ià(
•
) {

81 
	`kh_d–
(
_cuda_•_hash
, 
h
, 
k
);

83  
•
;

84 
	}
}

	@src/components/tl/cuda/tl_cuda_lib.c

7 
	~"_cuda.h
"

10 
	$UCC_CLASS_INIT_FUNC
(
ucc__cuda_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

11 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

13 cÚ¡ 
ucc__cuda_lib_cÚfig_t
 *
_cÚfig
 =

14 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__cuda_lib_cÚfig_t
);

15 
size_t
 
mš_sü©ch_size
;

17 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__lib_t
, &
ucc__cuda
.
su³r
,

18 &
_cÚfig
->
su³r
);

19 
	`memıy
(&
£lf
->
cfg
, 
_cÚfig
, (*tl_config));

20 ià(
£lf
->
cfg
.
®lg©h”_ršg_num_chunks
 < 1) {

21 
£lf
->
cfg
.
®lg©h”_ršg_num_chunks
 = 1;

23 ià(
£lf
->
cfg
.
®lg©h”_ršg_num_chunks
 > 
UCC_TL_CUDA_MAX_RING_CHUNKS
) {

24 
£lf
->
cfg
.
®lg©h”_ršg_num_chunks
 = 
UCC_TL_CUDA_MAX_RING_CHUNKS
;

30 
mš_sü©ch_size
 = 128 * 16 * 
	`ucc_dt_size
(
UCC_DT_FLOAT128_COMPLEX
) *

31 
£lf
->
cfg
.
®lg©h”_ršg_num_chunks
;

32 ià(
£lf
->
cfg
.
sü©ch_size
 < 
mš_sü©ch_size
) {

33 
£lf
->
cfg
.
sü©ch_size
 = 
mš_sü©ch_size
;

37 
£lf
->
tİo
 = 
NULL
;

39 
	`_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

40  
UCC_OK
;

41 
	}
}

43 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__cuda_lib_t
)

45 ià(
£lf
->
tİo
) {

46 
	`ucc__cuda_tİo_de¡roy
(
£lf
->
tİo
);

48 
	`_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

49 
	}
}

51 
UCC_CLASS_DEFINE
(
ucc__cuda_lib_t
, 
ucc__lib_t
);

53 
ucc_¡©us_t
 
	$ucc__cuda_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

54 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
)

56 
ucc__lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_tl_lib_attr_t);

58 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

59 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 
UCC_TL_CUDA_SUPPORTED_COLLS
;

60 
©Œ
->
su³r
.
æags
 = 0;

61 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
) {

62 
©Œ
->
su³r
.
mš_‹am_size
 = 
lib
->min_team_size;

64 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
) {

65 
©Œ
->
su³r
.
max_‹am_size
 = 
UCC_TL_CUDA_MAX_PEERS
;

67  
UCC_OK
;

68 
	}
}

70 
ucc_¡©us_t
 
	$ucc__cuda_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

72 
´İ
->
deçuÉ_‹am_size
 = 2;

73 
´İ
->
mš_‹am_size
 = 2;

74 
´İ
->
max_‹am_size
 = 
UCC_TL_CUDA_MAX_PEERS
;

75  
UCC_OK
;

76 
	}
}

	@src/components/tl/cuda/tl_cuda_nvls.c

7 
	~"_cuda_nvls.h
"

9 
	~"_cuda.h
"

10 
	~"_cuda_cŞl.h
"

11 
	~"uts/¬ch/cuda_def.h
"

13 
	~<sys/sysÿÎ.h
>

14 
	~<uni¡d.h
>

16 
ucc_¡©us_t
 
	$ucc__cuda_nvls_check_suµÜt
(
deviû
)

18 
suµÜ‹d
, 
çbric_suµÜ‹d
;

20 
	`cuDeviûG‘A‰ribu‹
(&
suµÜ‹d
, 
CU_DEVICE_ATTRIBUTE_MULTICAST_SUPPORTED
,

21 
deviû
);

22 
	`cuDeviûG‘A‰ribu‹
(&
çbric_suµÜ‹d
,

23 
CU_DEVICE_ATTRIBUTE_HANDLE_TYPE_FABRIC_SUPPORTED
,

24 
deviû
);

26 
	`ucc_debug
("MULTICAST_SUPPORTED: %d, HANDLE_TYPE_FABRIC_SUPPORTED: %d\n",

27 
suµÜ‹d
, 
çbric_suµÜ‹d
);

29 ià(!
suµÜ‹d
) {

30 
	`ucc_”rÜ
("muÉiÿ¡‚Ù suµÜ‹d oÀdeviû %d", 
deviû
);

31  
UCC_ERR_NOT_SUPPORTED
;

34  
UCC_OK
;

35 
	}
}

37 
ucc_¡©us_t


38 
	$ucc__cuda_nvls_g‘_g¿nuÏr™y
(
CUmuÉiÿ¡ObjeùPrİ
 *
mcPrİ
, 
size_t
 *
mšG¿n
,

39 
size_t
 *
g¿n
)

41 
ucc_¡©us_t
 
¡©us
;

43 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuMuÉiÿ¡G‘G¿nuÏr™y
(

44 
mšG¿n
, 
mcPrİ
, 
CU_MULTICAST_GRANULARITY_MINIMUM
));

45 ià(
¡©us
 !ğ
UCC_OK
) {

46 
	`ucc_”rÜ
("failedo get multicast granularity minimum");

47  
UCC_ERR_NOT_SUPPORTED
;

50 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuMuÉiÿ¡G‘G¿nuÏr™y
(

51 
g¿n
, 
mcPrİ
, 
CU_MULTICAST_GRANULARITY_RECOMMENDED
));

52 ià(
¡©us
 !ğ
UCC_OK
) {

53 
	`ucc_”rÜ
("failedo get multicast granularity„ecommended");

54  
UCC_ERR_NOT_SUPPORTED
;

57  
UCC_OK
;

58 
	}
}

60 
ucc_¡©us_t


61 
	$ucc__cuda_nvls_ü—‹_muÉiÿ¡_objeù
(
CUmuÉiÿ¡ObjeùPrİ
 *
mcPrİ
,

62 
CUmemG’”icAÎoÿtiÚHªdË
 *
mcHªdË
,

63 *
expÜt_hªdË
)

65 
ucc_¡©us_t
 
¡©us
;

67 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuMuÉiÿ¡C»©e
(
mcHªdË
, 
mcPrİ
));

68 ià(
¡©us
 !ğ
UCC_OK
) {

69 
	`ucc_”rÜ
("failedo create multicast object");

70  
UCC_ERR_NOT_SUPPORTED
;

73 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuMemExpÜtToSh¬—bËHªdË
(

74 
expÜt_hªdË
, *
mcHªdË
, 
CU_MEM_HANDLE_TYPE_POSIX_FILE_DESCRIPTOR
, 0));

75 ià(
¡©us
 !ğ
UCC_OK
) {

76 
	`ucc_”rÜ
("failedoƒxport shareable handle");

77 
	`CUDADRV_FUNC
(
	`cuMemR–—£
(*
mcHªdË
));

78  
¡©us
;

81  
UCC_OK
;

82 
	}
}

84 
ucc_¡©us_t


85 
	$ucc__cuda_nvls_sh¬e_hªdËs
(
ucc__cuda_‹am
 *
£lf
, 
expÜt_hªdË
,

86 
pid_t
 *
sh¬ed_pids
)

88 
ucc_¡©us_t
 
¡©us
;

89 
pid_t
 
cu¼’tPid
 = 
	`g‘pid
();

92 
¡©us
 = 
£lf
->
oob
.
	`®lg©h”
(&
cu¼’tPid
, 
sh¬ed_pids
, (currentPid),

93 
£lf
->
oob
.
cŞl_šfo
, &£lf->
oob_»q
);

94 ià(
UCC_OK
 !ğ
¡©us
) {

95  
¡©us
;

98 
UCC_OK
 !ğ(
¡©us
 = 
£lf
->
oob
.
	`»q_‹¡
(£lf->
oob_»q
))) {

99 ià(
¡©us
 < 0) {

100  
¡©us
;

103 
£lf
->
oob
.
	`»q_ä“
(£lf->
oob_»q
);

104 
£lf
->
oob_»q
 = 
NULL
;

107 ià(
	`UCC_TL_TEAM_RANK
(
£lf
) == 0) {

108 
£lf
->
sh¬ed_hªdËs
[0] = 
expÜt_hªdË
;

111 
¡©us
 = 
£lf
->
oob
.
	`®lg©h”
(&
expÜt_hªdË
, s–f->
sh¬ed_hªdËs
,

112 (
expÜt_hªdË
), 
£lf
->
oob
.
cŞl_šfo
,

113 &
£lf
->
oob_»q
);

114 ià(
UCC_OK
 !ğ
¡©us
) {

115  
¡©us
;

118 
UCC_OK
 !ğ(
¡©us
 = 
£lf
->
oob
.
	`»q_‹¡
(£lf->
oob_»q
))) {

119 ià(
¡©us
 < 0) {

120  
¡©us
;

123 
£lf
->
oob
.
	`»q_ä“
(£lf->
oob_»q
);

124 
£lf
->
oob_»q
 = 
NULL
;

126  
UCC_OK
;

127 
	}
}

129 
ucc_¡©us_t


130 
	$ucc__cuda_nvls_impÜt_hªdË
(
ucc__cuda_‹am
 *
£lf
, 
expÜt_hªdË
,

131 
pid_t
 
rg‘Pid
,

132 
CUmemG’”icAÎoÿtiÚHªdË
 *
mcHªdË
)

134 
pidFd
, 
³”Fd
;

135 
ucc_¡©us_t
 
¡©us
;

137 
pidFd
 = 
	`sysÿÎ
(
SYS_pidfd_İ’
, 
rg‘Pid
, 0);

138 ià(
pidFd
 < 0) {

139 
	`ucc_”rÜ
("çedØİ’…idfd fÜ…id %d", 
rg‘Pid
);

140  
UCC_ERR_NO_RESOURCE
;

143 
³”Fd
 = 
	`sysÿÎ
(
SYS_pidfd_g‘fd
, 
pidFd
, 
expÜt_hªdË
, 0);

144 ià(
³”Fd
 < 0) {

145 
	`ucc_”rÜ
("failedo get…eer fd");

146 
	`şo£
(
pidFd
);

147  
UCC_ERR_NO_RESOURCE
;

150 *
p
 = (*)((
ušt64_t
)
³”Fd
);

151 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuMemImpÜtFromSh¬—bËHªdË
(

152 
mcHªdË
, 
p
, 
CU_MEM_HANDLE_TYPE_POSIX_FILE_DESCRIPTOR
));

154 
	`şo£
(
³”Fd
);

155 
	`şo£
(
pidFd
);

157 ià(
¡©us
 !ğ
UCC_OK
) {

158 
	`ucc_”rÜ
("failedo import handle from„ank 0");

159  
¡©us
;

162  
UCC_OK
;

163 
	}
}

165 
ucc_¡©us_t
 
	$ucc__cuda_nvls_sync_b¬r›r
(
ucc__cuda_‹am
 *
£lf
)

167 
ucc_¡©us_t
 
¡©us
;

168 
ucc__cuda_shm_b¬r›r_t
 *
b¬
 = 
	`UCC_TL_CUDA_TEAM_BARRIER
(
£lf
, 0);

170 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
£lf
), 
b¬
);

171 ià(
¡©us
 !ğ
UCC_OK
) {

172 
	`ucc_”rÜ
("failedo start shm barrier");

173  
¡©us
;

176 (
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
£lf
),

177 
b¬
)è=ğ
UCC_INPROGRESS
) {

181 ià(
¡©us
 !ğ
UCC_OK
) {

182 
	`ucc_”rÜ
("failedoest shm barrier");

183  
¡©us
;

186  
UCC_OK
;

187 
	}
}

189 
ucc_¡©us_t
 
	$ucc__cuda_nvls_š™
(
ucc__cuda_‹am
 *
£lf
,

190 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
)

192 
ucc__cuda_nvls_t
 *
nvls
 = &
£lf
->nvls;

193 cÚ¡ 
size_t
 
symm‘ric_size
 = 1024ULL * 1024ULL * 512ULL;

194 
size_t
 
mšG¿n
 = 0, 
g¿n
 = 0, 
mcSize
;

195 
expÜt_hªdË
 = 0, 
deviû
;

196 
pid_t
 *
sh¬ed_pids
 = 
NULL
;

197 *
uc_va
 = 
NULL
, *
mc_va
 = NULL;

198 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

200 
CUmemG’”icAÎoÿtiÚHªdË
 
mcHªdË
 = 0;

201 
CUmemG’”icAÎoÿtiÚHªdË
 
memhªdË
 = 0;

202 
CUmemAÎoÿtiÚHªdËTy³
 
hªdËTy³
 = 
CU_MEM_HANDLE_TYPE_POSIX_FILE_DESCRIPTOR
;

203 
CUmuÉiÿ¡ObjeùPrİ
 
mcPrİ
 = {};

207 
mcPrİ
.
numDeviûs
 = 
	`UCC_TL_TEAM_SIZE
(
£lf
);

208 
mcPrİ
.
size
 = 
symm‘ric_size
;

209 
mcPrİ
.
hªdËTy³s
 = 
hªdËTy³
;

210 
mcPrİ
.
æags
 = 0;

212 
	`ucc_debug
(

214 
	`UCC_TL_TEAM_RANK
(
£lf
), 
mcPrİ
.
numDeviûs
, mcPrİ.
size
,

215 
mcPrİ
.
hªdËTy³s
, mcPrİ.
æags
);

218 
	`CUDA_CHECK
(
	`cudaG‘Deviû
(&
deviû
));

219 
	`ucc_debug
("RANK %d: deviû: %d\n", 
	`UCC_TL_TEAM_RANK
(
£lf
), 
deviû
);

221 
¡©us
 = 
	`ucc__cuda_nvls_check_suµÜt
(
deviû
);

222 ià(
¡©us
 !ğ
UCC_OK
) {

223  
¡©us
;

227 
¡©us
 = 
	`ucc__cuda_nvls_g‘_g¿nuÏr™y
(&
mcPrİ
, &
mšG¿n
, &
g¿n
);

228 ià(
¡©us
 !ğ
UCC_OK
) {

229  
¡©us
;

232 ià(
	`UCC_TL_TEAM_RANK
(
£lf
) == 0) {

233 
	`ucc_debug
("NVLS multicast granularity: gran = %lu, minGran = %lu\n",

234 
g¿n
, 
mšG¿n
);

238 
mcSize
 = ((
symm‘ric_size
 + 
g¿n
 - 1) / gran) * gran;

239 
mcPrİ
.
size
 = 
mcSize
;

242 
£lf
->
sh¬ed_hªdËs
 = 
	`ucc_m®loc
(

243 
	`UCC_TL_TEAM_SIZE
(
£lf
è* (
expÜt_hªdË
), "shared_handles");

244 ià(!
£lf
->
sh¬ed_hªdËs
) {

245 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

246 
ş—nup
;

250 
sh¬ed_pids
 =

251 
	`ucc_m®loc
(
	`UCC_TL_TEAM_SIZE
(
£lf
è* (
pid_t
), "shared_pids");

252 ià(!
sh¬ed_pids
) {

253 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

254 
ş—nup
;

258 ià(
	`UCC_TL_TEAM_RANK
(
£lf
) == 0) {

259 
¡©us
 = 
	`ucc__cuda_nvls_ü—‹_muÉiÿ¡_objeù
(&
mcPrİ
, &
mcHªdË
,

260 &
expÜt_hªdË
);

261 ià(
¡©us
 !ğ
UCC_OK
) {

262 
ş—nup
;

267 
¡©us
 = 
	`ucc__cuda_nvls_sh¬e_hªdËs
(
£lf
, 
expÜt_hªdË
, 
sh¬ed_pids
);

268 ià(
¡©us
 !ğ
UCC_OK
) {

269 
ş—nup
;

273 ià(
	`UCC_TL_TEAM_RANK
(
£lf
) != 0) {

274 
expÜt_hªdË
 = 
£lf
->
sh¬ed_hªdËs
[0];

275 
¡©us
 = 
	`ucc__cuda_nvls_impÜt_hªdË
(
£lf
, 
expÜt_hªdË
,

276 
sh¬ed_pids
[0], &
mcHªdË
);

277 ià(
¡©us
 !ğ
UCC_OK
) {

278 
ş—nup
;

283 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuMuÉiÿ¡AddDeviû
(
mcHªdË
, 
deviû
));

284 ià(
¡©us
 !ğ
UCC_OK
) {

285 
	`ucc_”rÜ
("failedo‡dd deviceo multicast");

286 
ş—nup
;

288 
	`ucc_debug
("¿nk %d:‡dded deviû %dØmuÉiÿ¡\n", 
	`UCC_TL_TEAM_RANK
(
£lf
),

289 
deviû
);

292 
¡©us
 = 
	`ucc__cuda_nvls_sync_b¬r›r
(
£lf
);

293 ià(
¡©us
 !ğ
UCC_OK
) {

294 
ş—nup
;

298 
CUmemAÎoÿtiÚPrİ
 
´İ
 = {};

299 
´İ
.
ty³
 = 
CU_MEM_ALLOCATION_TYPE_PINNED
;

300 
´İ
.
loÿtiÚ
.
ty³
 = 
CU_MEM_LOCATION_TYPE_DEVICE
;

301 
´İ
.
loÿtiÚ
.
id
 = 
deviû
;

302 
´İ
.
»que¡edHªdËTy³s
 = 
hªdËTy³
;

304 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuMemC»©e
(&
memhªdË
, 
mcSize
, &
´İ
, 0));

305 ià(
¡©us
 !ğ
UCC_OK
) {

306 
	`ucc_”rÜ
("failedo create memory‡llocation for multicast");

307 
ş—nup
;

311 
CUmemAcûssDesc
 
acûssDesc
 = {};

312 
acûssDesc
.
loÿtiÚ
.
ty³
 = 
CU_MEM_LOCATION_TYPE_DEVICE
;

313 
acûssDesc
.
loÿtiÚ
.
id
 = 
deviû
;

314 
acûssDesc
.
æags
 = 
CU_MEM_ACCESS_FLAGS_PROT_READWRITE
;

317 
¡©us
 = 
	`CUDADRV_FUNC
(

318 
	`cuMemAdd»ssRe£rve
((
CUdeviû±r
 *)&
uc_va
, 
mcSize
, 
mšG¿n
, 0U, 0));

319 ià(
¡©us
 !ğ
UCC_OK
) {

320 
	`ucc_”rÜ
("failedo„eserve virtual‡ddress space");

321 
ş—nup
;

324 
¡©us
 =

325 
	`CUDADRV_FUNC
(
	`cuMemM­
((
CUdeviû±r
)
uc_va
, 
mcSize
, 0, 
memhªdË
, 0));

326 ià(
¡©us
 !ğ
UCC_OK
) {

327 
	`ucc_”rÜ
("failedo map memory‡llocation");

328 
ş—nup
;

331 
¡©us
 = 
	`CUDADRV_FUNC
(

332 
	`cuMemS‘Acûss
((
CUdeviû±r
)
uc_va
, 
mcSize
, &
acûssDesc
, 1));

333 ià(
¡©us
 !ğ
UCC_OK
) {

334 
	`ucc_”rÜ
("failedo set memory‡ccess");

335 
ş—nup
;

339 
size_t
 
mcOff£t
 = 0;

340 
¡©us
 = 
	`CUDADRV_FUNC
(

341 
	`cuMuÉiÿ¡BšdAddr
(
mcHªdË
, 
mcOff£t
, (
CUdeviû±r
)
uc_va
, 
mcSize
, 0));

342 ià(
¡©us
 !ğ
UCC_OK
) {

343 
	`ucc_”rÜ
("failedo bind memoryo multicast");

344 
ş—nup
;

348 
¡©us
 = 
	`ucc__cuda_nvls_sync_b¬r›r
(
£lf
);

349 ià(
¡©us
 !ğ
UCC_OK
) {

350 
ş—nup
;

354 
¡©us
 = 
	`CUDADRV_FUNC
(

355 
	`cuMemAdd»ssRe£rve
((
CUdeviû±r
 *)&
mc_va
, 
mcSize
, 
mšG¿n
, 0U, 0));

356 ià(
¡©us
 !ğ
UCC_OK
) {

357 
	`ucc_”rÜ
("failedo„eserve multicast virtual‡ddress space");

358 
ş—nup
;

361 
¡©us
 = 
	`CUDADRV_FUNC
(
	`cuMemM­
((
CUdeviû±r
)
mc_va
, 
mcSize
, 0, 
mcHªdË
, 0));

362 ià(
¡©us
 !ğ
UCC_OK
) {

363 
	`ucc_”rÜ
("failedo map multicast memory");

364 
ş—nup
;

367 
¡©us
 = 
	`CUDADRV_FUNC
(

368 
	`cuMemS‘Acûss
((
CUdeviû±r
)
mc_va
, 
mcSize
, &
acûssDesc
, 1));

369 ià(
¡©us
 !ğ
UCC_OK
) {

370 
	`ucc_”rÜ
("failedo set multicast memory‡ccess");

371 
ş—nup
;

374 
	`ucc_debug
("Rank: %d symmetric memory is set: %p [%ld bytes]\n",

375 
	`UCC_TL_TEAM_RANK
(
£lf
), 
mc_va
, 
mcSize
);

378 
nvls
->
mc_hªdË
 = 
mcHªdË
;

379 
nvls
->
mc_va
 = (
CUdeviû±r
)mc_va;

380 
nvls
->
uc_va
 = (
CUdeviû±r
)uc_va;

381 
nvls
->
mc_memhªdË
 = 
memhªdË
;

382 
nvls
->
mc_size
 = 
mcSize
;

383 
nvls
->
mc_off£t
 = 
mcOff£t
;

385 
	`ucc_ä“
(
sh¬ed_pids
);

386  
UCC_OK
;

388 
ş—nup
:

390 ià(
sh¬ed_pids
) {

391 
	`ucc_ä“
(
sh¬ed_pids
);

394 ià(
	`UCC_TL_TEAM_RANK
(
£lf
) == 0) {

395 ià(
nvls
->
mc_va
) {

396 
	`CUDADRV_FUNC
(
	`cuMemUnm­
(
nvls
->
mc_va
,‚vls->
mc_size
));

397 
	`CUDADRV_FUNC
(
	`cuMemAdd»ssF»e
(
nvls
->
mc_va
,‚vls->
mc_size
));

399 ià(
nvls
->
mc_hªdË
) {

400 
	`CUDADRV_FUNC
(
	`cuMemR–—£
(
nvls
->
mc_hªdË
));

404 ià(
memhªdË
) {

405 
	`CUDADRV_FUNC
(
	`cuMemR–—£
(
memhªdË
));

408 ià(
uc_va
) {

409 
	`CUDADRV_FUNC
(
	`cuMemUnm­
((
CUdeviû±r
)
uc_va
, 
mcSize
));

410 
	`CUDADRV_FUNC
(
	`cuMemAdd»ssF»e
((
CUdeviû±r
)
uc_va
, 
mcSize
));

413 ià(
mc_va
) {

414 
	`CUDADRV_FUNC
(
	`cuMemUnm­
((
CUdeviû±r
)
mc_va
, 
mcSize
));

415 
	`CUDADRV_FUNC
(
	`cuMemAdd»ssF»e
((
CUdeviû±r
)
mc_va
, 
mcSize
));

418  
¡©us
;

419 
	}
}

421 
ucc_¡©us_t
 
	$ucc__cuda_nvls_de¡roy
(
ucc__cuda_‹am
 *
£lf
,

422 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
)

424 ià(
	`UCC_TL_TEAM_RANK
(
£lf
) == 0) {

426 
	`CUDADRV_FUNC
(
	`cuMuÉiÿ¡Unbšd
(
£lf
->
nvls
.
mc_hªdË
, 0 ,

427 
£lf
->
nvls
.
mc_off£t
,

428 
£lf
->
nvls
.
mc_size
));

430 
	`CUDADRV_FUNC
(
	`cuMemR–—£
(
£lf
->
nvls
.
mc_memhªdË
));

432 
	`CUDADRV_FUNC
(
	`cuMemUnm­
(
£lf
->
nvls
.
mc_va
, s–f->nvls.
mc_size
));

434 
	`CUDADRV_FUNC
(
	`cuMemAdd»ssF»e
(
£lf
->
nvls
.
mc_va
, s–f->nvls.
mc_size
));

436 
	`CUDADRV_FUNC
(
	`cuMemR–—£
(
£lf
->
nvls
.
mc_hªdË
));

438  
UCC_OK
;

439 
	}
}

	@src/components/tl/cuda/tl_cuda_nvls.h

7 #iâdeà
UCC_TL_CUDA_NVLS_H_


8 
	#UCC_TL_CUDA_NVLS_H_


	)

10 
	~<cuda_ruÁime.h
>

11 
	~<cuda.h
>

12 
	~<cudaTy³defs.h
>

13 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

16 
	gucc__cuda_‹am
;

18 
	succ__cuda_nvls
 {

19 
CUmemG’”icAÎoÿtiÚHªdË
 
	mmc_hªdË
;

20 
CUmemG’”icAÎoÿtiÚHªdË
 
	mmc_memhªdË
;

21 
CUdeviû±r
 
	mmc_va
;

22 
CUdeviû±r
 
	muc_va
;

23 
size_t
 
	mmc_size
;

24 
size_t
 
	mmc_off£t
;

25 } 
	tucc__cuda_nvls_t
;

28 
ucc_¡©us_t
 
ucc__cuda_nvls_š™
(
ucc__cuda_‹am
 *
£lf
, 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
);

30 
ucc_¡©us_t
 
ucc__cuda_nvls_de¡roy
(
ucc__cuda_‹am
 *
£lf
, 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
);

	@src/components/tl/cuda/tl_cuda_ring.h

7 #iâdeà
UCC_TL_CUDA_RING_H_


8 
	#UCC_TL_CUDA_RING_H_


	)

10 
	~"_cuda.h
"

11 
	~"_cuda_cŞl.h
"

14 
	mRING_STAGE_SYNC
,

15 
	mRING_STAGE_SETUP
,

16 
	mRING_STAGE_RING
,

17 
	mRING_STAGE_BARRIER
,

22 
	#RING_MIN_MSG_SIZE
 8192

	)

24 
šlše
 
size_t
 
	$g‘_sü©ch_size
(
ucc__cuda_‹am_t
 *
‹am
, 
Äšgs
,

25 
nchunks
, 
size_t
 
dt_size
)

27 
size_t
 
¿tio
 = 2 * 
Äšgs
 * 
nchunks
 * 
dt_size
;

29  
	`ucc_®ign_down_pow2
((
	`UCC_TL_CUDA_TEAM_LIB
(
‹am
)->
cfg
.
sü©ch_size
 /

30 
¿tio
), 64) *„atio;

31 
	}
}

33 
šlše
 
	$g‘_num_ršgs
(
ucc__cuda_‹am_t
 *
‹am
, 
size_t
 
msgsize
,

34 
ršgs_»que¡ed
)

36 
Äšgs
;

38 ià(
ršgs_»que¡ed
 !ğ
UCC_ULUNITS_AUTO
) {

39 
Äšgs
 = 
	`ucc_mš
(
ršgs_»que¡ed
, 
‹am
->
tİo
->
num_ršgs
);

41 
Äšgs
 = 
‹am
->
tİo
->
num_ršgs
;

44 
Äšgs
 = 
	`ucc_mš
Òršgs, 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
);

45 
Äšgs
 = 
	`ucc_mš
Òršgs, 
	`ucc_div_round_up
(
msgsize
, 
RING_MIN_MSG_SIZE
));

47  
Äšgs
;

48 
	}
}

50 
šlše
 
ucc_¿nk_t
 
	$g‘_£nd_to
(
ucc__cuda_‹am_t
 *
‹am
,

51 
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
,

52 
ršg_id
)

54 
ucc__cuda_ršg_t
 *
ršg
 = &
‹am
->
tİo
->
ršgs
[
ršg_id
];

56  
ršg
->ršg[Ôšg->
œšg
[
Œªk
] + 1è% 
tsize
];

57 
	}
}

59 
šlše
 
ucc_¿nk_t
 
	$g‘_»cv_äom
(
ucc__cuda_‹am_t
 *
‹am
,

60 
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
,

61 
ršg_id
)

63 
ucc__cuda_ršg_t
 *
ršg
 = &
‹am
->
tİo
->
ršgs
[
ršg_id
];

65  
ršg
->ršg[Ôšg->
œšg
[
Œªk
] - 1 + 
tsize
) %size];

66 
	}
}

68 
šlše
 
ucc_¿nk_t
 
	$g‘_£nd_block
(
ucc__cuda_‹am_t
 *
‹am
,

69 
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
,

70 
ušt32_t
 
¡•
, 
ršg_id
)

72 
ucc__cuda_ršg_t
 *
ršg
 = &
‹am
->
tİo
->
ršgs
[
ršg_id
];

74  
ršg
->ršg[Ôšg->
œšg
[
Œªk
] + 
tsize
 - 
¡•
) %size];

75 
	}
}

77 
šlše
 
ucc_¿nk_t
 
	$g‘_»cv_block
(
ucc__cuda_‹am_t
 *
‹am
,

78 
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
,

79 
ušt32_t
 
¡•
, 
ršg_id
)

81 
ucc__cuda_ršg_t
 *
ršg
 = &
‹am
->
tİo
->
ršgs
[
ršg_id
];

83  
ršg
->ršg[Ôšg->
œšg
[
Œªk
] + 
tsize
 - 
¡•
 - 1) %size];

84 
	}
}

	@src/components/tl/cuda/tl_cuda_team.c

7 
	~"_cuda.h
"

8 
	~"_cuda_cŞl.h
"

9 
	~"_cuda_tİo.h
"

10 
	~"_cuda_ÿche.h
"

11 #ifdeà
HAVE_TL_CUDA_NVLS


12 
	~"_cuda_nvls.h
"

14 
	~"cÜe/ucc_‹am.h
"

15 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

16 
	~"uts/¬ch/ıu.h
"

17 
	~"uts/¬ch/cuda_def.h
"

18 
	~"uts/ucc_sys.h
"

19 
	~<sys/shm.h
>

21 
	$UCC_CLASS_INIT_FUNC
(
ucc__cuda_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
,

22 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

24 
ucc__cuda_cÚ‹xt_t
 *
ùx
 =

25 
	`ucc_d”ived_of
(
_cÚ‹xt
, 
ucc__cuda_cÚ‹xt_t
);

26 
ucc__cuda_lib_t
 *
lib
 =

27 
	`ucc_d”ived_of
(
_cÚ‹xt
->
lib
, 
ucc__cuda_lib_t
);

29 
ušt32_t
 
»sourû_num
 = 
lib
->
cfg
.
max_cÚcu¼’t
 * 2;

30 
ucc__cuda_shm_b¬r›r_t
 *
b¬
;

31 
ucc_¡©us_t
 
¡©us
;

32 
shm_id
, 
i
, 
j
;

33 
size_t
 
ù¾_size
, 
®loc_size
, 
sü©ch_size
;

34 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

36 
£lf
->
oob
 = 
·¿ms
->params.oob;

37 
£lf
->
¡»am
 = 
NULL
;

38 
£lf
->
tİo
 = 
NULL
;

39 
£lf
->
sü©ch
.
loc
 = 
NULL
;

41 ià(!
	`ucc_‹am_m­_is_sšgË_node
(
·¿ms
->
‹am
,…¬ams->
m­
)) {

42 
	`_debug
(
_cÚ‹xt
->
lib
, "multinodeeam is‚ot supported");

43  
UCC_ERR_NOT_SUPPORTED
;

46 
£lf
->
ids
 = 
	`ucc_m®loc
((
	`UCC_TL_TEAM_SIZE
(self) + 1) * (*(self->ids)),

48 ià(!
£lf
->
ids
) {

49 
	`_”rÜ
(
_cÚ‹xt
->
lib
, "failedo‡lloc„anks id");

50  
UCC_ERR_NO_MEMORY
;

54 
sü©ch_size
 = 
»sourû_num
 * 
lib
->
cfg
.scratch_size;

55 
¡©us
 = 
	`CUDA_FUNC
(
	`cudaM®loc
(&
£lf
->
sü©ch
.
loc
, 
sü©ch_size
));

56 ià(
¡©us
 !ğ
UCC_OK
) {

57 
	`_”rÜ
(
_cÚ‹xt
->
lib
, "failedo‡lloc scratch buffer");

58 
ä“_ids
;

61 
¡©us
 = 
	`ucc__cuda_mem_šfo_g‘
(
£lf
->
sü©ch
.
loc
, 
sü©ch_size
,

62 &
£lf
->
ids
[
	`UCC_TL_TEAM_SIZE
(£lf)].
sü©ch_šfo
);

63 ià(
¡©us
 !ğ
UCC_OK
) {

64 
	`_”rÜ
(
_cÚ‹xt
->
lib
, "failedo get scratch memory info");

65 
ä“_sü©ch
;

68 
ù¾_size
 = ((
ucc__cuda_sync_t
è+ (
ucc__cuda_sync_d©a_t
) *

69 (
	`UCC_TL_TEAM_SIZE
(
£lf
) - 1)) * UCC_TL_TEAM_SIZE(self) *

70 
lib
->
cfg
.
max_cÚcu¼’t
 +

71 (
ucc__cuda_shm_b¬r›r_t
è* 
lib
->
cfg
.
max_cÚcu¼’t
 +

72 (
ucc__cuda_sync_¡©e_t
è* 
lib
->
cfg
.
max_cÚcu¼’t
;

73 
ù¾_size
 *= 2;

75 
shm_id
 = -1;

76 
£lf
->
sync
 = (*)-1;

77 ià(
	`UCC_TL_TEAM_RANK
(
£lf
) == 0) {

78 
®loc_size
 = 
ù¾_size
;

79 
¡©us
 = 
	`ucc_sysv_®loc
(&
®loc_size
, (**)&
£lf
->
sync
, &
shm_id
);

80 ià(
¡©us
 !ğ
UCC_OK
) {

81 
	`_”rÜ
(
_cÚ‹xt
->
lib
, "failedo‡lloc sysv segment");

83 
shm_id
 = -1;

84 
ids_exchªge
;

86 
	`mem£t
(
£lf
->
sync
, 0, 
ù¾_size
);

87 
£lf
->
b¬
 = (
ucc__cuda_shm_b¬r›r_t
 *)
	`UCC_TL_CUDA_TEAM_SYNC
(

88 
£lf
, 0, 
»sourû_num
);

90 
i
 = 0; i < 
»sourû_num
; i++) {

91 
b¬
 = 
	`UCC_TL_CUDA_TEAM_BARRIER
(
£lf
, 
i
);

92 
b¬
->
g
 = 
UCC_TL_CUDA_TAG_FREE
;

93 
j
 = 0; j < 
	`UCC_TL_TEAM_SIZE
(
£lf
); j++) {

94 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_š™
(
	`UCC_TL_TEAM_SIZE
(
£lf
),

95 
j
, 
b¬
);

96 ià(
¡©us
 !ğ
UCC_OK
) {

97 
	`_”rÜ
(
_cÚ‹xt
->
lib
,

99 
	`ucc_sysv_ä“
(
£lf
->
sync
);

100 
shm_id
 = -1;

101 
£lf
->
sync
 = (*)(-1);

103 
ids_exchªge
;

108 
ids_exchªge
:

109 
£lf
->
ids
[
	`UCC_TL_TEAM_SIZE
(£lf)].
pci_id
 = 
ùx
->
deviû_id
;

110 
£lf
->
ids
[
	`UCC_TL_TEAM_SIZE
(£lf)].
shm
 = 
shm_id
;

111 
¡©us
 = 
£lf
->
oob
.
	`®lg©h”
(&£lf->
ids
[
	`UCC_TL_TEAM_SIZE
(self)], self->ids,

112 (
ucc__cuda_¿nk_id_t
),

113 
£lf
->
oob
.
cŞl_šfo
, &£lf->
oob_»q
);

114 ià(
UCC_OK
 !ğ
¡©us
) {

115 
	`_”rÜ
(
_cÚ‹xt
->
lib
, "failedo start oob‡llgather");

116 
ä“_deviûs
;

118 
	`_debug
(
_cÚ‹xt
->
lib
, "po¡edÈ‹am: %p", 
£lf
);

120 
£lf
->
£q_num
 = 1;

121 
£lf
->
£q_num_aùive_£t
 = 1;

122  
UCC_OK
;

124 
ä“_deviûs
:

125 ià(
shm_id
 != -1) {

126 
	`ucc_sysv_ä“
(
£lf
->
sync
);

127 
£lf
->
sync
 = (*)(-1);

129 
ä“_sü©ch
:

130 
	`cudaF»e
(
£lf
->
sü©ch
.
loc
);

131 
ä“_ids
:

132 
	`ucc_ä“
(
£lf
->
ids
);

133  
¡©us
;

134 
	}
}

136 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__cuda_‹am_t
)

138 
ucc__cuda_lib_t
 *
lib
 = 
	`ucc_d”ived_of
(
£lf
->
su³r
.su³r.
cÚ‹xt
->lib,

139 
ucc__cuda_lib_t
);

141 
ušt32_t
 
»sourû_num
 = 
lib
->
cfg
.
max_cÚcu¼’t
 * 2;

142 
ucc__cuda_sync_t
 *
sync
;

143 
cudaE¼Ü_t
 
¡
;

144 
i
, 
j
;

146 
	`_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizingleam: %p", self);

147 ià(
£lf
->
tİo
) {

148 
	`ucc__cuda_‹am_tİo_de¡roy
(
£lf
->
tİo
);

151 #ifdeà
HAVE_TL_CUDA_NVLS


153 
	`ucc__cuda_nvls_de¡roy
(
£lf
, s–f->
su³r
.su³r.
cÚ‹xt
);

156 ià(
£lf
->
ids
) {

157 ià(
£lf
->
sync
 != (*)-1) {

158 
i
 = 0; i < 
»sourû_num
; i++) {

159 
j
 = 0; j < 
	`UCC_TL_TEAM_SIZE
(
£lf
); j++) {

160 ià(
j
 =ğ
	`UCC_TL_TEAM_RANK
(
£lf
)) {

163 
sync
 = 
	`UCC_TL_CUDA_TEAM_SYNC
(
£lf
, 
j
, 
i
);

164 ià(
sync
->
d©a
[
j
].
c_ev’t_»mÙe
) {

165 
¡
 = 
	`cudaEv’tDe¡roy
(
sync
->
d©a
[
j
].
c_ev’t_»mÙe
);

166 ià(
¡
 !ğ
cudaSucûss
) {

167 
	`_w¬n
(
	`UCC_TL_TEAM_LIB
(
£lf
), "cudaEventDestroy "

168 "çed: %d (%s)", 
¡
, 
	`cudaG‘E¼ÜName
(st));

172 
sync
 = 
	`UCC_TL_CUDA_TEAM_SYNC
(
£lf
, 
	`UCC_TL_TEAM_RANK
(£lf), 
i
);

173 ià(
sync
->
c_ev’t_loÿl
) {

174 
¡
 = 
	`cudaEv’tDe¡roy
(
sync
->
c_ev’t_loÿl
);

175 ià(
¡
 !ğ
cudaSucûss
) {

176 
	`_w¬n
(
	`UCC_TL_TEAM_LIB
(
£lf
), "cudaEventDestroy "

177 "çed: %d (%s)", 
¡
, 
	`cudaG‘E¼ÜName
(st));

181 
	`ucc_sysv_ä“
(
£lf
->
sync
);

183 
	`ucc_ä“
(
£lf
->
ids
);

185 ià(
£lf
->
¡»am
) {

186 
¡
 = 
	`cudaSŒ—mDe¡roy
(
£lf
->
¡»am
);

187 ià(
¡
 !ğ
cudaSucûss
) {

188 
	`_w¬n
(
	`UCC_TL_TEAM_LIB
(
£lf
), "cudaStreamDestroy failed: %d (%s)",

189 
¡
, 
	`cudaG‘E¼ÜName
(st));

192 
i
 = 0; i < 
	`UCC_TL_TEAM_SIZE
(
£lf
); i++) {

193 ià(
£lf
->
sü©ch
.
»m
[
i
]) {

194 
	`ucc__cuda_unm­_memhªdË
((
ušŒ_t
)
£lf
->
sü©ch
.
»m_šfo
[
i
].
±r
,

195 
£lf
->
sü©ch
.
»m
[
i
],

196 
	`ucc__cuda_g‘_ÿche
(
£lf
, 
i
), 1);

200 ià(
£lf
->
sü©ch
.
loc
) {

201 
	`cudaF»e
(
£lf
->
sü©ch
.
loc
);

203 
	}
}

205 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__cuda_‹am_t
, 
ucc_ba£_‹am_t
);

207 
UCC_CLASS_DEFINE
(
ucc__cuda_‹am_t
, 
ucc__‹am_t
);

209 
ucc_¡©us_t
 
	$ucc__cuda_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
)

211 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc__cuda_‹am_t
)(
_‹am
);

212  
UCC_OK
;

213 
	}
}

215 
ucc_¡©us_t
 
	$ucc__cuda_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
)

217 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

218 
ucc__cuda_lib_t
 *
lib
 = 
	`ucc_d”ived_of
(
_‹am
->
cÚ‹xt
->lib,

219 
ucc__cuda_lib_t
);

221 
ušt32_t
 
»sourû_num
 = 
lib
->
cfg
.
max_cÚcu¼’t
 * 2;

222 
ucc_¡©us_t
 
¡©us
;

223 
ucc__cuda_sync_t
 *
sync
;

224 
ucc__cuda_shm_b¬r›r_t
 *
b¬
;

225 vŞ©
ucc__cuda_sync_t
 *
³”_sync
;

226 
i
, 
j
, 
shm_id
;

228 ià(
‹am
->
oob_»q
 =ğ
NULL
) {

229  
UCC_OK
;

230 } ià(
‹am
->
oob_»q
 == (*)0x1) {

231 
b¬r›r
;

233 
¡©us
 = 
‹am
->
oob
.
	`»q_‹¡
Ñ—m->
oob_»q
);

234 ià(
¡©us
 =ğ
UCC_INPROGRESS
) {

235  
UCC_INPROGRESS
;

236 } ià(
¡©us
 < 0) {

237 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
, "oob‡llgather failed");

238 
ex™_”r
;

240 
‹am
->
oob
.
	`»q_ä“
Ñ—m->
oob_»q
);

241 
‹am
->
oob_»q
 = (*)0x1;

243 
i
 = 0; i < 
	`UCC_TL_TEAM_SIZE
(
‹am
); i++) {

244 
‹am
->
sü©ch
.
»m
[
i
] = 
NULL
;

247 
¡©us
 = 
	`ucc__cuda_‹am_tİo_ü—‹
(&
‹am
->
su³r
, &‹am->
tİo
);

248 ià(
¡©us
 !ğ
UCC_OK
) {

249 
ex™_”r
;

252 
i
 = 0; i < 
	`UCC_TL_TEAM_SIZE
(
‹am
); i++) {

253 ià(
i
 =ğ
	`UCC_TL_TEAM_RANK
(
‹am
) ||

254 !
	`ucc__cuda_‹am_tİo_is_dœeù
(&
‹am
->
su³r
,—m->
tİo
, 
i
,

255 
	`UCC_TL_TEAM_RANK
(
‹am
))) {

256 
‹am
->
sü©ch
.
»m
[
i
] = 
NULL
;

259 
¡©us
 = 
	`ucc__cuda_m­_memhªdË
(
‹am
->
ids
[
i
].
sü©ch_šfo
.
±r
,

260 
‹am
->
ids
[
i
].
sü©ch_šfo
.
Ëngth
,

261 
‹am
->
ids
[
i
].
sü©ch_šfo
.
hªdË
,

262 &
‹am
->
sü©ch
.
»m
[
i
],

263 
	`ucc__cuda_g‘_ÿche
(
‹am
, 
i
));

264 
	`memıy
(&
‹am
->
sü©ch
.
»m_šfo
[
i
], &‹am->
ids
[i].
sü©ch_šfo
,

265 (
ucc__cuda_mem_šfo_t
));

266 ià(
¡©us
 !ğ
UCC_OK
) {

267 
ex™_”r
;

271 ià(
	`UCC_TL_TEAM_LIB
(
‹am
)->
log_compÚ’t
.
log_Ëv–
 >ğ
UCC_LOG_LEVEL_DEBUG
) {

272 
	`ucc__cuda_‹am_tİo_´št_´ox›s
(&
‹am
->
su³r
,—m->
tİo
);

273 
	`ucc__cuda_‹am_tİo_´št_ršgs
(&
‹am
->
su³r
,—m->
tİo
);

276 
shm_id
 = 
‹am
->
ids
[0].
shm
;

277 ià(
shm_id
 < 0) {

278 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
, "failedo create shmem„egion");

279 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

280 
ex™_”r
;

282 ià(
	`UCC_TL_TEAM_RANK
(
‹am
) != 0) {

283 
‹am
->
sync
 = 
	`shm©
(
shm_id
, 
NULL
, 0);

284 ià(
‹am
->
sync
 == (*)-1) {

285 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
, "failedo shmatƒrrno: %d (%s)",

286 
”ºo
, 
	`¡»¼Ü
(errno));

287 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

288 
ex™_”r
;

290 
‹am
->
b¬
 = (
ucc__cuda_shm_b¬r›r_t
*)
	`UCC_TL_CUDA_TEAM_SYNC
(team, 0,

291 
»sourû_num
);

293 
‹am
->
sync_¡©e
 = (
ucc__cuda_sync_¡©e_t
*)
	`PTR_OFFSET
Ñ—m->
b¬
,

294 (
ucc__cuda_shm_b¬r›r_t
) *

295 
»sourû_num
);

296 
	`CUDA_CHECK_GOTO
(
	`cudaSŒ—mC»©eW™hFÏgs
(&
‹am
->
¡»am
,

297 
cudaSŒ—mNÚBlockšg
), 
ex™_”r
, 
¡©us
);

298 
i
 = 0; i < 
»sourû_num
; i++) {

299 
sync
 = 
	`UCC_TL_CUDA_TEAM_SYNC
(
‹am
, 
	`UCC_TL_TEAM_RANK
Ñ—m), 
i
);

300 
	`CUDA_CHECK_GOTO
(
	`cudaEv’tC»©eW™hFÏgs
(&
sync
->
c_ev’t_loÿl
,

301 
cudaEv’tDi§bËTimšg
 |

302 
cudaEv’tIÁ”´oûss
),

303 
ex™_”r
, 
¡©us
);

304 
	`CUDA_CHECK_GOTO
(
	`cudaIpcG‘Ev’tHªdË
(&
sync
->
ev_hªdË
,

305 
sync
->
c_ev’t_loÿl
),

306 
ex™_”r
, 
¡©us
);

309 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

310 
b¬
 = 
	`UCC_TL_CUDA_TEAM_BARRIER
(
‹am
, 0);

311 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_¡¬t
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
b¬
);

312 ià(
¡©us
 !ğ
UCC_OK
) {

313 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
, "failedo start shm barrier");

314 
ex™_”r
;

317 
b¬r›r
:

318 
b¬
 = 
	`UCC_TL_CUDA_TEAM_BARRIER
(
‹am
, 0);

319 
¡©us
 = 
	`ucc__cuda_shm_b¬r›r_‹¡
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
b¬
);

320 ià(
¡©us
 =ğ
UCC_INPROGRESS
) {

321  
¡©us
;

322 } ià(
¡©us
 !ğ
UCC_OK
) {

323 
ex™_”r
;

326 
i
 = 0; i < 
»sourû_num
; i++) {

327 
sync
 = 
	`UCC_TL_CUDA_TEAM_SYNC
(
‹am
, 
	`UCC_TL_TEAM_RANK
Ñ—m), 
i
);

328 
j
 = 0 ; j < 
	`UCC_TL_TEAM_SIZE
(
‹am
); j++) {

329 ià(
j
 =ğ
	`UCC_TL_TEAM_RANK
(
‹am
)) {

332 
³”_sync
 = 
	`UCC_TL_CUDA_TEAM_SYNC
(
‹am
, 
j
, 
i
);

333 
	`CUDA_CHECK_GOTO
(
	`cudaIpcO³nEv’tHªdË
(&
sync
->
d©a
[
j
].
c_ev’t_»mÙe
,

334 
³”_sync
->
ev_hªdË
),

335 
ex™_”r
, 
¡©us
);

338 
‹am
->
oob_»q
 = 
NULL
;

339 
	`_debug
(
_‹am
->
cÚ‹xt
->
lib
, "š™ŸlizedÈ‹am: %p", 
‹am
);

341 #ifdeà
HAVE_TL_CUDA_NVLS


342 
¡©us
 = 
	`ucc__cuda_nvls_š™
(
‹am
, 
_‹am
->
cÚ‹xt
);

343 ià(
¡©us
 !ğ
UCC_OK
) {

344 
	`ucc_”rÜ
("failedo init‚vls multicast");

345 
ex™_”r
;

349  
UCC_OK
;

351 
ex™_”r
:

352  
¡©us
;

353 
	}
}

355 
ucc_¡©us_t
 
	$ucc__cuda_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

356 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

358 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

359 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_TEAM_CTX
(
‹am
);

360 
ucc_memÜy_ty³_t
 
mt
 = 
UCC_MEMORY_TYPE_CUDA
;

361 
ucc_cŞl_scÜe_t
 *
scÜe
;

362 
ucc_¡©us_t
 
¡©us
;

363 
i
;

364 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

366 
‹am_šfo
.
®g_â
 = 
ucc__cuda_®g_id_to_š™
;

367 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_TL_CUDA_DEFAULT_SCORE
;

368 
‹am_šfo
.
š™
 = 
ucc__cuda_cŞl_š™
;

369 
‹am_šfo
.
num_mem_ty³s
 = 1;

370 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = &
mt
;

371 
‹am_šfo
.
suµÜ‹d_cŞls
 = 
UCC_TL_CUDA_SUPPORTED_COLLS
;

372 
‹am_šfo
.
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

374 
¡©us
 =

375 
	`ucc_cŞl_scÜe_bud_deçuÉ
(
_‹am
, 
UCC_TL_CUDA_DEFAULT_SCORE
,

376 
ucc__cuda_cŞl_š™
,

377 
UCC_TL_CUDA_SUPPORTED_COLLS
,

378 &
mt
, 1, &
scÜe
);

379 ià(
UCC_OK
 !ğ
¡©us
) {

380  
¡©us
;

383 
i
 = 0; i < 
UCC_TL_CUDA_N_DEFAULT_ALG_SELECT_STR
; i++) {

384 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(

385 
ucc__cuda_deçuÉ_®g_£Ëù_¡r
[
i
], &
‹am_šfo
,

386 &
‹am
->
su³r
.su³r, 
scÜe
);

387 ià(
UCC_OK
 !ğ
¡©us
) {

388 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
,

390 
ucc__cuda_deçuÉ_®g_£Ëù_¡r
[
i
]);

391 
”r
;

395 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

396 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

397 &
‹am
->
su³r
.su³r, 
scÜe
);

398 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

399 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

400 
”r
;

404 *
scÜe_p
 = 
scÜe
;

405  
UCC_OK
;

406 
”r
:

407 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

408  
¡©us
;

409 
	}
}

	@src/components/tl/cuda/tl_cuda_team_topo.c

7 
	~"_cuda_‹am_tİo.h
"

8 
	~"_cuda.h
"

10 
	#UCC_TL_CUDA_TEAM_TOPO_SAME_DEVICE
 ((
ucc_¿nk_t
)(
UCC_RANK_MAX
))

	)

12 
ucc_¡©us_t


13 
	$ucc__cuda_‹am_tİo_add_ršg
(cÚ¡ 
ucc__cuda_‹am_t
 *
‹am
,

14 
ucc__cuda_‹am_tİo_t
 *
tİo
,

15 
ucc__cuda_ršg_t
 *
ršg
,

16 
šv”t
, 
num_dups
)

18 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

19 
ucc__cuda_ršg_t
 *
Ãw_ršg
;

20 
ucc_¡©us_t
 
¡©us
;

21 
i
, 
j
;

23 
	`ucc_as£¹
(
size
 > 1);

24 
i
 = 0; i < 
num_dups
; i++) {

25 
tİo
->
ršgs
[tİo->
num_ršgs
 + 
i
].
ršg
 = 
NULL
;

26 
tİo
->
ršgs
[tİo->
num_ršgs
 + 
i
].
œšg
 = 
NULL
;

29 
i
 = 0; i < 
num_dups
; i++) {

30 
Ãw_ršg
 = &
tİo
->
ršgs
[tİo->
num_ršgs
 + 
i
];

31 
Ãw_ršg
->
ršg
 = (
ucc_¿nk_t
*)
	`ucc_m®loc
(2 * 
size
 * (ucc_rank_t),

33 
Ãw_ršg
->
œšg
 = 
	`PTR_OFFSET
Òew_ršg->
ršg
, 
size
 * (
ucc_¿nk_t
));

34 ià(!
Ãw_ršg
->
ršg
) {

35 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo‡llocateopo„ing");

36 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

37 
ä“_ršgs
;

39 
j
 = 0; j < 
size
; j++) {

40 ià(
šv”t
) {

41 
Ãw_ršg
->
ršg
[
j
] =„šg->ršg[
size
 - j - 1];

43 
Ãw_ršg
->
ršg
[
j
] =„ing->ring[j];

46 
j
 = 0; j < 
size
; j++) {

47 
Ãw_ršg
->
œšg
[Ãw_ršg->
ršg
[
j
]] = j;

50 
tİo
->
num_ršgs
 +ğ
num_dups
;

52  
UCC_OK
;

53 
ä“_ršgs
:

54 
i
 = 0; i < 
num_dups
; i++) {

55 
	`ucc_ä“
(
tİo
->
ršgs
[tİo->
num_ršgs
 + 
i
].
ršg
);

57  
¡©us
;

58 
	}
}

60 
ucc_¡©us_t


61 
	$ucc__cuda_‹am_tİo_bud_ršg
(cÚ¡ 
ucc__cuda_‹am_t
 *
‹am
,

62 cÚ¡ 
ucc_¿nk_t
 *
g¿ph
,

63 
ucc__cuda_ršg_t
 *
ršg
,

64 
ucc_¿nk_t
 
pos
,

65 
width
)

67 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

68 
ucc_¿nk_t
 
i
, 
j
;

69 
š_ršg
;

70 
lšks
;

71 
ucc_¡©us_t
 
¡©us
;

73 ià(
pos
 =ğ
size
) {

74 
lšks
 = 
g¿ph
[
ršg
->ršg[
pos
 - 1] * 
size
 +„ing->ring[0]];

75 ià((
lšks
 =ğ
UCC_TL_CUDA_TEAM_TOPO_SAME_DEVICE
è|| (lšk >ğ
width
)) {

76  
UCC_OK
;

78  
UCC_ERR_NOT_SUPPORTED
;

82 
i
 = 0; i < 
size
; i++) {

83 
lšks
 = 
g¿ph
[
ršg
->ršg[
pos
 - 1] * 
size
 + 
i
];

84 ià((
lšks
 < 
width
è&& (lšk !ğ
UCC_TL_CUDA_TEAM_TOPO_SAME_DEVICE
)) {

87 
š_ršg
 = 0;

88 
j
 = 0; j < 
pos
; j++) {

89 ià(
ršg
->ršg[
j
] =ğ
i
) {

90 
š_ršg
 = 1;

94 ià(
š_ršg
) {

97 
ršg
->ršg[
pos
] = 
i
;

98 
¡©us
 = 
	`ucc__cuda_‹am_tİo_bud_ršg
(
‹am
, 
g¿ph
, 
ršg
, 
pos
 + 1,

99 
width
);

100 ià(
¡©us
 =ğ
UCC_OK
) {

101  
UCC_OK
;

104  
UCC_ERR_NOT_SUPPORTED
;

105 
	}
}

117 
ucc_¡©us_t


118 
	$ucc__cuda_‹am_tİo_š™_ršgs
(cÚ¡ 
ucc__cuda_‹am_t
 *
‹am
,

119 
ucc__cuda_‹am_tİo_t
 *
tİo
)

121 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

122 
ucc__cuda_ršg_t
 
ršg
;

123 
i
, 
width
, 
Ä
, 
num_ršgs
, 
mš_width
;

124 
ucc_¡©us_t
 
¡©us
;

125 
ucc_¿nk_t
 *
g¿ph
;

127 
	`ucc_as£¹
(
size
 > 1);

128 
tİo
->
num_ršgs
 = 0;

129 
ršg
.ršg = (
ucc_¿nk_t
*è
	`ucc_m®loc
(
size
 * (ucc_rank_t),

131 ià(!
ršg
.ring) {

132 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo‡llocateopo„ing");

133  
UCC_ERR_NO_MEMORY
;

136 
g¿ph
 = (
ucc_¿nk_t
*è
	`ucc_m®loc
(
size
 * size * (ucc_rank_t),

138 ià(!
g¿ph
) {

139 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

140 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo‡llocateopo graph");

141 
ä“_ršg
;

144 
	`memıy
(
g¿ph
, 
tİo
->
m©rix
, 
size
 * siz* (
ucc_¿nk_t
));

146 
num_ršgs
 = 0;

147 
mš_width
 = 4;

148 
width
 = 
mš_width
; width > 0; width >>= 1) {

149 
ršg
.ring[0] = 0;

150 
¡©us
 = 
	`ucc__cuda_‹am_tİo_bud_ršg
(
‹am
, 
g¿ph
, &
ršg
, 1,

151 
width
);

152 ià(
¡©us
 =ğ
UCC_OK
) {

153 
num_ršgs
 +ğ2*
width
;

154 ià(
width
 < 
mš_width
) {

155 
mš_width
 = 
width
;

157 
i
 = 0; i < 
size
; i++) {

158 ià(
g¿ph
[
ršg
.ršg[
i
] * 
size
 +„ing.ring[(i+1)%size]] !=

159 
UCC_TL_CUDA_TEAM_TOPO_SAME_DEVICE
) {

160 
g¿ph
[
ršg
.ršg[
i
] * 
size
 +„šg.ršg[(i+1)%size]] -ğ
width
;

161 
g¿ph
[
ršg
.ršg[(
i
+1)%
size
] * siz+„šg.ršg[i]] -ğ
width
;

167 ià(
num_ršgs
 == 0) {

168 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

169 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "no„ings found");

170 
ä“_g¿ph
;

173 
tİo
->
ršgs
 = (
ucc__cuda_ršg_t
*)
	`ucc_m®loc
(
num_ršgs
 * (*topo->rings),

175 ià(!
tİo
->
ršgs
) {

176 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

177 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo‡llocateopo„ings‡rray");

178 
ä“_g¿ph
;

181 
i
 = 0; i < 
size
 * size; i++) {

182 
g¿ph
[
i
] = 
tİo
->
m©rix
[i];

184 
width
 = 4; width > 0; width >>= 1) {

185 
ršg
.ring[0] = 0;

186 
¡©us
 = 
	`ucc__cuda_‹am_tİo_bud_ršg
(
‹am
, 
g¿ph
, &
ršg
, 1,

187 
width
);

188 ià(
¡©us
 =ğ
UCC_OK
) {

189 
Ä
 = 
width
 / 
mš_width
;

190 
¡©us
 = 
	`ucc__cuda_‹am_tİo_add_ršg
(
‹am
, 
tİo
, &
ršg
, 0, 
Ä
);

191 ià(
¡©us
 !ğ
UCC_OK
) {

192 
ä“_ršgs
;

195 ià(
size
 > 2) {

196 
¡©us
 = 
	`ucc__cuda_‹am_tİo_add_ršg
(
‹am
, 
tİo
, &
ršg
, 1, 
Ä
);

197 ià(
¡©us
 !ğ
UCC_OK
) {

198 
ä“_ršgs
;

202 
i
 = 0; i < 
size
; i++) {

203 ià(
g¿ph
[
ršg
.ršg[
i
] * 
size
 +„ing.ring[(i+1)%size]] !=

204 
UCC_TL_CUDA_TEAM_TOPO_SAME_DEVICE
) {

205 
g¿ph
[
ršg
.ršg[
i
] * 
size
 +„šg.ršg[(i+1)%size]] -ğ
width
;

206 
g¿ph
[
ršg
.ršg[(
i
+1)%
size
] * siz+„šg.ršg[i]] -ğ
width
;

212 
	`ucc_ä“
(
g¿ph
);

213 
	`ucc_ä“
(
ršg
.ring);

214  
UCC_OK
;

216 
ä“_ršgs
:

217 
i
 = 0; i < 
tİo
->
num_ršgs
; i++) {

218 
	`ucc_ä“
(
tİo
->
ršgs
[
i
].
ršg
);

220 
	`ucc_ä“
(
tİo
->
ršgs
);

221 
ä“_g¿ph
:

222 
	`ucc_ä“
(
g¿ph
);

223 
ä“_ršg
:

224 
	`ucc_ä“
(
ršg
.ring);

225  
¡©us
;

226 
	}
}

228 
ucc_¡©us_t


229 
	$ucc__cuda_‹am_tİo_š™_´ox›s
(cÚ¡ 
ucc__cuda_‹am_t
 *
‹am
,

230 
ucc__cuda_‹am_tİo_t
 *
tİo
)

232 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

233 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

234 
ucc_¿nk_t
 
num_´ox›s
 = 0;

235 
ucc_¿nk_t
 
i
, 
j
, 
k
, 
´oxy
;

236 *
d©a
;

237 
scÜe
, 
mš_scÜe
;

238 
ucc_¡©us_t
 
¡©us
;

239 
pci_¡r
[2][
MAX_PCI_BUS_ID_STR
];

241 
tİo
->
´oxy_Ãeded
 = 0;

243 
i
 = 0; i < 
size
 * size; i++) {

244 ià(
tİo
->
m©rix
[
i
] == 0) {

245 
num_´ox›s
++;

249 
tİo
->
num_´ox›s
 =‚um_proxies;

250 
tİo
->
is_fuÎy_cÚÃùed
 = (
num_´ox›s
 == 0) ? 1 : 0;

251 ià(
num_´ox›s
 == 0) {

252  
UCC_OK
;

255 
tİo
->
´ox›s
 = (
ucc__cuda_´oxy_t
*)
	`ucc_m®loc
(

256 
num_´ox›s
 * (
ucc__cuda_´oxy_t
), "cuda_topo_proxies");

257 ià(!
tİo
->
´ox›s
) {

258 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo‡lloc cudaopo…roxies");

259  
UCC_ERR_NO_MEMORY
;

262 
d©a
 = (*)
	`ucc_m®loc
(
size
 * size * (),

264 ià(!
d©a
) {

265 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo‡lloc cudaopo work‡rray");

266 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

267 
ä“_´oxy
;

270 
i
 = 0; i < 
size
; i++) {

271 
j
 = 0; j < 
size
; j++) {

272 ià(
	`ucc__cuda_‹am_tİo_is_dœeù
(&
‹am
->
su³r
, 
tİo
, 
i
, 
j
)) {

273 
d©a
[
i
 * 
size
 + 
j
] = 1.0;

275 
d©a
[
i
 * 
size
 + 
j
] = 0.0;

280 
num_´ox›s
 = 0;

281 
i
 = 0; i < 
size
; i++) {

282 
j
 = 0; j < 
size
; j++) {

283 ià(
	`ucc__cuda_‹am_tİo_is_dœeù
(&
‹am
->
su³r
, 
tİo
, 
i
, 
j
)) {

286 ià((
i
 =ğ
¿nk
è|| (
j
 ==„ank)) {

287 
tİo
->
´oxy_Ãeded
 = 1;

289 
´oxy
 = 
UCC_RANK_INVALID
;

290 
mš_scÜe
 = ()(
UCC_RANK_MAX
);

291 
k
 = 0; k < 
size
; k++) {

292 ià(
	`ucc__cuda_‹am_tİo_is_dœeù
(&
‹am
->
su³r
, 
tİo
, 
i
, 
k
) &&

293 
	`ucc__cuda_‹am_tİo_is_dœeù
(&
‹am
->
su³r
, 
tİo
, 
k
, 
j
)) {

294 
	`ucc_as£¹
((
tİo
->
m©rix
[
i
 * 
size
 + 
k
] > 0) &&

295 (
tİo
->
m©rix
[
k
 * 
size
 + 
j
] > 0));

296 
scÜe
 = 
	`ucc_max
((
d©a
[
i
 * 
size
 + 
k
] + 1.0) /

297 
tİo
->
m©rix
[
i
 * 
size
 + 
k
],

298 (
d©a
[
k
 * 
size
 + 
j
] + 1.0) /

299 
tİo
->
m©rix
[
k
 * 
size
 + 
j
]);

300 ià(
scÜe
 >ğ
mš_scÜe
) {

303 
´oxy
 = 
k
;

304 
mš_scÜe
 = 
scÜe
;

307 ià(
´oxy
 =ğ
UCC_RANK_INVALID
) {

308 
	`ucc__cuda_tİo_pci_id_to_¡r
(&
‹am
->
ids
[
i
].
pci_id
,

309 
pci_¡r
[0], 
MAX_PCI_BUS_ID_STR
);

310 
	`ucc__cuda_tİo_pci_id_to_¡r
(&
‹am
->
ids
[
j
].
pci_id
,

311 
pci_¡r
[1], 
MAX_PCI_BUS_ID_STR
);

312 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "no…roxy found between "

315 
pci_¡r
[0], 
i
,…ci_¡r[
j
], j);

316 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

317 
ä“_d©a
;

319 ià(
´oxy
 =ğ
¿nk
) {

320 
tİo
->
´ox›s
[
num_´ox›s
].
¤c
 = 
i
;

321 
tİo
->
´ox›s
[
num_´ox›s
].
d¡
 = 
j
;

322 
tİo
->
´ox›s
[
num_´ox›s
].
´oxy
 =…roxy;

323 
num_´ox›s
++;

325 
d©a
[
i
 * 
size
 + 
´oxy
] += 1.0;

326 
d©a
[
´oxy
 * 
size
 + 
j
] += 1.0;

329 
tİo
->
num_´ox›s
 =‚um_proxies;

331 
	`ucc_ä“
(
d©a
);

332  
UCC_OK
;

333 
ä“_d©a
:

334 
	`ucc_ä“
(
d©a
);

335 
ä“_´oxy
:

336 
	`ucc_ä“
(
tİo
->
´ox›s
);

337  
¡©us
;

338 
	}
}

340 
ucc_¡©us_t


341 
	$ucc__cuda_‹am_tİo_š™_m©rix
(cÚ¡ 
ucc__cuda_‹am_t
 *
‹am
,

342 
ucc_¿nk_t
 *
m©rix
)

344 
ucc__cuda_tİo_t
 *
tİo
 = 
	`UCC_TL_CUDA_TEAM_CTX
(
‹am
)->topo;

345 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

346 
ucc_¡©us_t
 
¡©us
;

347 
i
, 
j
;

349 
i
 = 0; i < 
size
; i++) {

350 
m©rix
[
i
 + i*
size
] = 
UCC_TL_CUDA_TEAM_TOPO_SAME_DEVICE
;

351 
j
 = 
i
 + 1; j < 
size
; j++) {

352 ià(
	`ucc__cuda_tİo_deviû_id_equ®
(&
‹am
->
ids
[
i
].
pci_id
,

353 &
‹am
->
ids
[
j
].
pci_id
)) {

354 
m©rix
[
i
 + 
j
*
size
] = 
UCC_TL_CUDA_TEAM_TOPO_SAME_DEVICE
;

356 
¡©us
 = 
	`ucc__cuda_tİo_num_lšks
(
tİo
,

357 &
‹am
->
ids
[
i
].
pci_id
,

358 &
‹am
->
ids
[
j
].
pci_id
,

359 &
m©rix
[
i
 + 
j
*
size
]);

360 ià(
¡©us
 !ğ
UCC_OK
) {

361  
¡©us
;

364 
m©rix
[
j
 + 
i
*
size
] = matrix[i +j*size];

368  
UCC_OK
;

369 
	}
}

371 
ucc_¡©us_t
 
	$ucc__cuda_‹am_tİo_ü—‹
(cÚ¡ 
ucc__‹am_t
 *
cuda_‹am
,

372 
ucc__cuda_‹am_tİo_t
 **
‹am_tİo
)

374 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
cuda_‹am
, ucc_tl_cuda_team_t);

375 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

376 
ucc__cuda_‹am_tİo_t
 *
tİo
;

377 
ucc_¡©us_t
 
¡©us
;

379 
tİo
 = (
ucc__cuda_‹am_tİo_t
*)
	`ucc_m®loc
((*topo), "cuda_team_topo");

380 ià(!
tİo
) {

381 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo‡lloc cudaeamopo");

382  
UCC_ERR_NO_MEMORY
;

385 
tİo
->
m©rix
 = (
ucc_¿nk_t
*)
	`ucc_m®loc
(
size
 * size * (ucc_rank_t),

387 ià(!
tİo
->
m©rix
) {

388 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo‡lloc cudaeamopo matrix");

389 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

390 
ä“_tİo
;

392 
¡©us
 = 
	`ucc__cuda_‹am_tİo_š™_m©rix
(
‹am
, 
tİo
->
m©rix
);

393 ià(
¡©us
 !ğ
UCC_OK
) {

394 
ä“_m©rix
;

397 
¡©us
 = 
	`ucc__cuda_‹am_tİo_š™_´ox›s
(
‹am
, 
tİo
);

398 ià(
¡©us
 !ğ
UCC_OK
) {

399 ià(
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
) {

400 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo init cudaopo…roxy");

402 
ä“_m©rix
;

405 
¡©us
 = 
	`ucc__cuda_‹am_tİo_š™_ršgs
(
‹am
, 
tİo
);

406 ià(
¡©us
 !ğ
UCC_OK
) {

407 ià(
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
) {

408 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo init cudaopo„ings");

410 
ä“_´oxy
;

413 *
‹am_tİo
 = 
tİo
;

414  
UCC_OK
;

415 
ä“_´oxy
:

416 ià(
tİo
->
num_´ox›s
 > 0) {

417 
	`ucc_ä“
(
tİo
->
´ox›s
);

419 
ä“_m©rix
:

420 
	`ucc_ä“
(
tİo
->
m©rix
);

421 
ä“_tİo
:

422 
	`ucc_ä“
(
tİo
);

423  
¡©us
;

424 
	}
}

426 
	$ucc__cuda_‹am_tİo_´št_´ox›s
(cÚ¡ 
ucc__‹am_t
 *
_‹am
,

427 cÚ¡ 
ucc__cuda_‹am_tİo_t
 *
tİo
)

429 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

430 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

431 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

432 
ucc_¿nk_t
 
i
;

433 
pci_¡r
[3][
MAX_PCI_BUS_ID_STR
];

435 
i
 = 0; i < 
size
; i++) {

436 ià(
	`ucc__cuda_‹am_tİo_is_dœeù
(
_‹am
, 
tİo
, 
¿nk
, 
i
)) {

437 
	`ucc__cuda_tİo_pci_id_to_¡r
(&
‹am
->
ids
[
¿nk
].
pci_id
,

438 
pci_¡r
[0], 
MAX_PCI_BUS_ID_STR
);

439 
	`ucc__cuda_tİo_pci_id_to_¡r
(&
‹am
->
ids
[
i
].
pci_id
,

440 
pci_¡r
[1], 
MAX_PCI_BUS_ID_STR
);

441 ià(
tİo
->
m©rix
[
¿nk
 * 
size
 +
i
] =ğ
UCC_TL_CUDA_TEAM_TOPO_SAME_DEVICE
)

443 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
),

445 
pci_¡r
[0], 
¿nk
,…ci_¡r[1], 
i
);

448 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
),

450 
pci_¡r
[0], 
¿nk
,…ci_¡r[1], 
i
,

451 
tİo
->
m©rix
[
¿nk
 * 
size
 + 
i
]);

456 
i
 = 0; i < 
tİo
->
num_´ox›s
; i++) {

457 
	`ucc__cuda_tİo_pci_id_to_¡r
(&
‹am
->
ids
[
tİo
->
´ox›s
[
i
].
¤c
].
pci_id
,

458 
pci_¡r
[0], 
MAX_PCI_BUS_ID_STR
);

459 
	`ucc__cuda_tİo_pci_id_to_¡r
(&
‹am
->
ids
[
tİo
->
´ox›s
[
i
].
d¡
].
pci_id
,

460 
pci_¡r
[1], 
MAX_PCI_BUS_ID_STR
);

461 
	`ucc__cuda_tİo_pci_id_to_¡r
(&
‹am
->
ids
[
tİo
->
´ox›s
[
i
].
´oxy
].
pci_id
,

462 
pci_¡r
[2], 
MAX_PCI_BUS_ID_STR
);

463 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
),

465 
pci_¡r
[0], 
tİo
->
´ox›s
[
i
].
¤c
,

466 
pci_¡r
[1], 
tİo
->
´ox›s
[
i
].
d¡
,

467 
pci_¡r
[2], 
tİo
->
´ox›s
[
i
].
´oxy
);

469 
	}
}

471 
	$ucc__cuda_‹am_tİo_´št_ršgs
(cÚ¡ 
ucc__‹am_t
 *
_‹am
,

472 cÚ¡ 
ucc__cuda_‹am_tİo_t
 *
tİo
)

474 
ucc__cuda_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_cuda_team_t);

475 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

476 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

477 
i
, 
j
;

479 
i
 = 0; i < 
tİo
->
num_ršgs
; i++) {

480 
j
 = 0; j < 
size
; j++) {

481 ià(
tİo
->
ršgs
[
i
].
ršg
[
j
] =ğ
¿nk
) {

482 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "ring %d: %d sendo %d",

483 
i
, 
¿nk
, 
tİo
->
ršgs
[i].
ršg
[(
j
 + 1è% 
size
]);

487 
	}
}

489 
ucc_¡©us_t
 
	$ucc__cuda_‹am_tİo_de¡roy
(
ucc__cuda_‹am_tİo_t
 *
‹am_tİo
)

491 
i
;

493 
i
 = 0; i < 
‹am_tİo
->
num_ršgs
; i++) {

494 
	`ucc_ä“
(
‹am_tİo
->
ršgs
[
i
].
ršg
);

496 
	`ucc_ä“
(
‹am_tİo
->
ršgs
);

497 ià(
‹am_tİo
->
num_´ox›s
 > 0) {

498 
	`ucc_ä“
(
‹am_tİo
->
´ox›s
);

500 
	`ucc_ä“
(
‹am_tİo
->
m©rix
);

501 
	`ucc_ä“
(
‹am_tİo
);

502  
UCC_OK
;

503 
	}
}

	@src/components/tl/cuda/tl_cuda_team_topo.h

7 #iâdeà
UCC_TL_CUDA_TEAM_TOPO_H_


8 
	#UCC_TL_CUDA_TEAM_TOPO_H_


	)

10 
	~"compÚ’ts//ucc_.h
"

11 
	~"_cuda_tİo.h
"

13 
	succ__cuda_´oxy
 {

14 
ucc_¿nk_t
 
	m¤c
;

15 
ucc_¿nk_t
 
	md¡
;

16 
ucc_¿nk_t
 
	m´oxy
;

17 } 
	tucc__cuda_´oxy_t
;

19 
	succ__cuda_ršg
 {

20 
ucc_¿nk_t
 *
	mršg
;

21 
ucc_¿nk_t
 *
	mœšg
;

22 } 
	tucc__cuda_ršg_t
;

24 
	succ__cuda_‹am_tİo
 {

25 
ucc_¿nk_t
 *
	mm©rix
;

26 
	m´oxy_Ãeded
;

27 
	mnum_´ox›s
;

28 
ucc__cuda_´oxy_t
 *
	m´ox›s
;

29 
	mnum_ršgs
;

30 
ucc__cuda_ršg_t
 *
	mršgs
;

31 
	mis_fuÎy_cÚÃùed
;

32 } 
	tucc__cuda_‹am_tİo_t
;

34 
ucc_¡©us_t
 
ucc__cuda_‹am_tİo_ü—‹
(cÚ¡ 
ucc__‹am_t
 *
‹am
,

35 
ucc__cuda_‹am_tİo_t
 **
‹am_tİo
);

37 
ucc_¡©us_t
 
ucc__cuda_‹am_tİo_de¡roy
(
ucc__cuda_‹am_tİo_t
 *
‹am_tİo
);

39 
ucc__cuda_‹am_tİo_´št_´ox›s
(cÚ¡ 
ucc__‹am_t
 *
‹am
,

40 cÚ¡ 
ucc__cuda_‹am_tİo_t
 *
tİo
);

42 
ucc__cuda_‹am_tİo_´št_ršgs
(cÚ¡ 
ucc__‹am_t
 *
_‹am
,

43 cÚ¡ 
ucc__cuda_‹am_tİo_t
 *
tİo
);

45 
šlše
 

46 
	$ucc__cuda_‹am_tİo_is_dœeù
(cÚ¡ 
ucc__‹am_t
 *
‹am
,

47 cÚ¡ 
ucc__cuda_‹am_tİo_t
 *
tİo
,

48 
ucc_¿nk_t
 
r1
, ucc_¿nk_ˆ
r2
)

50  
tİo
->
m©rix
[
r1
 * 
‹am
->
su³r
.
·¿ms
.
size
 + 
r2
] != 0;

51 
	}
}

53 
šlše
 

54 
	$ucc__cuda_‹am_tİo_is_fuÎy_cÚÃùed
(cÚ¡ 
ucc__cuda_‹am_tİo_t
 *
tİo
)

56  
tİo
->
is_fuÎy_cÚÃùed
;

57 
	}
}

	@src/components/tl/cuda/tl_cuda_topo.c

7 
	~"cÚfig.h
"

8 
	~"_cuda_tİo.h
"

9 
	~"uts/¬ch/cuda_def.h
"

10 
	~<š‰y³s.h
>

11 
	~<±h»ad.h
>

12 
	~<nvml.h
>

14 
±h»ad_mu‹x_t
 
	gnvml_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

16 
	#MAX_PCI_DEVICES
 32

	)

18 
	#NVMLCHECK_GOTO
(
_cmd
, 
_Ïb–
, 
_¡©us
, 
_lib
) \

20 
nvmlR‘uº_t
 
e
 = 
_cmd
; \

21 ià(
	`ucc_uÆik–y
(
NVML_SUCCESS
 !ğ
e
)) { \

22 
	`_”rÜ
(
_lib
, "NVMLƒ¼Ü %d %s", 
e
, 
	`nvmlE¼ÜSŒšg
(e)); \

23 
_¡©us
 = 
UCC_ERR_NO_MESSAGE
; \

24 
_Ïb–
; \

26 } 0)

	)

28 
ucc_¡©us_t


29 
	$ucc__cuda_tİo_pci_id_äom_¡r
(cÚ¡ * 
bus_id_¡r
,

30 
ucc__cuda_deviû_pci_id_t
 *
pci_id
)

32 
n
;

34 
n
 = 
	`ssÿnf
(
bus_id_¡r
, "%hx:%hhx:%hhx.%hhx", &
pci_id
->
domaš
, &pci_id->
bus
,

35 &
pci_id
->
deviû
, &pci_id->
funùiÚ
);

36 ià(
n
 != 4) {

37  
UCC_ERR_INVALID_PARAM
;

39  
UCC_OK
;

40 
	}
}

43 
	$ucc__cuda_tİo_pci_id_to_¡r
(cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
pci_id
,

44 *
¡r
, 
size_t
 
max
)

46 
	`ucc_¢´štf_§ã
(
¡r
, 
max
, "%04x:%02x:%02x.%d", 
pci_id
->
domaš
,

47 
pci_id
->
bus
,…ci_id->
deviû
,…ci_id->
funùiÚ
);

48 
	}
}

50 
ucc_¡©us_t
 
	$ucc__cuda_tİo_g‘_pci_id
(
deviû
,

51 
ucc__cuda_deviû_pci_id_t
 *
pci_id
)

53 
pci_bus_id
[
MAX_PCI_BUS_ID_STR
];

54 
ucc_¡©us_t
 
¡
;

56 
	`CUDA_CHECK_GOTO
(
	`cudaDeviûG‘PCIBusId
(
pci_bus_id
, 
MAX_PCI_BUS_ID_STR
,

57 
deviû
), 
ex™
, 
¡
);

58 
¡
 = 
	`ucc__cuda_tİo_pci_id_äom_¡r
(
pci_bus_id
, 
pci_id
);

59 
ex™
:

60  
¡
;

61 
	}
}

63 
ušt64_t


64 
	$ucc__cuda_deviû_pci_id_to_ušt64
(cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
id
)

66  (((
ušt64_t
)
id
->
domaš
 << 24) |

67 ((
ušt64_t
)
id
->
bus
 << 16) |

68 ((
ušt64_t
)
id
->
deviû
 << 8) |

69 ((
ušt64_t
)
id
->
funùiÚ
));

70 
	}
}

73 
ucc_¡©us_t


74 
	$ucc__cuda_tİo_g¿ph_fšd_by_id
(cÚ¡ 
ucc__cuda_tİo_t
 *
tİo
,

75 cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
dev_id
,

76 
ucc__cuda_tİo_node_t
 **
node
)

78 
ušt64_t
 
id
;

79 
kh™”_t
 
™”
;

81 
id
 = 
	`ucc__cuda_deviû_pci_id_to_ušt64
(
dev_id
);

82 
™”
 = 
	`kh_g‘
(
bus_to_node
, &
tİo
->
bus_to_node_hash
, 
id
);

83 ià(
™”
 =ğ
	`kh_’d
(&
tİo
->
bus_to_node_hash
)) {

84  
UCC_ERR_NOT_FOUND
;

86 *
node
 = &
tİo
->
g¿ph
[
	`kh_v®ue
(&tİo->
bus_to_node_hash
, 
™”
)];

87  
UCC_OK
;

88 
	}
}

90 
ucc_¡©us_t


91 
	$ucc__cuda_tİo_g¿ph_add_deviû
(cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
dev_id
,

92 
ucc__cuda_tİo_dev_ty³_t
 
dev_ty³
,

93 
ucc__cuda_tİo_t
 *
tİo
,

94 
ucc__cuda_tİo_node_t
 **
node
)

96 
ušt64_t
 
key
;

97 
kh™”_t
 
™”
;

98 
»t
;

99 
n
;

100 
dev_id_¡r
[
MAX_PCI_BUS_ID_STR
];

102 
key
 = 
	`ucc__cuda_deviû_pci_id_to_ušt64
(
dev_id
);

103 
™”
 = 
	`kh_put
(
bus_to_node
, &
tİo
->
bus_to_node_hash
, 
key
, &
»t
);

104 ià(
»t
 < 0) {

105 
	`ucc__cuda_tİo_pci_id_to_¡r
(
dev_id
, 
dev_id_¡r
, 
MAX_PCI_BUS_ID_STR
);

106 
	`_”rÜ
(
tİo
->
lib
, "çedØadd deviû id % key %" 
PRIu64
 "o hash",

107 
dev_id_¡r
, 
key
);

108  
UCC_ERR_NO_MESSAGE
;

109 } ià(
»t
 == 0) {

111 *
node
 = &
tİo
->
g¿ph
[
	`kh_v®ue
(&tİo->
bus_to_node_hash
, 
™”
)];

112 
	`ucc_as£¹
((*
node
)->
ty³
 =ğ
dev_ty³
);

113  
UCC_OK
;

115 
n
 = 
tİo
->
num_nodes
;

116 
tİo
->
num_nodes
++;

117 
	`kh_v®ue
(&
tİo
->
bus_to_node_hash
, 
™”
èğ
n
;

118 
tİo
->
g¿ph
[
n
].
pci_id
 = *
dev_id
;

119 
tİo
->
g¿ph
[
n
].
ty³
 = 
dev_ty³
;

120 
	`ucc_li¡_h—d_š™
(&
tİo
->
g¿ph
[
n
].
lšk
.
li¡_lšk
);

121 *
node
 = &
tİo
->
g¿ph
[
n
];

123  
UCC_OK
;

124 
	}
}

126 
ucc_¡©us_t


127 
	$ucc__cuda_tİo_g¿ph_add_lšk
(
ucc__cuda_tİo_t
 *
tİo
,

128 
ucc__cuda_tİo_node_t
 *
¤c
,

129 
ucc__cuda_tİo_node_t
 *
d¡
)

131 
ucc__cuda_tİo_lšk_t
 *
lšk
;

132 
	`ucc_li¡_fÜ_—ch
(
lšk
, &
¤c
->lšk.
li¡_lšk
,†ist_link) {

133 ià(
	`ucc__cuda_tİo_deviû_id_equ®
(&
lšk
->
pci_id
, &
d¡
->pci_id)) {

134 
lšk
->
width
 += 1;

135  
UCC_OK
;

138 
lšk
 = (
ucc__cuda_tİo_lšk_t
*)
	`ucc_m®loc
((*link), "cuda_topo_link");

139 ià(!
lšk
) {

140 
	`_”rÜ
(
tİo
->
lib
, "failedo‡llocateopo†ink");

141  
UCC_ERR_NO_MEMORY
;

143 
lšk
->
pci_id
 = 
d¡
->pci_id;

144 
lšk
->
width
 = 1;

145 
	`ucc_li¡_add_
(&
¤c
->
lšk
.
li¡_lšk
, &link->list_link);

147  
UCC_OK
;

148 
	}
}

150 
	$ucc__cuda_tİo_ä“_lšk
(
ucc__cuda_tİo_lšk_t
 *
lšk
)

151 {
	}
}

153 
	$ucc__cuda_tİo_g¿ph_de¡roy
(
ucc__cuda_tİo_t
 *
tİo
)

155 
i
;

157 
i
 = 0; i < 
tİo
->
num_nodes
; i++) {

158 
	`ucc_li¡_de¡ruù
(&
tİo
->
g¿ph
[
i
].
lšk
.
li¡_lšk
,

159 
ucc__cuda_tİo_lšk_t
, 
ucc__cuda_tİo_ä“_lšk
,

160 
li¡_lšk
);

162 
	`kh_de¡roy_š¶aû
(
bus_to_node
, &
tİo
->
bus_to_node_hash
);

163 
	`ä“
(
tİo
->
g¿ph
);

164 
	}
}

166 
ucc_¡©us_t


167 
	$ucc__cuda_tİo_g‘_»mÙe_dev_ty³
(
ucc__cuda_tİo_t
 *
tİo
,

168 
nvmlDeviû_t
 
dev
, 
lšk
,

169 
ucc__cuda_tİo_dev_ty³_t
 *
dev_ty³
)

172 #ià
HAVE_NVML_REMOTE_DEVICE_TYPE


173 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

174 
nvmlIÁNvLškDeviûTy³_t
 
nvml_dt
;

176 
	`NVMLCHECK_GOTO
(
	`nvmlDeviûG‘NvLškRemÙeDeviûTy³
(
dev
, 
lšk
, &
nvml_dt
),

177 
ex™
, 
¡©us
, 
tİo
->
lib
);

178 
nvml_dt
) {

179 
NVML_NVLINK_DEVICE_TYPE_GPU
:

180 *
dev_ty³
 = 
UCC_TL_CUDA_TOPO_DEV_TYPE_GPU
;

182 
NVML_NVLINK_DEVICE_TYPE_SWITCH
:

183 *
dev_ty³
 = 
UCC_TL_CUDA_TOPO_DEV_TYPE_SWITCH
;

186 *
dev_ty³
 = 
UCC_TL_CUDA_TOPO_DEV_TYPE_LAST
;

189 
ex™
:

190  
¡©us
;

192 
nvmlPciInfo_t
 
nvml_pci
;

193 
nvmlDeviû_t
 
nvml_dev
;

194 
nvmlR‘uº_t
 
nvml_¡
;

196 
nvml_¡
 = 
	`nvmlDeviûG‘NvLškRemÙePciInfo_v2
(
dev
, 
lšk
, &
nvml_pci
);

197 ià(
nvml_¡
 !ğ
NVML_SUCCESS
) {

198 *
dev_ty³
 = 
UCC_TL_CUDA_TOPO_DEV_TYPE_LAST
;

199  
UCC_OK
;

202 
nvml_¡
 = 
	`nvmlDeviûG‘HªdËByPciBusId_v2
(
nvml_pci
.
busId
, &
nvml_dev
);

203 ià(
nvml_¡
 =ğ
NVML_SUCCESS
) {

204 *
dev_ty³
 = 
UCC_TL_CUDA_TOPO_DEV_TYPE_GPU
;

205  
UCC_OK
;

206 } ià(
nvml_¡
 =ğ
NVML_ERROR_NOT_FOUND
) {

207 *
dev_ty³
 = 
UCC_TL_CUDA_TOPO_DEV_TYPE_SWITCH
;

208  
UCC_OK
;

210  
UCC_ERR_NOT_SUPPORTED
;

212 
	}
}

214 
ucc_¡©us_t
 
	$ucc__cuda_tİo_g¿ph_ü—‹
(
ucc__cuda_tİo_t
 *
tİo
)

216 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

217 
nvmlDeviû_t
 
nvml_dev
;

218 
nvmlF›ldV®ue_t
 
nvml_v®ue
;

219 
nvmlPciInfo_t
 
nvml_pci
;

220 
ucc__cuda_tİo_dev_ty³_t
 
dev_ty³
;

221 
ucc__cuda_deviû_pci_id_t
 
pci_id
;

222 
ucc__cuda_tİo_node_t
 *
node
, *
³”_node
;

223 
num_nvlšks
, 
lšk
, 
i
;

224 
num_gpus
;

225 
nvmlR‘uº_t
 
nvml_¡
;

227 
nvml_¡
 = 
	`nvmlIn™_v2
();

228 ià(
nvml_¡
 !ğ
NVML_SUCCESS
) {

229 
	`_debug
(
tİo
->
lib
, "failedo init NVML: %s",

230 
	`nvmlE¼ÜSŒšg
(
nvml_¡
));

231  
UCC_ERR_NO_MESSAGE
;

234 
nvml_¡
 = 
	`nvmlDeviûG‘CouÁ
(&
num_gpus
);

235 ià(
nvml_¡
 !ğ
NVML_SUCCESS
) {

236 
	`_debug
(
tİo
->
lib
, "nvmlDeviceGetCount failed: %s",

237 
	`nvmlE¼ÜSŒšg
(
nvml_¡
));

238 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

239 
ex™_nvml_shutdown
;

242 ià(
num_gpus
 == 0) {

243 
	`_debug
(
tİo
->
lib
, "no GPU devices found");

244 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

245 
ex™_nvml_shutdown
;

248 
tİo
->
num_nodes
 = 0;

249 
tİo
->
g¿ph
 = (
ucc__cuda_tİo_node_t
*)
	`ucc_m®loc
(
MAX_PCI_DEVICES
 *

250 (*
tİo
->
g¿ph
),

252 ià(!
tİo
->
g¿ph
) {

253 
	`_”rÜ
(
tİo
->
lib
, "failedo‡llocatel cudaopo graph");

254  
UCC_ERR_NO_MEMORY
;

256 
	`kh_š™_š¶aû
(
bus_to_node
, &
tİo
->
bus_to_node_hash
);

257 
	`±h»ad_mu‹x_lock
(&
nvml_lock
);

258 
nvml_v®ue
.
f›ldId
 = 
NVML_FI_DEV_NVLINK_LINK_COUNT
;

259 
i
 = 0; i < 
num_gpus
; i++) {

260 
	`NVMLCHECK_GOTO
(
	`nvmlDeviûG‘HªdËByIndex
(
i
, &
nvml_dev
),

261 
ex™_ä“_g¿ph
, 
¡©us
, 
tİo
->
lib
);

262 
	`NVMLCHECK_GOTO
(
	`nvmlDeviûG‘PciInfo
(
nvml_dev
, &
nvml_pci
),

263 
ex™_ä“_g¿ph
, 
¡©us
, 
tİo
->
lib
);

264 
pci_id
.
domaš
 = 
nvml_pci
.domain;

265 
pci_id
.
bus
 = 
nvml_pci
.bus;

266 
pci_id
.
deviû
 = 
nvml_pci
.device;

267 
pci_id
.
funùiÚ
 = 0;

268 
¡©us
 = 
	`ucc__cuda_tİo_g¿ph_add_deviû
(&
pci_id
,

269 
UCC_TL_CUDA_TOPO_DEV_TYPE_GPU
,

270 
tİo
, &
node
);

271 ià(
¡©us
 !ğ
UCC_OK
) {

272 
ex™_ä“_g¿ph
;

274 
	`NVMLCHECK_GOTO
(
	`nvmlDeviûG‘F›ldV®ues
(
nvml_dev
, 1, &
nvml_v®ue
),

275 
ex™_ä“_g¿ph
, 
¡©us
, 
tİo
->
lib
);

276 
num_nvlšks
 = ((
nvml_v®ue
.
nvmlR‘uº
 =ğ
NVML_SUCCESS
) &&

277 (
nvml_v®ue
.
v®ueTy³
 =ğ
NVML_VALUE_TYPE_UNSIGNED_INT
)) ?

278 
nvml_v®ue
.
v®ue
.
uiV®
 : 0;

279 
lšk
 = 0;†šk < 
num_nvlšks
;†ink++) {

280 
¡©us
 = 
	`ucc__cuda_tİo_g‘_»mÙe_dev_ty³
(
tİo
, 
nvml_dev
, 
lšk
,

281 &
dev_ty³
);

282 ià(
¡©us
 !ğ
UCC_OK
) {

283 
	`_debug
(
tİo
->
lib
, "failedo get„emote deviceype");

284 
ex™_ä“_g¿ph
;

286 ià(
dev_ty³
 =ğ
UCC_TL_CUDA_TOPO_DEV_TYPE_LAST
) {

290 
	`NVMLCHECK_GOTO
(
	`nvmlDeviûG‘NvLškRemÙePciInfo_v2
(
nvml_dev
, 
lšk
,

291 &
nvml_pci
),

292 
ex™_ä“_g¿ph
, 
¡©us
, 
tİo
->
lib
);

293 
pci_id
.
domaš
 = 
nvml_pci
.domain;

294 
pci_id
.
bus
 = 
nvml_pci
.bus;

295 
pci_id
.
deviû
 = 
nvml_pci
.device;

296 
pci_id
.
funùiÚ
 = 0;

297 
¡©us
 = 
	`ucc__cuda_tİo_g¿ph_add_deviû
(&
pci_id
, 
dev_ty³
, 
tİo
,

298 &
³”_node
);

299 ià(
¡©us
 !ğ
UCC_OK
) {

300 
ex™_ä“_g¿ph
;

302 
¡©us
 = 
	`ucc__cuda_tİo_g¿ph_add_lšk
(
tİo
, 
node
, 
³”_node
);

303 ià(
¡©us
 !ğ
UCC_OK
) {

304 
ex™_ä“_g¿ph
;

308 
	`nvmlShutdown
();

309 
	`±h»ad_mu‹x_uÆock
(&
nvml_lock
);

310  
UCC_OK
;

312 
ex™_ä“_g¿ph
:

313 
	`ucc__cuda_tİo_g¿ph_de¡roy
(
tİo
);

314 
	`±h»ad_mu‹x_uÆock
(&
nvml_lock
);

315 
ex™_nvml_shutdown
:

316 
	`nvmlShutdown
();

317  
¡©us
;

318 
	}
}

320 
ucc_¡©us_t
 
	$ucc__cuda_tİo_ü—‹
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

321 
ucc__cuda_tİo_t
 **
cuda_tİo
)

323 
ucc__cuda_tİo_t
 *
tİo
;

324 
ucc_¡©us_t
 
¡©us
;

326 
tİo
 = (
ucc__cuda_tİo_t
*)
	`ucc_m®loc
((*topo), "cuda_topo");

327 ià(!
tİo
) {

328 
	`_”rÜ
(
lib
, "failedo‡lloc cudaopo");

329 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

330 
ex™_”r
;

333 
tİo
->
lib
 =†ib;

334 
¡©us
 = 
	`ucc__cuda_tİo_g¿ph_ü—‹
(
tİo
);

335 ià(
¡©us
 !ğ
UCC_OK
) {

336 
ä“_tİo
;

339 *
cuda_tİo
 = 
tİo
;

340  
UCC_OK
;

341 
ä“_tİo
:

342 
	`ucc_ä“
(
tİo
);

343 
ex™_”r
:

344  
¡©us
;

345 
	}
}

347 
ucc_¡©us_t
 
	$ucc__cuda_tİo_num_lšks
(cÚ¡ 
ucc__cuda_tİo_t
 *
tİo
,

348 cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
dev1
,

349 cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
dev2
,

350 
ucc_¿nk_t
 *
num_lšks
)

352 
ucc_¡©us_t
 
¡©us
;

353 
ucc__cuda_tİo_node_t
 *
dev1_node
, *
dev2_node
;

354 
ucc__cuda_tİo_node_t
 *
lšk_node
;

355 
ucc__cuda_tİo_lšk_t
 *
dev1_lšk
, *
dev2_lšk
;

357 *
num_lšks
 = 0;

358 
¡©us
 = 
	`ucc__cuda_tİo_g¿ph_fšd_by_id
(
tİo
, 
dev1
, &
dev1_node
);

359 ià(
¡©us
 !ğ
UCC_OK
) {

360  
¡©us
;

362 
¡©us
 = 
	`ucc__cuda_tİo_g¿ph_fšd_by_id
(
tİo
, 
dev2
, &
dev2_node
);

363 ià(
¡©us
 !ğ
UCC_OK
) {

364  
¡©us
;

367 
	`ucc_li¡_fÜ_—ch
(
dev1_lšk
, &
dev1_node
->
lšk
.
li¡_lšk
,†ist_link) {

368 ià(
	`ucc__cuda_tİo_deviû_id_equ®
(&
dev1_lšk
->
pci_id
, 
dev2
)) {

369 *
num_lšks
 +ğ
dev1_lšk
->
width
;

372 
¡©us
 = 
	`ucc__cuda_tİo_g¿ph_fšd_by_id
(
tİo
, &
dev1_lšk
->
pci_id
,

373 &
lšk_node
);

374 ià(
¡©us
 !ğ
UCC_OK
) {

375  
¡©us
;

377 ià(
lšk_node
->
ty³
 =ğ
UCC_TL_CUDA_TOPO_DEV_TYPE_SWITCH
) {

378 
	`ucc_li¡_fÜ_—ch
(
dev2_lšk
, &
dev2_node
->
lšk
.
li¡_lšk
,†ist_link) {

379 ià(
	`ucc__cuda_tİo_deviû_id_equ®
(&
dev2_lšk
->
pci_id
,

380 &
dev1_lšk
->
pci_id
)) {

381 *
num_lšks
 +ğ
	`ucc_mš
(
dev1_lšk
->
width
, 
dev2_lšk
->width);

388  
UCC_OK
;

389 
	}
}

391 
ucc_¡©us_t
 
	$ucc__cuda_tİo_de¡roy
(
ucc__cuda_tİo_t
 *
cuda_tİo
)

393 
	`ucc__cuda_tİo_g¿ph_de¡roy
(
cuda_tİo
);

394 
	`ucc_ä“
(
cuda_tİo
);

395  
UCC_OK
;

396 
	}
}

	@src/components/tl/cuda/tl_cuda_topo.h

7 #iâdeà
UCC_TL_CUDA_TOPO_H_


8 
	#UCC_TL_CUDA_TOPO_H_


	)

10 
	~"compÚ’ts//ucc__log.h
"

11 
	~"uts/khash.h
"

13 
	#MAX_PCI_BUS_ID_STR
 16

	)

15 
	succ__cuda_deviû_id
 {

16 
ušt16_t
 
	mdomaš
;

17 
ušt8_t
 
	mbus
;

18 
ušt8_t
 
	mdeviû
;

19 
ušt8_t
 
	mfunùiÚ
;

20 } 
	tucc__cuda_deviû_pci_id_t
;

22 
	eucc__cuda_tİo_dev_ty³
 {

23 
	mUCC_TL_CUDA_TOPO_DEV_TYPE_GPU
,

24 
	mUCC_TL_CUDA_TOPO_DEV_TYPE_SWITCH
,

25 
	mUCC_TL_CUDA_TOPO_DEV_TYPE_LAST


26 } 
	tucc__cuda_tİo_dev_ty³_t
;

28 
šlše
 

29 
	$ucc__cuda_tİo_deviû_id_equ®
(cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
id1
,

30 cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
id2
)

32  ((
id1
->
domaš
 =ğ
id2
->domain) &&

33 (
id1
->
bus
 =ğ
id2
->bus) &&

34 (
id1
->
deviû
 =ğ
id2
->device) &&

35 (
id1
->
funùiÚ
 =ğ
id2
->function));

36 
	}
}

38 
	succ__cuda_tİo_lšk
 {

39 
ucc_li¡_lšk_t
 
	mli¡_lšk
;

40 
ucc__cuda_deviû_pci_id_t
 
	mpci_id
;

41 
	mwidth
;

42 } 
	tucc__cuda_tİo_lšk_t
;

44 
	succ__cuda_tİo_node
 {

45 
ucc__cuda_deviû_pci_id_t
 
	mpci_id
;

46 
ucc__cuda_tİo_dev_ty³_t
 
	mty³
;

47 
ucc__cuda_tİo_lšk_t
 
	mlšk
;

48 } 
	tucc__cuda_tİo_node_t
;

50 
KHASH_MAP_INIT_INT64
(
bus_to_node
, );

52 
	succ__cuda_tİo
 {

53 cÚ¡ 
ucc_ba£_lib_t
 *
	mlib
;

54 
khash_t
(
bus_to_node
è
	mbus_to_node_hash
;

55 
	mnum_nodes
;

56 
ucc__cuda_tİo_node_t
 *
	mg¿ph
;

57 } 
	tucc__cuda_tİo_t
;

59 
ucc_¡©us_t
 
ucc__cuda_tİo_g‘_pci_id
(
deviû
,

60 
ucc__cuda_deviû_pci_id_t
 *
pci_id
);

62 
ucc_¡©us_t
 
ucc__cuda_tİo_ü—‹
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

63 
ucc__cuda_tİo_t
 **
cuda_tİo
);

65 
ucc_¡©us_t
 
ucc__cuda_tİo_de¡roy
(
ucc__cuda_tİo_t
 *
cuda_tİo
);

67 
ucc_¡©us_t
 
ucc__cuda_tİo_num_lšks
(cÚ¡ 
ucc__cuda_tİo_t
 *
tİo
,

68 cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
dev1
,

69 cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
dev2
,

70 
ucc_¿nk_t
 *
num_lšks
);

72 
ucc__cuda_tİo_pci_id_to_¡r
(cÚ¡ 
ucc__cuda_deviû_pci_id_t
 *
pci_id
,

73 *
¡r
, 
size_t
 
max
);

	@src/components/tl/mlx5/alltoall/alltoall.c

7 
	~"®ÉßÎ.h
"

8 
	~"®ÉßÎ_mkeys.h
"

10 
	~"_mlx5_ib.h
"

12 
	~"cÜe/ucc_‹am.h
"

13 
	~<sys/shm.h
>

15 
	s¿nk_d©a
 {

16 
ucc_¿nk_t
 
	m‹am_¿nk
;

17 
ucc_¿nk_t
 
	msbgp_¿nk
;

20 
	sÃt_exchage
 {

21 
¿nk_d©a
 
	mrd
;

22 
®ÉßÎ_Ãt_ù¾_t
 
	mÃt_ù¾
;

23 
ušt32_t
 
	mpÜt_lid
;

24 
ušt32_t
 
	m»cv_mkey_rkey
;

25 
ušt32_t
 
	mq²
[1];

26 } 
	tÃt_exchªge_t
;

28 
	$com·»_¿nk_d©a
(cÚ¡ *
a
, cÚ¡ *
b
)

30 cÚ¡ 
¿nk_d©a
 *
d1
 = (cÚ¡ ¿nk_d©¨*)
a
;

31 cÚ¡ 
¿nk_d©a
 *
d2
 = (cÚ¡ ¿nk_d©¨*)
b
;

33  
d1
->
‹am_¿nk
 > 
d2
->team_rank ? 1 : -1;

34 
	}
}

36 
ucc_¡©us_t
 
	$bud_¿nk_m­
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

37 
Ãt_exchªge_t
 *
glob®_d©a
,

38 
size_t
 
loÿl_d©a_size
)

40 
¿nk_d©a
 *
d©a
;

41 
Ãt_exchªge_t
 *
d
;

42 
i
;

44 
d©a
 = 
	`ucc_m®loc
((*d©aè* 
a2a
->
Ãt
.
Ãt_size
);

45 ià(!
d©a
) {

46  
UCC_ERR_NO_MEMORY
;

49 
i
 = 0; i < 
a2a
->
Ãt
.
Ãt_size
; i++) {

50 
d
 = 
	`PTR_OFFSET
(
glob®_d©a
, 
i
 * 
loÿl_d©a_size
);

51 
d©a
[
i
].
‹am_¿nk
 = 
d
->
rd
.team_rank;

52 
d©a
[
i
].
sbgp_¿nk
 = 
d
->
rd
.sbgp_rank;

55 
a2a
->
Ãt
.
¿nk_m­
 = 
	`ucc_m®loc
((è*‡2a->Ãt.
Ãt_size
);

56 ià(!
a2a
->
Ãt
.
¿nk_m­
) {

57 
	`ucc_ä“
(
d©a
);

58  
UCC_ERR_NO_MEMORY
;

60 
	`qsÜt
(
d©a
, 
a2a
->
Ãt
.
Ãt_size
, (*d©a), 
com·»_¿nk_d©a
);

61 
i
 = 0; i < 
a2a
->
Ãt
.
Ãt_size
; i++) {

62 
a2a
->
Ãt
.
¿nk_m­
[
d©a
[
i
].
sbgp_¿nk
] = i;

64 
	`ucc_ä“
(
d©a
);

65  
UCC_OK
;

66 
	}
}

68 
ucc_¡©us_t
 
	$ucc__mlx5_‹am_š™_®ÉßÎ
(
ucc__mlx5_‹am_t
 *
‹am
)

70 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
‹am
);

71 
ucc__mlx5_®ÉßÎ_t
 *
a2a
;

72 
ucc_sbgp_t
 *
node
, *
Ãt
;

73 
i
, 
j
, 
node_size
, 
µn
, 
‹am_size
, 
Âodes
;

74 
ucc_tİo_t
 *
tİo
;

76 
‹am
->
a2a
 = 
NULL
;

77 
‹am
->
dm_±r
 = 
NULL
;

78 
‹am
->
a2a_¡©us
.
loÿl
 = 
UCC_OK
;

80 
tİo
 = 
‹am
->topo;

81 
node
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

82 
Ãt
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

83 
node_size
 = 
node
->
group_size
;

84 
Âodes
 = 
	`ucc_tİo_Âodes
(
tİo
);

85 
‹am_size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

87 ià(!
	`ucc_tİo_isİ²
(
tİo
)) {

88 
	`_debug
(
ùx
->
su³r
.su³r.
lib
,

91 
	`ucc_tİo_mš_µn
(
tİo
), 
	`ucc_tİo_max_µn
(topo));

92 
nÚ_çl_”rÜ
;

94 
µn
 = 
	`ucc_tİo_max_µn
(
tİo
);

96 ià(
Ãt
->
¡©us
 =ğ
UCC_SBGP_NOT_EXISTS
) {

97 
	`_debug
(
ùx
->
su³r
.su³r.
lib
,

99 
nÚ_çl_”rÜ
;

102 ià(
Âodes
 =ğ
‹am_size
) {

103 
	`_debug
(
ùx
->
su³r
.su³r.
lib
,

105 
nÚ_çl_”rÜ
;

109 
i
 = 0; i < 
Âodes
; i++) {

110 
j
 = 1; j < 
µn
; j++) {

111 ià(!
	`ucc_‹am_¿nks_Ú_§me_node
(
i
 * 
µn
, i *…² + 
j
,

112 
	`UCC_TL_CORE_TEAM
(
‹am
))) {

113 
	`_debug
(
ùx
->
su³r
.su³r.
lib
,

116 
nÚ_çl_”rÜ
;

121 
‹am
->
a2a
 = 
	`ucc_ÿÎoc
(1, (*team->a2a), "mlx5_a2a");

122 ià(!
‹am
->
a2a
) {

123  
UCC_ERR_NO_MEMORY
;

126 
a2a
 = 
‹am
->a2a;

127 
a2a
->
node_size
 =‚ode_size;

128 
a2a
->
pd
 = 
ùx
->
sh¬ed_pd
;

129 
a2a
->
ùx
 = ctx->
sh¬ed_ùx
;

130 
a2a
->
ib_pÜt
 = 
ùx
->ib_port;

131 
a2a
->
node
.
sbgp
 =‚ode;

132 
a2a
->
Ãt
.
sbgp
 =‚et;

133 
a2a
->
node
.
a¤_¿nk
 = 
MLX5_ASR_RANK
;

134 
a2a
->
num_dci_qps
 = 
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.num_dci_qps;

135 
a2a
->
£qu’û_numb”
 = 1;

136 
a2a
->
Ãt
.
©omic
.
couÁ”s
 = 
NULL
;

137 
a2a
->
Ãt
.
ù¾_mr
 = 
NULL
;

138 
a2a
->
Ãt
.
»mÙe_ù¾
 = 
NULL
;

139 
a2a
->
Ãt
.
¿nk_m­
 = 
NULL
;

140 
a2a
->
max_msg_size
 = 
MAX_MSG_SIZE
;

141 
a2a
->
max_num_of_cŞumns
 =

142 
	`ucc_div_round_up
(
node
->
group_size
, 2

145 ià(
a2a
->
node
.
a¤_¿nk
 =ğnode->
group_¿nk
) {

146 
‹am
->
a2a_¡©us
.
loÿl
 = 
	`ucc__mlx5_dm_š™
(team);

147 ià(
UCC_OK
 !ğ
‹am
->
a2a_¡©us
.
loÿl
) {

148 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo init device memory");

152  
UCC_OK
;

154 
nÚ_çl_”rÜ
:

155 
‹am
->
a2a_¡©us
.
loÿl
 = 
UCC_ERR_NOT_SUPPORTED
;

156  
UCC_OK
;

157 
	}
}

159 
ucc_¡©us_t
 
	$ucc__mlx5_‹am_‹¡_®ÉßÎ_¡¬t
(
ucc__mlx5_‹am_t
 *
‹am
)

161 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
‹am
);

162 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

163 
size_t
 
¡Üage_size
;

165 ià(
‹am
->
a2a_¡©us
.
glob®
 !ğ
UCC_OK
) {

166 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "global status inƒrror state: %s",

167 
	`ucc_¡©us_¡ršg
(
‹am
->
a2a_¡©us
.
glob®
));

169 
	`ucc__mlx5_dm_ş—nup
(
‹am
);

170 ià(
a2a
) {

171 
	`ucc_ä“
(
a2a
);

172 
‹am
->
a2a
 = 
NULL
;

174 
	`ucc__mlx5_tİo_ş—nup
(
‹am
);

175  
‹am
->
a2a_¡©us
.
glob®
;

178 ià(
a2a
->
node
.
a¤_¿nk
 =ğa2a->node.
sbgp
->
group_¿nk
) {

179 
a2a
->
Ãt
.
Ãt_size
 =‡2a->Ãt.
sbgp
->
group_size
;

180 
¡Üage_size
 = 
	`OP_SEGMENT_SIZE
(
a2a
è* 
MAX_OUTSTANDING_OPS
;

181 
a2a
->
bÿ¡_d©a
.
shmid
 =

182 
	`shmg‘
(
IPC_PRIVATE
, 
¡Üage_size
, 
IPC_CREAT
 | 0600);

183 ià(
a2a
->
bÿ¡_d©a
.
shmid
 == -1) {

184 
	`_debug
(
ùx
->
su³r
.su³r.
lib
,

186 
¡Üage_size
);

188 
a2a
->
node
.
¡Üage
 = 
	`shm©
×2a->
bÿ¡_d©a
.
shmid
, 
NULL
, 0);

189 
	`mem£t
(
a2a
->
node
.
¡Üage
, 0, 
¡Üage_size
);

190 
	`shmùl
(
a2a
->
bÿ¡_d©a
.
shmid
, 
IPC_RMID
, 
NULL
);

192 
a2a
->
bÿ¡_d©a
.
Ãt_size
 =‡2a->
Ãt
.
sbgp
->
group_size
;

195 
a2a
->
¡©e
 = 
TL_MLX5_ALLTOALL_STATE_SHMID
;

197 
‹am
->
a2a
 =‡2a;

198  
	`ucc_£rviû_bÿ¡
(

199 
	`UCC_TL_CORE_TEAM
(
‹am
), &
a2a
->
bÿ¡_d©a
,

200 (
ucc__mlx5_a2a_bÿ¡_d©a_t
), 
a2a
->
node
.
a¤_¿nk
,

201 
	`ucc_sbgp_to_sub£t
(
a2a
->
node
.
sbgp
), &
‹am
->
scŞl_»q
);

202 
	}
}

204 
	$ucc__mlx5_®ÉßÎ_b¬r›r_ä“
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
)

206 
	`ibv_d”eg_mr
(
a2a
->
Ãt
.
b¬r›r
.
mr
);

207 
	`ucc_ä“
(
a2a
->
Ãt
.
b¬r›r
.
æags
);

208 
	}
}

210 
ucc_¡©us_t
 
	$ucc__mlx5_®ÉßÎ_b¬r›r_®loc
(
ucc__mlx5_‹am_t
 *
‹am
)

212 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
‹am
);

213 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

214 
size_t
 
size
;

218 
size
 = (
a2a
->
Ãt
.
Ãt_size
 + 1è* (*a2a->Ãt.
b¬r›r
.
æags
) *

219 
MAX_OUTSTANDING_OPS
;

220 
a2a
->
Ãt
.
b¬r›r
.
æags
 = 
	`ucc_ÿÎoc
(1, 
size
, "barrier");

221 ià(!
a2a
->
Ãt
.
b¬r›r
.
æags
) {

222 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
),

223 "çedØ®loÿ‹ %zd by‹ fÜ b¬r›¸æag ¬¿y", 
size
);

224  
UCC_ERR_NO_MEMORY
;

227 
a2a
->
Ãt
.
b¬r›r
.
mr
 =

228 
	`ibv_»g_mr
(
ùx
->
sh¬ed_pd
, 
a2a
->
Ãt
.
b¬r›r
.
æags
, 
size
,

229 
IBV_ACCESS_REMOTE_WRITE
 | 
IBV_ACCESS_LOCAL_WRITE
);

231 ià(!
a2a
->
Ãt
.
b¬r›r
.
mr
) {

232 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
),

234 
	`ucc_ä“
(
a2a
->
Ãt
.
b¬r›r
.
æags
);

235  
UCC_ERR_NO_MESSAGE
;

237  
UCC_OK
;

238 
	}
}

240 
ucc_¡©us_t
 
	$ucc__mlx5_‹am_‹¡_®ÉßÎ_´og»ss
(
ucc__mlx5_‹am_t
 *
‹am
)

242 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
‹am
);

243 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

244 
ucc_ba£_lib_t
 *
lib
 = 
	`UCC_TL_TEAM_LIB
(
‹am
);

245 
i
 = 0;

246 
Ãt_exchªge_t
 *
loÿl_d©a
 = 
NULL
;

247 
ucc_¿nk_t
 
node_size
, 
node_¿nk
;

248 
ucc_¡©us_t
 
¡©us
;

249 
ucc__mlx5_®ÉßÎ_İ_t
 *
İ
;

250 
j
, 
a¤_cq_size
, 
Ãt_size
, 
»t
;

251 
ibv_pÜt_©Œ
 
pÜt_©Œ
;

252 
size_t
 
İ_£g_size
, 
loÿl_d©a_size
, 
umr_buf_size
;

253 
Ãt_exchªge_t
 *
glob®_d©a
, *
»mÙe_d©a
;

255 ià(
‹am
->
a2a_¡©us
.
loÿl
 < 0) {

256  
‹am
->
a2a_¡©us
.
loÿl
;

259 
node_size
 = 
a2a
->
node
.
sbgp
->
group_size
;

260 
node_¿nk
 = 
a2a
->
node
.
sbgp
->
group_¿nk
;

261 
İ_£g_size
 = 
	`OP_SEGMENT_SIZE
(
a2a
);

263 
a2a
->
¡©e
) {

264 
TL_MLX5_ALLTOALL_STATE_SHMID
:

265 
¡©us
 = 
	`ucc_£rviû_cŞl_‹¡
(
‹am
->
scŞl_»q
);

266 ià(
¡©us
 < 0) {

267 
	`_”rÜ
(
lib
, "failure during service collƒxchange: %s",

268 
	`ucc_¡©us_¡ršg
(
¡©us
));

269 
	`ucc_£rviû_cŞl_fš®ize
(
‹am
->
scŞl_»q
);

270  
¡©us
;

272 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

273  
¡©us
;

275 
	`ucc_£rviû_cŞl_fš®ize
(
‹am
->
scŞl_»q
);

277 ià(
a2a
->
bÿ¡_d©a
.
shmid
 == -1) {

278 
	`_”rÜ
(
lib
, "failedo‡llocate sysv shm segment");

279  
UCC_ERR_NO_MEMORY
;

281 
a2a
->
Ãt
.
Ãt_size
 =‡2a->
bÿ¡_d©a
.net_size;

282 ià(
a2a
->
node
.
a¤_¿nk
 !ğ
node_¿nk
) {

284 
a2a
->
node
.
¡Üage
 = 
	`shm©
×2a->
bÿ¡_d©a
.
shmid
, 
NULL
, 0);

286 ià(
a2a
->
node
.
¡Üage
 == (*)(-1)) {

287 
	`_”rÜ
(
lib
, "çedØshm© seg %d", 
a2a
->
bÿ¡_d©a
.
shmid
);

288  
UCC_ERR_NO_MEMORY
;

290 
i
 = 0; i < 
MAX_OUTSTANDING_OPS
; i++) {

291 
İ
 = &
a2a
->
node
.
İs
[
i
];

292 
İ
->
ù¾
 = 
	`PTR_OFFSET
(
a2a
->
node
.
¡Üage
, 
İ_£g_size
 * 
i
);

293 
İ
->
my_ù¾
 = 
	`PTR_OFFSET
(

294 
İ
->
ù¾
, 
node_¿nk
 * (
ucc__mlx5_®ÉßÎ_ù¾_t
));

297 ià(
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
block_size
 > 
MAX_BLOCK_SIZE
) {

298 
	`_”rÜ
(
lib
, "max block_sizi %d", 
MAX_BLOCK_SIZE
);

299  
UCC_ERR_NO_MESSAGE
;

301 
a2a
->
»que¡ed_block_size
 = 
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
block_size
;

304 ià(
a2a
->
node
.
a¤_¿nk
 !ğ
node_¿nk
) {

305  
UCC_OK
;

308 
¡©us
 = 
	`ucc__mlx5_®ÉßÎ_b¬r›r_®loc
(
‹am
);

309 ià(
UCC_OK
 !ğ
¡©us
) {

310 
”r_b¬r›r
;

313 
a2a
->
Ãt
.
blocks_£Á
 =

314 
	`ucc_m®loc
((*
a2a
->
Ãt
.
blocks_£Á
è*‡2a->Ãt.
Ãt_size
 *

315 
MAX_OUTSTANDING_OPS
,

317 ià(!
a2a
->
Ãt
.
blocks_£Á
) {

318 
	`_”rÜ
(
lib
,

320 (*
a2a
->
Ãt
.
blocks_£Á
è*‡2a->Ãt.
Ãt_size
 *

321 
MAX_OUTSTANDING_OPS
);

322 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

323 
”r_blocks_£Á
;

326 
i
 = 0; i < 
MAX_OUTSTANDING_OPS
; i++) {

327 
İ
 = &
a2a
->
node
.
İs
[
i
];

328 
İ
->
blocks_£Á
 = 
	`PTR_OFFSET
(
a2a
->
Ãt
.blocks_sent,

329 (*
a2a
->
Ãt
.
blocks_£Á
) *

330 
a2a
->
Ãt
.
Ãt_size
 * 
i
);

333 
	`mem£t
(
a2a
->
´evious_msg_size
, 0, (a2a->previous_msg_size));

335 
¡©us
 = 
	`ucc__mlx5_®ÉßÎ_š™_umr
(
‹am
->
a2a
, 
lib
);

336 ià(
¡©us
 !ğ
UCC_OK
) {

337 
	`_”rÜ
(
lib
, "failedo init UMR");

338 
”r_umr
;

340 
Ãt_size
 = 
a2a
->
Ãt
.net_size;

341 
a¤_cq_size
 = 
Ãt_size
 *

342 (
	`SQUARED
(
a2a
->
node
.
sbgp
->
group_size
 / 2 + 1) + 1) *

343 
MAX_OUTSTANDING_OPS
;

344 
a2a
->
Ãt
.
cq
 =

345 
	`ibv_ü—‹_cq
(
ùx
->
sh¬ed_ùx
, 
a¤_cq_size
, 
NULL
, NULL, 0);

346 ià(!
a2a
->
Ãt
.
cq
) {

347 
	`_”rÜ
(
lib
, "failedo‡llocate ASR CQ");

348 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

349 
”r_cq
;

352 
a2a
->
is_dc
 =

353 (
Ãt_size
 >ğ
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
dc_th»shŞd
);

355 
	`ibv_qu”y_pÜt
(
ùx
->
sh¬ed_ùx
, ctx->
ib_pÜt
, &
pÜt_©Œ
);

357 
a2a
->
Ãt
.
ù¾_mr
 = 
	`ibv_»g_mr
(

358 
ùx
->
sh¬ed_pd
, 
a2a
->
node
.
¡Üage
,

359 
İ_£g_size
 * 
MAX_OUTSTANDING_OPS
,

360 
IBV_ACCESS_REMOTE_WRITE
 | 
IBV_ACCESS_REMOTE_READ
 |

361 
IBV_ACCESS_REMOTE_ATOMIC
 | 
IBV_ACCESS_LOCAL_WRITE
);

362 ià(!
a2a
->
Ãt
.
ù¾_mr
) {

363 
	`_”rÜ
(
lib
, "failedo„egister control data,ƒrrno %d",

364 
”ºo
);

365 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

366 
”r_ù¾_mr
;

368 
a2a
->
Ãt
.
»mÙe_ù¾
 = 
	`ucc_ÿÎoc
((*a2a->net.remote_ctrl),

369 
Ãt_size
, "remote_ctrl");

370 ià(!
a2a
->
Ãt
.
»mÙe_ù¾
) {

371 
	`_”rÜ
(
lib
, "failedo‡llocate %zd bytes for„emote_ctrl",

372 (*
a2a
->
Ãt
.
»mÙe_ù¾
è* 
Ãt_size
);

373 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

374 
”r_»mÙe_ù¾
;

377 
¡©us
 = 
	`ucc__mlx5_š™_mkeys
(
‹am
, 
lib
);

378 ià(
¡©us
 !ğ
UCC_OK
) {

379 
	`_”rÜ
(
lib
, "failedo init mkeys");

380 
”r_mkeys
;

384 
loÿl_d©a_size
 = (
Ãt_exchªge_t
);

385 ià(!
a2a
->
is_dc
) {

387 
loÿl_d©a_size
 +ğ(
ušt32_t
è* (
Ãt_size
 - 1);

390 
loÿl_d©a
 =

391 
	`ucc_m®loc
(
loÿl_d©a_size
 * (
Ãt_size
 + 1), "exchange_data");

392 ià(!
loÿl_d©a
) {

393 
	`_”rÜ
(
lib
, "failedo‡llocate %zd bytes forƒxchange data",

394 
loÿl_d©a_size
 * (
Ãt_size
 + 1));

395 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

396 
”r_loÿl_d©a
;

398 
glob®_d©a
 = 
	`PTR_OFFSET
(
loÿl_d©a
, 
loÿl_d©a_size
);

400 ià(
a2a
->
is_dc
) {

402 
ibv_¤q_š™_©Œ
 
¤q_©Œ
;

403 
	`mem£t
(&
¤q_©Œ
, 0, (
ibv_¤q_š™_©Œ
));

404 
¤q_©Œ
.
©Œ
.
max_wr
 = 1;

405 
¤q_©Œ
.
©Œ
.
max_sge
 = 1;

407 
a2a
->
Ãt
.
¤q
 = 
	`ibv_ü—‹_¤q
(
ùx
->
sh¬ed_pd
, &
¤q_©Œ
);

408 ià(
a2a
->
Ãt
.
¤q
 =ğ
NULL
) {

409 
	`_”rÜ
(
lib
, "failedo create SRQ");

410 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

411 
”r_¤q
;

415 
tx_d•th
 =

416 (
	`SQUARED
(
a2a
->
node
.
sbgp
->
group_size
 / 2 + 1) * 2 + 2) *

417 
MAX_OUTSTANDING_OPS
 *

418 
	`ucc_div_round_up
(
a2a
->
Ãt
.
Ãt_size
,‡2a->
num_dci_qps
);

420 
a2a
->
Ãt
.
dcis
 = 
	`ucc_m®loc
((
ucc__mlx5_dci_t
è*‡2a->
num_dci_qps
);

421 ià(!
a2a
->
Ãt
.
dcis
) {

422 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo‡llocate mem");

423 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

424 
”r_dcis
;

427 
i
 = 0; i < 
a2a
->
num_dci_qps
; i++) {

428 
¡©us
 = 
	`ucc__mlx5_š™_dci
(

429 &
a2a
->
Ãt
.
dcis
[
i
], 
ùx
->
sh¬ed_pd
, ctx->
sh¬ed_ùx
,

430 
a2a
->
Ãt
.
cq
, 
ùx
->
ib_pÜt
, 
tx_d•th
,

431 &
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
qp_cÚf
, 
lib
);

432 ià(
UCC_OK
 !ğ
¡©us
) {

433 
”r_š™_dci
;

438 
¡©us
 = 
	`ucc__mlx5_š™_dù
(

439 
ùx
->
sh¬ed_pd
, ctx->
sh¬ed_ùx
, 
a2a
->
Ãt
.
cq
,‡2a->Ãt.
¤q
,

440 
ùx
->
ib_pÜt
, &
a2a
->
Ãt
.
dù_qp
, 
loÿl_d©a
->
q²
,

441 &
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
qp_cÚf
, 
lib
);

442 ià(
UCC_OK
 !ğ
¡©us
) {

443 
”r_š™_dù
;

446 
a2a
->
Ãt
.
rc_qps
 =

447 
	`ucc_m®loc
((
ucc__mlx5_qp_t
è* 
a2a
->
Ãt
.
Ãt_size
);

448 ià(!
a2a
->
Ãt
.
rc_qps
) {

449 
	`_”rÜ
(
lib
, "failedo‡llocate‡sr qps‡rray");

450 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

451 
”r_®loc_rc_qps
;

453 
tx_d•th
 =

454 (
	`SQUARED
(
a2a
->
node
.
sbgp
->
group_size
 / 2 + 1) * 2 + 2) *

455 
MAX_OUTSTANDING_OPS
;

456 
i
 = 0; i < 
a2a
->
Ãt
.
Ãt_size
; i++) {

457 
¡©us
 = 
	`ucc__mlx5_ü—‹_rc_qp
(

458 
ùx
->
sh¬ed_ùx
, ctx->
sh¬ed_pd
, 
a2a
->
Ãt
.
cq
, 
tx_d•th
,

459 &
a2a
->
Ãt
.
rc_qps
[
i
], &
loÿl_d©a
->
q²
[i], 
lib
);

460 ià(
UCC_OK
 !ğ
¡©us
) {

461 
”r_ü—‹_rc_qps
;

466 
loÿl_d©a
->
pÜt_lid
 = 
pÜt_©Œ
.
lid
;

467 
loÿl_d©a
->
»cv_mkey_rkey
 = 
a2a
->
node
.
‹am_»cv_mkey
->
rkey
;

468 
loÿl_d©a
->
rd
.
‹am_¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

469 
loÿl_d©a
->
rd
.
sbgp_¿nk
 = 
a2a
->
Ãt
.
sbgp
->
group_¿nk
;

470 
loÿl_d©a
->
Ãt_ù¾
.
©omic
.
addr
 = 
a2a
->
Ãt
.©omic.
couÁ”s
;

471 
loÿl_d©a
->
Ãt_ù¾
.
©omic
.
rkey
 = 
a2a
->
Ãt
.©omic.
mr
->rkey;

472 
loÿl_d©a
->
Ãt_ù¾
.
b¬r›r
.
addr
 = 
a2a
->
Ãt
.b¬r›r.
æags
;

473 
loÿl_d©a
->
Ãt_ù¾
.
b¬r›r
.
rkey
 = 
a2a
->
Ãt
.b¬r›r.
mr
->rkey;

474 
¡©us
 = 
	`ucc_£rviû_®lg©h”
(
	`UCC_TL_CORE_TEAM
(
‹am
), 
loÿl_d©a
,

475 
glob®_d©a
, 
loÿl_d©a_size
,

476 
	`ucc_sbgp_to_sub£t
(
a2a
->
Ãt
.
sbgp
),

477 &
‹am
->
scŞl_»q
);

478 ià(
UCC_OK
 !ğ
¡©us
) {

479 
	`_”rÜ
(
lib
, "failed start service‡llgather");

480 
”r_£rviû_®lg©h”_po¡
;

482 
‹am
->
scŞl_»q
->
d©a
 = 
loÿl_d©a
;

483 
a2a
->
¡©e
 = 
TL_MLX5_ALLTOALL_STATE_EXCHANGE_PROGRESS
;

485 
TL_MLX5_ALLTOALL_STATE_EXCHANGE_PROGRESS
:

486 
¡©us
 = 
	`ucc_£rviû_cŞl_‹¡
(
‹am
->
scŞl_»q
);

487 ià(
¡©us
 < 0) {

488 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
),

490 
	`ucc_¡©us_¡ršg
(
¡©us
));

491 
	`ucc_£rviû_cŞl_fš®ize
(
‹am
->
scŞl_»q
);

492 
”r_£rviû_®lg©h”_´og»ss
;

494 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

495  
¡©us
;

497 
	`ucc_as£¹
(
¡©us
 =ğ
UCC_OK
);

498 
a2a
->
¡©e
 = 
TL_MLX5_ALLTOALL_STATE_EXCHANGE_DONE
;

500 
TL_MLX5_ALLTOALL_STATE_EXCHANGE_DONE
:

501 
loÿl_d©a
 = 
‹am
->
scŞl_»q
->
d©a
;

502 
	`ucc_£rviû_cŞl_fš®ize
(
‹am
->
scŞl_»q
);

504 
Ãt_size
 = 
a2a
->
Ãt
.net_size;

505 
loÿl_d©a_size
 = (
Ãt_exchªge_t
);

506 ià(!
a2a
->
is_dc
) {

508 
loÿl_d©a_size
 +ğ(
ušt32_t
è* (
Ãt_size
 - 1);

510 
glob®_d©a
 = 
	`PTR_OFFSET
(
loÿl_d©a
, 
loÿl_d©a_size
);

512 
¡©us
 = 
	`bud_¿nk_m­
(
a2a
, 
glob®_d©a
, 
loÿl_d©a_size
);

513 ià(
¡©us
 !ğ
UCC_OK
) {

514 
	`_”rÜ
(
lib
, "failedo build„ank map");

515 
”r_¿nk_m­
;

517 
a2a
->
Ãt
.
rkeys
 = 
	`ucc_m®loc
((
ušt32_t
è* 
Ãt_size
);

518 ià(!
a2a
->
Ãt
.
rkeys
) {

519 
	`_”rÜ
(
lib
, "failedo‡llocate %zd bytes for‚et„keys",

520 (
ušt32_t
è* 
Ãt_size
);

521 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

522 
”r_rkeys
;

524 ià(
a2a
->
is_dc
) {

525 
a2a
->
Ãt
.
»mÙe_dùns
 = 
	`ucc_m®loc
((
ušt32_t
è* 
Ãt_size
);

526 ià(!
a2a
->
Ãt
.
»mÙe_dùns
) {

527 
	`_”rÜ
(
lib
, "failedo‡llocate %zd bytes for„emote_dctns",

528 (
ušt32_t
è* 
Ãt_size
);

529 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

530 
”r_»mÙe_dùns
;

532 
a2a
->
Ãt
.
ahs
 = 
	`ucc_m®loc
((
ibv_ah
 *è* 
Ãt_size
);

533 ià(!
a2a
->
Ãt
.
ahs
) {

534 
	`_”rÜ
(
lib
, "failedo‡llocate %zd bytes for‚et‡hs",

535 (
ibv_ah
 *è* 
Ãt_size
);

536 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

537 
”r_ahs
;

540 
i
 = 0; i < 
Ãt_size
; i++) {

541 
»mÙe_d©a
 = 
	`PTR_OFFSET
(
glob®_d©a
, 
i
 * 
loÿl_d©a_size
);

542 ià(
a2a
->
is_dc
) {

543 
a2a
->
Ãt
.
»mÙe_dùns
[
i
] = 
»mÙe_d©a
->
q²
[0];

544 
¡©us
 =

545 
	`ucc__mlx5_ü—‹_ah
(
ùx
->
sh¬ed_pd
, 
»mÙe_d©a
->
pÜt_lid
,

546 
ùx
->
ib_pÜt
, &
a2a
->
Ãt
.
ahs
[
i
], 
lib
);

547 ià(
UCC_OK
 !ğ
¡©us
) {

548 
	`_”rÜ
(
lib
, "failedo create‡h, %s",

549 
	`ucc_¡©us_¡ršg
(
¡©us
));

550 
”r_ü—‹_ah
;

553 
¡©us
 = 
	`ucc__mlx5_qp_cÚÃù
(

554 
a2a
->
Ãt
.
rc_qps
[
i
].
qp
,

555 
»mÙe_d©a
->
q²
[
a2a
->
Ãt
.
sbgp
->
group_¿nk
],

556 
»mÙe_d©a
->
pÜt_lid
, 
ùx
->
ib_pÜt
,

557 &
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
qp_cÚf
, 
lib
);

558 ià(
UCC_OK
 !ğ
¡©us
) {

559 
	`_”rÜ
(
lib
, "failedo connect„c qps, %s",

560 
	`ucc_¡©us_¡ršg
(
¡©us
));

561 
”r_qp_cÚÃù
;

564 
a2a
->
Ãt
.
»mÙe_ù¾
[
i
] = 
»mÙe_d©a
->
Ãt_ù¾
;

565 
a2a
->
Ãt
.
rkeys
[
i
] = 
»mÙe_d©a
->
»cv_mkey_rkey
;

568 
a2a
->
©omic_sü©ch_bf_mr
 =

569 
	`ibv_»g_mr
(
ùx
->
sh¬ed_pd
, (*)&
a2a
->
©omic_sü©ch_bf
,

570 (
a2a
->
©omic_sü©ch_bf
),

571 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
);

572 ià(!
a2a
->
©omic_sü©ch_bf_mr
) {

573 
	`_”rÜ
(
lib
, "failedo„egister‡tomic scratch buff (errno=%d)",

574 
”ºo
);

575 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

576 
”r_©omic_©omic_sü©ch_bf_mr
;

580 
umr_buf_size
 = 
	`ucc_®ign_up
(

581 (
mlx5_wqe_umr_»³©_’t_£g
è* (
node_size
 + 1), 64);

582 
»t
 =

583 
	`ucc_posix_mem®ign
(&
a2a
->
node
.
umr_’Œ›s_buf
, 2048, 
umr_buf_size
);

584 ià(
»t
) {

585 
	`_”rÜ
(
lib
,

587 
umr_buf_size
);

588  
UCC_ERR_NO_MEMORY
;

590 
a2a
->
node
.
umr_’Œ›s_mr
 = 
	`ibv_»g_mr
(

591 
ùx
->
sh¬ed_pd
, (*)
a2a
->
node
.
umr_’Œ›s_buf
, 
umr_buf_size
,

592 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
);

593 ià(!
a2a
->
node
.
umr_’Œ›s_mr
) {

594 
	`_”rÜ
(
lib
, "çedØ»gi¡” um¸bufàÓ¼no=%d)", 
”ºo
);

595 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

596 
”r_umr_’Œ›s_mr
;

600  
UCC_OK
;

602 
”r_umr_’Œ›s_mr
:

603 
	`ibv_d”eg_mr
(
a2a
->
©omic_sü©ch_bf_mr
);

604 
”r_©omic_©omic_sü©ch_bf_mr
:

605 ià(
a2a
->
is_dc
) {

606 
”r_ü—‹_ah
:

607 
j
 = 0; j < 
i
 ; j++) {

608 
	`ibv_de¡roy_ah
(
a2a
->
Ãt
.
ahs
[
j
]);

610 
	`ucc_ä“
(
a2a
->
Ãt
.
ahs
);

611 
”r_ahs
:

612 
	`ucc_ä“
(
a2a
->
Ãt
.
»mÙe_dùns
);

614 
”r_qp_cÚÃù
:

615 
”r_»mÙe_dùns
:

616 
	`ucc_ä“
(
a2a
->
Ãt
.
rkeys
);

617 
”r_rkeys
:

618 
	`ucc_ä“
(
a2a
->
Ãt
.
¿nk_m­
);

619 
”r_¿nk_m­
:

620 
”r_£rviû_®lg©h”_´og»ss
:

621 
”r_£rviû_®lg©h”_po¡
:

622 ià(!
a2a
->
is_dc
) {

623 
”r_ü—‹_rc_qps
:

624 
j
 = 0; j < 
i
 ; j++) {

625 
	`ibv_de¡roy_qp
(
a2a
->
Ãt
.
rc_qps
[
j
].
qp
);

627 
	`ucc_ä“
(
a2a
->
Ãt
.
rc_qps
);

629 
	`ibv_de¡roy_qp
(
a2a
->
Ãt
.
dù_qp
);

630 
”r_š™_dù
:

631 
”r_š™_dci
:

632 
j
 = 0; j < 
i
; j++) {

633 
	`ibv_de¡roy_qp
(
a2a
->
Ãt
.
dcis
[
j
].
dci_qp
);

635 
	`ucc_ä“
(
a2a
->
Ãt
.
dcis
);

636 
”r_dcis
:

637 
	`ibv_de¡roy_¤q
(
a2a
->
Ãt
.
¤q
);

639 
”r_®loc_rc_qps
:

640 
”r_¤q
:

641 ià(
loÿl_d©a
) {

642 
	`ucc_ä“
(
loÿl_d©a
);

644 
”r_loÿl_d©a
:

645 
	`ucc__mlx5_de¡roy_mkeys
(
a2a
, 0, 
lib
);

646 
”r_mkeys
:

647 
	`ucc_ä“
(
a2a
->
Ãt
.
»mÙe_ù¾
);

648 
”r_»mÙe_ù¾
:

649 
	`ibv_d”eg_mr
(
a2a
->
Ãt
.
ù¾_mr
);

650 
”r_ù¾_mr
:

651 
	`ibv_de¡roy_cq
(
a2a
->
Ãt
.
cq
);

652 
”r_cq
:

653 
	`ucc__mlx5_de¡roy_umr
(
a2a
, 
lib
);

654 
”r_umr
:

655 
	`ucc_ä“
(
a2a
->
Ãt
.
blocks_£Á
);

656 
”r_blocks_£Á
:

657 
	`ucc__mlx5_®ÉßÎ_b¬r›r_ä“
(
a2a
);

658 
”r_b¬r›r
:

659  
¡©us
;

660 
	}
}

662 
	$ucc__mlx5_®ÉßÎ_ş—nup
(
ucc__mlx5_‹am_t
 *
‹am
)

664 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

665 
ucc_ba£_lib_t
 * 
lib
 = 
	`UCC_TL_TEAM_LIB
(
‹am
);

666 
ucc_¡©us_t
 
¡©us
;

667 
i
;

669 ià(!
a2a
) {

673 ià(-1 =ğ
	`shmdt
(
a2a
->
node
.
¡Üage
)) {

674 
	`_”rÜ
(
lib
, "çedØshmdˆ%p,ƒ¼nØ%d", 
a2a
->
node
.
¡Üage
, 
”ºo
);

676 ià(
a2a
->
node
.
a¤_¿nk
 =ğa2a->node.
sbgp
->
group_¿nk
) {

677 
¡©us
 = 
	`ucc__mlx5_de¡roy_umr
(
a2a
, 
lib
);

678 ià(
¡©us
 !ğ
UCC_OK
) {

679 
	`_”rÜ
(
lib
, "failedo destroy UMR");

681 
	`ibv_d”eg_mr
(
a2a
->
Ãt
.
ù¾_mr
);

682 
	`ucc_ä“
(
a2a
->
Ãt
.
»mÙe_ù¾
);

683 ià(
a2a
->
is_dc
) {

684 
i
 = 0; i < 
a2a
->
num_dci_qps
; i++) {

685 
	`ibv_de¡roy_qp
(
a2a
->
Ãt
.
dcis
[
i
].
dci_qp
);

687 
	`ucc_ä“
(
a2a
->
Ãt
.
dcis
);

688 
	`ibv_de¡roy_qp
(
a2a
->
Ãt
.
dù_qp
);

689 
	`ibv_de¡roy_¤q
(
a2a
->
Ãt
.
¤q
);

690 
i
 = 0; i < 
a2a
->
Ãt
.
Ãt_size
; i++) {

691 
	`ibv_de¡roy_ah
(
a2a
->
Ãt
.
ahs
[
i
]);

694 
i
 = 0; i < 
a2a
->
Ãt
.
Ãt_size
; i++) {

695 
	`ibv_de¡roy_qp
(
a2a
->
Ãt
.
rc_qps
[
i
].
qp
);

698 ià(
a2a
->
is_dc
) {

699 
	`ucc_ä“
(
a2a
->
Ãt
.
»mÙe_dùns
);

700 
	`ucc_ä“
(
a2a
->
Ãt
.
ahs
);

702 
	`ucc_ä“
(
a2a
->
Ãt
.
rc_qps
);

704 ià(
	`ibv_de¡roy_cq
(
a2a
->
Ãt
.
cq
)) {

705 
	`_”rÜ
(
lib
, "Ãˆcq de¡roy faed (”ºo=%d)", 
”ºo
);

708 
¡©us
 = 
	`ucc__mlx5_de¡roy_mkeys
(
a2a
, 0, 
lib
);

709 ià(
¡©us
 !ğ
UCC_OK
) {

710 
	`_”rÜ
(
lib
, "failedo destroy Mkeys");

712 
	`ucc_ä“
(
a2a
->
Ãt
.
rkeys
);

713 
	`ibv_d”eg_mr
(
a2a
->
©omic_sü©ch_bf_mr
);

714 
	`ucc_ä“
(
a2a
->
Ãt
.
¿nk_m­
);

715 
	`ibv_d”eg_mr
(
a2a
->
node
.
umr_’Œ›s_mr
);

716 
	`ucc_ä“
(
a2a
->
node
.
umr_’Œ›s_buf
);

718 
	`ucc_ä“
(
a2a
->
Ãt
.
blocks_£Á
);

719 
	`ucc__mlx5_®ÉßÎ_b¬r›r_ä“
(
a2a
);

721 
	`ucc_ä“
(
a2a
);

722 
	}
}

	@src/components/tl/mlx5/alltoall/alltoall.h

7 #iâdeà
ALLTOALL_H_


8 
	#ALLTOALL_H_


	)

10 
	~"_mlx5.h
"

11 
	~"_mlx5_ib.h
"

12 
	~"_mlx5_dm.h
"

14 
	#SEQ_INDEX
(
_£q_num
è((_£q_numè% 
MAX_OUTSTANDING_OPS
)

	)

16 
	#MLX5_ASR_RANK
 0

17 
	#MLX5_NUM_OF_BLOCKS_SIZE_BINS
 8

	)

18 
	#MAX_TRANSPOSE_SIZE
 8192

19 
	#MAX_MSG_SIZE
 128

20 
	#MAX_BLOCK_SIZE
 64

21 
	#MAX_OUTSTANDING_OPS
 1

22 
	#MIN_POLL_WC
 8

	)

24 
ušt64_t
 
	t_mlx5_©omic_t
;

25 
ušt64_t
 
	t_mlx5_b¬r›r_t
;

29 
	mUCC_MLX5_NEED_SEND_MKEY_UPDATE
 = 
UCC_BIT
(1),

30 
	mUCC_MLX5_NEED_RECV_MKEY_UPDATE
 = 
UCC_BIT
(2),

33 
	succ__mlx5_®ÉßÎ_ù¾
 {

36 vŞ©
	m£q_num
;

37 
	mmkey_ÿche_æag
;

39 
	mtmp
[
UCC_CACHE_LINE_SIZE
];

41 } 
	tucc__mlx5_®ÉßÎ_ù¾_t
;

43 
	succ__mlx5_®ÉßÎ_İ
 {

44 
ucc__mlx5_®ÉßÎ_ù¾_t
 *
	mù¾
;

45 
ucc__mlx5_®ÉßÎ_ù¾_t
 *
	mmy_ù¾
;

46 
mlx5dv_mkey
 ** 
	m£nd_mkeys
;

47 
mlx5dv_mkey
 ** 
	m»cv_mkeys
;

48 * 
	mblocks_£Á
;

49 } 
	tucc__mlx5_®ÉßÎ_İ_t
;

53 
	succ__mlx5_®ÉßÎ_node
 {

54 
	ma¤_¿nk
;

55 
ucc_sbgp_t
 *
	msbgp
;

56 *
	m¡Üage
;

57 
ucc__mlx5_®ÉßÎ_İ_t
 
	mİs
[
MAX_OUTSTANDING_OPS
];

58 
mlx5dv_mkey
 *
	m‹am_»cv_mkey
;

59 *
	mumr_’Œ›s_buf
;

60 
ibv_mr
 *
	mumr_’Œ›s_mr
;

61 } 
	tucc__mlx5_®ÉßÎ_node_t
;

63 
	s®ÉßÎ_Ãt_ù¾
 {

65 *
	maddr
;

66 
ušt32_t
 
	mrkey
;

67 } 
	m©omic
;

69 *
	maddr
;

70 
ušt32_t
 
	mrkey
;

71 } 
	mb¬r›r
;

72 } 
	t®ÉßÎ_Ãt_ù¾_t
;

74 
	succ__mlx5_®ÉßÎ_Ãt
 {

75 
ucc_sbgp_t
 *
	msbgp
;

76 
	mÃt_size
;

77 *
	m¿nk_m­
;

78 
ucc__mlx5_qp_t
 *
	mrc_qps
;

79 
ibv_qp
 *
	mdù_qp
;

80 
ibv_¤q
 *
	m¤q
;

81 
ušt32_t
 *
	m»mÙe_dùns
;

82 
ibv_ah
 **
	mahs
;

83 
ibv_cq
 *
	mcq
;

84 
ibv_cq
 *
	mumr_cq
;

85 
ibv_qp
 *
	mumr_qp
;

86 
ibv_mr
 *
	mù¾_mr
;

88 #ià
ATOMIC_IN_MEMIC


89 
ibv_dm
 *
	mcouÁ”s
;

91 
_mlx5_©omic_t
 *
	mcouÁ”s
;

93 
ibv_mr
 *
	mmr
;

94 } 
	m©omic
;

96 
_mlx5_b¬r›r_t
 *
	mæags
;

97 
ibv_mr
 *
	mmr
;

98 } 
	mb¬r›r
;

99 *
	mblocks_£Á
;

100 
®ÉßÎ_Ãt_ù¾_t
 *
	m»mÙe_ù¾
;

101 
ušt32_t
 *
	mrkeys
;

102 
ucc__mlx5_dci_t
 *
	mdcis
;

103 } 
	tucc__mlx5_®ÉßÎ_Ãt_t
;

105 
	succ__mlx5_a2a_bÿ¡_d©a
 {

106 
	mshmid
;

107 
	mÃt_size
;

108 } 
	tucc__mlx5_a2a_bÿ¡_d©a_t
;

112 
	mTL_MLX5_ALLTOALL_STATE_SHMID
,

113 
	mTL_MLX5_ALLTOALL_STATE_EXCHANGE_PROGRESS
,

114 
	mTL_MLX5_ALLTOALL_STATE_EXCHANGE_DONE


117 
	succ__mlx5_®ÉßÎ
 {

118 
ibv_pd
 *
	mpd
;

119 
ibv_cÚ‹xt
 *
	mùx
;

120 
	mib_pÜt
;

121 
	m¡©e
;

122 
ušt64_t
 
	mmax_msg_size
;

123 
ucc__mlx5_®ÉßÎ_node_t
 
	mnode
;

124 
ucc__mlx5_®ÉßÎ_Ãt_t
 
	mÃt
;

125 
	m£qu’û_numb”
;

126 
	mİ_busy
[
MAX_OUTSTANDING_OPS
];

127 
	mnum_dci_qps
;

128 
ušt8_t
 
	mis_dc
;

129 
	m´evious_msg_size
[
MAX_OUTSTANDING_OPS
];

130 *
	m´evious_£nd_add»ss
[
MAX_OUTSTANDING_OPS
];

131 *
	m´evious_»cv_add»ss
[
MAX_OUTSTANDING_OPS
];

132 
ušt64_t
 
	m©omic_sü©ch_bf
;

133 
	m»que¡ed_block_size
;

134 
	mmax_num_of_cŞumns
;

135 
ibv_mr
 *
	m©omic_sü©ch_bf_mr
;

136 
ucc_¿nk_t
 
	mnode_size
;

137 
ucc__mlx5_a2a_bÿ¡_d©a_t
 
	mbÿ¡_d©a
;

138 } 
	tucc__mlx5_®ÉßÎ_t
;

140 
ucc__mlx5_tİo_ş—nup
(
ucc__mlx5_‹am_t
 *
‹am
);

141 
ucc_¡©us_t
 
ucc__mlx5_‹am_š™_®ÉßÎ
(
ucc__mlx5_‹am_t
 *
‹am
);

142 
ucc_¡©us_t
 
ucc__mlx5_‹am_‹¡_®ÉßÎ_¡¬t
(
ucc__mlx5_‹am_t
 *
‹am
);

143 
ucc_¡©us_t
 
ucc__mlx5_‹am_‹¡_®ÉßÎ_´og»ss
(
ucc__mlx5_‹am_t
 *
‹am
);

144 
ucc_¡©us_t
 
ucc__mlx5_®ÉßÎ_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

145 
ucc_ba£_‹am_t
 * 
‹am
,

146 
ucc_cŞl_sk_t
 ** 
sk_h
);

147 
ucc__mlx5_®ÉßÎ_ş—nup
(
ucc__mlx5_‹am_t
 *
‹am
);

149 
šlše
 
ucc__mlx5_®ÉßÎ_ù¾_t
*

150 
	$ucc__mlx5_g‘_ù¾
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
, 
İ_šdex
, 
¿nk
)

152 
ucc__mlx5_®ÉßÎ_ù¾_t
 *
ù¾
 =

153 
	`PTR_OFFSET
(
a2a
->
node
.
İs
[
İ_šdex
].
ù¾
,

154 (
ucc__mlx5_®ÉßÎ_ù¾_t
è* 
¿nk
);

155  
ù¾
;

156 
	}
}

158 
šlše
 
ucc__mlx5_®ÉßÎ_ù¾_t
*

159 
	$ucc__mlx5_g‘_my_ù¾
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
, 
İ_šdex
)

161 
my_¿nk
 = 
a2a
->
node
.
sbgp
->
group_¿nk
;

163  
	`ucc__mlx5_g‘_ù¾
(
a2a
, 
İ_šdex
, 
my_¿nk
);

164 
	}
}

166 
	#OP_SEGMENT_SIZE
(
_a2a
) \

167 ((
ucc__mlx5_®ÉßÎ_ù¾_t
è* (
_a2a
)->
node_size
 + \

168 ((
umr_t
è* (
_a2a
)->
max_num_of_cŞumns
 * (_a2a)->
node_size
è* 2)

	)

170 
	#UMR_DATA_OFFSET
(
_a2a
) \

171 ((
ucc__mlx5_®ÉßÎ_ù¾_t
è* (
_a2a
)->
node_size
)

	)

173 
	#OP_SEGMENT_STORAGE
(
_»q
, 
_a2a
) \

174 
	`PTR_OFFSET
((
_a2a
)->
node
.
¡Üage
, \

175 
	`OP_SEGMENT_SIZE
(
_a2a
è* (
_»q
)->
®ÉßÎ
.
£q_šdex
)

	)

177 
	#OP_UMR_DATA
(
_»q
, 
_a2a
) \

178 
	`PTR_OFFSET
(
	`OP_SEGMENT_STORAGE
(
_»q
, 
_a2a
), 
	`UMR_DATA_OFFSET
(_a2a))

	)

180 
	#SEND_UMR_DATA
(
_»q
, 
_a2a
, 
_cŞ
) \

181 
	`PTR_OFFSET
(
	`OP_UMR_DATA
(
_»q
, 
_a2a
), \

182 
_cŞ
 *(
_a2a
)->
node
.
sbgp
->
group_size
 * (
umr_t
))

	)

184 
	#RECV_UMR_DATA
(
_»q
, 
_a2a
, 
_cŞ
) \

185 
	`PTR_OFFSET
(
	`OP_UMR_DATA
(
_»q
, 
_a2a
), \

186 (
_a2a
)->
max_num_of_cŞumns
 *(_a2a)->
node
.
sbgp
->
group_size
 * \

187 (
umr_t
) + \

188 
_cŞ
 * (
_a2a
)->
node
.
sbgp
->
group_size
 * (
umr_t
))

	)

190 
	#MY_SEND_UMR_DATA
(
_»q
, 
_a2a
, 
_cŞ
) \

191 
	`PTR_OFFSET
(
	`SEND_UMR_DATA
(
_»q
, 
_a2a
, 
_cŞ
), \

192 (
_a2a
)->
node
.
sbgp
->
group_¿nk
 * (
umr_t
))

	)

194 
	#MY_RECV_UMR_DATA
(
_»q
, 
_a2a
, 
_cŞ
) \

195 
	`PTR_OFFSET
(
	`RECV_UMR_DATA
(
_»q
, 
_a2a
, 
_cŞ
), \

196 (
_a2a
)->
node
.
sbgp
->
group_¿nk
 * (
umr_t
))

	)

	@src/components/tl/mlx5/alltoall/alltoall_coll.c

7 
	~"_mlx5_cŞl.h
"

8 
	~"®ÉßÎ/®ÉßÎ.h
"

9 
	~"®ÉßÎ/®ÉßÎ_mkeys.h
"

10 
	~"®ÉßÎ/®ÉßÎ_šlše.h
"

12 
	~"compÚ’ts/mc/ucc_mc.h
"

13 
	~"cÜe/ucc_‹am.h
"

14 
	~"_mlx5_wqe.h
"

15 
	~"_mlx5_ib.h
"

17 
ucc_¡©us_t


18 
	$ucc__mlx5_pŞl_ä“_İ_¦Ù_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

20 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

21 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

22 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

23 
£q_šdex
 = 
sk
->
®ÉßÎ
.seq_index;

25 ià(
a2a
->
İ_busy
[
£q_šdex
] && !
sk
->
®ÉßÎ
.
¡¬‹d
) {

26 
	`_debug
(

27 
	`UCC_TL_TEAM_LIB
(
‹am
),

29 
sk
->
®ÉßÎ
.
£q_num
);

32 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

33 
cŞl_sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

34 
	`ucc_´og»ss_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, 
cŞl_sk
);

35  
UCC_OK
;

36 
	}
}

38 
	$ucc__mlx5_pŞl_ä“_İ_¦Ù_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

40 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

41 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

42 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

43 
£q_šdex
 = 
sk
->
®ÉßÎ
.seq_index;

45 ià(
a2a
->
İ_busy
[
£q_šdex
] && !
sk
->
®ÉßÎ
.
¡¬‹d
) {

46 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

49 
a2a
->
İ_busy
[
£q_šdex
] = 1;

50 
sk
->
®ÉßÎ
.
¡¬‹d
 = 1;

51 
cŞl_sk
->
¡©us
 = 
UCC_OK
;

52 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "Operation‚um %d started",

53 
sk
->
®ÉßÎ
.
£q_num
);

54 
	}
}

56 
ucc_¡©us_t
 
	$ucc__mlx5_pŞl_cq
(
ibv_cq
 *
cq
, 
ucc_ba£_lib_t
 *
lib
)

58 
i
, 
com¶‘iÚs_num
;

59 
ibv_wc
 
wcs
[
MIN_POLL_WC
];

61 
com¶‘iÚs_num
 = 
	`ibv_pŞl_cq
(
cq
, 
MIN_POLL_WC
, 
wcs
);

62 ià(
com¶‘iÚs_num
 < 0) {

63 
	`_”rÜ
(
lib
, "ibv_pŞl_cq(èçed,ƒ¼nØ%d", 
”ºo
);

64  
UCC_ERR_NO_MESSAGE
;

66 
i
 = 0; i < 
com¶‘iÚs_num
; i++) {

67 ià(
wcs
[
i
].
¡©us
 !ğ
IBV_WC_SUCCESS
) {

68 
	`_”rÜ
(
lib
, "bad work completion status %s, wr_id %zu",

69 
	`ibv_wc_¡©us_¡r
(
wcs
[
i
].
¡©us
), wcs[i].
wr_id
);

70  
UCC_ERR_NO_MESSAGE
;

73 
	`ucc_as£¹
(
wcs
[
i
].
İcode
 =ğ
IBV_WC_DRIVER2
);

74 ià(
wcs
[
i
].
wr_id
 == 0) {

77 } ià(
wcs
[
i
].
wr_id
 & 0x1) {

78 
ucc__mlx5_scheduË_t
 *
sk
 =

79 (
ucc__mlx5_scheduË_t
 *)(
ušŒ_t
)(
wcs
[
i
].
wr_id
 &

80 (~(
ušt64_t
)0x1));

81 
sk
->
®ÉßÎ
.
wa™_wc
 = 1;

83 
ucc__mlx5_dm_chunk_t
 *
dm
 = (ucc__mlx5_dm_chunk_ˆ*)
wcs
[
i
].
wr_id
;

84 
dm
->
sk
->
®ÉßÎ
.
blocks_com¶‘ed
++;

85 
dm
->
com¶‘ed_£nds
++;

86 ià(
dm
->
po¡ed_®l
 && dm->
com¶‘ed_£nds
 =ğdm->
po¡ed_£nds
) {

87 
	`ucc_mpoŞ_put
(
dm
);

91  
UCC_OK
;

92 
	}
}

94 
ucc_¡©us_t
 
	$ucc__mlx5_node_çnš
(
ucc__mlx5_‹am_t
 *
‹am
,

95 
ucc__mlx5_scheduË_t
 *
sk
)

97 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

98 
£q_šdex
 = 
sk
->
®ÉßÎ
.seq_index;

99 
i
;

100 
ucc__mlx5_®ÉßÎ_ù¾_t
 *
ù¾_v
;

102 ià(
a2a
->
node
.
sbgp
->
group_¿nk
 !ğa2a->node.
a¤_¿nk
) {

103 
	`ucc__mlx5_g‘_my_ù¾
(
a2a
, 
£q_šdex
)->
£q_num
 =

104 
sk
->
®ÉßÎ
.
£q_num
;

106 
i
 = 0; i < 
a2a
->
node
.
sbgp
->
group_size
; i++) {

107 ià(
i
 =ğ
a2a
->
node
.
sbgp
->
group_¿nk
) {

110 
ù¾_v
 = 
	`ucc__mlx5_g‘_ù¾
(
a2a
, 
£q_šdex
, 
i
);

111 ià(
ù¾_v
->
£q_num
 !ğ
sk
->
®ÉßÎ
.seq_num) {

112  
UCC_INPROGRESS
;

115 
i
 = 0; i < 
a2a
->
node
.
sbgp
->
group_size
; i++) {

116 ià(
i
 =ğ
a2a
->
node
.
sbgp
->
group_¿nk
) {

119 
ù¾_v
 = 
	`ucc__mlx5_g‘_ù¾
(
a2a
, 
£q_šdex
, 
i
);

120 
	`ucc__mlx5_g‘_my_ù¾
(
a2a
, 
£q_šdex
)->
mkey_ÿche_æag
 |=

121 
ù¾_v
->
mkey_ÿche_æag
;

124 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
, "mlx5_alltoall_fanin_done", 0);

125  
UCC_OK
;

126 
	}
}

131 
ucc_¡©us_t
 
	$ucc__mlx5_»g_çnš_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

133 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

134 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

135 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
‹am
);

136 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

137 
»g_chªge_æag
 = 0;

138 
£q_šdex
 = 
sk
->
®ÉßÎ
.seq_index;

139 
æag
;

140 
ucc__mlx5_rÿche_»giÚ_t
 *
£nd_±r
;

141 
ucc__mlx5_rÿche_»giÚ_t
 *
»cv_±r
;

143 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
, "mlx5_alltoall_fanin_start", 0);

144 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "register memory buffers");

145 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

146 
cŞl_sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

148 
”ºo
 = 0;

149 ià(
UCC_OK
 !=

150 
	`ucc_rÿche_g‘
(
ùx
->
rÿche
, (*)
	`SCHEDULE_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
,

151 
sk
->
®ÉßÎ
.
msg_size
 * 
	`UCC_TL_TEAM_SIZE
(
‹am
),

152 &
»g_chªge_æag
, (
ucc_rÿche_»giÚ_t
 **)&
£nd_±r
)) {

153 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

154 "FaedØ»gi¡” s’d_bàmemÜy (”ºo=%d)", 
”ºo
);

155  
UCC_ERR_NO_RESOURCE
;

157 
sk
->
®ÉßÎ
.
£nd_rÿche_»giÚ_p
 = 
£nd_±r
;

163 
æag
 =

164 (
sk
->
®ÉßÎ
.
msg_size
 =ğ
a2a
->
´evious_msg_size
[
£q_šdex
])

166 : (
UCC_MLX5_NEED_SEND_MKEY_UPDATE
 | 
UCC_MLX5_NEED_RECV_MKEY_UPDATE
);

168 ià(
»g_chªge_æag
 || (
sk
->
®ÉßÎ
.
£nd_rÿche_»giÚ_p
->
»g
.
mr
->
addr
 !=

169 
a2a
->
´evious_£nd_add»ss
[
£q_šdex
])) {

170 
æag
 |ğ
UCC_MLX5_NEED_SEND_MKEY_UPDATE
;

172 
»g_chªge_æag
 = 0;

173 ià(
UCC_OK
 !=

174 
	`ucc_rÿche_g‘
(
ùx
->
rÿche
, (*)
	`SCHEDULE_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
,

175 
sk
->
®ÉßÎ
.
msg_size
 * 
	`UCC_TL_TEAM_SIZE
(
‹am
),

176 &
»g_chªge_æag
, (
ucc_rÿche_»giÚ_t
 **)&
»cv_±r
)) {

177 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "Failedo„egister„eceive_bf memory");

178 
	`ucc_rÿche_»giÚ_put
(
ùx
->
rÿche
,

179 &
sk
->
®ÉßÎ
.
£nd_rÿche_»giÚ_p
->
su³r
);

180  
UCC_ERR_NO_RESOURCE
;

182 
sk
->
®ÉßÎ
.
»cv_rÿche_»giÚ_p
 = 
»cv_±r
;

183 ià(
»g_chªge_æag
 || (
sk
->
®ÉßÎ
.
»cv_rÿche_»giÚ_p
->
»g
.
mr
->
addr
 !=

184 
a2a
->
´evious_»cv_add»ss
[
£q_šdex
])) {

185 
æag
 |ğ
UCC_MLX5_NEED_RECV_MKEY_UPDATE
;

188 
	`_debug
(
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
), "fanin start");

191 
	`ucc__mlx5_g‘_my_ù¾
(
a2a
, 
£q_šdex
)->
mkey_ÿche_æag
 = 
æag
;

192 
	`ucc__mlx5_upd©e_mkeys_’Œ›s
(
a2a
, 
sk
, 
æag
);

194 ià(
UCC_OK
 =ğ
	`ucc__mlx5_node_çnš
(
‹am
, 
sk
)) {

195 
	`_debug
(
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
), "fanin complete");

196 
cŞl_sk
->
¡©us
 = 
UCC_OK
;

197 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
, "mlx5_alltoall_fanin_done", 0);

198  
	`ucc_sk_com¶‘e
(
cŞl_sk
);

201 
	`ucc_´og»ss_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, 
cŞl_sk
);

202  
UCC_OK
;

203 
	}
}

205 
	$ucc__mlx5_»g_çnš_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

207 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

208 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

210 
	`ucc_as£¹
(
‹am
->
a2a
->
node
.
sbgp
->
group_¿nk
 =ğ‹am->a2a->node.
a¤_¿nk
);

211 ià(
UCC_OK
 =ğ
	`ucc__mlx5_node_çnš
(
‹am
, 
sk
)) {

212 
	`_debug
(
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
), "fanin complete");

213 
cŞl_sk
->
¡©us
 = 
UCC_OK
;

215 
	}
}

217 
ucc_¡©us_t
 
	$ucc__mlx5_node_çnout
(
ucc__mlx5_‹am_t
 *
‹am
,

218 
ucc__mlx5_scheduË_t
 *
sk
)

220 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

221 
ucc__mlx5_®ÉßÎ_ù¾_t
 *
ù¾_v
;

224 ià(
a2a
->
node
.
sbgp
->
group_¿nk
 =ğa2a->node.
a¤_¿nk
) {

226 
	`ucc__mlx5_g‘_my_ù¾
(
a2a
, 
sk
->
®ÉßÎ
.
£q_šdex
)->
£q_num
 =

227 
sk
->
®ÉßÎ
.
£q_num
;

229 
ù¾_v
 = 
	`ucc__mlx5_g‘_ù¾
(
a2a
, 
sk
->
®ÉßÎ
.
£q_šdex
,

230 
a2a
->
node
.
a¤_¿nk
);

231 ià(
ù¾_v
->
£q_num
 !ğ
sk
->
®ÉßÎ
.seq_num) {

232  
UCC_INPROGRESS
;

235  
UCC_OK
;

236 
	}
}

238 
ucc_¡©us_t
 
	$ucc__mlx5_çnout_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

240 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

241 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

243 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

244 
cŞl_sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

246 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "fanout start");

248 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
, "mlx5_alltoall_fanout_start", 0);

249 ià(
‹am
->
a2a
->
node
.
sbgp
->
group_¿nk
 =ğ‹am->a2a->node.
a¤_¿nk
) {

250 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(

251 
sk
, "mlx5_alltoall_wait-on-data_start", 0);

254 
	`ucc_´og»ss_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, 
cŞl_sk
);

255  
UCC_OK
;

256 
	}
}

258 
	$ucc__mlx5_çnout_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

260 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

261 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

262 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

263 
ucc_¡©us_t
 
¡©us
;

265 ià(
a2a
->
node
.
sbgp
->
group_¿nk
 =ğa2a->node.
a¤_¿nk
) {

266 
¡©us
 = 
	`ucc__mlx5_pŞl_cq
(
a2a
->
Ãt
.
umr_cq
, 
	`UCC_TASK_LIB
(
sk
));

267 ià(
UCC_OK
 !ğ
¡©us
) {

268 
cŞl_sk
->
¡©us
 = status;

271 ià(!
sk
->
®ÉßÎ
.
wa™_wc
) {

272 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

275 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(

276 
sk
, "mlx5_alltoall_wait-on-data_complete, fanout_start", 0);

279 ià(
UCC_OK
 =ğ
	`ucc__mlx5_node_çnout
(
‹am
, 
sk
)) {

281 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "Algorithm completion");

282 
a2a
->
İ_busy
[
sk
->
®ÉßÎ
.
£q_šdex
] = 0;

283 
cŞl_sk
->
¡©us
 = 
UCC_OK
;

284 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
, "mlx5_alltoall_fanout_done", 0);

286 
	}
}

288 
ucc_¡©us_t
 
	$ucc__mlx5_a¤_b¬r›r_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

290 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

291 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

292 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

293 
_mlx5_b¬r›r_t
 *
loÿl
 = 
	`_mlx5_b¬r›r_loÿl_addr
(
sk
);

294 
ucc_¡©us_t
 
¡©us
;

295 
i
;

297 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

298 
cŞl_sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

300 
sk
->
®ÉßÎ
.
¡¬‹d
 = 0;

301 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
, "mlx5_alltoall_barrier_start", 0);

304 
	`ucc__mlx5_pİuÏ‹_£nd_»cv_mkeys
(
‹am
, 
sk
);

307 #ià
ATOMIC_IN_MEMIC


308 
_mlx5_©omic_t
 
z”o
 = 0;

310 
	`ibv_memıy_to_dm
(
a2a
->
Ãt
.
©omic
.
couÁ”s
,

311 
sk
->
®ÉßÎ
.
£q_šdex
 * (
_mlx5_©omic_t
),

312 &
z”o
, (
_mlx5_©omic_t
))) {

313 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo„eset‡tomic in memic");

314  
UCC_ERR_NO_MESSAGE
;

317 
a2a
->
Ãt
.
©omic
.
couÁ”s
[
sk
->
®ÉßÎ
.
£q_šdex
] = 0;

319 ià(
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
a¤_b¬r›r
) {

320 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "asr barrier start");

321 
¡©us
 = 
	`ucc_£rviû_®Ìeduû
(

322 
	`UCC_TL_CORE_TEAM
(
‹am
), &
sk
->
®ÉßÎ
.
b¬r›r_sü©ch
[0],

323 &
sk
->
®ÉßÎ
.
b¬r›r_sü©ch
[1], 
UCC_DT_INT32
, 1, 
UCC_OP_SUM
,

324 
	`ucc_sbgp_to_sub£t
(
a2a
->
Ãt
.
sbgp
), &
sk
->
®ÉßÎ
.
b¬r›r_»q
);

325 ià(
¡©us
 < 0) {

326 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo start‡sr barrier");

328 
i
 = 0; i < 
a2a
->
Ãt
.
Ãt_size
; i++) {

329 
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
i
] = 0;

330 
a2a
->
Ãt
.
b¬r›r


331 .
æags
[(
a2a
->
Ãt
.
Ãt_size
 + 1è* 
sk
->
®ÉßÎ
.
£q_šdex
 + 
i
] =

332 
sk
->
®ÉßÎ
.
£q_num
;

334 
	`ucc_´og»ss_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, 
cŞl_sk
);

336 *
loÿl
 = 
sk
->
®ÉßÎ
.
£q_num
;

337 
i
 = 0; i < 
a2a
->
Ãt
.
Ãt_size
; i++) {

338 
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
i
] = 0;

339 ià(
i
 =ğ
a2a
->
Ãt
.
sbgp
->
group_¿nk
) {

340 
	`_mlx5_b¬r›r_æag_£t
(
sk
, 
i
);

344 
	`£nd_¡¬t
(
‹am
, 
i
);

345 
¡©us
 = 
	`£nd_block_d©a
(

346 
a2a
, 
i
, (
ušŒ_t
)
loÿl
, (
_mlx5_b¬r›r_t
),

347 
a2a
->
Ãt
.
b¬r›r
.
mr
->
lkey
,

348 
	`_mlx5_b¬r›r_my_»mÙe_addr
(
sk
, 
i
),

349 
	`_mlx5_b¬r›r_»mÙe_rkey
(
sk
, 
i
), 0, 
NULL
);

350 ià(
UCC_OK
 =ğ
¡©us
) {

351 
¡©us
 = 
	`£nd_dÚe
(
‹am
, 
i
);

353 ià(
¡©us
 !ğ
UCC_OK
) {

354 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failed sending barrier‚otice");

355  
¡©us
;

357 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(

358 
sk
, "mlx5_alltoall_barrier_send_posted", 0);

360 
cŞl_sk
->
¡©us
 = 
UCC_OK
;

361 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
, "mlx5_alltoall_barrier_done",

363  
	`ucc_sk_com¶‘e
(
cŞl_sk
);

365  
UCC_OK
;

366 
	}
}

368 
	$ucc__mlx5_a¤_b¬r›r_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

370 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

371 
ucc_¡©us_t
 
¡©us
;

373 
¡©us
 = 
	`ucc_cŞËùive_‹¡
(&
sk
->
®ÉßÎ
.
b¬r›r_»q
->sk->
su³r
);

374 ià(
¡©us
 < 0) {

375 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure during‡sr barrier");

376 } ià(
UCC_OK
 =ğ
¡©us
) {

377 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "asr barrier done");

378 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
, "mlx5_alltoall_barreir_done",

380 
	`ucc_£rviû_cŞl_fš®ize
(
sk
->
®ÉßÎ
.
b¬r›r_»q
);

381 
cŞl_sk
->
¡©us
 = 
UCC_OK
;

383 
	}
}

385 
ucc__mlx5_dm_chunk_t
 *

386 
	$ucc__mlx5_a2a_wa™_fÜ_dm_chunk
(
ucc__mlx5_scheduË_t
 *
sk
)

388 
ucc_ba£_lib_t
 *
lib
 = 
	`UCC_TASK_LIB
(
sk
);

389 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(&
sk
->
su³r
);

390 
ucc__mlx5_dm_chunk_t
 *
dm
 = 
NULL
;

392 
dm
 = 
	`ucc_mpoŞ_g‘
(&
‹am
->
dm_poŞ
);

393 !
dm
) {

394 ià(
UCC_OK
 !ğ
	`ucc__mlx5_pŞl_cq
(
‹am
->
a2a
->
Ãt
.
cq
, 
lib
)) {

395  
NULL
;

397 
dm
 = 
	`ucc_mpoŞ_g‘
(&
‹am
->
dm_poŞ
);

399 
dm
->
sk
 =ask;

401  
dm
;

402 
	}
}

405 
ucc_¡©us_t
 
	$ucc__mlx5_£nd_blocks_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

407 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

408 
ucc_ba£_lib_t
 * 
lib
 = 
	`UCC_TASK_LIB
(
sk
);

409 
ucc__mlx5_‹am_t
 * 
‹am
 = 
	`TASK_TEAM
(&
sk
->
su³r
);

410 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

411 
ucc_¿nk_t
 
node_size
 = 
a2a
->
node
.
sbgp
->
group_size
;

412 
ucc_¿nk_t
 
Ãt_size
 = 
a2a
->
Ãt
.
sbgp
->
group_size
;

413 
size_t
 
İ_msgsize
 = 
node_size
 * 
a2a
->
max_msg_size
 * 
	`UCC_TL_TEAM_SIZE
(
‹am
) *

414 
a2a
->
max_num_of_cŞumns
;

415 
size_t
 
node_msgsize
 = 
	`SQUARED
(
node_size
è* 
sk
->
®ÉßÎ
.
msg_size
;

416 
block_h
 = 
sk
->
®ÉßÎ
.
block_height
;

417 
block_w
 = 
sk
->
®ÉßÎ
.
block_width
;

418 
size_t
 
cŞ_msgsize
 = 
sk
->
®ÉßÎ
.
msg_size
 * 
block_w
 * 
node_size
;

419 
size_t
 
lše_msgsize
 = 
sk
->
®ÉßÎ
.
msg_size
 * 
block_h
 * 
node_size
;

420 
size_t
 
block_msgsize
 = 
block_h
 * 
block_w
 * 
sk
->
®ÉßÎ
.
msg_size
;

421 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

422 
node_grid_w
 = 
node_size
 / 
block_w
;

423 
node_nbr_blocks
 = (
node_size
 *‚ode_sizeè/ (
block_h
 * 
block_w
);

424 
£q_šdex
 = 
sk
->
®ÉßÎ
.seq_index;

425 
block_row
 = 0;

426 
block_cŞ
 = 0;

427 
ušt64_t
 
»mÙe_addr
 = 0;

428 
ucc__mlx5_dm_chunk_t
 *
dm
 = 
NULL
;

429 
b©ch_size
 = 
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
block_b©ch_size
;

430 
num_£rŸlized_b©ches
 =

431 
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
num_£rŸlized_b©ches
;

432 
num_b©ches_³r_·s§ge
 =

433 
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
num_b©ches_³r_·s§ge
;

434 
i
, 
j
, 
k
, 
£nd_to_£lf
, 
block_idx
, 
¿nk
, 
de¡_¿nk
, 
cyc_¿nk
, 
node_idx
;

435 
ušt64_t
 
¤c_addr
;

437 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

438 
cŞl_sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

440 
	`_debug
(
lib
, "send blocks start");

441 
¿nk
 = 
a2a
->
Ãt
.
¿nk_m­
[a2a->Ãt.
sbgp
->
group_¿nk
];

442 ià(!
sk
->
®ÉßÎ
.
£nd_blocks_’queued
) {

443 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
,

447 
j
 = 0; j < 
num_b©ches_³r_·s§ge
; j++) {

448 
node_idx
 = 0;‚ode_idx < 
Ãt_size
;‚ode_idx++) {

449 
cyc_¿nk
 = (
node_idx
 + 
a2a
->
Ãt
.
sbgp
->
group_¿nk
è% 
Ãt_size
;

450 
de¡_¿nk
 = 
a2a
->
Ãt
.
¿nk_m­
[
cyc_¿nk
];

451 
£nd_to_£lf
 = (
cyc_¿nk
 =ğ
a2a
->
Ãt
.
sbgp
->
group_¿nk
);

452 ià(
	`_mlx5_b¬r›r_æag
(
sk
, 
cyc_¿nk
) !=

453 
sk
->
®ÉßÎ
.
£q_num
) {

456 
dm
 = 
NULL
;

457 ià(!
£nd_to_£lf
 &&

458 
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
cyc_¿nk
] < 
node_nbr_blocks
) {

459 
dm
 = 
	`ucc__mlx5_a2a_wa™_fÜ_dm_chunk
(
sk
);

461 
	`£nd_¡¬t
(
‹am
, 
cyc_¿nk
);

462 
i
 = 0; i < 
num_£rŸlized_b©ches
; i++) {

463 
k
 = 0;

464 
k
 < 
b©ch_size
 &&

465 
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
cyc_¿nk
] < 
node_nbr_blocks
;

466 
k
++, 
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
cyc_¿nk
]++) {

467 
block_idx
 = 
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
cyc_¿nk
];

468 
block_cŞ
 = 
block_idx
 % 
node_grid_w
;

469 
block_row
 = 
block_idx
 / 
node_grid_w
;

470 
¤c_addr
 = (
ušŒ_t
)(

471 
İ_msgsize
 * 
£q_šdex
 + 
node_msgsize
 * 
de¡_¿nk
 +

472 
cŞ_msgsize
 * 
block_cŞ
 + 
block_msgsize
 * 
block_row
);

473 ià(
£nd_to_£lf
 || !
k
) {

474 
»mÙe_addr
 = (
ušŒ_t
)(
İ_msgsize
 * 
£q_šdex
 +

475 
node_msgsize
 * 
¿nk
 +

476 
block_msgsize
 * 
block_cŞ
 +

477 
lše_msgsize
 * 
block_row
);

479 ià(
£nd_to_£lf
) {

480 
¡©us
 = 
	`ucc__mlx5_po¡_Œª¥o£
(

481 
	`_mlx5_g‘_qp
(
a2a
, 
cyc_¿nk
),

482 
a2a
->
node
.
İs
[
£q_šdex
].
£nd_mkeys
[0]->
lkey
,

483 
a2a
->
Ãt
.
rkeys
[
cyc_¿nk
], 
¤c_addr
, 
»mÙe_addr
,

484 
sk
->
®ÉßÎ
.
msg_size
, 
block_w
, 
block_h
,

485 (
block_row
 =ğ0 && 
block_cŞ
 == 0)

486 ? 
IBV_SEND_SIGNALED


488 ià(
UCC_OK
 !ğ
¡©us
) {

489  
¡©us
;

492 
	`ucc_as£¹
(
dm
 !ğ
NULL
);

493 
¡©us
 = 
	`ucc__mlx5_po¡_Œª¥o£
(

494 
	`_mlx5_g‘_qp
(
a2a
, 
cyc_¿nk
),

495 
a2a
->
node
.
İs
[
£q_šdex
].
£nd_mkeys
[0]->
lkey
,

496 
‹am
->
dm_mr
->
rkey
, 
¤c_addr
,

497 
dm
->
addr
 + 
k
 * 
block_msgsize
,

498 
sk
->
®ÉßÎ
.
msg_size
, 
block_w
, 
block_h
, 0);

499 ià(
UCC_OK
 !ğ
¡©us
) {

500  
¡©us
;

504 ià(!
£nd_to_£lf
 && 
k
) {

505 
¡©us
 = 
	`£nd_block_d©a
(

506 
a2a
, 
cyc_¿nk
, 
dm
->
addr
, 
block_msgsize
 * 
k
,

507 
‹am
->
dm_mr
->
lkey
, 
»mÙe_addr
,

508 
a2a
->
Ãt
.
rkeys
[
cyc_¿nk
], 
IBV_SEND_SIGNALED
, 
dm
);

509 ià(
¡©us
 !ğ
UCC_OK
) {

510 
	`_”rÜ
(
lib
, "failed sending block [%d,%d,%d]",

511 
node_idx
, 
block_row
, 
block_cŞ
);

512  
¡©us
;

514 
dm
->
po¡ed_£nds
++;

517 
¡©us
 = 
	`£nd_dÚe
(
‹am
, 
cyc_¿nk
);

518 ià(
¡©us
 !ğ
UCC_OK
) {

519  
¡©us
;

521 ià(
dm
) {

522 
dm
->
po¡ed_®l
 = 1;

524 ià(
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
cyc_¿nk
] =ğ
node_nbr_blocks
) {

525 
	`£nd_¡¬t
(
‹am
, 
cyc_¿nk
);

526 
¡©us
 = 
	`£nd_©omic
(
a2a
, 
cyc_¿nk
,

527 
	`_mlx5_©omic_addr
(
sk
, 
cyc_¿nk
),

528 
	`_mlx5_©omic_rkey
(
sk
, 
cyc_¿nk
));

530 ià(
¡©us
 !ğ
UCC_OK
) {

531 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

532 "Faed s’dšg‡tomiøtØnod[%d]", 
cyc_¿nk
);

533  
¡©us
;

535 
¡©us
 = 
	`£nd_dÚe
(
‹am
, 
cyc_¿nk
);

536 ià(
UCC_OK
 !ğ
¡©us
) {

537 
	`_”rÜ
(
lib
, "Faed s’dšg‡tomiøtØnod%d", 
node_idx
);

538  
¡©us
;

540 
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
cyc_¿nk
]++;

541 
sk
->
®ÉßÎ
.
¡¬‹d
++;

545 ià(!
sk
->
®ÉßÎ
.
£nd_blocks_’queued
) {

546 
	`ucc_´og»ss_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, 
cŞl_sk
);

547 
sk
->
®ÉßÎ
.
£nd_blocks_’queued
 = 1;

550 ià(
sk
->
®ÉßÎ
.
¡¬‹d
 =ğ
a2a
->
Ãt
.
Ãt_size
) {

551 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
sk
, "mlx5_alltoall_block_send_done",

553 
¡©us
 = 
	`ucc__mlx5_po¡_wa™_Ú_d©a
(

554 
a2a
->
Ãt
.
umr_qp
,‡2a->Ãt.
Ãt_size
,‡2a->Ãt.
©omic
.
mr
->
lkey
,

555 (
ušŒ_t
)

556 #ià
ATOMIC_IN_MEMIC


557 
	`PTR_OFFSET
(0,

559 
	`PTR_OFFSET
(
a2a
->
Ãt
.
©omic
.
couÁ”s
,

561 
£q_šdex
 * (
_mlx5_©omic_t
)),

562 
sk
);

563 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(

564 
sk
, "mlx5_alltoall_block_post_wait_on_data_done", 0);

566  
¡©us
;

567 
	}
}

569 
ucc_¡©us_t


570 
	$ucc__mlx5_£nd_blocks_Ëáov”s_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

572 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

573 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

574 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

575 
node_size
 = 
a2a
->
node
.
sbgp
->
group_size
;

576 
Ãt_size
 = 
a2a
->
Ãt
.
sbgp
->
group_size
;

577 
£q_šdex
 = 
sk
->
®ÉßÎ
.seq_index;

578 
size_t
 
msg_size
 = 
sk
->
®ÉßÎ
.msg_size;

579 
size_t
 
İ_msgsize
 = 
node_size
 * 
a2a
->
max_msg_size
 * 
	`UCC_TL_TEAM_SIZE
(
‹am
) *

580 
a2a
->
max_num_of_cŞumns
;

581 
size_t
 
mkey_msgsize
 =

582 
node_size
 * 
a2a
->
max_msg_size
 * 
	`UCC_TL_TEAM_SIZE
(
‹am
);

583 
block_size
 = 
sk
->
®ÉßÎ
.
block_height
;

584 
size_t
 
cŞ_msgsize
 = 
msg_size
 * 
block_size
 * 
node_size
;

585 
size_t
 
block_msgsize
 = 
	`SQUARED
(
block_size
è* 
msg_size
;

586 
block_size_Ëáov”s_side
 = 
node_size
 % 
block_size
;

587 
size_t
 
cŞ_msgsize_Ëáov”s
 =

588 
msg_size
 * 
block_size_Ëáov”s_side
 * 
node_size
;

589 
size_t
 
block_msgsize_Ëáov”s
 =

590 
block_size_Ëáov”s_side
 * 
block_size
 * 
msg_size
;

591 
size_t
 
cÜÃr_msgsize
 = 
	`SQUARED
(
block_size_Ëáov”s_side
è* 
msg_size
;

592 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

593 
ucc_ba£_lib_t
 *
lib
 = 
	`UCC_TASK_LIB
(
cŞl_sk
);

594 
nbc
 = 
sk
->
®ÉßÎ
.
num_of_blocks_cŞumns
;

595 
i
, 
j
, 
k
, 
de¡_¿nk
, 
¿nk
, 
cyc_¿nk
, 
bs_x
, 
bs_y
;

596 
size_t
 
cu¼’t_block_msgsize
;

597 
ušt64_t
 
¤c_addr
, 
»mÙe_addr
;

598 
ucc__mlx5_dm_chunk_t
 *
dm
;

599 
ušŒ_t
 
dm_addr
;

601 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

602 
cŞl_sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

604 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "send blocks start");

605 
¿nk
 = 
a2a
->
Ãt
.
¿nk_m­
[a2a->Ãt.
sbgp
->
group_¿nk
];

607 
i
 = 0; i < 
Ãt_size
; i++) {

608 
cyc_¿nk
 = (
i
 + 
a2a
->
Ãt
.
sbgp
->
group_¿nk
è% 
Ãt_size
;

609 
de¡_¿nk
 = 
a2a
->
Ãt
.
¿nk_m­
[
cyc_¿nk
];

610 ià(
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
cyc_¿nk
] ||

611 
	`_mlx5_b¬r›r_æag
(
sk
, 
cyc_¿nk
è!ğsk->
®ÉßÎ
.
£q_num
) {

615 
j
 = 0; j < 
nbc
; j++) {

616 
k
 = 0; k < 
nbc
; k++) {

617 ià(
j
 !ğ(
nbc
 - 1)) {

618 
¤c_addr
 = (
ušŒ_t
)(
cŞ_msgsize
 * 
de¡_¿nk
 +

619 
block_msgsize
 * 
k
);

621 
¤c_addr
 = (
ušŒ_t
)(
cŞ_msgsize_Ëáov”s
 * 
de¡_¿nk
 +

622 
block_msgsize_Ëáov”s
 * 
k
);

624 ià(
k
 !ğ(
nbc
 - 1)) {

625 
»mÙe_addr
 = (
ušŒ_t
)(

626 
İ_msgsize
 * 
£q_šdex
 + 
cŞ_msgsize
 * 
¿nk
 +

627 
block_msgsize
 * 
j
 + 
mkey_msgsize
 * 
k
);

628 
cu¼’t_block_msgsize
 = (
j
 !ğ(
nbc
 - 1))

629 ? 
block_msgsize


630 : 
block_msgsize_Ëáov”s
;

632 
»mÙe_addr
 = (
ušŒ_t
)(

633 
İ_msgsize
 * 
£q_šdex
 + 
cŞ_msgsize_Ëáov”s
 * 
¿nk
 +

634 
block_msgsize_Ëáov”s
 * 
j
 + 
mkey_msgsize
 * 
k
);

635 
cu¼’t_block_msgsize
 = (
j
 !ğ(
nbc
 - 1))

636 ? 
block_msgsize_Ëáov”s


637 : 
cÜÃr_msgsize
;

639 
bs_x
 = 
k
 < 
nbc
 - 1 ? 
block_size
 : 
block_size_Ëáov”s_side
;

640 
bs_y
 = 
j
 < 
nbc
 - 1 ? 
block_size
 : 
block_size_Ëáov”s_side
;

642 
	`£nd_¡¬t
(
‹am
, 
cyc_¿nk
);

645 ià(
bs_x
 =ğ1 || 
bs_y
 == 1) {

646 
¡©us
 = 
	`£nd_block_d©a
(

647 
a2a
, 
cyc_¿nk
, 
¤c_addr
, 
cu¼’t_block_msgsize
,

648 
a2a
->
node
.
İs
[
£q_šdex
].
£nd_mkeys
[
j
]->
lkey
,

649 
»mÙe_addr
, 
a2a
->
Ãt
.
rkeys
[
cyc_¿nk
], 0, 
NULL
);

651 
dm
 = 
	`ucc_mpoŞ_g‘
(&
‹am
->
dm_poŞ
);

652 !
dm
) {

653 
¡©us
 = 
	`£nd_dÚe
(
‹am
, 
cyc_¿nk
);

654 ià(
UCC_OK
 !ğ
¡©us
) {

655  
¡©us
;

658 
¡©us
 = 
	`ucc__mlx5_pŞl_cq
(
a2a
->
Ãt
.
cq
, 
lib
);

659 ià(
UCC_OK
 !ğ
¡©us
) {

660  
¡©us
;

662 
dm
 = 
	`ucc_mpoŞ_g‘
(&
‹am
->
dm_poŞ
);

663 
	`£nd_¡¬t
(
‹am
, 
cyc_¿nk
);

665 
dm_addr
 = 
dm
->
addr
;

666 
dm
->
sk
 =ask;

668 
¡©us
 = 
	`ucc__mlx5_po¡_Œª¥o£
(

669 
	`_mlx5_g‘_qp
(
a2a
, 
cyc_¿nk
),

670 
a2a
->
node
.
İs
[
£q_šdex
].
£nd_mkeys
[
j
]->
lkey
,

671 
‹am
->
dm_mr
->
rkey
, 
¤c_addr
, 
dm_addr
, 
msg_size
, 
bs_x
,

672 
bs_y
, 0);

673 ià(
UCC_OK
 !ğ
¡©us
) {

674  
¡©us
;

677 
¡©us
 = 
	`£nd_block_d©a
(

678 
a2a
, 
cyc_¿nk
, 
dm_addr
, 
cu¼’t_block_msgsize
,

679 
‹am
->
dm_mr
->
lkey
, 
»mÙe_addr
,

680 
a2a
->
Ãt
.
rkeys
[
cyc_¿nk
], 
IBV_SEND_SIGNALED
, 
dm
);

682 ià(
¡©us
 !ğ
UCC_OK
) {

683 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

684 "Faed s’dšg block [%d,%d,%d]", 
i
, 
j
, 
k
);

685  
¡©us
;

687 
¡©us
 = 
	`£nd_dÚe
(
‹am
, 
cyc_¿nk
);

688 ià(
UCC_OK
 !ğ
¡©us
) {

689  
¡©us
;

693 
	`£nd_¡¬t
(
‹am
, 
cyc_¿nk
);

694 
¡©us
 = 
	`£nd_©omic
(
a2a
, 
cyc_¿nk
, 
	`_mlx5_©omic_addr
(
sk
, cyc_rank),

695 
	`_mlx5_©omic_rkey
(
sk
, 
cyc_¿nk
));

696 ià(
UCC_OK
 =ğ
¡©us
) {

697 
¡©us
 = 
	`£nd_dÚe
(
‹am
, 
cyc_¿nk
);

699 
sk
->
®ÉßÎ
.
İ
->
blocks_£Á
[
cyc_¿nk
] = 1;

700 
sk
->
®ÉßÎ
.
¡¬‹d
++;

701 ià(
¡©us
 !ğ
UCC_OK
) {

702 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "Failed sending‡tomico‚ode [%d]",

703 
cyc_¿nk
);

704  
¡©us
;

707 ià(!
sk
->
®ÉßÎ
.
£nd_blocks_’queued
) {

708 
	`ucc_´og»ss_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, 
cŞl_sk
);

709 
sk
->
®ÉßÎ
.
£nd_blocks_’queued
 = 1;

712 ià(
sk
->
®ÉßÎ
.
¡¬‹d
 =ğ
a2a
->
Ãt
.
Ãt_size
) {

713 
¡©us
 = 
	`ucc__mlx5_po¡_wa™_Ú_d©a
(

714 
a2a
->
Ãt
.
umr_qp
,‡2a->Ãt.
Ãt_size
,‡2a->Ãt.
©omic
.
mr
->
lkey
,

715 (
ušŒ_t
)

716 #ià
ATOMIC_IN_MEMIC


717 
	`PTR_OFFSET
(0,

719 
	`PTR_OFFSET
(
a2a
->
Ãt
.
©omic
.
couÁ”s
,

721 
£q_šdex
 * (
_mlx5_©omic_t
)),

722 
sk
);

725  
¡©us
;

726 
	}
}

728 
	$ucc__mlx5_£nd_blocks_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

730 
ucc__mlx5_scheduË_t
 *
sk
 = 
	`TASK_SCHEDULE
(
cŞl_sk
);

731 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

732 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

733 
ucc_¡©us_t
 
¡©us
;

735 ià(
sk
->
®ÉßÎ
.
¡¬‹d
 !ğ
a2a
->
Ãt
.
Ãt_size
) {

736 
cŞl_sk
->
	`po¡
(coll_task);

739 
¡©us
 = 
	`ucc__mlx5_pŞl_cq
(
a2a
->
Ãt
.
cq
, 
	`UCC_TASK_LIB
(
cŞl_sk
));

740 ià(
UCC_OK
 !ğ
¡©us
) {

741 
cŞl_sk
->
¡©us
 = status;

745 ià(
sk
->
®ÉßÎ
.
blocks_£Á
 =ğsk->®ÉßÎ.
blocks_com¶‘ed
) {

746 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(

747 
sk
, "mlx5_alltoall_all_blocks_completed", 0);

748 
cŞl_sk
->
¡©us
 = 
UCC_OK
;

750 
	}
}

752 
ucc_¡©us_t
 
	$ucc__mlx5_®ÉßÎ_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

754 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "mlx5_alltoall_start", 0);

755  
	`ucc_scheduË_¡¬t
(
cŞl_sk
);

756 
	}
}

758 
ucc_¡©us_t
 
	$ucc__mlx5_®ÉßÎ_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

760 
ucc__mlx5_scheduË_t
 *
sk
 =

761 
	`ucc_d”ived_of
(
cŞl_sk
, 
ucc__mlx5_scheduË_t
);

762 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

763 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

764 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`SCHEDULE_CTX
(
sk
);

765 
£q_šdex
 = 
sk
->
®ÉßÎ
.seq_index;

766 
ucc_¡©us_t
 
¡©us
;

768 
a2a
->
´evious_msg_size
[
£q_šdex
] = 
sk
->
®ÉßÎ
.
msg_size
;

769 
a2a
->
´evious_£nd_add»ss
[
£q_šdex
] =

770 
sk
->
®ÉßÎ
.
£nd_rÿche_»giÚ_p
->
»g
.
mr
->
addr
;

771 
a2a
->
´evious_»cv_add»ss
[
£q_šdex
] =

772 
sk
->
®ÉßÎ
.
»cv_rÿche_»giÚ_p
->
»g
.
mr
->
addr
;

773 
	`ucc_rÿche_»giÚ_put
(
ùx
->
rÿche
,

774 &
sk
->
®ÉßÎ
.
£nd_rÿche_»giÚ_p
->
su³r
);

775 
	`ucc_rÿche_»giÚ_put
(
ùx
->
rÿche
,

776 &
sk
->
®ÉßÎ
.
»cv_rÿche_»giÚ_p
->
su³r
);

777 
	`UCC_TL_MLX5_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "mlx5_alltoall_done", 0);

778 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
cŞl_sk
);

779 
	`ucc__mlx5_put_scheduË
(
sk
);

780  
¡©us
;

781 
	}
}

783 
šlše
 
	$block_size_f™s
(
size_t
 
msgsize
, 
height
, 
width
)

785 
t
;

787 ià(
msgsize
 > 
MAX_MSG_SIZE
 || 
height
 > 
MAX_BLOCK_SIZE
 ||

788 
width
 > 
MAX_BLOCK_SIZE
) {

789  
çl£
;

791 
t
 = 
	`ucc_round_up_pow”2
(
	`ucc_max
(
msgsize
, 8));

792  
height
 *

793 
	`ucc_max
(
	`ucc_round_up_pow”2
(
width
è* 
t
, 
MAX_MSG_SIZE
) <=

794 
MAX_TRANSPOSE_SIZE
;

795 
	}
}

797 
	#MAYBE_CONTINUE_OR_BREAK_IF_REGULAR
(
x
) \

798 ià(
fÜû_»guÏr
) { \

799 ià(
x
 > 
µn
) { \

801 } ià(
µn
 % 
x
) { \

804 }

	)

806 
šlše
 

807 
	$g‘_block_dim’siÚs
(
µn
, 
msgsize
, 
fÜû_»guÏr
,

808 
ucc__mlx5_®ÉßÎ_block_sh­e_modes_t
 
block_sh­e_mode
,

809 *
block_height
, *
block_width
)

811 
h_be¡
 = 1;

812 
w_be¡
 = 1;

813 
h
, 
w
, 
w_mš
, 
w_max
;

815 
h
 = 1; h <ğ
MAX_BLOCK_SIZE
; h++) {

816 
	`MAYBE_CONTINUE_OR_BREAK_IF_REGULAR
(
h
);

817 
w_max
 = 
block_sh­e_mode
 !ğ
UCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_LONG


818 ? 
MAX_BLOCK_SIZE


819 : 
h
;

820 
w_mš
 =

821 
block_sh­e_mode
 !ğ
UCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_WIDE
 ? 1 : 
h
;

822 
w_mš
 = 
	`ucc_max
(w_mš, 
h_be¡
 * 
w_be¡
 / 
h
);

823 
w
 = 
w_mš
; w <ğ
w_max
; w++) {

824 
	`MAYBE_CONTINUE_OR_BREAK_IF_REGULAR
(
w
);

825 ià(
	`block_size_f™s
(
msgsize
, 
h
, 
w
)) {

826 ià(
h
 * 
w
 > 
h_be¡
 * 
w_be¡
 ||

827 
	`abs
(
h
 / 
w
 - 1è<‡bs(
h_be¡
 / 
w_be¡
 - 1)) {

828 
h_be¡
 = 
h
;

829 
w_be¡
 = 
w
;

835 *
block_height
 = 
h_be¡
;

836 *
block_width
 = 
w_be¡
;

837 
	}
}

839 
UCC_TL_MLX5_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc__mlx5_®ÉßÎ_š™
,

840 (
cŞl_¬gs
, 
‹am
, 
sk_h
),

841 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

842 
ucc_cŞl_sk_t
 **
sk_h
)

844 
ucc__mlx5_‹am_t
 *
	g_‹am
 = 
ucc_d”ived_of
(
‹am
,

845 
ucc__mlx5_‹am_t
);

846 
ucc__mlx5_®ÉßÎ_t
 *
	ga2a
 = 
_‹am
->
a2a
;

847 
ucc__mlx5_cÚ‹xt_t
 *
	gùx
 = 
UCC_TL_MLX5_TEAM_CTX
(
_‹am
);

848 
	gis_a¤
 = (
a2a
->
node
.
sbgp
->
group_¿nk


849 =ğ
a2a
->
node
.
a¤_¿nk
);

850 
	gn_sks
 = 
is_a¤
 ? 5 : 3;

851 
	gcu¼_sk
 = 0;

852 
	gµn
 = 
_‹am
->
a2a
->
node
.
sbgp
->
group_size
;

853 
ucc__mlx5_lib_cÚfig_t
 *
	gcfg
 = &
UCC_TL_MLX5_TEAM_LIB
(
_‹am
)->
cfg
;

854 
ucc_scheduË_t
 *
	gscheduË
;

855 
ucc__mlx5_scheduË_t
 *
	gsk
;

856 
size_t
 
	gmsg_size
;

857 
	gblock_size
, 
	gi
;

858 
ucc_cŞl_sk_t
 *
	gsks
[5];

859 
ucc_¡©us_t
 
	g¡©us
;

860 
size_t
 
	gby‹s_couÁ
, 
	gby‹s_couÁ_Ï¡
, 
	gby‹s_sk
, 
	gby‹s_sk_Ï¡
;

862 ià(!
	gùx
->
	gcfg
.
	g’abË_®ÉßÎ
) {

863  
	gUCC_ERR_NOT_SUPPORTED
;

866 ià(
UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
)) {

867  
	gUCC_ERR_NOT_SUPPORTED
;

870 
	gmsg_size
 = (
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
couÁ
 *

871 
ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
d©©y³
)) /

872 
UCC_TL_TEAM_SIZE
(
_‹am
);

873 ià(!
	gmsg_size
) {

874 
_Œaû
(
UCC_TL_TEAM_LIB
(
_‹am
),

876  
	gUCC_ERR_NOT_SUPPORTED
;

879 ià(
	gmsg_size
 > 
	ga2a
->
	gmax_msg_size
) {

880 
_Œaû
(
UCC_TL_TEAM_LIB
(
_‹am
), "msg sizeoo†ong");

881  
	gUCC_ERR_NOT_SUPPORTED
;

884 
	g¡©us
 = 
ucc__mlx5_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
, &
sk
);

885 ià(
ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

886  
¡©us
;

888 
	gscheduË
 = &
sk
->
su³r
;

890 
	gi
 = 0; i < 
	gn_sks
; i++) {

891 
	gsks
[
i
] = &
ucc__mlx5_š™_sk
(
cŞl_¬gs
, 
‹am
, 
scheduË
)->
	gsu³r
;

894 
	gsk
->
	g®ÉßÎ
.
	g£nd_blocks_’queued
 = 0;

895 
	gsk
->
	g®ÉßÎ
.
	g¡¬‹d
 = 0;

896 
	gsk
->
	g®ÉßÎ
.
	gwa™_wc
 = 0;

897 
	gsk
->
	g®ÉßÎ
.
	gblocks_£Á
 = 0;

898 
	gsk
->
	g®ÉßÎ
.
	gblocks_com¶‘ed
 = 0;

899 
	gsk
->
	g®ÉßÎ
.
	g£q_num
 = 
a2a
->
£qu’û_numb”
;

900 
	gsk
->
	g®ÉßÎ
.
	g£q_šdex
 = 
SEQ_INDEX
(
a2a
->
£qu’û_numb”
);

901 
	gsk
->
	g®ÉßÎ
.
	gİ
 = &
a2a
->
node
.
İs
[

902 
sk
->
®ÉßÎ
.
£q_šdex
];

903 
	gsk
->
	g®ÉßÎ
.
	gmsg_size
 = 
msg_size
;

905 
_Œaû
(
UCC_TL_TEAM_LIB
(
_‹am
), "Seq‚um i %d", 
sk
->
®ÉßÎ
.
£q_num
);

906 
	ga2a
->
	g£qu’û_numb”
 += 1;

908 ià(
	ga2a
->
	g»que¡ed_block_size
) {

909 
	gsk
->
	g®ÉßÎ
.
	gblock_height
 = 
sk
->
®ÉßÎ
.
block_width
 =

910 
a2a
->
»que¡ed_block_size
;

911 ià(
	gcfg
->
	gfÜû_»guÏr
 && ((
	gµn
 % 
	gsk
->
	g®ÉßÎ
.
	gblock_height
) ||

912 (
	gµn
 % 
	gsk
->
	g®ÉßÎ
.
	gblock_width
))) {

913 
_debug
(
UCC_TL_TEAM_LIB
(
_‹am
),

917  
	gUCC_ERR_INVALID_PARAM
;

920 ià(!
	gcfg
->
	gfÜû_»guÏr
) {

921 ià(!(
	gcfg
->
	gblock_sh­e_mode
 !=

922 
UCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_SQUARE
)) {

923 
_debug
(
UCC_TL_TEAM_LIB
(
_‹am
),

926 
	gcfg
->
	gblock_sh­e_mode
 = 
UCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_SQUARE
;

929 
g‘_block_dim’siÚs
(
µn
, 
sk
->
®ÉßÎ
.
msg_size
, 
cfg
->
fÜû_»guÏr
,

930 
cfg
->
block_sh­e_mode
,

931 &
sk
->
®ÉßÎ
.
block_height
,

932 &
sk
->
®ÉßÎ
.
block_width
);

934 
_debug
(
UCC_TL_TEAM_LIB
(
_‹am
), "block dimensions: [%d,%d]",

935 
sk
->
®ÉßÎ
.
block_height
,ask->®ÉßÎ.
block_width
);

938 
	gsk
->
	g®ÉßÎ
.
	gnum_of_blocks_cŞumns
 =

939 (
a2a
->
node
.
sbgp
->
group_size
 % 
sk
->
®ÉßÎ
.
block_height
)

940 ? 
ucc_div_round_up
(
a2a
->
node
.
sbgp
->
group_size
,

941 
sk
->
®ÉßÎ
.
block_height
)

945 ià(
	gsk
->
	g®ÉßÎ


946 .
	gnum_of_blocks_cŞumns
) {

948 
size_t
 
	glim™
 =

951 
ucc_as£¹
(
sk
->
®ÉßÎ
.
block_height
 =ğsk->®ÉßÎ.
block_width
);

952 
	gblock_size
 = 
sk
->
®ÉßÎ
.
block_height
;

954 
ucc_as£¹
(
sk
->
®ÉßÎ
.
block_height
 =ğsk->®ÉßÎ.
block_width
);

956 
	gby‹s_couÁ_Ï¡
 = (
µn
 % 
block_size
è* 
msg_size
;

957 
	gby‹s_sk_Ï¡
 = (
µn
 - (µÀ% 
block_size
)è* 
msg_size
;

958 
	gby‹s_couÁ
 = 
block_size
 * 
msg_size
;

959 
	gby‹s_sk
 = (
µn
 - 
block_size
è* 
msg_size
;

960 ià((
	gby‹s_couÁ
 + 
	gby‹s_sk
 >ğ
lim™
) ||

961 (
by‹s_couÁ_Ï¡
 + 
by‹s_sk_Ï¡
 >ğ
lim™
)) {

962 
_debug
(
UCC_TL_TEAM_LIB
(
_‹am
), "unsupported operation");

963 
	g¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

964 
	gput_scheduË
;

968 
ucc_scheduË_add_sk
(
scheduË
, 
sks
[0]);

969 
ucc_ev’t_mªag”_subsüibe
(&
scheduË
->
su³r
, 
UCC_EVENT_SCHEDULE_STARTED
,

970 
sks
[0], 
ucc_sk_¡¬t_hªdËr
);

971 
	gi
 = 0; i < (
	gn_sks
 - 1); i++) {

972 
ucc_scheduË_add_sk
(
scheduË
, 
sks
[
i
 + 1]);

973 
ucc_ev’t_mªag”_subsüibe
(
sks
[
i
], 
UCC_EVENT_COMPLETED
,asks[i + 1],

974 
ucc_sk_¡¬t_hªdËr
);

977 
	gsks
[
cu¼_sk
]->
	gpo¡
 = 
ucc__mlx5_pŞl_ä“_İ_¦Ù_¡¬t
;

978 
	gsks
[
cu¼_sk
]->
	g´og»ss
 = 
ucc__mlx5_pŞl_ä“_İ_¦Ù_´og»ss
;

979 
	gcu¼_sk
++;

981 
	gsks
[
cu¼_sk
]->
	gpo¡
 = 
ucc__mlx5_»g_çnš_¡¬t
;

982 
	gsks
[
cu¼_sk
]->
	g´og»ss
 = 
ucc__mlx5_»g_çnš_´og»ss
;

983 
	gcu¼_sk
++;

985 ià(
	gis_a¤
) {

986 
	gsks
[
cu¼_sk
]->
	gpo¡
 = 
ucc__mlx5_a¤_b¬r›r_¡¬t
;

987 
	gsks
[
cu¼_sk
]->
	g´og»ss
 = 
ucc__mlx5_a¤_b¬r›r_´og»ss
;

988 
	gcu¼_sk
++;

989 ià(
	gsk
->
	g®ÉßÎ
.
	gnum_of_blocks_cŞumns
) {

990 
	gsks
[
cu¼_sk
]->
	gpo¡
 = 
ucc__mlx5_£nd_blocks_Ëáov”s_¡¬t
;

992 
	gsks
[
cu¼_sk
]->
	gpo¡
 = 
ucc__mlx5_£nd_blocks_¡¬t
;

994 
	gsks
[
cu¼_sk
]->
	g´og»ss
 = 
ucc__mlx5_£nd_blocks_´og»ss
;

995 
	gcu¼_sk
++;

997 
	gsks
[
cu¼_sk
]->
	gpo¡
 = 
ucc__mlx5_çnout_¡¬t
;

998 
	gsks
[
cu¼_sk
]->
	g´og»ss
 = 
ucc__mlx5_çnout_´og»ss
;

1000 
	gscheduË
->
	gsu³r
.
	gpo¡
 = 
ucc__mlx5_®ÉßÎ_¡¬t
;

1001 
	gscheduË
->
	gsu³r
.
	g´og»ss
 = 
NULL
;

1002 
	gscheduË
->
	gsu³r
.
	gfš®ize
 = 
ucc__mlx5_®ÉßÎ_fš®ize
;

1003 
	gscheduË
->
	gsu³r
.
	gŒigg”ed_po¡
 = 
NULL
;

1005 *
	gsk_h
 = &
scheduË
->
su³r
;

1006  
	g¡©us
;

1008 
	gput_scheduË
:

1009 
ucc__mlx5_put_scheduË
(
sk
);

1010  
	g¡©us
;

	@src/components/tl/mlx5/alltoall/alltoall_inline.h

7 #iâdeà
UCC_TL_MLX5_INLINE_H_


8 
	#UCC_TL_MLX5_INLINE_H_


	)

10 
	~"_mlx5_ib.h
"

11 
	~"_mlx5_cŞl.h
"

12 
	~"_mlx5_wqe.h
"

13 
	~"®ÉßÎ/®ÉßÎ.h
"

15 
šlše
 
ibv_qp_ex
 *
	$_mlx5_g‘_qp_ex
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

16 
ucc_¿nk_t
 
¿nk
)

18 ià(
a2a
->
is_dc
) {

19  
a2a
->
Ãt
.
dcis
[
¿nk
 %‡2a->
num_dci_qps
].
dc_q³x
;

21  
a2a
->
Ãt
.
rc_qps
[
¿nk
].
qp_ex
;

22 
	}
}

24 
šlše
 
ibv_qp
 *
	$_mlx5_g‘_qp
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

25 
ucc_¿nk_t
 
¿nk
)

27 ià(
a2a
->
is_dc
) {

28  
a2a
->
Ãt
.
dcis
[
¿nk
 %‡2a->
num_dci_qps
].
dci_qp
;

30  
a2a
->
Ãt
.
rc_qps
[
¿nk
].
qp
;

31 
	}
}

33 
šlše
 
ucc_¡©us_t


34 
	$£nd_block_d©a
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
, 
ucc_¿nk_t
 
¿nk
, 
ušt64_t
 
¤c_addr
,

35 
ušt32_t
 
msg_size
, ušt32_ˆ
lkey
, 
ušt64_t
 
»mÙe_addr
,

36 
ušt32_t
 
rkey
, 
£nd_æags
, 
ucc__mlx5_dm_chunk_t
 *
dm
)

38 
ibv_qp
 *
qp
 = 
	`_mlx5_g‘_qp
(
a2a
, 
¿nk
);

39 
ibv_ah
 *
ah
 = 
NULL
;

40 
ušt32_t
 
dùn
 = 0;

42 ià(
dm
) {

43 
dm
->
sk
->
®ÉßÎ
.
blocks_£Á
++;

45 ià(
a2a
->
is_dc
) {

46 
ah
 = 
a2a
->
Ãt
.
ahs
[
¿nk
];

47 
dùn
 = 
a2a
->
Ãt
.
»mÙe_dùns
[
¿nk
];

49  
	`ucc__mlx5_po¡_rdma
(
qp
, 
dùn
, 
ah
, 
¤c_addr
, 
msg_size
, 
lkey
,

50 
»mÙe_addr
, 
rkey
, 
£nd_æags
, (
ušŒ_t
)
dm
);

51 
	}
}

53 
šlše
 
	$£nd_¡¬t
(
ucc__mlx5_‹am_t
 *
‹am
, 
ucc_¿nk_t
 
¿nk
)

55 
	`ibv_wr_¡¬t
(
	`_mlx5_g‘_qp_ex
(
‹am
->
a2a
, 
¿nk
));

56 
	}
}

58 
šlše
 
ucc_¡©us_t
 
	$£nd_dÚe
(
ucc__mlx5_‹am_t
 *
‹am
, 
ucc_¿nk_t
 
¿nk
)

60 ià(
	`ibv_wr_com¶‘e
(
	`_mlx5_g‘_qp_ex
(
‹am
->
a2a
, 
¿nk
))) {

61 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "ibv_wr_complete failed,ƒrrno %d",

62 
”ºo
);

63  
UCC_ERR_NO_MESSAGE
;

65  
UCC_OK
;

66 
	}
}

68 
šlše
 
ucc_¡©us_t
 
	$£nd_©omic
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

69 
ucc_¿nk_t
 
¿nk
, *
»mÙe_addr
,

70 
ušt32_t
 
rkey
)

72 
ibv_qp_ex
 *
qp_ex
;

73 
mlx5dv_qp_ex
 *
qp_dv
;

75 
qp_ex
 = 
	`_mlx5_g‘_qp_ex
(
a2a
, 
¿nk
);

76 
qp_ex
->
wr_æags
 = 0;

77 
	`ibv_wr_©omic_ãtch_add
(
qp_ex
, 
rkey
, (
ušŒ_t
)
»mÙe_addr
, 1ULL);

78 ià(
a2a
->
is_dc
) {

79 
qp_dv
 = 
	`mlx5dv_qp_ex_äom_ibv_qp_ex
(
qp_ex
);

80 
	`mlx5dv_wr_£t_dc_addr
(
qp_dv
, 
a2a
->
Ãt
.
ahs
[
¿nk
],

81 
a2a
->
Ãt
.
»mÙe_dùns
[
¿nk
], 
DC_KEY
);

83 
	`ibv_wr_£t_sge
(
qp_ex
, 
a2a
->
©omic_sü©ch_bf_mr
->
lkey
,

84 (
ušt64_t
)
a2a
->
©omic_sü©ch_bf_mr
->
addr
,

85 
a2a
->
©omic_sü©ch_bf_mr
->
Ëngth
);

86  
UCC_OK
;

87 
	}
}

89 
šlše
 *
	$_mlx5_©omic_addr
(
ucc__mlx5_scheduË_t
 *
sk
,

90 
ucc_¿nk_t
 
¿nk
)

92 *
»mÙe_©omic
 = 
NULL
;

93 #ià!
ATOMIC_IN_MEMIC


94 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

96 
»mÙe_©omic
 = 
‹am
->
a2a
->
Ãt
.
»mÙe_ù¾
[
¿nk
].
©omic
.
addr
;

98  
	`PTR_OFFSET
(
»mÙe_©omic
,

99 
sk
->
®ÉßÎ
.
£q_šdex
 * (
_mlx5_©omic_t
));

100 
	}
}

102 
šlše
 
ušt32_t
 
	$_mlx5_©omic_rkey
(
ucc__mlx5_scheduË_t
 *
sk
,

103 
ucc_¿nk_t
 
¿nk
)

105 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

107  
‹am
->
a2a
->
Ãt
.
»mÙe_ù¾
[
¿nk
].
©omic
.
rkey
;

108 
	}
}

110 
šlše
 
_mlx5_b¬r›r_t


111 
	$_mlx5_b¬r›r_æag
(
ucc__mlx5_scheduË_t
 *
sk
, 
ucc_¿nk_t
 
¿nk
)

113 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

114 
ucc_¿nk_t
 
Ãt_size
 = 
‹am
->
a2a
->
Ãt
.net_size;

116  
‹am
->
a2a
->
Ãt
.
b¬r›r


117 .
æags
[(
Ãt_size
 + 1è* 
sk
->
®ÉßÎ
.
£q_šdex
 + 
¿nk
];

118 
	}
}

120 
šlše
 
	$_mlx5_b¬r›r_æag_£t
(
ucc__mlx5_scheduË_t
 *
sk
,

121 
ucc_¿nk_t
 
¿nk
)

123 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

124 
ucc_¿nk_t
 
Ãt_size
 = 
‹am
->
a2a
->
Ãt
.net_size;

126 
‹am
->
a2a
->
Ãt
.
b¬r›r


127 .
æags
[(
Ãt_size
 + 1è* 
sk
->
®ÉßÎ
.
£q_šdex
 + 
¿nk
] =

128 
sk
->
®ÉßÎ
.
£q_num
;

129 
	}
}

131 
šlše
 
_mlx5_b¬r›r_t
 *

132 
	$_mlx5_b¬r›r_loÿl_addr
(
ucc__mlx5_scheduË_t
 *
sk
)

134 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

135 
ucc_¿nk_t
 
Ãt_size
 = 
‹am
->
a2a
->
Ãt
.net_size;

137  &
‹am
->
a2a
->
Ãt
.
b¬r›r


138 .
æags
[(
Ãt_size
 + 1è* 
sk
->
®ÉßÎ
.
£q_šdex
 +‚et_size];

139 
	}
}

141 
šlše
 
ušŒ_t


142 
	$_mlx5_b¬r›r_my_»mÙe_addr
(
ucc__mlx5_scheduË_t
 *
sk
, 
ucc_¿nk_t
 
¿nk
)

144 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

145 
ucc_¿nk_t
 
Ãt_size
 = 
‹am
->
a2a
->
Ãt
.net_size;

146 
ucc_¿nk_t
 
Ãt_¿nk
 = 
‹am
->
a2a
->
Ãt
.
sbgp
->
group_¿nk
;

147 * 
»mÙe_b¬r›r
;

148 
±rdiff_t
 
off£t
;

150 
»mÙe_b¬r›r
 = 
‹am
->
a2a
->
Ãt
.
»mÙe_ù¾
[
¿nk
].
b¬r›r
.
addr
;

151 
off£t
 = (
sk
->
®ÉßÎ
.
£q_šdex
 * (
Ãt_size
 + 1è+ 
Ãt_¿nk
) *

152 (
_mlx5_b¬r›r_t
);

153  (
ušŒ_t
)
	`PTR_OFFSET
(
»mÙe_b¬r›r
, 
off£t
);

154 
	}
}

156 
šlše
 
ušt32_t
 
	$_mlx5_b¬r›r_»mÙe_rkey
(
ucc__mlx5_scheduË_t
 *
sk
,

157 
ucc_¿nk_t
 
¿nk
)

159 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`SCHEDULE_TEAM
(
sk
);

161  
‹am
->
a2a
->
Ãt
.
»mÙe_ù¾
[
¿nk
].
b¬r›r
.
rkey
;

162 
	}
}

	@src/components/tl/mlx5/alltoall/alltoall_mkeys.c

7 
	~"_mlx5.h
"

8 
	~"_mlx5_ib.h
"

9 
	~"_mlx5_cŞl.h
"

10 
	~"_mlx5_wqe.h
"

12 
	~"®ÉßÎ/®ÉßÎ.h
"

13 
	~"®ÉßÎ/®ÉßÎ_mkeys.h
"

15 
	~<š‰y³s.h
>

20 
ucc_¡©us_t
 
	$ucc__mlx5_®ÉßÎ_š™_umr
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

21 
ucc_ba£_lib_t
 *
lib
)

23 
ucc__mlx5_lib_cÚfig_t
 
cfg
 = 
	`ucc_d”ived_of
(
lib
, 
ucc__mlx5_lib_t
)->cfg;

24 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

26 
a2a
->
Ãt
.
umr_cq
 = 
	`ibv_ü—‹_cq
×2a->
ùx
, 
UMR_CQ_SIZE
, 
NULL
, NULL, 0);

27 ià(
a2a
->
Ãt
.
umr_cq
 =ğ
NULL
) {

28 
	`_”rÜ
(
lib
, "çedØü—‹ UMR (”ºØ%d)", 
”ºo
);

29  
UCC_ERR_NO_MESSAGE
;

31 
¡©us
 = 
	`ucc__mlx5_ü—‹_umr_qp
(
a2a
->
ùx
,‡2a->
pd
,‡2a->
Ãt
.
umr_cq
,

32 
a2a
->
ib_pÜt
, &a2a->
Ãt
.
umr_qp
,

33 &
cfg
.
qp_cÚf
, 
lib
);

34 ià(
¡©us
 !ğ
UCC_OK
) {

35 
”r
;

37  
¡©us
;

39 
”r
:

40 ià(
	`ibv_de¡roy_cq
(
a2a
->
Ãt
.
umr_cq
)) {

41 
	`_”rÜ
(
lib
, "çedØde¡roy UMR CQ (”ºo=%d)", 
”ºo
);

43  
¡©us
;

44 
	}
}

46 
ucc_¡©us_t
 
	$ü—‹_ma¡”_key
(
num_of_’Œ›s
, 
ibv_pd
 *
pd
,

47 
mlx5dv_mkey
 **
mkey_±r
,

48 
ucc_ba£_lib_t
 * 
lib
)

50 
mlx5dv_mkey
 * 
mkey
;

51 
mlx5dv_mkey_š™_©Œ
 
umr_mkey_š™_©Œ
;

53 
	`mem£t
(&
umr_mkey_š™_©Œ
, 0, (umr_mkey_init_attr));

54 
umr_mkey_š™_©Œ
.
pd
 =…d;

55 
umr_mkey_š™_©Œ
.
ü—‹_æags
 = 
MLX5DV_MKEY_INIT_ATTR_FLAGS_INDIRECT
;

60 
umr_mkey_š™_©Œ
.
max_’Œ›s
 = 
num_of_’Œ›s
;

61 
mkey
 = 
	`mlx5dv_ü—‹_mkey
(&
umr_mkey_š™_©Œ
);

62 ià(
mkey
 =ğ
NULL
) {

63 
	`_”rÜ
(
lib
, "Ma¡”MKey c»©iÚ faed (”ºo=%d)", 
”ºo
);

64  
UCC_ERR_NO_MESSAGE
;

66 
	`_Œaû
(
lib
, "umr_master_key_dv_mkey:†key=0x%x, with %dƒntries",

67 
mkey
->
lkey
, 
num_of_’Œ›s
);

68 *
mkey_±r
 = 
mkey
;

69  
UCC_OK
;

70 
	}
}

72 
ucc_¡©us_t
 
	$pŞl_umr_cq
(
ibv_cq
 *
cq
, 
ucc_ba£_lib_t
 *
lib
)

74 
ibv_wc
 
wc
;

75 
»t
 = 0;

77 !
»t
) {

78 
»t
 = 
	`ibv_pŞl_cq
(
cq
, 1, &
wc
);

79 ià(
»t
 < 0) {

80 
	`_”rÜ
(
lib
, "ibv_poll_cq() failed for UMRƒxecution");

81  
UCC_ERR_NO_MESSAGE
;

82 } ià(
»t
 > 0) {

83 ià(
wc
.
¡©us
 !ğ
IBV_WC_SUCCESS
) {

84 
	`_”rÜ
(
lib
,

87 
	`ibv_wc_¡©us_¡r
(
wc
.
¡©us
));

88  
UCC_ERR_NO_MESSAGE
;

92  
UCC_OK
;

93 
	}
}

96 
ucc_¡©us_t
 
	$pİuÏ‹_nÚ_¡rided_mkey
(
ibv_qp
 *
umr_qp
,

97 
ibv_cq
 *
umr_cq
,

98 
mem_acûss_æags
,

99 
mlx5dv_mkey
 *
mkey
,

100 *
mkey_’Œ›s
, 
n_’Œ›s
,

101 
ucc_ba£_lib_t
 *
lib
)

103 
ibv_qp_ex
 * 
qp_ex
 = 
	`ibv_qp_to_qp_ex
(
umr_qp
);

104 
mlx5dv_qp_ex
 *
mqp
 = 
	`mlx5dv_qp_ex_äom_ibv_qp_ex
(
qp_ex
);

105 
ucc_¡©us_t
 
¡©us
;

107 
	`ibv_wr_¡¬t
(
qp_ex
);

108 
qp_ex
->
wr_id
 = 1;

109 
	`mlx5dv_wr_mr_li¡
(
mqp
, 
mkey
, 
mem_acûss_æags
, 
n_’Œ›s
,

110 (
ibv_sge
 *)
mkey_’Œ›s
);

112 ià(
	`ibv_wr_com¶‘e
(
qp_ex
)) {

113 
	`_”rÜ
(
lib
, "UMR WQE faed (”ºo=%d)", 
”ºo
);

114  
UCC_ERR_NO_MESSAGE
;

116 
¡©us
 = 
	`pŞl_umr_cq
(
umr_cq
, 
lib
);

117 ià(
¡©us
 !ğ
UCC_OK
) {

118  
¡©us
;

120  
UCC_OK
;

121 
	}
}

124 
ucc_¡©us_t
 
	$pİuÏ‹_¡rided_mkey
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

125 
mem_acûss_æags
,

126 
mlx5dv_mkey
 *
mkey
,

127 *
mkey_’Œ›s
, 
»³©_couÁ
,

128 
ucc_ba£_lib_t
 *
lib
)

130 
ucc_¡©us_t
 
¡©us
;

131 
ucc__mlx5_®ÉßÎ_Ãt_t
 * 
Ãt
 = &
a2a
->net;

132 
ucc__mlx5_®ÉßÎ_node_t
 *
node
 = &
a2a
->node;

134 
	`ucc__mlx5_po¡_umr
(
Ãt
->
umr_qp
, 
mkey
, 
mem_acûss_æags
, 
»³©_couÁ
,

135 
node
->
sbgp
->
group_size
,

136 (
mlx5dv_mr_š‹¾—ved
 *)
mkey_’Œ›s
,

137 
node
->
umr_’Œ›s_mr
->
lkey
,‚ode->
umr_’Œ›s_buf
);

139 
¡©us
 = 
	`pŞl_umr_cq
(
Ãt
->
umr_cq
, 
lib
);

140 ià(
¡©us
 !ğ
UCC_OK
) {

141 
	`_”rÜ
(
lib
, "çedØpİuÏ‹ sŒided UMR mkey (”ºo=%d)", 
”ºo
);

142  
¡©us
;

144  
UCC_OK
;

145 
	}
}

147 
ucc_¡©us_t
 
	$ü—‹_ªd_pİuÏ‹_»cv_‹am_mkey
(
ucc__mlx5_‹am_t
 *
‹am
,

148 
ucc_ba£_lib_t
 *
lib
)

150 
‹am_size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

151 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

152 
ucc__mlx5_®ÉßÎ_node_t
 *
node
 = &
a2a
->node;

153 
mnc
 = 
a2a
->
max_num_of_cŞumns
;

154 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

155 
i
, 
j
, 
šdex
;

157 
¡©us
 = 
	`ü—‹_ma¡”_key
(
MAX_OUTSTANDING_OPS
 * 
mnc
, 
a2a
->
pd
,

158 &
node
->
‹am_»cv_mkey
, 
lib
);

159 ià(
¡©us
 !ğ
UCC_OK
) {

160  
¡©us
;

162 
ibv_sge
 *
‹am_mkey_klm_’Œ›s
 = (ibv_sg*)
	`ÿÎoc
(

163 
MAX_OUTSTANDING_OPS
 * 
mnc
, (
ibv_sge
));

165 ià(!
‹am_mkey_klm_’Œ›s
) {

166 
	`_”rÜ
(
lib
, "failedo‡llocateeam_mkey_klm_entries");

167 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

168 
”r_ÿÎoc
;

171 
i
 = 0; i < 
MAX_OUTSTANDING_OPS
; i++) {

172 
j
 = 0; j < 
mnc
; j++) {

173 
šdex
 = 
i
 * 
mnc
 + 
j
;

174 
‹am_mkey_klm_’Œ›s
[
šdex
].
addr
 = 0;

176 
‹am_mkey_klm_’Œ›s
[
šdex
].
Ëngth
 =

177 
node
->
sbgp
->
group_size
 * 
a2a
->
max_msg_size
 * 
‹am_size
;

178 
‹am_mkey_klm_’Œ›s
[
šdex
].
lkey
 =

179 
node
->
İs
[
i
].
»cv_mkeys
[
j
]->
rkey
;

182 
¡©us
 = 
	`pİuÏ‹_nÚ_¡rided_mkey
(

183 
a2a
->
Ãt
.
umr_qp
,‡2a->Ãt.
umr_cq
,

184 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
, 
node
->
‹am_»cv_mkey
,

185 
‹am_mkey_klm_’Œ›s
, 
MAX_OUTSTANDING_OPS
 * 
mnc
, 
lib
);

186 ià(
¡©us
 !ğ
UCC_OK
) {

187 
	`_”rÜ
(
a2a
, "failedo…opulateeam mkey");

188 
”r_mkey
;

190 
	`ucc_ä“
(
‹am_mkey_klm_’Œ›s
);

191  
¡©us
;

193 
”r_mkey
:

194 
	`ucc_ä“
(
‹am_mkey_klm_’Œ›s
);

195 
”r_ÿÎoc
:

196 ià(
	`mlx5dv_de¡roy_mkey
(
node
->
‹am_»cv_mkey
)) {

197 
	`_”rÜ
(
lib
, "mkey de¡roy faedÓ¼no=%d)", 
”ºo
);

199  
¡©us
;

200 
	}
}

206 
ucc_¡©us_t
 
	$ucc__mlx5_š™_mkeys
(
ucc__mlx5_‹am_t
 *
‹am
,

207 
ucc_ba£_lib_t
 *
lib
)

209 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

210 
ucc__mlx5_®ÉßÎ_node_t
 *
node
 = &
a2a
->node;

211 
i
, 
j
, 
k
, 
l
;

212 
ucc_¡©us_t
 
¡©us
;

214 
i
 = 0; i < 
MAX_OUTSTANDING_OPS
; i++) {

215 
node
->
İs
[
i
].
£nd_mkeys
 = (
mlx5dv_mkey
 **)
	`ucc_m®loc
(

216 (
mlx5dv_mkey
 *è* 
a2a
->
max_num_of_cŞumns
);

217 ià(!
node
->
İs
[
i
].
£nd_mkeys
) {

218 
	`_”rÜ
(
lib
, "failedo malloc");

219 
”r_m®loc
;

221 
node
->
İs
[
i
].
»cv_mkeys
 = (
mlx5dv_mkey
 **)
	`ucc_m®loc
(

222 (
mlx5dv_mkey
 *è* 
a2a
->
max_num_of_cŞumns
);

223 ià(!
node
->
İs
[
i
].
»cv_mkeys
) {

224 
	`_”rÜ
(
lib
, "failedo malloc");

225 
	`ucc_ä“
(
node
->
İs
[
i
].
£nd_mkeys
);

226 
”r_m®loc
;

228 
j
 = 0; j < 
a2a
->
max_num_of_cŞumns
; j++) {

229 
¡©us
 = 
	`ü—‹_ma¡”_key
(
node
->
sbgp
->
group_size
 + 1, 
a2a
->
pd
,

230 &
node
->
İs
[
i
].
£nd_mkeys
[
j
], 
lib
);

231 ià(
¡©us
 !ğ
UCC_OK
) {

232 
	`_”rÜ
(
lib
, "çedØü—‹ s’d ma¡”key [%d,%d]", 
i
, 
j
);

233 
”r_ü—‹_mkey
;

235 
¡©us
 = 
	`ü—‹_ma¡”_key
(
node
->
sbgp
->
group_size
 + 1, 
a2a
->
pd
,

236 &
node
->
İs
[
i
].
»cv_mkeys
[
j
], 
lib
);

237 ià(
¡©us
 !ğ
UCC_OK
) {

238 
	`_”rÜ
(
lib
, "çedØü—‹„ecv ma¡”key [%d,%d]", 
i
, 
j
);

239 ià(!
	`mlx5dv_de¡roy_mkey
(
node
->
İs
[
i
].
£nd_mkeys
[
j
])) {

240 
	`_”rÜ
(
lib
, "mkey de¡roy faedÓ¼no=%d)", 
”ºo
);

242 
”r_ü—‹_mkey
;

247 
¡©us
 = 
	`ü—‹_ªd_pİuÏ‹_»cv_‹am_mkey
(
‹am
, 
lib
);

248 ià(
¡©us
 !ğ
UCC_OK
) {

249 
	`_”rÜ
(
lib
, "failedo create„ecvop masterkey");

250 
”r_m®loc
;

253  
UCC_OK
;

255 
”r_ü—‹_mkey
:

256 
l
 = 0;† < 
j
;†++) {

257 ià(!
	`mlx5dv_de¡roy_mkey
(
node
->
İs
[
i
].
»cv_mkeys
[
l
])) {

258 
	`_”rÜ
(
lib
, "mkey de¡roy faedÓ¼no=%d)", 
”ºo
);

261 
	`ucc_ä“
(
node
->
İs
[
i
].
»cv_mkeys
);

262 
	`ucc_ä“
(
node
->
İs
[
i
].
£nd_mkeys
);

263 
”r_m®loc
:

264 
k
 = 0; k < 
i
; k++) {

265 
l
 = 0;† < 
a2a
->
max_num_of_cŞumns
;†++) {

266 ià(!
	`mlx5dv_de¡roy_mkey
(
node
->
İs
[
k
].
£nd_mkeys
[
l
])) {

267 
	`_”rÜ
(
lib
, "mkey de¡roy faedÓ¼no=%d)", 
”ºo
);

269 ià(!
	`mlx5dv_de¡roy_mkey
(
node
->
İs
[
k
].
»cv_mkeys
[
l
])) {

270 
	`_”rÜ
(
lib
, "mkey de¡roy faedÓ¼no=%d)", 
”ºo
);

273 
	`ucc_ä“
(
node
->
İs
[
k
].
£nd_mkeys
);

274 
	`ucc_ä“
(
node
->
İs
[
k
].
»cv_mkeys
);

276  
UCC_ERR_NO_MESSAGE
;

277 
	}
}

284 
ucc_¡©us_t
 
	$ucc__mlx5_pİuÏ‹_£nd_»cv_mkeys
(
ucc__mlx5_‹am_t
 * 
‹am
,

285 
ucc__mlx5_scheduË_t
 *
»q
)

287 
£nd_mem_acûss_æags
 = 0;

288 
ucc__mlx5_®ÉßÎ_t
 * 
a2a
 = 
‹am
->a2a;

289 
ucc__mlx5_®ÉßÎ_node_t
 *
node
 = &
a2a
->node;

290 
»cv_mem_acûss_æags
 =

291 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
;

292 
nbc
 = 
»q
->
®ÉßÎ
.
num_of_blocks_cŞumns
;

293 
£q_šdex
 = 
»q
->
®ÉßÎ
.seq_index;

294 
n_mkeys
 = 
nbc
 ?‚bc : 1;

295 
»³©_couÁ
;

296 
i
;

297 
ucc_¡©us_t
 
¡©us
;

299 ià(
	`ucc__mlx5_g‘_my_ù¾
(
a2a
, 
£q_šdex
)->
mkey_ÿche_æag
 &

300 
UCC_MLX5_NEED_SEND_MKEY_UPDATE
) {

301 
»³©_couÁ
 = 
nbc
 ? 
a2a
->
Ãt
.
sbgp
->
group_size


302 : 
	`UCC_TL_TEAM_SIZE
(
‹am
è/ 
»q
->
®ÉßÎ
.
block_width
;

303 
i
 = 0; i < 
n_mkeys
; i++) {

304 
¡©us
 = 
	`pİuÏ‹_¡rided_mkey
(
a2a
, 
£nd_mem_acûss_æags
,

305 
node
->
İs
[
£q_šdex
].
£nd_mkeys
[
i
],

306 
	`SEND_UMR_DATA
(
»q
, 
a2a
, 
i
),

307 
»³©_couÁ
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

308 ià(
¡©us
 !ğ
UCC_OK
) {

309 
	`_”rÜ
(
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
),

310 "FaedØpİuÏ‹ s’d umr[%d,%d]", 
£q_šdex
, 
i
);

311  
¡©us
;

315 ià(
	`ucc__mlx5_g‘_my_ù¾
(
a2a
, 
£q_šdex
)->
mkey_ÿche_æag
 &

316 
UCC_MLX5_NEED_RECV_MKEY_UPDATE
) {

317 
»³©_couÁ
 =

318 
nbc
 ? 
a2a
->
Ãt
.
sbgp
->
group_size


319 : 
	`UCC_TL_TEAM_SIZE
(
‹am
è/ 
»q
->
®ÉßÎ
.
block_height
;

320 
i
 = 0; i < 
n_mkeys
; i++) {

321 
¡©us
 = 
	`pİuÏ‹_¡rided_mkey
(
a2a
, 
»cv_mem_acûss_æags
,

322 
node
->
İs
[
£q_šdex
].
»cv_mkeys
[
i
],

323 
	`RECV_UMR_DATA
(
»q
, 
a2a
, 
i
),

324 
»³©_couÁ
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

325 ià(
¡©us
 !ğ
UCC_OK
) {

326 
	`_”rÜ
(
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
),

327 "FaedØpİuÏ‹„ecv umr[%d,%d]", 
£q_šdex
, 
i
);

328  
¡©us
;

332  
UCC_OK
;

333 
	}
}

335 
	$upd©e_mkey_’Œy
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

336 
ucc__mlx5_scheduË_t
 *
»q
, 
dœeùiÚ_£nd
)

338 
ucc__mlx5_®ÉßÎ_node_t
 *
node
 = &
a2a
->node;

339 
block_height
 = 
»q
->
®ÉßÎ
.block_height;

340 
block_width
 = 
»q
->
®ÉßÎ
.block_width;

341 
size_t
 
msg_size
 = 
»q
->
®ÉßÎ
.msg_size;

342 
nbc
 = 
»q
->
®ÉßÎ
.
num_of_blocks_cŞumns
;

343 
ibv_mr
 *
buff
 = 
dœeùiÚ_£nd


344 ? 
»q
->
®ÉßÎ
.
£nd_rÿche_»giÚ_p
->
»g
.
mr


345 : 
»q
->
®ÉßÎ
.
»cv_rÿche_»giÚ_p
->
»g
.
mr
;

346 
mlx5dv_mr_š‹¾—ved
 *
mkey_’Œy
;

347 
i
;

349 ià(!
nbc
) {

350 
mkey_’Œy
 = (
umr_t
 *)(
dœeùiÚ_£nd
 ? 
	`MY_SEND_UMR_DATA
(
»q
, 
a2a
, 0)

351 : 
	`MY_RECV_UMR_DATA
(
»q
, 
a2a
, 0));

352 
mkey_’Œy
->
addr
 = (
ušŒ_t
)
buff
->addr;

353 
mkey_’Œy
->
by‹s_couÁ
 =

354 (
dœeùiÚ_£nd
 ? 
block_width
 : 
block_height
è* 
msg_size
;

355 
mkey_’Œy
->
by‹s_sk
 = 0;

356 
mkey_’Œy
->
lkey
 = 
dœeùiÚ_£nd
 ? 
buff
->lkey : buff->
rkey
;

358 
i
 = 0; i < 
nbc
; i++) {

359 
	`ucc_as£¹
(
block_height
 =ğ
block_width
);

360 
mkey_’Œy
 =

361 (
umr_t
 *)(
dœeùiÚ_£nd
 ? 
	`MY_SEND_UMR_DATA
(
»q
, 
a2a
, 
i
)

362 : 
	`MY_RECV_UMR_DATA
(
»q
, 
a2a
, 
i
));

363 
mkey_’Œy
->
addr
 =

364 (
ušŒ_t
)
buff
->
addr
 + 
i
 * (
block_height
 * 
msg_size
);

365 
mkey_’Œy
->
by‹s_couÁ
 =

366 (
i
 =ğ(
nbc
 - 1))

367 ? ((
node
->
sbgp
->
group_size
 % 
block_height
è* 
msg_size
)

368 : (
block_height
 * 
msg_size
);

369 
mkey_’Œy
->
by‹s_sk
 =

370 (
i
 =ğ(
nbc
 - 1))

371 ? ((
node
->
sbgp
->
group_size
 -

372 (
node
->
sbgp
->
group_size
 % 
block_height
)) *

373 
msg_size
)

374 : ((
node
->
sbgp
->
group_size
 - 
block_height
è* 
msg_size
);

375 
mkey_’Œy
->
lkey
 = 
dœeùiÚ_£nd
 ? 
buff
->lkey : buff->
rkey
;

378 
	}
}

385 
ucc_¡©us_t
 
	$ucc__mlx5_upd©e_mkeys_’Œ›s
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

386 
ucc__mlx5_scheduË_t
 *
»q
,

387 
æag
)

389 ià(
æag
 & 
UCC_MLX5_NEED_SEND_MKEY_UPDATE
) {

390 
	`upd©e_mkey_’Œy
(
a2a
, 
»q
, 1);

392 ià(
æag
 & 
UCC_MLX5_NEED_RECV_MKEY_UPDATE
) {

393 
	`upd©e_mkey_’Œy
(
a2a
, 
»q
, 0);

395  
UCC_OK
;

396 
	}
}

401 
ucc_¡©us_t
 
	$ucc__mlx5_de¡roy_umr
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

402 
ucc_ba£_lib_t
 *
lib
)

404 ià(
	`ibv_de¡roy_qp
(
a2a
->
Ãt
.
umr_qp
)) {

405 
	`_”rÜ
(
lib
, "um¸q°de¡roy faed (”ºo=%d)", 
”ºo
);

406  
UCC_ERR_NO_MESSAGE
;

408 ià(
	`ibv_de¡roy_cq
(
a2a
->
Ãt
.
umr_cq
)) {

409 
	`_”rÜ
(
lib
, "um¸cq de¡roy faed (”ºo=%d)", 
”ºo
);

410  
UCC_ERR_NO_MESSAGE
;

412  
UCC_OK
;

413 
	}
}

418 
ucc_¡©us_t
 
	$ucc__mlx5_de¡roy_mkeys
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

419 
”rÜ_mode
, 
ucc_ba£_lib_t
 *
lib
)

421 
i
, 
j
;

422 
ucc__mlx5_®ÉßÎ_node_t
 *
node
 = &
a2a
->node;

423 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

425 
i
 = 0; i < 
MAX_OUTSTANDING_OPS
; i++) {

426 
j
 = 0; j < 
a2a
->
max_num_of_cŞumns
; j++) {

427 ià(
	`mlx5dv_de¡roy_mkey
(
node
->
İs
[
i
].
£nd_mkeys
[
j
])) {

428 ià(!
”rÜ_mode
) {

429 
	`_”rÜ
(
lib
, "mkey de¡roy faedÓ¼no=%d)", 
”ºo
);

430 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

433 ià(
	`mlx5dv_de¡roy_mkey
(
node
->
İs
[
i
].
»cv_mkeys
[
j
])) {

434 ià(!
”rÜ_mode
) {

435 
	`_”rÜ
(
lib
, "mkey de¡roy faedÓ¼no=%d)", 
”ºo
);

436 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

440 
	`ucc_ä“
(
node
->
İs
[
i
].
£nd_mkeys
);

441 
	`ucc_ä“
(
node
->
İs
[
i
].
»cv_mkeys
);

443 ià(
	`mlx5dv_de¡roy_mkey
(
node
->
‹am_»cv_mkey
)) {

444 ià(!
”rÜ_mode
) {

445 
	`_”rÜ
(
lib
, "mkey de¡roy faedÓ¼no=%d)", 
”ºo
);

446 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

449  
¡©us
;

450 
	}
}

	@src/components/tl/mlx5/alltoall/alltoall_mkeys.h

7 #iâdeà
UCC_TL_MLX5_MKEYS_H


8 
	#UCC_TL_MLX5_MKEYS_H


	)

10 
ucc__mlx5_cÚ‹xt
 
	tucc__mlx5_cÚ‹xt_t
;

11 
ucc__mlx5_®ÉßÎ
 
	tucc__mlx5_®ÉßÎ_t
;

12 
ucc__mlx5_scheduË
 
	tucc__mlx5_scheduË_t
;

13 
ucc__mlx5_‹am
 
	tucc__mlx5_‹am_t
;

14 
ucc__mlx5_lib
 
	tucc__mlx5_lib_t
;

15 
ucc_ba£_lib
 
	tucc_ba£_lib_t
;

17 
	#UMR_CQ_SIZE
 8

	)

19 
ucc_¡©us_t
 
ucc__mlx5_®ÉßÎ_š™_umr
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

20 
ucc_ba£_lib_t
 *
lib
);

22 
ucc_¡©us_t
 
ucc__mlx5_š™_mkeys
(
ucc__mlx5_‹am_t
 *
‹am
,

23 
ucc_ba£_lib_t
 *
lib
);

25 
ucc_¡©us_t
 
ucc__mlx5_pİuÏ‹_£nd_»cv_mkeys
(
ucc__mlx5_‹am_t
 *
‹am
,

26 
ucc__mlx5_scheduË_t
 *
»q
);

28 
ucc_¡©us_t
 
ucc__mlx5_upd©e_mkeys_’Œ›s
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

29 
ucc__mlx5_scheduË_t
 *
»q
,

30 
æag
);

32 
ucc_¡©us_t
 
ucc__mlx5_de¡roy_umr
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

33 
ucc_ba£_lib_t
 *
lib
);

35 
ucc_¡©us_t
 
ucc__mlx5_de¡roy_mkeys
(
ucc__mlx5_®ÉßÎ_t
 *
a2a
,

36 
”rÜ_mode
, 
ucc_ba£_lib_t
 *
lib
);

	@src/components/tl/mlx5/mcast/p2p/ucc_tl_mlx5_mcast_p2p.c

7 
	~"ucc__mlx5_mÿ¡_p2p.h
"

9 
šlše
 
	$ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_cb
(* 
cÚ‹xt
)

11 
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
obj
 =

12 (
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *)
cÚ‹xt
;

14 
	`ucc_as£¹
(
obj
 !ğ
NULL
 && obj->
com¶_cb
 != NULL);

16 
obj
->
	`com¶_cb
(obj);

18 
	`ucc_as£¹
(
obj
->
»q
 !ğ
NULL
);

20 
	`ucc_cŞËùive_fš®ize
(
obj
->
»q
);

21 
	}
}

23 
	$ucc__mlx5_mÿ¡_com¶‘iÚ_cb
(* 
cÚ‹xt
, 
ucc_¡©us_t
 
¡©us
)

25 
	`ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_cb
(
cÚ‹xt
);

26 
	}
}

28 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_do_p2p_bÿ¡_nb
(*
buf
, 
size_t


29 
Ën
, 
ucc_¿nk_t
 
my_‹am_¿nk
, ucc_¿nk_ˆ
de¡
,

30 
ucc_memÜy_ty³_t
 
mem_ty³
,

31 
ucc_‹am_h
 
‹am
, 
ucc_cŞl_ÿÎback_t
 *
ÿÎback
,

32 
ucc_cŞl_»q_h
 *
p2p_»q
, 
is_£nd
,

33 
ucc_ba£_lib_t
 *
lib
)

35 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

36 
ucc_cŞl_»q_h
 
»q
 = 
NULL
;

37 
ucc_cŞl_¬gs_t
 
¬gs
 = {0};

39 
¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_ACTIVE_SET
 |

40 
UCC_COLL_ARGS_FIELD_CB
;

41 
¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_BCAST
;

42 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
buf
;

43 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
Ën
;

44 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
UCC_DT_INT8
;

45 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

46 
¬gs
.
roÙ
 = 
is_£nd
 ? 
my_‹am_¿nk
 : 
de¡
;

47 
¬gs
.
cb
.cb = 
ÿÎback
->cb;

48 
¬gs
.
cb
.
d©a
 = 
ÿÎback
->data;

49 
¬gs
.
aùive_£t
.
size
 = 2;

50 
¬gs
.
aùive_£t
.
¡¬t
 = 
my_‹am_¿nk
;

51 
¬gs
.
aùive_£t
.
¡ride
 = ()
de¡
 - ()
my_‹am_¿nk
;

53 
¡©us
 = 
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
);

54 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

55 
	`_”rÜ
(
lib
, "nonblocking…2p init failed");

56  
¡©us
;

59 ((
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *)
¬gs
.
cb
.
d©a
)->
»q
 =„eq;

61 
¡©us
 = 
	`ucc_cŞËùive_po¡
(
»q
);

62 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

63 
	`_”rÜ
(
lib
, "nonblocking…2p…ost failed");

64  
¡©us
;

67 *
p2p_»q
 = 
»q
;

69  
¡©us
;

70 
	}
}

72 
šlše
 
ucc_¡©us_t
 
	$do_£nd_nb
(*
sbuf
, 
size_t
 
Ën
, 
ucc_¿nk_t


73 
my_‹am_¿nk
, 
ucc_¿nk_t
 
de¡
,

74 
ucc_memÜy_ty³_t
 
mem_ty³
, 
ucc_‹am_h
 
‹am
,

75 
ucc_cŞl_ÿÎback_t
 *
ÿÎback
,

76 
ucc_cŞl_»q_h
 *
»q
, 
ucc_ba£_lib_t
 *
lib
)

78  
	`ucc__mlx5_mÿ¡_do_p2p_bÿ¡_nb
(
sbuf
, 
Ën
, 
my_‹am_¿nk
, 
de¡
, 
mem_ty³
,

79 
‹am
, 
ÿÎback
, 
»q
, 1, 
lib
);

80 
	}
}

82 
šlše
 
ucc_¡©us_t
 
	$do_»cv_nb
(*
rbuf
, 
size_t
 
Ën
, 
ucc_¿nk_t


83 
my_‹am_¿nk
, 
ucc_¿nk_t
 
de¡
,

84 
ucc_memÜy_ty³_t
 
mem_ty³
, 
ucc_‹am_h
 
‹am
,

85 
ucc_cŞl_ÿÎback_t
 *
ÿÎback
,

86 
ucc_cŞl_»q_h
 *
»q
, 
ucc_ba£_lib_t
 *
lib
)

88  
	`ucc__mlx5_mÿ¡_do_p2p_bÿ¡_nb
(
rbuf
, 
Ën
, 
my_‹am_¿nk
, 
de¡
, 
mem_ty³
,

89 
‹am
, 
ÿÎback
, 
»q
, 0, 
lib
);

90 
	}
}

92 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_p2p_£nd_nb
(* 
¤c
, 
size_t
 
size
, 
ucc_¿nk_t


93 
¿nk
, 
ucc_memÜy_ty³_t
 
mem_ty³
, *
cÚ‹xt
,

94 
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t


95 *
obj
)

97 
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
 *
oob_p2p_ùx
 =

98 (
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
 *)
cÚ‹xt
;

99 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

100 
ucc_cŞl_»q_h
 
»q
 = 
NULL
;

101 
ucc_¿nk_t
 
my_‹am_¿nk
 = 
oob_p2p_ùx
->my_team_rank;

102 
ucc_‹am_h
 
‹am
 = 
oob_p2p_ùx
->
ba£_‹am
;

103 
ucc_cŞl_ÿÎback_t
 
ÿÎback
;

105 
ÿÎback
.
cb
 = 
ucc__mlx5_mÿ¡_com¶‘iÚ_cb
;

106 
ÿÎback
.
d©a
 = 
obj
;

108 
	`_Œaû
(
oob_p2p_ùx
->
lib
, "P2P: SENDØ%d Msg Siz%ld", 
¿nk
, 
size
);

109 
¡©us
 = 
	`do_£nd_nb
(
¤c
, 
size
, 
my_‹am_¿nk
, 
¿nk
, 
mem_ty³
, 
‹am
, &
ÿÎback
, &
»q
, 
oob_p2p_ùx
->
lib
);

111 ià(
¡©us
 < 0) {

112 
	`_”rÜ
(
oob_p2p_ùx
->
lib
, "nonblocking…2p send failed");

113  
¡©us
;

116  
¡©us
;

117 
	}
}

119 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_p2p_»cv_nb
(*
d¡
, 
size_t
 
size
, 
ucc_¿nk_t


120 
¿nk
, 
ucc_memÜy_ty³_t
 
mem_ty³
, *
cÚ‹xt
,

121 
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t


122 *
obj
)

124 
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
 *
oob_p2p_ùx
 =

125 (
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
 *)
cÚ‹xt
;

126 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

127 
ucc_cŞl_»q_h
 
»q
 = 
NULL
;

128 
ucc_¿nk_t
 
my_‹am_¿nk
 = 
oob_p2p_ùx
->my_team_rank;

129 
ucc_‹am_h
 
‹am
 = 
oob_p2p_ùx
->
ba£_‹am
;

130 
ucc_cŞl_ÿÎback_t
 
ÿÎback
;

132 
ÿÎback
.
cb
 = 
ucc__mlx5_mÿ¡_com¶‘iÚ_cb
;

133 
ÿÎback
.
d©a
 = 
obj
;

135 
	`_Œaû
(
oob_p2p_ùx
->
lib
, "P2P: RECVØ%d Msg Siz%ld", 
¿nk
, 
size
);

136 
¡©us
 = 
	`do_»cv_nb
(
d¡
, 
size
, 
my_‹am_¿nk
, 
¿nk
, 
mem_ty³
, 
‹am
, &
ÿÎback
, &
»q
, 
oob_p2p_ùx
->
lib
);

138 ià(
¡©us
 < 0) {

139 
	`_”rÜ
(
oob_p2p_ùx
->
lib
, "nonblocking…2p„ecv failed");

140  
¡©us
;

143  
¡©us
;

144 
	}
}

146 
ucc_¡©us_t
 
	$ucc__mlx5_Úe_sided_p2p_put
(* 
¤c
, * 
»mÙe_addr
, 
size_t
 
Ëngth
,

147 
ušt32_t
 
lkey
, ušt32_ˆ
rkey
, 
ucc_¿nk_t
 
rg‘_¿nk
,

148 
ušt64_t
 
wr_id
, 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

150 
ibv_£nd_wr
 
swr
 = {0};

151 
ibv_sge
 
ssg
 = {0};

152 
ibv_£nd_wr
 *
bad_wr
;

153 
rc
;

155 ià(
UINT32_MAX
 < 
Ëngth
) {

156 
	`_”rÜ
(
comm
->
lib
, "msgoo†arge for…2p…ut");

157  
UCC_ERR_NOT_SUPPORTED
;

160 
ssg
.
addr
 = (
ušt64_t
)
¤c
;

161 
ssg
.
Ëngth
 = (
ušt32_t
)length;

162 
ssg
.
lkey
 =†key;

163 
swr
.
sg_li¡
 = &
ssg
;

164 
swr
.
num_sge
 = 1;

166 
swr
.
İcode
 = 
IBV_WR_RDMA_WRITE
;

167 
swr
.
wr_id
 = wr_id;

168 
swr
.
£nd_æags
 = 
IBV_SEND_SIGNALED
;

169 
swr
.
wr
.
rdma
.
»mÙe_addr
 = (
ušt64_t
)remote_addr;

170 
swr
.
wr
.
rdma
.
rkey
 =„key;

171 
swr
.
Ãxt
 = 
NULL
;

173 
	`_Œaû
(
comm
->
lib
, "RDMA WRITEo„ank %d size†ength %ld„emote‡ddress %p„key %d†key %d src %p",

174 
rg‘_¿nk
, 
Ëngth
, 
»mÙe_addr
, 
rkey
, 
lkey
, 
¤c
);

176 ià(0 !ğ(
rc
 = 
	`ibv_po¡_£nd
(
comm
->
mÿ¡
.
rc_qp
[
rg‘_¿nk
], &
swr
, &
bad_wr
))) {

177 
	`_”rÜ
(
comm
->
lib
, "RDMA Write failed„c %d„ank %d„emote‡ddresss %p„key %d",

178 
rc
, 
rg‘_¿nk
, 
»mÙe_addr
, 
rkey
);

179  
UCC_ERR_NO_MESSAGE
;

182  
UCC_OK
;

183 
	}
}

185 
ucc_¡©us_t
 
	$ucc__mlx5_Úe_sided_p2p_g‘
(* 
¤c
, * 
»mÙe_addr
, 
size_t
 
Ëngth
,

186 
ušt32_t
 
lkey
, ušt32_ˆ
rkey
, 
ucc_¿nk_t
 
rg‘_¿nk
,

187 
ušt64_t
 
wr_id
, 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

189 
ibv_£nd_wr
 
swr
 = {0};

190 
ibv_sge
 
ssg
 = {0};

191 
ibv_£nd_wr
 *
bad_wr
;

192 
rc
;

194 ià(
UINT32_MAX
 < 
Ëngth
) {

195 
	`_”rÜ
(
comm
->
lib
, "msgoo†arge for…2p get");

196  
UCC_ERR_NOT_SUPPORTED
;

199 
ssg
.
addr
 = (
ušt64_t
)
¤c
;

200 
ssg
.
Ëngth
 = (
ušt32_t
)length;

201 
ssg
.
lkey
 =†key;

202 
swr
.
sg_li¡
 = &
ssg
;

203 
swr
.
num_sge
 = 1;

205 
swr
.
İcode
 = 
IBV_WR_RDMA_READ
;

206 
swr
.
wr_id
 = wr_id;

207 
swr
.
£nd_æags
 = 
IBV_SEND_SIGNALED
;

208 
swr
.
wr
.
rdma
.
»mÙe_addr
 = (
ušt64_t
)remote_addr;

209 
swr
.
wr
.
rdma
.
rkey
 =„key;

210 
swr
.
Ãxt
 = 
NULL
;

212 
	`_Œaû
(
comm
->
lib
, "RDMA READo„ank %d size†ength %ld„emote‡ddress %p„key %d†key %d src %p",

213 
rg‘_¿nk
, 
Ëngth
, 
»mÙe_addr
, 
rkey
, 
lkey
, 
¤c
);

215 ià(0 !ğ(
rc
 = 
	`ibv_po¡_£nd
(
comm
->
mÿ¡
.
rc_qp
[
rg‘_¿nk
], &
swr
, &
bad_wr
))) {

216 
	`_”rÜ
(
comm
->
lib
, "RDMA Read failed„c %d„ank %d„emote‡ddresss %p„key %d",

217 
rc
, 
rg‘_¿nk
, 
»mÙe_addr
, 
rkey
);

218  
UCC_ERR_NO_MESSAGE
;

221  
UCC_OK
;

222 
	}
}

	@src/components/tl/mlx5/mcast/p2p/ucc_tl_mlx5_mcast_p2p.h

7 
	~<ucc/­i/ucc.h
>

8 
	~"compÚ’ts//mlx5/mÿ¡/_mlx5_mÿ¡.h
"

10 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_p2p_£nd_nb
(* 
¤c
, 
size_t
 
size
, 
ucc_¿nk_t


11 
¿nk
, 
ucc_memÜy_ty³_t
 
mem_ty³
, *
cÚ‹xt
,

12 
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t


13 *
obj
);

15 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_p2p_»cv_nb
(* 
d¡
, 
size_t
 
size
, 
ucc_¿nk_t


16 
¿nk
, 
ucc_memÜy_ty³_t
 
mem_ty³
, *
cÚ‹xt
,

17 
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t


18 *
obj
);

20 
ucc_¡©us_t
 
ucc__mlx5_Úe_sided_p2p_put
(* 
¤c
, * 
»mÙe_addr
, 
size_t
 
Ëngth
,

21 
ušt32_t
 
lkey
, ušt32_ˆ
rkey
, 
ucc_¿nk_t
 
rg‘_¿nk
,

22 
ušt64_t
 
wr_id
, 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

24 
ucc_¡©us_t
 
ucc__mlx5_Úe_sided_p2p_g‘
(* 
¤c
, * 
»mÙe_addr
, 
size_t
 
Ëngth
,

25 
ušt32_t
 
lkey
, ušt32_ˆ
rkey
, 
ucc_¿nk_t
 
rg‘_¿nk
,

26 
ušt64_t
 
wr_id
, 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast.h

7 #iâdeà
UCC_MCAST_H


8 
	#UCC_MCAST_H


	)

10 
	~<šfšibªd/ib.h
>

11 
	~<šfšibªd/umad.h
>

12 
	~<šfšibªd/v”bs.h
>

13 
	~<rdma/rdma_v”bs.h
>

14 
	~"uts/ucc_li¡.h
"

15 
	~"uts/ucc_mpoŞ.h
"

16 
	~"compÚ’ts//ucc_.h
"

17 
	~"compÚ’ts//ucc__log.h
"

18 
	~"uts/ucc_rÿche.h
"

19 
	~"cÜe/ucc_£rviû_cŞl.h
"

20 
	~"compÚ’ts/mc/ucc_mc.h
"

22 
	#POLL_PACKED
 16

	)

23 
	#REL_DONE
 ((*)-1)

	)

24 
	#NB_POLL
 8

	)

25 
	#NB_POLL_LARGE
 32

	)

26 
	#MULTICAST_QPN
 0xFFFFFF

	)

28 
	#DEF_QKEY
 0x1a1a1a1a

	)

29 
	#DEF_PKEY
 0xffff

	)

30 
	#DEF_PSN
 0

	)

31 
	#DEF_SL
 0

	)

32 
	#DEF_SRC_PATH_BITS
 0

	)

33 
	#GRH_LENGTH
 40

	)

34 
	#DROP_THRESHOLD
 10000

	)

35 
	#MAX_COMM_POW2
 32

	)

36 
	#MAX_GROUP_COUNT
 64

	)

39 
	#ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
 1024u

	)

40 
	#ONE_SIDED_SLOTS_COUNT
 2

	)

41 
	#ONE_SIDED_SLOTS_INFO_SIZE
 (è

	)

42 
	#ONE_SIDED_MAX_ZCOPY_COLL_COUNTER
 32u

	)

43 
	#ONE_SIDED_MAX_CONCURRENT_LEVEL
 64

	)

45 
	eucc__mlx5_mÿ¡_Úe_sided_¦Ù_¡©es
 {

46 
	mONE_SIDED_INVALID
 = -4,

47 
	mONE_SIDED_VALID
,

48 
	mONE_SIDED_PENDING_INFO
,

49 
	mONE_SIDED_PENDING_DATA
,

52 
	eucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_scheme
 {

53 
	mONE_SIDED_NO_RELIABILITY
 = 0,

54 
	mONE_SIDED_SYNCHRONOUS_PROTO
,

55 
	mONE_SIDED_ASYNCHRONOUS_PROTO


58 
	#CUDA_MEM_MCAST_BCAST_MAX_MSG
 4096

	)

61 
	mMCAST_PROTO_EAGER
,

62 
	mMCAST_PROTO_ZCOPY


66 
	mMCAST_P2P_NACK
,

67 
	mMCAST_P2P_ACK
,

68 
	mMCAST_P2P_NEED_NACK_SEND
,

69 
	mMCAST_P2P_NACK_SEND_PENDING


73 
	mMCAST_RECV_WR
 = 1,

74 
	mMCAST_WAIT_RECV_WR
,

75 
	mMCAST_SEND_WR
,

76 
	mMCAST_CALC_WR
,

77 
	mMCAST_BCASTRECV_WR
,

78 
	mMCAST_BCASTSEND_WR
,

79 
	mMCAST_AG_RDMA_READ_INFO_WR
,

80 
	mMCAST_AG_RDMA_READ_WR
,

83 
	gucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj
;

84 (*
	tucc__mlx5_mÿ¡_p2p_com¶‘iÚ_cb_â_t
)(
	tucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj
 *
	tobj
);

85 
	succ__mlx5_mÿ¡_p2p_com¶‘iÚ_obj
 {

86 
ucc_li¡_lšk_t
 
su³r
;

87 
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_cb_â_t
 
com¶_cb
;

88 
ušt64_t
 
d©a
[3];

89 
ucc_cŞl_»q_h
 
»q
;

90 } 
	tucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
;

92 (*
	tucc__mlx5_mÿ¡_p2p_wa™_cb_â_t
)(*
	twa™_¬g
);

94 
	$ucc_¡©us_t
 (*
	tucc__mlx5_mÿ¡_p2p_£nd_nb_â_t
)(* 
	t¤c
, 
	tsize_t
 
	tsize
,

95 
	tucc_¿nk_t
 
	t¿nk
, 
	tucc_memÜy_ty³_t
 
	tmem_ty³
, *
	tcÚ‹xt
,

96 
	tucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
	tcom¶_obj
);

99 
	$ucc_¡©us_t
 (*
	tucc__mlx5_mÿ¡_p2p_»cv_nb_â_t
)(* 
	t¤c
, 
	tsize_t
 
	tsize
,

100 
	tucc_¿nk_t
 
	t¿nk
, 
	tucc_memÜy_ty³_t
 
	tmem_ty³
, *
	tcÚ‹xt
,

101 
	tucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
	tcom¶_obj
);

103 
	succ__mlx5_mÿ¡_p2p_š‹rçû
 {

104 
ucc__mlx5_mÿ¡_p2p_£nd_nb_â_t
 
£nd_nb
;

105 
ucc__mlx5_mÿ¡_p2p_»cv_nb_â_t
 
»cv_nb
;

106 } 
	tucc__mlx5_mÿ¡_p2p_š‹rçû_t
;

108 
	succ__mlx5_mÿ¡_cŞl_comm_š™_¥ec
 {

109 
ucc__mlx5_mÿ¡_p2p_š‹rçû_t
 
p2p_içû
;

110 
sx_d•th
;

111 
rx_d•th
;

112 
sx_sge
;

113 
rx_sge
;

114 
sx_šlše
;

115 
po¡_»cv_th»sh
;

116 
scq_mod”©iÚ
;

117 
wsize
;

118 
mÿ¡_group_couÁ
;

119 
max_push_£nd
;

120 
max_—g”
;

121 
cuda_mem_’abËd
;

122 
Úe_sided_»lŸb™y_’abË
;

123 
»lŸb™y_scheme_msg_th»shŞd
;

124 
Œuly_z”o_cİy_®lg©h”_’abËd
;

125 
Œuly_z”o_cİy_bÿ¡_’abËd
;

126 
Œuly_z”o_cİy_cŞl_mš_msg
;

127 
mÿ¡_´•o¡_buck‘_size
;

128 
hÿ_cİy_’abËd
;

129 *
oob
;

130 } 
	tucc__mlx5_mÿ¡_cŞl_comm_š™_¥ec_t
;

132 
	succ__mlx5_mÿ¡_cÚ‹xt_cÚfig
 {

133 
ucc__cÚ‹xt_cÚfig_t
 
su³r
;

134 *
dev_li¡
;

135 
u£_rÿche
;

136 
size_t
 
»g_th»shŞd
;

137 
¿nd_£ed
;

138 
u´og»ss_num_pŞls
;

139 
cÚ‹xt_³r_‹am
;

140 } 
	tucc__mlx5_mÿ¡_cÚ‹xt_cÚfig_t
;

142 
	succ__mlx5_mÿ¡_oob_ùx
 {

143 *
ùx
;

145 
ucc_oob_cŞl_t
 *
oob
;

146 
ucc_sub£t_t
 
sub£t
;

148 } 
	tucc__mlx5_mÿ¡_oob_ùx_t
;

150 
	succ__mlx5_mÿ¡_»g
 {

151 *
mr
;

152 } 
	tucc__mlx5_mÿ¡_»g_t
;

154 
	succ__mlx5_mÿ¡_rÿche_»giÚ
 {

155 
ucc_rÿche_»giÚ_t
 
su³r
;

156 
ucc__mlx5_mÿ¡_»g_t
 
»g
;

157 } 
	tucc__mlx5_mÿ¡_rÿche_»giÚ_t
;

159 
	succ__mlx5_mÿ¡_ùx_·¿ms
 {

160 
ucc_‹º¬y_auto_v®ue_t
 
mÿ¡_’abËd
;

161 *
ib_dev_Çme
;

162 
´št_Çck_¡©s
;

163 
timeout
;

164 
mÿ¡_bÿ¡_’abËd
;

165 
mÿ¡_®lg©h”_’abËd
;

166 } 
	tucc__mlx5_mÿ¡_ùx_·¿ms_t
;

168 
	succ__mlx5_mÿ¡_cŞl_cÚ‹xt
 {

169 
ibv_cÚ‹xt
 *
ùx
;

170 
ibv_pd
 *
pd
;

171 *
devÇme
;

172 
max_qp_wr
;

173 
u£r_´ovided_ib
;

174 
ib_pÜt
;

175 
pkey_šdex
;

176 
mtu
;

177 
ušt16_t
 
pÜt_lid
;

178 
rdma_cm_id
 *
id
;

179 
rdma_ev’t_chªÃl
 *
chªÃl
;

180 
ucc_mpoŞ_t
 
com¶_objeùs_mp
;

181 
ucc_mpoŞ_t
 
mÿ¡_»q_mp
;

182 
ucc_li¡_lšk_t
 
³ndšg_Çcks_li¡
;

183 
ucc_rÿche_t
 *
rÿche
;

184 
ucc__mlx5_mÿ¡_ùx_·¿ms_t
 
·¿ms
;

185 
ucc_ba£_lib_t
 *
lib
;

186 } 
	tucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
;

188 
	succ__mlx5_mÿ¡_još_šfo_t
 {

189 
ucc_¡©us_t
 
¡©us
;

190 
ušt16_t
 
dlid
[
MAX_GROUP_COUNT
];

191 
ibv_gid
 
dgid
[
MAX_GROUP_COUNT
];

192 } 
	tucc__mlx5_mÿ¡_još_šfo_t
;

194 
	succ__mlx5_mÿ¡_cÚ‹xt
 {

195 
ucc_th»ad_mode_t
 
tm
;

196 
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 
mÿ¡_cÚ‹xt
;

197 
ucc__mlx5_mÿ¡_cÚ‹xt_cÚfig_t
 
cfg
;

198 
ucc_‹º¬y_auto_v®ue_t
 
mÿ¡_’abËd
;

199 
mÿ¡_ùx_»ady
;

200 
ucc__mlx5_mÿ¡_oob_ùx_t
 
oob_ùx
;

201 
mÿ¡_bÿ¡_’abËd
;

202 
mÿ¡_®lg©h”_’abËd
;

203 } 
	tucc__mlx5_mÿ¡_cÚ‹xt_t
;

205 
	sµ_·ck‘
 {

206 
ucc_li¡_lšk_t
 
su³r
;

207 
ušt32_t
 
p¢
;

208 
Ëngth
;

209 
·ck‘_couÁ”
;

210 
ušŒ_t
 
cÚ‹xt
;

211 
qp_id
;

212 
ušŒ_t
 
buf
;

215 
	smÿ¡_group
 {

216 
ibv_qp
 *
qp
;

217 
ibv_ah
 *
ah
;

218 
ušt16_t
 
lid
;

219 
ibv_gid
 
mgid
;

220 
sockaddr_š6
 
mÿ¡_addr
;

223 
	smÿ¡_ùx
 {

224 
ibv_£nd_wr
 
swr
;

225 
ibv_sge
 
ssg
;

226 
ibv_cq
 *
scq
;

227 
ibv_cq
 *
rcq
;

228 
ibv_¤q
 *
¤q
;

229 
mÿ¡_group
 
groups
[
MAX_GROUP_COUNT
];

231 
ibv_qp
 **
rc_qp
;

234 
	s·ck‘
 {

235 
ty³
;

236 
ucc_¿nk_t
 
äom
;

237 
ušt32_t
 
p¢
;

238 
comm_id
;

241 
	succ__mlx5_mÿ¡_¦Ù_mem_šfo
 {

242 
ušt64_t
 
»mÙe_addr
;

243 
ušt32_t
 
rkey
;

244 } 
	tucc__mlx5_mÿ¡_¦Ù_mem_šfo_t
;

246 
	succ__mlx5_Úe_sided_»lŸbË_‹am_šfo
 {

247 
ucc__mlx5_mÿ¡_¦Ù_mem_šfo_t
 
¦Ù_mem
;

248 
ušt16_t
 
pÜt_lid
;

249 
ušt32_t
 
rc_qp_num
[
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
];

250 } 
	tucc__mlx5_Úe_sided_»lŸbË_‹am_šfo_t
;

252 
	succ__mlx5_mÿ¡_³r_qp_po¡ed_»cv_šfo
 {

253 
ucc_li¡_lšk_t
 
po¡ed_»cv_bufs
;

254 
po¡ed_»cvs_couÁ
;

255 } 
	tucc__mlx5_mÿ¡_³r_qp_po¡ed_»cv_šfo_t
;

257 
	succ__mlx5_mÿ¡_Úe_sided_»lŸb™y_comm
 {

261 
ucc__mlx5_Úe_sided_»lŸbË_‹am_šfo_t
 *
šfo
;

265 
ucc__mlx5_mÿ¡_¦Ù_mem_šfo_t
 *
£ndbuf_memkey_li¡
;

267 
ušt32_t
 *
»cvd_pkts_Œack”
;

270 *
»mÙe_¦Ù_šfo
;

271 
ibv_mr
 *
»mÙe_¦Ù_šfo_mr
;

272 
»lŸb™y_scheme_msg_th»shŞd
;

274 *
¦Ùs_bufãr
;

275 
ibv_mr
 *
¦Ùs_mr
;

277 
¦Ù_size
;

279 
ucc_£rviû_cŞl_»q_t
 *
»lŸb™y_»q
;

280 
»lŸb™y_’abËd
;

281 
»lŸb™y_»ady
;

282 
³ndšg_»ads
;

283 
hÿ_cİy_’abËd
;

284 
ucc__mlx5_mÿ¡_Úe_sided_¦Ù_¡©es
 
¦Ùs_¡©e
;

285 
ucc__mlx5_mÿ¡_³r_qp_po¡ed_»cv_šfo_t
 
po¡ed_»cv
[
MAX_GROUP_COUNT
];

286 } 
	tucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_comm_t
;

288 
	succ__mlx5_mÿ¡_£rviû_cŞl
 {

289 
	`ucc_¡©us_t
 (*
bÿ¡_po¡
è(*, *, 
size_t
, 
ucc_¿nk_t
, 
ucc_£rviû_cŞl_»q_t
**);

290 
	`ucc_¡©us_t
 (*
®lg©h”_po¡
è(*, *, *, 
size_t
, 
ucc_£rviû_cŞl_»q_t
**);

291 
	`ucc_¡©us_t
 (*
®Ìeduû_po¡
è(*, *, *, 
size_t
, 
ucc_d©©y³_t
, 
ucc_»duùiÚ_İ_t
, 
ucc_£rviû_cŞl_»q_t
**);

292 
	`ucc_¡©us_t
 (*
b¬r›r_po¡
è(*, 
ucc_£rviû_cŞl_»q_t
**);

293 
	`ucc_¡©us_t
 (*
cŞl_‹¡
è(
ucc_£rviû_cŞl_»q_t
*);

294 } 
	tucc__mlx5_mÿ¡_£rviû_cŞl_t
;

296 
	succ__mlx5_mÿ¡_®lg©h”_comm
 {

297 
ušt32_t
 
und”_´og»ss_couÁ”
;

298 
ušt32_t
 
cŞl_couÁ”
;

299 
ušt32_t
 
max_num_·ck‘s
;

300 
ušt32_t
 
max_push_£nd
;

301 
ušt8_t
 
Œuly_z”o_cİy_®lg©h”_’abËd
;

302 
ušt32_t
 
mÿ¡_´•o¡_buck‘_size
;

303 } 
	tucc__mlx5_mÿ¡_®lg©h”_comm_t
;

305 
	succ__mlx5_mÿ¡_bÿ¡_comm
 {

306 
ušt32_t
 
und”_´og»ss_couÁ”
;

307 
ušt32_t
 
cŞl_couÁ”
;

308 
ušt32_t
 
Ï¡_p¢
;

309 
ušt32_t
 
¿cks_n
;

310 
ušt32_t
 
§cks_n
;

311 
ušt32_t
 
Ï¡_acked
;

312 
ušt32_t
 
chd_n
;

313 
ušt32_t
 
·»Á_n
;

314 
·ck‘
 
p2p_pkt
[
MAX_COMM_POW2
];

315 
·ck‘
 
p2p_¥kt
[
MAX_COMM_POW2
];

316 
»lŸbË_š_´og»ss
;

317 
»cv_drİ_·ck‘_š_´og»ss
;

318 
ucc_¿nk_t
 
·»Ás
[
MAX_COMM_POW2
];

319 
ucc_¿nk_t
 
chd»n
[
MAX_COMM_POW2
];

320 
Çck_»que¡s
;

321 
Çcks_couÁ”
;

322 
n_mÿ¡_»lŸbË
;

323 
wsize
;

324 
ušt32_t
 
mÿ¡_´•o¡_buck‘_size
;

325 
ušt8_t
 
Œuly_z”o_cİy_bÿ¡_’abËd
;

326 
ušt32_t
 
max_push_£nd
;

327 } 
	tucc__mlx5_mÿ¡_bÿ¡_comm_t
;

329 
	succ__mlx5_mÿ¡_cŞl_comm
 {

330 
µ_·ck‘
 
dummy_·ck‘
;

331 
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
;

332 
ucc__mlx5_mÿ¡_cŞl_comm_š™_¥ec_t
 
·¿ms
;

333 
ucc__mlx5_mÿ¡_p2p_š‹rçû_t
 
p2p
;

334 
tx
;

335 
ucc_¿nk_t
 
¿nk
;

336 
ucc_¿nk_t
 
commsize
;

337 *
grh_buf
;

338 
ibv_mr
 *
grh_mr
;

339 
max_šlše
;

340 
size_t
 
max_—g”
;

341 
max_³r_·ck‘
;

342 
³ndšg_£nd
;

343 
³ndšg_»cv
;

344 
ibv_mr
 *
µ_mr
;

345 *
µ_buf
;

346 
ucc_mc_bufãr_h—d”_t
 *
µ_buf_h—d”
;

347 
µ_·ck‘
 *
µ
;

348 
ušt32_t
 
p¢
;

349 
buf_n
;

350 
ucc_li¡_lšk_t
 
bpoŞ
;

351 
ucc_li¡_lšk_t
 
³ndšg_q
;

352 
mÿ¡_ùx
 
mÿ¡
;

353 
ibv_»cv_wr
 *
ÿÎ_rwr
;

354 
ibv_sge
 *
ÿÎ_rsgs
;

355 
ušt64_t
 
tim”
;

356 
¡®Ëd
;

357 
comm_id
;

358 *
p2p_ùx
;

359 
ucc_ba£_lib_t
 *
lib
;

360 
cuda_mem_’abËd
;

361 
ucc__mlx5_mÿ¡_još_šfo_t
 *
group_£tup_šfo
;

362 
ucc_£rviû_cŞl_»q_t
 *
group_£tup_šfo_»q
;

363 
mÿ¡_Œª¥Üt_»ady
;

364 
Œª¥Üt_»ady_glob®
;

365 
ucc_£rviû_cŞl_»q_t
 *
Œª¥Üt_»ady_»q
;

366 
ucc__mlx5_mÿ¡_£rviû_cŞl_t
 
£rviû_cŞl
;

367 
rdma_cm_ev’t
 *
ev’t
;

368 
ucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_comm_t
 
Úe_sided
;

369 
mÿ¡_group_couÁ
;

370 
ucc__mlx5_mÿ¡_®lg©h”_comm_t
 
®lg©h”_comm
;

371 
ucc__mlx5_mÿ¡_bÿ¡_comm_t
 
bÿ¡_comm
;

372 
ušt32_t
 
Œuly_z”o_cİy_cŞl_mš_msg
;

373 
ucc__mlx5_mÿ¡_cÚ‹xt_t
 *
cÚ‹xt
;

375 
ibv_cq
 *
hÿ_cİy_cq
;

376 
ibv_qp
 *
hÿ_cİy_qp
;

377 
µ_·ck‘
 *
r_wšdow
[1];

378 } 
	tucc__mlx5_mÿ¡_cŞl_comm_t
;

380 
	succ__mlx5_mÿ¡_‹am
 {

381 
ucc__mlx5_mÿ¡_cÚ‹xt_t
 *
mÿ¡_cÚ‹xt
;

382 
ucc__mlx5_mÿ¡_cŞl_comm
 *
mÿ¡_comm
;

383 
ucc__mlx5_mÿ¡_oob_ùx_t
 
oob_ùx
;

384 } 
	tucc__mlx5_mÿ¡_‹am_t
;

387 
	succ__mlx5_mÿ¡_Çck_»q
 {

388 
ucc_li¡_lšk_t
 
su³r
;

389 
pkt_id
;

390 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
;

391 } 
	tucc__mlx5_mÿ¡_Çck_»q_t
;

393 
	#PSN_IS_IN_RANGE
(
_p¢
, 
_ÿÎ
, 
_comm
) \

395 ((
_p¢
 >ğ
_ÿÎ
->
¡¬t_p¢
) && \

396 (
_p¢
 < 
_ÿÎ
->
¡¬t_p¢
 + _ÿÎ->
num_·ck‘s
) && \

397 (
_p¢
 >ğ
_comm
->
bÿ¡_comm
.
Ï¡_acked
) && \

398 (
_p¢
 < 
_comm
->
bÿ¡_comm
.
Ï¡_acked
 + _comm->bÿ¡_comm.
wsize
)) \

399 )

	)

401 
	#PSN_TO_RECV_OFFSET
(
_p¢
, 
_ÿÎ
, 
_comm
) \

403 ((
±rdiff_t
)((
_p¢
 - 
_ÿÎ
->
¡¬t_p¢
) \

404 * (
_comm
->
max_³r_·ck‘
))) \

405 )

	)

407 
	#PSN_TO_RECV_LEN
(
_p¢
, 
_ÿÎ
, 
_comm
) \

409 ((
_p¢
 - 
_ÿÎ
->
¡¬t_p¢
 + 1) % \

410 
_ÿÎ
->
num_·ck‘s
 =ğ0 ? _ÿÎ->
Ï¡_pkt_Ën
 : \

411 
_comm
->
max_³r_·ck‘
) \

412 )

	)

414 
	#PSN_RECEIVED
(
_p¢
, 
_comm
) \

416 (
_comm
->
r_wšdow
[(
_p¢
) % \

417 
_comm
->
bÿ¡_comm
.
wsize
]->
p¢
 =ğ(
_p¢
)) \

418 )

	)

420 
	succ__mlx5_mÿ¡_‹nsÜ
 {

421 
group_id
;

422 
size_t
 
off£t
;

423 
size_t
 
off£t_Ëá
;

424 
roÙ
;

425 
couÁ
;

426 
to_»cv
;

427 
to_£nd_Ëá
;

428 } 
	tucc__mlx5_mÿ¡_‹nsÜ_t
;

430 
	succ__mlx5_mÿ¡_p–šed_ag_scheduË
 {

431 
ucc__mlx5_mÿ¡_‹nsÜ_t
 
muÉiÿ¡_İ
[
ONE_SIDED_MAX_CONCURRENT_LEVEL
];

432 
ucc__mlx5_mÿ¡_‹nsÜ_t
 
´•o¡_buf_İ
[
ONE_SIDED_MAX_CONCURRENT_LEVEL
];

433 
´•o¡_buf_İ_dÚe
;

434 
muÉiÿ¡_İ_dÚe
;

435 
tÙ®_¡•s
;

436 
num_»cvd
;

437 
to_»cv
;

438 
to_£nd
;

439 } 
	tucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
;

441 
	succ__mlx5_mÿ¡_cŞl_»q
 {

442 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
;

443 
size_t
 
Ëngth
;

444 
´Ùo
;

445 
ibv_mr
 *
mr
;

446 
ibv_mr
 *
»cv_mr
;

447 
ibv_»cv_wr
 *
rwr
;

448 
ibv_sge
 *
rsgs
;

449 *
¼eg
;

450 *
±r
;

451 *
½Œ
;

452 
am_roÙ
;

453 
ucc_¿nk_t
 
roÙ
;

454 **
rbufs
;

455 
fœ¡_£nd_p¢
;

456 
to_£nd
;

457 
to_»cv
;

458 
ucc_¿nk_t
 
·»Á
;

459 
ušt32_t
 
¡¬t_p¢
;

460 
num_·ck‘s
;

461 
Ï¡_pkt_Ën
;

462 
off£t
;

463 
ucc_memÜy_ty³_t
 
buf_mem_ty³
;

464 
ucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_scheme
 
Úe_sided_»lŸb™y_scheme
;

465 
ušt32_t
 
ag_couÁ”
;

466 
cÚcu¼’cy_Ëv–
;

467 
mÿ¡_´•o¡_buck‘_size
;

468 
¡©e
;

469 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
ag_scheduË
;

470 
tÙ®_¡•s
;

471 
¡•
;

472 
ucc_£rviû_cŞl_»q_t
 *
®lg©h”_rkeys_»q
;

473 
ucc_£rviû_cŞl_»q_t
 *
bÿ¡_rkeys_»q
;

474 
ucc_£rviû_cŞl_»q_t
 *
b¬r›r_»q
;

475 *
»cv_¼eg
;

476 
ucc_“_executÜ_sk_t
 *
exec_sk
;

477 
ucc_cŞl_sk_t
 *
cŞl_sk
;

478 
	`ucc_¡©us_t
 (*
´og»ss
è(*
»q
);

480 *
sü©ch_buf
;

481 
ucc_mc_bufãr_h—d”_t
 *
sü©ch_buf_h—d”
;

482 
sü©ch_·ck‘s_»ûived
;

483 } 
	tucc__mlx5_mÿ¡_cŞl_»q_t
;

485 
	succ__mlx5_mÿ¡_oob_p2p_cÚ‹xt
 {

486 
ucc_cÚ‹xt_h
 
ba£_ùx
;

487 
ucc_‹am_h
 
ba£_‹am
;

488 
ucc_¿nk_t
 
my_‹am_¿nk
;

489 
ucc_sub£t_t
 
sub£t
;

490 
ucc_ba£_lib_t
 *
lib
;

491 
tmp_sbuf
;

492 
tmp_rbuf
;

493 } 
	tucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
;

495 
šlše
 
µ_·ck‘
* 
	$ucc__mlx5_mÿ¡_buf_g‘_ä“
(
ucc__mlx5_mÿ¡_cŞl_comm_t
* 
comm
)

497 
µ_·ck‘
* 
µ
;

499 
µ
 = 
	`ucc_li¡_exŒaù_h—d
(&
comm
->
bpoŞ
, 
µ_·ck‘
, 
su³r
);

501 
	`ucc_as£¹
(
µ
 =ğ
NULL
 ||…p->
cÚ‹xt
 == 0);

503  
µ
;

504 
	}
}

506 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_po¡_»cv_bufãrs
(
ucc__mlx5_mÿ¡_cŞl_comm_t
* 
comm
)

508 
ibv_»cv_wr
 *
bad_wr
 = 
NULL
;

509 
ibv_»cv_wr
 *
rwr
 = 
comm
->
ÿÎ_rwr
;

510 
ibv_sge
 *
sge
 = 
comm
->
ÿÎ_rsgs
;

511 
µ_·ck‘
 *
µ
 = 
NULL
;

512 
i
;

513 
couÁ
;

514 
couÁ_³r_qp
;

516 
couÁ
 = 
comm
->
·¿ms
.
rx_d•th
 - comm->
³ndšg_»cv
;

517 ià(
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
 ||

518 
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
 ||

519 
couÁ
 <ğ
comm
->
·¿ms
.
po¡_»cv_th»sh
) {

520  
UCC_OK
;

523 
couÁ_³r_qp
 = 
couÁ
 / 
comm
->
mÿ¡_group_couÁ
;

524 
i
 = 0; i < 
couÁ_³r_qp
; i++) {

525 ià(
NULL
 =ğ(
µ
 = 
	`ucc__mlx5_mÿ¡_buf_g‘_ä“
(
comm
))) {

528 
rwr
[
i
].
wr_id
 = ((
ušt64_t
è
µ
);

529 
rwr
[
i
].
Ãxt
 = &rwr[i+1];

530 
sge
[2*
i
 + 1].
addr
 = 
µ
->
buf
;

531 
	`as£¹
((
ušt64_t
)
comm
->
µ
 <ğ
rwr
[
i
].
wr_id


532 && ((
ušt64_t
)
comm
->
µ
 + comm->
buf_n
 * (
µ_·ck‘
)è> 
rwr
[
i
].
wr_id
);

535 ià(
i
 > 0) {

536 
rwr
[
i
-1].
Ãxt
 = 
NULL
;

537 ià(
	`ibv_po¡_»cv
(
comm
->
mÿ¡
.
groups
[0].
qp
, &
rwr
[0], &
bad_wr
)) {

538 
	`_”rÜ
(
comm
->
lib
, "Failedo…repost„ecvs:ƒrrno %d qp index %d buffer count %d",

539 
”ºo
, 0, 
i
);

540  
UCC_ERR_NO_RESOURCE
;

542 
comm
->
³ndšg_»cv
 +ğ
i
;

545  
UCC_OK
;

546 
	}
}

548 
šlše
 
ušt64_t
 
	$ucc__mlx5_mÿ¡_g‘_tim”
()

550 
t_£cÚd
 = 
	`ucc_g‘_time
();

551  (
ušt64_t
è(
t_£cÚd
 * 1000000);

552 
	}
}

554 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_po¡_u£r_»cv_bufãrs
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

555 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

556 
group_id
, 
ucc_¿nk_t
 
roÙ
,

557 
cŞl_ty³
,

558 
couÁ
,

559 
size_t
 
off£t
)

561 
ibv_»cv_wr
 *
bad_wr
 = 
NULL
;

562 
ibv_»cv_wr
 *
rwr
 = 
comm
->
ÿÎ_rwr
;

563 
ibv_sge
 *
sge
 = 
comm
->
ÿÎ_rsgs
;

564 
µ_·ck‘
 *
µ
 = 
NULL
;

565 
ušt32_t
 
i
;

567 
i
 = 0; i < 
couÁ
; i++) {

568 ià(
NULL
 =ğ(
µ
 = 
	`ucc__mlx5_mÿ¡_buf_g‘_ä“
(
comm
))) {

569 
	`_”rÜ
(
comm
->
lib
, "notƒnought free…p…acketso coverheƒntire message");

570  
UCC_ERR_NO_RESOURCE
;

573 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
 &&

574 (
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
 ||

575 
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
)) {

577 
	`ucc_li¡_add_
(&
comm
->
Úe_sided
.
po¡ed_»cv
[
group_id
].
po¡ed_»cv_bufs
,

578 &
µ
->
su³r
);

581 
	`as£¹
(
off£t
 % 
comm
->
max_³r_·ck‘
 == 0);

582 
µ
->
·ck‘_couÁ”
 = 
off£t
 / 
comm
->
max_³r_·ck‘
;

583 
µ
->
qp_id
 = 
group_id
;

584 
rwr
[
i
].
wr_id
 = ((
ušt64_t
è
µ
);

585 ià(
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHER
) {

586 
sge
[2*
i
 + 1].
addr
 = (
ušt64_t
)
»q
->
½Œ
 + 
roÙ
 *„eq->
Ëngth
 + 
off£t
;

588 
	`ucc_as£¹
(
UCC_COLL_TYPE_BCAST
 =ğ
cŞl_ty³
);

589 
sge
[2*
i
 + 1].
addr
 = (
ušt64_t
)
»q
->
±r
 + 
off£t
;

591 
sge
[2*
i
 + 1].
lkey
 = 
»q
->
»cv_mr
->lkey;

592 
off£t
 +ğ
comm
->
max_³r_·ck‘
;

593 
sge
[2*
i
 + 1].
Ëngth
 = 
comm
->
max_³r_·ck‘
;

594 ià(
i
 < 
couÁ
 - 1) {

595 
rwr
[
i
].
Ãxt
 = &rwr[i+1];

599 ià(
i
 > 0) {

600 
rwr
[
i
-1].
Ãxt
 = 
NULL
;

601 ià(
	`ibv_po¡_»cv
(
comm
->
mÿ¡
.
groups
[
group_id
].
qp
, &
rwr
[0], &
bad_wr
)) {

602 
	`_”rÜ
(
comm
->
lib
, "failedo…repost„ecvs:ƒrrno %d buffer count %d",

603 
”ºo
, 
i
);

604  
UCC_ERR_NO_RESOURCE
;

606 
comm
->
³ndšg_»cv
 +ğ
i
;

607 
comm
->
Úe_sided
.
po¡ed_»cv
[
group_id
].
po¡ed_»cvs_couÁ
 +ğ
i
;

608 
	`_Œaû
(
comm
->
lib
, "posted %d buffers into„ecv queue with„oot %d mcast group %d"

610 
i
, 
roÙ
, 
group_id
, (
off£t
-(i*
comm
->
max_³r_·ck‘
))/comm->max_per_packet,

611 
off£t
/
comm
->
max_³r_·ck‘
);

614  
UCC_OK
;

615 
	}
}

617 
	#EXEC_TASK_TEST
(
_”rmsg
, 
_‘ask
, 
_lib
) do { \

618 ià(
_‘ask
 !ğ
NULL
) { \

619 
¡©us
 = 
	`ucc_“_executÜ_sk_‹¡
(
_‘ask
); \

620 ià(
¡©us
 > 0) { \

621  
¡©us
; \

623 
	`ucc_“_executÜ_sk_fš®ize
(
_‘ask
); \

624 
_‘ask
 = 
NULL
; \

625 ià(
	`ucc_uÆik–y
(
¡©us
 < 0)) { \

626 
	`_”rÜ
(
_lib
, 
_”rmsg
); \

627  
¡©us
; \

630 } 0)

	)

632 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_‹am_š™
(
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
,

633 
ucc__mlx5_mÿ¡_‹am_t
 **
mÿ¡_‹am
,

634 
ucc__mlx5_mÿ¡_cÚ‹xt_t
 *
ùx
,

635 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
,

636 
ucc__mlx5_mÿ¡_cŞl_comm_š™_¥ec_t
 *
mÿ¡_cÚf
);

638 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_‹am_‹¡
(
ucc_ba£_‹am_t
 *
‹am
);

640 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

641 
ucc_ba£_‹am_t
 *
‹am
,

642 
ucc_cŞl_sk_t
 **
sk_h
);

644 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_cÚ‹xt_š™
(
ucc__mlx5_mÿ¡_cÚ‹xt_t
 *
mÿ¡_ùx
,

645 
ucc__mlx5_mÿ¡_ùx_·¿ms_t
 *
mÿ¡_ùx_cÚf
);

648 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_ş—n_ùx
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
);

651 
	#_mlx5_mÿ¡_log
(
_mÿ¡_’abËd
, 
_lib
, 
_š‹nded_Ëv–
, 
_fmt
, ...) \

653 ià((
_mÿ¡_’abËd
è=ğ
UCC_YES
) { \

654 
	`ucc_log_compÚ’t
((
_š‹nded_Ëv–
), (
_lib
)->
log_compÚ’t
, (
_fmt
), ##
__VA_ARGS__
); \

655 } ià((
_mÿ¡_’abËd
è=ğ
UCC_TRY
) { \

656 
	`ucc_log_compÚ’t
(
UCC_LOG_LEVEL_DEBUG
, (
_lib
)->
log_compÚ’t
, (
_fmt
), ##
__VA_ARGS__
); \

658 } 0)

	)

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_allgather.c

7 
	~"_mlx5_mÿ¡_h–³r.h
"

8 
	~"_mlx5_cŞl.h
"

9 
	~"_mlx5_mÿ¡_rÿche.h
"

10 
	~"_mlx5_mÿ¡_´og»ss.h
"

11 
	~"_mlx5_mÿ¡_®lg©h”.h
"

12 
	~"_mlx5_mÿ¡_Úe_sided_´og»ss.h
"

13 
	~"_mlx5_mÿ¡_hÿ_cİy.h
"

14 
	~<š‰y³s.h
>

17 
	#TL_MLX5_MCAST_IB_IMMEDIATE_PACKET_BIT_COUNT
 32u

	)

19 
	#MCAST_GET_MAX_ALLGATHER_PACKET_COUNT
(
_max_couÁ
, 
_max_‹am
, 
_max_couÁ”
) \

21 
_max_couÁ
 = 2 << (
TL_MLX5_MCAST_IB_IMMEDIATE_PACKET_BIT_COUNT
 - \

22 
	`ucc_og2
(
_max_‹am
) - \

23 
	`ucc_og2
(
_max_couÁ”
)); \

24 } 0);

	)

26 
	#MCAST_ALLGATHER_IN_PROGRESS
(
_»q
, 
_comm
) \

27 (
_»q
->
to_£nd
 || _»q->
to_»cv
 || 
_comm
->
³ndšg_£nd
 || \

28 
_comm
->
Úe_sided
.
³ndšg_»ads
 || (
NULL
 !ğ
_»q
->
®lg©h”_rkeys_»q
) || \

29 (
_»q
->
ag_scheduË
 !ğ
NULL
 && _»q->
¡•
 !ğ_»q->ag_scheduË->
tÙ®_¡•s
))

	)

31 
šlše
 
ucc_¡©us_t


32 
	$ucc__mlx5_mÿ¡_check_¡agšg_ba£d_cŞËùive
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

33 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

35 
ucc_¡©us_t
 
¡©us
;

37 
	`ucc_as£¹
(
comm
->
Úe_sided
.
»lŸb™y_»ady
);

38 
	`ucc_as£¹
(
»q
->
®lg©h”_rkeys_»q
 =ğ
NULL
);

40 ià(
comm
->
Úe_sided
.
³ndšg_»ads
) {

41  
	`ucc__mlx5_mÿ¡_´og»ss_Úe_sided_communiÿtiÚ
(
comm
, 
»q
);

44 ià(!
»q
->
to_£nd
 && !»q->
to_»cv
) {

46  
UCC_OK
;

47 } ià(
»q
->
to_£nd
) {

49  
UCC_INPROGRESS
;

52 ià(!
comm
->
tim”
) {

53 ià(
comm
->
¡®Ëd
 < 
DROP_THRESHOLD
) {

54 
comm
->
¡®Ëd
++;

57 
comm
->
tim”
 = 
	`ucc__mlx5_mÿ¡_g‘_tim”
();

58 
comm
->
¡®Ëd
 = 0;

61 ià(
comm
->
¡®Ëd
 < 
DROP_THRESHOLD
) {

62 
comm
->
¡®Ëd
++;

65 ià(
	`ucc__mlx5_mÿ¡_g‘_tim”
(è- 
comm
->
tim”
 >=

66 
comm
->
ùx
->
·¿ms
.
timeout
) {

67 
	`_debug
(
comm
->
lib
, "[REL]ime out„eq->to_recv %d†eft out ofotal of %d…ackets",

68 
»q
->
to_»cv
,„eq->
num_·ck‘s
 * 
comm
->
commsize
);

69 
¡©us
 = 
	`ucc__mlx5_mÿ¡_¡agšg_®lg©h”_»lŸbË_Úe_sided_g‘
(
comm
, 
»q
, 
NULL
);

70 ià(
UCC_OK
 !ğ
¡©us
) {

71  
¡©us
;

74 
comm
->
¡®Ëd
 = 0;

79  
UCC_INPROGRESS
;

80 
	}
}

82 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_®lg©h”_»lŸb™y_»ady
(
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

84 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
»q
->comm;

85 
ucc__mlx5_mÿ¡_»g_t
 *
»g
 = 
NULL
;

86 
ucc_¡©us_t
 
¡©us
;

88 
	`ucc_as£¹
(
»q
->
ag_couÁ”
 =ğ
comm
->
®lg©h”_comm
.
und”_´og»ss_couÁ”
);

90 ià(!
comm
->
Úe_sided
.
»lŸb™y_’abËd
 || comm->Úe_sided.
»lŸb™y_»ady
) {

91  
UCC_OK
;

94 ià(
»q
->
®lg©h”_rkeys_»q
) {

95 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(
»q
->
®lg©h”_rkeys_»q
);

96 ià(
¡©us
 =ğ
UCC_OK
) {

97 
	`ucc_as£¹
(
ONE_SIDED_SYNCHRONOUS_PROTO
 =ğ
»q
->
Úe_sided_»lŸb™y_scheme
);

98 
»q
->
®lg©h”_rkeys_»q
 = 
NULL
;

99 
	`_Œaû
(
comm
->
lib
, "allgather for„emote_addr/rkey is completed");

100 
comm
->
Úe_sided
.
»lŸb™y_»ady
 = 1;

102  
¡©us
;

106 
	`mem£t
(
comm
->
Úe_sided
.
»cvd_pkts_Œack”
, 0, comm->
commsize
 * (
ušt32_t
));

107 
	`mem£t
(
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
, 
ONE_SIDED_INVALID
, comm->
commsize
 * ());

109 
comm
->
Úe_sided
.
¦Ùs_¡©e
 = 
ONE_SIDED_INVALID
;

111 ià(
ONE_SIDED_SYNCHRONOUS_PROTO
 =ğ
»q
->
Úe_sided_»lŸb™y_scheme
) {

113 ià(!
»q
->
¼eg
) {

115 
¡©us
 = 
	`ucc__mlx5_mÿ¡_mem_»gi¡”
(
comm
->
ùx
, 
»q
->
±r
,„eq->
Ëngth
, &
»g
);

116 ià(
UCC_OK
 !ğ
¡©us
) {

117  
¡©us
;

119 
»q
->
¼eg
 = 
»g
;

120 
»q
->
mr
 = 
»g
->mr;

122 
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[comm->
¿nk
].
rkey
 = 
»q
->
mr
->rkey;

123 
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[comm->
¿nk
].
»mÙe_addr
 = (
ušt64_t
)
»q
->
±r
;

124 
	`_Œaû
(
comm
->
lib
, "allgather over sendbuf‡ddresses/rkey:‡ddress %p„key %d",

125 
»q
->
±r
,„eq->
mr
->
rkey
);

126 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`®lg©h”_po¡
(comm->
p2p_ùx
,

127 &(
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[comm->
¿nk
]),

128 
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
,

129 (
ucc__mlx5_mÿ¡_¦Ù_mem_šfo_t
),

130 &
»q
->
®lg©h”_rkeys_»q
);

131 ià(
UCC_OK
 !ğ
¡©us
) {

132 
	`_”rÜ
(
comm
->
lib
, "oob‡llgather failed during one-sided„eliability„eset of‡ collective call");

133  
¡©us
;

135  
UCC_INPROGRESS
;

137 
comm
->
Úe_sided
.
»lŸb™y_»ady
 = 1;

140  
UCC_OK
;

141 
	}
}

143 
šlše
 
ucc_¡©us_t


144 
	$ucc__mlx5_mÿ¡_š™_async_»lŸb™y_¦Ùs
(
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

146 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
»q
->comm;

147 *
de¡
;

148 
ucc_¡©us_t
 
¡©us
;

150 
	`ucc_as£¹
(
»q
->
ag_couÁ”
 =ğ
comm
->
®lg©h”_comm
.
und”_´og»ss_couÁ”
);

152 ià(
ONE_SIDED_ASYNCHRONOUS_PROTO
 =ğ
»q
->
Úe_sided_»lŸb™y_scheme
 &&

153 
ONE_SIDED_INVALID
 =ğ
comm
->
Úe_sided
.
¦Ùs_¡©e
) {

155 
	`ucc_as£¹
(
»q
->
Ëngth
 <ğ
comm
->
Úe_sided
.
»lŸb™y_scheme_msg_th»shŞd
);

156 
de¡
 = 
	`PTR_OFFSET
(
comm
->
Úe_sided
.
¦Ùs_bufãr
,

157 (
»q
->
ag_couÁ”
 % 
ONE_SIDED_SLOTS_COUNT
)

158 * 
comm
->
Úe_sided
.
¦Ù_size
);

160 
¡©us
 = 
	`ucc__mlx5_mÿ¡_memıy_nb
(
	`PTR_OFFSET
(
de¡
, 
ONE_SIDED_SLOTS_INFO_SIZE
),

161 
UCC_MEMORY_TYPE_HOST
,

162 
»q
->
±r
,„eq->
¤c_mem_ty³
,

163 
»q
->
Ëngth
, 
comm
,

164 &
comm
->
Úe_sided
.
³ndšg_cİy_sk
);

165 ià(
¡©us
 !ğ
UCC_OK
) {

166 
	`_”rÜ
(
comm
->
lib
, "failedo start copyo„eliability slots");

167  
¡©us
;

169 
comm
->
Úe_sided
.
¦Ùs_¡©e
 = 
ONE_SIDED_PENDING_DATA
;

171  
UCC_OK
;

172 
	}
}

174 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_do_¡agšg_ba£d_®lg©h”
(*
»q_hªdË
)

177 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

178 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
 = (ucc__mlx5_mÿ¡_cŞl_»q_ˆ*)
»q_hªdË
;

179 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
»q
->comm;

180 cÚ¡ 
zcİy
 = 
»q
->
´Ùo
 !ğ
MCAST_PROTO_EAGER
;

181 
num_»cvd
;

182 *
de¡
;

184 
	`ucc_as£¹
(
»q
->
to_»cv
 >ğ0 &&„eq->
to_£nd
 >= 0);

187 ià(
comm
->
Úe_sided
.
¦Ùs_¡©e
 =ğ
ONE_SIDED_PENDING_DATA
) {

188 
¡©us
 = 
	`ucc__mlx5_mÿ¡_memıy_‹¡
(
comm
->
Úe_sided
.
³ndšg_cİy_sk
);

189 ià(
¡©us
 =ğ
UCC_OK
) {

191 
de¡
 = 
	`PTR_OFFSET
(
comm
->
Úe_sided
.
¦Ùs_bufãr
,

192 (
»q
->
ag_couÁ”
 % 
ONE_SIDED_SLOTS_COUNT
)

193 * 
comm
->
Úe_sided
.
¦Ù_size
);

194 
	`memıy
(
de¡
, &
»q
->
ag_couÁ”
, 
ONE_SIDED_SLOTS_INFO_SIZE
);

195 
comm
->
Úe_sided
.
¦Ùs_¡©e
 = 
ONE_SIDED_VALID
;

196 } ià(
¡©us
 !ğ
UCC_INPROGRESS
) {

197  
¡©us
;

201 
¡©us
 = 
	`ucc__mlx5_mÿ¡_®lg©h”_»lŸb™y_»ady
(
»q
);

202 ià(
UCC_OK
 !ğ
¡©us
) {

203  
¡©us
;

206 ià(
»q
->
to_£nd
 ||„eq->
to_»cv
) {

207 
	`ucc_as£¹
(
comm
->
®lg©h”_comm
.
max_push_£nd
 >ğcomm->
³ndšg_£nd
);

208 ià(
»q
->
to_£nd
 &&

209 (
comm
->
®lg©h”_comm
.
max_push_£nd
 - comm->
³ndšg_£nd
) > 0) {

210 
¡©us
 = 
	`ucc__mlx5_mÿ¡_£nd_cŞËùive
(
comm
, 
»q
, 
	`ucc_mš
(comm->
®lg©h”_comm
.
max_push_£nd
 -

211 
comm
->
³ndšg_£nd
, 
»q
->
to_£nd
),

212 
zcİy
, 0, 
SIZE_MAX
);

213 ià(
¡©us
 < 0) {

214 
	`_”rÜ
(
comm
->
lib
, "a failure happend during send…ackets");

215  
¡©us
;

219 
¡©us
 = 
	`ucc__mlx5_mÿ¡_š™_async_»lŸb™y_¦Ùs
(
»q
);

220 ià(
¡©us
 !ğ
UCC_OK
) {

221 
	`_”rÜ
(
comm
->
lib
, "failedo initialize‡sync„eliability slots");

222  
¡©us
;

225 ià(
»q
->
to_»cv
) {

226 
num_»cvd
 = 
	`ucc__mlx5_mÿ¡_»cv_cŞËùive
(
comm
, 
»q
,„eq->
to_»cv
,

227 
UCC_COLL_TYPE_ALLGATHER
);

228 ià(
num_»cvd
 < 0) {

229 
	`_”rÜ
(
comm
->
lib
, "a failure happend during cq…olling");

230 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

231  
¡©us
;

236 ià(
comm
->
³ndšg_£nd
) {

237 
¡©us
 = 
	`ucc__mlx5_mÿ¡_pŞl_£nd
(
comm
);

238 ià(
¡©us
 !ğ
UCC_OK
) {

239  
¡©us
;

243 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

244 
¡©us
 = 
	`ucc__mlx5_mÿ¡_check_¡agšg_ba£d_cŞËùive
(
comm
, 
»q
);

245 ià(
¡©us
 < 0) {

246  
¡©us
;

250 ià(
	`MCAST_ALLGATHER_IN_PROGRESS
(
»q
, 
comm
)) {

251  
UCC_INPROGRESS
;

254 ià(
ONE_SIDED_SYNCHRONOUS_PROTO
 =ğ
»q
->
Úe_sided_»lŸb™y_scheme
) {

257 ià(!
»q
->
b¬r›r_»q
) {

259 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`b¬r›r_po¡
(comm->
p2p_ùx
, &
»q
->
b¬r›r_»q
);

260 ià(
¡©us
 !ğ
UCC_OK
) {

261  
¡©us
;

263 
	`_Œaû
(
comm
->
lib
, "mcast operations‡re done‡nd‚ow goo barrier");

266 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(
»q
->
b¬r›r_»q
);

267 ià(
¡©us
 =ğ
UCC_OK
) {

268 
»q
->
b¬r›r_»q
 = 
NULL
;

269 
	`_Œaû
(
comm
->
lib
, "barrier‡theƒnd of mcast‡llgather is completed");

271  
¡©us
;

276  
UCC_OK
;

277 
	}
}

279 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_®lg©h”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

281 
ucc__mlx5_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_mlx5_task_t);

282 
ucc__mlx5_‹am_t
 *
mlx5_‹am
 = 
	`TASK_TEAM
(
sk
);

284  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
mlx5_‹am
)->
pq
, &
sk
->
su³r
);

285 
	}
}

287 
	$ucc__mlx5_mÿ¡_®lg©h”_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

289 
ucc__mlx5_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_mlx5_task_t);

290 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
 = 
sk
->
cŞl_mÿ¡
.
»q_hªdË
;

292 
	`ucc_as£¹
(
»q
 !ğ
NULL
);

294 ià(
»q
->
ag_couÁ”
 !ğ»q->
comm
->
®lg©h”_comm
.
und”_´og»ss_couÁ”
) {

296 
	`ucc_as£¹
(
»q
->
comm
->
®lg©h”_comm
.
und”_´og»ss_couÁ”
 <„eq->
ag_couÁ”
);

300 
cŞl_sk
->
¡©us
 = (
»q
->
´og»ss
)(req);

301 ià(
cŞl_sk
->
¡©us
 < 0) {

302 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "´og»s mÿ¡‡Îg©h” faed:%d", 
cŞl_sk
->
¡©us
);

304 
	}
}

306 
šlše
 
ucc_¡©us_t


307 
	$ucc__mlx5_mÿ¡_v®id©e_z”o_cİy_®lg©h”_·¿ms
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

308 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

311 ià(
»q
->
cÚcu¼’cy_Ëv–
 % 2 =ğ0 &&„eq->
num_·ck‘s
 %„eq->
mÿ¡_´•o¡_buck‘_size
 != 0) {

312 
	`_debug
(
comm
->
lib
, "Pipelined mcast‡llgather‚ot supported: "

315 
»q
->
num_·ck‘s
,„eq->
mÿ¡_´•o¡_buck‘_size
,„eq->
cÚcu¼’cy_Ëv–
);

316  
UCC_ERR_NOT_SUPPORTED
;

319 ià(
comm
->
commsize
 % 
»q
->
cÚcu¼’cy_Ëv–
 != 0) {

320 
	`_debug
(
comm
->
lib
, "Pipelined mcast‡llgather‚ot supported: "

322 
comm
->
commsize
, 
»q
->
cÚcu¼’cy_Ëv–
);

323  
UCC_ERR_NOT_SUPPORTED
;

328 ià(
»q
->
Ëngth
 >ğ
comm
->
max_³r_·ck‘
 &&„eq->length % comm->max_per_packet != 0) {

329 
	`_debug
(
comm
->
lib
, "Pipelined mcast‡llgather‚ot supported: "

332 
»q
->
Ëngth
, 
comm
->
max_³r_·ck‘
);

333  
UCC_ERR_NOT_SUPPORTED
;

336 ià(
»q
->
mÿ¡_´•o¡_buck‘_size
 *„eq->
cÚcu¼’cy_Ëv–
 * 2 > 
comm
->
·¿ms
.
rx_d•th
) {

337 
	`_debug
(
comm
->
lib
, "Pipelined mcast‡llgather‚ot supported: "

341 
»q
->
mÿ¡_´•o¡_buck‘_size
,„eq->
cÚcu¼’cy_Ëv–
,

342 
comm
->
·¿ms
.
rx_d•th
);

343  
UCC_ERR_NOT_SUPPORTED
;

346  
UCC_OK
;

347 
	}
}

354 
šlše
 
ucc_¡©us_t


355 
	$ucc__mlx5_mÿ¡_´•¬e_z”o_cİy_®lg©h”
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

356 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

358 
ucc__mlx5_mÿ¡_»g_t
 *
»g
 = 
NULL
;

359 
ucc_¿nk_t
 
roÙ
 = 0;

360 
off£t
 = 0;

361 
ucc_¡©us_t
 
¡©us
;

362 
ucc_¿nk_t
 
j
, 
i
;

363 
tÙ®_¡•s
;

364 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
scheduË
;

366 
	`ucc_as£¹
(
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
);

368 
»q
->
cÚcu¼’cy_Ëv–
 = 
comm
->
mÿ¡_group_couÁ
 / 2;

369 
»q
->
cÚcu¼’cy_Ëv–
 = 
	`ucc_mš
Ôeq->cÚcu¼’cy_Ëv–, 
ONE_SIDED_MAX_CONCURRENT_LEVEL
);

370 
»q
->
cÚcu¼’cy_Ëv–
 = 
	`ucc_mš
Ôeq->cÚcu¼’cy_Ëv–, 
comm
->
commsize
);

372 ià(
»q
->
cÚcu¼’cy_Ëv–
 == 0) {

373 
	`_w¬n
(
comm
->
lib
, "notƒnough concurreny†eveloƒnable zcopy…ipeline‡llgather");

374 
	`_debug
(
comm
->
lib
, "truly zero-copy‡llgather„equires‡t†east 2 multicast groups. "

378 
comm
->
mÿ¡_group_couÁ
, 
»q
->
cÚcu¼’cy_Ëv–
);

379  
UCC_ERR_NOT_SUPPORTED
;

382 
»q
->
mÿ¡_´•o¡_buck‘_size
 =

383 
	`ucc_mš
(
»q
->
num_·ck‘s
, 
comm
->
®lg©h”_comm
.
mÿ¡_´•o¡_buck‘_size
);

385 
¡©us
 = 
	`ucc__mlx5_mÿ¡_v®id©e_z”o_cİy_®lg©h”_·¿ms
(
comm
, 
»q
);

386 ià(
¡©us
 !ğ
UCC_OK
) {

387  
¡©us
;

392 
tÙ®_¡•s
 = 
»q
->
num_·ck‘s
 * (
comm
->
commsize
 /„eq->
cÚcu¼’cy_Ëv–
)

393 / 
»q
->
mÿ¡_´•o¡_buck‘_size
 + 1;

395 
scheduË
 = 
	`ucc_ÿÎoc
(1,

396 (
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
) *

397 
tÙ®_¡•s
, "sched");

398 ià(!
scheduË
) {

399 
	`_w¬n
(
comm
->
lib
, "cannot‡llocate memory for schedule†ist");

400  
UCC_ERR_NO_MEMORY
;

404 
i
 = 0; i < 
tÙ®_¡•s
; i++) {

405 ià(
i
 < 
tÙ®_¡•s
 - 1) {

406 
j
 = 0; j < 
»q
->
cÚcu¼’cy_Ëv–
; j++) {

407 
scheduË
[
i
].
´•o¡_buf_İ
[
j
].
group_id
 =

408 
j
 + 
»q
->
cÚcu¼’cy_Ëv–
 * (
i
 % 2);

409 
scheduË
[
i
].
´•o¡_buf_İ
[
j
].
off£t
 =

410 
off£t
 * 
comm
->
max_³r_·ck‘
;

411 
scheduË
[
i
].
´•o¡_buf_İ
[
j
].
roÙ
 =„oot + j;

412 
scheduË
[
i
].
´•o¡_buf_İ
[
j
].
couÁ
 =

413 
»q
->
mÿ¡_´•o¡_buck‘_size
;

416 
scheduË
[
i
].
´•o¡_buf_İ_dÚe
 = 1;

419 ià(
i
 > 0) {

420 
j
 = 0; j < 
»q
->
cÚcu¼’cy_Ëv–
; j++) {

421 
scheduË
[
i
].
muÉiÿ¡_İ
[
j
].
group_id
 =

422 
scheduË
[
i
 - 1].
´•o¡_buf_İ
[
j
].
group_id
;

423 
scheduË
[
i
].
muÉiÿ¡_İ
[
j
].
off£t
 =

424 
scheduË
[
i
 - 1].
´•o¡_buf_İ
[
j
].
off£t
;

425 
scheduË
[
i
].
muÉiÿ¡_İ
[
j
].
off£t_Ëá
 =

426 
scheduË
[
i
 - 1].
´•o¡_buf_İ
[
j
].
off£t
;

427 
scheduË
[
i
].
muÉiÿ¡_İ
[
j
].
roÙ
 =

428 
scheduË
[
i
 - 1].
´•o¡_buf_İ
[
j
].
roÙ
;

429 
scheduË
[
i
].
muÉiÿ¡_İ
[
j
].
to_£nd_Ëá
 =

430 
scheduË
[
i
 - 1].
´•o¡_buf_İ
[
j
].
couÁ
;

431 
scheduË
[
i
].
muÉiÿ¡_İ
[
j
].
to_»cv
 =

432 
scheduË
[
i
 - 1].
´•o¡_buf_İ
[
j
].
couÁ
;

433 
scheduË
[
i
].
to_»cv
 +ğscheduË[i].
muÉiÿ¡_İ
[
j
].to_recv;

434 ià(
scheduË
[
i
].
muÉiÿ¡_İ
[
j
].
roÙ
 =ğ
comm
->
¿nk
) {

435 
scheduË
[
i
].
to_£nd
 +ğscheduË[i].
muÉiÿ¡_İ
[
j
].
to_£nd_Ëá
;

440 ià(!
scheduË
[
i
].
to_£nd
 || !scheduË[i].
to_»cv
) {

441 
scheduË
[
i
].
muÉiÿ¡_İ_dÚe
 = 1;

444 
off£t
 +ğ
»q
->
mÿ¡_´•o¡_buck‘_size
;

446 ià(
off£t
 =ğ
»q
->
num_·ck‘s
) {

447 
off£t
 = 0;

448 
roÙ
 = (roÙ + 
»q
->
cÚcu¼’cy_Ëv–
è% 
comm
->
commsize
;

452 
	`_Œaû
(
comm
->
lib
,

454 
tÙ®_¡•s
);

455 
scheduË
->
tÙ®_¡•s
 =otal_steps;

456 
»q
->
tÙ®_¡•s
 =otal_steps;

457 
»q
->
ag_scheduË
 = 
scheduË
;

458 
	`_Œaû
(
comm
->
lib
, "»gi¡”šg„ecv buàoàsiz%ld", 
»q
->
Ëngth
 * comm->
commsize
);

459 
	`ucc_as£¹
(
»q
->
»cv_¼eg
 =ğ
NULL
);

461 
¡©us
 = 
	`ucc__mlx5_mÿ¡_mem_»gi¡”
(
comm
->
ùx
, 
»q
->
½Œ
,„eq->
Ëngth
 *

462 
comm
->
commsize
, &
»g
);

463 ià(
UCC_OK
 !ğ
¡©us
) {

464 
	`_w¬n
(
comm
->
lib
, "unableo„egister„eceive buffer %p of size %ld",

465 
»q
->
½Œ
,„eq->
Ëngth
 * 
comm
->
commsize
);

466 
	`ucc_ä“
(
scheduË
);

467  
¡©us
;

470 
»q
->
»cv_¼eg
 = 
»g
;

471 
»q
->
»cv_mr
 = 
»g
->
mr
;

473  
UCC_OK
;

474 
	}
}

476 
šlše
 
ucc_¡©us_t


477 
	$ucc__mlx5_mÿ¡_check_zcİy_®lg©h”_cŞËùive
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

478 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

480 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
sched
 = 
»q
->
ag_scheduË
;

482 
	`ucc_as£¹
(
»q
->
®lg©h”_rkeys_»q
 =ğ
NULL
);

483 ià(
comm
->
Úe_sided
.
³ndšg_»ads
) {

484  
	`ucc__mlx5_mÿ¡_´og»ss_Úe_sided_communiÿtiÚ
(
comm
, 
»q
);

486 ià(
»q
->
¡•
 =ğ»q->
tÙ®_¡•s
) {

487  
UCC_OK
;

489 ià(!
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
 || !sched[»q->¡•].
muÉiÿ¡_İ_dÚe
) {

491  
UCC_INPROGRESS
;

493 ià(
sched
[
»q
->
¡•
].
num_»cvd
 =ğsched[»q->¡•].
to_»cv
) {

497  
	`ucc__mlx5_mÿ¡_»lŸbË_zcİy_p–šed_Úe_sided_g‘
(
comm
, 
»q
, 
NULL
);

498 } ià(!
comm
->
tim”
) {

499 ià(
comm
->
¡®Ëd
 < 
DROP_THRESHOLD
) {

500 
comm
->
¡®Ëd
++;

503 
comm
->
tim”
 = 
	`ucc__mlx5_mÿ¡_g‘_tim”
();

504 
comm
->
¡®Ëd
 = 0;

507 ià(
comm
->
¡®Ëd
 < 
DROP_THRESHOLD
) {

508 
comm
->
¡®Ëd
++;

511 ià(
	`ucc__mlx5_mÿ¡_g‘_tim”
(è- 
comm
->
tim”
 >=

512 
comm
->
ùx
->
·¿ms
.
timeout
) {

513 
comm
->
tim”
 = 0;

514 
	`ucc_as£¹
(
sched
[
»q
->
¡•
].
to_»cv
 >ğsched[»q->¡•].
num_»cvd
);

515 
	`_debug
(
comm
->
lib
, "allgatherimeout %d…ending…acketso„ecv %d on step %d",

516 
comm
->
ùx
->
·¿ms
.
timeout
, 
sched
[
»q
->
¡•
].
to_»cv
 - sched[»q->¡•].
num_»cvd
,

517 
»q
->
¡•
);

518  
	`ucc__mlx5_mÿ¡_»lŸbË_zcİy_p–šed_Úe_sided_g‘
(
comm
, 
»q
, 
NULL
);

520 
comm
->
¡®Ëd
 = 0;

524  
UCC_INPROGRESS
;

525 
	}
}

527 
šlše
 
ucc_¡©us_t


528 
	$ucc__mlx5_mÿ¡_do_z”o_cİy_p–šed_®lg©h”
(*
»q_hªdË
)

530 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
 = (ucc__mlx5_mÿ¡_cŞl_»q_ˆ*)
»q_hªdË
;

531 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
»q
->comm;

532 cÚ¡ 
zcİy
 = 
»q
->
´Ùo
 !ğ
MCAST_PROTO_EAGER
;

533 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
sched
 = 
»q
->
ag_scheduË
;

534 
num_»cvd
, 
roÙ
, 
to_£nd_Ëá
,

535 
j
, 
group_id
, 
num_·ck‘s
, 
couÁ
;

536 
size_t
 
off£t
, 
off£t_Ëá
;

537 
ucc_¡©us_t
 
¡©us
;

539 
¡©us
 = 
	`ucc__mlx5_mÿ¡_®lg©h”_»lŸb™y_»ady
(
»q
);

540 ià(
UCC_OK
 !ğ
¡©us
) {

541  
¡©us
;

544 
	`ucc_as£¹
(
»q
->
to_»cv
>=0 &&„eq->
to_£nd
 >=0);

545 ià(
»q
->
b¬r›r_»q
) {

546 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(
»q
->
b¬r›r_»q
);

547 ià(
¡©us
 !ğ
UCC_OK
) {

548  
¡©us
;

550 
	`_Œaû
(
comm
->
lib
, "b¬r›¸©ƒnd oà»q->¡• %d i com¶‘ed", 
»q
->
¡•
);

551 
»q
->
b¬r›r_»q
 = 
NULL
;

552 
»q
->
¡•
++;

553 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

554 
	`mem£t
(
comm
->
Úe_sided
.
»cvd_pkts_Œack”
, 0, comm->
commsize
 * (
ušt32_t
));

558 ià(
»q
->
¡•
 < 
sched
->
tÙ®_¡•s
) {

559 ià(!
sched
[
»q
->
¡•
].
muÉiÿ¡_İ_dÚe
) {

560 
j
 = 0; j < 
»q
->
cÚcu¼’cy_Ëv–
; j++) {

561 
roÙ
 = 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].root;

562 ià(
comm
->
¿nk
 =ğ
roÙ
) {

564 
group_id
 = 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].group_id;

565 
to_£nd_Ëá
 = 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].to_send_left;

566 
off£t_Ëá
 = 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].offset_left;

567 
num_·ck‘s
 = 
	`ucc_mš
(
comm
->
®lg©h”_comm
.
max_push_£nd
 - comm->
³ndšg_£nd
, 
to_£nd_Ëá
);

568 ià(
to_£nd_Ëá
 &&

569 (
comm
->
®lg©h”_comm
.
max_push_£nd
 - comm->
³ndšg_£nd
) > 0) {

570 
¡©us
 = 
	`ucc__mlx5_mÿ¡_£nd_cŞËùive
(
comm
, 
»q
, 
num_·ck‘s
,

571 
zcİy
, 
group_id
, 
off£t_Ëá
);

572 ià(
UCC_OK
 !ğ
¡©us
) {

573  
¡©us
;

575 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
to_£nd_Ëá
 -ğ
num_·ck‘s
;

576 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
off£t_Ëá
 +ğ(
num_·ck‘s
 * 
comm
->
max_³r_·ck‘
);

578 ià(
comm
->
³ndšg_£nd
) {

579 
¡©us
 = 
	`ucc__mlx5_mÿ¡_pŞl_£nd
(
comm
);

580 ià(
¡©us
 !ğ
UCC_OK
) {

581  
¡©us
;

584 ià(!
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
to_£nd_Ëá
 && !
comm
->
³ndšg_£nd
) {

585 
	`_Œaû
(
comm
->
lib
, "done with mcast ops step %d group id %do_send %d",

586 
»q
->
¡•
, 
group_id
, 
sched
[»q->¡•].
to_£nd
);

587 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ_dÚe
 = 1;

594 ià(!
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
) {

596 
j
 = 0; j < 
»q
->
cÚcu¼’cy_Ëv–
; j++) {

597 
roÙ
 = 
sched
[
»q
->
¡•
].
´•o¡_buf_İ
[
j
].root;

598 
group_id
 = 
sched
[
»q
->
¡•
].
´•o¡_buf_İ
[
j
].group_id;

599 
couÁ
 = 
sched
[
»q
->
¡•
].
´•o¡_buf_İ
[
j
].count;

600 
off£t
 = 
sched
[
»q
->
¡•
].
´•o¡_buf_İ
[
j
].offset;

601 
¡©us
 = 
	`ucc__mlx5_mÿ¡_po¡_u£r_»cv_bufãrs
(
comm
, 
»q
, 
group_id
, 
roÙ
,

602 
UCC_COLL_TYPE_ALLGATHER
, 
couÁ
,

603 
off£t
);

604 ià(
UCC_OK
 !ğ
¡©us
) {

605  
¡©us
;

608 ià(
»q
->
to_»cv
) {

609 
num_»cvd
 = 
	`ucc__mlx5_mÿ¡_»cv_cŞËùive
(
comm
, 
»q
,

610 
»q
->
to_»cv
,

611 
UCC_COLL_TYPE_ALLGATHER
);

612 ià(
num_»cvd
 < 0) {

613 
	`_”rÜ
(
comm
->
lib
, "a failure happend during cq…olling");

614 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

615  
¡©us
;

617 ià(
sched
[
»q
->
¡•
].
num_»cvd
 !ğsched[»q->¡•].
to_»cv
) {

623 
sched
[
»q
->
¡•
].
num_»cvd
 +=‚um_recvd;

626 
	`_Œaû
(
comm
->
lib
, "preposted bufs step %d group id %d count %d offset %ld„oot %d",

627 
»q
->
¡•
, 
group_id
, 
couÁ
, 
off£t
, 
roÙ
);

629 
	`_Œaû
(
comm
->
lib
, "done with…repost bufs step %d group id %d„oot %d",

630 
»q
->
¡•
, 
group_id
, 
roÙ
);

631 
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
 = 1;

633 ià(
»q
->
to_»cv
) {

634 
num_»cvd
 = 
	`ucc__mlx5_mÿ¡_»cv_cŞËùive
(
comm
, 
»q
,

635 
»q
->
to_»cv
,

636 
UCC_COLL_TYPE_ALLGATHER
);

637 ià(
num_»cvd
 < 0) {

638 
	`_”rÜ
(
comm
->
lib
, "a failure happend during cq…olling");

639 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

640  
¡©us
;

642 ià(
sched
[
»q
->
¡•
].
num_»cvd
 !ğsched[»q->¡•].
to_»cv
) {

643 
sched
[
»q
->
¡•
].
num_»cvd
 +=‚um_recvd;

646 ià(
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
 &&

647 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ_dÚe
 &&

648 
sched
[
»q
->
¡•
].
num_»cvd
 =ğsched[»q->¡•].
to_»cv
) {

650 
	`_Œaû
(
comm
->
lib
, "š™ glob® synø»q->¡• %d", 
»q
->
¡•
);

651 
	`ucc_as£¹
(
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
 && sched[»q->¡•].
muÉiÿ¡_İ_dÚe
);

652 
	`ucc_as£¹
(
»q
->
b¬r›r_»q
 =ğ
NULL
);

653 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`b¬r›r_po¡
(comm->
p2p_ùx
, &
»q
->
b¬r›r_»q
);

654 ià(
¡©us
 !ğ
UCC_OK
) {

655  
¡©us
;

660 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

661 
¡©us
 = 
	`ucc__mlx5_mÿ¡_check_zcİy_®lg©h”_cŞËùive
(
comm
, 
»q
);

662 ià(
¡©us
 < 0) {

663  
¡©us
;

667 ià(
»q
->
b¬r›r_»q
 !ğ
NULL
 ||

668 
	`MCAST_ALLGATHER_IN_PROGRESS
(
»q
, 
comm
)) {

669  
UCC_INPROGRESS
;

673 
	`as£¹
(
»q
->
¡•
 =ğ
sched
->
tÙ®_¡•s
);

674  
UCC_OK
;

675 
	}
}

677 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_®lg©h”_š™
(
ucc__mlx5_sk_t
 *
sk
)

679 
ucc_cŞl_sk_t
 *
cŞl_sk
 = &(
sk
->
su³r
);

680 
ucc__mlx5_‹am_t
 *
mlx5_‹am
 = 
	`TASK_TEAM
(
sk
);

681 
ucc__mlx5_mÿ¡_‹am_t
 *
‹am
 = 
mlx5_‹am
->
mÿ¡
;

682 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

683 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

684 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

685 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

686 
size_t
 
d©a_size
 = 
	`ucc_dt_size
(
dt
è* 
couÁ
;

687 *
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

688 *
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

689 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
‹am
->
mÿ¡_comm
;

690 
ucc__mlx5_mÿ¡_»g_t
 *
»g
 = 
NULL
;

691 
ucc_¿nk_t
 
max_‹am
 = 
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
;

692 
max_ùr
 = 
ONE_SIDED_MAX_ZCOPY_COLL_COUNTER
;

693 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
;

696 
sk
->
cŞl_mÿ¡
.
»q_hªdË
 = 
NULL
;

698 
	`_Œaû
(
comm
->
lib
, "MCAST‡llgather init, sbuf %p,„buf %p, size %ld, comm %d, "

700 
sbuf
, 
rbuf
, 
d©a_size
, 
comm
->
comm_id
, comm->
commsize
, comm->
®lg©h”_comm
.
cŞl_couÁ”
);

702 
»q
 = 
	`ucc_mpoŞ_g‘
(&
comm
->
ùx
->
mÿ¡_»q_mp
);

703 ià(!
»q
) {

704 
	`_”rÜ
(
comm
->
lib
, "failedo get‡ mcast„eq");

705 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

706 
çed
;

708 
	`mem£t
(
»q
, 0, (
ucc__mlx5_mÿ¡_cŞl_»q_t
));

710 
»q
->
comm
 = comm;

711 
»q
->
±r
 = 
sbuf
;

712 
»q
->
½Œ
 = 
rbuf
;

713 
»q
->
Ëngth
 = 
d©a_size
;

714 
»q
->
mr
 = 
comm
->
µ_mr
;

715 
»q
->
¼eg
 = 
NULL
;

716 
»q
->
sü©ch_buf
 = 
NULL
;

717 
»q
->
sü©ch_buf_h—d”
 = 
NULL
;

718 
»q
->
sü©ch_·ck‘s_»ûived
 = 0;

732 ià(
comm
->
cuda_mem_’abËd
) {

733 ià(
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
) {

734 
»q
->
´Ùo
 = 
MCAST_PROTO_ZCOPY
;

735 
	`_Œaû
(
comm
->
lib
,

737 
»q
->
Ëngth
);

739 
»q
->
´Ùo
 = 
MCAST_PROTO_EAGER
;

740 
	`_Œaû
(
comm
->
lib
,

741 "CUDA mes§gsiz%zu: usšg sgšg w™h sü©ch bufãr", 
»q
->
Ëngth
);

745 
»q
->
´Ùo
 = (»q->
Ëngth
 < 
comm
->
max_—g”
) ?

746 
MCAST_PROTO_EAGER
 :

747 
MCAST_PROTO_ZCOPY
;

750 
	`as£¹
(
comm
->
commsize
 <ğ
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
);

752 
»q
->
off£t
 = 0;

753 
»q
->
num_·ck‘s
 = 
	`ucc_div_round_up
Ôeq->
Ëngth
, 
comm
->
max_³r_·ck‘
);

755 
	`MCAST_GET_MAX_ALLGATHER_PACKET_COUNT
(
comm
->
®lg©h”_comm
.
max_num_·ck‘s
, 
max_‹am
, 
max_ùr
);

757 ià(
comm
->
®lg©h”_comm
.
max_num_·ck‘s
 < 
»q
->
num_·ck‘s
) {

758 
	`_w¬n
(
comm
->
lib
,

760 
»q
->
Ëngth
, 
comm
->
®lg©h”_comm
.
max_num_·ck‘s
 * comm->
max_³r_·ck‘
);

761 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

762 
çed
;

765 ià(
»q
->
´Ùo
 =ğ
MCAST_PROTO_EAGER
 && 
comm
->
cuda_mem_’abËd
) {

767 
size_t
 
sü©ch_size
 = 
»q
->
Ëngth
 * 
comm
->
commsize
;

768 
¡©us
 = 
	`ucc_mc_®loc
(&
»q
->
sü©ch_buf_h—d”
, 
sü©ch_size
, 
UCC_MEMORY_TYPE_HOST
);

769 ià(
UCC_OK
 !ğ
¡©us
) {

770 
	`_”rÜ
(
comm
->
lib
, "çedØ®loÿ‹ sü©ch bufã¸oàsiz%zu", 
sü©ch_size
);

771 
çed
;

773 
»q
->
sü©ch_buf
 =„eq->
sü©ch_buf_h—d”
->
addr
;

774 
	`_Œaû
(
comm
->
lib
,

775 "®loÿ‹d sü©ch bufã¸oàsiz%zu fÜ CUDA sgšg", 
sü©ch_size
);

779 
¡©us
 = 
	`ucc__mlx5_mÿ¡_mem_»gi¡”
(
comm
->
ùx
, 
»q
->
±r
,„eq->
Ëngth
, &
»g
);

780 ià(
UCC_OK
 !ğ
¡©us
) {

781 
	`_”rÜ
(
comm
->
lib
, "sendbuf„egistration failed");

782 
çed
;

784 
»q
->
¼eg
 = 
»g
;

785 
»q
->
mr
 = 
»g
->mr;

787 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

788 
»q
->
Úe_sided_»lŸb™y_scheme
 = (»q->
Ëngth
 <

789 
comm
->
Úe_sided
.
»lŸb™y_scheme_msg_th»shŞd
) ?

790 
ONE_SIDED_ASYNCHRONOUS_PROTO
 : 
ONE_SIDED_SYNCHRONOUS_PROTO
;

791 ià(
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
) {

792 
»q
->
Úe_sided_»lŸb™y_scheme
 = 
ONE_SIDED_SYNCHRONOUS_PROTO
;

795 
»q
->
Úe_sided_»lŸb™y_scheme
 = 
ONE_SIDED_NO_RELIABILITY
;

798 
»q
->
ag_couÁ”
 = 
comm
->
®lg©h”_comm
.
cŞl_couÁ”
;

799 
»q
->
to_£nd
 =„eq->
num_·ck‘s
;

800 
»q
->
to_»cv
 = 
comm
->
commsize
 *„eq->
num_·ck‘s
;

801 
»q
->
´og»ss
 = 
ucc__mlx5_mÿ¡_do_¡agšg_ba£d_®lg©h”
;

803 ià(
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
) {

804 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´•¬e_z”o_cİy_®lg©h”
(
comm
, 
»q
);

805 ià(
UCC_OK
 !ğ
¡©us
) {

806 
	`_Œaû
(
comm
->
lib
,

808 
	`ucc_¡©us_¡ršg
(
¡©us
));

809 
	`_Œaû
(
comm
->
lib
,

810 "usšg sgšg…rÙocŞ‡ çÎback fÜ mes§gsiz%zu", 
»q
->
Ëngth
);

812 
»q
->
´og»ss
 = 
ucc__mlx5_mÿ¡_do_z”o_cİy_p–šed_®lg©h”
;

813 
	`_Œaû
(
comm
->
lib
,

814 "sucûssfuÎyƒÇbËdruly z”o-cİy‡Îg©h” fÜ mes§gsiz%zu", 
»q
->
Ëngth
);

817 
	`_Œaû
(
comm
->
lib
,

819 
»q
->
Ëngth
);

822 
comm
->
®lg©h”_comm
.
cŞl_couÁ”
++;

824 
sk
->
cŞl_mÿ¡
.
»q_hªdË
 = 
»q
;

825 
cŞl_sk
->
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

826 
sk
->
su³r
.
po¡
 = 
ucc__mlx5_mÿ¡_®lg©h”_¡¬t
;

827 
sk
->
su³r
.
´og»ss
 = 
ucc__mlx5_mÿ¡_®lg©h”_´og»ss
;

828  
UCC_OK
;

830 
çed
:

831 
	`_w¬n
(
	`UCC_TASK_LIB
(
sk
), "mÿ¡ in™‡Îg©h” faed:%d", 
¡©us
);

832 ià(
»q
) {

833 ià(
»q
->
¼eg
) {

834 
	`ucc__mlx5_mÿ¡_mem_d”egi¡”
(
comm
->
ùx
, 
»q
->
¼eg
);

836 ià(
»q
->
sü©ch_buf_h—d”
) {

837 
	`ucc_mc_ä“
(
»q
->
sü©ch_buf_h—d”
);

839 
	`ucc_mpoŞ_put
(
»q
);

841  
¡©us
;

842 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_allgather.h

7 #iâdeà
UCC_TL_MLX5_MCAST_ALLGATHER_H_


8 
	#UCC_TL_MLX5_MCAST_ALLGATHER_H_


	)

10 
	~"_mlx5_mÿ¡.h
"

11 
	~"_mlx5_cŞl.h
"

13 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_®lg©h”_š™
(
ucc__mlx5_sk_t
 *
sk
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_coll.c

7 
	~"_mlx5_cŞl.h
"

8 
	~"_mlx5_mÿ¡_h–³r.h
"

9 
	~"_mlx5_mÿ¡_rÿche.h
"

11 
	#MCAST_BCAST_IN_PROGRESS
(
_»q
, 
_comm
) \

12 (
_»q
->
to_£nd
 || _»q->
to_»cv
 || 
_comm
->
³ndšg_£nd
 || \

13 
_comm
->
Úe_sided
.
³ndšg_»ads
 || (
NULL
 !ğ
_»q
->
bÿ¡_rkeys_»q
) || \

14 (
_»q
->
ag_scheduË
 !ğ
NULL
 && _»q->
¡•
 !ğ_»q->ag_scheduË->
tÙ®_¡•s
))

	)

16 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_r_wšdow_»cyşe
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

17 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

19 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

20 
wsize
 = 
comm
->
bÿ¡_comm
.wsize;

21 
num_ä“_wš
 = 
wsize
 - (
comm
->
p¢
 - comm->
bÿ¡_comm
.
Ï¡_acked
);

22 
»q_com¶‘ed
 = (
»q
->
to_£nd
 =ğ0 &&„eq->
to_»cv
 == 0);

23 
µ_·ck‘
 *
µ
 = 
NULL
;

25 
	`ucc_as£¹
(
comm
->
bÿ¡_comm
.
»cv_drİ_·ck‘_š_´og»ss
 =ğ
çl£
);

26 
	`ucc_as£¹
(
»q
->
to_£nd
 >= 0);

33 
	`ucc_as£¹
(
num_ä“_wš
 >= 0);

35 ià(!
num_ä“_wš
 || (
»q
->
´Ùo
 =ğ
MCAST_PROTO_ZCOPY
 && 
»q_com¶‘ed
)) {

36 
¡©us
 = 
	`ucc__mlx5_mÿ¡_»lŸbË
(
comm
);

37 ià(
UCC_OK
 !ğ
¡©us
) {

38  
¡©us
;

41 
»q
->
exec_sk
 !ğ
NULL
) {

42 
	`EXEC_TASK_TEST
("çedØcom¶‘thnb memıy", 
»q
->
exec_sk
, 
comm
->
lib
);

45 
comm
->
bÿ¡_comm
.
n_mÿ¡_»lŸbË
++;

47 ; 
comm
->
bÿ¡_comm
.
Ï¡_acked
 < comm->
p¢
; comm->bcast_comm.last_acked++) {

48 
µ
 = 
comm
->
r_wšdow
[comm->
bÿ¡_comm
.
Ï¡_acked
 & (
wsize
-1)];

49 
	`ucc_as£¹
(
µ
 !ğ&
comm
->
dummy_·ck‘
);

50 
comm
->
r_wšdow
[comm->
bÿ¡_comm
.
Ï¡_acked
 & (
wsize
-1)] = &comm->
dummy_·ck‘
;

52 
µ
->
cÚ‹xt
 = 0;

53 
	`ucc_li¡_add_
(&
comm
->
bpoŞ
, &
µ
->
su³r
);

56 ià(!
»q_com¶‘ed
) {

57 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´•¬e_»lŸbË
(
comm
, 
»q
,„eq->
roÙ
);

58 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

59  
¡©us
;

64  
UCC_OK
;

65 
	}
}

67 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_do_bÿ¡
(*
»q_hªdË
)

69 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

70 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
 = (ucc__mlx5_mÿ¡_cŞl_»q_ˆ*)
»q_hªdË
;

71 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
»q
->comm;

72 
zcİy
 = 
»q
->
´Ùo
 !ğ
MCAST_PROTO_EAGER
;

73 
wsize
 = 
comm
->
bÿ¡_comm
.wsize;

74 
num_ä“_wš
;

75 
num_£Á
;

76 
to_£nd
;

77 
to_»cv
;

78 
to_»cv_Ëá
;

79 
³ndšg_q_size
;

81 
	`ucc_as£¹
(
»q
->
comm
->
p¢
 >ğ»q->
¡¬t_p¢
);

83 
¡©us
 = 
	`ucc__mlx5_mÿ¡_check_Çck_»que¡s
(
comm
, 
UINT32_MAX
);

84 ià(
¡©us
 < 0) {

85  
¡©us
;

88 ià(
	`ucc_uÆik–y
(
comm
->
bÿ¡_comm
.
»cv_drİ_·ck‘_š_´og»ss
)) {

90  
UCC_INPROGRESS
;

94 ià(
»q
->
to_£nd
 ||„eq->
to_»cv
) {

95 
num_ä“_wš
 = 
wsize
 - (
comm
->
p¢
 - comm->
bÿ¡_comm
.
Ï¡_acked
);

98 ià(
num_ä“_wš
 && 
»q
->
am_roÙ
) {

99 
num_£Á
 = 
»q
->
num_·ck‘s
 -„eq->
to_£nd
;

100 
	`ucc_as£¹
(
»q
->
to_£nd
 > 0);

101 
	`ucc_as£¹
(
»q
->
fœ¡_£nd_p¢
 + 
num_£Á
 < 
comm
->
bÿ¡_comm
.
Ï¡_acked
 + 
wsize
);

102 ià(
»q
->
fœ¡_£nd_p¢
 + 
num_£Á
 < 
comm
->
bÿ¡_comm
.
Ï¡_acked
 + 
wsize
 &&

103 
»q
->
to_£nd
) {

106 
to_£nd
 = 
	`ucc_mš
(
»q
->to_send,

107 
comm
->
bÿ¡_comm
.
Ï¡_acked
 + 
wsize
 - (
»q
->
fœ¡_£nd_p¢
 + 
num_£Á
));

108 
	`ucc__mlx5_mÿ¡_£nd
(
comm
, 
»q
, 
to_£nd
, 
zcİy
);

110 
num_ä“_wš
 = 
wsize
 - (
comm
->
p¢
 - comm->
bÿ¡_comm
.
Ï¡_acked
);

114 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´•¬e_»lŸbË
(
comm
, 
»q
,„eq->
roÙ
);

115 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

116  
¡©us
;

119 ià(
num_ä“_wš
 && 
»q
->
to_»cv
) {

121 
³ndšg_q_size
 = 0;

122 
to_»cv
 = 
	`ucc_mš
(
num_ä“_wš
, 
»q
->to_recv);

123 
to_»cv_Ëá
 = 
	`ucc__mlx5_mÿ¡_»cv
(
comm
, 
»q
, 
to_»cv
, &
³ndšg_q_size
);

125 ià(
to_»cv
 =ğ
to_»cv_Ëá
) {

128 ià(
comm
->
¡®Ëd
++ >ğ
DROP_THRESHOLD
) {

130 
	`_Œaû
(
comm
->
lib
, "Did‚ot„eceivehe…acket with…sn in"

134 
³ndšg_q_size
, 
comm
->
p¢
, comm->
bÿ¡_comm
.
Ï¡_acked
,

135 
DROP_THRESHOLD
);

137 
¡©us
 = 
	`ucc__mlx5_mÿ¡_bÿ¡_check_drİ
(
comm
, 
»q
);

138 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

139  
¡©us
;

142 } ià(
to_»cv_Ëá
 < 0) {

144  
UCC_ERR_NO_MESSAGE
;

146 
comm
->
¡®Ëd
 = 0;

147 
comm
->
tim”
 = 0;

153 
¡©us
 = 
	`ucc__mlx5_mÿ¡_r_wšdow_»cyşe
(
comm
, 
»q
);

154 ià(
UCC_OK
 !ğ
¡©us
) {

155  
¡©us
;

158 ià(
»q
->
to_£nd
 ||„eq->
to_»cv
 || (
zcİy
 && 
comm
->
p¢
 !ğcomm->
bÿ¡_comm
.
Ï¡_acked
)) {

159  
UCC_INPROGRESS
;

161  
¡©us
;

163 
	}
}

165 
šlše
 
ucc_¡©us_t


166 
	$ucc__mlx5_mÿ¡_v®id©e_z”o_cİy_bÿ¡_·¿ms
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

167 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

170 ià(
»q
->
num_·ck‘s
 %„eq->
mÿ¡_´•o¡_buck‘_size
 != 0) {

171 
	`_debug
(
comm
->
lib
, "Pipelined mcast bcast‚ot supported: "

173 
»q
->
num_·ck‘s
,„eq->
mÿ¡_´•o¡_buck‘_size
);

174  
UCC_ERR_NOT_SUPPORTED
;

177 ià(
comm
->
commsize
 % 
»q
->
cÚcu¼’cy_Ëv–
 != 0) {

178 
	`_debug
(
comm
->
lib
, "Pipelined mcast bcast‚ot supported: "

180 
comm
->
commsize
, 
»q
->
cÚcu¼’cy_Ëv–
);

181  
UCC_ERR_NOT_SUPPORTED
;

184 ià(
»q
->
Ëngth
 % 
comm
->
max_³r_·ck‘
 != 0) {

185 
	`_debug
(
comm
->
lib
, "Pipelined mcast bcast‚ot supported: "

187 
»q
->
Ëngth
, 
comm
->
max_³r_·ck‘
);

188  
UCC_ERR_NOT_SUPPORTED
;

191 ià(
»q
->
mÿ¡_´•o¡_buck‘_size
 *„eq->
cÚcu¼’cy_Ëv–
 * 2 > 
comm
->
·¿ms
.
rx_d•th
) {

192 
	`_debug
(
comm
->
lib
, "Pipelined mcast bcast‚ot supported: "

196 
»q
->
mÿ¡_´•o¡_buck‘_size
,„eq->
cÚcu¼’cy_Ëv–
,

197 
comm
->
·¿ms
.
rx_d•th
);

198  
UCC_ERR_NOT_SUPPORTED
;

201  
UCC_OK
;

202 
	}
}

204 
šlše
 
ucc_¡©us_t


205 
	$ucc__mlx5_mÿ¡_´•¬e_z”o_cİy_bÿ¡
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

206 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

208 
ucc__mlx5_mÿ¡_»g_t
 *
»g
 = 
NULL
;

209 
ucc_¿nk_t
 
roÙ
 = 
»q
->root;

210 
off£t
 = 0;

211 
ucc_¡©us_t
 
¡©us
;

212 
ucc_¿nk_t
 
j
, 
i
;

213 
tÙ®_¡•s
;

214 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
scheduË
;

215 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
cu¼_scheduË
;

216 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
´ev_scheduË
;

217 
	`ucc_as£¹
(
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
);

219 ià(
comm
->
commsize
 =ğ1è 
UCC_OK
;

221 ià(
comm
->
mÿ¡_group_couÁ
 != 2) {

222 
	`_w¬n
(
comm
->
lib
, "needƒxactlywo mcast groupsoƒnable zcopy bcast");

223  
UCC_ERR_NOT_SUPPORTED
;

225 
»q
->
cÚcu¼’cy_Ëv–
 = 1;

227 
»q
->
mÿ¡_´•o¡_buck‘_size
 =

228 
	`ucc_mš
(
»q
->
num_·ck‘s
, 
comm
->
bÿ¡_comm
.
mÿ¡_´•o¡_buck‘_size
);

230 
¡©us
 = 
	`ucc__mlx5_mÿ¡_v®id©e_z”o_cİy_bÿ¡_·¿ms
(
comm
, 
»q
);

231 ià(
¡©us
 !ğ
UCC_OK
) {

232  
¡©us
;

237 
tÙ®_¡•s
 = 
»q
->
num_·ck‘s
 / (»q->
cÚcu¼’cy_Ëv–


238 * 
»q
->
mÿ¡_´•o¡_buck‘_size
) + 1;

239 
scheduË
 = 
	`ucc_ÿÎoc
(1, (
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
) *

240 
tÙ®_¡•s
, "sched");

241 ià(!
scheduË
) {

242 
	`_w¬n
(
comm
->
lib
, "cannot‡llocate memory for schedule†ist");

243  
UCC_ERR_NO_MEMORY
;

247 
i
 = 0; i < 
tÙ®_¡•s
; i++) {

248 
cu¼_scheduË
 = &(
scheduË
[
i
]);

249 ià(
i
 < 
tÙ®_¡•s
 - 1) {

250 
j
 = 0; j < 
»q
->
cÚcu¼’cy_Ëv–
; j++) {

251 
cu¼_scheduË
->
´•o¡_buf_İ
[
j
].
group_id
 =

252 
j
 + 
»q
->
cÚcu¼’cy_Ëv–
 * (
i
 % 2);

253 
cu¼_scheduË
->
´•o¡_buf_İ
[
j
].
off£t
 =

254 (
off£t
 + 
j
 * 
»q
->
mÿ¡_´•o¡_buck‘_size
) *

255 
comm
->
max_³r_·ck‘
;

256 
cu¼_scheduË
->
´•o¡_buf_İ
[
j
].
roÙ
 =„oot;

257 
cu¼_scheduË
->
´•o¡_buf_İ
[
j
].
couÁ
 =

258 
»q
->
mÿ¡_´•o¡_buck‘_size
;

261 ià(
i
 > 0) {

262 
´ev_scheduË
 = &(
scheduË
[
i
 - 1]);

263 
j
 = 0; j < 
»q
->
cÚcu¼’cy_Ëv–
; j++) {

264 
cu¼_scheduË
->
muÉiÿ¡_İ
[
j
].
group_id
 =

265 
´ev_scheduË
->
´•o¡_buf_İ
[
j
].
group_id
;

266 
cu¼_scheduË
->
muÉiÿ¡_İ
[
j
].
off£t
 =

267 
´ev_scheduË
->
´•o¡_buf_İ
[
j
].
off£t
;

268 
cu¼_scheduË
->
muÉiÿ¡_İ
[
j
].
off£t_Ëá
 =

269 
´ev_scheduË
->
´•o¡_buf_İ
[
j
].
off£t
;

270 
cu¼_scheduË
->
muÉiÿ¡_İ
[
j
].
roÙ
 =„oot;

271 ià(!
»q
->
am_roÙ
) {

272 
cu¼_scheduË
->
muÉiÿ¡_İ
[
j
].
to_»cv
 =

273 
´ev_scheduË
->
´•o¡_buf_İ
[
j
].
couÁ
;

275 
cu¼_scheduË
->
to_»cv
 +ğcu¼_scheduË->
muÉiÿ¡_İ
[
j
].to_recv;

276 ià(
cu¼_scheduË
->
muÉiÿ¡_İ
[
j
].
roÙ
 =ğ
comm
->
¿nk
) {

277 
cu¼_scheduË
->
muÉiÿ¡_İ
[
j
].
to_£nd_Ëá
 =

278 
´ev_scheduË
->
´•o¡_buf_İ
[
j
].
couÁ
;

279 
cu¼_scheduË
->
to_£nd
 +ğcu¼_scheduË->
muÉiÿ¡_İ
[
j
].
to_£nd_Ëá
;

283 ià(
»q
->
am_roÙ
) {

284 
cu¼_scheduË
->
´•o¡_buf_İ_dÚe
 = 1;

286 
off£t
 +ğ
»q
->
mÿ¡_´•o¡_buck‘_size
 *„eq->
cÚcu¼’cy_Ëv–
;

288 
	`_Œaû
(
comm
->
lib
,

290 
tÙ®_¡•s
);

291 
scheduË
->
tÙ®_¡•s
 =otal_steps;

292 
»q
->
tÙ®_¡•s
 =otal_steps;

293 
»q
->
ag_scheduË
 = 
scheduË
;

294 
»q
->
ag_couÁ”
 = 
comm
->
bÿ¡_comm
.
cŞl_couÁ”
;

295 
comm
->
bÿ¡_comm
.
cŞl_couÁ”
++;

297 ià(!
»q
->
am_roÙ
) {

298 
	`_Œaû
(
comm
->
lib
, "»gi¡”šg„ecv buàoàsiz%ld", 
»q
->
Ëngth
);

299 
	`ucc_as£¹
(
»q
->
»cv_¼eg
 =ğ
NULL
);

300 
¡©us
 = 
	`ucc__mlx5_mÿ¡_mem_»gi¡”
(
comm
->
ùx
, 
»q
->
±r
,„eq->
Ëngth
, &
»g
);

301 ià(
UCC_OK
 !ğ
¡©us
) {

302 
	`_w¬n
(
comm
->
lib
, "unableo„egister„eceive buffer %p of size %ld",

303 
»q
->
±r
,„eq->
Ëngth
);

304 
	`ucc_ä“
(
scheduË
);

305  
¡©us
;

307 
»q
->
»cv_¼eg
 = 
»g
;

308 
»q
->
»cv_mr
 = 
»g
->
mr
;

311 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

312 
»q
->
Úe_sided_»lŸb™y_scheme
 = 
ONE_SIDED_SYNCHRONOUS_PROTO
;

314 
»q
->
Úe_sided_»lŸb™y_scheme
 = 
ONE_SIDED_NO_RELIABILITY
;

317  
UCC_OK
;

318 
	}
}

320 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_bÿ¡_»lŸb™y_»ady
(
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

322 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
»q
->comm;

323 
ucc__mlx5_mÿ¡_»g_t
 *
»g
 = 
NULL
;

324 
ucc_¡©us_t
 
¡©us
;

326 
	`ucc_as£¹
(
»q
->
ag_couÁ”
 =ğ
comm
->
bÿ¡_comm
.
und”_´og»ss_couÁ”
);

328 ià(!
comm
->
Úe_sided
.
»lŸb™y_’abËd
 || comm->Úe_sided.
»lŸb™y_»ady
) {

329  
UCC_OK
;

332 ià(
»q
->
bÿ¡_rkeys_»q
) {

333 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(
»q
->
bÿ¡_rkeys_»q
);

334 ià(
¡©us
 =ğ
UCC_OK
) {

335 
»q
->
bÿ¡_rkeys_»q
 = 
NULL
;

336 
	`_Œaû
(
comm
->
lib
, "bcast for„emote_addr/rkey is completed");

337 
comm
->
Úe_sided
.
»lŸb™y_»ady
 = 1;

339  
¡©us
;

343 
	`mem£t
(
comm
->
Úe_sided
.
»cvd_pkts_Œack”
, 0, comm->
commsize
 * (
ušt32_t
));

344 
	`mem£t
(
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
, 
ONE_SIDED_INVALID
, comm->
commsize
 * ());

346 
comm
->
Úe_sided
.
¦Ùs_¡©e
 = 
ONE_SIDED_INVALID
;

349 ià(!
»q
->
¼eg
) {

351 
¡©us
 = 
	`ucc__mlx5_mÿ¡_mem_»gi¡”
(
comm
->
ùx
, 
»q
->
±r
,„eq->
Ëngth
, &
»g
);

352 ià(
UCC_OK
 !ğ
¡©us
) {

353  
¡©us
;

355 
»q
->
¼eg
 = 
»g
;

356 
»q
->
mr
 = 
»g
->mr;

358 ià(
»q
->
am_roÙ
) {

359 
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[comm->
¿nk
].
rkey
 = 
»q
->
mr
->rkey;

360 
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[comm->
¿nk
].
»mÙe_addr
 = (
ušt64_t
)
»q
->
±r
;

362 
	`_Œaû
(
comm
->
lib
, "bcast over buffer‡ddresses/rkey:‡ddress %p„key %d",

363 
»q
->
±r
,„eq->
mr
->
rkey
);

364 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`bÿ¡_po¡
(comm->
p2p_ùx
,

365 &(
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[
»q
->
roÙ
]),

366 (
ucc__mlx5_mÿ¡_¦Ù_mem_šfo_t
),

367 
»q
->
roÙ
,

368 &
»q
->
bÿ¡_rkeys_»q
);

369 ià(
UCC_OK
 !ğ
¡©us
) {

370 
	`_”rÜ
(
comm
->
lib
, "oob bcast failed during one-sided„eliability„eset of‡ collective call");

371  
¡©us
;

374  
UCC_INPROGRESS
;

375 
	}
}

377 
šlše
 
ucc_¡©us_t


378 
	$ucc__mlx5_mÿ¡_check_zcİy_bÿ¡_cŞËùive
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

379 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

381 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
sched
 = 
»q
->
ag_scheduË
;

383 
	`ucc_as£¹
(
»q
->
bÿ¡_rkeys_»q
 =ğ
NULL
);

384 ià(
comm
->
Úe_sided
.
³ndšg_»ads
) {

385  
	`ucc__mlx5_mÿ¡_´og»ss_Úe_sided_communiÿtiÚ
(
comm
, 
»q
);

387 ià(
»q
->
¡•
 =ğ»q->
tÙ®_¡•s
) {

388  
UCC_OK
;

390 ià(!
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
 || !sched[»q->¡•].
muÉiÿ¡_İ_dÚe
) {

392  
UCC_INPROGRESS
;

394 ià(
sched
[
»q
->
¡•
].
num_»cvd
 =ğsched[»q->¡•].
to_»cv
) {

398  
	`ucc__mlx5_mÿ¡_»lŸbË_zcİy_p–šed_Úe_sided_g‘
(
comm
, 
»q
, 
NULL
);

399 } ià(!
comm
->
tim”
) {

400 ià(
comm
->
¡®Ëd
 < 
DROP_THRESHOLD
) {

401 
comm
->
¡®Ëd
++;

404 
comm
->
tim”
 = 
	`ucc__mlx5_mÿ¡_g‘_tim”
();

405 
comm
->
¡®Ëd
 = 0;

408 ià(
comm
->
¡®Ëd
 < 
DROP_THRESHOLD
) {

409 
comm
->
¡®Ëd
++;

412 ià(
	`ucc__mlx5_mÿ¡_g‘_tim”
(è- 
comm
->
tim”
 >=

413 
comm
->
ùx
->
·¿ms
.
timeout
) {

414 
comm
->
tim”
 = 0;

415 
	`ucc_as£¹
(
sched
[
»q
->
¡•
].
to_»cv
 >ğsched[»q->¡•].
num_»cvd
);

416 
	`_debug
(
comm
->
lib
, "zcopy bcastimeout %d…ending…acketso„ecv %d on step %d",

417 
comm
->
ùx
->
·¿ms
.
timeout
, 
sched
[
»q
->
¡•
].
to_»cv
 - sched[»q->¡•].
num_»cvd
,

418 
»q
->
¡•
);

419  
	`ucc__mlx5_mÿ¡_»lŸbË_zcİy_p–šed_Úe_sided_g‘
(
comm
, 
»q
, 
NULL
);

421 
comm
->
¡®Ëd
 = 0;

425  
UCC_INPROGRESS
;

426 
	}
}

428 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_do_z”o_cİy_p–šed_bÿ¡
(*
»q_hªdË
)

430 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
 = (ucc__mlx5_mÿ¡_cŞl_»q_ˆ*)
»q_hªdË
;

431 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
»q
->comm;

432 cÚ¡ 
zcİy
 = 
»q
->
´Ùo
 !ğ
MCAST_PROTO_EAGER
;

433 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
sched
 = 
»q
->
ag_scheduË
;

434 
roÙ
 = 
»q
->root;

435 
num_»cvd
, 
to_£nd_Ëá
,

436 
j
, 
group_id
, 
num_·ck‘s
, 
couÁ
;

437 
size_t
 
off£t
, 
off£t_Ëá
;

438 
ucc_¡©us_t
 
¡©us
;

440 ià(
»q
->
ag_couÁ”
 !ğ»q->
comm
->
bÿ¡_comm
.
und”_´og»ss_couÁ”
) {

442 
	`ucc_as£¹
(
»q
->
comm
->
bÿ¡_comm
.
und”_´og»ss_couÁ”
 <„eq->
ag_couÁ”
);

443  
UCC_INPROGRESS
;

446 
¡©us
 = 
	`ucc__mlx5_mÿ¡_bÿ¡_»lŸb™y_»ady
(
»q
);

447 ià(
UCC_OK
 !ğ
¡©us
) {

448  
¡©us
;

451 
	`ucc_as£¹
(
»q
->
to_»cv
 >ğ0 &&„eq->
to_£nd
 >= 0);

452 ià(
»q
->
b¬r›r_»q
) {

453 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(
»q
->
b¬r›r_»q
);

454 ià(
¡©us
 !ğ
UCC_OK
) {

455  
¡©us
;

457 
	`_Œaû
(
comm
->
lib
, "b¬r›¸©ƒnd oà»q->¡• %d i com¶‘ed", 
»q
->
¡•
);

458 
»q
->
b¬r›r_»q
 = 
NULL
;

459 
»q
->
¡•
++;

460 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

461 
	`mem£t
(
comm
->
Úe_sided
.
»cvd_pkts_Œack”
, 0, comm->
commsize
 * (
ušt32_t
));

465 ià(
»q
->
¡•
 < 
sched
->
tÙ®_¡•s
) {

466 ià(!
sched
[
»q
->
¡•
].
muÉiÿ¡_İ_dÚe
) {

467 
j
 = 0; j < 
»q
->
cÚcu¼’cy_Ëv–
; j++) {

468 
	`ucc_as£¹
(
roÙ
 =ğ
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].root);

469 
group_id
 = 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].group_id;

470 
to_£nd_Ëá
 = 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].to_send_left;

471 
off£t_Ëá
 = 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].offset_left;

472 
num_·ck‘s
 = 
	`ucc_mš
(
comm
->
bÿ¡_comm
.
max_push_£nd
 - comm->
³ndšg_£nd
, 
to_£nd_Ëá
);

473 ià(
to_£nd_Ëá
 &&

474 (
comm
->
bÿ¡_comm
.
max_push_£nd
 - comm->
³ndšg_£nd
) > 0) {

475 
	`ucc_as£¹
(
»q
->
am_roÙ
);

476 
¡©us
 = 
	`ucc__mlx5_mÿ¡_£nd_cŞËùive
(
comm
, 
»q
, 
num_·ck‘s
,

477 
zcİy
, 
group_id
, 
off£t_Ëá
);

478 ià(
UCC_OK
 !ğ
¡©us
) {

479  
¡©us
;

481 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
to_£nd_Ëá
 -ğ
num_·ck‘s
;

482 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
off£t_Ëá
 +ğ(
num_·ck‘s
 * 
comm
->
max_³r_·ck‘
);

484 ià(
comm
->
³ndšg_£nd
) {

485 
¡©us
 = 
	`ucc__mlx5_mÿ¡_pŞl_£nd
(
comm
);

486 ià(
¡©us
 !ğ
UCC_OK
) {

487  
¡©us
;

490 ià(!
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
to_£nd_Ëá
 && !
comm
->
³ndšg_£nd
) {

491 
	`_Œaû
(
comm
->
lib
, "done with mcast ops step %d group id %do_send %d",

492 
»q
->
¡•
, 
group_id
, 
sched
[»q->¡•].
to_£nd
);

493 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ_dÚe
 = 1;

499 ià(!
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
) {

501 
j
 = 0; j < 
»q
->
cÚcu¼’cy_Ëv–
; j++) {

502 
group_id
 = 
sched
[
»q
->
¡•
].
´•o¡_buf_İ
[
j
].group_id;

503 
couÁ
 = 
sched
[
»q
->
¡•
].
´•o¡_buf_İ
[
j
].count;

504 
off£t
 = 
sched
[
»q
->
¡•
].
´•o¡_buf_İ
[
j
].offset;

505 ià(
couÁ
) {

506 
	`ucc_as£¹
(!
»q
->
am_roÙ
);

507 
¡©us
 = 
	`ucc__mlx5_mÿ¡_po¡_u£r_»cv_bufãrs
(
comm
, 
»q
, 
group_id
, 
roÙ
,

508 
UCC_COLL_TYPE_BCAST
, 
couÁ
,

509 
off£t
);

510 ià(
UCC_OK
 !ğ
¡©us
) {

511  
¡©us
;

515 ià(
»q
->
to_»cv
) {

516 
num_»cvd
 = 
	`ucc__mlx5_mÿ¡_»cv_cŞËùive
(
comm
, 
»q
,

517 
»q
->
to_»cv
,

518 
UCC_COLL_TYPE_BCAST
);

519 ià(
num_»cvd
 < 0) {

520 
	`_”rÜ
(
comm
->
lib
, "a failure happend during cq…olling");

521 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

522  
¡©us
;

524 
sched
[
»q
->
¡•
].
num_»cvd
 +=‚um_recvd;

527 
	`_Œaû
(
comm
->
lib
, "done with…repost bufs step %d group id %d count %d offset %ld„oot %d",

528 
»q
->
¡•
, 
group_id
, 
couÁ
, 
off£t
, 
roÙ
);

529 
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
 = 1;

532 ià(
»q
->
to_»cv
) {

533 
num_»cvd
 = 
	`ucc__mlx5_mÿ¡_»cv_cŞËùive
(
comm
, 
»q
,

534 
»q
->
to_»cv
,

535 
UCC_COLL_TYPE_BCAST
);

536 ià(
num_»cvd
 < 0) {

537 
	`_”rÜ
(
comm
->
lib
, "a failure happend during cq…olling");

538 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

539  
¡©us
;

541 
sched
[
»q
->
¡•
].
num_»cvd
 +=‚um_recvd;

544 ià(
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
 &&

545 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ_dÚe
 &&

546 
sched
[
»q
->
¡•
].
num_»cvd
 =ğsched[»q->¡•].
to_»cv
) {

548 
	`ucc_as£¹
(
sched
[
»q
->
¡•
].
´•o¡_buf_İ_dÚe
 && sched[»q->¡•].
muÉiÿ¡_İ_dÚe
);

549 
	`ucc_as£¹
(
»q
->
b¬r›r_»q
 =ğ
NULL
);

550 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`b¬r›r_po¡
(comm->
p2p_ùx
, &
»q
->
b¬r›r_»q
);

551 ià(
¡©us
 !ğ
UCC_OK
) {

552  
¡©us
;

554 
	`_Œaû
(
comm
->
lib
, "š™ glob® synø»q->¡• %d", 
»q
->
¡•
);

558 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

559 
¡©us
 = 
	`ucc__mlx5_mÿ¡_check_zcİy_bÿ¡_cŞËùive
(
comm
, 
»q
);

560 ià(
¡©us
 < 0) {

561  
¡©us
;

565 ià(
»q
->
b¬r›r_»q
 !ğ
NULL
 ||

566 
	`MCAST_BCAST_IN_PROGRESS
(
»q
, 
comm
)) {

567  
UCC_INPROGRESS
;

571 
	`as£¹
(
»q
->
¡•
 =ğ
sched
->
tÙ®_¡•s
);

572  
UCC_OK
;

573 
	}
}

575 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_´•¬e_bÿ¡
(* 
buf
, 
size_t
 
size
, 
ucc_¿nk_t
 
roÙ
,

576 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

577 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

579 
ucc_¡©us_t
 
¡©us
;

580 
ucc__mlx5_mÿ¡_»g_t
 *
»g
;

582 
»q
->
comm
 = comm;

583 
»q
->
±r
 = 
buf
;

584 
»q
->
Ëngth
 = 
size
;

585 
»q
->
roÙ
 =„oot;

586 
»q
->
am_roÙ
 = (
roÙ
 =ğ
comm
->
¿nk
);

587 
»q
->
mr
 = 
comm
->
µ_mr
;

588 
»q
->
¼eg
 = 
NULL
;

590 
»q
->
´Ùo
 = (»q->
Ëngth
 < 
comm
->
max_—g”
 && !comm->
cuda_mem_’abËd
) ?

591 
MCAST_PROTO_EAGER
 : 
MCAST_PROTO_ZCOPY
;

593 
»q
->
num_·ck‘s
 = 
	`ucc_div_round_up
Ôeq->
Ëngth
, 
comm
->
max_³r_·ck‘
);

594 
»q
->
off£t
 = 0;

595 
»q
->
to_£nd
 =„eq->
am_roÙ
 ?„eq->
num_·ck‘s
 : 0;

596 
»q
->
to_»cv
 =„eq->
am_roÙ
 ? 0 :„eq->
num_·ck‘s
;

598 ià(
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
) {

599 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´•¬e_z”o_cİy_bÿ¡
(
comm
, 
»q
);

600 ià(
UCC_OK
 !ğ
¡©us
) {

601  
¡©us
;

603 
»q
->
´og»ss
 = 
ucc__mlx5_mÿ¡_do_z”o_cİy_p–šed_bÿ¡
;

605 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´•¬e_»lŸbË
(
comm
, 
»q
,„eq->
roÙ
);

606 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

607  
¡©us
;

609 
»q
->
¡¬t_p¢
 = 
comm
->
bÿ¡_comm
.
Ï¡_p¢
;

610 
»q
->
Ï¡_pkt_Ën
 =„eq->
Ëngth
 - (»q->
num_·ck‘s
 - 1è* 
comm
->
max_³r_·ck‘
;

611 
	`ucc_as£¹
(
»q
->
Ï¡_pkt_Ën
 > 0 &&„eq->Ï¡_pkt_ËÀ<ğ
comm
->
max_³r_·ck‘
);

612 
comm
->
bÿ¡_comm
.
Ï¡_p¢
 +ğ
»q
->
num_·ck‘s
;

613 
»q
->
fœ¡_£nd_p¢
 =„eq->
¡¬t_p¢
;

614 
»q
->
´og»ss
 = 
ucc__mlx5_mÿ¡_do_bÿ¡
;

617 ià(
»q
->
am_roÙ
) {

618 ià(
»q
->
´Ùo
 !ğ
MCAST_PROTO_EAGER
) {

619 
¡©us
 = 
	`ucc__mlx5_mÿ¡_mem_»gi¡”
(
comm
->
ùx
, 
»q
->
±r
,„eq->
Ëngth
, &
»g
);

620 ià(
UCC_OK
 !ğ
¡©us
) {

621 ià(
»q
->
ag_scheduË
) {

622 
	`ucc_ä“
(
»q
->
ag_scheduË
);

624  
¡©us
;

626 
»q
->
¼eg
 = 
»g
;

627 
»q
->
mr
 = 
»g
->mr;

631  
UCC_OK
;

632 
	}
}

634 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_cŞl_do_bÿ¡
(* 
buf
, 
size_t
 
size
, 
ucc_¿nk_t
 
roÙ
,

635 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

636 
ucc__mlx5_mÿ¡_cŞl_»q_t
 **
sk_»q_hªdË
)

638 
ucc_¡©us_t
 
¡©us
;

639 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
;

641 
	`_Œaû
(
comm
->
lib
, "MCAST bcast start, buf %p, size %ld,„oot %d, comm %d, "

643 
buf
, 
size
, 
roÙ
, 
comm
->
comm_id
, comm->
commsize
, comm->
¿nk
 ==

644 
roÙ
, 
comm
->
p¢
 );

646 
»q
 = 
	`ucc_mpoŞ_g‘
(&
comm
->
ùx
->
mÿ¡_»q_mp
);

647 ià(!
»q
) {

648 
	`_”rÜ
(
comm
->
lib
, "failedo get mcast„eq");

649  
UCC_ERR_NO_MEMORY
;

651 
	`mem£t
(
»q
, 0, (
ucc__mlx5_mÿ¡_cŞl_»q_t
));

653 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´•¬e_bÿ¡
(
buf
, 
size
, 
roÙ
, 
comm
, 
»q
);

654 ià(
UCC_OK
 !ğ
¡©us
) {

655 
	`ucc_mpoŞ_put
(
»q
);

656  
¡©us
;

659 
¡©us
 = 
UCC_INPROGRESS
;

660 *
sk_»q_hªdË
 = 
»q
;

662  
¡©us
;

663 
	}
}

665 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_bÿ¡_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

667 
ucc__mlx5_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_mlx5_task_t);

668 
ucc__mlx5_‹am_t
 *
mlx5_‹am
 = 
	`TASK_TEAM
(
sk
);

669 
ucc__mlx5_mÿ¡_‹am_t
 *
‹am
 = 
mlx5_‹am
->
mÿ¡
;

670 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

671 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

672 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

673 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

674 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

675 
size_t
 
d©a_size
 = 
	`ucc_dt_size
(
dt
è* 
couÁ
;

676 *
buf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

677 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
‹am
->
mÿ¡_comm
;

679 
sk
->
cŞl_mÿ¡
.
»q_hªdË
 = 
NULL
;

681 
¡©us
 = 
	`ucc__mlx5_mÿ¡_cŞl_do_bÿ¡
(
buf
, 
d©a_size
, 
roÙ
, 
comm
,

682 &
sk
->
cŞl_mÿ¡
.
»q_hªdË
);

683 ià(
¡©us
 < 0) {

684 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "mÿ¡_cŞl_do_bÿ¡ faed:%d", 
¡©us
);

685 
cŞl_sk
->
¡©us
 = status;

686  
	`ucc_sk_com¶‘e
(
cŞl_sk
);

689 
	`ucc_as£¹
(
sk
->
cŞl_mÿ¡
.
»q_hªdË
 !ğ
NULL
);

691 
cŞl_sk
->
¡©us
 = status;

692 
sk
->
cŞl_mÿ¡
.
»q_hªdË
->
cŞl_sk
 = coll_task;

694  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
mlx5_‹am
)->
pq
, &
sk
->
su³r
);

695 
	}
}

697 
šlše
 
	$ucc__mlx5_mÿ¡_bÿ¡_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

699 
ucc__mlx5_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_mlx5_task_t);

700 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
 = 
sk
->
cŞl_mÿ¡
.
»q_hªdË
;

702 
	`ucc_as£¹
(
»q
 !ğ
NULL
);

704 
cŞl_sk
->
¡©us
 = (
»q
->
´og»ss
)(req);

705 ià(
cŞl_sk
->
¡©us
 < 0) {

706 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "´og»s mÿ¡ bÿ¡ faed:%d", 
cŞl_sk
->
¡©us
);

708 
	}
}

710 
šlše
 
ucc_¡©us_t


711 
	$ucc__mlx5_mÿ¡_check_comm_Ëv–_ÿp
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

712 
ucc_ba£_‹am_t
 *
‹am
)

714 
ucc__mlx5_‹am_t
 *
mlx5_‹am
 =

715 
	`ucc_d”ived_of
(
‹am
, 
ucc__mlx5_‹am_t
);

716 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 =

717 
mlx5_‹am
->
mÿ¡
->
mÿ¡_comm
;

718 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
cŞl_¬gs
->args;

719 
size_t
 
buf_size
 =

720 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
è*‡rgs->¤c.šfo.
couÁ
;

721 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
¤c
.
šfo
.mem_type;

722 
ucc_cŞl_ty³_t
 
cŞl_ty³
 = 
¬gs
->coll_type;

723 
boŞ
 
mÿ¡_’abËd
 = 
çl£
;

724 
boŞ
 
z”o_cİy_suµÜ‹d
 = 
çl£
;

727 ià(
mem_ty³
 !ğ
UCC_MEMORY_TYPE_CUDA
 &&

728 
mem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
) {

729 
	`_Œaû
(
comm
->
lib
,

731 
mem_ty³
);

732  
UCC_ERR_NO_RESOURCE
;

736 ià((
comm
->
cuda_mem_’abËd
 && 
mem_ty³
 =ğ
UCC_MEMORY_TYPE_HOST
) ||

737 (!
comm
->
cuda_mem_’abËd
 && 
mem_ty³
 =ğ
UCC_MEMORY_TYPE_CUDA
)) {

738 
	`_Œaû
(
comm
->
lib
,

741 
comm
->
cuda_mem_’abËd
,

742 
mem_ty³
 =ğ
UCC_MEMORY_TYPE_CUDA
);

743  
UCC_ERR_NO_RESOURCE
;

747 ià(
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
 &&

748 
comm
->
cÚ‹xt
->
mÿ¡_bÿ¡_’abËd
) {

749 
mÿ¡_’abËd
 = 
Œue
;

750 } ià(
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHER
 &&

751 
comm
->
cÚ‹xt
->
mÿ¡_®lg©h”_’abËd
) {

752 
mÿ¡_’abËd
 = 
Œue
;

755 ià(!
mÿ¡_’abËd
) {

756 
	`_Œaû
(
comm
->
lib
,

758 
	`ucc_cŞl_ty³_¡r
(
cŞl_ty³
));

759  
UCC_ERR_NO_RESOURCE
;

763 ià(
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
 &&

764 
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
) {

765 
z”o_cİy_suµÜ‹d
 = 
Œue
;

766 } ià(
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHER
 &&

767 
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
) {

768 
z”o_cİy_suµÜ‹d
 = 
Œue
;

771 ià(
z”o_cİy_suµÜ‹d
) {

772 ià(
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
 &&

773 (
buf_size
 < 
comm
->
Œuly_z”o_cİy_cŞl_mš_msg
 ||

774 
buf_size
 % 
comm
->
max_³r_·ck‘
 != 0)) {

775 
	`_Œaû
(
comm
->
lib
,

778 
buf_size
,

779 
comm
->
Œuly_z”o_cİy_cŞl_mš_msg
,

780 
comm
->
max_³r_·ck‘
);

781  
UCC_ERR_NO_RESOURCE
;

782 } ià(
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHER
 &&

783 
buf_size
 >ğ
comm
->
max_³r_·ck‘
 &&

784 
buf_size
 % 
comm
->
max_³r_·ck‘
 != 0) {

787 
	`_Œaû
(
comm
->
lib
,

790 
comm
->
max_³r_·ck‘
, comm->max_per_packet);

791  
UCC_ERR_NO_RESOURCE
;

796 ià(
mem_ty³
 =ğ
UCC_MEMORY_TYPE_CUDA
 &&

797 
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
 &&

798 
buf_size
 > 
CUDA_MEM_MCAST_BCAST_MAX_MSG
 &&

799 !
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
) {

800 
	`_Œaû
(
comm
->
lib
,

803 
buf_size
, 
CUDA_MEM_MCAST_BCAST_MAX_MSG
);

804  
UCC_ERR_NO_RESOURCE
;

807  
UCC_OK
;

808 
	}
}

810 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_check_suµÜt
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

811 
ucc_ba£_‹am_t
 *
‹am
)

813 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(&
cŞl_¬gs
->
¬gs
) ||

814 ((
cŞl_¬gs
->
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHER
) &&

815 (
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
è|| 
	`UCC_IS_PERSISTENT
(coll_args->args)))) {

816 
	`_Œaû
(
‹am
->
cÚ‹xt
->
lib
, "mcast collective‚ot supported");

817  
UCC_ERR_NOT_SUPPORTED
;

820 ià(
UCC_OK
 !ğ
	`ucc__mlx5_mÿ¡_check_comm_Ëv–_ÿp
(
cŞl_¬gs
, 
‹am
)) {

821 
	`_Œaû
(
‹am
->
cÚ‹xt
->
lib
, "mcast collective‚ot supported");

822  
UCC_ERR_NOT_SUPPORTED
;

825  
UCC_OK
;

826 
	}
}

828 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_bÿ¡_š™
(
ucc__mlx5_sk_t
 *
sk
)

830 
sk
->
su³r
.
po¡
 = 
ucc__mlx5_mÿ¡_bÿ¡_¡¬t
;

831 
sk
->
su³r
.
´og»ss
 = 
ucc__mlx5_mÿ¡_bÿ¡_´og»ss
;

832 
sk
->
su³r
.
æags
 = 
UCC_COLL_TASK_FLAG_EXECUTOR
;

834  
UCC_OK
;

835 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_coll.h

7 #iâdeà
UCC_TL_MLX5_MCAST_COLL_H_


8 
	#UCC_TL_MLX5_MCAST_COLL_H_


	)

10 
	~"_mlx5_mÿ¡.h
"

11 
	~"_mlx5_cŞl.h
"

13 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_bÿ¡_š™
(
ucc__mlx5_sk_t
 *
sk
);

15 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_‹¡
(
ucc__mlx5_mÿ¡_cŞl_»q_t
* 
_»q
);

17 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_check_suµÜt
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

18 
ucc_ba£_‹am_t
 *
‹am
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_context.c

7 
	~<š‰y³s.h
>

8 
	~"_mlx5_mÿ¡.h
"

9 
	~"uts/¬ch/ıu.h
"

10 
	~<ucs/sys/¡ršg.h
>

11 
	~"cÜe/ucc_£rviû_cŞl.h
"

12 
	~"_mlx5.h
"

13 
	~"_mlx5_mÿ¡_h–³r.h
"

14 
	~"_mlx5_mÿ¡_rÿche.h
"

16 
	#UCC_TL_MLX5_MCAST_MAX_MTU_COUNT
 5

	)

17 
	gmtu_lookup
[
UCC_TL_MLX5_MCAST_MAX_MTU_COUNT
][2] = {

18 {256, 
IBV_MTU_256
},

19 {512, 
IBV_MTU_512
},

20 {1024, 
IBV_MTU_1024
},

21 {2048, 
IBV_MTU_2048
},

22 {4096, 
IBV_MTU_4096
}

25 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_cÚ‹xt_š™
(
ucc__mlx5_mÿ¡_cÚ‹xt_t
 *
cÚ‹xt
,

26 
ucc__mlx5_mÿ¡_ùx_·¿ms_t
 *
mÿ¡_ùx_cÚf
)

28 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

29 
ibv_deviû
 **
deviû_li¡
 = 
NULL
;

30 
ibv_deviû
 *
dev
 = 
NULL
;

31 *
devÇme
 = 
NULL
;

32 
is_v4
 = 0;

33 
sockaddr_š
 *
š_¤c_addr
 = 
NULL
;

34 
rdma_cm_ev’t
 *
»v’t
 = 
NULL
;

35 
aùive_mtu
 = 4096;

36 
max_mtu
 = 4096;

37 
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
 = 
NULL
;

38 *
ib_devÇme
 = 
NULL
;

39 
devÇme_Ën
 = 0, 
ib_pÜt
 = 1;

40 
ibv_pÜt_©Œ
 
pÜt_©Œ
;

41 
ibv_deviû_©Œ
 
deviû_©Œ
;

42 
sockaddr_¡Üage
 
_oib_addr
;

43 
sockaddr_¡Üage
 
d¡_addr
;

44 
num_deviûs
;

45 
addr¡r
[128];

46 
ucc__mlx5_cÚ‹xt_t
 *
mlx5_ùx
;

47 
ucc_ba£_lib_t
 *
lib
;

48 
i
;

49 
ib_v®id
;

50 cÚ¡ *
d¡
;

51 
tmp
[128], *
pos
, *
’d_pos
;

53 
mlx5_ùx
 = 
	`ucc_cÚš”_of
(
cÚ‹xt
, 
ucc__mlx5_cÚ‹xt_t
, 
mÿ¡
);

54 
lib
 = 
mlx5_ùx
->
su³r
.super.lib;

56 
cÚ‹xt
->
mÿ¡_’abËd
 = 
mÿ¡_ùx_cÚf
->mcast_enabled;

57 
cÚ‹xt
->
mÿ¡_bÿ¡_’abËd
 = 
mÿ¡_ùx_cÚf
->mcast_bcast_enabled;

58 
cÚ‹xt
->
mÿ¡_®lg©h”_’abËd
 = 
mÿ¡_ùx_cÚf
->mcast_allgather_enabled;

59 ià(
cÚ‹xt
->
mÿ¡_bÿ¡_’abËd
 && cÚ‹xt->
mÿ¡_®lg©h”_’abËd
) {

61 
cÚ‹xt
->
mÿ¡_®lg©h”_’abËd
 = 0;

64 ià(
mÿ¡_ùx_cÚf
->
mÿ¡_’abËd
 =ğ
UCC_NO
) {

65 
	`_debug
(
lib
, "Mcast is disabled byhe user");

66  
UCC_ERR_NO_RESOURCE
;

69 
ùx
 = &(
cÚ‹xt
->
mÿ¡_cÚ‹xt
);

70 
	`mem£t
(
ùx
, 0, (
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
));

71 
	`memıy
(&
ùx
->
·¿ms
, 
mÿ¡_ùx_cÚf
, (
ucc__mlx5_mÿ¡_ùx_·¿ms_t
));

73 
ùx
->
lib
 =†ib;

76 
deviû_li¡
 = 
	`ibv_g‘_deviû_li¡
(&
num_deviûs
);

77 ià(!
deviû_li¡
 || !
num_deviûs
) {

78 
	`_debug
(
lib
, "no ib devices‡vailable");

79 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

80 
”rÜ
;

83 ià(!
	`¡rcmp
(
mÿ¡_ùx_cÚf
->
ib_dev_Çme
, "")) {

84 
dev
 = 
deviû_li¡
[0];

85 
devÇme
 = (*)
	`ibv_g‘_deviû_Çme
(
dev
);

86 
ùx
->
devÇme
 = 
	`ucc_m®loc
(
	`¡¾’
(devname)+3, "devname");

87 ià(!
ùx
->
devÇme
) {

88 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

89 
”rÜ
;

91 
	`mem£t
(
ùx
->
devÇme
, 0, 
	`¡¾’
(devname)+3);

92 
	`memıy
(
ùx
->
devÇme
, devÇme, 
	`¡¾’
(devname));

93 
	`¡ºÿt
(
ùx
->
devÇme
, ":1", 3);

94 
ùx
->
u£r_´ovided_ib
 = 0;

95 
ùx
->
ib_pÜt
 = 1;

97 
ib_v®id
 = 0;

100 
ib_devÇme
 = 
mÿ¡_ùx_cÚf
->
ib_dev_Çme
;

101 
pos
 = 
	`¡r¡r
(
ib_devÇme
, ":");

102 ià(!
pos
) {

103 
devÇme_Ën
 = (
tmp
) - 1;

105 
devÇme_Ën
 = ()(
pos
 - 
ib_devÇme
);

106 
pos
++;

107 
”ºo
 = 0;

108 
ib_pÜt
 = ()
	`¡¹Ş
(
pos
, &
’d_pos
, 0);

109 ià(
”ºo
 !ğ0 || 
pos
 =ğ
’d_pos
 || 
	`¡rcmp
Ónd_pos,"\0"è|| 
ib_pÜt
 < 0

110 || 
ib_pÜt
 > 
UINT8_MAX
 ) {

111 
	`_w¬n
(
lib
, "wrong device's…ort‚umber");

112  
UCC_ERR_INVALID_PARAM
;

115 
ùx
->
ib_pÜt
 = ib_port;

116 
	`¡ºıy
(
tmp
, 
ib_devÇme
, 
devÇme_Ën
);

117 
tmp
[
devÇme_Ën
] = '\0';

118 
ib_devÇme
 = 
tmp
;

120 
i
 = 0; 
deviû_li¡
[i]; ++i) {

121 ià(!
	`¡rcmp
(
	`ibv_g‘_deviû_Çme
(
deviû_li¡
[
i
]), 
ib_devÇme
)) {

122 
ib_v®id
 = 1;

126 ià(!
ib_v®id
) {

127 
	`_w¬n
(
lib
, "ib deviû % nÙ found", 
mÿ¡_ùx_cÚf
->
ib_dev_Çme
);

128 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

129 
	`ibv_ä“_deviû_li¡
(
deviû_li¡
);

130 
”rÜ
;

132 
ùx
->
devÇme
 = 
mÿ¡_ùx_cÚf
->
ib_dev_Çme
;

133 
ùx
->
u£r_´ovided_ib
 = 1;

136 
	`ibv_ä“_deviû_li¡
(
deviû_li¡
);

138 
¡©us
 = 
	`ucc__mlx5_´obe__ov”_ib
(
ùx
->
devÇme
, &
_oib_addr
);

139 ià(
UCC_OK
 !ğ
¡©us
) {

140 
	`_debug
(
lib
, "çedØg‘ ipoib iÁ”çû fÜ devÇm%s", 
ùx
->
devÇme
);

141 ià(!
ùx
->
u£r_´ovided_ib
) {

142 
	`ucc_ä“
(
ùx
->
devÇme
);

144 
”rÜ
;

147 
is_v4
 = (
_oib_addr
.
ss_çmy
 =ğ
AF_INET
) ? 1 : 0;

148 
š_¤c_addr
 = (
sockaddr_š
*)&
_oib_addr
;

150 
d¡
 = 
	`š‘_Áİ
((
is_v4
è? 
AF_INET
 : 
AF_INET6
,

151 &
š_¤c_addr
->
sš_addr
, 
addr¡r
, (addrstr) - 1);

152 ià(
NULL
 =ğ
d¡
) {

153 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
, "inet_ntop failed");

154 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

155 
”rÜ
;

158 
	`_debug
(
ùx
->
lib
, "devÇm%s, ipoib %s", ctx->
devÇme
, 
addr¡r
);

160 
ùx
->
chªÃl
 = 
	`rdma_ü—‹_ev’t_chªÃl
();

161 ià(!
ùx
->
chªÃl
) {

162 
	`_debug
(
lib
, "rdma_ü—‹_ev’t_chªÃÈçed,ƒ¼nØ%d", 
”ºo
);

163 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

164 
”rÜ
;

167 
	`mem£t
(&
d¡_addr
, 0, (
sockaddr_¡Üage
));

168 
d¡_addr
.
ss_çmy
 = 
is_v4
 ? 
AF_INET
 : 
AF_INET6
;

169 ià(
	`rdma_ü—‹_id
(
ùx
->
chªÃl
, &ùx->
id
, 
NULL
, 
RDMA_PS_UDP
)) {

170 
	`_debug
(
lib
, "çedØü—‹„dm¨id,ƒ¼nØ%d", 
”ºo
);

171 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

172 
”rÜ
;

175 ià(0 !ğ
	`rdma_»sŞve_addr
(
ùx
->
id
, (
sockaddr
 *)&
_oib_addr
,

176 (
sockaddr
 *è&
d¡_addr
, 1000)) {

177 
	`_debug
(
lib
, "çedØ»sŞvrdm¨addr,ƒ¼nØ%d", 
”ºo
);

178 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

179 
”rÜ
;

182 ià(
	`rdma_g‘_cm_ev’t
(
ùx
->
chªÃl
, &
»v’t
) < 0) {

183 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
,

184 "çedØg‘ cmƒv’t,ƒ¼nØ%d", 
”ºo
);

185 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

186 
”rÜ
;

187 } ià(
»v’t
->
ev’t
 !ğ
RDMA_CM_EVENT_ADDR_RESOLVED
) {

188 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
, "cmƒvent is‚ot„esolved");

189 ià(
	`rdma_ack_cm_ev’t
(
»v’t
) < 0) {

190 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
, "rdma_ack_cm_event failed");

192 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

193 
”rÜ
;

196 ià(
	`rdma_ack_cm_ev’t
(
»v’t
) < 0) {

197 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
, "rdma_ack_cm_event failed");

198 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

199 
”rÜ
;

202 
ùx
->ùx = ctx->
id
->
v”bs
;

203 
ùx
->
pd
 = 
	`ibv_®loc_pd
(ctx->ctx);

204 ià(!
ùx
->
pd
) {

205 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
, "failedo‡llocate…d");

206 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

207 
”rÜ
;

211 ià(
	`ibv_qu”y_pÜt
(
ùx
->ùx, ctx->
ib_pÜt
, &
pÜt_©Œ
)) {

212 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
,

213 "couldn'ˆqu”y…Üˆš ctx c»©e,ƒ¼nØ%d", 
”ºo
);

214 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

215 
”rÜ
;

218 
i
 = 0; i < 
UCC_TL_MLX5_MCAST_MAX_MTU_COUNT
; i++) {

219 ià(
mtu_lookup
[
i
][1] =ğ
pÜt_©Œ
.
max_mtu
) {

220 
max_mtu
 = 
mtu_lookup
[
i
][0];

222 ià(
mtu_lookup
[
i
][1] =ğ
pÜt_©Œ
.
aùive_mtu
) {

223 
aùive_mtu
 = 
mtu_lookup
[
i
][0];

227 
ùx
->
mtu
 = 
aùive_mtu
;

228 
ùx
->
pÜt_lid
 = 
pÜt_©Œ
.
lid
;

230 
	`_debug
(
ùx
->
lib
, "port‡ctive MTU is %d‡nd…ort max MTU is %d",

231 
aùive_mtu
, 
max_mtu
);

233 ià(
pÜt_©Œ
.
max_mtu
 <…Üt_©Œ.
aùive_mtu
) {

234 
	`_debug
(
ùx
->
lib
, "port‡ctive MTU (%d) is smallerhan…ort max MTU (%d)",

235 
aùive_mtu
, 
max_mtu
);

238 ià(
	`ibv_qu”y_deviû
(
ùx
->ùx, &
deviû_©Œ
)) {

239 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
,

240 "çedØqu”y deviû iÀùx c»©e,ƒ¼nØ%d", 
”ºo
);

241 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

242 
”rÜ
;

245 
	`_debug
(
ùx
->
lib
, "MTU %d, MAX QP WR: %d, max sqr_wr: %d, max cq: %d, max cqe: %d",

246 
ùx
->
mtu
, 
deviû_©Œ
.
max_qp_wr
, deviû_©Œ.
max_¤q_wr
,

247 
deviû_©Œ
.
max_cq
, deviû_©Œ.
max_cqe
);

249 
ùx
->
max_qp_wr
 = 
deviû_©Œ
.max_qp_wr;

251 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
ùx
->
com¶_objeùs_mp
, 0, (
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
), 0,

252 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
,

253 &
ucc_cŞl_sk_mpoŞ_İs
,

254 
UCC_THREAD_SINGLE
,

256 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

257 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
,

259 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

260 
”rÜ
;

263 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
ùx
->
mÿ¡_»q_mp
, 0, (
ucc__mlx5_mÿ¡_cŞl_»q_t
), 0,

264 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
,

265 &
ucc_cŞl_sk_mpoŞ_İs
,

266 
UCC_THREAD_SINGLE
,

268 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

269 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
,

271 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

272 
”rÜ
;

275 
ùx
->
rÿche
 = 
NULL
;

276 
¡©us
 = 
	`ucc__mlx5_mÿ¡_£tup_rÿche
(
ùx
);

277 ià(
UCC_OK
 !ğ
¡©us
) {

278 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
, "failedo setup„cache");

279 
”rÜ
;

282 
	`_debug
(
ùx
->
lib
, "multicast context setup complete: ctx %p", ctx);

284  
UCC_OK
;

286 
”rÜ
:

287 ià(
ùx
->
pd
) {

288 
	`ibv_d—Îoc_pd
(
ùx
->
pd
);

289 
ùx
->
pd
 = 
NULL
;

291 ià(
ùx
->
id
) {

292 
	`rdma_de¡roy_id
(
ùx
->
id
);

293 
ùx
->
id
 = 
NULL
;

295 ià(
ùx
->
chªÃl
) {

296 
	`rdma_de¡roy_ev’t_chªÃl
(
ùx
->
chªÃl
);

297 
ùx
->
chªÃl
 = 
NULL
;

301 
	`_mlx5_mÿ¡_log
(
cÚ‹xt
->
mÿ¡_’abËd
, 
lib
, 
UCC_LOG_LEVEL_WARN
,

302 "mÿ¡ cÚ‹xˆš™Ÿliz©iÚ faed (¡©us: %d)", 
¡©us
);

304  
UCC_ERR_NO_RESOURCE
;

305 
	}
}

307 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_ş—n_ùx
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
)

309 
	`_debug
(
ùx
->
lib
, "cleaning mcast ctx: %p", ctx);

311 ià(
ùx
->
rÿche
) {

312 
	`ucc_rÿche_de¡roy
(
ùx
->
rÿche
);

313 
ùx
->
rÿche
 = 
NULL
;

316 ià(
ùx
->
pd
) {

317 ià(
	`ibv_d—Îoc_pd
(
ùx
->
pd
)) {

318 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_ERROR
,

319 "ibv_d—Îoc_pd faedƒ¼nØ%d", 
”ºo
);

320  
UCC_ERR_NO_RESOURCE
;

322 
ùx
->
pd
 = 
NULL
;

325 ià(
ùx
->
id
 && 
	`rdma_de¡roy_id
(ctx->id)) {

326 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_ERROR
,

327 "rdma_de¡roy_id faedƒ¼nØ%d", 
”ºo
);

328  
UCC_ERR_NO_RESOURCE
;

331 
ùx
->
id
 = 
NULL
;

333 ià(
ùx
->
chªÃl
) {

334 
	`rdma_de¡roy_ev’t_chªÃl
(
ùx
->
chªÃl
);

335 
ùx
->
chªÃl
 = 
NULL
;

338 ià(
ùx
->
devÇme
 && !ùx->
u£r_´ovided_ib
) {

339 
	`ucc_ä“
(
ùx
->
devÇme
);

340 
ùx
->
devÇme
 = 
NULL
;

343  
UCC_OK
;

344 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_hca_copy.c

7 
	~"_mlx5_mÿ¡_hÿ_cİy.h
"

8 
	~"_mlx5_mÿ¡_h–³r.h
"

9 
	~"_mlx5_mÿ¡_rÿche.h
"

10 
	~<šfšibªd/v”bs.h
>

13 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_hÿ_cİy_£tup_»sourûs
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

15 
ibv_qp_š™_©Œ
 
qp_©Œ
;

18 ià(!
comm
->
hÿ_cİy_cq
) {

19 
comm
->
hÿ_cİy_cq
 = 
	`ibv_ü—‹_cq
(comm->
ùx
->ùx, 16, 
NULL
, NULL, 0);

20 ià(!
comm
->
hÿ_cİy_cq
) {

21 
	`_”rÜ
(
comm
->
lib
, "çedØü—‹ HCA cİy CQ,ƒ¼nØ%d", 
”ºo
);

22  
UCC_ERR_NO_RESOURCE
;

24 
	`_debug
(
comm
->
lib
, "created dedicated HCA copy CQ");

28 ià(!
comm
->
hÿ_cİy_qp
) {

29 
	`mem£t
(&
qp_©Œ
, 0, (qp_attr));

30 
qp_©Œ
.
qp_ty³
 = 
IBV_QPT_RC
;

31 
qp_©Œ
.
£nd_cq
 = 
comm
->
hÿ_cİy_cq
;

32 
qp_©Œ
.
»cv_cq
 = 
comm
->
hÿ_cİy_cq
;

33 
qp_©Œ
.
sq_sig_®l
 = 1;

34 
qp_©Œ
.
ÿp
.
max_£nd_wr
 = 16;

35 
qp_©Œ
.
ÿp
.
max_»cv_wr
 = 16;

36 
qp_©Œ
.
ÿp
.
max_£nd_sge
 = 1;

37 
qp_©Œ
.
ÿp
.
max_»cv_sge
 = 1;

38 
qp_©Œ
.
ÿp
.
max_šlše_d©a
 = 0;

40 
comm
->
hÿ_cİy_qp
 = 
	`ibv_ü—‹_qp
(comm->
ùx
->
pd
, &
qp_©Œ
);

41 ià(!
comm
->
hÿ_cİy_qp
) {

42 
	`_”rÜ
(
comm
->
lib
, "çedØü—‹ HCA cİy QP,ƒ¼nØ%d", 
”ºo
);

43 
	`ibv_de¡roy_cq
(
comm
->
hÿ_cİy_cq
);

44 
comm
->
hÿ_cİy_cq
 = 
NULL
;

45  
UCC_ERR_NO_RESOURCE
;

47 
	`_debug
(
comm
->
lib
, "created dedicated HCA copy QP");

50 
ibv_qp_©Œ
 
©Œ
;

51 
	`mem£t
(&
©Œ
, 0, (attr));

52 
©Œ
.
qp_¡©e
 = 
IBV_QPS_INIT
;

53 
©Œ
.
pkey_šdex
 = 0;

54 
©Œ
.
pÜt_num
 = 
comm
->
ùx
->
ib_pÜt
;

55 
©Œ
.
qp_acûss_æags
 = 
IBV_ACCESS_REMOTE_WRITE
 | 
IBV_ACCESS_REMOTE_READ
;

57 ià(
	`ibv_modify_qp
(
comm
->
hÿ_cİy_qp
, &
©Œ
,

58 
IBV_QP_STATE
 | 
IBV_QP_PKEY_INDEX
 | 
IBV_QP_PORT
 | 
IBV_QP_ACCESS_FLAGS
)) {

59 
	`_”rÜ
(
comm
->
lib
, "failedo move HCA copy QPo INIT");

60 
	`ibv_de¡roy_qp
(
comm
->
hÿ_cİy_qp
);

61 
	`ibv_de¡roy_cq
(
comm
->
hÿ_cİy_cq
);

62 
comm
->
hÿ_cİy_qp
 = 
NULL
;

63 
comm
->
hÿ_cİy_cq
 = 
NULL
;

64  
UCC_ERR_NO_RESOURCE
;

68 
	`mem£t
(&
©Œ
, 0, (attr));

69 
©Œ
.
qp_¡©e
 = 
IBV_QPS_RTR
;

70 
©Œ
.
·th_mtu
 = 
IBV_MTU_1024
;

71 
©Œ
.
de¡_qp_num
 = 
comm
->
hÿ_cİy_qp
->
qp_num
;

72 
©Œ
.
rq_p¢
 = 0;

73 
©Œ
.
max_de¡_rd_©omic
 = 1;

74 
©Œ
.
mš_ºr_tim”
 = 12;

75 
©Œ
.
ah_©Œ
.
is_glob®
 = 0;

76 
©Œ
.
ah_©Œ
.
dlid
 = 
comm
->
ùx
->
pÜt_lid
;

77 
©Œ
.
ah_©Œ
.
¦
 = 0;

78 
©Œ
.
ah_©Œ
.
¤c_·th_b™s
 = 0;

79 
©Œ
.
ah_©Œ
.
pÜt_num
 = 
comm
->
ùx
->
ib_pÜt
;

81 ià(
	`ibv_modify_qp
(
comm
->
hÿ_cİy_qp
, &
©Œ
,

82 
IBV_QP_STATE
 | 
IBV_QP_AV
 | 
IBV_QP_PATH_MTU
 | 
IBV_QP_DEST_QPN
 |

83 
IBV_QP_RQ_PSN
 | 
IBV_QP_MAX_DEST_RD_ATOMIC
 | 
IBV_QP_MIN_RNR_TIMER
)) {

84 
	`_”rÜ
(
comm
->
lib
, "failedo move HCA copy QPo RTR");

85 
	`ibv_de¡roy_qp
(
comm
->
hÿ_cİy_qp
);

86 
	`ibv_de¡roy_cq
(
comm
->
hÿ_cİy_cq
);

87 
comm
->
hÿ_cİy_qp
 = 
NULL
;

88 
comm
->
hÿ_cİy_cq
 = 
NULL
;

89  
UCC_ERR_NO_RESOURCE
;

93 
	`mem£t
(&
©Œ
, 0, (attr));

94 
©Œ
.
qp_¡©e
 = 
IBV_QPS_RTS
;

95 
©Œ
.
sq_p¢
 = 0;

96 
©Œ
.
timeout
 = 14;

97 
©Œ
.
»Œy_út
 = 7;

98 
©Œ
.
ºr_»Œy
 = 7;

99 
©Œ
.
max_rd_©omic
 = 1;

101 ià(
	`ibv_modify_qp
(
comm
->
hÿ_cİy_qp
, &
©Œ
,

102 
IBV_QP_STATE
 | 
IBV_QP_SQ_PSN
 | 
IBV_QP_TIMEOUT
 |

103 
IBV_QP_RETRY_CNT
 | 
IBV_QP_RNR_RETRY
 | 
IBV_QP_MAX_QP_RD_ATOMIC
)) {

104 
	`_”rÜ
(
comm
->
lib
, "failedo move HCA copy QPo RTS");

105 
	`ibv_de¡roy_qp
(
comm
->
hÿ_cİy_qp
);

106 
	`ibv_de¡roy_cq
(
comm
->
hÿ_cİy_cq
);

107 
comm
->
hÿ_cİy_qp
 = 
NULL
;

108 
comm
->
hÿ_cİy_cq
 = 
NULL
;

109  
UCC_ERR_NO_RESOURCE
;

112 
	`_Œaû
(
comm
->
lib
, "HCA copy QP„eady for†oopback RDMA operations");

115  
UCC_OK
;

116 
	}
}

119 
	$ucc__mlx5_mÿ¡_hÿ_cİy_com¶‘iÚ
(
ibv_wc
 *
wc
, *
¬g
)

121 
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 *
sk
 = (ucc__mlx5_mÿ¡_hÿ_cİy_sk_ˆ*)
¬g
;

123 ià(
wc
->
¡©us
 !ğ
IBV_WC_SUCCESS
) {

124 
sk
->
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

126 
sk
->
¡©us
 = 
UCC_OK
;

129 
sk
->
com¶‘ed
 = 1;

130 
	}
}

134 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_hÿ_cİy_po¡
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

135 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

136 
size_t
 
size
,

137 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

138 
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 **
cİy_sk
)

140 
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 *
sk
;

141 
ibv_£nd_wr
 *
bad_wr
;

142 
»t
;

143 
ucc_¡©us_t
 
¡©us
;

145 ià(!
comm
->
Úe_sided
.
hÿ_cİy_’abËd
) {

146  
UCC_ERR_NOT_SUPPORTED
;

150 ià(
¤c_mty³
 !ğ
UCC_MEMORY_TYPE_CUDA
 && 
d¡_mty³
 != UCC_MEMORY_TYPE_CUDA) {

151  
UCC_ERR_NOT_SUPPORTED
;

155 
¡©us
 = 
	`ucc__mlx5_mÿ¡_hÿ_cİy_£tup_»sourûs
(
comm
);

156 ià(
¡©us
 !ğ
UCC_OK
) {

157  
¡©us
;

160 
sk
 = 
	`ucc_m®loc
((*task), "hca_copy_task");

161 ià(!
sk
) {

162  
UCC_ERR_NO_MEMORY
;

165 
sk
->
d¡
 = dst;

166 
sk
->
¤c
 = src;

167 
sk
->
size
 = size;

168 
sk
->
d¡_mty³
 = dst_mtype;

169 
sk
->
¤c_mty³
 = src_mtype;

170 
sk
->
comm
 = comm;

171 
sk
->
rg‘_¿nk
 = 
comm
->
¿nk
;

172 
sk
->
com¶‘ed
 = 0;

173 
sk
->
¡©us
 = 
UCC_OK
;

174 
sk
->
¤c_»g
 = 
NULL
;

175 
sk
->
d¡_»g
 = 
NULL
;

178 
¡©us
 = 
	`ucc__mlx5_mÿ¡_mem_»gi¡”
(
comm
->
ùx
, 
¤c
, 
size
, &
sk
->
¤c_»g
);

179 ià(
¡©us
 !ğ
UCC_OK
) {

180 
	`_”rÜ
(
comm
->
lib
,

182 
	`ucc_ä“
(
sk
);

183  
¡©us
;

186 
¡©us
 = 
	`ucc__mlx5_mÿ¡_mem_»gi¡”
(
comm
->
ùx
, 
d¡
, 
size
, &
sk
->
d¡_»g
);

187 ià(
¡©us
 !ğ
UCC_OK
) {

188 
	`_”rÜ
(
comm
->
lib
,

190 
	`ucc__mlx5_mÿ¡_mem_d”egi¡”
(
comm
->
ùx
, 
sk
->
¤c_»g
);

191 
	`ucc_ä“
(
sk
);

192  
¡©us
;

196 
sk
->
rdma_sge
.
addr
 = (
ušŒ_t
)
¤c
;

197 
sk
->
rdma_sge
.
Ëngth
 = 
size
;

198 
sk
->
rdma_sge
.
lkey
 = ((
ibv_mr
*éask->
¤c_»g
->
mr
)->lkey;

200 
sk
->
rdma_wr
.
wr_id
 = (
ušŒ_t
)task;

201 
sk
->
rdma_wr
.
sg_li¡
 = &sk->
rdma_sge
;

202 
sk
->
rdma_wr
.
num_sge
 = 1;

203 
sk
->
rdma_wr
.
İcode
 = 
IBV_WR_RDMA_WRITE
;

204 
sk
->
rdma_wr
.
£nd_æags
 = 
IBV_SEND_SIGNALED
;

205 
sk
->
rdma_wr
.
Ãxt
 = 
NULL
;

208 
sk
->
rdma_wr
.
wr
.
rdma
.
»mÙe_addr
 = (
ušŒ_t
)
d¡
;

210 
sk
->
rdma_wr
.
wr
.
rdma
.
rkey
 = ((
ibv_mr
*éask->
d¡_»g
->
mr
)->
lkey
;

213 
»t
 = 
	`ibv_po¡_£nd
(
comm
->
hÿ_cİy_qp
, &
sk
->
rdma_wr
, &
bad_wr
);

214 ià(
»t
) {

215 
	`_”rÜ
(
comm
->
lib
, "çedØpo¡ HCA cİy RDMA wr™e,ƒ¼nØ%d", 
»t
);

216 
	`ucc__mlx5_mÿ¡_mem_d”egi¡”
(
comm
->
ùx
, 
sk
->
¤c_»g
);

217 
	`ucc__mlx5_mÿ¡_mem_d”egi¡”
(
comm
->
ùx
, 
sk
->
d¡_»g
);

218 
	`ucc_ä“
(
sk
);

219  
UCC_ERR_NO_RESOURCE
;

222 *
cİy_sk
 = 
sk
;

223 
	`_Œaû
(
comm
->
lib
,

225 
¤c
, 
d¡
, 
size
);

226  
UCC_OK
;

227 
	}
}

230 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_hÿ_cİy_‹¡
(
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 *
cİy_sk
)

232 
ibv_wc
 
wc
;

233 
Ã
;

235 ià(!
cİy_sk
) {

236  
UCC_ERR_INVALID_PARAM
;

240 ià(
cİy_sk
->
com¶‘ed
) {

241  
cİy_sk
->
¡©us
;

245 
Ã
 = 
	`ibv_pŞl_cq
(
cİy_sk
->
comm
->
hÿ_cİy_cq
, 1, &
wc
);

246 ià(
Ã
 < 0) {

247 
	`_”rÜ
(
cİy_sk
->
comm
->
lib
, "failedo…oll HCA copy CQ");

248  
UCC_ERR_NO_MESSAGE
;

251 ià(
Ã
 > 0 && 
wc
.
wr_id
 =ğ(
ušŒ_t
)
cİy_sk
) {

252 
	`ucc__mlx5_mÿ¡_hÿ_cİy_com¶‘iÚ
(&
wc
, 
cİy_sk
);

256 ià(
cİy_sk
->
com¶‘ed
) {

257 ià(
cİy_sk
->
¡©us
 =ğ
UCC_OK
) {

258 
	`_Œaû
(
cİy_sk
->
comm
->
lib
, "HCA copy RDMA write completed successfully");

260 
	`_Œaû
(
cİy_sk
->
comm
->
lib
, "HCA copy RDMA write completed withƒrror");

262  
cİy_sk
->
¡©us
;

265  
UCC_INPROGRESS
;

266 
	}
}

269 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_hÿ_cİy_fš®ize
(
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 *
cİy_sk
)

271 ià(!
cİy_sk
) {

272  
UCC_ERR_INVALID_PARAM
;

276 ià(
cİy_sk
->
¤c_»g
) {

277 
	`ucc__mlx5_mÿ¡_mem_d”egi¡”
(
cİy_sk
->
comm
->
ùx
, cİy_sk->
¤c_»g
);

279 ià(
cİy_sk
->
d¡_»g
) {

280 
	`ucc__mlx5_mÿ¡_mem_d”egi¡”
(
cİy_sk
->
comm
->
ùx
, cİy_sk->
d¡_»g
);

284 
	`ucc_ä“
(
cİy_sk
);

286  
UCC_OK
;

287 
	}
}

290 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_memıy
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

291 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

292 
size_t
 
size
,

293 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

295 
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 *
cİy_sk
;

296 
ucc_¡©us_t
 
¡©us
;

299 ià(
comm
->
Úe_sided
.
hÿ_cİy_’abËd
 &&

300 (
¤c_mty³
 =ğ
UCC_MEMORY_TYPE_CUDA
 || 
d¡_mty³
 == UCC_MEMORY_TYPE_CUDA)) {

302 
	`_Œaû
(
comm
->
lib
,

304 
¤c_mty³
 =ğ
UCC_MEMORY_TYPE_CUDA
 ? "CUDA" : "HOST",

305 
d¡_mty³
 =ğ
UCC_MEMORY_TYPE_CUDA
 ? "CUDA" : "HOST");

308 
¡©us
 = 
	`ucc__mlx5_mÿ¡_hÿ_cİy_po¡
(
d¡
, 
d¡_mty³
, 
¤c
, 
¤c_mty³
, 
size
, 
comm
, &
cİy_sk
);

309 ià(
¡©us
 !ğ
UCC_OK
) {

310 
	`_w¬n
(
comm
->
lib
, "HCA copy…ost failed, falling backo mc copy");

311  
	`ucc_mc_memıy
(
d¡
, 
¤c
, 
size
, 
d¡_mty³
, 
¤c_mty³
);

315 (
¡©us
 = 
	`ucc__mlx5_mÿ¡_hÿ_cİy_‹¡
(
cİy_sk
)è=ğ
UCC_INPROGRESS
) {

320 
	`ucc__mlx5_mÿ¡_hÿ_cİy_fš®ize
(
cİy_sk
);

322 ià(
¡©us
 =ğ
UCC_OK
) {

323 
	`_Œaû
(
comm
->
lib
, "HCA copy completed successfully");

324  
UCC_OK
;

326 
	`_w¬n
(
comm
->
lib
, "HCA copy failed, falling backo mc copy");

327  
	`ucc_mc_memıy
(
d¡
, 
¤c
, 
size
, 
d¡_mty³
, 
¤c_mty³
);

332  
	`ucc_mc_memıy
(
d¡
, 
¤c
, 
size
, 
d¡_mty³
, 
¤c_mty³
);

334 
	}
}

336 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_memıy_nb
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

337 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

338 
size_t
 
size
,

339 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

340 
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 **
cİy_sk
)

343 ià(
comm
->
Úe_sided
.
hÿ_cİy_’abËd
 &&

344 (
¤c_mty³
 =ğ
UCC_MEMORY_TYPE_CUDA
 || 
d¡_mty³
 == UCC_MEMORY_TYPE_CUDA)) {

346  
	`ucc__mlx5_mÿ¡_hÿ_cİy_po¡
(
d¡
, 
d¡_mty³
, 
¤c
, 
¤c_mty³
,

347 
size
, 
comm
, 
cİy_sk
);

351 
ucc_¡©us_t
 
¡©us
 = 
	`ucc_mc_memıy
(
d¡
, 
¤c
, 
size
, 
d¡_mty³
, 
¤c_mty³
);

352 *
cİy_sk
 = 
NULL
;

353  
¡©us
;

354 
	}
}

356 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_memıy_‹¡
(
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 *
cİy_sk
)

358 
ucc_¡©us_t
 
¡©us
;

360 ià(
cİy_sk
 =ğ
NULL
) {

362  
UCC_OK
;

366 
¡©us
 = 
	`ucc__mlx5_mÿ¡_hÿ_cİy_‹¡
(
cİy_sk
);

367 ià(
¡©us
 !ğ
UCC_INPROGRESS
) {

369 
	`ucc__mlx5_mÿ¡_hÿ_cİy_fš®ize
(
cİy_sk
);

371  
¡©us
;

372 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_hca_copy.h

7 #iâdeà
UCC_TL_MLX5_MCAST_HCA_COPY_H_


8 
	#UCC_TL_MLX5_MCAST_HCA_COPY_H_


	)

10 
	~"_mlx5_mÿ¡.h
"

12 
	succ__mlx5_mÿ¡_hÿ_cİy_sk
 {

13 *
	md¡
;

14 *
	m¤c
;

15 
size_t
 
	msize
;

16 
ucc_memÜy_ty³_t
 
	md¡_mty³
;

17 
ucc_memÜy_ty³_t
 
	m¤c_mty³
;

18 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
	mcomm
;

21 
ucc__mlx5_mÿ¡_»g_t
 *
	m¤c_»g
;

22 
ucc__mlx5_mÿ¡_»g_t
 *
	md¡_»g
;

23 
ibv_£nd_wr
 
	mrdma_wr
;

24 
ibv_sge
 
	mrdma_sge
;

25 vŞ©
	mcom¶‘ed
;

26 
ucc_¡©us_t
 
	m¡©us
;

27 
ucc_¿nk_t
 
	mrg‘_¿nk
;

28 } 
	tucc__mlx5_mÿ¡_hÿ_cİy_sk_t
;

31 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_hÿ_cİy_po¡
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

32 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

33 
size_t
 
size
,

34 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

35 
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 **
cİy_sk
);

37 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_hÿ_cİy_‹¡
(
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 *
cİy_sk
);

39 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_hÿ_cİy_fš®ize
(
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 *
cİy_sk
);

42 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_memıy
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

43 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

44 
size_t
 
size
,

45 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

47 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_memıy_nb
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

48 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

49 
size_t
 
size
,

50 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

51 
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 **
cİy_sk
);

53 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_memıy_‹¡
(
ucc__mlx5_mÿ¡_hÿ_cİy_sk_t
 *
cİy_sk
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_helper.c

7 
	~"_mlx5_mÿ¡_h–³r.h
"

8 
	~<glob.h
>

9 
	~<Ãt/if.h
>

10 
	~<içddrs.h
>

11 
	~"_mlx5_mÿ¡_Úe_sided_»lŸb™y.h
"

13 
	#PREF
 "/sys/şass/Ãt/"

	)

14 
	#SUFF
 "/deviû/»sourû"

	)

15 
	#MAX_STR_LEN
 128

	)

17 
ucc_¡©us_t
 
	$ucc__mlx5_g‘_oib_
(*
iâame
, 
sockaddr_¡Üage
 *
addr
)

19 
ucc_¡©us_t
 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

20 
içddrs
 *
içddr
 = 
NULL
;

21 
içddrs
 *
iç
 = 
NULL
;

22 
is_v4
 = 0;

23 
çmy
;

24 
n
;

25 
is_up
;

27 ià(
	`g‘içddrs
(&
içddr
) == -1) {

28  
UCC_ERR_NO_RESOURCE
;

31 
iç
 = 
içddr
, 
n
 = 0; iç !ğ
NULL
; iç=iç->
iç_Ãxt
,‚++) {

32 ià(
iç
->
iç_addr
 =ğ
NULL
) {

36 
çmy
 = 
iç
->
iç_addr
->
§_çmy
;

37 ià(
çmy
 !ğ
AF_INET
 && famy !ğ
AF_INET6
) {

41 
is_up
 = (
iç
->
iç_æags
 & 
IFF_UP
) == IFF_UP;

42 
is_v4
 = (
çmy
 =ğ
AF_INET
) ? 1 : 0;

44 ià(
is_up
 && !
	`¡ºcmp
(
iç
->
iç_Çme
, 
iâame
, 
	`¡¾’
(ifname)) ) {

45 ià(
is_v4
) {

46 
	`memıy
((
sockaddr_š
 *è
addr
,

47 (
sockaddr_š
 *è
iç
->
iç_addr
,

48 (
sockaddr_š
));

50 
	`memıy
((
sockaddr_š6
 *è
addr
,

51 (
sockaddr_š6
 *è
iç
->
iç_addr
,

52 (
sockaddr_š6
));

55 
¡©us
 = 
UCC_OK
;

60 
	`ä“içddrs
(
içddr
);

61  
¡©us
;

62 
	}
}

64 
	$cmp_fes
(*
f1
, *
f2
)

66 
ªsw”
 = 0;

67 
FILE
 *
å1
;

68 
FILE
 *
å2
;

69 
ch1
;

70 
ch2
;

72 ià((
å1
 = 
	`fİ’
(
f1
, "r")è=ğ
NULL
) {

73 
out
;

74 } ià((
å2
 = 
	`fİ’
(
f2
, "r")è=ğ
NULL
) {

75 
şo£
;

79 
ch1
 = 
	`g‘c
(
å1
);

80 
ch2
 = 
	`g‘c
(
å2
);

81 } (
ch1
 !ğ
EOF
è&& (
ch2
 != EOF) && (ch1 == ch2));

84 ià(
ch1
 =ğ
ch2
) {

85 
ªsw”
 = 1;

88 ià(
	`fşo£
(
å2
) != 0) {

89 
	`fşo£
(
å1
);

92 
şo£
:

93 ià(
	`fşo£
(
å1
) != 0) {

96 
out
:

97  
ªsw”
;

98 
	}
}

100 
	$pÜt_äom_fe
(*
pÜt_fe
)

102 
»s
 = -1;

103 
buf1
[
MAX_STR_LEN
];

104 
buf2
[
MAX_STR_LEN
];

105 
FILE
 *
å
;

106 
Ën
;

108 ià((
å
 = 
	`fİ’
(
pÜt_fe
, "r")è=ğ
NULL
) {

112 ià(
	`fg‘s
(
buf1
, 
MAX_STR_LEN
 - 1, 
å
è=ğ
NULL
) {

113 
out
;

116 
Ën
 = 
	`¡¾’
(
buf1
) - 2;

117 
	`¡ºıy
(
buf2
, 
buf1
 + 2, 
Ën
);

118 
buf2
[
Ën
] = 0;

119 
»s
 = 
	`©oi
(
buf2
);

121 
out
:

122 ià(
	`fşo£
(
å
) != 0) {

125  
»s
;

126 
	}
}

128 
ucc_¡©us_t
 
	$dev2if
(*
dev_Çme
, *
pÜt
, 
sockaddr_¡Üage


129 *
rdma_¤c_addr
)

131 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

132 
glob_t
 
glob_–
 = {0,};

133 
dev_fe
 [
MAX_STR_LEN
];

134 
pÜt_fe
[
MAX_STR_LEN
];

135 
Ãt_fe
 [
MAX_STR_LEN
];

136 
if_Çme
 [
MAX_STR_LEN
];

137 
glob_·th
[
MAX_STR_LEN
];

138 
i
;

139 **
p
;

140 
Ën
;

142 
	`¥rštf
(
glob_·th
, 
PREF
"*");

144 
	`¥rštf
(
dev_fe
, "/sys/şass/šfšibªd/%s"
SUFF
, 
dev_Çme
);

145 ià(
	`glob
(
glob_·th
, 0, 0, &
glob_–
)) {

146  
UCC_ERR_NO_RESOURCE
;

148 
p
 = 
glob_–
.
gl_·thv
;

150 ià(
glob_–
.
gl_·thc
 >= 1) {

151 
i
 = 0; i < 
glob_–
.
gl_·thc
; i++, 
p
++) {

152 
	`¥rštf
(
pÜt_fe
, "%s/dev_id", *
p
);

153 
	`¥rštf
(
Ãt_fe
, "%s"
SUFF
, *
p
);

154 if(
	`cmp_fes
(
Ãt_fe
, 
dev_fe
è&& 
pÜt
 !ğ
NULL
 &&

155 
	`pÜt_äom_fe
(
pÜt_fe
è=ğ
	`©oi
(
pÜt
) - 1) {

156 
Ën
 = 
	`¡¾’
(
Ãt_fe
è- sŒËn(
PREF
è- sŒËn(
SUFF
);

157 
	`¡ºıy
(
if_Çme
, 
Ãt_fe
 + 
	`¡¾’
(
PREF
), 
Ën
);

158 
if_Çme
[
Ën
] = 0;

160 
¡©us
 = 
	`ucc__mlx5_g‘_oib_
(
if_Çme
, 
rdma_¤c_addr
);

161 ià(
UCC_OK
 =ğ
¡©us
) {

168 
	`globä“
(&
glob_–
);

169  
¡©us
;

170 
	}
}

172 
ucc_¡©us_t
 
	$ucc__mlx5_´obe__ov”_ib
(* 
ib_dev
, 

173 
sockaddr_¡Üage
 *
addr
)

175 *
ib_Çme
 = 
NULL
;

176 *
pÜt
 = 
NULL
;

177 *
ib
 = 
NULL
;

178 
ucc_¡©us_t
 
¡©us
;

179 
sockaddr_¡Üage
 
rdma_¤c_addr
;

181 ià(
ib_dev
 =ğ
NULL
) {

182  
UCC_ERR_NO_RESOURCE
;

185 
ib
 = 
	`¡rdup
(
ib_dev
);

186 ià(!
ib
) {

187  
UCC_ERR_NO_MEMORY
;

190 
	`ucc_¡ršg_¥l™
(
ib
, ":", 2, &
ib_Çme
, &
pÜt
);

191 
¡©us
 = 
	`dev2if
(
ib_Çme
, 
pÜt
, &
rdma_¤c_addr
);

193 ià(
UCC_OK
 =ğ
¡©us
) {

194 *
addr
 = 
rdma_¤c_addr
;

196 
	`ucc_ä“
(
ib
);

198  
¡©us
;

199 
	}
}

201 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_još_mÿ¡_po¡
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

202 
sockaddr_š6
 *
Ãt_addr
,

203 
mÿ¡_group
 *
group
,

204 
is_roÙ
)

206 
buf
[
INET6_ADDRSTRLEN
];

207 cÚ¡ *
d¡
;

209 
d¡
 = 
	`š‘_Áİ
(
AF_INET6
, 
Ãt_addr
, 
buf
, 
INET6_ADDRSTRLEN
);

210 ià(
NULL
 =ğ
d¡
) {

211 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_WARN
, "inet_ntop failed");

212  
UCC_ERR_NO_RESOURCE
;

215 
	`_debug
(
ùx
->
lib
, "joššg‡ddr: % is_roÙ %d grou°%p", 
buf
, 
is_roÙ
, 
group
);

217 ià(
	`rdma_još_muÉiÿ¡
(
ùx
->
id
, (
sockaddr
*)
Ãt_addr
, (*)
group
)) {

218 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_WARN
,

219 "rdma_još_muÉiÿ¡ faedƒ¼nØ%d", 
”ºo
);

220  
UCC_ERR_NO_RESOURCE
;

223  
UCC_OK
;

224 
	}
}

226 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_još_mÿ¡_g‘_ev’t
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

227 
rdma_cm_ev’t
 **
ev’t
)

229 
buf
[
INET6_ADDRSTRLEN
];

230 cÚ¡ *
d¡
;

232 ià(
	`rdma_g‘_cm_ev’t
(
ùx
->
chªÃl
, 
ev’t
) < 0) {

233 ià(
EINTR
 !ğ
”ºo
) {

234 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_WARN
,

236 
”ºo
, 
	`¡»¼Ü
(errno));

237  
UCC_ERR_NO_RESOURCE
;

240  
UCC_INPROGRESS
;

244 ià(
RDMA_CM_EVENT_MULTICAST_JOIN
 !ğ(*
ev’t
)->event) {

245 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_WARN
,

248 (*
ev’t
)->ev’t, 
	`rdma_ev’t_¡r
((*event)->event),

249 (*
ev’t
)->
¡©us
);

250 ià(
	`rdma_ack_cm_ev’t
(*
ev’t
) < 0) {

251 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_WARN
,

254  
UCC_ERR_NO_RESOURCE
;

257 
d¡
 = 
	`š‘_Áİ
(
AF_INET6
, (*
ev’t
)->
·¿m
.
ud
.
ah_©Œ
.
grh
.
dgid
.
¿w
, 
buf
, 
INET6_ADDRSTRLEN
);

258 ià(
NULL
 =ğ
d¡
) {

259 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_WARN
, "inet_ntop failed");

260  
UCC_ERR_NO_RESOURCE
;

263 
	`_debug
(
ùx
->
lib
, "jošed dgid: %s, mlid 0x%x, sÈ%d", 
buf
,

264 (*
ev’t
)->
·¿m
.
ud
.
ah_©Œ
.
dlid
, (*ev’t)->·¿m.ud.ah_©Œ.
¦
);

266  
UCC_OK
;

268 
	}
}

270 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_š™_qps
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

271 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

273 
max_šlše
 = 
INT_MAX
;

274 
ibv_qp_š™_©Œ
 
qp_š™_©Œ
 = {0};

275 
i
;

276 
j
;

278 
qp_š™_©Œ
.
qp_ty³
 = 
IBV_QPT_UD
;

279 
qp_š™_©Œ
.
£nd_cq
 = 
comm
->
mÿ¡
.
scq
;

280 
qp_š™_©Œ
.
»cv_cq
 = 
comm
->
mÿ¡
.
rcq
;

281 
qp_š™_©Œ
.
sq_sig_®l
 = 0;

282 
qp_š™_©Œ
.
ÿp
.
max_£nd_wr
 = 
comm
->
·¿ms
.
sx_d•th
;

283 
qp_š™_©Œ
.
ÿp
.
max_»cv_wr
 = 
comm
->
·¿ms
.
rx_d•th
;

284 
qp_š™_©Œ
.
ÿp
.
max_šlše_d©a
 = 
comm
->
·¿ms
.
sx_šlše
;

285 
qp_š™_©Œ
.
ÿp
.
max_£nd_sge
 = 
comm
->
·¿ms
.
sx_sge
;

286 
qp_š™_©Œ
.
ÿp
.
max_»cv_sge
 = 
comm
->
·¿ms
.
rx_sge
;

288 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i++) {

289 
	`ucc_li¡_h—d_š™
(&
comm
->
Úe_sided
.
po¡ed_»cv
[
i
].
po¡ed_»cv_bufs
);

290 
comm
->
mÿ¡
.
groups
[
i
].
qp
 = 
	`ibv_ü—‹_qp
(
ùx
->
pd
, &
qp_š™_©Œ
);

291 ià(!
comm
->
mÿ¡
.
groups
[
i
].
qp
) {

292 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

293 "FaedØü—‹ mÿ¡ UD q°šdex %d,ƒ¼nØ%d", 
i
, 
”ºo
);

294 
”rÜ
;

296 ià(
qp_š™_©Œ
.
ÿp
.
max_šlše_d©a
 < 
max_šlše
) {

297 
max_šlše
 = 
qp_š™_©Œ
.
ÿp
.
max_šlše_d©a
;

301 ià(
comm
->
cuda_mem_’abËd
) {

303 
comm
->
max_šlše
 = 0;

305 
comm
->
max_šlše
 = max_inline;

308  
UCC_OK
;

310 
”rÜ
:

311 
j
 = 0; j < 
i
; j++) {

312 
	`ibv_de¡roy_qp
(
comm
->
mÿ¡
.
groups
[
j
].
qp
);

313 
comm
->
mÿ¡
.
groups
[
j
].
qp
 = 
NULL
;

315  
UCC_ERR_NO_RESOURCE
;

316 
	}
}

318 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_ü—‹_ah
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

320 
i
, 
j
, 
»t
;

321 
ibv_ah_©Œ
 
ah_©Œ
 = {

322 .
is_glob®
 = 1,

323 .
grh
 = {.
sgid_šdex
 = 0},

324 .
¦
 = 
DEF_SL
,

325 .
¤c_·th_b™s
 = 
DEF_SRC_PATH_BITS
,

326 .
pÜt_num
 = 
comm
->
ùx
->
ib_pÜt


329 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i ++) {

330 
ah_©Œ
.
dlid
 = 
comm
->
mÿ¡
.
groups
[
i
].
lid
;

331 
	`memıy
(
ah_©Œ
.
grh
.
dgid
.
¿w
, &
comm
->
mÿ¡
.
groups
[
i
].
mgid
, (ah_attr.grh.dgid.raw));

333 
comm
->
mÿ¡
.
groups
[
i
].
ah
 = 
	`ibv_ü—‹_ah
(comm->
ùx
->
pd
, &
ah_©Œ
);

334 ià(!
comm
->
mÿ¡
.
groups
[
i
].
ah
) {

335 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

336 "çedØü—‹ AH index %d", 
i
);

337 
”rÜ
;

341  
UCC_OK
;

343 
”rÜ
:

344 
j
 = 0; j < 
i
; j++) {

345 
»t
 = 
	`ibv_de¡roy_ah
(
comm
->
mÿ¡
.
groups
[
j
].
ah
);

346 ià(
»t
) {

347 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

349  
UCC_ERR_NO_RESOURCE
;

351 
comm
->
mÿ¡
.
groups
[
j
].
ah
 = 
NULL
;

353  
UCC_ERR_NO_RESOURCE
;

354 
	}
}

356 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£tup_qps
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

357 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

359 
ibv_pÜt_©Œ
 
pÜt_©Œ
;

360 
ibv_qp_©Œ
 
©Œ
;

361 
ušt16_t
 
pkey
;

362 
i
;

363 
»Œy_couÁ
;

364 cÚ¡ 
max_»Œ›s
 = 5;

365 cÚ¡ 
ba£_d–ay_us
 = 5000;

366 
©ch_»suÉ
;

367 
©ched_groups
 = 0;

369 
	`ibv_qu”y_pÜt
(
ùx
->ùx, ctx->
ib_pÜt
, &
pÜt_©Œ
);

370 
ùx
->
pkey_šdex
 = 0; ctx->pkey_šdex < 
pÜt_©Œ
.
pkey_tbl_Ën
;

371 ++
ùx
->
pkey_šdex
) {

372 
	`ibv_qu”y_pkey
(
ùx
->ùx, ctx->
ib_pÜt
, ctx->
pkey_šdex
, &
pkey
);

373 ià(
pkey
 =ğ
DEF_PKEY
)

376 ià(
ùx
->
pkey_šdex
 >ğ
pÜt_©Œ
.
pkey_tbl_Ën
) {

377 
ùx
->
pkey_šdex
 = 0;

378 
	`ibv_qu”y_pkey
(
ùx
->ùx, ctx->
ib_pÜt
, ctx->
pkey_šdex
, &
pkey
);

379 ià(!
pkey
) {

380 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_WARN
,

382  
UCC_ERR_NO_RESOURCE
;

385 
	`_debug
(
ùx
->
lib
, "cannot find default…key 0x%04x on…ort %d, using "

386 "šdex 0…key:0x%04x", 
DEF_PKEY
, 
ùx
->
ib_pÜt
, 
pkey
);

389 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i++) {

390 
©Œ
.
qp_¡©e
 = 
IBV_QPS_INIT
;

391 
©Œ
.
pkey_šdex
 = 
ùx
->pkey_index;

392 
©Œ
.
pÜt_num
 = 
ùx
->
ib_pÜt
;

393 
©Œ
.
qkey
 = 
DEF_QKEY
;

395 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
groups
[
i
].
qp
, &
©Œ
,

396 
IBV_QP_STATE
 | 
IBV_QP_PKEY_INDEX
 | 
IBV_QP_PORT
 | 
IBV_QP_QKEY
)) {

397 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

398 "çedØmovmÿ¡ q°tØINIT,ƒ¼nØ%d", 
”ºo
);

399 
”rÜ
;

403 
»Œy_couÁ
 = 0;

404 
©ch_»suÉ
 = -1;

406 
»Œy_couÁ
 < 
max_»Œ›s
) {

407 
©ch_»suÉ
 = 
	`ibv_©ch_mÿ¡
(
comm
->
mÿ¡
.
groups
[
i
].
qp
, &comm->mÿ¡.groups[i].
mgid
,

408 
comm
->
mÿ¡
.
groups
[
i
].
lid
);

409 ià(
©ch_»suÉ
 == 0) {

413 
»Œy_couÁ
++;

414 ià(
»Œy_couÁ
 < 
max_»Œ›s
) {

416 
¿ndom_j™‹r
 = 
	`¿nd
() % 1000;

417 
d–ay
 = 
ba£_d–ay_us
 * 
»Œy_couÁ
 + 
¿ndom_j™‹r
;

418 
	`u¦“p
(
d–ay
);

419 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_DEBUG
,

421 
i
, 
»Œy_couÁ
 + 1, 
max_»Œ›s
, 
”ºo
, 
d–ay
);

425 ià(
©ch_»suÉ
 != 0) {

426 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

428 
comm
->
mÿ¡
.
groups
[
i
].
lid
, 
max_»Œ›s
, 
”ºo
);

429 
”rÜ
;

432 
©ched_groups
++;

434 ià(
»Œy_couÁ
 > 0) {

435 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_DEBUG
,

437 
i
, 
»Œy_couÁ
);

440 
©Œ
.
qp_¡©e
 = 
IBV_QPS_RTR
;

441 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
groups
[
i
].
qp
, &
©Œ
, 
IBV_QP_STATE
)) {

442 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

443 "çedØmodify QPØRTR,ƒ¼nØ%d", 
”ºo
);

444 
”rÜ
;

447 
©Œ
.
qp_¡©e
 = 
IBV_QPS_RTS
;

448 
©Œ
.
sq_p¢
 = 
DEF_PSN
;

449 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
groups
[
i
].
qp
, &
©Œ
, 
IBV_QP_STATE
 | 
IBV_QP_SQ_PSN
)) {

450 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

451 "çedØmodify QPØRTS,ƒ¼nØ%d", 
”ºo
);

452 
”rÜ
;

455 
	`_debug
(
ùx
->
lib
, "modif›d UD QPØRTS‡nd RTR fÜ mÿ¡ grou°id %d", 
i
);

459 ià(
UCC_OK
 !ğ
	`ucc__mlx5_mÿ¡_ü—‹_ah
(
comm
)) {

460 
	`_w¬n
(
ùx
->
lib
, "failedo create‡dress handle");

461 
”rÜ
;

464  
UCC_OK
;

466 
”rÜ
:

468 
i
 = 0; i < 
©ched_groups
; i++) {

469 ià(
	`ibv_d‘ach_mÿ¡
(
comm
->
mÿ¡
.
groups
[
i
].
qp
, &comm->mÿ¡.groups[i].
mgid
,

470 
comm
->
mÿ¡
.
groups
[
i
].
lid
)) {

471 
	`_w¬n
(
ùx
->
lib
, "çedØd‘ach QP from mÿ¡ grou°%d duršg cËªup", 
i
);

475 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i++) {

476 
	`ibv_de¡roy_qp
(
comm
->
mÿ¡
.
groups
[
i
].
qp
);

477 
comm
->
mÿ¡
.
groups
[
i
].
qp
 = 
NULL
;

479  
UCC_ERR_NO_RESOURCE
;

480 
	}
}

482 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_ü—‹_rc_qps
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

483 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

485 
i
 = 0, 
j
 = 0;

486 
ibv_¤q_š™_©Œ
 
¤q_š™_©Œ
;

487 
ibv_qp_š™_©Œ
 
qp_š™_©Œ
;

490 
	`mem£t
(&
¤q_š™_©Œ
, 0, (srq_init_attr));

491 
¤q_š™_©Œ
.
©Œ
.
max_wr
 = 
comm
->
·¿ms
.
rx_d•th
;

492 
¤q_š™_©Œ
.
©Œ
.
max_sge
 = 2;

494 
comm
->
mÿ¡
.
¤q
 = 
	`ibv_ü—‹_¤q
(
ùx
->
pd
, &
¤q_š™_©Œ
);

495 ià(!
comm
->
mÿ¡
.
¤q
) {

496 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_ERROR
,

498  
UCC_ERR_NO_RESOURCE
;

501 
comm
->
mÿ¡
.
rc_qp
 = 
	`ucc_ÿÎoc
(1, comm->
commsize
 * (
ibv_qp
 *), "ibv_qp*†ist");

502 ià(!
comm
->
mÿ¡
.
rc_qp
) {

503 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_ERROR
,

505 
çed
;

509 
i
 = 0; i < 
comm
->
commsize
; i++) {

510 
	`mem£t
(&
qp_š™_©Œ
, 0, (qp_init_attr));

512 
qp_š™_©Œ
.
¤q
 = 
comm
->
mÿ¡
.srq;

513 
qp_š™_©Œ
.
qp_ty³
 = 
IBV_QPT_RC
;

514 
qp_š™_©Œ
.
£nd_cq
 = 
comm
->
mÿ¡
.
scq
;

515 
qp_š™_©Œ
.
»cv_cq
 = 
comm
->
mÿ¡
.
rcq
;

516 
qp_š™_©Œ
.
sq_sig_®l
 = 0;

517 
qp_š™_©Œ
.
ÿp
.
max_£nd_wr
 = 
comm
->
·¿ms
.
sx_d•th
;

518 
qp_š™_©Œ
.
ÿp
.
max_»cv_wr
 = 0;

519 
qp_š™_©Œ
.
ÿp
.
max_šlše_d©a
 = 0;

520 
qp_š™_©Œ
.
ÿp
.
max_£nd_sge
 = 
comm
->
·¿ms
.
sx_sge
;

521 
qp_š™_©Œ
.
ÿp
.
max_»cv_sge
 = 
comm
->
·¿ms
.
rx_sge
;

523 
comm
->
mÿ¡
.
rc_qp
[
i
] = 
	`ibv_ü—‹_qp
(
ùx
->
pd
, &
qp_š™_©Œ
);

524 ià(!
comm
->
mÿ¡
.
rc_qp
[
i
]) {

525 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_ERROR
,

527 
i
, 
”ºo
);

528 
çed
;

532  
UCC_OK
;

534 
çed
:

535 
j
=0; j<
i
; j++) {

536 ià(
	`ibv_de¡roy_qp
(
comm
->
mÿ¡
.
rc_qp
[
j
])) {

537 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

539  
UCC_ERR_NO_RESOURCE
;

543 ià(
	`ibv_de¡roy_¤q
(
comm
->
mÿ¡
.
¤q
)) {

544 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

546  
UCC_ERR_NO_RESOURCE
;

549 
	`ucc_ä“
(
comm
->
mÿ¡
.
rc_qp
);

551  
UCC_ERR_NO_RESOURCE
;

552 
	}
}

554 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_modify_rc_qps
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

555 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

557 
ucc_¿nk_t
 
my_¿nk
 = 
comm
->
¿nk
;

558 
ibv_qp_©Œ
 
©Œ
;

559 
i
;

561 
i
 = 0; i < 
comm
->
commsize
; i++) {

562 
	`mem£t
(&
©Œ
, 0, (attr));

564 
©Œ
.
qp_¡©e
 = 
IBV_QPS_INIT
;

565 
©Œ
.
pkey_šdex
 = 0;

566 
©Œ
.
pÜt_num
 = 
ùx
->
ib_pÜt
;

567 
©Œ
.
qp_acûss_æags
 = 
IBV_ACCESS_REMOTE_WRITE
 |

568 
IBV_ACCESS_REMOTE_READ
 |

569 
IBV_ACCESS_REMOTE_ATOMIC
;

571 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
rc_qp
[
i
], &
©Œ
,

572 
IBV_QP_STATE
 | 
IBV_QP_PKEY_INDEX
 | 
IBV_QP_PORT
 |

573 
IBV_QP_ACCESS_FLAGS
)) {

574 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_ERROR
,

575 "FaedØmovrøq°tØINIT,ƒ¼nØ%d", 
”ºo
);

576  
UCC_ERR_NO_RESOURCE
;

579 
	`mem£t
(&
©Œ
, 0, (attr));

581 
©Œ
.
qp_¡©e
 = 
IBV_QPS_RTR
;

582 
©Œ
.
·th_mtu
 = 
IBV_MTU_4096
;

583 
©Œ
.
de¡_qp_num
 = 
comm
->
Úe_sided
.
šfo
[
i
].
rc_qp_num
[
my_¿nk
];

584 
©Œ
.
rq_p¢
 = 
DEF_PSN
;

585 
©Œ
.
max_de¡_rd_©omic
 = 16;

586 
©Œ
.
mš_ºr_tim”
 = 12;

587 
©Œ
.
ah_©Œ
.
is_glob®
 = 0;

588 
©Œ
.
ah_©Œ
.
dlid
 = 
comm
->
Úe_sided
.
šfo
[
i
].
pÜt_lid
;

589 
©Œ
.
ah_©Œ
.
¦
 = 
DEF_SL
;

590 
©Œ
.
ah_©Œ
.
¤c_·th_b™s
 = 0;

591 
©Œ
.
ah_©Œ
.
pÜt_num
 = 
ùx
->
ib_pÜt
;

593 
	`_debug
(
comm
->
lib
, "Connectingo„c qpo„ank %d with†id %d qp_num %d…ort_num %d",

594 
i
, 
©Œ
.
ah_©Œ
.
dlid
,‡‰r.
de¡_qp_num
,‡‰r.ah_©Œ.
pÜt_num
);

596 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
rc_qp
[
i
], &
©Œ
,

597 
IBV_QP_STATE
 | 
IBV_QP_AV
 | 
IBV_QP_PATH_MTU
 | 
IBV_QP_DEST_QPN


598 | 
IBV_QP_RQ_PSN
 | 
IBV_QP_MAX_DEST_RD_ATOMIC
 | 
IBV_QP_MIN_RNR_TIMER
)) {

599 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_ERROR
,

601 
i
, 
”ºo
);

602  
UCC_ERR_NO_RESOURCE
;

605 
	`mem£t
(&
©Œ
, 0, (attr));

607 
©Œ
.
qp_¡©e
 = 
IBV_QPS_RTS
;

608 
©Œ
.
sq_p¢
 = 
DEF_PSN
;

609 
©Œ
.
timeout
 = 14;

610 
©Œ
.
»Œy_út
 = 7;

611 
©Œ
.
ºr_»Œy
 = 7;

612 
©Œ
.
max_rd_©omic
 = 1;

613 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
rc_qp
[
i
], &
©Œ
,

614 
IBV_QP_STATE
 | 
IBV_QP_SQ_PSN
 | 
IBV_QP_TIMEOUT
 |

615 
IBV_QP_RETRY_CNT
 | 
IBV_QP_RNR_RETRY
 | 
IBV_QP_MAX_QP_RD_ATOMIC
)) {

616 
	`_mlx5_mÿ¡_log
(
ùx
->
·¿ms
.
mÿ¡_’abËd
, ctx->
lib
, 
UCC_LOG_LEVEL_ERROR
,

618 
i
, 
”ºo
);

619  
UCC_ERR_NO_RESOURCE
;

623  
UCC_OK
;

624 
	}
}

626 
ucc_¡©us_t
 
	$ucc__mlx5_Ëave_mÿ¡_groups
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

627 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

629 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

630 
buf
[
INET6_ADDRSTRLEN
];

631 cÚ¡ *
d¡
;

632 
i
;

634 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i++) {

635 ià(
comm
->
mÿ¡
.
groups
[
i
].
mÿ¡_addr
.
sš6_æowšfo
 != 0) {

636 
d¡
 = 
	`š‘_Áİ
(
AF_INET6
, &
comm
->
mÿ¡
.
groups
[
i
].
mÿ¡_addr
, 
buf
, 
INET6_ADDRSTRLEN
);

637 ià(
NULL
 =ğ
d¡
) {

638 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

639 "š‘_Áİ faed fÜ grou°%d duršg mÿ¡†—vgroup", 
i
);

640 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

644 
	`_debug
(
ùx
->
lib
, "mÿ¡†—ve: ctx %p, comm %p, dgid: % grou°%d", ctx, 
comm
, 
buf
, 
i
);

646 ià(
	`rdma_Ëave_muÉiÿ¡
(
ùx
->
id
, (
sockaddr
*)&
comm
->
mÿ¡
.
groups
[
i
].
mÿ¡_addr
)) {

647 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

648 "mÿ¡„mda_Ëave_muÉiÿ¡ faed fÜ grou°%d", 
i
);

649 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

654  
¡©us
;

655 
	}
}

657 
ucc_¡©us_t
 
	$ucc__mlx5_ş—n_mÿ¡_comm
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

659 
ucc__mlx5_mÿ¡_cÚ‹xt_t
 *
mÿ¡_ùx
 = 
	`ucc_cÚš”_of
(
comm
->
ùx
,

660 
ucc__mlx5_mÿ¡_cÚ‹xt_t
, 
mÿ¡_cÚ‹xt
);

661 
ucc__mlx5_cÚ‹xt_t
 *
mlx5_ùx
 = 
	`ucc_cÚš”_of
(
mÿ¡_ùx
,

662 
ucc__mlx5_cÚ‹xt_t
, 
mÿ¡
);

663 
ucc_cÚ‹xt_h
 
cÚ‹xt
 = 
mlx5_ùx
->
su³r
.su³r.
ucc_cÚ‹xt
;

664 
»t
, 
i
;

665 
ucc_¡©us_t
 
¡©us
;

667 
	`_debug
(
comm
->
lib
, "ş—nšg mÿ¡ comm: %p, id %d", comm, comm->
comm_id
);

669 
UCC_INPROGRESS
 =ğ(
¡©us
 = 
	`ucc__mlx5_mÿ¡_»lŸbË
(
comm
))) {

670 
	`ucc_cÚ‹xt_´og»ss
(
cÚ‹xt
);

673 ià(
UCC_OK
 !ğ
¡©us
) {

674 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

676 
¡©us
);

677  
¡©us
;

680 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i++) {

681 ià(
comm
->
mÿ¡
.
groups
[
i
].
qp
) {

682 
»t
 = 
	`ibv_d‘ach_mÿ¡
(
comm
->
mÿ¡
.
groups
[
i
].
qp
, &(comm->mÿ¡.groups[i].
mgid
), comm->mÿ¡.groups[i].
lid
);

683 ià(
»t
) {

684 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

685 "couldn'ˆd‘ach QP,„‘ %d,ƒ¼nØ%d", 
»t
, 
”ºo
);

686  
UCC_ERR_NO_RESOURCE
;

689 
»t
 = 
	`ibv_de¡roy_qp
(
comm
->
mÿ¡
.
groups
[
i
].
qp
);

690 ià(
»t
) {

691 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

692 "çedØde¡roy QP %d", 
»t
);

693  
UCC_ERR_NO_RESOURCE
;

696 
comm
->
mÿ¡
.
groups
[
i
].
qp
 = 
NULL
;

698 ià(
comm
->
mÿ¡
.
groups
[
i
].
ah
) {

699 
»t
 = 
	`ibv_de¡roy_ah
(
comm
->
mÿ¡
.
groups
[
i
].
ah
);

700 ià(
»t
) {

701 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

703  
UCC_ERR_NO_RESOURCE
;

705 
comm
->
mÿ¡
.
groups
[
i
].
ah
 = 
NULL
;

709 
¡©us
 = 
	`ucc__mlx5_Ëave_mÿ¡_groups
(
comm
->
ùx
, comm);

710 ià(
¡©us
) {

711 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

713  
¡©us
;

716 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

717 
	`ucc__mlx5_mÿ¡_Úe_sided_ş—nup
(
comm
);

720 ià(
comm
->
mÿ¡
.
rcq
) {

721 
»t
 = 
	`ibv_de¡roy_cq
(
comm
->
mÿ¡
.
rcq
);

722 ià(
»t
) {

723 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

725  
UCC_ERR_NO_RESOURCE
;

729 ià(
comm
->
mÿ¡
.
scq
) {

730 
»t
 = 
	`ibv_de¡roy_cq
(
comm
->
mÿ¡
.
scq
);

731 ià(
»t
) {

732 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

734  
UCC_ERR_NO_RESOURCE
;

738 ià(
comm
->
grh_mr
) {

739 
»t
 = 
	`ibv_d”eg_mr
(
comm
->
grh_mr
);

740 ià(
»t
) {

741 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

743  
UCC_ERR_NO_RESOURCE
;

747 ià(
comm
->
grh_buf
) {

748 
	`ucc_ä“
(
comm
->
grh_buf
);

751 ià(
comm
->
µ
) {

752 
	`ucc_ä“
(
comm
->
µ
);

755 ià(
comm
->
µ_mr
) {

756 
»t
 = 
	`ibv_d”eg_mr
(
comm
->
µ_mr
);

757 ià(
»t
) {

758 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

760  
UCC_ERR_NO_RESOURCE
;

764 ià(
comm
->
µ_buf
) {

765 
	`ucc_mc_ä“
(
comm
->
µ_buf_h—d”
);

768 ià(
comm
->
ÿÎ_rwr
) {

769 
	`ucc_ä“
(
comm
->
ÿÎ_rwr
);

772 ià(
comm
->
ÿÎ_rsgs
) {

773 
	`ucc_ä“
(
comm
->
ÿÎ_rsgs
);

776 ià(
comm
->
ùx
->
·¿ms
.
´št_Çck_¡©s
) {

777 
	`_debug
(
comm
->
lib
, "comm_id %d, comm_size %d, comm->psn %d,„ank %d, "

779 
comm
->
comm_id
, comm->
commsize
, comm->
p¢
, comm->
¿nk
,

780 
comm
->
bÿ¡_comm
.
Çcks_couÁ”
, comm->bÿ¡_comm.
n_mÿ¡_»lŸbË
);

783 ià(
comm
->
p2p_ùx
 !ğ
NULL
) {

784 
	`ucc_ä“
(
comm
->
p2p_ùx
);

788 ià(
comm
->
hÿ_cİy_qp
) {

789 
»t
 = 
	`ibv_de¡roy_qp
(
comm
->
hÿ_cİy_qp
);

790 ià(
»t
) {

791 
	`_”rÜ
(
comm
->
lib
, "couldn't destroy HCA copy QP");

792  
UCC_ERR_NO_RESOURCE
;

796 ià(
comm
->
hÿ_cİy_cq
) {

797 
»t
 = 
	`ibv_de¡roy_cq
(
comm
->
hÿ_cİy_cq
);

798 ià(
»t
) {

799 
	`_”rÜ
(
comm
->
lib
, "couldn't destroy HCA copy CQ");

800  
UCC_ERR_NO_RESOURCE
;

804 
	`ucc_ä“
(
comm
);

806  
UCC_OK
;

807 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_helper.h

7 #iâdeà
TL_MLX5_MCAST_HELPER_H_


8 
	#TL_MLX5_MCAST_HELPER_H_


	)

9 
	~"_mlx5_mÿ¡_´og»ss.h
"

10 
	~"_mlx5_mÿ¡_Úe_sided_´og»ss.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"_mlx5.h
"

13 
	~"_mlx5_mÿ¡_hÿ_cİy.h
"

15 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_pŞl_£nd
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

17 
num_comp
;

18 
µ_·ck‘
 *
µ
;

19 
ibv_wc
 
wc
[
POLL_PACKED
];

21 
num_comp
 = 
	`ibv_pŞl_cq
(
comm
->
mÿ¡
.
scq
, 
POLL_PACKED
, &
wc
[0]);

22 ià(
num_comp
 < 0) {

23 
	`_”rÜ
(
comm
->
lib
, "£nd queupŞÈcom¶‘iÚ faed %d", 
num_comp
);

24  
UCC_ERR_NO_MESSAGE
;

25 } ià(
num_comp
 > 0) {

26 
	`_Œaû
(
comm
->
lib
, "pŞËd s’d com¶‘iÚs: %d", 
num_comp
);

27 
i
 = 0 ; i < 
num_comp
 ; i++) {

28 ià(
IBV_WC_SUCCESS
 !ğ
wc
[
i
].
¡©us
) {

29 
	`_w¬n
(
comm
->
lib
, "mcast_poll_send: %sƒrr %d‚um_comp %d op %ld wr_id\n",

30 
	`ibv_wc_¡©us_¡r
(
wc
[
i
].
¡©us
), 
num_comp
, wc[i].
İcode
, wc[i].
wr_id
);

31  
UCC_ERR_NO_MESSAGE
;

33 
wc
[
i
].
wr_id
) {

34 
MCAST_AG_RDMA_READ_WR
:

37 
comm
->
Úe_sided
.
³ndšg_»ads
--;

38 
	`_Œaû
(
comm
->
lib
, "RDMA READ completion,…ending„eads %d",

39 
comm
->
Úe_sided
.
³ndšg_»ads
);

41 
MCAST_AG_RDMA_READ_INFO_WR
:

42 
	`_Œaû
(
comm
->
lib
, "RDMA READ„emote slot info completion,…ending„eads %d",

43 
comm
->
Úe_sided
.
³ndšg_»ads
);

44 
comm
->
Úe_sided
.
³ndšg_»ads
--;

46 
MCAST_BCASTSEND_WR
:

47 
	`_Œaû
(
comm
->
lib
, "completion of mcast send for bcast, opcode %d",

48 
wc
[
i
].
İcode
);

49 
comm
->
³ndšg_£nd
--;

52 
	`_Œaû
(
comm
->
lib
, "completion of mcast send for zero-copy collective, opcode %d",

53 
wc
[
i
].
İcode
);

54 
comm
->
³ndšg_£nd
--;

55 
µ
 = (
µ_·ck‘
*)
wc
[
i
].
wr_id
;

56 
	`as£¹
(
µ
 != 0);

57 
µ
->
cÚ‹xt
 = 0;

58 
	`ucc_li¡_add_
(&
comm
->
bpoŞ
, &
µ
->
su³r
);

63  
UCC_OK
;

64 
	}
}

66 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£nd
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

67 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

68 
num_·ck‘s
, cÚ¡ 
zcİy
)

70 
ibv_£nd_wr
 *
swr
 = &
comm
->
mÿ¡
.swr;

71 
ibv_sge
 *
ssg
 = &
comm
->
mÿ¡
.ssg;

72 
max_³r_·ck‘
 = 
comm
->max_per_packet;

73 
off£t
 = 
»q
->offset;

74 
i
;

75 
ibv_£nd_wr
 *
bad_wr
;

76 
µ_·ck‘
 *
µ
;

77 
rc
;

78 
Ëngth
;

79 
ucc_¡©us_t
 
¡©us
;

80 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
comm
->
cuda_mem_’abËd
 ? 
UCC_MEMORY_TYPE_CUDA


81 : 
UCC_MEMORY_TYPE_HOST
;

83 
i
 = 0; i < 
num_·ck‘s
; i++) {

84 ià(
comm
->
·¿ms
.
sx_d•th
 <=

85 (
comm
->
³ndšg_£nd
 * comm->
·¿ms
.
scq_mod”©iÚ
 + comm->
tx
)) {

86 
¡©us
 = 
	`ucc__mlx5_mÿ¡_pŞl_£nd
(
comm
);

87 ià(
UCC_OK
 !ğ
¡©us
) {

88  
¡©us
;

93 ià(
NULL
 =ğ(
µ
 = 
	`ucc__mlx5_mÿ¡_buf_g‘_ä“
(
comm
))) {

97 
	`ucc_as£¹
(
µ
->
cÚ‹xt
 == 0);

99 
	`__butš_´eãtch
((*è
µ
->
buf
);

100 
	`__butš_´eãtch
(
	`PTR_OFFSET
(
»q
->
±r
, 
off£t
));

102 
Ëngth
 = 
»q
->
to_£nd
 =ğ1 ?„eq->
Ï¡_pkt_Ën
 : 
max_³r_·ck‘
;

103 
µ
->
Ëngth
 =†ength;

104 
µ
->
p¢
 = 
comm
->psn;

105 
ssg
[0].
addr
 = (
ušŒ_t
è
	`PTR_OFFSET
(
»q
->
±r
, 
off£t
);

107 ià(
zcİy
) {

108 
µ
->
cÚ‹xt
 = (
ušŒ_t
è
	`PTR_OFFSET
(
»q
->
±r
, 
off£t
);

110 
¡©us
 = 
	`ucc_mc_memıy
((*è
µ
->
buf
, 
	`PTR_OFFSET
(
»q
->
±r
, 
off£t
), 
Ëngth
,

111 
mem_ty³
, mem_type);

112 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

113 
	`_”rÜ
(
comm
->
lib
, "failedo copy cuda buffer");

114  
¡©us
;

116 
ssg
[0].
addr
 = (
ušt64_t
è
µ
->
buf
;

119 
ssg
[0].
Ëngth
 =†ength;

120 
ssg
[0].
lkey
 = 
zcİy
 ? 
»q
->
mr
->lkey : 
comm
->
µ_mr
->lkey;

121 
swr
[0].
wr
.
ud
.
ah
 = 
comm
->
mÿ¡
.
groups
[0].ah;

122 
swr
[0].
wr_id
 = 
MCAST_BCASTSEND_WR
;

123 
swr
[0].
imm_d©a
 = 
	`htÚl
(
µ
->
p¢
);

124 
swr
[0].
£nd_æags
 = (
Ëngth
 <ğ
comm
->
max_šlše
è? 
IBV_SEND_INLINE
 : 0;

126 
comm
->
r_wšdow
[
µ
->
p¢
 & (comm->
bÿ¡_comm
.
wsize
-1)] =…p;

127 
comm
->
p¢
++;

128 
»q
->
to_£nd
--;

129 
off£t
 +ğ
Ëngth
;

130 
comm
->
tx
++;

132 ià(
comm
->
tx
 =ğcomm->
·¿ms
.
scq_mod”©iÚ
) {

133 
swr
[0].
£nd_æags
 |ğ
IBV_SEND_SIGNALED
;

134 
comm
->
tx
 = 0;

135 
comm
->
³ndšg_£nd
++;

138 
	`_Œaû
(
comm
->
lib
, "post_send,…sn %d,†ength %d, zcopy %d, signaled %d",

139 
µ
->
p¢
,…p->
Ëngth
, 
zcİy
, 
swr
[0].
£nd_æags
 & 
IBV_SEND_SIGNALED
);

141 ià(0 !ğ(
rc
 = 
	`ibv_po¡_£nd
(
comm
->
mÿ¡
.
groups
[0].
qp
, &
swr
[0], &
bad_wr
))) {

142 
	`_”rÜ
(
comm
->
lib
, "post send failed:„et %d, start_psn %d,o_send %d, "

144 
rc
, 
»q
->
¡¬t_p¢
,„eq->
to_£nd
,„eq->
to_»cv
,

145 
Ëngth
, 
µ
->
p¢
,†’gth <ğ
comm
->
max_šlše
);

146  
UCC_ERR_NO_MESSAGE
;

149 
¡©us
 = 
	`ucc__mlx5_mÿ¡_check_Çck_»que¡s
(
comm
, 
µ
->
p¢
);

150 ià(
UCC_OK
 !ğ
¡©us
) {

151  
¡©us
;

155 
»q
->
off£t
 = offset;

157  
UCC_OK
;

158 
	}
}

160 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_´oûss_µ
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

161 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

162 
µ_·ck‘
 *
µ
,

163 *
num_Ëá
, 
š_³ndšg_queue
)

165 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

167 ià(
	`PSN_RECEIVED
(
µ
->
p¢
, 
comm
è||…p->p¢ < comm->
bÿ¡_comm
.
Ï¡_acked
) {

169 
	`ucc_as£¹
(
µ
->
cÚ‹xt
 == 0);

170 ià(
š_³ndšg_queue
) {

172 
	`ucc_li¡_d–
(&
µ
->
su³r
);

175 
	`ucc_li¡_add_
(&
comm
->
bpoŞ
, &
µ
->
su³r
);

176 } ià(
	`PSN_IS_IN_RANGE
(
µ
->
p¢
, 
»q
, 
comm
)) {

177 ià(*
num_Ëá
 <ğ0 && !
š_³ndšg_queue
) {

181 
	`ucc_li¡_add_
(&
comm
->
³ndšg_q
, &
µ
->
su³r
);

183 
	`__butš_´eãtch
(
	`PTR_OFFSET
(
»q
->
±r
, 
	`PSN_TO_RECV_OFFSET
(
µ
->
p¢
,„eq, 
comm
)));

184 
	`__butš_´eãtch
((*è
µ
->
buf
);

185 ià(
š_³ndšg_queue
) {

186 
	`ucc_li¡_d–
(&
µ
->
su³r
);

188 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´oûss_·ck‘
(
comm
, 
»q
, 
µ
);

189 ià(
UCC_OK
 !ğ
¡©us
) {

190  
¡©us
;

192 (*
num_Ëá
)--;

194 } ià(!
š_³ndšg_queue
) {

196 
	`ucc_li¡_add_
(&
comm
->
³ndšg_q
, &
µ
->
su³r
);

199  
¡©us
;

200 
	}
}

204 
šlše
 
	$ucc__mlx5_mÿ¡_»cv
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

205 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

206 
num_Ëá
, *
³ndšg_q_size
)

208 
µ_·ck‘
 *
µ
;

209 
µ_·ck‘
 *
Ãxt
;

210 
ušt64_t
 
id
;

211 
ibv_wc
 *
wc
;

212 
num_comp
;

213 
i
;

214 
»®_num_comp
;

215 
ucc_¡©us_t
 
¡©us
;

218 
	`ucc_li¡_fÜ_—ch_§ã
(
µ
, 
Ãxt
, &
comm
->
³ndšg_q
, 
su³r
) {

219 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´oûss_µ
(
comm
, 
»q
, 
µ
, &
num_Ëá
, 1);

220 ià(
UCC_OK
 !ğ
¡©us
) {

223 (*
³ndšg_q_size
)++;

226 
wc
 = 
	`ucc_m®loc
((
ibv_wc
è* 
POLL_PACKED
, "WC");

227 ià(!
wc
) {

228 
	`_”rÜ
(
comm
->
lib
, "ucc_malloc failed");

232 
num_Ëá
 > 0)

234 
	`mem£t
(
wc
, 0, (
ibv_wc
è* 
POLL_PACKED
);

235 
num_comp
 = 
	`ibv_pŞl_cq
(
comm
->
mÿ¡
.
rcq
, 
POLL_PACKED
, 
wc
);

237 ià(
num_comp
 < 0) {

238 
	`_”rÜ
(
comm
->
lib
, "»cv queupŞÈcom¶‘iÚ faed %d", 
num_comp
);

239 
	`ucc_ä“
(
wc
);

241 } ià(
num_comp
 == 0) {

245 
»®_num_comp
 = 
num_comp
;

247 
i
 = 0; i < 
»®_num_comp
; i++) {

248 ià(
IBV_WC_SUCCESS
 !ğ
wc
[
i
].
¡©us
) {

249 
	`_”rÜ
(
comm
->
lib
, "mcast_recv: %sƒrr…ending_recv %d wr_id %ld"

251 
	`ibv_wc_¡©us_¡r
(
wc
[
i
].
¡©us
), 
comm
->
³ndšg_»cv
,

252 
wc
[
i
].
wr_id
, 
num_comp
, wc[i].
by‹_Ën
);

253 
	`ucc_ä“
(
wc
);

257 
id
 = 
wc
[
i
].
wr_id
;

258 
µ
 = (
µ_·ck‘
*è(
id
);

259 
µ
->
Ëngth
 = 
wc
[
i
].
by‹_Ën
 - 
GRH_LENGTH
;

260 
µ
->
p¢
 = 
	`Áohl
(
wc
[
i
].
imm_d©a
);

262 
	`_Œaû
(
comm
->
lib
, "completion:…sn %d,†ength %d,‡lready_received %d, "

265 
µ
->
p¢
,…p->
Ëngth
, 
	`PSN_RECEIVED
(pp->psn,

266 
comm
è> 0, 
	`PSN_IS_IN_RANGE
(
µ
->
p¢
, 
»q
,

267 
comm
), 
»q
->
¡¬t_p¢
,„eq->
num_·ck‘s
,

268 
»q
->
to_£nd
,„eq->
to_»cv
, 
num_Ëá
);

270 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´oûss_µ
(
comm
, 
»q
, 
µ
, &
num_Ëá
, 0);

271 ià(
UCC_OK
 !ğ
¡©us
) {

276 
comm
->
³ndšg_»cv
 -ğ
num_comp
;

277 
¡©us
 = 
	`ucc__mlx5_mÿ¡_po¡_»cv_bufãrs
(
comm
);

278 ià(
UCC_OK
 !ğ
¡©us
) {

283 
	`ucc_ä“
(
wc
);

284  
num_Ëá
;

285 
	}
}

287 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£nd_cŞËùive
(
ucc__mlx5_mÿ¡_cŞl_comm_t
*

288 
comm
, 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

289 
num_·ck‘s
, cÚ¡ 
zcİy
,

290 
mÿ¡_group_šdex
,

291 
size_t
 
£nd_off£t
)

293 
ibv_£nd_wr
 *
swr
 = &
comm
->
mÿ¡
.swr;

294 
ibv_sge
 *
ssg
 = &
comm
->
mÿ¡
.ssg;

295 
size_t
 
off£t
 = (
£nd_off£t
 =ğ
SIZE_MAX
è? 
»q
->offset : send_offset;

296 
max_commsize
 = 
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
;

297 
max_ag_couÁ”
 = 
ONE_SIDED_MAX_ZCOPY_COLL_COUNTER
;

298 
i
;

299 
ibv_£nd_wr
 *
bad_wr
;

300 
µ_·ck‘
 *
µ
;

301 
rc
;

302 
Ëngth
;

303 
ucc_¡©us_t
 
¡©us
;

304 
u£_zcİy
;

305 
ucc_memÜy_ty³_t
 
¤c_mem_ty³
;

306 
ucc_memÜy_ty³_t
 
d¡_mem_ty³
;

308 
	`ucc_as£¹
(
mÿ¡_group_šdex
 <ğ
comm
->
mÿ¡_group_couÁ
);

310 
swr
->
num_sge
 = 1;

311 
swr
->
sg_li¡
 = & 
comm
->
mÿ¡
.
ssg
;

312 
swr
->
İcode
 = 
IBV_WR_SEND_WITH_IMM
;

313 
swr
->
wr
.
ud
.
»mÙe_q²
 = 
MULTICAST_QPN
;

314 
swr
->
wr
.
ud
.
»mÙe_qkey
 = 
DEF_QKEY
;

315 
swr
->
Ãxt
 = 
NULL
;

317 
i
 = 0; i < 
num_·ck‘s
; i++) {

318 ià(
NULL
 =ğ(
µ
 = 
	`ucc__mlx5_mÿ¡_buf_g‘_ä“
(
comm
))) {

321 
	`ucc_as£¹
(
µ
->
cÚ‹xt
 == 0);

323 
	`__butš_´eãtch
((*è
µ
->
buf
);

324 
	`__butš_´eãtch
(
»q
->
±r
 + 
off£t
);

326 
Ëngth
 = (
»q
->
to_£nd
 =ğ1è? (»q->Ëngth - 
off£t
è: 
comm
->
max_³r_·ck‘
;

327 
µ
->
Ëngth
 =†ength;

333 
µ
->
p¢
 = (
»q
->
num_·ck‘s
 -„eq->
to_£nd
)*
max_commsize
*
max_ag_couÁ”


334 + (
»q
->
ag_couÁ”
 % 
max_ag_couÁ”
)*
max_commsize
 + 
comm
->
¿nk
;

336 
ssg
[0].
addr
 = (
ušŒ_t
)
»q
->
±r
 + 
off£t
;

339 
u£_zcİy
 = 
zcİy
 || (
comm
->
cuda_mem_’abËd
 && 
»q
->
mr
 &&„eq->m¸!ğcomm->
µ_mr
);

341 ià(
u£_zcİy
 && 
comm
->
cuda_mem_’abËd
 && 
»q
->
mr
 !ğcomm->
µ_mr
) {

342 
	`_Œaû
(
comm
->
lib
, "usšg z”o-cİy s’dšg fÜ CUDA memÜy,†’gth %d", 
Ëngth
);

345 ià(!
u£_zcİy
) {

346 
¤c_mem_ty³
 = 
comm
->
cuda_mem_’abËd
 ? 
UCC_MEMORY_TYPE_CUDA
 : 
UCC_MEMORY_TYPE_HOST
;

347 
d¡_mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

348 
¡©us
 = 
	`ucc__mlx5_mÿ¡_memıy
((*è
µ
->
buf
, 
d¡_mem_ty³
,

349 
»q
->
±r
 + 
off£t
, 
¤c_mem_ty³
, 
Ëngth
, 
comm
);

350 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

351 
	`_”rÜ
(
comm
->
lib
, "failedo copy buffero staging‡rea");

352  
¡©us
;

354 
ssg
[0].
addr
 = (
ušt64_t
è
µ
->
buf
;

355 
ssg
[0].
lkey
 = 
comm
->
µ_mr
->lkey;

357 
µ
->
cÚ‹xt
 = (
ušŒ_t
)
»q
->
±r
 + 
off£t
;

358 
ssg
[0].
lkey
 = 
»q
->
mr
->lkey;

361 
ssg
[0].
Ëngth
 =†ength;

362 
swr
[0].
wr_id
 = (
ušt64_t
è
µ
;

363 
swr
[0].
imm_d©a
 = 
	`htÚl
(
µ
->
p¢
);

364 
swr
[0].
£nd_æags
 = (
Ëngth
 <ğ
comm
->
max_šlše
è? 
IBV_SEND_INLINE
 : 0;

366 
comm
->
p¢
 ++;

367 
»q
->
to_£nd
 --;

368 
off£t
 +ğ
Ëngth
;

370 
swr
[0].
£nd_æags
 |ğ
IBV_SEND_SIGNALED
;

371 
comm
->
³ndšg_£nd
++;

373 
swr
[0].
wr
.
ud
.
ah
 = 
comm
->
mÿ¡
.
groups
[
mÿ¡_group_šdex
].ah;

375 
	`_Œaû
(
comm
->
lib
,

378 
µ
->
p¢
,…p->
Ëngth
, 
zcİy
, 
u£_zcİy
, 
swr
[0].
£nd_æags
 & 
IBV_SEND_SIGNALED
,

379 
comm
->
mÿ¡
.
groups
[
mÿ¡_group_šdex
].
qp
->
¡©e
,

380 
comm
->
mÿ¡
.
groups
[
mÿ¡_group_šdex
].
qp
->
qp_num
,

381 
comm
->
mÿ¡
.
groups
[
mÿ¡_group_šdex
].
qp
->
pd
, mcast_group_index);

383 ià(0 !ğ(
rc
 = 
	`ibv_po¡_£nd
(
comm
->
mÿ¡
.
groups
[
mÿ¡_group_šdex
].
qp
, &
swr
[0], &
bad_wr
))) {

384 
	`_”rÜ
(
comm
->
lib
, "post send failed:„et %d, start_psn %d,o_send %d, "

386 
rc
, 
»q
->
¡¬t_p¢
,„eq->
to_£nd
,„eq->
to_»cv
,

387 
Ëngth
, 
µ
->
p¢
,†’gth <ğ
comm
->
max_šlše
);

388  
UCC_ERR_NO_MESSAGE
;

392 ià(
£nd_off£t
 =ğ
SIZE_MAX
) {

393 
»q
->
off£t
 = offset;

396  
UCC_OK
;

397 
	}
}

399 
šlše
 
	$ucc__mlx5_mÿ¡_»cv_cŞËùive
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

400 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
, 

401 
num_Ëá
, 
cŞl_ty³
)

403 
max_commsize
 = 
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
;

404 
max_ag_couÁ”
 = 
ONE_SIDED_MAX_ZCOPY_COLL_COUNTER
;

405 
µ_·ck‘
 *
µ
;

406 
µ_·ck‘
 *
Ãxt
;

407 
ušt64_t
 
id
;

408 
ibv_wc
 *
wc
;

409 
num_comp
;

410 
i
;

411 
»®_num_comp
;

412 
»cv_´og»s£d
 = 0;

413 
ag_couÁ”
;

414 
ucc_¡©us_t
 
¡©us
;

417 
	`ucc_li¡_fÜ_—ch_§ã
(
µ
, 
Ãxt
, &
comm
->
³ndšg_q
, 
su³r
) {

418 
ag_couÁ”
 = (
µ
->
p¢
 / 
max_commsize
) %

419 
max_ag_couÁ”
;

420 ià(
ag_couÁ”
 =ğ(
»q
->ag_couÁ” % 
max_ag_couÁ”
)) {

421 
	`ucc_li¡_d–
(&
µ
->
su³r
);

422 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´oûss_·ck‘_cŞËùive
(
comm
, 
»q
, 
µ
, 
cŞl_ty³
);

423 ià(
UCC_OK
 !ğ
¡©us
) {

424 
	`_”rÜ
(
comm
->
lib
, "process mcast…acket failed, status %d",

425 
¡©us
);

428 
»cv_´og»s£d
++;

432 
wc
 = 
	`ucc_m®loc
((
ibv_wc
è* 
POLL_PACKED
, "WC");

433 ià(!
wc
) {

434 
»cv_´og»s£d
 = -1;

435 
ex™
;

438 
num_Ëá
 > 
»cv_´og»s£d
)

440 
	`mem£t
(
wc
, 0, (
ibv_wc
è* 
POLL_PACKED
);

441 
num_comp
 = 
	`ibv_pŞl_cq
(
comm
->
mÿ¡
.
rcq
, 
POLL_PACKED
, &
wc
[0]);

443 ià(
num_comp
 < 0) {

444 
	`_”rÜ
(
comm
->
lib
, "»cv queupŞÈcom¶‘iÚ faed %d", 
num_comp
);

445 
»cv_´og»s£d
 = -1;

446 
ex™
;

447 } ià(
num_comp
 == 0) {

451 ià(
IBV_WC_SUCCESS
 !ğ
wc
[0].
¡©us
) {

452 
	`_”rÜ
(
comm
->
lib
, "mcast_recv: %sƒrr…ending_recv %d wr_id %ld‚um_comp %d byte_len %d\n",

453 
	`ibv_wc_¡©us_¡r
(
wc
[0].
¡©us
), 
comm
->
³ndšg_»cv
, wc[0].
wr_id
, 
num_comp
, wc[0].
by‹_Ën
);

454 
»cv_´og»s£d
 = -1;

455 
ex™
;

458 
»®_num_comp
 = 
num_comp
;

460 
i
 = 0; i < 
»®_num_comp
; i++) {

461 
	`ucc_as£¹
(
wc
[
i
].
¡©us
 =ğ
IBV_WC_SUCCESS
);

462 
id
 = 
wc
[
i
].
wr_id
;

463 
µ
 = (
µ_·ck‘
*è(
id
);

464 
µ
->
Ëngth
 = 
wc
[
i
].
by‹_Ën
 - 
GRH_LENGTH
;

465 
µ
->
p¢
 = 
	`Áohl
(
wc
[
i
].
imm_d©a
);

467 
	`_Œaû
(
comm
->
lib
, "%d collective…kt completion:…sn %d,†ength %d, "

469 
cŞl_ty³
, 
µ
->
p¢
,…p->
Ëngth
, 
»q
->
num_·ck‘s
,

470 
»q
->
to_£nd
,„eq->
to_»cv
, 
num_Ëá
);

472 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´oûss_·ck‘_cŞËùive
(
comm
, 
»q
, 
µ
, 
cŞl_ty³
);

473 ià(
UCC_OK
 !ğ
¡©us
) {

474 
	`_”rÜ
(
comm
->
lib
, "process mcast…acket failed, status %d",

475 
¡©us
);

476 
»cv_´og»s£d
 = -1;

477 
ex™
;

480 
»cv_´og»s£d
++;

481 
	`ucc_as£¹
(
µ
->
qp_id
 < 
MAX_GROUP_COUNT
);

484 
comm
->
³ndšg_»cv
 -ğ
num_comp
;

485 
¡©us
 = 
	`ucc__mlx5_mÿ¡_po¡_»cv_bufãrs
(
comm
);

486 ià(
UCC_OK
 !ğ
¡©us
) {

487 
»cv_´og»s£d
 = -1;

488 
ex™
;

492 
ex™
:

493 
	`ucc_ä“
(
wc
);

494  
»cv_´og»s£d
;

495 
	}
}

498 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_pŞl_»cv
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

500 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

501 
µ_·ck‘
 *
µ
;

502 
ibv_wc
 
wc
;

503 
num_comp
;

504 
ušt64_t
 
id
;

505 
Ëngth
;

506 
ušt32_t
 
p¢
;

509 
num_comp
 = 
	`ibv_pŞl_cq
(
comm
->
mÿ¡
.
rcq
, 1, &
wc
);

511 ià(
num_comp
 > 0) {

512 ià(
IBV_WC_SUCCESS
 !ğ
wc
.
¡©us
) {

513 
	`_”rÜ
(
comm
->
lib
, "mcast_poll_recv: %sƒrr %d‚um_comp",

514 
	`ibv_wc_¡©us_¡r
(
wc
.
¡©us
), 
num_comp
);

515 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

516  
¡©us
;

520 
id
 = 
wc
.
wr_id
;

521 
Ëngth
 = 
wc
.
by‹_Ën
 - 
GRH_LENGTH
;

522 
p¢
 = 
	`Áohl
(
wc
.
imm_d©a
);

523 
µ
 = (
µ_·ck‘
*è
id
;

525 ià(
p¢
 >ğ
comm
->psn) {

526 
	`ucc_as£¹
(!
	`PSN_RECEIVED
(
p¢
, 
comm
));

527 
µ
->
p¢
 =…sn;

528 
µ
->
Ëngth
 =†ength;

529 
	`ucc_li¡_add_
(&
comm
->
³ndšg_q
, &
µ
->
su³r
);

531 
	`ucc_as£¹
(
µ
->
cÚ‹xt
 == 0);

532 
	`ucc_li¡_add_
(&
comm
->
bpoŞ
, &
µ
->
su³r
);

535 
comm
->
³ndšg_»cv
--;

536 
¡©us
 = 
	`ucc__mlx5_mÿ¡_po¡_»cv_bufãrs
(
comm
);

537 ià(
UCC_OK
 !ğ
¡©us
) {

538  
¡©us
;

540 } ià(
num_comp
 != 0) {

541 
	`_”rÜ
(
comm
->
lib
, "mÿ¡_pŞl_»cv: %d‚um_comp", 
num_comp
);

542 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

543  
¡©us
;

545 } 
num_comp
);

547  
¡©us
;

548 
	}
}

550 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_»lŸbË
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

552 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

554 ià(
comm
->
bÿ¡_comm
.
¿cks_n
 !ğcomm->bÿ¡_comm.
chd_n
 ||

555 
comm
->
bÿ¡_comm
.
§cks_n
 !ğcomm->bÿ¡_comm.
·»Á_n
 ||

556 
comm
->
bÿ¡_comm
.
Çck_»que¡s
) {

557 ià(
comm
->
³ndšg_£nd
) {

558 
¡©us
 = 
	`ucc__mlx5_mÿ¡_pŞl_£nd
(
comm
);

559 ià(
UCC_OK
 !ğ
¡©us
) {

560  
¡©us
;

564 ià(
comm
->
bÿ¡_comm
.
·»Á_n
) {

565 
¡©us
 = 
	`ucc__mlx5_mÿ¡_pŞl_»cv
(
comm
);

566 ià(
UCC_OK
 !ğ
¡©us
) {

567  
¡©us
;

571 
¡©us
 = 
	`ucc__mlx5_mÿ¡_check_Çck_»que¡s
(
comm
, 
UINT32_MAX
);

572 ià(
UCC_OK
 !ğ
¡©us
) {

573  
¡©us
;

577 ià(
comm
->
bÿ¡_comm
.
·»Á_n
 && !comm->bÿ¡_comm.
»lŸbË_š_´og»ss
) {

578 
¡©us
 = 
	`ucc__mlx5_mÿ¡_»lŸbË_£nd
(
comm
);

579 ià(
UCC_OK
 !ğ
¡©us
) {

580  
¡©us
;

584 ià(!
comm
->
bÿ¡_comm
.
»lŸbË_š_´og»ss
) {

585 
comm
->
bÿ¡_comm
.
»lŸbË_š_´og»ss
 = 1;

588 ià(
comm
->
bÿ¡_comm
.
¿cks_n
 =ğcomm->bÿ¡_comm.
chd_n
 &&

589 
comm
->
bÿ¡_comm
.
§cks_n
 =ğcomm->bÿ¡_comm.
·»Á_n
 && 0 ==

590 
comm
->
bÿ¡_comm
.
Çck_»que¡s
) {

592 
	`mem£t
(
comm
->
bÿ¡_comm
.
·»Ás
, 0, (comm->bcast_comm.parents));

593 
	`mem£t
(
comm
->
bÿ¡_comm
.
chd»n
, 0, (comm->bcast_comm.children));

595 
comm
->
bÿ¡_comm
.
¿cks_n
 = comm->bÿ¡_comm.
chd_n
 = 0;

596 
comm
->
bÿ¡_comm
.
§cks_n
 = comm->bÿ¡_comm.
·»Á_n
 = 0;

597 
comm
->
bÿ¡_comm
.
»lŸbË_š_´og»ss
 = 0;

599  
UCC_OK
;

602  
UCC_INPROGRESS
;

603 
	}
}

605 
ucc_¡©us_t
 
ucc__mlx5_´obe__ov”_ib
(* 
ib_dev_li¡
,

606 
sockaddr_¡Üage
 *
addr
);

608 
ucc_¡©us_t
 
ucc__mlx5_£tup_mÿ¡
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

610 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_š™_qps
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

611 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

613 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_£tup_qps
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

614 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

616 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_ü—‹_rc_qps
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

617 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

619 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_modify_rc_qps
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

620 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

622 
ucc_¡©us_t
 
ucc__mlx5_ş—n_mÿ¡_comm
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

624 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_još_mÿ¡_po¡
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

625 
sockaddr_š6
 *
Ãt_addr
,

626 
mÿ¡_group
 *
group
,

627 
is_roÙ
);

629 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_još_mÿ¡_g‘_ev’t
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

630 
rdma_cm_ev’t
 **
ev’t
);

632 
ucc_¡©us_t
 
ucc__mlx5_Ëave_mÿ¡_groups
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

633 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_one_sided_progress.c

7 
	~"_mlx5_mÿ¡_Úe_sided_´og»ss.h
"

8 
	~"_mlx5_mÿ¡_rÿche.h
"

9 
	~"_mlx5_mÿ¡_hÿ_cİy.h
"

10 
	~<š‰y³s.h
>

12 
ucc_¡©us_t


13 
	$ucc__mlx5_mÿ¡_¡agšg_®lg©h”_»lŸbË_Úe_sided_g‘
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

14 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

15 *
com¶‘ed
)

17 
rg‘_com¶‘ed
 = 0;

18 
issued
 = 0;

19 
ucc_¡©us_t
 
¡©us
;

20 
ucc_¿nk_t
 
rg‘
;

21 
ucc__mlx5_mÿ¡_»g_t
 *
»g
;

22 *
¤c_addr
;

23 *
»mÙe_addr
;

24 
ušt32_t
 
rkey
;

25 
ušt32_t
 
lkey
;

26 
size_t
 
size
;

27 
ušt64_t
 
wr
;

30 
	`ucc_as£¹
(!(
ONE_SIDED_SYNCHRONOUS_PROTO
 =ğ
»q
->
Úe_sided_»lŸb™y_scheme
 &&

31 
comm
->
Úe_sided
.
³ndšg_»ads
));

35 ià(
»q
->
sü©ch_buf
 &&„eq->
sü©ch_·ck‘s_»ûived
 > 0) {

36 
	`_Œaû
(
comm
->
lib
,

38 "tØu£¸bufã¸befÜRDMA„—ds", 
»q
->
sü©ch_·ck‘s_»ûived
);

42 
¡©us
 = 
	`ucc__mlx5_mÿ¡_memıy
(
»q
->
½Œ
, 
UCC_MEMORY_TYPE_CUDA
,

43 
»q
->
sü©ch_buf
, 
UCC_MEMORY_TYPE_HOST
,

44 
»q
->
Ëngth
 * 
comm
->
commsize
, comm);

45 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

46 
	`_”rÜ
(
comm
->
lib
,

48  
¡©us
;

52 
»q
->
sü©ch_·ck‘s_»ûived
 = -1;

53 
	`_Œaû
(
comm
->
lib
,

57 
rg‘
 = 0;¬g‘ < 
comm
->
commsize
;arget++) {

58 ià(
comm
->
Úe_sided
.
»cvd_pkts_Œack”
[
rg‘
] =ğ
»q
->
num_·ck‘s
) {

59 
rg‘_com¶‘ed
++;

62 ià(
NULL
 =ğ
»q
->
»cv_¼eg
) {

64 
	`_debug
(
comm
->
lib
, "»gi¡”šg„ecv buàoàsiz%ld", comm->
commsize
 * 
»q
->
Ëngth
);

65 
¡©us
 = 
	`ucc__mlx5_mÿ¡_mem_»gi¡”
(
comm
->
ùx
, 
»q
->
½Œ
, comm->
commsize
 *„eq->
Ëngth
, &
»g
);

66 ià(
UCC_OK
 !ğ
¡©us
) {

67  
¡©us
;

69 
»q
->
»cv_¼eg
 = 
»g
;

70 
»q
->
»cv_mr
 = 
»g
->
mr
;

72 
»q
->
Úe_sided_»lŸb™y_scheme
) {

73 
ONE_SIDED_ASYNCHRONOUS_PROTO
:

78 ià(
»q
->
ag_couÁ”
 =ğ
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
[
rg‘
]) {

83 
¤c_addr
 = 
	`PTR_OFFSET
(
»q
->
½Œ
, (»q->
Ëngth
 * 
rg‘
));

84 
»mÙe_addr
 = 
	`PTR_OFFSET
(
comm
->
Úe_sided
.
šfo
[
rg‘
].
¦Ù_mem
.remote_addr,

85 ((
»q
->
ag_couÁ”
 %

86 
ONE_SIDED_SLOTS_COUNT
) *

87 
comm
->
Úe_sided
.
¦Ù_size
 +

88 
ONE_SIDED_SLOTS_INFO_SIZE
));

89 
lkey
 = 
»q
->
»cv_mr
->lkey;

90 
rkey
 = 
comm
->
Úe_sided
.
šfo
[
rg‘
].
¦Ù_mem
.rkey;

91 
size
 = 
»q
->
Ëngth
;

92 
wr
 = 
MCAST_AG_RDMA_READ_WR
;

93 
comm
->
Úe_sided
.
³ndšg_»ads
++;

94 
rg‘_com¶‘ed
++;

95 
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
[
rg‘
] = 
ONE_SIDED_PENDING_DATA
;

96 
comm
->
Úe_sided
.
»cvd_pkts_Œack”
[
rg‘
] = 
»q
->
num_·ck‘s
;

97 } ià(
ONE_SIDED_PENDING_INFO
 !ğ
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
[
rg‘
] &&

98 
ONE_SIDED_PENDING_DATA
 !ğ
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
[
rg‘
]) {

101 
¤c_addr
 = &
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
[
rg‘
];

102 
»mÙe_addr
 = 
	`PTR_OFFSET
(
comm
->
Úe_sided
.
šfo
[
rg‘
].
¦Ù_mem
.remote_addr,

103 ((
»q
->
ag_couÁ”
 % 
ONE_SIDED_SLOTS_COUNT
) *

104 
comm
->
Úe_sided
.
¦Ù_size
));

105 
lkey
 = 
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo_mr
->lkey;

106 
rkey
 = 
comm
->
Úe_sided
.
šfo
[
rg‘
].
¦Ù_mem
.rkey;

107 
size
 = 
ONE_SIDED_SLOTS_INFO_SIZE
;

108 
wr
 = 
MCAST_AG_RDMA_READ_INFO_WR
;

109 
comm
->
Úe_sided
.
³ndšg_»ads
++;

110 
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
[
rg‘
] = 
ONE_SIDED_PENDING_INFO
;

117 
ONE_SIDED_SYNCHRONOUS_PROTO
:

120 
¤c_addr
 = 
	`PTR_OFFSET
(
»q
->
½Œ
, (»q->
Ëngth
 * 
rg‘
));

121 
»mÙe_addr
 = (*)
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[
rg‘
].remote_addr;

122 
rkey
 = 
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[
rg‘
].rkey;

123 
lkey
 = 
»q
->
»cv_mr
->lkey;

124 
size
 = 
»q
->
Ëngth
;

125 
wr
 = 
MCAST_AG_RDMA_READ_WR
;

126 
comm
->
Úe_sided
.
³ndšg_»ads
++;

127 
rg‘_com¶‘ed
++;

130  
UCC_ERR_NOT_IMPLEMENTED
;

132 
issued
++;

133 
¡©us
 = 
	`ucc__mlx5_Úe_sided_p2p_g‘
(
¤c_addr
, 
»mÙe_addr
, 
size
,

134 
lkey
, 
rkey
, 
rg‘
, 
wr
, 
comm
);

135 ià(
UCC_OK
 !ğ
¡©us
) {

136  
¡©us
;

139 ià(
com¶‘ed
) {

140 *
com¶‘ed
 = 
rg‘_com¶‘ed
;

142 ià(
issued
) {

143 
	`_debug
(
comm
->
lib
,

145 
issued
, 
rg‘_com¶‘ed
);

147  
UCC_OK
;

148 
	}
}

150 
ucc_¡©us_t


151 
	$ucc__mlx5_mÿ¡_´og»ss_Úe_sided_communiÿtiÚ
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

152 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

154 
com¶‘ed
 = 0;

155 
ucc_¡©us_t
 
¡©us
;

157 
	`ucc_as£¹
(
comm
->
Úe_sided
.
³ndšg_»ads
);

159 ià(!
»q
->
to_£nd
 && !»q->
to_»cv
) {

161 
	`_Œaû
(
comm
->
lib
,

164 
comm
->
ùx
->
·¿ms
.
timeout
);

167 ià(
	`ucc__mlx5_mÿ¡_pŞl_£nd
(
comm
) < 0) {

168  
UCC_ERR_NO_MESSAGE
;

172 
»q
->
Úe_sided_»lŸb™y_scheme
) {

173 
ONE_SIDED_ASYNCHRONOUS_PROTO
:

175 
¡©us
 = 
	`ucc__mlx5_mÿ¡_¡agšg_®lg©h”_»lŸbË_Úe_sided_g‘
(
comm
, 
»q
, &
com¶‘ed
);

176 ià(
UCC_OK
 !ğ
¡©us
) {

177  
¡©us
;

180 ià(!
comm
->
Úe_sided
.
³ndšg_»ads
 && (
com¶‘ed
 =ğcomm->
commsize
)) {

181 
	`_Œaû
(
comm
->
lib
,

183 
»q
->
to_»cv
 = 0;

184  
UCC_OK
;

188 
ONE_SIDED_SYNCHRONOUS_PROTO
:

189 ià(!
comm
->
Úe_sided
.
³ndšg_»ads
) {

190 
	`_Œaû
(
comm
->
lib
,

193 ià(!
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
 &&

194 !
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
) {

195 
»q
->
to_»cv
 = 0;

197  
UCC_OK
;

202  
UCC_ERR_NOT_IMPLEMENTED
;

205  
UCC_INPROGRESS
;

206 
	}
}

208 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_´oûss_·ck‘_cŞËùive
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

209 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

210 
µ_·ck‘
 *
µ
,

211 
cŞl_ty³
)

213 
out_of_Üd”_»cvd
 = 0;

214 *
de¡
;

215 
off£t
;

216 
sourû_¿nk
;

217 
ušt32_t
 
ag_couÁ”
;

218 
ucc_memÜy_ty³_t
 
d¡_mem_ty³
;

219 
ucc_memÜy_ty³_t
 
¤c_mem_ty³
;

220 
ucc_¡©us_t
 
¡©us
;

222 
	`ucc_as£¹
(
µ
->
cÚ‹xt
 == 0);

225 
sourû_¿nk
 = 
µ
->
p¢
 % 
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
;

226 
ag_couÁ”
 = (
µ
->
p¢
 / 
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
è% 
ONE_SIDED_MAX_ZCOPY_COLL_COUNTER
;

227 
off£t
 = (
µ
->
p¢
 / (
ONE_SIDED_MAX_ZCOPY_COLL_COUNTER
 * 
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
));

229 
	`_Œaû
(
comm
->
lib
, "processing‡„ecvd…acket with†ength %d source_rank"

230 " %d‡g_couÁ” %d off£ˆ%d", 
µ
->
Ëngth
, 
sourû_¿nk
,

231 
ag_couÁ”
, 
off£t
);

233 
	`ucc_as£¹
(
off£t
 < 
»q
->
num_·ck‘s
);

238 ià(
ag_couÁ”
 =ğ(
»q
->ag_couÁ” % 
ONE_SIDED_MAX_ZCOPY_COLL_COUNTER
)) {

240 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

243 ià(
off£t
 !ğ
µ
->
·ck‘_couÁ”
) {

244 
out_of_Üd”_»cvd
 = 1;

247 ià(
out_of_Üd”_»cvd
 == 0) {

248 
comm
->
Úe_sided
.
»cvd_pkts_Œack”
[
sourû_¿nk
]++;

250 ià(
comm
->
Úe_sided
.
»cvd_pkts_Œack”
[
sourû_¿nk
] > 
»q
->
num_·ck‘s
) {

251 
	`_”rÜ
(
comm
->
lib
, "reliability failed: comm->one_sided.recvd_pkts_tracker[%d] %d"

254 " %d \n", 
sourû_¿nk
, 
comm
->
Úe_sided
.
»cvd_pkts_Œack”
[source_rank],

255 
»q
->
num_·ck‘s
, 
off£t
,

256 
comm
->
®lg©h”_comm
.
und”_´og»ss_couÁ”
, 
»q
->
ag_couÁ”
);

257  
UCC_ERR_NO_MESSAGE
;

259 ià(
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
 ||

260 
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
) {

262 
	`ucc_li¡_d–
(&
µ
->
su³r
);

266 ià(
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
 ||

267 
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
) {

270 ià(
off£t
 !ğ
µ
->
·ck‘_couÁ”
) {

272 
	`_Œaû
(
comm
->
lib
, "recevied out of order:…acket counter %dƒxpected„ecv counter %d with…p %p",

273 
off£t
, 
µ
->
·ck‘_couÁ”
,…p);

275 } ià(
µ
->
Ëngth
) {

277 
	`ucc_as£¹
(
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHER
);

281 ià(
»q
->
sü©ch_buf
 && 
comm
->
cuda_mem_’abËd
) {

283 ià(
µ
->
Ëngth
 =ğ
comm
->
max_³r_·ck‘
) {

284 
de¡
 = 
»q
->
sü©ch_buf
 + (
off£t
 * 
µ
->
Ëngth
 + 
sourû_¿nk
 *„eq->length);

286 
de¡
 = 
»q
->
sü©ch_buf
 + (Ôeq->
Ëngth
 - 
µ
->Ëngthè+ 
sourû_¿nk
 *„eq->length);

290 
	`memıy
(
de¡
, (*è
µ
->
buf
,…p->
Ëngth
);

293 ià(
»q
->
sü©ch_·ck‘s_»ûived
 >= 0) {

294 
»q
->
sü©ch_·ck‘s_»ûived
++;

298 ià(
»q
->
sü©ch_·ck‘s_»ûived
 =ğÔeq->
comm
->
commsize
 *„eq->
num_·ck‘s
)) {

299 
¡©us
 = 
	`ucc__mlx5_mÿ¡_memıy
(
»q
->
½Œ
, 
UCC_MEMORY_TYPE_CUDA
,

300 
»q
->
sü©ch_buf
, 
UCC_MEMORY_TYPE_HOST
,

301 
»q
->
Ëngth
 *„eq->
comm
->
commsize
, comm);

302 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

303 
	`_”rÜ
(
comm
->
lib
, "failedo copy scratch buffero user buffer");

304  
¡©us
;

306 
»q
->
sü©ch_·ck‘s_»ûived
 = -1;

307 
	`_Œaû
(
comm
->
lib
, "all…ackets„eceived - copied scratch buffero user buffer");

311 ià(
µ
->
Ëngth
 =ğ
comm
->
max_³r_·ck‘
) {

312 
de¡
 = 
	`PTR_OFFSET
(
»q
->
½Œ
, (
off£t
 * 
µ
->
Ëngth
 + 
sourû_¿nk
 *„eq->length));

314 
de¡
 = 
	`PTR_OFFSET
(
»q
->
½Œ
,

315 ((
»q
->
Ëngth
 - 
µ
->Ëngthè+ 
sourû_¿nk
 *„eq->length));

318 
d¡_mem_ty³
 = 
comm
->
cuda_mem_’abËd
 ? 
UCC_MEMORY_TYPE_CUDA
 : 
UCC_MEMORY_TYPE_HOST
;

319 
¤c_mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

320 
¡©us
 = 
	`ucc__mlx5_mÿ¡_memıy
(
de¡
, 
d¡_mem_ty³
, (*è
µ
->
buf
,

321 
¤c_mem_ty³
, 
µ
->
Ëngth
, 
comm
);

322 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

323 
	`_”rÜ
(
comm
->
lib
, "failedo copy buffer");

324  
¡©us
;

329 
»q
->
to_»cv
--;

330 
comm
->
p¢
++;

331 
µ
->
cÚ‹xt
 = 0;

332 
	`ucc_li¡_add_
(&
comm
->
bpoŞ
, &
µ
->
su³r
);

333 
comm
->
Úe_sided
.
po¡ed_»cv
[
µ
->
qp_id
].
po¡ed_»cvs_couÁ
--;

334 } ià(
ag_couÁ”
 > (
»q
->ag_couÁ” % 
ONE_SIDED_MAX_ZCOPY_COLL_COUNTER
)) {

337 
	`ucc_li¡_add_
(&
comm
->
³ndšg_q
, &
µ
->
su³r
);

342 
	`ucc_as£¹
(
comm
->
Úe_sided
.
»lŸb™y_’abËd
);

343 
µ
->
cÚ‹xt
 = 0;

344 
	`ucc_li¡_add_
(&
comm
->
bpoŞ
, &
µ
->
su³r
);

347  
UCC_OK
;

348 
	}
}

351 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_d¿š_»cv_wr
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

352 
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

353 
qp_id
)

355 
ibv_qp_©Œ
 
©Œ
 = {

356 .
qp_¡©e
 = 
IBV_QPS_ERR
,

357 .
pkey_šdex
 = 
ùx
->pkey_index,

358 .
pÜt_num
 = 
ùx
->
ib_pÜt
,

359 .
qkey
 = 
DEF_QKEY


363 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
groups
[
qp_id
].
qp
, &
©Œ
, 
IBV_QP_STATE
)) {

364 
	`_”rÜ
(
comm
->
lib
, "çedØmovmÿ¡ q°tØERR,ƒ¼nØ%d", 
”ºo
);

365  
UCC_ERR_NO_RESOURCE
;

368 
©Œ
.
qp_¡©e
 = 
IBV_QPS_RESET
;

369 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
groups
[
qp_id
].
qp
, &
©Œ
, 
IBV_QP_STATE
)) {

370 
	`_”rÜ
(
comm
->
lib
, "çedØmovmÿ¡ q°tØRESET,ƒ¼nØ%d", 
”ºo
);

371  
UCC_ERR_NO_RESOURCE
;

374 
©Œ
.
qp_¡©e
 = 
IBV_QPS_INIT
;

375 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
groups
[
qp_id
].
qp
, &
©Œ
,

376 
IBV_QP_STATE
 | 
IBV_QP_PKEY_INDEX
 | 
IBV_QP_PORT
 | 
IBV_QP_QKEY
)) {

377 
	`_”rÜ
(
comm
->
lib
, "çedØmovmÿ¡ q°tØINIT,ƒ¼nØ%d", 
”ºo
);

378  
UCC_ERR_NO_RESOURCE
;

381 
©Œ
.
qp_¡©e
 = 
IBV_QPS_RTR
;

382 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
groups
[
qp_id
].
qp
, &
©Œ
, 
IBV_QP_STATE
)) {

383 
	`_”rÜ
(
comm
->
lib
, "çedØmodify QPØRTR,ƒ¼nØ%d", 
”ºo
);

384  
UCC_ERR_NO_RESOURCE
;

387 
©Œ
.
qp_¡©e
 = 
IBV_QPS_RTS
;

388 
©Œ
.
sq_p¢
 = 
DEF_PSN
;

389 ià(
	`ibv_modify_qp
(
comm
->
mÿ¡
.
groups
[
qp_id
].
qp
, &
©Œ
, 
IBV_QP_STATE
 | 
IBV_QP_SQ_PSN
)) {

390 
	`_”rÜ
(
comm
->
lib
, "çedØmodify QPØRTS,ƒ¼nØ%d", 
”ºo
);

391  
UCC_ERR_NO_RESOURCE
;

394 ià(
	`ibv_©ch_mÿ¡
(
comm
->
mÿ¡
.
groups
[
qp_id
].
qp
, &comm->mÿ¡.groups[qp_id].
mgid
,

395 
comm
->
mÿ¡
.
groups
[
qp_id
].
lid
)) {

396 
	`_”rÜ
(
comm
->
lib
, "failedo‡ttach QP %dohe mcast group with mcast_lid %d,ƒrrno %d",

397 
qp_id
, 
comm
->
mÿ¡
.
groups
[qp_id].
lid
, 
”ºo
);

398  
UCC_ERR_NO_RESOURCE
;

401 
	`_Œaû
(
comm
->
lib
, "d¿šed„ecv queuoàQP %d", 
qp_id
);

402  
UCC_OK
;

403 
	}
}

406 
ucc_¡©us_t


407 
	$ucc__mlx5_mÿ¡_»lŸbË_zcİy_p–šed_Úe_sided_g‘
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

408 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

409 *
com¶‘ed
)

411 
ucc__mlx5_mÿ¡_p–šed_ag_scheduË_t
 *
sched
 = 
»q
->
ag_scheduË
;

412 
ucc_¡©us_t
 
¡©us
;

413 
µ_·ck‘
 *
µ
;

414 
µ_·ck‘
 *
Ãxt
;

415 *
¤c_addr
;

416 *
»mÙe_addr
;

417 
ušt32_t
 
rkey
;

418 
ušt32_t
 
lkey
;

419 
size_t
 
size
;

420 
ušt64_t
 
wr
;

421 
rg‘_com¶‘ed
 = 0;

422 
issued
 = 0;

423 
j
;

424 
roÙ
;

425 
qp_id
;

427 
	`ucc_as£¹
(!
comm
->
Úe_sided
.
³ndšg_»ads
);

428 
j
 = 0; j < 
»q
->
cÚcu¼’cy_Ëv–
; j++) {

429 
roÙ
 = 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].root;

432 ià(
comm
->
Úe_sided
.
»cvd_pkts_Œack”
[
roÙ
] =ğ
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
to_»cv
) {

433 
rg‘_com¶‘ed
++;

436 
qp_id
 = 
sched
[
»q
->
¡•
].
´•o¡_buf_İ
[
j
].
group_id
;

437 
¡©us
 = 
	`ucc__mlx5_mÿ¡_d¿š_»cv_wr
(
comm
, comm->
ùx
, 
qp_id
);

438 ià(
UCC_OK
 !ğ
¡©us
) {

439 
	`_”rÜ
(
comm
->
lib
, "uÇbËØd¿šhpo¡ed„ecv w¸Ú q°%d", 
qp_id
);

440  
¡©us
;

442 
	`ucc_li¡_fÜ_—ch_§ã
(
µ
, 
Ãxt
, &
comm
->
Úe_sided
.
po¡ed_»cv
[
qp_id
].
po¡ed_»cv_bufs
,

443 
su³r
) {

445 
	`ucc_li¡_d–
(&
µ
->
su³r
);

446 
µ
->
cÚ‹xt
 = 0;

447 
	`ucc_li¡_add_
(&
comm
->
bpoŞ
, &
µ
->
su³r
);

449 
	`_Œaû
(
comm
->
lib
, "RDMA READ for step %dotal steps %d"

452 
»q
->
¡•
,„eq->
tÙ®_¡•s
,

453 
comm
->
Úe_sided
.
po¡ed_»cv
[
qp_id
].
po¡ed_»cvs_couÁ
,

454 
roÙ
, 
comm
->
Úe_sided
.
»cvd_pkts_Œack”
[root],

455 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
to_»cv
,

456 
»q
->
to_»cv
, 
comm
->
³ndšg_»cv
, 
qp_id
);

458 
comm
->
³ndšg_»cv
 -=

459 
comm
->
Úe_sided
.
po¡ed_»cv
[
qp_id
].
po¡ed_»cvs_couÁ
;

460 
»q
->
to_»cv
 -=

461 
comm
->
Úe_sided
.
po¡ed_»cv
[
qp_id
].
po¡ed_»cvs_couÁ
;

462 
comm
->
Úe_sided
.
»cvd_pkts_Œack”
[
roÙ
] =

463 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
to_»cv
;

464 
comm
->
Úe_sided
.
po¡ed_»cv
[
qp_id
].
po¡ed_»cvs_couÁ
 = 0;

465 
	`ucc_as£¹
(
comm
->
³ndšg_»cv
 >ğ0 && 
»q
->
to_»cv
 >= 0);

469 ià(
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
) {

470 
¤c_addr
 = 
	`PTR_OFFSET
(
»q
->
±r
,„eq->
Ëngth
 * 
roÙ
 +

471 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
off£t
);

473 
	`ucc_as£¹
(
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd
);

474 
¤c_addr
 = 
	`PTR_OFFSET
(
»q
->
½Œ
,„eq->
Ëngth
 * 
roÙ
 +

475 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
off£t
);

477 
»mÙe_addr
 = 
	`PTR_OFFSET
(
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[
roÙ
].remote_addr,

478 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
off£t
);

479 
rkey
 = 
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
[
roÙ
].rkey;

480 
lkey
 = 
»q
->
»cv_mr
->lkey;

481 
size
 = 
sched
[
»q
->
¡•
].
muÉiÿ¡_İ
[
j
].
to_»cv
 * 
comm
->
max_³r_·ck‘
;

482 
wr
 = 
MCAST_AG_RDMA_READ_WR
;

483 
	`ucc_as£¹
(
size
 != 0);

484 
comm
->
Úe_sided
.
³ndšg_»ads
++;

485 
issued
++;

486 
¡©us
 = 
	`ucc__mlx5_Úe_sided_p2p_g‘
(
¤c_addr
, 
»mÙe_addr
, 
size
,

487 
lkey
, 
rkey
, 
roÙ
, 
wr
, 
comm
);

488 ià(
UCC_OK
 !ğ
¡©us
) {

489  
¡©us
;

492 
sched
[
»q
->
¡•
].
num_»cvd
 = sched[»q->¡•].
to_»cv
;

493 ià(
com¶‘ed
) {

494 *
com¶‘ed
 = 
rg‘_com¶‘ed
;

496 ià(
issued
) {

497 
	`_debug
(
comm
->
lib
, "issued %d RDMA READo„emote DATA for step %d. Number of"

499 
»q
->
¡•
, 
issued
, 
rg‘_com¶‘ed
);

501  
UCC_OK
;

502 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_one_sided_progress.h

7 
	~<sys/ty³s.h
>

8 
	~<uni¡d.h
>

9 
	~<sys/sysÿÎ.h
>

10 
	~"_mlx5_mÿ¡.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"_mlx5_mÿ¡_h–³r.h
"

13 
	~"p2p/ucc__mlx5_mÿ¡_p2p.h
"

15 #iâdeà
TL_MLX5_MCAST_ONE_SIDED_PROGRESS_H_


16 
	#TL_MLX5_MCAST_ONE_SIDED_PROGRESS_H_


	)

18 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_´og»ss_Úe_sided_communiÿtiÚ
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

19 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
);

21 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_¡agšg_®lg©h”_»lŸbË_Úe_sided_g‘
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

22 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

23 *
com¶‘ed
);

25 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_´oûss_·ck‘_cŞËùive
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

26 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

27 
µ_·ck‘
* 
µ
, 
cŞl_ty³
);

29 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_»lŸbË_zcİy_p–šed_Úe_sided_g‘
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

30 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

31 *
com¶‘ed
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_one_sided_reliability.c

7 
	~"_mlx5_mÿ¡_Úe_sided_»lŸb™y.h
"

9 
šlše
 
ucc_¡©us_t


10 
	$ucc__mlx5_mÿ¡_Úe_sided_£tup_»lŸb™y_bufãrs
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

12 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

13 
Úe_sided_tÙ®_¦Ùs_size
, 
i
;

17 
comm
->
Úe_sided
.
»cvd_pkts_Œack”
 = 
	`ucc_ÿÎoc
(1, comm->
commsize
 * (
ušt32_t
),

19 ià(!
comm
->
Úe_sided
.
»cvd_pkts_Œack”
) {

20 
	`_”rÜ
(
comm
->
lib
, "unableo malloc for one_sided.recvd_pkts_tracker");

21 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

22 
çed
;

25 
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
 = 
ucc_ÿÎoc


26 (1, 
comm
->
commsize
 * (
ucc__mlx5_mÿ¡_¦Ù_mem_šfo_t
),

28 ià(!
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
) {

29 
	`_”rÜ
(
comm
->
lib
, "unableo malloc for one_sided.sendbuf_memkey_list");

30 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

31 
çed
;

35 
comm
->
Úe_sided
.
¦Ù_size
 = comm->Úe_sided.
»lŸb™y_scheme_msg_th»shŞd


36 + 
ONE_SIDED_SLOTS_INFO_SIZE
;

37 
Úe_sided_tÙ®_¦Ùs_size
 = 
comm
->
Úe_sided
.
¦Ù_size
 *

38 
ONE_SIDED_SLOTS_COUNT
 * ();

39 
comm
->
Úe_sided
.
¦Ùs_bufãr
 = (*)
	`ucc_ÿÎoc
(1, 
Úe_sided_tÙ®_¦Ùs_size
,

41 ià(!
comm
->
Úe_sided
.
¦Ùs_bufãr
) {

42 
	`_”rÜ
(
comm
->
lib
, "unableo malloc for one_sided.slots_buffer");

43 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

44 
çed
;

46 
comm
->
Úe_sided
.
¦Ùs_mr
 = 
	`ibv_»g_mr
(comm->
ùx
->
pd
, comm->Úe_sided.
¦Ùs_bufãr
,

47 
Úe_sided_tÙ®_¦Ùs_size
, 
IBV_ACCESS_LOCAL_WRITE
 |

48 
IBV_ACCESS_REMOTE_READ
 | 
IBV_ACCESS_REMOTE_WRITE
);

49 ià(!
comm
->
Úe_sided
.
¦Ùs_mr
) {

50 
	`_”rÜ
(
comm
->
lib
, "unableo„egister for one_sided.slots_mr");

51 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

52 
çed
;

56 
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
 = (*)
	`ucc_ÿÎoc
(comm->
commsize
, 
ONE_SIDED_SLOTS_INFO_SIZE
,

58 ià(!
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
) {

59 
	`_”rÜ
(
comm
->
lib
, "unableo malloc for one_sided.remote_slot_info");

60 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

61 
çed
;

63 
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo_mr
 = 
	`ibv_»g_mr
(comm->
ùx
->
pd
, comm->Úe_sided.
»mÙe_¦Ù_šfo
,

64 
comm
->
commsize
 * 
ONE_SIDED_SLOTS_INFO_SIZE
,

65 
IBV_ACCESS_REMOTE_WRITE
 | 
IBV_ACCESS_LOCAL_WRITE
 |

66 
IBV_ACCESS_REMOTE_READ
);

67 ià(!
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo_mr
) {

68 
	`_”rÜ
(
comm
->
lib
, "unableo„egister for one_sided.remote_slot_info_mr");

69 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

70 
çed
;

73 
comm
->
Úe_sided
.
šfo
 = 
	`ucc_ÿÎoc
(1, (
ucc__mlx5_Úe_sided_»lŸbË_‹am_šfo_t
) *

74 
comm
->
commsize
, "one_sided.info");

75 ià(!
comm
->
Úe_sided
.
šfo
) {

76 
	`_”rÜ
(
comm
->
lib
, "unableo‡llocate mem for one_sided.info");

77 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

78 
çed
;

81 
¡©us
 = 
	`ucc__mlx5_mÿ¡_ü—‹_rc_qps
(
comm
->
ùx
, comm);

82 ià(
UCC_OK
 !ğ
¡©us
) {

83 
	`_”rÜ
(
comm
->
lib
, "RC qp create failed");

84 
çed
;

89 
comm
->
Úe_sided
.
šfo
[comm->
¿nk
].
¦Ù_mem
.
rkey
 = comm->Úe_sided.
¦Ùs_mr
->rkey;

90 
comm
->
Úe_sided
.
šfo
[comm->
¿nk
].
¦Ù_mem
.
»mÙe_addr
 = (
ušt64_t
)comm->Úe_sided.
¦Ùs_bufãr
;

91 
comm
->
Úe_sided
.
šfo
[comm->
¿nk
].
pÜt_lid
 = comm->
ùx
->port_lid;

92 
i
 = 0; i < 
comm
->
commsize
; i++) {

93 
comm
->
Úe_sided
.
šfo
[comm->
¿nk
].
rc_qp_num
[
i
] = comm->
mÿ¡
.
rc_qp
[i]->
qp_num
;

96  
UCC_OK
;

98 
çed
:

99  
¡©us
;

100 
	}
}

102 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_Úe_sided_ş—nup
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

104 
j
;

106 ià(
comm
->
mÿ¡
.
rc_qp
 !ğ
NULL
) {

107 
j
=0; j<
comm
->
commsize
; j++) {

108 ià(
comm
->
mÿ¡
.
rc_qp
[
j
] !ğ
NULL
 && 
	`ibv_de¡roy_qp
(comm->mcast.rc_qp[j])) {

109 
	`_”rÜ
(
comm
->
lib
, "ibv_destroy_qp failed");

110  
UCC_ERR_NO_RESOURCE
;

112 
comm
->
mÿ¡
.
rc_qp
[
j
] = 
NULL
;

115 
	`ucc_ä“
(
comm
->
mÿ¡
.
rc_qp
);

116 
comm
->
mÿ¡
.
rc_qp
 = 
NULL
;

119 ià(
comm
->
mÿ¡
.
¤q
 !ğ
NULL
 && 
	`ibv_de¡roy_¤q
(comm->mcast.srq)) {

120 
	`_”rÜ
(
comm
->
lib
, "ibv_destroy_srq failed");

121  
UCC_ERR_NO_RESOURCE
;

123 
comm
->
mÿ¡
.
¤q
 = 
NULL
;

125 ià(
comm
->
Úe_sided
.
¦Ùs_mr
) {

126 
	`ibv_d”eg_mr
(
comm
->
Úe_sided
.
¦Ùs_mr
);

127 
comm
->
Úe_sided
.
¦Ùs_mr
 = 0;

130 ià(
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo_mr
) {

131 
	`ibv_d”eg_mr
(
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo_mr
);

132 
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo_mr
 = 0;

135 ià(
comm
->
Úe_sided
.
¦Ùs_bufãr
) {

136 
	`ucc_ä“
(
comm
->
Úe_sided
.
¦Ùs_bufãr
);

137 
comm
->
Úe_sided
.
¦Ùs_bufãr
 = 
NULL
;

140 ià(
comm
->
Úe_sided
.
»cvd_pkts_Œack”
) {

141 
	`ucc_ä“
(
comm
->
Úe_sided
.
»cvd_pkts_Œack”
);

142 
comm
->
Úe_sided
.
»cvd_pkts_Œack”
 = 
NULL
;

145 ià(
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
) {

146 
	`ucc_ä“
(
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
);

147 
comm
->
Úe_sided
.
£ndbuf_memkey_li¡
 = 
NULL
;

150 ià(
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
) {

151 
	`ucc_ä“
(
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
);

152 
comm
->
Úe_sided
.
»mÙe_¦Ù_šfo
 = 
NULL
;

155 ià(
comm
->
Úe_sided
.
šfo
) {

156 
	`ucc_ä“
(
comm
->
Úe_sided
.
šfo
);

157 
comm
->
Úe_sided
.
šfo
 = 
NULL
;

160  
UCC_OK
;

161 
	}
}

163 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_š™
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

165 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

167 ià(!
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

168  
UCC_OK
;

171 ià(
comm
->
commsize
 > 
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
) {

172 
	`_w¬n
(
comm
->
lib
,

174 
comm
->
commsize
, 
ONE_SIDED_RELIABILITY_MAX_TEAM_SIZE
);

175  
UCC_ERR_NOT_SUPPORTED
;

178 
¡©us
 = 
	`ucc__mlx5_mÿ¡_Úe_sided_£tup_»lŸb™y_bufãrs
(
comm
);

179 ià(
¡©us
 !ğ
UCC_OK
) {

180 
	`_”rÜ
(
comm
->
lib
, "setup„eliability„esources failed");

183  
¡©us
;

184 
	}
}

186 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_‹¡
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

188 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

190 ià(!
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

191  
UCC_OK
;

194 ià(
comm
->
Úe_sided
.
»lŸb™y_»q
 =ğ
NULL
) {

195 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`®lg©h”_po¡
(comm->
p2p_ùx
, &(comm->
Úe_sided
.
šfo
[comm->
¿nk
]),

196 
comm
->
Úe_sided
.
šfo
,

197 (
ucc__mlx5_Úe_sided_»lŸbË_‹am_šfo_t
),

198 &
comm
->
Úe_sided
.
»lŸb™y_»q
);

199 ià(
UCC_OK
 !ğ
¡©us
) {

200 
	`_”rÜ
(
comm
->
lib
, "oob‡llgather failed during one-sided„eliability init");

201 
çed
;

205 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(comm->
Úe_sided
.
»lŸb™y_»q
);

206 ià(
UCC_OK
 !ğ
¡©us
) {

207 ià(
¡©us
 < 0) {

208 
	`_”rÜ
(
comm
->
lib
, "one sided config infoƒxchange failed");

209 
çed
;

211  
¡©us
;

215 
¡©us
 = 
	`ucc__mlx5_mÿ¡_modify_rc_qps
(
comm
->
ùx
, comm);

216 ià(
UCC_OK
 !ğ
¡©us
) {

217 
	`_”rÜ
(
comm
->
lib
, "RC qp modify failed");

218 
çed
;

221 
	`_debug
(
comm
->
lib
, "support for‡llgather„eliability isƒnabled");

222 
comm
->
Úe_sided
.
»lŸb™y_»q
 = 
NULL
;

223  
UCC_OK
;

225 
çed
:

226 ià(
UCC_OK
 !ğ
	`ucc__mlx5_mÿ¡_Úe_sided_ş—nup
(
comm
)) {

227 
	`_”rÜ
(
comm
->
lib
, "mcast one-sided„eliability„esource cleanup failed");

230  
¡©us
;

231 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_one_sided_reliability.h

8 
	~"_mlx5.h
"

9 
	~"_mlx5_mÿ¡_cŞl.h
"

10 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

11 
	~"_mlx5_mÿ¡_h–³r.h
"

12 
	~"p2p/ucc__mlx5_mÿ¡_p2p.h
"

13 
	~"mÿ¡/_mlx5_mÿ¡_h–³r.h
"

14 
	~"mÿ¡/_mlx5_mÿ¡_£rviû_cŞl.h
"

17 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_š™
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

19 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_‹¡
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

21 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_Úe_sided_ş—nup
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_progress.c

7 
	~"_mlx5_mÿ¡_´og»ss.h
"

9 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_»cv_com¶‘iÚ
(
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
obj
);

11 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_£nd_com¶‘iÚ
(
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
obj
);

13 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_»lŸb™y_£nd_com¶‘iÚ
(
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
comp_obj
)

15 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = (ucc__mlx5_mÿ¡_cŞl_comm_t*)
comp_obj
->
d©a
[0];

16 
pkt_id
 = 
comp_obj
->
d©a
[2];

17 
·ck‘
 *
p
 = (·ck‘ *)
comp_obj
->
d©a
[1];

18 
ucc_¡©us_t
 
¡©us
;

20 ià(
p
 !ğ
NULL
) {

22 
	`ucc_ä“
(
p
);

25 ià(
pkt_id
 !ğ
UINT_MAX
) {

27 
	`ucc_as£¹
(
comm
->
bÿ¡_comm
.
Çck_»que¡s
 > 0);

28 
	`ucc_as£¹
(
comm
->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].
ty³
 =ğ
MCAST_P2P_NACK_SEND_PENDING
);

29 
comm
->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].
ty³
 = 
MCAST_P2P_ACK
;

30 
comm
->
bÿ¡_comm
.
Çck_»que¡s
--;

31 
¡©us
 = 
comm
->
·¿ms
.
p2p_içû
.
	`»cv_nb
(&comm->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
],

32 (
·ck‘
),

33 
comm
->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].
äom
,

34 
UCC_MEMORY_TYPE_HOST
,

35 
comm
->
p2p_ùx
, 
	`GET_COMPL_OBJ
(comm,

36 
ucc__mlx5_mÿ¡_»cv_com¶‘iÚ
, 
pkt_id
, 
NULL
));

37 ià(
¡©us
 < 0) {

38  
¡©us
;

42 
	`ucc_mpoŞ_put
(
comp_obj
);

44  
UCC_OK
;

45 
	}
}

47 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_»£nd_·ck‘_»lŸbË
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

48 
p2p_pkt_id
)

50 
ušt32_t
 
p¢
 = 
comm
->
bÿ¡_comm
.
p2p_pkt
[
p2p_pkt_id
].psn;

51 
µ_·ck‘
 *
µ
 = 
comm
->
r_wšdow
[
p¢
 % comm->
bÿ¡_comm
.
wsize
];

52 
ucc_¡©us_t
 
¡©us
;

53 
ucc_memÜy_ty³_t
 
mem_ty³
;

55 
	`ucc_as£¹
(
µ
->
p¢
 ==…sn);

56 
	`ucc_as£¹
(
comm
->
bÿ¡_comm
.
p2p_pkt
[
p2p_pkt_id
].
ty³
 =ğ
MCAST_P2P_NEED_NACK_SEND
);

58 
comm
->
bÿ¡_comm
.
p2p_pkt
[
p2p_pkt_id
].
ty³
 = 
MCAST_P2P_NACK_SEND_PENDING
;

60 
	`_Œaû
(
comm
->
lib
, "[comm %d,„ank %d] Send data NACK:o %d,…sn %d, context %ld‚ack_requests %d \n",

61 
comm
->
comm_id
, comm->
¿nk
,

62 
comm
->
bÿ¡_comm
.
p2p_pkt
[
p2p_pkt_id
].
äom
, 
p¢
, 
µ
->
cÚ‹xt
, comm->bÿ¡_comm.
Çck_»que¡s
);

64 ià(
comm
->
cuda_mem_’abËd
) {

65 
mem_ty³
 = 
UCC_MEMORY_TYPE_CUDA
;

67 
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

70 
¡©us
 = 
comm
->
·¿ms
.
p2p_içû
.
	`£nd_nb
((*è(
µ
->
cÚ‹xt
 ?…p->cÚ‹xˆ:…p->
buf
),

71 
µ
->
Ëngth
, 
comm
->
bÿ¡_comm
.
p2p_pkt
[
p2p_pkt_id
].
äom
, 
mem_ty³
,

72 
comm
->
p2p_ùx
, 
	`GET_COMPL_OBJ
(comm,

73 
ucc__mlx5_mÿ¡_»lŸb™y_£nd_com¶‘iÚ
, 
NULL
, 
p2p_pkt_id
));

74 ià(
¡©us
 < 0) {

75  
¡©us
;

78  
UCC_OK
;

79 
	}
}

81 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_check_Çck_»que¡s
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
, 
ušt32_t
 
p¢
)

83 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

84 
i
;

85 
µ_·ck‘
 *
µ
;

87 ià(!
comm
->
bÿ¡_comm
.
Çck_»que¡s
) {

88  
UCC_OK
;

91 ià(
p¢
 !ğ
UINT32_MAX
) {

92 
i
=0; i<
comm
->
bÿ¡_comm
.
chd_n
; i++) {

93 ià(
p¢
 =ğ
comm
->
bÿ¡_comm
.
p2p_pkt
[
i
].psn &&

94 
comm
->
bÿ¡_comm
.
p2p_pkt
[
i
].
ty³
 =ğ
MCAST_P2P_NEED_NACK_SEND
) {

95 
¡©us
 = 
	`ucc__mlx5_mÿ¡_»£nd_·ck‘_»lŸbË
(
comm
, 
i
);

96 ià(
¡©us
 !ğ
UCC_OK
) {

102 
i
=0; i<
comm
->
bÿ¡_comm
.
chd_n
; i++){

103 ià(
comm
->
bÿ¡_comm
.
p2p_pkt
[
i
].
ty³
 =ğ
MCAST_P2P_NEED_NACK_SEND
) {

104 
p¢
 = 
comm
->
bÿ¡_comm
.
p2p_pkt
[
i
].psn;

105 
µ
 = 
comm
->
r_wšdow
[
p¢
 % comm->
bÿ¡_comm
.
wsize
];

106 ià(
p¢
 =ğ
µ
->psn) {

107 
¡©us
 = 
	`ucc__mlx5_mÿ¡_»£nd_·ck‘_»lŸbË
(
comm
, 
i
);

108 ià(
¡©us
 < 0) {

116  
¡©us
;

117 
	}
}

119 
šlše
 
	$ucc__mlx5_mÿ¡_fšd_Çck_p¢
(
ucc__mlx5_mÿ¡_cŞl_comm_t
* 
comm
,

120 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

122 
p¢
 = 
	`ucc_max
(
comm
->
bÿ¡_comm
.
Ï¡_acked
, 
»q
->
¡¬t_p¢
);

123 
max_£¬ch_p¢
 = 
	`ucc_mš
(
»q
->
¡¬t_p¢
 +„eq->
num_·ck‘s
,

124 
comm
->
bÿ¡_comm
.
Ï¡_acked
 + comm->bÿ¡_comm.
wsize
 + 1);

126 ; 
p¢
 < 
max_£¬ch_p¢
;…sn++) {

127 ià(!
	`PSN_RECEIVED
(
p¢
, 
comm
)) {

132 
	`ucc_as£¹
(
p¢
 < 
max_£¬ch_p¢
);

134  
p¢
;

135 
	}
}

137 
šlše
 
ucc_¿nk_t
 
	$ucc__mlx5_mÿ¡_g‘_Çck_·»Á
(
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

139  
»q
->
·»Á
;

140 
	}
}

143 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_»cv_d©a_com¶‘iÚ
(
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
obj
)

145 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

146 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = (ucc__mlx5_mÿ¡_cŞl_comm_ˆ*)
obj
->
d©a
[0];

147 
µ_·ck‘
 *
µ
 = (µ_·ck‘ *)
obj
->
d©a
[1];

148 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
 = (ucc__mlx5_mÿ¡_cŞl_»q_ˆ*)
obj
->
d©a
[2];

149 *
de¡
;

150 
ucc_memÜy_ty³_t
 
d¡_mem_ty³
;

151 
ucc_memÜy_ty³_t
 
¤c_mem_ty³
;

153 
	`_Œaû
(
comm
->
lib
, "[comm %d,„ªk %d] Recved d©¨p¢ %d", comm->
comm_id
, comm->
¿nk
, 
µ
->
p¢
);

155 
de¡
 = 
»q
->
±r
 + 
	`PSN_TO_RECV_OFFSET
(
µ
->
p¢
,„eq, 
comm
);

157 
d¡_mem_ty³
 = 
comm
->
cuda_mem_’abËd
 ? 
UCC_MEMORY_TYPE_CUDA
 : 
UCC_MEMORY_TYPE_HOST
;

158 
¤c_mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

160 
¡©us
 = 
	`ucc_mc_memıy
(
de¡
, (*è
µ
->
buf
,…p->
Ëngth
,

161 
d¡_mem_ty³
, 
¤c_mem_ty³
);

162 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

163 
	`_”rÜ
(
comm
->
lib
, "failedo copy buffer");

164  
¡©us
;

167 
»q
->
to_»cv
--;

168 
comm
->
r_wšdow
[
µ
->
p¢
 % comm->
bÿ¡_comm
.
wsize
] =…p;

170 
¡©us
 = 
	`ucc__mlx5_mÿ¡_check_Çck_»que¡s
(
comm
, 
µ
->
p¢
);

171 ià(
¡©us
 < 0) {

172  
¡©us
;

175 
comm
->
p¢
++;

176 
comm
->
bÿ¡_comm
.
»cv_drİ_·ck‘_š_´og»ss
 = 
çl£
;

178  
¡©us
;

179 
	}
}

181 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_»lŸbË_£nd_NACK
(
ucc__mlx5_mÿ¡_cŞl_comm_t
* 
comm
,

182 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

184 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

185 
ušt32_t
 
p¢
 = 
	`ucc__mlx5_mÿ¡_fšd_Çck_p¢
(
comm
, 
»q
);

186 
µ_·ck‘
 *
µ
;

187 
ucc_¿nk_t
 
·»Á
;

188 
·ck‘
 *
p
;

190 
p
 = 
	`ucc_ÿÎoc
(1, (
·ck‘
));

191 
p
->
ty³
 = 
MCAST_P2P_NACK
;

192 
p
->
p¢
 =…sn;

193 
p
->
äom
 = 
comm
->
¿nk
;

194 
p
->
comm_id
 = 
comm
->comm_id;

196 
·»Á
 = 
	`ucc__mlx5_mÿ¡_g‘_Çck_·»Á
(
»q
);

198 
comm
->
bÿ¡_comm
.
Çcks_couÁ”
++;

200 
¡©us
 = 
comm
->
·¿ms
.
p2p_içû
.
	`£nd_nb
(
p
, (
·ck‘
), 
·»Á
, 
UCC_MEMORY_TYPE_HOST
,

201 
comm
->
p2p_ùx
, 
	`GET_COMPL_OBJ
(comm,

202 
ucc__mlx5_mÿ¡_»lŸb™y_£nd_com¶‘iÚ
, 
p
, 
UINT_MAX
));

203 ià(
¡©us
 < 0) {

204  
¡©us
;

207 
	`_Œaû
(
comm
->
lib
, "[comm %d,„ank %d] Sent NAK :…arent %d,…sn %d",

208 
comm
->
comm_id
, comm->
¿nk
, 
·»Á
, 
p¢
);

211 
µ
 = 
	`ucc__mlx5_mÿ¡_buf_g‘_ä“
(
comm
);

212 ià(
	`ucc_uÆik–y
(
µ
 =ğ
NULL
)) {

213 
	`_”rÜ
(
comm
->
lib
, "failedo get free buffer for NACK");

214  
UCC_ERR_NO_MEMORY
;

216 
µ
->
p¢
 =…sn;

217 
µ
->
Ëngth
 = 
	`PSN_TO_RECV_LEN
Õp->
p¢
, 
»q
, 
comm
);

219 
comm
->
bÿ¡_comm
.
»cv_drİ_·ck‘_š_´og»ss
 = 
Œue
;

221 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
comm
->
cuda_mem_’abËd
 ? 
UCC_MEMORY_TYPE_CUDA
 : 
UCC_MEMORY_TYPE_HOST
;

223 
¡©us
 = 
comm
->
·¿ms
.
p2p_içû
.
	`»cv_nb
((*è
µ
->
buf
,

224 
µ
->
Ëngth
, 
·»Á
, 
mem_ty³
,

225 
comm
->
p2p_ùx
, 
	`GET_COMPL_OBJ
(comm,

226 
ucc__mlx5_mÿ¡_»cv_d©a_com¶‘iÚ
, 
µ
, 
»q
));

227 ià(
¡©us
 < 0) {

228  
¡©us
;

231  
UCC_INPROGRESS
;

232 
	}
}

234 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_»lŸbË_£nd
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

236 
ucc_¿nk_t
 
i
;

237 
ucc_¿nk_t
 
·»Á
;

238 
ucc_¡©us_t
 
¡©us
;

240 
	`_Œaû
(
comm
->
lib
, "comm %p,…sn %d,†ast_acked %d,‚_parent %d",

241 
comm
, comm->
p¢
, comm->
bÿ¡_comm
.
Ï¡_acked
, comm->bÿ¡_comm.
·»Á_n
);

243 
	`ucc_as£¹
(!
comm
->
bÿ¡_comm
.
»lŸbË_š_´og»ss
);

245 
i
=0; i<
comm
->
bÿ¡_comm
.
·»Á_n
; i++) {

246 
·»Á
 = 
comm
->
bÿ¡_comm
.
·»Ás
[
i
];

247 
comm
->
bÿ¡_comm
.
p2p_¥kt
[
i
].
ty³
 = 
MCAST_P2P_ACK
;

248 
comm
->
bÿ¡_comm
.
p2p_¥kt
[
i
].
p¢
 = comm->bÿ¡_comm.
Ï¡_acked
 + comm->bÿ¡_comm.
wsize
;

249 
comm
->
bÿ¡_comm
.
p2p_¥kt
[
i
].
comm_id
 = comm->comm_id;

251 
	`_Œaû
(
comm
->
lib
, "rank %d, Posting SENDo…arent %d,‚_parent %d,…sn %d",

252 
comm
->
¿nk
, 
·»Á
, comm->
bÿ¡_comm
.
·»Á_n
, comm->
p¢
);

254 
¡©us
 = 
comm
->
·¿ms
.
p2p_içû
.
	`£nd_nb
(&comm->
bÿ¡_comm
.
p2p_¥kt
[
i
],

255 (
·ck‘
), 
·»Á
, 
UCC_MEMORY_TYPE_HOST
,

256 
comm
->
p2p_ùx
, 
	`GET_COMPL_OBJ
(comm,

257 
ucc__mlx5_mÿ¡_£nd_com¶‘iÚ
, 
i
, 
NULL
));

258 ià(
¡©us
 < 0) {

259  
¡©us
;

263  
UCC_OK
;

264 
	}
}

266 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_»cv_com¶‘iÚ
(
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
obj
)

268 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = (ucc__mlx5_mÿ¡_cŞl_comm_t*)
obj
->
d©a
[0];

269 
pkt_id
 = ()
obj
->
d©a
[1];

270 
ušt32_t
 
p¢
;

271 
µ_·ck‘
 *
µ
;

272 
ucc_¡©us_t
 
¡©us
;

274 
	`ucc_as£¹
(
comm
->
comm_id
 =ğcomm->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].comm_id);

276 ià(
comm
->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].
ty³
 !ğ
MCAST_P2P_ACK
) {

277 
	`ucc_as£¹
(
comm
->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].
ty³
 =ğ
MCAST_P2P_NACK
);

278 
p¢
 = 
comm
->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].psn;

279 
µ
 = 
comm
->
r_wšdow
[
p¢
 % comm->
bÿ¡_comm
.
wsize
];

281 
	`_Œaû
(
comm
->
lib
, "[comm %d,„ank %d] Got NACK: from %d,…sn %d,‡vail %d…kt_id %d",

282 
comm
->
comm_id
, comm->
¿nk
,

283 
comm
->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].
äom
, 
p¢
, 
µ
->psn ==…sn,…kt_id);

285 
comm
->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].
ty³
 = 
MCAST_P2P_NEED_NACK_SEND
;

286 
comm
->
bÿ¡_comm
.
Çck_»que¡s
++;

288 ià(
µ
->
p¢
 ==…sn) {

290 
¡©us
 = 
	`ucc__mlx5_mÿ¡_»£nd_·ck‘_»lŸbË
(
comm
, 
pkt_id
);

291 ià(
¡©us
 !ğ
UCC_OK
) {

292  
¡©us
;

297 
	`ucc_as£¹
(
comm
->
bÿ¡_comm
.
p2p_pkt
[
pkt_id
].
ty³
 =ğ
MCAST_P2P_ACK
);

298 
comm
->
bÿ¡_comm
.
¿cks_n
++;

301 
	`ucc_mpoŞ_put
(
obj
);

303  
UCC_OK
;

304 
	}
}

306 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£nd_com¶‘iÚ
(
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
obj
)

308 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = (ucc__mlx5_mÿ¡_cŞl_comm_t*)
obj
->
d©a
[0];

310 
comm
->
bÿ¡_comm
.
§cks_n
++;

311 
	`ucc_mpoŞ_put
(
obj
);

312  
UCC_OK
;

313 
	}
}

315 
šlše
 
	$add_uniq
(
ucc_¿nk_t
 *
¬r
, 
ušt32_t
 *
Ën
, ucc_¿nk_ˆ
v®ue
)

317 
i
;

319 
i
=0; i<(*
Ën
); i++) {

320 ià(
¬r
[
i
] =ğ
v®ue
) {

325 
¬r
[*
Ën
] = 
v®ue
;

326 (*
Ën
)++;

328 
	}
}

330 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_´•¬e_»lŸbË
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

331 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

332 
ucc_¿nk_t
 
roÙ
)

334 
ucc_¿nk_t
 
mask
 = 1;

335 
ucc_¿nk_t
 
v¿nk
 = 
	`TO_VIRTUAL
(
comm
->
¿nk
, comm->
commsize
, 
roÙ
);

336 
ucc_¿nk_t
 
chd
;

337 
ucc_¡©us_t
 
¡©us
;

339 
	`ucc_as£¹
(
comm
->
commsize
 <ğ
	`pow
(2, 
MAX_COMM_POW2
));

341 
mask
 < 
comm
->
commsize
) {

342 ià(
v¿nk
 & 
mask
) {

343 
»q
->
·»Á
 = 
	`TO_ORIGINAL
((
v¿nk
 ^ 
mask
), 
comm
->
commsize
, 
roÙ
);

344 
	`add_uniq
(
comm
->
bÿ¡_comm
.
·»Ás
, &comm->bÿ¡_comm.
·»Á_n
, 
»q
->
·»Á
);

347 
chd
 = 
v¿nk
 ^ 
mask
;

348 ià(
chd
 < 
comm
->
commsize
) {

349 
chd
 = 
	`TO_ORIGINAL
(chd, 
comm
->
commsize
, 
roÙ
);

350 ià(
	`add_uniq
(
comm
->
bÿ¡_comm
.
chd»n
, &comm->bÿ¡_comm.
chd_n
, 
chd
)) {

351 
	`_Œaû
(
comm
->
lib
, "rank %d, Posting RECV from child %d,‚_child %d,…sn %d",

352 
comm
->
¿nk
, 
chd
, comm->
bÿ¡_comm
.
chd_n
, comm->
p¢
);

354 
¡©us
 = 
comm
->
·¿ms
.
p2p_içû
.
	`»cv_nb
(&comm->
bÿ¡_comm
.
p2p_pkt
[comm->bÿ¡_comm.
chd_n
 - 1],

355 (
·ck‘
), 
chd
,

356 
UCC_MEMORY_TYPE_HOST
,

357 
comm
->
p2p_ùx
, 
	`GET_COMPL_OBJ
(comm,

358 
ucc__mlx5_mÿ¡_»cv_com¶‘iÚ
,

359 
comm
->
bÿ¡_comm
.
chd_n
 - 1, 
»q
));

360 ià(
¡©us
 < 0) {

361  
¡©us
;

367 
mask
 <<= 1;

370  
UCC_OK
;

371 
	}
}

373 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_bÿ¡_check_drİ
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

374 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
)

376 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

378 ià(
comm
->
tim”
 == 0) {

379 
comm
->
tim”
 = 
	`ucc__mlx5_mÿ¡_g‘_tim”
();

381 ià(
	`ucc__mlx5_mÿ¡_g‘_tim”
(è- 
comm
->
tim”
 >ğcomm->
ùx
->
·¿ms
.
timeout
) {

382 
	`_Œaû
(
comm
->
lib
, "[REL]imouˆ%d", comm->
p¢
);

383 
¡©us
 = 
	`ucc__mlx5_mÿ¡_»lŸbË_£nd_NACK
(
comm
, 
»q
);

384 
comm
->
tim”
 = 0;

388  
¡©us
;

389 
	}
}

391 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_´oûss_·ck‘
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

392 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

393 
µ_·ck‘
* 
µ
)

395 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

396 *
de¡
;

397 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

398 
ucc_“_executÜ_t
 *
exec
;

399 
	`ucc_as£¹
(
µ
->
p¢
 >ğ
»q
->
¡¬t_p¢
 &&

400 
µ
->
p¢
 < 
»q
->
¡¬t_p¢
 +„eq->
num_·ck‘s
);

402 
	`ucc_as£¹
(
µ
->
Ëngth
 =ğ
	`PSN_TO_RECV_LEN
Õp->
p¢
, 
»q
, 
comm
));

403 
	`ucc_as£¹
(
µ
->
cÚ‹xt
 == 0);

405 ià(
µ
->
Ëngth
 > 0 ) {

406 
de¡
 = 
»q
->
±r
 + 
	`PSN_TO_RECV_OFFSET
(
µ
->
p¢
,„eq, 
comm
);

407 
»q
->
exec_sk
 !ğ
NULL
) {

408 
	`EXEC_TASK_TEST
("çedØcom¶‘thnb memıy", 
»q
->
exec_sk
, 
comm
->
lib
);

412 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(
»q
->
cŞl_sk
, &
exec
);

413 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

414  
¡©us
;

417 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

418 
—rgs
.
cİy
.
¤c
 = (*è
µ
->
buf
;

419 
—rgs
.
cİy
.
d¡
 = 
de¡
;

420 
—rgs
.
cİy
.
Ën
 = 
µ
->
Ëngth
;

422 
	`as£¹
(
»q
->
exec_sk
 =ğ
NULL
);

423 
¡©us
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
, &
»q
->
exec_sk
);

424 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

425  
¡©us
;

428 ià(
»q
->
exec_sk
 !ğ
NULL
) {

429 
	`EXEC_TASK_TEST
("çedØ´og»s thmemıy", 
»q
->
exec_sk
, 
comm
->
lib
);

433 
comm
->
r_wšdow
[
µ
->
p¢
 & (comm->
bÿ¡_comm
.
wsize
-1)] =…p;

434 
¡©us
 = 
	`ucc__mlx5_mÿ¡_check_Çck_»que¡s
(
comm
, 
µ
->
p¢
);

435 ià(
¡©us
 < 0) {

436  
¡©us
;

439 
»q
->
to_»cv
--;

440 
comm
->
p¢
++;

441 
	`ucc_as£¹
(
comm
->
bÿ¡_comm
.
»cv_drİ_·ck‘_š_´og»ss
 =ğ
çl£
);

443  
¡©us
;

444 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_progress.h

7 
	~"_mlx5_mÿ¡.h
"

8 
	~"_mlx5_mÿ¡_h–³r.h
"

10 #iâdeà
TL_MLX5_MCAST_PROGRESS_H_


11 
	#TL_MLX5_MCAST_PROGRESS_H_


	)

13 
	#TO_VIRTUAL
(
_¿nk
, 
_size
, 
_roÙ
è((_¿nk + _siz- _roÙè% _size)

	)

15 
	#TO_ORIGINAL
(
_¿nk
, 
_size
, 
_roÙ
è((_¿nk + _roÙè% _size)

	)

17 
	#ACK
 1

	)

19 
	#GET_COMPL_OBJ
(
_comm
, 
_com¶_â
, 
_pkt_id
, 
_»q
) \

21 * 
™em
; \

22 
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *
obj
; \

23 
™em
 = 
	`ucc_mpoŞ_g‘
(&(
_comm
)->
ùx
->
com¶_objeùs_mp
); \

24 
obj
 = (
ucc__mlx5_mÿ¡_p2p_com¶‘iÚ_obj_t
 *)
™em
; \

26 
obj
->
d©a
[0] = (
ušŒ_t
)
_comm
; \

27 
obj
->
com¶_cb
 = 
_com¶_â
; \

28 
obj
->
d©a
[1] = (
ušŒ_t
)
_pkt_id
; \

29 
obj
->
d©a
[2] = (
ušŒ_t
)
_»q
; \

30 
obj
; \

31 })

	)

33 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_´•¬e_»lŸbË
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

34 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

35 
ucc_¿nk_t
 
roÙ
);

37 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_bÿ¡_check_drİ
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

38 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
);

40 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_´oûss_·ck‘
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

41 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
,

42 
µ_·ck‘
* 
µ
);

44 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_check_Çck_»que¡s
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
,

45 
ušt32_t
 
p¢
);

47 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_»lŸbË_£nd
(
ucc__mlx5_mÿ¡_cŞl_comm_t
* 
comm
);

49 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_check_Çck_»que¡s
(
ucc__mlx5_mÿ¡_cŞl_comm_t
* 
comm
, 
ušt32_t
 
p¢
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_rcache.c

7 
	~"_mlx5_mÿ¡_rÿche.h
"

9 
ucs_¡©us_t
 
	$ucc__mlx5_mÿ¡_cŞl_»g_mr
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t


10 *
ùx
, *
d©a
, 
size_t
 
d©a_size
,

11 **
mr
)

13 *
mr
 = 
	`ibv_»g_mr
(
ùx
->
pd
, 
d©a
, 
d©a_size
, 
IBV_ACCESS_LOCAL_WRITE
 |

14 
IBV_ACCESS_REMOTE_READ
 | 
IBV_ACCESS_REMOTE_WRITE
);

16 
	`_Œaû
(
ùx
->
lib
, "external memory„egister:…tr %p,†en %zd, mr %p",

17 
d©a
, 
d©a_size
, (*
mr
));

18 ià(!*
mr
) {

19 
	`_”rÜ
(
ùx
->
lib
, "failedo„egister MR");

20  
UCS_ERR_NO_MEMORY
;

23  
UCS_OK
;

24 
	}
}

27 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_cŞl_d”eg_mr
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t


28 *
ùx
, *
mr
)

30 ià(
	`ucc_uÆik–y
(
NULL
 =ğ
mr
)) {

31 
	`_debug
(
ùx
->
lib
, "ex‹º® memÜy m¸%°®»ady d”egi¡”ed", 
mr
);

32  
UCC_OK
;

35 
	`_Œaû
(
ùx
->
lib
, "ex‹º® memÜy d”egi¡”: m¸%p", 
mr
);

37 ià(
	`ibv_d”eg_mr
(
mr
)) {

38 
	`_”rÜ
(
ùx
->
lib
, "couldn'ˆde¡roy m¸%p", 
mr
);

39  
UCC_ERR_NO_RESOURCE
;

42  
UCC_OK
;

43 
	}
}

45 
ucs_¡©us_t


46 
	$ucc__mlx5_mÿ¡_rÿche_mem_»g_cb
(*
cÚ‹xt
, 
ucs_rÿche_t
 *
rÿche
,

47 *
¬g
, 
ucs_rÿche_»giÚ_t
 *
¼egiÚ
,

48 
ušt16_t
 
æags
)

50 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
 *
»giÚ
;

51 *
add»ss
;

52 
size_t
 
Ëngth
;

54 
add»ss
 = (*)
¼egiÚ
->
su³r
.
¡¬t
;

55 
Ëngth
 = (
size_t
)(
¼egiÚ
->
su³r
.
’d
 -„»giÚ->su³r.
¡¬t
);

56 
»giÚ
 = 
	`ucc_d”ived_of
(
¼egiÚ
, 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
);

58  
	`ucc__mlx5_mÿ¡_cŞl_»g_mr
((
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *)
cÚ‹xt
,

59 
add»ss
, 
Ëngth
, &
»giÚ
->
»g
.
mr
);

60 
	}
}

62 
	$ucc__mlx5_mÿ¡_rÿche_mem_d”eg_cb
(*
cÚ‹xt
, 
ucc_rÿche_t


63 *
rÿche
, 
ucc_rÿche_»giÚ_t
 *
¼egiÚ
)

65 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
 *
»giÚ
 = 
	`ucc_d”ived_of
(
¼egiÚ
,

66 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
);

68 
	`ucc__mlx5_mÿ¡_cŞl_d”eg_mr
((
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *)
cÚ‹xt
,

69 
»giÚ
->
»g
.
mr
);

70 
	}
}

72 
	$ucc__mlx5_mÿ¡_rÿche_dump_»giÚ_cb
(*
cÚ‹xt
,

73 
ucc_rÿche_t
 *
rÿche
,

74 
ucc_rÿche_»giÚ_t
 *
¼egiÚ
,

75 *
buf
,

76 
size_t
 
max
)

78 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
 *
»giÚ
 = 
	`ucc_d”ived_of
(
¼egiÚ
,

79 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
);

81 
	`¢´štf
(
buf
, 
max
, "b¬…Œ:%p", 
»giÚ
->
»g
.
mr
);

82 
	}
}

84 
ucc_¡©us_t


85 
	$ucc__mlx5_mÿ¡_mem_»gi¡”
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

86 *
addr
, 
size_t
 
Ëngth
,

87 
ucc__mlx5_mÿ¡_»g_t
 **
»g
)

89 
ucc_rÿche_»giÚ_t
 *
¼egiÚ
;

90 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
 *
»giÚ
;

91 
ucc_¡©us_t
 
¡©us
;

92 
ucc_rÿche_t
 *
rÿche
;

94 
rÿche
 = 
ùx
->rcache;

96 
	`ucc_as£¹
(
rÿche
 !ğ
NULL
);

98 
¡©us
 = 
	`ucc_rÿche_g‘
(
rÿche
, (*)
addr
, 
Ëngth
, 
NULL
, &
¼egiÚ
);

99 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

100 
	`_”rÜ
(
ùx
->
lib
, "ucc_rcache_get failed");

101  
¡©us
;

104 
»giÚ
 = 
	`ucc_d”ived_of
(
¼egiÚ
, 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
);

105 *
»g
 = &
»giÚ
->reg;

107 
	`_Œaû
(
ùx
->
lib
, "memÜy„egi¡” m¸%p", (*
»g
)->
mr
);

109  
UCC_OK
;

110 
	}
}

112 
	$ucc__mlx5_mÿ¡_mem_d”egi¡”
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

113 
ucc__mlx5_mÿ¡_»g_t
 *
»g
)

115 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
 *
»giÚ
;

116 
ucc_rÿche_t
 *
rÿche
;

118 
rÿche
 = 
ùx
->rcache;

120 ià(
»g
 =ğ
NULL
) {

124 
	`ucc_as£¹
(
rÿche
 !ğ
NULL
);

125 
	`_Œaû
(
ùx
->
lib
, "memÜy d”egi¡” m¸%p", 
»g
->
mr
);

126 
»giÚ
 = 
	`ucc_cÚš”_of
(
»g
, 
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
,„eg);

127 
	`ucc_rÿche_»giÚ_put
(
rÿche
, &
»giÚ
->
su³r
);

128 
	}
}

130 
ucc_rÿche_İs_t
 
	gucc__mlx5_rÿche_İs
 = {

131 .
mem_»g
 = 
ucc__mlx5_mÿ¡_rÿche_mem_»g_cb
,

132 .
	gmem_d”eg
 = 
ucc__mlx5_mÿ¡_rÿche_mem_d”eg_cb
,

133 .
	gdump_»giÚ
 = 
ucc__mlx5_mÿ¡_rÿche_dump_»giÚ_cb
,

134 #ifdeà
UCS_HAVE_RCACHE_MERGE_CB


135 .
	gm”ge
 = 
ucc_rÿche_m”ge_cb_em±y


139 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£tup_rÿche
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
)

141 
ucc_rÿche_·¿ms_t
 
rÿche_·¿ms
;

143 
	`ucc_rÿche_£t_deçuÉ_·¿ms
(&
rÿche_·¿ms
);

144 
rÿche_·¿ms
.
»giÚ_¡ruù_size
 = (
ucc__mlx5_mÿ¡_rÿche_»giÚ_t
);

145 
rÿche_·¿ms
.
cÚ‹xt
 = 
ùx
;

146 
rÿche_·¿ms
.
İs
 = &
ucc__mlx5_rÿche_İs
;

147 
rÿche_·¿ms
.
ucm_ev’ts
 = 
UCM_EVENT_VM_UNMAPPED
 |

148 
UCM_EVENT_MEM_TYPE_FREE
;

150  
	`ucc_rÿche_ü—‹
(&
rÿche_·¿ms
, "MLX5_MCAST", &
ùx
->
rÿche
);

151 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_rcache.h

7 
	~"_mlx5_mÿ¡.h
"

8 
	~"uts/ucc_rÿche.h
"

10 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_£tup_rÿche
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
);

12 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_mem_»gi¡”
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t


13 *
ùx
, *
addr
, 
size_t
 
Ëngth
,

14 
ucc__mlx5_mÿ¡_»g_t
 **
»g
);

16 
ucc__mlx5_mÿ¡_mem_d”egi¡”
(
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
ùx
,

17 
ucc__mlx5_mÿ¡_»g_t
 *
»g
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_service_coll.c

7 
	~"mÿ¡/_mlx5_mÿ¡_£rviû_cŞl.h
"

8 
	~"cÜe/ucc_£rviû_cŞl.h
"

10 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£rviû_bÿ¡_po¡
(*
¬g
, *
buf
, 
size_t
 
size
, 
ucc_¿nk_t
 
roÙ
,

11 
ucc_£rviû_cŞl_»q_t
 **
bÿ¡_»q
)

13 
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
 *
ùx
 = (ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_ˆ*)
¬g
;

14 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

15 
ucc_‹am_t
 *
‹am
 = 
ùx
->
ba£_‹am
;

16 
ucc_sub£t_t
 
sub£t
 = 
ùx
->subset;

17 
ucc_£rviû_cŞl_»q_t
 *
»q
 = 
NULL
;

19 
¡©us
 = 
	`ucc_£rviû_bÿ¡
(
‹am
, 
buf
, 
size
, 
roÙ
, 
sub£t
, &
»q
);

20 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

21 
	`_”rÜ
(
ùx
->
ba£_ùx
->
lib
, "tl service mcast bcast failed");

22  
¡©us
;

25 *
bÿ¡_»q
 = 
»q
;

27  
¡©us
;

28 
	}
}

30 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£rviû_®lg©h”_po¡
(*
¬g
, *
sbuf
, *
rbuf
, 
size_t
 
size
,

31 
ucc_£rviû_cŞl_»q_t
 **
ag_»q
)

33 
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
 *
ùx
 = (ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_ˆ*)
¬g
;

34 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

35 
ucc_‹am_t
 *
‹am
 = 
ùx
->
ba£_‹am
;

36 
ucc_sub£t_t
 
sub£t
 = 
ùx
->subset;

37 
ucc_£rviû_cŞl_»q_t
 *
»q
 = 
NULL
;

39 
¡©us
 = 
	`ucc_£rviû_®lg©h”
(
‹am
, 
sbuf
, 
rbuf
, 
size
, 
sub£t
, &
»q
);

40 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

41 
	`_”rÜ
(
ùx
->
ba£_ùx
->
lib
, "tl service mcast‡llgather failed");

42  
¡©us
;

45 *
ag_»q
 = 
»q
;

47  
¡©us
;

48 
	}
}

50 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£rviû_b¬r›r_po¡
(*
¬g
, 
ucc_£rviû_cŞl_»q_t
 **
b¬r›r_»q
)

52 
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
 *
ùx
 = (ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_ˆ*)
¬g
;

53 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

54 
ucc_‹am_t
 *
‹am
 = 
ùx
->
ba£_‹am
;

55 
ucc_sub£t_t
 
sub£t
 = 
ùx
->subset;

56 
ucc_£rviû_cŞl_»q_t
 *
»q
 = 
NULL
;

57 
ùx
->
tmp_sbuf
 = 0;

58 
ùx
->
tmp_rbuf
 = 0;

60 
¡©us
 = 
	`ucc_£rviû_®Ìeduû
(
‹am
, &
ùx
->
tmp_sbuf
, &ùx->
tmp_rbuf
, 
UCC_DT_INT8
, 1,

61 
UCC_OP_SUM
, 
sub£t
, &
»q
);

62 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

63 
	`_”rÜ
(
ùx
->
ba£_ùx
->
lib
, "tl service mcast barrier failed");

64  
¡©us
;

67 *
b¬r›r_»q
 = 
»q
;

69  
¡©us
;

70 
	}
}

72 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£rviû_®Ìeduû_po¡
(*
¬g
, *
£ndbuf
, *
»cvbuf
,

73 
size_t
 
couÁ
, 
ucc_d©©y³_t
 
dt
,

74 
ucc_»duùiÚ_İ_t
 
İ
,

75 
ucc_£rviû_cŞl_»q_t
 **
®Ìed_»q
)

77 
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
 *
ùx
 = (ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_ˆ*)
¬g
;

78 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

79 
ucc_‹am_t
 *
‹am
 = 
ùx
->
ba£_‹am
;

80 
ucc_sub£t_t
 
sub£t
 = 
ùx
->subset;

81 
ucc_£rviû_cŞl_»q_t
 *
»q
 = 
NULL
;

83 
¡©us
 = 
	`ucc_£rviû_®Ìeduû
(
‹am
, 
£ndbuf
, 
»cvbuf
, 
dt
, 
couÁ
, 
İ
, 
sub£t
, &
»q
);

84 ià(
UCC_OK
 !ğ
¡©us
) {

85 
	`_”rÜ
(
ùx
->
ba£_ùx
->
lib
, "tl service mcast‡llreduce failed");

86  
¡©us
;

88 *
®Ìed_»q
 = 
»q
;

89  
¡©us
;

90 
	}
}

92 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_£rviû_cŞl_‹¡
(
ucc_£rviû_cŞl_»q_t
 *
»q
)

94 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

96 
¡©us
 = 
	`ucc_cŞËùive_‹¡
(&
»q
->
sk
->
su³r
);

97 ià(
UCC_INPROGRESS
 !ğ
¡©us
) {

98 ià(
¡©us
 < 0) {

99 
	`ucc_”rÜ
("oob service coll…rogress failed");

101 
	`ucc_£rviû_cŞl_fš®ize
(
»q
);

104  
¡©us
;

105 
	}
}

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_service_coll.h

7 
	~"_mlx5_mÿ¡_cŞl.h
"

9 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_£rviû_bÿ¡_po¡
(*
¬g
, *
buf
, 
size_t
 
size
, 
ucc_¿nk_t
 
roÙ
,

10 
ucc_£rviû_cŞl_»q_t
 **
bÿ¡_»q
);

12 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_£rviû_®lg©h”_po¡
(*
¬g
, *
sbuf
, *
rbuf
, 
size_t
 
size
,

13 
ucc_£rviû_cŞl_»q_t
 **
ag_»q
);

15 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_£rviû_b¬r›r_po¡
(*
¬g
, 
ucc_£rviû_cŞl_»q_t
 **
b¬r›r_»q
);

17 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_£rviû_®Ìeduû_po¡
(*
¬g
, *
sbuf
, *
rbuf
,

18 
size_t
 
couÁ
, 
ucc_d©©y³_t
 
dt
,

19 
ucc_»duùiÚ_İ_t
 
İ
,

20 
ucc_£rviû_cŞl_»q_t
 **
»d_»q
);

22 
ucc_¡©us_t
 
ucc__mlx5_mÿ¡_£rviû_cŞl_‹¡
(
ucc_£rviû_cŞl_»q_t
 *
»q
);

	@src/components/tl/mlx5/mcast/tl_mlx5_mcast_team.c

8 
	~"_mlx5.h
"

9 
	~"_mlx5_mÿ¡_cŞl.h
"

10 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

11 
	~"_mlx5_mÿ¡_h–³r.h
"

12 
	~"p2p/ucc__mlx5_mÿ¡_p2p.h
"

13 
	~"mÿ¡/_mlx5_mÿ¡_h–³r.h
"

14 
	~"mÿ¡/_mlx5_mÿ¡_£rviû_cŞl.h
"

15 
	~"mÿ¡/_mlx5_mÿ¡_Úe_sided_»lŸb™y.h
"

17 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_‹am_š™
(
ucc_ba£_cÚ‹xt_t
 *
ba£_cÚ‹xt
,

18 
ucc__mlx5_mÿ¡_‹am_t
 **
mÿ¡_‹am
,

19 
ucc__mlx5_mÿ¡_cÚ‹xt_t
 *
ùx
,

20 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
‹am_·¿ms
,

21 
ucc__mlx5_mÿ¡_cŞl_comm_š™_¥ec_t
 *
mÿ¡_cÚf
)

23 
ucc__mlx5_mÿ¡_cŞl_comm_š™_¥ec_t
 
comm_¥ec
 = *
mÿ¡_cÚf
;

24 
ucc__mlx5_mÿ¡_cŞl_cÚ‹xt_t
 *
mÿ¡_cÚ‹xt
 = &(
ùx
->mcast_context);

25 
ucc__mlx5_mÿ¡_cŞl_comm_š™_¥ec_t
 *
cÚf_·¿ms
 = &
comm_¥ec
;

26 
ucc_cÚ‹xt_t
 *
cÚ‹xt
 = 
ba£_cÚ‹xt
->
ucc_cÚ‹xt
;

27 
ucc__mlx5_cÚ‹xt_t
 *
_ùx
 = 
	`ucc_d”ived_of
(
ba£_cÚ‹xt
,

28 
ucc__mlx5_cÚ‹xt_t
);

29 
ucc_¡©us_t
 
¡©us
;

30 
ucc_sub£t_t
 
£t
;

31 
ucc__mlx5_mÿ¡_‹am_t
 *
Ãw_mÿ¡_‹am
;

32 
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
 *
oob_p2p_ùx
;

33 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
;

34 
i
;

36 ià(!
ùx
->
mÿ¡_ùx_»ady
) {

37 
	`_debug
(
ba£_cÚ‹xt
->
lib
,

39 
ba£_cÚ‹xt
 );

40  
UCC_ERR_NO_RESOURCE
;

44 ià(!
mÿ¡_cÚ‹xt
->
ùx
 || !mÿ¡_cÚ‹xt->
pd
) {

45 
	`_mlx5_mÿ¡_log
(
ùx
->
mÿ¡_’abËd
, 
ba£_cÚ‹xt
->
lib
, 
UCC_LOG_LEVEL_WARN
,

47  
UCC_ERR_NO_RESOURCE
;

50 
Ãw_mÿ¡_‹am
 = 
	`ucc_ÿÎoc
(1, (
ucc__mlx5_mÿ¡_‹am_t
), "new_mcast_team");

52 ià(!
Ãw_mÿ¡_‹am
) {

53  
UCC_ERR_NO_MEMORY
;

56 
Ãw_mÿ¡_‹am
->
mÿ¡_cÚ‹xt
 = 
ùx
;

59 
cÚf_·¿ms
->
p2p_içû
.
£nd_nb
 = 
ucc__mlx5_mÿ¡_p2p_£nd_nb
;

60 
cÚf_·¿ms
->
p2p_içû
.
»cv_nb
 = 
ucc__mlx5_mÿ¡_p2p_»cv_nb
;

62 
oob_p2p_ùx
 = 
	`ucc_m®loc
((
ucc__mlx5_mÿ¡_oob_p2p_cÚ‹xt_t
),

64 ià(!
oob_p2p_ùx
) {

65 
	`ucc_ä“
(
Ãw_mÿ¡_‹am
);

66  
UCC_ERR_NO_MEMORY
;

69 
oob_p2p_ùx
->
ba£_ùx
 = 
cÚ‹xt
;

70 
oob_p2p_ùx
->
ba£_‹am
 = 
‹am_·¿ms
->
‹am
;

71 
oob_p2p_ùx
->
my_‹am_¿nk
 = 
‹am_·¿ms
->
¿nk
;

72 
oob_p2p_ùx
->
lib
 = 
mÿ¡_cÚ‹xt
->lib;

73 
£t
.
my¿nk
 = 
‹am_·¿ms
->
¿nk
;

74 
£t
.
m­
 = 
‹am_·¿ms
->map;

75 
oob_p2p_ùx
->
sub£t
 = 
£t
;

76 
cÚf_·¿ms
->
oob
 = 
oob_p2p_ùx
;

77 
cÚf_·¿ms
->
sx_sge
 = 1;

78 
cÚf_·¿ms
->
rx_sge
 = 2;

79 
cÚf_·¿ms
->
scq_mod”©iÚ
 = 64;

81 
comm
 = (
ucc__mlx5_mÿ¡_cŞl_comm_t
*)

82 
	`ucc_ÿÎoc
(1, (
ucc__mlx5_mÿ¡_cŞl_comm_t
) +

83 (
µ_·ck‘
*)*(
cÚf_·¿ms
->
wsize
-1),

85 ià(!
comm
) {

86 
	`ucc_ä“
(
oob_p2p_ùx
);

87 
	`ucc_ä“
(
Ãw_mÿ¡_‹am
);

88  
UCC_ERR_NO_MEMORY
;

92 
comm
->
hÿ_cİy_cq
 = 
NULL
;

93 
comm
->
hÿ_cİy_qp
 = 
NULL
;

95 
	`ucc_li¡_h—d_š™
(&
comm
->
bpoŞ
);

96 
	`ucc_li¡_h—d_š™
(&
comm
->
³ndšg_q
);

98 
comm
->
£rviû_cŞl
.
bÿ¡_po¡
 = 
ucc__mlx5_mÿ¡_£rviû_bÿ¡_po¡
;

99 
comm
->
£rviû_cŞl
.
®lg©h”_po¡
 = 
ucc__mlx5_mÿ¡_£rviû_®lg©h”_po¡
;

100 
comm
->
£rviû_cŞl
.
®Ìeduû_po¡
 = 
ucc__mlx5_mÿ¡_£rviû_®Ìeduû_po¡
;

101 
comm
->
£rviû_cŞl
.
b¬r›r_po¡
 = 
ucc__mlx5_mÿ¡_£rviû_b¬r›r_po¡
;

102 
comm
->
£rviû_cŞl
.
cŞl_‹¡
 = 
ucc__mlx5_mÿ¡_£rviû_cŞl_‹¡
;

104 
	`memıy
(&
comm
->
·¿ms
, 
cÚf_·¿ms
, (*conf_params));

106 
comm
->
Úe_sided
.
»lŸb™y_’abËd
 = 
cÚf_·¿ms
->
Úe_sided_»lŸb™y_’abË
;

107 
comm
->
Úe_sided
.
»lŸb™y_scheme_msg_th»shŞd


108 ğ
cÚf_·¿ms
->
»lŸb™y_scheme_msg_th»shŞd
;

109 
comm
->
Úe_sided
.
hÿ_cİy_’abËd
 = 
cÚf_·¿ms
->hca_copy_enabled;

110 
comm
->
max_—g”
 = 
cÚf_·¿ms
->max_eager;

111 
comm
->
Œuly_z”o_cİy_cŞl_mš_msg
 = 
cÚf_·¿ms
->truly_zero_copy_coll_min_msg;

112 
comm
->
cuda_mem_’abËd
 = 
cÚf_·¿ms
->cuda_mem_enabled;

113 
comm
->
comm_id
 = 
‹am_·¿ms
->
id
;

114 
comm
->
ùx
 = 
mÿ¡_cÚ‹xt
;

115 
comm
->
cÚ‹xt
 = 
ùx
;

116 
comm
->
mÿ¡_group_couÁ
 = 
	`ucc_mš
(
cÚf_·¿ms
->mÿ¡_group_couÁ, 
MAX_GROUP_COUNT
);

119 ià(
ùx
->
mÿ¡_bÿ¡_’abËd
) {

120 
comm
->
bÿ¡_comm
.
mÿ¡_´•o¡_buck‘_size


121 ğ
cÚf_·¿ms
->
mÿ¡_´•o¡_buck‘_size
;

122 
comm
->
bÿ¡_comm
.
wsize
 = 
cÚf_·¿ms
->wsize;

123 
comm
->
bÿ¡_comm
.
max_push_£nd
 = 
cÚf_·¿ms
->max_push_send;

124 
comm
->
bÿ¡_comm
.
Œuly_z”o_cİy_bÿ¡_’abËd
 =

125 
cÚf_·¿ms
->
Œuly_z”o_cİy_bÿ¡_’abËd
;

127 
comm
->
®lg©h”_comm
.
mÿ¡_´•o¡_buck‘_size


128 ğ
cÚf_·¿ms
->
mÿ¡_´•o¡_buck‘_size
;

129 
comm
->
®lg©h”_comm
.
Œuly_z”o_cİy_®lg©h”_’abËd


130 ğ
cÚf_·¿ms
->
Œuly_z”o_cİy_®lg©h”_’abËd
;

131 
comm
->
®lg©h”_comm
.
max_push_£nd
 = 
cÚf_·¿ms
->max_push_send;

134 ià(
comm
->
cuda_mem_’abËd
 && !(
_ùx
->
suµÜ‹d_mem_ty³s
 & 
	`UCC_BIT
(
UCC_MEMORY_TYPE_CUDA
))) {

135 
	`_w¬n
(
mÿ¡_cÚ‹xt
->
lib
, "cuda-aware mcast‚ot‡vailable‡s gpu direct is‚ot„eady");

136 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

137 
ş—nup
;

140 
comm
->
mÿ¡
.
rcq
 = 
	`ibv_ü—‹_cq
(
mÿ¡_cÚ‹xt
->
ùx
, comm->
·¿ms
.
rx_d•th
, 
NULL
, NULL, 0);

141 ià(!
comm
->
mÿ¡
.
rcq
) {

142 
	`_mlx5_mÿ¡_log
(
mÿ¡_cÚ‹xt
->
·¿ms
.
mÿ¡_’abËd
, mÿ¡_cÚ‹xt->
lib
, 
UCC_LOG_LEVEL_ERROR
,

144 
comm
->
·¿ms
.
rx_d•th
, 
”ºo
);

145 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

146 
ş—nup
;

149 
comm
->
mÿ¡
.
scq
 = 
	`ibv_ü—‹_cq
(
mÿ¡_cÚ‹xt
->
ùx
, comm->
·¿ms
.
sx_d•th
, 
NULL
, NULL, 0);

150 ià(!
comm
->
mÿ¡
.
scq
) {

151 
	`ibv_de¡roy_cq
(
comm
->
mÿ¡
.
rcq
);

152 
	`_mlx5_mÿ¡_log
(
mÿ¡_cÚ‹xt
->
·¿ms
.
mÿ¡_’abËd
, mÿ¡_cÚ‹xt->
lib
, 
UCC_LOG_LEVEL_ERROR
,

154 
comm
->
·¿ms
.
sx_d•th
, 
”ºo
);

155 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

156 
ş—nup
;

159 
comm
->
¿nk
 = 
‹am_·¿ms
->rank;

160 
comm
->
commsize
 = 
‹am_·¿ms
->
size
;

161 
comm
->
max_³r_·ck‘
 = 
mÿ¡_cÚ‹xt
->
mtu
;

162 
comm
->
bÿ¡_comm
.
Ï¡_acked
 = comm->bÿ¡_comm.
Ï¡_p¢
 = 0;

163 
comm
->
bÿ¡_comm
.
¿cks_n
 = comm->bÿ¡_comm.
§cks_n
 = 0;

164 
comm
->
bÿ¡_comm
.
chd_n
 = comm->bÿ¡_comm.
·»Á_n
 = 0;

165 
comm
->
p2p_ùx
 = 
cÚf_·¿ms
->
oob
;

167 
	`memıy
(&
comm
->
p2p
, &
cÚf_·¿ms
->
p2p_içû
,

168 (
ucc__mlx5_mÿ¡_p2p_š‹rçû_t
));

170 
comm
->
dummy_·ck‘
.
p¢
 = 
UINT32_MAX
;

172 
i
=0; i< 
comm
->
bÿ¡_comm
.
wsize
; i++) {

173 
comm
->
r_wšdow
[
i
] = &comm->
dummy_·ck‘
;

176 
comm
->
lib
 = 
ba£_cÚ‹xt
->lib;

177 
Ãw_mÿ¡_‹am
->
mÿ¡_comm
 = 
comm
;

179 *
mÿ¡_‹am
 = 
Ãw_mÿ¡_‹am
;

180 
	`_debug
(
ba£_cÚ‹xt
->
lib
, "po¡edÈmÿ¡—m : %p", 
Ãw_mÿ¡_‹am
);

182  
UCC_OK
;

184 
ş—nup
:

185 
	`ucc_ä“
(
comm
);

186 
	`ucc_ä“
(
Ãw_mÿ¡_‹am
);

187 
	`ucc_ä“
(
oob_p2p_ùx
);

188  
¡©us
;

189 
	}
}

191 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_cŞl_£tup_comm_»sourûs
(
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
)

193 
ucc_¡©us_t
 
¡©us
;

194 
size_t
 
·ge_size
;

195 
buf_size
, 
i
, 
»t
;

196 
ucc_memÜy_ty³_t
 
suµÜ‹d_mem_ty³
;

198 
¡©us
 = 
	`ucc__mlx5_mÿ¡_š™_qps
(
comm
->
ùx
, comm);

199 ià(
UCC_OK
 !ğ
¡©us
) {

200 
”rÜ
;

203 
¡©us
 = 
	`ucc__mlx5_mÿ¡_£tup_qps
(
comm
->
ùx
, comm);

204 ià(
UCC_OK
 !ğ
¡©us
) {

205 
”rÜ
;

208 
·ge_size
 = 
	`ucc_g‘_·ge_size
();

209 
buf_size
 = 
comm
->
ùx
->
mtu
;

212 
»t
 = 
	`posix_mem®ign
((**)&
comm
->
ÿÎ_rwr
, 
·ge_size
, (
ibv_»cv_wr
) *

213 
comm
->
·¿ms
.
rx_d•th
);

214 ià(
»t
) {

215 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
, "posix_memalign failed");

216  
UCC_ERR_NO_MEMORY
;

219 
»t
 = 
	`posix_mem®ign
((**)&
comm
->
ÿÎ_rsgs
, 
·ge_size
, (
ibv_sge
) *

220 
comm
->
·¿ms
.
rx_d•th
 * 2);

221 ià(
»t
) {

222 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
, "posix_memalign failed");

223  
UCC_ERR_NO_MEMORY
;

226 
comm
->
³ndšg_»cv
 = 0;

227 
comm
->
buf_n
 = comm->
·¿ms
.
rx_d•th
 * 2;

232 
suµÜ‹d_mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

234 
comm
->
grh_buf
 = 
	`ucc_m®loc
(
GRH_LENGTH
 * (), "grh");

235 ià(
	`ucc_uÆik–y
(!
comm
->
grh_buf
)) {

236 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

238 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

239 
”rÜ
;

242 
¡©us
 = 
	`ucc_mc_mem£t
(
comm
->
grh_buf
, 0, 
GRH_LENGTH
, 
UCC_MEMORY_TYPE_HOST
);

243 ià(
¡©us
 !ğ
UCC_OK
) {

244 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

246 
”rÜ
;

249 
comm
->
grh_mr
 = 
	`ibv_»g_mr
(comm->
ùx
->
pd
, comm->
grh_buf
, 
GRH_LENGTH
,

250 
IBV_ACCESS_REMOTE_WRITE
 | 
IBV_ACCESS_LOCAL_WRITE
);

251 ià(!
comm
->
grh_mr
) {

252 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

253 "could‚Ù„egi¡” deviû memÜy fÜ GRH,ƒ¼nØ%d", 
”ºo
);

254 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

255 
”rÜ
;

258 
¡©us
 = 
	`ucc_mc_®loc
(&
comm
->
µ_buf_h—d”
, 
buf_size
 * comm->
buf_n
, 
suµÜ‹d_mem_ty³
);

259 
comm
->
µ_buf
 = comm->
µ_buf_h—d”
->
addr
;

260 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

261 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

263 
”rÜ
;

266 
¡©us
 = 
	`ucc_mc_mem£t
(
comm
->
µ_buf
, 0, 
buf_size
 * comm->
buf_n
, 
suµÜ‹d_mem_ty³
);

267 ià(
¡©us
 !ğ
UCC_OK
) {

268 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

270 
”rÜ
;

273 
comm
->
µ_mr
 = 
	`ibv_»g_mr
(comm->
ùx
->
pd
, comm->
µ_buf
, 
buf_size
 * comm->
buf_n
,

274 
IBV_ACCESS_REMOTE_WRITE
 | 
IBV_ACCESS_LOCAL_WRITE
);

275 ià(!
comm
->
µ_mr
) {

276 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

277 "could‚Ù„egi¡”…p_buàdeviû mr,ƒ¼nØ%d", 
”ºo
);

278 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

279 
”rÜ
;

282 
»t
 = 
	`posix_mem®ign
((**è&
comm
->
µ
, 
·ge_size
, (

283 
µ_·ck‘
è* 
comm
->
buf_n
);

284 ià(
»t
) {

285 
	`_mlx5_mÿ¡_log
(
comm
->
cÚ‹xt
->
mÿ¡_’abËd
, comm->
lib
, 
UCC_LOG_LEVEL_ERROR
,

287  
UCC_ERR_NO_MEMORY
;

290 
i
 = 0; i < 
comm
->
buf_n
; i++) {

291 
	`ucc_li¡_h—d_š™
(&
comm
->
µ
[
i
].
su³r
);

293 
comm
->
µ
[
i
].
buf
 = (
ušŒ_t
ècomm->
µ_buf
 + i * 
buf_size
;

294 
comm
->
µ
[
i
].
cÚ‹xt
 = 0;

296 
	`ucc_li¡_add_
(&
comm
->
bpoŞ
, &comm->
µ
[
i
].
su³r
);

299 
comm
->
mÿ¡
.
swr
.
num_sge
 = 1;

300 
comm
->
mÿ¡
.
swr
.
sg_li¡
 = &comm->mÿ¡.
ssg
;

301 
comm
->
mÿ¡
.
swr
.
İcode
 = 
IBV_WR_SEND_WITH_IMM
;

302 
comm
->
mÿ¡
.
swr
.
wr
.
ud
.
»mÙe_q²
 = 
MULTICAST_QPN
;

303 
comm
->
mÿ¡
.
swr
.
wr
.
ud
.
»mÙe_qkey
 = 
DEF_QKEY
;

304 
comm
->
mÿ¡
.
swr
.
Ãxt
 = 
NULL
;

306 
i
 = 0; i < 
comm
->
·¿ms
.
rx_d•th
; i++) {

307 
comm
->
ÿÎ_rwr
[
i
].
sg_li¡
 = &comm->
ÿÎ_rsgs
[2 * i];

308 
comm
->
ÿÎ_rwr
[
i
].
num_sge
 = 2;

309 
comm
->
ÿÎ_rwr
[
i
].
wr_id
 = 
MCAST_BCASTRECV_WR
;

310 
comm
->
ÿÎ_rsgs
[2 * 
i
].
Ëngth
 = 
GRH_LENGTH
;

311 
comm
->
ÿÎ_rsgs
[2 * 
i
].
addr
 = (
ušŒ_t
)comm->
grh_buf
;

312 
comm
->
ÿÎ_rsgs
[2 * 
i
].
lkey
 = comm->
grh_mr
->lkey;

313 
comm
->
ÿÎ_rsgs
[2 * 
i
 + 1].
lkey
 = comm->
µ_mr
->lkey;

314 
comm
->
ÿÎ_rsgs
[2 * 
i
 + 1].
Ëngth
 = comm->
max_³r_·ck‘
;

317 
¡©us
 = 
	`ucc__mlx5_mÿ¡_po¡_»cv_bufãrs
(
comm
);

318 ià(
UCC_OK
 !ğ
¡©us
) {

319 
”rÜ
;

322 
	`mem£t
(
comm
->
bÿ¡_comm
.
·»Ás
, 0, (comm->bcast_comm.parents));

323 
	`mem£t
(
comm
->
bÿ¡_comm
.
chd»n
, 0, (comm->bcast_comm.children));

325 
comm
->
bÿ¡_comm
.
Çcks_couÁ”
 = 0;

326 
comm
->
bÿ¡_comm
.
n_mÿ¡_»lŸbË
 = 0;

327 
comm
->
bÿ¡_comm
.
»lŸbË_š_´og»ss
 = 0;

328 
comm
->
bÿ¡_comm
.
»cv_drİ_·ck‘_š_´og»ss
 = 0;

329 
comm
->
tx
 = 0;

332 
comm
->
mÿ¡_Œª¥Üt_»ady
 = 1;

335 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

336 
¡©us
 = 
	`ucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_š™
(
comm
);

337 ià((
¡©us
 !ğ
UCC_OK
è&& (¡©u !ğ
UCC_ERR_NOT_SUPPORTED
)) {

338  
¡©us
;

342  
UCC_OK
;

344 
”rÜ
:

348  
¡©us
;

349 
	}
}

351 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_´oûss_comm_ev’t
(
ucc_ba£_‹am_t
 *
‹am
)

353 
ucc__mlx5_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_mlx5_team_t);

354 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
_‹am
->
mÿ¡
->
mÿ¡_comm
;

355 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

356 
mÿ¡_group
 *
group
;

357 
i
;

359 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i++) {

360 ià(
comm
->
mÿ¡
.
groups
[
i
].
lid
 != 0) {

364 
¡©us
 = 
	`ucc__mlx5_mÿ¡_još_mÿ¡_g‘_ev’t
(
comm
->
ùx
, &comm->
ev’t
);

365 ià(
¡©us
 !ğ
UCC_OK
) {

366 
çed
;

369 ià(!
comm
->
ev’t
) {

370 
	`_”rÜ
(
comm
->
lib
, "received NULLƒvent‡fter successful get_event call");

371 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

372 
çed
;

375 
group
 = (
mÿ¡_group
 *)
comm
->
ev’t
->
·¿m
.
ud
.
´iv©e_d©a
;

377 
	`ucc_as£¹
(
group
 !ğ
NULL
);

378 
	`_debug
(
comm
->
lib
, "found mÿ¡ grou°%°šfØšh»Œeived mÿ¡ jošƒv’t", 
group
);

380 
group
->
lid
 = 
comm
->
ev’t
->
·¿m
.
ud
.
ah_©Œ
.
dlid
;

381 
group
->
mgid
 = 
comm
->
ev’t
->
·¿m
.
ud
.
ah_©Œ
.
grh
.
dgid
;

383 ià(
	`rdma_ack_cm_ev’t
(
comm
->
ev’t
) < 0) {

384 
	`_”rÜ
(
comm
->
lib
, "rdma_ack_cm_event failed");

385 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

386 
comm
->
ev’t
 = 
NULL
;

387 
çed
;

389 
comm
->
ev’t
 = 
NULL
;

392 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_READY
;

393  
UCC_OK
;

395 
çed
:

396 ià(
¡©us
 < 0) {

397 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_FAILED
;

399  
¡©us
;

400 
	}
}

402 
ucc_¡©us_t
 
	$ucc__mlx5_mÿ¡_‹am_‹¡
(
ucc_ba£_‹am_t
 *
‹am
)

404 
ucc__mlx5_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_mlx5_team_t);

405 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

406 
sockaddr_š6
 
Ãt_addr
 = {0,};

407 
ucc__mlx5_mÿ¡_još_šfo_t
 *
d©a
 = 
NULL
;

408 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
_‹am
->
mÿ¡
->
mÿ¡_comm
;

409 
i
;

411 ià(
comm
->
¿nk
 == 0) {

412 
_‹am
->
mÿ¡_¡©e
) {

413 
TL_MLX5_TEAM_STATE_MCAST_INIT
:

415 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i++) {

416 
Ãt_addr
.
sš6_çmy
 = 
AF_INET6
;

417 
Ãt_addr
.
sš6_æowšfo
 = 
comm
->
comm_id
 + 
i
 + 1;

418 
¡©us
 = 
	`ucc__mlx5_mÿ¡_još_mÿ¡_po¡
(
comm
->
ùx
, &
Ãt_addr
, &comm->
mÿ¡
.
groups
[
i
], 1);

419 ià(
¡©us
 < 0) {

420 
	`_”rÜ
(
comm
->
lib
, "rank 0 is unableo join mcast group %dƒrror %d",

421 
i
, 
¡©us
);

422 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_FAILED
;

423  
UCC_INPROGRESS
;

425 
comm
->
mÿ¡
.
groups
[
i
].
mÿ¡_addr
 = 
Ãt_addr
;

428 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_TEST
;

429  
UCC_INPROGRESS
;

432 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_TEST
:

434 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´oûss_comm_ev’t
(
‹am
);

435 ià(
¡©us
 < 
UCC_OK
) {

436 
	`_”rÜ
(
comm
->
lib
, "mcast_process_comm_event failed");

439  
UCC_INPROGRESS
;

442 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_READY
:

443 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_FAILED
:

446 
d©a
 = 
	`ucc_ÿÎoc
(1, (
ucc__mlx5_mÿ¡_još_šfo_t
),

448 ià(!
d©a
) {

449 
	`_”rÜ
(
comm
->
lib
, "unableo‡llocate memory for group setup info");

450  
UCC_ERR_NO_MEMORY
;

453 
comm
->
group_£tup_šfo
 = 
d©a
;

455 ià(
_‹am
->
mÿ¡_¡©e
 =ğ
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_READY
) {

457 
d©a
->
¡©us
 = 
UCC_OK
;

458 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i++) {

459 
d©a
->
dgid
[
i
] = 
comm
->
mÿ¡
.
groups
[i].
mgid
;

460 
d©a
->
dlid
[
i
] = 
comm
->
mÿ¡
.
groups
[i].
lid
;

464 
¡©us
 = 
	`ucc__mlx5_Ëave_mÿ¡_groups
(
comm
->
ùx
, comm);

465 ià(
¡©us
) {

466 
	`_”rÜ
(
comm
->
lib
, "couldn't†eave mcast group");

468 ià(
comm
->
group_£tup_šfo
) {

469 
	`ucc_ä“
(
comm
->
group_£tup_šfo
);

470 
comm
->
group_£tup_šfo
 = 
NULL
;

472 
d©a
->
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

475 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`bÿ¡_po¡
(comm->
p2p_ùx
, 
d©a
, (
ucc__mlx5_mÿ¡_još_šfo_t
),

476 0, &
comm
->
group_£tup_šfo_»q
);

477 ià(
UCC_OK
 !ğ
¡©us
) {

478 
	`_”rÜ
(
comm
->
lib
, "unableo…ost bcast for group setup info");

479 
	`ucc_ä“
(
comm
->
group_£tup_šfo
);

480 
comm
->
group_£tup_šfo
 = 
NULL
;

481  
¡©us
;

484 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_GRP_BCAST_POST
;

486  
UCC_INPROGRESS
;

489 
TL_MLX5_TEAM_STATE_MCAST_GRP_BCAST_POST
:

492 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(comm->
group_£tup_šfo_»q
);

493 ià(
UCC_OK
 !ğ
¡©us
) {

495 ià(
¡©us
 < 0) {

496 
	`ucc_ä“
(
comm
->
group_£tup_šfo
);

497 
comm
->
group_£tup_šfo
 = 
NULL
;

499  
¡©us
;

502 ià(
comm
->
group_£tup_šfo
 && comm->group_£tup_šfo->
¡©us
 !ğ
UCC_OK
) {

505 
	`ucc_ä“
(
comm
->
group_£tup_šfo
);

506 
comm
->
group_£tup_šfo
 = 
NULL
;

507  
UCC_ERR_NO_RESOURCE
;

510 ià(
comm
->
group_£tup_šfo
) {

511 
	`ucc_ä“
(
comm
->
group_£tup_šfo
);

512 
comm
->
group_£tup_šfo
 = 
NULL
;

522 
¡©us
 = 
	`ucc__mlx5_mÿ¡_cŞl_£tup_comm_»sourûs
(
comm
);

523 ià(
UCC_OK
 !ğ
¡©us
) {

524 
	`_debug
(
comm
->
lib
,

526 
comm
->
¿nk
);

528 
comm
->
mÿ¡_Œª¥Üt_»ady
 = 0;

532 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`®Ìeduû_po¡
(comm->
p2p_ùx
,

533 &
comm
->
mÿ¡_Œª¥Üt_»ady
,

534 &
comm
->
Œª¥Üt_»ady_glob®
,

535 1, 
UCC_DT_INT32
, 
UCC_OP_MIN
,

536 &
comm
->
Œª¥Üt_»ady_»q
);

537 ià(
¡©us
 !ğ
UCC_OK
) {

538  
¡©us
;

540 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_RELIAB_SYNC
;

541  
UCC_INPROGRESS
;

544 
TL_MLX5_TEAM_STATE_MCAST_RELIAB_SYNC
:

546 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(comm->
Œª¥Üt_»ady_»q
);

547 ià(
UCC_OK
 !ğ
¡©us
) {

548 ià(
¡©us
 < 0) {

549  
¡©us
;

551  
¡©us
;

554 
comm
->
Œª¥Üt_»ady_»q
 = 
NULL
;

555 ià(
comm
->
Œª¥Üt_»ady_glob®
 == 0) {

559 
	`ucc__mlx5_ş—n_mÿ¡_comm
(
comm
);

560  
UCC_ERR_NO_RESOURCE
;

562 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_RELIABLITY
;

563  
UCC_INPROGRESS
;

565 
TL_MLX5_TEAM_STATE_MCAST_RELIABLITY
:

567 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

568 
¡©us
 = 
	`ucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_‹¡
(
comm
);

569 ià(
UCC_OK
 !ğ
¡©us
) {

570 ià(
¡©us
 < 0) {

571 
	`_debug
(
comm
->
lib
, "»lŸb™ye¡ faed oÀ¿nk %d", comm->
¿nk
);

572  
¡©us
;

575  
¡©us
;

578 
	`_debug
(
comm
->
lib
, "»lŸb™ye¡ sucûeded oÀ¿nk %d", comm->
¿nk
);

580 
	`_debug
(
comm
->
lib
, "»lŸb™y di§bËd, skpšge¡ oÀ¿nk %d", comm->
¿nk
);

583 
	`_debug
(
comm
->
lib
, "š™ŸlizedÈmÿ¡—m: %p", 
_‹am
);

584 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_READY
;

587 
TL_MLX5_TEAM_STATE_MCAST_READY
:

588 
TL_MLX5_TEAM_STATE_MCAST_NOT_AVAILABLE
:

590  
UCC_OK
;

595 
	`_”rÜ
(
comm
->
lib
, "unknowÀ¡©duršg mÿ¡—m: %°ü—‹", 
_‹am
);

596  
UCC_ERR_NO_RESOURCE
;

601 
_‹am
->
mÿ¡_¡©e
) {

602 
TL_MLX5_TEAM_STATE_MCAST_INIT
:

606 
d©a
 = 
	`ucc_ÿÎoc
(1, (
ucc__mlx5_mÿ¡_još_šfo_t
),

608 ià(!
d©a
) {

609 
	`_”rÜ
(
comm
->
lib
, "unableo‡llocate memory for group setup info");

610  
UCC_ERR_NO_MEMORY
;

613 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`bÿ¡_po¡
(comm->
p2p_ùx
, 
d©a
,

614 (
ucc__mlx5_mÿ¡_još_šfo_t
), 0,

615 &
comm
->
group_£tup_šfo_»q
);

616 ià(
UCC_OK
 !ğ
¡©us
) {

617 
	`_”rÜ
(
comm
->
lib
, "unableo…ost bcast for group setup info");

618 
	`ucc_ä“
(
d©a
);

619  
¡©us
;

622 
comm
->
group_£tup_šfo
 = 
d©a
;

623 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_GRP_BCAST_POST
;

625  
UCC_INPROGRESS
;

628 
TL_MLX5_TEAM_STATE_MCAST_GRP_BCAST_POST
:

631 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(comm->
group_£tup_šfo_»q
);

632 ià(
UCC_OK
 !ğ
¡©us
) {

634 ià(
¡©us
 < 0) {

635 
	`ucc_ä“
(
comm
->
group_£tup_šfo
);

636 
comm
->
group_£tup_šfo
 = 
NULL
;

638  
¡©us
;

641 
d©a
 = 
comm
->
group_£tup_šfo
;

642 ià(!
d©a
) {

643 
	`_”rÜ
(
comm
->
lib
, "group_setup_info is NULL‡fter successful coll_test");

644  
UCC_ERR_NO_RESOURCE
;

647 
¡©us
 = 
d©a
->status;

648 ià(
UCC_OK
 !ğ
¡©us
) {

651 
	`ucc_ä“
(
d©a
);

652 
comm
->
group_£tup_šfo
 = 
NULL
;

653  
¡©us
;

658 
i
 = 0; i < 
comm
->
mÿ¡_group_couÁ
; i++) {

659 
	`memıy
(&
Ãt_addr
.
sš6_addr
, &(
d©a
->
dgid
[
i
]), (
š6_addr
));

660 
Ãt_addr
.
sš6_çmy
 = 
AF_INET6
;

661 
¡©us
 = 
	`ucc__mlx5_mÿ¡_još_mÿ¡_po¡
(
comm
->
ùx
, &
Ãt_addr
, &comm->
mÿ¡
.
groups
[
i
], 0);

662 ià(
¡©us
 < 0) {

663 
	`_”rÜ
(
comm
->
lib
, "none-root„ank is unableo join mcast groupƒrror %d",

664 
¡©us
);

665 
	`ucc_ä“
(
d©a
);

666 
comm
->
group_£tup_šfo
 = 
NULL
;

667  
¡©us
;

669 
comm
->
mÿ¡
.
groups
[
i
].
mÿ¡_addr
 = 
Ãt_addr
;

672 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_TEST
;

673  
UCC_INPROGRESS
;

676 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_TEST
:

678 
¡©us
 = 
	`ucc__mlx5_mÿ¡_´oûss_comm_ev’t
(
‹am
);

679 ià(
¡©us
 < 
UCC_OK
) {

680 
	`_”rÜ
(
comm
->
lib
, "mcast_process_comm_event failed");

683  
UCC_INPROGRESS
;

686 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_FAILED
:

688 
¡©us
 = 
	`ucc__mlx5_Ëave_mÿ¡_groups
(
comm
->
ùx
, comm);

689 ià(
¡©us
) {

690 
	`_”rÜ
(
comm
->
lib
, "couldn't†eave mcast group");

692  
UCC_ERR_NO_RESOURCE
;

695 
TL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_READY
:

697 
¡©us
 = 
	`ucc__mlx5_mÿ¡_cŞl_£tup_comm_»sourûs
(
comm
);

698 ià(
UCC_OK
 !ğ
¡©us
) {

699 
	`_debug
(
comm
->
lib
,

701 
comm
->
¿nk
);

702 
comm
->
mÿ¡_Œª¥Üt_»ady
 = 0;

705 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`®Ìeduû_po¡
(comm->
p2p_ùx
,

706 &
comm
->
mÿ¡_Œª¥Üt_»ady
,

707 &
comm
->
Œª¥Üt_»ady_glob®
,

708 1, 
UCC_DT_INT32
, 
UCC_OP_MIN
,

709 &
comm
->
Œª¥Üt_»ady_»q
);

710 ià(
¡©us
 !ğ
UCC_OK
) {

711  
¡©us
;

713 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_RELIAB_SYNC
;

714  
UCC_INPROGRESS
;

717 
TL_MLX5_TEAM_STATE_MCAST_RELIAB_SYNC
:

719 
¡©us
 = 
comm
->
£rviû_cŞl
.
	`cŞl_‹¡
(comm->
Œª¥Üt_»ady_»q
);

720 ià(
UCC_OK
 !ğ
¡©us
) {

721 ià(
¡©us
 < 0) {

722  
¡©us
;

724  
¡©us
;

727 
comm
->
Œª¥Üt_»ady_»q
 = 
NULL
;

728 ià(
comm
->
Œª¥Üt_»ady_glob®
 == 0) {

729 
	`ucc__mlx5_ş—n_mÿ¡_comm
(
comm
);

730  
UCC_ERR_NO_RESOURCE
;

732 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_RELIABLITY
;

733  
UCC_INPROGRESS
;

736 
TL_MLX5_TEAM_STATE_MCAST_RELIABLITY
:

738 ià(
comm
->
Úe_sided
.
»lŸb™y_’abËd
) {

739 
¡©us
 = 
	`ucc__mlx5_mÿ¡_Úe_sided_»lŸb™y_‹¡
(
comm
);

740 ià(
UCC_OK
 !ğ
¡©us
) {

741 ià(
¡©us
 < 0) {

742 
	`_debug
(
comm
->
lib
, "»lŸb™ye¡ faed oÀ¿nk %d", comm->
¿nk
);

743  
¡©us
;

746  
¡©us
;

749 
	`_debug
(
comm
->
lib
, "»lŸb™ye¡ sucûeded oÀ¿nk %d", comm->
¿nk
);

751 
	`_debug
(
comm
->
lib
, "»lŸb™y di§bËd, skpšge¡ oÀ¿nk %d", comm->
¿nk
);

754 
	`_debug
(
comm
->
lib
, "š™ŸlizedÈmÿ¡—m: %p", 
_‹am
);

755 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_READY
;

758 
TL_MLX5_TEAM_STATE_MCAST_READY
:

759 
TL_MLX5_TEAM_STATE_MCAST_NOT_AVAILABLE
:

761  
UCC_OK
;

766 
	`_”rÜ
(
comm
->
lib
, "unknowÀ¡©duršg mÿ¡—m: %°ü—‹", 
_‹am
);

767  
UCC_ERR_NO_RESOURCE
;

771 
	}
}

	@src/components/tl/mlx5/tl_mlx5.c

7 
	~"_mlx5.h
"

9 
ucc_¡©us_t
 
ucc__mlx5_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

10 
ucc_ba£_lib_©Œ_t
 * 
ba£_©Œ
);

11 
ucc_¡©us_t
 
ucc__mlx5_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

12 
ucc_ba£_ùx_©Œ_t
 * 
ba£_©Œ
);

14 
ucc_¡©us_t
 
ucc__mlx5_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

15 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
);

17 
ucc_¡©us_t
 
ucc__mlx5_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

18 
ucc_mem_m­__t
 *
_h
);

20 
ucc_¡©us_t
 
ucc__mlx5_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

21 
ucc_mem_m­_mode_t
 
mode
, 
ucc_mem_m­__t
 *
_h
, **
·ck_bufãr
);

23 
ucc_¡©us_t
 
ucc__mlx5_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

25 cÚ¡ *
	g®ÉßÎ_block_sh­e_modes
[] = {

26 [
UCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_LONG
] = "long",

27 [
UCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_WIDE
] = "wide",

28 [
UCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_SQUARE
] = "square",

29 [
UCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_LAST
] = 
NULL
};

33 
ucc_cÚfig_f›ld_t
 
	gucc__mlx5_lib_cÚfig_bË
[] = {

34 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
su³r
),

35 
UCC_CONFIG_TYPE_TABLE
(
ucc__lib_cÚfig_bË
)},

38 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
a¤_b¬r›r
), 
UCC_CONFIG_TYPE_BOOL
},

41 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
dm_buf_size
),

42 
UCC_CONFIG_TYPE_MEMUNITS
},

45 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
dm_buf_num
),

46 
UCC_CONFIG_TYPE_ULUNITS
},

51 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
fÜû_»guÏr
),

52 
UCC_CONFIG_TYPE_BOOL
},

59 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
block_sh­e_mode
),

60 
UCC_CONFIG_TYPE_ENUM
(
®ÉßÎ_block_sh­e_modes
)},

65 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
block_size
), 
UCC_CONFIG_TYPE_UINT
},

69 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
num_dci_qps
), 
UCC_CONFIG_TYPE_UINT
},

74 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
dc_th»shŞd
),

75 
UCC_CONFIG_TYPE_UINT
},

80 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
dm_ho¡
), 
UCC_CONFIG_TYPE_BOOL
},

83 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
qp_cÚf
.
qp_ºr_»Œy
),

84 
UCC_CONFIG_TYPE_UINT
},

87 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
qp_cÚf
.
qp_ºr_tim”
),

88 
UCC_CONFIG_TYPE_UINT
},

91 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
qp_cÚf
.
qp_»Œy_út
),

92 
UCC_CONFIG_TYPE_UINT
},

95 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
qp_cÚf
.
qp_timeout
),

96 
UCC_CONFIG_TYPE_UINT
},

99 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
qp_cÚf
.
qp_max_©omic
),

100 
UCC_CONFIG_TYPE_UINT
},

103 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
qp_cÚf
.
qp_¦
),

104 
UCC_CONFIG_TYPE_UINT
},

107 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
sx_d•th
),

108 
UCC_CONFIG_TYPE_INT
},

111 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
sx_šlše
),

112 
UCC_CONFIG_TYPE_MEMUNITS
},

115 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
rx_d•th
),

116 
UCC_CONFIG_TYPE_INT
},

120 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
po¡_»cv_th»sh
),

121 
UCC_CONFIG_TYPE_INT
},

124 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
wsize
),

125 
UCC_CONFIG_TYPE_INT
},

129 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
max_push_£nd
),

130 
UCC_CONFIG_TYPE_INT
},

134 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
max_—g”
),

135 
UCC_CONFIG_TYPE_MEMUNITS
},

139 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
cuda_mem_’abËd
),

140 
UCC_CONFIG_TYPE_BOOL
},

143 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
Úe_sided_»lŸb™y_’abË
),

144 
UCC_CONFIG_TYPE_BOOL
},

148 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
»lŸb™y_scheme_msg_th»shŞd
),

149 
UCC_CONFIG_TYPE_INT
},

152 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
Œuly_z”o_cİy_®lg©h”_’abËd
),

153 
UCC_CONFIG_TYPE_BOOL
},

156 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
Œuly_z”o_cİy_bÿ¡_’abËd
),

157 
UCC_CONFIG_TYPE_BOOL
},

162 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
,

163 
mÿ¡_cÚf
.
mÿ¡_´•o¡_buck‘_size
),

164 
UCC_CONFIG_TYPE_INT
},

167 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
mÿ¡_group_couÁ
),

168 
UCC_CONFIG_TYPE_INT
},

172 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
Œuly_z”o_cİy_cŞl_mš_msg
),

173 
UCC_CONFIG_TYPE_UINT
},

177 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
mÿ¡_cÚf
.
hÿ_cİy_’abËd
),

178 
UCC_CONFIG_TYPE_BOOL
},

183 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
block_b©ch_size
),

184 
UCC_CONFIG_TYPE_UINT
},

190 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
num_£rŸlized_b©ches
),

191 
UCC_CONFIG_TYPE_UINT
},

195 
ucc_off£tof
(
ucc__mlx5_lib_cÚfig_t
, 
num_b©ches_³r_·s§ge
),

196 
UCC_CONFIG_TYPE_UINT
},

198 {
NULL
}};

200 
ucc_cÚfig_f›ld_t
 
	gucc__mlx5_cÚ‹xt_cÚfig_bË
[] = {

201 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__mlx5_cÚ‹xt_cÚfig_t
, 
su³r
),

202 
UCC_CONFIG_TYPE_TABLE
(
ucc__cÚ‹xt_cÚfig_bË
)},

205 
ucc_off£tof
(
ucc__mlx5_cÚ‹xt_cÚfig_t
, 
deviûs
),

206 
UCC_CONFIG_TYPE_STRING_ARRAY
},

210 
ucc_off£tof
(
ucc__mlx5_cÚ‹xt_cÚfig_t
, 
mÿ¡_ùx_cÚf
.
timeout
),

211 
UCC_CONFIG_TYPE_INT
},

214 
ucc_off£tof
(
ucc__mlx5_cÚ‹xt_cÚfig_t
, 
mÿ¡_ùx_cÚf
.
mÿ¡_bÿ¡_’abËd
),

215 
UCC_CONFIG_TYPE_BOOL
},

218 
ucc_off£tof
(
ucc__mlx5_cÚ‹xt_cÚfig_t
, 
mÿ¡_ùx_cÚf
.
mÿ¡_®lg©h”_’abËd
),

219 
UCC_CONFIG_TYPE_BOOL
},

226 
ucc_off£tof
(
ucc__mlx5_cÚ‹xt_cÚfig_t
, 
mÿ¡_ùx_cÚf
.
mÿ¡_’abËd
),

227 
UCC_CONFIG_TYPE_TERNARY
},

230 
ucc_off£tof
(
ucc__mlx5_cÚ‹xt_cÚfig_t
, 
mÿ¡_ùx_cÚf
.
ib_dev_Çme
),

231 
UCC_CONFIG_TYPE_STRING
},

234 
ucc_off£tof
(
ucc__mlx5_cÚ‹xt_cÚfig_t
, 
’abË_®ÉßÎ
),

235 
UCC_CONFIG_TYPE_BOOL
},

237 {
NULL
}};

239 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__mlx5_lib_t
, 
ucc_ba£_lib_t
,

240 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

241 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

243 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__mlx5_lib_t
, 
ucc_ba£_lib_t
);

245 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__mlx5_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

246 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

247 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

249 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__mlx5_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

251 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__mlx5_‹am_t
, 
ucc_ba£_‹am_t
,

252 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

254 
ucc_¡©us_t
 
ucc__mlx5_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
);

256 
ucc_¡©us_t
 
ucc__mlx5_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
);

258 
ucc_¡©us_t
 
ucc__mlx5_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

259 
ucc_ba£_‹am_t
 * 
‹am
,

260 
ucc_cŞl_sk_t
 ** 
sk
);

262 
ucc_¡©us_t
 
ucc__mlx5_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 * 
_‹am
,

263 
ucc_cŞl_scÜe_t
 **
scÜe
);

265 
UCC_TL_IFACE_DECLARE
(
mlx5
, 
MLX5
);

267 
ucc_¡©us_t
 
ucc__mlx5_cÚ‹xt_ü—‹_•og
(
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
);

269 
__©Œibu‹__
((
cÚ¡ruùÜ
)è
	$_mlx5_içû_š™
()

271 
ucc__mlx5
.
su³r
.
cÚ‹xt
.
ü—‹_•og
 = 
ucc__mlx5_cÚ‹xt_ü—‹_•og
;

272 
	}
}

	@src/components/tl/mlx5/tl_mlx5.h

7 #iâdeà
UCC_TL_MLX5_H_


8 
	#UCC_TL_MLX5_H_


	)

10 
	~"compÚ’ts//ucc_.h
"

11 
	~"compÚ’ts//ucc__log.h
"

12 
	~"cÜe/ucc_£rviû_cŞl.h
"

13 
	~"uts/ucc_mpoŞ.h
"

14 
	~"uts/ucc_rÿche.h
"

15 
	~<šfšibªd/v”bs.h
>

16 
	~<šfšibªd/mlx5dv.h
>

17 
	~"uts/¬ch/ıu.h
"

18 
	~"mÿ¡/_mlx5_mÿ¡.h
"

20 #iâdeà
UCC_TL_MLX5_DEFAULT_SCORE


21 
	#UCC_TL_MLX5_DEFAULT_SCORE
 1

	)

24 #ifdeà
HAVE_PROFILING_TL_MLX5


25 
	~"uts/´ofe/ucc_´ofe.h
"

27 
	~"uts/´ofe/ucc_´ofe_off.h
"

30 
	#UCC_TL_MLX5_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

31 
	#UCC_TL_MLX5_PROFILE_FUNC_VOID
 
UCC_PROFILE_FUNC_VOID


	)

32 
	#UCC_TL_MLX5_PROFILE_REQUEST_NEW
 
UCC_PROFILE_REQUEST_NEW


	)

33 
	#UCC_TL_MLX5_PROFILE_REQUEST_EVENT
 
UCC_PROFILE_REQUEST_EVENT


	)

34 
	#UCC_TL_MLX5_PROFILE_REQUEST_FREE
 
UCC_PROFILE_REQUEST_FREE


	)

36 
	#ATOMIC_IN_MEMIC
 1

	)

37 
	#DC_KEY
 1

	)

39 
	succ__mlx5_içû
 {

40 
ucc__içû_t
 
	msu³r
;

41 } 
	tucc__mlx5_içû_t
;

43 
ucc__mlx5_içû_t
 
ucc__mlx5
;

45 
	succ__mlx5_ib_qp_cÚf
 {

46 
ušt8_t
 
	mqp_¦
;

47 
ušt32_t
 
	mqp_ºr_»Œy
;

48 
ušt32_t
 
	mqp_ºr_tim”
;

49 
ušt32_t
 
	mqp_»Œy_út
;

50 
ušt32_t
 
	mqp_timeout
;

51 
ušt32_t
 
	mqp_max_©omic
;

52 } 
	tucc__mlx5_ib_qp_cÚf_t
;

54 
	eucc__mlx5_®ÉßÎ_block_sh­e_modes


56 
	mUCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_LONG
,

57 
	mUCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_WIDE
,

58 
	mUCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_SQUARE
,

59 
	mUCC_TL_MLX5_ALLTOALL_BLOCK_SHAPE_LAST
,

60 } 
	tucc__mlx5_®ÉßÎ_block_sh­e_modes_t
;

62 
	succ__mlx5_lib_cÚfig
 {

63 
ucc__lib_cÚfig_t
 
	msu³r
;

64 
	ma¤_b¬r›r
;

65 
	mblock_size
;

66 
	mnum_dci_qps
;

67 
	mdc_th»shŞd
;

68 
size_t
 
	mdm_buf_size
;

69 
	mdm_buf_num
;

70 
	mdm_ho¡
;

71 
ucc__mlx5_ib_qp_cÚf_t
 
	mqp_cÚf
;

72 
ucc__mlx5_mÿ¡_cŞl_comm_š™_¥ec_t
 
	mmÿ¡_cÚf
;

73 
	mnum_£rŸlized_b©ches
;

74 
	mnum_b©ches_³r_·s§ge
;

75 
	mblock_b©ch_size
;

76 
	mfÜû_»guÏr
;

77 
ucc__mlx5_®ÉßÎ_block_sh­e_modes_t
 
	mblock_sh­e_mode
;

78 } 
	tucc__mlx5_lib_cÚfig_t
;

80 
	succ__mlx5_cÚ‹xt_cÚfig
 {

81 
ucc__cÚ‹xt_cÚfig_t
 
	msu³r
;

82 
ucs_cÚfig_Çmes_¬¿y_t
 
	mdeviûs
;

83 
ucc__mlx5_mÿ¡_ùx_·¿ms_t
 
	mmÿ¡_ùx_cÚf
;

84 
	m’abË_®ÉßÎ
;

85 } 
	tucc__mlx5_cÚ‹xt_cÚfig_t
;

87 
	succ__mlx5_lib
 {

88 
ucc__lib_t
 
	msu³r
;

89 
ucc__mlx5_lib_cÚfig_t
 
	mcfg
;

90 } 
	tucc__mlx5_lib_t
;

92 
UCC_CLASS_DECLARE
(
ucc__mlx5_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

93 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

95 
	succ__mlx5_cÚ‹xt
 {

96 
ucc__cÚ‹xt_t
 
	msu³r
;

97 
ucc__mlx5_cÚ‹xt_cÚfig_t
 
	mcfg
;

98 
ibv_cÚ‹xt
 *
	msh¬ed_ùx
;

99 
ibv_pd
 *
	msh¬ed_pd
;

100 
ucc_rÿche_t
 *
	mrÿche
;

101 
	mis_impÜ‹d
;

102 
	mib_pÜt
;

103 
	msock
;

104 
ucc_mpoŞ_t
 
	m»q_mp
;

105 
ucc__mlx5_mÿ¡_cÚ‹xt_t
 
	mmÿ¡
;

106 
ušt16_t
 
	msuµÜ‹d_mem_ty³s
;

107 } 
	tucc__mlx5_cÚ‹xt_t
;

108 
UCC_CLASS_DECLARE
(
ucc__mlx5_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
*,

109 cÚ¡ 
ucc_ba£_cÚfig_t
*);

111 
ucc__mlx5_sk
 
	tucc__mlx5_sk_t
;

112 
ucc__mlx5_scheduË
 
	tucc__mlx5_scheduË_t
;

113 
	succ__mlx5_dm_chunk_t
 {

114 
ušŒ_t
 
	maddr
;

116 
ucc__mlx5_scheduË_t
 *
	msk
;

117 
	mpo¡ed_£nds
;

118 
	mpo¡ed_®l
;

119 
	mcom¶‘ed_£nds
;

120 } 
	tucc__mlx5_dm_chunk_t
;

122 
ucc__mlx5_®ÉßÎ
 
	tucc__mlx5_®ÉßÎ_t
;

126 
	mTL_MLX5_TEAM_STATE_ALLTOALL_CTX_CHECK
,

127 
	mTL_MLX5_TEAM_STATE_ALLTOALL_INIT
,

128 
	mTL_MLX5_TEAM_STATE_ALLTOALL_POSTED
,

129 
	mTL_MLX5_TEAM_STATE_ALLTOALL_READY
,

130 
	mTL_MLX5_TEAM_STATE_ALLTOALL_NOT_AVAILABLE
,

131 } 
	tucc__mlx5_‹am_a2a_¡©e_t
;

135 
	mTL_MLX5_TEAM_STATE_MCAST_CTX_CHECK
,

136 
	mTL_MLX5_TEAM_STATE_MCAST_INIT
,

137 
	mTL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_TEST
,

138 
	mTL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_READY
,

139 
	mTL_MLX5_TEAM_STATE_MCAST_GRP_JOIN_FAILED
,

140 
	mTL_MLX5_TEAM_STATE_MCAST_GRP_BCAST_POST
,

141 
	mTL_MLX5_TEAM_STATE_MCAST_RELIAB_SYNC
,

142 
	mTL_MLX5_TEAM_STATE_MCAST_RELIABLITY
,

143 
	mTL_MLX5_TEAM_STATE_MCAST_READY
,

144 
	mTL_MLX5_TEAM_STATE_MCAST_NOT_AVAILABLE


145 } 
	tucc__mlx5_‹am_mÿ¡_¡©e_t
;

147 
	succ__mlx5_‹am_¡©us
 {

148 
ucc_¡©us_t
 
	mloÿl
;

149 
ucc_¡©us_t
 
	mglob®
;

150 } 
	tucc__mlx5_‹am_¡©us_t
;

152 
	#UCC_TL_MLX5_FEATURES_COUNT
 2

	)

153 
	#UCC_TL_MLX5_A2A_STATUS_INDEX
 0

	)

154 
	#UCC_TL_MLX5_MCAST_STATUS_INDEX
 1

	)

156 
	succ__mlx5_‹am
 {

157 
ucc__‹am_t
 
	msu³r
;

158 
ucc_£rviû_cŞl_»q_t
 *
	mscŞl_»q
;

159 
ucc_£rviû_cŞl_»q_t
 *
	mglob®_sync_»q
;

160 
ucc__mlx5_‹am_a2a_¡©e_t
 
	ma2a_¡©e
;

161 
ucc__mlx5_‹am_mÿ¡_¡©e_t
 
	mmÿ¡_¡©e
;

162 *
	mdm_off£t
;

163 
ucc_mpoŞ_t
 
	mdm_poŞ
;

164 
ibv_dm
 *
	mdm_±r
;

165 
ibv_mr
 *
	mdm_mr
;

166 
ucc__mlx5_‹am_¡©us_t
 
	ma2a_¡©us
;

167 
ucc__mlx5_®ÉßÎ_t
 *
	ma2a
;

168 
ucc_tİo_t
 *
	mtİo
;

169 
ucc_•_m­_t
 
	mùx_m­
;

170 
	mloÿl_mÿ¡_‹am_»ady
;

171 
ucc__mlx5_mÿ¡_‹am_t
 *
	mmÿ¡
;

172 
ucc_¡©us_t
 
	mloÿl_¡©us_¬¿y
[
UCC_TL_MLX5_FEATURES_COUNT
];

173 
ucc_¡©us_t
 
	mglob®_¡©us_¬¿y
[
UCC_TL_MLX5_FEATURES_COUNT
];

174 } 
	tucc__mlx5_‹am_t
;

175 
UCC_CLASS_DECLARE
(
ucc__mlx5_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

176 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

178 
ucc_¡©us_t
 
_mlx5_rÿche_ü—‹
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
);

180 
	succ__mlx5_»g
 {

181 
ibv_mr
 *
	mmr
;

182 } 
	tucc__mlx5_»g_t
;

184 
	succ__mlx5_rÿche_»giÚ
 {

185 
ucc_rÿche_»giÚ_t
 
	msu³r
;

186 
ucc__mlx5_»g_t
 
	m»g
;

187 } 
	tucc__mlx5_rÿche_»giÚ_t
;

189 
	#UCC_TL_MLX5_SUPPORTED_COLLS
 \

190 (
UCC_COLL_TYPE_ALLTOALL
 | 
UCC_COLL_TYPE_BCAST
 | 
UCC_COLL_TYPE_ALLGATHER
)

	)

192 
	#UCC_TL_MLX5_TEAM_LIB
(
_‹am
) \

193 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
->
lib
, 
ucc__mlx5_lib_t
))

	)

195 
	#UCC_TL_MLX5_TEAM_CTX
(
_‹am
) \

196 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
, 
ucc__mlx5_cÚ‹xt_t
))

	)

198 
	#UCC_TL_CTX_HAS_OOB
(
_ùx
) \

199 ((
_ùx
)->
su³r
.su³r.
ucc_cÚ‹xt
->
·¿ms
.
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
)

	)

201 
	#UCC_TL_CTX_OOB
(
_ùx
è((_ùx)->
su³r
.su³r.
ucc_cÚ‹xt
->
·¿ms
.
oob
)

	)

203 
	#UCC_TL_CTX_LIB
(
_ùx
) \

204 (
	`ucc_d”ived_of
((
_ùx
)->
su³r
.su³r.
lib
, 
ucc__mlx5_lib_t
))

	)

206 
	#SQUARED
(
_num
è((_numè* (_num))

	)

208 
ucc_¡©us_t
 
_mlx5_ü—‹_rÿche
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
);

210 
ucc_¡©us_t
 
ucc__mlx5_a¤_sock‘_š™
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
,

211 
ucc_¿nk_t
 
group_size
, *
sock‘
,

212 cÚ¡ *
sock_·th
);

214 
ucc_¡©us_t
 
ucc__mlx5_dm_®loc_»g
(
ibv_cÚ‹xt
 *
ib_ùx
,

215 
ibv_pd
 *
pd
, 
dm_ho¡
,

216 
size_t
 
buf_size
, size_ˆ*
buf_num_p
,

217 
ibv_dm
 **
±r
, 
ibv_mr
 **
mr
,

218 
ucc_ba£_lib_t
 *
lib
);

	@src/components/tl/mlx5/tl_mlx5_coll.c

7 
	~"_mlx5_cŞl.h
"

8 
	~"mÿ¡/_mlx5_mÿ¡_cŞl.h
"

9 
	~"mÿ¡/_mlx5_mÿ¡_®lg©h”.h
"

10 
	~"mÿ¡/_mlx5_mÿ¡_rÿche.h
"

11 
	~"®ÉßÎ/®ÉßÎ.h
"

13 
ucc_¡©us_t
 
	$ucc__mlx5_cŞl_mÿ¡_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

14 
ucc_ba£_‹am_t
 *
‹am
,

15 
ucc_cŞl_sk_t
 **
sk_h
)

17 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

18 
ucc__mlx5_sk_t
 *
sk
 = 
NULL
;

20 
¡©us
 = 
	`ucc__mlx5_mÿ¡_check_suµÜt
(
cŞl_¬gs
, 
‹am
);

21 ià(
UCC_OK
 !ğ
¡©us
) {

22  
¡©us
;

25 
sk
 = 
	`ucc__mlx5_g‘_sk
(
cŞl_¬gs
, 
‹am
);

26 ià(
	`ucc_uÆik–y
(!
sk
)) {

27  
UCC_ERR_NO_MEMORY
;

30 
sk
->
su³r
.
fš®ize
 = 
ucc__mlx5_sk_fš®ize
;

32 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
) {

33 
UCC_COLL_TYPE_BCAST
:

34 
¡©us
 = 
	`ucc__mlx5_mÿ¡_bÿ¡_š™
(
sk
);

35 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

36 
ä“_sk
;

38 *
sk_h
 = &(
sk
->
su³r
);

40 
UCC_COLL_TYPE_ALLGATHER
:

41 
¡©us
 = 
	`ucc__mlx5_mÿ¡_®lg©h”_š™
(
sk
);

42 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

43 
ä“_sk
;

45 *
sk_h
 = &(
sk
->
su³r
);

48 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

49 
	`_Œaû
(
‹am
->
cÚ‹xt
->
lib
, "mcast‚ot supported forhis collectiveype");

50 
ä“_sk
;

53 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "initialized mcast collectiveask %p",ask);

55  
UCC_OK
;

57 
ä“_sk
:

58 
	`ucc_mpoŞ_put
(
sk
);

59  
¡©us
;

60 
	}
}

62 
ucc_¡©us_t
 
	$ucc__mlx5_sk_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

64 
ucc__mlx5_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_mlx5_task_t);

65 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
»q
 = 
sk
->
cŞl_mÿ¡
.
»q_hªdË
;

67 ià(
»q
 !ğ
NULL
) {

68 
	`ucc_as£¹
(
cŞl_sk
->
¡©us
 !ğ
UCC_INPROGRESS
);

69 
	`ucc_as£¹
(
»q
->
comm
->
ùx
 !ğ
NULL
);

70 ià(
cŞl_sk
->
¡©us
 =ğ
UCC_OK
) {

71 ià(
cŞl_sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHER
) {

72 
»q
->
comm
->
®lg©h”_comm
.
und”_´og»ss_couÁ”
++;

74 
	`ucc_as£¹
(
cŞl_sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
);

75 
»q
->
comm
->
bÿ¡_comm
.
und”_´og»ss_couÁ”
++;

79 
»q
->
comm
->
Úe_sided
.
»lŸb™y_»ady
 = 0;

80 
»q
->
comm
->
¡®Ëd
 = 0;

81 
»q
->
comm
->
tim”
 = 0;

83 ià(
»q
->
¼eg
 !ğ
NULL
) {

84 
	`ucc__mlx5_mÿ¡_mem_d”egi¡”
(
»q
->
comm
->
ùx
,„eq->
¼eg
);

85 
»q
->
¼eg
 = 
NULL
;

87 ià(
»q
->
»cv_¼eg
 !ğ
NULL
) {

88 
	`ucc__mlx5_mÿ¡_mem_d”egi¡”
(
»q
->
comm
->
ùx
,„eq->
»cv_¼eg
);

89 
»q
->
»cv_¼eg
 = 
NULL
;

91 ià(
»q
->
ag_scheduË
) {

92 
	`ucc_ä“
(
»q
->
ag_scheduË
);

93 
»q
->
ag_scheduË
 = 
NULL
;

95 ià(
»q
->
sü©ch_buf_h—d”
) {

96 
	`ucc_mc_ä“
(
»q
->
sü©ch_buf_h—d”
);

97 
»q
->
sü©ch_buf_h—d”
 = 
NULL
;

98 
»q
->
sü©ch_buf
 = 
NULL
;

100 
	`ucc_mpoŞ_put
(
»q
);

101 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizing‡n mcastask %p",ask);

102 
sk
->
cŞl_mÿ¡
.
»q_hªdË
 = 
NULL
;

105 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizingask %p",ask);

106 
	`ucc__mlx5_put_sk
(
sk
);

107  
UCC_OK
;

108 
	}
}

110 
ucc__mlx5_sk_t
* 
	$ucc__mlx5_š™_sk
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

111 
ucc_ba£_‹am_t
 *
‹am
,

112 
ucc_scheduË_t
 *
scheduË
)

114 
ucc__mlx5_sk_t
 *
sk
 = 
	`ucc__mlx5_g‘_sk
(
cŞl_¬gs
, 
‹am
);

116 
sk
->
su³r
.
scheduË
 = schedule;

117 
sk
->
su³r
.
fš®ize
 = 
ucc__mlx5_sk_fš®ize
;

118  
sk
;

119 
	}
}

121 
ucc_¡©us_t
 
	$ucc__mlx5_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

122 
ucc_ba£_‹am_t
 *
‹am
,

123 
ucc_cŞl_sk_t
 **
sk_h
)

125 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

127 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
) {

128 
UCC_COLL_TYPE_ALLTOALL
:

129 
¡©us
 = 
	`ucc__mlx5_®ÉßÎ_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

131 
UCC_COLL_TYPE_BCAST
:

132 
UCC_COLL_TYPE_ALLGATHER
:

133 
¡©us
 = 
	`ucc__mlx5_cŞl_mÿ¡_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

136 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

139  
¡©us
;

140 
	}
}

	@src/components/tl/mlx5/tl_mlx5_coll.h

7 #iâdeà
UCC_TL_MLX5_COLL_H_


8 
	#UCC_TL_MLX5_COLL_H_


	)

10 
	~"_mlx5.h
"

11 
	~"scheduË/ucc_scheduË.h
"

12 
	~"®ÉßÎ/®ÉßÎ.h
"

14 
	succ__mlx5_sk
 {

15 
ucc_cŞl_sk_t
 
	msu³r
;

18 
ucc__mlx5_mÿ¡_cŞl_»q_t
 *
	m»q_hªdË
;

19 } 
	mcŞl_mÿ¡
;

21 } 
	tucc__mlx5_sk_t
;

23 
	succ__mlx5_scheduË
 {

24 
ucc_scheduË_t
 
	msu³r
;

27 
	m£q_num
;

28 
	m£q_šdex
;

29 
	mnum_of_blocks_cŞumns
;

30 
	mblock_height
;

31 
	mblock_width
;

32 
	m¡¬‹d
;

33 
	m£nd_blocks_’queued
;

34 
	mblocks_£Á
;

35 
	mblocks_com¶‘ed
;

36 
ucc__mlx5_®ÉßÎ_İ_t
 *
	mİ
;

37 
ucc__mlx5_rÿche_»giÚ_t
 *
	m£nd_rÿche_»giÚ_p
;

38 
ucc__mlx5_rÿche_»giÚ_t
 *
	m»cv_rÿche_»giÚ_p
;

39 
size_t
 
	mmsg_size
;

40 
ucc_£rviû_cŞl_»q_t
 *
	mb¬r›r_»q
;

41 
	mb¬r›r_sü©ch
[2];

42 
	mwa™_wc
;

43 } 
	m®ÉßÎ
;

45 } 
	tucc__mlx5_scheduË_t
;

47 
	#TASK_TEAM
(
_sk
) \

48 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
, 
ucc__mlx5_‹am_t
))

	)

50 
	#TASK_CTX
(
_sk
) \

51 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
, 
ucc__mlx5_cÚ‹xt_t
))

	)

53 
	#TASK_LIB
(
_sk
) \

54 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
->
lib
, 
ucc__mlx5_lib_t
))

	)

56 
	#TASK_ARGS
(
_sk
è(_sk)->
su³r
.
b¬gs
.
¬gs


	)

58 
	#TASK_SCHEDULE
(
_sk
) \

59 (
	`ucc_d”ived_of
((
_sk
)->
scheduË
, 
ucc__mlx5_scheduË_t
))

	)

61 
	#SCHEDULE_TEAM
(
_scheduË
) \

62 (
	`ucc_d”ived_of
((
_scheduË
)->
su³r
.su³r.
‹am
, 
ucc__mlx5_‹am_t
))

	)

64 
	#SCHEDULE_CTX
(
_scheduË
) \

65 (
	`ucc_d”ived_of
((
_scheduË
)->
su³r
.su³r.
‹am
->
cÚ‹xt
, \

66 
ucc__mlx5_cÚ‹xt_t
))

	)

68 
	#SCHEDULE_LIB
(
_scheduË
) \

69 (
	`ucc_d”ived_of
((
_scheduË
)->
su³r
.su³r.
‹am
->
cÚ‹xt
->
lib
, \

70 
ucc__mlx5_lib_t
))

	)

72 
	#SCHEDULE_ARGS
(
_scheduË
è(_scheduË)->
su³r
.su³r.
b¬gs
.
¬gs


	)

74 
šlše
 
ucc__mlx5_sk_t
*

75 
	$ucc__mlx5_g‘_sk
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
)

77 
ucc__mlx5_‹am_t
 * 
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_mlx5_team_t);

78 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
_‹am
);

79 
ucc__mlx5_sk_t
 * 
sk
 = 
	`ucc_mpoŞ_g‘
(&
ùx
->
»q_mp
);

81 
	`UCC_TL_MLX5_PROFILE_REQUEST_NEW
(
sk
, "tl_mlx5_task", 0);

82 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, 
cŞl_¬gs
, 
‹am
);

83 
sk
->
cŞl_mÿ¡
.
»q_hªdË
 = 
NULL
;

84  
sk
;

85 
	}
}

87 
šlše
 
	$ucc__mlx5_put_sk
(
ucc__mlx5_sk_t
 *
sk
)

89 
	`UCC_TL_MLX5_PROFILE_REQUEST_FREE
(
sk
);

90 
	`ucc_mpoŞ_put
(
sk
);

91 
	}
}

93 
šlše
 
ucc_¡©us_t


94 
	$ucc__mlx5_g‘_scheduË
(
ucc__mlx5_‹am_t
 *
‹am
,

95 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

96 
ucc__mlx5_scheduË_t
 **
scheduË
)

98 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
‹am
);

100 *
scheduË
 = 
	`ucc_mpoŞ_g‘
(&
ùx
->
»q_mp
);

102 ià(
	`ucc_uÆik–y
(!(*
scheduË
))) {

103  
UCC_ERR_NO_MEMORY
;

105 
	`UCC_TL_MLX5_PROFILE_REQUEST_NEW
(
scheduË
, "tl_mlx5_sched", 0);

107  
	`ucc_scheduË_š™
(&((*
scheduË
)->
su³r
), 
cŞl_¬gs
,

108 &
‹am
->
su³r
.super);

109 
	}
}

111 
šlše
 
	$ucc__mlx5_put_scheduË
(
ucc__mlx5_scheduË_t
 *
scheduË
)

113 
	`UCC_TL_MLX5_PROFILE_REQUEST_FREE
(
scheduË
);

114 
	`ucc_mpoŞ_put
(
scheduË
);

115 
	}
}

117 
ucc_¡©us_t
 
ucc__mlx5_cŞl_mÿ¡_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

118 
ucc_ba£_‹am_t
 *
‹am
,

119 
ucc_cŞl_sk_t
 **
sk_h
);

121 
ucc_¡©us_t
 
ucc__mlx5_sk_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

123 
ucc__mlx5_sk_t
* 
ucc__mlx5_š™_sk
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

124 
ucc_ba£_‹am_t
 *
‹am
,

125 
ucc_scheduË_t
 *
scheduË
);

127 
ucc_¡©us_t
 
ucc__mlx5_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

128 
ucc_ba£_‹am_t
 *
‹am
,

129 
ucc_cŞl_sk_t
 **
sk_h
);

	@src/components/tl/mlx5/tl_mlx5_context.c

7 
	~"_mlx5.h
"

8 
	~"uts/ucc_m©h.h
"

9 
	~"scheduË/ucc_scheduË.h
"

10 
	~<lim™s.h
>

11 
	~"_mlx5_cŞl.h
"

12 
	~"uts/¬ch/ıu.h
"

13 
	~"_mlx5_pd.h
"

14 
	~"_mlx5_ib.h
"

16 
	#PD_OWNER_RANK
 0

	)

17 
	#TL_MLX5_IB_PORT_INVALID
 -1

	)

19 
ucc_¡©us_t
 
	$ucc__mlx5_check_gpudœeù_driv”
(
ucc_ba£_lib_t
 *
lib
,

20 cÚ¡ *
fe
)

22 
ucc_¡©us_t
 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

24 ià(!
	`acûss
(
fe
, 
F_OK
)) {

25 
¡©us
 = 
UCC_OK
;

28 
	`_debug
(
lib
, "checkšg gpudœeù driv”: %s, stus: %d %s", 
fe
,

29 
¡©us
, 
	`ucc_¡©us_¡ršg
(status));

30  
¡©us
;

31 
	}
}

33 
ucc_¡©us_t
 
	$ucc__mlx5_check_gpudœeù_driv”_cuda
(
ucc_ba£_lib_t
 *
lib
)

37 ià(
UCC_OK
 =ğ
	`ucc__mlx5_check_gpudœeù_driv”
(
lib
,

39  
UCC_OK
;

40 } ià(
UCC_OK
 =ğ
	`ucc__mlx5_check_gpudœeù_driv”
(
lib
,

42  
UCC_OK
;

43 } ià(
UCC_OK
 =ğ
	`ucc__mlx5_check_gpudœeù_driv”
(
lib
,

45  
UCC_OK
;

47 
	`_debug
(
lib
, "no gpudirect driver found, cuda memory is‚ot supported");

48  
UCC_ERR_NOT_SUPPORTED
;

49 
	}
}

51 
	$UCC_CLASS_INIT_FUNC
(
ucc__mlx5_cÚ‹xt_t
,

52 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

53 cÚ¡ 
ucc_ba£_cÚfig_t
 * 
cÚfig
)

55 
ucc__mlx5_cÚ‹xt_cÚfig_t
 *
_mlx5_cÚfig
 =

56 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__mlx5_cÚ‹xt_cÚfig_t
);

57 
ucc_¡©us_t
 
¡©us
;

59 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__cÚ‹xt_t
, &
_mlx5_cÚfig
->
su³r
,

60 
·¿ms
->
cÚ‹xt
);

61 
	`memıy
(&
£lf
->
cfg
, 
_mlx5_cÚfig
, (*tl_mlx5_config));

62 
£lf
->
sock
 = 0;

63 
£lf
->
rÿche
 = 
NULL
;

64 
£lf
->
sh¬ed_pd
 = 
NULL
;

65 
£lf
->
sh¬ed_ùx
 = 
NULL
;

66 
£lf
->
suµÜ‹d_mem_ty³s
 = 
	`UCC_BIT
(
UCC_MEMORY_TYPE_HOST
);

68 ià(
UCC_OK
 =ğ
	`ucc__mlx5_check_gpudœeù_driv”_cuda
(
£lf
->
su³r
.su³r.
lib
)) {

69 
£lf
->
suµÜ‹d_mem_ty³s
 |ğ
	`UCC_BIT
(
UCC_MEMORY_TYPE_CUDA
);

72 
¡©us
 = 
	`ucc_mpoŞ_š™
(

73 &
£lf
->
»q_mp
, 0,

74 
	`ucc_max
((
ucc__mlx5_sk_t
), (
ucc__mlx5_scheduË_t
)), 0,

75 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
, &
ucc_cŞl_sk_mpoŞ_İs
,

76 
·¿ms
->
th»ad_mode
, "tl_mlx5_req_mp");

77 ià(
UCC_OK
 !ğ
¡©us
) {

78 
	`_debug
(
£lf
->
su³r
.su³r.
lib
,

80  
¡©us
;

83 ià(!
£lf
->
cfg
.
’abË_®ÉßÎ
) {

84 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "alltoall is disabled byheƒnv variable "

88 
£lf
->
mÿ¡
.
mÿ¡_ùx_»ady
 = 0;

89 ià(
·¿ms
->
th»ad_mode
 =ğ
UCC_THREAD_SINGLE
) {

90 
¡©us
 = 
	`ucc__mlx5_mÿ¡_cÚ‹xt_š™
(&(
£lf
->
mÿ¡
), &(£lf->
cfg
.
mÿ¡_ùx_cÚf
));

91 ià(
UCC_OK
 !ğ
¡©us
) {

92 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "failedo initialize mcast context");

94 
£lf
->
mÿ¡
.
mÿ¡_ùx_»ady
 = 1;

97  
UCC_OK
;

98 
	}
}

100 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__mlx5_cÚ‹xt_t
)

102 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizingl context: %p", self);

103 ià(
£lf
->
rÿche
) {

104 
	`ucc_rÿche_de¡roy
(
£lf
->
rÿche
);

107 ià(
UCC_OK
 !ğ
	`ucc__mlx5_»move_sh¬ed_ùx_pd
(
£lf
)) {

108 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "failedo free ib ctx‡nd…d");

111 ià(
£lf
->
sock
) {

112 
	`şo£
(
£lf
->
sock
);

115 
	`ucc_mpoŞ_ş—nup
(&
£lf
->
»q_mp
, 1);

117 ià(
£lf
->
mÿ¡
.
mÿ¡_ùx_»ady
) {

118 
	`ucc__mlx5_mÿ¡_ş—n_ùx
(&
£lf
->
mÿ¡
.
mÿ¡_cÚ‹xt
);

120 
	}
}

122 
UCC_CLASS_DEFINE
(
ucc__mlx5_cÚ‹xt_t
, 
ucc__cÚ‹xt_t
);

124 
ucc_¡©us_t


125 
	$ucc__mlx5_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

126 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

128 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

129 
©Œ
->
tİo_»quœed
 = 1;

130  
UCC_OK
;

131 
	}
}

133 
ucc_¡©us_t
 
	$ucc__mlx5_ib_ùx_pd_š™
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
)

135 
pÜt
 = -1;

136 * 
ib_devÇme
 = 
NULL
;

137 
devÇme_Ën
;

138 
tmp
[128], *
pos
, *
’d_pos
;

139 
ucc_¡©us_t
 
¡©us
;

141 ià(
ùx
->
cfg
.
deviûs
.
couÁ
 > 0) {

142 
ib_devÇme
 = 
ùx
->
cfg
.
deviûs
.
Çmes
[0];

143 
pos
 = 
	`¡r¡r
(
ib_devÇme
, ":");

144 
’d_pos
 = 
ib_devÇme
 + 
	`¡¾’
(ib_devname);

145 ià(!
pos
) {

146 
devÇme_Ën
 = (
tmp
) - 1;

148 
devÇme_Ën
 = ()(
pos
 - 
ib_devÇme
);

149 
pos
++;

150 
”ºo
 = 0;

151 
pÜt
 = ()
	`¡¹Ş
(
pos
, &
’d_pos
, 10);

152 ià(
”ºo
 !ğ0 || 
pos
 =ğ
’d_pos
) {

153 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "wrong device's…ort‚umber");

154  
UCC_ERR_INVALID_PARAM
;

157 
	`¡ºıy
(
tmp
, 
ib_devÇme
, 
devÇme_Ën
);

158 
tmp
[
devÇme_Ën
] = '\0';

159 
ib_devÇme
 = 
tmp
;

162 
¡©us
 = 
	`ucc__mlx5_ü—‹_ibv_ùx
(&
ib_devÇme
, &
ùx
->
sh¬ed_ùx
, ctx->
su³r
.su³r.
lib
);

163 ià(
UCC_OK
 !ğ
¡©us
) {

164 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "failedo‡llocate ibv_context status %d",

165 
¡©us
);

166  
¡©us
;

168 ià(
pÜt
 == -1) {

169 
pÜt
 = 
	`ucc__mlx5_g‘_aùive_pÜt
(
ùx
->
sh¬ed_ùx
);

171 
ùx
->
ib_pÜt
 = 
pÜt
;

172 ià(-1 =ğ
pÜt
 || !
	`ucc__mlx5_check_pÜt_aùive
(
ùx
->
sh¬ed_ùx
,…ort)) {

173 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "no‡ctive…orts found on %s",

174 
ib_devÇme
);

175 
de¡roy_cÚ‹xt
;

177 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "usšg %s:%d", 
ib_devÇme
, 
pÜt
);

179 
ùx
->
sh¬ed_pd
 = 
	`ibv_®loc_pd
(ùx->
sh¬ed_ùx
);

180 ià(!
ùx
->
sh¬ed_pd
) {

181 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "failedo‡llocate ib_pd");

182 
de¡roy_cÚ‹xt
;

185  
UCC_OK
;

187 
de¡roy_cÚ‹xt
:

188 
	`ibv_şo£_deviû
(
ùx
->
sh¬ed_ùx
);

190  
UCC_ERR_NO_RESOURCE
;

191 
	}
}

193 
	succ__mlx5_cÚ‹xt_ü—‹_sbÿ¡_d©a
 {

194 
	mib_pÜt
;

195 
	msock_·th
[];

196 } 
	tucc__mlx5_cÚ‹xt_ü—‹_sbÿ¡_d©a_t
;

198 
ucc_¡©us_t
 
	$ucc__mlx5_cÚ‹xt_ib_ùx_pd_£tup
(
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
)

200 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`ucc_d”ived_of
(
cÚ‹xt
, ucc_tl_mlx5_context_t);

201 
ucc_cÚ‹xt_t
 * 
cÜe_ùx
 = 
cÚ‹xt
->
ucc_cÚ‹xt
;

202 cÚ¡ * 
‹m¶©e
 = "/tmp/ucc.mlx5.XXXXXX";

203 cÚ¡ * 
sockÇme
 = "/sock";

204 
size_t
 
sock_dœ_Ën
 = 
	`¡¾’
(
‹m¶©e
) + 1;

205 
size_t
 
sock_·th_Ën
 = 
sock_dœ_Ën
 + 
	`¡¾’
(
sockÇme
);

206 
size_t
 
sbÿ¡_d©a_Ëngth
 = (è+ 
sock_·th_Ën
;

207 
ucc_tİo_t
 * 
tİo
 = 
NULL
;

208 
ucc__‹am_t
 * 
¡—m
 = 
cÜe_ùx
->
£rviû_‹am
;

209 
sock_·th
[
sock_·th_Ën
];

210 
ucc_sub£t_t
 
s
;

211 
ucc_¡©us_t
 
¡©us
, 
glob®_¡©us
, 
loÿl_¡©us
;

212 
ucc_sbgp_t
 * 
sbgp
;

213 
ucc_cŞl_sk_t
 *
»q
;

214 
ucc__mlx5_cÚ‹xt_ü—‹_sbÿ¡_d©a_t
 *
sbÿ¡_d©a
;

216 ià(!
ùx
->
cfg
.
’abË_®ÉßÎ
) {

217  
UCC_OK
;

220 ià(!
cÜe_ùx
->
£rviû_‹am
) {

221 
	`_debug
(
cÚ‹xt
->
lib
, "failedo init ctx:‚eed serviceeam");

222  
UCC_ERR_NO_MESSAGE
;

224 
	`ucc_as£¹
(
cÜe_ùx
->
·¿ms
.
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
);

226 
sbÿ¡_d©a
 = (
ucc__mlx5_cÚ‹xt_ü—‹_sbÿ¡_d©a_t
 *)
	`ucc_m®loc
(

227 
sbÿ¡_d©a_Ëngth
);

228 ià(!
sbÿ¡_d©a
) {

229 
	`_debug
(
cÚ‹xt
->
lib
,

231  
UCC_ERR_NO_MEMORY
;

234 
	`mem£t
(&
s
.
m­
, 0, (
ucc_•_m­_t
));

235 
s
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

236 
s
.
m­
.
•_num
 = 
cÜe_ùx
->
·¿ms
.
oob
.
n_oob_•s
;

237 
s
.
my¿nk
 = 
cÜe_ùx
->
¿nk
;

239 
¡©us
 = 
	`_mlx5_rÿche_ü—‹
(
ùx
);

240 ià(
UCC_OK
 !ğ
¡©us
) {

241 
	`_debug
(
cÚ‹xt
->
lib
, "çedØü—‹„ÿch¡©u %d", 
¡©us
);

242 
¡¬t_®Ìeduû
;

245 
¡©us
 = 
	`ucc_tİo_š™
(
s
, 
cÜe_ùx
->
tİo
, &topo);

246 ià(
UCC_OK
 !ğ
¡©us
) {

247 
	`_debug
(
cÚ‹xt
->
lib
, "çedØš™ mlx5 ctxİØ%d", 
¡©us
);

248 
¡¬t_®Ìeduû
;

251 
¡¬t_®Ìeduû
:

252 
loÿl_¡©us
 = 
¡©us
;

253 
¡©us
 = 
	`UCC_TL_TEAM_IFACE
(
¡—m
)->
scŞl
.
	`®Ìeduû
(

254 &
¡—m
->
su³r
, &
loÿl_¡©us
, &
glob®_¡©us
, 
UCC_DT_INT32
, 1, 
UCC_OP_LOR
,

255 
s
, &
»q
);

256 ià(
UCC_OK
 !ğ
¡©us
) {

257 
	`_debug
(
cÚ‹xt
->
lib
, "failedo start mlx5 ctx‡llreduce");

258 
”r_glob®_¡©us
;

260 
UCC_INPROGRESS
 =ğ(
¡©us
 = 
	`ucc_cŞËùive_‹¡
(&
»q
->
su³r
))) {

261 
	`ucc_cÚ‹xt_´og»ss
(
cÜe_ùx
);

263 
	`ucc_cŞËùive_fš®ize_š‹º®
(
»q
);

264 ià(
UCC_OK
 !ğ
¡©us
) {

265 
	`_debug
(
cÚ‹xt
->
lib
, "failure during mlx5 ctx‡llreduce");

266 
”r_glob®_¡©us
;

268 ià(
glob®_¡©us
 !ğ
UCC_OK
 || 
loÿl_¡©us
 != UCC_OK) {

269 
	`_debug
(
cÚ‹xt
->
lib
,

272 
¡©us
 = 
glob®_¡©us
;

273 
”r_glob®_¡©us
;

275 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

276 
ùx
->
sh¬ed_ùx
 = 
NULL
;

277 
ùx
->
sh¬ed_pd
 = 
NULL
;

278 
ùx
->
is_impÜ‹d
 = 
sbgp
->
group_¿nk
 !ğ
PD_OWNER_RANK
;

280 ià(!
ùx
->
is_impÜ‹d
) {

281 
¡©us
 = 
	`ucc__mlx5_ib_ùx_pd_š™
(
ùx
);

282 ià(
UCC_OK
 !ğ
¡©us
) {

283 
ùx
->
ib_pÜt
 = 
TL_MLX5_IB_PORT_INVALID
;

284 
¡¬t_bÿ¡
;

286 ià(
UCC_SBGP_NOT_EXISTS
 =ğ
sbgp
->
¡©us
) {

287 
tİo_µn_1
;

289 
	`ucc_¡ºıy_§ã
(
sock_·th
, 
‹m¶©e
, 
sock_dœ_Ën
);

290 ià(
	`mkd‹mp
(
sock_·th
è!ğ
NULL
) {

291 
	`¡ºÿt
(
sock_·th
, 
sockÇme
,

292 (
sock_·th
è- 
	`¡¾’
(sock_path) - 1);

293 
¡©us
 = 
	`ucc__mlx5_sock‘_š™
(
ùx
, 
sbgp
->
group_size
, &ùx->
sock
,

294 
sock_·th
);

295 ià(
UCC_OK
 !ğ
¡©us
) {

296 
sock_·th
[0] = '\0';

297 
	`_debug
(
cÚ‹xt
->
lib
, "failedo init socketo share ib_ctx");

300 
	`_debug
(
cÚ‹xt
->
lib
, "failedo createmp file for socket…ath");

301 
sock_·th
[0] = '\0';

303 
	`memıy
(
sbÿ¡_d©a
->
sock_·th
, sock_path, (sock_path));

305 
¡¬t_bÿ¡
:

306 
sbÿ¡_d©a
->
ib_pÜt
 = 
ùx
->ib_port;

307 
s
.
m­
 = 
sbgp
->map;

308 
s
.
my¿nk
 = 
sbgp
->
group_¿nk
;

310 
¡©us
 = 
	`UCC_TL_TEAM_IFACE
(
¡—m
)->
scŞl
.
	`bÿ¡
(

311 &
¡—m
->
su³r
, 
sbÿ¡_d©a
, 
sbÿ¡_d©a_Ëngth
, 
PD_OWNER_RANK
, 
s
, &
»q
);

313 ià(
UCC_OK
 !ğ
¡©us
) {

314 
	`_debug
(
cÚ‹xt
->
lib
, "failedo start mlx5 ctx bcast");

315 
”r
;

317 
UCC_INPROGRESS
 =ğ(
¡©us
 = 
	`ucc_cŞËùive_‹¡
(&
»q
->
su³r
))) {

318 
	`ucc_cÚ‹xt_´og»ss
(
cÜe_ùx
);

320 
	`ucc_cŞËùive_fš®ize_š‹º®
(
»q
);

322 ià(
UCC_OK
 !ğ
¡©us
) {

323 
	`_debug
(
cÚ‹xt
->
lib
, "failure during mlx5 ctx bcast");

324 
”r
;

327 
ùx
->
ib_pÜt
 = 
sbÿ¡_d©a
->ib_port;

328 
	`memıy
(
sock_·th
, 
sbÿ¡_d©a
->sock_path, (sock_path));

330 ià(
ùx
->
ib_pÜt
 =ğ
TL_MLX5_IB_PORT_INVALID
) {

331 
	`_debug
(
cÚ‹xt
->
lib
, "invalid ib…ort„eceived");

332 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

333 
”r_ib_ùx_pd_š™
;

336 ià(
	`¡¾’
(
sock_·th
) == 0) {

337 
	`_debug
(
cÚ‹xt
->
lib
, "failedo share ctx‡nd…d");

338 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

339 
”r
;

341 
¡©us
 = 
	`ucc__mlx5_sh¬e_ùx_pd
(
ùx
, 
sock_·th
, 
sbgp
->
group_size
,

342 !
ùx
->
is_impÜ‹d
, ctx->
sock
);

344 ià(
UCC_OK
 !ğ
¡©us
) {

345 
”r
;

348 
	`rmdœ
(
sock_·th
);

349 
tİo_µn_1
:

350 
	`ucc_ä“
(
sbÿ¡_d©a
);

351 
	`ucc_tİo_ş—nup
(
tİo
);

352 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "initializedl context: %p", ctx);

353  
UCC_OK
;

355 
”r
:

356 
	`ucc__mlx5_»move_sh¬ed_ùx_pd
(
ùx
);

357 
	`rmdœ
(
sock_·th
);

358 
	`şo£
(
ùx
->
sock
);

359 
”r_ib_ùx_pd_š™
:

360 
”r_glob®_¡©us
:

361 ià(
tİo
) {

362 
	`ucc_tİo_ş—nup
(
tİo
);

364 ià(
ùx
->
rÿche
) {

365 
	`ucc_rÿche_de¡roy
(
ùx
->
rÿche
);

366 
ùx
->
rÿche
 = 
NULL
;

368 
	`ucc_ä“
(
sbÿ¡_d©a
);

369 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "failed initializel context: %p", ctx);

370  
¡©us
;

371 
	}
}

373 
ucc_¡©us_t
 
	$ucc__mlx5_cÚ‹xt_ü—‹_•og
(
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
)

375  
	`ucc__mlx5_cÚ‹xt_ib_ùx_pd_£tup
(
cÚ‹xt
);

376 
	}
}

378 
ucc_¡©us_t
 
	$ucc__mlx5_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

379 *
memh
, *
_h
)

381  
UCC_ERR_NOT_IMPLEMENTED
;

382 
	}
}

384 
ucc_¡©us_t
 
	$ucc__mlx5_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

385 *
memh
)

387  
UCC_ERR_NOT_IMPLEMENTED
;

388 
	}
}

390 
ucc_¡©us_t
 
	$ucc__mlx5_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

391 
ty³
, *
memh
, **
·ck_bufãr
)

393  
UCC_ERR_NOT_IMPLEMENTED
;

394 
	}
}

	@src/components/tl/mlx5/tl_mlx5_dm.c

7 
	~"_mlx5_dm.h
"

8 
	~"®ÉßÎ/®ÉßÎ.h
"

10 
	#DM_HOST_AUTO_NUM_CHUNKS
 8

	)

12 
	$ucc__mlx5_®ÉßÎ_©omic_ä“
(
ucc__mlx5_‹am_t
 *
‹am
)

14 ià(!
‹am
->
a2a
 || !‹am->a2a->
Ãt
.
©omic
.
couÁ”s
) {

18 
	`ibv_d”eg_mr
(
‹am
->
a2a
->
Ãt
.
©omic
.
mr
);

19 #ià
ATOMIC_IN_MEMIC


20 
	`ibv_ä“_dm
(
‹am
->
a2a
->
Ãt
.
©omic
.
couÁ”s
);

22 
	`ucc_ä“
(
‹am
->
a2a
->
Ãt
.
©omic
.
couÁ”s
);

24 
‹am
->
a2a
->
Ãt
.
©omic
.
couÁ”s
 = 
NULL
;

25 
	}
}

27 
ucc_¡©us_t
 
	$ucc__mlx5_®ÉßÎ_©omic_®loc
(
ucc__mlx5_‹am_t
 *
‹am
)

29 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
‹am
);

30 
ucc__mlx5_®ÉßÎ_t
 *
a2a
 = 
‹am
->a2a;

31 
size_t
 
size
;

33 
size
 = (*
a2a
->
Ãt
.
©omic
.
couÁ”s
è* 
MAX_OUTSTANDING_OPS
;

34 #ià
ATOMIC_IN_MEMIC


35 
ibv_®loc_dm_©Œ
 
dm_©Œ
;

36 
	`mem£t
(&
dm_©Œ
, 0, (dm_attr));

37 
dm_©Œ
.
Ëngth
 = 
size
;

38 
a2a
->
Ãt
.
©omic
.
couÁ”s
 = 
	`ibv_®loc_dm
(
ùx
->
sh¬ed_ùx
, &
dm_©Œ
);

40 
a2a
->
Ãt
.
©omic
.
couÁ”s
 = 
	`ucc_m®loc
(
size
, "atomic");

43 ià(!
a2a
->
Ãt
.
©omic
.
couÁ”s
) {

44 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
),

46 
size
);

47  
UCC_ERR_NO_MEMORY
;

49 #ià
ATOMIC_IN_MEMIC


50 
a2a
->
Ãt
.
©omic
.
mr
 =

51 
	`ibv_»g_dm_mr
(
ùx
->
sh¬ed_pd
, 
a2a
->
Ãt
.
©omic
.
couÁ”s
, 0, 
size
,

52 
IBV_ACCESS_REMOTE_ATOMIC
 | 
IBV_ACCESS_LOCAL_WRITE
 |

53 
IBV_ACCESS_ZERO_BASED
);

56 
a2a
->
Ãt
.
©omic
.
mr
 =

57 
	`ibv_»g_mr
(
ùx
->
sh¬ed_pd
, 
a2a
->
Ãt
.
©omic
.
couÁ”s
, 
size
,

58 
IBV_ACCESS_REMOTE_ATOMIC
 | 
IBV_ACCESS_LOCAL_WRITE
);

61 ià(!
a2a
->
Ãt
.
©omic
.
mr
) {

62 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
),

64 #ià
ATOMIC_IN_MEMIC


65 
	`ibv_ä“_dm
(
a2a
->
Ãt
.
©omic
.
couÁ”s
);

67 
	`ucc_ä“
(
a2a
->
Ãt
.
©omic
.
couÁ”s
);

69  
UCC_ERR_NO_MESSAGE
;

71  
UCC_OK
;

72 
	}
}

74 
	$ucc__mlx5_dm_chunk_š™
(
ucc_mpoŞ_t
 *
mp
,

75 *
obj
, *
chunk
)

77 
ucc__mlx5_dm_chunk_t
 *
c
 = (ucc__mlx5_dm_chunk_ˆ*)
obj
;

78 
ucc__mlx5_‹am_t
 *
‹am
 =

79 
	`ucc_cÚš”_of
(
mp
, 
ucc__mlx5_‹am_t
, 
dm_poŞ
);

81 
c
->
addr
 = (
ušŒ_t
)
	`PTR_OFFSET
(

82 (
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
dm_ho¡
è?—m->
dm_±r
 : 
NULL
,

83 
‹am
->
dm_off£t
);

84 
c
->
po¡ed_£nds
 = 0;

85 
c
->
po¡ed_®l
 = 0;

86 
c
->
com¶‘ed_£nds
 = 0;

87 
‹am
->
dm_off£t
 = 
	`PTR_OFFSET
(

88 
‹am
->
dm_off£t
, 
	`UCC_TL_MLX5_TEAM_LIB
Ñ—m)->
cfg
.
dm_buf_size
 *

89 
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
block_b©ch_size
);

90 
	}
}

92 
ucc_mpoŞ_İs_t
 
	gucc__mlx5_dm_İs
 = {

93 .
chunk_®loc
 = 
ucc_mpoŞ_hug‘lb_m®loc
,

94 .
	gchunk_»Ëa£
 = 
ucc_mpoŞ_hug‘lb_ä“
,

95 .
	gobj_š™
 = 
ucc__mlx5_dm_chunk_š™
,

96 .
	gobj_ş—nup
 = 
NULL
};

98 
	$ucc__mlx5_dm_poŞ_ş—nup
(
ucc__mlx5_‹am_t
 *
‹am
)

100 ià(!
‹am
->
dm_±r
 || !‹am->
a2a
) {

104 
	`ucc_mpoŞ_ş—nup
(&
‹am
->
dm_poŞ
, 1);

106 
	`ibv_d”eg_mr
(
‹am
->
dm_mr
);

107 ià(
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
dm_ho¡
) {

108 
	`ucc_ä“
(
‹am
->
dm_±r
);

110 
	`ibv_ä“_dm
(
‹am
->
dm_±r
);

112 
‹am
->
dm_±r
 = 
NULL
;

113 
	}
}

115 
	$ucc__mlx5_dm_ş—nup
(
ucc__mlx5_‹am_t
 *
‹am
)

117 
	`ucc__mlx5_dm_poŞ_ş—nup
(
‹am
);

118 
	`ucc__mlx5_®ÉßÎ_©omic_ä“
(
‹am
);

119 
	}
}

121 
ucc_¡©us_t
 
	$ucc__mlx5_dm_®loc_»g
(
ibv_cÚ‹xt
 *
ib_ùx
,

122 
ibv_pd
 *
pd
, 
dm_ho¡
,

123 
size_t
 
buf_size
, size_ˆ*
buf_num_p
,

124 
ibv_dm
 **
±r
, 
ibv_mr
 **
mr
,

125 
ucc_ba£_lib_t
 *
lib
)

127 
ibv_dm
 *
dm_±r
 = 
NULL
;

128 
ibv_mr
 *
dm_mr
;

129 
ibv_deviû_©Œ_ex
 
©Œ
;

130 
ibv_®loc_dm_©Œ
 
dm_©Œ
;

131 
max_chunks_to_®loc
, 
mš_chunks_to_®loc
, 
i
;

133 ià(
dm_ho¡
) {

134 
max_chunks_to_®loc
 = (*
buf_num_p
 =ğ
UCC_ULUNITS_AUTO
)

135 ? 
DM_HOST_AUTO_NUM_CHUNKS


136 : *
buf_num_p
;

137 
dm_©Œ
.
Ëngth
 = 
max_chunks_to_®loc
 * 
buf_size
;

138 
dm_±r
 = 
	`ucc_m®loc
(
dm_©Œ
.
Ëngth
, "memic_host");

139 ià(!
dm_±r
) {

140 
	`_debug
(
lib
, " memic_host‡llocation failed");

141  
UCC_ERR_NO_MEMORY
;

144 
dm_mr
 = 
	`ibv_»g_mr
(
pd
, 
dm_±r
, 
dm_©Œ
.
Ëngth
,

145 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
);

146 ià(!
dm_mr
) {

147 
	`_debug
(
lib
, "failedo„eg host memory");

148 
	`ucc_ä“
(
dm_±r
);

149  
UCC_ERR_NO_MESSAGE
;

151 *
buf_num_p
 = 
max_chunks_to_®loc
;

153 
©Œ
.
comp_mask
 = 0;

154 ià(
	`ibv_qu”y_deviû_ex
(
ib_ùx
, 
NULL
, &
©Œ
)) {

155 
	`_debug
(
lib
, "çedØqu”y deviû (”ºo=%d)", 
”ºo
);

156  
UCC_ERR_NO_MESSAGE
;

158 ià(!
©Œ
.
max_dm_size
) {

159 
	`_debug
(
lib
, "device doesn't support dm‡llocation");

160  
UCC_ERR_NO_RESOURCE
;

162 
max_chunks_to_®loc
 = 
mš_chunks_to_®loc
 = *
buf_num_p
;

163 ià(*
buf_num_p
 =ğ
UCC_ULUNITS_AUTO
) {

164 
max_chunks_to_®loc
 =

165 
©Œ
.
max_dm_size
 / 
buf_size
 - 1;

166 
mš_chunks_to_®loc
 = 1;

167 ià(!
max_chunks_to_®loc
) {

168 
	`_debug
(
lib
,

172 
buf_size
, 
©Œ
.
max_dm_size
 / 2,‡ttr.max_dm_size);

173  
UCC_ERR_NO_RESOURCE
;

176 ià(
©Œ
.
max_dm_size
 < 
buf_size
 * 
mš_chunks_to_®loc
) {

177 
	`_debug
(
lib
,

180 
mš_chunks_to_®loc
, 
buf_size
, 
©Œ
.
max_dm_size
);

181  
UCC_ERR_NO_MEMORY
;

183 
	`mem£t
(&
dm_©Œ
, 0, (dm_attr));

184 
i
 = 
max_chunks_to_®loc
; i >ğ
mš_chunks_to_®loc
; i--) {

185 
dm_©Œ
.
Ëngth
 = 
i
 * 
buf_size
;

186 
”ºo
 = 0;

187 
dm_±r
 = 
	`ibv_®loc_dm
(
ib_ùx
, &
dm_©Œ
);

188 ià(
dm_±r
) {

192 ià(!
dm_±r
) {

193 
	`_debug
(
lib
,

196 
dm_©Œ
.
Ëngth
, 
©Œ
.
max_dm_size
, 
”ºo
);

197  
”ºo
 =ğ
ENOMEM
 ||ƒ¼nØ=ğ
ENOSPC
 ? 
UCC_ERR_NO_MEMORY


198 : 
UCC_ERR_NO_MESSAGE
;

200 
dm_mr
 = 
	`ibv_»g_dm_mr
(
pd
, 
dm_±r
, 0, 
dm_©Œ
.
Ëngth
,

201 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
 |

202 
IBV_ACCESS_ZERO_BASED
);

203 ià(!
dm_mr
) {

204 
	`_debug
(
lib
, "failedo„eg memic");

205 
	`ibv_ä“_dm
(
dm_±r
);

206  
UCC_ERR_NO_MESSAGE
;

208 *
buf_num_p
 = 
i
;

210 *
±r
 = 
dm_±r
;

211 *
mr
 = 
dm_mr
;

213  
UCC_OK
;

214 
	}
}

216 
ucc_¡©us_t
 
	$ucc__mlx5_dm_š™
(
ucc__mlx5_‹am_t
 *
‹am
)

218 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
‹am
);

219 
ucc__mlx5_lib_cÚfig_t
 *
cfg
 = &
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->cfg;

220 
ucc_¡©us_t
 
¡©us
;

222 
¡©us
 = 
	`ucc__mlx5_®ÉßÎ_©omic_®loc
(
‹am
);

223 ià(
UCC_OK
 !ğ
¡©us
) {

224  
¡©us
;

227 
¡©us
 = 
	`ucc__mlx5_dm_®loc_»g
(

228 
ùx
->
sh¬ed_ùx
, ctx->
sh¬ed_pd
, 
cfg
->
dm_ho¡
,

229 
cfg
->
dm_buf_size
 * cfg->
block_b©ch_size
, &cfg->
dm_buf_num
,

230 &
‹am
->
dm_±r
, &‹am->
dm_mr
, 
	`UCC_TL_TEAM_LIB
(team));

231 ià(
¡©us
 !ğ
UCC_OK
) {

232 
”r_dm_®loc
;

234 
‹am
->
dm_off£t
 = 0;

236 
	`ucc_as£¹
(!
cfg
->
dm_ho¡
);

237 
¡©us
 = 
	`ucc_mpoŞ_š™
(

238 &
‹am
->
dm_poŞ
, 0, (
ucc__mlx5_dm_chunk_t
), 0,

239 
UCC_CACHE_LINE_SIZE
, 1, 
cfg
->
dm_buf_num
, &
ucc__mlx5_dm_İs
,

240 
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
->
th»ad_mode
, "mlx5 dm…ool");

241 ià(
¡©us
 !ğ
UCC_OK
) {

242 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo init dm…ool");

243 
”r_mpoŞ_š™
;

245  
UCC_OK
;

247 
”r_mpoŞ_š™
:

248 
	`ibv_d”eg_mr
(
‹am
->
dm_mr
);

249 ià(
	`UCC_TL_MLX5_TEAM_LIB
(
‹am
)->
cfg
.
dm_ho¡
) {

250 
	`ucc_ä“
(
‹am
->
dm_±r
);

252 
	`ibv_ä“_dm
(
‹am
->
dm_±r
);

254 
‹am
->
dm_±r
 = 
NULL
;

255 
”r_dm_®loc
:

256 
	`ucc__mlx5_®ÉßÎ_©omic_ä“
(
‹am
);

257  
¡©us
;

258 
	}
}

	@src/components/tl/mlx5/tl_mlx5_dm.h

7 
	~"_mlx5.h
"

9 
ucc_¡©us_t
 
ucc__mlx5_dm_®loc_»g
(
ibv_cÚ‹xt
 *
ib_ùx
,

10 
ibv_pd
 *
pd
, 
dm_ho¡
,

11 
size_t
 
buf_size
, size_ˆ*
buf_num_p
,

12 
ibv_dm
 **
±r
, 
ibv_mr
 **
mr
,

13 
ucc_ba£_lib_t
 *
lib
);

15 
ucc__mlx5_dm_ş—nup
(
ucc__mlx5_‹am_t
 *
‹am
);

17 
ucc_¡©us_t
 
ucc__mlx5_dm_š™
(
ucc__mlx5_‹am_t
 *
‹am
);

	@src/components/tl/mlx5/tl_mlx5_ib.c

7 
	~"_mlx5_ib.h
"

9 
	#UCC_QP_PKEY_INDEX
 0

	)

10 
	#UCC_QP_PSN
 0x123

	)

11 
	#UCC_QP_ACCESS_FLAGS
 (
IBV_ACCESS_LOCAL_WRITE
 | \

12 
IBV_ACCESS_REMOTE_READ
 | \

13 
IBV_ACCESS_REMOTE_WRITE
 | \

14 
IBV_ACCESS_REMOTE_ATOMIC
)

	)

16 
ucc_¡©us_t
 
	$ü—‹_ùx_fÜ_dev
(
ibv_deviû
 * 
ib_dev
,

17 
ibv_cÚ‹xt
 **
ib_ùx
)

19 
mlx5dv_cÚ‹xt_©Œ
 
©Œ
 = {};

20 
ibv_cÚ‹xt
 *
ùx
;

21 
pÜt
;

26 
©Œ
.
æags
 = 
MLX5DV_CONTEXT_FLAGS_DEVX
;

27 
ùx
 = 
	`mlx5dv_İ’_deviû
(
ib_dev
, &
©Œ
);

28 ià(!
ùx
) {

29  
UCC_ERR_NO_MESSAGE
;

32 
pÜt
 = 
	`ucc__mlx5_g‘_aùive_pÜt
(
ùx
);

33 ià(
pÜt
 < 0) {

35 
	`ibv_şo£_deviû
(
ùx
);

36  
UCC_ERR_NO_MESSAGE
;

38 *
ib_ùx
 = 
ùx
;

39  
UCC_OK
;

40 
	}
}

42 
ucc_¡©us_t
 
	$ucc__mlx5_ü—‹_ibv_ùx
(**
ib_devÇme
,

43 
ibv_cÚ‹xt
 **
ùx
,

44 
ucc_ba£_lib_t
 *
lib
)

46 
ibv_deviû
 **
dev_li¡
 = 
	`ibv_g‘_deviû_li¡
(
NULL
);

47 
ucc_¡©us_t
 
¡©us
;

48 
i
;

50 ià(!
dev_li¡
) {

51 
	`_debug
(
lib
, "no IB devices‡re‡vailable");

52  
UCC_ERR_NOT_FOUND
;

55 ià(!(*
ib_devÇme
)) {

58 
i
 = 0; 
dev_li¡
[i]; ++i) {

59 
¡©us
 = 
	`ü—‹_ùx_fÜ_dev
(
dev_li¡
[
i
], 
ùx
);

60 ià(
UCC_OK
 =ğ
¡©us
) {

61 *
ib_devÇme
 = (*)
	`ibv_g‘_deviû_Çme
(
dev_li¡
[
i
]);

62 
¡©us
 = 
UCC_OK
;

63 
out
;

67 
	`_debug
(
lib
, "no IB devices found");

68 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

69 
out
;

71 
i
 = 0; 
dev_li¡
[i]; ++i) {

72 ià(!
	`¡rcmp
(
	`ibv_g‘_deviû_Çme
(
dev_li¡
[
i
]), *
ib_devÇme
)) {

76 ià(!
dev_li¡
[
i
]) {

77 
	`_debug
(
lib
, "IB deviû % nÙ found", *
ib_devÇme
);

78 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

79 
out
;

81 
¡©us
 = 
	`ü—‹_ùx_fÜ_dev
(
dev_li¡
[
i
], 
ùx
);

84 
out
:

85 ià(
dev_li¡
) {

86 
	`ibv_ä“_deviû_li¡
(
dev_li¡
);

88  
¡©us
;

89 
	}
}

91 
	$ucc__mlx5_check_pÜt_aùive
(
ibv_cÚ‹xt
 *
ùx
, 
pÜt_num
)

93 
ibv_pÜt_©Œ
 
pÜt_©Œ
;

95 
	`ibv_qu”y_pÜt
(
ùx
, 
pÜt_num
, &
pÜt_©Œ
);

96 ià(
pÜt_©Œ
.
¡©e
 =ğ
IBV_PORT_ACTIVE
 &&

97 
pÜt_©Œ
.
lšk_Ïy”
 =ğ
IBV_LINK_LAYER_INFINIBAND
) {

101 
	}
}

103 
	$ucc__mlx5_g‘_aùive_pÜt
(
ibv_cÚ‹xt
 *
ùx
)

105 
ibv_deviû_©Œ
 
deviû_©Œ
;

106 
i
;

108 
	`ibv_qu”y_deviû
(
ùx
, &
deviû_©Œ
);

109 
i
 = 1; i <ğ
deviû_©Œ
.
phys_pÜt_út
; i++) {

110 ià(
	`ucc__mlx5_check_pÜt_aùive
(
ùx
, 
i
)) {

111  
i
;

115 
	}
}

117 
ucc_¡©us_t
 
	$ucc__mlx5_qp_cÚÃù
(
ibv_qp
 *
qp
, 
ušt32_t
 
qp_num
,

118 
ušt16_t
 
lid
, 
pÜt
,

119 
ucc__mlx5_ib_qp_cÚf_t
 *
qp_cÚf
,

120 
ucc_ba£_lib_t
 *
lib
)

122 
ibv_qp_©Œ
 
qp_©Œ
;

124 
	`mem£t
(&
qp_©Œ
, 0, (qp_attr));

125 
qp_©Œ
.
qp_¡©e
 = 
IBV_QPS_INIT
;

126 
qp_©Œ
.
pkey_šdex
 = 
UCC_QP_PKEY_INDEX
;

127 
qp_©Œ
.
pÜt_num
 = 
pÜt
;

128 
qp_©Œ
.
qp_acûss_æags
 = 
UCC_QP_ACCESS_FLAGS
;

129 ià(
	`ibv_modify_qp
(
qp
, &
qp_©Œ
,

130 
IBV_QP_STATE
 | 
IBV_QP_PKEY_INDEX
 | 
IBV_QP_PORT
 |

131 
IBV_QP_ACCESS_FLAGS
) != 0) {

132 
	`_debug
(
lib
, "QP RESET->INIT failed, %m");

133  
UCC_ERR_NO_MESSAGE
;

136 
	`mem£t
((*)&
qp_©Œ
, 0, (qp_attr));

137 
qp_©Œ
.
qp_¡©e
 = 
IBV_QPS_RTR
;

138 
qp_©Œ
.
·th_mtu
 = 
IBV_MTU_4096
;

139 
qp_©Œ
.
de¡_qp_num
 = 
qp_num
;

140 
qp_©Œ
.
rq_p¢
 = 
UCC_QP_PSN
;

141 
qp_©Œ
.
mš_ºr_tim”
 = 
qp_cÚf
->
qp_ºr_tim”
;

142 
qp_©Œ
.
max_de¡_rd_©omic
 = 
qp_cÚf
->
qp_max_©omic
;

143 
qp_©Œ
.
ah_©Œ
.
dlid
 = 
lid
;

144 
qp_©Œ
.
ah_©Œ
.
¦
 = 
qp_cÚf
->
qp_¦
;

145 
qp_©Œ
.
ah_©Œ
.
¤c_·th_b™s
 = 0;

146 
qp_©Œ
.
ah_©Œ
.
pÜt_num
 = 
pÜt
;

148 ià(
	`ibv_modify_qp
(
qp
, &
qp_©Œ
,

149 
IBV_QP_STATE
 | 
IBV_QP_AV
 | 
IBV_QP_PATH_MTU
 |

150 
IBV_QP_DEST_QPN
 | 
IBV_QP_RQ_PSN
 |

151 
IBV_QP_MAX_DEST_RD_ATOMIC
 | 
IBV_QP_MIN_RNR_TIMER
)) {

152 
	`_debug
(
lib
, "QP INIT->RTR failed, %m");

153  
UCC_ERR_NO_MESSAGE
;

157 
qp_©Œ
.
qp_¡©e
 = 
IBV_QPS_RTS
;

158 
qp_©Œ
.
timeout
 = 
qp_cÚf
->
qp_timeout
;

159 
qp_©Œ
.
»Œy_út
 = 
qp_cÚf
->
qp_»Œy_út
;

160 
qp_©Œ
.
ºr_»Œy
 = 
qp_cÚf
->
qp_ºr_»Œy
;

161 
qp_©Œ
.
sq_p¢
 = 
UCC_QP_PSN
;

162 
qp_©Œ
.
max_rd_©omic
 = 
qp_cÚf
->
qp_max_©omic
;

164 ià(
	`ibv_modify_qp
(
qp
, &
qp_©Œ
,

165 
IBV_QP_STATE
 | 
IBV_QP_TIMEOUT
 | 
IBV_QP_RETRY_CNT
 |

166 
IBV_QP_RNR_RETRY
 | 
IBV_QP_SQ_PSN
 |

167 
IBV_QP_MAX_QP_RD_ATOMIC
)) {

168 
	`_debug
(
lib
, "QP RTR->RTS failed, %m");

169  
UCC_ERR_NO_MESSAGE
;

171  
UCC_OK
;

172 
	}
}

174 
ucc_¡©us_t
 
	$ucc__mlx5_š™_dù
(
ibv_pd
 *
pd
, 
ibv_cÚ‹xt
 *
ùx
,

175 
ibv_cq
 *
cq
, 
ibv_¤q
 *
¤q
,

176 
ušt8_t
 
pÜt_num
, 
ibv_qp
 **
dù_qp
,

177 
ušt32_t
 *
q²
,

178 
ucc__mlx5_ib_qp_cÚf_t
 *
qp_cÚf
,

179 
ucc_ba£_lib_t
 *
lib
)

181 
ibv_qp_š™_©Œ_ex
 
©Œ_ex
;

182 
mlx5dv_qp_š™_©Œ
 
©Œ_dv
;

183 
ibv_qp_©Œ
 
qp_©Œ_to_š™
;

184 
ibv_qp_©Œ
 
qp_©Œ_to_¹r
;

185 
ibv_qp
 * 
qp
;

187 
	`mem£t
(&
©Œ_ex
, 0, (
ibv_qp_š™_©Œ_ex
));

188 
	`mem£t
(&
©Œ_dv
, 0, (
mlx5dv_qp_š™_©Œ
));

189 
	`mem£t
(&
qp_©Œ_to_š™
, 0, (qp_attr_to_init));

190 
	`mem£t
(&
qp_©Œ_to_¹r
, 0, (qp_attr_to_rtr));

192 
qp_©Œ_to_š™
.
qp_¡©e
 = 
IBV_QPS_INIT
;

193 
qp_©Œ_to_š™
.
pkey_šdex
 = 
UCC_QP_PKEY_INDEX
;

194 
qp_©Œ_to_š™
.
pÜt_num
 =…ort_num;

195 
qp_©Œ_to_š™
.
qp_acûss_æags
 = 
UCC_QP_ACCESS_FLAGS
;

197 
qp_©Œ_to_¹r
.
qp_¡©e
 = 
IBV_QPS_RTR
;

198 
qp_©Œ_to_¹r
.
·th_mtu
 = 
IBV_MTU_4096
;

199 
qp_©Œ_to_¹r
.
mš_ºr_tim”
 = 
qp_cÚf
->
qp_ºr_tim”
;

200 
qp_©Œ_to_¹r
.
ah_©Œ
.
pÜt_num
 =…ort_num;

201 
qp_©Œ_to_¹r
.
ah_©Œ
.
is_glob®
 = 0;

202 
qp_©Œ_to_¹r
.
ah_©Œ
.
¦
 = 
qp_cÚf
->
qp_¦
;

204 
©Œ_ex
.
qp_ty³
 = 
IBV_QPT_DRIVER
;

205 
©Œ_ex
.
£nd_cq
 = 
cq
;

206 
©Œ_ex
.
»cv_cq
 = 
cq
;

207 
©Œ_ex
.
comp_mask
 |ğ
IBV_QP_INIT_ATTR_PD
;

208 
©Œ_ex
.
pd
 =…d;

209 
©Œ_ex
.
¤q
 = srq;

211 
©Œ_dv
.
comp_mask
 |ğ
MLX5DV_QP_INIT_ATTR_MASK_DC
;

212 
©Œ_dv
.
dc_š™_©Œ
.
dc_ty³
 = 
MLX5DV_DCTYPE_DCT
;

213 
©Œ_dv
.
dc_š™_©Œ
.
dù_acûss_key
 = 
DC_KEY
;

215 
qp
 = 
	`mlx5dv_ü—‹_qp
(
ùx
, &
©Œ_ex
, &
©Œ_dv
);

216 ià(
qp
 =ğ
NULL
) {

217 
	`_debug
(
lib
, "couldn't create DCT QP, %m");

218  
UCC_ERR_NO_MESSAGE
;

221 ià(
	`ibv_modify_qp
(
qp
, &
qp_©Œ_to_š™
,

222 
IBV_QP_STATE
 | 
IBV_QP_PKEY_INDEX
 | 
IBV_QP_PORT
 |

223 
IBV_QP_ACCESS_FLAGS
) != 0) {

224 
	`_debug
(
lib
, "failedo modify init qp, %m");

225 
ç
;

228 ià(
	`ibv_modify_qp
(
qp
, &
qp_©Œ_to_¹r
,

229 
IBV_QP_STATE
 | 
IBV_QP_PATH_MTU
 | 
IBV_QP_AV
 |

230 
IBV_QP_MIN_RNR_TIMER
) != 0) {

231 
	`_debug
(
lib
, "failedo modify init qp, %m");

232 
ç
;

235 *
dù_qp
 = 
qp
;

236 *
q²
 = 
qp
->
qp_num
;

237  
UCC_OK
;

239 
ç
:

240 ià(
	`ibv_de¡roy_qp
(
qp
)) {

241 
	`_debug
(
lib
, "couldn't destroy QP, %m");

243  
UCC_ERR_NO_MESSAGE
;

244 
	}
}

246 
ucc_¡©us_t
 
	$ucc__mlx5_š™_dci
(
ucc__mlx5_dci_t
 *
dci
, 
ibv_pd
 *
pd
,

247 
ibv_cÚ‹xt
 *
ùx
, 
ibv_cq
 *
cq
,

248 
ušt8_t
 
pÜt_num
, 
tx_d•th
,

249 
ucc__mlx5_ib_qp_cÚf_t
 *
qp_cÚf
,

250 
ucc_ba£_lib_t
 *
lib
)

252 
ibv_qp_š™_©Œ_ex
 
©Œ_ex
;

253 
mlx5dv_qp_š™_©Œ
 
©Œ_dv
;

254 
ibv_qp_©Œ
 
qp_©Œ_to_š™
;

255 
ibv_qp_©Œ
 
qp_©Œ_to_¹r
;

256 
ibv_qp_©Œ
 
qp_©Œ_to_¹s
;

258 
	`mem£t
(&
©Œ_ex
, 0, (attr_ex));

259 
	`mem£t
(&
©Œ_dv
, 0, (attr_dv));

260 
	`mem£t
(&
qp_©Œ_to_š™
, 0, (qp_attr_to_init));

261 
	`mem£t
(&
qp_©Œ_to_¹r
, 0, (qp_attr_to_rtr));

262 
	`mem£t
(&
qp_©Œ_to_¹s
, 0, (qp_attr_to_rts));

264 
©Œ_ex
.
qp_ty³
 = 
IBV_QPT_DRIVER
;

265 
©Œ_ex
.
£nd_cq
 = 
cq
;

266 
©Œ_ex
.
»cv_cq
 = 
cq
;

267 
©Œ_ex
.
pd
 =…d;

268 
©Œ_ex
.
ÿp
.
max_£nd_wr
 = 
tx_d•th
;

269 
©Œ_ex
.
ÿp
.
max_£nd_sge
 = 1;

270 
©Œ_ex
.
comp_mask
 |ğ
IBV_QP_INIT_ATTR_SEND_OPS_FLAGS
 | 
IBV_QP_INIT_ATTR_PD
;

271 
©Œ_ex
.
£nd_İs_æags
 = 
IBV_QP_EX_WITH_RDMA_WRITE
 |

272 
IBV_QP_EX_WITH_RDMA_WRITE_WITH_IMM
 |

273 
IBV_QP_EX_WITH_ATOMIC_FETCH_AND_ADD
;

274 
©Œ_dv
.
comp_mask
 |ğ
MLX5DV_QP_INIT_ATTR_MASK_DC
 |

275 
MLX5DV_QP_INIT_ATTR_MASK_QP_CREATE_FLAGS
 |

276 
MLX5DV_QP_INIT_ATTR_MASK_SEND_OPS_FLAGS
;

277 
©Œ_dv
.
dc_š™_©Œ
.
dc_ty³
 = 
MLX5DV_DCTYPE_DCI
;

278 
©Œ_dv
.
ü—‹_æags
 |ğ
MLX5DV_QP_CREATE_DISABLE_SCATTER_TO_CQE
;

280 
©Œ_dv
.
£nd_İs_æags
 = 
MLX5DV_QP_EX_WITH_RAW_WQE
;

281 
qp_©Œ_to_š™
.
qp_¡©e
 = 
IBV_QPS_INIT
;

282 
qp_©Œ_to_š™
.
pkey_šdex
 = 
UCC_QP_PKEY_INDEX
;

283 
qp_©Œ_to_š™
.
pÜt_num
 =…ort_num;

284 
qp_©Œ_to_š™
.
qp_acûss_æags
 =

285 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_READ
 |

286 
IBV_ACCESS_REMOTE_WRITE
 | 
IBV_ACCESS_REMOTE_ATOMIC
;

288 
qp_©Œ_to_¹r
.
qp_¡©e
 = 
IBV_QPS_RTR
;

289 
qp_©Œ_to_¹r
.
·th_mtu
 = 
IBV_MTU_4096
;

290 
qp_©Œ_to_¹r
.
mš_ºr_tim”
 = 
qp_cÚf
->
qp_ºr_tim”
;

291 
qp_©Œ_to_¹r
.
ah_©Œ
.
pÜt_num
 =…ort_num;

292 
qp_©Œ_to_¹r
.
ah_©Œ
.
is_glob®
 = 0;

293 
qp_©Œ_to_¹r
.
ah_©Œ
.
¦
 = 
qp_cÚf
->
qp_¦
;

295 
qp_©Œ_to_¹s
.
qp_¡©e
 = 
IBV_QPS_RTS
;

296 
qp_©Œ_to_¹s
.
timeout
 = 
qp_cÚf
->
qp_timeout
;

297 
qp_©Œ_to_¹s
.
»Œy_út
 = 
qp_cÚf
->
qp_»Œy_út
;

298 
qp_©Œ_to_¹s
.
ºr_»Œy
 = 
qp_cÚf
->
qp_ºr_»Œy
;

299 
qp_©Œ_to_¹s
.
sq_p¢
 = 
UCC_QP_PSN
;

300 
qp_©Œ_to_¹s
.
max_rd_©omic
 = 
qp_cÚf
->
qp_max_©omic
;

302 
dci
->
dci_qp
 = 
	`mlx5dv_ü—‹_qp
(
ùx
, &
©Œ_ex
, &
©Œ_dv
);

303 ià(!
dci
->
dci_qp
) {

304 
	`_debug
(
lib
, "couldn't create DCI QP, %m");

305  
UCC_ERR_NO_MESSAGE
;

308 
dci
->
dc_q³x
 = 
	`ibv_qp_to_qp_ex
(dci->
dci_qp
);

309 ià(!
dci
->
dc_q³x
) {

310 
	`_debug
(
lib
, "failedurn ibv_qpo ibv_qp_ex, %m");

311 
ç
;

313 
dci
->
dc_mq³x
 = 
	`mlx5dv_qp_ex_äom_ibv_qp_ex
(dci->
dc_q³x
);

314 ià(!
dci
->
dc_mq³x
) {

315 
	`_debug
(
lib
, "failedurn ibv_qp_exo mlx5dv_qp_ex, %m");

316 
ç
;

319 ià(
	`ibv_modify_qp
(
dci
->
dci_qp
, &
qp_©Œ_to_š™
,

320 
IBV_QP_STATE
 | 
IBV_QP_PKEY_INDEX
 | 
IBV_QP_PORT
) != 0) {

321 
	`_debug
(
lib
, "failedo modify init qp, %m");

322 
ç
;

325 ià(
	`ibv_modify_qp
(
dci
->
dci_qp
, &
qp_©Œ_to_¹r
,

326 
IBV_QP_STATE
 | 
IBV_QP_PATH_MTU
 | 
IBV_QP_AV
) != 0) {

327 
	`_debug
(
lib
, "failedo modify qpo„tr, %m");

328 
ç
;

331 ià(
	`ibv_modify_qp
(
dci
->
dci_qp
, &
qp_©Œ_to_¹s
,

332 
IBV_QP_STATE
 | 
IBV_QP_TIMEOUT
 | 
IBV_QP_RETRY_CNT
 |

333 
IBV_QP_RNR_RETRY
 | 
IBV_QP_SQ_PSN
 |

334 
IBV_QP_MAX_QP_RD_ATOMIC
 | 
IBV_QP_MIN_RNR_TIMER
) != 0) {

335 
	`_debug
(
lib
, "failedo modify qpo„ts, %m");

336 
ç
;

339  
UCC_OK
;

341 
ç
:

342 ià(
	`ibv_de¡roy_qp
(
dci
->
dci_qp
)) {

343 
	`_debug
(
lib
, "couldn't destroy qp, %m");

345  
UCC_ERR_NO_MESSAGE
;

346 
	}
}

348 
ucc_¡©us_t
 
	$ucc__mlx5_ü—‹_rc_qp
(
ibv_cÚ‹xt
 *
ùx
,

349 
ibv_pd
 *
pd
, 
ibv_cq
 *
cq
,

350 
tx_d•th
, 
ucc__mlx5_qp_t
 *
qp
,

351 
ušt32_t
 *
q²
, 
ucc_ba£_lib_t
 *
lib
)

353 
ibv_qp_š™_©Œ_ex
 
©Œ_ex
;

354 
mlx5dv_qp_š™_©Œ
 
©Œ_dv
;

356 
	`mem£t
(&
©Œ_ex
, 0, (attr_ex));

357 
	`mem£t
(&
©Œ_dv
, 0, (attr_dv));

359 
©Œ_ex
.
qp_ty³
 = 
IBV_QPT_RC
;

360 
©Œ_ex
.
£nd_cq
 = 
cq
;

361 
©Œ_ex
.
»cv_cq
 = 
cq
;

362 
©Œ_ex
.
pd
 =…d;

363 
©Œ_ex
.
ÿp
.
max_£nd_wr
 = 
tx_d•th
;

364 
©Œ_ex
.
ÿp
.
max_£nd_sge
 = 1;

365 
©Œ_ex
.
comp_mask
 |ğ
IBV_QP_INIT_ATTR_SEND_OPS_FLAGS
 | 
IBV_QP_INIT_ATTR_PD
;

366 
©Œ_ex
.
£nd_İs_æags
 = 
IBV_QP_EX_WITH_RDMA_WRITE
 |

367 
IBV_QP_EX_WITH_RDMA_WRITE_WITH_IMM
 |

368 
IBV_QP_EX_WITH_ATOMIC_FETCH_AND_ADD
;

369 
©Œ_dv
.
comp_mask
 |ğ
MLX5DV_QP_INIT_ATTR_MASK_QP_CREATE_FLAGS
 |

370 
MLX5DV_QP_INIT_ATTR_MASK_SEND_OPS_FLAGS
;

371 
©Œ_dv
.
ü—‹_æags
 |ğ
MLX5DV_QP_CREATE_DISABLE_SCATTER_TO_CQE
;

372 
©Œ_dv
.
£nd_İs_æags
 = 
MLX5DV_QP_EX_WITH_RAW_WQE
;

374 
qp
->q°ğ
	`mlx5dv_ü—‹_qp
(
ùx
, &
©Œ_ex
, &
©Œ_dv
);

375 ià(!
qp
->qp) {

376 
	`_debug
(
lib
, "failedo create RC QP, %m");

377  
UCC_ERR_NO_MESSAGE
;

379 
qp
->
qp_ex
 = 
	`ibv_qp_to_qp_ex
(qp->qp);

380 *
q²
 = 
qp
->qp->
qp_num
;

382  
UCC_OK
;

383 
	}
}

385 
ucc_¡©us_t
 
	$ucc__mlx5_ü—‹_ah
(
ibv_pd
 *
pd
, 
ušt16_t
 
lid
,

386 
ušt8_t
 
pÜt_num
, 
ibv_ah
 **
ah_±r
,

387 
ucc_ba£_lib_t
 *
lib
)

389 
ibv_ah_©Œ
 
ah_©Œ
;

391 
	`mem£t
(&
ah_©Œ
, 0, (
ibv_ah_©Œ
));

393 
ah_©Œ
.
dlid
 = 
lid
;

394 
ah_©Œ
.
pÜt_num
 =…ort_num;

395 
ah_©Œ
.
is_glob®
 = 0;

396 
ah_©Œ
.
grh
.
hİ_lim™
 = 0;

398 *
ah_±r
 = 
	`ibv_ü—‹_ah
(
pd
, &
ah_©Œ
);

399 ià(!(*
ah_±r
)) {

400 
	`_debug
(
lib
, "failedo create‡h, %m");

401  
UCC_ERR_NO_MESSAGE
;

403  
UCC_OK
;

404 
	}
}

406 
ucc_¡©us_t
 
	$ucc__mlx5_ü—‹_umr_qp
(
ibv_cÚ‹xt
 *
ùx
,

407 
ibv_pd
 *
pd
, 
ibv_cq
 *
cq
,

408 
ib_pÜt
, 
ibv_qp
 **
qp
,

409 
ucc__mlx5_ib_qp_cÚf_t
 *
qp_cÚf
,

410 
ucc_ba£_lib_t
 *
lib
)

412 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

413 
ibv_qp_ex
 * 
qp_ex
 = 
NULL
;

414 
ibv_qp_š™_©Œ_ex
 
umr_š™_©Œ_ex
;

415 
mlx5dv_qp_š™_©Œ
 
umr_mlx5dv_qp_©Œ
;

416 
ibv_pÜt_©Œ
 
pÜt_©Œ
;

418 
	`mem£t
(&
umr_mlx5dv_qp_©Œ
, 0, (umr_mlx5dv_qp_attr));

419 
	`mem£t
(&
umr_š™_©Œ_ex
, 0, (umr_init_attr_ex));

421 
umr_mlx5dv_qp_©Œ
.
comp_mask
 = 
MLX5DV_QP_INIT_ATTR_MASK_SEND_OPS_FLAGS
;

422 
umr_mlx5dv_qp_©Œ
.
£nd_İs_æags
 = 
MLX5DV_QP_EX_WITH_MR_LIST
 |

423 
MLX5DV_QP_EX_WITH_MR_INTERLEAVED
 |

424 
MLX5DV_QP_EX_WITH_RAW_WQE
;

426 
umr_š™_©Œ_ex
.
£nd_cq
 = 
cq
;

427 
umr_š™_©Œ_ex
.
»cv_cq
 = 
cq
;

428 
umr_š™_©Œ_ex
.
ÿp
.
max_£nd_wr
 = 1;

429 
umr_š™_©Œ_ex
.
ÿp
.
max_»cv_wr
 = 1;

430 
umr_š™_©Œ_ex
.
ÿp
.
max_£nd_sge
 = 1;

431 
umr_š™_©Œ_ex
.
ÿp
.
max_»cv_sge
 = 1;

432 
umr_š™_©Œ_ex
.
qp_ty³
 = 
IBV_QPT_RC
;

433 
umr_š™_©Œ_ex
.
comp_mask
 =

434 
IBV_QP_INIT_ATTR_SEND_OPS_FLAGS
 | 
IBV_QP_INIT_ATTR_PD
;

435 
umr_š™_©Œ_ex
.
pd
 =…d;

436 
umr_š™_©Œ_ex
.
£nd_İs_æags
 |ğ
IBV_QP_EX_WITH_SEND
;

442 
umr_š™_©Œ_ex
.
ÿp
.
max_šlše_d©a
 = 828;

444 *
qp
 = 
	`mlx5dv_ü—‹_qp
(
ùx
, &
umr_š™_©Œ_ex
, &
umr_mlx5dv_qp_©Œ
);

445 ià(
umr_š™_©Œ_ex
.
ÿp
.
max_šlše_d©a
 == 828) {

446 
umr_š™_©Œ_ex
.
ÿp
.
max_šlše_d©a
 = 768;

448 
umr_š™_©Œ_ex
.
ÿp
.
max_šlše_d©a
 -= 128;

450 } *
qp
 =ğ
NULL
 && 
umr_š™_©Œ_ex
.
ÿp
.
max_šlše_d©a
 > 0);

452 ià(*
qp
 =ğ
NULL
) {

453 
	`_debug
(
lib
, "failedo create UMR QP with inline_data, %m");

454  
UCC_ERR_NO_MESSAGE
;

456 
qp_ex
 = 
	`ibv_qp_to_qp_ex
(*
qp
);

457 ià(
qp_ex
 =ğ
NULL
) {

458 
	`_debug
(
lib
, "failedo create UMR qp_ex, %m");

459 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

460 
çu»
;

462 
qp_ex
->
wr_æags
 = 
IBV_SEND_INLINE
 | 
IBV_SEND_SIGNALED
;

463 ià(
	`ibv_qu”y_pÜt
(
ùx
, 
ib_pÜt
, &
pÜt_©Œ
)) {

464 
	`_debug
(
lib
, "failedo get…ort info, %m");

465 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

466 
çu»
;

468 
¡©us
 = 
	`ucc__mlx5_qp_cÚÃù
(*
qp
, (*qp)->
qp_num
, 
pÜt_©Œ
.
lid
, 
ib_pÜt
,

469 
qp_cÚf
, 
lib
);

470 ià(
¡©us
 !ğ
UCC_OK
) {

471 
çu»
;

474 
	`_debug
(
lib
, "created UMR QP, cap.max_inline_data = %d",

475 
umr_š™_©Œ_ex
.
ÿp
.
max_šlše_d©a
);

477  
UCC_OK
;

479 
çu»
:

480 ià(*
qp
) {

481 ià(
	`ibv_de¡roy_qp
(*
qp
)) {

482 
	`_debug
(
lib
, "failedo destroy UMR QP, %m");

485 *
qp
 = 
NULL
;

486  
¡©us
;

487 
	}
}

	@src/components/tl/mlx5/tl_mlx5_ib.h

7 #iâdeà
UCC_TL_MLX5_IB_H_


8 
	#UCC_TL_MLX5_IB_H_


	)

10 
	~"_mlx5.h
"

12 
mlx5dv_mr_š‹¾—ved
 
	tumr_t
;

14 
	succ__mlx5_qp
 {

15 
ibv_qp
 * 
	mqp
;

16 
ibv_qp_ex
 *
	mqp_ex
;

17 } 
	tucc__mlx5_qp_t
;

19 
	succ__mlx5_dci
 {

20 
ibv_qp
 * 
	mdci_qp
;

21 
ibv_qp_ex
 * 
	mdc_q³x
;

22 
mlx5dv_qp_ex
 *
	mdc_mq³x
;

23 } 
	tucc__mlx5_dci_t
;

25 
ucc__mlx5_g‘_aùive_pÜt
(
ibv_cÚ‹xt
 *
ùx
);

27 
ucc__mlx5_check_pÜt_aùive
(
ibv_cÚ‹xt
 *
ùx
, 
pÜt_num
);

29 
ucc_¡©us_t
 
ucc__mlx5_ü—‹_ibv_ùx
(** 
ib_devÇme
,

30 
ibv_cÚ‹xt
 **
ùx
,

31 
ucc_ba£_lib_t
 * 
lib
);

33 
ucc_¡©us_t
 
ucc__mlx5_qp_cÚÃù
(
ibv_qp
 *
qp
, 
ušt32_t
 
qp_num
,

34 
ušt16_t
 
lid
, 
pÜt
,

35 
ucc__mlx5_ib_qp_cÚf_t
 *
qp_cÚf
,

36 
ucc_ba£_lib_t
 *
lib
);

38 
ucc_¡©us_t
 
ucc__mlx5_š™_dù
(
ibv_pd
 *
pd
, 
ibv_cÚ‹xt
 *
ùx
,

39 
ibv_cq
 *
cq
, 
ibv_¤q
 *
¤q
,

40 
ušt8_t
 
pÜt_num
, 
ibv_qp
 **
dù_qp
,

41 
ušt32_t
 *
q²
,

42 
ucc__mlx5_ib_qp_cÚf_t
 *
qp_cÚf
,

43 
ucc_ba£_lib_t
 *
lib
);

45 
ucc_¡©us_t
 
ucc__mlx5_š™_dci
(
ucc__mlx5_dci_t
 *
dci
, 
ibv_pd
 *
pd
,

46 
ibv_cÚ‹xt
 *
ùx
, 
ibv_cq
 *
cq
,

47 
ušt8_t
 
pÜt_num
, 
tx_d•th
,

48 
ucc__mlx5_ib_qp_cÚf_t
 *
qp_cÚf
,

49 
ucc_ba£_lib_t
 *
lib
);

51 
ucc_¡©us_t
 
ucc__mlx5_ü—‹_rc_qp
(
ibv_cÚ‹xt
 *
ùx
,

52 
ibv_pd
 *
pd
, 
ibv_cq
 *
cq
,

53 
tx_d•th
, 
ucc__mlx5_qp_t
 *
qp
,

54 
ušt32_t
 *
q²
, 
ucc_ba£_lib_t
 *
lib
);

56 
ucc_¡©us_t
 
ucc__mlx5_ü—‹_ah
(
ibv_pd
 *
pd
, 
ušt16_t
 
lid
,

57 
ušt8_t
 
pÜt_num
, 
ibv_ah
 **
ah_±r
,

58 
ucc_ba£_lib_t
 *
lib
);

60 
ucc_¡©us_t
 
ucc__mlx5_ü—‹_umr_qp
(
ibv_cÚ‹xt
 *
ùx
,

61 
ibv_pd
 *
pd
, 
ibv_cq
 *
cq
,

62 
ib_pÜt
, 
ibv_qp
 **
qp
,

63 
ucc__mlx5_ib_qp_cÚf_t
 *
qp_cÚf
,

64 
ucc_ba£_lib_t
 *
lib
);

66 
šlše
 
ucc_¡©us_t
 
	$_mlx5_ah_to_av
(
ibv_ah
 *
ah
, 
mlx5_wqe_av
 *
av
)

68 
mlx5dv_obj
 
obj
;

69 
mlx5dv_ah
 
dv_ah
;

71 
obj
.
ah
.
š
 =‡h;

72 
obj
.
ah
.
out
 = &
dv_ah
;

73 ià(
	`ucc_uÆik–y
(
	`mlx5dv_š™_obj
(&
obj
, 
MLX5DV_OBJ_AH
))) {

74  
UCC_ERR_NO_MESSAGE
;

77 *
av
 = *(
dv_ah
.av);

78  
UCC_OK
;

79 
	}
}

	@src/components/tl/mlx5/tl_mlx5_lib.c

7 
	~"_mlx5.h
"

8 
	~"uts/ucc_m®loc.h
"

11 
	$UCC_CLASS_INIT_FUNC
(
ucc__mlx5_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

12 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

14 cÚ¡ 
ucc__mlx5_lib_cÚfig_t
 *
_mlx5_cÚfig
 =

15 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__mlx5_lib_cÚfig_t
);

16 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__lib_t
, &
ucc__mlx5
.
su³r
,

17 &
_mlx5_cÚfig
->
su³r
);

18 
	`memıy
(&
£lf
->
cfg
, 
_mlx5_cÚfig
, (*tl_mlx5_config));

19 
	`_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

20  
UCC_OK
;

21 
	}
}

23 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__mlx5_lib_t
)

25 
	`_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

26 
	}
}

28 
UCC_CLASS_DEFINE
(
ucc__mlx5_lib_t
, 
ucc__lib_t
);

30 
ucc_¡©us_t
 
	$ucc__mlx5_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

31 
ucc_ba£_lib_©Œ_t
 * 
ba£_©Œ
)

33 
ucc__lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_tl_lib_attr_t);

34 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

35 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 
UCC_TL_MLX5_SUPPORTED_COLLS
;

36 
©Œ
->
su³r
.
æags
 = 
UCC_BASE_LIB_FLAG_SERVICE_TEAM_REQUIRED
 |

37 
UCC_BASE_LIB_FLAG_CTX_SERVICE_TEAM_REQUIRED
;

38 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
) {

39 
©Œ
->
su³r
.
mš_‹am_size
 = 
lib
->min_team_size;

42 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
) {

43 
©Œ
->
su³r
.
max_‹am_size
 = 
UCC_RANK_MAX
;

46  
UCC_OK
;

47 
	}
}

49 
ucc_¡©us_t
 
	$ucc__mlx5_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

51 
´İ
->
deçuÉ_‹am_size
 = 2;

52 
´İ
->
mš_‹am_size
 = 2;

53 
´İ
->
max_‹am_size
 = 
UCC_RANK_MAX
;

54  
UCC_OK
;

55 
	}
}

	@src/components/tl/mlx5/tl_mlx5_pd.c

7 
	~"_mlx5.h
"

8 
	~"_mlx5_pd.h
"

11 
	msock
, 
	mfd
;

12 
ušt32_t
 
	mpd_hªdË
;

13 } 
	tcÚÃùiÚ_t
;

15 
ucc_¡©us_t
 
	$do_£ndmsg
(
cÚÃùiÚ_t
 *
cÚn
)

17 
msghdr
 
msg
 = {};

18 
cmsghdr
 *cmsghdr;

19 
iovec
 
iov
;

20 
ssize_t
 
nby‹s
;

21 * 
p
;

22 
buf
[
	`CMSG_SPACE
(())];

23 
ušt32_t
 
hªdË
;

25 
hªdË
 = 
cÚn
->
pd_hªdË
;

26 
iov
.
iov_ba£
 = &
hªdË
;

27 
iov
.
iov_Ën
 = (
hªdË
);

28 
	`mem£t
(
buf
, 0x0b, (buf));

29 
cmsghdr
 = (cmsghd¸*)
buf
;

30 
cmsghdr
->
cmsg_Ën
 = 
	`CMSG_LEN
(());

31 
cmsghdr
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

32 
cmsghdr
->
cmsg_ty³
 = 
SCM_RIGHTS
;

33 
msg
.
msg_Çme
 = 
NULL
;

34 
msg
.
msg_Çm–’
 = 0;

35 
msg
.
msg_iov
 = &
iov
;

36 
msg
.
msg_iovËn
 = 1;

37 
msg
.
msg_cÚŒŞ
 = 
cmsghdr
;

38 
msg
.
msg_cÚŒŞËn
 = 
	`CMSG_LEN
(());

39 
msg
.
msg_æags
 = 0;

40 
p
 = (*)
	`CMSG_DATA
(
cmsghdr
);

41 *
p
 = 
cÚn
->
fd
;

43 
nby‹s
 = 
	`£ndmsg
(
cÚn
->
sock
, &
msg
, 0);

44 ià(
nby‹s
 == -1) {

45  
UCC_ERR_NO_MESSAGE
;

47  
UCC_OK
;

48 
	}
}

50 
ucc_¡©us_t
 
	$do_»cvmsg
(
sock
, *
sh¬ed_cmd_fd
,

51 
ušt32_t
 *
sh¬ed_pd_hªdË
)

53 
ušt32_t
 
hªdË
;

54 
msghdr
 
msg
;

55 
cmsghdr
 *cmsghdr;

56 
iovec
 
iov
;

57 
ssize_t
 
nby‹s
;

58 * 
p
;

59 
buf
[
	`CMSG_SPACE
(())];

61 
iov
.
iov_ba£
 = &
hªdË
;

62 
iov
.
iov_Ën
 = (
hªdË
);

64 
	`mem£t
(
buf
, 0x0d, (buf));

65 
cmsghdr
 = (cmsghd¸*)
buf
;

66 
cmsghdr
->
cmsg_Ën
 = 
	`CMSG_LEN
(());

67 
cmsghdr
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

68 
cmsghdr
->
cmsg_ty³
 = 
SCM_RIGHTS
;

69 
msg
.
msg_Çme
 = 
NULL
;

70 
msg
.
msg_Çm–’
 = 0;

71 
msg
.
msg_iov
 = &
iov
;

72 
msg
.
msg_iovËn
 = 1;

73 
msg
.
msg_cÚŒŞ
 = 
cmsghdr
;

74 
msg
.
msg_cÚŒŞËn
 = 
	`CMSG_LEN
(());

75 
msg
.
msg_æags
 = 0;

77 
nby‹s
 = 
	`»cvmsg
(
sock
, &
msg
, 0);

78 ià(
nby‹s
 == -1) {

79  
UCC_ERR_NO_MESSAGE
;

82 
p
 = (*)
	`CMSG_DATA
(
cmsghdr
);

84 *
sh¬ed_cmd_fd
 = *
p
;

85 *
sh¬ed_pd_hªdË
 = 
hªdË
;

87  
UCC_OK
;

88 
	}
}

90 
ucc_¡©us_t
 
	$ucc__mlx5_sock‘_š™
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
,

91 
ucc_¿nk_t
 
group_size
, *
sock_p
,

92 cÚ¡ *
sock_·th
)

94 
sockaddr_¡Üage
 
¡Üage
 = {};

95 
sockaddr_un
 * 
addr
;

96 
sock
;

98 
sock
 = 
	`sock‘
(
PF_LOCAL
, 
SOCK_STREAM
, 0);

99 ià(
sock
 == -1) {

100 
	`_debug
(
ùx
->
su³r
.su³r.
lib
,

101 "çedØü—‹ s”v” sock‘ƒ¼nØ%d", 
”ºo
);

102  
UCC_ERR_NO_MESSAGE
;

105 
addr
 = (
sockaddr_un
 *)&
¡Üage
;

106 
addr
->
sun_çmy
 = 
AF_UNIX
;

107 
	`¡ºıy
(
addr
->
sun_·th
, 
sock_·th
, (addr->sun_path));

108 
addr
->
sun_·th
[(addr->sun_path) - 1] = '\0';

110 ià(
	`bšd
(
sock
, (
sockaddr
 *)
addr
, (
sockaddr_un
)) == -1) {

111 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "failedo bind server socketƒrrno %d",

112 
”ºo
);

113 
out
;

115 ià(
	`li¡’
(
sock
, 
group_size
) == -1) {

116 
	`_debug
(
ùx
->
su³r
.su³r.
lib
,

117 "çedØli¡’Ø£rv” sock‘ƒ¼nØ%d", 
”ºo
);

118 
out
;

120 *
sock_p
 = 
sock
;

121  
UCC_OK
;

123 
out
:

124 
	`şo£
(
sock
);

125  
UCC_ERR_NO_MESSAGE
;

126 
	}
}

128 
ucc_¡©us_t
 
	$ş›Á_»cv_d©a
(*
sh¬ed_cmd_fd
,

129 
ušt32_t
 *
sh¬ed_pd_hªdË
,

130 cÚ¡ *
sock_·th
, *
sock_p
,

131 
ucc__mlx5_lib_t
 *
lib
)

133 
sockaddr_¡Üage
 
sockaddr
 = {};

134 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

135 
sockaddr_un
 * 
addr
;

136 
sock
;

138 
sock
 = 
	`sock‘
(
PF_LOCAL
, 
SOCK_STREAM
, 0);

139 ià(
sock
 == -1) {

140 
	`_debug
(
lib
, "çedØü—‹ cl›Á sock‘ƒ¼nØ%d", 
”ºo
);

141  
UCC_ERR_NO_MESSAGE
;

144 
addr
 = (
sockaddr_un
 *)&
sockaddr
;

145 
addr
->
sun_çmy
 = 
AF_UNIX
;

146 
	`¡ºıy
(
addr
->
sun_·th
, 
sock_·th
, (addr->sun_path));

147 
addr
->
sun_·th
[(addr->sun_path) - 1] = '\0';

149 
	`cÚÃù
(
sock
, (
sockaddr
 *)
addr
, 
	`SUN_LEN
(addr)) == -1) {

150 ià(
”ºo
 !ğ
ENOENT
) {

151 
	`_debug
(
lib
, "çedØcÚÃù cl›Á sock‘ƒ¼nØ%d", 
”ºo
);

152 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

153 
out
;

156 ià(
	`do_»cvmsg
(
sock
, 
sh¬ed_cmd_fd
, 
sh¬ed_pd_hªdË
è!ğ
UCC_OK
) {

157 
	`_debug
(
lib
, "Failedo„ecv msg");

158 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

159 
out
;

162 *
sock_p
 = 
sock
;

163  
UCC_OK
;

165 
out
:

166 ià(
	`şo£
(
sock
) == -1) {

167 
	`_debug
(
lib
, "FaedØşo£ cl›Á sock‘ƒ¼nØ%d", 
”ºo
);

168 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

170  
¡©us
;

171 
	}
}

173 
ucc_¡©us_t
 
	$£rv”_£nd_d©a
(
commªd_fd
, 
ušt32_t
 
pd_hªdË
,

174 
ucc_¿nk_t
 
group_size
, 
sock
,

175 
ucc__mlx5_lib_t
 *
lib
)

177 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

178 
i
;

179 
cÚÃùiÚ_t
 
cÚÃùiÚ
[
group_size
];

180 
sockaddr_un
 
addr
;

181 
sockËn_t
 
add¾’
;

183 
i
 = 0; i < 
group_size
; i++) {

185 
cÚÃùiÚ
[
i
].
fd
 = 
commªd_fd
;

186 
cÚÃùiÚ
[
i
].
pd_hªdË
 =…d_handle;

187 
cÚÃùiÚ
[
i
].
sock
 = 
	`acû±
(sock, 
NULL
, 0);

188 ià(
cÚÃùiÚ
[
i
].
sock
 == -1) {

189 
	`_debug
(
lib
,

192 
i
, 
”ºo
);

193 
li¡’_ç
;

195 
¡©us
 = 
	`do_£ndmsg
(&
cÚÃùiÚ
[
i
]);

196 ià(
¡©us
 !ğ
UCC_OK
) {

197 
	`_debug
(
lib
, "failedo send cmd_fd");

198 
li¡’_ç
;

202 
add¾’
 = (
addr
);

203 
	`g‘sockÇme
(
sock
, (
sockaddr
 *)&
addr
, &
add¾’
);

205 ià(
	`»move
(
addr
.
sun_·th
) == -1) {

206 
	`_debug
(
lib
, "socket file„emoval failed");

207 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

210  
¡©us
;

212 
li¡’_ç
:

213 ià(
	`şo£
(
sock
) == -1) {

214 
	`_debug
(
lib
, "çedØşo£ s”v” sock‘ƒ¼nØ%d", 
”ºo
);

215 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

218  
¡©us
;

219 
	}
}

221 
ucc_¡©us_t
 
	$ucc__mlx5_sh¬e_ùx_pd
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
,

222 cÚ¡ * 
sock_·th
,

223 
ucc_¿nk_t
 
group_size
, 
is_ùx_owÃr
,

224 
ùx_owÃr_sock
)

226 
ucc__mlx5_lib_t
 *
lib
 =

227 
	`ucc_d”ived_of
(
ùx
->
su³r
.su³r.
lib
, 
ucc__mlx5_lib_t
);

228 
ùx_fd
;

229 
ušt32_t
 
pd_hªdË
;

230 
ucc_¡©us_t
 
¡©us
;

232 ià(!
is_ùx_owÃr
) {

233 
¡©us
 =

234 
	`ş›Á_»cv_d©a
(&
ùx_fd
, &
pd_hªdË
, 
sock_·th
, &
ùx
->
sock
, 
lib
);

235 ià(
UCC_OK
 !ğ
¡©us
) {

236 
	`_debug
(
lib
, "failedo share ctx &…d from client side");

237  
¡©us
;

239 
ùx
->
sh¬ed_ùx
 = 
	`ibv_impÜt_deviû
(
ùx_fd
);

240 ià(!
ùx
->
sh¬ed_ùx
) {

241 
	`_debug
(
lib
, "import context failed");

242  
UCC_ERR_NO_MESSAGE
;

244 
ùx
->
sh¬ed_pd
 = 
	`ibv_impÜt_pd
(ùx->
sh¬ed_ùx
, 
pd_hªdË
);

245 ià(!
ùx
->
sh¬ed_pd
) {

246 
	`_debug
(
lib
, "import PD failed");

247 ià(
	`ibv_şo£_deviû
(
ùx
->
sh¬ed_ùx
)) {

248 
	`_debug
(
lib
, "imported context close failed");

250  
UCC_ERR_NO_MESSAGE
;

253 
ùx_fd
 = 
ùx
->
sh¬ed_ùx
->
cmd_fd
;

254 
pd_hªdË
 = 
ùx
->
sh¬ed_pd
->
hªdË
;

255 
¡©us
 = 
	`£rv”_£nd_d©a
(
ùx_fd
, 
pd_hªdË
, 
group_size
 - 1,

256 
ùx_owÃr_sock
, 
lib
);

257 ià(
UCC_OK
 !ğ
¡©us
) {

258 
	`_debug
(
lib
, "failedo share ctx &…d from server side");

259  
¡©us
;

262  
UCC_OK
;

263 
	}
}

265 
	$ucc__mlx5_cÚ‹xt_b¬r›r
(
ucc_cÚ‹xt_oob_cŞl_t
 *
oob
,

266 
ucc_cÚ‹xt_t
 *
cÜe_ùx
,

267 
ucc_ba£_lib_t
 *
lib
)

269 *
rbuf
;

270 
sbuf
;

271 *
»q
;

272 
ucc_¡©us_t
 
¡©us
;

274 ià(
	`ucc_uÆik–y
(
oob
->
n_oob_•s
 < 2)) {

278 
rbuf
 = 
	`ucc_m®loc
((è* 
oob
->
n_oob_•s
, "tmp_barrier");

279 ià(!
rbuf
) {

280 
	`_debug
(
lib
, "failedo‡llocate %zd bytes formp barrier‡rray",

281 (è* 
oob
->
n_oob_•s
);

284 ià(
UCC_OK
 ==

285 
oob
->
	`®lg©h”
(&
sbuf
, 
rbuf
, (), oob->
cŞl_šfo
, &
»q
)) {

286 
	`ucc_as£¹
(
»q
 !ğ
NULL
);

287 
UCC_OK
 !ğ(
¡©us
 = 
oob
->
	`»q_‹¡
(
»q
))) {

288 
	`ucc_cÚ‹xt_´og»ss
(
cÜe_ùx
);

289 ià(
¡©us
 < 0) {

290 
	`_debug
(
lib
, "failedoest oob„eq");

294 
oob
->
	`»q_ä“
(
»q
);

296 
	`ucc_ä“
(
rbuf
);

297 
	}
}

299 
ucc_¡©us_t
 
	$ucc__mlx5_»move_sh¬ed_ùx_pd
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
)

301 
ucc_ba£_lib_t
 *
lib
 = 
ùx
->
su³r
.super.lib;

302 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

303 
”r
;

305 ià(
ùx
->
sh¬ed_pd
 && ctx->
is_impÜ‹d
) {

306 
	`ibv_unimpÜt_pd
(
ùx
->
sh¬ed_pd
);

308 
	`ucc__mlx5_cÚ‹xt_b¬r›r
(&
	`UCC_TL_CTX_OOB
(
ùx
),

309 
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
, 
lib
);

310 ià(
ùx
->
sh¬ed_pd
 && !ùx->
is_impÜ‹d
) {

311 
”r
 = 
	`ibv_d—Îoc_pd
(
ùx
->
sh¬ed_pd
);

312 ià(
”r
) {

313 
	`_debug
(
lib
, "çedØd—ÎoøPD,ƒ¼nØ%d", 
”r
);

314 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

318 ià(
ùx
->
sh¬ed_ùx
) {

319 ià(
	`ibv_şo£_deviû
(
ùx
->
sh¬ed_ùx
)) {

320 
	`_debug
(
lib
, "failedo close ib ctx");

321 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

325  
¡©us
;

326 
	}
}

	@src/components/tl/mlx5/tl_mlx5_pd.h

7 #iâdeà
TL_MLX5_PD_H


8 
	#TL_MLX5_PD_H


	)

10 
	~<sys/un.h
>

12 
ucc__mlx5_‹am
 
	tucc__mlx5_‹am_t
;

14 
ucc_¡©us_t
 
ucc__mlx5_sh¬e_ùx_pd
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
,

15 cÚ¡ * 
sock_·th
,

16 
ucc_¿nk_t
 
group_size
, 
is_ùx_owÃr
,

17 
ùx_owÃr_sock
);

19 
ucc_¡©us_t
 
ucc__mlx5_»move_sh¬ed_ùx_pd
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
);

21 
ucc_¡©us_t
 
ucc__mlx5_sock‘_š™
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
,

22 
ucc_¿nk_t
 
group_size
, *
sock_p
,

23 cÚ¡ *
sock_·th
);

	@src/components/tl/mlx5/tl_mlx5_rcache.c

7 
	~"_mlx5.h
"

9 
ucs_¡©us_t


10 
	$rÿche_»g_mr
(*
cÚ‹xt
, 
ucc_rÿche_t
 *
rÿche
,

11 *
¬g
, 
ucc_rÿche_»giÚ_t
 *
¼egiÚ
,

12 
ušt16_t
 
æags
)

14 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 =

15 (
ucc__mlx5_cÚ‹xt_t
 *)
cÚ‹xt
;

16 *
addr
 = (*)
¼egiÚ
->
su³r
.
¡¬t
;

17 
size_t
 
Ëngth
 = (size_t)(
¼egiÚ
->
su³r
.
’d


18 - 
¼egiÚ
->
su³r
.
¡¬t
);

19 *
chªge_æag
 = (*)
¬g
;

20 
ucc__mlx5_rÿche_»giÚ_t
 *
mlx5_¼egiÚ
 = 
	`ucc_d”ived_of
(
¼egiÚ
,

21 
ucc__mlx5_rÿche_»giÚ_t
);

23 *
chªge_æag
 = 1;

24 
mlx5_¼egiÚ
->
»g
.
mr
 =

25 
	`ibv_»g_mr
(
ùx
->
sh¬ed_pd
, 
addr
, 
Ëngth
,

26 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
);

27 ià(!
mlx5_¼egiÚ
->
»g
.
mr
) {

28 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo„egister memory");

29  
UCS_ERR_NO_MESSAGE
;

31  
UCS_OK
;

32 
	}
}

34 
	$rÿche_d”eg_mr
(*
cÚ‹xt
,

35 
ucc_rÿche_t
 *
rÿche
,

36 
ucc_rÿche_»giÚ_t
 *
¼egiÚ
)

38 
ucc__mlx5_rÿche_»giÚ_t
 *
mlx5_¼egiÚ
 =

39 
	`ucc_d”ived_of
(
¼egiÚ
, 
ucc__mlx5_rÿche_»giÚ_t
);

41 
	`ibv_d”eg_mr
(
mlx5_¼egiÚ
->
»g
.
mr
);

42 
	}
}

44 
	$ucc__mlx5_rÿche_dump_»giÚ_cb
(*
cÚ‹xt
,

45 
ucc_rÿche_t
 *
rÿche
,

46 
ucs_rÿche_»giÚ_t
 *
¼egiÚ
,

47 *
buf
, 
size_t
 
max
)

49 
ucc__mlx5_rÿche_»giÚ_t
 *
mlx5_¼egiÚ
 =

50 
	`ucc_d”ived_of
(
¼egiÚ
, 
ucc__mlx5_rÿche_»giÚ_t
);

52 
	`¢´štf
(
buf
, 
max
, "b¬…Œ:%p", 
mlx5_¼egiÚ
->
»g
.
mr
);

53 
	}
}

55 
ucc_rÿche_İs_t
 
	gucc__mlx5_rÿche_İs
 = {

56 .
mem_»g
 = 
rÿche_»g_mr
,

57 .
	gmem_d”eg
 = 
rÿche_d”eg_mr
,

58 .
	gdump_»giÚ
 = 
ucc__mlx5_rÿche_dump_»giÚ_cb
,

59 #ifdeà
UCS_HAVE_RCACHE_MERGE_CB


60 .
	gm”ge
 = 
ucc_rÿche_m”ge_cb_em±y


64 
ucc_¡©us_t
 
	$_mlx5_rÿche_ü—‹
(
ucc__mlx5_cÚ‹xt_t
 *
ùx
)

66 
ucc_rÿche_·¿ms_t
 
rÿche_·¿ms
;

68 
	`ucc_rÿche_£t_deçuÉ_·¿ms
(&
rÿche_·¿ms
);

69 
rÿche_·¿ms
.
»giÚ_¡ruù_size
 = (
ucc__mlx5_rÿche_»giÚ_t
);

70 
rÿche_·¿ms
.
cÚ‹xt
 = 
ùx
;

71 
rÿche_·¿ms
.
İs
 = &
ucc__mlx5_rÿche_İs
;

72 
rÿche_·¿ms
.
ucm_ev’ts
 = 
UCM_EVENT_VM_UNMAPPED
 |

73 
UCM_EVENT_MEM_TYPE_FREE
;

75  
	`ucc_rÿche_ü—‹
(&
rÿche_·¿ms
, "MLX5_A2A", &
ùx
->
rÿche
);

76 
	}
}

	@src/components/tl/mlx5/tl_mlx5_team.c

7 
	~"_mlx5_cŞl.h
"

8 
	~"_mlx5.h
"

9 
	~"_mlx5_cŞl.h
"

10 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

11 
	~"®ÉßÎ/®ÉßÎ.h
"

12 
	~"cÜe/ucc_‹am.h
"

13 
	~<sys/shm.h
>

14 
	~"mÿ¡/_mlx5_mÿ¡.h
"

15 
	~"mÿ¡/_mlx5_mÿ¡_h–³r.h
"

17 
ucc_¡©us_t
 
	$ucc__mlx5_tİo_š™
(
ucc__mlx5_‹am_t
 *
‹am
)

19 
ucc_sub£t_t
 
sub£t
;

20 
ucc_¡©us_t
 
¡©us
;

22 
¡©us
 = 
	`ucc_•_m­_ü—‹_Ã¡ed
(&
	`UCC_TL_CORE_TEAM
(
‹am
)->
ùx_m­
,

23 &
	`UCC_TL_TEAM_MAP
(
‹am
), &‹am->
ùx_m­
);

24 ià(
UCC_OK
 !ğ
¡©us
) {

25 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo create ctx map");

26  
¡©us
;

28 
sub£t
.
m­
 = 
‹am
->
ùx_m­
;

29 
sub£t
.
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

31 
¡©us
 = 
	`ucc_tİo_š™
(
sub£t
, 
	`UCC_TL_CORE_CTX
(
‹am
)->
tİo
, &team->topo);

33 ià(
UCC_OK
 !ğ
¡©us
) {

34 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo initeamopo");

35 
”r_tİo_š™
;

38  
UCC_OK
;

39 
”r_tİo_š™
:

40 
	`ucc_•_m­_de¡roy_Ã¡ed
(&
‹am
->
ùx_m­
);

41  
¡©us
;

42 
	}
}

44 
	$ucc__mlx5_tİo_ş—nup
(
ucc__mlx5_‹am_t
 *
‹am
)

46 ià(!
‹am
->
tİo
) {

49 
	`ucc_•_m­_de¡roy_Ã¡ed
(&
‹am
->
ùx_m­
);

50 
	`ucc_tİo_ş—nup
(
‹am
->
tİo
);

51 
‹am
->
tİo
 = 
NULL
;

52 
	}
}

54 
	$UCC_CLASS_INIT_FUNC
(
ucc__mlx5_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
,

55 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

57 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 =

58 
	`ucc_d”ived_of
(
_cÚ‹xt
, 
ucc__mlx5_cÚ‹xt_t
);

59 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

61 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

63 
¡©us
 = 
	`ucc__mlx5_tİo_š™
(
£lf
);

64 ià(
¡©us
 !ğ
UCC_OK
) {

65 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "failedo initeamopo");

66  
¡©us
;

69 
£lf
->
glob®_sync_»q
 = 
NULL
;

71 
£lf
->
a2a
 = 
NULL
;

72 ià(
ùx
->
cfg
.
’abË_®ÉßÎ
) {

73 
¡©us
 = 
	`ucc__mlx5_‹am_š™_®ÉßÎ
(
£lf
);

74 ià(
UCC_OK
 !ğ
¡©us
) {

75  
¡©us
;

79 
£lf
->
mÿ¡
 = 
NULL
;

81 
£lf
->
loÿl_mÿ¡_‹am_»ady
 = 0;

82 ià(
ùx
->
mÿ¡
.
mÿ¡_ùx_»ady
) {

83 
¡©us
 = 
	`ucc__mlx5_mÿ¡_‹am_š™
(
_cÚ‹xt
, &(
£lf
->
mÿ¡
), &(
ùx
->mcast),

84 
·¿ms
, &(
	`UCC_TL_MLX5_TEAM_LIB
(
£lf
)->
cfg
.
mÿ¡_cÚf
));

85 ià(
UCC_OK
 !ğ
¡©us
) {

86 
	`_w¬n
(
_cÚ‹xt
->
lib
, "mcasteam init failed");

88 
£lf
->
loÿl_mÿ¡_‹am_»ady
 = 1;

92 
£lf
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_CTX_CHECK
;

93 
£lf
->
a2a_¡©e
 = 
TL_MLX5_TEAM_STATE_ALLTOALL_CTX_CHECK
;

95 
	`_debug
(
_cÚ‹xt
->
lib
, "po¡edÈ‹am: %p", 
£lf
);

96  
UCC_OK
;

97 
	}
}

99 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__mlx5_‹am_t
)

101 
	`_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizingleam: %p", self);

103 
	`ucc__mlx5_dm_ş—nup
(
£lf
);

104 ià(
£lf
->
a2a_¡©e
 !ğ
TL_MLX5_TEAM_STATE_ALLTOALL_NOT_AVAILABLE
) {

105 
	`ucc__mlx5_®ÉßÎ_ş—nup
(
£lf
);

107 
	`ucc__mlx5_tİo_ş—nup
(
£lf
);

108 ià(
£lf
->
mÿ¡_¡©e
 !ğ
TL_MLX5_TEAM_STATE_MCAST_NOT_AVAILABLE
) {

109 
	`ucc__mlx5_ş—n_mÿ¡_comm
(
£lf
->
mÿ¡
->
mÿ¡_comm
);

111 
	}
}

113 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__mlx5_‹am_t
, 
ucc_ba£_‹am_t
);

114 
UCC_CLASS_DEFINE
(
ucc__mlx5_‹am_t
, 
ucc__‹am_t
);

116 
ucc_¡©us_t
 
	$ucc__mlx5_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
)

118 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc__mlx5_‹am_t
)(
_‹am
);

119  
UCC_OK
;

120 
	}
}

122 
šlše
 
ucc_¡©us_t
 
	$ucc__mlx5_®ÉßÎ_‹am_‹¡
(
ucc_ba£_‹am_t
 *
‹am
)

124 
ucc__mlx5_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_mlx5_team_t);

126 
_‹am
->
a2a_¡©e
) {

127 
TL_MLX5_TEAM_STATE_ALLTOALL_INIT
:

128 
_‹am
->
a2a_¡©us
.
loÿl
 =

129 
	`ucc__mlx5_‹am_‹¡_®ÉßÎ_¡¬t
(
_‹am
);

130 
_‹am
->
a2a_¡©e
 = 
TL_MLX5_TEAM_STATE_ALLTOALL_POSTED
;

132 
TL_MLX5_TEAM_STATE_ALLTOALL_POSTED
:

134 
_‹am
->
a2a_¡©us
.
loÿl
 =

135 
	`ucc__mlx5_‹am_‹¡_®ÉßÎ_´og»ss
(
_‹am
);

136 ià(
UCC_INPROGRESS
 =ğ
_‹am
->
a2a_¡©us
.
loÿl
) {

137  
UCC_INPROGRESS
;

139 ià(
UCC_OK
 !ğ
_‹am
->
a2a_¡©us
.
loÿl
) {

140 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "failedo init‡2a: %s",

141 
	`ucc_¡©us_¡ršg
(
_‹am
->
a2a_¡©us
.
loÿl
));

142 
_‹am
->
a2a_¡©e
 = 
TL_MLX5_TEAM_STATE_ALLTOALL_NOT_AVAILABLE
;

144 
_‹am
->
a2a_¡©e
 = 
TL_MLX5_TEAM_STATE_ALLTOALL_READY
;

145 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "initializedl‡2aeam: %p",

146 
_‹am
);

148 
TL_MLX5_TEAM_STATE_ALLTOALL_READY
:

149 
TL_MLX5_TEAM_STATE_ALLTOALL_NOT_AVAILABLE
:

150  
UCC_OK
;

152 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

153 "unknowÀ¡©duršg‡2¨‹am: %°ü—‹", 
_‹am
);

154  
UCC_ERR_NO_RESOURCE
;

156 
	}
}

158 
ucc_¡©us_t
 
	$ucc__mlx5_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
‹am
)

160 
ucc__mlx5_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_mlx5_team_t);

161 
ucc__mlx5_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_MLX5_TEAM_CTX
(
_‹am
);

162 
ucc_‹am_t
 *
cÜe_‹am
 = 
	`UCC_TL_CORE_TEAM
(
_‹am
);

163 
ucc_sub£t_t
 
sub£t
 = {.
m­
 = 
	`UCC_TL_TEAM_MAP
(
_‹am
),

164 .
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(
_‹am
)};

165 
ucc_¡©us_t
 
a2a_¡©us
 = 
UCC_OK
;

166 
ucc_¡©us_t
 
mÿ¡_¡©us
 = 
UCC_OK
;

167 
ucc__mlx5_mÿ¡_cŞl_comm_t
 *
comm
 = 
NULL
;

168 
ucc_¡©us_t
 
¡©us
;

171 ià(
_‹am
->
glob®_sync_»q
 !ğ
NULL
) {

172 
¡©us
 = 
	`ucc_£rviû_cŞl_‹¡
(
_‹am
->
glob®_sync_»q
);

173 ià(
¡©us
 < 0) {

174 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

176 
	`ucc_¡©us_¡ršg
(
¡©us
));

177  
¡©us
;

179 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

180  
¡©us
;

183 
	`ucc_£rviû_cŞl_fš®ize
(
_‹am
->
glob®_sync_»q
);

185 
_‹am
->
glob®_sync_»q
 = 
NULL
;

187 ià(
_‹am
->
mÿ¡_¡©e
 =ğ
TL_MLX5_TEAM_STATE_MCAST_CTX_CHECK
 &&

188 
_‹am
->
a2a_¡©e
 =ğ
TL_MLX5_TEAM_STATE_ALLTOALL_CTX_CHECK
 ) {

189 
_‹am
->
a2a_¡©us
.
glob®
 =l_‹am->
glob®_¡©us_¬¿y
[
UCC_TL_MLX5_A2A_STATUS_INDEX
];

190 
_‹am
->
a2a_¡©e
 = 
TL_MLX5_TEAM_STATE_ALLTOALL_INIT
;

192 ià(
_‹am
->
glob®_¡©us_¬¿y
[
UCC_TL_MLX5_MCAST_STATUS_INDEX
] !ğ
UCC_OK
) {

195 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

198 ià(
_‹am
->
loÿl_mÿ¡_‹am_»ady
) {

199 
comm
 = 
_‹am
->
mÿ¡
->
mÿ¡_comm
;

200 ià(
	`ibv_de¡roy_cq
(
comm
->
mÿ¡
.
rcq
)) {

201 
	`_w¬n
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

204 
	`ucc_ä“
(
comm
->
·¿ms
.
oob
);

205 
	`ucc_ä“
(
comm
);

206 
	`ucc_ä“
(
_‹am
->
mÿ¡
);

208 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_NOT_AVAILABLE
;

210 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

212 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_INIT
;

215  
UCC_INPROGRESS
;

217 ià(
_‹am
->
glob®_¡©us_¬¿y
[
UCC_TL_MLX5_A2A_STATUS_INDEX
] !ğ
UCC_OK
) {

219 ià(
_‹am
->
a2a_¡©e
 =ğ
TL_MLX5_TEAM_STATE_ALLTOALL_READY
) {

221 
	`ucc__mlx5_®ÉßÎ_ş—nup
(
_‹am
);

223 
_‹am
->
a2a_¡©e
 = 
TL_MLX5_TEAM_STATE_ALLTOALL_NOT_AVAILABLE
;

226 ià(
_‹am
->
glob®_¡©us_¬¿y
[
UCC_TL_MLX5_MCAST_STATUS_INDEX
] !ğ
UCC_OK
) {

228 ià(
_‹am
->
mÿ¡_¡©e
 =ğ
TL_MLX5_TEAM_STATE_MCAST_READY
) {

230 
	`ucc__mlx5_ş—n_mÿ¡_comm
(
_‹am
->
mÿ¡
->
mÿ¡_comm
);

232 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_NOT_AVAILABLE
;

235 
	`_debug
(
‹am
->
cÚ‹xt
->
lib
, "team %p: MCAST component is %s ALLTOALL component is %s",

236 
‹am
, (
_‹am
->
mÿ¡_¡©e
 =ğ
TL_MLX5_TEAM_STATE_MCAST_READY
)?"ENABLED":"DISABLED",

237 (
_‹am
->
a2a_¡©e
 =ğ
TL_MLX5_TEAM_STATE_ALLTOALL_READY
)?"ENABLED":"DISABLED");

240  
UCC_OK
;

243 
	`ucc_as£¹
(
_‹am
->
glob®_sync_»q
 =ğ
NULL
);

245 ià(
_‹am
->
mÿ¡_¡©e
 =ğ
TL_MLX5_TEAM_STATE_MCAST_CTX_CHECK
 &&

246 
_‹am
->
a2a_¡©e
 =ğ
TL_MLX5_TEAM_STATE_ALLTOALL_CTX_CHECK
) {

248 
_‹am
->
loÿl_¡©us_¬¿y
[
UCC_TL_MLX5_A2A_STATUS_INDEX
] =

249 
_‹am
->
a2a_¡©us
.
loÿl
;

250 
_‹am
->
loÿl_¡©us_¬¿y
[
UCC_TL_MLX5_MCAST_STATUS_INDEX
] =

251 (
_‹am
->
loÿl_mÿ¡_‹am_»ady
è? 
UCC_OK
 : 
UCC_ERR_NO_RESOURCE
;

252 
š™Ÿl_sync_po¡
;

255 ià(
ùx
->
cfg
.
’abË_®ÉßÎ
) {

256 
a2a_¡©us
 = 
	`ucc__mlx5_®ÉßÎ_‹am_‹¡
(
‹am
);

257 ià(
a2a_¡©us
 < 0) {

258 
	`_w¬n
(
‹am
->
cÚ‹xt
->
lib
,

259 "ALLTOALLÈ‹am: %°ü—tiÚ faed %d", 
‹am
,

260 
a2a_¡©us
);

261 
_‹am
->
a2a_¡©e
 = 
TL_MLX5_TEAM_STATE_ALLTOALL_NOT_AVAILABLE
;

264 
_‹am
->
a2a_¡©e
 = 
TL_MLX5_TEAM_STATE_ALLTOALL_NOT_AVAILABLE
;

267 ià(
_‹am
->
mÿ¡_¡©e
 !ğ
TL_MLX5_TEAM_STATE_MCAST_NOT_AVAILABLE
) {

268 
mÿ¡_¡©us
 = 
	`ucc__mlx5_mÿ¡_‹am_‹¡
(
‹am
);

269 ià(
mÿ¡_¡©us
 < 0) {

270 
	`_mlx5_mÿ¡_log
(
ùx
->
mÿ¡
.
mÿ¡_’abËd
, 
‹am
->
cÚ‹xt
->
lib
, 
UCC_LOG_LEVEL_WARN
,

271 "MCASTÈ‹am: %°ü—tiÚ faed %d", 
‹am
, 
mÿ¡_¡©us
);

272 
_‹am
->
mÿ¡_¡©e
 = 
TL_MLX5_TEAM_STATE_MCAST_NOT_AVAILABLE
;

276 ià(
UCC_INPROGRESS
 =ğ
a2a_¡©us
 || UCC_INPROGRESS =ğ
mÿ¡_¡©us
) {

277  
UCC_INPROGRESS
;

280 
_‹am
->
loÿl_¡©us_¬¿y
[
UCC_TL_MLX5_A2A_STATUS_INDEX
] =

281 (
_‹am
->
a2a_¡©e
 =ğ
TL_MLX5_TEAM_STATE_ALLTOALL_READY
è? 
UCC_OK
 : 
UCC_ERR_NO_RESOURCE
;

282 
_‹am
->
loÿl_¡©us_¬¿y
[
UCC_TL_MLX5_MCAST_STATUS_INDEX
] =

283 (
_‹am
->
mÿ¡_¡©e
 =ğ
TL_MLX5_TEAM_STATE_MCAST_READY
è? 
UCC_OK
 : 
UCC_ERR_NO_RESOURCE
;

285 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

287 (
_‹am
->
a2a_¡©e
 =ğ
TL_MLX5_TEAM_STATE_ALLTOALL_READY
),

288 (
_‹am
->
mÿ¡_¡©e
 =ğ
TL_MLX5_TEAM_STATE_MCAST_READY
));

290 
š™Ÿl_sync_po¡
:

291 
¡©us
 = 
	`ucc_£rviû_®Ìeduû
(

292 
cÜe_‹am
, 
_‹am
->
loÿl_¡©us_¬¿y
,l_‹am->
glob®_¡©us_¬¿y
,

293 
UCC_DT_INT32
, 
UCC_TL_MLX5_FEATURES_COUNT
, 
UCC_OP_MIN
, 
sub£t
, &
_‹am
->
glob®_sync_»q
);

294 ià(
¡©us
 < 0) {

295 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

297  
¡©us
;

300  
UCC_INPROGRESS
;

301 
	}
}

303 
ucc_¡©us_t
 
	$ucc__mlx5_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

304 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

306 
ucc__mlx5_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_mlx5_team_t);

307 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_TEAM_CTX
(
‹am
);

308 
ucc__mlx5_cÚ‹xt_t
 *
_ùx
 = 
	`ucc_d”ived_of
(
ùx
, ucc_tl_mlx5_context_t);

309 
ucc_ba£_lib_t
 *
lib
 = 
	`UCC_TL_TEAM_LIB
(
‹am
);

310 
ucc_memÜy_ty³_t
 
mt
[2] = {
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
};

311 
ucc_cŞl_scÜe_t
 *
scÜe
;

312 
ucc_¡©us_t
 
¡©us
;

313 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

316 
‹am_šfo
.
®g_â
 = 
NULL
;

317 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_TL_MLX5_DEFAULT_SCORE
;

318 
‹am_šfo
.
š™
 = 
ucc__mlx5_cŞl_š™
;

319 
‹am_šfo
.
num_mem_ty³s
 = 
_ùx
->
suµÜ‹d_mem_ty³s
 & 
	`UCC_BIT
(
UCC_MEMORY_TYPE_CUDA
) ? 2 : 1;

320 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = 
mt
;

321 
‹am_šfo
.
suµÜ‹d_cŞls
 =

322 (
UCC_COLL_TYPE_ALLTOALL
 * (
‹am
->
a2a_¡©e
 =ğ
TL_MLX5_TEAM_STATE_ALLTOALL_READY
)) |

323 (
UCC_COLL_TYPE_BCAST
 * (
‹am
->
mÿ¡_¡©e
 =ğ
TL_MLX5_TEAM_STATE_MCAST_READY
 &&

324 
_ùx
->
mÿ¡
.
mÿ¡_bÿ¡_’abËd
)) |

325 (
UCC_COLL_TYPE_ALLGATHER
 * (
‹am
->
mÿ¡_¡©e
 =ğ
TL_MLX5_TEAM_STATE_MCAST_READY
 &&

326 
_ùx
->
mÿ¡
.
mÿ¡_®lg©h”_’abËd
));

327 
‹am_šfo
.
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

329 
¡©us
 = 
	`ucc_cŞl_scÜe_bud_deçuÉ
(

330 
_‹am
, 
UCC_TL_MLX5_DEFAULT_SCORE
, 
ucc__mlx5_cŞl_š™
,

331 
‹am_šfo
.
suµÜ‹d_cŞls
, 
mt
, 2, &
scÜe
);

332 ià(
UCC_OK
 !ğ
¡©us
) {

333 
	`_debug
(
lib
, "failedo build score map");

334  
¡©us
;

337 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

338 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

339 &
‹am
->
su³r
.su³r, 
scÜe
);

341 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

342 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

343 
”r
;

347 *
scÜe_p
 = 
scÜe
;

348  
UCC_OK
;

350 
”r
:

351 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

352 *
scÜe_p
 = 
NULL
;

353  
¡©us
;

354 
	}
}

	@src/components/tl/mlx5/tl_mlx5_wqe.c

7 
	~"_mlx5_wqe.h
"

8 
	~"_mlx5_ib.h
"

9 
	~"uts/¬ch/ıu.h
"

10 
	~"uts/ucc_m©h.h
"

12 
	#SQ_WQE_SHIFT
 6

	)

13 
	#DS_SIZE
 16

14 

	)

16 
	smlx5_wqe_umr_poš‹r_£g
 {

17 
__be32
 
	m»£rved
;

18 
__be32
 
	mmkey
;

19 
__be64
 
	madd»ss
;

22 
šlše
 
ušt8_t
 
	$g‘_umr_mr_æags
(
ušt32_t
 
acc
)

24  ((
acc
 & 
IBV_ACCESS_REMOTE_ATOMIC


25 ? 
MLX5_WQE_MKEY_CONTEXT_ACCESS_FLAGS_ATOMIC


27 (
acc
 & 
IBV_ACCESS_REMOTE_WRITE


28 ? 
MLX5_WQE_MKEY_CONTEXT_ACCESS_FLAGS_REMOTE_WRITE


30 (
acc
 & 
IBV_ACCESS_REMOTE_READ


31 ? 
MLX5_WQE_MKEY_CONTEXT_ACCESS_FLAGS_REMOTE_READ


33 (
acc
 & 
IBV_ACCESS_LOCAL_WRITE


34 ? 
MLX5_WQE_MKEY_CONTEXT_ACCESS_FLAGS_LOCAL_WRITE


36 
	}
}

38 
	#MLX5_OPCODE_LOCAL_MMO
 0x32

	)

40 
	sŒª¥o£_£g
 {

41 
__be32
 
	m–em’t_size
;

43 
__be16
 
	mnum_cŞs
;

44 
__be16
 
	mnum_rows
;

45 
__be64
 
	m·ddšg
;

46 } 
	tŒª¥o£_£g_t
;

49 
ucc_¡©us_t
 
	$ucc__mlx5_po¡_Œª¥o£
(
ibv_qp
 *
qp
, 
ušt32_t
 
¤c_mr_lkey
,

50 
ušt32_t
 
d¡_mr_key
,

51 
ušŒ_t
 
¤c_mkey_addr
,

52 
ušŒ_t
 
d¡_addr
,

53 
ušt32_t
 
–em’t_size
, 
ušt16_t
 
ncŞs
,

54 
ušt16_t
 
Äows
, 
£nd_æags
)

56 
ušt32_t
 
İcode
 = 
MLX5_OPCODE_LOCAL_MMO
;

57 
ušt32_t
 
İmode
 = 0x0;

58 
ušt32_t
 
n_ds
 = 4;

59 
ibv_qp_ex
 * 
qp_ex
 = 
	`ibv_qp_to_qp_ex
(
qp
);

60 
mlx5dv_qp_ex
 * 
mqp
 = 
	`mlx5dv_qp_ex_äom_ibv_qp_ex
(
qp_ex
);

61 
fm_û_£
 = 0;

62 
wqe_desc
[
n_ds
 * 
DS_SIZE
];

63 
mlx5_wqe_ù¾_£g
 *
ù¾
;

64 
mlx5_wqe_d©a_£g
 *
d©a
;

65 
Œª¥o£_£g_t
 * 
t£g
;

67 ià(
£nd_æags
 & 
IBV_SEND_SIGNALED
) {

68 
qp_ex
->
wr_id
 = 0;

69 
fm_û_£
 |ğ
MLX5_WQE_CTRL_CQ_UPDATE
;

72 
	`mem£t
(
wqe_desc
, 0, 
n_ds
 * 
DS_SIZE
);

74 
ù¾
 = (*)
wqe_desc
;

75 
	`mlx5dv_£t_ù¾_£g
(
ù¾
, 0x0, 
İcode
, 
İmode
, 
qp
->
qp_num
,

76 
fm_û_£
, 
n_ds
, 0x0, 0x0);

79 
t£g
 = 
	`PTR_OFFSET
(
ù¾
, 
DS_SIZE
);

80 
t£g
->
–em’t_size
 = 
	`htobe32
(element_size);

81 
t£g
->
num_rows
 = 
	`htobe16
(
Äows
);

82 
t£g
->
num_cŞs
 = 
	`htobe16
(
ncŞs
);

85 
d©a
 = 
	`PTR_OFFSET
(
t£g
, 
DS_SIZE
);

86 
	`mlx5dv_£t_d©a_£g
(
d©a
, 
ncŞs
 * 
Äows
 * 
–em’t_size
, 
¤c_mr_lkey
,

87 
¤c_mkey_addr
);

90 
d©a
 = 
	`PTR_OFFSET
(d©a, 
DS_SIZE
);

91 
	`mlx5dv_£t_d©a_£g
(
d©a
, 
ncŞs
 * 
Äows
 * 
–em’t_size
, 
d¡_mr_key
,

92 
d¡_addr
);

93 
	`mlx5dv_wr_¿w_wqe
(
mqp
, 
wqe_desc
);

94  
UCC_OK
;

95 
	}
}

100 
	$umr_poš‹r_£g_š™
(
ušt32_t
 
»³©_couÁ
,

101 
ušt16_t
 
num_š‹¾—ved
,

102 
mlx5dv_mr_š‹¾—ved
 *
d©a
,

103 
mlx5_wqe_umr_poš‹r_£g
 *
p£g
,

104 
ušt32_t
 
±r_mkey
, *
±r_add»ss
,

105 *
xÏt_size
, 
ušt64_t
 *
»gËn
)

107 
ušt64_t
 
by‹_couÁ
 = 0;

108 
mlx5_wqe_umr_»³©_block_£g
 *
rb
;

109 
mlx5_wqe_umr_»³©_’t_£g
 * 
eb
;

110 
i
;

113 
p£g
->
mkey
 = 
	`htobe32
(
±r_mkey
);

114 
p£g
->
add»ss
 = 
	`htobe64
((
ušt64_t
)
±r_add»ss
);

117 
rb
 = 
±r_add»ss
;

118 
rb
->
İ
 = 
	`htobe32
(0x400);

119 
rb
->
»£rved
 = 0;

120 
rb
->
num_’t
 = 
	`htobe16
(
num_š‹¾—ved
);

121 
rb
->
»³©_couÁ
 = 
	`htobe32
(repeat_count);

122 
eb
 = 
rb
->
’Œ›s
;

129 
i
 = 0; i < 
num_š‹¾—ved
; i++, 
eb
++) {

130 
by‹_couÁ
 +ğ
d©a
[
i
].
by‹s_couÁ
;

131 
eb
->
va
 = 
	`htobe64
(
d©a
[
i
].
addr
);

132 
eb
->
by‹_couÁ
 = 
	`htobe16
(
d©a
[
i
].
by‹s_couÁ
);

133 
eb
->
¡ride
 = 
	`htobe16
(
d©a
[
i
].
by‹s_couÁ
 + d©a[i].
by‹s_sk
);

134 
eb
->
memkey
 = 
	`htobe32
(
d©a
[
i
].
lkey
);

137 
rb
->
by‹_couÁ
 = 
	`htobe32
(byte_count);

138 *
»gËn
 = 
by‹_couÁ
 * 
»³©_couÁ
;

139 *
xÏt_size
 = (
num_š‹¾—ved
 + 1è* (*
eb
);

140 
	}
}

142 
ucc_¡©us_t
 
	$ucc__mlx5_po¡_umr
(
ibv_qp
 * 
qp
,

143 
mlx5dv_mkey
 *
dv_mkey
,

144 
ušt32_t
 
acûss_æags
, ušt32_ˆ
»³©_couÁ
,

145 
ušt16_t
 
num_’Œ›s
,

146 
mlx5dv_mr_š‹¾—ved
 *
d©a
,

147 
ušt32_t
 
±r_mkey
, *
±r_add»ss
)

149 
ušt32_t
 
İcode
 = 
MLX5_OPCODE_UMR
;

150 
ušt64_t
 
»gËn
 = 0;

151 
ušt32_t
 
İmode
 = 0x0;

152 
ušt32_t
 
n_ds
 = ((
mlx5_wqe_ù¾_£g
) +

153 (
mlx5_wqe_umr_ù¾_£g
) +

154 (
mlx5_wqe_mkey_cÚ‹xt_£g
) +

155 (
mlx5_wqe_umr_poš‹r_£g
)) /

156 
DS_SIZE
;

157 
ušt8_t
 
fm_û_£
 = 
MLX5_WQE_CTRL_CQ_UPDATE
;

158 
ibv_qp_ex
 *
qp_ex
 = 
	`ibv_qp_to_qp_ex
(
qp
);

159 
mlx5dv_qp_ex
 *
mqp
 =

160 
	`mlx5dv_qp_ex_äom_ibv_qp_ex
(
qp_ex
);

161 
mlx5_wqe_ù¾_£g
 *
ù¾
;

162 
mlx5_wqe_umr_ù¾_£g
 *
umr_ù¾_£g
;

163 
mlx5_wqe_mkey_cÚ‹xt_£g
 *
mk_£g
;

164 
mlx5_wqe_umr_poš‹r_£g
 *
p£g
;

165 
wqe_desc
[
n_ds
 * 
DS_SIZE
];

166 
xÏt_size
;

168 
	`mem£t
(
wqe_desc
, 0, 
n_ds
 * 
DS_SIZE
);

170 
ù¾
 = (*)
wqe_desc
;

171 
	`mlx5dv_£t_ù¾_£g
(
ù¾
, 0x0, 
İcode
, 
İmode
, 
qp
->
qp_num
,

172 
fm_û_£
, 
n_ds
, 0x0, 
	`htobe32
(
dv_mkey
->
lkey
));

174 
umr_ù¾_£g
 = 
	`PTR_OFFSET
(
ù¾
, (*ctrl));

175 
umr_ù¾_£g
->
mkey_mask
 =

176 
	`htobe64
(
MLX5_WQE_UMR_CTRL_MKEY_MASK_LEN
 |

177 
MLX5_WQE_UMR_CTRL_MKEY_MASK_ACCESS_LOCAL_WRITE
 |

178 
MLX5_WQE_UMR_CTRL_MKEY_MASK_ACCESS_REMOTE_READ
 |

179 
MLX5_WQE_UMR_CTRL_MKEY_MASK_ACCESS_REMOTE_WRITE
 |

180 
MLX5_WQE_UMR_CTRL_MKEY_MASK_ACCESS_ATOMIC
 |

181 
MLX5_WQE_UMR_CTRL_MKEY_MASK_FREE
);

183 
mk_£g
 = 
	`PTR_OFFSET
(
umr_ù¾_£g
, (*umr_ctrl_seg));

184 
mk_£g
->
acûss_æags
 = 
	`g‘_umr_mr_æags
(access_flags);

185 
mk_£g
->
q²_mkey
 = 
	`htobe32
(0xffffff00 | (
dv_mkey
->
lkey
 & 0xff));

187 
p£g
 = 
	`PTR_OFFSET
(
mk_£g
, (*mk_seg));

189 
	`umr_poš‹r_£g_š™
(
»³©_couÁ
, 
num_’Œ›s
, 
d©a
, 
p£g
, 
±r_mkey
,

190 
±r_add»ss
, &
xÏt_size
, &
»gËn
);

192 
mk_£g
->
Ën
 = 
	`htobe64
(
»gËn
);

193 
umr_ù¾_£g
->
klm_oùowÜds
 =

194 
	`htobe16
(
	`ucc_®ign_up
(
xÏt_size
, 64è/ 
DS_SIZE
);

195 
	`ibv_wr_¡¬t
(
qp_ex
);

196 
	`mlx5dv_wr_¿w_wqe
(
mqp
, 
wqe_desc
);

197 
	`ibv_wr_com¶‘e
(
qp_ex
);

198  
UCC_OK
;

199 
	}
}

201 
ucc_¡©us_t
 
	$ucc__mlx5_po¡_rdma
(
ibv_qp
 *
qp
, 
ušt32_t
 
q²
,

202 
ibv_ah
 *
ah
, 
ušŒ_t
 
¤c_mkey_addr
,

203 
size_t
 
Ën
, 
ušt32_t
 
¤c_mr_lkey
,

204 
ušŒ_t
 
d¡_addr
, 
ušt32_t
 
d¡_mr_key
,

205 
£nd_æags
, 
ušt64_t
 
wr_id
)

209 
ušt32_t
 
İcode
 = 
MLX5_OPCODE_RDMA_WRITE
;

210 
ušt32_t
 
İmode
 = 0x0;

211 
ibv_qp_ex
 * 
qp_ex
 = 
	`ibv_qp_to_qp_ex
(
qp
);

212 
mlx5dv_qp_ex
 * 
mqp
 = 
	`mlx5dv_qp_ex_äom_ibv_qp_ex
(
qp_ex
);

213 
ušt8_t
 
fm_û_£
 = 
MLX5_WQE_CTRL_INITIATOR_SMALL_FENCE
;

214 
ušt32_t
 
n_ds
 =

215 ((
mlx5_wqe_ù¾_£g
) +

216 (
ah
 ? (
mlx5_wqe_d©ag¿m_£g
) : 0) +

217 (
mlx5_wqe_¿ddr_£g
è+ (
mlx5_wqe_d©a_£g
)) /

218 
DS_SIZE
;

219 
mlx5_wqe_ù¾_£g
 *
ù¾
;

220 
mlx5_wqe_d©a_£g
 *
d©a
;

221 
mlx5_wqe_d©ag¿m_£g
 *
d£g
;

222 
mlx5_wqe_¿ddr_£g
 * 
r£g
;

223 
wqe_desc
[
n_ds
 * 
DS_SIZE
];

225 
qp_ex
->
wr_id
 = wr_id;

226 
	`mem£t
(
wqe_desc
, 0, 
n_ds
 * 
DS_SIZE
);

228 
ù¾
 = (*)
wqe_desc
;

229 ià(
£nd_æags
 & 
IBV_SEND_SIGNALED
) {

230 
fm_û_£
 |ğ
MLX5_WQE_CTRL_CQ_UPDATE
;

232 
	`mlx5dv_£t_ù¾_£g
(
ù¾
, 0x0, 
İcode
, 
İmode
, 
qp
->
qp_num
,

233 
fm_û_£
, 
n_ds
, 0x0, 0x0);

235 ià(
ah
) {

236 
d£g
 = 
	`PTR_OFFSET
(
ù¾
, (*ctrl));

237 
	`_mlx5_ah_to_av
(
ah
, &
d£g
->
av
);

238 
d£g
->
av
.
dqp_dù
 |ğ
	`htobe32
(
q²
 | 
MLX5_EXTENDED_UD_AV
);

239 
d£g
->
av
.
key
.
dc_key
 = 
	`htobe64
(
DC_KEY
);

240 
r£g
 = 
	`PTR_OFFSET
(
d£g
, (*dseg));

242 
r£g
 = 
	`PTR_OFFSET
(
ù¾
, (*ctrl));

245 
r£g
->
¿ddr
 = 
	`htobe64
(
d¡_addr
);

246 
r£g
->
rkey
 = 
	`htobe32
(
d¡_mr_key
);

249 
d©a
 = 
	`PTR_OFFSET
(
r£g
, (*rseg));

250 
	`mlx5dv_£t_d©a_£g
(
d©a
, 
Ën
, 
¤c_mr_lkey
, 
¤c_mkey_addr
);

252 
	`mlx5dv_wr_¿w_wqe
(
mqp
, 
wqe_desc
);

253  
UCC_OK
;

254 
	}
}

256 
	#ACTION_RETRY
 0x0ULL

	)

257 
	#ACTION_SEND_ERR_CQE
 0x1ULL

	)

258 
	#ACTION
 
ACTION_RETRY


	)

259 
	#MLX5_OPCODE_WAIT
 0xF

	)

261 
	swa™_Ú_d©a_£g
 {

262 
__be32
 
	mİ
;

263 
__be32
 
	mlkey
;

264 
__be64
 
	mva_ç
;

265 
__be64
 
	md©a
;

266 
__be64
 
	md©a_mask
;

267 } 
	twa™_Ú_d©a_£g_t
;

269 
ucc_¡©us_t
 
	$ucc__mlx5_po¡_wa™_Ú_d©a
(
ibv_qp
 *
qp
, 
ušt64_t
 
v®ue
,

270 
ušt32_t
 
lkey
, 
ušŒ_t
 
addr
,

271 *
sk_±r
)

274 
ušt32_t
 
İcode
 = 
MLX5_OPCODE_WAIT
;

275 
ušt32_t
 
İmode
 = 0x1;

276 
ušt32_t
 
n_ds
 = 3;

277 
ibv_qp_ex
 *
qp_ex
 = 
	`ibv_qp_to_qp_ex
(
qp
);

278 
mlx5dv_qp_ex
 *
mqp
 = 
	`mlx5dv_qp_ex_äom_ibv_qp_ex
(
qp_ex
);

279 
ušt8_t
 
fm_û_£
 = 
MLX5_WQE_CTRL_CQ_UPDATE
;

280 
wqe_desc
[
n_ds
 * 
DS_SIZE
];

281 
mlx5_wqe_ù¾_£g
 *
ù¾
;

282 
wa™_Ú_d©a_£g_t
 * 
w£g
;

285 
	`ucc_as£¹
(
addr
 % 8 == 0);

287 
	`mem£t
(
wqe_desc
, 0, 
n_ds
 * 
DS_SIZE
);

289 
	`ibv_wr_¡¬t
(
qp_ex
);

290 
qp_ex
->
wr_id
 = ((
ušt64_t
)(
ušŒ_t
)
sk_±r
) | 0x1;

291 
ù¾
 = (*)
wqe_desc
;

292 
	`mlx5dv_£t_ù¾_£g
(
ù¾
, 0x0, 
İcode
, 
İmode
, 
qp
->
qp_num
,

293 
fm_û_£
, 
n_ds
, 0x0, 0x0);

296 
w£g
 = 
	`PTR_OFFSET
(
ù¾
, 
DS_SIZE
);

297 
w£g
->
İ
 = 
	`htobe32
(0x1);

298 
w£g
->
lkey
 = 
	`htobe32
(lkey);

299 
w£g
->
va_ç
 = 
	`htobe64
((
addr
è| (
ACTION
));

300 
w£g
->
d©a
 = 
v®ue
;

301 
w£g
->
d©a_mask
 = 0xFFFFFFFF;

302 
	`mlx5dv_wr_¿w_wqe
(
mqp
, 
wqe_desc
);

303 ià(
	`ibv_wr_com¶‘e
(
qp_ex
)) {

304  
UCC_ERR_NO_MESSAGE
;

306  
UCC_OK
;

307 
	}
}

	@src/components/tl/mlx5/tl_mlx5_wqe.h

7 #iâdeà
UCC_TL_MLX5_WQE_H_


8 
	#UCC_TL_MLX5_WQE_H_


	)

10 
	~"ucc/­i/ucc_¡©us.h
"

11 
	~<šfšibªd/v”bs.h
>

12 
	~<šfšibªd/mlx5dv.h
>

14 
ucc_¡©us_t
 
ucc__mlx5_po¡_Œª¥o£
(
ibv_qp
 *
qp
, 
ušt32_t
 
¤c_mr_lkey
,

15 
ušt32_t
 
d¡_mr_key
,

16 
ušŒ_t
 
¤c_mkey_addr
,

17 
ušŒ_t
 
d¡_addr
,

18 
ušt32_t
 
–em’t_size
, 
ušt16_t
 
ncŞs
,

19 
ušt16_t
 
Äows
, 
£nd_æags
);

21 
ucc_¡©us_t
 
ucc__mlx5_po¡_umr
(
ibv_qp
 * 
qp
,

22 
mlx5dv_mkey
 *
dv_mkey
,

23 
ušt32_t
 
acûss_æags
, ušt32_ˆ
»³©_couÁ
,

24 
ušt16_t
 
num_’Œ›s
,

25 
mlx5dv_mr_š‹¾—ved
 *
d©a
,

26 
ušt32_t
 
±r_mkey
, *
±r_add»ss
);

28 
ucc_¡©us_t
 
ucc__mlx5_po¡_rdma
(
ibv_qp
 *
qp
, 
ušt32_t
 
q²
,

29 
ibv_ah
 *
ah
, 
ušŒ_t
 
¤c_mkey_addr
,

30 
size_t
 
Ën
, 
ušt32_t
 
¤c_mr_lkey
,

31 
ušŒ_t
 
d¡_addr
, 
ušt32_t
 
d¡_mr_key
,

32 
£nd_æags
, 
ušt64_t
 
wr_id
);

34 
ucc_¡©us_t
 
ucc__mlx5_po¡_wa™_Ú_d©a
(
ibv_qp
 *
qp
, 
ušt64_t
 
v®ue
,

35 
ušt32_t
 
lkey
, 
ušŒ_t
 
addr
,

36 *
sk_±r
);

	@src/components/tl/nccl/allgatherv/allgatherv.c

7 
	~"_ncş.h
"

8 
	~"®lg©h”v.h
"

9 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
	~"cÜe/ucc_“.h
"

11 
	~"uts/¬ch/cuda_def.h
"

13 
ucc_ba£_cŞl_®g_šfo_t


14 
	gucc__ncş_®lg©h”v_®gs
[
UCC_TL_NCCL_ALLGATHERV_ALG_LAST
 + 1] = {

15 [
UCC_TL_NCCL_ALLGATHERV_ALG_P2P
] =

16 {.
id
 = 
UCC_TL_NCCL_ALLGATHERV_ALG_P2P
,

17 .
	gÇme
 = "p2p",

18 .
	gdesc
 = "allgatherv based on‚ccl…oint-to-point"},

19 [
UCC_TL_NCCL_ALLGATHERV_ALG_BCOPY
] =

20 {.
id
 = 
UCC_TL_NCCL_ALLGATHERV_ALG_BCOPY
,

21 .
	gÇme
 = "bcopy",

22 .
	gdesc
 = "allgatherv with buffered copy"},

23 [
UCC_TL_NCCL_ALLGATHERV_ALG_BCAST
] =

24 {.
id
 = 
UCC_TL_NCCL_ALLGATHERV_ALG_BCAST
,

25 .
	gÇme
 = "bcast",

26 .
	gdesc
 = "allgatherv based on‚ccl bcast"},

27 [
UCC_TL_NCCL_ALLGATHERV_ALG_LAST
] = {

28 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

30 
	#CHECK_INPLACE
(
_¬gs
, 
_‹am
) \

32 ià(
	`UCC_IS_INPLACE
((
_¬gs
))) { \

33 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
((
_‹am
)), \

35 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
; \

36 
out
; \

38 } 0)

	)

40 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”v_p2p_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

42 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

43 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

44 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

45 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

46 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

47 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

48 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 :

49 
‹am
->
¡»am
;

50 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

51 *
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

52 *
sbuf
;

53 
size_t
 
sdt_size
, 
rdt_size
, 
couÁ
, 
di¥l
;

54 
ucc_¿nk_t
 
³”
;

56 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

57 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

58 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

59 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

60 
Œªk
);

62 
sbuf
 = 
	`PTR_OFFSET
(
rbuf
, 
di¥l
 * 
rdt_size
);

63 
sdt_size
 = 
rdt_size
;

64 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
Œªk
);

66 
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

67 
sdt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

68 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

71 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

72 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_allgatherv_start", 0);

73 
	`NCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

74 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

75 ià(
couÁ
 != 0) {

76 
³”
 = 0;…“¸< 
size
;…eer++) {

77 
	`NCCLCHECK_GOTO
(
	`ncşS’d
(
sbuf
, 
couÁ
 * 
sdt_size
, 
ncşCh¬
, 
³”
,

78 
‹am
->
ncş_comm
, 
¡»am
),

79 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

80 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

83 
³”
 = 0;…“¸< 
size
;…eer++) {

84 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
³”
);

85 ià(
couÁ
 != 0) {

86 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

87 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
³”
);

88 
	`NCCLCHECK_GOTO
(
	`ncşRecv
(
	`PTR_OFFSET
(
rbuf
, 
di¥l
 * 
rdt_size
),

89 
couÁ
 * 
rdt_size
, 
ncşCh¬
, 
³”
,

90 
‹am
->
ncş_comm
, 
¡»am
),

91 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

92 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

95 
	`NCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

96 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

97 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

98 
ex™_cŞl
:

99  
¡©us
;

100 
	}
}

102 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”v_p2p_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

103 
ucc_ba£_‹am_t
 * 
‹am
,

104 
ucc_cŞl_sk_t
 ** 
sk_h
)

106 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

107 
ucc__ncş_sk_t
 *
sk
;

109 
¡©us
 = 
	`ucc__ncş_š™_sk
(
cŞl_¬gs
, 
‹am
, &
sk
);

110 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

111  
¡©us
;

113 
sk
->
su³r
.
po¡
 = 
ucc__ncş_®lg©h”v_p2p_¡¬t
;

114 *
sk_h
 = &
sk
->
su³r
;

116  
¡©us
;

117 
	}
}

119 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”v_bcİy_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

121 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

122 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

123 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

124 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

125 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

126 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 :

127 
‹am
->
¡»am
;

128 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

129 *
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

130 *
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

131 *
sü©ch
 = 
sk
->
®lg©h”v_bcİy
.sü©ch->
addr
;

132 
size_t
 
max_couÁ
, 
rdt_size
, 
sdt_size
, 
di¥l
, 
scouÁ
, 
rcouÁ
;

133 
ucc_¿nk_t
 
³”
;

135 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

136 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_allgatherv_start", 0);

137 
max_couÁ
 = 
sk
->
®lg©h”v_bcİy
.max_count;

138 
scouÁ
 = 
¬gs
->
¤c
.
šfo
.
couÁ
;

139 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

140 
sdt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

141 ià(
max_couÁ
 * 
rdt_size
 > 
scouÁ
 * 
sdt_size
) {

142 
	`CUDA_CHECK_GOTO
(
	`cudaMemıyAsync
(
	`PTR_OFFSET
(
sü©ch
,

143 
max_couÁ
 * 
rdt_size
 * 
size
), 
sbuf
,

144 
scouÁ
 * 
sdt_size
,

145 
cudaMemıyDeviûToDeviû
, 
¡»am
),

146 
ex™_cŞl
, 
¡©us
);

147 
sbuf
 = 
	`PTR_OFFSET
(
sü©ch
, 
max_couÁ
 * 
rdt_size
 * 
size
);

149 
	`NCCLCHECK_GOTO
(
	`ncşAÎG©h”
(
sbuf
, 
sü©ch
, 
max_couÁ
 * 
rdt_size
,

150 
ncşCh¬
, 
‹am
->
ncş_comm
, 
¡»am
),

151 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

152 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

153 
³”
 = 0;…“¸< 
size
;…eer++) {

154 
rcouÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,

155 
¬gs
->
d¡
.
šfo_v
.
couÁs
, 
³”
);

156 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

157 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

158 
³”
);

159 
	`CUDA_CHECK_GOTO
(
	`cudaMemıyAsync
(
	`PTR_OFFSET
(
rbuf
, 
di¥l
 * 
rdt_size
),

160 
	`PTR_OFFSET
(
sü©ch
,

161 
³”
 * 
max_couÁ
 * 
rdt_size
),

162 
rcouÁ
 * 
rdt_size
,

163 
cudaMemıyDeviûToDeviû
, 
¡»am
),

164 
ex™_cŞl
, 
¡©us
);

166 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

167 
ex™_cŞl
:

168  
¡©us
;

169 
	}
}

171 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”v_bcİy_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

173 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

175 
	`ucc_mc_ä“
(
sk
->
®lg©h”v_bcİy
.
sü©ch
);

176  
	`ucc__ncş_cŞl_fš®ize
(
cŞl_sk
);

177 
	}
}

179 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”v_bcİy_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

180 
ucc_ba£_‹am_t
 * 
‹am
,

181 
ucc_cŞl_sk_t
 ** 
sk_h
)

183 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
cŞl_¬gs
->args;

184 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

185 
ucc__ncş_sk_t
 *
sk
;

186 
size_t
 
max_couÁ
, 
sdt_size
, 
rdt_size
;

187 
ucc_¿nk_t
 
³”
;

189 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

190 
	`_debug
(
‹am
->
cÚ‹xt
->
lib
,

192  
	`ucc__ncş_®lg©h”v_bÿ¡_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

194 
¡©us
 = 
	`ucc__ncş_š™_sk
(
cŞl_¬gs
, 
‹am
, &
sk
);

195 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

196  
¡©us
;

199 
sdt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

200 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

201 
max_couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 0);

202 
³”
 = 1;…“¸< 
‹am
->
·¿ms
.
size
;…eer++) {

203 
max_couÁ
 = 
	`ucc_max
(
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,

204 
¬gs
->
d¡
.
šfo_v
.
couÁs
, 
³”
), 
max_couÁ
);

206 
sk
->
®lg©h”v_bcİy
.
max_couÁ
 = max_count;

207 ià(
max_couÁ
 * 
rdt_size
 > 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
sdt_size
) {

208 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
®lg©h”v_bcİy
.
sü©ch
,

209 (
‹am
->
·¿ms
.
size
 + 1è* 
max_couÁ
 *

210 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
),

211 
UCC_MEMORY_TYPE_CUDA
);

214 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
®lg©h”v_bcİy
.
sü©ch
, 
max_couÁ
 *

215 
‹am
->
·¿ms
.
size
 *

216 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
),

217 
UCC_MEMORY_TYPE_CUDA
);

219 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

220 
	`ucc__ncş_ä“_sk
(
sk
);

221  
¡©us
;

223 
sk
->
su³r
.
po¡
 = 
ucc__ncş_®lg©h”v_bcİy_¡¬t
;

224 
sk
->
su³r
.
fš®ize
 = 
ucc__ncş_®lg©h”v_bcİy_fš®ize
;

225 *
sk_h
 = &
sk
->
su³r
;

226  
¡©us
;

227 
	}
}

229 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”v_bÿ¡_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

231 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

232 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

233 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

234 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

235 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

236 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 :

237 
‹am
->
¡»am
;

238 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

239 *
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

240 
±rdiff_t
 
rbuf
 = (±rdiff_t)
¬gs
->
d¡
.
šfo_v
.
bufãr
;

241 
size_t
 
rdt_size
, 
couÁ
, 
di¥l
;

242 
ucc_¿nk_t
 
³”
;

244 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

245 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

246 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_allgatherv_start", 0);

247 
	`NCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

248 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

249 
³”
 = 0;…“¸< 
size
;…eer++) {

250 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
³”
);

251 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

252 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

253 
³”
);

254 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

255 
sbuf
 = 
	`PTR_OFFSET
(
rbuf
, 
di¥l
 * 
rdt_size
);

257 
	`NCCLCHECK_GOTO
(
	`ncşBrßdÿ¡
(
sbuf
, 
	`PTR_OFFSET
(
rbuf
, 
di¥l
 * 
rdt_size
),

258 
couÁ
 * 
rdt_size
, 
ncşCh¬
, 
³”
,

259 
‹am
->
ncş_comm
, 
¡»am
),

260 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

261 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

263 
	`NCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

264 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

265 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

266 
ex™_cŞl
:

267  
¡©us
;

268 
	}
}

270 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”v_bÿ¡_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

271 
ucc_ba£_‹am_t
 * 
‹am
,

272 
ucc_cŞl_sk_t
 ** 
sk_h
)

274 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

275 
ucc__ncş_sk_t
 *
sk
;

277 
¡©us
 = 
	`ucc__ncş_š™_sk
(
cŞl_¬gs
, 
‹am
, &
sk
);

278 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

279  
¡©us
;

282 
sk
->
su³r
.
po¡
 = 
ucc__ncş_®lg©h”v_bÿ¡_¡¬t
;

283 *
sk_h
 = &
sk
->
su³r
;

284  
¡©us
;

285 
	}
}

	@src/components/tl/nccl/allgatherv/allgatherv.h

7 #iâdeà
ALLGATHERV_H_


8 
	#ALLGATHERV_H_


	)

10 
	~"_ncş_cŞl.h
"

13 
	mUCC_TL_NCCL_ALLGATHERV_ALG_P2P
,

14 
	mUCC_TL_NCCL_ALLGATHERV_ALG_BCOPY
,

15 
	mUCC_TL_NCCL_ALLGATHERV_ALG_BCAST
,

16 
	mUCC_TL_NCCL_ALLGATHERV_ALG_LAST


19 
	#UCC_TL_NCCL_ALLGATHERV_DEFAULT_ALG_SELECT_STR
 \

20 "®lg©h”v:cuda:0-16k:@0#®lg©h”v:cuda:16k-1M:@1#®lg©h”v:cuda:1M-šf:@2#®lg©h”v:cuda_mªaged:0-šf:@0"

	)

22 
ucc_ba£_cŞl_®g_šfo_t


23 
ucc__ncş_®lg©h”v_®gs
[
UCC_TL_NCCL_ALLGATHERV_ALG_LAST
 + 1];

25 
ucc_¡©us_t
 
ucc__ncş_®lg©h”v_p2p_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

27 
ucc_¡©us_t
 
ucc__ncş_®lg©h”v_p2p_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

28 
ucc_ba£_‹am_t
 * 
‹am
,

29 
ucc_cŞl_sk_t
 ** 
sk_h
);

31 
ucc_¡©us_t
 
ucc__ncş_®lg©h”v_bcİy_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

33 
ucc_¡©us_t
 
ucc__ncş_®lg©h”v_bcİy_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

34 
ucc_ba£_‹am_t
 * 
‹am
,

35 
ucc_cŞl_sk_t
 ** 
sk_h
);

37 
ucc_¡©us_t
 
ucc__ncş_®lg©h”v_bÿ¡_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

39 
ucc_¡©us_t
 
ucc__ncş_®lg©h”v_bÿ¡_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

40 
ucc_ba£_‹am_t
 * 
‹am
,

41 
ucc_cŞl_sk_t
 ** 
sk_h
);

43 
šlše
 
	$ucc__ncş_®lg©h”v_®g_äom_¡r
(cÚ¡ *
¡r
)

45 
i
;

46 
i
 = 0; i < 
UCC_TL_NCCL_ALLGATHERV_ALG_LAST
; i++) {

47 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__ncş_®lg©h”v_®gs
[
i
].
Çme
)) {

51  
i
;

52 
	}
}

	@src/components/tl/nccl/tl_nccl.c

7 
	~"_ncş.h
"

8 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

9 
	~"®lg©h”v/®lg©h”v.h
"

11 
ucc_¡©us_t
 
ucc__ncş_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

12 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
);

14 
ucc_¡©us_t
 
ucc__ncş_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

16 
ucc_¡©us_t
 
ucc__ncş_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

17 
ucc_ba£_ùx_©Œ_t
 *
ba£_©Œ
);

19 
ucc_¡©us_t
 
ucc__ncş_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

20 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
);

22 
ucc_¡©us_t
 
ucc__ncş_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

23 
ucc_mem_m­__t
 *
_h
);

25 
ucc_¡©us_t
 
ucc__ncş_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

26 
ucc_mem_m­_mode_t
 
mode
, 
ucc_mem_m­__t
 *
_h
, **
·ck_bufãr
);

28 
ucc_cÚfig_f›ld_t
 
	gucc__ncş_lib_cÚfig_bË
[] = {

29 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__ncş_lib_cÚfig_t
, 
su³r
),

30 
UCC_CONFIG_TYPE_TABLE
(
ucc__lib_cÚfig_bË
)},

32 {
NULL
}};

34 cÚ¡ * 
	gucc__ncş_com¶‘iÚ_sync_Çmes
[] = {

35 [
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_EVENT
] = "event",

36 [
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_MEMOPS
] = "driver",

37 [
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_AUTO
] = "auto",

38 [
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_LAST
] = 
NULL


41 
ucs_cÚfig_f›ld_t
 
	gucc__ncş_cÚ‹xt_cÚfig_bË
[] = {

42 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__ncş_cÚ‹xt_cÚfig_t
, 
su³r
),

43 
UCC_CONFIG_TYPE_TABLE
(
ucc__cÚ‹xt_cÚfig_bË
)},

47 
ucs_off£tof
(
ucc__ncş_cÚ‹xt_cÚfig_t
, 
sync_ty³
),

48 
UCS_CONFIG_TYPE_ENUM
(
ucc__ncş_com¶‘iÚ_sync_Çmes
)

54 
ucs_off£tof
(
ucc__ncş_cÚ‹xt_cÚfig_t
, 
ncş_cfg_blockšg
),

55 
UCS_CONFIG_TYPE_BOOL
},

59 
ucc_off£tof
(
ucc__ncş_cÚ‹xt_cÚfig_t
, 
ncş_Ïzy_š™
),

60 
UCC_CONFIG_TYPE_BOOL
},

62 {
NULL
}};

64 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__ncş_lib_t
, 
ucc_ba£_lib_t
,

65 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

66 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

68 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__ncş_lib_t
, 
ucc_ba£_lib_t
);

70 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__ncş_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

71 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

72 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

74 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__ncş_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

76 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__ncş_‹am_t
, 
ucc_ba£_‹am_t
,

77 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

79 
ucc_¡©us_t
 
ucc__ncş_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
);

81 
ucc_¡©us_t
 
ucc__ncş_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
);

83 
ucc_¡©us_t
 
ucc__ncş_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

84 
ucc_ba£_‹am_t
 *
‹am
,

85 
ucc_cŞl_sk_t
 **
sk
);

87 
ucc_¡©us_t
 
ucc__ncş_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

88 
ucc_cŞl_scÜe_t
 **
scÜe_p
);

89 
UCC_TL_IFACE_DECLARE
(
ncş
, 
NCCL
);

91 
__©Œibu‹__
((
cÚ¡ruùÜ
)è
	$_ncş_içû_š™
()

93 
ucc__ncş
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLGATHERV
)] =

94 
ucc__ncş_®lg©h”v_®gs
;

95 
	}
}

	@src/components/tl/nccl/tl_nccl.h

8 #iâdeà
UCC_TL_NCCL_H_


9 
	#UCC_TL_NCCL_H_


	)

11 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

12 
	~"compÚ’ts//ucc_.h
"

13 
	~"compÚ’ts//ucc__log.h
"

14 
	~"uts/ucc_mpoŞ.h
"

16 
	~<cuda_ruÁime.h
>

17 #ià
CUDART_VERSION
 >= 11000

18 #iâdeà
__CUDA_BF16_TYPES_EXIST__


19 
	#__CUDA_BF16_TYPES_EXIST__


	)

27 
	~<ncş.h
>

28 
	~<cuda.h
>

30 #iâdeà
UCC_TL_NCCL_DEFAULT_SCORE


31 
	#UCC_TL_NCCL_DEFAULT_SCORE
 20

	)

34 #ifdeà
HAVE_PROFILING_TL_NCCL


35 
	~"uts/´ofe/ucc_´ofe.h
"

37 
	~"uts/´ofe/ucc_´ofe_off.h
"

40 
	#UCC_TL_NCCL_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

41 
	#UCC_TL_NCCL_PROFILE_FUNC_VOID
 
UCC_PROFILE_FUNC_VOID


	)

42 
	#UCC_TL_NCCL_PROFILE_REQUEST_NEW
 
UCC_PROFILE_REQUEST_NEW


	)

43 
	#UCC_TL_NCCL_PROFILE_REQUEST_EVENT
 
UCC_PROFILE_REQUEST_EVENT


	)

44 
	#UCC_TL_NCCL_PROFILE_REQUEST_FREE
 
UCC_PROFILE_REQUEST_FREE


	)

45 
	#NCCL_VERSION_COMM_INIT_NB
 
	`NCCL_VERSION
(2,14,3)

	)

46 
	#NCCL_USE_NON_BLOCKING
 
NCCL_VERSION_CODE
 >ğ
NCCL_VERSION_COMM_INIT_NB


	)

49 
	mTL_NCCL_COMM_STATE_ERROR
,

50 
	mTL_NCCL_COMM_STATE_OOB
,

51 
	mTL_NCCL_COMM_STATE_INIT_TEAM
,

52 
	mTL_NCCL_COMM_STATE_INIT_COMM
,

53 
	mTL_NCCL_COMM_STATE_DESTROY_COMM
,

54 
	mTL_NCCL_COMM_STATE_READY
,

57 
	succ__ncş_içû
 {

58 
ucc__içû_t
 
	msu³r
;

59 } 
	tucc__ncş_içû_t
;

61 
ucc__ncş_içû_t
 
ucc__ncş
;

63 
	succ__ncş_lib_cÚfig
 {

64 
ucc__lib_cÚfig_t
 
	msu³r
;

65 } 
	tucc__ncş_lib_cÚfig_t
;

67 
	eucc__ncş_com¶‘iÚ_sync_ty³
 {

68 
	mUCC_TL_NCCL_COMPLETION_SYNC_TYPE_EVENT
,

69 
	mUCC_TL_NCCL_COMPLETION_SYNC_TYPE_MEMOPS
,

70 
	mUCC_TL_NCCL_COMPLETION_SYNC_TYPE_AUTO
,

71 
	mUCC_TL_NCCL_COMPLETION_SYNC_TYPE_LAST


72 } 
	tucc__ncş_com¶‘iÚ_sync_ty³_t
;

74 
	succ__ncş_cÚ‹xt_cÚfig
 {

75 
ucc__cÚ‹xt_cÚfig_t
 
	msu³r
;

76 
ucc__ncş_com¶‘iÚ_sync_ty³_t
 
	msync_ty³
;

77 
	mncş_cfg_blockšg
;

78 
	mncş_Ïzy_š™
;

79 } 
	tucc__ncş_cÚ‹xt_cÚfig_t
;

81 
	succ__ncş_lib
 {

82 
ucc__lib_t
 
	msu³r
;

83 } 
	tucc__ncş_lib_t
;

84 
UCC_CLASS_DECLARE
(
ucc__ncş_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

85 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

87 
	succ__ncş_cÚ‹xt
 {

88 
ucc__cÚ‹xt_t
 
	msu³r
;

89 
ucc__ncş_cÚ‹xt_cÚfig_t
 
	mcfg
;

90 
ucc_mpoŞ_t
 
	m»q_mp
;

91 *
	msü©ch_buf
;

92 } 
	tucc__ncş_cÚ‹xt_t
;

93 
UCC_CLASS_DECLARE
(
ucc__ncş_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

94 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

96 
	succ__ncş_‹am
 {

97 
ucc__‹am_t
 
	msu³r
;

98 
	mcomm_¡©e
;

99 
ncşUniqueId
 *
	munique_id
;

100 *
	moob_»q
;

101 
ncşComm_t
 
	mncş_comm
;

102 
cudaSŒ—m_t
 
	m¡»am
;

103 } 
	tucc__ncş_‹am_t
;

105 
	succ__ncş_sk
 {

106 
ucc_cŞl_sk_t
 
	msu³r
;

107 
ucc_¡©us_t
 
	mho¡_¡©us
;

108 
ucc_¡©us_t
 
	mncş_´og»ss_¡
;

109 
ucc_¡©us_t
 *
	mdev_¡©us
;

110 *
	mcom¶‘ed
;

113 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch
;

114 
size_t
 
	mmax_couÁ
;

115 } 
	m®lg©h”v_bcİy
;

117 } 
	tucc__ncş_sk_t
;

119 
	#TASK_TEAM
(
_sk
) \

120 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
, 
ucc__ncş_‹am_t
))

	)

121 
	#TASK_CTX
(
_sk
) \

122 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
, 
ucc__ncş_cÚ‹xt_t
))

	)

123 
	#TASK_LIB
(
_sk
) \

124 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
->
lib
, 
ucc__ncş_lib_t
))

	)

125 
	#TASK_ARGS
(
_sk
è(_sk)->
su³r
.
b¬gs
.
¬gs


	)

127 
	#UCC_TL_NCCL_SUPPORTED_COLLS
 \

128 (
UCC_COLL_TYPE_ALLTOALL
 | 
UCC_COLL_TYPE_ALLTOALLV
 | \

129 
UCC_COLL_TYPE_ALLGATHER
 | 
UCC_COLL_TYPE_ALLGATHERV
 | \

130 
UCC_COLL_TYPE_ALLREDUCE
 | 
UCC_COLL_TYPE_BCAST
 | \

131 
UCC_COLL_TYPE_REDUCE_SCATTER
 | 
UCC_COLL_TYPE_REDUCE
 | \

132 
UCC_COLL_TYPE_BARRIER
 | 
UCC_COLL_TYPE_GATHER
 | \

133 
UCC_COLL_TYPE_GATHERV
 | 
UCC_COLL_TYPE_SCATTER
 | \

134 
UCC_COLL_TYPE_SCATTERV
)

	)

136 
UCC_CLASS_DECLARE
(
ucc__ncş_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

137 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

139 
šlše
 
ucc_¡©us_t
 
	$ucc__ncş_check_nb
(
ncşResuÉ_t
 *
ncş_¡©us
,

140 
ucc_¡©us_t
 *
sk_¡
,

141 
ncşComm_t
 
ncş_comm
,

142 
check_nb
) {

143 #ià
NCCL_USE_NON_BLOCKING


144 ià(
check_nb
 &&

145 (*
ncş_¡©us
 =ğ
ncşSucûss
 || *ncş_¡©u =ğ
ncşInProg»ss
)) {

146 
ncşResuÉ_t
 
¡
 = 
	`ncşCommG‘AsyncE¼Ü
(
ncş_comm
, 
ncş_¡©us
);

147 ià(
¡
 !ğ
ncşSucûss
) {

148  
UCC_ERR_NO_MESSAGE
;

150 ià(
ncşInProg»ss
 =ğ*
ncş_¡©us
) {

151 *
sk_¡
 = 
UCC_INPROGRESS
;

152  
UCC_INPROGRESS
;

156  
UCC_OK
;

157 
	}
}

159 
ucc_¡©us_t
 
ucc__ncş_comm_š™
(
ucc__ncş_‹am_t
 *
‹am
);

161 
	#NCCLCHECK_GOTO
(
_cmd
, 
_Ïb–
, 
_¡
, 
_lib
, 
_sk_¡
, 
_comm
, 
_check_nb
) \

163 
ncşResuÉ_t
 
e
 = 
_cmd
; \

164 
_¡
 = 
	`ucc__ncş_check_nb
(&
e
, 
_sk_¡
, 
_comm
, 
_check_nb
); \

165 ià(
_¡
 !ğ
UCC_INPROGRESS
 && 
ncşSucûss
 !ğ
e
) { \

166 
	`_”rÜ
(
_lib
, "NCCLƒ¼Ü %d %s", 
e
, 
	`ncşG‘E¼ÜSŒšg
(e)); \

167 
_¡
 = 
UCC_ERR_NO_MESSAGE
; \

168 
_Ïb–
; \

170 } 0)

	)

172 
	#UCC_TL_NCCL_TEAM_LIB
(
_‹am
) \

173 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
->
lib
, 
ucc__ncş_lib_t
))

	)

175 
	#UCC_TL_NCCL_TEAM_CTX
(
_‹am
) \

176 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
, 
ucc__ncş_cÚ‹xt_t
))

	)

	@src/components/tl/nccl/tl_nccl_coll.c

8 
	~"_ncş_cŞl.h
"

9 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
	~"compÚ’ts/ec/ucc_ec.h
"

11 
	~"cÜe/ucc_“.h
"

12 
	~"uts/ucc_comp”_def.h
"

13 
	~"uts/ucc_m©h.h
"

14 
	~"uts/ucc_cŞl_uts.h
"

15 
	~"uts/¬ch/cuda_def.h
"

16 
	~"®lg©h”v/®lg©h”v.h
"

18 
	#ncşOpUnsuµÜ‹d
 (
ncşNumOps
 + 1)

	)

19 
	#ncşD©aTy³UnsuµÜ‹d
 (
ncşNumTy³s
 + 1)

	)

21 
ncşD©aTy³_t
 
	gucc_to_ncş_dty³
[] = {

22 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT8
)] = (
ncşD©aTy³_t
)
ncşIÁ8
,

23 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT16
)] =

24 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

25 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT32
)] = (
ncşD©aTy³_t
)
ncşIÁ32
,

26 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT64
)] = (
ncşD©aTy³_t
)
ncşIÁ64
,

27 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT128
)] =

28 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

29 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT8
)] = (
ncşD©aTy³_t
)
ncşUšt8
,

30 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT16
)] =

31 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

32 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT32
)] = (
ncşD©aTy³_t
)
ncşUšt32
,

33 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT64
)] = (
ncşD©aTy³_t
)
ncşUšt64
,

34 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT128
)] =

35 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

36 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT16
)] = (
ncşD©aTy³_t
)
ncşFlßt16
,

37 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT32
)] = (
ncşD©aTy³_t
)
ncşFlßt32
,

38 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT64
)] = (
ncşD©aTy³_t
)
ncşFlßt64
,

39 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT128
)] =

40 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

41 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT32_COMPLEX
)] =

42 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

43 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT64_COMPLEX
)] =

44 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

45 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT128_COMPLEX
)] =

46 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

47 #ià(
CUDART_VERSION
 >ğ11000è&& (
NCCL_VERSION_CODE
 >ğ
NCCL_VERSION
(2,10,3))

48 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_BFLOAT16
)] = (
ncşD©aTy³_t
)
ncşBæßt16
,

50 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_BFLOAT16
)] =

51 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

55 
ncşRedOp_t
 
	gucc_to_ncş_»duû_İ
[] = {

56 [
UCC_OP_SUM
] = (
ncşRedOp_t
)
ncşSum
,

57 [
UCC_OP_PROD
] = (
ncşRedOp_t
)
ncşProd
,

58 [
UCC_OP_MAX
] = (
ncşRedOp_t
)
ncşMax
,

59 [
UCC_OP_MIN
] = (
ncşRedOp_t
)
ncşMš
,

60 #ià
NCCL_VERSION_CODE
 < 
NCCL_VERSION
(2,10,3)

61 [
UCC_OP_AVG
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

63 [
UCC_OP_AVG
] = (
ncşRedOp_t
)
ncşAvg
,

65 [
UCC_OP_LAND
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

66 [
UCC_OP_LOR
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

67 [
UCC_OP_LXOR
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

68 [
UCC_OP_BAND
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

69 [
UCC_OP_BOR
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

70 [
UCC_OP_BXOR
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

71 [
UCC_OP_MAXLOC
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

72 [
UCC_OP_MINLOC
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

76 *
	gucc__ncş_deçuÉ_®g_£Ëù_¡r
[
UCC_TL_NCCL_N_DEFAULT_ALG_SELECT_STR
] = {

77 
UCC_TL_NCCL_ALLGATHERV_DEFAULT_ALG_SELECT_STR
};

79 
šlše
 

80 
	$ucc__ncş_check_ªd_cÚv”t_bufãr
(
ucc_cŞl_bufãr_šfo_t
 *
bufãr_šfo
,

81 
ucc_d©©y³_t
 
Ãw_d©©y³
)

83 ià(
ucc_to_ncş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
bufãr_šfo
->
d©©y³
)] ==

84 
ncşD©aTy³UnsuµÜ‹d
) {

85 
	`ucc_as£¹
(
	`ucc_dt_size
(
bufãr_šfo
->
d©©y³
) %

86 
	`ucc_dt_size
(
Ãw_d©©y³
) ==

88 
bufãr_šfo
->
couÁ
 *=

89 
	`ucc_dt_size
(
bufãr_šfo
->
d©©y³
è/ ucc_dt_size(
Ãw_d©©y³
);

90 
bufãr_šfo
->
d©©y³
 = 
Ãw_d©©y³
;

92 
	}
}

94 
šlše
 
ucc_¡©us_t
 
	$ucc__ncş_check_ªd_cÚv”t_bufãr_»duùiÚ
(

95 
ucc_cŞl_bufãr_šfo_t
 *
bufãr_šfo
, 
ucc__ncş_sk_t
 *
sk
)

97 
ucc_»duùiÚ_İ_t
 
İ
 = 
	`TASK_ARGS
(
sk
).op;

99 ià(
ucc_to_ncş_»duû_İ
[
İ
] =ğ
ncşOpUnsuµÜ‹d
) {

100 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "reduction operation %s is‚ot supported",

101 
	`ucc_»duùiÚ_İ_¡r
(
İ
));

102  
UCC_ERR_NOT_SUPPORTED
;

105 ià(
ucc_to_ncş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
bufãr_šfo
->
d©©y³
)] ==

106 
ncşD©aTy³UnsuµÜ‹d
) {

107 ià(
İ
 =ğ
UCC_OP_SUM
) {

108 
bufãr_šfo
->
d©©y³
) {

109 
UCC_DT_FLOAT32_COMPLEX
:

110 
	`ucc__ncş_check_ªd_cÚv”t_bufãr
(
bufãr_šfo
,

111 
UCC_DT_FLOAT32
);

112  
UCC_OK
;

113 
UCC_DT_FLOAT64_COMPLEX
:

114 
	`ucc__ncş_check_ªd_cÚv”t_bufãr
(
bufãr_šfo
,

115 
UCC_DT_FLOAT64
);

116  
UCC_OK
;

121 
	`_debug
(
	`UCC_TASK_LIB
(
sk
),

123 
	`ucc_d©©y³_¡r
(
bufãr_šfo
->
d©©y³
),

124 
	`ucc_»duùiÚ_İ_¡r
(
İ
));

125  
UCC_ERR_NOT_SUPPORTED
;

127  
UCC_OK
;

128 
	}
}

130 
ucc_¡©us_t
 
	$ucc__ncş_š™_sk
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

131 
ucc_ba£_‹am_t
 *
‹am
,

132 
ucc__ncş_sk_t
 **
cŞl_sk
)

134 
ucc__ncş_‹am_t
 *
ncş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_nccl_team_t);

135 
ucc__ncş_cÚ‹xt_t
 *
ncş_ùx
 = 
	`ucc_d”ived_of
(
‹am
->
cÚ‹xt
,

136 
ucc__ncş_cÚ‹xt_t
);

137 
ucc__ncş_sk_t
 *
sk
;

138 
ucc_¡©us_t
 
¡©us
;

139 
ucc_cŞl_´og»ss_â_t
 
´og»ss_â
;

141 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&
cŞl_¬gs
->
¬gs
, 
‹am
->
·¿ms
.
¿nk
)) {

142 
	`_”rÜ
(
‹am
->
cÚ‹xt
->
lib
,

144  
UCC_ERR_NOT_SUPPORTED
;

147 ià(
	`ucc_uÆik–y
(
ncş_‹am
->
comm_¡©e
 !ğ
TL_NCCL_COMM_STATE_READY
)) {

148 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(&
cŞl_¬gs
->
¬gs
)) {

150  
UCC_ERR_NOT_SUPPORTED
;

152 
¡©us
 = 
	`ucc__ncş_comm_š™
(
ncş_‹am
);

153 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

154  
¡©us
;

158 
sk
 = 
	`ucc_mpoŞ_g‘
(&
ncş_ùx
->
»q_mp
);

159 ià(
	`ucc_uÆik–y
(!
sk
)) {

160 
	`_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "failedo getask from mpool");

161  
UCC_ERR_NO_MEMORY
;

163 
´og»ss_â
 = 
sk
->
su³r
.
´og»ss
;

165 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, 
cŞl_¬gs
, 
‹am
);

166 
	`UCC_TL_NCCL_PROFILE_REQUEST_NEW
(
sk
, "tl_nccl_task", 0);

167 
sk
->
su³r
.
fš®ize
 = 
ucc__ncş_cŞl_fš®ize
;

168 
sk
->
su³r
.
Œigg”ed_po¡
 = 
ucc__ncş_Œigg”ed_po¡
;

169 
sk
->
su³r
.
´og»ss
 = 
´og»ss_â
;

170 
sk
->
com¶‘ed
 = 
NULL
;

171 ià(
ncş_ùx
->
cfg
.
sync_ty³
 =ğ
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_EVENT
) {

172 
¡©us
 = 
	`ucc_ec_ü—‹_ev’t
(&
sk
->
com¶‘ed
, 
UCC_EE_CUDA_STREAM
);

173 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

174 
	`ucc_mpoŞ_put
(
sk
);

175  
¡©us
;

179 *
cŞl_sk
 = 
sk
;

180  
UCC_OK
;

181 
	}
}

183 
	$ucc__ncş_ä“_sk
(
ucc__ncş_sk_t
 *
sk
)

185 
	`UCC_TL_NCCL_PROFILE_REQUEST_FREE
(
sk
);

186 ià(
sk
->
com¶‘ed
) {

187 
	`ucc_ec_de¡roy_ev’t
(
sk
->
com¶‘ed
, 
UCC_EE_CUDA_STREAM
);

189 
	`ucc_mpoŞ_put
(
sk
);

190 
	}
}

192 
ucc_¡©us_t
 
	$ucc__ncş_Œigg”ed_po¡
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
,

193 
ucc_cŞl_sk_t
 *
cŞl_sk
)

195 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

196 
ucc_¡©us_t
 
¡©us
;

197 
ucc_ev_t
 
po¡_ev’t
;

199 
	`ucc_as£¹
(
“
->
“_ty³
 =ğ
UCC_EE_CUDA_STREAM
);

200 
cŞl_sk
->
“
 =ƒe;

201 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "Œigg”ed…o¡.ask:%p", 
cŞl_sk
);

202 
¡©us
 = 
cŞl_sk
->
	`po¡
(coll_task);

203 ià(
	`ucc_lik–y
(
¡©us
 =ğ
UCC_OK
)) {

204 
po¡_ev’t
.
ev_ty³
 = 
UCC_EVENT_COLLECTIVE_POST
;

205 
po¡_ev’t
.
ev_cÚ‹xt_size
 = 0;

206 
po¡_ev’t
.
ev_cÚ‹xt
 = 
NULL
;

207 
po¡_ev’t
.
»q
 = &
cŞl_sk
->
su³r
;

208 
	`ucc_“_£t_ev’t_š‹º®
(
cŞl_sk
->
“
, &
po¡_ev’t
,

209 &
cŞl_sk
->
“
->
ev’t_out_queue
);

211  
¡©us
;

212 
	}
}

214 
ucc_¡©us_t
 
	$ucc__ncş_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

216 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

217 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

218 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

220 ià(
	`ucc_uÆik–y
(
sk
->
su³r
.su³r.
¡©us
 !ğ
UCC_OK
)) {

221 
‹am
->
comm_¡©e
 = 
TL_NCCL_COMM_STATE_ERROR
;

223 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "finalizing collask %p",ask);

224 
	`ucc__ncş_ä“_sk
(
sk
);

225  
¡©us
;

226 
	}
}

228 
ucc_¡©us_t
 
	$ucc__ncş_cŞËùive_sync
(
ucc__ncş_sk_t
 *
sk
,

229 
cudaSŒ—m_t
 
¡»am
)

231 
ucc__ncş_cÚ‹xt_t
 *
ùx
 = 
	`TASK_CTX
(
sk
);

232 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

233 
cudaSŒ—mC­tu»Stus
 
ÿ±u»_¡
;

234 
CU»suÉ
 
cu_¡©us
;

235 
cudaE¼Ü_t
 
cuda_¡
;

237 ià(
sk
->
su³r
.
“
) {

238 
cuda_¡
 =
	`cudaSŒ—mIsC­turšg
((
cudaSŒ—m_t
)
sk
->
su³r
.
“
->
“_cÚ‹xt
,

239 &
ÿ±u»_¡
);

240 ià((
cuda_¡
 =ğ
cudaSucûss
) &&

241 (
ÿ±u»_¡
 !ğ
cudaSŒ—mC­tu»StusNÚe
)) {

242 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

243  
	`ucc_sk_com¶‘e
(&
sk
->
su³r
);

247 
sk
->
ho¡_¡©us
 =ask->
su³r
.
¡©us
;

248 ià(
ùx
->
cfg
.
sync_ty³
 =ğ
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_EVENT
) {

249 
¡©us
 = 
	`ucc_ec_ev’t_po¡
(
¡»am
, 
sk
->
com¶‘ed
, 
UCC_EE_CUDA_STREAM
);

250 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

251  
¡©us
;

254 
cu_¡©us
 = 
	`cuSŒ—mWr™eV®ue32
(
¡»am
, (
CUdeviû±r
)
sk
->
dev_¡©us
,

255 
UCC_OK
, 0);

256 ià(
	`ucc_uÆik–y
(
cu_¡©us
 !ğ
CUDA_SUCCESS
)) {

257  
UCC_ERR_NO_MESSAGE
;

261  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
	`TASK_TEAM
(
sk
))->
pq
,

262 &
sk
->
su³r
);

263 
	}
}

265 
ucc_¡©us_t
 
	$ucc__ncş_®ÉßÎ_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

267 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

268 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

269 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

270 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

271 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

272 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

273 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

274 
±rdiff_t
 
sbuf
 = (±rdiff_t)
¬gs
->
¤c
.
šfo
.
bufãr
;

275 
±rdiff_t
 
rbuf
 = (±rdiff_t)
¬gs
->
d¡
.
šfo
.
bufãr
;

276 
size_t
 
d©a_size
;

277 
ucc_¿nk_t
 
³”
;

279 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

280 
d©a_size
 = (
size_t
)(
¬gs
->
¤c
.
šfo
.
couÁ
 / 
gsize
) *

281 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

282 
	`ucc_as£¹
(
¬gs
->
¤c
.
šfo
.
couÁ
 % 
gsize
 == 0);

283 ià(
d©a_size
 == 0) {

284 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

285  
	`ucc_sk_com¶‘e
(&
sk
->
su³r
);

287 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_alltoall_start", 0);

288 
	`NCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

289 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

290 
³”
 = 0;…“¸< 
gsize
;…eer++) {

291 
	`NCCLCHECK_GOTO
(
	`ncşS’d
((*)(
sbuf
 + 
³”
 * 
d©a_size
), data_size,

292 
ncşCh¬
, 
³”
, 
‹am
->
ncş_comm
, 
¡»am
),

293 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

294 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

295 
	`NCCLCHECK_GOTO
(
	`ncşRecv
((*)(
rbuf
 + 
³”
 * 
d©a_size
), data_size,

296 
ncşCh¬
, 
³”
, 
‹am
->
ncş_comm
, 
¡»am
),

297 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

298 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

300 
	`NCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

301 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

302 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

303 
ex™_cŞl
:

304  
¡©us
;

305 
	}
}

307 
ucc_¡©us_t
 
	$ucc__ncş_®ÉßÎ_š™
(
ucc__ncş_sk_t
 *
sk
)

309 ià(
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

310 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "inplace‡lltoallv is‚ot supported");

311  
UCC_ERR_NOT_SUPPORTED
;

314 
sk
->
su³r
.
po¡
 = 
ucc__ncş_®ÉßÎ_¡¬t
;

315  
UCC_OK
;

316 
	}
}

318 
ucc_¡©us_t
 
	$ucc__ncş_®ÉßÎv_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

320 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

321 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

322 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

323 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

324 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

325 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

326 
±rdiff_t
 
sbuf
 = (±rdiff_t)
¬gs
->
¤c
.
šfo_v
.
bufãr
;

327 
±rdiff_t
 
rbuf
 = (±rdiff_t)
¬gs
->
d¡
.
šfo_v
.
bufãr
;

328 
size_t
 
sdt_size
, 
rdt_size
, 
couÁ
, 
di¥l
;

329 
ucc_¿nk_t
 
³”
;

331 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

332 
sdt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
);

333 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

334 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_alltoallv_start", 0);

335 
	`NCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

336 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

337 
³”
 = 0;…“¸< 
	`UCC_TL_TEAM_SIZE
(
‹am
);…eer++) {

338 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
, 
³”
);

339 ià(
couÁ
 != 0) {

340 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

341 
¬gs
,‡rgs->
¤c
.
šfo_v
.
di¥Ïûm’ts
, 
³”
);

342 
	`NCCLCHECK_GOTO
(
	`ncşS’d
((*)(
sbuf
 + 
di¥l
 * 
sdt_size
),

343 
couÁ
 * 
sdt_size
, 
ncşCh¬
, 
³”
,

344 
‹am
->
ncş_comm
, 
¡»am
),

345 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

346 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

348 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
³”
);

349 ià(
couÁ
 != 0) {

350 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

351 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
³”
);

352 
	`NCCLCHECK_GOTO
(
	`ncşRecv
((*)(
rbuf
 + 
di¥l
 * 
rdt_size
),

353 
couÁ
 * 
rdt_size
, 
ncşCh¬
, 
³”
,

354 
‹am
->
ncş_comm
, 
¡»am
),

355 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

356 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

359 
	`NCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

360 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

361 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

362 
ex™_cŞl
:

363  
¡©us
;

364 
	}
}

366 
ucc_¡©us_t
 
	$ucc__ncş_®ÉßÎv_š™
(
ucc__ncş_sk_t
 *
sk
)

368 ià(
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

369 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "inplace‡lltoall is‚ot supported");

370  
UCC_ERR_NOT_SUPPORTED
;

373 
sk
->
su³r
.
po¡
 = 
ucc__ncş_®ÉßÎv_¡¬t
;

374  
UCC_OK
;

375 
	}
}

377 
ucc_¡©us_t
 
	$ucc__ncş_®Ìeduû_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

379 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

380 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

381 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

382 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

383 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

384 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

385 *
¤c
 =

386 
	`UCC_IS_INPLACE
(*
¬gs
è?‡rgs->
d¡
.
šfo
.
bufãr
 :‡rgs->
¤c
.info.buffer;

387 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

388 
ncşRedOp_t
 
İ
 = 
ucc_to_ncş_»duû_İ
[
¬gs
->op];

389 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

390 
ncşD©aTy³_t
 
dt
;

392 
dt
 = 
ucc_to_ncş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)];

393 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

394 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
,

395 
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BARRIER


399 
	`NCCLCHECK_GOTO
(
	`ncşAÎReduû
(
¤c
, 
d¡
, 
couÁ
, 
dt
, 
İ
, 
‹am
->
ncş_comm
,

400 
¡»am
),

401 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

402 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

403 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

404 
ex™_cŞl
:

405  
¡©us
;

406 
	}
}

408 
ucc_¡©us_t
 
	$ucc__ncş_®Ìeduû_š™
(
ucc__ncş_sk_t
 *
sk
)

410 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

412 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

413 ià(
	`ucc__ncş_check_ªd_cÚv”t_bufãr_»duùiÚ
(&
¬gs
->
¤c
.
šfo
,

414 
sk
è!ğ
UCC_OK
) {

415  
UCC_ERR_NOT_SUPPORTED
;

419 ià(
	`ucc__ncş_check_ªd_cÚv”t_bufãr_»duùiÚ
(&
¬gs
->
d¡
.
šfo
, 
sk
) !=

420 
UCC_OK
) {

421  
UCC_ERR_NOT_SUPPORTED
;

424 
sk
->
su³r
.
po¡
 = 
ucc__ncş_®Ìeduû_¡¬t
;

425  
UCC_OK
;

426 
	}
}

428 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

430 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

431 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

432 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

433 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

434 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

435 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

436 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

437 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

438 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

439 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

440 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

441 
ncşD©aTy³_t
 
dt
;

443 
dt
 = 
ucc_to_ncş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)];

444 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

445 
¤c
 = (*)((
±rdiff_t
)
¬gs
->
d¡
.
šfo
.
bufãr
 + (
couÁ
 / 
size
) *

446 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
è* 
¿nk
);

448 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

449 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_allgather_start", 0);

450 
	`NCCLCHECK_GOTO
(
	`ncşAÎG©h”
(
¤c
, 
d¡
, 
couÁ
 / 
size
, 
dt
,

451 
‹am
->
ncş_comm
, 
¡»am
),

452 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

453 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

454 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

455 
ex™_cŞl
:

456  
¡©us
;

457 
	}
}

459 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”_š™
(
ucc__ncş_sk_t
 *
sk
)

461 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

463 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

464 
	`ucc__ncş_check_ªd_cÚv”t_bufãr
(

465 &
¬gs
->
¤c
.
šfo
, 
UCC_TL_NCCL_DT_FOR_UNSUPPORTED
);

468 
	`ucc__ncş_check_ªd_cÚv”t_bufãr
(&
¬gs
->
d¡
.
šfo
,

469 
UCC_TL_NCCL_DT_FOR_UNSUPPORTED
);

471 
sk
->
su³r
.
po¡
 = 
ucc__ncş_®lg©h”_¡¬t
;

472  
UCC_OK
;

473 
	}
}

475 
ucc_¡©us_t
 
	$ucc__ncş_®lg©h”v_š™
(
ucc__ncş_sk_t
 *
sk
)

477 
sk
->
su³r
.
po¡
 = 
ucc__ncş_®lg©h”v_p2p_¡¬t
;

478  
UCC_OK
;

479 
	}
}

481 
ucc_¡©us_t
 
	$ucc__ncş_bÿ¡_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

483 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

484 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

485 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

486 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

487 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

488 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

489 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

490 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

491 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

492 
ucc_¿nk_t
 
³”
, 
¿nk
, 
size
;

493 
ncşD©aTy³_t
 
dt
;

494 
ucc_•_m­_t
 
m­
;

496 
dt
 = 
ucc_to_ncş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
¤c
.
šfo
.
d©©y³
)];

497 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

498 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_bcast_start", 0);

500 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(
¬gs
)) {

501 
m­
 = 
	`ucc_aùive_£t_to_•_m­
(
¬gs
);

502 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

503 
size
 = (
ucc_¿nk_t
)
¬gs
->
aùive_£t
.size;

504 ià(
roÙ
 =ğ
¿nk
) {

505 
	`NCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
,

506 
	`UCC_TL_TEAM_LIB
(
‹am
), &
sk
->
ncş_´og»ss_¡
,

507 
‹am
->
ncş_comm
, 0);

508 
³”
 = 0;…“¸< 
size
;…eer++) {

509 ià(
	`ucc_•_m­_ev®
(
m­
, 
³”
è=ğ
¿nk
) {

512 
	`NCCLCHECK_GOTO
(
	`ncşS’d
(
¤c
, 
couÁ
, 
dt
,

513 
	`ucc_•_m­_ev®
(
m­
, 
³”
),

514 
‹am
->
ncş_comm
, 
¡»am
),

515 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

516 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

518 
	`NCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

519 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

521 
	`NCCLCHECK_GOTO
(
	`ncşRecv
(
¤c
, 
couÁ
, 
dt
, 
roÙ
,

522 
‹am
->
ncş_comm
, 
¡»am
),

523 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

524 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

527 
	`NCCLCHECK_GOTO
(
	`ncşBrßdÿ¡
(
¤c
, src, 
couÁ
, 
dt
, 
roÙ
, 
‹am
->
ncş_comm
,

528 
¡»am
),

529 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

530 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

532 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

533 
ex™_cŞl
:

534  
¡©us
;

535 
	}
}

537 
ucc_¡©us_t
 
	$ucc__ncş_bÿ¡_š™
(
ucc__ncş_sk_t
 *
sk
)

539 
	`ucc__ncş_check_ªd_cÚv”t_bufãr
(&
	`TASK_ARGS
(
sk
).
¤c
.
šfo
,

540 
UCC_TL_NCCL_DT_FOR_UNSUPPORTED
);

542 
sk
->
su³r
.
po¡
 = 
ucc__ncş_bÿ¡_¡¬t
;

543  
UCC_OK
;

544 
	}
}

546 
ucc_¡©us_t
 
	$ucc__ncş_»duû_sÿ‰”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

548 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

549 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

550 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

551 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

552 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

553 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

554 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

555 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

556 
ncşRedOp_t
 
İ
 = 
ucc_to_ncş_»duû_İ
[
¬gs
->op];

557 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

558 
ncşD©aTy³_t
 
dt
;

560 
dt
 = 
ucc_to_ncş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)];

561 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

562 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_reduce_scatter_start", 0);

563 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

564 
couÁ
 /ğ
	`UCC_TL_TEAM_SIZE
(
‹am
);

565 
¤c
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

566 
d¡
 = 
	`PTR_OFFSET
(
¤c
, 
	`UCC_TL_TEAM_RANK
(
‹am
è* 
couÁ


567 * 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
));

569 
	`NCCLCHECK_GOTO
(
	`ncşReduûSÿ‰”
(
¤c
, 
d¡
, 
couÁ
, 
dt
, 
İ
, 
‹am
->
ncş_comm
,

570 
¡»am
),

571 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

572 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

573 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

574 
ex™_cŞl
:

575  
¡©us
;

576 
	}
}

578 
ucc_¡©us_t
 
	$ucc__ncş_»duû_sÿ‰”_š™
(
ucc__ncş_sk_t
 *
sk
)

580 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

582 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

583 ià(
	`ucc__ncş_check_ªd_cÚv”t_bufãr_»duùiÚ
(&
¬gs
->
¤c
.
šfo
,

584 
sk
è!ğ
UCC_OK
) {

585  
UCC_ERR_NOT_SUPPORTED
;

589 ià(
	`ucc__ncş_check_ªd_cÚv”t_bufãr_»duùiÚ
(&
¬gs
->
d¡
.
šfo
, 
sk
) !=

590 
UCC_OK
) {

591  
UCC_ERR_NOT_SUPPORTED
;

594 
sk
->
su³r
.
po¡
 = 
ucc__ncş_»duû_sÿ‰”_¡¬t
;

595  
UCC_OK
;

596 
	}
}

598 
ucc_¡©us_t
 
	$ucc__ncş_»duû_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

600 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

601 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

602 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

603 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

604 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

605 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

606 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

607 
ucc_d©©y³_t
 
ucc_dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

608 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

609 
ncşRedOp_t
 
İ
 = 
ucc_to_ncş_»duû_İ
[
¬gs
->op];

610 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

611 
ncşD©aTy³_t
 
ncş_dt
;

613 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_reduce_start", 0);

614 ià(
¬gs
->
roÙ
 =ğ
	`UCC_TL_TEAM_RANK
(
‹am
)) {

615 
ucc_dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

616 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

617 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

618 
¤c
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

621 
ncş_dt
 = 
ucc_to_ncş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
ucc_dt
)];

622 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

623 
	`NCCLCHECK_GOTO
(
	`ncşReduû
(
¤c
, 
d¡
, 
couÁ
, 
ncş_dt
, 
İ
, 
¬gs
->
roÙ
,

624 
‹am
->
ncş_comm
, 
¡»am
),

625 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

626 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

627 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

628 
ex™_cŞl
:

629  
¡©us
;

630 
	}
}

632 
ucc_¡©us_t
 
	$ucc__ncş_»duû_š™
(
ucc__ncş_sk_t
 *
sk
)

634 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

635 
is_roÙ
 =

636 
	`UCC_IS_ROOT
(
	`TASK_ARGS
(
sk
), 
	`UCC_TL_TEAM_RANK
(
	`TASK_TEAM
(task)));

638 ià(
is_roÙ
) {

639 ià(
	`ucc__ncş_check_ªd_cÚv”t_bufãr_»duùiÚ
(&
¬gs
->
d¡
.
šfo
,

640 
sk
è!ğ
UCC_OK
) {

641  
UCC_ERR_NOT_SUPPORTED
;

645 ià(!(
is_roÙ
 && 
	`UCC_IS_INPLACE
(*
¬gs
))) {

646 ià(
	`ucc__ncş_check_ªd_cÚv”t_bufãr_»duùiÚ
(&
¬gs
->
¤c
.
šfo
,

647 
sk
è!ğ
UCC_OK
) {

648  
UCC_ERR_NOT_SUPPORTED
;

652 
sk
->
su³r
.
po¡
 = 
ucc__ncş_»duû_¡¬t
;

653  
UCC_OK
;

654 
	}
}

656 
ucc_¡©us_t
 
	$ucc__ncş_b¬r›r_š™
(
ucc__ncş_sk_t
 *
sk
)

659 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

661 
¬gs
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

662 
¬gs
->
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

663 
¬gs
->
İ
 = 
UCC_OP_SUM
;

665 
¬gs
->
d¡
.
šfo
.
bufãr
 = 
	`TASK_CTX
(
sk
)->
sü©ch_buf
;

666 
¬gs
->
¤c
.
šfo
.
bufãr
 =‡rgs->
d¡
.info.buffer;

667 
¬gs
->
d¡
.
šfo
.
d©©y³
 =‡rgs->
¤c
.šfo.d©©y³ = 
UCC_DT_FLOAT32
;

668 
¬gs
->
d¡
.
šfo
.
couÁ
 =‡rgs->
¤c
.info.count = 1;

670 
sk
->
su³r
.
po¡
 = 
ucc__ncş_®Ìeduû_¡¬t
;

672  
UCC_OK
;

673 
	}
}

675 
ucc_¡©us_t
 
	$ucc__ncş_g©h”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

677 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

678 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

679 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

680 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

681 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

682 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

683 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

684 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

685 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

686 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

687 
size_t
 
£nd_size
;

688 
ucc_¿nk_t
 
³”
;

690 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

691 
£nd_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
) *

692 
¬gs
->
d¡
.
šfo
.
couÁ
 / 
size
;

694 
£nd_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
è*‡rgs->¤c.šfo.
couÁ
;

697 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_gather_start", 0);

698 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

699 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

700 
	`CUDA_CHECK_GOTO
(
	`cudaMemıyAsync
(
	`PTR_OFFSET
(
d¡
, 
¿nk
 * 
£nd_size
),

701 
¤c
, 
£nd_size
,

702 
cudaMemıyDeviûToDeviû
, 
¡»am
),

703 
ex™_cŞl
, 
¡©us
);

705 
	`NCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
,

706 
	`UCC_TL_TEAM_LIB
(
‹am
), &
sk
->
ncş_´og»ss_¡
,

707 
‹am
->
ncş_comm
, 0);

708 
³”
 = 0;…“¸< 
size
;…eer++) {

709 ià(
³”
 =ğ
¬gs
->
roÙ
) {

712 
	`NCCLCHECK_GOTO
(
	`ncşRecv
(
	`PTR_OFFSET
(
d¡
, 
³”
 * 
£nd_size
),

713 
£nd_size
, 
ncşCh¬
, 
³”
, 
‹am
->
ncş_comm
,

714 
¡»am
),

715 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

716 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

718 
	`NCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
,

719 
	`UCC_TL_TEAM_LIB
(
‹am
), &
sk
->
ncş_´og»ss_¡
,

720 
‹am
->
ncş_comm
, 1);

722 
	`NCCLCHECK_GOTO
(
	`ncşS’d
(
¤c
, 
£nd_size
, 
ncşCh¬
, 
¬gs
->
roÙ
,

723 
‹am
->
ncş_comm
, 
¡»am
),

724 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

725 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

727 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

728 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

729 
ex™_cŞl
:

730  
¡©us
;

731 
	}
}

733 
ucc_¡©us_t
 
	$ucc__ncş_g©h”_š™
(
ucc__ncş_sk_t
 *
sk
)

735 
sk
->
su³r
.
po¡
 = 
ucc__ncş_g©h”_¡¬t
;

736  
UCC_OK
;

737 
	}
}

739 
ucc_¡©us_t
 
	$ucc__ncş_g©h”v_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

741 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

742 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

743 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

744 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

745 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

746 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

747 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

748 *
d¡
 = 
¬gs
->d¡.
šfo_v
.
bufãr
;

749 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

750 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

751 
size_t
 
couÁ
, 
di¥l
, 
dt_size
;

752 
ucc_¿nk_t
 
³”
;

754 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

755 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

757 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

760 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_gatherv_start", 0);

761 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

762 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

763 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
¿nk
);

764 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

765 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

766 
¿nk
);

767 
	`CUDA_CHECK_GOTO
(
	`cudaMemıyAsync
(
	`PTR_OFFSET
(
d¡
, 
di¥l
 * 
dt_size
),

768 
¤c
, 
couÁ
 * 
dt_size
,

769 
cudaMemıyDeviûToDeviû
, 
¡»am
),

770 
ex™_cŞl
, 
¡©us
);

772 
	`NCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
,

773 
	`UCC_TL_TEAM_LIB
(
‹am
), &
sk
->
ncş_´og»ss_¡
,

774 
‹am
->
ncş_comm
, 0);

775 
³”
 = 0;…“¸< 
size
;…eer++) {

776 ià(
³”
 =ğ
¬gs
->
roÙ
) {

779 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
³”
);

780 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

781 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

782 
³”
);

783 
	`NCCLCHECK_GOTO
(
	`ncşRecv
(
	`PTR_OFFSET
(
d¡
, 
di¥l
 * 
dt_size
),

784 
couÁ
 * 
dt_size
, 
ncşCh¬
,

785 
³”
,
‹am
->
ncş_comm
, 
¡»am
),

786 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

787 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

789 
	`NCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
,

790 
	`UCC_TL_TEAM_LIB
(
‹am
), &
sk
->
ncş_´og»ss_¡
,

791 
‹am
->
ncş_comm
, 1);

793 
	`NCCLCHECK_GOTO
(
	`ncşS’d
(
¤c
, 
¬gs
->¤c.
šfo
.
couÁ
 * 
dt_size
,

794 
ncşCh¬
, 
¬gs
->
roÙ
, 
‹am
->
ncş_comm
,

795 
¡»am
),

796 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

797 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

799 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

800 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

801 
ex™_cŞl
:

802  
¡©us
;

803 
	}
}

805 
ucc_¡©us_t
 
	$ucc__ncş_g©h”v_š™
(
ucc__ncş_sk_t
 *
sk
)

807 
sk
->
su³r
.
po¡
 = 
ucc__ncş_g©h”v_¡¬t
;

808  
UCC_OK
;

809 
	}
}

811 
ucc_¡©us_t
 
	$ucc__ncş_sÿ‰”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

813 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

814 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

815 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

816 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

817 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

818 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

819 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

820 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

821 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

822 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

823 
size_t
 
£nd_size
;

824 
ucc_¿nk_t
 
³”
;

826 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

827 
£nd_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
) *

828 
¬gs
->
¤c
.
šfo
.
couÁ
 / 
size
;

830 
£nd_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
è*‡rgs->d¡.šfo.
couÁ
;

833 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_scatter_start", 0);

834 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

835 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

836 
	`CUDA_CHECK_GOTO
(
	`cudaMemıyAsync
(
d¡
,

837 
	`PTR_OFFSET
(
¤c
, 
¿nk
 * 
£nd_size
),

838 
£nd_size
, 
cudaMemıyDeviûToDeviû
,

839 
¡»am
),

840 
ex™_cŞl
, 
¡©us
);

842 
	`NCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
,

843 
	`UCC_TL_TEAM_LIB
(
‹am
), &
sk
->
ncş_´og»ss_¡
,

844 
‹am
->
ncş_comm
, 0);

845 
³”
 = 0;…“¸< 
size
;…eer++) {

846 ià(
³”
 =ğ
¬gs
->
roÙ
) {

849 
	`NCCLCHECK_GOTO
(
	`ncşS’d
(
	`PTR_OFFSET
(
¤c
, 
³”
 * 
£nd_size
),

850 
£nd_size
, 
ncşCh¬
, 
³”
, 
‹am
->
ncş_comm
,

851 
¡»am
),

852 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

853 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

855 
	`NCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

856 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

858 
	`NCCLCHECK_GOTO
(
	`ncşRecv
(
d¡
, 
£nd_size
, 
ncşCh¬
, 
¬gs
->
roÙ
,

859 
‹am
->
ncş_comm
, 
¡»am
),

860 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

861 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

863 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

864 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

865 
ex™_cŞl
:

866  
¡©us
;

867 
	}
}

869 
ucc_¡©us_t
 
	$ucc__ncş_sÿ‰”_š™
(
ucc__ncş_sk_t
 *
sk
)

871 
sk
->
su³r
.
po¡
 = 
ucc__ncş_sÿ‰”_¡¬t
;

872  
UCC_OK
;

873 
	}
}

875 
ucc_¡©us_t
 
	$ucc__ncş_sÿ‰”v_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

877 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

878 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

879 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

880 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

881 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

882 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

883 
cudaSŒ—m_t
 
¡»am
 = (
“
è? (cudaSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

884 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

885 *
¤c
 = 
¬gs
->¤c.
šfo_v
.
bufãr
;

886 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

887 
size_t
 
couÁ
, 
di¥l
, 
dt_size
;

888 
ucc_¿nk_t
 
³”
;

890 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

891 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
);

893 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

896 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_scatterv_start", 0);

897 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

898 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

899 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
, 
¿nk
);

900 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

901 
¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
,

902 
¿nk
);

903 
	`CUDA_CHECK_GOTO
(
	`cudaMemıyAsync
(
d¡
,

904 
	`PTR_OFFSET
(
¤c
, 
di¥l
 * 
dt_size
),

905 
couÁ
 * 
dt_size
,

906 
cudaMemıyDeviûToDeviû
,

907 
¡»am
),

908 
ex™_cŞl
, 
¡©us
);

910 
	`NCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
,

911 
	`UCC_TL_TEAM_LIB
(
‹am
), &
sk
->
ncş_´og»ss_¡
,

912 
‹am
->
ncş_comm
, 0);

913 
³”
 = 0;…“¸< 
size
;…eer++) {

914 ià(
³”
 =ğ
¬gs
->
roÙ
) {

917 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
, 
³”
);

918 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

919 
¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
,

920 
³”
);

921 
	`NCCLCHECK_GOTO
(
	`ncşS’d
(
	`PTR_OFFSET
(
¤c
, 
di¥l
 * 
dt_size
),

922 
couÁ
 * 
dt_size
, 
ncşCh¬
, 
³”
,

923 
‹am
->
ncş_comm
, 
¡»am
),

924 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

925 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 0);

927 
	`NCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

928 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

930 
	`NCCLCHECK_GOTO
(
	`ncşRecv
(
d¡
, 
¬gs
->d¡.
šfo
.
couÁ
 * 
dt_size
, 
ncşCh¬
,

931 
¬gs
->
roÙ
, 
‹am
->
ncş_comm
, 
¡»am
),

932 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
),

933 &
sk
->
ncş_´og»ss_¡
, 
‹am
->
ncş_comm
, 1);

935 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

936 
¡©us
 = 
	`ucc__ncş_cŞËùive_sync
(
sk
, 
¡»am
);

937 
ex™_cŞl
:

938  
¡©us
;

939 
	}
}

941 
ucc_¡©us_t
 
	$ucc__ncş_sÿ‰”v_š™
(
ucc__ncş_sk_t
 *
sk
)

943 
sk
->
su³r
.
po¡
 = 
ucc__ncş_sÿ‰”v_¡¬t
;

944  
UCC_OK
;

945 
	}
}

947 
šlše
 
	$®g_id_äom_¡r
(
ucc_cŞl_ty³_t
 
cŞl_ty³
, cÚ¡ *
¡r
)

949 
cŞl_ty³
) {

950 
UCC_COLL_TYPE_ALLGATHERV
:

951  
	`ucc__ncş_®lg©h”v_®g_äom_¡r
(
¡r
);

956 
	}
}

958 
ucc_¡©us_t
 
	$ucc__ncş_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

959 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

960 
ucc_memÜy_ty³_t
 
mem_ty³
,

961 
ucc_ba£_cŞl_š™_â_t
 *
š™
)

963 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

964 ià(
®g_id_¡r
) {

965 
®g_id
 = 
	`®g_id_äom_¡r
(
cŞl_ty³
, 
®g_id_¡r
);

968 
cŞl_ty³
) {

969 
UCC_COLL_TYPE_ALLGATHERV
:

970 
®g_id
) {

971 
UCC_TL_NCCL_ALLGATHERV_ALG_P2P
:

972 *
š™
 = 
ucc__ncş_®lg©h”v_p2p_š™
;

974 
UCC_TL_NCCL_ALLGATHERV_ALG_BCOPY
:

975 *
š™
 = 
ucc__ncş_®lg©h”v_bcİy_š™
;

977 
UCC_TL_NCCL_ALLGATHERV_ALG_BCAST
:

978 *
š™
 = 
ucc__ncş_®lg©h”v_bÿ¡_š™
;

981 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

986 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

989  
¡©us
;

990 
	}
}

	@src/components/tl/nccl/tl_nccl_coll.h

8 #iâdeà
UCC_TL_NCCL_COLL_H_


9 
	#UCC_TL_NCCL_COLL_H_


	)

11 
	~"_ncş.h
"

13 
	#UCC_TL_NCCL_DT_FOR_UNSUPPORTED
 
UCC_DT_INT8


	)

14 
	#UCC_TL_NCCL_N_DEFAULT_ALG_SELECT_STR
 1

	)

16 *
ucc__ncş_deçuÉ_®g_£Ëù_¡r
[
UCC_TL_NCCL_N_DEFAULT_ALG_SELECT_STR
];

18 
ucc_¡©us_t
 
ucc__ncş_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

19 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

20 
ucc_memÜy_ty³_t
 
mem_ty³
,

21 
ucc_ba£_cŞl_š™_â_t
 *
š™
);

23 
ucc_¡©us_t
 
ucc__ncş_š™_sk
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

24 
ucc_ba£_‹am_t
 *
‹am
,

25 
ucc__ncş_sk_t
 **
cŞl_sk
);

27 
ucc__ncş_ä“_sk
(
ucc__ncş_sk_t
 *
sk
);

29 
ucc_¡©us_t
 
ucc__ncş_Œigg”ed_po¡
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
,

30 
ucc_cŞl_sk_t
 *
cŞl_sk
);

32 
ucc_¡©us_t
 
ucc__ncş_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

34 
ucc_¡©us_t
 
ucc__ncş_cŞËùive_sync
(
ucc__ncş_sk_t
 *
sk
,

35 
cudaSŒ—m_t
 
¡»am
);

37 
ucc_¡©us_t
 
ucc__ncş_®lg©h”_š™
(
ucc__ncş_sk_t
 *
sk
);

39 
ucc_¡©us_t
 
ucc__ncş_®lg©h”v_š™
(
ucc__ncş_sk_t
 *
sk
);

41 
ucc_¡©us_t
 
ucc__ncş_®Ìeduû_š™
(
ucc__ncş_sk_t
 *
sk
);

43 
ucc_¡©us_t
 
ucc__ncş_®ÉßÎ_š™
(
ucc__ncş_sk_t
 *
sk
);

45 
ucc_¡©us_t
 
ucc__ncş_®ÉßÎv_š™
(
ucc__ncş_sk_t
 *
sk
);

47 
ucc_¡©us_t
 
ucc__ncş_bÿ¡_š™
(
ucc__ncş_sk_t
 *
sk
);

49 
ucc_¡©us_t
 
ucc__ncş_»duû_sÿ‰”_š™
(
ucc__ncş_sk_t
 *
sk
);

51 
ucc_¡©us_t
 
ucc__ncş_»duû_š™
(
ucc__ncş_sk_t
 *
sk
);

53 
ucc_¡©us_t
 
ucc__ncş_b¬r›r_š™
(
ucc__ncş_sk_t
 *
sk
);

55 
ucc_¡©us_t
 
ucc__ncş_g©h”_š™
(
ucc__ncş_sk_t
 *
sk
);

57 
ucc_¡©us_t
 
ucc__ncş_g©h”v_š™
(
ucc__ncş_sk_t
 *
sk
);

59 
ucc_¡©us_t
 
ucc__ncş_sÿ‰”_š™
(
ucc__ncş_sk_t
 *
sk
);

61 
ucc_¡©us_t
 
ucc__ncş_sÿ‰”v_š™
(
ucc__ncş_sk_t
 *
sk
);

	@src/components/tl/nccl/tl_nccl_context.c

8 
	~"_ncş.h
"

9 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
	~"compÚ’ts/ec/ucc_ec.h
"

11 
	~"cÜe/ucc_“.h
"

12 
	~"uts/¬ch/ıu.h
"

14 
ucc_¡©us_t
 
	$ucc__ncş_nb_´og»ss
(
ucc__ncş_sk_t
 *
sk
) {

15 #ià
NCCL_USE_NON_BLOCKING


16 
ucc__ncş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

17 
ncşResuÉ_t
 
ncş_¡©us
, 
¡
;

19 ià(
sk
->
ncş_´og»ss_¡
 =ğ
UCC_INPROGRESS
) {

20 
¡
 = 
	`ncşCommG‘AsyncE¼Ü
(
‹am
->
ncş_comm
, &
ncş_¡©us
);

21 ià(
¡
 !ğ
ncşSucûss
 ||

22 (
ncş_¡©us
 !ğ
ncşSucûss
 &&‚cş_¡©u !ğ
ncşInProg»ss
)) {

23 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "NCCLƒrror %d %s",

24 
¡
 !ğ
ncşSucûss
 ? sˆ: 
ncş_¡©us
,

25 
	`ncşG‘E¼ÜSŒšg
(
¡
 !ğ
ncşSucûss
 ? sˆ: 
ncş_¡©us
));

26  
UCC_ERR_NO_MESSAGE
;

28 ià(
ncş_¡©us
 =ğ
ncşInProg»ss
) {

29  
UCC_INPROGRESS
;

33  
UCC_OK
;

34 
	}
}

36 
	$ucc__ncş_ev’t_cŞËùive_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

38 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

39 
ucc_¡©us_t
 
¡©us
;

41 
¡©us
 = 
	`ucc__ncş_nb_´og»ss
(
sk
);

42 ià(
¡©us
 !ğ
UCC_OK
) {

43 
cŞl_sk
->
¡©us
 = status;

47 
	`ucc_as£¹
(
sk
->
com¶‘ed
 !ğ
NULL
);

48 
¡©us
 = 
	`ucc_ec_ev’t_‹¡
(
sk
->
com¶‘ed
, 
UCC_EE_CUDA_STREAM
);

49 
cŞl_sk
->
¡©us
 = status;

50 #ifdeà
HAVE_PROFILING_TL_NCCL


51 ià(
cŞl_sk
->
¡©us
 =ğ
UCC_OK
) {

52 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_coll_done", 0);

55 
	}
}

57 
	$ucc__ncş_driv”_cŞËùive_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

59 
ucc__ncş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_nccl_task_t);

60 
ucc_¡©us_t
 
¡©us
;

62 
¡©us
 = 
	`ucc__ncş_nb_´og»ss
(
sk
);

63 ià(
¡©us
 !ğ
UCC_OK
) {

64 
cŞl_sk
->
¡©us
 = status;

68 
cŞl_sk
->
¡©us
 = 
sk
->
ho¡_¡©us
;

69 #ifdeà
HAVE_PROFILING_TL_NCCL


70 ià(
cŞl_sk
->
¡©us
 =ğ
UCC_OK
) {

71 
	`UCC_TL_NCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "nccl_coll_done", 0);

74 
	}
}

76 
	$ucc__ncş_»q_mpoŞ_obj_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

78 
	`ucc_cŞl_sk_de¡ruù
(
obj
);

79 
	}
}

81 
	$ucc__ncş_»q_mpoŞ_obj_š™
(
ucc_mpoŞ_t
 *
mp
, *
obj
,

82 *
chunk
)

84 
ucc__ncş_sk_t
 *
»q
 = (ucc__ncş_sk_t*è
obj
;

86 
	`ucc_cŞl_sk_cÚ¡ruù
(&
»q
->
su³r
);

87 
»q
->
su³r
.
´og»ss
 = 
ucc__ncş_ev’t_cŞËùive_´og»ss
;

88 
»q
->
ncş_´og»ss_¡
 = 
UCC_OK
;

89 
	}
}

92 
ucc_mpoŞ_İs_t
 
	gucc__ncş_»q_mpoŞ_İs
 = {

93 .
chunk_®loc
 = 
ucc_mpoŞ_hug‘lb_m®loc
,

94 .
	gchunk_»Ëa£
 = 
ucc_mpoŞ_hug‘lb_ä“
,

95 .
	gobj_š™
 = 
ucc__ncş_»q_mpoŞ_obj_š™
,

96 .
	gobj_ş—nup
 = 
ucc__ncş_»q_mpoŞ_obj_ş—nup


99 
ucc_¡©us_t
 
	$ucc__ncş_»q_m­³d_mpoŞ_chunk_m®loc
(
ucc_mpoŞ_t
 *
mp
,

100 
size_t
 *
size_p
,

101 ** 
chunk_p
)

103 
cudaE¼Ü_t
 
cu_¡
;

105 
cu_¡
 = 
	`cudaHo¡AÎoc
((**)
chunk_p
, *
size_p
, 
cudaHo¡AÎocM­³d
);

106 ià(
cu_¡
 !ğ
cudaSucûss
) {

107  
UCC_ERR_NO_MEMORY
;

110  
UCC_OK
;

111 
	}
}

113 
	$ucc__ncş_»q_m­³d_mpoŞ_chunk_ä“
(
ucc_mpoŞ_t
 *
mp
,

114 *
chunk
)

116 
	`cudaF»eHo¡
(
chunk
);

117 
	}
}

119 
	$ucc__ncş_»q_m­³d_mpoŞ_obj_š™
(
ucc_mpoŞ_t
 *
mp
, *
obj
,

120 *
chunk
)

122 
ucc__ncş_sk_t
 *
»q
 = (ucc__ncş_sk_t*è
obj
;

123 
cudaE¼Ü_t
 
¡
;

124 
¡
 = 
	`cudaHo¡G‘DeviûPoš‹r
((**)(&
»q
->
dev_¡©us
),

125 (*)&
»q
->
ho¡_¡©us
, 0);

126 ià(
¡
 !ğ
cudaSucûss
) {

127 
»q
->
su³r
.
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

129 
	`ucc_cŞl_sk_cÚ¡ruù
(&
»q
->
su³r
);

130 
»q
->
su³r
.
´og»ss
 = 
ucc__ncş_driv”_cŞËùive_´og»ss
;

131 
»q
->
ncş_´og»ss_¡
 = 
UCC_OK
;

132 
	}
}

134 
ucc_mpoŞ_İs_t
 
	gucc__ncş_»q_m­³d_mpoŞ_İs
 = {

135 .
chunk_®loc
 = 
ucc__ncş_»q_m­³d_mpoŞ_chunk_m®loc
,

136 .
	gchunk_»Ëa£
 = 
ucc__ncş_»q_m­³d_mpoŞ_chunk_ä“
,

137 .
	gobj_š™
 = 
ucc__ncş_»q_m­³d_mpoŞ_obj_š™
,

138 .
	gobj_ş—nup
 = 
ucc__ncş_»q_mpoŞ_obj_ş—nup


141 
	$UCC_CLASS_INIT_FUNC
(
ucc__ncş_cÚ‹xt_t
,

142 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

143 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

145 
ucc__ncş_cÚ‹xt_cÚfig_t
 *
_ncş_cÚfig
 =

146 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__ncş_cÚ‹xt_cÚfig_t
);

147 
mem_İs_©Œ
 = 0;

148 
ucc_¡©us_t
 
¡©us
;

150 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__cÚ‹xt_t
, &
_ncş_cÚfig
->
su³r
,

151 
·¿ms
->
cÚ‹xt
);

152 
	`memıy
(&
£lf
->
cfg
, 
_ncş_cÚfig
, (*tl_nccl_config));

153 ià(
£lf
->
cfg
.
sync_ty³
 !ğ
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_EVENT
) {

154 #ià
CUDA_VERSION
 < 12000

155 
CU»suÉ
 
cu_¡
;

156 
CUdeviû
 
cu_dev
;

157 
cu_¡
 = 
	`cuCtxG‘Deviû
(&
cu_dev
);

158 ià(
cu_¡
 =ğ
CUDA_SUCCESS
) {

159 
cu_¡
 = 
	`cuDeviûG‘A‰ribu‹
(&
mem_İs_©Œ
,

160 
CU_DEVICE_ATTRIBUTE_CAN_USE_STREAM_MEM_OPS
,

161 
cu_dev
);

163 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "failedo get cuda device");

166 
mem_İs_©Œ
 = 1;

168 ià(
mem_İs_©Œ
 == 0) {

169 ià(
£lf
->
cfg
.
sync_ty³
 =ğ
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_MEMOPS
) {

170 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "memops‚ot supported");

171  
UCC_ERR_NOT_SUPPORTED
;

173 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "fallbackoƒvent completion sync");

174 
£lf
->
cfg
.
sync_ty³
 = 
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_EVENT
;

176 
£lf
->
cfg
.
sync_ty³
 = 
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_MEMOPS
;

179 
	`ucc_as£¹
(
£lf
->
cfg
.
sync_ty³
 =ğ
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_MEMOPS
 ||

180 
£lf
->
cfg
.
sync_ty³
 =ğ
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_EVENT
);

181 ià(
£lf
->
cfg
.
sync_ty³
 =ğ
UCC_TL_NCCL_COMPLETION_SYNC_TYPE_MEMOPS
) {

182 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "using memops completion sync");

183 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
£lf
->
»q_mp
, 0, (
ucc__ncş_sk_t
), 0,

184 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
,

185 &
ucc__ncş_»q_m­³d_mpoŞ_İs
,

186 
·¿ms
->
th»ad_mode
, "tl_nccl_req_mp");

188 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "usingƒvent completion sync");

189 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
£lf
->
»q_mp
, 0, (
ucc__ncş_sk_t
), 0,

190 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
,

191 &
ucc__ncş_»q_mpoŞ_İs
, 
·¿ms
->
th»ad_mode
,

195 ià(
¡©us
 !ğ
UCC_OK
) {

196 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

198  
¡©us
;

201 
cudaE¼Ü_t
 
cuda_¡
 = 
	`cudaM®loc
(&
£lf
->
sü©ch_buf
, ());

202 ià(
cuda_¡
 !ğ
cudaSucûss
) {

203  
UCC_ERR_NO_MEMORY
;

205 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "initializedl context: %p", self);

206  
UCC_OK
;

207 
	}
}

209 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__ncş_cÚ‹xt_t
)

211 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizingl context: %p", self);

212 
	`ucc_mpoŞ_ş—nup
(&
£lf
->
»q_mp
, 1);

213 
	`cudaF»e
(
£lf
->
sü©ch_buf
);

214 
£lf
->
sü©ch_buf
 = 
NULL
;

215 
	}
}

217 
UCC_CLASS_DEFINE
(
ucc__ncş_cÚ‹xt_t
, 
ucc__cÚ‹xt_t
);

219 
ucc_¡©us_t


220 
	$ucc__ncş_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

221 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

223 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

224  
UCC_OK
;

225 
	}
}

227 
ucc_¡©us_t
 
	$ucc__ncş_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

228 *
memh
, *
_h
)

230  
UCC_ERR_NOT_SUPPORTED
;

231 
	}
}

233 
ucc_¡©us_t
 
	$ucc__ncş_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

234 *
memh
)

236  
UCC_ERR_NOT_SUPPORTED
;

237 
	}
}

239 
ucc_¡©us_t
 
	$ucc__ncş_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

240 
ty³
, *
memh
, **
·ck_bufãr
)

242  
UCC_ERR_NOT_SUPPORTED
;

243 
	}
}

	@src/components/tl/nccl/tl_nccl_lib.c

7 
	~"_ncş.h
"

10 
	$UCC_CLASS_INIT_FUNC
(
ucc__ncş_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

11 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

13 cÚ¡ 
ucc__lib_cÚfig_t
 *
_cÚfig
 =

14 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__lib_cÚfig_t
);

15 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__lib_t
, &
ucc__ncş
.
su³r
, 
_cÚfig
);

16 
	`_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

17  
UCC_OK
;

18 
	}
}

20 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__ncş_lib_t
)

22 
	`_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

23 
	}
}

25 
UCC_CLASS_DEFINE
(
ucc__ncş_lib_t
, 
ucc__lib_t
);

27 
ucc_¡©us_t
 
	$ucc__ncş_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

28 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
)

30 
ucc__lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_tl_lib_attr_t);

31 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

32 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 
UCC_TL_NCCL_SUPPORTED_COLLS
;

33 
©Œ
->
su³r
.
æags
 = 0;

34 
©Œ
->
su³r
.
mš_‹am_size
 = 2;

35 
©Œ
->
su³r
.
max_‹am_size
 = 
UCC_RANK_MAX
;

36 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
) {

37 
©Œ
->
su³r
.
mš_‹am_size
 = 
lib
->min_team_size;

40 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
) {

41 
©Œ
->
su³r
.
max_‹am_size
 = 
UCC_RANK_MAX
;

44  
UCC_OK
;

45 
	}
}

47 
ucc_¡©us_t
 
	$ucc__ncş_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

49 
´İ
->
deçuÉ_‹am_size
 = 2;

50 
´İ
->
mš_‹am_size
 = 2;

51 
´İ
->
max_‹am_size
 = 
UCC_RANK_MAX
;

52  
UCC_OK
;

53 
	}
}

	@src/components/tl/nccl/tl_nccl_team.c

8 
	~"_ncş.h
"

9 
	~"_ncş_cŞl.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"cÜe/ucc_“.h
"

12 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

13 
	~"uts/¬ch/cuda_def.h
"

15 
	$UCC_CLASS_INIT_FUNC
(
ucc__ncş_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
,

16 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

18 
ucc__ncş_cÚ‹xt_t
 *
ùx
 = 
	`ucc_d”ived_of
(
_cÚ‹xt
,

19 
ucc__ncş_cÚ‹xt_t
);

20 
ucc_‹am_oob_cŞl_t
 *
oob
;

21 
ucc_¡©us_t
 
¡©us
;

22 
ucc_¿nk_t
 
size
;

24 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

25 
oob
 = &(
	`UCC_TL_TEAM_OOB
(
£lf
));

26 
size
 = 
	`UCC_TL_TEAM_SIZE
(
£lf
);

27 
£lf
->
¡»am
 = 
NULL
;

28 
£lf
->
ncş_comm
 = 
NULL
;

29 
£lf
->
unique_id
 = 
	`ucc_m®loc
((
ncşUniqueId
è* (
size
 + 1),

31 ià(!
£lf
->
unique_id
) {

32 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

34 (
ncşUniqueId
è* (
size
 + 1));

35  
UCC_ERR_NO_MEMORY
;

38 ià(
	`UCC_TL_TEAM_RANK
(
£lf
) == 0) {

39 
ncşResuÉ_t
 
¡
;

40 
¡
 = 
	`ncşG‘UniqueId
(&
£lf
->
unique_id
[
size
]);

41 ià(
¡
 !ğ
ncşSucûss
) {

42 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo get unique id");

43 
	`mem£t
(&
£lf
->
unique_id
[
size
], 0, (
ncşUniqueId
));

47 
¡©us
 = 
oob
->
	`®lg©h”
(&
£lf
->
unique_id
[
size
],

48 
£lf
->
unique_id
, (
ncşUniqueId
),

49 
oob
->
cŞl_šfo
, &
£lf
->
oob_»q
);

50 ià(
¡©us
 !ğ
UCC_OK
) {

51 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo start oob‡llgather");

52 
ä“_unique_id
;

54 
£lf
->
comm_¡©e
 = 
TL_NCCL_COMM_STATE_OOB
;

56  
UCC_OK
;

58 
ä“_unique_id
:

59 
	`ucc_ä“
(
£lf
->
unique_id
);

60  
¡©us
;

61 
	}
}

63 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__ncş_‹am_t
)

65 
	`_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizingleam: %p", self);

66 
	}
}

68 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__ncş_‹am_t
, 
ucc_ba£_‹am_t
);

69 
UCC_CLASS_DEFINE
(
ucc__ncş_‹am_t
, 
ucc__‹am_t
);

71 
ucc_¡©us_t
 
	$ucc__ncş_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
)

73 
ucc__ncş_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_nccl_team_t);

75 #ià
NCCL_USE_NON_BLOCKING


76 
ncşResuÉ_t
 
ncş_¡©us
, 
¡
;

78 ià(
‹am
->
comm_¡©e
 =ğ
TL_NCCL_COMM_STATE_DESTROY_COMM
) {

79 
check_fš®ize
;

83 ià(
‹am
->
¡»am
) {

84 
	`cudaSŒ—mDe¡roy
(
‹am
->
¡»am
);

85 
‹am
->
¡»am
 = 
NULL
;

87 ià(
‹am
->
ncş_comm
) {

88 ià(
‹am
->
comm_¡©e
 =ğ
TL_NCCL_COMM_STATE_ERROR
) {

89 
	`ncşCommAbÜt
(
‹am
->
ncş_comm
);

91 #ià
NCCL_USE_NON_BLOCKING


92 
	`ncşCommFš®ize
(
‹am
->
ncş_comm
);

93 
check_fš®ize
:

94 
¡
 = 
	`ncşCommG‘AsyncE¼Ü
(
‹am
->
ncş_comm
, &
ncş_¡©us
);

95 ià(
¡
 !ğ
ncşSucûss
 || (
ncş_¡©us
 !=‚cclSuccess)) {

96 
	`_debug
(
_‹am
->
cÚ‹xt
->
lib
, "NCCLƒrror %d %s",

97 
¡
 !ğ
ncşSucûss
 ? sˆ: 
ncş_¡©us
,

98 
	`ncşG‘E¼ÜSŒšg
(
¡
 !ğ
ncşSucûss
 ? sˆ: 
ncş_¡©us
));

99 
	`ncşCommAbÜt
(
‹am
->
ncş_comm
);

100  
UCC_ERR_NO_MESSAGE
;

101 } ià(
ncş_¡©us
 =ğ
ncşInProg»ss
) {

102 
‹am
->
comm_¡©e
 = 
TL_NCCL_COMM_STATE_DESTROY_COMM
;

103  
UCC_INPROGRESS
;

105 
	`ncşCommDe¡roy
(
‹am
->
ncş_comm
);

107 
‹am
->
comm_¡©e
 = 
UCC_OK
;

109 
	`ncşCommDe¡roy
(
‹am
->
ncş_comm
);

114 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc__ncş_‹am_t
)(
_‹am
);

115  
UCC_OK
;

116 
	}
}

118 
ucc_¡©us_t
 
	$ucc__ncş_comm_š™
(
ucc__ncş_‹am_t
 *
‹am
)

120 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

121 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

122 
ucc_¡©us_t
 
¡©us
;

123 
ncşResuÉ_t
 
ncş_¡©us
;

124 #ià
NCCL_USE_NON_BLOCKING


125 
ncşCÚfig_t
 
ncş_cfg
 = 
NCCL_CONFIG_INITIALIZER
;

126 
ncşResuÉ_t
 
async_¡©us
;

129 ià(
‹am
->
comm_¡©e
 =ğ
TL_NCCL_COMM_STATE_READY
) {

130  
UCC_OK
;

131 } ià(
‹am
->
comm_¡©e
 =ğ
TL_NCCL_COMM_STATE_ERROR
) {

132  
UCC_ERR_NOT_SUPPORTED
;

133 } ià(
‹am
->
comm_¡©e
 =ğ
TL_NCCL_COMM_STATE_INIT_COMM
) {

134 #ià
NCCL_USE_NON_BLOCKING


135 
ncş_async_š™
;

137 
	`ucc_as£¹_®ways
(0);

141 
	`CUDA_CHECK_GOTO
(
	`cudaSŒ—mC»©eW™hFÏgs
(&
‹am
->
¡»am
,

142 
cudaSŒ—mNÚBlockšg
),

143 
ex™_”r
, 
¡©us
);

144 #ià
NCCL_USE_NON_BLOCKING


149 
ncş_cfg
.
blockšg
 = (
	`UCC_TL_NCCL_TEAM_CTX
(
‹am
)->
cfg
.
ncş_cfg_blockšg
 ||

150 
	`UCC_TL_NCCL_TEAM_CTX
(
‹am
)->
cfg
.
ncş_Ïzy_š™
) ? 1: 0;

152 
ncş_¡©us
 = 
	`ncşCommIn™RªkCÚfig
(&
‹am
->
ncş_comm
, 
tsize
,

153 
‹am
->
unique_id
[0], 
Œªk
, &
ncş_cfg
);

154 ià((
ncş_¡©us
 !ğ
ncşInProg»ss
è&& (ncş_¡©u !ğ
ncşSucûss
)) {

155 
ncş_comm_š™_”r
;

157 
ncş_async_š™
:

158 
ncş_¡©us
 = 
	`ncşCommG‘AsyncE¼Ü
(
‹am
->
ncş_comm
, &
async_¡©us
);

159 ià(
ncş_¡©us
 !ğ
ncşSucûss
) {

160 
ncş_comm_š™_”r
;

162 ià(
async_¡©us
 =ğ
ncşInProg»ss
) {

163 
‹am
->
comm_¡©e
 = 
TL_NCCL_COMM_STATE_INIT_COMM
;

166 
ncş_¡©us
 = 
	`ncşCommIn™Rªk
(&
‹am
->
ncş_comm
, 
tsize
,—m->
unique_id
[0],

167 
Œªk
);

168 ià(
ncş_¡©us
 !ğ
ncşSucûss
) {

169 
ncş_comm_š™_”r
;

173 
‹am
->
comm_¡©e
 = 
TL_NCCL_COMM_STATE_READY
;

174  
UCC_OK
;

176 
ncş_comm_š™_”r
:

177 
	`_debug
(
‹am
->
su³r
.su³r.
cÚ‹xt
->
lib
, "NCCLƒrror %d %s",

178 
ncş_¡©us
, 
	`ncşG‘E¼ÜSŒšg
(nccl_status));

179 ià(
ncş_¡©us
 =ğ
ncşInv®idU§ge
) {

184 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

186 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

188 
‹am
->
comm_¡©e
 = 
TL_NCCL_COMM_STATE_ERROR
;

190 
ex™_”r
:

191  
¡©us
;

192 
	}
}

194 
ucc_¡©us_t
 
	$ucc__ncş_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
)

196 
ucc__ncş_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_nccl_team_t);

197 
ucc_‹am_oob_cŞl_t
 *
oob
 = &(
	`UCC_TL_TEAM_OOB
(
‹am
));

198 
ncşUniqueId
 
”rÜid
;

199 
ucc_¡©us_t
 
¡©us
;

202 ià(
‹am
->
comm_¡©e
 =ğ
TL_NCCL_COMM_STATE_OOB
) {

203 
¡©us
 = 
oob
->
	`»q_‹¡
(
‹am
->
oob_»q
);

204 ià(
¡©us
 =ğ
UCC_INPROGRESS
) {

205  
UCC_INPROGRESS
;

208 
oob
->
	`»q_ä“
(
‹am
->
oob_»q
);

209 ià(
¡©us
 !ğ
UCC_OK
) {

210 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
, "oob„eqest failed");

211  
¡©us
;

215 
	`mem£t
(&
”rÜid
, 0, (errorid));

216 ià(!
	`memcmp
(&
”rÜid
, 
‹am
->
unique_id
, (errorid))) {

217 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
, "incorrect unique id");

218  
¡©us
;

221 
‹am
->
comm_¡©e
 = 
TL_NCCL_COMM_STATE_INIT_TEAM
;

224 ià(
	`UCC_TL_NCCL_TEAM_CTX
(
‹am
)->
cfg
.
ncş_Ïzy_š™
) {

225  
UCC_OK
;

228  
	`ucc__ncş_comm_š™
(
‹am
);

229 
	}
}

231 
ucc_¡©us_t
 
	$ucc__ncş_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

232 
ucc_ba£_‹am_t
 *
‹am
,

233 
ucc_cŞl_sk_t
 **
sk_h
)

235 
ucc__ncş_sk_t
 *
sk
;

236 
ucc_¡©us_t
 
¡©us
;

238 
¡©us
 = 
	`ucc__ncş_š™_sk
(
cŞl_¬gs
, 
‹am
, &
sk
);

239 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

240  
¡©us
;

243 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
)

245 
UCC_COLL_TYPE_ALLGATHER
:

246 
¡©us
 = 
	`ucc__ncş_®lg©h”_š™
(
sk
);

248 
UCC_COLL_TYPE_ALLGATHERV
:

249 
¡©us
 = 
	`ucc__ncş_®lg©h”v_š™
(
sk
);

251 
UCC_COLL_TYPE_ALLREDUCE
:

252 
¡©us
 = 
	`ucc__ncş_®Ìeduû_š™
(
sk
);

254 
UCC_COLL_TYPE_ALLTOALL
:

255 
¡©us
 = 
	`ucc__ncş_®ÉßÎ_š™
(
sk
);

257 
UCC_COLL_TYPE_ALLTOALLV
:

258 
¡©us
 = 
	`ucc__ncş_®ÉßÎv_š™
(
sk
);

260 
UCC_COLL_TYPE_BCAST
:

261 
¡©us
 = 
	`ucc__ncş_bÿ¡_š™
(
sk
);

263 
UCC_COLL_TYPE_REDUCE_SCATTER
:

264 
¡©us
 = 
	`ucc__ncş_»duû_sÿ‰”_š™
(
sk
);

266 
UCC_COLL_TYPE_REDUCE
:

267 
¡©us
 = 
	`ucc__ncş_»duû_š™
(
sk
);

269 
UCC_COLL_TYPE_BARRIER
:

270 
¡©us
 = 
	`ucc__ncş_b¬r›r_š™
(
sk
);

272 
UCC_COLL_TYPE_GATHER
:

273 
¡©us
 = 
	`ucc__ncş_g©h”_š™
(
sk
);

275 
UCC_COLL_TYPE_GATHERV
:

276 
¡©us
 = 
	`ucc__ncş_g©h”v_š™
(
sk
);

278 
UCC_COLL_TYPE_SCATTER
:

279 
¡©us
 = 
	`ucc__ncş_sÿ‰”_š™
(
sk
);

281 
UCC_COLL_TYPE_SCATTERV
:

282 
¡©us
 = 
	`ucc__ncş_sÿ‰”v_š™
(
sk
);

285 
	`_debug
(
	`UCC_TASK_LIB
(
sk
),

287 
	`ucc_cŞl_ty³_¡r
(
cŞl_¬gs
->
¬gs
.
cŞl_ty³
));

288 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

290 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

291 
ä“_sk
;

293 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "init collask %p",ask);

294 *
sk_h
 = &
sk
->
su³r
;

295  
¡©us
;

297 
ä“_sk
:

298 
	`ucc__ncş_ä“_sk
(
sk
);

299  
¡©us
;

300 
	}
}

302 
ucc_¡©us_t
 
	$ucc__ncş_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

303 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

305 
ucc__ncş_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_nccl_team_t);

306 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_TEAM_CTX
(
‹am
);

307 
ucc_memÜy_ty³_t
 
mts
[2] = {
UCC_MEMORY_TYPE_CUDA
,

308 
UCC_MEMORY_TYPE_CUDA_MANAGED
};

309 
ucc_cŞl_scÜe_t
 *
scÜe
;

310 
ucc_¡©us_t
 
¡©us
;

311 
i
;

312 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

314 
‹am_šfo
.
®g_â
 = 
ucc__ncş_®g_id_to_š™
;

315 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_TL_NCCL_DEFAULT_SCORE
;

316 
‹am_šfo
.
š™
 = 
ucc__ncş_cŞl_š™
;

317 
‹am_šfo
.
num_mem_ty³s
 = 2;

318 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = 
mts
;

319 
‹am_šfo
.
suµÜ‹d_cŞls
 = 
UCC_TL_NCCL_SUPPORTED_COLLS
;

320 
‹am_šfo
.
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

323 
¡©us
 =

324 
	`ucc_cŞl_scÜe_bud_deçuÉ
(
_‹am
, 
UCC_TL_NCCL_DEFAULT_SCORE
,

325 
ucc__ncş_cŞl_š™
, 
UCC_TL_NCCL_SUPPORTED_COLLS
,

326 
mts
, 2, &
scÜe
);

327 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

328  
¡©us
;

331 
i
 = 0; i < 
UCC_TL_NCCL_N_DEFAULT_ALG_SELECT_STR
; i++) {

332 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(

333 
ucc__ncş_deçuÉ_®g_£Ëù_¡r
[
i
], &
‹am_šfo
,

334 &
‹am
->
su³r
.su³r, 
scÜe
);

335 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

336 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
,

338 
ucc__ncş_deçuÉ_®g_£Ëù_¡r
[
i
]);

339 
”r
;

345 
¡©us
 = 
	`ucc_cŞl_scÜe_add_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
,

346 
UCC_MEMORY_TYPE_HOST
, 0, 
UCC_MSG_MAX
, 1,

347 
ucc__ncş_cŞl_š™
, 
_‹am
);

348 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

349  
¡©us
;

352 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

353 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

354 &
‹am
->
su³r
.su³r, 
scÜe
);

356 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

357 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

358 
”r
;

361 *
scÜe_p
 = 
scÜe
;

362  
UCC_OK
;

363 
”r
:

364 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

365  
¡©us
;

366 
	}
}

	@src/components/tl/rccl/allgatherv/allgatherv.c

8 
	~"_rcş.h
"

9 
	~"®lg©h”v.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"cÜe/ucc_“.h
"

13 
ucc_ba£_cŞl_®g_šfo_t


14 
	gucc__rcş_®lg©h”v_®gs
[
UCC_TL_RCCL_ALLGATHERV_ALG_LAST
 + 1] = {

15 [
UCC_TL_RCCL_ALLGATHERV_ALG_P2P
] =

16 {.
id
 = 
UCC_TL_RCCL_ALLGATHERV_ALG_P2P
,

17 .
	gÇme
 = "p2p",

18 .
	gdesc
 = "allgatherv based on„ccl…oint-to-point"},

19 [
UCC_TL_RCCL_ALLGATHERV_ALG_BCOPY
] =

20 {.
id
 = 
UCC_TL_RCCL_ALLGATHERV_ALG_BCOPY
,

21 .
	gÇme
 = "bcopy",

22 .
	gdesc
 = "allgatherv with buffered copy"},

23 [
UCC_TL_RCCL_ALLGATHERV_ALG_BCAST
] =

24 {.
id
 = 
UCC_TL_RCCL_ALLGATHERV_ALG_BCAST
,

25 .
	gÇme
 = "bcast",

26 .
	gdesc
 = "allgatherv based on„ccl bcast"},

27 [
UCC_TL_RCCL_ALLGATHERV_ALG_LAST
] = {

28 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

30 
	#CHECK_INPLACE
(
_¬gs
, 
_‹am
) \

32 ià(
	`UCC_IS_INPLACE
((
_¬gs
))) { \

33 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
((
_‹am
)), \

35 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
; \

36 
out
; \

38 } 0)

	)

40 
	#CHECK_USERDEFINED_DT
(
_¬gs
, 
_‹am
) \

42 ià(!
	`UCC_DT_IS_PREDEFINED
((
_¬gs
).
¤c
.
šfo
.
d©©y³
) || \

43 !
	`UCC_DT_IS_PREDEFINED
((
_¬gs
).
d¡
.
šfo_v
.
d©©y³
)) { \

44 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
((
_‹am
)), \

46 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
; \

47 
out
; \

49 } 0)

	)

51 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”v_p2p_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

53 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

54 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

55 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

56 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

57 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

58 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 :

59 
‹am
->
¡»am
;

60 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

61 *
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

62 *
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

63 
size_t
 
sdt_size
, 
rdt_size
, 
couÁ
, 
di¥l
;

64 
ucc_¿nk_t
 
³”
;

66 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

67 
sdt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

68 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

69 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_allgatherv_start", 0);

70 
	`RCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

71 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

72 ià(
couÁ
 != 0) {

73 
³”
 = 0;…“¸< 
size
;…eer++) {

74 
	`RCCLCHECK_GOTO
(
	`ncşS’d
(
sbuf
, 
couÁ
 * 
sdt_size
, 
ncşCh¬
, 
³”
,

75 
‹am
->
rcş_comm
, 
¡»am
),

76 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

79 
³”
 = 0;…“¸< 
size
;…eer++) {

80 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
³”
);

81 ià(
couÁ
 != 0) {

82 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

83 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
³”
);

84 
	`RCCLCHECK_GOTO
(
	`ncşRecv
(
	`PTR_OFFSET
(
rbuf
, 
di¥l
 * 
rdt_size
),

85 
couÁ
 * 
rdt_size
, 
ncşCh¬
, 
³”
,

86 
‹am
->
rcş_comm
, 
¡»am
),

87 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

90 
	`RCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

91 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

92 
ex™_cŞl
:

93  
¡©us
;

94 
	}
}

96 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”v_p2p_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

97 
ucc_ba£_‹am_t
 * 
‹am
,

98 
ucc_cŞl_sk_t
 ** 
sk_h
)

100 
ucc__rcş_‹am_t
 *
rcş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_rccl_team_t);

101 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
cŞl_¬gs
->args;

102 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

103 
ucc__rcş_sk_t
 *
sk
;

105 
	`CHECK_INPLACE
(*
¬gs
, 
rcş_‹am
);

106 
	`CHECK_USERDEFINED_DT
(*
¬gs
, 
rcş_‹am
);

107 
sk
 = 
	`ucc__rcş_š™_sk
(
cŞl_¬gs
, 
‹am
);

108 ià(!
sk
) {

109  
UCC_ERR_NO_MESSAGE
;

111 
sk
->
su³r
.
po¡
 = 
ucc__rcş_®lg©h”v_p2p_¡¬t
;

112 *
sk_h
 = &
sk
->
su³r
;

113 
out
:

114  
¡©us
;

115 
	}
}

117 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”v_bcİy_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

119 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

120 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

121 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

122 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

123 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

124 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 :

125 
‹am
->
¡»am
;

126 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

127 *
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

128 *
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

129 *
sü©ch
 = 
sk
->
®lg©h”v_bcİy
.sü©ch->
addr
;

130 
size_t
 
max_couÁ
, 
rdt_size
, 
sdt_size
, 
di¥l
, 
scouÁ
, 
rcouÁ
;

131 
ucc_¿nk_t
 
³”
;

133 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

134 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_allgatherv_start", 0);

135 
max_couÁ
 = 
sk
->
®lg©h”v_bcİy
.max_count;

136 
scouÁ
 = 
¬gs
->
¤c
.
šfo
.
couÁ
;

137 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

138 
sdt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

139 ià(
max_couÁ
 * 
rdt_size
 > 
scouÁ
 * 
sdt_size
) {

140 
	`HIPCHECK_GOTO
(
	`hMemıyAsync
(
	`PTR_OFFSET
(
sü©ch
,

141 
max_couÁ
 * 
rdt_size
 * 
size
), 
sbuf
,

142 
scouÁ
 * 
sdt_size
,

143 
hMemıyDeviûToDeviû
, 
¡»am
),

144 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

145 
sbuf
 = 
	`PTR_OFFSET
(
sü©ch
, 
max_couÁ
 * 
rdt_size
 * 
size
);

147 
	`RCCLCHECK_GOTO
(
	`ncşAÎG©h”
(
sbuf
, 
sü©ch
, 
max_couÁ
 * 
rdt_size
,

148 
ncşCh¬
, 
‹am
->
rcş_comm
, 
¡»am
),

149 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

150 
³”
 = 0;…“¸< 
size
;…eer++) {

151 
rcouÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,

152 
¬gs
->
d¡
.
šfo_v
.
couÁs
, 
³”
);

153 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

154 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

155 
³”
);

156 
	`HIPCHECK_GOTO
(
	`hMemıyAsync
(
	`PTR_OFFSET
(
rbuf
, 
di¥l
 * 
rdt_size
),

157 
	`PTR_OFFSET
(
sü©ch
,

158 
³”
 * 
max_couÁ
 * 
rdt_size
),

159 
rcouÁ
 * 
rdt_size
,

160 
hMemıyDeviûToDeviû
, 
¡»am
),

161 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

163 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

164 
ex™_cŞl
:

165  
¡©us
;

166 
	}
}

168 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”v_bcİy_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

170 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

172 
	`ucc_mc_ä“
(
sk
->
®lg©h”v_bcİy
.
sü©ch
);

173  
	`ucc__rcş_cŞl_fš®ize
(
cŞl_sk
);

174 
	}
}

176 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”v_bcİy_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

177 
ucc_ba£_‹am_t
 * 
‹am
,

178 
ucc_cŞl_sk_t
 ** 
sk_h
)

180 
ucc__rcş_‹am_t
 *
rcş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_rccl_team_t);

181 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
cŞl_¬gs
->args;

182 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

183 
ucc__rcş_sk_t
 *
sk
;

184 
size_t
 
max_couÁ
, 
sdt_size
, 
rdt_size
;

185 
ucc_¿nk_t
 
³”
;

187 
	`CHECK_INPLACE
(*
¬gs
, 
rcş_‹am
);

188 
	`CHECK_USERDEFINED_DT
(*
¬gs
, 
rcş_‹am
);

189 
sk
 = 
	`ucc__rcş_š™_sk
(
cŞl_¬gs
, 
‹am
);

190 ià(
	`ucc_uÆik–y
(!
sk
)) {

191  
UCC_ERR_NO_MESSAGE
;

194 
sdt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

195 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

196 
max_couÁ
 = 
	`ucc_cŞl_¬gs_g‘_max_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
	`UCC_TL_TEAM_SIZE
(
rcş_‹am
));

197 
³”
 = 1;…“¸< 
‹am
->
·¿ms
.
size
;…eer++) {

198 
max_couÁ
 = 
	`ucc_max
(
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,

199 
¬gs
->
d¡
.
šfo_v
.
couÁs
, 
³”
), 
max_couÁ
);

201 
sk
->
®lg©h”v_bcİy
.
max_couÁ
 = max_count;

202 ià(
max_couÁ
 * 
rdt_size
 > 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
sdt_size
) {

203 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
®lg©h”v_bcİy
.
sü©ch
,

204 (
‹am
->
·¿ms
.
size
 + 1è* 
max_couÁ
 *

205 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
),

206 
UCC_MEMORY_TYPE_ROCM
);

209 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
®lg©h”v_bcİy
.
sü©ch
, 
max_couÁ
 *

210 
‹am
->
·¿ms
.
size
 *

211 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
),

212 
UCC_MEMORY_TYPE_ROCM
);

214 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

215 
	`ucc__rcş_ä“_sk
(
sk
);

216  
¡©us
;

218 
sk
->
su³r
.
po¡
 = 
ucc__rcş_®lg©h”v_bcİy_¡¬t
;

219 
sk
->
su³r
.
fš®ize
 = 
ucc__rcş_®lg©h”v_bcİy_fš®ize
;

220 *
sk_h
 = &
sk
->
su³r
;

221 
out
:

222  
¡©us
;

223 
	}
}

225 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”v_bÿ¡_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

227 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

228 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

229 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

230 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

231 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

232 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 :

233 
‹am
->
¡»am
;

234 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

235 *
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

236 
±rdiff_t
 
rbuf
 = (±rdiff_t)
¬gs
->
d¡
.
šfo_v
.
bufãr
;

237 
size_t
 
rdt_size
, 
couÁ
, 
di¥l
;

238 
ucc_¿nk_t
 
³”
;

240 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

241 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

242 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_allgatherv_start", 0);

243 
	`RCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

244 
³”
 = 0;…“¸< 
size
;…eer++) {

245 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
³”
);

246 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

247 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

248 
³”
);

249 
	`RCCLCHECK_GOTO
(
	`ncşBrßdÿ¡
(
sbuf
, 
	`PTR_OFFSET
(
rbuf
, 
di¥l
 * 
rdt_size
),

250 
couÁ
 * 
rdt_size
, 
ncşCh¬
, 
³”
,

251 
‹am
->
rcş_comm
, 
¡»am
),

252 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

254 
	`RCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

255 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

256 
ex™_cŞl
:

257  
¡©us
;

258 
	}
}

260 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”v_bÿ¡_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

261 
ucc_ba£_‹am_t
 * 
‹am
,

262 
ucc_cŞl_sk_t
 ** 
sk_h
)

264 
ucc__rcş_‹am_t
 *
rcş_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_rccl_team_t);

265 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
cŞl_¬gs
->args;

266 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

267 
ucc__rcş_sk_t
 *
sk
;

269 
	`CHECK_INPLACE
(*
¬gs
, 
rcş_‹am
);

270 
	`CHECK_USERDEFINED_DT
(*
¬gs
, 
rcş_‹am
);

271 
sk
 = 
	`ucc__rcş_š™_sk
(
cŞl_¬gs
, 
‹am
);

272 ià(
	`ucc_uÆik–y
(!
sk
)) {

273  
UCC_ERR_NO_MESSAGE
;

275 
sk
->
su³r
.
po¡
 = 
ucc__rcş_®lg©h”v_bÿ¡_¡¬t
;

276 *
sk_h
 = &
sk
->
su³r
;

277 
out
:

278  
¡©us
;

279 
	}
}

	@src/components/tl/rccl/allgatherv/allgatherv.h

8 #iâdeà
RCCL_ALLGATHERV_H_


9 
	#RCCL_ALLGATHERV_H_


	)

11 
	~"_rcş_cŞl.h
"

14 
	mUCC_TL_RCCL_ALLGATHERV_ALG_P2P
,

15 
	mUCC_TL_RCCL_ALLGATHERV_ALG_BCOPY
,

16 
	mUCC_TL_RCCL_ALLGATHERV_ALG_BCAST
,

17 
	mUCC_TL_RCCL_ALLGATHERV_ALG_LAST


20 
	#UCC_TL_RCCL_ALLGATHERV_DEFAULT_ALG_SELECT_STR
 \

21 "®lg©h”v:rocm:0-16k:@0#®lg©h”v:rocm:16k-1M:@1#®lg©h”v:rocm:1M-šf:@2"

	)

23 
ucc_ba£_cŞl_®g_šfo_t


24 
ucc__rcş_®lg©h”v_®gs
[
UCC_TL_RCCL_ALLGATHERV_ALG_LAST
 + 1];

26 
ucc_¡©us_t
 
ucc__rcş_®lg©h”v_p2p_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

28 
ucc_¡©us_t
 
ucc__rcş_®lg©h”v_p2p_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

29 
ucc_ba£_‹am_t
 * 
‹am
,

30 
ucc_cŞl_sk_t
 ** 
sk_h
);

32 
ucc_¡©us_t
 
ucc__rcş_®lg©h”v_bcİy_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

34 
ucc_¡©us_t
 
ucc__rcş_®lg©h”v_bcİy_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

35 
ucc_ba£_‹am_t
 * 
‹am
,

36 
ucc_cŞl_sk_t
 ** 
sk_h
);

38 
ucc_¡©us_t
 
ucc__rcş_®lg©h”v_bÿ¡_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

40 
ucc_¡©us_t
 
ucc__rcş_®lg©h”v_bÿ¡_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

41 
ucc_ba£_‹am_t
 * 
‹am
,

42 
ucc_cŞl_sk_t
 ** 
sk_h
);

44 
šlše
 
	$ucc__rcş_®lg©h”v_®g_äom_¡r
(cÚ¡ *
¡r
)

46 
i
;

47 
i
 = 0; i < 
UCC_TL_RCCL_ALLGATHERV_ALG_LAST
; i++) {

48 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__rcş_®lg©h”v_®gs
[
i
].
Çme
)) {

52  
i
;

53 
	}
}

	@src/components/tl/rccl/tl_rccl.c

8 
	~"_rcş.h
"

9 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

10 
	~"®lg©h”v/®lg©h”v.h
"

12 
ucc_¡©us_t
 
ucc__rcş_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

13 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
);

15 
ucc_¡©us_t
 
ucc__rcş_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

17 
ucc_¡©us_t
 
ucc__rcş_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

18 
ucc_ba£_ùx_©Œ_t
 *
ba£_©Œ
);

20 
ucc_¡©us_t
 
ucc__rcş_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

21 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
);

23 
ucc_¡©us_t
 
ucc__rcş_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

24 
ucc_mem_m­__t
 *
_h
);

26 
ucc_¡©us_t
 
ucc__rcş_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

27 
ucc_mem_m­_mode_t
 
mode
, 
ucc_mem_m­__t
 *
_h
, **
·ck_bufãr
);

29 
ucc_cÚfig_f›ld_t
 
	gucc__rcş_lib_cÚfig_bË
[] = {

30 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__rcş_lib_cÚfig_t
, 
su³r
),

31 
UCC_CONFIG_TYPE_TABLE
(
ucc__lib_cÚfig_bË
)},

33 {
NULL
}};

35 cÚ¡ * 
	gucc__rcş_com¶‘iÚ_sync_Çmes
[] = {

36 [
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_EVENT
] = "event",

37 [
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_MEMOPS
] = "driver",

38 [
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_AUTO
] = "auto",

39 [
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_LAST
] = 
NULL


42 
ucs_cÚfig_f›ld_t
 
	gucc__rcş_cÚ‹xt_cÚfig_bË
[] = {

43 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__rcş_cÚ‹xt_cÚfig_t
, 
su³r
),

44 
UCC_CONFIG_TYPE_TABLE
(
ucc__cÚ‹xt_cÚfig_bË
)},

48 
ucs_off£tof
(
ucc__rcş_cÚ‹xt_cÚfig_t
, 
sync_ty³
),

49 
UCS_CONFIG_TYPE_ENUM
(
ucc__rcş_com¶‘iÚ_sync_Çmes
)

52 {
NULL
}};

54 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__rcş_lib_t
, 
ucc_ba£_lib_t
,

55 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

56 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

58 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__rcş_lib_t
, 
ucc_ba£_lib_t
);

60 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__rcş_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

61 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

62 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

64 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__rcş_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

66 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__rcş_‹am_t
, 
ucc_ba£_‹am_t
,

67 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

69 
ucc_¡©us_t
 
ucc__rcş_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
);

71 
ucc_¡©us_t
 
ucc__rcş_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
);

73 
ucc_¡©us_t
 
ucc__rcş_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

74 
ucc_ba£_‹am_t
 *
‹am
,

75 
ucc_cŞl_sk_t
 **
sk
);

77 
ucc_¡©us_t
 
ucc__rcş_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

78 
ucc_cŞl_scÜe_t
 **
scÜe_p
);

79 
UCC_TL_IFACE_DECLARE
(
rcş
, 
RCCL
);

81 
__©Œibu‹__
((
cÚ¡ruùÜ
)è
	$_rcş_içû_š™
()

83 
ucc__rcş
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLGATHERV
)] =

84 
ucc__rcş_®lg©h”v_®gs
;

85 
	}
}

	@src/components/tl/rccl/tl_rccl.h

9 #iâdeà
UCC_TL_RCCL_H_


10 
	#UCC_TL_RCCL_H_


	)

12 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

13 
	~"compÚ’ts//ucc_.h
"

14 
	~"compÚ’ts//ucc__log.h
"

15 
	~"uts/ucc_mpoŞ.h
"

17 
	~<h/h_ruÁime.h
>

19 #´agm¨
GCC
 
dŸgno¡ic
 
push


20 #ià
defšed
(
__şªg__
)

21 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wunknown-warning-option"

23 
	~<h/h_å16.h
>

24 #´agm¨
GCC
 
dŸgno¡ic
 
pİ


26 #ifdeà
RCCL_OLD_HEADERS


27 
	~<rcş.h
>

29 
	~<rcş/rcş.h
>

32 #iâdeà
UCC_TL_RCCL_DEFAULT_SCORE


33 
	#UCC_TL_RCCL_DEFAULT_SCORE
 20

	)

36 #ifdeà
HAVE_PROFILING_TL_RCCL


37 
	~"uts/´ofe/ucc_´ofe.h
"

39 
	~"uts/´ofe/ucc_´ofe_off.h
"

42 
	#UCC_TL_RCCL_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

43 
	#UCC_TL_RCCL_PROFILE_FUNC_VOID
 
UCC_PROFILE_FUNC_VOID


	)

44 
	#UCC_TL_RCCL_PROFILE_REQUEST_NEW
 
UCC_PROFILE_REQUEST_NEW


	)

45 
	#UCC_TL_RCCL_PROFILE_REQUEST_EVENT
 
UCC_PROFILE_REQUEST_EVENT


	)

46 
	#UCC_TL_RCCL_PROFILE_REQUEST_FREE
 
UCC_PROFILE_REQUEST_FREE


	)

48 
	succ__rcş_içû
 {

49 
ucc__içû_t
 
	msu³r
;

50 } 
	tucc__rcş_içû_t
;

52 
ucc__rcş_içû_t
 
ucc__rcş
;

54 
	succ__rcş_lib_cÚfig
 {

55 
ucc__lib_cÚfig_t
 
	msu³r
;

56 } 
	tucc__rcş_lib_cÚfig_t
;

58 
	eucc__rcş_com¶‘iÚ_sync_ty³
 {

59 
	mUCC_TL_RCCL_COMPLETION_SYNC_TYPE_EVENT
,

60 
	mUCC_TL_RCCL_COMPLETION_SYNC_TYPE_MEMOPS
,

61 
	mUCC_TL_RCCL_COMPLETION_SYNC_TYPE_AUTO
,

62 
	mUCC_TL_RCCL_COMPLETION_SYNC_TYPE_LAST


63 } 
	tucc__rcş_com¶‘iÚ_sync_ty³_t
;

65 
	succ__rcş_cÚ‹xt_cÚfig
 {

66 
ucc__cÚ‹xt_cÚfig_t
 
	msu³r
;

67 
ucc__rcş_com¶‘iÚ_sync_ty³_t
 
	msync_ty³
;

68 } 
	tucc__rcş_cÚ‹xt_cÚfig_t
;

70 
	succ__rcş_lib
 {

71 
ucc__lib_t
 
	msu³r
;

72 } 
	tucc__rcş_lib_t
;

73 
UCC_CLASS_DECLARE
(
ucc__rcş_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

74 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

76 
	succ__rcş_cÚ‹xt
 {

77 
ucc__cÚ‹xt_t
 
	msu³r
;

78 
ucc__rcş_cÚ‹xt_cÚfig_t
 
	mcfg
;

79 
ucc_mpoŞ_t
 
	m»q_mp
;

80 *
	msü©ch_buf
;

81 } 
	tucc__rcş_cÚ‹xt_t
;

82 
UCC_CLASS_DECLARE
(
ucc__rcş_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

83 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

85 
	succ__rcş_‹am
 {

86 
ucc__‹am_t
 
	msu³r
;

87 
ncşUniqueId
 *
	munique_id
;

88 *
	moob_»q
;

89 
ncşComm_t
 
	mrcş_comm
;

90 
hSŒ—m_t
 
	m¡»am
;

91 } 
	tucc__rcş_‹am_t
;

93 
	succ__rcş_sk
 {

94 
ucc_cŞl_sk_t
 
	msu³r
;

95 
ucc_¡©us_t
 
	mho¡_¡©us
;

96 
ucc_¡©us_t
 *
	mdev_¡©us
;

97 *
	mcom¶‘ed
;

100 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch
;

101 
size_t
 
	mmax_couÁ
;

102 } 
	m®lg©h”v_bcİy
;

104 } 
	tucc__rcş_sk_t
;

106 
	#TASK_TEAM
(
_sk
) \

107 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
, 
ucc__rcş_‹am_t
))

	)

108 
	#TASK_CTX
(
_sk
) \

109 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
, 
ucc__rcş_cÚ‹xt_t
))

	)

110 
	#TASK_LIB
(
_sk
) \

111 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
->
lib
, 
ucc__rcş_lib_t
))

	)

112 
	#TASK_ARGS
(
_sk
è(_sk)->
su³r
.
b¬gs
.
¬gs


	)

114 
	#UCC_TL_RCCL_SUPPORTED_COLLS
 \

115 (
UCC_COLL_TYPE_ALLTOALL
 | 
UCC_COLL_TYPE_ALLTOALLV
 | \

116 
UCC_COLL_TYPE_ALLGATHER
 | 
UCC_COLL_TYPE_ALLGATHERV
 | \

117 
UCC_COLL_TYPE_ALLREDUCE
 | 
UCC_COLL_TYPE_BCAST
 | \

118 
UCC_COLL_TYPE_REDUCE_SCATTER
 | 
UCC_COLL_TYPE_REDUCE
 | \

119 
UCC_COLL_TYPE_BARRIER
 | 
UCC_COLL_TYPE_GATHER
 | \

120 
UCC_COLL_TYPE_GATHERV
 | 
UCC_COLL_TYPE_SCATTER
 | \

121 
UCC_COLL_TYPE_SCATTERV
)

	)

123 
UCC_CLASS_DECLARE
(
ucc__rcş_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

124 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

126 
	#RCCLCHECK_GOTO
(
_cmd
, 
_Ïb–
, 
_¡©us
, 
_lib
) \

128 
ncşResuÉ_t
 
e
 = 
_cmd
; \

129 ià(
ncşSucûss
 !ğ
e
) { \

130 
	`_”rÜ
(
_lib
, "RCCLƒ¼Ü %d %s", 
e
, 
	`ncşG‘E¼ÜSŒšg
(e)); \

131 
_¡©us
 = 
UCC_ERR_NO_MESSAGE
; \

132 
_Ïb–
; \

134 } 0)

	)

136 
	#HIPCHECK_GOTO
(
_cmd
, 
_Ïb–
, 
_¡©us
, 
_lib
) \

138 
hE¼Ü_t
 
e
 = 
_cmd
; \

139 ià(
hSucûss
 !ğ
e
) { \

140 
	`_”rÜ
(
_lib
, "HIPƒ¼Ü %d %s", 
e
, 
	`hG‘E¼ÜName
(e)); \

141 
_¡©us
 = 
UCC_ERR_NO_MESSAGE
; \

142 
_Ïb–
; \

144 } 0)

	)

146 
	#UCC_TL_RCCL_TEAM_LIB
(
_‹am
) \

147 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
->
lib
, 
ucc__rcş_lib_t
))

	)

	@src/components/tl/rccl/tl_rccl_coll.c

9 
	~"_rcş_cŞl.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"compÚ’ts/ec/ucc_ec.h
"

12 
	~"cÜe/ucc_“.h
"

13 
	~"uts/ucc_comp”_def.h
"

14 
	~"uts/ucc_m©h.h
"

15 
	~"uts/ucc_cŞl_uts.h
"

16 
	~"®lg©h”v/®lg©h”v.h
"

18 
	#ncşOpUnsuµÜ‹d
 (
ncşNumOps
 + 1)

	)

19 
	#ncşD©aTy³UnsuµÜ‹d
 (
ncşNumTy³s
 + 1)

	)

21 
ncşD©aTy³_t
 
	gucc_to_rcş_dty³
[] = {

22 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT8
)] = (
ncşD©aTy³_t
)
ncşIÁ8
,

23 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT16
)] = (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

24 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT32
)] = (
ncşD©aTy³_t
)
ncşIÁ32
,

25 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT64
)] = (
ncşD©aTy³_t
)
ncşIÁ64
,

26 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT128
)] = (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

27 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT8
)] = (
ncşD©aTy³_t
)
ncşUšt8
,

28 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT16
)] = (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

29 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT32
)] = (
ncşD©aTy³_t
)
ncşUšt32
,

30 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT64
)] = (
ncşD©aTy³_t
)
ncşUšt64
,

31 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT128
)] = (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

32 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT16
)] = (
ncşD©aTy³_t
)
ncşFlßt16
,

33 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT32
)] = (
ncşD©aTy³_t
)
ncşFlßt32
,

34 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT64
)] = (
ncşD©aTy³_t
)
ncşFlßt64
,

35 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT128
)] = (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

36 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT32_COMPLEX
)] =

37 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

38 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT64_COMPLEX
)] =

39 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

40 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT128_COMPLEX
)] =

41 (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

42 #ià
NCCL_VERSION_CODE
 >ğ
NCCL_VERSION
(2,10,3)

43 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_BFLOAT16
)] = (
ncşD©aTy³_t
)
ncşBæßt16
,

45 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_BFLOAT16
)] = (
ncşD©aTy³_t
)
ncşD©aTy³UnsuµÜ‹d
,

49 
ncşRedOp_t
 
	gucc_to_rcş_»duû_İ
[] = {

50 [
UCC_OP_SUM
] = (
ncşRedOp_t
)
ncşSum
,

51 [
UCC_OP_PROD
] = (
ncşRedOp_t
)
ncşProd
,

52 [
UCC_OP_MAX
] = (
ncşRedOp_t
)
ncşMax
,

53 [
UCC_OP_MIN
] = (
ncşRedOp_t
)
ncşMš
,

54 #ià
NCCL_VERSION_CODE
 < 
NCCL_VERSION
(2,10,3)

55 [
UCC_OP_AVG
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

57 [
UCC_OP_AVG
] = (
ncşRedOp_t
)
ncşAvg
,

59 [
UCC_OP_LAND
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

60 [
UCC_OP_LOR
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

61 [
UCC_OP_LXOR
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

62 [
UCC_OP_BAND
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

63 [
UCC_OP_BOR
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

64 [
UCC_OP_BXOR
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

65 [
UCC_OP_MAXLOC
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

66 [
UCC_OP_MINLOC
] = (
ncşRedOp_t
)
ncşOpUnsuµÜ‹d
,

70 *
	gucc__rcş_deçuÉ_®g_£Ëù_¡r
[
UCC_TL_RCCL_N_DEFAULT_ALG_SELECT_STR
] = {

71 
UCC_TL_RCCL_ALLGATHERV_DEFAULT_ALG_SELECT_STR
};

73 
šlše
 
ucc_¡©us_t
 
	$ucc_rcş_check_dt_suµÜ‹d
(
ucc_d©©y³_t
 
dt1
,

74 
ucc_d©©y³_t
 
dt2
)

76 ià(
	`ucc_uÆik–y
((
dt1
 !ğ
dt2
è|| !
	`UCC_DT_IS_PREDEFINED
(dt1) ||

77 (
ucc_to_rcş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
dt1
)]

78 =ğ
ncşD©aTy³UnsuµÜ‹d
))) {

79  
UCC_ERR_NOT_SUPPORTED
;

81  
UCC_OK
;

82 
	}
}

84 
ucc__rcş_sk_t
 * 
	$ucc__rcş_š™_sk
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

85 
ucc_ba£_‹am_t
 *
‹am
)

87 
ucc__rcş_cÚ‹xt_t
 *
rcş_ùx
 = 
	`ucc_d”ived_of
(
‹am
->
cÚ‹xt
,

88 
ucc__rcş_cÚ‹xt_t
);

89 
ucc__rcş_sk_t
 *
sk
;

90 
ucc_¡©us_t
 
¡©us
;

91 
ucc_cŞl_´og»ss_â_t
 
´og»ss_â
;

93 
sk
 = 
	`ucc_mpoŞ_g‘
(&
rcş_ùx
->
»q_mp
);

94 ià(
	`ucc_uÆik–y
(!
sk
)) {

95 
	`_”rÜ
(
‹am
->
cÚ‹xt
->
lib
,"Failedo‡llocateask");

96  
NULL
;

98 
´og»ss_â
 = 
sk
->
su³r
.
´og»ss
;

100 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, 
cŞl_¬gs
, 
‹am
);

101 
	`UCC_TL_RCCL_PROFILE_REQUEST_NEW
(
sk
, "tl_rccl_task", 0);

102 
sk
->
su³r
.
fš®ize
 = 
ucc__rcş_cŞl_fš®ize
;

103 
sk
->
su³r
.
Œigg”ed_po¡
 = 
ucc__rcş_Œigg”ed_po¡
;

104 
sk
->
su³r
.
´og»ss
 = 
´og»ss_â
;

105 
sk
->
com¶‘ed
 = 
NULL
;

106 ià(
rcş_ùx
->
cfg
.
sync_ty³
 =ğ
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_EVENT
) {

107 
¡©us
 = 
	`ucc_ec_ü—‹_ev’t
(&
sk
->
com¶‘ed
, 
UCC_EE_ROCM_STREAM
);

108 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

109 
	`ucc_mpoŞ_put
(
sk
);

110  
NULL
;

113  
sk
;

114 
	}
}

116 
	$ucc__rcş_ä“_sk
(
ucc__rcş_sk_t
 *
sk
)

118 
	`UCC_TL_RCCL_PROFILE_REQUEST_FREE
(
sk
);

119 ià(
sk
->
com¶‘ed
) {

120 
	`ucc_ec_de¡roy_ev’t
(
sk
->
com¶‘ed
, 
UCC_EE_ROCM_STREAM
);

122 
	`ucc_mpoŞ_put
(
sk
);

123 
	}
}

125 
ucc_¡©us_t
 
	$ucc__rcş_Œigg”ed_po¡
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
,

126 
ucc_cŞl_sk_t
 *
cŞl_sk
)

128 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

129 
ucc_¡©us_t
 
¡©us
;

130 
ucc_ev_t
 *
po¡_ev’t
;

132 
	`ucc_as£¹
(
“
->
“_ty³
 =ğ
UCC_EE_ROCM_STREAM
);

133 
cŞl_sk
->
“
 =ƒe;

134 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "Œigg”ed…o¡.ask:%p", 
cŞl_sk
);

136 
¡©us
 = 
cŞl_sk
->
	`po¡
(coll_task);

137 ià(
	`ucc_lik–y
(
¡©us
 =ğ
UCC_OK
)) {

139 
po¡_ev’t
 = 
	`ucc_m®loc
((
ucc_ev_t
), "event");

140 ià(
	`ucc_uÆik–y
(
po¡_ev’t
 =ğ
NULL
)) {

141 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo‡llocate memory forƒvent");

142  
UCC_ERR_NO_MEMORY
;

145 
po¡_ev’t
->
ev_ty³
 = 
UCC_EVENT_COLLECTIVE_POST
;

146 
po¡_ev’t
->
ev_cÚ‹xt_size
 = 0;

147 
po¡_ev’t
->
»q
 = &
cŞl_sk
->
su³r
;

148 
	`ucc_“_£t_ev’t_š‹º®
(
cŞl_sk
->
“
, 
po¡_ev’t
,

149 &
cŞl_sk
->
“
->
ev’t_out_queue
);

151  
¡©us
;

152 
	}
}

154 
ucc_¡©us_t
 
	$ucc__rcş_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

156 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

157 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
 ;

159 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "finalizing collask %p",ask);

160 
	`ucc__rcş_ä“_sk
(
sk
);

161  
¡©us
;

162 
	}
}

164 
ucc_¡©us_t
 
	$ucc__rcş_cŞËùive_sync
(
ucc__rcş_sk_t
 *
sk
,

165 
hSŒ—m_t
 
¡»am
)

167 
ucc__rcş_cÚ‹xt_t
 *
ùx
 = 
	`TASK_CTX
(
sk
);

168 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

170 
sk
->
ho¡_¡©us
 =ask->
su³r
.su³r.
¡©us
;

171 ià(
ùx
->
cfg
.
sync_ty³
 !ğ
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_EVENT
) {

172 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "RCCL only supports stream synchronizationƒvents");

173  
UCC_ERR_NOT_SUPPORTED
;

176 
¡©us
 = 
	`ucc_ec_ev’t_po¡
(
¡»am
, 
sk
->
com¶‘ed
,

177 
UCC_EE_ROCM_STREAM
);

178 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

179  
¡©us
;

182  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
	`TASK_TEAM
(
sk
))->
pq
,

183 &
sk
->
su³r
);

184 
	}
}

186 
ucc_¡©us_t
 
	$ucc__rcş_®ÉßÎ_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

188 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

189 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

190 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

191 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

192 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

193 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

194 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

195 
±rdiff_t
 
sbuf
 = (±rdiff_t)
¬gs
->
¤c
.
šfo
.
bufãr
;

196 
±rdiff_t
 
rbuf
 = (±rdiff_t)
¬gs
->
d¡
.
šfo
.
bufãr
;

197 
size_t
 
d©a_size
;

198 
ucc_¿nk_t
 
³”
;

199 
ncşD©aTy³_t
 
dt
;

201 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

202 
d©a_size
 = (
size_t
)(
¬gs
->
¤c
.
šfo
.
couÁ
 / 
gsize
) *

203 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

204 
	`ucc_as£¹
(
¬gs
->
¤c
.
šfo
.
couÁ
 % 
gsize
 == 0);

205 ià(
d©a_size
 == 0) {

206 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_OK
;

207  
UCC_OK
;

209 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_alltoall_start", 0);

210 ià(
¬gs
->
¤c
.
šfo
.
d©©y³
 =ğ¬gs->
d¡
.info.datatype) {

211 
dt
 = 
ucc_to_rcş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)];

212 
	`RCCLCHECK_GOTO
(
	`ncşAÎToAÎ
((*)
sbuf
, (*)
rbuf
,

213 (
size_t
)(
¬gs
->
¤c
.
šfo
.
couÁ
 / 
gsize
),

214 
dt
, 
‹am
->
rcş_comm
, 
¡»am
),

215 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

217 
	`RCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

218 
³”
 = 0;…“¸< 
gsize
;…eer++) {

219 
	`RCCLCHECK_GOTO
(
	`ncşS’d
((*)(
sbuf
 + 
³”
 * 
d©a_size
), data_size,

220 
ncşCh¬
, 
³”
, 
‹am
->
rcş_comm
, 
¡»am
),

221 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

222 
	`RCCLCHECK_GOTO
(
	`ncşRecv
((*)(
rbuf
 + 
³”
 * 
d©a_size
), data_size,

223 
ncşCh¬
, 
³”
, 
‹am
->
rcş_comm
, 
¡»am
),

224 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

226 
	`RCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

228 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

229 
ex™_cŞl
:

230  
¡©us
;

231 
	}
}

233 
ucc_¡©us_t
 
	$ucc__rcş_®ÉßÎ_š™
(
ucc__rcş_sk_t
 *
sk
)

235 
ucc_d©©y³_t
 
dt1
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
;

236 
ucc_d©©y³_t
 
dt2
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

238 ià(
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

239 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "inplace‡lltoall is‚ot supported");

240  
UCC_ERR_NOT_SUPPORTED
;

242 ià(
UCC_OK
 !ğ
	`ucc_rcş_check_dt_suµÜ‹d
(
dt1
, 
dt2
)) {

243 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

244  
UCC_ERR_NOT_SUPPORTED
;

247 
sk
->
su³r
.
po¡
 = 
ucc__rcş_®ÉßÎ_¡¬t
;

248  
UCC_OK
;

249 
	}
}

251 
ucc_¡©us_t
 
	$ucc__rcş_®ÉßÎv_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

253 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

254 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

255 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

256 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

257 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

258 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

259 
±rdiff_t
 
sbuf
 = (±rdiff_t)
¬gs
->
¤c
.
šfo_v
.
bufãr
;

260 
±rdiff_t
 
rbuf
 = (±rdiff_t)
¬gs
->
d¡
.
šfo_v
.
bufãr
;

261 
size_t
 
sdt_size
, 
rdt_size
, 
couÁ
, 
di¥l
;

262 
ucc_¿nk_t
 
³”
;

264 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

265 
sdt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
);

266 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

267 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_alltoallv_start", 0);

268 
	`RCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

269 
³”
 = 0;…“¸< 
	`UCC_TL_TEAM_SIZE
(
‹am
);…eer++) {

270 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
, 
³”
);

271 ià(
couÁ
 != 0) {

272 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

273 
¬gs
,‡rgs->
¤c
.
šfo_v
.
di¥Ïûm’ts
, 
³”
);

274 
	`RCCLCHECK_GOTO
(
	`ncşS’d
((*)(
sbuf
 + 
di¥l
 * 
sdt_size
),

275 
couÁ
 * 
sdt_size
, 
ncşCh¬
, 
³”
,

276 
‹am
->
rcş_comm
, 
¡»am
),

277 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

279 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
³”
);

280 ià(
couÁ
 != 0) {

281 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

282 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
³”
);

283 
	`RCCLCHECK_GOTO
(
	`ncşRecv
((*)(
rbuf
 + 
di¥l
 * 
rdt_size
),

284 
couÁ
 * 
rdt_size
, 
ncşCh¬
, 
³”
,

285 
‹am
->
rcş_comm
, 
¡»am
),

286 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

289 
	`RCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

290 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

291 
ex™_cŞl
:

292  
¡©us
;

293 
	}
}

295 
ucc_¡©us_t
 
	$ucc__rcş_®ÉßÎv_š™
(
ucc__rcş_sk_t
 *
sk
)

297 
ucc_d©©y³_t
 
dt1
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
d©©y³
;

298 
ucc_d©©y³_t
 
dt2
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
d©©y³
;

300 ià(
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

301 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "inplace‡lltoallv is‚ot supported");

302  
UCC_ERR_NOT_SUPPORTED
;

304 ià(
UCC_OK
 !ğ
	`ucc_rcş_check_dt_suµÜ‹d
(
dt1
, 
dt2
)) {

305 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

306  
UCC_ERR_NOT_SUPPORTED
;

308 
sk
->
su³r
.
po¡
 = 
ucc__rcş_®ÉßÎv_¡¬t
;

309  
UCC_OK
;

310 
	}
}

312 
ucc_¡©us_t
 
	$ucc__rcş_®Ìeduû_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

314 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

315 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

316 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

317 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

318 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

319 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

320 *
¤c
 =

321 
	`UCC_IS_INPLACE
(*
¬gs
è?‡rgs->
d¡
.
šfo
.
bufãr
 :‡rgs->
¤c
.info.buffer;

322 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

323 
ncşRedOp_t
 
İ
 = 
ucc_to_rcş_»duû_İ
[
¬gs
->op];

324 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

325 
ncşD©aTy³_t
 
dt
;

327 
dt
 = 
ucc_to_rcş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)];

328 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

329 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
,

330 
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BARRIER


334 
	`RCCLCHECK_GOTO
(
	`ncşAÎReduû
(
¤c
, 
d¡
, 
couÁ
, 
dt
, 
İ
, 
‹am
->
rcş_comm
,

335 
¡»am
),

336 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

337 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

338 
ex™_cŞl
:

339  
¡©us
;

340 
	}
}

342 
ucc_¡©us_t
 
	$ucc__rcş_®Ìeduû_š™
(
ucc__rcş_sk_t
 *
sk
)

344 ià(
UCC_OK
 !=

345 
	`ucc_rcş_check_dt_suµÜ‹d
(
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
,

346 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
)) {

347 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

348  
UCC_ERR_NOT_SUPPORTED
;

351 ià(
ucc_to_rcş_»duû_İ
[
	`TASK_ARGS
(
sk
).
İ
] =ğ
ncşOpUnsuµÜ‹d
) {

352 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "reduction operation is‚ot supported");

353  
UCC_ERR_NOT_SUPPORTED
;

356 
sk
->
su³r
.
po¡
 = 
ucc__rcş_®Ìeduû_¡¬t
;

357  
UCC_OK
;

358 
	}
}

360 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

362 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

363 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

364 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

365 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

366 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

367 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

368 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

369 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

370 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

371 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

372 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

373 
ncşD©aTy³_t
 
dt
;

375 
dt
 = 
ucc_to_rcş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)];

376 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

377 
¤c
 = (*)((
±rdiff_t
)
¬gs
->
d¡
.
šfo
.
bufãr
 + (
couÁ
 / 
size
) *

378 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
è* 
¿nk
);

380 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

381 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_allgather_start", 0);

382 
	`RCCLCHECK_GOTO
(
	`ncşAÎG©h”
(
¤c
, 
d¡
, 
couÁ
 / 
size
, 
dt
,

383 
‹am
->
rcş_comm
, 
¡»am
),

384 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

385 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

386 
ex™_cŞl
:

387  
¡©us
;

388 
	}
}

390 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”_š™
(
ucc__rcş_sk_t
 *
sk
)

392 
ucc_d©©y³_t
 
dt1
 = 
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))

393 ? 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³


394 : 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
;

395 
ucc_d©©y³_t
 
dt2
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

397 ià(
UCC_OK
 !ğ
	`ucc_rcş_check_dt_suµÜ‹d
(
dt1
, 
dt2
)) {

398 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "dataype is‚ot supported");

399  
UCC_ERR_NOT_SUPPORTED
;

401 
sk
->
su³r
.
po¡
 = 
ucc__rcş_®lg©h”_¡¬t
;

402  
UCC_OK
;

403 
	}
}

405 
ucc_¡©us_t
 
	$ucc__rcş_®lg©h”v_š™
(
ucc__rcş_sk_t
 *
sk
)

407 
ucc_d©©y³_t
 
dt1
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
d©©y³
;

408 
ucc_d©©y³_t
 
dt2
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
d©©y³
;

410 ià(
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

411 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "inplace‡llgatherv is‚ot supported");

412  
UCC_ERR_NOT_SUPPORTED
;

414 ià(
UCC_OK
 !ğ
	`ucc_rcş_check_dt_suµÜ‹d
(
dt1
, 
dt2
)) {

415 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

416  
UCC_ERR_NOT_SUPPORTED
;

418 
sk
->
su³r
.
po¡
 = 
ucc__rcş_®lg©h”v_p2p_¡¬t
;

419  
UCC_OK
;

420 
	}
}

422 
ucc_¡©us_t
 
	$ucc__rcş_bÿ¡_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

424 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

425 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

426 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

427 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

428 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

429 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

430 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

431 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

432 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

433 
ucc_¿nk_t
 
³”
, 
¿nk
, 
size
;

434 
ncşD©aTy³_t
 
dt
;

435 
ucc_•_m­_t
 
m­
;

437 
dt
 = 
ucc_to_rcş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
¤c
.
šfo
.
d©©y³
)];

438 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

439 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_bcast_start", 0);

441 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(
¬gs
)) {

442 
m­
 = 
	`ucc_aùive_£t_to_•_m­
(
¬gs
);

443 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

444 
size
 = (
ucc_¿nk_t
)
¬gs
->
aùive_£t
.size;

445 ià(
roÙ
 =ğ
¿nk
) {

446 
	`RCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
,

447 
	`UCC_TL_TEAM_LIB
(
‹am
));

448 
³”
 = 0;…“¸< 
size
;…eer++) {

449 ià(
	`ucc_•_m­_ev®
(
m­
, 
³”
è=ğ
¿nk
) {

452 
	`RCCLCHECK_GOTO
(
	`ncşS’d
(
¤c
, 
couÁ
, 
dt
,

453 
	`ucc_•_m­_ev®
(
m­
, 
³”
),

454 
‹am
->
rcş_comm
, 
¡»am
),

455 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

457 
	`RCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
,

458 
	`UCC_TL_TEAM_LIB
(
‹am
));

460 
	`RCCLCHECK_GOTO
(
	`ncşRecv
(
¤c
, 
couÁ
, 
dt
, 
roÙ
,

461 
‹am
->
rcş_comm
, 
¡»am
),

462 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

465 
	`RCCLCHECK_GOTO
(
	`ncşBrßdÿ¡
(
¤c
, src, 
couÁ
, 
dt
, 
roÙ
, 
‹am
->
rcş_comm
,

466 
¡»am
),

467 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

469 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

470 
ex™_cŞl
:

471  
¡©us
;

472 
	}
}

474 
ucc_¡©us_t
 
	$ucc__rcş_bÿ¡_š™
(
ucc__rcş_sk_t
 *
sk
)

476 ià(
UCC_OK
 !=

477 
	`ucc_rcş_check_dt_suµÜ‹d
(
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
,

478 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
)) {

480 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "dataype is‚ot supported");

481  
UCC_ERR_NOT_SUPPORTED
;

483 
sk
->
su³r
.
po¡
 = 
ucc__rcş_bÿ¡_¡¬t
;

484  
UCC_OK
;

485 
	}
}

487 
ucc_¡©us_t
 
	$ucc__rcş_»duû_sÿ‰”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

489 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

490 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

491 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

492 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

493 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

494 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

495 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

496 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

497 
ncşRedOp_t
 
İ
 = 
ucc_to_rcş_»duû_İ
[
¬gs
->op];

498 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

499 
ncşD©aTy³_t
 
dt
;

501 
dt
 = 
ucc_to_rcş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)];

502 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

503 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_reduce_scatter_start", 0);

504 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

505 
couÁ
 /ğ
	`UCC_TL_TEAM_SIZE
(
‹am
);

506 
¤c
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

507 
d¡
 = 
	`PTR_OFFSET
(
¤c
, 
	`UCC_TL_TEAM_RANK
(
‹am
è* 
couÁ


508 * 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
));

510 
	`RCCLCHECK_GOTO
(
	`ncşReduûSÿ‰”
(
¤c
, 
d¡
, 
couÁ
, 
dt
, 
İ
, 
‹am
->
rcş_comm
,

511 
¡»am
),

512 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

513 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

514 
ex™_cŞl
:

515  
¡©us
;

516 
	}
}

518 
ucc_¡©us_t
 
	$ucc__rcş_»duû_sÿ‰”_š™
(
ucc__rcş_sk_t
 *
sk
)

520 ià(
UCC_OK
 !=

521 
	`ucc_rcş_check_dt_suµÜ‹d
(
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
,

522 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
)) {

523 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "dataype is‚ot supported");

524  
UCC_ERR_NOT_SUPPORTED
;

527 ià(
ucc_to_rcş_»duû_İ
[
	`TASK_ARGS
(
sk
).
İ
] =ğ
ncşOpUnsuµÜ‹d
) {

528 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "reduction operation is‚ot supported");

529  
UCC_ERR_NOT_SUPPORTED
;

532 
sk
->
su³r
.
po¡
 = 
ucc__rcş_»duû_sÿ‰”_¡¬t
;

533  
UCC_OK
;

534 
	}
}

536 
ucc_¡©us_t
 
	$ucc__rcş_»duû_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

538 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

539 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

540 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

541 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

542 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

543 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

544 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

545 
ucc_d©©y³_t
 
ucc_dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

546 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

547 
ncşRedOp_t
 
İ
 = 
ucc_to_rcş_»duû_İ
[
¬gs
->op];

548 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

549 
ncşD©aTy³_t
 
rcş_dt
;

551 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_reduce_start", 0);

552 ià(
¬gs
->
roÙ
 =ğ
	`UCC_TL_TEAM_RANK
(
‹am
)) {

553 
ucc_dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

554 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

555 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

556 
¤c
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

559 
rcş_dt
 = 
ucc_to_rcş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
ucc_dt
)];

560 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

561 
	`RCCLCHECK_GOTO
(
	`ncşReduû
(
¤c
, 
d¡
, 
couÁ
, 
rcş_dt
, 
İ
, 
¬gs
->
roÙ
,

562 
‹am
->
rcş_comm
, 
¡»am
),

563 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

564 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

565 
ex™_cŞl
:

566  
¡©us
;

567 
	}
}

569 
ucc_¡©us_t
 
	$ucc__rcş_»duû_š™
(
ucc__rcş_sk_t
 *
sk
)

571 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

572 
ucc_d©©y³_t
 
dt
;

574 
dt
 = (
	`TASK_ARGS
(
sk
).
roÙ
 =ğ
	`UCC_TL_TEAM_RANK
(
‹am
))

575 ? 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³


576 : 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
;

578 ià(
UCC_OK
 !=

579 
	`ucc_rcş_check_dt_suµÜ‹d
(
dt
, dt)) {

580 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "dataype is‚ot supported");

581  
UCC_ERR_NOT_SUPPORTED
;

584 ià(
ucc_to_rcş_»duû_İ
[
	`TASK_ARGS
(
sk
).
İ
] =ğ
ncşOpUnsuµÜ‹d
) {

585 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "reduction operation is‚ot supported");

586  
UCC_ERR_NOT_SUPPORTED
;

589 
sk
->
su³r
.
po¡
 = 
ucc__rcş_»duû_¡¬t
;

590  
UCC_OK
;

591 
	}
}

593 
ucc_¡©us_t
 
	$ucc__rcş_b¬r›r_š™
(
ucc__rcş_sk_t
 *
sk
)

596 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

598 
¬gs
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

599 
¬gs
->
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

600 
¬gs
->
İ
 = 
UCC_OP_SUM
;

602 
¬gs
->
d¡
.
šfo
.
bufãr
 = 
	`TASK_CTX
(
sk
)->
sü©ch_buf
;

603 
¬gs
->
¤c
.
šfo
.
bufãr
 =‡rgs->
d¡
.info.buffer;

604 
¬gs
->
d¡
.
šfo
.
d©©y³
 =‡rgs->
¤c
.šfo.d©©y³ = 
UCC_DT_FLOAT32
;

605 
¬gs
->
d¡
.
šfo
.
couÁ
 =‡rgs->
¤c
.info.count = 1;

607 
sk
->
su³r
.
po¡
 = 
ucc__rcş_®Ìeduû_¡¬t
;

609  
UCC_OK
;

610 
	}
}

612 
ucc_¡©us_t
 
	$ucc__rcş_g©h”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

614 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

615 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

616 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

617 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

618 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

619 
ucc_d©©y³_t
 
ucc_dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

620 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

621 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

622 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

623 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

624 
ncşD©aTy³_t
 
rcş_dt
;

626 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_gather_start", 0);

627 ià(
¬gs
->
roÙ
 =ğ
	`UCC_TL_TEAM_RANK
(
‹am
)) {

628 
ucc_dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

629 
couÁ
 = 
¬gs
->
d¡
.
šfo
.couÁ / 
	`UCC_TL_TEAM_SIZE
(
‹am
);

630 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

631 
¤c
 = 
	`PTR_OFFSET
(
d¡
, 
	`UCC_TL_TEAM_RANK
(
‹am
è* 
couÁ


632 * 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
));

635 
rcş_dt
 = 
ucc_to_rcş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
ucc_dt
)];

636 
sk
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

637 
	`RCCLCHECK_GOTO
(
	`ncşG©h”
(
¤c
, 
d¡
, 
couÁ
, 
rcş_dt
, 
¬gs
->
roÙ
,

638 
‹am
->
rcş_comm
, 
¡»am
),

639 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

640 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

641 
ex™_cŞl
:

642  
¡©us
;

643 
	}
}

645 
ucc_¡©us_t
 
	$ucc__rcş_g©h”_š™
(
ucc__rcş_sk_t
 *
sk
)

647 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

648 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

649 
ucc_d©©y³_t
 
dt
;

651 
dt
 = (
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
¬gs
->
roÙ
)

652 ? 
¬gs
->
d¡
.
šfo
.
d©©y³


653 : 
¬gs
->
¤c
.
šfo
.
d©©y³
;

655 ià(
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
¬gs
->
roÙ
) {

656 ià(
	`ucc_rcş_check_dt_suµÜ‹d
 (
dt
, dt)) {

657 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

658  
UCC_ERR_NOT_SUPPORTED
;

661 ià((
	`UCC_TL_TEAM_RANK
(
‹am
è!ğ
¬gs
->
roÙ
) ||

662 (!
	`UCC_IS_INPLACE
(*
¬gs
))) {

663 ià(
	`ucc_rcş_check_dt_suµÜ‹d
 (
dt
, dt)) {

664 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

665  
UCC_ERR_NOT_SUPPORTED
;

669 
sk
->
su³r
.
po¡
 = 
ucc__rcş_g©h”_¡¬t
;

670  
UCC_OK
;

671 
	}
}

673 
ucc_¡©us_t
 
	$ucc__rcş_g©h”v_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

675 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

676 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

677 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

678 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

679 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

680 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

681 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

682 *
d¡
 = 
¬gs
->d¡.
šfo_v
.
bufãr
;

683 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

684 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

685 
size_t
 
couÁ
, 
di¥l
, 
dt_size
;

686 
ucc_¿nk_t
 
³”
;

688 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

689 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

691 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

694 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_gatherv_start", 0);

695 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

696 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

697 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
¿nk
);

698 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

699 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

700 
¿nk
);

701 
	`HIPCHECK_GOTO
(
	`hMemıyAsync
(
	`PTR_OFFSET
(
d¡
, 
di¥l
 * 
dt_size
),

702 
¤c
, 
couÁ
 * 
dt_size
,

703 
hMemıyDeviûToDeviû
, 
¡»am
),

704 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

706 
	`RCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
,

707 
	`UCC_TL_TEAM_LIB
(
‹am
));

708 
³”
 = 0;…“¸< 
size
;…eer++) {

709 ià(
³”
 =ğ
¬gs
->
roÙ
) {

712 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
³”
);

713 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

714 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

715 
³”
);

716 
	`RCCLCHECK_GOTO
(
	`ncşRecv
(
	`PTR_OFFSET
(
d¡
, 
di¥l
 * 
dt_size
),

717 
couÁ
 * 
dt_size
, 
ncşCh¬
,

718 
³”
, 
‹am
->
rcş_comm
, 
¡»am
),

719 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

721 
	`RCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
,

722 
	`UCC_TL_TEAM_LIB
(
‹am
));

724 
	`RCCLCHECK_GOTO
(
	`ncşS’d
(
¤c
, 
¬gs
->¤c.
šfo
.
couÁ
 * 
dt_size
,

725 
ncşCh¬
, 
¬gs
->
roÙ
, 
‹am
->
rcş_comm
,

726 
¡»am
),

727 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

729 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

730 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

731 
ex™_cŞl
:

732  
¡©us
;

733 
	}
}

735 
ucc_¡©us_t
 
	$ucc__rcş_g©h”v_š™
(
ucc__rcş_sk_t
 *
sk
)

737 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

738 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

739 
ucc_d©©y³_t
 
dt
;

741 
dt
 = (
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
¬gs
->
roÙ
)

742 ? 
¬gs
->
d¡
.
šfo_v
.
d©©y³


743 : 
¬gs
->
¤c
.
šfo
.
d©©y³
;

745 ià(
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
¬gs
->
roÙ
) {

746 ià(
	`ucc_rcş_check_dt_suµÜ‹d
 (
dt
, dt)) {

747 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

748  
UCC_ERR_NOT_SUPPORTED
;

751 ià((
	`UCC_TL_TEAM_RANK
(
‹am
è!ğ
¬gs
->
roÙ
) ||

752 (!
	`UCC_IS_INPLACE
(*
¬gs
))) {

753 ià(
	`ucc_rcş_check_dt_suµÜ‹d
 (
dt
, dt)) {

754 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

755  
UCC_ERR_NOT_SUPPORTED
;

759 
sk
->
su³r
.
po¡
 = 
ucc__rcş_g©h”v_¡¬t
;

760  
UCC_OK
;

761 
	}
}

763 
ucc_¡©us_t
 
	$ucc__rcş_sÿ‰”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

765 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

766 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

767 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

768 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

769 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

770 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

771 *
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

772 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

773 
ucc_d©©y³_t
 
ucc_dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

774 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

775 
ncşD©aTy³_t
 
rcş_dt
;

777 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_scatter_start", 0);

778 ià(
¬gs
->
roÙ
 =ğ
	`UCC_TL_TEAM_RANK
(
‹am
)) {

779 
ucc_dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

780 
couÁ
 = 
¬gs
->
¤c
.
šfo
.couÁ / 
	`UCC_TL_TEAM_SIZE
(
‹am
);

781 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

782 
d¡
 = 
	`PTR_OFFSET
(
¤c
, 
	`UCC_TL_TEAM_RANK
(
‹am
è* 
couÁ


783 * 
	`ucc_dt_size
(
ucc_dt
));

786 
rcş_dt
 = 
ucc_to_rcş_dty³
[
	`UCC_DT_PREDEFINED_ID
(
ucc_dt
)];

787 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

788 
	`RCCLCHECK_GOTO
(
	`ncşSÿ‰”
(
¤c
, 
d¡
, 
couÁ
, 
rcş_dt
, 
¬gs
->
roÙ
,

789 
‹am
->
rcş_comm
, 
¡»am
),

790 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

792 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

793 
ex™_cŞl
:

794  
¡©us
;

795 
	}
}

797 
ucc_¡©us_t
 
	$ucc__rcş_sÿ‰”_š™
(
ucc__rcş_sk_t
 *
sk
)

799 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

800 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

801 
ucc_d©©y³_t
 
dt
;

803 
dt
 = (
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
¬gs
->
roÙ
)

804 ? 
¬gs
->
¤c
.
šfo
.
d©©y³


805 : 
¬gs
->
d¡
.
šfo
.
d©©y³
;

807 ià(
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
¬gs
->
roÙ
) {

808 ià(
	`ucc_rcş_check_dt_suµÜ‹d
(
dt
, dt)) {

809 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

810  
UCC_ERR_NOT_SUPPORTED
;

813 ià((
	`UCC_TL_TEAM_RANK
(
‹am
è!ğ
¬gs
->
roÙ
) ||

814 (!
	`UCC_IS_INPLACE
(*
¬gs
))) {

815 ià(
	`ucc_rcş_check_dt_suµÜ‹d
 (
dt
, dt)) {

816 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

817  
UCC_ERR_NOT_SUPPORTED
;

821 
sk
->
su³r
.
po¡
 = 
ucc__rcş_sÿ‰”_¡¬t
;

822  
UCC_OK
;

823 
	}
}

825 
ucc_¡©us_t
 
	$ucc__rcş_sÿ‰”v_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

827 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

828 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

829 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

830 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

831 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

832 
ucc_“_h
 
“
 = 
cŞl_sk
->ee;

833 
hSŒ—m_t
 
¡»am
 = (
“
è? (hSŒ—m_tè“->
“_cÚ‹xt
 : 
‹am
->stream;

834 *
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

835 *
¤c
 = 
¬gs
->¤c.
šfo_v
.
bufãr
;

836 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

837 
size_t
 
couÁ
, 
di¥l
, 
dt_size
;

838 
ucc_¿nk_t
 
³”
;

840 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

841 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
);

843 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

846 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_scatterv_start", 0);

847 ià(
¿nk
 =ğ
¬gs
->
roÙ
) {

848 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

849 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
, 
¿nk
);

850 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

851 
¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
,

852 
¿nk
);

853 
	`HIPCHECK_GOTO
(
	`hMemıyAsync
(
d¡
,

854 
	`PTR_OFFSET
(
¤c
, 
di¥l
 * 
dt_size
),

855 
couÁ
 * 
dt_size
,

856 
hMemıyDeviûToDeviû
, 
¡»am
),

857 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

859 
	`RCCLCHECK_GOTO
(
	`ncşGroupS¹
(), 
ex™_cŞl
, 
¡©us
,

860 
	`UCC_TL_TEAM_LIB
(
‹am
));

861 
³”
 = 0;…“¸< 
size
;…eer++) {

862 ià(
³”
 =ğ
¬gs
->
roÙ
) {

865 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
, 
³”
);

866 
di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

867 
¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
,

868 
³”
);

869 
	`RCCLCHECK_GOTO
(
	`ncşS’d
(
	`PTR_OFFSET
(
¤c
, 
di¥l
 * 
dt_size
),

870 
couÁ
 * 
dt_size
, 
ncşCh¬
, 
³”
,

871 
‹am
->
rcş_comm
, 
¡»am
),

872 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

874 
	`RCCLCHECK_GOTO
(
	`ncşGroupEnd
(), 
ex™_cŞl
, 
¡©us
,

875 
	`UCC_TL_TEAM_LIB
(
‹am
));

877 
	`RCCLCHECK_GOTO
(
	`ncşRecv
(
d¡
, 
¬gs
->d¡.
šfo
.
couÁ
 * 
dt_size
, 
ncşCh¬
,

878 
¬gs
->
roÙ
, 
‹am
->
rcş_comm
, 
¡»am
),

879 
ex™_cŞl
, 
¡©us
, 
	`UCC_TL_TEAM_LIB
(
‹am
));

881 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

882 
¡©us
 = 
	`ucc__rcş_cŞËùive_sync
(
sk
, 
¡»am
);

883 
ex™_cŞl
:

884  
¡©us
;

885 
	}
}

887 
ucc_¡©us_t
 
	$ucc__rcş_sÿ‰”v_š™
(
ucc__rcş_sk_t
 *
sk
)

889 
ucc__rcş_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

890 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

891 
ucc_d©©y³_t
 
dt
;

893 
dt
 = (
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
¬gs
->
roÙ
)

894 ? 
¬gs
->
¤c
.
šfo_v
.
d©©y³


895 : 
¬gs
->
d¡
.
šfo
.
d©©y³
;

897 ià(
	`UCC_TL_TEAM_RANK
(
‹am
è=ğ
¬gs
->
roÙ
) {

898 ià(
	`ucc_rcş_check_dt_suµÜ‹d
(
dt
, dt)) {

899 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

900  
UCC_ERR_NOT_SUPPORTED
;

903 ià((
	`UCC_TL_TEAM_RANK
(
‹am
è!ğ
¬gs
->
roÙ
) ||

904 (!
	`UCC_IS_INPLACE
(*
¬gs
))) {

905 ià(
	`ucc_rcş_check_dt_suµÜ‹d
(
dt
, dt)) {

906 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "datatype is‚ot supported");

907  
UCC_ERR_NOT_SUPPORTED
;

911 
sk
->
su³r
.
po¡
 = 
ucc__rcş_sÿ‰”v_¡¬t
;

912  
UCC_OK
;

913 
	}
}

916 
šlše
 
	$®g_id_äom_¡r
(
ucc_cŞl_ty³_t
 
cŞl_ty³
, cÚ¡ *
¡r
)

918 
cŞl_ty³
) {

919 
UCC_COLL_TYPE_ALLGATHERV
:

920  
	`ucc__rcş_®lg©h”v_®g_äom_¡r
(
¡r
);

925 
	}
}

927 
ucc_¡©us_t
 
	$ucc__rcş_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

928 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

929 
ucc_memÜy_ty³_t
 
mem_ty³
,

930 
ucc_ba£_cŞl_š™_â_t
 *
š™
)

932 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

933 ià(
®g_id_¡r
) {

934 
®g_id
 = 
	`®g_id_äom_¡r
(
cŞl_ty³
, 
®g_id_¡r
);

937 
cŞl_ty³
) {

938 
UCC_COLL_TYPE_ALLGATHERV
:

939 
®g_id
) {

940 
UCC_TL_RCCL_ALLGATHERV_ALG_P2P
:

941 *
š™
 = 
ucc__rcş_®lg©h”v_p2p_š™
;

943 
UCC_TL_RCCL_ALLGATHERV_ALG_BCOPY
:

944 *
š™
 = 
ucc__rcş_®lg©h”v_bcİy_š™
;

946 
UCC_TL_RCCL_ALLGATHERV_ALG_BCAST
:

947 *
š™
 = 
ucc__rcş_®lg©h”v_bÿ¡_š™
;

950 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

955 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

958  
¡©us
;

959 
	}
}

	@src/components/tl/rccl/tl_rccl_coll.h

9 #iâdeà
UCC_TL_RCCL_COLL_H_


10 
	#UCC_TL_RCCL_COLL_H_


	)

12 
	~"_rcş.h
"

14 
	#UCC_TL_RCCL_N_DEFAULT_ALG_SELECT_STR
 1

	)

16 *
ucc__rcş_deçuÉ_®g_£Ëù_¡r
[
UCC_TL_RCCL_N_DEFAULT_ALG_SELECT_STR
];

18 
ucc_¡©us_t
 
ucc__rcş_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

19 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

20 
ucc_memÜy_ty³_t
 
mem_ty³
,

21 
ucc_ba£_cŞl_š™_â_t
 *
š™
);

23 
ucc__rcş_sk_t
 * 
ucc__rcş_š™_sk
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

24 
ucc_ba£_‹am_t
 *
‹am
);

26 
ucc__rcş_ä“_sk
(
ucc__rcş_sk_t
 *
sk
);

28 
ucc_¡©us_t
 
ucc__rcş_Œigg”ed_po¡
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
,

29 
ucc_cŞl_sk_t
 *
cŞl_sk
);

31 
ucc_¡©us_t
 
ucc__rcş_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

33 
ucc_¡©us_t
 
ucc__rcş_cŞËùive_sync
(
ucc__rcş_sk_t
 *
sk
,

34 
hSŒ—m_t
 
¡»am
);

36 
ucc_¡©us_t
 
ucc__rcş_®lg©h”_š™
(
ucc__rcş_sk_t
 *
sk
);

38 
ucc_¡©us_t
 
ucc__rcş_®lg©h”v_š™
(
ucc__rcş_sk_t
 *
sk
);

40 
ucc_¡©us_t
 
ucc__rcş_®Ìeduû_š™
(
ucc__rcş_sk_t
 *
sk
);

42 
ucc_¡©us_t
 
ucc__rcş_®ÉßÎ_š™
(
ucc__rcş_sk_t
 *
sk
);

44 
ucc_¡©us_t
 
ucc__rcş_®ÉßÎv_š™
(
ucc__rcş_sk_t
 *
sk
);

46 
ucc_¡©us_t
 
ucc__rcş_bÿ¡_š™
(
ucc__rcş_sk_t
 *
sk
);

48 
ucc_¡©us_t
 
ucc__rcş_»duû_sÿ‰”_š™
(
ucc__rcş_sk_t
 *
sk
);

50 
ucc_¡©us_t
 
ucc__rcş_»duû_š™
(
ucc__rcş_sk_t
 *
sk
);

52 
ucc_¡©us_t
 
ucc__rcş_b¬r›r_š™
(
ucc__rcş_sk_t
 *
sk
);

54 
ucc_¡©us_t
 
ucc__rcş_g©h”_š™
(
ucc__rcş_sk_t
 *
sk
);

56 
ucc_¡©us_t
 
ucc__rcş_g©h”v_š™
(
ucc__rcş_sk_t
 *
sk
);

58 
ucc_¡©us_t
 
ucc__rcş_sÿ‰”_š™
(
ucc__rcş_sk_t
 *
sk
);

60 
ucc_¡©us_t
 
ucc__rcş_sÿ‰”v_š™
(
ucc__rcş_sk_t
 *
sk
);

	@src/components/tl/rccl/tl_rccl_context.c

9 
	~"_rcş.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"compÚ’ts/ec/ucc_ec.h
"

12 
	~"uts/¬ch/ıu.h
"

14 
	$ucc__rcş_ev’t_cŞËùive_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

16 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

17 
ucc_¡©us_t
 
¡©us
;

19 
	`ucc_as£¹
(
sk
->
com¶‘ed
 !ğ
NULL
);

20 
¡©us
 = 
	`ucc_ec_ev’t_‹¡
(
sk
->
com¶‘ed
, 
UCC_EE_ROCM_STREAM
);

21 
cŞl_sk
->
¡©us
 = status;

22 #ifdeà
HAVE_PROFILING_TL_RCCL


23 ià(
cŞl_sk
->
¡©us
 =ğ
UCC_OK
) {

24 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_coll_done", 0);

27 
	}
}

29 
	$ucc__rcş_driv”_cŞËùive_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

31 
ucc__rcş_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_rccl_task_t);

33 
cŞl_sk
->
¡©us
 = 
sk
->
ho¡_¡©us
;

34 #ifdeà
HAVE_PROFILING_TL_RCCL


35 ià(
cŞl_sk
->
¡©us
 =ğ
UCC_OK
) {

36 
	`UCC_TL_RCCL_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "rccl_coll_done", 0);

39 
	}
}

41 
	$ucc__rcş_»q_mpoŞ_obj_š™
(
ucc_mpoŞ_t
 *
mp
, *
obj
,

42 *
chunk
)

44 
ucc__rcş_sk_t
 *
»q
 = (ucc__rcş_sk_t*è
obj
;

46 
	`ucc_cŞl_sk_cÚ¡ruù
(&
»q
->
su³r
);

47 
»q
->
su³r
.
´og»ss
 = 
ucc__rcş_ev’t_cŞËùive_´og»ss
;

48 
	}
}

50 
	$ucc__rcş_»q_mpoŞ_obj_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

52 
	`ucc_cŞl_sk_de¡ruù
(
obj
);

53 
	}
}

56 
ucc_mpoŞ_İs_t
 
	gucc__rcş_»q_mpoŞ_İs
 = {

57 .
chunk_®loc
 = 
ucc_mpoŞ_hug‘lb_m®loc
,

58 .
	gchunk_»Ëa£
 = 
ucc_mpoŞ_hug‘lb_ä“
,

59 .
	gobj_š™
 = 
ucc__rcş_»q_mpoŞ_obj_š™
,

60 .
	gobj_ş—nup
 = 
ucc__rcş_»q_mpoŞ_obj_ş—nup


63 
	$UCC_CLASS_INIT_FUNC
(
ucc__rcş_cÚ‹xt_t
,

64 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

65 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

67 
ucc__rcş_cÚ‹xt_cÚfig_t
 *
_rcş_cÚfig
 =

68 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__rcş_cÚ‹xt_cÚfig_t
);

69 
ucc_¡©us_t
 
¡©us
;

71 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__cÚ‹xt_t
, &
_rcş_cÚfig
->
su³r
,

72 
·¿ms
->
cÚ‹xt
);

73 
	`memıy
(&
£lf
->
cfg
, 
_rcş_cÚfig
, (*tl_rccl_config));

76 ià(
£lf
->
cfg
.
sync_ty³
 =ğ
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_MEMOPS
) {

77 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "memops‚ot supported");

78  
UCC_ERR_NOT_SUPPORTED
;

81 ià(
£lf
->
cfg
.
sync_ty³
 !ğ
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_EVENT
) {

82 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "fallbackoƒvent completion sync");

83 
£lf
->
cfg
.
sync_ty³
 = 
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_EVENT
;

86 
	`ucc_as£¹
(
£lf
->
cfg
.
sync_ty³
 =ğ
UCC_TL_RCCL_COMPLETION_SYNC_TYPE_EVENT
);

87 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "usingƒvent completion sync");

88 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
£lf
->
»q_mp
, 0, (
ucc__rcş_sk_t
), 0,

89 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
,

90 &
ucc__rcş_»q_mpoŞ_İs
, 
·¿ms
->
th»ad_mode
,

92 ià(
¡©us
 !ğ
UCC_OK
) {

93 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

95  
¡©us
;

98 
hE¼Ü_t
 
h_¡
 = 
	`hM®loc
(&
£lf
->
sü©ch_buf
, ());

99 ià(
h_¡
 !ğ
hSucûss
) {

100  
UCC_ERR_NO_MEMORY
;

102 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "initializedl context: %p", self);

103  
UCC_OK
;

104 
	}
}

106 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__rcş_cÚ‹xt_t
)

108 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizingl context: %p", self);

109 
	`ucc_mpoŞ_ş—nup
(&
£lf
->
»q_mp
, 1);

110 
	`hF»e
(
£lf
->
sü©ch_buf
);

111 
£lf
->
sü©ch_buf
 = 
NULL
;

112 
	}
}

114 
UCC_CLASS_DEFINE
(
ucc__rcş_cÚ‹xt_t
, 
ucc__cÚ‹xt_t
);

116 
ucc_¡©us_t


117 
	$ucc__rcş_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

118 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

120 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

121  
UCC_OK
;

122 
	}
}

124 
ucc_¡©us_t
 
	$ucc__rcş_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

125 *
memh
, *
_h
)

127  
UCC_ERR_NOT_SUPPORTED
;

128 
	}
}

130 
ucc_¡©us_t
 
	$ucc__rcş_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

131 *
memh
)

133  
UCC_ERR_NOT_SUPPORTED
;

134 
	}
}

136 
ucc_¡©us_t
 
	$ucc__rcş_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

137 
ty³
, *
memh
, **
·ck_bufãr
)

139  
UCC_ERR_NOT_SUPPORTED
;

140 
	}
}

	@src/components/tl/rccl/tl_rccl_lib.c

8 
	~"_rcş.h
"

11 
	$UCC_CLASS_INIT_FUNC
(
ucc__rcş_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

12 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

14 cÚ¡ 
ucc__lib_cÚfig_t
 *
_cÚfig
 =

15 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__lib_cÚfig_t
);

16 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__lib_t
, &
ucc__rcş
.
su³r
, 
_cÚfig
);

18 
	`_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

19  
UCC_OK
;

20 
	}
}

22 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__rcş_lib_t
)

24 
	`_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

25 
	}
}

27 
UCC_CLASS_DEFINE
(
ucc__rcş_lib_t
, 
ucc__lib_t
);

29 
ucc_¡©us_t
 
	$ucc__rcş_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

30 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
)

32 
ucc__lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_tl_lib_attr_t);

34 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

35 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 
UCC_TL_RCCL_SUPPORTED_COLLS
;

36 
©Œ
->
su³r
.
æags
 = 0;

37 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
) {

38 
©Œ
->
su³r
.
mš_‹am_size
 = 
lib
->min_team_size;

41 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
) {

42 
©Œ
->
su³r
.
max_‹am_size
 = 
UCC_RANK_MAX
;

45  
UCC_OK
;

46 
	}
}

48 
ucc_¡©us_t
 
	$ucc__rcş_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

50 
´İ
->
deçuÉ_‹am_size
 = 2;

51 
´İ
->
mš_‹am_size
 = 2;

52 
´İ
->
max_‹am_size
 = 
UCC_RANK_MAX
;

53  
UCC_OK
;

54 
	}
}

	@src/components/tl/rccl/tl_rccl_team.c

9 
	~"_rcş.h
"

10 
	~"_rcş_cŞl.h
"

11 
	~"compÚ’ts/mc/ucc_mc.h
"

12 
	~"compÚ’ts/ec/ucc_ec.h
"

13 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

15 
	$UCC_CLASS_INIT_FUNC
(
ucc__rcş_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
,

16 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

18 
ucc__rcş_cÚ‹xt_t
 *
ùx
 =

19 
	`ucc_d”ived_of
(
_cÚ‹xt
, 
ucc__rcş_cÚ‹xt_t
);

20 
ucc_¡©us_t
 
¡©us
;

21 
ucc_¿nk_t
 
size
;

22 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

24 
size
 = 
	`UCC_TL_TEAM_SIZE
(
£lf
);

25 
£lf
->
unique_id
 = 
	`ucc_m®loc
((
ncşUniqueId
è* (
size
 + 1),

27 ià(!
£lf
->
unique_id
) {

28 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

30 (
ncşUniqueId
è* (
size
 + 1));

31  
UCC_ERR_NO_MEMORY
;

33 ià(
	`UCC_TL_TEAM_RANK
(
£lf
) == 0) {

34 
ncşResuÉ_t
 
¡
;

35 
¡
 = 
	`ncşG‘UniqueId
(&
£lf
->
unique_id
[
size
]);

36 ià(
¡
 !ğ
ncşSucûss
) {

37 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo get unique id");

38 
	`mem£t
(&
£lf
->
unique_id
[
size
], 0, (
ncşUniqueId
));

41 
¡©us
 = 
	`UCC_TL_TEAM_OOB
(
£lf
).
	`®lg©h”
(

42 &
£lf
->
unique_id
[
size
], self->unique_id,

43 (
ncşUniqueId
), 
	`UCC_TL_TEAM_OOB
(
£lf
).
cŞl_šfo
,

44 &
£lf
->
oob_»q
);

45 ià(
¡©us
 !ğ
UCC_OK
) {

46 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo start oob‡llgather");

47 
ä“_unique_id
;

49  
UCC_OK
;

51 
ä“_unique_id
:

52 
	`ucc_ä“
(
£lf
->
unique_id
);

53  
¡©us
;

54 
	}
}

56 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__rcş_‹am_t
)

58 
	`_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizingleam: %p", self);

59 ià(
£lf
->
rcş_comm
) {

60 
	`ncşCommDe¡roy
(
£lf
->
rcş_comm
);

61 
	`hSŒ—mDe¡roy
(
£lf
->
¡»am
);

63 
	}
}

65 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__rcş_‹am_t
, 
ucc_ba£_‹am_t
);

66 
UCC_CLASS_DEFINE
(
ucc__rcş_‹am_t
, 
ucc__‹am_t
);

68 
ucc_¡©us_t
 
	$ucc__rcş_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
)

70 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc__rcş_‹am_t
)(
_‹am
);

71  
UCC_OK
;

72 
	}
}

74 
ucc_¡©us_t
 
	$ucc__rcş_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
)

76 
ucc__rcş_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_rccl_team_t);

77 
ucc_¡©us_t
 
¡©us
;

78 
ncşResuÉ_t
 
rcş_¡©us
;

79 
ncşUniqueId
 
”rÜid
;

81 
¡©us
 = 
	`UCC_TL_TEAM_OOB
(
‹am
).
	`»q_‹¡
Ñ—m->
oob_»q
);

82 ià(
¡©us
 =ğ
UCC_INPROGRESS
) {

83  
UCC_INPROGRESS
;

85 ià(
¡©us
 !ğ
UCC_OK
) {

86 
	`UCC_TL_TEAM_OOB
(
‹am
).
	`»q_ä“
Ñ—m->
oob_»q
);

87 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
, "oob„eqest failed");

88 
ä“_unique_id
;

90 
¡©us
 = 
	`UCC_TL_TEAM_OOB
(
‹am
).
	`»q_ä“
Ñ—m->
oob_»q
);

91 ià(
¡©us
 !ğ
UCC_OK
) {

92 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
, "oob„eq free failed");

93 
ä“_unique_id
;

96 
	`mem£t
(&
”rÜid
, 0, (errorid));

97 ià(!
	`memcmp
(&
”rÜid
, 
‹am
->
unique_id
, (errorid))) {

98 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
, "incorrect unique id");

99 
ä“_unique_id
;

102 
	`HIPCHECK_GOTO
(
	`hSŒ—mC»©eW™hFÏgs
(&
‹am
->
¡»am
,

103 
hSŒ—mNÚBlockšg
), 
ä“_unique_id
, 
¡©us
,

104 
_‹am
->
cÚ‹xt
->
lib
);

105 
rcş_¡©us
 = 
	`ncşCommIn™Rªk
(&
‹am
->
rcş_comm
, 
	`UCC_TL_TEAM_SIZE
(team),

106 
‹am
->
unique_id
[0], 
	`UCC_TL_TEAM_RANK
(team));

107 ià(
rcş_¡©us
 !ğ
ncşSucûss
) {

108 
	`_debug
(
_‹am
->
cÚ‹xt
->
lib
, "RCCLƒrror %d %s",

109 
rcş_¡©us
, 
	`ncşG‘E¼ÜSŒšg
(rccl_status));

110 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

111 
ä“_¡»am
;

113 
	`ucc_ä“
(
‹am
->
unique_id
);

114 
	`_debug
(
_‹am
->
cÚ‹xt
->
lib
, "š™ŸlizedÈ‹am: %p", 
‹am
);

115  
UCC_OK
;

117 
ä“_¡»am
:

118 
	`hSŒ—mDe¡roy
(
‹am
->
¡»am
);

119 
ä“_unique_id
:

120 
	`ucc_ä“
(
‹am
->
unique_id
);

121  
¡©us
;

122 
	}
}

124 
ucc_¡©us_t
 
	$ucc__rcş_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

125 
ucc_ba£_‹am_t
 *
‹am
,

126 
ucc_cŞl_sk_t
 **
sk_h
)

128 
ucc__rcş_sk_t
 *
sk
;

129 
ucc_¡©us_t
 
¡©us
;

131 
sk
 = 
	`ucc__rcş_š™_sk
(
cŞl_¬gs
, 
‹am
);

132 ià(
	`ucc_uÆik–y
(!
sk
)) {

133  
UCC_ERR_NO_MESSAGE
;

136 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
)

138 
UCC_COLL_TYPE_ALLGATHER
:

139 
¡©us
 = 
	`ucc__rcş_®lg©h”_š™
(
sk
);

141 
UCC_COLL_TYPE_ALLGATHERV
:

142 
¡©us
 = 
	`ucc__rcş_®lg©h”v_š™
(
sk
);

144 
UCC_COLL_TYPE_ALLREDUCE
:

145 
¡©us
 = 
	`ucc__rcş_®Ìeduû_š™
(
sk
);

147 
UCC_COLL_TYPE_ALLTOALL
:

148 
¡©us
 = 
	`ucc__rcş_®ÉßÎ_š™
(
sk
);

150 
UCC_COLL_TYPE_ALLTOALLV
:

151 
¡©us
 = 
	`ucc__rcş_®ÉßÎv_š™
(
sk
);

153 
UCC_COLL_TYPE_BCAST
:

154 
¡©us
 = 
	`ucc__rcş_bÿ¡_š™
(
sk
);

156 
UCC_COLL_TYPE_REDUCE_SCATTER
:

157 
¡©us
 = 
	`ucc__rcş_»duû_sÿ‰”_š™
(
sk
);

159 
UCC_COLL_TYPE_REDUCE
:

160 
¡©us
 = 
	`ucc__rcş_»duû_š™
(
sk
);

162 
UCC_COLL_TYPE_BARRIER
:

163 
¡©us
 = 
	`ucc__rcş_b¬r›r_š™
(
sk
);

165 
UCC_COLL_TYPE_GATHER
:

166 
¡©us
 = 
	`ucc__rcş_g©h”_š™
(
sk
);

168 
UCC_COLL_TYPE_GATHERV
:

169 
¡©us
 = 
	`ucc__rcş_g©h”v_š™
(
sk
);

171 
UCC_COLL_TYPE_SCATTER
:

172 
¡©us
 = 
	`ucc__rcş_sÿ‰”_š™
(
sk
);

174 
UCC_COLL_TYPE_SCATTERV
:

175 
¡©us
 = 
	`ucc__rcş_sÿ‰”v_š™
(
sk
);

178 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

180 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
);

181 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

183 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

184 
ä“_sk
;

186 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "init collask %p",ask);

187 *
sk_h
 = &
sk
->
su³r
;

188  
¡©us
;

190 
ä“_sk
:

191 
	`ucc__rcş_ä“_sk
(
sk
);

192  
¡©us
;

193 
	}
}

195 
ucc_¡©us_t
 
	$ucc__rcş_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

196 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

198 
ucc__rcş_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_rccl_team_t);

199 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_TEAM_CTX
(
‹am
);

200 
ucc_memÜy_ty³_t
 
mt
 = 
UCC_MEMORY_TYPE_ROCM
;

201 
ucc_cŞl_scÜe_t
 *
scÜe
;

202 
ucc_¡©us_t
 
¡©us
;

203 
i
;

204 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

206 
‹am_šfo
.
®g_â
 = 
ucc__rcş_®g_id_to_š™
;

207 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_TL_RCCL_DEFAULT_SCORE
;

208 
‹am_šfo
.
š™
 = 
ucc__rcş_cŞl_š™
;

209 
‹am_šfo
.
num_mem_ty³s
 = 1;

210 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = &
mt
;

211 
‹am_šfo
.
suµÜ‹d_cŞls
 = 
UCC_TL_RCCL_SUPPORTED_COLLS
;

212 
‹am_šfo
.
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

215 
¡©us
 =

216 
	`ucc_cŞl_scÜe_bud_deçuÉ
(
_‹am
, 
UCC_TL_RCCL_DEFAULT_SCORE
,

217 
ucc__rcş_cŞl_š™
, 
UCC_TL_RCCL_SUPPORTED_COLLS
,

218 &
mt
, 1, &
scÜe
);

219 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

220  
¡©us
;

223 
i
 = 0; i < 
UCC_TL_RCCL_N_DEFAULT_ALG_SELECT_STR
; i++) {

224 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(

225 
ucc__rcş_deçuÉ_®g_£Ëù_¡r
[
i
], &
‹am_šfo
,

226 &
‹am
->
su³r
.su³r, 
scÜe
);

227 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

228 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
,

230 
ucc__rcş_deçuÉ_®g_£Ëù_¡r
[
i
]);

231 
”r
;

237 
¡©us
 = 
	`ucc_cŞl_scÜe_add_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
,

238 
UCC_MEMORY_TYPE_HOST
, 0, 
UCC_MSG_MAX
, 1,

239 
ucc__rcş_cŞl_š™
, 
_‹am
);

240 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

241  
¡©us
;

244 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

245 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

246 &
‹am
->
su³r
.su³r, 
scÜe
);

248 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

249 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

250 
”r
;

253 *
scÜe_p
 = 
scÜe
;

254  
UCC_OK
;

255 
”r
:

256 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

257  
¡©us
;

258 
	}
}

	@src/components/tl/self/tl_self.c

8 
	~"_£lf.h
"

9 
	~"uts/ucc_m®loc.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

13 
ucc_¡©us_t
 
ucc__£lf_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

14 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
);

16 
ucc_¡©us_t
 
ucc__£lf_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

17 
ucc_ba£_ùx_©Œ_t
 *
ba£_©Œ
);

19 
ucc_¡©us_t
 
ucc__£lf_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

20 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
);

22 
ucc_¡©us_t
 
ucc__£lf_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

23 
ucc_mem_m­__t
 *
_h
);

25 
ucc_¡©us_t
 
ucc__£lf_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

26 
ucc_mem_m­_mode_t
 
mode
, 
ucc_mem_m­__t
 *
_h
, **
·ck_bufãr
);

28 
ucc_¡©us_t
 
ucc__£lf_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

30 
ucc_cÚfig_f›ld_t
 
	gucc__£lf_lib_cÚfig_bË
[] = {

31 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__£lf_lib_cÚfig_t
, 
su³r
),

32 
UCC_CONFIG_TYPE_TABLE
(
ucc__lib_cÚfig_bË
)},

34 {
NULL
}};

36 
ucs_cÚfig_f›ld_t
 
	gucc__£lf_cÚ‹xt_cÚfig_bË
[] = {

37 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__£lf_cÚ‹xt_cÚfig_t
, 
su³r
),

38 
UCC_CONFIG_TYPE_TABLE
(
ucc__cÚ‹xt_cÚfig_bË
)},

40 {
NULL
}};

42 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__£lf_lib_t
, 
ucc_ba£_lib_t
,

43 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

44 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

46 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__£lf_lib_t
, 
ucc_ba£_lib_t
);

48 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__£lf_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

49 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

50 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

52 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__£lf_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

54 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__£lf_‹am_t
, 
ucc_ba£_‹am_t
,

55 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

57 
ucc_¡©us_t
 
ucc__£lf_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
);

59 
ucc_¡©us_t
 
ucc__£lf_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
);

61 
ucc_¡©us_t
 
ucc__£lf_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

62 
ucc_ba£_‹am_t
 *
‹am
,

63 
ucc_cŞl_sk_t
 **
sk
);

65 
ucc_¡©us_t
 
ucc__£lf_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

66 
ucc_cŞl_scÜe_t
 **
scÜe
);

68 
UCC_TL_IFACE_DECLARE
(
£lf
, 
SELF
);

	@src/components/tl/self/tl_self.h

8 #iâdeà
UCC_TL_SELF_H_


9 
	#UCC_TL_SELF_H_


	)

10 
	~<ucs/memÜy/memÜy_ty³.h
>

11 
	~"compÚ’ts//ucc_.h
"

12 
	~"compÚ’ts//ucc__log.h
"

13 
	~"cÜe/ucc_“.h
"

14 
	~"uts/ucc_mpoŞ.h
"

16 #iâdeà
UCC_TL_SELF_DEFAULT_SCORE


17 
	#UCC_TL_SELF_DEFAULT_SCORE
 50

	)

20 #ifdeà
HAVE_PROFILING_TL_SELF


21 
	~"uts/´ofe/ucc_´ofe.h
"

23 
	~"uts/´ofe/ucc_´ofe_off.h
"

26 
	#UCC_TL_SELF_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

27 
	#UCC_TL_SELF_PROFILE_FUNC_VOID
 
UCC_PROFILE_FUNC_VOID


	)

28 
	#UCC_TL_SELF_PROFILE_REQUEST_NEW
 
UCC_PROFILE_REQUEST_NEW


	)

29 
	#UCC_TL_SELF_PROFILE_REQUEST_EVENT
 
UCC_PROFILE_REQUEST_EVENT


	)

30 
	#UCC_TL_SELF_PROFILE_REQUEST_FREE
 
UCC_PROFILE_REQUEST_FREE


	)

32 
	succ__£lf_içû
 {

33 
ucc__içû_t
 
	msu³r
;

34 } 
	tucc__£lf_içû_t
;

36 
ucc__£lf_içû_t
 
ucc__£lf
;

38 
	succ__£lf_lib_cÚfig
 {

39 
ucc__lib_cÚfig_t
 
	msu³r
;

40 } 
	tucc__£lf_lib_cÚfig_t
;

42 
	succ__£lf_cÚ‹xt_cÚfig
 {

43 
ucc__cÚ‹xt_cÚfig_t
 
	msu³r
;

44 } 
	tucc__£lf_cÚ‹xt_cÚfig_t
;

46 
	succ__£lf_lib
 {

47 
ucc__lib_t
 
	msu³r
;

48 
ucc__£lf_lib_cÚfig_t
 
	mcfg
;

49 } 
	tucc__£lf_lib_t
;

50 
UCC_CLASS_DECLARE
(
ucc__£lf_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

51 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

53 
	succ__£lf_cÚ‹xt
 {

54 
ucc__cÚ‹xt_t
 
	msu³r
;

55 
ucc__£lf_cÚ‹xt_cÚfig_t
 
	mcfg
;

56 
ucc_mpoŞ_t
 
	m»q_mp
;

57 } 
	tucc__£lf_cÚ‹xt_t
;

58 
UCC_CLASS_DECLARE
(
ucc__£lf_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

59 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

61 
	succ__£lf_sk
 {

62 
ucc_cŞl_sk_t
 
	msu³r
;

63 *
	m¤c
;

64 *
	md¡
;

65 
size_t
 
	msize
;

66 
ucc_memÜy_ty³_t
 
	m¤c_memty³
;

67 
ucc_memÜy_ty³_t
 
	md¡_memty³
;

68 
ucc_“_executÜ_sk_t
 *
	m‘ask
;

69 } 
	tucc__£lf_sk_t
;

71 
	succ__£lf_‹am
 {

72 
ucc__‹am_t
 
	msu³r
;

73 
ucc_¡©us_t
 
	m¡©us
;

74 } 
	tucc__£lf_‹am_t
;

75 
UCC_CLASS_DECLARE
(
ucc__£lf_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

76 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

78 
	#UCC_TL_SELF_SUPPORTED_COLLS
 \

79 (
UCC_COLL_TYPE_ALLTOALL
 | 
UCC_COLL_TYPE_ALLTOALLV
 | \

80 
UCC_COLL_TYPE_ALLGATHER
 | 
UCC_COLL_TYPE_ALLGATHERV
 | \

81 
UCC_COLL_TYPE_ALLREDUCE
 | 
UCC_COLL_TYPE_BCAST
 | 
UCC_COLL_TYPE_BARRIER
 | \

82 
UCC_COLL_TYPE_REDUCE
 | 
UCC_COLL_TYPE_FANIN
 | 
UCC_COLL_TYPE_FANOUT
 | \

83 
UCC_COLL_TYPE_GATHER
 | 
UCC_COLL_TYPE_GATHERV
 | 
UCC_COLL_TYPE_SCATTER
 | \

84 
UCC_COLL_TYPE_SCATTERV
 | 
UCC_COLL_TYPE_REDUCE_SCATTER
 | \

85 
UCC_COLL_TYPE_REDUCE_SCATTERV
)

	)

87 
	#UCC_TL_SELF_TEAM_LIB
(
_‹am
) \

88 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
->
lib
, 
ucc__£lf_lib_t
))

	)

90 
	#UCC_TL_SELF_TEAM_CTX
(
_‹am
) \

91 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
, 
ucc__£lf_cÚ‹xt_t
))

	)

93 
ucc_¡©us_t
 
ucc__£lf_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

94 
ucc_ba£_‹am_t
 *
‹am
,

95 
ucc_cŞl_sk_t
 **
sk_h
);

96 
ucc_¡©us_t
 
ucc__£lf_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

	@src/components/tl/self/tl_self_coll.c

8 
	~"_£lf.h
"

9 
	~"uts/ucc_cŞl_uts.h
"

10 
	~"uts/ucc_m®loc.h
"

12 
šlše
 
ucc__£lf_sk_t
 *

13 
	$ucc__£lf_cŞl_š™_sk
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

14 
ucc_ba£_‹am_t
 *
‹am
)

16 
ucc__£lf_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_self_team_t);

17 
ucc__£lf_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_SELF_TEAM_CTX
(
_‹am
);

18 
ucc__£lf_sk_t
 *
sk
 = 
	`ucc_mpoŞ_g‘
(&
ùx
->
»q_mp
);

20 ià(
	`ucc_uÆik–y
(!
sk
)) {

21  
NULL
;

24 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, 
cŞl_¬gs
, 
‹am
);

25 
	`UCC_TL_SELF_PROFILE_REQUEST_NEW
(
sk
, "tl_self_task", 0);

26 
sk
->
su³r
.
fš®ize
 = 
ucc__£lf_cŞl_fš®ize
;

27 
sk
->
¤c
 = 
NULL
;

28 
sk
->
d¡
 = 
NULL
;

29 
sk
->
size
 = 0;

30 
sk
->
‘ask
 = 
NULL
;

31  
sk
;

32 
	}
}

34 
šlše
 
	$ucc__£lf_put_sk
(
ucc__£lf_sk_t
 *
sk
)

36 
	`UCC_TL_SELF_PROFILE_REQUEST_FREE
(
sk
);

37 
	`ucc_mpoŞ_put
(
sk
);

38 
	}
}

40 
ucc_¡©us_t
 
	$ucc__£lf_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

42 
ucc__£lf_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_self_task_t);

44 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizingask %p",ask);

45 
	`ucc__£lf_put_sk
(
sk
);

46  
UCC_OK
;

47 
	}
}

49 
	$ucc__£lf_noİ_´og»ss
(
ucc_cŞl_sk_t
 *
sk
)

51 
sk
->
¡©us
 = 
UCC_OK
;

52 
	}
}

54 
	$ucc__£lf_cİy_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

56 
ucc__£lf_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_self_task_t);

57 
ucc_¡©us_t
 
¡©us
;

59 ià(
sk
->
‘ask
 !ğ
NULL
) {

60 
¡©us
 = 
	`ucc_“_executÜ_sk_‹¡
(
sk
->
‘ask
);

61 ià(
¡©us
 =ğ
UCC_OPERATION_INITIALIZED
 || stu =ğ
UCC_INPROGRESS
) {

62 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

65 
	`ucc_“_executÜ_sk_fš®ize
(
sk
->
‘ask
);

66 
sk
->
‘ask
 = 
NULL
;

67 
sk
->
su³r
.
¡©us
 = status;

69 
	}
}

71 
ucc_¡©us_t
 
	$ucc__£lf_cİy_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

73 
ucc__£lf_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

74 
ucc__£lf_sk_t
);

75 
ucc_“_executÜ_sk_¬gs_t
 
exec_¬gs
 = {0};

76 
ucc_“_executÜ_t
 *
exec
;

77 
ucc_¡©us_t
 
¡©us
;

79 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

80 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

81  
¡©us
;

84 
exec_¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

85 
exec_¬gs
.
cİy
.
d¡
 = 
sk
->dst;

86 
exec_¬gs
.
cİy
.
¤c
 = 
sk
->src;

87 
exec_¬gs
.
cİy
.
Ën
 = 
sk
->
size
;

88 
¡©us
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
exec_¬gs
,

89 &
sk
->
‘ask
);

90 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

91 
sk
->
su³r
.
¡©us
 = status;

92  
¡©us
;

95  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TASK_CORE_CTX
(
cŞl_sk
)->
pq
,

96 
cŞl_sk
);

97 
	}
}

99 
ucc_¡©us_t
 
	$ucc__£lf_cŞl_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

101  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TASK_CORE_CTX
(
sk
)->
pq
,ask);

102 
	}
}

104 
ucc_¡©us_t
 
	$ucc__£lf_cŞl_noİ_š™
(
ucc__£lf_sk_t
 *
sk
)

106 
sk
->
su³r
.
po¡
 = 
ucc__£lf_cŞl_¡¬t
;

107 
sk
->
su³r
.
´og»ss
 = 
ucc__£lf_noİ_´og»ss
;

108  
UCC_OK
;

109 
	}
}

111 
ucc_¡©us_t
 
	$ucc__£lf_cŞl_cİy_š™
(
ucc__£lf_sk_t
 *
sk
)

113 
ucc_cŞl_¬gs_t
 *
¬gs
 = &(
sk
->
su³r
.
b¬gs
.args);

115 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
,

116 
sk
->
su³r
.
‹am
->
·¿ms
.
¿nk
)) {

117  
UCC_ERR_NOT_SUPPORTED
;

120 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

122 
sk
->
su³r
.
po¡
 = 
ucc__£lf_cŞl_¡¬t
;

123 
sk
->
su³r
.
´og»ss
 = 
ucc__£lf_noİ_´og»ss
;

125 
sk
->
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

126 
sk
->
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

127 
sk
->
size
 =

128 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->¤c.šfo.
d©©y³
);

129 
sk
->
d¡_memty³
 = 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

130 
sk
->
¤c_memty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

131 
sk
->
su³r
.
po¡
 = 
ucc__£lf_cİy_¡¬t
;

132 
sk
->
su³r
.
´og»ss
 = 
ucc__£lf_cİy_´og»ss
;

133 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

135  
UCC_OK
;

136 
	}
}

138 
ucc_¡©us_t
 
	$ucc__£lf_®ÉßÎv_š™
(
ucc__£lf_sk_t
 *
sk
)

140 
ucc_cŞl_¬gs_t
 *
¬gs
 = &(
sk
->
su³r
.
b¬gs
.args);

142 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
,

143 
sk
->
su³r
.
‹am
->
·¿ms
.
¿nk
)) {

144  
UCC_ERR_NOT_SUPPORTED
;

147 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

149 
sk
->
su³r
.
po¡
 = 
ucc__£lf_cŞl_¡¬t
;

150 
sk
->
su³r
.
´og»ss
 = 
ucc__£lf_noİ_´og»ss
;

152 
size_t
 
di¥l
 = (size_t)
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

153 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 0);

154 
sk
->
d¡
 = 
	`PTR_OFFSET
(
¬gs
->d¡.
šfo_v
.
bufãr
, 
di¥l
);

155 
di¥l
 = (
size_t
)
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

156 
¬gs
,‡rgs->
¤c
.
šfo_v
.
di¥Ïûm’ts
, 0);

157 
sk
->
¤c
 = 
	`PTR_OFFSET
(
¬gs
->¤c.
šfo_v
.
bufãr
, 
di¥l
);

158 
sk
->
size
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
, 0) *

159 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
);

160 
sk
->
d¡_memty³
 = 
¬gs
->
d¡
.
šfo_v
.
mem_ty³
;

161 
sk
->
¤c_memty³
 = 
¬gs
->
¤c
.
šfo_v
.
mem_ty³
;

162 
sk
->
su³r
.
po¡
 = 
ucc__£lf_cİy_¡¬t
;

163 
sk
->
su³r
.
´og»ss
 = 
ucc__£lf_cİy_´og»ss
;

164 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

166  
UCC_OK
;

167 
	}
}

169 
ucc_¡©us_t
 
	$ucc__£lf_cŞl_cİyv_š™
(
ucc__£lf_sk_t
 *
sk
)

171 
ucc_cŞl_¬gs_t
 *
¬gs
 = &(
sk
->
su³r
.
b¬gs
.args);

173 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
,

174 
sk
->
su³r
.
‹am
->
·¿ms
.
¿nk
)) {

175  
UCC_ERR_NOT_SUPPORTED
;

178 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

180 
sk
->
su³r
.
po¡
 = 
ucc__£lf_cŞl_¡¬t
;

181 
sk
->
su³r
.
´og»ss
 = 
ucc__£lf_noİ_´og»ss
;

183 
size_t
 
di¥l
 = 0;

185 ià(
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
) {

186 
di¥l
 = (
size_t
)
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

187 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 0);

189 
sk
->
d¡
 = 
	`PTR_OFFSET
(
¬gs
->d¡.
šfo_v
.
bufãr
, 
di¥l
);

190 
sk
->
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

191 
sk
->
size
 =

192 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->¤c.šfo.
d©©y³
);

193 
sk
->
d¡_memty³
 = 
¬gs
->
d¡
.
šfo_v
.
mem_ty³
;

194 
sk
->
¤c_memty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

195 
sk
->
su³r
.
po¡
 = 
ucc__£lf_cİy_¡¬t
;

196 
sk
->
su³r
.
´og»ss
 = 
ucc__£lf_cİy_´og»ss
;

197 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

199  
UCC_OK
;

200 
	}
}

202 
ucc_¡©us_t
 
	$ucc__£lf_sÿ‰”v_š™
(
ucc__£lf_sk_t
 *
sk
)

204 
ucc_cŞl_¬gs_t
 *
¬gs
 = &(
sk
->
su³r
.
b¬gs
.args);

206 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
,

207 
sk
->
su³r
.
‹am
->
·¿ms
.
¿nk
)) {

208  
UCC_ERR_NOT_SUPPORTED
;

211 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

213 
sk
->
su³r
.
po¡
 = 
ucc__£lf_cŞl_¡¬t
;

214 
sk
->
su³r
.
´og»ss
 = 
ucc__£lf_noİ_´og»ss
;

216 
size_t
 
di¥l
 = (size_t)
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

217 
¬gs
,‡rgs->
¤c
.
šfo_v
.
di¥Ïûm’ts
, 0);

218 
sk
->
¤c
 = 
	`PTR_OFFSET
(
¬gs
->¤c.
šfo_v
.
bufãr
, 
di¥l
);

219 
sk
->
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

220 
sk
->
size
 =

221 
¬gs
->
d¡
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->d¡.šfo.
d©©y³
);

222 
sk
->
d¡_memty³
 = 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

223 
sk
->
¤c_memty³
 = 
¬gs
->
¤c
.
šfo_v
.
mem_ty³
;

224 
sk
->
su³r
.
po¡
 = 
ucc__£lf_cİy_¡¬t
;

225 
sk
->
su³r
.
´og»ss
 = 
ucc__£lf_cİy_´og»ss
;

226 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

228  
UCC_OK
;

229 
	}
}

231 
ucc_¡©us_t
 
	$ucc__£lf_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

232 
ucc_ba£_‹am_t
 *
‹am
,

233 
ucc_cŞl_sk_t
 **
sk_h
)

235 
ucc_¡©us_t
 
¡©us
;

236 
ucc__£lf_sk_t
 *
sk
 = 
	`ucc__£lf_cŞl_š™_sk
(
cŞl_¬gs
, 
‹am
);

238 ià(
	`ucc_uÆik–y
(!
sk
)) {

239  
UCC_ERR_NO_MEMORY
;

242 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
) {

243 
UCC_COLL_TYPE_BARRIER
:

244 
UCC_COLL_TYPE_BCAST
:

245 
UCC_COLL_TYPE_FANIN
:

246 
UCC_COLL_TYPE_FANOUT
:

247 
¡©us
 = 
	`ucc__£lf_cŞl_noİ_š™
(
sk
);

249 
UCC_COLL_TYPE_REDUCE
:

250 
UCC_COLL_TYPE_GATHER
:

251 
UCC_COLL_TYPE_ALLTOALL
:

252 
UCC_COLL_TYPE_ALLREDUCE
:

253 
UCC_COLL_TYPE_ALLGATHER
:

254 
UCC_COLL_TYPE_REDUCE_SCATTER
:

255 
¡©us
 = 
	`ucc__£lf_cŞl_cİy_š™
(
sk
);

257 
UCC_COLL_TYPE_GATHERV
:

258 
UCC_COLL_TYPE_ALLGATHERV
:

259 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

260 
¡©us
 = 
	`ucc__£lf_cŞl_cİyv_š™
(
sk
);

262 
UCC_COLL_TYPE_ALLTOALLV
:

263 
¡©us
 = 
	`ucc__£lf_®ÉßÎv_š™
(
sk
);

265 
UCC_COLL_TYPE_SCATTERV
:

266 
¡©us
 = 
	`ucc__£lf_sÿ‰”v_š™
(
sk
);

269 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

271 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

272 
	`ucc__£lf_put_sk
(
sk
);

273  
¡©us
;

275 
	`_Œaû
(
‹am
->
cÚ‹xt
->
lib
, "š™ cŞÈ»q %p", 
sk
);

276 *
sk_h
 = &
sk
->
su³r
;

277  
¡©us
;

278 
	}
}

	@src/components/tl/self/tl_self_context.c

8 
	~"_£lf.h
"

9 
	~"uts/¬ch/ıu.h
"

10 
	~<lim™s.h
>

12 
	$UCC_CLASS_INIT_FUNC
(
ucc__£lf_cÚ‹xt_t
,

13 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

14 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

16 
ucc__£lf_cÚ‹xt_cÚfig_t
 *
_£lf_cÚfig
 =

17 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__£lf_cÚ‹xt_cÚfig_t
);

18 
ucc_¡©us_t
 
¡©us
;

20 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__cÚ‹xt_t
, &
_£lf_cÚfig
->
su³r
,

21 
·¿ms
->
cÚ‹xt
);

22 
	`memıy
(&
£lf
->
cfg
, 
_£lf_cÚfig
, (*tl_self_config));

24 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
£lf
->
»q_mp
, 0, (
ucc__£lf_sk_t
), 0,

25 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
,

26 &
ucc_cŞl_sk_mpoŞ_İs
, 
·¿ms
->
th»ad_mode
,

28 ià(
¡©us
 !ğ
UCC_OK
) {

29 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

31  
¡©us
;

34  
¡©us
;

35 
	}
}

37 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__£lf_cÚ‹xt_t
)

39 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizingl context: %p", self);

40 
	`ucc_mpoŞ_ş—nup
(&
£lf
->
»q_mp
, 1);

41 
	}
}

43 
UCC_CLASS_DEFINE
(
ucc__£lf_cÚ‹xt_t
, 
ucc__cÚ‹xt_t
);

45 
ucc_¡©us_t


46 
	$ucc__£lf_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

47 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

49 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

50  
UCC_OK
;

51 
	}
}

53 
ucc_¡©us_t
 
	$ucc__£lf_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

54 *
add»ss
, 
size_t
 
Ën
, *
memh
,

55 *
_h
)

57  
UCC_ERR_NOT_SUPPORTED
;

58 
	}
}

60 
ucc_¡©us_t
 
	$ucc__£lf_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

61 *
memh
)

63  
UCC_ERR_NOT_SUPPORTED
;

64 
	}
}

66 
ucc_¡©us_t
 
	$ucc__£lf_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

67 
ty³
, *
memh
, **
·ck_bufãr
)

69  
UCC_ERR_NOT_SUPPORTED
;

70 
	}
}

	@src/components/tl/self/tl_self_lib.c

8 
	~"_£lf.h
"

11 
	$UCC_CLASS_INIT_FUNC
(
ucc__£lf_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

12 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

14 cÚ¡ 
ucc__£lf_lib_cÚfig_t
 *
_cÚfig
 =

15 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__£lf_lib_cÚfig_t
);

17 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__lib_t
, &
ucc__£lf
.
su³r
,

18 &
_cÚfig
->
su³r
);

19 
	`memıy
(&
£lf
->
cfg
, 
_cÚfig
, (*tl_config));

20 
	`_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

21  
UCC_OK
;

22 
	}
}

24 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__£lf_lib_t
)

26 
	`_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

27 
	}
}

29 
UCC_CLASS_DEFINE
(
ucc__£lf_lib_t
, 
ucc__lib_t
);

31 
ucc_¡©us_t
 
	$ucc__£lf_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

32 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
)

34 
ucc__lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_tl_lib_attr_t);

36 
©Œ
->
su³r
.
æags
 = 0;

37 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

38 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 
UCC_TL_SELF_SUPPORTED_COLLS
;

39 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
) {

40 
©Œ
->
su³r
.
mš_‹am_size
 = 1;

42 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
) {

43 
©Œ
->
su³r
.
max_‹am_size
 = 1;

45  
UCC_OK
;

46 
	}
}

48 
ucc_¡©us_t
 
	$ucc__£lf_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

50 
´İ
->
deçuÉ_‹am_size
 = 1;

51 
´İ
->
mš_‹am_size
 = 1;

52 
´İ
->
max_‹am_size
 = 1;

53  
UCC_OK
;

54 
	}
}

	@src/components/tl/self/tl_self_team.c

8 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

9 
	~"cÜe/ucc_‹am.h
"

10 
	~"_£lf.h
"

12 
	$UCC_CLASS_INIT_FUNC
(
ucc__£lf_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
,

13 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

15 
ucc__£lf_cÚ‹xt_t
 *
ùx
 =

16 
	`ucc_d”ived_of
(
_cÚ‹xt
, 
ucc__£lf_cÚ‹xt_t
);

18 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

19 
	`_debug
(
_cÚ‹xt
->
lib
, "po¡edÈ‹am: %p", 
£lf
);

20  
UCC_OK
;

21 
	}
}

23 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__£lf_‹am_t
)

25 
	`_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizingleam: %p", self);

26 
	}
}

28 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__£lf_‹am_t
, 
ucc_ba£_‹am_t
);

30 
UCC_CLASS_DEFINE
(
ucc__£lf_‹am_t
, 
ucc__‹am_t
);

32 
ucc_¡©us_t
 
	$ucc__£lf_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
)

34 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc__£lf_‹am_t
)(
_‹am
);

35  
UCC_OK
;

36 
	}
}

38 
ucc_¡©us_t
 
	$ucc__£lf_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
)

40 
ucc__£lf_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_self_team_t);

42 
	`_debug
(
_‹am
->
cÚ‹xt
->
lib
, "š™ŸlizedÈ‹am: %p", 
‹am
);

43  
UCC_OK
;

44 
	}
}

46 
ucc_¡©us_t
 
	$ucc__£lf_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

47 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

49 
ucc__£lf_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_self_team_t);

50 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_TEAM_CTX
(
‹am
);

51 
mt_n
 = 0, 
i
;

52 
ucc_memÜy_ty³_t
 
mem_ty³s
[
UCC_MEMORY_TYPE_LAST
];

53 
ucc_cŞl_scÜe_t
 *
scÜe
;

54 
ucc_¡©us_t
 
¡©us
;

55 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

57 
i
 = 0; i < 
UCC_MEMORY_TYPE_LAST
; i++) {

58 
mem_ty³s
[
mt_n
++] = (
ucc_memÜy_ty³_t
)
i
;

61 
‹am_šfo
.
®g_â
 = 
NULL
;

62 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_TL_SELF_DEFAULT_SCORE
;

63 
‹am_šfo
.
š™
 = 
ucc__£lf_cŞl_š™
;

64 
‹am_šfo
.
num_mem_ty³s
 = 
mt_n
;

65 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = 
mem_ty³s
;

66 
‹am_šfo
.
suµÜ‹d_cŞls
 = 
UCC_TL_SELF_SUPPORTED_COLLS
;

67 
‹am_šfo
.
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

69 
¡©us
 = 
	`ucc_cŞl_scÜe_bud_deçuÉ
(

70 
_‹am
, 
UCC_TL_SELF_DEFAULT_SCORE
, 
ucc__£lf_cŞl_š™
,

71 
UCC_TL_SELF_SUPPORTED_COLLS
, 
mem_ty³s
, 
mt_n
, &
scÜe
);

73 ià(
UCC_OK
 !ğ
¡©us
) {

74  
¡©us
;

77 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

78 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

79 &
‹am
->
su³r
.su³r, 
scÜe
);

80 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

81 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

82 
”r
;

86 *
scÜe_p
 = 
scÜe
;

87  
UCC_OK
;

88 
”r
:

89 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

90  
¡©us
;

91 
	}
}

	@src/components/tl/sharp/tl_sharp.c

7 
	~"_sh¬p.h
"

8 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

10 
ucc_¡©us_t
 
ucc__sh¬p_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

11 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
);

13 
ucc_¡©us_t
 
ucc__sh¬p_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

15 
ucc_¡©us_t
 
ucc__sh¬p_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

16 
ucc_ba£_ùx_©Œ_t
 *
ba£_©Œ
);

18 
ucc_¡©us_t
 
ucc__sh¬p_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

19 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
);

21 
ucc_¡©us_t
 
ucc__sh¬p_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

22 
ucc_mem_m­__t
 *
_h
);

24 
ucc_¡©us_t
 
ucc__sh¬p_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

25 
ucc_mem_m­_mode_t
 
mode
, 
ucc_mem_m­__t
 *
_h
, **
·ck_bufãr
);

27 
ucc_cÚfig_f›ld_t
 
	gucc__sh¬p_lib_cÚfig_bË
[] = {

28 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__sh¬p_lib_cÚfig_t
, 
su³r
),

29 
UCC_CONFIG_TYPE_TABLE
(
ucc__lib_cÚfig_bË
)},

33 
ucc_off£tof
(
ucc__sh¬p_lib_cÚfig_t
, 
u£_š‹º®_oob
),

34 
UCC_CONFIG_TYPE_TERNARY
},

36 {
NULL
}};

38 
ucc_cÚfig_f›ld_t
 
	gucc__sh¬p_cÚ‹xt_cÚfig_bË
[] = {

39 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
su³r
),

40 
UCC_CONFIG_TYPE_TABLE
(
ucc__cÚ‹xt_cÚfig_bË
)},

44 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
dev_li¡
),

45 
UCC_CONFIG_TYPE_STRING
},

49 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
u£_rÿche
),

50 
UCC_CONFIG_TYPE_BOOL
},

54 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
»g_th»shŞd
),

55 
UCC_CONFIG_TYPE_MEMUNITS
},

59 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
u´og»ss_num_pŞls
),

60 
UCC_CONFIG_TYPE_UINT
},

64 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
cÚ‹xt_³r_‹am
),

65 
UCC_CONFIG_TYPE_BOOL
},

67 #ià
HAVE_DECL_SHARP_COLL_DISABLE_LAZY_GROUP_RESOURCE_ALLOC


70 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
’abË_Ïzy_group_®loc
),

71 
UCC_CONFIG_TYPE_BOOL
},

76 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
¿nd_£ed
),

77 
UCC_CONFIG_TYPE_UINT
},

81 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
‹am_max_µn
),

82 
UCC_CONFIG_TYPE_UINT
},

86 
ucc_off£tof
(
ucc__sh¬p_cÚ‹xt_cÚfig_t
, 
u£_muÉi_chªÃl
),

87 
UCC_CONFIG_TYPE_BOOL
},

89 {
NULL
}};

91 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__sh¬p_lib_t
, 
ucc_ba£_lib_t
,

92 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

93 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

95 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__sh¬p_lib_t
, 
ucc_ba£_lib_t
);

97 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__sh¬p_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

98 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

99 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

101 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__sh¬p_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

103 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__sh¬p_‹am_t
, 
ucc_ba£_‹am_t
,

104 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

106 
ucc_¡©us_t
 
ucc__sh¬p_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
);

108 
ucc_¡©us_t
 
ucc__sh¬p_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
);

110 
ucc_¡©us_t
 
ucc__sh¬p_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

111 
ucc_ba£_‹am_t
 *
‹am
,

112 
ucc_cŞl_sk_t
 **
sk
);

114 
ucc_¡©us_t
 
ucc__sh¬p_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

115 
ucc_cŞl_scÜe_t
 **
scÜe_p
);

116 
UCC_TL_IFACE_DECLARE
(
sh¬p
, 
SHARP
);

118 
ucc_¡©us_t
 
ucc__sh¬p_cÚ‹xt_ü—‹_•og
(
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
);

120 
ucc_¡©us_t
 
	$sh¬p_¡©us_to_ucc_¡©us
(
¡©us
)

122 
¡©us
) {

123 
SHARP_COLL_SUCCESS
:

124  
UCC_OK
;

125 
SHARP_COLL_ENOMEM
:

126  
UCC_ERR_NO_MEMORY
;

127 
SHARP_COLL_ENOT_SUPP
:

128  
UCC_ERR_NOT_SUPPORTED
;

129 
SHARP_COLL_EINVAL
:

130  
UCC_ERR_INVALID_PARAM
;

131 
SHARP_COLL_ENO_RESOURCE
:

132  
UCC_ERR_NO_RESOURCE
;

136  
UCC_ERR_NO_MESSAGE
;

137 
	}
}

139 
__©Œibu‹__
((
cÚ¡ruùÜ
)è
	$_sh¬p_içû_š™
()

141 
ucc__sh¬p
.
su³r
.
cÚ‹xt
.
ü—‹_•og
 = 
ucc__sh¬p_cÚ‹xt_ü—‹_•og
;

142 
	}
}

	@src/components/tl/sharp/tl_sharp.h

7 #iâdeà
UCC_TL_SHARP_H_


8 
	#UCC_TL_SHARP_H_


	)

10 
	~"compÚ’ts//ucc_.h
"

11 
	~"compÚ’ts//ucc__log.h
"

12 
	~"uts/ucc_mpoŞ.h
"

13 
	~"uts/ucc_rÿche.h
"

15 
	~<sh¬p/­i/sh¬p.h
>

16 
	~<lim™s.h
>

18 #iâdeà
UCC_TL_SHARP_DEFAULT_SCORE


19 
	#UCC_TL_SHARP_DEFAULT_SCORE
 30

	)

22 #ifdeà
HAVE_PROFILING_TL_SHARP


23 
	~"uts/´ofe/ucc_´ofe.h
"

25 
	~"uts/´ofe/ucc_´ofe_off.h
"

28 
	#UCC_TL_SHARP_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

29 
	#UCC_TL_SHARP_PROFILE_FUNC_VOID
 
UCC_PROFILE_FUNC_VOID


	)

30 
	#UCC_TL_SHARP_PROFILE_REQUEST_NEW
 
UCC_PROFILE_REQUEST_NEW


	)

31 
	#UCC_TL_SHARP_PROFILE_REQUEST_EVENT
 
UCC_PROFILE_REQUEST_EVENT


	)

32 
	#UCC_TL_SHARP_PROFILE_REQUEST_FREE
 
UCC_PROFILE_REQUEST_FREE


	)

34 
	succ__sh¬p_içû
 {

35 
ucc__içû_t
 
	msu³r
;

36 } 
	tucc__sh¬p_içû_t
;

38 
ucc__sh¬p_içû_t
 
ucc__sh¬p
;

40 
	succ__sh¬p_lib_cÚfig
 {

41 
ucc__lib_cÚfig_t
 
	msu³r
;

42 
	mu£_š‹º®_oob
;

43 } 
	tucc__sh¬p_lib_cÚfig_t
;

45 
	succ__sh¬p_cÚ‹xt_cÚfig
 {

46 
ucc__cÚ‹xt_cÚfig_t
 
	msu³r
;

47 
sh¬p_cŞl_cÚfig
 
	mcfg
;

48 *
	mdev_li¡
;

49 
	mu£_rÿche
;

50 
size_t
 
	m»g_th»shŞd
;

51 
	m¿nd_£ed
;

52 
	mu´og»ss_num_pŞls
;

53 
	mcÚ‹xt_³r_‹am
;

54 
	m’abË_Ïzy_group_®loc
;

55 
	m‹am_max_µn
;

56 
	mu£_muÉi_chªÃl
;

57 } 
	tucc__sh¬p_cÚ‹xt_cÚfig_t
;

59 
	succ__sh¬p_lib
 {

60 
ucc__lib_t
 
	msu³r
;

61 
ucc__sh¬p_lib_cÚfig_t
 
	mcfg
;

62 } 
	tucc__sh¬p_lib_t
;

63 
UCC_CLASS_DECLARE
(
ucc__sh¬p_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

64 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

66 
	succ__sh¬p_oob_ùx
 {

67 *
	mùx
;

69 
ucc_oob_cŞl_t
 *
	moob
;

70 
ucc_sub£t_t
 
	msub£t
;

72 } 
	tucc__sh¬p_oob_ùx_t
;

74 
	succ__sh¬p_»g
 {

75 *
	mmr
;

76 } 
	tucc__sh¬p_»g_t
;

78 
	succ__sh¬p_rÿche_»giÚ
 {

79 
ucc_rÿche_»giÚ_t
 
	msu³r
;

80 
ucc__sh¬p_»g_t
 
	m»g
;

81 } 
	tucc__sh¬p_rÿche_»giÚ_t
;

83 
	succ__sh¬p_cÚ‹xt
 {

84 
ucc__cÚ‹xt_t
 
	msu³r
;

85 
ucc_th»ad_mode_t
 
	mtm
;

86 
sh¬p_cŞl_cÚ‹xt
 *
	msh¬p_cÚ‹xt
;

87 
ucc__sh¬p_cÚ‹xt_cÚfig_t
 
	mcfg
;

88 
ucc_mpoŞ_t
 
	m»q_mp
;

89 
ucc__sh¬p_oob_ùx_t
 
	moob_ùx
;

90 
ucc_rÿche_t
 *
	mrÿche
;

91 
sh¬p_cŞl_ÿps
 
	msh¬p_ÿps
;

92 } 
	tucc__sh¬p_cÚ‹xt_t
;

93 
UCC_CLASS_DECLARE
(
ucc__sh¬p_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

94 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

96 
	succ__sh¬p_‹am
 {

97 
ucc__‹am_t
 
	msu³r
;

98 
sh¬p_cŞl_cÚ‹xt
 *
	msh¬p_cÚ‹xt
;

99 
ucc_rÿche_t
 *
	mrÿche
;

100 
sh¬p_cŞl_comm
 *
	msh¬p_comm
;

101 
ucc__sh¬p_oob_ùx_t
 
	moob_ùx
;

102 
ucc_tİo_t
 *
	mtİo
;

103 } 
	tucc__sh¬p_‹am_t
;

105 
	succ__sh¬p_sk
 {

106 
ucc_cŞl_sk_t
 
	msu³r
;

107 *
	m»q_hªdË
;

110 
ucc__sh¬p_»g_t
 *
	ms_mem_h
;

111 
ucc__sh¬p_»g_t
 *
	mr_mem_h
;

112 } 
	m®lg©h”
;

114 
ucc__sh¬p_»g_t
 *
	ms_mem_h
;

115 
ucc__sh¬p_»g_t
 *
	mr_mem_h
;

116 } 
	m®Ìeduû
;

118 
ucc__sh¬p_»g_t
 *
	ms_mem_h
;

119 
ucc__sh¬p_»g_t
 *
	mr_mem_h
;

120 } 
	m»duû_sÿ‰”
;

122 
ucc__sh¬p_»g_t
 *
	mmem_h
;

123 } 
	mbÿ¡
;

125 } 
	tucc__sh¬p_sk_t
;

127 
ucc_¡©us_t
 
ucc__sh¬p_cÚ‹xt_š™
(
ucc__sh¬p_cÚ‹xt_t
 *
sh¬p_ùx
,

128 
sh¬p_cŞl_cÚ‹xt
 **
cÚ‹xt
,

129 
ucc__sh¬p_oob_ùx_t
 *
oob_ùx
,

130 
ucc_tİo_t
 *
tİo
);

131 
ucc_¡©us_t
 
ucc__sh¬p_rÿche_ü—‹
(
sh¬p_cŞl_cÚ‹xt
 *
cÚ‹x
,

132 
ucc_rÿche_t
 **
rÿche
);

134 
ucc_¡©us_t
 
sh¬p_¡©us_to_ucc_¡©us
(
¡©us
);

136 
	#TASK_TEAM
(
_sk
) \

137 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
, 
ucc__sh¬p_‹am_t
))

	)

138 
	#TASK_CTX
(
_sk
) \

139 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
, 
ucc__sh¬p_cÚ‹xt_t
))

	)

140 
	#TASK_LIB
(
_sk
) \

141 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
->
lib
, 
ucc__sh¬p_lib_t
))

	)

142 
	#TASK_ARGS
(
_sk
è(_sk)->
su³r
.
b¬gs
.
¬gs


	)

144 
	#UCC_TL_BASIC_SHARP_SUPPORTED_COLLS
 \

145 (
UCC_COLL_TYPE_ALLREDUCE
 | 
UCC_COLL_TYPE_BARRIER
 | 
UCC_COLL_TYPE_BCAST
)

	)

148 
	#UCC_TL_SHARP_SUPPORTED_COLLS
 \

149 (
UCC_TL_BASIC_SHARP_SUPPORTED_COLLS
 | \

150 (
HAVE_DECL_SHARP_COLL_DO_REDUCE_SCATTER
 ? 
UCC_COLL_TYPE_REDUCE_SCATTER
 : 0) | \

151 (
HAVE_DECL_SHARP_COLL_DO_ALLGATHER
 ? 
UCC_COLL_TYPE_ALLGATHER
 : 0))

	)

153 
UCC_CLASS_DECLARE
(
ucc__sh¬p_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

154 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

156 
	#UCC_TL_SHARP_TEAM_LIB
(
_‹am
) \

157 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
->
lib
, 
ucc__sh¬p_lib_t
))

	)

	@src/components/tl/sharp/tl_sharp_coll.c

7 
	~"_sh¬p_cŞl.h
"

8 
	~"compÚ’ts/mc/ucc_mc.h
"

9 
	~"cÜe/ucc_“.h
"

10 
	~"uts/ucc_m©h.h
"

11 
	~"uts/ucc_cŞl_uts.h
"

12 
	~<sh¬p/­i/v”siÚ.h
>

13 
	~<sh¬p/­i/sh¬p_cŞl.h
>

18 
	#UCC_TL_SHARP_ALLGATHER_DEFAULT_ALG_SELECT_STR
 \

19 "®lg©h”:0-16k:0"

	)

21 
	#UCC_TL_SHARP_REDUCE_SCATTER_DEFAULT_ALG_SELECT_STR
 \

22 "»duû_sÿ‰”:0-16k:0"

	)

25 *
	gucc__sh¬p_deçuÉ_®g_£Ëù_¡r
[
UCC_TL_SHARP_N_DEFAULT_ALG_SELECT_STR
] = {

26 
UCC_TL_SHARP_ALLGATHER_DEFAULT_ALG_SELECT_STR
,

27 
UCC_TL_SHARP_REDUCE_SCATTER_DEFAULT_ALG_SELECT_STR
};

29 
sh¬p_d©©y³
 
	gucc_to_sh¬p_dty³
[] = {

30 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT16
)] = 
SHARP_DTYPE_SHORT
,

31 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT32
)] = 
SHARP_DTYPE_INT
,

32 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT64
)] = 
SHARP_DTYPE_LONG
,

33 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT128
)] = 
SHARP_DTYPE_NULL
,

34 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT16
)] = 
SHARP_DTYPE_UNSIGNED_SHORT
,

35 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT32
)] = 
SHARP_DTYPE_UNSIGNED
,

36 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT64
)] = 
SHARP_DTYPE_UNSIGNED_LONG
,

37 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT128
)] = 
SHARP_DTYPE_NULL
,

38 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT16
)] = 
SHARP_DTYPE_FLOAT_SHORT
,

39 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT32
)] = 
SHARP_DTYPE_FLOAT
,

40 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT64
)] = 
SHARP_DTYPE_DOUBLE
,

41 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT128
)] = 
SHARP_DTYPE_NULL
,

42 #ià
SHARP_API
 > 
SHARP_VERSION
(3, 0)

43 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT8
)] = (
sh¬p_d©©y³
)
SHARP_DTYPE_UNKNOWN
,

44 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT8
)] = (
sh¬p_d©©y³
)
SHARP_DTYPE_UNKNOWN
,

45 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_BFLOAT16
)] = (
sh¬p_d©©y³
)
SHARP_DTYPE_UNKNOWN
,

47 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT8
)] = 
SHARP_DTYPE_NULL
,

48 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT8
)] = 
SHARP_DTYPE_NULL
,

49 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_BFLOAT16
)] = 
SHARP_DTYPE_NULL
,

51 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT32_COMPLEX
)] = 
SHARP_DTYPE_NULL
,

52 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT64_COMPLEX
)] = 
SHARP_DTYPE_NULL
,

53 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT128_COMPLEX
)] = 
SHARP_DTYPE_NULL
,

56 
sh¬p_»duû_İ
 
	gucc_to_sh¬p_»duû_İ
[] = {

57 [
UCC_OP_SUM
] = 
SHARP_OP_SUM
,

58 [
UCC_OP_PROD
] = 
SHARP_OP_NULL
,

59 [
UCC_OP_MAX
] = 
SHARP_OP_MAX
,

60 [
UCC_OP_MIN
] = 
SHARP_OP_MIN
,

61 [
UCC_OP_LAND
] = 
SHARP_OP_LAND
,

62 [
UCC_OP_LOR
] = 
SHARP_OP_LOR
,

63 [
UCC_OP_LXOR
] = 
SHARP_OP_LXOR
,

64 [
UCC_OP_BAND
] = 
SHARP_OP_BAND
,

65 [
UCC_OP_BOR
] = 
SHARP_OP_BOR
,

66 [
UCC_OP_BXOR
] = 
SHARP_OP_BXOR
,

67 [
UCC_OP_MAXLOC
] = 
SHARP_OP_MAXLOC
,

68 [
UCC_OP_MINLOC
] = 
SHARP_OP_MINLOC
,

69 [
UCC_OP_AVG
] = 
SHARP_OP_NULL
,

72 
sh¬p_d©a_memÜy_ty³
 
	gucc_to_sh¬p_memty³
[] = {

73 [
UCC_MEMORY_TYPE_HOST
] = 
SHARP_MEM_TYPE_HOST
,

74 [
UCC_MEMORY_TYPE_CUDA
] = 
SHARP_MEM_TYPE_CUDA
,

75 [
UCC_MEMORY_TYPE_CUDA_MANAGED
] = 
SHARP_MEM_TYPE_LAST
,

76 [
UCC_MEMORY_TYPE_ROCM
] = 
SHARP_MEM_TYPE_LAST
,

77 [
UCC_MEMORY_TYPE_ROCM_MANAGED
] = 
SHARP_MEM_TYPE_LAST
,

78 [
UCC_MEMORY_TYPE_LAST
] = 
SHARP_MEM_TYPE_LAST
,

81 
šlše
 
ucc_¡©us_t
 
	$ucc__sh¬p_¡©us_to_ucc
(
¡©us
)

83 
¡©us
) {

84 
SHARP_COLL_SUCCESS
:

85  
UCC_OK
;

86 
SHARP_COLL_ENOMEM
:

87  
UCC_ERR_NO_MEMORY
;

88 
SHARP_COLL_ENOT_SUPP
:

89  
UCC_ERR_NOT_SUPPORTED
;

90 
SHARP_COLL_EINVAL
:

91  
UCC_ERR_INVALID_PARAM
;

92 
SHARP_COLL_ENO_RESOURCE
:

93  
UCC_ERR_NO_RESOURCE
;

97  
UCC_ERR_NO_MESSAGE
;

98 
	}
}

100 
ucc__sh¬p_»g_t
 
	gucc__sh¬p_»g_nuÎ
 = { .
mr
 = 
NULL
 };

102 
ucc_¡©us_t


103 
	$ucc__sh¬p_mem_»gi¡”
(
ucc__sh¬p_cÚ‹xt_t
 *
ùx
, 
ucc__sh¬p_‹am_t
 *
‹am
,

104 *
addr
, 
size_t
 
Ëngth
, 
ucc__sh¬p_»g_t
 **
»g
)

106 
ucc_rÿche_»giÚ_t
 *
¼egiÚ
;

107 
ucc__sh¬p_rÿche_»giÚ_t
 *
»giÚ
;

108 
ucc_¡©us_t
 
¡©us
;

109 
ucc__sh¬p_»g_t
 *
r
;

110 
ucc_rÿche_t
 *
rÿche
;

111 
sh¬p_cŞl_cÚ‹xt
 *
sh¬p_ùx
;

113 ià(
Ëngth
 < 
ùx
->
cfg
.
»g_th»shŞd
) {

114 *
»g
 = &
ucc__sh¬p_»g_nuÎ
;

115  
UCC_OK
;

118 
sh¬p_ùx
 = 
‹am
->
sh¬p_cÚ‹xt
;

119 
rÿche
 = 
‹am
->rcache;

121 ià(
rÿche
) {

122 
¡©us
 = 
	`ucc_rÿche_g‘
(
rÿche
, (*)
addr
, 
Ëngth
, 
NULL
,

123 &
¼egiÚ
);

124 ià(
¡©us
 !ğ
UCC_OK
) {

125 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "ucc_rcache_get failed");

126  
UCC_ERR_INVALID_PARAM
;

128 
»giÚ
 = 
	`ucc_d”ived_of
(
¼egiÚ
, 
ucc__sh¬p_rÿche_»giÚ_t
);

129 *
»g
 = &
»giÚ
->reg;

131 
r
 = 
	`ucc_m®loc
((
ucc__sh¬p_»g_t
), "sharp„eg");

132 ià(!
r
) {

133 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo‡llocate„eg data");

134  
UCC_ERR_NO_MEMORY
;

137 
	`sh¬p_cŞl_»g_mr
(
sh¬p_ùx
, 
addr
, 
Ëngth
, &
r
->
mr
);

138 *
»g
 = 
r
;

141  
UCC_OK
;

142 
	}
}

144 
ucc_¡©us_t


145 
	$ucc__sh¬p_mem_d”egi¡”
(
ucc__sh¬p_‹am_t
 *
‹am
, 
ucc__sh¬p_»g_t
 *
»g
)

147 
ucc__sh¬p_rÿche_»giÚ_t
 *
»giÚ
;

148 
ucc_rÿche_t
 *
rÿche
;

149 
sh¬p_cŞl_cÚ‹xt
 *
sh¬p_ùx
;

151 ià(
»g
 =ğ&
ucc__sh¬p_»g_nuÎ
) {

152  
UCC_OK
;

155 
sh¬p_ùx
 = 
‹am
->
sh¬p_cÚ‹xt
;

156 
rÿche
 = 
‹am
->rcache;

158 ià(
rÿche
) {

159 
»giÚ
 = 
	`ucc_cÚš”_of
(
»g
, 
ucc__sh¬p_rÿche_»giÚ_t
,„eg);

160 
	`ucc_rÿche_»giÚ_put
(
rÿche
, &
»giÚ
->
su³r
);

162 
	`sh¬p_cŞl_d”eg_mr
(
sh¬p_ùx
, 
»g
->
mr
);

163 
	`ucc_ä“
(
»g
);

166  
UCC_OK
;

167 
	}
}

169 
	$ucc__sh¬p_cŞËùive_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

171 
ucc__sh¬p_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_sharp_task_t);

172 
com¶‘ed
;

173 
ucc_¡©us_t
 
¡1
, 
¡2
;

175 ià(
sk
->
»q_hªdË
 !ğ
NULL
) {

176 
com¶‘ed
 = 
	`sh¬p_cŞl_»q_‹¡
(
sk
->
»q_hªdË
);

177 ià(
com¶‘ed
) {

178 
¡1
 = 
UCC_OK
; 
¡2
 = UCC_OK;

179 
	`TASK_ARGS
(
sk
).
cŞl_ty³
){

180 
UCC_COLL_TYPE_ALLREDUCE
:

181 ià(!
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

182 
¡1
 = 
	`ucc__sh¬p_mem_d”egi¡”
(
	`TASK_TEAM
(
sk
),

183 
sk
->
®Ìeduû
.
s_mem_h
);

185 
¡2
 = 
	`ucc__sh¬p_mem_d”egi¡”
(
	`TASK_TEAM
(
sk
),

186 
sk
->
®Ìeduû
.
r_mem_h
);

188 
UCC_COLL_TYPE_BCAST
:

189 
¡1
 = 
	`ucc__sh¬p_mem_d”egi¡”
(
	`TASK_TEAM
(
sk
),

190 
sk
->
bÿ¡
.
mem_h
);

192 
UCC_COLL_TYPE_ALLGATHER
:

193 ià(!
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

194 
¡1
 = 
	`ucc__sh¬p_mem_d”egi¡”
(
	`TASK_TEAM
(
sk
),

195 
sk
->
®lg©h”
.
s_mem_h
);

197 
¡2
 = 
	`ucc__sh¬p_mem_d”egi¡”
(
	`TASK_TEAM
(
sk
),

198 
sk
->
®lg©h”
.
r_mem_h
);

200 
UCC_COLL_TYPE_REDUCE_SCATTER
:

201 ià(!
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

202 
¡1
 = 
	`ucc__sh¬p_mem_d”egi¡”
(
	`TASK_TEAM
(
sk
),

203 
sk
->
»duû_sÿ‰”
.
s_mem_h
);

205 
¡2
 = 
	`ucc__sh¬p_mem_d”egi¡”
(
	`TASK_TEAM
(
sk
),

206 
sk
->
»duû_sÿ‰”
.
r_mem_h
);

211 ià(
	`ucc_uÆik–y
(
¡1
 !ğ
UCC_OK
 || 
¡2
 != UCC_OK)) {

212 
	`_w¬n
(
	`UCC_TASK_LIB
(
sk
), "ucc_tl_sharp_mem_deregister failed");

214 
	`sh¬p_cŞl_»q_ä“
(
sk
->
»q_hªdË
);

215 
cŞl_sk
->
¡©us
 = 
UCC_OK
;

216 
	`UCC_TL_SHARP_PROFILE_REQUEST_EVENT
(
cŞl_sk
,

220 
	}
}

222 
ucc_¡©us_t
 
	$ucc__sh¬p_b¬r›r_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

224 
ucc__sh¬p_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_sharp_task_t);

225 
ucc__sh¬p_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

226 
»t
;

228 
	`UCC_TL_SHARP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "sharp_barrier_start", 0);

230 
»t
 = 
	`sh¬p_cŞl_do_b¬r›r_nb
(
‹am
->
sh¬p_comm
, &
sk
->
»q_hªdË
);

231 ià(
	`ucc_uÆik–y
(
»t
 !ğ
SHARP_COLL_SUCCESS
)) {

232 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "sharp_coll_do_barrier_nb failed:%s",

233 
	`sh¬p_cŞl_¡»¼Ü
(
»t
));

234 
cŞl_sk
->
¡©us
 = 
	`ucc__sh¬p_¡©us_to_ucc
(
»t
);

235  
	`ucc_sk_com¶‘e
(
cŞl_sk
);

237 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

239  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

240 
	}
}

242 
ucc_¡©us_t
 
	$ucc__sh¬p_®Ìeduû_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

244 
ucc__sh¬p_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_sharp_task_t);

245 
ucc__sh¬p_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

246 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

247 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

248 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

249 
sh¬p_cŞl_»duû_¥ec
 
»duû_¥ec
;

250 
sh¬p_d©©y³
 
sh¬p_ty³
;

251 
sh¬p_»duû_İ
 
İ_ty³
;

252 
size_t
 
d©a_size
;

253 
»t
;

255 
	`UCC_TL_SHARP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "sharp_allreduce_start", 0);

257 
sh¬p_ty³
 = 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
dt
)];

258 
İ_ty³
 = 
ucc_to_sh¬p_»duû_İ
[
¬gs
->
İ
];

259 
d©a_size
 = 
	`ucc_dt_size
(
dt
è* 
couÁ
;

261 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

262 
	`ucc__sh¬p_mem_»gi¡”
(
	`TASK_CTX
(
sk
), 
‹am
, 
¬gs
->
¤c
.
šfo
.
bufãr
,
d©a_size
,

263 &
sk
->
®Ìeduû
.
s_mem_h
);

265 
	`ucc__sh¬p_mem_»gi¡”
(
	`TASK_CTX
(
sk
), 
‹am
, 
¬gs
->
d¡
.
šfo
.
bufãr
, 
d©a_size
,

266 &
sk
->
®Ìeduû
.
r_mem_h
);

268 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

269 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
±r
 = 
¬gs
->
¤c
.
šfo
.buffer;

270 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
mem_hªdË
 = 
sk
->
®Ìeduû
.
s_mem_h
->
mr
;

271 
»duû_¥ec
.
sbuf_desc
.
mem_ty³
 = 
ucc_to_sh¬p_memty³
[
¬gs
->
¤c
.
šfo
.mem_type];

273 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
±r
 = 
¬gs
->
d¡
.
šfo
.buffer;

274 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
mem_hªdË
 = 
sk
->
®Ìeduû
.
r_mem_h
->
mr
;

275 
»duû_¥ec
.
sbuf_desc
.
mem_ty³
 = 
ucc_to_sh¬p_memty³
[
¬gs
->
d¡
.
šfo
.mem_type];

278 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
Ëngth
 = 
d©a_size
;

279 
»duû_¥ec
.
sbuf_desc
.
ty³
 = 
SHARP_DATA_BUFFER
;

280 
»duû_¥ec
.
rbuf_desc
.
bufãr
.
±r
 = 
¬gs
->
d¡
.
šfo
.buffer;

281 
»duû_¥ec
.
rbuf_desc
.
bufãr
.
Ëngth
 = 
d©a_size
;

282 
»duû_¥ec
.
rbuf_desc
.
bufãr
.
mem_hªdË
 = 
sk
->
®Ìeduû
.
r_mem_h
->
mr
;

283 
»duû_¥ec
.
rbuf_desc
.
ty³
 = 
SHARP_DATA_BUFFER
;

284 
»duû_¥ec
.
rbuf_desc
.
mem_ty³
 = 
ucc_to_sh¬p_memty³
[
¬gs
->
d¡
.
šfo
.mem_type];

285 
»duû_¥ec
.
aggr_mode
 = 
SHARP_AGGREGATION_NONE
;

286 
»duû_¥ec
.
Ëngth
 = 
couÁ
;

287 
»duû_¥ec
.
dty³
 = 
sh¬p_ty³
;

288 
»duû_¥ec
.
İ
 = 
İ_ty³
;

290 
»t
 = 
	`sh¬p_cŞl_do_®Ìeduû_nb
(
‹am
->
sh¬p_comm
, &
»duû_¥ec
, &
sk
->
»q_hªdË
);

291 ià(
	`ucc_uÆik–y
(
»t
 !ğ
SHARP_COLL_SUCCESS
)) {

292 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "sharp_coll_do_allreduce_nb failed:%s",

293 
	`sh¬p_cŞl_¡»¼Ü
(
»t
));

294 
cŞl_sk
->
¡©us
 = 
	`ucc__sh¬p_¡©us_to_ucc
(
»t
);

295  
	`ucc_sk_com¶‘e
(
cŞl_sk
);

297 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

299  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

300 
	}
}

302 
ucc_¡©us_t
 
	$ucc__sh¬p_bÿ¡_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

304 
ucc__sh¬p_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_sharp_task_t);

305 
ucc__sh¬p_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

306 
ucc_cŞl_¬gs_t
 * 
¬gs
 = &
	`TASK_ARGS
(
sk
);

307 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

308 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

309 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

310 
size_t
 
d©a_size
;

311 
sh¬p_cŞl_bÿ¡_¥ec
 
bÿ¡_¥ec
;

312 
»t
;

314 
	`UCC_TL_SHARP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "sharp_bcast_start", 0);

316 
d©a_size
 = 
	`ucc_dt_size
(
dt
è* 
couÁ
;

318 
	`ucc__sh¬p_mem_»gi¡”
(
	`TASK_CTX
(
sk
), 
‹am
, 
¬gs
->
¤c
.
šfo
.
bufãr
,

319 
d©a_size
, &
sk
->
bÿ¡
.
mem_h
);

321 
bÿ¡_¥ec
.
size
 = 
d©a_size
;

322 
bÿ¡_¥ec
.
roÙ
 =„oot;

323 
bÿ¡_¥ec
.
buf_desc
.
ty³
 = 
SHARP_DATA_BUFFER
;

324 
bÿ¡_¥ec
.
buf_desc
.
bufãr
.
±r
 = 
¬gs
->
¤c
.
šfo
.buffer;

325 
bÿ¡_¥ec
.
buf_desc
.
bufãr
.
Ëngth
 = 
d©a_size
;

326 
bÿ¡_¥ec
.
buf_desc
.
bufãr
.
mem_hªdË
 = 
sk
->
bÿ¡
.
mem_h
->
mr
;

327 
bÿ¡_¥ec
.
buf_desc
.
mem_ty³
 =

328 
ucc_to_sh¬p_memty³
[
¬gs
->
¤c
.
šfo
.
mem_ty³
];

330 
»t
 = 
	`sh¬p_cŞl_do_bÿ¡_nb
(
‹am
->
sh¬p_comm
, &
bÿ¡_¥ec
,

331 &
sk
->
»q_hªdË
);

333 ià(
	`ucc_uÆik–y
(
»t
 !ğ
SHARP_COLL_SUCCESS
)) {

334 ià(
»t
 =ğ
SHARP_COLL_ENOT_SUPP
) {

335 
	`_debug
(
	`UCC_TASK_LIB
(
sk
),

337 
d©a_size
);

339 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "sharp_coll_do_bcast_nb failed:%s",

340 
	`sh¬p_cŞl_¡»¼Ü
(
»t
));

342 
cŞl_sk
->
¡©us
 = 
	`ucc__sh¬p_¡©us_to_ucc
(
»t
);

343  
	`ucc_sk_com¶‘e
(
cŞl_sk
);

345 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

347  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

348 
	}
}

350 #ià
HAVE_DECL_SHARP_COLL_DO_REDUCE_SCATTER


351 
ucc_¡©us_t
 
	$ucc__sh¬p_»duû_sÿ‰”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

353 
ucc__sh¬p_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_sharp_task_t);

354 
ucc__sh¬p_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

355 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

356 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

357 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

358 
sh¬p_cŞl_»duû_¥ec
 
»duû_¥ec
;

359 
sh¬p_d©©y³
 
sh¬p_ty³
;

360 
sh¬p_»duû_İ
 
İ_ty³
;

361 
size_t
 
¤c_d©a_size
, 
d¡_d©a_size
;

362 
»t
;

364 
	`UCC_TL_SHARP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "sharp_reduce_scatter_start",

367 
sh¬p_ty³
 = 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
dt
)];

368 
İ_ty³
 = 
ucc_to_sh¬p_»duû_İ
[
¬gs
->
İ
];

369 
¤c_d©a_size
 = 
	`ucc_dt_size
(
dt
è* 
couÁ
 * 
	`UCC_TL_TEAM_SIZE
(
‹am
);

370 
d¡_d©a_size
 = 
	`ucc_dt_size
(
dt
è* 
couÁ
;

372 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

373 
	`ucc__sh¬p_mem_»gi¡”
(
	`TASK_CTX
(
sk
), 
‹am
, 
¬gs
->
¤c
.
šfo
.
bufãr
,

374 
¤c_d©a_size
, &
sk
->
»duû_sÿ‰”
.
s_mem_h
);

376 
	`ucc__sh¬p_mem_»gi¡”
(
	`TASK_CTX
(
sk
), 
‹am
, 
¬gs
->
d¡
.
šfo
.
bufãr
,

377 
d¡_d©a_size
, &
sk
->
»duû_sÿ‰”
.
r_mem_h
);

379 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

380 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
±r
 = 
¬gs
->
¤c
.
šfo
.buffer;

381 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
mem_hªdË
 =

382 
sk
->
»duû_sÿ‰”
.
s_mem_h
->
mr
;

383 
»duû_¥ec
.
sbuf_desc
.
mem_ty³
 =

384 
ucc_to_sh¬p_memty³
[
¬gs
->
¤c
.
šfo
.
mem_ty³
];

386 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
±r
 = 
¬gs
->
d¡
.
šfo
.buffer;

387 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
mem_hªdË
 =

388 
sk
->
»duû_sÿ‰”
.
r_mem_h
->
mr
;

389 
»duû_¥ec
.
sbuf_desc
.
mem_ty³
 =

390 
ucc_to_sh¬p_memty³
[
¬gs
->
d¡
.
šfo
.
mem_ty³
];

393 
»duû_¥ec
.
sbuf_desc
.
bufãr
.
Ëngth
 = 
¤c_d©a_size
;

394 
»duû_¥ec
.
sbuf_desc
.
ty³
 = 
SHARP_DATA_BUFFER
;

395 
»duû_¥ec
.
rbuf_desc
.
bufãr
.
±r
 = 
¬gs
->
d¡
.
šfo
.buffer;

396 
»duû_¥ec
.
rbuf_desc
.
bufãr
.
Ëngth
 = 
d¡_d©a_size
;

397 
»duû_¥ec
.
rbuf_desc
.
bufãr
.
mem_hªdË
 = 
sk
->
»duû_sÿ‰”
.
r_mem_h
->
mr
;

398 
»duû_¥ec
.
rbuf_desc
.
ty³
 = 
SHARP_DATA_BUFFER
;

399 
»duû_¥ec
.
rbuf_desc
.
mem_ty³
 =

400 
ucc_to_sh¬p_memty³
[
¬gs
->
d¡
.
šfo
.
mem_ty³
];

401 
»duû_¥ec
.
aggr_mode
 = 
SHARP_AGGREGATION_NONE
;

402 
»duû_¥ec
.
Ëngth
 = 
couÁ
;

403 
»duû_¥ec
.
dty³
 = 
sh¬p_ty³
;

404 
»duû_¥ec
.
İ
 = 
İ_ty³
;

405 
»duû_¥ec
.
off£t
 = 0;

407 
»t
 = 
	`sh¬p_cŞl_do_»duû_sÿ‰”_nb
(
‹am
->
sh¬p_comm
, &
»duû_¥ec
,

408 &
sk
->
»q_hªdË
);

409 ià(
»t
 !ğ
SHARP_COLL_SUCCESS
) {

410 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

412 
	`sh¬p_cŞl_¡»¼Ü
(
»t
));

413 
cŞl_sk
->
¡©us
 = 
	`ucc__sh¬p_¡©us_to_ucc
(
»t
);

414  
	`ucc_sk_com¶‘e
(
cŞl_sk
);

416 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

418  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

419 
	}
}

421 
ucc_¡©us_t
 
	$ucc__sh¬p_»duû_sÿ‰”_š™
(
ucc__sh¬p_sk_t
 *
sk
)

423 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

425 ià(!(
	`TASK_CTX
(
sk
)->
sh¬p_ÿps
.
suµÜt_mask
.
ã©u»_mask
 & 
SHARP_FEATURE_SAT
)) {

426  
UCC_ERR_NOT_SUPPORTED
;

429 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
, 
UCC_RANK_INVALID
)) {

430  
UCC_ERR_NOT_SUPPORTED
;

433 ià((!
	`UCC_IS_INPLACE
(*
¬gs
) &&

434 
ucc_to_sh¬p_memty³
[
¬gs
->
¤c
.
šfo
.
mem_ty³
] =ğ
SHARP_MEM_TYPE_LAST
) ||

435 
ucc_to_sh¬p_memty³
[
¬gs
->
d¡
.
šfo
.
mem_ty³
] =ğ
SHARP_MEM_TYPE_LAST
 ||

436 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)] ==

437 
SHARP_DTYPE_NULL
 ||

438 
ucc_to_sh¬p_»duû_İ
[
¬gs
->
İ
] =ğ
SHARP_OP_NULL
) {

439  
UCC_ERR_NOT_SUPPORTED
;

442 
sk
->
su³r
.
po¡
 = 
ucc__sh¬p_»duû_sÿ‰”_¡¬t
;

443 
sk
->
su³r
.
´og»ss
 = 
ucc__sh¬p_cŞËùive_´og»ss
;

444  
UCC_OK
;

445 
	}
};

448 
ucc_¡©us_t
 
	$ucc__sh¬p_®Ìeduû_š™
(
ucc__sh¬p_sk_t
 *
sk
)

450 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

452 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
, 
UCC_RANK_INVALID
)) {

453  
UCC_ERR_NOT_SUPPORTED
;

456 ià((!
	`UCC_IS_INPLACE
(*
¬gs
) &&

457 
ucc_to_sh¬p_memty³
[
¬gs
->
¤c
.
šfo
.
mem_ty³
] =ğ
SHARP_MEM_TYPE_LAST
) ||

458 
ucc_to_sh¬p_memty³
[
¬gs
->
d¡
.
šfo
.
mem_ty³
] =ğ
SHARP_MEM_TYPE_LAST
 ||

459 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)] =ğ
SHARP_DTYPE_NULL
 ||

460 
ucc_to_sh¬p_»duû_İ
[
¬gs
->
İ
] =ğ
SHARP_OP_NULL
) {

461  
UCC_ERR_NOT_SUPPORTED
;

464 
sk
->
su³r
.
po¡
 = 
ucc__sh¬p_®Ìeduû_¡¬t
;

465 
sk
->
su³r
.
´og»ss
 = 
ucc__sh¬p_cŞËùive_´og»ss
;

466  
UCC_OK
;

467 
	}
}

469 
ucc_¡©us_t
 
	$ucc__sh¬p_bÿ¡_š™
(
ucc__sh¬p_sk_t
 *
sk
)

471 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

472 
size_t
 
d©a_size
;

474 
d©a_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
è*‡rgs->¤c.šfo.
couÁ
;

478 ià((
ucc_to_sh¬p_memty³
[
¬gs
->
¤c
.
šfo
.
mem_ty³
] =ğ
SHARP_MEM_TYPE_LAST
) ||

479 !
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
, 
UCC_RANK_INVALID
) ||

480 ((
d©a_size
 % 2 != 0) &&

481 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
UCC_DT_INT8
)] =ğ
SHARP_DTYPE_NULL
)) {

482  
UCC_ERR_NOT_SUPPORTED
;

485 
sk
->
su³r
.
po¡
 = 
ucc__sh¬p_bÿ¡_¡¬t
;

486 
sk
->
su³r
.
´og»ss
 = 
ucc__sh¬p_cŞËùive_´og»ss
;

487  
UCC_OK
;

488 
	}
}

490 
ucc_¡©us_t
 
	$ucc__sh¬p_b¬r›r_š™
(
ucc__sh¬p_sk_t
 *
sk
)

492 
sk
->
su³r
.
po¡
 = 
ucc__sh¬p_b¬r›r_¡¬t
;

493 
sk
->
su³r
.
´og»ss
 = 
ucc__sh¬p_cŞËùive_´og»ss
;

494  
UCC_OK
;

495 
	}
};

497 #ià
HAVE_DECL_SHARP_COLL_DO_ALLGATHER


498 
ucc_¡©us_t
 
	$ucc__sh¬p_®lg©h”_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

500 
ucc__sh¬p_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_sharp_task_t);

501 
ucc__sh¬p_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

502 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

503 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

504 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

505 
sh¬p_cŞl_g©h”_¥ec
 
g©h”_¥ec
;

506 
size_t
 
¤c_d©a_size
, 
d¡_d©a_size
;

507 
»t
;

508 
ucc_¡©us_t
 
¡©us
;

510 
	`UCC_TL_SHARP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "sharp_allgather_start", 0);

512 
¤c_d©a_size
 = 
	`ucc_dt_size
(
dt
è* 
couÁ
 / 
	`UCC_TL_TEAM_SIZE
(
‹am
);

513 
d¡_d©a_size
 = 
	`ucc_dt_size
(
dt
è* 
couÁ
;

515 
¡©us
 = 
	`ucc__sh¬p_mem_»gi¡”
(
	`TASK_CTX
(
sk
), 
‹am
, 
¬gs
->
d¡
.
šfo
.
bufãr
,

516 
d¡_d©a_size
, &
sk
->
®lg©h”
.
r_mem_h
);

517 ià(
¡©us
 !ğ
UCC_OK
) {

518 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "ucc_tl_sharp_mem_register failed "

520 
	`ucc_¡©us_¡ršg
(
¡©us
));

521  
¡©us
;

523 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

524 
¡©us
 = 
	`ucc__sh¬p_mem_»gi¡”
(
	`TASK_CTX
(
sk
), 
‹am
, 
¬gs
->
¤c
.
šfo
.
bufãr
,

525 
¤c_d©a_size
, &
sk
->
®lg©h”
.
s_mem_h
);

526 ià(
¡©us
 !ğ
UCC_OK
) {

527 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "ucc_tl_sharp_mem_register failed "

529 
	`ucc_¡©us_¡ršg
(
¡©us
));

530  
¡©us
;

534 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

535 
g©h”_¥ec
.
sbuf_desc
.
bufãr
.
±r
 = 
¬gs
->
¤c
.
šfo
.buffer;

536 
g©h”_¥ec
.
sbuf_desc
.
bufãr
.
mem_hªdË
 = 
sk
->
®lg©h”
.
s_mem_h
->
mr
;

537 
g©h”_¥ec
.
sbuf_desc
.
mem_ty³
 =

538 
ucc_to_sh¬p_memty³
[
¬gs
->
¤c
.
šfo
.
mem_ty³
];

540 
g©h”_¥ec
.
sbuf_desc
.
bufãr
.
±r
 = 
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.buffer,

541 
	`UCC_TL_TEAM_RANK
(
‹am
) *

542 
¤c_d©a_size
);

543 
g©h”_¥ec
.
sbuf_desc
.
bufãr
.
mem_hªdË
 = 
sk
->
®lg©h”
.
r_mem_h
->
mr
;

544 
g©h”_¥ec
.
sbuf_desc
.
mem_ty³
 =

545 
ucc_to_sh¬p_memty³
[
¬gs
->
d¡
.
šfo
.
mem_ty³
];

547 
g©h”_¥ec
.
sbuf_desc
.
bufãr
.
Ëngth
 = 
¤c_d©a_size
;

548 
g©h”_¥ec
.
sbuf_desc
.
ty³
 = 
SHARP_DATA_BUFFER
;

550 
g©h”_¥ec
.
rbuf_desc
.
bufãr
.
±r
 = 
¬gs
->
d¡
.
šfo
.buffer;

551 
g©h”_¥ec
.
rbuf_desc
.
bufãr
.
Ëngth
 = 
d¡_d©a_size
;

552 
g©h”_¥ec
.
rbuf_desc
.
bufãr
.
mem_hªdË
 = 
sk
->
®lg©h”
.
r_mem_h
->
mr
;

553 
g©h”_¥ec
.
rbuf_desc
.
ty³
 = 
SHARP_DATA_BUFFER
;

554 
g©h”_¥ec
.
rbuf_desc
.
mem_ty³
 =

555 
ucc_to_sh¬p_memty³
[
¬gs
->
d¡
.
šfo
.
mem_ty³
];

556 
g©h”_¥ec
.
off£t
 = 0;

557 
g©h”_¥ec
.
dty³
 = 
SHARP_DTYPE_INT8
;

559 
»t
 = 
	`sh¬p_cŞl_do_®lg©h”_nb
(
‹am
->
sh¬p_comm
, &
g©h”_¥ec
,

560 &
sk
->
»q_hªdË
);

561 ià(
»t
 !ğ
SHARP_COLL_SUCCESS
) {

562 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

564 
	`sh¬p_cŞl_¡»¼Ü
(
»t
));

565 
cŞl_sk
->
¡©us
 = 
	`ucc__sh¬p_¡©us_to_ucc
(
»t
);

566  
	`ucc_sk_com¶‘e
(
cŞl_sk
);

568 
cŞl_sk
->
¡©us
 = 
UCC_INPROGRESS
;

570  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

571 
	}
}

573 
ucc_¡©us_t
 
	$ucc__sh¬p_®lg©h”_š™
(
ucc__sh¬p_sk_t
 *
sk
)

575 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

577 ià(!(
	`TASK_CTX
(
sk
)->
sh¬p_ÿps
.
suµÜt_mask
.
ã©u»_mask
 & 
SHARP_FEATURE_SAT
)) {

578  
UCC_ERR_NOT_SUPPORTED
;

581 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
, 
UCC_RANK_INVALID
)) {

582  
UCC_ERR_NOT_SUPPORTED
;

585 ià((!
	`UCC_IS_INPLACE
(*
¬gs
) &&

586 
ucc_to_sh¬p_memty³
[
¬gs
->
¤c
.
šfo
.
mem_ty³
] =ğ
SHARP_MEM_TYPE_LAST
) ||

587 
ucc_to_sh¬p_memty³
[
¬gs
->
d¡
.
šfo
.
mem_ty³
] =ğ
SHARP_MEM_TYPE_LAST
 ||

588 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
¬gs
->
d¡
.
šfo
.
d©©y³
)] ==

589 
SHARP_DTYPE_NULL
) {

590  
UCC_ERR_NOT_SUPPORTED
;

592 
sk
->
®lg©h”
.
s_mem_h
 = 
NULL
;

593 
sk
->
®lg©h”
.
r_mem_h
 = 
NULL
;

594 
sk
->
su³r
.
po¡
 = 
ucc__sh¬p_®lg©h”_¡¬t
;

595 
sk
->
su³r
.
´og»ss
 = 
ucc__sh¬p_cŞËùive_´og»ss
;

596  
UCC_OK
;

597 
	}
};

	@src/components/tl/sharp/tl_sharp_coll.h

7 #iâdeà
UCC_TL_SHARP_COLL_H_


8 
	#UCC_TL_SHARP_COLL_H_


	)

10 
	~"_sh¬p.h
"

13 
	#SHARP_DTYPE_UNKNOWN
 0xFFFF

	)

15 
	#UCC_TL_SHARP_N_DEFAULT_ALG_SELECT_STR
 2

	)

17 *
ucc__sh¬p_deçuÉ_®g_£Ëù_¡r
[
UCC_TL_SHARP_N_DEFAULT_ALG_SELECT_STR
];

19 
sh¬p_d©©y³
 
ucc_to_sh¬p_dty³
[];

21 
ucc_¡©us_t
 
ucc__sh¬p_®Ìeduû_š™
(
ucc__sh¬p_sk_t
 *
sk
);

23 
ucc_¡©us_t
 
ucc__sh¬p_b¬r›r_š™
(
ucc__sh¬p_sk_t
 *
sk
);

25 
ucc_¡©us_t
 
ucc__sh¬p_bÿ¡_š™
(
ucc__sh¬p_sk_t
 *
sk
);

27 #ià
HAVE_DECL_SHARP_COLL_DO_REDUCE_SCATTER


28 
ucc_¡©us_t
 
ucc__sh¬p_»duû_sÿ‰”_š™
(
ucc__sh¬p_sk_t
 *
sk
);

31 #ià
HAVE_DECL_SHARP_COLL_DO_ALLGATHER


32 
ucc_¡©us_t
 
ucc__sh¬p_®lg©h”_š™
(
ucc__sh¬p_sk_t
 *
sk
);

	@src/components/tl/sharp/tl_sharp_context.c

7 
	~<š‰y³s.h
>

8 
	~"_sh¬p.h
"

9 
	~"uts/¬ch/ıu.h
"

10 
	~"cÜe/ucc_£rviû_cŞl.h
"

12 
	$ucc__sh¬p_oob_b¬r›r
(*
¬g
)

14 
ucc__sh¬p_oob_ùx_t
 *
oob_ùx
 = (ucc__sh¬p_oob_ùx_ˆ*)
¬g
;

15 
ucc__sh¬p_cÚ‹xt_t
 *
ùx
 = 
oob_ùx
->ctx;

16 
ucc_oob_cŞl_t
 *
oob_cŞl
 = 
oob_ùx
->
oob
;

17 
ucc_¡©us_t
 
¡©us
;

18 
sbuf
, *
rbuf
;

19 *
»q
;

21 
rbuf
 = 
	`ucc_m®loc
((è* 
oob_cŞl
->
n_oob_•s
, "tmp_barrier");

22 ià(!
rbuf
) {

23 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

25 (è* 
oob_cŞl
->
n_oob_•s
);

26  
UCC_ERR_NO_MEMORY
;

29 
¡©us
 = 
oob_cŞl
->
	`®lg©h”
(&
sbuf
, 
rbuf
, (),

30 
oob_cŞl
->
cŞl_šfo
, &
»q
);

31 ià(
UCC_OK
 =ğ
¡©us
) {

32 
	`ucc_as£¹
(
»q
 !ğ
NULL
);

33 
UCC_OK
 !ğ(
¡©us
 = 
oob_cŞl
->
	`»q_‹¡
(
»q
))) {

34 ià(
¡©us
 < 0) {

35 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedoest oob„eq");

39 
oob_cŞl
->
	`»q_ä“
(
»q
);

42 
	`ucc_ä“
(
rbuf
);

43  
¡©us
;

44 
	}
}

46 
	$ucc__sh¬p_oob_g©h”
(*
¬g
, 
roÙ
, *
sbuf
,

47 *
rbuf
, 
size
)

49 
ucc__sh¬p_oob_ùx_t
 *
oob_ùx
 = (ucc__sh¬p_oob_ùx_ˆ*)
¬g
;

50 
ucc__sh¬p_cÚ‹xt_t
 *
ùx
 = 
oob_ùx
->ctx;

51 *
tmp_rbuf
 = 
NULL
;

52 
size_t
 
msg_size
 = 
size
;

53 
ucc_oob_cŞl_t
 *
oob_cŞl
 = 
oob_ùx
->
oob
;

54 *
»q
;

55 
ucc_¡©us_t
 
¡©us
;

57 ià(
oob_cŞl
->
oob_•
 !ğ
roÙ
) {

58 
tmp_rbuf
 = 
	`ucc_m®loc
(
msg_size
 * 
oob_cŞl
->
n_oob_•s
, "tmp_gather");

59 ià(!
tmp_rbuf
) {

60 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

62 
msg_size
 * 
oob_cŞl
->
n_oob_•s
);

63  
UCC_ERR_NO_MEMORY
;

65 
rbuf
 = 
tmp_rbuf
;

68 
¡©us
 = 
oob_cŞl
->
	`®lg©h”
(
sbuf
, 
rbuf
, 
msg_size
, oob_cŞl->
cŞl_šfo
, &
»q
);

69 ià(
UCC_OK
 =ğ
¡©us
) {

70 
	`ucc_as£¹
(
»q
 !ğ
NULL
);

71 
UCC_OK
 !ğ(
¡©us
 = 
oob_cŞl
->
	`»q_‹¡
(
»q
))) {

72 ià(
¡©us
 < 0) {

73 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedoest oob„eq");

78 
oob_cŞl
->
	`»q_ä“
(
»q
);

81 ià(
tmp_rbuf
) {

82 
	`ucc_ä“
(
tmp_rbuf
);

84  
¡©us
;

85 
	}
}

87 
	$ucc__sh¬p_oob_bÿ¡
(*
¬g
, *
buf
, 
size
, 
roÙ
)

89 
ucc__sh¬p_oob_ùx_t
 *
oob_ùx
 = (ucc__sh¬p_oob_ùx_ˆ*)
¬g
;

90 
ucc__sh¬p_cÚ‹xt_t
 *
ùx
 = 
oob_ùx
->ctx;

91 
size_t
 
msg_size
 = 
size
;

92 
ucc_oob_cŞl_t
 *
oob_cŞl
 = 
oob_ùx
->
oob
;

93 
ucc_¡©us_t
 
¡©us
;

94 *
»q
, *
tmp_rbuf
;

96 
tmp_rbuf
 = 
	`ucc_m®loc
(
msg_size
 * 
oob_cŞl
->
n_oob_•s
, "tmp_bcast");

97 ià(!
tmp_rbuf
) {

98 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

100 
msg_size
 * 
oob_cŞl
->
n_oob_•s
);

101  
UCC_ERR_NO_MEMORY
;

104 
¡©us
 = 
oob_cŞl
->
	`®lg©h”
(
buf
, 
tmp_rbuf
, 
msg_size
, oob_cŞÈ->
cŞl_šfo
,

105 &
»q
);

106 ià(
UCC_OK
 =ğ
¡©us
) {

107 
	`ucc_as£¹
(
»q
 !ğ
NULL
);

108 
UCC_OK
 !ğ(
¡©us
 = 
oob_cŞl
 ->
	`»q_‹¡
(
»q
))) {

109 ià(
¡©us
 < 0) {

110 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedoest oob„eq");

114 
oob_cŞl
 ->
	`»q_ä“
(
»q
);

117 
	`memıy
(
buf
, 
	`PTR_OFFSET
(
tmp_rbuf
, 
roÙ
 * 
msg_size
), msg_size);

119 
	`ucc_ä“
(
tmp_rbuf
);

120  
¡©us
;

121 
	}
}

123 
	$ucc__sh¬p_£rviû_b¬r›r
(*
¬g
)

125 
ucc__sh¬p_oob_ùx_t
 *
oob_ùx
 = (ucc__sh¬p_oob_ùx_t*)
¬g
;

126 
ucc__sh¬p_cÚ‹xt_t
 *
ùx
 = (ucc__sh¬p_cÚ‹xt_t*)
oob_ùx
->ctx;

127 
ucc__‹am_t
 *
¡—m
 = 
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
->
£rviû_‹am
;

128 
ucc_cŞl_sk_t
 *
»q
;

129 
ucc_¡©us_t
 
¡©us
;

130 
št32_t
 
sbuf
, 
rbuf
;

132 
¡©us
 = 
	`UCC_TL_TEAM_IFACE
(
¡—m
)->
scŞl
.
	`®Ìeduû
(&¡—m->
su³r
, &
sbuf
,

133 &
rbuf
, 
UCC_DT_INT32
, 1,

134 
UCC_OP_SUM
,

135 
oob_ùx
->
sub£t
, &
»q
);

136 ià(
¡©us
 !ğ
UCC_OK
) {

137 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "tl sharp gather failed\n");

138  
¡©us
;

142 
	`ucc_cÚ‹xt_´og»ss
(
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
);

143 
¡©us
 = 
	`ucc_cŞËùive_‹¡
(&
»q
->
su³r
);

144 } 
¡©us
 =ğ
UCC_INPROGRESS
);

145 
	`ucc_cŞËùive_fš®ize_š‹º®
(
»q
);

147  
¡©us
;

148 
	}
}

150 
	$ucc__sh¬p_£rviû_g©h”
(*
¬g
, 
roÙ
, *
sbuf
,

151 *
rbuf
, 
size
)

153 
ucc__sh¬p_oob_ùx_t
 *
oob_ùx
 = (ucc__sh¬p_oob_ùx_t*)
¬g
;

154 
ucc__sh¬p_cÚ‹xt_t
 *
ùx
 = (ucc__sh¬p_cÚ‹xt_t*)
oob_ùx
->ctx;

155 
ucc__‹am_t
 *
¡—m
 = 
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
->
£rviû_‹am
;

156 
size_t
 
msg_size
 = (size_t)
size
;

157 
ucc_sub£t_t
 
sub£t
 = 
oob_ùx
->subset;

158 
ucc_cŞl_sk_t
 *
»q
;

159 
ucc_¡©us_t
 
¡©us
;

161 ià(
sub£t
.
my¿nk
 !ğ
roÙ
) {

162 
rbuf
 = 
	`ucc_m®loc
(
msg_size
 * 
sub£t
.
m­
.
•_num
, "tmp_gather");

163 ià(!
rbuf
) {

164 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

166 
msg_size
 * 
sub£t
.
m­
.
•_num
);

167  
UCC_ERR_NO_MEMORY
;

171 
¡©us
 = 
	`UCC_TL_TEAM_IFACE
(
¡—m
)->
scŞl
.
	`®lg©h”
(&¡—m->
su³r
, 
sbuf
,

172 
rbuf
, 
msg_size
, 
sub£t
,

173 &
»q
);

174 ià(
¡©us
 !ğ
UCC_OK
) {

175 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "tl sharp gather failed\n");

176  
¡©us
;

180 
	`ucc_cÚ‹xt_´og»ss
(
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
);

181 
¡©us
 = 
	`ucc_cŞËùive_‹¡
(&
»q
->
su³r
);

182 } 
¡©us
 =ğ
UCC_INPROGRESS
);

183 
	`ucc_cŞËùive_fš®ize_š‹º®
(
»q
);

185 ià(
sub£t
.
my¿nk
 !ğ
roÙ
) {

186 
	`ucc_ä“
(
rbuf
);

189  
¡©us
;

190 
	}
}

192 
	$ucc__sh¬p_£rviû_bÿ¡
(*
¬g
, *
buf
, 
size
, 
roÙ
)

194 
ucc__sh¬p_oob_ùx_t
 *
oob_ùx
 = (ucc__sh¬p_oob_ùx_t*)
¬g
;

195 
ucc__sh¬p_cÚ‹xt_t
 *
ùx
 = (ucc__sh¬p_cÚ‹xt_t*)
oob_ùx
->ctx;

196 
ucc__‹am_t
 *
¡—m
 = 
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
->
£rviû_‹am
;

197 
ucc_cŞl_sk_t
 *
»q
;

198 
ucc_¡©us_t
 
¡©us
;

200 
¡©us
 = 
	`UCC_TL_TEAM_IFACE
(
¡—m
)->
scŞl
.
	`bÿ¡
(&¡—m->
su³r
, 
buf
, 
size
,

201 
roÙ
, 
oob_ùx
->
sub£t
, &
»q
);

202 ià(
¡©us
 !ğ
UCC_OK
) {

203 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "tl sharp bcast failed\n");

204  
¡©us
;

208 
	`ucc_cÚ‹xt_´og»ss
(
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
);

209 
¡©us
 = 
	`ucc_cŞËùive_‹¡
(&
»q
->
su³r
);

210 } 
¡©us
 =ğ
UCC_INPROGRESS
);

212 
	`ucc_cŞËùive_fš®ize_š‹º®
(
»q
);

213  
¡©us
;

214 
	}
}

217 
ucs_¡©us_t


218 
	$ucc__sh¬p_rÿche_mem_»g_cb
(*
cÚ‹xt
, 
ucc_rÿche_t
 *
rÿche
,

219 *
¬g
, 
ucc_rÿche_»giÚ_t
 *
¼egiÚ
,

220 
ušt16_t
 
æags
)

222 
ucc__sh¬p_rÿche_»giÚ_t
 *
»giÚ
;

223 *
add»ss
;

224 
size_t
 
Ëngth
;

225 
»t
;

227 
add»ss
 = (*)
¼egiÚ
->
su³r
.
¡¬t
;

228 
Ëngth
 = (
size_t
)(
¼egiÚ
->
su³r
.
’d
 -„»giÚ->su³r.
¡¬t
);

229 
»giÚ
 = 
	`ucc_d”ived_of
(
¼egiÚ
, 
ucc__sh¬p_rÿche_»giÚ_t
);

231 
»t
 = 
	`sh¬p_cŞl_»g_mr
((
sh¬p_cŞl_cÚ‹xt
 *)
cÚ‹xt
, 
add»ss
,

232 
Ëngth
, &
»giÚ
->
»g
.
mr
);

233 ià(
»t
 < 0) {

234  
UCS_ERR_INVALID_PARAM
;

236  
UCS_OK
;

238 
	}
}

241 
	$ucc__sh¬p_rÿche_mem_d”eg_cb
(*
cÚ‹xt
, 
ucc_rÿche_t
 *
rÿche
,

242 
ucc_rÿche_»giÚ_t
 *
¼egiÚ
)

244 
ucc__sh¬p_rÿche_»giÚ_t
 *
»giÚ
 = 
	`ucc_d”ived_of
(
¼egiÚ
,

245 
ucc__sh¬p_rÿche_»giÚ_t
);

247 
	`sh¬p_cŞl_d”eg_mr
((
sh¬p_cŞl_cÚ‹xt
 *)
cÚ‹xt
, 
»giÚ
->
»g
.
mr
);

248 
	}
}

252 
	$ucc__sh¬p_rÿche_dump_»giÚ_cb
(*
cÚ‹xt
, 
ucs_rÿche_t
 *
rÿche
,

253 
ucs_rÿche_»giÚ_t
 *
¼egiÚ
, *
buf
,

254 
size_t
 
max
)

256 
ucc__sh¬p_rÿche_»giÚ_t
 *
»giÚ
 = 
	`ucc_d”ived_of
(
¼egiÚ
,

257 
ucc__sh¬p_rÿche_»giÚ_t
);

259 
	`¢´štf
(
buf
, 
max
, "b¬…Œ:%p", 
»giÚ
->
»g
.
mr
);

260 
	}
}

262 
ucc_rÿche_İs_t
 
	gucc__sh¬p_rÿche_İs
 = {

263 .
mem_»g
 = 
ucc__sh¬p_rÿche_mem_»g_cb
,

264 .
	gmem_d”eg
 = 
ucc__sh¬p_rÿche_mem_d”eg_cb
,

265 .
	gdump_»giÚ
 = 
ucc__sh¬p_rÿche_dump_»giÚ_cb
,

266 #ifdeà
UCS_HAVE_RCACHE_MERGE_CB


267 .
	gm”ge
 = 
ucc_rÿche_m”ge_cb_em±y


271 
ucc_¡©us_t
 
	$ucc__sh¬p_rÿche_ü—‹
(
sh¬p_cŞl_cÚ‹xt
 *
cÚ‹xt
,

272 
ucc_rÿche_t
 **
rÿche
)

274 
ucc_rÿche_·¿ms_t
 
rÿche_·¿ms
;

276 
	`ucc_rÿche_£t_deçuÉ_·¿ms
(&
rÿche_·¿ms
);

277 
rÿche_·¿ms
.
»giÚ_¡ruù_size
 = (
ucc__sh¬p_rÿche_»giÚ_t
);

278 
rÿche_·¿ms
.
cÚ‹xt
 = context;

279 
rÿche_·¿ms
.
İs
 = &
ucc__sh¬p_rÿche_İs
;

280 
rÿche_·¿ms
.
ucm_ev’ts
 = 
UCM_EVENT_VM_UNMAPPED
 |

281 
UCM_EVENT_MEM_TYPE_FREE
;

283  
	`ucc_rÿche_ü—‹
(&
rÿche_·¿ms
, "SHARP", 
rÿche
);

284 
	}
}

286 
ucc_¡©us_t
 
	$ucc__sh¬p_cÚ‹xt_š™
(
ucc__sh¬p_cÚ‹xt_t
 *
sh¬p_ùx
,

287 
sh¬p_cŞl_cÚ‹xt
 **
cÚ‹xt
,

288 
ucc__sh¬p_oob_ùx_t
 *
oob_ùx
,

289 
ucc_tİo_t
 *
tİo
)

291 
sh¬p_cŞl_š™_¥ec
 
š™_¥ec
 = {0};

292 
ucc__sh¬p_lib_t
 *
lib
 = 
	`ucc_d”ived_of
(
sh¬p_ùx
->
su³r
.super.lib,

293 
ucc__sh¬p_lib_t
);

294 
ucc_sbgp_t
 *
sbgp
;

295 
loÿl_¿nk
;

296 
»t
;

298 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

299 ià(
sbgp
->
¡©us
 !ğ
UCC_SBGP_ENABLED
) {

300 
	`_debug
(
sh¬p_ùx
->
su³r
.su³r.
lib
, "NODE SBGP is‚otƒnabled");

301 
loÿl_¿nk
 = 0;

303 
loÿl_¿nk
 = 
sbgp
->
group_¿nk
;

306 
š™_¥ec
.
´og»ss_func
 = 
NULL
;

307 
š™_¥ec
.
wÜld_loÿl_¿nk
 = 
loÿl_¿nk
;

308 ià(
sh¬p_ùx
->
cfg
.
u£_muÉi_chªÃl
) {

309 
š™_¥ec
.
group_chªÃl_idx
 = 
loÿl_¿nk
;

311 
š™_¥ec
.
group_chªÃl_idx
 = 0;

313 
š™_¥ec
.
oob_ùx
 = oob_ctx;

314 
š™_¥ec
.
cÚfig
 = 
sh¬p_cŞl_deçuÉ_cÚfig
;

315 
š™_¥ec
.
cÚfig
.
u£r_´og»ss_num_pŞls
 = 
sh¬p_ùx
->
cfg
.
u´og»ss_num_pŞls
;

316 
š™_¥ec
.
cÚfig
.
ib_dev_li¡
 = 
sh¬p_ùx
->
cfg
.
dev_li¡
;

317 #ià
HAVE_DECL_SHARP_COLL_HIDE_ERRORS


318 ià(
lib
->
su³r
.su³r.
log_compÚ’t
.
log_Ëv–
 < 
UCC_LOG_LEVEL_DEBUG
) {

319 
š™_¥ec
.
cÚfig
.
æags
 |ğ
SHARP_COLL_HIDE_ERRORS
;

322 #ià
HAVE_DECL_SHARP_COLL_DISABLE_LAZY_GROUP_RESOURCE_ALLOC


323 if(!
sh¬p_ùx
->
cfg
.
’abË_Ïzy_group_®loc
) {

324 
š™_¥ec
.
cÚfig
.
æags
 |ğ
SHARP_COLL_DISABLE_LAZY_GROUP_RESOURCE_ALLOC
;

328 
š™_¥ec
.
job_id
 = ((
	`g‘pid
(è^ 
	`±h»ad_£lf
())

329 ^ 
	`¿nd_r
(&
sh¬p_ùx
->
cfg
.
¿nd_£ed
));

330 
š™_¥ec
.
’abË_th»ad_suµÜt
 =

331 (
sh¬p_ùx
->
tm
 =ğ
UCC_THREAD_MULTIPLE
) ? 1 : 0;

333 ià(
lib
->
cfg
.
u£_š‹º®_oob
 !ğ
UCC_NO
 && 
sh¬p_ùx
->
su³r
.su³r.
ucc_cÚ‹xt
->
£rviû_‹am
) {

334 
	`_debug
(
sh¬p_ùx
->
su³r
.su³r.
lib
,

336 
oob_ùx
->
sub£t
.
my¿nk
, oob_ùx->sub£t.
m­
.
•_num
);

337 
š™_¥ec
.
wÜld_¿nk
 = 
oob_ùx
->
sub£t
.
my¿nk
;

338 
š™_¥ec
.
wÜld_size
 = 
oob_ùx
->
sub£t
.
m­
.
•_num
;

339 
š™_¥ec
.
oob_cŞls
.
b¬r›r
 = 
ucc__sh¬p_£rviû_b¬r›r
;

340 
š™_¥ec
.
oob_cŞls
.
bÿ¡
 = 
ucc__sh¬p_£rviû_bÿ¡
;

341 
š™_¥ec
.
oob_cŞls
.
g©h”
 = 
ucc__sh¬p_£rviû_g©h”
;

343 
	`_debug
(
sh¬p_ùx
->
su³r
.su³r.
lib
,

345 
oob_ùx
->
oob
->
oob_•
, oob_ùx->oob->
n_oob_•s
);

346 
š™_¥ec
.
wÜld_¿nk
 = 
oob_ùx
->
oob
->
oob_•
;

347 
š™_¥ec
.
wÜld_size
 = 
oob_ùx
->
oob
->
n_oob_•s
;

348 
š™_¥ec
.
oob_cŞls
.
b¬r›r
 = 
ucc__sh¬p_oob_b¬r›r
;

349 
š™_¥ec
.
oob_cŞls
.
bÿ¡
 = 
ucc__sh¬p_oob_bÿ¡
;

350 
š™_¥ec
.
oob_cŞls
.
g©h”
 = 
ucc__sh¬p_oob_g©h”
;

354 
»t
 = 
š™_¥ec
.
oob_cŞls
.
	`bÿ¡
((*)
oob_ùx
, &š™_¥ec.
job_id
,

355 (
ušt64_t
), 0);

356 ià(
»t
 < 0) {

357 
	`_”rÜ
(
sh¬p_ùx
->
su³r
.su³r.
lib
,

359  
UCC_ERR_NO_MESSAGE
;

362 
»t
 = 
	`sh¬p_cŞl_š™
(&
š™_¥ec
, 
cÚ‹xt
);

363 ià(
»t
 < 0 ) {

364 
	`_debug
(
sh¬p_ùx
->
su³r
.su³r.
lib
, "failedo initialize SHARP "

365 "cŞËùives:%s(%dèjob ID:%" 
PRIu64
"\n",

366 
	`sh¬p_cŞl_¡»¼Ü
(
»t
),„‘, 
š™_¥ec
.
job_id
);

367  
UCC_ERR_NO_RESOURCE
;

370 
»t
 = 
	`sh¬p_cŞl_ÿps_qu”y
(*
cÚ‹xt
, &
sh¬p_ùx
->
sh¬p_ÿps
);

371 ià(
»t
 < 0) {

372 
	`_”rÜ
(
sh¬p_ùx
->
su³r
.su³r.
lib
, "sharp_coll_caps_query failed: %s(%d)",

373 
	`sh¬p_cŞl_¡»¼Ü
(
»t
),„et);

374 
	`sh¬p_cŞl_fš®ize
(*
cÚ‹xt
);

375  
UCC_ERR_NO_RESOURCE
;

378  
UCC_OK
;

379 
	}
}

381 
	$UCC_CLASS_INIT_FUNC
(
ucc__sh¬p_cÚ‹xt_t
,

382 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

383 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

385 
ucc__sh¬p_cÚ‹xt_cÚfig_t
 *
_sh¬p_cÚfig
 =

386 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__sh¬p_cÚ‹xt_cÚfig_t
);

387 
ucc_¡©us_t
 
¡©us
;

388 
timev®
 
tv®
;

390 ià(!(
·¿ms
->·¿ms.
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
)) {

391 
	`_”rÜ
(
_sh¬p_cÚfig
->
su³r
.
_lib
, "Context OOB is„equired for SHARP");

392 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

393 
”r
;

396 ià(
·¿ms
->·¿ms.
oob
.
n_oob_•s
 < 2) {

397 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

398 
”r
;

401 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__cÚ‹xt_t
, &
_sh¬p_cÚfig
->
su³r
,

402 
·¿ms
->
cÚ‹xt
);

403 
	`memıy
(&
£lf
->
cfg
, 
_sh¬p_cÚfig
, (*tl_sharp_config));

405 ià(
£lf
->
cfg
.
¿nd_£ed
 == 0) {

406 
	`g‘timeofday
(&
tv®
, 
NULL
);

407 
£lf
->
cfg
.
¿nd_£ed
 = (è
tv®
.
tv_u£c
;

410 
£lf
->
sh¬p_cÚ‹xt
 = 
NULL
;

411 
£lf
->
rÿche
 = 
NULL
;

412 
£lf
->
oob_ùx
.
ùx
 = self;

413 
£lf
->
tm
 = 
·¿ms
->
th»ad_mode
;

415 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
£lf
->
»q_mp
, 0, (
ucc__sh¬p_sk_t
), 0,

416 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
,

417 &
ucc_cŞl_sk_mpoŞ_İs
, 
·¿ms
->
th»ad_mode
,

419 ià(
¡©us
 !ğ
UCC_OK
) {

420 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

422 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

423 
”r
;

426 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "initializedl context: %p", self);

427  
UCC_OK
;

429 
”r
:

430  
¡©us
;

431 
	}
}

433 
ucc_¡©us_t
 
	$ucc__sh¬p_cÚ‹xt_ü—‹_•og
(
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
)

435 
ucc__sh¬p_cÚ‹xt_t
 *
sh¬p_ùx
 = 
	`ucc_d”ived_of
(
cÚ‹xt
, ucc_tl_sharp_context_t);

436 
ucc_cÚ‹xt_t
 *
cÜe_ùx
 = 
cÚ‹xt
->
ucc_cÚ‹xt
;

437 
ucc__sh¬p_lib_t
 *
lib
 = 
	`ucc_d”ived_of
(
sh¬p_ùx
->
su³r
.super.lib,

438 
ucc__sh¬p_lib_t
);

439 
ucc_¡©us_t
 
¡©us
;

440 
ucc_tİo_t
 *
tİo
;

441 
ucc_sub£t_t
 
£t
;

443 ià(
sh¬p_ùx
->
cfg
.
cÚ‹xt_³r_‹am
) {

444  
UCC_OK
;

447 
	`mem£t
(&
£t
.
m­
, 0, (
ucc_•_m­_t
));

448 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

449 
£t
.
my¿nk
 = 
	`UCC_TL_CTX_OOB
(
sh¬p_ùx
).
oob_•
;

450 
£t
.
m­
.
•_num
 = 
	`UCC_TL_CTX_OOB
(
sh¬p_ùx
).
n_oob_•s
;

452 ià(
lib
->
cfg
.
u£_š‹º®_oob
 !ğ
UCC_NO
 && 
cÜe_ùx
->
£rviû_‹am
) {

453 
sh¬p_ùx
->
oob_ùx
.
sub£t
 = 
£t
;

455 
sh¬p_ùx
->
oob_ùx
.
oob
 = &
	`UCC_TL_CTX_OOB
(sharp_ctx);

458 
	`ucc_as£¹
(
cÜe_ùx
->
tİo
 !ğ
NULL
);

459 
¡©us
 = 
	`ucc_tİo_š™
(
£t
, 
cÜe_ùx
->
tİo
, &topo);

460 ià(
UCC_OK
 !ğ
¡©us
) {

461 
	`_”rÜ
(
sh¬p_ùx
->
su³r
.su³r.
lib
, "failedo initopo");

462  
¡©us
;

465 
¡©us
 = 
	`ucc__sh¬p_cÚ‹xt_š™
(
sh¬p_ùx
, &sh¬p_ùx->
sh¬p_cÚ‹xt
,

466 &
sh¬p_ùx
->
oob_ùx
, 
tİo
);

467 
	`ucc_tİo_ş—nup
(
tİo
);

468 ià(
¡©us
 !ğ
UCC_OK
) {

469  
¡©us
;

472 ià(
sh¬p_ùx
->
cfg
.
u£_rÿche
) {

473 
¡©us
 = 
	`ucc__sh¬p_rÿche_ü—‹
(
sh¬p_ùx
->
sh¬p_cÚ‹xt
, &sh¬p_ùx->
rÿche
);

474 ià(
¡©us
 !ğ
UCC_OK
) {

475 
	`_”rÜ
(
sh¬p_ùx
->
su³r
.su³r.
lib
, "failedo create„cache");

476 
”r_sh¬p_ùx_š™
;

480 
¡©us
 = 
	`ucc_cÚ‹xt_´og»ss_»gi¡”
(

481 
cÚ‹xt
->
ucc_cÚ‹xt
, (
ucc_cÚ‹xt_´og»ss_â_t
)
sh¬p_cŞl_´og»ss
,

482 
sh¬p_ùx
->
sh¬p_cÚ‹xt
);

483 ià(
¡©us
 !ğ
UCC_OK
) {

484 
	`_”rÜ
(
cÚ‹xt
->
lib
, "failedo„egister…rogress function");

485 
”r_sh¬p_´og»ss_»gi¡”
;

488  
UCC_OK
;

490 
”r_sh¬p_´og»ss_»gi¡”
:

491 ià(
sh¬p_ùx
->
rÿche
 !ğ
NULL
) {

492 
	`ucc_rÿche_de¡roy
(
sh¬p_ùx
->
rÿche
);

494 
”r_sh¬p_ùx_š™
:

495 
	`sh¬p_cŞl_fš®ize
(
sh¬p_ùx
->
sh¬p_cÚ‹xt
);

496  
¡©us
;

497 
	}
}

499 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__sh¬p_cÚ‹xt_t
)

501 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizingl context: %p", self);

503 ià(
£lf
->
rÿche
 !ğ
NULL
) {

504 
	`ucc_rÿche_de¡roy
(
£lf
->
rÿche
);

507 ià(
£lf
->
sh¬p_cÚ‹xt
 !ğ
NULL
) {

508 
	`ucc_cÚ‹xt_´og»ss_d”egi¡”
(

509 
£lf
->
su³r
.su³r.
ucc_cÚ‹xt
,

510 (
ucc_cÚ‹xt_´og»ss_â_t
)
sh¬p_cŞl_´og»ss
, 
£lf
->
sh¬p_cÚ‹xt
);

511 
	`sh¬p_cŞl_fš®ize
(
£lf
->
sh¬p_cÚ‹xt
);

514 
	`ucc_mpoŞ_ş—nup
(&
£lf
->
»q_mp
, 1);

515 
	}
}

517 
UCC_CLASS_DEFINE
(
ucc__sh¬p_cÚ‹xt_t
, 
ucc__cÚ‹xt_t
);

519 
ucc_¡©us_t
 
	$ucc__sh¬p_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

520 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

522 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

523 
©Œ
->
tİo_»quœed
 = 1;

524  
UCC_OK
;

525 
	}
}

527 
ucc_¡©us_t
 
	$ucc__sh¬p_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

528 *
add»ss
, 
size_t
 
Ën
, *
memh
,

529 *
_h
)

531  
UCC_ERR_NOT_SUPPORTED
;

532 
	}
}

534 
ucc_¡©us_t
 
	$ucc__sh¬p_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ty³
,

535 *
memh
)

537  
UCC_ERR_NOT_SUPPORTED
;

538 
	}
}

540 
ucc_¡©us_t
 
	$ucc__sh¬p_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

541 
ty³
, *
memh
, **
·ck_bufãr
)

543  
UCC_ERR_NOT_SUPPORTED
;

544 
	}
}

	@src/components/tl/sharp/tl_sharp_lib.c

7 
	~<sys/time.h
>

8 
	~"_sh¬p.h
"

11 
	$UCC_CLASS_INIT_FUNC
(
ucc__sh¬p_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

12 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

14 cÚ¡ 
ucc__sh¬p_lib_cÚfig_t
 *
_sh¬p_cÚfig
 =

15 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__sh¬p_lib_cÚfig_t
);

17 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__lib_t
, &
ucc__sh¬p
.
su³r
,

18 &
_sh¬p_cÚfig
->
su³r
);

19 
	`memıy
(&
£lf
->
cfg
, 
_sh¬p_cÚfig
, (*tl_sharp_config));

20 
	`_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

21  
UCC_OK
;

22 
	}
}

24 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__sh¬p_lib_t
)

26 
	`_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

27 
	}
}

29 
UCC_CLASS_DEFINE
(
ucc__sh¬p_lib_t
, 
ucc__lib_t
);

31 
ucc_¡©us_t
 
	$ucc__sh¬p_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

32 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
)

34 
ucc__sh¬p_lib_t
 *
sh¬p_lib
 = 
	`ucc_d”ived_of
(
lib
, ucc_tl_sharp_lib_t);

35 
ucc__lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_tl_lib_attr_t);

37 
©Œ
->
su³r
.
æags
 = 0;

38 ià(
lib
 !ğ
NULL
) {

39 ià(
sh¬p_lib
->
cfg
.
u£_š‹º®_oob
 =ğ
UCC_YES
) {

40 
©Œ
->
su³r
.
æags
 |ğ
UCC_BASE_LIB_FLAG_CTX_SERVICE_TEAM_REQUIRED
;

43 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

44 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 
UCC_TL_SHARP_SUPPORTED_COLLS
;

45 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
) {

46 ià(
lib
 =ğ
NULL
) {

47  
UCC_ERR_INVALID_PARAM
;

49 
©Œ
->
su³r
.
mš_‹am_size
 = 
lib
->min_team_size;

52 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
) {

53 ià(
lib
 =ğ
NULL
) {

54  
UCC_ERR_INVALID_PARAM
;

56 
©Œ
->
su³r
.
max_‹am_size
 = 
UCC_RANK_MAX
;

59  
UCC_OK
;

60 
	}
}

62 
ucc_¡©us_t
 
	$ucc__sh¬p_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

64 
´İ
->
deçuÉ_‹am_size
 = 4;

65 
´İ
->
mš_‹am_size
 = 2;

66 
´İ
->
max_‹am_size
 = 
UCC_RANK_MAX
;

67  
UCC_OK
;

68 
	}
}

	@src/components/tl/sharp/tl_sharp_team.c

7 
	~"_sh¬p_cŞl.h
"

8 
	~"compÚ’ts/mc/ucc_mc.h
"

9 
	~"cÜe/ucc_“.h
"

10 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

11 
	~"cÜe/ucc_‹am.h
"

12 
	~<sh¬p/­i/v”siÚ.h
>

14 
	$UCC_CLASS_INIT_FUNC
(
ucc__sh¬p_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
,

15 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

17 
ucc__sh¬p_cÚ‹xt_t
 *
ùx
 =

18 
	`ucc_d”ived_of
(
_cÚ‹xt
, 
ucc__sh¬p_cÚ‹xt_t
);

19 
sh¬p_cŞl_cÚ‹xt
 *
sh¬p_ùx
 = 
ùx
->
sh¬p_cÚ‹xt
;

20 
sh¬p_cŞl_comm_š™_¥ec
 
comm_¥ec
;

21 
»t
;

22 
ucc_¡©us_t
 
¡©us
;

23 
ucc_sub£t_t
 
£t
;

25 ià(!(
·¿ms
->·¿ms.
mask
 & 
UCC_TEAM_PARAM_FIELD_OOB
)) {

26 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "team OOB„equired for sharpeam");

27  
UCC_ERR_INVALID_PARAM
;

30 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

32 
£lf
->
sh¬p_cÚ‹xt
 = 
NULL
;

33 
£lf
->
rÿche
 = 
NULL
;

34 
£lf
->
oob_ùx
.
ùx
 = 
	`UCC_TL_TEAM_CTX
(self);

36 
£t
.
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(
£lf
);

37 
£t
.
m­
 = 
	`UCC_TL_TEAM_MAP
(
£lf
);

39 ià(
	`UCC_TL_SHARP_TEAM_LIB
(
£lf
)->
cfg
.
u£_š‹º®_oob
) {

40 
¡©us
 = 
	`ucc_•_m­_ü—‹_Ã¡ed
(&
	`UCC_TL_CORE_TEAM
(
£lf
)->
ùx_m­
,

41 &
	`UCC_TL_TEAM_MAP
(
£lf
),

42 &
£lf
->
oob_ùx
.
sub£t
.
m­
);

43 ià(
¡©us
 !ğ
UCC_OK
) {

44  
¡©us
;

46 
£lf
->
oob_ùx
.
sub£t
.
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(self);

48 
£lf
->
oob_ùx
.
oob
 = &
	`UCC_TL_TEAM_OOB
(self);

51 
¡©us
 = 
	`ucc_tİo_š™
(
£t
, 
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
->
tİo
, &
£lf
->topo);

52 ià(
UCC_OK
 !ğ
¡©us
) {

53 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo initeamopo");

54 ià(
	`UCC_TL_SHARP_TEAM_LIB
(
£lf
)->
cfg
.
u£_š‹º®_oob
) {

55 
	`ucc_•_m­_de¡roy_Ã¡ed
(&
£lf
->
oob_ùx
.
sub£t
.
m­
);

57  
¡©us
;

60 ià(
	`ucc_tİo_max_µn
(
£lf
->
tİo
è> 
ùx
->
cfg
.
‹am_max_µn
) {

61 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "sharpeam‚ot supported with…pn > 1");

62 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

63 
ş—nup
;

66 ià(
sh¬p_ùx
 =ğ
NULL
) {

67 
¡©us
 = 
	`ucc__sh¬p_cÚ‹xt_š™
(
ùx
, &
£lf
->
sh¬p_cÚ‹xt
,

68 &
£lf
->
oob_ùx
, s–f->
tİo
);

69 ià(
¡©us
 !ğ
UCC_OK
) {

70 
ş—nup
;

73 ià(
ùx
->
cfg
.
u£_rÿche
) {

74 
¡©us
 = 
	`ucc__sh¬p_rÿche_ü—‹
(
£lf
->
sh¬p_cÚ‹xt
, &£lf->
rÿche
);

75 ià(
¡©us
 !ğ
UCC_OK
) {

76 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo create„cache");

77 
ş—nup
;

81 
¡©us
 = 
	`ucc_cÚ‹xt_´og»ss_»gi¡”
(

82 
_cÚ‹xt
->
ucc_cÚ‹xt
, (
ucc_cÚ‹xt_´og»ss_â_t
)
sh¬p_cŞl_´og»ss
,

83 
£lf
->
sh¬p_cÚ‹xt
);

84 ià(
¡©us
 !ğ
UCC_OK
) {

85 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo„egister…rogress function");

86 
ş—nup
;

89 
sh¬p_ùx
 = 
£lf
->
sh¬p_cÚ‹xt
;

91 
£lf
->
sh¬p_cÚ‹xt
 = 
sh¬p_ùx
;

92 
£lf
->
rÿche
 = 
ùx
->rcache;

95 #ià
SHARP_API
 > 
	`SHARP_VERSION
(3, 0)

96 ià((
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
UCC_DT_INT8
)] ==

97 
SHARP_DTYPE_UNKNOWN
) ||

98 (
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
SHARP_DTYPE_UINT8
)] ==

99 
SHARP_DTYPE_UNKNOWN
) ||

100 (
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
SHARP_DTYPE_BFLOAT16
)] ==

101 
SHARP_DTYPE_UNKNOWN
)) {

103 ià(
ùx
->
sh¬p_ÿps
.
suµÜt_mask
.
dty³s
 & 
	`UCC_BIT
(
SHARP_DTYPE_INT8
)) {

104 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "enabling support for UCC_DT_INT8");

105 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
UCC_DT_INT8
)] = 
SHARP_DTYPE_INT8
;

107 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "disabling support for UCC_DT_INT8");

108 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
UCC_DT_INT8
)] = 
SHARP_DTYPE_NULL
;

111 ià(
ùx
->
sh¬p_ÿps
.
suµÜt_mask
.
dty³s
 & 
	`UCC_BIT
(
SHARP_DTYPE_UINT8
)) {

112 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "enabling support for UCC_DT_UINT8");

113 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT8
)] = 
SHARP_DTYPE_UINT8
;

115 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "disabling support for UCC_DT_UINT8");

116 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT8
)] = 
SHARP_DTYPE_NULL
;

120 ià(
ùx
->
sh¬p_ÿps
.
suµÜt_mask
.
dty³s
 & 
	`UCC_BIT
(
SHARP_DTYPE_BFLOAT16
)) {

121 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "enabling support for UCC_DT_BFLOAT16");

122 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
UCC_DT_BFLOAT16
)] = 
SHARP_DTYPE_BFLOAT16
;

124 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "disabling support for UCC_DT_BFLOAT16");

125 
ucc_to_sh¬p_dty³
[
	`UCC_DT_PREDEFINED_ID
(
UCC_DT_BFLOAT16
)] = 
SHARP_DTYPE_NULL
;

130 
comm_¥ec
.
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
£lf
);

131 
comm_¥ec
.
size
 = 
	`UCC_TL_TEAM_SIZE
(
£lf
);

132 
comm_¥ec
.
group_wÜld_¿nks
 = 
NULL
;

133 
comm_¥ec
.
oob_ùx
 = &
£lf
->oob_ctx;

135 
»t
 = 
	`sh¬p_cŞl_comm_š™
(
sh¬p_ùx
,

136 &
comm_¥ec
, &
£lf
->
sh¬p_comm
);

137 ià(
»t
 < 0) {

138 
	`_debug
(
ùx
->
su³r
.su³r.
lib
, "sharp group create failed:%s(%d)",

139 
	`sh¬p_cŞl_¡»¼Ü
(
»t
),„et);

140 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

141 
ş—nup
;

144 
	`_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
,

145 "š™ŸlizedÈ‹am: %°size:%d", 
£lf
, 
	`UCC_TL_TEAM_SIZE
(self));

146  
UCC_OK
;

147 
ş—nup
:

148 ià(
ùx
->
cfg
.
cÚ‹xt_³r_‹am
) {

149 ià(
£lf
->
rÿche
) {

150 
	`ucc_rÿche_de¡roy
(
£lf
->
rÿche
);

152 ià(
£lf
->
sh¬p_cÚ‹xt
) {

153 
	`ucc_cÚ‹xt_´og»ss_d”egi¡”
(

154 
_cÚ‹xt
->
ucc_cÚ‹xt
,

155 (
ucc_cÚ‹xt_´og»ss_â_t
)
sh¬p_cŞl_´og»ss
,

156 
£lf
->
sh¬p_cÚ‹xt
);

157 
	`sh¬p_cŞl_fš®ize
(
£lf
->
sh¬p_cÚ‹xt
);

160 
	`ucc_tİo_ş—nup
(
£lf
->
tİo
);

161 ià(
	`UCC_TL_SHARP_TEAM_LIB
(
£lf
)->
cfg
.
u£_š‹º®_oob
) {

162 
	`ucc_•_m­_de¡roy_Ã¡ed
(&
£lf
->
oob_ùx
.
sub£t
.
m­
);

164  
¡©us
;

165 
	}
}

167 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__sh¬p_‹am_t
)

169 
ucc__sh¬p_cÚ‹xt_t
 *
ùx
 = 
	`ucc_d”ived_of
(
	`UCC_TL_TEAM_CTX
(
£lf
), ucc_tl_sharp_context_t);

171 
	`_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizingleam: %p", self);

172 
	`sh¬p_cŞl_comm_de¡roy
(
£lf
->
sh¬p_comm
);

173 
	`ucc_tİo_ş—nup
(
£lf
->
tİo
);

175 ià(
ùx
->
cfg
.
cÚ‹xt_³r_‹am
) {

176 ià(
	`UCC_TL_SHARP_TEAM_LIB
(
£lf
)->
cfg
.
u£_š‹º®_oob
) {

177 ià(
£lf
->
rÿche
 !ğ
NULL
) {

178 
	`ucc_rÿche_de¡roy
(
£lf
->
rÿche
);

180 ià(
£lf
->
sh¬p_cÚ‹xt
 !ğ
NULL
) {

181 
	`ucc_cÚ‹xt_´og»ss_d”egi¡”
(

182 
£lf
->
su³r
.su³r.
cÚ‹xt
->
ucc_cÚ‹xt
,

183 (
ucc_cÚ‹xt_´og»ss_â_t
)
sh¬p_cŞl_´og»ss
, 
£lf
->
sh¬p_cÚ‹xt
);

184 
	`sh¬p_cŞl_fš®ize
(
£lf
->
sh¬p_cÚ‹xt
);

188 ià(
	`UCC_TL_SHARP_TEAM_LIB
(
£lf
)->
cfg
.
u£_š‹º®_oob
) {

189 
	`ucc_•_m­_de¡roy_Ã¡ed
(&
£lf
->
oob_ùx
.
sub£t
.
m­
);

191 
	}
}

193 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__sh¬p_‹am_t
, 
ucc_ba£_‹am_t
);

194 
UCC_CLASS_DEFINE
(
ucc__sh¬p_‹am_t
, 
ucc__‹am_t
);

196 
ucc_¡©us_t
 
	$ucc__sh¬p_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
)

198 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc__sh¬p_‹am_t
)(
_‹am
);

199  
UCC_OK
;

200 
	}
}

203 
ucc_¡©us_t
 
	$ucc__sh¬p_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
)

205  
UCC_OK
;

206 
	}
}

208 
ucc_¡©us_t
 
	$ucc__sh¬p_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

210 
ucc__sh¬p_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_sharp_task_t);

212 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "finalizing collask %p",ask);

213 
	`UCC_TL_SHARP_PROFILE_REQUEST_FREE
(
sk
);

214 
	`ucc_mpoŞ_put
(
sk
);

215  
UCC_OK
;

216 
	}
}

218 
ucc_¡©us_t
 
	$ucc__sh¬p_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

219 
ucc_ba£_‹am_t
 *
‹am
,

220 
ucc_cŞl_sk_t
 **
sk_h
)

222 
ucc__sh¬p_cÚ‹xt_t
 *
sh¬p_ùx
 = 
	`ucc_d”ived_of
(
‹am
->
cÚ‹xt
,

223 
ucc__sh¬p_cÚ‹xt_t
);

224 
ucc__sh¬p_sk_t
 *
sk
;

225 
ucc_¡©us_t
 
¡©us
;

227 
sk
 = 
	`ucc_mpoŞ_g‘
(&
sh¬p_ùx
->
»q_mp
);

228 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, 
cŞl_¬gs
, 
‹am
);

229 
	`UCC_TL_SHARP_PROFILE_REQUEST_NEW
(
sk
, "tl_sharp_task", 0);

231 
sk
->
»q_hªdË
 = 
NULL
;

232 
sk
->
su³r
.
fš®ize
 = 
ucc__sh¬p_cŞl_fš®ize
;

234 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
)

236 
UCC_COLL_TYPE_ALLREDUCE
:

237 
¡©us
 = 
	`ucc__sh¬p_®Ìeduû_š™
(
sk
);

239 
UCC_COLL_TYPE_BARRIER
:

240 
¡©us
 = 
	`ucc__sh¬p_b¬r›r_š™
(
sk
);

242 
UCC_COLL_TYPE_BCAST
:

243 
¡©us
 = 
	`ucc__sh¬p_bÿ¡_š™
(
sk
);

245 #ià
HAVE_DECL_SHARP_COLL_DO_REDUCE_SCATTER


246 
UCC_COLL_TYPE_REDUCE_SCATTER
:

247 
¡©us
 = 
	`ucc__sh¬p_»duû_sÿ‰”_š™
(
sk
);

250 #ià
HAVE_DECL_SHARP_COLL_DO_ALLGATHER


251 
UCC_COLL_TYPE_ALLGATHER
:

252 
¡©us
 = 
	`ucc__sh¬p_®lg©h”_š™
(
sk
);

256 
	`_debug
(
	`UCC_TASK_LIB
(
sk
),

258 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
);

259 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

261 ià(
¡©us
 !ğ
UCC_OK
) {

262 
ä“_sk
;

265 
	`_debug
(
	`UCC_TASK_LIB
(
sk
), "init collask %p",ask);

266 *
sk_h
 = &
sk
->
su³r
;

267  
¡©us
;

269 
ä“_sk
:

270 
	`ucc_mpoŞ_put
(
sk
);

271  
¡©us
;

272 
	}
}

274 
ucc_¡©us_t
 
	$ucc__sh¬p_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

275 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

277 
ucc__sh¬p_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_sharp_team_t);

278 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_TEAM_CTX
(
‹am
);

279 
ucc_cŞl_scÜe_t
 *
scÜe
;

280 
ucc_¡©us_t
 
¡©us
;

281 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

282 
i
;

284 
‹am_šfo
.
®g_â
 = 
NULL
;

285 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_TL_SHARP_DEFAULT_SCORE
;

286 
‹am_šfo
.
š™
 = 
ucc__sh¬p_cŞl_š™
;

287 
‹am_šfo
.
num_mem_ty³s
 = 0;

288 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = 
NULL
;

289 
‹am_šfo
.
suµÜ‹d_cŞls
 = 
UCC_TL_SHARP_SUPPORTED_COLLS
;

290 
‹am_šfo
.
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

293 
¡©us
 =

294 
	`ucc_cŞl_scÜe_bud_deçuÉ
(
_‹am
, 
UCC_TL_SHARP_DEFAULT_SCORE
,

295 
ucc__sh¬p_cŞl_š™
,

296 
UCC_TL_SHARP_SUPPORTED_COLLS
,

297 
NULL
, 0, &
scÜe
);

298 ià(
UCC_OK
 !ğ
¡©us
) {

299  
¡©us
;

302 
i
 = 0; i < 
UCC_TL_SHARP_N_DEFAULT_ALG_SELECT_STR
; i++) {

303 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(

304 
ucc__sh¬p_deçuÉ_®g_£Ëù_¡r
[
i
], &
‹am_šfo
,

305 &
‹am
->
su³r
.su³r, 
scÜe
);

306 ià(
UCC_OK
 !ğ
¡©us
) {

307 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
,

309 
ucc__sh¬p_deçuÉ_®g_£Ëù_¡r
[
i
]);

310 
”r
;

314 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

315 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

316 &
‹am
->
su³r
.su³r, 
scÜe
);

318 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

319 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

320 
”r
;

324 *
scÜe_p
 = 
scÜe
;

325  
UCC_OK
;

326 
”r
:

327 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

328  
¡©us
;

329 
	}
}

	@src/components/tl/ucc_tl.c

7 
	~"ucc_.h
"

8 
	~"uts/ucc_log.h
"

9 
	~"cÜe/ucc_‹am.h
"

10 
	~"ucc__log.h
"

12 
ucc_cÚfig_f›ld_t
 
	gucc__lib_cÚfig_bË
[] = {

13 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__lib_cÚfig_t
, 
su³r
),

14 
UCC_CONFIG_TYPE_TABLE
(
ucc_ba£_lib_cÚfig_bË
)},

16 {
NULL
}

19 
ucc_cÚfig_f›ld_t
 
	gucc__cÚ‹xt_cÚfig_bË
[] = {

20 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__cÚ‹xt_cÚfig_t
, 
su³r
),

21 
UCC_CONFIG_TYPE_TABLE
(
ucc_ba£_ùx_cÚfig_bË
)},

23 {
NULL
}

26 
	$UCC_CLASS_INIT_FUNC
(
ucc__lib_t
, 
ucc__içû_t
 *
_içû
,

27 cÚ¡ 
ucc__lib_cÚfig_t
 *
_cÚfig
)

29 
	`UCC_CLASS_CALL_BASE_INIT
();

30 
ucc_ba£_lib_´İ”t›s_t
 
´İ
;

31 
ucc_¡©us_t
 
¡©us
;

33 
¡©us
 = 
_içû
->
lib
.
	`g‘_´İ”t›s
(&
´İ
);

34 ià(
¡©us
 !ğ
UCC_OK
) {

35  
¡©us
;

38 
£lf
->
içû
 = 
_içû
;

39 
£lf
->
su³r
.
u£_tunšg
 = 
_cÚfig
->super.use_tuning;

40 
£lf
->
su³r
.
log_compÚ’t
 = 
_cÚfig
->super.log_component;

41 
£lf
->
su³r
.
mš_‹am_size
 = 
´İ
.
deçuÉ_‹am_size
;

42 
	`ucc_¡ºıy_§ã
(
£lf
->
su³r
.
log_compÚ’t
.
Çme
,

43 
_içû
->
_lib_cÚfig
.
Çme
,

44 (
£lf
->
su³r
.
log_compÚ’t
.
Çme
));

46 ià(
_cÚfig
->
su³r
.
mš_‹am_size
 !ğ
UCC_ULUNITS_AUTO
) {

47 ià(
_cÚfig
->
su³r
.
mš_‹am_size
 < 
´İ
.min_team_size) {

48 
	`_w¬n
(
£lf
, "min supportedeam size is %d,„equested %d",

49 
´İ
.
mš_‹am_size
,

50 (
ucc_¿nk_t
)
_cÚfig
->
su³r
.
mš_‹am_size
);

51 } ià(
_cÚfig
->
su³r
.
mš_‹am_size
 > 
´İ
.
max_‹am_size
) {

52 
	`_w¬n
(
£lf
, "max supportedeam size is %d,„equested %d",

53 
´İ
.
max_‹am_size
,

54 (
ucc_¿nk_t
)
_cÚfig
->
su³r
.
mš_‹am_size
);

56 
£lf
->
su³r
.
mš_‹am_size
 = 
_cÚfig
->super.min_team_size;

60  
UCC_OK
;

61 
	}
}

63 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__lib_t
)

65 
	}
}

67 
UCC_CLASS_DEFINE
(
ucc__lib_t
, );

69 
	$UCC_CLASS_INIT_FUNC
(
ucc__cÚ‹xt_t
, cÚ¡ 
ucc__cÚ‹xt_cÚfig_t
 *
_cÚfig
,

70 
ucc_cÚ‹xt_t
 *
ucc_cÚ‹xt
)

72 
	`UCC_CLASS_CALL_BASE_INIT
();

73 
£lf
->
su³r
.
lib
 = &
_cÚfig
->
_lib
->super;

74 
£lf
->
su³r
.
ucc_cÚ‹xt
 = ucc_context;

75 
£lf
->
»f_couÁ
 = 0;

76 ià(0 =ğ
	`¡rcmp
(
_cÚfig
->
su³r
.
scÜe_¡r
, "0")) {

77  
UCC_ERR_LAST
;

79 
£lf
->
su³r
.
scÜe_¡r
 = 
	`¡rdup
(
_cÚfig
->super.score_str);

81  
UCC_OK
;

82 
	}
}

84 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__cÚ‹xt_t
)

86 
	`ucc_ä“
(
£lf
->
su³r
.
scÜe_¡r
);

87 
	}
}

89 
UCC_CLASS_DEFINE
(
ucc__cÚ‹xt_t
, );

91 
ucc_¡©us_t
 
	$ucc__cÚ‹xt_cÚfig_»ad
(
ucc__lib_t
 *
_lib
,

92 cÚ¡ 
ucc_cÚ‹xt_cÚfig_t
 *
cÚfig
,

93 
ucc__cÚ‹xt_cÚfig_t
 **
_cÚfig
)

95 
ucc_¡©us_t
 
¡©us
;

96 
¡©us
 = 
	`ucc_ba£_cÚfig_»ad
(
cÚfig
->
lib
->
fuÎ_´efix
,

97 &
_lib
->
içû
->
_cÚ‹xt_cÚfig
,

98 (
ucc_ba£_cÚfig_t
 **)
_cÚfig
);

99 ià(
UCC_OK
 =ğ
¡©us
) {

100 (*
_cÚfig
)->
_lib
 =l_lib;

102  
¡©us
;

103 
	}
}

105 
ucc_¡©us_t
 
	$ucc__lib_cÚfig_»ad
(
ucc__içû_t
 *
içû
,

106 cÚ¡ *
fuÎ_´efix
,

107 
ucc__lib_cÚfig_t
 **
_cÚfig
)

109  
	`ucc_ba£_cÚfig_»ad
(
fuÎ_´efix
, &
içû
->
_lib_cÚfig
,

110 (
ucc_ba£_cÚfig_t
 **)
_cÚfig
);

111 
	}
}

113 
ucc_¡©us_t
 
	$ucc__cÚ‹xt_g‘
(
ucc_cÚ‹xt_t
 *
ùx
, cÚ¡ * 
Çme
,

114 
ucc__cÚ‹xt_t
 **
_cÚ‹xt
)

116 
i
;

117 
ucc__lib_t
 *
_lib
;

118 
i
 = 0; i < 
ùx
->
n__ùx
; i++) {

119 
_lib
 = 
	`ucc_d”ived_of
(
ùx
->
_ùx
[
i
]->
su³r
.
lib
, 
ucc__lib_t
);

120 ià(0 =ğ
	`¡rcmp
(
_lib
->
içû
->
su³r
.
Çme
,‚ame)) {

121 
ùx
->
_ùx
[
i
]->
»f_couÁ
++;

122 *
_cÚ‹xt
 = 
ùx
->
_ùx
[
i
];

123  
UCC_OK
;

126  
UCC_ERR_NOT_FOUND
;

127 
	}
}

129 
ucc_¡©us_t
 
	$ucc__cÚ‹xt_put
(
ucc__cÚ‹xt_t
 *
_cÚ‹xt
)

131 
_cÚ‹xt
->
»f_couÁ
--;

132  
UCC_OK
;

133 
	}
}

135 
ucc_¡©us_t


136 
	$ucc_‹am_muÉË_»q_®loc
(
ucc_‹am_muÉË_»q_t
 **
»q
, 
n_‹ams
)

138 
ucc_‹am_muÉË_»q_t
 *
r
;

140 
r
 = 
	`ucc_m®loc
((
ucc_‹am_muÉË_»q_t
) +

141 (
n_‹ams
 - 1è* (
ucc_‹am_‹am_desc
),

143 ià(!
r
) {

144 
ex™_”r
;

146 
r
->
Ï¡
 = -1;

147 
r
->
n_‹ams
 =‚_teams;

148 *
»q
 = 
r
;

149  
UCC_OK
;

150 
ex™_”r
:

151 *
»q
 = 
NULL
;

152  
UCC_ERR_NO_MEMORY
;

153 
	}
}

155 
	$ucc_‹am_muÉË_»q_ä“
(
ucc_‹am_muÉË_»q_t
 *
»q
)

157 
	`ucc_ä“
(
»q
);

158 
	}
}

160 
ucc_¡©us_t
 
	$ucc__is_»achabË
(cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
,

161 
_id
)

163 
ucc_‹am_t
 *
cÜe_‹am
 = 
·¿ms
->
‹am
;

164 
ucc_cÚ‹xt_t
 *
cÜe_cÚ‹xt
 = 
cÜe_‹am
->
cÚ‹xts
[0];

165 
ucc_addr_¡Üage_t
 *
addr_¡Üage
;

166 
ucc_cÚ‹xt_addr_h—d”_t
 *
addr_h—d”
;

167 
ucc_¿nk_t
 
i
, 
¿nk
;

168 
j
, 
u£_ùx
;

170 
	`ucc_as£¹
(
cÜe_‹am
->
num_cÚ‹xts
 == 1);

172 ià(
·¿ms
->
size
 == 1) {

173  
UCC_OK
;

176 ià(
cÜe_cÚ‹xt
->
addr_¡Üage
.
¡Üage
) {

177 
addr_¡Üage
 = &
cÜe_cÚ‹xt
->addr_storage;

178 
u£_ùx
 = 1;

180 
addr_¡Üage
 = &
cÜe_‹am
->addr_storage;

181 
u£_ùx
 = 0;

184 ià(
addr_¡Üage
->
æags
 & 
UCC_ADDR_STORAGE_FLAG_TLS_SYMMETRIC
) {

185  
UCC_OK
;

188 
i
 = 0; i < 
·¿ms
->
size
; i++) {

189 
¿nk
 = 
	`ucc_•_m­_ev®
(
·¿ms
->
m­
, 
i
);

190 ià(
u£_ùx
) {

191 
¿nk
 = 
	`ucc_•_m­_ev®
(
cÜe_‹am
->
ùx_m­
,„ank);

193 
addr_h—d”
 = 
	`UCC_ADDR_STORAGE_RANK_HEADER
(
addr_¡Üage
, 
¿nk
);

194 
j
 = 0; j < 
addr_h—d”
->
n_compÚ’ts
; j++) {

195 ià(
addr_h—d”
->
compÚ’ts
[
j
].
id
 =ğ
_id
) {

199 ià(
j
 =ğ
addr_h—d”
->
n_compÚ’ts
) {

200  
UCC_ERR_NOT_FOUND
;

204  
UCC_OK
;

205 
	}
}

207 
ucc_¡©us_t
 
	$ucc__‹am_ü—‹_muÉË
(
ucc_‹am_muÉË_»q_t
 *
»q
)

209 *
id
 = &
»q
->
Ï¡
;

210 
ucc_ba£_‹am_t
 *
b_‹am
;

211 
ucc_¡©us_t
 
¡©us
;

212 
ucc__lib_t
 *
lib
;

214 ià(*
id
 =ğ
»q
->
n_‹ams
) {

215  
UCC_OK
;

217 ià((*
id
 =ğ-1è|| (
»q
->
descs
[*id].
¡©us
 !ğ
UCC_INPROGRESS
)) {

219 *
id
 += 1;

220 ià(*
id
 =ğ
»q
->
n_‹ams
) {

221  
UCC_OK
;

223 
lib
 = 
	`ucc_d”ived_of
(
»q
->
descs
[*
id
].
ùx
->
su³r
.lib, 
ucc__lib_t
);

224 
¡©us
 = 
	`ucc__is_»achabË
(&
»q
->
descs
[*
id
].
·¿m
,

225 
lib
->
içû
->
su³r
.
id
);

226 ià(
UCC_OK
 !ğ
¡©us
) {

227 
	`ucc_debug
("TL %s is‚ot„eachable, skipping\n",

228 
lib
->
içû
->
su³r
.
Çme
);

230 
¡©us
 = 
	`UCC_TL_CTX_IFACE
(
»q
->
descs
[*
id
].
ùx
)

231 ->
‹am
.
	`ü—‹_po¡
(&((
»q
->
descs
[*
id
].
ùx
->
su³r
)),

232 &
»q
->
descs
[*
id
].
·¿m
, &
b_‹am
);

234 ià(
UCC_OK
 !ğ
¡©us
) {

235 
»q
->
descs
[*
id
].
¡©us
 = status;

236 
»q
->
descs
[*
id
].
‹am
 = 
NULL
;

238 
»q
->
descs
[*
id
].
¡©us
 = 
UCC_INPROGRESS
;

239 
»q
->
descs
[*
id
].
‹am
 = 
	`ucc_d”ived_of
(
b_‹am
, 
ucc__‹am_t
);

241  
UCC_INPROGRESS
;

243 
»q
->
descs
[*
id
].
¡©us
 = 
	`UCC_TL_CTX_IFACE
Ôeq->descs[*id].
ùx
)

244 ->
‹am
.
	`ü—‹_‹¡
(&
»q
->
descs
[*
id
].‹am->
su³r
);

245 ià(
»q
->
descs
[*
id
].
¡©us
 < 0) {

247 
	`UCC_TL_CTX_IFACE
(
»q
->
descs
[*
id
].
ùx
)->
‹am
.
	`de¡roy
(

248 &
»q
->
descs
[*
id
].
‹am
->
su³r
);

250  
UCC_INPROGRESS
;

251 
	}
}

253 
ucc_¡©us_t
 
	$ucc__‹am_de¡roy_muÉË
(
ucc_‹am_muÉË_»q_t
 *
»q
)

255 *
id
 = &
»q
->
Ï¡
;

256 
ucc_¡©us_t
 
¡©us
;

257 ià(*
id
 < 0) (*id)++;

258 *
id
 !ğ
»q
->
n_‹ams
) {

259 
¡©us
 = 
	`UCC_TL_TEAM_IFACE
(
»q
->
descs
[*
id
].
‹am
)

260 ->
‹am
.
	`de¡roy
(&
»q
->
descs
[*
id
].‹am->
su³r
);

261 
»q
->
descs
[*
id
].
¡©us
 = status;

262 ià(
UCC_INPROGRESS
 !ğ
¡©us
) {

263 (*
id
)++;

265  
UCC_INPROGRESS
;

268  
UCC_OK
;

269 
	}
}

271 
	$UCC_CLASS_INIT_FUNC
(
ucc__‹am_t
, 
ucc__cÚ‹xt_t
 *
_cÚ‹xt
,

272 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

274 
	`UCC_CLASS_CALL_BASE_INIT
();

275 
ucc_ba£_lib_t
 *
lib
 = 
_cÚ‹xt
->
su³r
.lib;

276 
ucc_ba£_lib_©Œ_t
 
©Œ
;

277 
ucc__içû_t
 *
_içû
;

278 
ucc_¡©us_t
 
¡©us
;

280 
£lf
->
su³r
.
cÚ‹xt
 = &
_cÚ‹xt
->super;

281 
£lf
->
su³r
.
·¿ms
 = *params;

283 
_içû
 = 
	`UCC_TL_CTX_IFACE
(
_cÚ‹xt
);

284 
©Œ
.
mask
 = 
UCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
 |

285 
UCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
;

286 
¡©us
 = 
_içû
->
lib
.
	`g‘_©Œ
Öib, &
©Œ
);

287 ià(
¡©us
 !ğ
UCC_OK
) {

288  
¡©us
;

291 ià(
©Œ
.
mš_‹am_size
 > 
·¿ms
->
size
) {

292 
	`_debug
(
lib
, "team size %d isoo small, min supported %d",

293 
·¿ms
->
size
, 
©Œ
.
mš_‹am_size
);

294  
UCC_ERR_NOT_SUPPORTED
;

297 ià(
©Œ
.
max_‹am_size
 < 
·¿ms
->
size
) {

298 
	`_debug
(
lib
, "team size %d isoo big, max supported %d",

299 
·¿ms
->
size
, 
©Œ
.
max_‹am_size
);

300  
UCC_ERR_NOT_SUPPORTED
;

303  
UCC_OK
;

304 
	}
}

306 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__‹am_t
)

308 
	}
}

310 
UCC_CLASS_DEFINE
(
ucc__‹am_t
, );

	@src/components/tl/ucc_tl.h

7 
	~"cÚfig.h
"

9 #iâdeà
UCC_TL_H_


10 
	#UCC_TL_H_


	)

12 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

13 
	~"cÜe/ucc_cÚ‹xt.h
"

14 
	~"uts/ucc_sys.h
"

25 
ucc__lib
 
	tucc__lib_t
;

26 
ucc__içû
 
	tucc__içû_t
;

27 
ucc__cÚ‹xt
 
	tucc__cÚ‹xt_t
;

28 
ucc__‹am
 
	tucc__‹am_t
;

30 
	succ__lib_cÚfig
 {

31 
ucc_ba£_lib_cÚfig_t
 
	msu³r
;

32 
ucc__içû_t
 *
	miçû
;

33 } 
	tucc__lib_cÚfig_t
;

34 
ucc_cÚfig_f›ld_t
 
ucc__lib_cÚfig_bË
[];

36 
	succ__cÚ‹xt_cÚfig
 {

37 
ucc_ba£_ùx_cÚfig_t
 
	msu³r
;

38 
ucc__lib_t
 *
	m_lib
;

39 } 
	tucc__cÚ‹xt_cÚfig_t
;

40 
ucc_cÚfig_f›ld_t
 
ucc__cÚ‹xt_cÚfig_bË
[];

42 
ucc_¡©us_t
 
ucc__cÚ‹xt_cÚfig_»ad
(
ucc__lib_t
 *
_lib
,

43 cÚ¡ 
ucc_cÚ‹xt_cÚfig_t
 *
cÚfig
,

44 
ucc__cÚ‹xt_cÚfig_t
 **
ş_cÚfig
);

46 
ucc_¡©us_t
 
ucc__lib_cÚfig_»ad
(
ucc__içû_t
 *
içû
,

47 cÚ¡ *
fuÎ_´efix
,

48 
ucc__lib_cÚfig_t
 **
ş_cÚfig
);

50 
	succ__£rviû_cŞl
 {

51 
ucc_¡©us_t
 (*
®Ìeduû
)(
ucc_ba£_‹am_t
 *
	m‹am
, *
	msbuf
, *
	mrbuf
,

52 
ucc_d©©y³_t
 
	mdt
, 
size_t
 
	mcouÁ
,

53 
ucc_»duùiÚ_İ_t
 
	mİ
, 
ucc_sub£t_t
 
	msub£t
,

54 
ucc_cŞl_sk_t
 **
	msk
);

55 
ucc_¡©us_t
 (*
®lg©h”
)(
ucc_ba£_‹am_t
 *
	m‹am
, *
	msbuf
, *
	mrbuf
,

56 
size_t
 
	mmsgsize
, 
ucc_sub£t_t
 
	msub£t
,

57 
ucc_cŞl_sk_t
 **
	msk
);

58 
ucc_¡©us_t
 (*
bÿ¡
)(
ucc_ba£_‹am_t
 *
	m‹am
, *
	mbuf
, 
size_t
 
	mmsgsize
,

59 
ucc_¿nk_t
 
	mroÙ
, 
ucc_sub£t_t
 
	msub£t
,

60 
ucc_cŞl_sk_t
 **
	msk
);

61 (*
	mupd©e_id
)(
ucc_ba£_‹am_t
 *
	m‹am
, 
ušt16_t
 
	mid
);

62 } 
	tucc__£rviû_cŞl_t
;

64 
	succ__cŞl_¶ugš_içû
 {

65 
ucc_compÚ’t_içû_t
 
	msu³r
;

66 
ucs_cÚfig_glob®_li¡_’Œy_t
 
	mcÚfig
;

67 
ucc_g‘_cŞl_scÜes_â_t
 
	mg‘_scÜes
;

68 
ušt32_t
 
	mid
;

69 } 
	tucc__cŞl_¶ugš_içû_t
;

71 
	succ__içû
 {

72 
ucc_compÚ’t_içû_t
 
	msu³r
;

73 
ucs_cÚfig_glob®_li¡_’Œy_t
 
	m_lib_cÚfig
;

74 
ucs_cÚfig_glob®_li¡_’Œy_t
 
	m_cÚ‹xt_cÚfig
;

75 
ucc_ba£_lib_içû_t
 
	mlib
;

76 
ucc_ba£_cÚ‹xt_içû_t
 
	mcÚ‹xt
;

77 
ucc_ba£_‹am_içû_t
 
	m‹am
;

78 
ucc_ba£_cŞl_içû_t
 
	mcŞl
;

79 
ucc__£rviû_cŞl_t
 
	mscŞl
;

80 
ucc_ba£_cŞl_®g_šfo_t
 * 
	m®g_šfo
[
UCC_COLL_TYPE_NUM
];

81 
ucc_compÚ’t_äamewÜk_t
 
	mcŞl_¶ugšs
;

82 } 
	tucc__içû_t
;

84 
	succ__lib
 {

85 
ucc_ba£_lib_t
 
	msu³r
;

86 
ucc__içû_t
 *
	miçû
;

87 } 
	tucc__lib_t
;

88 
UCC_CLASS_DECLARE
(
ucc__lib_t
, 
ucc__içû_t
 *, cÚ¡ 
ucc__lib_cÚfig_t
 *);

90 
	succ__cÚ‹xt
 {

91 
ucc_ba£_cÚ‹xt_t
 
	msu³r
;

92 
	m»f_couÁ
;

93 } 
	tucc__cÚ‹xt_t
;

94 
UCC_CLASS_DECLARE
(
ucc__cÚ‹xt_t
, cÚ¡ 
ucc__cÚ‹xt_cÚfig_t
 *,

95 
ucc_cÚ‹xt_t
 *);

97 
	succ__‹am
 {

98 
ucc_ba£_‹am_t
 
	msu³r
;

99 } 
	tucc__‹am_t
;

100 
UCC_CLASS_DECLARE
(
ucc__‹am_t
, 
ucc__cÚ‹xt_t
 *,

101 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

103 
	#UCC_TL_IFACE_DECLARE
(
_Çme
, 
_NAME
) \

104 
	`UCC_BASE_IFACE_DECLARE
(
TL_
, 
_
, 
_Çme
, 
_NAME
)

	)

106 
ucc_¡©us_t
 
ucc__cÚ‹xt_g‘
(
ucc_cÚ‹xt_t
 *
ùx
, cÚ¡ *
Çme
,

107 
ucc__cÚ‹xt_t
 **
_cÚ‹xt
);

108 
ucc_¡©us_t
 
ucc__cÚ‹xt_put
(
ucc__cÚ‹xt_t
 *
_cÚ‹xt
);

110 
	succ_‹am_muÉË_»q
 {

111 
	mn_‹ams
;

112 
	mÏ¡
;

113 
	succ_‹am_‹am_desc
 {

114 
ucc__cÚ‹xt_t
 *
	mùx
;

115 
ucc__‹am_t
 *
	m‹am
;

116 
ucc_ba£_‹am_·¿ms_t
 
	m·¿m
;

117 
ucc_¡©us_t
 
	m¡©us
;

118 
ušt64_t
 
	m¬gs
[2];

119 } 
	mdescs
[1];

120 } 
	tucc_‹am_muÉË_»q_t
;

122 
ucc_¡©us_t


123 
ucc_‹am_muÉË_»q_®loc
(
ucc_‹am_muÉË_»q_t
 **
»q
,

124 
n_‹ams
);

126 
ucc_¡©us_t
 
ucc__‹am_ü—‹_muÉË
(
ucc_‹am_muÉË_»q_t
 *
»q
);

127 
ucc_¡©us_t
 
ucc__‹am_de¡roy_muÉË
(
ucc_‹am_muÉË_»q_t
 *
»q
);

129 
ucc_‹am_muÉË_»q_ä“
(
ucc_‹am_muÉË_»q_t
 *
»q
);

131 
	succ__lib_©Œ
 {

132 
ucc_ba£_lib_©Œ_t
 
	msu³r
;

133 } 
	tucc__lib_©Œ_t
;

135 
	#UCC_TL_CTX_IFACE
(
__ùx
) \

136 (
	`ucc_d”ived_of
((
__ùx
)->
su³r
.
lib
, 
ucc__lib_t
))->
içû


	)

138 
	#UCC_TL_TEAM_IFACE
(
__‹am
) \

139 (
	`ucc_d”ived_of
((
__‹am
)->
su³r
.
cÚ‹xt
->
lib
, 
ucc__lib_t
))->
içû


	)

146 
	#UCC_TL_TEAM_LIB
(
__‹am
è(__‹am)->
su³r
.su³r.
cÚ‹xt
->
lib


	)

153 
	#UCC_TL_TEAM_CTX
(
__‹am
è(__‹am)->
su³r
.su³r.
cÚ‹xt


	)

155 
	#UCC_TL_CORE_CTX
(
__‹am
è((__‹am)->
su³r
.su³r.
cÚ‹xt
->
ucc_cÚ‹xt
)

	)

157 
	#UCC_TL_CTX_OOB
(
_ùx
è((_ùx)->
su³r
.su³r.
ucc_cÚ‹xt
->
·¿ms
.
oob
)

	)

159 
	#UCC_TL_TEAM_SIZE
(
__‹am
è(__‹am)->
su³r
.su³r.
·¿ms
.
size


	)

161 
	#UCC_TL_TEAM_RANK
(
__‹am
è(__‹am)->
su³r
.su³r.
·¿ms
.
¿nk


	)

163 
	#UCC_TL_CORE_TEAM
(
__‹am
è(__‹am)->
su³r
.su³r.
·¿ms
.
‹am


	)

165 
	#UCC_TL_TEAM_MAP
(
__‹am
è(__‹am)->
su³r
.su³r.
·¿ms
.
m­


	)

167 
	#UCC_TL_TEAM_OOB
(
__‹am
è(__‹am)->
su³r
.su³r.
·¿ms
.·¿ms.
oob


	)

169 
	#UCC_TL_IS_SERVICE_TEAM
(
__‹am
) \

170 ((
__‹am
)->
su³r
.su³r.
·¿ms
.
scİe
 =ğ
UCC_CL_LAST
 + 1)

	)

	@src/components/tl/ucc_tl_log.h

7 #iâdeà
UCC_TL_LOG_H_


8 
	#UCC_TL_LOG_H_


	)

9 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

11 
	#_”rÜ
(
__lib
, 
_fmt
, ...è
	`ba£_”rÜ
((
ucc_ba£_lib_t
*)(__lib), _fmt, ## 
__VA_ARGS__
)

	)

12 
	#_w¬n
(
__lib
, 
_fmt
, ...è
	`ba£_w¬n
((
ucc_ba£_lib_t
*)(__lib), _fmt, ## 
__VA_ARGS__
)

	)

13 
	#_šfo
(
__lib
, 
_fmt
, ...è
	`ba£_šfo
((
ucc_ba£_lib_t
*)(__lib), _fmt, ## 
__VA_ARGS__
)

	)

14 
	#_debug
(
__lib
, 
_fmt
, ...è
	`ba£_debug
((
ucc_ba£_lib_t
*)(__lib), _fmt, ## 
__VA_ARGS__
)

	)

15 
	#_Œaû
(
__lib
, 
_fmt
, ...è
	`ba£_Œaû
((
ucc_ba£_lib_t
*)(__lib), _fmt, ## 
__VA_ARGS__
)

	)

	@src/components/tl/ucp/allgather/allgather.c

6 
	~"cÚfig.h
"

7 
	~"_uı.h
"

8 
	~"®lg©h”.h
"

9 
	~"../../../uts/ucc_¡ršg.h
"

10 
	~"../../../uts/ucc_log.h
"

11 
	~"../../../uts/ucc_cŞl_uts.h
"

13 
	#ALLGATHER_MAX_PATTERN_SIZE
 \

14 ((
UCC_TL_UCP_ALLGATHER_DEFAULT_ALG_SELECT_STR_1PPN
è* 2)

	)

16 
ucc_ba£_cŞl_®g_šfo_t


17 
	gucc__uı_®lg©h”_®gs
[
UCC_TL_UCP_ALLGATHER_ALG_LAST
 + 1] = {

18 [
UCC_TL_UCP_ALLGATHER_ALG_KNOMIAL
] =

19 {.
id
 = 
UCC_TL_UCP_ALLGATHER_ALG_KNOMIAL
,

20 .
	gÇme
 = "knomial",

21 .
	gdesc
 = "recursive k-ing with‡rbitrary„adix"},

22 [
UCC_TL_UCP_ALLGATHER_ALG_RING
] =

23 {.
id
 = 
UCC_TL_UCP_ALLGATHER_ALG_RING
,

24 .
	gÇme
 = "ring",

25 .
	gdesc
 = "O(N) Ring"},

26 [
UCC_TL_UCP_ALLGATHER_ALG_NEIGHBOR
] =

27 {.
id
 = 
UCC_TL_UCP_ALLGATHER_ALG_NEIGHBOR
,

28 .
	gÇme
 = "neighbor",

29 .
	gdesc
 = "O(N) Neighbor Exchange N/2 steps"},

30 [
UCC_TL_UCP_ALLGATHER_ALG_BRUCK
] =

31 {.
id
 = 
UCC_TL_UCP_ALLGATHER_ALG_BRUCK
,

32 .
	gÇme
 = "bruck",

33 .
	gdesc
 = "O(log(N)) Variation of Bruck‡lgorithm"},

34 [
UCC_TL_UCP_ALLGATHER_ALG_SPARBIT
] =

35 {.
id
 = 
UCC_TL_UCP_ALLGATHER_ALG_SPARBIT
,

36 .
	gÇme
 = "sparbit",

37 .
	gdesc
 = "O(log(N)) SPARBIT‡lgorithm"},

38 [
UCC_TL_UCP_ALLGATHER_ALG_LINEAR
] =

39 {.
id
 = 
UCC_TL_UCP_ALLGATHER_ALG_LINEAR
,

40 .
	gÇme
 = "linear",

41 .
	gdesc
 = "O(N - 1) Linear‡lgorithm, one-shot"},

42 [
UCC_TL_UCP_ALLGATHER_ALG_LINEAR_BATCHED
] =

43 {.
id
 = 
UCC_TL_UCP_ALLGATHER_ALG_LINEAR_BATCHED
,

44 .
	gÇme
 = "batched",

45 .
	gdesc
 = "O(N - 1) Linear‡lgorithm, K-send/receive in flight"},

46 [
UCC_TL_UCP_ALLGATHER_ALG_LAST
] = {

47 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

49 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_š™
(
ucc__uı_sk_t
 *
sk
)

51  
	`ucc__uı_®lg©h”_ršg_š™_commÚ
(
sk
);

52 
	}
}

54 *
	$ucc__uı_®lg©h”_scÜe_¡r_g‘
(
ucc__uı_‹am_t
 *
‹am
)

56 
max_size
 = 
ALLGATHER_MAX_PATTERN_SIZE
;

57 
®go_num
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
) % 2

58 ? 
UCC_TL_UCP_ALLGATHER_ALG_RING


59 : 
UCC_TL_UCP_ALLGATHER_ALG_NEIGHBOR
;

60 * 
¡r
 = 
	`ucc_m®loc
(
max_size
 * ());

61 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

62 
ušt64_t
 
cuda_ty³s
 =

63 
ùx
->
uı_memÜy_ty³s
 &

64 (
	`UCC_BIT
(
UCC_MEMORY_TYPE_CUDA
è| UCC_BIT(
UCC_MEMORY_TYPE_CUDA_MANAGED
));

65 
ušt64_t
 
nÚ_cuda_ty³s
 = 
ùx
->
uı_memÜy_ty³s
 & (~
cuda_ty³s
);

66 
ucc_sbgp_t
 *
sbgp
;

67 * 
nÚ_cuda_¡r
;

68 * 
cuda_¡r
;

70 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

71 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
‹am
->
tİo
, 
UCC_SBGP_FULL_HOST_ORDERED
);

72 ià(!
	`ucc_•_m­_is_id’t™y
(&
sbgp
->
m­
)) {

73 
®go_num
 = 
UCC_TL_UCP_ALLGATHER_ALG_RING
;

77 ià(
‹am
->
tİo
 && 
	`ucc_tİo_is_sšgË_µn
(team->topo)) {

78 ià(
cuda_ty³s
) {

79 
cuda_¡r
 = 
	`ucc_m®loc
(
max_size
 * ());

80 
	`ucc_mty³_m­_to_¡r
(
cuda_ty³s
, ",", 
cuda_¡r
, 
max_size
);

81 ià(
nÚ_cuda_ty³s
) {

82 
nÚ_cuda_¡r
 = 
	`ucc_m®loc
(
max_size
 * ());

83 
	`ucc_mty³_m­_to_¡r
(
nÚ_cuda_ty³s
, ",", 
nÚ_cuda_¡r
,

84 
max_size
);

85 
	`ucc_¢´štf_§ã
(

86 
¡r
, 
max_size
,

87 
UCC_TL_UCP_ALLGATHER_DEFAULT_ALG_SELECT_STR_1PPN
, 
cuda_¡r
,

88 
nÚ_cuda_¡r
, 
®go_num
);

89 
	`ucc_ä“
(
cuda_¡r
);

90 
	`ucc_ä“
(
nÚ_cuda_¡r
);

91  
¡r
;

93 
	`ucc_¢´štf_§ã
(

94 
¡r
, 
max_size
,

95 
UCC_TL_UCP_ALLGATHER_DEFAULT_ALG_SELECT_STR_1PPN_CUDA
, 
cuda_¡r
,

96 
®go_num
);

97 
	`ucc_ä“
(
cuda_¡r
);

98  
¡r
;

101 
	`ucc_¢´štf_§ã
(
¡r
, 
max_size
,

102 
UCC_TL_UCP_ALLGATHER_DEFAULT_ALG_SELECT_STR
, 
®go_num
);

103  
¡r
;

104 
	}
}

	@src/components/tl/ucp/allgather/allgather.h

6 #iâdeà
ALLGATHER_H_


7 
	#ALLGATHER_H_


	)

8 
	~"../_uı.h
"

9 
	~"../_uı_cŞl.h
"

12 
	mUCC_TL_UCP_ALLGATHER_ALG_KNOMIAL
,

13 
	mUCC_TL_UCP_ALLGATHER_ALG_RING
,

14 
	mUCC_TL_UCP_ALLGATHER_ALG_NEIGHBOR
,

15 
	mUCC_TL_UCP_ALLGATHER_ALG_BRUCK
,

16 
	mUCC_TL_UCP_ALLGATHER_ALG_SPARBIT
,

17 
	mUCC_TL_UCP_ALLGATHER_ALG_LINEAR
,

18 
	mUCC_TL_UCP_ALLGATHER_ALG_LINEAR_BATCHED
,

19 
	mUCC_TL_UCP_ALLGATHER_ALG_LAST


22 
ucc_ba£_cŞl_®g_šfo_t


23 
ucc__uı_®lg©h”_®gs
[
UCC_TL_UCP_ALLGATHER_ALG_LAST
 + 1];

25 
	#UCC_TL_UCP_ALLGATHER_DEFAULT_ALG_SELECT_STR
 \

26 "®lg©h”:0-4k:@0#®lg©h”:4k-šf:@%d"

	)

28 
	#UCC_TL_UCP_ALLGATHER_DEFAULT_ALG_SELECT_STR_1PPN
 \

29 "®lg©h”:0-4k:@0#®lg©h”:4k-šf:%s:@0#®lg©h”:4k-šf:%s:@%d"

	)

31 
	#UCC_TL_UCP_ALLGATHER_DEFAULT_ALG_SELECT_STR_1PPN_CUDA
 \

32 "®lg©h”:0-4k:@0#®lg©h”:4k-šf:%s:@0#®lg©h”:4k-šf:@%d"

	)

34 *
ucc__uı_®lg©h”_scÜe_¡r_g‘
(
ucc__uı_‹am_t
 *
‹am
);

36 
šlše
 
	$ucc__uı_®lg©h”_®g_äom_¡r
(cÚ¡ *
¡r
)

38 
i
;

39 
i
 = 0; i < 
UCC_TL_UCP_ALLGATHER_ALG_LAST
; i++) {

40 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__uı_®lg©h”_®gs
[
i
].
Çme
)) {

44  
i
;

45 
	}
}

47 
ucc_¡©us_t
 
ucc__uı_®lg©h”_š™
(
ucc__uı_sk_t
 *
sk
);

50 
ucc_¡©us_t
 
ucc__uı_®lg©h”_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

51 
ucc_ba£_‹am_t
 *
‹am
,

52 
ucc_cŞl_sk_t
 **
sk_h
);

54 
ucc_¡©us_t
 
ucc__uı_®lg©h”_ršg_š™_commÚ
(
ucc__uı_sk_t
 *
sk
);

56 
ucc__uı_®lg©h”_ršg_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

58 
ucc_¡©us_t
 
ucc__uı_®lg©h”_ršg_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

61 
ucc_¡©us_t
 
ucc__uı_®lg©h”_ÃighbÜ_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

62 
ucc_ba£_‹am_t
 *
‹am
,

63 
ucc_cŞl_sk_t
 **
sk_h
);

65 
ucc__uı_®lg©h”_ÃighbÜ_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

68 
ucc_¡©us_t
 
ucc__uı_®lg©h”_bruck_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

69 
ucc_ba£_‹am_t
 *
‹am
,

70 
ucc_cŞl_sk_t
 **
sk_h
);

72 
ucc__uı_®lg©h”_bruck_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

74 
ucc_¡©us_t
 
ucc__uı_®lg©h”_bruck_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

77 
ucc_¡©us_t
 
ucc__uı_®lg©h”_¥¬b™_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

78 
ucc_ba£_‹am_t
 *
‹am
,

79 
ucc_cŞl_sk_t
 **
sk_h
);

82 
ucc_¡©us_t
 
ucc__uı_®lg©h”_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

83 
ucc_ba£_‹am_t
 *
‹am
,

84 
ucc_cŞl_sk_t
 **
sk_h
);

86 
ucc__uı_®lg©h”_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

89 
ucc_¡©us_t


90 
ucc__uı_®lg©h”_lš—r_b©ched_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

91 
ucc_ba£_‹am_t
 *
‹am
,

92 
ucc_cŞl_sk_t
 **
sk_h
);

95 
ucc_¡©us_t
 
ucc__uı_®lg©h”_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

96 
ucc_ba£_‹am_t
 *
‹am
,

97 
ucc_cŞl_sk_t
 **
sk_h
);

100 
ucc_¡©us_t
 
ucc__uı_®lg©h”_knomŸl_š™_r
(

101 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

102 
ucc_cŞl_sk_t
 **
sk_h
, 
ucc_kn_¿dix_t
 
¿dix
);

	@src/components/tl/ucp/allgather/allgather_bruck.c

6 
	~"cÚfig.h
"

7 
	~"_uı.h
"

8 
	~"®lg©h”.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"compÚ’ts/mc/ucc_mc.h
"

15 
ucc_¡©us_t
 
ucc__uı_®lg©h”_bruck_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

17 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_bruck_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

18 
ucc_ba£_‹am_t
 *
‹am
,

19 
ucc_cŞl_sk_t
 **
sk_h
)

21 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

22 
ucc__uı_sk_t
 *
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

23 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

24 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
_‹am
);

25 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

26 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

27 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

28 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

29 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

30 
size_t
 
sü©ch_size
 = (
tsize
 - 
Œªk
è* 
d©a_size
;

32 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&
	`TASK_ARGS
(
sk
), 
UCC_RANK_INVALID
)) {

33 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "user defined datatype is‚ot supported");

34 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

35 
out
;

37 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "ucc_tl_ucp_allgather_bruck_init");

39 
sk
->
su³r
.
po¡
 = 
ucc__uı_®lg©h”_bruck_¡¬t
;

40 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®lg©h”_bruck_´og»ss
;

41 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_®lg©h”_bruck_fš®ize
;

44 ià(
Œªk
 != 0) {

45 ià(
UCC_MEMORY_TYPE_HOST
 !ğ
rmem
) {

46 
sü©ch_size
 = 
tsize
 * 
d©a_size
;

48 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
®lg©h”_bruck
.
sü©ch_h—d”
,

49 
sü©ch_size
, 
UCC_MEMORY_TYPE_HOST
);

50 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

51 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo‡llocate scratch buffer");

52 
	`ucc__uı_cŞl_fš®ize
(&
sk
->
su³r
);

53 
out
;

55 
sk
->
®lg©h”_bruck
.
sü©ch_size
 = scratch_size;

57 
sk
->
®lg©h”_bruck
.
sü©ch_h—d”
 = 
NULL
;

58 
sk
->
®lg©h”_bruck
.
sü©ch_size
 = 0;

60 
out
:

61 ià(
¡©us
 !ğ
UCC_OK
) {

62 
	`ucc__uı_put_sk
(
sk
);

63  
¡©us
;

66 *
sk_h
 = &
sk
->
su³r
;

67  
¡©us
;

68 
	}
}

70 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_bruck_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

72 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

73 
ucc_¡©us_t
 
glob®_¡©us
 = 
UCC_OK
;

74 
ucc_¡©us_t
 
¡©us
;

76 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "ucc_tl_ucp_allgather_bruck_finalize");

78 ià(
sk
->
®lg©h”_bruck
.
sü©ch_h—d”
 !ğ
NULL
) {

80 
glob®_¡©us
 = 
	`ucc_mc_ä“
(
sk
->
®lg©h”_bruck
.
sü©ch_h—d”
);

81 ià(
	`ucc_uÆik–y
(
glob®_¡©us
 !ğ
UCC_OK
)) {

82 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

85 
sk
->
®lg©h”_bruck
.
sü©ch_size
 = 0;

88 
¡©us
 = 
	`ucc__uı_cŞl_fš®ize
(&
sk
->
su³r
);

89 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

90 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

92 
glob®_¡©us
 = 
¡©us
;

94  
glob®_¡©us
;

95 
	}
}

98 
	$ucc__uı_®lg©h”_bruck_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

100 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

101 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

102 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

103 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

104 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

105 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

106 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

107 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

108 
ucc_mc_bufãr_h—d”_t
 *
sü©ch_h—d”
 =

109 
sk
->
®lg©h”_bruck
.
sü©ch_h—d”
;

110 
size_t
 
sü©ch_size
 = 
sk
->
®lg©h”_bruck
.scratch_size;

111 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

112 
ucc_¿nk_t
 
»cväom
, 
£ndto
;

113 
ucc_¡©us_t
 
¡©us
;

114 
size_t
 
blockcouÁ
, 
di¡ªû
;

115 *
tm´ecv
, *
tmp£nd
;

117 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

122 
di¡ªû
 = 1 << 
sk
->
gged
.
»cv_po¡ed
;

123 
tmp£nd
 = 
rbuf
;

124 
di¡ªû
 < 
tsize
) {

126 
»cväom
 = (
Œªk
 + 
di¡ªû
è% 
tsize
;

127 
£ndto
 = (
Œªk
 + 
tsize
 - 
di¡ªû
) %size;

129 
tm´ecv
 = 
	`PTR_OFFSET
(
tmp£nd
, 
di¡ªû
 * 
d©a_size
);

131 ià(
di¡ªû
 <ğ
tsize
 >> 1) {

132 
blockcouÁ
 = 
di¡ªû
;

135 
blockcouÁ
 = 
tsize
 - 
di¡ªû
;

139 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
tmp£nd
, 
blockcouÁ
 * 
d©a_size
, 
rmem
,

140 
£ndto
, 
‹am
, 
sk
),

141 
sk
, 
out
);

142 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
tm´ecv
, 
blockcouÁ
 * 
d©a_size
, 
rmem
,

143 
»cväom
, 
‹am
, 
sk
),

144 
sk
, 
out
);

146 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_»cv
(
sk
)) {

150 
di¡ªû
 = 1 << 
sk
->
gged
.
»cv_po¡ed
;

153 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

158 ià(
Œªk
 != 0) {

159 ià(
UCC_MEMORY_TYPE_HOST
 =ğ
rmem
) {

161 
¡©us
 = 
	`ucc_mc_memıy
(
sü©ch_h—d”
->
addr
, 
rbuf
, 
sü©ch_size
,

162 
UCC_MEMORY_TYPE_HOST
, 
rmem
);

163 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

164 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

166 
sk
->
su³r
.
¡©us
 = status;

171 
	`memmove
(
rbuf
, 
	`PTR_OFFSET
Ôbuf, 
sü©ch_size
), 
Œªk
 * 
d©a_size
);

173 
¡©us
 = 
	`ucc_mc_memıy
(
	`PTR_OFFSET
(
rbuf
, 
Œªk
 * 
d©a_size
),

174 
sü©ch_h—d”
->
addr
, 
sü©ch_size
, 
rmem
,

175 
UCC_MEMORY_TYPE_HOST
);

176 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

177 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

179 
sk
->
su³r
.
¡©us
 = status;

185 
¡©us
 = 
	`ucc_mc_memıy
(

186 
	`PTR_OFFSET
(
sü©ch_h—d”
->
addr
, 
Œªk
 * 
d©a_size
), 
rbuf
,

187 (
tsize
 - 
Œªk
è* 
d©a_size
, 
UCC_MEMORY_TYPE_HOST
, 
rmem
);

188 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

189 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

191 
sk
->
su³r
.
¡©us
 = status;

194 
¡©us
 =

195 
	`ucc_mc_memıy
(
sü©ch_h—d”
->
addr
,

196 
	`PTR_OFFSET
(
rbuf
, (
tsize
 - 
Œªk
è* 
d©a_size
),

197 
Œªk
 * 
d©a_size
, 
UCC_MEMORY_TYPE_HOST
, 
rmem
);

198 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

199 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

201 
sk
->
su³r
.
¡©us
 = status;

204 
¡©us
 =

205 
	`ucc_mc_memıy
(
rbuf
, 
sü©ch_h—d”
->
addr
, 
tsize
 * 
d©a_size
,

206 
rmem
, 
UCC_MEMORY_TYPE_HOST
);

207 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

208 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

210 
sk
->
su³r
.
¡©us
 = status;

216 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

218 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

220 
out
:

221 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_bruck_done", 0);

222 
	}
}

224 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_bruck_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

226 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

227 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

228 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

229 *
sbuf
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
;

230 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

231 
ucc_memÜy_ty³_t
 
smem
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
;

232 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

233 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

234 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

235 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

236 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

237 
ucc_¡©us_t
 
¡©us
;

239 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_bruck_start", 0);

240 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

243 ià(!
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

245 
¡©us
 = 
	`ucc_mc_memıy
(
rbuf
, 
sbuf
, 
d©a_size
, 
rmem
, 
smem
);

246 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

247  
¡©us
;

249 } ià(
Œªk
 != 0) {

251 
¡©us
 = 
	`ucc_mc_memıy
(
rbuf
, 
	`PTR_OFFSET
Ôbuf, 
d©a_size
 * 
Œªk
),

252 
d©a_size
, 
rmem
,„mem);

253 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

254  
¡©us
;

258  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

259 
	}
}

	@src/components/tl/ucp/allgather/allgather_knomial.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"_uı_cŞl.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"_uı_cİy.h
"

12 
	~"cÜe/ucc_´og»ss_queue.h
"

13 
	~"compÚ’ts/mc/ucc_mc.h
"

14 
	~"cŞl_·‰”ns/¤a_knomŸl.h
"

15 
	~"uts/ucc_m©h.h
"

16 
	~"uts/ucc_cŞl_uts.h
"

18 
	#SAVE_STATE
(
_pha£
) \

20 
sk
->
®lg©h”_kn
.
pha£
 = 
_pha£
; \

21 } 0)

	)

23 
	#GET_LOCAL_COUNT
(
_¬gs
, 
_size
, 
_¿nk
) \

24 ((
_¬gs
)->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHERV
) \

25 ? 
	`ucc_cŞl_¬gs_g‘_couÁ
((
_¬gs
), (_¬gs)->
d¡
.
šfo_v
.
couÁs
, \

26 (
_¿nk
)) \

27 : (
_¬gs
)->
d¡
.
šfo
.
couÁ
 / (
_size
)

	)

29 
	#GET_TOTAL_COUNT
(
_¬gs
, 
_size
) \

30 ((
_¬gs
)->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHERV
) \

31 ? 
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
((
_¬gs
), (_¬gs)->
d¡
.
šfo_v
.
couÁs
, \

32 (
_size
)) \

33 : (
_¬gs
)->
d¡
.
šfo
.
couÁ


	)

35 
	#GET_DT
(
_¬gs
) \

36 ((
_¬gs
)->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHERV
) \

37 ? (
_¬gs
)->
d¡
.
šfo_v
.
d©©y³
 \

38 : (
_¬gs
)->
d¡
.
šfo
.
d©©y³


	)

40 
	#GET_DST
(
_¬gs
) \

41 ((
_¬gs
)->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHERV
) \

42 ? (
_¬gs
)->
d¡
.
šfo_v
.
bufãr
 \

43 : (
_¬gs
)->
d¡
.
šfo
.
bufãr


	)

45 
	#GET_MT
(
_¬gs
) \

46 ((
_¬gs
)->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHERV
) \

47 ? (
_¬gs
)->
d¡
.
šfo_v
.
mem_ty³
 \

48 : (
_¬gs
)->
d¡
.
šfo
.
mem_ty³


	)

56 
	$ucc__uı_®lg©h”_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

58 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

59 
ucc__uı_sk_t
);

60 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

61 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

62 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

63 
ucc_kn_¿dix_t
 
¿dix
 = 
sk
->
®lg©h”_kn
.
p
.radix;

64 
ušt8_t
 
node_ty³
 = 
sk
->
®lg©h”_kn
.
p
.node_type;

65 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
®lg©h”_kn
.p;

66 *
rbuf
 = 
	`GET_DST
(
¬gs
);

67 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
	`GET_MT
(
¬gs
);

68 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
	`GET_DT
(
¬gs
));

69 
ucc_¿nk_t
 
size
 = 
sk
->
sub£t
.
m­
.
•_num
;

70 
size_t
 
d©a_size
 = 
	`GET_TOTAL_COUNT
(
¬gs
, 
size
);

71 
ucc_¿nk_t
 
broÙ
 = 
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
 ?

72 
¬gs
->
roÙ
 : 0;

73 
ucc_¿nk_t
 
¿nk
 = 
	`VRANK
(
sk
->
sub£t
.
my¿nk
, 
broÙ
, 
size
);

74 
size_t
 
loÿl
 = 
	`GET_LOCAL_COUNT
(
¬gs
, 
size
, 
¿nk
);

75 *
sbuf
;

76 
±rdiff_t
 
³”_£g_off£t
, 
loÿl_£g_off£t
;

77 
ucc_¿nk_t
 
³”
, 
³”_di¡
;

78 
ucc_kn_¿dix_t
 
loİ_¡•
;

79 
size_t
 
³”_£g_couÁ
, 
loÿl_£g_couÁ
;

80 
ucc_¡©us_t
 
¡©us
;

81 
size_t
 
exŒa_couÁ
;

83 
	`COPY_TASK_TEST
(
UCC_KN_PHASE_INIT
, 
ùx
, "failed during copyaskest",

84 
sk
->
®lg©h”_kn
.
cİy_sk
);

85 
	`UCC_KN_GOTO_PHASE
(
sk
->
®lg©h”_kn
.
pha£
);

86 ià(
KN_NODE_EXTRA
 =ğ
node_ty³
) {

87 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_´oxy
(
p
, 
¿nk
);

88 ià(
p
->
ty³
 !ğ
KN_PATTERN_ALLGATHERX
) {

89 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
sk
->
®lg©h”_kn
.
sbuf
,

90 
loÿl
 * 
dt_size
, 
mem_ty³
,

91 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

92 
	`INV_VRANK
(
³”
,
broÙ
,
size
)),

93 
‹am
, 
sk
),

94 
sk
, 
out
);

96 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
rbuf
, 
d©a_size
 * 
dt_size
, 
mem_ty³
,

97 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

98 
	`INV_VRANK
(
³”
,
broÙ
,
size
)),

99 
‹am
, 
sk
),

100 
sk
, 
out
);

102 ià((
p
->
ty³
 !ğ
KN_PATTERN_ALLGATHERX
è&& (
node_ty³
 =ğ
KN_NODE_PROXY
)) {

103 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_exŒa
(
p
, 
¿nk
);

104 
exŒa_couÁ
 =

105 
cŞl_sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLGATHER


106 ? 
loÿl


107 : 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
³”
);

108 
³”
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,…eer);

109 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
	`PTR_OFFSET
(
sk
->
®lg©h”_kn
.
sbuf
,

110 
loÿl
 * 
dt_size
), 
exŒa_couÁ
 * dt_size,

111 
mem_ty³
, 
³”
, 
‹am
, 
sk
),

112 
sk
, 
out
);

115 
UCC_KN_PHASE_EXTRA
:

116 ià((
KN_NODE_EXTRA
 =ğ
node_ty³
è|| (
KN_NODE_PROXY
 ==‚ode_type)) {

117 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

118 
	`SAVE_STATE
(
UCC_KN_PHASE_EXTRA
);

121 ià(
KN_NODE_EXTRA
 =ğ
node_ty³
) {

122 
out
;

125 !
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

126 
	`ucc_kn_ag_·‰”n_³”_£g
(
¿nk
, 
p
, &
loÿl_£g_couÁ
,

127 &
loÿl_£g_off£t
);

128 
sbuf
 = 
	`PTR_OFFSET
(
rbuf
, 
loÿl_£g_off£t
 * 
dt_size
);

130 
loİ_¡•
 = 
¿dix
 - 1;†oop_step > 0;†oop_step--) {

131 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
loİ_¡•
);

132 ià(
³”
 =ğ
UCC_KN_PEER_NULL
)

134 ià(
cŞl_sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
) {

135 
³”_di¡
 = 
	`ucc_knomŸl_ÿlc_»cv_di¡
(
size
 - 
p
->
n_exŒa
,

136 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
³”
),…->
¿dix
, 0);

137 ià(
³”_di¡
 < 
sk
->
®lg©h”_kn
.
»cv_di¡
) {

141 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
sbuf
, 
loÿl_£g_couÁ
 * 
dt_size
,

142 
mem_ty³
,

143 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

144 
	`INV_VRANK
(
³”
, 
broÙ
, 
size
)),

145 
‹am
, 
sk
),

146 
sk
, 
out
);

149 
loİ_¡•
 = 1;†oİ_¡• < 
¿dix
;†oop_step++) {

150 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
loİ_¡•
);

151 ià(
³”
 =ğ
UCC_KN_PEER_NULL
)

153 
	`ucc_kn_ag_·‰”n_³”_£g
(
³”
, 
p
, &
³”_£g_couÁ
,

154 &
³”_£g_off£t
);

156 ià(
cŞl_sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
) {

157 
³”_di¡
 = 
	`ucc_knomŸl_ÿlc_»cv_di¡
(
size
 - 
p
->
n_exŒa
,

158 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
³”
),…->
¿dix
, 0);

159 ià(
³”_di¡
 > 
sk
->
®lg©h”_kn
.
»cv_di¡
) {

163 
	`UCPCHECK_GOTO
(

164 
	`ucc__uı_»cv_nb
(
	`PTR_OFFSET
(
rbuf
, 
³”_£g_off£t
 * 
dt_size
),

165 
³”_£g_couÁ
 * 
dt_size
, 
mem_ty³
,

166 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

167 
	`INV_VRANK
(
³”
, 
broÙ
, 
size
)),

168 
‹am
, 
sk
),

169 
sk
, 
out
);

171 
UCC_KN_PHASE_LOOP
:

172 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_»cv
(
sk
)) {

173 
	`SAVE_STATE
(
UCC_KN_PHASE_LOOP
);

176 
	`ucc_kn_ag_·‰”n_Ãxt_™”
(
p
);

179 ià(
KN_NODE_PROXY
 =ğ
node_ty³
) {

180 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_exŒa
(
p
, 
¿nk
);

181 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
rbuf
, 
d©a_size
 * 
dt_size
, 
mem_ty³
,

182 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

183 
	`INV_VRANK
(
³”
, 
broÙ
, 
size
)),

184 
‹am
, 
sk
),

185 
sk
, 
out
);

187 
UCC_KN_PHASE_PROXY
:

188 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

189 
	`SAVE_STATE
(
UCC_KN_PHASE_PROXY
);

193 
out
:

194 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

195 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

196 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_kn_done", 0);

197 
	}
}

199 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

201 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

202 
ucc__uı_sk_t
);

203 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

204 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

205 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

206 
ucc_cŞl_ty³_t
 
ù
 = 
¬gs
->
cŞl_ty³
;

207 
ucc_¿nk_t
 
size
 = 
sk
->
sub£t
.
m­
.
•_num
;

208 
ucc_kn_¿dix_t
 
¿dix
 = 
sk
->
®lg©h”_kn
.
p
.radix;

209 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
®lg©h”_kn
.p;

210 
ucc_¿nk_t
 
¿nk
 = 
	`VRANK
(
sk
->
sub£t
.
my¿nk
,

211 
ù
 =ğ
UCC_COLL_TYPE_BCAST
 ?

212 
¬gs
->
roÙ
 : 0, 
size
);

213 
ucc_¡©us_t
 
¡©us
;

214 
±rdiff_t
 
off£t
;

215 *
rbuf
;

217 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_kn_start", 0);

218 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

219 
sk
->
®lg©h”_kn
.
cİy_sk
 = 
NULL
;

220 
sk
->
®lg©h”_kn
.
pha£
 = 
UCC_KN_PHASE_INIT
;

221 ià(
ù
 =ğ
UCC_COLL_TYPE_ALLGATHER
) {

222 
	`ucc_kn_ag_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
, 
¬gs
->
d¡
.
šfo
.
couÁ
,

223 &
sk
->
®lg©h”_kn
.
p
);

224 
off£t
 = 
	`ucc_bufãr_block_off£t
(
¬gs
->
d¡
.
šfo
.
couÁ
, 
size
, 
¿nk
) *

225 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

226 
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

227 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

228 
¡©us
 = 
ùx
->
cİy
.
	`po¡
(
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.
bufãr
, 
off£t
),

229 
¬gs
->
d¡
.
šfo
.
mem_ty³
,

230 
¬gs
->
¤c
.
šfo
.
bufãr
,

231 
¬gs
->
¤c
.
šfo
.
mem_ty³
,

232 
¬gs
->
¤c
.
šfo
.
couÁ
 *

233 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
),

234 
sk
,

235 &
sk
->
®lg©h”_kn
.
cİy_sk
);

236 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

237 
sk
->
su³r
.
¡©us
 = status;

238  
¡©us
;

241 } ià(
ù
 =ğ
UCC_COLL_TYPE_ALLGATHERV
) {

242 
	`ucc_kn_agv_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
, 
¬gs
->
d¡
.
šfo_v
.
couÁs
,

243 
	`UCC_COLL_ARGS_COUNT64
(
¬gs
),

244 &
sk
->
®lg©h”_kn
.
p
);

245 
off£t
 = 
	`ucc_bufãr_veùÜ_block_off£t
(
¬gs
->
d¡
.
šfo_v
.
couÁs
,

246 
	`UCC_COLL_ARGS_COUNT64
(
¬gs
),

247 
¿nk
) *

248 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

249 
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

250 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

251 
¡©us
 = 
ùx
->
cİy
.
	`po¡
(
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo_v
.
bufãr
, 
off£t
),

252 
¬gs
->
d¡
.
šfo_v
.
mem_ty³
,

253 
¬gs
->
¤c
.
šfo
.
bufãr
,

254 
¬gs
->
¤c
.
šfo
.
mem_ty³
,

255 
¬gs
->
¤c
.
šfo
.
couÁ
 *

256 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
),

257 
sk
,

258 &
sk
->
®lg©h”_kn
.
cİy_sk
);

259 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

260 
sk
->
su³r
.
¡©us
 = status;

261  
¡©us
;

265 
	`ucc_kn_agx_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
, 
¬gs
->
d¡
.
šfo
.
couÁ
,

266 &
sk
->
®lg©h”_kn
.
p
);

267 
off£t
 = 
	`ucc_¤a_kn_g‘_off£t
(
¬gs
->
d¡
.
šfo
.
couÁ
,

268 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
), 
¿nk
,

269 
size
, 
¿dix
);

270 
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

271 
sk
->
®lg©h”_kn
.
»cv_di¡
 = 
	`ucc_knomŸl_ÿlc_»cv_di¡
(

272 
size
 - 
p
->
n_exŒa
,

273 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
¿nk
),

274 
p
->
¿dix
, 0);

276 
sk
->
®lg©h”_kn
.
sbuf
 = 
	`PTR_OFFSET
(
rbuf
, 
off£t
);

278  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

279 
	}
}

281 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_knomŸl_š™_r
(

282 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

283 
ucc_cŞl_sk_t
 **
sk_h
, 
ucc_kn_¿dix_t
 
¿dix
)

285 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

286 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
_‹am
);

287 
ucc__uı_sk_t
 *
sk
;

288 
ucc_sbgp_t
 *
sbgp
;

290 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

291 ià(
_‹am
->
cfg
.
u£_»Üd”šg
 &&

292 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLREDUCE
) {

293 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
_‹am
->
tİo
, 
UCC_SBGP_FULL_HOST_ORDERED
);

294 
sk
->
sub£t
.
my¿nk
 = 
sbgp
->
group_¿nk
;

295 
sk
->
sub£t
.
m­
 = 
sbgp
->map;

297 
sk
->
®lg©h”_kn
.
p
.
¿dix
 =„adix;

298 ià(!
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
)) {

299 ià(
ùx
->
cfg
.
loÿl_cİy_ty³
 =ğ
UCC_TL_UCP_LOCAL_COPY_TYPE_EC
) {

300 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

303 
sk
->
su³r
.
po¡
 = 
ucc__uı_®lg©h”_knomŸl_¡¬t
;

304 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®lg©h”_knomŸl_´og»ss
;

305 *
sk_h
 = &
sk
->
su³r
;

306  
UCC_OK
;

307 
	}
}

309 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

310 
ucc_ba£_‹am_t
 *
‹am
,

311 
ucc_cŞl_sk_t
 **
sk_h
)

313 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

314 
ucc_m¿nge_ušt_t
 *
p
 = &
_‹am
->
cfg
.
®lg©h”_kn_¿dix
;

315 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

316 
ucc_memÜy_ty³_t
 
mty³
 = 
	`GET_MT
(&
cŞl_¬gs
->
¬gs
);

317 
size_t
 
couÁ
 = 
	`GET_TOTAL_COUNT
(&
cŞl_¬gs
->
¬gs
, 
tsize
);

318 
ucc_d©©y³_t
 
dty³
 = 
	`GET_DT
(&
cŞl_¬gs
->
¬gs
);

319 
ucc_kn_¿dix_t
 
¿dix
;

321 
¿dix
 = 
	`ucc__uı_g‘_knomŸl_¿dix
(
_‹am
, 
couÁ
, 
dty³
, 
mty³
, 
p
, 0);

323  
	`ucc__uı_®lg©h”_knomŸl_š™_r
(
cŞl_¬gs
, 
‹am
, 
sk_h
, 
¿dix
);

324 
	}
}

	@src/components/tl/ucp/allgather/allgather_linear.c

6 
	~"cÚfig.h
"

7 
	~"_uı.h
"

8 
	~"®lg©h”.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"compÚ’ts/mc/ucc_mc.h
"

13 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

15 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

16 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

17 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

18 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

19 *
sbuf
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
;

20 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

21 
ucc_memÜy_ty³_t
 
smem
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
;

22 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

23 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

24 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

25 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

26 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

27 
ucc_¡©us_t
 
¡©us
;

29 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_linear_start",

32 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

33 
sk
->
®lg©h”_lš—r
.
cİy_sk
 = 
NULL
;

36 ià(!
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

37 
¡©us
 = 
ùx
->
cİy
.
	`po¡
(
	`PTR_OFFSET
(
rbuf
, 
d©a_size
 * 
Œªk
), 
rmem
,

38 
sbuf
, 
smem
, 
d©a_size
, 
sk
,

39 &
sk
->
®lg©h”_lš—r
.
cİy_sk
);

40 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

41  
¡©us
;

45  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

46 
	}
}

52 
	$g‘_num_»qs
(cÚ¡ 
ucc__uı_‹am_t
 *
‹am
)

54 
»qs
 =

55 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
®lg©h”_b©ched_num_po¡s
;

56 
ucc_¿nk_t
 
max_»q
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
) - 1;

57 
»qs
 = (»q > 
max_»q
 ||„eq =ğ
UCC_ULUNITS_AUTO
) ? max_req :„eqs;

58  
»qs
;

59 
	}
}

61 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_b©ched_š™
(

62 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

63 
ucc_cŞl_sk_t
 **
sk_h
, 
Äeqs
)

65 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

66 
ucc__uı_sk_t
 *
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

68 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&
	`TASK_ARGS
(
sk
), 
UCC_RANK_INVALID
)) {

69 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "user defined datatype is‚ot supported");

70 
	`ucc__uı_put_sk
(
sk
);

71  
UCC_ERR_NOT_SUPPORTED
;

74 ià(!
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
)) {

75 ià(
	`UCC_TL_UCP_TEAM_CTX
(
_‹am
)->
cfg
.
loÿl_cİy_ty³
 ==

76 
UCC_TL_UCP_LOCAL_COPY_TYPE_EC
) {

77 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

81 
sk
->
su³r
.
po¡
 = 
ucc__uı_®lg©h”_lš—r_¡¬t
;

82 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®lg©h”_lš—r_´og»ss
;

83 
sk
->
®lg©h”_lš—r
.
Äeqs
 =

84 
Äeqs
 =ğ0 ? 
	`UCC_TL_TEAM_SIZE
(
_‹am
) - 1 :‚reqs;

85 *
sk_h
 = &
sk
->
su³r
;

87  
UCC_OK
;

88 
	}
}

91 
ucc_¡©us_t


92 
	$ucc__uı_®lg©h”_lš—r_b©ched_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

93 
ucc_ba£_‹am_t
 *
‹am
,

94 
ucc_cŞl_sk_t
 **
sk_h
)

96  
	`ucc__uı_®lg©h”_b©ched_š™
(

97 
cŞl_¬gs
, 
‹am
, 
sk_h
,

98 
	`g‘_num_»qs
(
	`ucc_d”ived_of
(
‹am
, 
ucc__uı_‹am_t
)));

99 
	}
}

102 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_lš—r_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

103 
ucc_ba£_‹am_t
 *
‹am
,

104 
ucc_cŞl_sk_t
 **
sk_h
)

107  
	`ucc__uı_®lg©h”_b©ched_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
, 0);

108 
	}
}

110 
	$ucc__uı_®lg©h”_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

112 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

113 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

114 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

115 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

116 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

117 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

118 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

119 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

120 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

121 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

122 
Äeqs
 = 
sk
->
®lg©h”_lš—r
.nreqs;

123 
pŞls
 = 0;

124 *
tmp£nd
 = 
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))

125 ? 
	`PTR_OFFSET
(
rbuf
, 
Œªk
 * 
d©a_size
)

126 : 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
;

127 
ucc_memÜy_ty³_t
 
smem
 = 
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))

128 ? 
rmem


129 : 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
;

130 *
tm´ecv
;

131 
ucc_¿nk_t
 
³”
;

132 
ucc_¡©us_t
 
¡©us
;

134 (
sk
->
gged
.
£nd_po¡ed
 < 
tsize
 - 1 ||

135 
sk
->
gged
.
»cv_po¡ed
 < 
tsize
 - 1) &&

136 (
pŞls
++ < 
sk
->
n_pŞls
)) {

139 
	`uı_wÜk”_´og»ss
(
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
wÜk”
.
uı_wÜk”
);

142 (
sk
->
gged
.
£nd_po¡ed
 < 
tsize
 - 1) &&

143 ((
sk
->
gged
.
£nd_po¡ed
 -ask->gged.
£nd_com¶‘ed
) <

144 
Äeqs
)) {

145 
³”
 = (
Œªk
 + 1 + 
sk
->
gged
.
£nd_po¡ed
è% 
tsize
;

147 
	`UCPCHECK_GOTO
(

148 
	`ucc__uı_£nd_nb
(
tmp£nd
, 
d©a_size
, 
smem
, 
³”
, 
‹am
, 
sk
),

149 
sk
, 
”r
);

150 
pŞls
 = 0;

154 (
sk
->
gged
.
»cv_po¡ed
 < 
tsize
 - 1) &&

155 ((
sk
->
gged
.
»cv_po¡ed
 -ask->gged.
»cv_com¶‘ed
) <

156 
Äeqs
)) {

157 
³”
 = (
tsize
 + 
Œªk
 - 1 - 
sk
->
gged
.
»cv_po¡ed
) %size;

158 
tm´ecv
 = 
	`PTR_OFFSET
(
rbuf
, 
³”
 * 
d©a_size
);

159 
	`UCPCHECK_GOTO
(

160 
	`ucc__uı_»cv_nb
(
tm´ecv
, 
d©a_size
, 
rmem
, 
³”
, 
‹am
, 
sk
),

161 
sk
, 
”r
);

162 
pŞls
 = 0;

166 ià(
sk
->
gged
.
£nd_po¡ed
 < 
tsize
 - 1 ||

167 
sk
->
gged
.
»cv_po¡ed
 < 
tsize
 - 1) {

171 
sk
->
su³r
.
¡©us
 = 
	`ucc__uı_‹¡
(task);

172 ià(
sk
->
su³r
.
¡©us
 !ğ
UCC_OK
) {

177 ià(
sk
->
®lg©h”_lš—r
.
cİy_sk
 !ğ
NULL
) {

178 
¡©us
 = 
ùx
->
cİy
.
	`‹¡
(ùx, 
sk
->
®lg©h”_lš—r
.
cİy_sk
);

179 ià(
¡©us
 > 0) {

180 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

183 
sk
->
su³r
.
¡©us
 = status;

184 
ùx
->
cİy
.
	`fš®ize
(
sk
->
®lg©h”_lš—r
.
cİy_sk
);

185 
sk
->
®lg©h”_lš—r
.
cİy_sk
 = 
NULL
;

188 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_linear_done", 0);

190 
”r
:

191 
	`ucc_”rÜ
("allgather†inear…rogress failed with status %d: %s",

192 
sk
->
su³r
.
¡©us
, 
	`ucc_¡©us_¡ršg
(task->super.status));

193 
	}
}

	@src/components/tl/ucp/allgather/allgather_neighbor.c

6 
	~"cÚfig.h
"

7 
	~"_uı.h
"

8 
	~"®lg©h”.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"compÚ’ts/mc/ucc_mc.h
"

15 
ucc_¿nk_t
 
	$g‘_»cv_äom_¿nk
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
, 
i
)

17 cÚ¡ 
i_·r™y
 = 
i
 % 2;

18 
off£t_©_¡•
[2];

19 
ucc_¿nk_t
 
»cv_d©a_äom
;

21 ià(
¿nk
 % 2) {

22 
»cv_d©a_äom
 = (
¿nk
 - 1 + 
size
) % size;

23 
off£t_©_¡•
[0] = (-2);

24 
off£t_©_¡•
[1] = (+2);

26 
»cv_d©a_äom
 = 
¿nk
;

27 
off£t_©_¡•
[0] = (+2);

28 
off£t_©_¡•
[1] = (-2);

31  (
»cv_d©a_äom
 + 
off£t_©_¡•
[
i_·r™y
] * 
	`ucc_div_round_up
(
i
, 2è+ 
size
) % size;

32 
	}
}

34 
ucc_¡©us_t
 
ucc__uı_®lg©h”_ÃighbÜ_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

36 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_ÃighbÜ_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

37 
ucc_ba£_‹am_t
 *
‹am
,

38 
ucc_cŞl_sk_t
 **
sk_h
)

40 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

41 
ucc__uı_sk_t
 *
sk
;

42 
ucc__uı_‹am_t
 *
uı_‹am
;

44 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

45 
uı_‹am
 = 
	`TASK_TEAM
(
sk
);

47 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&
	`TASK_ARGS
(
sk
), 
UCC_RANK_INVALID
)) {

48 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "user defined datatype is‚ot supported");

49 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

50 
out
;

53 ià(
	`UCC_TL_TEAM_SIZE
(
uı_‹am
) % 2) {

54 
	`_debug
(
	`UCC_TASK_LIB
(
sk
),

56 
¡©us
 = 
	`ucc__uı_®lg©h”_ršg_š™_commÚ
(
sk
);

58 
sk
->
su³r
.
po¡
 = 
ucc__uı_®lg©h”_ÃighbÜ_¡¬t
;

59 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®lg©h”_ÃighbÜ_´og»ss
;

62 
out
:

63 ià(
¡©us
 !ğ
UCC_OK
) {

64 
	`ucc__uı_put_sk
(
sk
);

65  
¡©us
;

68 *
sk_h
 = &
sk
->
su³r
;

69  
¡©us
;

70 
	}
}

73 
	$ucc__uı_®lg©h”_ÃighbÜ_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

75 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

76 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

77 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

78 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

79 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

80 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

81 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

82 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

83 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

84 
ucc_¿nk_t
 
ÃighbÜs
[2], 
i
;

85 
i_·r™y
, 
ev’_¿nk
;

86 *
tm´ecv
, *
tmp£nd
;

88 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

92 
ev’_¿nk
 = !(
Œªk
 % 2);

93 ià(
ev’_¿nk
) {

94 
ÃighbÜs
[0] = (
Œªk
 + 1è% 
tsize
;

95 
ÃighbÜs
[1] = (
Œªk
 - 1 + 
tsize
) %size;

97 
ÃighbÜs
[0] = (
Œªk
 - 1 + 
tsize
) %size;

98 
ÃighbÜs
[1] = (
Œªk
 + 1è% 
tsize
;

101 
sk
->
gged
.
£nd_po¡ed
 < (
tsize
 / 2)) {

102 
i
 = 
sk
->
gged
.
£nd_po¡ed
;

103 
i_·r™y
 = 
i
 % 2;

105 
tm´ecv
 =

106 
	`PTR_OFFSET
(
rbuf
, 
	`g‘_»cv_äom_¿nk
(
Œªk
, 
tsize
, 
i
è* 
d©a_size
);

107 
tmp£nd
 = 
	`PTR_OFFSET
(
rbuf
, 
	`g‘_»cv_äom_¿nk
(
Œªk
, 
tsize
, 
i
 - 1) *

108 
d©a_size
);

111 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
tmp£nd
, 2 * 
d©a_size
, 
rmem
,

112 
ÃighbÜs
[
i_·r™y
], 
‹am
, 
sk
),

113 
sk
, 
out
);

114 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
tm´ecv
, 2 * 
d©a_size
, 
rmem
,

115 
ÃighbÜs
[
i_·r™y
], 
‹am
, 
sk
),

116 
sk
, 
out
);

118 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

123 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

124 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

126 
out
:

127 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_neighbor_done",

129 
	}
}

131 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_ÃighbÜ_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

133 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

134 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

135 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

136 *
sbuf
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
;

137 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

138 
ucc_memÜy_ty³_t
 
smem
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
;

139 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

140 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

141 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

142 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

143 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

144 
ucc_¡©us_t
 
¡©us
;

145 
ucc_¿nk_t
 
ÃighbÜ
;

146 *
tm´ecv
, *
tmp£nd
;

148 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_neighbor_start",

150 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

152 ià(!
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

153 
¡©us
 = 
	`ucc_mc_memıy
(
	`PTR_OFFSET
(
rbuf
, 
d©a_size
 * 
Œªk
), 
sbuf
,

154 
d©a_size
, 
rmem
, 
smem
);

155 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

156  
¡©us
;

160 ià(
Œªk
 % 2) {

161 
ÃighbÜ
 = (
Œªk
 - 1 + 
tsize
) %size;

163 
ÃighbÜ
 = (
Œªk
 + 1è% 
tsize
;

166 
tm´ecv
 = 
	`PTR_OFFSET
(
rbuf
, 
ÃighbÜ
 * 
d©a_size
);

167 
tmp£nd
 = 
	`PTR_OFFSET
(
rbuf
, 
Œªk
 * 
d©a_size
);

170 
	`UCPCHECK_GOTO
(

171 
	`ucc__uı_£nd_nb
(
tmp£nd
, 
d©a_size
, 
rmem
, 
ÃighbÜ
, 
‹am
, 
sk
),

172 
sk
, 
out
);

173 
	`UCPCHECK_GOTO
(

174 
	`ucc__uı_»cv_nb
(
tm´ecv
, 
d©a_size
, 
rmem
, 
ÃighbÜ
, 
‹am
, 
sk
),

175 
sk
, 
out
);

176 
out
:

177  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

178 
	}
}

	@src/components/tl/ucp/allgather/allgather_ring.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®lg©h”.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"_uı_£nd»cv.h
"

12 
	~"uts/ucc_m©h.h
"

13 
	~"uts/ucc_cŞl_uts.h
"

14 
	~"compÚ’ts/mc/ucc_mc.h
"

16 
ucc_¿nk_t
 
	$ucc__uı_®lg©h”_ršg_g‘_£nd_block
(
ucc_sub£t_t
 *
sub£t
,

17 
ucc_¿nk_t
 
Œªk
,

18 
ucc_¿nk_t
 
tsize
,

19 
¡•
)

21  
	`ucc_•_m­_ev®
(
sub£t
->
m­
, (
Œªk
 - 
¡•
 + 
tsize
) %size);

22 
	}
}

24 
ucc_¿nk_t
 
	$ucc__uı_®lg©h”_ršg_g‘_»cv_block
(
ucc_sub£t_t
 *
sub£t
,

25 
ucc_¿nk_t
 
Œªk
,

26 
ucc_¿nk_t
 
tsize
,

27 
¡•
)

29  
	`ucc_•_m­_ev®
(
sub£t
->
m­
, (
Œªk
 - 
¡•
 - 1 + 
tsize
) %size);

30 
	}
}

32 
	$ucc__uı_®lg©h”_ršg_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

34 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

35 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

36 
ucc_¿nk_t
 
Œªk
 = 
sk
->
sub£t
.
my¿nk
;

37 
ucc_¿nk_t
 
tsize
 = (ucc_¿nk_t)
sk
->
sub£t
.
m­
.
•_num
;

38 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

39 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

40 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

41 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

42 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

43 
ucc_¿nk_t
 
£ndto
, 
»cväom
, 
sblock
, 
rblock
;

44 
¡•
;

45 *
buf
;

47 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

50 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, (
Œªk
 + 1è% 
tsize
);

51 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, (
Œªk
 - 1 + 
tsize
) %size);

53 
sk
->
gged
.
£nd_po¡ed
 < 
tsize
 - 1) {

54 
¡•
 = 
sk
->
gged
.
£nd_po¡ed
;

55 
sblock
 = 
sk
->
®lg©h”_ršg
.
	`g‘_£nd_block
(&sk->
sub£t
, 
Œªk
,

56 
tsize
, 
¡•
);

57 
rblock
 = 
sk
->
®lg©h”_ršg
.
	`g‘_»cv_block
(&sk->
sub£t
, 
Œªk
,

58 
tsize
, 
¡•
);

59 
buf
 = 
	`PTR_OFFSET
(
rbuf
, 
sblock
 * 
d©a_size
);

60 
	`UCPCHECK_GOTO
(

61 
	`ucc__uı_£nd_nb
(
buf
, 
d©a_size
, 
rmem
, 
£ndto
, 
‹am
, 
sk
),

62 
sk
, 
out
);

63 
buf
 = 
	`PTR_OFFSET
(
rbuf
, 
rblock
 * 
d©a_size
);

64 
	`UCPCHECK_GOTO
(

65 
	`ucc__uı_»cv_nb
(
buf
, 
d©a_size
, 
rmem
, 
»cväom
, 
‹am
, 
sk
),

66 
sk
, 
out
);

67 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

71 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

72 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

73 
out
:

74 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_ring_done", 0);

75 
	}
}

77 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_ršg_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

79 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

80 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

81 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

82 *
sbuf
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
;

83 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

84 
ucc_memÜy_ty³_t
 
smem
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
;

85 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

86 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

87 
ucc_¿nk_t
 
Œªk
 = 
sk
->
sub£t
.
my¿nk
;

88 
ucc_¿nk_t
 
tsize
 = (ucc_¿nk_t)
sk
->
sub£t
.
m­
.
•_num
;

89 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

90 
ucc_¡©us_t
 
¡©us
;

91 
ucc_¿nk_t
 
block
;

93 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_ring_start", 0);

94 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

96 ià(!
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

97 
block
 = 
sk
->
®lg©h”_ršg
.
	`g‘_£nd_block
(&sk->
sub£t
, 
Œªk
, 
tsize
,

99 
¡©us
 = 
	`ucc_mc_memıy
(
	`PTR_OFFSET
(
rbuf
, 
d©a_size
 * 
block
),

100 
sbuf
, 
d©a_size
, 
rmem
, 
smem
);

101 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

102  
¡©us
;

106  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

107 
	}
}

109 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_ršg_š™_commÚ
(
ucc__uı_sk_t
 *
sk
)

111 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

112 
ucc_sbgp_t
 *
sbgp
;

114 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&
	`TASK_ARGS
(
sk
), 
UCC_RANK_INVALID
)) {

115 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "user defined datatype is‚ot supported");

116  
UCC_ERR_NOT_SUPPORTED
;

119 ià(!(
sk
->
æags
 & 
UCC_TL_UCP_TASK_FLAG_SUBSET
)) {

120 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

121 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
‹am
->
tİo
, 
UCC_SBGP_FULL_HOST_ORDERED
);

122 
sk
->
sub£t
.
my¿nk
 = 
sbgp
->
group_¿nk
;

123 
sk
->
sub£t
.
m­
 = 
sbgp
->map;

127 
sk
->
®lg©h”_ršg
.
g‘_£nd_block
 = 
ucc__uı_®lg©h”_ršg_g‘_£nd_block
;

128 
sk
->
®lg©h”_ršg
.
g‘_»cv_block
 = 
ucc__uı_®lg©h”_ršg_g‘_»cv_block
;

129 
sk
->
su³r
.
po¡
 = 
ucc__uı_®lg©h”_ršg_¡¬t
;

130 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®lg©h”_ršg_´og»ss
;

132  
UCC_OK
;

133 
	}
}

135 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

136 
ucc_ba£_‹am_t
 * 
‹am
,

137 
ucc_cŞl_sk_t
 ** 
sk_h
)

139 
ucc__uı_sk_t
 *
sk
;

140 
ucc_¡©us_t
 
¡©us
;

142 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

143 
¡©us
 = 
	`ucc__uı_®lg©h”_ršg_š™_commÚ
(
sk
);

144 ià(
¡©us
 !ğ
UCC_OK
) {

145 
	`ucc__uı_put_sk
(
sk
);

146  
¡©us
;

148 *
sk_h
 = &
sk
->
su³r
;

149  
UCC_OK
;

150 
	}
}

	@src/components/tl/ucp/allgather/allgather_sparbit.c

6 
	~"cÚfig.h
"

7 
	~"_uı.h
"

8 
	~"®lg©h”.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"compÚ’ts/mc/ucc_mc.h
"

15 
ucc__uı_®lg©h”_¥¬b™_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

17 
ucc_¡©us_t
 
ucc__uı_®lg©h”_¥¬b™_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

19 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_¥¬b™_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

20 
ucc_ba£_‹am_t
 *
‹am
,

21 
ucc_cŞl_sk_t
 **
sk_h
)

23 
ucc__uı_sk_t
 *
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

25 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&
	`TASK_ARGS
(
sk
), 
UCC_RANK_INVALID
)) {

26 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "user defined datatype is‚ot supported");

27 
	`ucc__uı_put_sk
(
sk
);

28  
UCC_ERR_NOT_SUPPORTED
;

30 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "ucc_tl_ucp_allgather_sparbit_init");

32 
sk
->
su³r
.
po¡
 = 
ucc__uı_®lg©h”_¥¬b™_¡¬t
;

33 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®lg©h”_¥¬b™_´og»ss
;

35 *
sk_h
 = &
sk
->
su³r
;

37  
UCC_OK
;

38 
	}
}

41 
	$ucc__uı_®lg©h”_¥¬b™_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

43 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

44 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

45 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

46 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

47 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

48 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

49 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

50 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

51 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

52 
ušt32_t
 
i
 = 
sk
->
®lg©h”_¥¬b™
.i;

53 
ušt32_t
 
tsize_log
 = 
	`ucc_og2_û
(
tsize
);

54 
ucc_¿nk_t
 
»cväom
, 
£ndto
, 
di¡ªû
;

55 
ušt32_t
 
Ï¡_ignÜe
, 
ignÜe_¡•s
, 
d©a_ex³ùed
, 
Œªsãr_couÁ
;

56 
ušt32_t
 
exşusiÚ
;

57 *
tm´ecv
, *
tmp£nd
;

60 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

64 
Ï¡_ignÜe
 = 
	`__butš_ùz
(
tsize
);

65 
ignÜe_¡•s
 = (~((
ušt32_t
)
tsize
 >> 
Ï¡_ignÜe
) | 1) <<†ast_ignore;

67 
i
 < 
tsize_log
) {

68 
d©a_ex³ùed
 = 
sk
->
®lg©h”_¥¬b™
.data_expected;

70 
di¡ªû
 = 1 << (
tsize_log
 - 1);

71 
di¡ªû
 >>ğ
i
;

73 
»cväom
 = (
Œªk
 + 
tsize
 - 
di¡ªû
) %size;

74 
£ndto
 = (
Œªk
 + 
di¡ªû
è% 
tsize
;

75 
exşusiÚ
 = (
di¡ªû
 & 
ignÜe_¡•s
) == distance;

77 
Œªsãr_couÁ
 = 0;¿nsãr_couÁ < 
d©a_ex³ùed
 - 
exşusiÚ
;

78 
Œªsãr_couÁ
++) {

79 
tm´ecv
 = 
	`PTR_OFFSET
(

80 
rbuf
, (
Œªk
 - (2 * 
Œªsãr_couÁ
 + 1è* 
di¡ªû
 + 
tsize
) %

81 
tsize
 * 
d©a_size
);

82 
tmp£nd
 = 
	`PTR_OFFSET
(

83 
rbuf
, (
Œªk
 - 2 * 
Œªsãr_couÁ
 * 
di¡ªû
 + 
tsize
) %size *

84 
d©a_size
);

86 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
tmp£nd
, 
d©a_size
, 
rmem
, 
£ndto
,

87 
‹am
, 
sk
),

88 
sk
, 
out
);

89 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
tm´ecv
, 
d©a_size
, 
rmem
, 
»cväom
,

90 
‹am
, 
sk
),

91 
sk
, 
out
);

94 
sk
->
®lg©h”_¥¬b™
.
d©a_ex³ùed
 =

95 (
d©a_ex³ùed
 << 1è- 
exşusiÚ
;

96 
sk
->
®lg©h”_¥¬b™
.
i
++;

98 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

101 
i
 = 
sk
->
®lg©h”_¥¬b™
.i;

104 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

105 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

107 
out
:

108 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_sparbit_done",

110 
	}
}

112 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”_¥¬b™_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

114 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

115 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

116 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

117 *
sbuf
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
;

118 *
rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

119 
ucc_memÜy_ty³_t
 
smem
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
;

120 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

121 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

122 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

123 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

124 
size_t
 
d©a_size
 = (
couÁ
 / 
tsize
è* 
	`ucc_dt_size
(
dt
);

125 
ucc_¡©us_t
 
¡©us
;

127 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allgather_sparbit_start",

129 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

130 
sk
->
®lg©h”_¥¬b™
.
i
 = 0;

131 
sk
->
®lg©h”_¥¬b™
.
d©a_ex³ùed
 = 1;

133 ià(!
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
))) {

134 
¡©us
 = 
	`ucc_mc_memıy
(
	`PTR_OFFSET
(
rbuf
, 
d©a_size
 * 
Œªk
), 
sbuf
,

135 
d©a_size
, 
rmem
, 
smem
);

136 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

137  
¡©us
;

141  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

142 
	}
}

	@src/components/tl/ucp/allgatherv/allgatherv.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®lg©h”v.h
"

10 
	~"uts/ucc_cŞl_uts.h
"

12 
ucc_ba£_cŞl_®g_šfo_t


13 
	gucc__uı_®lg©h”v_®gs
[
UCC_TL_UCP_ALLGATHERV_ALG_LAST
 + 1] = {

14 [
UCC_TL_UCP_ALLGATHERV_ALG_RING
] =

15 {.
id
 = 
UCC_TL_UCP_ALLGATHERV_ALG_RING
,

16 .
	gÇme
 = "ring",

17 .
	gdesc
 = "O(N) Ring"},

18 [
UCC_TL_UCP_ALLGATHERV_ALG_KNOMIAL
] =

19 {.
id
 = 
UCC_TL_UCP_ALLGATHERV_ALG_KNOMIAL
,

20 .
	gÇme
 = "knomial",

21 .
	gdesc
 = "recursive k-ing with‡rbitrary„adix"},

22 [
UCC_TL_UCP_ALLGATHERV_ALG_LAST
] = {

23 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

25 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”v_š™
(
ucc__uı_sk_t
 *
sk
)

27 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&
	`TASK_ARGS
(
sk
), 
UCC_RANK_INVALID
)) {

28 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "user defined datatype is‚ot supported");

29  
UCC_ERR_NOT_SUPPORTED
;

32  
	`ucc__uı_®lg©h”v_ršg_š™_commÚ
(
sk
);

33 
	}
}

	@src/components/tl/ucp/allgatherv/allgatherv.h

7 #iâdeà
ALLGATHERV_H_


8 
	#ALLGATHERV_H_


	)

10 
	~"../_uı.h
"

11 
	~"../_uı_cŞl.h
"

14 
	mUCC_TL_UCP_ALLGATHERV_ALG_RING
,

15 
	mUCC_TL_UCP_ALLGATHERV_ALG_KNOMIAL
,

16 
	mUCC_TL_UCP_ALLGATHERV_ALG_LAST


19 
ucc_ba£_cŞl_®g_šfo_t


20 
ucc__uı_®lg©h”v_®gs
[
UCC_TL_UCP_ALLGATHERV_ALG_LAST
 + 1];

22 
	#UCC_TL_UCP_ALLGATHERV_DEFAULT_ALG_SELECT_STR
 \

23 "®lg©h”v:@0"

	)

25 *
ucc__uı_®lg©h”v_scÜe_¡r_g‘
(
ucc__uı_‹am_t
 *
‹am
);

27 
šlše
 
	$ucc__uı_®lg©h”v_®g_äom_¡r
(cÚ¡ *
¡r
)

29 
i
;

30 
i
 = 0; i < 
UCC_TL_UCP_ALLGATHERV_ALG_LAST
; i++) {

31 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__uı_®lg©h”v_®gs
[
i
].
Çme
)) {

35  
i
;

36 
	}
}

38 
ucc_¡©us_t
 
ucc__uı_®lg©h”v_ršg_š™_commÚ
(
ucc__uı_sk_t
 *
sk
);

40 
ucc_¡©us_t
 
ucc__uı_®lg©h”v_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

41 
ucc_ba£_‹am_t
 *
‹am
,

42 
ucc_cŞl_sk_t
 **
sk_h
);

44 
ucc_¡©us_t
 
ucc__uı_®lg©h”v_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

45 
ucc_ba£_‹am_t
 *
‹am
,

46 
ucc_cŞl_sk_t
 **
sk_h
);

48 
ucc_¡©us_t
 
ucc__uı_®lg©h”v_š™
(
ucc__uı_sk_t
 *
sk
);

	@src/components/tl/ucp/allgatherv/allgatherv_knomial.c

7 
	~"®lg©h”v/®lg©h”v.h
"

8 
	~"®lg©h”/®lg©h”.h
"

10 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”v_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

11 
ucc_ba£_‹am_t
 *
‹am
,

12 
ucc_cŞl_sk_t
 **
sk_h
)

14 ià(!
	`UCC_COLL_IS_DST_CONTIG
(&
cŞl_¬gs
->
¬gs
)) {

15  
	`ucc__uı_®lg©h”v_ršg_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

17  
	`ucc__uı_®lg©h”_knomŸl_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

18 
	}
}

	@src/components/tl/ucp/allgatherv/allgatherv_ring.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®lg©h”v.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"_uı_£nd»cv.h
"

15 
	$ucc__uı_®lg©h”v_ršg_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

17 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

18 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

19 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

20 
ucc_¿nk_t
 
Œªk
 = 
sk
->
sub£t
.
my¿nk
;

21 
ucc_¿nk_t
 
tsize
 = (ucc_¿nk_t)
sk
->
sub£t
.
m­
.
•_num
;

22 
±rdiff_t
 
rbuf
 = (±rdiff_t)
¬gs
->
d¡
.
šfo_v
.
bufãr
;

23 
ucc_memÜy_ty³_t
 
rmem
 = 
¬gs
->
d¡
.
šfo_v
.
mem_ty³
;

24 
size_t
 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

25 
ucc_¿nk_t
 
£nd_idx
, 
»cv_idx
, 
£ndto
, 
»cväom
;

26 
size_t
 
d©a_size
, 
d©a_di¥l
;

28 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

32 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, (
Œªk
 + 1è% 
tsize
);

33 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, (
Œªk
 - 1 + 
tsize
) %size);

35 
sk
->
gged
.
£nd_po¡ed
 < 
tsize
) {

36 
£nd_idx
 =

37 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, (
Œªk
 -

38 
sk
->
gged
.
£nd_po¡ed
 + 1 +

39 
tsize
) %size);

40 
d©a_di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

41 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
£nd_idx
) *

42 
rdt_size
;

43 
d©a_size
 =

44 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
£nd_idx
) *

45 
rdt_size
;

46 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
((*)(
rbuf
 + 
d©a_di¥l
), 
d©a_size
,

47 
rmem
, 
£ndto
, 
‹am
, 
sk
),

48 
sk
, 
out
);

49 
»cv_idx
 =

50 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, (
Œªk
 -

51 
sk
->
gged
.
»cv_po¡ed
 +

52 
tsize
) %size);

53 
d©a_di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

54 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
»cv_idx
) *

55 
rdt_size
;

56 
d©a_size
 =

57 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
»cv_idx
) *

58 
rdt_size
;

59 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
((*)(
rbuf
 + 
d©a_di¥l
), 
d©a_size
,

60 
rmem
, 
»cväom
, 
‹am
, 
sk
),

61 
sk
, 
out
);

62 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

66 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

67 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

68 
out
:

70 
	}
}

72 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”v_ršg_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

74 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

75 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

76 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

77 * 
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

78 * 
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

79 
ucc_memÜy_ty³_t
 
smem
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

80 
ucc_memÜy_ty³_t
 
rmem
 = 
¬gs
->
d¡
.
šfo_v
.
mem_ty³
;

81 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

82 
size_t
 
d©a_size
, 
d©a_di¥l
, 
rdt_size
;

84 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

86 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

88 
rdt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

89 
d©a_di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

90 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
g¿nk
è* 
rdt_size
;

91 
d©a_size
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,

92 
¬gs
->
d¡
.
šfo_v
.
couÁs
, 
g¿nk
è* 
rdt_size
;

93 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
	`PTR_OFFSET
(
rbuf
, 
d©a_di¥l
), 
d©a_size
,

94 
rmem
, 
g¿nk
, 
‹am
, 
sk
),

95 
sk
, 
”rÜ
);

96 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
sbuf
, 
d©a_size
, 
smem
, 
g¿nk
, 
‹am
, 
sk
),

97 
sk
, 
”rÜ
);

101 
sk
->
gged
.
£nd_po¡ed
 =ask->gged.
£nd_com¶‘ed
 = 1;

102 
sk
->
gged
.
»cv_po¡ed
 =ask->gged.
»cv_com¶‘ed
 = 1;

105  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

106 
”rÜ
:

107  
sk
->
su³r
.
¡©us
;

108 
	}
}

110 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”v_ršg_š™_commÚ
(
ucc__uı_sk_t
 *
sk
)

112 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

113 
ucc_sbgp_t
 *
sbgp
;

115 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&
	`TASK_ARGS
(
sk
), 
UCC_RANK_INVALID
)) {

116 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "user defined datatype is‚ot supported");

117  
UCC_ERR_NOT_SUPPORTED
;

120 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

121 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
‹am
->
tİo
, 
UCC_SBGP_FULL_HOST_ORDERED
);

122 
sk
->
sub£t
.
my¿nk
 = 
sbgp
->
group_¿nk
;

123 
sk
->
sub£t
.
m­
 = 
sbgp
->map;

126 
sk
->
su³r
.
po¡
 = 
ucc__uı_®lg©h”v_ršg_¡¬t
;

127 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®lg©h”v_ršg_´og»ss
;

129  
UCC_OK
;

130 
	}
}

132 
ucc_¡©us_t
 
	$ucc__uı_®lg©h”v_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

133 
ucc_ba£_‹am_t
 *
‹am
,

134 
ucc_cŞl_sk_t
 **
sk_h
)

136 
ucc__uı_sk_t
 *
sk
;

137 
ucc_¡©us_t
 
¡©us
;

139 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

140 
¡©us
 = 
	`ucc__uı_®lg©h”v_ršg_š™_commÚ
(
sk
);

141 ià(
¡©us
 !ğ
UCC_OK
) {

142 
	`ucc__uı_put_sk
(
sk
);

143  
¡©us
;

145 *
sk_h
 = &
sk
->
su³r
;

146  
UCC_OK
;

147 
	}
}

	@src/components/tl/ucp/allreduce/allreduce.c

6 
	~"cÚfig.h
"

7 
	~"_uı.h
"

8 
	~"®Ìeduû.h
"

9 
	~"uts/ucc_cŞl_uts.h
"

11 
ucc_ba£_cŞl_®g_šfo_t


12 
	gucc__uı_®Ìeduû_®gs
[
UCC_TL_UCP_ALLREDUCE_ALG_LAST
 + 1] = {

13 [
UCC_TL_UCP_ALLREDUCE_ALG_KNOMIAL
] =

14 {.
id
 = 
UCC_TL_UCP_ALLREDUCE_ALG_KNOMIAL
,

15 .
	gÇme
 = "knomial",

16 .
	gdesc
 =

18 [
UCC_TL_UCP_ALLREDUCE_ALG_SRA_KNOMIAL
] =

19 {.
id
 = 
UCC_TL_UCP_ALLREDUCE_ALG_SRA_KNOMIAL
,

20 .
	gÇme
 = "sra_knomial",

21 .
	gdesc
 = "recursive knomial scatter-reduce followed by knomial "

23 [
UCC_TL_UCP_ALLREDUCE_ALG_DBT
] =

24 {.
id
 = 
UCC_TL_UCP_ALLREDUCE_ALG_DBT
,

25 .
	gÇme
 = "dbt",

26 .
	gdesc
 = "alreduce over double binaryree where‡†eaf in oneree "

28 [
UCC_TL_UCP_ALLREDUCE_ALG_SLIDING_WINDOW
] =

29 {.
id
 = 
UCC_TL_UCP_ALLREDUCE_ALG_SLIDING_WINDOW
,

30 .
	gÇme
 = "sliding_window",

31 .
	gdesc
 = "sliding window‡llreduce (optimized for„unning on DPU)"},

32 [
UCC_TL_UCP_ALLREDUCE_ALG_LAST
] = {

33 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

35 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_š™
(
ucc__uı_sk_t
 *
sk
)

37 
ucc_¡©us_t
 
¡©us
;

38 
	`ALLREDUCE_TASK_CHECK
(
	`TASK_ARGS
(
sk
), 
	`TASK_TEAM
(task));

39 
¡©us
 = 
	`ucc__uı_®Ìeduû_knomŸl_š™_commÚ
(
sk
);

40 
out
:

41  
¡©us
;

42 
	}
}

44 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

45 
ucc_ba£_‹am_t
 * 
‹am
,

46 
ucc_cŞl_sk_t
 ** 
sk_h
)

48 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

49 
ucc__uı_sk_t
 *
sk
;

50 
ucc_¡©us_t
 
¡©us
;

52 
	`ALLREDUCE_TASK_CHECK
(
cŞl_¬gs
->
¬gs
, 
_‹am
);

53 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

54 *
sk_h
 = &
sk
->
su³r
;

55 
¡©us
 = 
	`ucc__uı_®Ìeduû_knomŸl_š™_commÚ
(
sk
);

56 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

57 
	`ucc__uı_put_sk
(
sk
);

59 
out
:

60  
¡©us
;

61 
	}
}

	@src/components/tl/ucp/allreduce/allreduce.h

7 #iâdeà
ALLREDUCE_H_


8 
	#ALLREDUCE_H_


	)

9 
	~"_uı_cŞl.h
"

12 
	mUCC_TL_UCP_ALLREDUCE_ALG_KNOMIAL
,

13 
	mUCC_TL_UCP_ALLREDUCE_ALG_SRA_KNOMIAL
,

14 
	mUCC_TL_UCP_ALLREDUCE_ALG_SLIDING_WINDOW
,

15 
	mUCC_TL_UCP_ALLREDUCE_ALG_DBT
,

16 
	mUCC_TL_UCP_ALLREDUCE_ALG_LAST


19 
ucc_ba£_cŞl_®g_šfo_t


20 
ucc__uı_®Ìeduû_®gs
[
UCC_TL_UCP_ALLREDUCE_ALG_LAST
 + 1];

21 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_š™
(
ucc__uı_sk_t
 *
sk
);

23 
	#UCC_TL_UCP_ALLREDUCE_DEFAULT_ALG_SELECT_STR
 \

24 "®Ìeduû:0-4k:@0#®Ìeduû:4k-šf:@1"

	)

26 
	#CHECK_SAME_MEMTYPE
(
_¬gs
, 
_‹am
) \

28 ià(!
	`UCC_IS_INPLACE
(
_¬gs
) && \

29 (
_¬gs
.
¤c
.
šfo
.
mem_ty³
 !ğ_¬gs.
d¡
.info.mem_type)) { \

30 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), \

32 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
; \

33 
out
; \

35 } 0)

	)

37 
	#ALLREDUCE_TASK_CHECK
(
_¬gs
, 
_‹am
) \

38 
	`CHECK_SAME_MEMTYPE
((
_¬gs
), (
_‹am
));

	)

41 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

42 
ucc_ba£_‹am_t
 *
‹am
,

43 
ucc_cŞl_sk_t
 **
sk_h
);

45 
ucc_¡©us_t


46 
ucc__uı_®Ìeduû_¦idšg_wšdow_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

47 
ucc_ba£_‹am_t
 *
‹am
,

48 
ucc_cŞl_sk_t
 **
sk_h
);

50 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_knomŸl_š™_commÚ
(
ucc__uı_sk_t
 *
sk
);

52 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

54 
ucc__uı_®Ìeduû_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

56 
ucc_¡©us_t


57 
ucc__uı_®Ìeduû_¦idšg_wšdow_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

59 
ucc_¡©us_t


60 
ucc__uı_®Ìeduû_¦idšg_wšdow_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

62 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

64 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_¤a_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

65 
ucc_ba£_‹am_t
 *
‹am
,

66 
ucc_cŞl_sk_t
 **
sk_h
);

68 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_¤a_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

70 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_¤a_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

72 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_dbt_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

73 
ucc_ba£_‹am_t
 *
‹am
,

74 
ucc_cŞl_sk_t
 **
sk_h
);

76 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_dbt_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

78 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_dbt_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

80 
šlše
 
	$ucc__uı_®Ìeduû_®g_äom_¡r
(cÚ¡ *
¡r
)

82 
i
;

83 
i
 = 0; i < 
UCC_TL_UCP_ALLREDUCE_ALG_LAST
; i++) {

84 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__uı_®Ìeduû_®gs
[
i
].
Çme
)) {

88  
i
;

89 
	}
}

	@src/components/tl/ucp/allreduce/allreduce_dbt.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®Ìeduû.h
"

10 
	~"../»duû/»duû.h
"

11 
	~"../bÿ¡/bÿ¡.h
"

13 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_dbt_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

15 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_schedule_t);

16 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
scheduË
->
su³r
.
b¬gs
.args;

17 
ucc_cŞl_sk_t
 *
»duû_sk
, *
bÿ¡_sk
;

19 
»duû_sk
 = 
scheduË
->
sks
[0];

20 
»duû_sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 =‡rgs->src.info.buffer;

21 
»duû_sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
bufãr
 =‡rgs->dst.info.buffer;

22 
»duû_sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 =‡rgs->src.info.count;

23 
»duû_sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
 =‡rgs->dst.info.count;

25 
bÿ¡_sk
 = 
scheduË
->
sks
[1];

26 
bÿ¡_sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 =‡rgs->
d¡
.info.buffer;

27 
bÿ¡_sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 =‡rgs->
d¡
.info.count;

29 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allreduce_dbt_start", 0);

30  
	`ucc_scheduË_¡¬t
(
cŞl_sk
);

31 
	}
}

33 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_dbt_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

35 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_schedule_t);

36 
ucc_¡©us_t
 
¡©us
;

38 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
scheduË
, "ucp_allreduce_dbt_done", 0);

39 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
cŞl_sk
);

40 
	`ucc__uı_put_scheduË
(
scheduË
);

41  
¡©us
;

42 
	}
}

44 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_dbt_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

45 
ucc_ba£_‹am_t
 *
‹am
,

46 
ucc_cŞl_sk_t
 **
sk_h
)

48 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

49 
ucc_ba£_cŞl_¬gs_t
 
¬gs
 = *
cŞl_¬gs
;

50 
ucc_scheduË_t
 *
scheduË
;

51 
ucc_cŞl_sk_t
 *
»duû_sk
, *
bÿ¡_sk
;

52 
ucc_¡©us_t
 
¡©us
;

54 ià(
	`UCC_IS_INPLACE
(
¬gs
.args)) {

55  
UCC_ERR_NOT_SUPPORTED
;

58 
¡©us
 = 
	`ucc__uı_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
,

59 (
ucc__uı_scheduË_t
 **)&
scheduË
);

60 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

61  
¡©us
;

64 
¬gs
.¬gs.
roÙ
 = 0;

65 
	`UCC_CHECK_GOTO
(
	`ucc__uı_»duû_dbt_š™
(&
¬gs
, 
‹am
, &
»duû_sk
),

66 
out
, 
¡©us
);

67 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
»duû_sk
),

68 
out
, 
¡©us
);

69 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(&
scheduË
->
su³r
,

70 
UCC_EVENT_SCHEDULE_STARTED
,

71 
»duû_sk
,

72 
ucc_sk_¡¬t_hªdËr
),

73 
out
, 
¡©us
);

75 
	`UCC_CHECK_GOTO
(
	`ucc__uı_bÿ¡_dbt_š™
(&
¬gs
, 
‹am
, &
bÿ¡_sk
),

76 
out
, 
¡©us
);

77 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
bÿ¡_sk
),

78 
out
, 
¡©us
);

79 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(
»duû_sk
, 
UCC_EVENT_COMPLETED
,

80 
bÿ¡_sk
,

81 
ucc_sk_¡¬t_hªdËr
),

82 
out
, 
¡©us
);

84 
scheduË
->
su³r
.
po¡
 = 
ucc__uı_®Ìeduû_dbt_¡¬t
;

85 
scheduË
->
su³r
.
´og»ss
 = 
NULL
;

86 
scheduË
->
su³r
.
fš®ize
 = 
ucc__uı_®Ìeduû_dbt_fš®ize
;

87 *
sk_h
 = &
scheduË
->
su³r
;

89  
UCC_OK
;

91 
out
:

92 
	`ucc__uı_put_scheduË
(
scheduË
);

93  
¡©us
;

94 
	}
}

	@src/components/tl/ucp/allreduce/allreduce_knomial.c

7 
	~"®Ìeduû.h
"

8 
	~"cÜe/ucc_´og»ss_queue.h
"

9 
	~"uts/ucc_dt_»duû.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"cŞl_·‰”ns/»cursive_knomŸl.h
"

12 
	~"uts/ucc_m©h.h
"

13 
	~"uts/ucc_cŞl_uts.h
"

14 
	~"compÚ’ts/ec/ucc_ec.h
"

16 
	#SAVE_STATE
(
_pha£
) \

18 
sk
->
®Ìeduû_kn
.
pha£
 = 
_pha£
; \

19 } 0)

	)

21 
	$ucc__uı_®Ìeduû_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

23 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

24 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

25 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

26 
avg_´e_İ
 = 
‹am
->
cfg
.
»duû_avg_´e_İ
;

27 
ucc_kn_¿dix_t
 
¿dix
 = 
sk
->
®Ìeduû_kn
.
p
.radix;

28 
ušt8_t
 
node_ty³
 = 
sk
->
®Ìeduû_kn
.
p
.node_type;

29 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
®Ìeduû_kn
.p;

30 *
sü©ch
 = 
sk
->
®Ìeduû_kn
.scratch;

31 *
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

32 *
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

33 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
d¡
.
šfo
.mem_type;

34 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

35 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

36 
size_t
 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
dt
);

37 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

38 *
£nd_buf
;

39 
±rdiff_t
 
»cv_off£t
;

40 
ucc_¿nk_t
 
³”
;

41 
ucc_¡©us_t
 
¡©us
;

42 
ucc_kn_¿dix_t
 
loİ_¡•
;

43 
is_avg
;

44 
ucc_kn_¿dix_t
 
šdex
;

46 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

47 
sbuf
 = 
rbuf
;

49 
	`UCC_KN_REDUCE_GOTO_PHASE
(
sk
->
®Ìeduû_kn
.
pha£
);

51 ià(
KN_NODE_EXTRA
 =ğ
node_ty³
) {

52 
³”
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

53 
	`ucc_knomŸl_·‰”n_g‘_´oxy
(
p
, 
¿nk
));

54 
	`UCPCHECK_GOTO
(

55 
	`ucc__uı_£nd_nb
(
sbuf
, 
d©a_size
, 
mem_ty³
, 
³”
, 
‹am
, 
sk
),

56 
sk
, 
out
);

57 
	`UCPCHECK_GOTO
(

58 
	`ucc__uı_»cv_nb
(
rbuf
, 
d©a_size
, 
mem_ty³
, 
³”
, 
‹am
, 
sk
),

59 
sk
, 
out
);

62 ià(
KN_NODE_PROXY
 =ğ
node_ty³
) {

63 
³”
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

64 
	`ucc_knomŸl_·‰”n_g‘_exŒa
(
p
, 
¿nk
));

65 
	`UCPCHECK_GOTO
(

66 
	`ucc__uı_»cv_nb
(
sü©ch
, 
d©a_size
, 
mem_ty³
, 
³”
, 
‹am
, 
sk
),

67 
sk
, 
out
);

69 
UCC_KN_PHASE_EXTRA
:

70 ià(
KN_NODE_PROXY
 =ğ
node_ty³
 || 
KN_NODE_EXTRA
 ==‚ode_type) {

71 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

72 
	`SAVE_STATE
(
UCC_KN_PHASE_EXTRA
);

75 ià(
KN_NODE_EXTRA
 =ğ
node_ty³
) {

76 
com¶‘iÚ
;

78 
¡©us
 = 
	`ucc_dt_»duû
(
sbuf
, 
sü©ch
, 
rbuf
, 
couÁ
, 
dt
, 
¬gs
, 0, 0,

79 
sk
->
®Ìeduû_kn
.
executÜ
,

80 &
sk
->
®Ìeduû_kn
.
‘ask
);

81 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

82 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo…erform dt„eduction");

83 
sk
->
su³r
.
¡©us
 = status;

86 
UCC_KN_PHASE_EXTRA_REDUCE
:

87 
	`EXEC_TASK_TEST
(
UCC_KN_PHASE_EXTRA_REDUCE
,

89 
sk
->
®Ìeduû_kn
.
‘ask
);

92 !
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

93 
loİ_¡•
 = 1;†oİ_¡• < 
¿dix
;†oop_step++) {

94 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
loİ_¡•
);

95 ià(
³”
 =ğ
UCC_KN_PEER_NULL
)

97 
³”
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,…eer);

98 ià((
	`ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
p
)) &&

99 (
KN_NODE_PROXY
 !ğ
node_ty³
è&& !
	`UCC_IS_INPLACE
(*
¬gs
)) {

100 
£nd_buf
 = 
sbuf
;

102 
£nd_buf
 = 
rbuf
;

104 
	`UCPCHECK_GOTO
(

105 
	`ucc__uı_£nd_nb
(
£nd_buf
, 
d©a_size
, 
mem_ty³
, 
³”
, 
‹am
,

106 
sk
),

107 
sk
, 
out
);

110 
»cv_off£t
 = 0;

111 
loİ_¡•
 = 
¿dix
 - 1 ;†oop_step > 0;†oop_step--) {

112 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
loİ_¡•
);

113 ià(
³”
 =ğ
UCC_KN_PEER_NULL
)

115 
šdex
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_šdex
(
p
, 
³”
);

116 
³”
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,…eer);

117 
sk
->
®Ìeduû_kn
.
»duû_bufs
[
šdex
] = 
	`PTR_OFFSET
(
sü©ch
, 
»cv_off£t
);

118 
	`UCPCHECK_GOTO
(

119 
	`ucc__uı_»cv_nb
(
	`PTR_OFFSET
(
sü©ch
, 
»cv_off£t
),

120 
d©a_size
, 
mem_ty³
, 
³”
, 
‹am
, 
sk
),

121 
sk
, 
out
);

122 
»cv_off£t
 +ğ
d©a_size
;

125 
UCC_KN_PHASE_LOOP
:

126 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

127 
	`SAVE_STATE
(
UCC_KN_PHASE_LOOP
);

131 ià(
sk
->
gged
.
£nd_po¡ed
 > 
p
->
™”©iÚ
 * (
¿dix
 - 1)) {

132 ià((
	`ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
p
)) &&

133 (
KN_NODE_PROXY
 !ğ
node_ty³
è&& !
	`UCC_IS_INPLACE
(*
¬gs
)) {

134 
£nd_buf
 = 
sbuf
;

136 
£nd_buf
 = 
rbuf
;

138 
šdex
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_šdex
(
p
, 
¿nk
);

139 
sk
->
®Ìeduû_kn
.
»duû_bufs
[
šdex
] = 
£nd_buf
;

140 
is_avg
 = 
¬gs
->
İ
 =ğ
UCC_OP_AVG
 &&

141 (
avg_´e_İ
 ? 
	`ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
p
)

142 : 
	`ucc_knomŸl_·‰”n_loİ_Ï¡_™”©iÚ
(
p
));

144 
¡©us
 = 
	`ucc_dt_»duû_muÉi
(

145 
sk
->
®Ìeduû_kn
.
»duû_bufs
, 
rbuf
,ask->
gged
.
£nd_po¡ed
 - 
p
->
™”©iÚ
 * (
¿dix
 - 1) + 1,

146 
couÁ
, 
dt
, 
¬gs
,

147 
is_avg
 ? 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
 : 0, 
	`AVG_ALPHA
(
sk
),

148 
sk
->
®Ìeduû_kn
.
executÜ
, &sk->®Ìeduû_kn.
‘ask
);

149 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

150 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo…erform dt„eduction");

151 
sk
->
su³r
.
¡©us
 = status;

154 
UCC_KN_PHASE_REDUCE
:

155 
	`EXEC_TASK_TEST
(
UCC_KN_PHASE_REDUCE
,

157 
sk
->
®Ìeduû_kn
.
‘ask
);

159 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ
(
p
);

161 ià(
KN_NODE_PROXY
 =ğ
node_ty³
) {

162 
³”
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

163 
	`ucc_knomŸl_·‰”n_g‘_exŒa
(
p
, 
¿nk
));

164 
	`UCPCHECK_GOTO
(

165 
	`ucc__uı_£nd_nb
(
rbuf
, 
d©a_size
, 
mem_ty³
, 
³”
, 
‹am
, 
sk
),

166 
sk
, 
out
);

167 
UCC_KN_PHASE_PROXY
;

169 
com¶‘iÚ
;

172 
UCC_KN_PHASE_PROXY
:

173 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

174 
	`SAVE_STATE
(
UCC_KN_PHASE_PROXY
);

178 
com¶‘iÚ
:

179 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

180 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

181 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allreduce_kn_done", 0);

182 
UCC_KN_PHASE_COMPLETE
:

183 
out
:

185 
	}
}

187 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

189 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

190 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

191 
ucc_¿nk_t
 
size
 = (ucc_¿nk_t)
sk
->
sub£t
.
m­
.
•_num
;

192 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

193 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.mem_type;

194 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

195 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

196 
size_t
 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
dt
);

197 
ucc_m¿nge_ušt_t
 *
p
 = &
‹am
->
cfg
.
®Ìeduû_kn_¿dix
;

198 
ucc_kn_¿dix_t
 
cfg_¿dix
, 
¿dix
;

199 
ucc_¡©us_t
 
¡©us
;

201 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_allreduce_kn_start", 0);

202 
sk
->
®Ìeduû_kn
.
pha£
 = 
UCC_KN_PHASE_INIT
;

203 
	`ucc_as£¹
(
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sk
)) ||

204 (
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
 == mem_type));

205 
cfg_¿dix
 = 
	`ucc__uı_g‘_¿dix_äom_¿nge
(
‹am
, 
d©a_size
, 
mem_ty³
, 
p
,

206 
UCC_UUNITS_AUTO_RADIX
);

207 
¿dix
 = 
	`ucc_mš
(
cfg_¿dix
, 
size
);

209 
¿dix
 = 
	`ucc_mš
Ôadix, 
UCC_EE_EXECUTOR_NUM_BUFS
);

210 
	`ucc_knomŸl_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
,

211 &
sk
->
®Ìeduû_kn
.
p
);

212 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

213 
¡©us
 =

214 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &sk->
®Ìeduû_kn
.
executÜ
);

215 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

216  
¡©us
;

218  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

219 
	}
}

221 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_knomŸl_š™_commÚ
(
ucc__uı_sk_t
 *
sk
)

223 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

224 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.mem_type;

225 
size_t
 
couÁ
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.count;

226 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

227 
size_t
 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
dt
);

228 
ucc_m¿nge_ušt_t
 *
p
 = &
‹am
->
cfg
.
®Ìeduû_kn_¿dix
;

229 
ucc_sbgp_t
 *
sbgp
;

230 
ucc_¿nk_t
 
size
;

231 
ucc_kn_¿dix_t
 
¿dix
, 
cfg_¿dix
;

232 
ucc_¡©us_t
 
¡©us
;

234 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

235 
sk
->
su³r
.
po¡
 = 
ucc__uı_®Ìeduû_knomŸl_¡¬t
;

236 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®Ìeduû_knomŸl_´og»ss
;

237 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_®Ìeduû_knomŸl_fš®ize
;

239 ià(!(
sk
->
æags
 & 
UCC_TL_UCP_TASK_FLAG_SUBSET
è&& 
‹am
->
cfg
.
u£_»Üd”šg
) {

240 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
‹am
->
tİo
, 
UCC_SBGP_FULL_HOST_ORDERED
);

241 
sk
->
sub£t
.
my¿nk
 = 
sbgp
->
group_¿nk
;

242 
sk
->
sub£t
.
m­
 = 
sbgp
->map;

245 
size
 = (
ucc_¿nk_t
)
sk
->
sub£t
.
m­
.
•_num
;

246 
cfg_¿dix
 = 
	`ucc__uı_g‘_¿dix_äom_¿nge
(
‹am
, 
d©a_size
, 
mem_ty³
, 
p
,

247 
UCC_UUNITS_AUTO_RADIX
);

248 
¿dix
 = 
	`ucc_mš
(
cfg_¿dix
, 
size
);

249 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
®Ìeduû_kn
.
sü©ch_mc_h—d”
,

250 (
¿dix
 - 1è* 
d©a_size
,

251 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
);

252 
sk
->
®Ìeduû_kn
.
sü©ch
 =ask->®Ìeduû_kn.
sü©ch_mc_h—d”
->
addr
;

253 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

254 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo‡llocate scratch buffer");

255  
¡©us
;

257  
UCC_OK
;

258 
	}
}

260 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

262 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

263 
ucc_¡©us_t
 
¡
, 
glob®_¡
;

265 
glob®_¡
 = 
	`ucc_mc_ä“
(
sk
->
®Ìeduû_kn
.
sü©ch_mc_h—d”
);

266 ià(
	`ucc_uÆik–y
(
glob®_¡
 !ğ
UCC_OK
)) {

267 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo free scratch buffer");

270 
¡
 = 
	`ucc__uı_cŞl_fš®ize
(&
sk
->
su³r
);

271 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

272 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failed finalize collective");

273 
glob®_¡
 = 
¡
;

275  
glob®_¡
;

276 
	}
}

	@src/components/tl/ucp/allreduce/allreduce_sliding_window.c

7 
	~"®Ìeduû.h
"

8 
	~"®Ìeduû_¦idšg_wšdow.h
"

9 
	~"../®lg©h”/®lg©h”.h
"

10 
	~"../b¬r›r/b¬r›r.h
"

11 
	~"uts/ucc_dt_»duû.h
"

12 
	~"_uı_•.h
"

14 
šlše
 

15 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_»£t_buf
(
ucc__uı_®Ìeduû_sw_buf_t
 *
buf
)

17 
buf
->
¡©e
 = 
FREE
;

18 
buf
->
couÁ
 = 0;

19 
buf
->
by‹s
 = 0;

20 
buf
->
uı_»q
 = 
NULL
;

21 
	}
}

23 
šlše
 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_»£t_p–še
(

24 
ucc__uı_®Ìeduû_sw_p–še_t
 *
pe
, 
ucc_¿nk_t
 
¿nk
,

25 
ucc_¿nk_t
 
put_wšdow_size
)

27 
i
;

29 
pe
->
ava_buffs
 =…e->
num_bufãrs
;

30 
pe
->
¤c_¿nk
 =…e->
d¡_¿nk
 = 
¿nk
;

31 
pe
->
g‘_idx
 =…e->
»d_idx
 = 0;

32 
pe
->
dÚe_g‘
 =…e->
dÚe_»d
 = 0;

33 
pe
->
dÚe_put
 =…e->
po¡ed_put
 = 0;

34 
pe
->
couÁ_»duûd
 =…e->
couÁ_£rviûd
 = 0;

35 
pe
->
my_couÁ
 =…e->
my_off£t
 = 0;

36 
pe
->
couÁ_»ûived
 = 0;

38 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»£t_buf
(&
pe
->
accbuf
);

39 
i
 = 0; i < 
pe
->
num_bufãrs
; i++) {

40 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»£t_buf
(&
pe
->
g‘buf
[
i
]);

43 
	`mem£t
(
pe
->
put_»que¡s
, 0, 
put_wšdow_size
 * (
ucs_¡©us_±r_t
));

44 
	}
}

46 
ucc_¡©us_t


47 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

49 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
 = &
cŞl_sk
->
b¬gs
;

50 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

51 
ucc_scheduË_t
);

52 
ucc_ba£_‹am_t
 *
ba£_‹am
 = 
scheduË
->
su³r
.
‹am
;

53 
ucc__uı_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
ba£_‹am
,

54 
ucc__uı_‹am_t
);

55 
ucc__uı_cÚ‹xt_t
 *
_ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

56 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

57 
ušt32_t
 
couÁ_tÙ®
 = 
cŞl_sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
;

58 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

59 
ucc_d©©y³_t
 
dty³
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

60 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dty³
);

61 
š¶aû
 = 
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
);

62 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

63 
ucc_¿nk_t
 
put_wšdow_size
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)

64 ->
cfg
.
®Ìeduû_¦idšg_wšdow_put_wšdow_size
;

65 
ucc__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo_t


66 *
gwbi_p
 = 
cŞl_¬gs
->
¬gs
.
glob®_wÜk_bufãr
;

67 
ucc__uı_sk_t
 *
rdma_sk
 = 
	`ucc_d”ived_of
(
scheduË
->
sks
[0],

68 
ucc__uı_sk_t
);

69 
ucc__uı_®Ìeduû_sw_p–še_t
 *
pe
;

70 
ucc__uı_®Ìeduû_sw_ho¡_®lg©h”_t
 *
®lg©h”_d©a
;

72 
pe
 = 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.pipe;

73 
®lg©h”_d©a
 = 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.allgather_data;

76 ià(!
š¶aû
) {

77 
¡©us
 = 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»gi¡”
(

78 
_ùx
->
wÜk”
.
uı_cÚ‹xt
, 
‹am
,

79 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
,

80 
gwbi_p
->
·cked_¤c_memh
);

81 ià(
¡©us
 !ğ
UCC_OK
) {

82 
	`_”rÜ
(
	`UCC_TASK_LIB
(
rdma_sk
), "failedo„egister src memh: %s",

83 
	`ucc_¡©us_¡ršg
(
¡©us
));

84 
out
;

86 
	`ucc_as£¹
(

87 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
->
·cked_key_Ën


88 <ğ
ALLREDUCE_PACKED_KEY_MAX_LEN
);

89 
	`memıy
(
®lg©h”_d©a
->
·cked_¤c_key
,

90 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
->
·cked_key
,

91 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
->
·cked_key_Ën
);

95 
¡©us
 = 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»gi¡”
(

96 
_ùx
->
wÜk”
.
uı_cÚ‹xt
, 
‹am
,

97 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_ebuf
,

98 
gwbi_p
->
·cked_d¡_memh
);

99 ià(
¡©us
 !ğ
UCC_OK
) {

100 
	`_”rÜ
(
	`UCC_TASK_LIB
(
rdma_sk
), "failedo„egister dst memh: %s",

101 
	`ucc_¡©us_¡ršg
(
¡©us
));

102 
out
;

104 
	`ucc_as£¹
(

105 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_ebuf
->
·cked_key_Ën


106 <ğ
ALLREDUCE_PACKED_KEY_MAX_LEN
);

107 
	`memıy
(
®lg©h”_d©a
->
·cked_d¡_key
,

108 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_ebuf
->
·cked_key
,

109 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_ebuf
->
·cked_key_Ën
);

111 ià(
put_wšdow_size
 =ğ0 ||…ut_wšdow_siz> 
size
) {

112 
put_wšdow_size
 = 
size
;

115 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»£t_p–še
(

116 
pe
, 
¿nk
, 
put_wšdow_size
);

118 
pe
->
my_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
couÁ_tÙ®
, 
size
, 
¿nk
);

119 
pe
->
my_off£t
 = 
	`ucc_bufãr_block_off£t
(
couÁ_tÙ®
 * 
dt_size
, 
size
, 
¿nk
);

121 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
»duû_sk
 = 
NULL
;

123 
	`UCC_CHECK_GOTO
(
	`ucc__uı_®lg©h”_ršg_¡¬t
(

124 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
®lg©h”_sk
),

125 
out
, 
¡©us
);

127  
	`ucc_scheduË_¡¬t
(
cŞl_sk
);

129 
out
:

130 
	`_”rÜ
(
	`UCC_TASK_LIB
(
rdma_sk
), "failedo start‡llreduce sliding window: %s",

131 
	`ucc_¡©us_¡ršg
(
¡©us
));

132  
¡©us
;

133 
	}
}

135 
ucc_¡©us_t


136 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

138 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_schedule_t);

139 
ucc_¡©us_t
 
¡©us
;

141 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
cŞl_sk
);

142 
	`ucc__uı_put_scheduË
(
scheduË
);

144  
¡©us
;

145 
	}
}

147 
ucc_¡©us_t


148 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_rdma_sk_po¡
(

149 
ucc_cŞl_sk_t
 *
cŞl_sk
)

151 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

152 
ucc__uı_sk_t
);

153 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

155 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

157  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

158 
	}
}

160 
šlše
 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_rkeys
(

161 
ucc_cŞl_sk_t
 *
cŞl_sk
)

163 
ucc_ba£_‹am_t
 *
‹am
 = 
cŞl_sk
->team;

164 
ucc_¿nk_t
 
‹am_size
 = (ucc_¿nk_t)
‹am
->
·¿ms
.
size
;

165 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

166 
š¶aû
 = 
	`UCC_IS_INPLACE
(
cŞl_sk
->
b¬gs
.
¬gs
);

167 
ucc_¿nk_t
 
i
;

169 
i
 = 0; i < 
‹am_size
; i++) {

170 ià(!
š¶aû
 && 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_rkeys
[
i
] !ğ
NULL
) {

171 
	`uı_rkey_de¡roy
(
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_rkeys
[
i
]);

173 ià(
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_rkeys
[
i
] !ğ
NULL
) {

174 
	`uı_rkey_de¡roy
(
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_rkeys
[
i
]);

177 
	}
}

179 
ucc_¡©us_t


180 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_rdma_sk_fš®ize
(

181 
ucc_cŞl_sk_t
 *
cŞl_sk
)

183 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

184 
ucc_¡©us_t
 
¡
 = 
UCC_OK
;

186 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_rkeys
(
cŞl_sk
);

187 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_sk
(
cŞl_sk
);

188 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_pe
(
cŞl_sk
);

190 
¡
 = 
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

192 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

193 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo finalize collective");

196  
¡
;

197 
	}
}

199 
šlše
 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_»duùiÚ
(

200 
ucc_cŞl_sk_t
 *
cŞl_sk
, 
ucc__uı_®Ìeduû_sw_buf_t
 *
accbuf
,

201 
ucc__uı_®Ìeduû_sw_buf_t
 *
g‘buf
)

203 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

204 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

205 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

206 
ucc_d©©y³_t
 
dt
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

207 
ucc_“_executÜ_t
 *
exec
;

209 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

210 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

211 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo getƒxecutor");

214 
¡©us
 =

215 
	`ucc_dt_»duû
(
accbuf
->
buf
, 
g‘buf
->buf,‡ccbuf->buf,‡ccbuf->
couÁ
, 
dt
,

216 
¬gs
, 0, 0, 
exec
,

217 &
sk
->
®Ìeduû_¦idšg_wšdow
.
»duû_sk
);

219 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

220 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo…erform dt„eduction");

221 
sk
->
su³r
.
¡©us
 = status;

224 
	}
}

226 
šlše
 

227 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_‹¡_»duùiÚ
(
ucc__uı_sk_t
 *
sk
)

229 
ucc_¡©us_t
 
¡©us
;

231 
	#SAVE_STATE
(
_pha£
)

	)

233 
	`EXEC_TASK_TEST
(
NULL
,

235 
sk
->
®Ìeduû_¦idšg_wšdow
.
»duû_sk
);

238 
sk
->
®Ìeduû_¦idšg_wšdow
.
»duû_sk
 = 
NULL
;

239 
	}
}

241 
šlše
 
ucc_¡©us_t


242 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_»q_‹¡
(
ucs_¡©us_±r_t
 
»que¡
,

243 
ucc__uı_sk_t
 *
sk
)

245 ià(
»que¡
 =ğ
NULL
) {

246  
UCC_OK
;

247 } ià(
	`UCS_PTR_IS_ERR
(
»que¡
)) {

248 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "unableo complete UCX„equest=%p: %d",

249 
»que¡
, 
	`UCS_PTR_STATUS
(request));

250  
	`ucs_¡©us_to_ucc_¡©us
(
	`UCS_PTR_STATUS
(
»que¡
));

252  
	`ucs_¡©us_to_ucc_¡©us
(
	`uı_»que¡_check_¡©us
(
»que¡
));

254 
	}
}

256 
šlše
 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_key_exchªge_´og»ss
(

257 
ucc_cŞl_sk_t
 *
cŞl_sk
)

259 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

260 
ucc_cŞl_sk_t
 *
®lg©h”_sk
 =

261 
sk
->
®Ìeduû_¦idšg_wšdow
.
®lg©h”_sk
;

262 
ucc_¡©us_t
 
¡©us
 = 
®lg©h”_sk
->
su³r
.status;

264 ià(
¡©us
 < 0) {

265 
”r
;

267 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

268 
	`ucc__uı_®lg©h”_ršg_´og»ss
(
®lg©h”_sk
);

271 
	`ucc_as£¹
(
¡©us
 =ğ
UCC_OK
);

274 
	`UCC_CHECK_GOTO
(

275 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_®lg©h”_šfo_fš®ize
(
sk
),

276 
”r
, 
¡©us
);

278 
out
:

279 
	`ucc__uı_cŞl_fš®ize
(
®lg©h”_sk
);

280 
sk
->
®Ìeduû_¦idšg_wšdow
.
®lg©h”_sk
 = 
NULL
;

282 
”r
:

283 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_sk
(
cŞl_sk
);

284 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_pe
(
cŞl_sk
);

285 
	`_”rÜ
(
cŞl_sk
->
‹am
->
cÚ‹xt
->
lib
,

287 
	`ucc_¡©us_¡ršg
(
¡©us
));

288 
out
;

289 
	}
}

291 
šlše
 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_m¬k_»dbuf_ä“
(

292 
ucc__uı_®Ìeduû_sw_p–še_t
 *
pe
,

293 
ucc__uı_®Ìeduû_sw_buf_t
 *
accbuf
,

294 
ucc__uı_®Ìeduû_sw_buf_t
 *
»dbuf
,

295 
ucc_¿nk_t
 
ho¡_‹am_size
)

297 
»dbuf
->
¡©e
 = 
FREE
;

298 
pe
->
ava_buffs
++;

299 
pe
->
»d_idx
++;

300 
pe
->
dÚe_»d
++;

302 ià(
pe
->
dÚe_»d
 =ğ
ho¡_‹am_size
 - 1) {

303 
accbuf
->
¡©e
 = 
REDUCED
;

304 
pe
->
couÁ_»duûd
 +ğ
accbuf
->
couÁ
;

306 
	}
}

308 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_rdma_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

310 
ucc__uı_sk_t
 *
sk
 =

311 
	`ucc_d”ived_of
(
cŞl_sk
, 
ucc__uı_sk_t
);

312 
ucc_¿nk_t
 
size
 =

313 (
ucc_¿nk_t
)
sk
->
sub£t
.
m­
.
•_num
;

314 
ucc_d©©y³_t
 
dty³
 =

315 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
;

316 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dty³
);

317 
ucc_¿nk_t
 
ho¡_‹am_size
 = 
size
;

318 
ucc_ba£_‹am_t
 *
ba£_‹am
 = 
cŞl_sk
->
‹am
;

319 
ucc__uı_‹am_t
 *
_‹am
 =

320 
	`ucc_d”ived_of
(
ba£_‹am
, 
ucc__uı_‹am_t
);

321 
ucc__uı_®Ìeduû_sw_p–še_t
 *
pe
 =

322 
sk
->
®Ìeduû_¦idšg_wšdow
.
pe
;

323 
ucc__uı_cÚ‹xt_t
 *
_ùx
 =

324 
	`UCC_TL_UCP_TEAM_CTX
(
_‹am
);

325 
ucc__uı_®Ìeduû_sw_buf_t
 *
accbuf
 = &
pe
->accbuf;

326 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

327 
i
 = 0;

328 
ucc_cŞl_sk_t
 *
®lg©h”_sk
 =

329 
sk
->
®Ìeduû_¦idšg_wšdow
.
®lg©h”_sk
;

330 
ucc_“_executÜ_sk_t
 **
»duû_sk
 =

331 &
sk
->
®Ìeduû_¦idšg_wšdow
.
»duû_sk
;

332 
ucc_¿nk_t
 
put_wšdow_size
 =

333 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->

334 
cfg
.
®Ìeduû_¦idšg_wšdow_put_wšdow_size
;

335 
ucc__uı_®Ìeduû_sw_buf_t
 *
»dbuf
;

336 
ucc__uı_®Ìeduû_sw_buf_t
 *
g‘buf
;

337 
size_t
 
»maššg_–ems
;

338 
ucc_¿nk_t
 
g‘_idx
;

339 
size_t
 
couÁ
;

340 
size_t
 
g‘_off£t
;

341 
size_t
 
d©a_size
;

342 
ucc_¿nk_t
 
¤c_¿nk
;

343 
ucc_¿nk_t
 
d¡_¿nk
;

344 *
¤c_addr
;

345 *
d¡_addr
;

346 
ucs_¡©us_±r_t
 
»que¡
;

347 
size_t
 
»d_idx
;

348 
size_t
 
put_off£t
;

349 
wšdow
;

350 
put_idx
;

351 
uı_•_h
 
•
;

352 
ucc_¡©us_t
 
¡©us
;

354 
	`ucc_as£¹
(
ho¡_‹am_size
 > 0);

356 ià(
®lg©h”_sk
 !ğ
NULL
) {

357 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_key_exchªge_´og»ss
(
cŞl_sk
);

361 ià(*
»duû_sk
 !ğ
NULL
) {

364 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_‹¡_»duùiÚ
(
sk
);

366 ià(*
»duû_sk
 !ğ
NULL
) {

370 
»d_idx
 = 
pe
->»d_idx %…e->
num_bufãrs
;

371 
»dbuf
 = &
pe
->
g‘buf
[
»d_idx
];

373 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_m¬k_»dbuf_ä“
(

374 
pe
, 
accbuf
, 
»dbuf
, 
ho¡_‹am_size
);

377 ià(
pe
->
couÁ_£rviûd
 <…e->
my_couÁ
) {

378 ià((
pe
->
couÁ_»ûived
 <…e->
my_couÁ
) &&

379 (
pe
->
dÚe_g‘
 < 
ho¡_‹am_size
è&& (pe->
ava_buffs
 > 0) &&

380 (
accbuf
->
¡©e
 !ğ
REDUCED
 &&‡ccbuf->¡©!ğ
SENDING
)) {

381 
»maššg_–ems
 = 
pe
->
my_couÁ
 -…e->
couÁ_»ûived
;

382 
g‘_idx
 = 
pe
->g‘_idx %…e->
num_bufãrs
;

383 
couÁ
 = 
	`ucc_mš
(
pe
->
bufãr_size
 / 
dt_size
, 
»maššg_–ems
);

384 
g‘_off£t
 = 
pe
->
couÁ_»ûived
 * 
dt_size
 +…e->
my_off£t
;

385 
d©a_size
 = 
couÁ
 * 
dt_size
;

386 
¤c_¿nk
 = 
pe
->src_rank;

387 
g‘buf
 = 
accbuf
->
¡©e
 =ğ
FREE
 ?‡ccbuà: &
pe
->g‘buf[
g‘_idx
];

388 
¤c_addr
 = 
	`PTR_OFFSET
(

389 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
sbufs
[
¤c_¿nk
],

390 
g‘_off£t
);

391 
d¡_addr
 = 
g‘buf
->
buf
;

393 
	`ucc_as£¹
(
g‘buf
->
¡©e
 =ğ
FREE
);

395 
g‘buf
->
¡©e
 = 
RECVING
;

396 
g‘buf
->
couÁ
 = count;

397 
g‘buf
->
by‹s
 = 
d©a_size
;

398 
	`ucc__uı_g‘_•
(
_‹am
, 
¤c_¿nk
, &
•
);

399 
g‘buf
->
uı_»q
 = 
	`uı_g‘_nbx
(

400 
•
, 
d¡_addr
,

401 
d©a_size
, (
ušt64_t
)
¤c_addr
,

402 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_rkeys
[
¤c_¿nk
],

403 &
»q_·¿m
);

405 
pe
->
¤c_¿nk
 = (¤c_¿nk + 1è% 
ho¡_‹am_size
;

407 ià(
g‘buf
 !ğ
accbuf
) {

408 
pe
->
ava_buffs
--;

409 
pe
->
g‘_idx
++;

412 
pe
->
dÚe_g‘
++;

413 ià(
pe
->
dÚe_g‘
 =ğ
ho¡_‹am_size
) {

414 
pe
->
couÁ_»ûived
 +ğ
couÁ
;

418 ià(
accbuf
->
¡©e
 =ğ
RECVING
) {

419 
»que¡
 = 
accbuf
->
uı_»q
;

420 
¡©us
 = 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»q_‹¡
(
»que¡
, 
sk
);

421 ià(
¡©us
 =ğ
UCC_OK
) {

422 ià(
»que¡
)

423 
	`uı_»que¡_ä“
(
»que¡
);

424 
accbuf
->
¡©e
 = 
REDUCING
;

425 
accbuf
->
uı_»q
 = 
NULL
;

426 } ià(
¡©us
 < 0) {

427 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "accbuf„equest failed: %s",

428 
	`ucc_¡©us_¡ršg
(
¡©us
));

432 
»d_idx
 = 
pe
->»d_idx %…e->
num_bufãrs
;

433 
»dbuf
 = &
pe
->
g‘buf
[
»d_idx
];

434 ià(
accbuf
->
¡©e
 =ğ
REDUCING
 && 
»dbuf
->¡©=ğ
RECVING
) {

435 
»que¡
 = 
»dbuf
->
uı_»q
;

436 
¡©us
 = 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»q_‹¡
(
»que¡
, 
sk
);

437 ià(
¡©us
 =ğ
UCC_OK
) {

438 ià(
»que¡
)

439 
	`uı_»que¡_ä“
(
»que¡
);

440 
»dbuf
->
¡©e
 = 
REDUCING
;

441 
»dbuf
->
uı_»q
 = 
NULL
;

443 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»duùiÚ
(
cŞl_sk
, 
accbuf
,

444 
»dbuf
);

446 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_‹¡_»duùiÚ
(
sk
);

448 ià(*
»duû_sk
 !ğ
NULL
) {

452 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_m¬k_»dbuf_ä“
(

453 
pe
, 
accbuf
, 
»dbuf
, 
ho¡_‹am_size
);

455 } ià(
¡©us
 < 0) {

456 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "redbuf„equest failed: %s",

457 
	`ucc_¡©us_¡ršg
(
¡©us
));

461 ià((
pe
->
couÁ_£rviûd
 <…e->
couÁ_»duûd
) &&

462 (
accbuf
->
¡©e
 =ğ
REDUCED
)) {

463 
d©a_size
 = 
accbuf
->
by‹s
;

464 
put_off£t
 = 
pe
->
couÁ_£rviûd
 * 
dt_size
 +…e->
my_off£t
;

466 ià(
put_wšdow_size
 =ğ0 ||…ut_wšdow_siz> 
ho¡_‹am_size
) {

467 
put_wšdow_size
 = 
ho¡_‹am_size
;

470 
wšdow
 = 
	`ucc_mš
(
put_wšdow_size
,

471 
ho¡_‹am_size
 - 
pe
->
po¡ed_put
);

473 
i
 = 0; i < 
wšdow
; i++) {

474 
d¡_¿nk
 = 
pe
->dst_rank;

475 
¤c_addr
 = 
accbuf
->
buf
;

476 
d¡_addr
 = 
	`PTR_OFFSET
(

477 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
rbufs
[
d¡_¿nk
],

478 
put_off£t
);

479 
put_idx
 = 
pe
->
po¡ed_put
 %

480 
put_wšdow_size
;

482 ià(
sk
->
®Ìeduû_¦idšg_wšdow
.
put_»que¡s
[
put_idx
] !=

483 
NULL
) {

491 
	`uı_wÜk”_ãnû
(
_ùx
->
wÜk”
.
uı_wÜk”
);

492 
	`ucc__uı_g‘_•
(
_‹am
, 
d¡_¿nk
, &
•
);

493 
sk
->
®Ìeduû_¦idšg_wšdow
.
put_»que¡s
[
put_idx
] =

494 
	`uı_put_nbx
(

495 
•
, 
¤c_addr
,

496 
d©a_size
, (
ušt64_t
)
d¡_addr
,

497 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_rkeys
[
d¡_¿nk
],

498 &
»q_·¿m
);

500 
pe
->
po¡ed_put
++;

501 
pe
->
d¡_¿nk
 = (d¡_¿nk + 1è% 
ho¡_‹am_size
;

504 
i
 = 
pe
->
dÚe_put
; i <…e->
po¡ed_put
; i++) {

505 
put_idx
 = 
i
 % 
put_wšdow_size
;

506 
»que¡
 = 
sk
->
®Ìeduû_¦idšg_wšdow
.
put_»que¡s
[
put_idx
];

510 ià(
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»q_‹¡
(

511 
»que¡
, 
sk
è!ğ
UCC_OK
)

514 ià(
»que¡
 !ğ
NULL
)

515 
	`uı_»que¡_ä“
(
»que¡
);

516 
sk
->
®Ìeduû_¦idšg_wšdow
.
put_»que¡s
[
put_idx
] = 
NULL
;

517 
pe
->
dÚe_put
++;

520 ià(
pe
->
dÚe_put
 =ğ
ho¡_‹am_size
) {

521 
	`ucc_as£¹
(
pe
->
ava_buffs
 =ğpe->
num_bufãrs
);

522 
	`ucc_as£¹
(
pe
->
dÚe_g‘
 =ğ
ho¡_‹am_size
);

523 
	`ucc_as£¹
(
pe
->
dÚe_»d
 =ğ
ho¡_‹am_size
 - 1);

525 
pe
->
couÁ_£rviûd
 +ğ
accbuf
->
couÁ
;

527 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_»£t_buf
(
accbuf
);

528 
pe
->
dÚe_g‘
 = 0;

529 
pe
->
dÚe_»d
 =…e->
dÚe_put
 =…e->
po¡ed_put
 = 0;

533 
	`uı_wÜk”_´og»ss
(
_ùx
->
wÜk”
.
uı_wÜk”
);

536 ià(
pe
->
couÁ_£rviûd
 =ğpe->
my_couÁ
) {

537 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

539 
	}
}

541 
ucc_¡©us_t


542 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

543 
ucc_ba£_‹am_t
 *
‹am
,

544 
ucc_cŞl_sk_t
 **
sk_h
)

546 
ucc_scheduË_t
 *
scheduË
 = 
NULL
;

547 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

548 
ucc__uı_‹am_t
 *
_‹am
 =

549 
	`ucc_d”ived_of
(
‹am
, 
ucc__uı_‹am_t
);

550 
size_t
 
®lg©h”_size
 =

551 (
ucc__uı_®Ìeduû_sw_ho¡_®lg©h”_t
);

552 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

553 
ucc_ba£_cŞl_¬gs_t
 
b¬gs
 = {

554 .
mask
 = 0,

555 .
¬gs
 = {

556 .
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLGATHER
,

557 .
mask
 = 0,

558 .
¤c
.
šfo
 = {.
bufãr
 = 
NULL
,

559 .
couÁ
 = 
®lg©h”_size
,

560 .
d©©y³
 = 
UCC_DT_UINT8
,

561 .
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
},

562 .
d¡
.
šfo
 = {.
bufãr
 = 
NULL
,

563 .
couÁ
 = 
®lg©h”_size
 * 
size
,

564 .
d©©y³
 = 
UCC_DT_UINT8
,

565 .
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
}

568 
ucc_ba£_cŞl_¬gs_t
 
b¬r›r_cŞl_¬gs
 = {

569 .
‹am
 =—m->
·¿ms
.team,

570 .
¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_BARRIER
,

572 
ucc__uı_®Ìeduû_sw_ho¡_®lg©h”_t
 *
®lg©h”_d©a
;

573 
ucc__uı_sk_t
 *
rdma_sk
;

574 
ucc_cŞl_sk_t
 *
b¬r›r_sk
;

576 ià(!(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
) ||

577 !(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) ||

578 !(
cŞl_¬gs
->
¬gs
.
æags
 & 
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
)) {

579 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "sliding window‡llreduce„equires "

582  
UCC_ERR_NOT_SUPPORTED
;

585 
¡©us
 = 
	`ucc__uı_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
,

586 (
ucc__uı_scheduË_t
 **)&
scheduË
);

587 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

588  
¡©us
;

591 *
sk_h
 = &
scheduË
->
su³r
;

592 
scheduË
->
su³r
.
po¡
 = 
ucc__uı_®Ìeduû_¦idšg_wšdow_¡¬t
;

593 
scheduË
->
su³r
.
´og»ss
 = 
NULL
;

594 
scheduË
->
su³r
.
fš®ize
 = 
ucc__uı_®Ìeduû_¦idšg_wšdow_fš®ize
;

596 
scheduË
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

598 
rdma_sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

599 ià(
	`ucc_uÆik–y
(!
rdma_sk
)) {

600 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "Couldnt‡llocateask");

601  
UCC_ERR_NO_MEMORY
;

604 ià(
	`ucc__uı_®Ìeduû_¦idšg_wšdow_®loc_pe
(
‹am
, 
rdma_sk
è!ğ
UCC_OK
) {

605 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "failedo‡lloc…ipe: %s",

606 
	`ucc_¡©us_¡ršg
(
¡©us
));

607 
ä“_rdma_sk
;

610 
¡©us
 = 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_sk_š™
(
cŞl_¬gs
, 
‹am
,

611 
rdma_sk
);

612 ià(
¡©us
 !ğ
UCC_OK
) {

613 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "failedo initask: %s",

614 
	`ucc_¡©us_¡ršg
(
¡©us
));

615 
out
;

618 
®lg©h”_d©a
 = 
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.allgather_data;

619 
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 = 
®lg©h”_d©a
;

620 
b¬gs
.
¬gs
.
d¡
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
®lg©h”_d©a
, 
®lg©h”_size
);

622 
rdma_sk
->
su³r
.
po¡
 = 
ucc__uı_®Ìeduû_¦idšg_wšdow_rdma_sk_po¡
;

623 
rdma_sk
->
su³r
.
´og»ss
 = 
ucc__uı_®Ìeduû_¦idšg_wšdow_rdma_´og»ss
;

624 
rdma_sk
->
su³r
.
fš®ize
 = 
ucc__uı_®Ìeduû_¦idšg_wšdow_rdma_sk_fš®ize
;

626 
	`UCC_CHECK_GOTO
(
	`ucc__uı_®lg©h”_ršg_š™
(&
b¬gs
, 
‹am
,

627 &
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
®lg©h”_sk
),

628 
ä“_rdma_pe
, 
¡©us
);

630 
¡©us
 = 
	`ucc__uı_cŞl_š™
(&
b¬r›r_cŞl_¬gs
, 
‹am
,

631 &
b¬r›r_sk
);

632 ià(
¡©us
 < 0) {

633 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

635 
	`ucc_¡©us_¡ršg
(
¡©us
));

636 
ä“_®lg©h”_sk
;

639 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, &
rdma_sk
->
su³r
), 
out
, 
¡©us
);

640 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(&
scheduË
->
su³r
,

641 
UCC_EVENT_SCHEDULE_STARTED
,

642 &
rdma_sk
->
su³r
,

643 
ucc_sk_¡¬t_hªdËr
),

644 
ä“_b¬r›r_sk
, 
¡©us
);

646 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
b¬r›r_sk
), 
out
, 
¡©us
);

647 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(&
rdma_sk
->
su³r
,

648 
UCC_EVENT_COMPLETED
,

649 
b¬r›r_sk
,

650 
ucc_sk_¡¬t_hªdËr
),

651 
ä“_b¬r›r_sk
, 
¡©us
);

653  
¡©us
;

655 
ä“_b¬r›r_sk
:

656 
	`ucc__uı_cŞl_fš®ize
(
b¬r›r_sk
);

657 
ä“_®lg©h”_sk
:

658 
	`ucc__uı_cŞl_fš®ize
(
rdma_sk
->
®Ìeduû_¦idšg_wšdow
.
®lg©h”_sk
);

659 
ä“_rdma_pe
:

660 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_pe
(&
rdma_sk
->
su³r
);

661 
ä“_rdma_sk
:

662 
	`ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_sk
(&
rdma_sk
->
su³r
);

663 
out
:

664 
	`ucc__uı_put_scheduË
(
scheduË
);

665  
¡©us
;

666 
	}
}

	@src/components/tl/ucp/allreduce/allreduce_sliding_window.h

7 #iâdeà
ALLREDUCE_SW_H_


8 
	#ALLREDUCE_SW_H_


	)

10 
	~"_uı_cŞl.h
"

11 
	~"_uı_dpu_ofæßd.h
"

13 
	eucc__uı_®Ìeduû_sw_buf_¡©e
 {

14 
	mFREE
,

15 
	mRECVING
,

16 
	mREDUCING
,

17 
	mREDUCED
,

18 
	mSENDING
,

19 
	mIDLE
,

20 } 
	tucc__uı_®Ìeduû_sw_buf_¡©e_t
;

22 
	succ__uı_®Ìeduû_sw_buf
 {

23 *
	mbuf
;

24 
ucc__uı_®Ìeduû_sw_buf_¡©e_t
 
	m¡©e
;

25 
ucs_¡©us_±r_t
 
	muı_»q
;

26 
size_t
 
	mcouÁ
;

27 
size_t
 
	mby‹s
;

28 } 
	tucc__uı_®Ìeduû_sw_buf_t
;

30 
	succ__uı_®Ìeduû_sw_p–še
 {

31 
ucc__uı_®Ìeduû_sw_buf_t
 
	maccbuf
;

32 
ucc__uı_®Ìeduû_sw_buf_t
 *
	mg‘buf
;

33 
ucs_¡©us_±r_t
 *
	mput_»que¡s
;

34 
size_t
 
	mbufãr_size
;

35 
size_t
 
	mnum_bufãrs
;

36 
size_t
 
	mava_buffs
;

37 
size_t
 
	mmy_couÁ
;

38 
size_t
 
	mmy_off£t
;

39 
size_t
 
	mcouÁ_»ûived
;

40 
size_t
 
	mcouÁ_»duûd
;

41 
size_t
 
	mcouÁ_£rviûd
;

42 
size_t
 
	mg‘_idx
;

43 
size_t
 
	m»d_idx
;

44 
ucc_¿nk_t
 
	m¤c_¿nk
;

45 
ucc_¿nk_t
 
	md¡_¿nk
;

46 
	mdÚe_g‘
;

47 
	mdÚe_»d
;

48 
	mdÚe_put
;

49 
	mpo¡ed_put
;

50 } 
	tucc__uı_®Ìeduû_sw_p–še_t
;

53 
ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_sk
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

56 
ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_pe
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

58 
ucc_¡©us_t


59 
ucc__uı_®Ìeduû_¦idšg_wšdow_®loc_pe
(
ucc_ba£_‹am_t
 *
‹am
,

60 
ucc__uı_sk_t
 *
sk
);

62 
ucc_¡©us_t


63 
ucc__uı_®Ìeduû_¦idšg_wšdow_sk_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

64 
ucc_ba£_‹am_t
 *
‹am
,

65 
ucc__uı_sk_t
 *
sk
);

67 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_¦idšg_wšdow_®lg©h”_šfo_fš®ize
(

68 
ucc__uı_sk_t
 *
sw_sk
);

70 
ucc_¡©us_t


71 
ucc__uı_®Ìeduû_¦idšg_wšdow_rdma_sk_po¡
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

73 
ucc__uı_®Ìeduû_¦idšg_wšdow_rdma_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

	@src/components/tl/ucp/allreduce/allreduce_sliding_window_setup.c

7 
	~"®Ìeduû.h
"

8 
	~"®Ìeduû_¦idšg_wšdow.h
"

9 
	~"../®lg©h”/®lg©h”.h
"

10 
	~"uts/ucc_dt_»duû.h
"

11 
	~"_uı_•.h
"

13 
ucc_¡©us_t


14 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_®loc_pe
(
ucc_ba£_‹am_t
 *
‹am
,

15 
ucc__uı_sk_t
 *
sk
)

17 
ucc__uı_‹am_t
 *
_‹am
 =

18 
	`ucc_d”ived_of
(
‹am
, 
ucc__uı_‹am_t
);

19 
ucc_¿nk_t
 
‹am_size
 =

20 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

21 
ucc__uı_lib_cÚfig_t
 *
cfg
 =

22 &
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
;

23 cÚ¡ 
size_t
 
buf_size
 =

24 
cfg
->
®Ìeduû_¦idšg_wšdow_buf_size
;

25 
ušt32_t
 
put_wšdow_size
 =

26 
cfg
->
®Ìeduû_¦idšg_wšdow_put_wšdow_size
;

27 
ušt32_t
 
num_g‘_bufs
 =

28 
cfg
->
®Ìeduû_¦idšg_wšdow_num_g‘_bufs
;

29 
i
, 
j
;

30 
ucc__uı_®Ìeduû_sw_p–še
 *
pe
;

32 
pe
 = 
	`ucc_m®loc
((
ucc__uı_®Ìeduû_sw_p–še
));

33 ià(
pe
 =ğ
NULL
) {

34 
”r
;

37 
	`ucc_as£¹
(
‹am_size
 > 0);

39 ià(
put_wšdow_size
 =ğ0 ||…ut_wšdow_siz> 
‹am_size
) {

40 
put_wšdow_size
 = 
‹am_size
;

43 ià(
num_g‘_bufs
 == 0) {

44 
num_g‘_bufs
 = 
‹am_size
;

47 
pe
->
accbuf
.
buf
 = 
	`ucc_m®loc
(
buf_size
);

48 ià(
pe
->
accbuf
.
buf
 =ğ
NULL
) {

49 
ä“_pe
;

51 
pe
->
g‘buf
 = (
ucc__uı_®Ìeduû_sw_buf_t
 *)
	`ucc_m®loc
(

52 
num_g‘_bufs
 * (
ucc__uı_®Ìeduû_sw_buf_t
));

53 ià(
pe
->
g‘buf
 =ğ
NULL
) {

54 
ä“_acc
;

56 
i
 = 0; i < 
num_g‘_bufs
; i++) {

57 
pe
->
g‘buf
[
i
].
buf
 = 
	`ucc_m®loc
(
buf_size
);

58 ià(
pe
->
g‘buf
[
i
].
buf
 =ğ
NULL
) {

59 
ä“_g‘buf
;

63 
pe
->
bufãr_size
 = 
buf_size
;

64 
pe
->
num_bufãrs
 = 
num_g‘_bufs
;

65 
pe
->
put_»que¡s
 = (
ucs_¡©us_±r_t
 *)
	`ucc_m®loc
(

66 
put_wšdow_size
 * (
ucs_¡©us_±r_t
));

67 ià(
pe
->
put_»que¡s
 =ğ
NULL
) {

68 
ä“_g‘buf
;

71 
sk
->
®Ìeduû_¦idšg_wšdow
.
pe
 =…ipe;

72 
sk
->
®Ìeduû_¦idšg_wšdow
.
put_»que¡s
 =

73 
sk
->
®Ìeduû_¦idšg_wšdow
.
pe
->
put_»que¡s
;

75  
UCC_OK
;

77 
ä“_g‘buf
:

78 
j
 = 0; j < 
i
; j++) {

79 
	`ucc_ä“
(
pe
->
g‘buf
[
j
].
buf
);

81 
	`ucc_ä“
(
pe
->
g‘buf
);

82 
ä“_acc
:

83 
	`ucc_ä“
(
pe
->
accbuf
.
buf
);

84 
ä“_pe
:

85 
	`ucc_ä“
(
pe
);

86 
”r
:

87 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "error‡llocating sliding window…ipe");

88  
UCC_ERR_NO_RESOURCE
;

89 
	}
}

91 
ucc_¡©us_t


92 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_sk_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

93 
ucc_ba£_‹am_t
 *
‹am
,

94 
ucc__uı_sk_t
 *
sk
)

96 *
¤c_buf
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
bufãr
;

97 *
d¡_buf
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
bufãr
;

98 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

99 
ucc_¿nk_t
 
‹am_size
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

100 
š¶aû
 = 
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
);

101 
ucc__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo_t


102 *
gwbi_p
 = 
NULL
;

103 
size_t
 
®lg©h”_size
 =

104 (
ucc__uı_®Ìeduû_sw_ho¡_®lg©h”_t
);

105 
ucc__uı_®Ìeduû_sw_ho¡_®lg©h”_t


106 *
®lg©h”_d©a
;

107 
ucc_¿nk_t
 
i
;

108 *
bufãr
;

109 *
±r
;

110 
size_t
 
bufs_sz
, 
®lg©h”_d©a_sz
, 
rbufs_sz
, 
d¡_rkeys_sz
,

111 
d¡_ebuf_sz
, 
sbufs_sz
, 
¤c_rkeys_sz
, 
¤c_ebuf_sz
;

113 
	`ucc_as£¹
(
‹am_size
 > 0);

115 
bufs_sz
 = (
ucc__uı_dpu_ofæßd_buf_šfo_t
);

116 
®lg©h”_d©a_sz
 = 
®lg©h”_size
 * (
‹am_size
 + 1);

117 
rbufs_sz
 = (*è* 
‹am_size
;

118 
d¡_rkeys_sz
 = (
uı_rkey_h
è* 
‹am_size
;

119 
d¡_ebuf_sz
 = (
ucc__uı_®Ìeduû_sw_expÜt_buf
);

121 ià(!
š¶aû
) {

122 
sbufs_sz
 = (*è* 
‹am_size
;

123 
¤c_rkeys_sz
 = (
uı_rkey_h
è* 
‹am_size
;

124 
¤c_ebuf_sz
 = (
ucc__uı_®Ìeduû_sw_expÜt_buf
);

126 
sbufs_sz
 = 0;

127 
¤c_rkeys_sz
 = 0;

128 
¤c_ebuf_sz
 = 0;

131 
bufãr
 = 
	`ucc_m®loc
(
bufs_sz
 + 
®lg©h”_d©a_sz
 + 
rbufs_sz
 +

132 
d¡_rkeys_sz
 + 
d¡_ebuf_sz
 + 
sbufs_sz
 +

133 
¤c_rkeys_sz
 + 
¤c_ebuf_sz
);

134 ià(
bufãr
 =ğ
NULL
) {

135 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "error while‡llocatingask");

136  
UCC_ERR_NO_RESOURCE
;

139 
±r
 = 
bufãr
;

141 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
 = 
±r
;

143 
±r
 = 
®lg©h”_d©a
 = 
	`PTR_OFFSET
ÕŒ, 
bufs_sz
);

144 
sk
->
®Ìeduû_¦idšg_wšdow
.
®lg©h”_d©a
 =‡llgather_data;

146 
gwbi_p
 = 
cŞl_¬gs
->
¬gs
.
glob®_wÜk_bufãr
;

147 
sk
->
su³r
.
b¬gs
.
¬gs
.
glob®_wÜk_bufãr
 = 
gwbi_p
;

149 
sk
->
®Ìeduû_¦idšg_wšdow
.
»duû_sk
 = 
NULL
;

151 
±r
 = 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
rbufs
 = 
	`PTR_OFFSET
ÕŒ, 
®lg©h”_d©a_sz
);

152 
±r
 = 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_rkeys
 = 
	`PTR_OFFSET
ÕŒ, 
rbufs_sz
);

153 
i
 = 0; i < 
‹am_size
; i++) {

154 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_rkeys
[
i
] = 
NULL
;

157 
±r
 = 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_ebuf
 = 
	`PTR_OFFSET
ÕŒ, 
d¡_rkeys_sz
);

158 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_ebuf
->
memh
 = 
NULL
;

160 
®lg©h”_d©a
->
d¡_buf
 = dst_buf;

162 
sk
->
®Ìeduû_¦idšg_wšdow
.
®lg©h”_d©a
 =‡llgather_data;

163 
sk
->
®Ìeduû_¦idšg_wšdow
.
®lg©h”_sk
 = 
NULL
;

165 ià(!
š¶aû
) {

166 
®lg©h”_d©a
->
¤c_buf
 = src_buf;

168 
±r
 = 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
sbufs
 = 
	`PTR_OFFSET
ÕŒ, 
d¡_ebuf_sz
);

169 
±r
 = 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_rkeys
 = 
	`PTR_OFFSET
ÕŒ, 
sbufs_sz
);

170 
i
 = 0; i < 
‹am_size
; i++) {

171 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_rkeys
[
i
] = 
NULL
;

174 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
 = 
	`PTR_OFFSET
(
±r
, 
¤c_rkeys_sz
);

175 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
->
memh
 = 
NULL
;

177 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
 = 
NULL
;

180  
UCC_OK
;

181 
	}
}

183 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_®lg©h”_šfo_fš®ize
(

184 
ucc__uı_sk_t
 *
sw_sk
)

186 
ucs_¡©us_t
 
ucs_¡©us
 = 
UCS_OK
;

187 
ucc_ba£_‹am_t
 *
ba£_‹am
 = 
sw_sk
->
su³r
.
‹am
;

188 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
ba£_‹am
, ucc_tl_ucp_team_t);

189 
ucc_¿nk_t
 
‹am_size
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

190 *
»cvbuf
 = 
sw_sk
->
®Ìeduû_¦idšg_wšdow
.

191 
®lg©h”_sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
bufãr
;

192 
ucc__uı_®Ìeduû_sw_ho¡_®lg©h”_t
 *
®l_ho¡_®lg©h”
 = 
»cvbuf
;

193 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

194 
š¶aû
 = 
	`UCC_IS_INPLACE
(
	`TASK_ARGS
(
sw_sk
));

195 
ucc_¿nk_t
 
i
;

196 
uı_•_h
 
•
;

197 
uı_rkey_h
 
¤c_uÅacked
, 
d¡_uÅacked
;

199 
	`ucc_as£¹
(
‹am_size
 > 0);

201 
i
 = 0; i < 
‹am_size
; i++) {

202 
¡©us
 = 
	`ucc__uı_g‘_•
(
_‹am
, 
i
, &
•
);

203 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

204  
¡©us
;

207 
ucs_¡©us
 = 
	`uı_•_rkey_uÅack
(

208 
•
, 
®l_ho¡_®lg©h”
[
i
].
·cked_d¡_key
, &
d¡_uÅacked
);

209 ià(
UCS_OK
 !ğ
ucs_¡©us
) {

210 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "dst„key unpack failed");

211  
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

214 
sw_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
rbufs
[
i
] =

215 
®l_ho¡_®lg©h”
[
i
].
d¡_buf
;

216 
sw_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_rkeys
[
i
] = 
d¡_uÅacked
;

218 ià(!
š¶aû
) {

219 
ucs_¡©us
 = 
	`uı_•_rkey_uÅack
(

220 
•
, 
®l_ho¡_®lg©h”
[
i
].
·cked_¤c_key
, &
¤c_uÅacked
);

221 ià(
UCS_OK
 !ğ
ucs_¡©us
) {

222 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), "src„key unpack failed");

223  
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

226 
sw_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
sbufs
[
i
] =

227 
®l_ho¡_®lg©h”
[
i
].
¤c_buf
;

228 
sw_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_rkeys
[
i
] = 
¤c_uÅacked
;

230 
sw_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
sbufs
 =

231 
sw_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
rbufs
;

232 
sw_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_rkeys
 =

233 
sw_sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_rkeys
;

237  
¡©us
;

238 
	}
}

241 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_sk
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

243 
ucc_ba£_‹am_t
 *
‹am
 = 
cŞl_sk
->team;

244 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

245 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

246 
š¶aû
 = 
	`UCC_IS_INPLACE
(
cŞl_sk
->
b¬gs
.
¬gs
);

247 
ucc__uı_cÚ‹xt_t
 *
_ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
_‹am
);

249 ià(
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
) {

250 ià(!
š¶aû
) {

251 ià(
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
->
memh
 !ğ
NULL
) {

252 
	`uı_mem_unm­
(
_ùx
->
wÜk”
.
uı_cÚ‹xt
,

253 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
->
memh
);

254 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
¤c_ebuf
->
memh
 = 
NULL
;

258 ià(
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_ebuf
->
memh
 !ğ
NULL
) {

259 
	`uı_mem_unm­
(
_ùx
->
wÜk”
.
uı_cÚ‹xt
,

260 
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
->
d¡_ebuf
->
memh
);

262 
	`ucc_ä“
(
sk
->
®Ìeduû_¦idšg_wšdow
.
bufs
);

264 
	}
}

267 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_ä“_pe
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

269 
ucc_ba£_‹am_t
 *
‹am
 = 
cŞl_sk
->team;

270 
ucc__uı_‹am_t
 *
_‹am
 =

271 
	`ucc_d”ived_of
(
‹am
, 
ucc__uı_‹am_t
);

272 
ucc_¿nk_t
 
‹am_size
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

273 
ucc__uı_sk_t
 *
sk
 =

274 
	`ucc_d”ived_of
(
cŞl_sk
, 
ucc__uı_sk_t
);

275 
ucc__uı_®Ìeduû_sw_p–še
 *
pe
 =

276 
sk
->
®Ìeduû_¦idšg_wšdow
.
pe
;

277 
num_g‘_bufs
 =

278 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
®Ìeduû_¦idšg_wšdow_num_g‘_bufs
;

279 
i
;

281 ià(
num_g‘_bufs
 == 0) {

282 
num_g‘_bufs
 = 
‹am_size
;

285 ià(
pe
) {

286 
	`ucc_ä“
(
pe
->
accbuf
.
buf
);

287 
i
 = 0; i < 
num_g‘_bufs
; i++) {

288 
	`ucc_ä“
(
pe
->
g‘buf
[
i
].
buf
);

290 
	`ucc_ä“
(
pe
->
g‘buf
);

291 
	`ucc_ä“
(
pe
->
put_»que¡s
);

292 
	`ucc_ä“
(
pe
);

294 
	}
}

	@src/components/tl/ucp/allreduce/allreduce_sra_knomial.c

7 
	~"cÚfig.h
"

8 
	~"®Ìeduû.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"cŞl_·‰”ns/¤a_knomŸl.h
"

12 
	~"uts/ucc_m©h.h
"

13 
	~"uts/ucc_cŞl_uts.h
"

14 
	~"compÚ’ts/mc/ucc_mc.h
"

15 
	~"../»duû_sÿ‰”/»duû_sÿ‰”.h
"

16 
	~"../®lg©h”/®lg©h”.h
"

40 
ucc_¡©us_t


41 
	$ucc__uı_®Ìeduû_¤a_knomŸl_äag_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

43  
	`ucc_scheduË_¡¬t
(
sk
);

44 
	}
}

46 
ucc_¡©us_t


47 
	$ucc__uı_®Ìeduû_¤a_knomŸl_äag_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

49 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

50 
ucc_¡©us_t
 
¡©us
;

52 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

53 
	`ucc__uı_put_scheduË
(
scheduË
);

54  
¡©us
;

55 
	}
}

57 
ucc_¡©us_t


58 
	$ucc__uı_®Ìeduû_¤a_knomŸl_äag_£tup
(
ucc_scheduË_p–šed_t
 *
scheduË_p
,

59 
ucc_scheduË_t
 *
äag
, 
äag_num
)

61 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
scheduË_p
->
su³r
.su³r.
b¬gs
.args;

62 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

63 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

64 
n_äags
 = 
scheduË_p
->
su³r
.
n_sks
;

65 
size_t
 
äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
¬gs
->
d¡
.
šfo
.
couÁ
,

66 
n_äags
, 
äag_num
);

67 
size_t
 
off£t
 = 
	`ucc_bufãr_block_off£t
(
¬gs
->
d¡
.
šfo
.
couÁ
,

68 
n_äags
, 
äag_num
);

69 
ucc_cŞl_¬gs_t
 *
rgs
;

71 
rgs
 = &
äag
->
sks
[0]->
b¬gs
.
¬gs
;

72 
rgs
->
¤c
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
¬gs
->¤c.šfo.bufãr, 
off£t
 * 
dt_size
);

73 
rgs
->
¤c
.
šfo
.
couÁ
 = 
äag_couÁ
;

74 
rgs
->
d¡
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
¬gs
->d¡.šfo.bufãr, 
off£t
 * 
dt_size
);

75 
rgs
->
d¡
.
šfo
.
couÁ
 = 
äag_couÁ
;

77 
rgs
 = &
äag
->
sks
[1]->
b¬gs
.
¬gs
;

78 
rgs
->
¤c
.
šfo
.
bufãr
 = 
NULL
;

79 
rgs
->
¤c
.
šfo
.
couÁ
 = 0;

80 
rgs
->
d¡
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
¬gs
->d¡.šfo.bufãr, 
off£t
 * 
dt_size
);

81 
rgs
->
d¡
.
šfo
.
couÁ
 = 
äag_couÁ
;

83  
UCC_OK
;

84 
	}
}

86 
ucc_¡©us_t


87 
	$ucc__uı_®Ìeduû_¤a_knomŸl_äag_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

88 
ucc_scheduË_p–šed_t
 *
¥
,

89 
ucc_ba£_‹am_t
 *
‹am
,

90 
ucc_scheduË_t
 **
äag_p
)

92 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

93 
ucc_d©©y³_t
 
dty³
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

94 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.mem_type;

95 
ucc_ba£_cŞl_¬gs_t
 
¬gs
 = *
cŞl_¬gs
;

96 
ucc_m¿nge_ušt_t
 *
p
 = &
_‹am
->
cfg
.
®Ìeduû_¤a_kn_¿dix
;

97 
ucc_scheduË_t
 *
scheduË
;

98 
ucc_cŞl_sk_t
 *
sk
, *
rs_sk
;

99 
ucc_¡©us_t
 
¡©us
;

100 
ucc_kn_¿dix_t
 
¿dix
;

101 
size_t
 
couÁ
;

103 
¡©us
 = 
	`ucc__uı_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
,

104 (
ucc__uı_scheduË_t
 **)&
scheduË
);

105 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

106  
¡©us
;

109 ià(
cŞl_¬gs
->
mask
 & 
UCC_BASE_CARGS_MAX_FRAG_COUNT
) {

110 
couÁ
 = 
cŞl_¬gs
->
max_äag_couÁ
;

112 
couÁ
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.count;

115 
¿dix
 = 
	`ucc__uı_g‘_knomŸl_¿dix
(
_‹am
, 
couÁ
, 
dty³
, 
mem_ty³
, 
p
, 1);

117 
	`UCC_CHECK_GOTO
(

118 
	`ucc__uı_»duû_sÿ‰”_knomŸl_š™_r
(&
¬gs
, 
‹am
, &
sk
, 
¿dix
),

119 
out
, 
¡©us
);

121 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sk
), 
out
, 
¡©us
);

122 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(&
scheduË
->
su³r
, 
sk
,

123 
UCC_EVENT_SCHEDULE_STARTED
),

124 
out
, 
¡©us
);

125 
rs_sk
 = 
sk
;

129 
¬gs
.¬gs.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

130 
¬gs
.¬gs.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

131 
	`UCC_CHECK_GOTO
(

132 
	`ucc__uı_®lg©h”_knomŸl_š™_r
(&
¬gs
, 
‹am
, &
sk
, 
¿dix
), 
out
,

133 
¡©us
);

134 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sk
), 
out
, 
¡©us
);

135 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(
rs_sk
, 
sk
, 
UCC_EVENT_COMPLETED
),

136 
out
, 
¡©us
);

137 
scheduË
->
su³r
.
fš®ize
 = 
ucc__uı_®Ìeduû_¤a_knomŸl_äag_fš®ize
;

138 
scheduË
->
su³r
.
po¡
 = 
ucc__uı_®Ìeduû_¤a_knomŸl_äag_¡¬t
;

139 *
äag_p
 = 
scheduË
;

140  
UCC_OK
;

141 
out
:

142  
¡©us
;

143 
	}
}

145 
ucc_¡©us_t


146 
	$ucc__uı_®Ìeduû_¤a_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

148 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

149 
ucc_¡©us_t
 
¡©us
;

151 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
scheduË
, "ucp_allreduce_sra_kn_done", 0);

152 
¡©us
 = 
	`ucc_scheduË_p–šed_fš®ize
(
sk
);

153 
	`ucc__uı_put_scheduË
(
scheduË
);

154  
¡©us
;

155 
	}
}

157 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_¤a_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

159 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
sk
, "ucp_allreduce_sra_kn_start", 0);

160  
	`ucc_scheduË_p–šed_po¡
(
sk
);

161 
	}
}

164 
	$ucc__uı_®Ìeduû_¤a_knomŸl_g‘_p–še_·¿ms
(
ucc__uı_‹am_t
 *
‹am
,

165 
ucc_cŞl_¬gs_t
 *
¬gs
,

166 
ucc_p–še_·¿ms_t
 *
µ
)

168 
ucc__uı_lib_cÚfig_t
 *
cfg
 = &
‹am
->cfg;

170 ià(!
	`ucc_p–še_·¿ms_is_auto
(&
cfg
->
®Ìeduû_¤a_kn_p–še
)) {

171 *
µ
 = 
cfg
->
®Ìeduû_¤a_kn_p–še
;

175 ià((
¬gs
->
¤c
.
šfo
.
mem_ty³
 =ğ
UCC_MEMORY_TYPE_CUDA
) &&

176 (
	`UCC_IS_INPLACE
(*
¬gs
))) {

177 
ucc_mc_©Œ_t
 
mc_©Œ
;

178 
mc_©Œ
.
f›ld_mask
 = 
UCC_MC_ATTR_FIELD_FAST_ALLOC_SIZE
;

179 
	`ucc_mc_g‘_©Œ
(&
mc_©Œ
, 
UCC_MEMORY_TYPE_CUDA
);

180 
µ
->
th»shŞd
 = 
mc_©Œ
.
ç¡_®loc_size
;

181 
µ
->
n_äags
 = 2;

182 
µ
->
äag_size
 = 
mc_©Œ
.
ç¡_®loc_size
;

183 
µ
->
Üd”
 = 
UCC_PIPELINE_PARALLEL
;

184 
µ
->
pd•th
 = 2;

186 
µ
->
th»shŞd
 = 
SIZE_MAX
;

187 
µ
->
n_äags
 = 0;

188 
µ
->
äag_size
 = 0;

189 
µ
->
pd•th
 = 1;

190 
µ
->
Üd”
 = 
UCC_PIPELINE_PARALLEL
;

193 
	}
}

195 
ucc_¡©us_t


196 
	$ucc__uı_®Ìeduû_¤a_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

197 
ucc_ba£_‹am_t
 *
‹am
,

198 
ucc_cŞl_sk_t
 **
sk_h
)

200 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

201 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
cŞl_¬gs
->args;

202 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

203 
n_äags
, 
p–še_d•th
;

204 
ucc_scheduË_p–šed_t
 *
scheduË_p
;

205 
ucc_¡©us_t
 
¡
;

206 
ucc_ba£_cŞl_¬gs_t
 
b¬gs
;

207 
size_t
 
max_äag_couÁ
;

208 
ucc_p–še_·¿ms_t
 
p–še_·¿ms
;

210 
¡
 = 
	`ucc__uı_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
,

211 (
ucc__uı_scheduË_t
 **)&
scheduË_p
);

212 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡
)) {

213  
¡
;

216 
b¬gs
 = *
cŞl_¬gs
;

217 
max_äag_couÁ
 = (
b¬gs
.
mask
 & 
UCC_BASE_CARGS_MAX_FRAG_COUNT
) ?

218 
b¬gs
.
max_äag_couÁ
: 
¬gs
->
d¡
.
šfo
.
couÁ
;

219 
	`ucc__uı_®Ìeduû_¤a_knomŸl_g‘_p–še_·¿ms
(
_‹am
, 
¬gs
,

220 &
p–še_·¿ms
);

221 
	`ucc_p–še_näags_pd•th
(&
p–še_·¿ms
, 
max_äag_couÁ
 * 
dt_size
,

222 &
n_äags
, &
p–še_d•th
);

223 ià(
n_äags
 > 1) {

224 
b¬gs
.
mask
 |ğ
UCC_BASE_CARGS_MAX_FRAG_COUNT
;

225 
b¬gs
.
max_äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(max_äag_couÁ, 
n_äags
, 0);

228 
¡
 = 
	`ucc_scheduË_p–šed_š™
(&
b¬gs
, 
‹am
,

229 
ucc__uı_®Ìeduû_¤a_knomŸl_äag_š™
,

230 
ucc__uı_®Ìeduû_¤a_knomŸl_äag_£tup
,

231 
p–še_d•th
, 
n_äags
,

232 
p–še_·¿ms
.
Üd”
, 
scheduË_p
);

233 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡
)) {

234 
	`_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "failedo init…ipelined schedule");

235 
	`ucc__uı_put_scheduË
(&
scheduË_p
->
su³r
);

236  
¡
;

239 
scheduË_p
->
su³r
.su³r.
fš®ize
 = 
ucc__uı_®Ìeduû_¤a_knomŸl_fš®ize
;

240 
scheduË_p
->
su³r
.su³r.
po¡
 = 
ucc__uı_®Ìeduû_¤a_knomŸl_¡¬t
;

241 *
sk_h
 = &
scheduË_p
->
su³r
.super;

242  
UCC_OK
;

243 
	}
}

	@src/components/tl/ucp/alltoall/alltoall.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®ÉßÎ.h
"

11 
	#ALLTOALL_MAX_PATTERN_SIZE
 ((
UCC_TL_UCP_ALLTOALL_DEFAULT_ALG_SELECT_STR_PATTERN
è+ 32)

	)

12 
	#ALLTOALL_DEFAULT_ALG_SWITCH
 129

	)

14 
ucc_¡©us_t
 
ucc__uı_®ÉßÎ_·œwi£_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

15 
ucc__uı_®ÉßÎ_·œwi£_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

17 
ucc_¡©us_t
 
ucc__uı_®ÉßÎ_Úesided_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

18 
ucc__uı_®ÉßÎ_Úesided_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

20 * 
	$ucc__uı_®ÉßÎ_scÜe_¡r_g‘
(
ucc__uı_‹am_t
 *
‹am
)

22 
max_size
 = 
ALLTOALL_MAX_PATTERN_SIZE
;

23 *
¡r
;

25 
¡r
 = 
	`ucc_m®loc
(
max_size
 * ());

26 
	`ucc_¢´štf_§ã
(
¡r
, 
max_size
,

27 
UCC_TL_UCP_ALLTOALL_DEFAULT_ALG_SELECT_STR_PATTERN
,

28 
ALLTOALL_DEFAULT_ALG_SWITCH
 * 
	`UCC_TL_TEAM_SIZE
(
‹am
));

29  
¡r
;

30 
	}
}

32 
ucc_ba£_cŞl_®g_šfo_t


33 
	gucc__uı_®ÉßÎ_®gs
[
UCC_TL_UCP_ALLTOALL_ALG_LAST
 + 1] = {

34 [
UCC_TL_UCP_ALLTOALL_ALG_PAIRWISE
] =

35 {.
id
 = 
UCC_TL_UCP_ALLTOALL_ALG_PAIRWISE
,

36 .
	gÇme
 = "pairwise",

37 .
	gdesc
 = "pairwisewo-sided implementation"},

38 [
UCC_TL_UCP_ALLTOALL_ALG_BRUCK
] =

39 {.
id
 = 
UCC_TL_UCP_ALLTOALL_ALG_BRUCK
,

40 .
	gÇme
 = "bruck",

41 .
	gdesc
 = "Bruck‡lltoall"},

42 [
UCC_TL_UCP_ALLTOALL_ALG_ONESIDED
] =

43 {.
id
 = 
UCC_TL_UCP_ALLTOALL_ALG_ONESIDED
,

44 .
	gÇme
 = "onesided",

45 .
	gdesc
 = "naive,†inear one-sided implementation"},

46 [
UCC_TL_UCP_ALLTOALL_ALG_LAST
] = {.
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

48 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_š™
(
ucc__uı_sk_t
 *
sk
)

50 
ucc_¡©us_t
 
¡©us
;

52 
	`ALLTOALL_TASK_CHECK
(
	`TASK_ARGS
(
sk
), 
	`TASK_TEAM
(task));

53 
¡©us
 = 
	`ucc__uı_®ÉßÎ_·œwi£_š™_commÚ
(
sk
);

54 
out
:

55  
¡©us
;

56 
	}
}

58 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_·œwi£_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

59 
ucc_ba£_‹am_t
 *
‹am
,

60 
ucc_cŞl_sk_t
 **
sk_h
)

62 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

63 
ucc__uı_sk_t
 *
sk
;

64 
ucc_¡©us_t
 
¡©us
;

66 
	`ALLTOALL_TASK_CHECK
(
cŞl_¬gs
->
¬gs
, 
_‹am
);

67 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

68 *
sk_h
 = &
sk
->
su³r
;

69 
¡©us
 = 
	`ucc__uı_®ÉßÎ_·œwi£_š™_commÚ
(
sk
);

70 
out
:

71  
¡©us
;

72 
	}
}

74 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_Úesided_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

75 
ucc_ba£_‹am_t
 *
‹am
,

76 
ucc_cŞl_sk_t
 **
sk_h
)

78 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

79 
ucc__uı_sk_t
 *
sk
;

80 
ucc_¡©us_t
 
¡©us
;

82 
	`ALLTOALL_TASK_CHECK
(
cŞl_¬gs
->
¬gs
, 
_‹am
);

84 ià(!(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
)) {

85 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

87 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

88 
out
;

90 ià(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) {

91 ià(!(
cŞl_¬gs
->
¬gs
.
æags
 & 
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
)) {

92 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

94 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

95 
out
;

98 ià(!(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_MEM_MAP_SRC_MEMH
)) {

99 
cŞl_¬gs
->
¬gs
.
¤c_memh
.
glob®_memh
 = 
NULL
;

101 ià(!(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_MEM_MAP_DST_MEMH
)) {

102 
cŞl_¬gs
->
¬gs
.
d¡_memh
.
glob®_memh
 = 
NULL
;

104 ià(!(
cŞl_¬gs
->
¬gs
.
æags
 & 
UCC_COLL_ARGS_FLAG_DST_MEMH_GLOBAL
)) {

105 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

107 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

108 
out
;

112 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

113 *
sk_h
 = &
sk
->
su³r
;

114 
sk
->
su³r
.
po¡
 = 
ucc__uı_®ÉßÎ_Úesided_¡¬t
;

115 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®ÉßÎ_Úesided_´og»ss
;

116 
¡©us
 = 
UCC_OK
;

117 
out
:

118  
¡©us
;

119 
	}
}

	@src/components/tl/ucp/alltoall/alltoall.h

7 #iâdeà
ALLTOALL_H_


8 
	#ALLTOALL_H_


	)

10 
	~"../_uı.h
"

11 
	~"../_uı_cŞl.h
"

14 
	mUCC_TL_UCP_ALLTOALL_ALG_PAIRWISE
,

15 
	mUCC_TL_UCP_ALLTOALL_ALG_BRUCK
,

16 
	mUCC_TL_UCP_ALLTOALL_ALG_ONESIDED
,

17 
	mUCC_TL_UCP_ALLTOALL_ALG_LAST


20 
ucc_ba£_cŞl_®g_šfo_t


21 
ucc__uı_®ÉßÎ_®gs
[
UCC_TL_UCP_ALLTOALL_ALG_LAST
 + 1];

23 
	#UCC_TL_UCP_ALLTOALL_DEFAULT_ALG_SELECT_STR_PATTERN
 \

24 "®ÉßÎ:ho¡:0-%d:@bruck"

	)

26 * 
ucc__uı_®ÉßÎ_scÜe_¡r_g‘
(
ucc__uı_‹am_t
 *
‹am
);

28 
ucc_¡©us_t
 
ucc__uı_®ÉßÎ_š™
(
ucc__uı_sk_t
 *
sk
);

30 
ucc_¡©us_t
 
ucc__uı_®ÉßÎ_·œwi£_š™_commÚ
(
ucc__uı_sk_t
 *
sk
);

32 
ucc_¡©us_t
 
ucc__uı_®ÉßÎ_·œwi£_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

33 
ucc_ba£_‹am_t
 *
‹am
,

34 
ucc_cŞl_sk_t
 **
sk_h
);

36 
ucc_¡©us_t
 
ucc__uı_®ÉßÎ_bruck_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

37 
ucc_ba£_‹am_t
 *
‹am
,

38 
ucc_cŞl_sk_t
 **
sk_h
);

41 
ucc_¡©us_t
 
ucc__uı_®ÉßÎ_Úesided_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

42 
ucc_ba£_‹am_t
 *
‹am
,

43 
ucc_cŞl_sk_t
 **
sk_h
);

45 
	#ALLTOALL_CHECK_INPLACE
(
_¬gs
, 
_‹am
) \

47 ià(
	`UCC_IS_INPLACE
(
_¬gs
)) { \

48 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), \

50 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
; \

51 
out
; \

53 } 0)

	)

55 
	#ALLTOALL_CHECK_USERDEFINED_DT
(
_¬gs
, 
_‹am
 ) \

57 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&(
_¬gs
), 
UCC_RANK_INVALID
)) { \

58 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), \

60 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
; \

61 
out
; \

63 } 0)

	)

65 
	#ALLTOALL_TASK_CHECK
(
_¬gs
, 
_‹am
) \

66 
	`ALLTOALL_CHECK_INPLACE
((
_¬gs
), (
_‹am
)); \

67 
	`ALLTOALL_CHECK_USERDEFINED_DT
((
_¬gs
), (
_‹am
));

	)

69 
šlše
 
	$ucc__uı_®ÉßÎ_®g_äom_¡r
(cÚ¡ *
¡r
)

71 
i
;

72 
i
 = 0; i < 
UCC_TL_UCP_ALLTOALL_ALG_LAST
; i++) {

73 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__uı_®ÉßÎ_®gs
[
i
].
Çme
)) {

77  
i
;

78 
	}
}

	@src/components/tl/ucp/alltoall/alltoall_bruck.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®ÉßÎ.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"compÚ’ts/mc/ucc_mc.h
"

12 
	~"cŞl_·‰”ns/bruck_®ÉßÎ.h
"

14 
	#RADIX
 2

	)

15 
	#SAVE_STATE
(
_pha£
) \

17 
sk
->
®ÉßÎ_bruck
.
pha£
 = 
_pha£
; \

18 } 0)

	)

21 
	mPHASE_MERGE
,

22 
	mPHASE_SENDRECV
,

23 
	mPHASE_BCOPY


26 
šlše
 
	$msb_pos_fÜ_Ëv–
(
Áhb™
, 
ucc_¿nk_t
 
numb”
)

29 
msb_£t
 = -1;

30 
i
;

32 
i
 = 0; i < 
Áhb™
 - 1; i++) {

33 ià(1 & 
numb”
 >> 
i
) {

34 
msb_£t
 = 
i
;

38  
msb_£t
;

39 
	}
}

41 
šlše
 
	$fšd_£g_šdex
(
ucc_¿nk_t
 
£g_šdex
, 
Ëv–
,

42 
n£gs_³r_rblock
)

44 
block
, 
block£g
;

46 ià(0 =ğ
£g_šdex
) {

50 
block
 = 
	`msb_pos_fÜ_Ëv–
(
Ëv–
, 
£g_šdex
);

52 ià(
block
 < 0) {

57 
block£g
 = ((
£g_šdex
 >> (
block
 + 1)) << block) |

58 (
£g_šdex
 & 
	`UCC_MASK
(
block
));

59  
block
 * 
n£gs_³r_rblock
 + 
block£g
;

60 
	}
}

62 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_bruck_backw¬d_rÙ©iÚ
(*
d¡
,

63 *
¤c
,

64 
ucc_¿nk_t
 
Œªk
,

65 
ucc_¿nk_t
 
tsize
,

66 
size_t
 
£g_size
)

68 
ucc_¡©us_t
 
¡
;

69 
ucc_¿nk_t
 
šdex
, 
Ëv–
, 
n£gs_³r_rblock
;

70 
size_t
 
¢d_off£t
;

71 
£nd_bufãr_šdex
;

73 
Ëv–
 = 
	`lognum
(
tsize
);

74 
n£gs_³r_rblock
 = 
tsize
 / 2;

75 
šdex
 = 1; index < 
tsize
; index++) {

76 
£nd_bufãr_šdex
 = 
	`fšd_£g_šdex
(
šdex
, 
Ëv–
 + 1, 
n£gs_³r_rblock
);

77 
	`ucc_as£¹
(
£nd_bufãr_šdex
 >= 0);

78 
¢d_off£t
 = 
£nd_bufãr_šdex
 * 
£g_size
;

79 
¡
 = 
	`ucc_mc_memıy
(
	`PTR_OFFSET
(
d¡
, 
£g_size
 *

80 ((
Œªk
 - 
šdex
 + 
tsize
) %size)),

81 
	`PTR_OFFSET
(
¤c
, 
¢d_off£t
), 
£g_size
,

82 
UCC_MEMORY_TYPE_HOST
, UCC_MEMORY_TYPE_HOST);

83 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

84  
¡
;

88  
UCC_OK
;

89 
	}
}

91 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_bruck_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

93 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

94 
ucc_¡©us_t
 
¡
, 
glob®_¡
;

96 
glob®_¡
 = 
	`ucc_mc_ä“
(
sk
->
®ÉßÎ_bruck
.
sü©ch_mc_h—d”
);

97 ià(
	`ucc_uÆik–y
(
glob®_¡
 !ğ
UCC_OK
)) {

98 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo free scratch buffer");

101 
¡
 = 
	`ucc__uı_cŞl_fš®ize
(&
sk
->
su³r
);

102 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

103 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failed finalize collective");

104 
glob®_¡
 = 
¡
;

106  
glob®_¡
;

107 
	}
}

109 
	$ucc__uı_®ÉßÎ_bruck_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

111 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

112 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

113 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

114 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

115 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

116 *
sü©ch
 = 
sk
->
®ÉßÎ_bruck
.
sü©ch_mc_h—d”
->
addr
;

117 *
m”gebuf
 = 
sk
->
®ÉßÎ_bruck
.
d¡
;

118 cÚ¡ 
ucc_¿nk_t
 
Äecv_£gs
 = 
tsize
 / 2;

119 cÚ¡ 
size_t
 
£g_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
) *

120 
¬gs
->
¤c
.
šfo
.
couÁ
 / 
tsize
;

121 
ucc_memÜy_ty³_t
 
smty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

122 
ucc_memÜy_ty³_t
 
dmty³
 = 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

123 
ucc_¿nk_t
 
£ndto
, 
»cväom
, 
¡•
, 
šdex
;

124 *
d©a
;

125 
ucc_¿nk_t
 
Ëv–
, 
¢d_couÁ
;

126 
£nd_bufãr_šdex
;

127 
ucc_¡©us_t
 
¡©us
;

128 
ucc_“_executÜ_t
 *
exec
;

129 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

131 
	`EXEC_TASK_TEST
(
sk
->
®ÉßÎ_bruck
.
pha£
,

133 
sk
->
®ÉßÎ_bruck
.
‘ask
);

134 
sk
->
®ÉßÎ_bruck
.
pha£
) {

135 
PHASE_SENDRECV
:

136 
ALLTOALL_BRUCK_PHASE_SENDRECV
;

137 
PHASE_BCOPY
:

138 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

139 
out
;

142 
¡•
 = 1 << (
sk
->
®ÉßÎ_bruck
.
™”©iÚ
 - 1);

143 
¡•
 < 
tsize
) {

144 
Ëv–
 = 
sk
->
®ÉßÎ_bruck
.
™”©iÚ
 - 1;

145 
£ndto
 = 
	`g‘_bruck_£nd_³”
(
Œªk
, 
tsize
, 
¡•
, 1);

146 
»cväom
 = 
	`g‘_bruck_»cv_³”
(
Œªk
, 
tsize
, 
¡•
, 1);

148 
¢d_couÁ
 = 0;

149 
šdex
 = 
	`g‘_bruck_¡•_¡¬t
(
¡•
, 1);

150 
šdex
 <ğ
	`g‘_bruck_¡•_fšish
(
tsize
 - 1, 
RADIX
, 1, 
¡•
);

151 
šdex
 = 
	`GET_NEXT_BRUCK_NUM
(šdex, 
RADIX
, 
¡•
)) {

152 
£nd_bufãr_šdex
 = 
	`fšd_£g_šdex
(
šdex
, 
Ëv–
 + 1, 
Äecv_£gs
);

153 ià(
£nd_bufãr_šdex
 == -1) {

154 
d©a
 = 
	`PTR_OFFSET
(
sk
->
®ÉßÎ_bruck
.
¤c
,

155 ((
šdex
 + 
Œªk
è% 
tsize
è* 
£g_size
);

157 
d©a
 = 
	`PTR_OFFSET
(
sü©ch
, 
£nd_bufãr_šdex
 * 
£g_size
);

159 
¡©us
 = 
	`ucc_mc_memıy
(
	`PTR_OFFSET
(
m”gebuf
, 
£g_size
 * 
¢d_couÁ
),

160 
d©a
, 
£g_size
, 
UCC_MEMORY_TYPE_HOST
,

161 
UCC_MEMORY_TYPE_HOST
);

162 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

163 
sk
->
su³r
.
¡©us
 = status;

166 
¢d_couÁ
++;

168 
d©a
 = 
	`PTR_OFFSET
(
sü©ch
, 
Ëv–
 * 
Äecv_£gs
 * 
£g_size
);

169 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
m”gebuf
, 
¢d_couÁ
 * 
£g_size
,

170 
UCC_MEMORY_TYPE_HOST
, 
£ndto
, 
‹am
,

171 
sk
),

172 
sk
, 
out
);

173 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
d©a
, 
¢d_couÁ
 * 
£g_size
,

174 
UCC_MEMORY_TYPE_HOST
, 
»cväom
, 
‹am
,

175 
sk
),

176 
sk
, 
out
);

177 
ALLTOALL_BRUCK_PHASE_SENDRECV
:

178 ià(
	`ucc__uı_‹¡
(
sk
è=ğ
UCC_INPROGRESS
) {

179 
	`SAVE_STATE
(
PHASE_SENDRECV
);

182 
sk
->
®ÉßÎ_bruck
.
™”©iÚ
++;

183 
¡•
 = 1 << (
sk
->
®ÉßÎ_bruck
.
™”©iÚ
 - 1);

186 
¡©us
 = 
	`ucc_mc_memıy
(
	`PTR_OFFSET
(
sk
->
®ÉßÎ_bruck
.
d¡
, 
Œªk
 * 
£g_size
),

187 
	`PTR_OFFSET
(
sk
->
®ÉßÎ_bruck
.
¤c
, 
Œªk
 * 
£g_size
),

188 
£g_size
, 
UCC_MEMORY_TYPE_HOST
, UCC_MEMORY_TYPE_HOST);

189 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

190 
sk
->
su³r
.
¡©us
 = status;

193 
¡©us
 = 
	`ucc__uı_®ÉßÎ_bruck_backw¬d_rÙ©iÚ
(
m”gebuf
, 
sü©ch
,

194 
Œªk
, 
tsize
,

195 
£g_size
);

196 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

197 
sk
->
su³r
.
¡©us
 = status;

201 ià(
smty³
 !ğ
UCC_MEMORY_TYPE_HOST
 || 
dmty³
 != UCC_MEMORY_TYPE_HOST) {

202 
sk
->
®ÉßÎ_bruck
.
pha£
 = 
PHASE_BCOPY
;

203 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

204 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

205 
sk
->
su³r
.
¡©us
 = status;

209 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

210 
—rgs
.
cİy
.
¤c
 = 
m”gebuf
;

211 
—rgs
.
cİy
.
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

212 
—rgs
.
cİy
.
Ën
 = 
£g_size
 * 
tsize
;

213 
—rgs
.
æags
 = 0;

214 
¡©us
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
,

215 &
sk
->
®ÉßÎ_bruck
.
‘ask
);

216 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

217 
sk
->
su³r
.
¡©us
 = status;

220 
	`EXEC_TASK_TEST
(
PHASE_BCOPY
, "failedo copy datao user buffer",

221 
sk
->
®ÉßÎ_bruck
.
‘ask
);

224 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

225 
out
:

227 
	}
}

229 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_bruck_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

231 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

232 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

233 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

234 
size_t
 
size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
) *

235 
¬gs
->
¤c
.
šfo
.
couÁ
;

236 
ucc_“_executÜ_t
 *
exec
;

237 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

238 
ucc_¡©us_t
 
¡©us
;

240 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

241 
sk
->
®ÉßÎ_bruck
.
™”©iÚ
 = 1;

242 
sk
->
®ÉßÎ_bruck
.
pha£
 = 
PHASE_MERGE
;

243 
sk
->
®ÉßÎ_bruck
.
‘ask
 = 
NULL
;

245 ià((
¬gs
->
¤c
.
šfo
.
mem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
) ||

246 (
¬gs
->
d¡
.
šfo
.
mem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
)) {

247 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &
exec
);

248 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

249  
¡©us
;

252 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

253 
—rgs
.
cİy
.
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

254 
—rgs
.
cİy
.
d¡
 = 
sk
->
®ÉßÎ_bruck
.
¤c
;

255 
—rgs
.
cİy
.
Ën
 = 
size
;

256 
—rgs
.
æags
 = 0;

257 
¡©us
 = 
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
,

258 &
sk
->
®ÉßÎ_bruck
.
‘ask
);

259 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

260  
¡©us
;

264  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

265 
	}
}

267 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_bruck_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

268 
ucc_ba£_‹am_t
 *
‹am
,

269 
ucc_cŞl_sk_t
 **
sk_h
)

271 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

272 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

273 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
cŞl_¬gs
->args;

274 
size_t
 
ssize
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
) *

275 
¬gs
->
¤c
.
šfo
.
couÁ
;

276 
size_t
 
£g_size
 = 
ssize
 / 
tsize
;

277 
is_bcİy
 = 0;

278 
size_t
 
sü©ch_size
;

279 
ucc__uı_sk_t
 *
sk
;

280 
ucc_¡©us_t
 
¡©us
;

282 
	`ALLTOALL_TASK_CHECK
(
cŞl_¬gs
->
¬gs
, 
_‹am
);

283 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

284 
sk
->
su³r
.
po¡
 = 
ucc__uı_®ÉßÎ_bruck_¡¬t
;

285 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®ÉßÎ_bruck_´og»ss
;

286 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_®ÉßÎ_bruck_fš®ize
;

287 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

289 
sü©ch_size
 = 
	`lognum
(
tsize
è* 
	`ucc_div_round_up
Ñsize, 2è* 
£g_size
;

290 ià((
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
mem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
) ||

291 (
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
mem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
)) {

292 
is_bcİy
 = 1;

293 
sü©ch_size
 +ğ2 * 
ssize
;

296 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
®ÉßÎ_bruck
.
sü©ch_mc_h—d”
,

297 
sü©ch_size
, 
UCC_MEMORY_TYPE_HOST
);

298 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

299 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo‡llocate scratch buffer");

300 
	`ucc__uı_cŞl_fš®ize
(&
sk
->
su³r
);

301  
¡©us
;

304 ià(
is_bcİy
) {

305 
sk
->
®ÉßÎ_bruck
.
¤c
 =

306 
	`PTR_OFFSET
(
sk
->
®ÉßÎ_bruck
.
sü©ch_mc_h—d”
->
addr
,

307 
	`lognum
(
tsize
è* 
	`ucc_div_round_up
Ñsize, 2è* 
£g_size
);

308 
sk
->
®ÉßÎ_bruck
.
d¡
 =

309 
	`PTR_OFFSET
(
sk
->
®ÉßÎ_bruck
.
¤c
, 
ssize
);

311 
sk
->
®ÉßÎ_bruck
.
¤c
 = 
¬gs
->¤c.
šfo
.
bufãr
;

312 
sk
->
®ÉßÎ_bruck
.
d¡
 = 
¬gs
->d¡.
šfo
.
bufãr
;

315 *
sk_h
 = &
sk
->
su³r
;

316  
UCC_OK
;

318 
out
:

319  
¡©us
;

320 
	}
}

	@src/components/tl/ucp/alltoall/alltoall_onesided.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®ÉßÎ.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"_uı_£nd»cv.h
"

14 
ucc__uı_®ÉßÎ_Úesided_´og»ss
(
ucc_cŞl_sk_t
 *
ùask
);

16 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_Úesided_¡¬t
(
ucc_cŞl_sk_t
 *
ùask
)

18 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
ùask
, ucc_tl_ucp_task_t);

19 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

20 
±rdiff_t
 
¤c
 = (±rdiff_t)
	`TASK_ARGS
(
sk
).¤c.
šfo
.
bufãr
;

21 
±rdiff_t
 
de¡
 = (±rdiff_t)
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

22 
size_t
 
ÃËms
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
couÁ
;

23 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

24 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

25 
ucc_¿nk_t
 
¡¬t
 = (
g¿nk
 + 1è% 
gsize
;

26 *
pSync
 = 
	`TASK_ARGS
(
sk
).
glob®_wÜk_bufãr
;

27 
ucc_mem_m­_mem_h
 
¤c_memh
 = 
	`TASK_ARGS
(
sk
).¤c_memh.
loÿl_memh
;

28 
ucc_mem_m­_mem_h
 *
d¡_memh
 = 
	`TASK_ARGS
(
sk
).d¡_memh.
glob®_memh
;

29 
ucc_¿nk_t
 
³”
;

31 ià(
	`TASK_ARGS
(
sk
).
æags
 & 
UCC_COLL_ARGS_FLAG_SRC_MEMH_GLOBAL
) {

32 
¤c_memh
 = 
	`TASK_ARGS
(
sk
).¤c_memh.
glob®_memh
[
g¿nk
];

35 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

37 
ÃËms
 = (ÃËm / 
gsize
è* 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
);

38 
de¡
 = de¡ + 
g¿nk
 * 
ÃËms
;

39 
³”
 = 
¡¬t
; 
sk
->
Úesided
.
put_po¡ed
 < 
gsize
;…eer = (peer + 1) % gsize) {

40 
	`UCPCHECK_GOTO
(
	`ucc__uı_put_nb
(

41 (*)(
¤c
 + 
³”
 * 
ÃËms
), (*)
de¡
,‚elems,

42 
³”
, 
¤c_memh
, 
d¡_memh
, 
‹am
, 
sk
),

43 
sk
, 
out
);

44 
	`UCPCHECK_GOTO
(
	`ucc__uı_©omic_šc
(
pSync
, 
³”
, 
d¡_memh
, 
‹am
),

45 
sk
, 
out
);

47  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

48 
out
:

49  
sk
->
su³r
.
¡©us
;

50 
	}
}

52 
	$ucc__uı_®ÉßÎ_Úesided_´og»ss
(
ucc_cŞl_sk_t
 *
ùask
)

54 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
ùask
, ucc_tl_ucp_task_t);

55 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

56 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

57 * 
pSync
 = 
	`TASK_ARGS
(
sk
).
glob®_wÜk_bufãr
;

59 ià(
	`ucc__uı_‹¡_Úesided
(
sk
, 
gsize
è=ğ
UCC_INPROGRESS
) {

63 
pSync
[0] = 0;

64 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

65 
	}
}

	@src/components/tl/ucp/alltoall/alltoall_pairwise.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®ÉßÎ.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"_uı_£nd»cv.h
"

15 
	#MSG_MEDIUM
 66000

	)

16 
	#NP_THRESH
 32

	)

18 
šlše
 
ucc_¿nk_t
 
	$g‘_»cv_³”
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
,

19 
ucc_¿nk_t
 
¡•
)

21  (
¿nk
 + 
¡•
è% 
size
;

22 
	}
}

24 
šlše
 
ucc_¿nk_t
 
	$g‘_£nd_³”
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
,

25 
ucc_¿nk_t
 
¡•
)

27  (
¿nk
 - 
¡•
 + 
size
) % size;

28 
	}
}

30 
ucc_¿nk_t
 
	$g‘_num_po¡s
(cÚ¡ 
ucc__uı_‹am_t
 *
‹am
,

31 cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
)

33 
po¡s
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
®ÉßÎ_·œwi£_num_po¡s
;

34 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

35 
size_t
 
d©a_size
;

37 
d©a_size
 = (
size_t
)
¬gs
->
¤c
.
šfo
.
couÁ
 *

38 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

39 ià(
po¡s
 =ğ
UCC_ULUNITS_AUTO
) {

40 ià((
d©a_size
 > 
MSG_MEDIUM
è&& (
tsize
 > 
NP_THRESH
)) {

42 
po¡s
 = 1;

45 
po¡s
 = 0;

49 
po¡s
 = (po¡ > 
tsize
 ||…osts == 0) ?size:…osts;

50  
po¡s
;

51 
	}
}

53 
	$ucc__uı_®ÉßÎ_·œwi£_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

55 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

56 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

57 
±rdiff_t
 
sbuf
 = (±rdiff_t)
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
;

58 
±rdiff_t
 
rbuf
 = (±rdiff_t)
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
;

59 
ucc_memÜy_ty³_t
 
smem
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
;

60 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
;

61 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

62 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

63 
pŞls
 = 0;

64 
ucc_¿nk_t
 
³”
, 
Äeqs
;

65 
size_t
 
d©a_size
;

67 
Äeqs
 = 
	`g‘_num_po¡s
(
‹am
, &
	`TASK_ARGS
(
sk
));

68 
d©a_size
 = (
size_t
)(
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
couÁ
 / 
gsize
) *

69 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
);

70 (
sk
->
gged
.
£nd_po¡ed
 < 
gsize
 ||

71 
sk
->
gged
.
»cv_po¡ed
 < 
gsize
) &&

72 (
pŞls
++ < 
sk
->
n_pŞls
)) {

73 
	`uı_wÜk”_´og»ss
(
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
wÜk”
.
uı_wÜk”
);

74 (
sk
->
gged
.
»cv_po¡ed
 < 
gsize
) &&

75 ((
sk
->
gged
.
»cv_po¡ed
 -ask->gged.
»cv_com¶‘ed
) <

76 
Äeqs
)) {

77 
³”
 = 
	`g‘_»cv_³”
(
g¿nk
, 
gsize
, 
sk
->
gged
.
»cv_po¡ed
);

78 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
((*)(
rbuf
 + 
³”
 * 
d©a_size
),

79 
d©a_size
, 
rmem
, 
³”
, 
‹am
, 
sk
),

80 
sk
, 
out
);

81 
pŞls
 = 0;

83 (
sk
->
gged
.
£nd_po¡ed
 < 
gsize
) &&

84 ((
sk
->
gged
.
£nd_po¡ed
 -ask->gged.
£nd_com¶‘ed
) <

85 
Äeqs
)) {

86 
³”
 = 
	`g‘_£nd_³”
(
g¿nk
, 
gsize
, 
sk
->
gged
.
£nd_po¡ed
);

87 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
((*)(
sbuf
 + 
³”
 * 
d©a_size
),

88 
d©a_size
, 
smem
, 
³”
, 
‹am
, 
sk
),

89 
sk
, 
out
);

90 
pŞls
 = 0;

93 ià((
sk
->
gged
.
£nd_po¡ed
 < 
gsize
) ||

94 (
sk
->
gged
.
»cv_po¡ed
 < 
gsize
)) {

98 
sk
->
su³r
.
¡©us
 = 
	`ucc__uı_‹¡
(task);

99 
out
:

100 ià(
sk
->
su³r
.
¡©us
 !ğ
UCC_INPROGRESS
) {

101 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
,

104 
	}
}

106 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_·œwi£_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

108 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

109 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

111 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_alltoall_pairwise_start", 0);

112 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

114  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

115 
	}
}

117 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎ_·œwi£_š™_commÚ
(
ucc__uı_sk_t
 *
sk
)

119 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

120 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

121 
size_t
 
d©a_size
;

123 
sk
->
su³r
.
po¡
 = 
ucc__uı_®ÉßÎ_·œwi£_¡¬t
;

124 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®ÉßÎ_·œwi£_´og»ss
;

126 
sk
->
n_pŞls
 = 
	`ucc_max
(1,ask->n_polls);

127 ià(
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
cfg
.
´e_»g_mem
) {

128 
d©a_size
 =

129 (
size_t
)
¬gs
->
¤c
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->¤c.šfo.
d©©y³
);

130 
	`ucc__uı_´e_»gi¡”_mem
(
‹am
, 
¬gs
->
¤c
.
šfo
.
bufãr
, 
d©a_size
,

131 
¬gs
->
¤c
.
šfo
.
mem_ty³
);

132 
	`ucc__uı_´e_»gi¡”_mem
(
‹am
, 
¬gs
->
d¡
.
šfo
.
bufãr
, 
d©a_size
,

133 
¬gs
->
d¡
.
šfo
.
mem_ty³
);

136  
UCC_OK
;

137 
	}
}

	@src/components/tl/ucp/alltoallv/alltoallv.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®ÉßÎv.h
"

11 
ucc_ba£_cŞl_®g_šfo_t


12 
	gucc__uı_®ÉßÎv_®gs
[
UCC_TL_UCP_ALLTOALLV_ALG_LAST
 + 1] = {

13 [
UCC_TL_UCP_ALLTOALLV_ALG_PAIRWISE
] =

14 {.
id
 = 
UCC_TL_UCP_ALLTOALLV_ALG_PAIRWISE
,

15 .
	gÇme
 = "pairwise",

16 .
	gdesc
 = "O(N)…airwiseƒxchange with‡djustable‚umber "

18 [
UCC_TL_UCP_ALLTOALLV_ALG_HYBRID
] =

19 {.
id
 = 
UCC_TL_UCP_ALLTOALLV_ALG_HYBRID
,

20 .
	gÇme
 = "hybrid",

21 .
	gdesc
 = "hybrid‡2av‡lg "},

22 [
UCC_TL_UCP_ALLTOALLV_ALG_ONESIDED
] =

23 {.
id
 = 
UCC_TL_UCP_ALLTOALLV_ALG_ONESIDED
,

24 .
	gÇme
 = "onesided",

25 .
	gdesc
 = "O(N) onesided‡lltoallv"},

26 [
UCC_TL_UCP_ALLTOALLV_ALG_LAST
] = {

27 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

29 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎv_š™
(
ucc__uı_sk_t
 *
sk
)

31 
ucc_¡©us_t
 
¡©us
;

33 
	`ALLTOALLV_TASK_CHECK
(
	`TASK_ARGS
(
sk
), 
	`TASK_TEAM
(task));

34 
¡©us
 = 
	`ucc__uı_®ÉßÎv_·œwi£_š™_commÚ
(
sk
);

35 
out
:

36  
¡©us
;

37 
	}
}

39 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎv_·œwi£_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

40 
ucc_ba£_‹am_t
 *
‹am
,

41 
ucc_cŞl_sk_t
 **
sk_h
)

43 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

44 
ucc__uı_sk_t
 *
sk
;

45 
ucc_¡©us_t
 
¡©us
;

47 
	`ALLTOALLV_TASK_CHECK
(
cŞl_¬gs
->
¬gs
, 
_‹am
);

48 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

49 *
sk_h
 = &
sk
->
su³r
;

50 
¡©us
 = 
	`ucc__uı_®ÉßÎv_·œwi£_š™_commÚ
(
sk
);

51 
out
:

52  
¡©us
;

53 
	}
}

	@src/components/tl/ucp/alltoallv/alltoallv.h

7 #iâdeà
ALLTOALLV_H_


8 
	#ALLTOALLV_H_


	)

10 
	~"../_uı.h
"

11 
	~"../_uı_cŞl.h
"

14 
	mUCC_TL_UCP_ALLTOALLV_ALG_PAIRWISE
,

15 
	mUCC_TL_UCP_ALLTOALLV_ALG_HYBRID
,

16 
	mUCC_TL_UCP_ALLTOALLV_ALG_ONESIDED
,

17 
	mUCC_TL_UCP_ALLTOALLV_ALG_LAST


20 
	#UCC_TL_UCP_ALLTOALLV_DEFAULT_ALG_SELECT_STR
 \

21 "®ÉßÎv:ho¡:[64-šf]:@hybrid"

	)

23 
ucc_ba£_cŞl_®g_šfo_t


24 
ucc__uı_®ÉßÎv_®gs
[
UCC_TL_UCP_ALLTOALLV_ALG_LAST
 + 1];

26 
ucc_¡©us_t
 
ucc__uı_®ÉßÎv_š™
(
ucc__uı_sk_t
 *
sk
);

28 
ucc_¡©us_t
 
ucc__uı_®ÉßÎv_·œwi£_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

29 
ucc_ba£_‹am_t
 *
‹am
,

30 
ucc_cŞl_sk_t
 **
sk_h
);

32 
ucc_¡©us_t
 
ucc__uı_®ÉßÎv_hybrid_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

33 
ucc_ba£_‹am_t
 *
‹am
,

34 
ucc_cŞl_sk_t
 **
sk_h
);

36 
ucc_¡©us_t
 
ucc__uı_®ÉßÎv_Úesided_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

37 
ucc_ba£_‹am_t
 *
‹am
,

38 
ucc_cŞl_sk_t
 **
sk_h
);

40 
ucc_¡©us_t
 
ucc__uı_®ÉßÎv_·œwi£_š™_commÚ
(
ucc__uı_sk_t
 *
sk
);

42 
	#ALLTOALLV_CHECK_INPLACE
(
_¬gs
, 
_‹am
) \

44 ià(
	`UCC_IS_INPLACE
(
_¬gs
)) { \

45 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), \

47 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
; \

48 
out
; \

50 } 0)

	)

52 
	#ALLTOALLV_CHECK_USERDEFINED_DT
(
_¬gs
, 
_‹am
) \

54 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(&(
_¬gs
), 
UCC_RANK_INVALID
)) { \

55 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
), \

57 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
; \

58 
out
; \

60 } 0)

	)

62 
	#ALLTOALLV_TASK_CHECK
(
_¬gs
, 
_‹am
) \

63 
	`ALLTOALLV_CHECK_INPLACE
((
_¬gs
), (
_‹am
)); \

64 
	`ALLTOALLV_CHECK_USERDEFINED_DT
((
_¬gs
), (
_‹am
));

	)

67 
šlše
 
	$ucc__uı_®ÉßÎv_®g_äom_¡r
(cÚ¡ *
¡r
)

69 
i
;

70 
i
 = 0; i < 
UCC_TL_UCP_ALLTOALLV_ALG_LAST
; i++) {

71 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__uı_®ÉßÎv_®gs
[
i
].
Çme
)) {

75  
i
;

76 
	}
}

	@src/components/tl/ucp/alltoallv/alltoallv_hybrid.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®ÉßÎv.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"_uı_£nd»cv.h
"

14 
	~"compÚ’ts/mc/ucc_mc.h
"

15 
	~"cŞl_·‰”ns/bruck_®ÉßÎ.h
"

16 
	~"uts/ucc_©omic.h
"

27 
	#NUM_BINS
 5

	)

28 
	#MAX_BRUCK
 1250

	)

29 
	#COUNT_DIRECT
 
UINT_MAX


	)

30 
	#DENSE_PACK_FORMAT
 
UINT_MAX


	)

33 
	mUCC_ALLTOALLV_HYBRID_PHASE_START
,

34 
	mUCC_ALLTOALLV_HYBRID_PHASE_SENT
,

35 
	mUCC_ALLTOALLV_HYBRID_PHASE_RECV


39 
	mALLTOALLV_HYBRID_SEG_SEND_DIRECT
 = 0,

40 
	mALLTOALLV_HYBRID_SEG_RECV_DIRECT
 = 1,

41 
	mALLTOALLV_HYBRID_SEG_DIGIT
 = 2

44 
	succ__uı_®ÉßÎv_hybrid_m”ge_bš
 {

45 
ucc__uı_sk_t
 *
	msk
;

46 
	m¡¬t
;

47 
	mËn
;

48 } 
	tucc__uı_®ÉßÎv_hybrid_m”ge_bš_t
;

50 
	succ__uı_®ÉßÎv_hybrid_buf_m‘a
 {

51 
ucc__uı_®ÉßÎv_hybrid_m”ge_bš_t
 
	mbšs
[
NUM_BINS
];

52 
	mcur_bš
;

53 
	moff£t
;

54 } 
	tucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
;

56 
	#TASK_SCRATCH
(
_sk
) ({ \

57 (
_sk
)->
®ÉßÎv_hybrid
.
sü©ch_mc_h—d”
->
addr
; \

58 })

	)

60 
	#TASK_TMP
(
_sk
, 
_tsize
) ({ \

61 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
_sk
), 2*
_tsize
*()); \

62 })

	)

64 
	#TASK_SEG
(
_sk
, 
_tsize
) ({ \

65 
	`PTR_OFFSET
(
	`TASK_SCRATCH
(
_sk
), 4 * 
_tsize
*()); \

66 })

	)

68 
	#TASK_LB
(
_sk
, 
_tsize
) ({ \

69 
	`PTR_OFFSET
(
	`TASK_SEG
(
_sk
, 
_tsize
), _tsize*()); \

70 })

	)

72 
	#TASK_PTRS
(
_sk
, 
_tsize
) ({ \

73 
ušt32_t
 
_¿dix
 = (
_sk
)->
®ÉßÎv_hybrid
.
¿dix
; \

74 
	`PTR_OFFSET
(
	`TASK_LB
(
_sk
, 
_tsize
), (
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
)*(
_¿dix
 - 1)); \

75 })

	)

77 
	#TASK_BUF
(
_sk
, 
_i
, 
_tsize
) ({ \

78 
size_t
 
_buff_size
 = 
	`UCC_TL_UCP_TEAM_LIB
(
	`TASK_TEAM
(
_sk
))->
cfg
.
®ÉßÎv_hybrid_buff_size
; \

79 
	`PTR_OFFSET
(
	`TASK_PTRS
(
_sk
, 
_tsize
), 
	`ucc_div_round_up
(_tsize, 2)*(*) + \

80 (
_i
è* 
_buff_size
); \

81 })

	)

83 
	#ALIGN
(
x
è
	`ucc_û
(x, 4)

	)

85 
	#IS_DIRECT_SEND
(
_£g
è((_£gè& 
	`UCC_BIT
(
ALLTOALLV_HYBRID_SEG_SEND_DIRECT
))

	)

87 
	#SET_DIRECT_SEND
(
_£g
è((_£gè|ğ
	`UCC_BIT
(
ALLTOALLV_HYBRID_SEG_SEND_DIRECT
))

	)

89 
	#IS_DIRECT_RECV
(
_£g
è((_£gè& 
	`UCC_BIT
(
ALLTOALLV_HYBRID_SEG_RECV_DIRECT
))

	)

91 
	#SET_DIRECT_RECV
(
_£g
è((_£gè|ğ
	`UCC_BIT
(
ALLTOALLV_HYBRID_SEG_RECV_DIRECT
))

	)

93 
	#GET_BRUCK_DIGIT
(
_£g
è((_£gè>> 
ALLTOALLV_HYBRID_SEG_DIGIT
)

	)

95 
	#SET_BRUCK_DIGIT
(
_£g
, 
_dig™
) \

96 ((
_£g
èğ(((
_dig™
è<< 
ALLTOALLV_HYBRID_SEG_DIGIT
è+ ((_£gè& 
	`UCC_MASK
(ALLTOALLV_HYBRID_SEG_DIGIT))))

	)

98 
šlše
 
ucc_¿nk_t
 
	$g‘_·œwi£_£nd_³”
(
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
,

99 
ucc_¿nk_t
 
¡•
)

101  (
Œªk
 + 
¡•
è% 
tsize
;

102 
	}
}

104 
šlše
 
ucc_¿nk_t
 
	$g‘_·œwi£_»cv_³”
(
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
,

105 
ucc_¿nk_t
 
¡•
)

107  (
Œªk
 - 
¡•
 + 
tsize
) %size;

108 
	}
}

110 
	$£nd_com¶‘iÚ
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

111 *
u£r_d©a
)

113 
ucc__uı_®ÉßÎv_hybrid_m”ge_bš_t
 *
bš
 =

114 (
ucc__uı_®ÉßÎv_hybrid_m”ge_bš_t
*)
u£r_d©a
;

116 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

117 
	`_”rÜ
(
	`UCC_TASK_LIB
(
bš
->
sk
), "failure in‡lltoallv_hybird completion %s",

118 
	`ucs_¡©us_¡ršg
(
¡©us
));

119 
bš
->
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

122 ià(
»que¡
) {

123 
	`uı_»que¡_ä“
(
»que¡
);

126 
	`ucc_©omic_add32
(&
bš
->
sk
->
gged
.
£nd_com¶‘ed
, 1);

127 
bš
->
Ën
 = 0;

128 
	}
}

130 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎv_hybrid_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

132 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

134 ià(
sk
->
®ÉßÎv_hybrid
.
sü©ch_mc_h—d”
) {

135 
	`ucc_mc_ä“
(
sk
->
®ÉßÎv_hybrid
.
sü©ch_mc_h—d”
);

137  
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

138 
	}
}

140 
šlše
 
	$¿dix_£tup
(
ucc__uı_sk_t
 *
sk
, 
id
, 
ucc_¿nk_t
 
tsize
,

141 
size_t
 
m”ge_buf_size
,

142 
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
** 
m‘a
,

143 ** 
m”ge_buf
, ** 
tmp_buf
)

145 
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
 *
bm
 = 
	`TASK_LB
(
sk
, 
tsize
);

147 (*
m‘a
èğ&
bm
[
id
];

148 (*
m”ge_buf
èğ
	`TASK_BUF
(
sk
, 
id
, 
tsize
);

149 (*
tmp_buf
èğ
	`PTR_OFFSET
(*
m”ge_buf
, 
m”ge_buf_size
);

150 
	}
}

153 
šlše
 
	$g‘_£nd_block_couÁ
(
ucc_¿nk_t
 
tsize
, 
¿dix
,

154 
node_edge_id
, 
¿dix_pow
)

156 
k
 = 
tsize
 / 
¿dix_pow
;

157 
£nd_couÁ
 = (
k
 / 
¿dix
è* 
¿dix_pow
;

159 ià((
k
 % 
¿dix
è> 
node_edge_id
) {

160 
£nd_couÁ
 +ğ
¿dix_pow
;

161 } ià((
k
 % 
¿dix
è=ğ
node_edge_id
) {

162 
£nd_couÁ
 +ğ(
tsize
 % 
¿dix_pow
);

165  
£nd_couÁ
;

166 
	}
}

168 
šlše
 
	$ÿlcuÏ‹_h—d_size
(
¢d_couÁ
, 
size_t
 
dt_size
)

170 
h—d_num_–em’ts
 = 0;

172 ià(
dt_size
 <= ()) {

173 
h—d_num_–em’ts
 = ((
¢d_couÁ
 + 1è* ()è/ 
dt_size
;

176 ià(((
¢d_couÁ
 + 1è* ()è% 
dt_size
 == 0) {

178 
h—d_num_–em’ts
 = ((
¢d_couÁ
 + 1è* ()è/ 
dt_size
;

181 
h—d_num_–em’ts
 = ((
¢d_couÁ
 + 1è* ()è/ 
dt_size
 + 1;

184  
h—d_num_–em’ts
;

185 
	}
}

187 
	$f™_š_£nd_bufãr
(
num
,

188 
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
* 
m‘a
,

189 
size_»q
, 
mem_size
)

191 *
cur_bš
 = &
m‘a
->cur_bin;

192 
¡¬t_ok
 = 1;

193 
bš_rdy
 = -1;

194 
i
, 
k
, 
pos
, 
v®id_pos
;

196 
	`ucc_as£¹
(
size_»q
 <ğ
mem_size
);

197 
i
 = 0; i < 
num
; i++) {

198 ià(
m‘a
->
bšs
[
i
].
Ën
 == 0) {

199 
bš_rdy
 = 
i
;

203 *
cur_bš
 = 
bš_rdy
;

205 ià(
bš_rdy
 == -1) {

210 
i
 = 0; i < 
num
; i++) {

211 ià((
m‘a
->
bšs
[
i
].
Ën
 > 0è&& (m‘a->bšs[i].
¡¬t
 < 
size_»q
)) {

212 
¡¬t_ok
 = 0;

217 ià(
¡¬t_ok
 == 1) {

223 
k
 = 0; k < 
num
; k++) {

224 ià(
m‘a
->
bšs
[
k
].
Ën
 > 0) {

226 
v®id_pos
 = 1;

227 
pos
 = 
m‘a
->
bšs
[
k
].
¡¬t
 + m‘a->bšs[k].
Ën
;

228 ià(
pos
 + 
size_»q
 < 
mem_size
) {

232 
i
 = 0; i < 
num
; i++) {

233 ià((
i
 =ğ
k
è|| (
m‘a
->
bšs
[i].
Ën
 == 0)) {

237 ià(
m‘a
->
bšs
[
i
].
¡¬t
 < (
pos
 + 
size_»q
) &&

238 
pos
 < 
m‘a
->
bšs
[
i
].
¡¬t
 + m‘a->bšs[i].
Ën
) {

240 
v®id_pos
 = 0;

245 ià(
v®id_pos
) {

247  
pos
;

254 
	}
}

256 
šlše


257 
ucc_¡©us_t
 
	$g‘_£nd_bufãr
(*
p_tmp_£nd_»giÚ
,

258 
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
* 
m‘a
,

259 
num_bšs
, 
»quœed_buf_size
,

260 
ucc__uı_sk_t
 *
sk
, **
buf
)

262 
m”ge_buf_size
 = 
sk
->
®ÉßÎv_hybrid
.merge_buf_size;

263 
pŞls
 = 0;

264 
£nd_buf_off£t
;

267 
£nd_buf_off£t
 = 
	`f™_š_£nd_bufãr
(
num_bšs
, 
m‘a
, 
»quœed_buf_size
,

268 
m”ge_buf_size
);

269 ià(
£nd_buf_off£t
 < 0) {

271 
	`uı_wÜk”_´og»ss
(
	`TASK_CTX
(
sk
)->
wÜk”
.
uı_wÜk”
);

272 
£nd_buf_off£t
 = 
	`f™_š_£nd_bufãr
(
num_bšs
, 
m‘a
,

273 
»quœed_buf_size
,

274 
m”ge_buf_size
);

275 } (
£nd_buf_off£t
 < 0è&& (
pŞls
++ < 
sk
->
n_pŞls
));

276 ià(
£nd_buf_off£t
 < 0) {

277  
UCC_INPROGRESS
;

281 
m‘a
->
bšs
[m‘a->
cur_bš
].
¡¬t
 = 
£nd_buf_off£t
;

282 *
buf
 = 
	`PTR_OFFSET
(
p_tmp_£nd_»giÚ
, 
£nd_buf_off£t
);

283  
UCC_OK
;

284 
	}
}

290 
size_t
 
	$·ck_£nd_d©a
(
ucc__uı_sk_t
 *
sk
, 
¡•
,

291 
£nd_couÁ
, 
node_edge_id
, 
size_t
 
dt_size
,

292 
£nd_lim™
, 
¡•_h—d”_size
,

293 *
·cked_£nd_buf
)

295 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

296 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

297 *
By‹sFÜPackšg
 = 
	`TASK_TMP
(
sk
, 
tsize
);

298 *
£g_¡
 = 
	`TASK_SEG
(
sk
, 
tsize
);

299 
tmp_£nd_»giÚ_size
 = 
sk
->
®ÉßÎv_hybrid
.
m”ge_buf_size
;

300 
ušt32_t
 
¿dix
 = 
sk
->
®ÉßÎv_hybrid
.radix;

301 **
¤c_iovec
 = 
	`TASK_PTRS
(
sk
, 
tsize
);

302 *
u£r_sbuf
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
bufãr
;

303 
¥¬£_út
 = 0;

304 
n
 = 
£nd_couÁ
;

305 
logi
 = 1;

306 *
İ_m‘ad©a
 = 
sk
->
®ÉßÎv_hybrid
.
sü©ch_mc_h—d”
->
addr
;

307 
ucc_¿nk_t
 
šdex
;

308 
£nd_Ën
, 
¢d_off£t
, 
i
, 
k
;

309 
‹mp_couÁ
;

310 
loc
;

311 
size_t
 
off£t
;

313 
i
 = 0; i < 
n
; i++) {

314 
By‹sFÜPackšg
[
i
] = 
£nd_lim™
;

317 
logi
 < 
n
) {

318 
logi
 =†og˜* 
¿dix
;

321 
šdex
 = 
	`g‘_bruck_¡•_fšish
(
tsize
 - 1, 
¿dix
, 
node_edge_id
, 
¡•
);

322 
n
 > 0) {

323 
	`ucc_as£¹
((
šdex
 / 
¡•
è% 
¿dix
 =ğ
node_edge_id
);

324 
n
--;

325 ià(
logi
 > 
n
) {

326 
logi
 =†og˜/ 
¿dix
;

328 
‹mp_couÁ
 = ((*)
İ_m‘ad©a
)[
šdex
 + 
tsize
];

329 ià(
‹mp_couÁ
 =ğ
COUNT_DIRECT
) {

331 
£nd_Ën
 = 0;

333 
loc
 = 
	`GET_BRUCK_DIGIT
(
£g_¡
[
šdex
]);

334 
¢d_off£t
 = ((*)
İ_m‘ad©a
)[
šdex
] * 
dt_size
;

335 
£nd_Ën
 = 
dt_size
 * 
‹mp_couÁ
;

336 ià(
loc
) {

338 
¤c_iovec
[
n
] = 
	`PTR_OFFSET
(
	`TASK_BUF
(
sk
, (
loc
 - 1), 
tsize
),

339 
tmp_£nd_»giÚ_size
 + 
¢d_off£t
);

342 ià((
£nd_Ën
 <ğ
By‹sFÜPackšg
[
n
]) &&

343 (
£nd_Ën
 < 
MAX_BRUCK
 || 
n
 < 
¡•
)) {

344 
¤c_iovec
[
n
] = 
	`PTR_OFFSET
(
u£r_sbuf
, 
¢d_off£t
);

347 
‹mp_couÁ
 = 
COUNT_DIRECT
;

348 
sk
->
®ÉßÎv_hybrid
.
num2£nd
++;

350 
	`SET_DIRECT_SEND
(
£g_¡
[
šdex
]);

351 
£nd_Ën
 = 0;

355 ((*)
·cked_£nd_buf
)[
n
 + 1] = 
‹mp_couÁ
;

356 ià(
£nd_Ën
 > 0) {

357 
¥¬£_út
++;

360 ià(
logi
 > 0) {

361 
By‹sFÜPackšg
[
n
 % 
logi
] +ğBy‹sFÜPackšg[n] - 
£nd_Ën
;

363 
šdex
 = 
	`GET_PREV_BRUCK_NUM
(šdex, 
¿dix
, 
¡•
);

368 ià((
¥¬£_út
 * 2è< 
£nd_couÁ
) {

370 ((*)
·cked_£nd_buf
)[0] = 
¥¬£_út
;

372 
off£t
 = 
	`ÿlcuÏ‹_h—d_size
(
¥¬£_út
 * 2, 
dt_size
) * dt_size;

373 
i
 = 
k
 = 0;

374 
k
 < 
¥¬£_út
) {

375 
cur_Ën
 = ((*)
·cked_£nd_buf
)[
i
 + 1];

376 ià(
cur_Ën
 !ğ0 && cur_ËÀ!ğ
COUNT_DIRECT
) {

377 
By‹sFÜPackšg
[2 * 
k
] = 
i
;

378 
By‹sFÜPackšg
[2 * 
k
 + 1] = 
cur_Ën
;

379 ++
k
;

381 ++
i
;

383 
i
 = 0; i < 
¥¬£_út
; i++){

384 ((*)
·cked_£nd_buf
)[2 * 
i
 + 1] = 
By‹sFÜPackšg
[2 * i];

385 ((*)
·cked_£nd_buf
)[2 * 
i
 + 2] = 
By‹sFÜPackšg
[2 * i + 1];

388 
k
 = 0; k < 
¥¬£_út
; ++k) {

389 
i
 = ((*)
·cked_£nd_buf
)[2 * 
k
 + 1];

390 
‹mp_couÁ
 = ((*)
·cked_£nd_buf
)[2 * 
k
 + 2];

391 
	`memıy
(
	`PTR_OFFSET
(
·cked_£nd_buf
, 
off£t
), 
¤c_iovec
[
i
],

392 
‹mp_couÁ
 * 
dt_size
);

393 
off£t
 = off£ˆ+ 
‹mp_couÁ
 * 
dt_size
;

397 ((*)
·cked_£nd_buf
)[0] = 
DENSE_PACK_FORMAT
;

398 
off£t
 = 
¡•_h—d”_size
;

399 
i
 = 0; i < 
£nd_couÁ
; i++) {

400 
‹mp_couÁ
 = ((*)
·cked_£nd_buf
)[
i
 + 1];

401 ià(
‹mp_couÁ
 !ğ
COUNT_DIRECT
) {

402 
	`memıy
(
	`PTR_OFFSET
(
·cked_£nd_buf
, 
off£t
), 
¤c_iovec
[
i
],

403 
‹mp_couÁ
 * 
dt_size
);

404 
off£t
 = off£ˆ+ 
‹mp_couÁ
 * 
dt_size
;

409  
off£t
;

410 
	}
}

412 
šlše


413 
ucc_¡©us_t
 
	$£nd_d©a
(*
buf
, 
£nd_size
, 
ucc_¿nk_t
 
d¡
,

414 
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
 *
m‘a
,

415 
ucc__uı_sk_t
 *
sk
)

417 
ucc_¡©us_t
 
¡©us
;

419 
	`ucc_as£¹
(
m‘a
->
bšs
[m‘a->
cur_bš
].
Ën
 != 0);

420 
¡©us
 = 
	`ucc__uı_£nd_cb
(
buf
, 
£nd_size
, 
UCC_MEMORY_TYPE_HOST
, 
d¡
,

421 
	`TASK_TEAM
(
sk
),ask, 
£nd_com¶‘iÚ
,

422 (*)&
m‘a
->
bšs
[m‘a->
cur_bš
]);

423 
sk
->
®ÉßÎv_hybrid
.
pha£
 = 
UCC_ALLTOALLV_HYBRID_PHASE_SENT
;

424  
¡©us
;

425 
	}
}

428 
	$»ûive_bufãr_»cyş”
(
ucc_¿nk_t
 
tsize
, * 
rcv_¡¬t
, * 
rcv_Ën
,

429 * 
£g_¡
, * 
buf
, 
size_t
 
dt_size
, * 
tmp_buf
,

430 
¡•
, * 
rbuf
, * 
rdi¥s
, 
my_group_šdex
,

431 
¿dix
, 
node_edge_id
)

433 
cur
 = 0;

434 
m¡•
 = 
¡•
 / 
¿dix
;

435 
i
, 
k
, 
š_buf
, 
off£t
, 
idx
;

437 
i
 = 0; i < 
tsize
; ++i) {

438 ià(
	`GET_BRUCK_DIGIT
(
£g_¡
[
i
]è=ğ
node_edge_id
) {

439 
tmp_buf
[
i
 + 
tsize
] = 1;

440 ++
cur
;

442 
tmp_buf
[
i
 + 
tsize
] = 0;

446 
š_buf
 = 
cur
;

447 --
cur
;

448 
cur
 >= 0) {

449 
i
 = 
tsize
 - 1; i >= 0; --i) {

450 ià(
tmp_buf
[
i
 + 
tsize
] && ((˜/ 
m¡•
è% 
¿dix
 =ğ
node_edge_id
)) {

451 
tmp_buf
[
cur
] = 
i
;

452 
tmp_buf
[
i
 + 
tsize
] = 0;

453 --
cur
;

456 
m¡•
 = m¡• / 
¿dix
;

458 
k
 = 0;

459 
off£t
 = 0;

460 
k
 < 
š_buf
) {

461 
cur
 = 
tmp_buf
[
k
];

462 ià((
rcv_¡¬t
[
cur
] =ğ
COUNT_DIRECT
è|| (
rcv_Ën
[cur] == 0)) {

463 ++
k
;

466 ià(
cur
 < 
¡•
) {

468 
idx
 = (
my_group_šdex
 - 
cur
 + 
tsize
) %size;

469 
	`memıy
(
	`PTR_OFFSET
(
rbuf
, 
rdi¥s
[
idx
] * 
dt_size
),

470 
	`PTR_OFFSET
(
buf
, 
rcv_¡¬t
[
cur
] * 
dt_size
),

471 
rcv_Ën
[
cur
] * 
dt_size
);

472 
rcv_¡¬t
[
cur
] = 
COUNT_DIRECT
;

473 
rcv_Ën
[
cur
] = 0;

474 
£g_¡
[
cur
] = seg_st[cur] % 4;

476 ià(
off£t
 < 
rcv_¡¬t
[
cur
]) {

477 
	`memmove
(
	`PTR_OFFSET
(
buf
, 
off£t
 * 
dt_size
),

478 
	`PTR_OFFSET
(
buf
, 
rcv_¡¬t
[
cur
] * 
dt_size
),

479 
rcv_Ën
[
cur
] * 
dt_size
);

480 
rcv_¡¬t
[
cur
] = 
off£t
;

481 
off£t
 +ğ
rcv_Ën
[
cur
];

483 
	`ucc_as£¹
(
off£t
 =ğ
rcv_¡¬t
[
cur
]);

484 
off£t
 +ğ
rcv_Ën
[
cur
];

487 ++
k
;

490  
off£t
;

491 
	}
}

494 
ucc_¡©us_t
 
	$po¡_»cv
(
ucc_¿nk_t
 
»cväom
, ucc_¿nk_ˆ
tsize
, 
size_t
 
dt_size
,

495 
node_edge_id
, 
¡•
, 
ucc_¿nk_t
 
Œªk
,

496 *
İ_m‘ad©a
, 
tmp_buf_size
, *
£g_¡
,

497 
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
 *
m‘a
,

498 
¡•_buf_size
, *
By‹sFÜPackšg
,

499 *
p_tmp_»cv_»giÚ
, 
ucc__uı_sk_t
 *
sk
)

501 *
rdi¥s
 = (*)
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
di¥Ïûm’ts
;

502 *
u£r_rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
bufãr
;

503 
ušt32_t
 
¿dix
 = 
sk
->
®ÉßÎv_hybrid
.radix;

504 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

505 
Ãw_off£t
;

506 * 
d¡_buf
;

508 ià(
sk
->
®ÉßÎv_hybrid
.
pha£
 !ğ
UCC_ALLTOALLV_HYBRID_PHASE_SENT
) {

509  
UCC_OK
;

513 ià(
m‘a
->
off£t
 * 
dt_size
 + 
¡•_buf_size
 > 
tmp_buf_size
) {

514 
Ãw_off£t
 = 
	`»ûive_bufãr_»cyş”
(
tsize
, (*)
İ_m‘ad©a
,

515 (*)
İ_m‘ad©a
 + 
tsize
,

516 
£g_¡
, 
p_tmp_»cv_»giÚ
, 
dt_size
,

517 
By‹sFÜPackšg
, 
¡•
, 
u£r_rbuf
,

518 
rdi¥s
, 
Œªk
, 
¿dix
, 
node_edge_id
);

519 
m‘a
->
off£t
 = 
Ãw_off£t
;

521 
	`ucc_as£¹
(
m‘a
->
off£t
 * 
dt_size
 + 
¡•_buf_size
 <ğ
tmp_buf_size
);

522 
d¡_buf
 = 
	`PTR_OFFSET
(
p_tmp_»cv_»giÚ
, 
m‘a
->
off£t
 * 
dt_size
);

523 
¡©us
 = 
	`ucc__uı_»cv_nb
(
d¡_buf
, 
¡•_buf_size
, 
UCC_MEMORY_TYPE_HOST
,

524 
»cväom
, 
	`TASK_TEAM
(
sk
),ask);

525 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

526  
¡©us
;

529 
sk
->
®ÉßÎv_hybrid
.
pha£
 = 
UCC_ALLTOALLV_HYBRID_PHASE_START
;

530 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
++;

531 ià(
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
 =ğ
¿dix
) {

533 
sk
->
®ÉßÎv_hybrid
.
pha£
 = 
UCC_ALLTOALLV_HYBRID_PHASE_RECV
;

534 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
 = 1;

537  
UCC_OK
;

538 
	}
}

541 
ucc_¡©us_t
 
	$com¶‘e_cu¼’t_¡•_»ûives
(
ucc_¿nk_t
 
tsize
, 
¡•
,

542 
size_t
 
dt_size
, 
ucc_¿nk_t
 
Œªk
,

543 *
İ_m‘ad©a
, *
£g_¡
,

544 
ucc__uı_sk_t
 *
sk
)

546 
size_t
 
tmp_£nd_»giÚ_size
 = 
sk
->
®ÉßÎv_hybrid
.
m”ge_buf_size
;

547 
ušt32_t
 
¿dix
 = 
sk
->
®ÉßÎv_hybrid
.radix;

548 *
rcouÁs
 = (*)
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
couÁs
;

549 
pŞls
 = 0;

550 
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
 *
m‘a
;

551 
rcv_¥¬£
, 
Ãxt_p
, 
cur_p
;

552 *
p_tmp_»cv_»giÚ
, *
p_tmp_£nd_»giÚ
, *
d¡_buf
, *
‹mp_off£t
;

553 
i
, 
k
, 
n
, 
node_edge_id
, 
»cv_couÁ
, 
cur_buf_Ëngth
, 
»cv_size
;

555 (
sk
->
gged
.
»cv_po¡ed
 !ğsk->gged.
»cv_com¶‘ed
) &&

556 (
pŞls
++ < 
sk
->
n_pŞls
)) {

557 
	`uı_wÜk”_´og»ss
(
	`TASK_CTX
(
sk
)->
wÜk”
.
uı_wÜk”
);

560 ià(
sk
->
gged
.
»cv_po¡ed
 !ğsk->gged.
»cv_com¶‘ed
) {

561  
UCC_INPROGRESS
;

564 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
 < 
¿dix
) {

565 
node_edge_id
 = 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
;

566 
	`¿dix_£tup
(
sk
, 
node_edge_id
 - 1, 
tsize
, 
tmp_£nd_»giÚ_size
,

567 &
m‘a
, &
p_tmp_£nd_»giÚ
, &
p_tmp_»cv_»giÚ
);

569 
n
 = 
	`g‘_£nd_block_couÁ
(
tsize
, 
¿dix
, 
node_edge_id
, 
¡•
);

570 ià(!
n
) {

572 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
++;

579 
d¡_buf
 = 
	`PTR_OFFSET
(
p_tmp_»cv_»giÚ
, 
m‘a
->
off£t
 * 
dt_size
);

580 
rcv_¥¬£
 = ((*)
d¡_buf
)[0];

581 
i
 = 
	`g‘_bruck_¡•_¡¬t
(
¡•
, 
node_edge_id
);

582 ià(
rcv_¥¬£
 =ğ
DENSE_PACK_FORMAT
) {

583 
»cv_couÁ
 = 0;

584 
»cv_size
 = 
	`ÿlcuÏ‹_h—d_size
(
n
, 
dt_size
);

585 
‹mp_off£t
 = 
	`PTR_OFFSET
(
d¡_buf
, 
»cv_size
 * 
dt_size
);

589 
i
 < 
tsize
) {

590 
cur_buf_Ëngth
 = ((*)
d¡_buf
)[1 + 
»cv_couÁ
];

591 ià(
cur_buf_Ëngth
 !ğ
COUNT_DIRECT
) {

592 ((*)
İ_m‘ad©a
)[
i
] =

593 ((*)
‹mp_off£t
-(*)
p_tmp_»cv_»giÚ
è/ 
dt_size
;

595 
	`SET_BRUCK_DIGIT
(
£g_¡
[
i
], 
node_edge_id
);

596 ((*)
İ_m‘ad©a
)[
i
 + 
tsize
] = 
cur_buf_Ëngth
;

597 
»cv_size
 +ğ
cur_buf_Ëngth
;

598 
‹mp_off£t
 = 
	`PTR_OFFSET
Ñemp_off£t, 
cur_buf_Ëngth
 * 
dt_size
);

601 ((*)
İ_m‘ad©a
)[
i
] = ()
COUNT_DIRECT
;

602 ((*)
İ_m‘ad©a
)[
i
 + 
tsize
] = ()
COUNT_DIRECT
;

603 ià(
i
 < (
¡•
 * 
¿dix
)) {

604 
·œwi£_¤c
 = (
Œªk
 - 
i
 + 
tsize
) %size;

605 ià(
rcouÁs
[
·œwi£_¤c
] > 0) {

606 
sk
->
®ÉßÎv_hybrid
.
num2»cv
++;

607 
	`SET_DIRECT_RECV
(
£g_¡
[
i
]);

611 ++
»cv_couÁ
;

612 
i
 = 
	`GET_NEXT_BRUCK_NUM
(i, 
¿dix
, 
¡•
);

615 
»cv_size
 = 
	`ÿlcuÏ‹_h—d_size
(2*
rcv_¥¬£
, 
dt_size
);

616 
‹mp_off£t
ğ
	`PTR_OFFSET
(
d¡_buf
, 
»cv_size
*
dt_size
);

617 
k
 = 0;

618 ià(
rcv_¥¬£
 > 0) {

619 
Ãxt_p
 = ((*)
d¡_buf
)[2 * 
k
 + 1];

621 
Ãxt_p
 = 
tsize
;

624 
cur_p
 = 0;

625 
i
 < 
tsize
) {

626 ià(
cur_p
 =ğ
Ãxt_p
) {

627 
cur_buf_Ëngth
 = ((*)
d¡_buf
)[2 * 
k
 + 2];

628 ((*)
İ_m‘ad©a
)[
i
] =

629 (((*)
‹mp_off£t
 - (*)
p_tmp_»cv_»giÚ
è/ 
dt_size
);

630 ((*)
İ_m‘ad©a
)[
i
 + 
tsize
] = 
cur_buf_Ëngth
;

632 
»cv_size
+ğ
cur_buf_Ëngth
;

633 
‹mp_off£t
 = 
	`PTR_OFFSET
Ñemp_off£t, 
cur_buf_Ëngth
 * 
dt_size
);

634 
	`SET_BRUCK_DIGIT
(
£g_¡
[
i
], 
node_edge_id
);

635 ++
k
;

636 ià(
k
 < 
rcv_¥¬£
) {

637 
Ãxt_p
ğ((*)
d¡_buf
)[2*
k
 + 1];

639 
Ãxt_p
 = 
tsize
;

642 ((*)
İ_m‘ad©a
)[
i
] = ()
COUNT_DIRECT
;

643 ((*)
İ_m‘ad©a
)[
i
 + 
tsize
] = ()
COUNT_DIRECT
;

644 ià(
i
 < (
¡•
 * 
¿dix
)) {

645 
·œwi£_¤c
 = (
Œªk
 - 
i
 + 
tsize
) %size;

646 ià(
rcouÁs
[
·œwi£_¤c
] > 0) {

647 
sk
->
®ÉßÎv_hybrid
.
num2»cv
++;

648 
	`SET_DIRECT_RECV
(
£g_¡
[
i
]);

652 ++
cur_p
;

653 
i
 = 
	`GET_NEXT_BRUCK_NUM
(i, 
¿dix
, 
¡•
);

655 
	`ucc_as£¹
(
Ãxt_p
 =ğ
tsize
);

657 
m‘a
->
off£t
 +ğ
»cv_size
;

658 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
++;

661  
UCC_OK
;

662 
	}
}

664 
šlše
 
	$hybrid_»v”£_rÙ©iÚ
(
ucc__uı_sk_t
 *
sk
)

666 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

667 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

668 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

669 *
£g_¡
 = 
	`TASK_SEG
(
sk
, 
tsize
);

670 
size_t
 
m”ge_buf_size
 = 
sk
->
®ÉßÎv_hybrid
.merge_buf_size;

671 *
u£r_sbuf
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
bufãr
;

672 *
u£r_rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
bufãr
;

673 *
rdi¥s
 = (*)
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
di¥Ïûm’ts
;

674 *
m‘ašfo
 = 
sk
->
®ÉßÎv_hybrid
.
sü©ch_mc_h—d”
->
addr
;

675 
size_t
 
dt_size
;

676 
i
, 
idx
, 
cur_buf_šdex
, 
cur_buf_size
;

677 
loc
;

678 *
lb
;

680 
dt_size
 = 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
d©©y³
);

681 
i
 = 0; i < 
tsize
; i++) {

682 
cur_buf_šdex
 = ((*)
m‘ašfo
)[
i
];

683 
cur_buf_size
 = ((*)
m‘ašfo
)[
i
 + 
tsize
];

684 ià(
cur_buf_šdex
 !ğ
COUNT_DIRECT
 ) {

685 
loc
 = 
	`GET_BRUCK_DIGIT
(
£g_¡
[
i
]);

686 
idx
 = (
Œªk
 - 
i
 + 
tsize
) %size;

687 ià(
loc
 == 0) {

689 
	`memıy
(
	`PTR_OFFSET
(
u£r_rbuf
, 
rdi¥s
[
idx
] * 
dt_size
),

690 
	`PTR_OFFSET
(
u£r_sbuf
, 
cur_buf_šdex
 * 
dt_size
),

691 
cur_buf_size
 * 
dt_size
);

694 
lb
 = 
	`TASK_BUF
(
sk
, 
loc
 - 1, 
tsize
);

695 
	`memıy
(
	`PTR_OFFSET
(
u£r_rbuf
, 
rdi¥s
[
idx
] * 
dt_size
),

696 
	`PTR_OFFSET
(
lb
, 
m”ge_buf_size
 + 
cur_buf_šdex
 * 
dt_size
),

697 
cur_buf_size
 * 
dt_size
);

701 
	}
}

704 
ucc_¡©us_t
 
	$·œwi£_mªag”
(
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
,

705 
size_t
 
dt_size
, 
ucc__uı_sk_t
 *
sk
)

707 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

708 *
£g_¡
 = 
	`TASK_SEG
(
sk
, 
tsize
);

709 *
u£r_sbuf
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
bufãr
;

710 *
u£r_rbuf
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
bufãr
;

711 *
s_di¥s
 = (*)
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
di¥Ïûm’ts
;

712 *
r_di¥s
 = (*)
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
di¥Ïûm’ts
;

713 *
scouÁs
 = (*)
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
couÁs
;

714 *
rcouÁs
 = (*)
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
couÁs
;

715 
ucc_¿nk_t
 *
cur
 = &
sk
->
®ÉßÎv_hybrid
.
cur_out
;

716 
chunk_num_lim™
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
®ÉßÎv_hybrid_·œwi£_num_po¡s
;

717 
chunk_by‹_lim™
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
®ÉßÎv_hybrid_chunk_by‹_lim™
;

718 
ucc_¡©us_t
 
¡©us
;

719 * 
mem_d¡
;

720 
·œwi£_de¡
, 
msg_size
;

722 ià((
sk
->
®ÉßÎv_hybrid
.
num_š
 < 
chunk_num_lim™
) &&

723 (
sk
->
®ÉßÎv_hybrid
.
Œaffic_š
 <ğ
chunk_by‹_lim™
) &&

724 (
sk
->
®ÉßÎv_hybrid
.
Œaffic_out
 <ğ
chunk_by‹_lim™
)) {

725 ià((
sk
->
®ÉßÎv_hybrid
.
num2£nd
 == 0) &&

726 (
sk
->
®ÉßÎv_hybrid
.
num2»cv
 == 0)) {

727  
UCC_OK
;

730 !(
	`IS_DIRECT_SEND
(
£g_¡
[*
cur
]è|| 
	`IS_DIRECT_RECV
(seg_st[*cur]))) {

731 ++(*
cur
);

732 
	`ucc_as£¹
(*
cur
 < 
tsize
);

735 ià(
	`IS_DIRECT_SEND
(
£g_¡
[*
cur
])) {

736 
·œwi£_de¡
 = 
	`g‘_·œwi£_£nd_³”
(
Œªk
, 
tsize
, *
cur
);

737 
mem_d¡
 = 
	`PTR_OFFSET
(
u£r_sbuf
, 
s_di¥s
[
·œwi£_de¡
] * 
dt_size
);

738 
msg_size
 = 
scouÁs
[
·œwi£_de¡
] * 
dt_size
;

739 
sk
->
®ÉßÎv_hybrid
.
Œaffic_out
 +ğ
msg_size
;

740 ià((
sk
->
®ÉßÎv_hybrid
.
num_š
 > 0) &&

741 (
sk
->
®ÉßÎv_hybrid
.
Œaffic_out
 > 
chunk_by‹_lim™
)) {

743  
UCC_OK
;

746 
¡©us
 = 
	`ucc__uı_£nd_nb
(
mem_d¡
, 
msg_size
, 
UCC_MEMORY_TYPE_HOST
,

747 
·œwi£_de¡
, 
‹am
, 
sk
);

748 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

749  
¡©us
;

751 
£g_¡
[(*
cur
)] = seg_st[(*cur)] - 1;

752 
sk
->
®ÉßÎv_hybrid
.
num2£nd
--;

755 ià(
	`IS_DIRECT_RECV
(
£g_¡
[*
cur
])) {

756 
·œwi£_de¡
 = 
	`g‘_·œwi£_»cv_³”
(
Œªk
, 
tsize
, *
cur
);

757 
mem_d¡
 = 
	`PTR_OFFSET
(
u£r_rbuf
, 
r_di¥s
[
·œwi£_de¡
] * 
dt_size
);

758 
msg_size
 = 
rcouÁs
[
·œwi£_de¡
] * 
dt_size
;

759 
¡©us
 = 
	`ucc__uı_»cv_nb
(
mem_d¡
, 
msg_size
, 
UCC_MEMORY_TYPE_HOST
,

760 
·œwi£_de¡
, 
‹am
, 
sk
);

761 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

762  
¡©us
;

764 
sk
->
®ÉßÎv_hybrid
.
Œaffic_š
 +ğ
msg_size
;

765 
£g_¡
[(*
cur
)] = seg_st[(*cur)] - 2;

766 
sk
->
®ÉßÎv_hybrid
.
num2»cv
--;

768 
sk
->
®ÉßÎv_hybrid
.
num_š
++;

769 ++(*
cur
);

771 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

772  
UCC_INPROGRESS
;

774 
sk
->
®ÉßÎv_hybrid
.
num_š
 = 0;

775 
sk
->
®ÉßÎv_hybrid
.
Œaffic_š
 = 0;

776 
sk
->
®ÉßÎv_hybrid
.
Œaffic_out
 = 0;

779  
UCC_OK
;

780 
	}
}

782 
	$ucc__uı_®ÉßÎv_hybrid_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

784 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

785 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

786 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

787 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

788 
ušt32_t
 
¿dix
 = 
sk
->
®ÉßÎv_hybrid
.radix;

789 *
£g_¡
 = 
	`TASK_SEG
(
sk
, 
gsize
);

790 *
İ_m‘ad©a
 = 
sk
->
®ÉßÎv_hybrid
.
sü©ch_mc_h—d”
->
addr
;

791 
size_t
 
m”ge_buf_size
 = 
sk
->
®ÉßÎv_hybrid
.merge_buf_size;

792 
size_t
 
£nd_lim™
 = 
sk
->
®ÉßÎv_hybrid
.
by‹_£nd_lim™
;

793 *
By‹sFÜPackšg
 = 
	`TASK_TMP
(
sk
, 
gsize
);

794 
size_t
 
buff_size
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
®ÉßÎv_hybrid_buff_size
;

795 
size_t
 
tmp_buf_size
 = 
buff_size
 - (
m”ge_buf_size
 + (
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
));

796 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_sk
->
b¬gs
.
¬gs
.
d¡
.
šfo_v
.
d©©y³
);

797 
ucc_¿nk_t
 
£ndto
, 
»cväom
;

798 
node_edge_id
, 
¡•
, 
i
, 
i¡•
, 
¡•_h—d”_size
, 
¡•_buf_size
;

799 
size_t
 
¢d_couÁ
, 
£nd_size
;

800 *
p_tmp_»cv_»giÚ
, *
p_tmp_£nd_»giÚ
, *
buf
;

801 
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
 *
m‘a
;

802 
ucc_¡©us_t
 
¡©us
;

804 
i¡•
 = 1;

805 
i
 = 1; i < 
sk
->
®ÉßÎv_hybrid
.
™”©iÚ
; i++) {

806 
i¡•
 *ğ
¿dix
;

812 
¡•
 = 
i¡•
; s‹°< 
gsize
; s‹°*ğ
¿dix
) {

813 (
sk
->
®ÉßÎv_hybrid
.
pha£
 =ğ
UCC_ALLTOALLV_HYBRID_PHASE_START
) ||

814 (
sk
->
®ÉßÎv_hybrid
.
pha£
 =ğ
UCC_ALLTOALLV_HYBRID_PHASE_SENT
)) {

818 
node_edge_id
 = 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
;

819 
	`¿dix_£tup
(
sk
, 
node_edge_id
 - 1, 
gsize
, 
m”ge_buf_size
,

820 &
m‘a
, &
p_tmp_£nd_»giÚ
, &
p_tmp_»cv_»giÚ
);

822 
¢d_couÁ
 = 
	`g‘_£nd_block_couÁ
(
gsize
, 
¿dix
, 
node_edge_id
, 
¡•
);

823 ià(!
¢d_couÁ
) {

824 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
++;

825 ià(
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
 =ğ
¿dix
) {

826 
sk
->
®ÉßÎv_hybrid
.
pha£
 = 
UCC_ALLTOALLV_HYBRID_PHASE_RECV
;

827 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
 = 1;

833 
£ndto
 = 
	`g‘_bruck_£nd_³”
(
g¿nk
, 
gsize
, 
¡•
, 
node_edge_id
);

834 
»cväom
 = 
	`g‘_bruck_»cv_³”
(
g¿nk
, 
gsize
, 
¡•
, 
node_edge_id
);

837 
¡•_h—d”_size
 = 
	`ÿlcuÏ‹_h—d_size
(
¢d_couÁ
, 
dt_size
) * dt_size;

838 
¡•_buf_size
 = (
£nd_lim™
 * 
¢d_couÁ
è+ 
¡•_h—d”_size
;

839 ià(
sk
->
®ÉßÎv_hybrid
.
pha£
 =ğ
UCC_ALLTOALLV_HYBRID_PHASE_START
) {

844 
¡©us
 = 
	`g‘_£nd_bufãr
(
p_tmp_£nd_»giÚ
, 
m‘a
, 
NUM_BINS
,

845 
¡•_buf_size
, 
sk
, &
buf
);

846 ià(
UCC_OK
 !ğ
¡©us
) {

847 
sk
->
su³r
.
¡©us
 = status;

848 
out
;

852 
£nd_size
 = 
	`·ck_£nd_d©a
(
sk
, 
¡•
, 
¢d_couÁ
, 
node_edge_id
,

853 
dt_size
, 
£nd_lim™
,

854 
¡•_h—d”_size
, 
buf
);

855 
	`ucc_as£¹
(
¡•_buf_size
 >ğ
£nd_size
);

856 
m‘a
->
bšs
[m‘a->
cur_bš
].
Ën
 = 
£nd_size
;

858 
¡©us
 = 
	`£nd_d©a
(
buf
, 
£nd_size
, 
£ndto
, 
m‘a
, 
sk
);

859 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

860 
sk
->
su³r
.
¡©us
 = status;

861 
out
;

865 
¡©us
 = 
	`po¡_»cv
(
»cväom
, 
gsize
, 
dt_size
, 
node_edge_id
,

866 
¡•
, 
g¿nk
, 
İ_m‘ad©a
, 
tmp_buf_size
, 
£g_¡
,

867 
m‘a
, 
¡•_buf_size
, 
By‹sFÜPackšg
,

868 
p_tmp_»cv_»giÚ
, 
sk
);

869 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

870 
sk
->
su³r
.
¡©us
 = status;

871 
out
;

875 
¡©us
 = 
	`com¶‘e_cu¼’t_¡•_»ûives
(
gsize
, 
¡•
, 
dt_size
, 
g¿nk
,

876 
İ_m‘ad©a
, 
£g_¡
, 
sk
);

877 ià(
UCC_OK
 !ğ
¡©us
) {

878 
sk
->
su³r
.
¡©us
 = status;

879 
out
;

881 
sk
->
®ÉßÎv_hybrid
.
pha£
 = 
UCC_ALLTOALLV_HYBRID_PHASE_START
;

882 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
 = 1;

883 
sk
->
®ÉßÎv_hybrid
.
™”©iÚ
++;

888 (
sk
->
®ÉßÎv_hybrid
.
num2»cv
 > 0) ||

889 (
sk
->
®ÉßÎv_hybrid
.
num2£nd
 > 0)) {

890 
¡©us
 = 
	`·œwi£_mªag”
(
g¿nk
, 
gsize
, 
dt_size
, 
sk
);

891 ià(
UCC_OK
 !ğ
¡©us
) {

892 
sk
->
su³r
.
¡©us
 = status;

893 
out
;

897 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

901 
	`hybrid_»v”£_rÙ©iÚ
(
sk
);

902 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

903 
out
:

904 ià(
sk
->
su³r
.
¡©us
 !ğ
UCC_INPROGRESS
) {

905 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
,

908 
	}
}

910 
šlše
 
	$m‘a_š™
(
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
* 
m‘a
,

911 
ucc__uı_sk_t
 *
sk
)

913 
i
;

915 
m‘a
->
cur_bš
 = 0;

916 
m‘a
->
off£t
 = 0;

917 
i
 = 0; i < 
NUM_BINS
; i++) {

918 
m‘a
->
bšs
[
i
].
Ën
 = 0;

919 
m‘a
->
bšs
[
i
].
sk
 =ask;

921 
	}
}

923 
šlše
 
	$cİy_brucks_rÙ©iÚ
(*
sü©ch
,

924 *
scouÁs
, *
sdi¥s
,

925 
ucc_¿nk_t
 
Œªk
, ucc_¿nk_ˆ
tsize
)

928 
size_t
 
size
 = ();

930 
	`memıy
(
sü©ch
, 
	`PTR_OFFSET
(
sdi¥s
, 
Œªk
 * 
size
), (
tsize
 -rank) * size);

931 
	`memıy
(
	`PTR_OFFSET
(
sü©ch
, 
tsize
 * 
size
), PTR_OFFSET(
scouÁs
, 
Œªk
 * size),

932 (
tsize
 - 
Œªk
è* 
size
);

934 ià(
Œªk
 != 0) {

935 
	`memıy
(
	`PTR_OFFSET
(
sü©ch
, (
tsize
 - 
Œªk
è* 
size
), 
sdi¥s
,rank * size);

936 
	`memıy
(
	`PTR_OFFSET
(
sü©ch
, (
tsize
 - 
Œªk
 +sizeè* 
size
), 
scouÁs
,

937 
Œªk
 * 
size
);

939 
	}
}

941 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎv_hybrid_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

943 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

944 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

945 
ušt32_t
 
¿dix
 = 
sk
->
®ÉßÎv_hybrid
.radix;

946 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

947 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

948 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

949 
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
 *
lbm
;

950 
i
;

952 
lbm
 = 
	`TASK_LB
(
sk
, 
tsize
);

953 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_alltoallv_hybrid_start",

955 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

956 
	`cİy_brucks_rÙ©iÚ
(
sk
->
®ÉßÎv_hybrid
.
sü©ch_mc_h—d”
->
addr
,

957 
¬gs
->
¤c
.
šfo_v
.
couÁs
,‡rgs->¤c.šfo_v.
di¥Ïûm’ts
,

958 
Œªk
, 
tsize
);

960 
sk
->
®ÉßÎv_hybrid
.
num_š
 = 0;

961 
sk
->
®ÉßÎv_hybrid
.
cur_out
 = 1;

962 
sk
->
®ÉßÎv_hybrid
.
cur_¿dix
 = 1;

963 
sk
->
®ÉßÎv_hybrid
.
Œaffic_š
 = 0;

964 
sk
->
®ÉßÎv_hybrid
.
Œaffic_out
 = 0;

965 
sk
->
®ÉßÎv_hybrid
.
num2£nd
 = 0;

966 
sk
->
®ÉßÎv_hybrid
.
num2»cv
 = 0;

967 
sk
->
®ÉßÎv_hybrid
.
pha£
 = 
UCC_ALLTOALLV_HYBRID_PHASE_START
;

968 
sk
->
®ÉßÎv_hybrid
.
™”©iÚ
 = 1;

970 
	`mem£t
(
	`TASK_SEG
(
sk
, 
tsize
), 0,size * ());

971 
i
 = 0; i < 
¿dix
 - 1; ++i) {

972 
	`m‘a_š™
(&
lbm
[
i
], 
sk
);

974  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

975 
	}
}

977 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎv_hybrid_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

978 
ucc_ba£_‹am_t
 *
‹am
,

979 
ucc_cŞl_sk_t
 **
sk_h
)

981 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

982 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

983 
ušt32_t
 
¿dix
 = 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
®ÉßÎv_hybrid_¿dix
;

984 
size_t
 
buff_size
 = 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
®ÉßÎv_hybrid_buff_size
;

985 
ušt32_t
 
¢d_size
 = 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
®ÉßÎv_hybrid_num_sü©ch_£nds
;

986 
ušt32_t
 
rcv_size
 = 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
®ÉßÎv_hybrid_num_sü©ch_»cvs
;

987 
ucc__uı_sk_t
 *
sk
;

988 
size_t
 
sü©ch_size
, 
ÿlc_lim™
, 
max_¢d_couÁ
, 
dt_size
;

989 
ucc_¡©us_t
 
¡©us
;

991 ià(
	`UCC_COLL_ARGS_DISPL64
(&
cŞl_¬gs
->
¬gs
) ||

992 
	`UCC_COLL_ARGS_COUNT64
(&
cŞl_¬gs
->
¬gs
) ||

993 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo_v
.
mem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
 ||

994 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo_v
.
mem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
) {

995  
UCC_ERR_NOT_SUPPORTED
;

998 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

999 ià(
	`ucc_uÆik–y
(!
sk
)) {

1000  
UCC_ERR_NO_MEMORY
;

1002 
sk
->
su³r
.
po¡
 = 
ucc__uı_®ÉßÎv_hybrid_¡¬t
;

1003 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®ÉßÎv_hybrid_´og»ss
;

1004 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_®ÉßÎv_hybrid_fš®ize
;

1006 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
->
¬gs
.
d¡
.
šfo_v
.
d©©y³
);

1008 
sk
->
®ÉßÎv_hybrid
.
¿dix
 =„adix;

1009 
sü©ch_size
 = 2 * 
tsize
 * ()

1010 + 2 * 
tsize
 * ()

1011 + 
tsize
 * (*)

1012 + (
¿dix
 - 1è* (
ucc__uı_®ÉßÎv_hybrid_buf_m‘a_t
)

1013 + 
	`ucc_div_round_up
(
tsize
, 2) * (*)

1014 + (
¿dix
 - 1è* 
buff_size
;

1016 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
®ÉßÎv_hybrid
.
sü©ch_mc_h—d”
,

1017 
sü©ch_size
, 
UCC_MEMORY_TYPE_HOST
);

1018 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

1019 
	`ucc__uı_put_sk
(
sk
);

1020  
¡©us
;

1024 
max_¢d_couÁ
 = 
	`ucc_û
(
tsize
, 
¿dix
) /„adix;

1026 
ÿlc_lim™
 = ((
buff_size
 - 256è/ (
¢d_size
 + 
rcv_size
) -

1027 
	`ucc_û
((è* (
max_¢d_couÁ
 + 1), 
dt_size
)) / max_snd_count;

1028 
ÿlc_lim™
 -= (calc_limit % 4);

1029 
	`ucc_as£¹
(
ÿlc_lim™
 > 0);

1030 
sk
->
®ÉßÎv_hybrid
.
by‹_£nd_lim™
 = 
ÿlc_lim™
;

1031 
sk
->
®ÉßÎv_hybrid
.
m”ge_buf_size
 =

1032 
	`ALIGN
((
ÿlc_lim™
*
max_¢d_couÁ
 + 
	`ucc_û
((è* (max_¢d_couÁ + 1), 
dt_size
)è* 
¢d_size
);

1034 *
sk_h
 = &
sk
->
su³r
;

1035  
UCC_OK
;

1036 
	}
}

	@src/components/tl/ucp/alltoallv/alltoallv_onesided.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®ÉßÎv.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"_uı_£nd»cv.h
"

14 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎv_Úesided_¡¬t
(
ucc_cŞl_sk_t
 *
ùask
)

16 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
ùask
, ucc_tl_ucp_task_t);

17 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

18 
±rdiff_t
 
¤c
 = (±rdiff_t)
	`TASK_ARGS
(
sk
).¤c.
šfo_v
.
bufãr
;

19 
±rdiff_t
 
de¡
 = (±rdiff_t)
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
bufãr
;

20 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

21 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

22 *
pSync
 = 
	`TASK_ARGS
(
sk
).
glob®_wÜk_bufãr
;

23 
ucc_ašt_t
 *
s_di¥
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
di¥Ïûm’ts
;

24 
ucc_ašt_t
 *
d_di¥
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
di¥Ïûm’ts
;

25 
size_t
 
sdt_size
 = 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
d©©y³
);

26 
size_t
 
rdt_size
 = 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
d©©y³
);

27 
ucc_mem_m­_mem_h
 
¤c_memh
 = 
	`TASK_ARGS
(
sk
).¤c_memh.
loÿl_memh
;

28 
ucc_mem_m­_mem_h
 *
d¡_memh
 = 
	`TASK_ARGS
(
sk
).d¡_memh.
glob®_memh
;

29 
ucc_¿nk_t
 
³”
;

30 
size_t
 
sd_di¥
, 
dd_di¥
, 
d©a_size
;

32 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

36 
³”
 = (
g¿nk
 + 1è% 
gsize
; 
sk
->
Úesided
.
put_po¡ed
 < gsize;

37 
³”
 = (³” + 1è% 
gsize
) {

38 
sd_di¥
 =

39 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(&
	`TASK_ARGS
(
sk
), 
s_di¥
, 
³”
) *

40 
sdt_size
;

41 
dd_di¥
 =

42 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(&
	`TASK_ARGS
(
sk
), 
d_di¥
, 
³”
) *

43 
rdt_size
;

44 
d©a_size
 =

45 
	`ucc_cŞl_¬gs_g‘_couÁ
(

46 &
	`TASK_ARGS
(
sk
), TASK_ARGSÑask).
¤c
.
šfo_v
.
couÁs
, 
³”
) *

47 
sdt_size
;

49 
	`UCPCHECK_GOTO
(
	`ucc__uı_put_nb
(
	`PTR_OFFSET
(
¤c
, 
sd_di¥
),

50 
	`PTR_OFFSET
(
de¡
, 
dd_di¥
),

51 
d©a_size
, 
³”
, 
¤c_memh
,

52 
d¡_memh
, 
‹am
, 
sk
),

53 
sk
, 
out
);

54 
	`UCPCHECK_GOTO
(
	`ucc__uı_©omic_šc
(
pSync
, 
³”
,

55 
d¡_memh
, 
‹am
),

56 
sk
, 
out
);

58  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

59 
out
:

60  
sk
->
su³r
.
¡©us
;

61 
	}
}

63 
	$ucc__uı_®ÉßÎv_Úesided_´og»ss
(
ucc_cŞl_sk_t
 *
ùask
)

65 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
ùask
, ucc_tl_ucp_task_t);

66 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

67 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

68 *
pSync
 = 
	`TASK_ARGS
(
sk
).
glob®_wÜk_bufãr
;

70 ià(
	`ucc__uı_‹¡_Úesided
(
sk
, 
gsize
è=ğ
UCC_INPROGRESS
) {

74 
pSync
[0] = 0;

75 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

76 
	}
}

78 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎv_Úesided_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

79 
ucc_ba£_‹am_t
 *
‹am
,

80 
ucc_cŞl_sk_t
 **
sk_h
)

82 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

83 
ucc__uı_sk_t
 *
sk
;

84 
ucc_¡©us_t
 
¡©us
;

86 
	`ALLTOALLV_TASK_CHECK
(
cŞl_¬gs
->
¬gs
, 
_‹am
);

87 ià(!(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
)) {

88 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

90 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

91 
out
;

93 ià(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) {

94 ià(!(
cŞl_¬gs
->
¬gs
.
æags
 & 
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
)) {

95 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

97 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

98 
out
;

101 ià(!(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_MEM_MAP_SRC_MEMH
)) {

102 
cŞl_¬gs
->
¬gs
.
¤c_memh
.
glob®_memh
 = 
NULL
;

104 ià(!(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_MEM_MAP_DST_MEMH
)) {

105 
cŞl_¬gs
->
¬gs
.
d¡_memh
.
glob®_memh
 = 
NULL
;

108 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

109 *
sk_h
 = &
sk
->
su³r
;

110 
sk
->
su³r
.
po¡
 = 
ucc__uı_®ÉßÎv_Úesided_¡¬t
;

111 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®ÉßÎv_Úesided_´og»ss
;

112 
¡©us
 = 
UCC_OK
;

113 
out
:

114  
¡©us
;

115 
	}
}

	@src/components/tl/ucp/alltoallv/alltoallv_pairwise.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"®ÉßÎv.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"_uı_£nd»cv.h
"

16 
	#NP_THRESH
 32

	)

18 
šlše
 
ucc_¿nk_t
 
	$g‘_»cv_³”
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
,

19 
ucc_¿nk_t
 
¡•
)

21  (
¿nk
 + 
¡•
è% 
size
;

22 
	}
}

24 
šlše
 
ucc_¿nk_t
 
	$g‘_£nd_³”
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
,

25 
ucc_¿nk_t
 
¡•
)

27  (
¿nk
 - 
¡•
 + 
size
) % size;

28 
	}
}

30 
ucc_¿nk_t
 
	$g‘_num_po¡s
(cÚ¡ 
ucc__uı_‹am_t
 *
‹am
)

32 
po¡s
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
®ÉßÎv_·œwi£_num_po¡s
;

33 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

35 ià(
po¡s
 =ğ
UCC_ULUNITS_AUTO
) {

36 ià(
	`UCC_TL_TEAM_SIZE
(
‹am
è<ğ
NP_THRESH
) {

38 
po¡s
 = 0;

41 
po¡s
 = 1;

45 
po¡s
 = (po¡ > 
tsize
 ||…osts == 0) ?size:…osts;

46  
po¡s
;

47 
	}
}

49 
	$ucc__uı_®ÉßÎv_·œwi£_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

51 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

52 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

53 
±rdiff_t
 
sbuf
 = (±rdiff_t)
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
bufãr
;

54 
±rdiff_t
 
rbuf
 = (±rdiff_t)
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
bufãr
;

55 
ucc_memÜy_ty³_t
 
smem
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
mem_ty³
;

56 
ucc_memÜy_ty³_t
 
rmem
 = 
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
mem_ty³
;

57 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

58 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

59 
pŞls
 = 0;

60 
ucc_¿nk_t
 
³”
, 
Äeqs
;

61 
size_t
 
rdt_size
, 
sdt_size
, 
d©a_size
, 
d©a_di¥l
;

63 
Äeqs
 = 
	`g‘_num_po¡s
(
‹am
);

64 
rdt_size
 = 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
d©©y³
);

65 
sdt_size
 = 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
d©©y³
);

66 (
sk
->
gged
.
£nd_po¡ed
 < 
gsize
 ||

67 
sk
->
gged
.
»cv_po¡ed
 < 
gsize
) &&

68 (
pŞls
++ < 
sk
->
n_pŞls
)) {

69 
	`uı_wÜk”_´og»ss
(
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
wÜk”
.
uı_wÜk”
);

70 (
sk
->
gged
.
»cv_po¡ed
 < 
gsize
) &&

71 ((
sk
->
gged
.
»cv_po¡ed
 -ask->gged.
»cv_com¶‘ed
) <

72 
Äeqs
)) {

73 
³”
 = 
	`g‘_»cv_³”
(
g¿nk
, 
gsize
, 
sk
->
gged
.
»cv_po¡ed
);

74 
d©a_size
 =

75 
	`ucc_cŞl_¬gs_g‘_couÁ
(

76 &
	`TASK_ARGS
(
sk
), TASK_ARGSÑask).
d¡
.
šfo_v
.
couÁs
, 
³”
) *

77 
rdt_size
;

78 
d©a_di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

79 &
	`TASK_ARGS
(
sk
),

80 
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
³”
) *

81 
rdt_size
;

82 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nz
((*)(
rbuf
 + 
d©a_di¥l
),

83 
d©a_size
, 
rmem
, 
³”
, 
‹am
, 
sk
),

84 
sk
, 
out
);

85 
pŞls
 = 0;

87 (
sk
->
gged
.
£nd_po¡ed
 < 
gsize
) &&

88 ((
sk
->
gged
.
£nd_po¡ed
 -ask->gged.
£nd_com¶‘ed
) <

89 
Äeqs
)) {

90 
³”
 = 
	`g‘_£nd_³”
(
g¿nk
, 
gsize
, 
sk
->
gged
.
£nd_po¡ed
);

91 
d©a_size
 =

92 
	`ucc_cŞl_¬gs_g‘_couÁ
(

93 &
	`TASK_ARGS
(
sk
), TASK_ARGSÑask).
¤c
.
šfo_v
.
couÁs
, 
³”
) *

94 
sdt_size
;

95 
d©a_di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

96 &
	`TASK_ARGS
(
sk
),

97 
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
di¥Ïûm’ts
, 
³”
) *

98 
sdt_size
;

99 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nz
((*)(
sbuf
 + 
d©a_di¥l
),

100 
d©a_size
, 
smem
, 
³”
, 
‹am
, 
sk
),

101 
sk
, 
out
);

102 
pŞls
 = 0;

105 ià((
sk
->
gged
.
£nd_po¡ed
 < 
gsize
) ||

106 (
sk
->
gged
.
»cv_po¡ed
 < 
gsize
)) {

109 
sk
->
su³r
.
¡©us
 = 
	`ucc__uı_‹¡
(task);

110 
out
:

111 ià(
sk
->
su³r
.
¡©us
 !ğ
UCC_INPROGRESS
) {

112 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
,

115 
	}
}

117 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎv_·œwi£_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

119 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

120 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

122 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_alltoallv_pairwise_start",

124 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

125  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

126 
	}
}

128 
ucc_¡©us_t
 
	$ucc__uı_®ÉßÎv_·œwi£_š™_commÚ
(
ucc__uı_sk_t
 *
sk
)

130 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

131 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

132 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

134 
sk
->
su³r
.
po¡
 = 
ucc__uı_®ÉßÎv_·œwi£_¡¬t
;

135 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®ÉßÎv_·œwi£_´og»ss
;

137 
sk
->
n_pŞls
 = 
	`ucc_max
(1,ask->n_polls);

138 ià(
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
cfg
.
´e_»g_mem
) {

139 ià(
¬gs
->
æags
 & 
UCC_COLL_ARGS_FLAG_CONTIG_SRC_BUFFER
) {

140 
	`ucc__uı_´e_»gi¡”_mem
(

141 
‹am
, 
¬gs
->
¤c
.
šfo_v
.
bufãr
,

142 (
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
,

143 
size
) *

144 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
)),

145 
¬gs
->
¤c
.
šfo_v
.
mem_ty³
);

148 ià(
¬gs
->
æags
 & 
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
) {

149 
	`ucc__uı_´e_»gi¡”_mem
(

150 
‹am
, 
¬gs
->
d¡
.
šfo_v
.
bufãr
,

151 (
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
,

152 
size
) *

153 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
)),

154 
¬gs
->
d¡
.
šfo_v
.
mem_ty³
);

157  
UCC_OK
;

158 
	}
}

	@src/components/tl/ucp/barrier/barrier.c

6 
	~"cÚfig.h
"

7 
	~"_uı.h
"

8 
	~"b¬r›r.h
"

10 
ucc_¡©us_t
 
ucc__uı_b¬r›r_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

11 
ucc__uı_b¬r›r_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

13 
ucc_ba£_cŞl_®g_šfo_t


14 
	gucc__uı_b¬r›r_®gs
[
UCC_TL_UCP_BARRIER_ALG_LAST
 + 1] = {

15 [
UCC_TL_UCP_BARRIER_ALG_KNOMIAL
] =

16 {.
id
 = 
UCC_TL_UCP_BARRIER_ALG_KNOMIAL
,

17 .
	gÇme
 = "knomial",

18 .
	gdesc
 = "recursive knomial with‡rbitrary„adix"},

19 [
UCC_TL_UCP_BARRIER_ALG_LAST
] = {

20 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

22 
ucc_¡©us_t
 
	$ucc__uı_b¬r›r_š™
(
ucc__uı_sk_t
 *
sk
)

24 
sk
->
su³r
.
po¡
 = 
ucc__uı_b¬r›r_knomŸl_¡¬t
;

25 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_b¬r›r_knomŸl_´og»ss
;

26  
UCC_OK
;

27 
	}
}

	@src/components/tl/ucp/barrier/barrier.h

6 #iâdeà
BARRIER_H_


7 
	#BARRIER_H_


	)

8 
	~"../_uı.h
"

9 
	~"../_uı_cŞl.h
"

12 
	mUCC_TL_UCP_BARRIER_ALG_KNOMIAL
,

13 
	mUCC_TL_UCP_BARRIER_ALG_LAST


16 
ucc_ba£_cŞl_®g_šfo_t


17 
ucc__uı_b¬r›r_®gs
[
UCC_TL_UCP_BARRIER_ALG_LAST
 + 1];

19 
ucc_¡©us_t
 
ucc__uı_b¬r›r_š™
(
ucc__uı_sk_t
 *
sk
);

	@src/components/tl/ucp/barrier/barrier_knomial.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"b¬r›r.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"_uı_£nd»cv.h
"

12 
	~"cŞl_·‰”ns/»cursive_knomŸl.h
"

13 
	~"uts/ucc_m©h.h
"

15 
	#SAVE_STATE
(
_pha£
) \

17 
sk
->
b¬r›r
.
pha£
 = 
_pha£
; \

18 } 0)

	)

20 
	$ucc__uı_b¬r›r_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

22 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

23 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

24 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

25 
ucc_kn_¿dix_t
 
¿dix
 = 
sk
->
b¬r›r
.
p
.radix;

26 
ušt8_t
 
node_ty³
 = 
sk
->
b¬r›r
.
p
.node_type;

27 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
b¬r›r
.p;

28 
ucc_memÜy_ty³_t
 
mty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

29 
ucc_¿nk_t
 
³”
;

30 
ucc_kn_¿dix_t
 
loİ_¡•
;

33 
	`UCC_KN_GOTO_PHASE
(
sk
->
b¬r›r
.
pha£
);

34 ià(
KN_NODE_EXTRA
 =ğ
node_ty³
) {

35 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_´oxy
(
p
, 
¿nk
);

36 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
NULL
, 0, 
mty³
, 
³”
, 
‹am
, 
sk
),

37 
sk
, 
out
);

38 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
NULL
, 0, 
mty³
, 
³”
, 
‹am
, 
sk
),

39 
sk
, 
out
);

42 ià(
KN_NODE_PROXY
 =ğ
node_ty³
) {

43 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_exŒa
(
p
, 
¿nk
);

44 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
NULL
, 0, 
mty³
, 
³”
, 
‹am
, 
sk
),

45 
sk
, 
out
);

47 
UCC_KN_PHASE_EXTRA
:

48 ià(
KN_NODE_PROXY
 =ğ
node_ty³
 || 
KN_NODE_EXTRA
 ==‚ode_type) {

49 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

50 
	`SAVE_STATE
(
UCC_KN_PHASE_EXTRA
);

53 ià(
KN_NODE_EXTRA
 =ğ
node_ty³
) {

54 
com¶‘iÚ
;

58 !
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

59 
loİ_¡•
 = 1;†oİ_¡• < 
¿dix
;†oop_step++) {

60 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
loİ_¡•
);

61 ià(
³”
 =ğ
UCC_KN_PEER_NULL
)

63 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
NULL
, 0, 
mty³
, 
³”
, 
‹am
, 
sk
),

64 
sk
, 
out
);

67 
loİ_¡•
 = 1;†oİ_¡• < 
¿dix
;†oop_step++) {

68 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
loİ_¡•
);

69 ià(
³”
 =ğ
UCC_KN_PEER_NULL
)

71 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
NULL
, 0, 
mty³
, 
³”
, 
‹am
, 
sk
),

72 
sk
, 
out
);

74 
UCC_KN_PHASE_LOOP
:

75 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

76 
	`SAVE_STATE
(
UCC_KN_PHASE_LOOP
);

79 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ
(
p
);

81 ià(
KN_NODE_PROXY
 =ğ
node_ty³
) {

82 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_exŒa
(
p
, 
¿nk
);

83 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
NULL
, 0, 
mty³
, 
³”
, 
‹am
, 
sk
),

84 
sk
, 
out
);

85 
UCC_KN_PHASE_PROXY
;

87 
com¶‘iÚ
;

90 
UCC_KN_PHASE_PROXY
:

91 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

92 
	`SAVE_STATE
(
UCC_KN_PHASE_PROXY
);

96 
com¶‘iÚ
:

97 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

98 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

99 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_barrier_kn_done", 0);

100 
out
:

102 
	}
}

104 
ucc_¡©us_t
 
	$ucc__uı_b¬r›r_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

106 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

107 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

108 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

109 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

111 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_barrier_kn_start", 0);

112 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

113 
sk
->
b¬r›r
.
pha£
 = 
UCC_KN_PHASE_INIT
;

114 
	`ucc_knomŸl_·‰”n_š™
(
size
, 
¿nk
,

115 
	`ucc_mš
(
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->

116 
cfg
.
b¬r›r_kn_¿dix
, 
size
),

117 &
sk
->
b¬r›r
.
p
);

118  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

119 
	}
}

	@src/components/tl/ucp/bcast/bcast.c

6 
	~"cÚfig.h
"

7 
	~"_uı.h
"

8 
	~"bÿ¡.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__uı_bÿ¡_®gs
[
UCC_TL_UCP_BCAST_ALG_LAST
 + 1] = {

12 [
UCC_TL_UCP_BCAST_ALG_KNOMIAL
] =

13 {.
id
 = 
UCC_TL_UCP_BCAST_ALG_KNOMIAL
,

14 .
	gÇme
 = "knomial",

15 .
	gdesc
 = "bcast over knomialree with‡rbitrary„adix "

17 [
UCC_TL_UCP_BCAST_ALG_SAG_KNOMIAL
] =

18 {.
id
 = 
UCC_TL_UCP_BCAST_ALG_SAG_KNOMIAL
,

19 .
	gÇme
 = "sag_knomial",

20 .
	gdesc
 = "recursive knomial scatter followed by knomial "

22 [
UCC_TL_UCP_BCAST_ALG_DBT
] =

23 {.
id
 = 
UCC_TL_UCP_BCAST_ALG_DBT
,

24 .
	gÇme
 = "dbt",

25 .
	gdesc
 = "bcast over double binaryree where‡†eaf in oneree "

27 [
UCC_TL_UCP_BCAST_ALG_LAST
] = {

28 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

30 
ucc_¡©us_t
 
	$ucc__uı_bÿ¡_š™
(
ucc__uı_sk_t
 *
sk
)

32 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

33 
ucc_¿nk_t
 
‹am_size
 = (ucc_¿nk_t)
sk
->
sub£t
.
m­
.
•_num
;

35 
sk
->
bÿ¡_kn
.
¿dix
 =

36 
	`ucc_mš
(
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
bÿ¡_kn_¿dix
, 
‹am_size
);

38 
sk
->
su³r
.
po¡
 = 
ucc__uı_bÿ¡_knomŸl_¡¬t
;

39 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_bÿ¡_knomŸl_´og»ss
;

40  
UCC_OK
;

41 
	}
}

43 
ucc_¡©us_t
 
	$ucc__uı_bÿ¡_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

44 
ucc_ba£_‹am_t
 *
‹am
,

45 
ucc_cŞl_sk_t
 **
sk_h
)

47 
ucc__uı_sk_t
 *
sk
;

48 
ucc_¡©us_t
 
¡©us
;

50 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

51 
¡©us
 = 
	`ucc__uı_bÿ¡_š™
(
sk
);

52 *
sk_h
 = &
sk
->
su³r
;

53  
¡©us
;

54 
	}
}

	@src/components/tl/ucp/bcast/bcast.h

6 #iâdeà
BCAST_H_


7 
	#BCAST_H_


	)

8 
	~"../_uı.h
"

9 
	~"../_uı_cŞl.h
"

12 
	mUCC_TL_UCP_BCAST_ALG_KNOMIAL
,

13 
	mUCC_TL_UCP_BCAST_ALG_SAG_KNOMIAL
,

14 
	mUCC_TL_UCP_BCAST_ALG_DBT
,

15 
	mUCC_TL_UCP_BCAST_ALG_LAST


18 
ucc_ba£_cŞl_®g_šfo_t


19 
ucc__uı_bÿ¡_®gs
[
UCC_TL_UCP_BCAST_ALG_LAST
 + 1];

22 
	#UCC_TL_UCP_BCAST_DEFAULT_ALG_SELECT_STR
 \

23 "bÿ¡:0-šf:[2-2]:@0#bÿ¡:0-32k:[3-šf]:@0#bÿ¡:32k-šf:[3-šf]:@1"

	)

25 
šlše
 
	$ucc__uı_bÿ¡_®g_äom_¡r
(cÚ¡ *
¡r
)

27 
i
;

28 
i
 = 0; i < 
UCC_TL_UCP_BCAST_ALG_LAST
; i++) {

29 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__uı_bÿ¡_®gs
[
i
].
Çme
)) {

33  
i
;

34 
	}
}

36 
ucc_¡©us_t
 
ucc__uı_bÿ¡_š™
(
ucc__uı_sk_t
 *
sk
);

38 
ucc_¡©us_t


39 
ucc__uı_bÿ¡_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

40 
ucc_ba£_‹am_t
 *
‹am
, 
ucc_cŞl_sk_t
 **
sk_h
);

42 
ucc__uı_bÿ¡_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

44 
ucc_¡©us_t


45 
ucc__uı_bÿ¡_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

47 
ucc_¡©us_t


48 
ucc__uı_bÿ¡_§g_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

49 
ucc_ba£_‹am_t
 *
‹am
, 
ucc_cŞl_sk_t
 **
sk_h
);

51 
ucc_¡©us_t
 
ucc__uı_bÿ¡_dbt_š™
(

52 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

53 
ucc_cŞl_sk_t
 **
sk_h
);

	@src/components/tl/ucp/bcast/bcast_dbt.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"bÿ¡.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"_uı_£nd»cv.h
"

14 
	mRECV
,

15 
	mSEND_T1
,

16 
	mSEND_T2
,

17 
	mTEST
,

20 
	#UCC_BCAST_DBT_CHECK_STATE
(
_p
) \

21 
_p
: \

22 
_p
;

	)

24 
	#UCC_BCAST_DBT_GOTO_STATE
(
_¡©e
) \

26 
_¡©e
) { \

27 
	`UCC_BCAST_DBT_CHECK_STATE
(
SEND_T1
); \

28 
	`UCC_BCAST_DBT_CHECK_STATE
(
SEND_T2
); \

29 
	`UCC_BCAST_DBT_CHECK_STATE
(
TEST
); \

31 } 0)

	)

33 
	$»cv_com¶‘iÚ_commÚ
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

34 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

35 *
u£r_d©a
)

37 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

38 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

39 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in„ecv completion %s",

40 
	`ucs_¡©us_¡ršg
(
¡©us
));

41 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

43 
	`ucc_©omic_add32
(&
sk
->
gged
.
»cv_com¶‘ed
, 1);

44 ià(
»que¡
) {

45 
	`uı_»que¡_ä“
(
»que¡
);

47 
	}
}

49 
	$»cv_com¶‘iÚ_1
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

50 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

51 *
u£r_d©a
)

53 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

55 
sk
->
bÿ¡_dbt
.
t1
.
»cv
++;

56 
	`»cv_com¶‘iÚ_commÚ
(
»que¡
, 
¡©us
, 
šfo
, 
u£r_d©a
);

57 
	}
}

59 
	$»cv_com¶‘iÚ_2
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

60 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

61 *
u£r_d©a
)

63 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

65 
sk
->
bÿ¡_dbt
.
t2
.
»cv
++;

66 
	`»cv_com¶‘iÚ_commÚ
(
»que¡
, 
¡©us
, 
šfo
, 
u£r_d©a
);

68 
	}
}

70 
	$ucc__uı_bÿ¡_dbt_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

72 
ušt32_t
 
i
;

73 
ucc__uı_sk_t
 *
sk
 =

74 
	`ucc_d”ived_of
(
cŞl_sk
, 
ucc__uı_sk_t
);

75 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

76 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

77 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

78 
ucc_dbt_sšgË_Œ“_t
 
t1
 = 
sk
->
bÿ¡_dbt
.t1;

79 
ucc_dbt_sšgË_Œ“_t
 
t2
 = 
sk
->
bÿ¡_dbt
.t2;

80 *
bufãr
 = 
¬gs
->
¤c
.
šfo
.buffer;

81 
ucc_memÜy_ty³_t
 
mty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

82 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

83 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

84 
size_t
 
couÁ_t1
 = (
couÁ
 % 2) ? count / 2 + 1

85 : 
couÁ
 / 2;

86 
size_t
 
d©a_size_t1
 = 
couÁ_t1
 * 
	`ucc_dt_size
(
dt
);

87 
size_t
 
d©a_size_t2
 = 
couÁ
 / 2 * 
	`ucc_dt_size
(
dt
);

88 
ucc_¿nk_t
 
cŞl_roÙ
 = (ucc_¿nk_t)
¬gs
->
roÙ
;

89 
uı_g_»cv_nbx_ÿÎback_t
 
cb
[2] = {
»cv_com¶‘iÚ_1
,

90 
»cv_com¶‘iÚ_2
};

92 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(&(
	`TASK_ARGS
(
sk
)))) {

93 
cŞl_roÙ
 = 
	`ucc_•_m­_loÿl_¿nk
(
sk
->
sub£t
.
m­
, coll_root);

96 
	`UCC_BCAST_DBT_GOTO_STATE
(
sk
->
bÿ¡_dbt
.
¡©e
);

98 ià(
¿nk
 !ğ
t1
.
roÙ
 &&„ªk !ğ
cŞl_roÙ
) {

99 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_cb
(
bufãr
, 
d©a_size_t1
, 
mty³
,

100 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

101 
t1
.
·»Á
),

102 
‹am
, 
sk
, 
cb
[0],

103 (*)
sk
),

104 
sk
, 
out
);

107 ià(
¿nk
 !ğ
t2
.
roÙ
 &&„ªk !ğ
cŞl_roÙ
) {

108 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_cb
(
	`PTR_OFFSET
(
bufãr
, 
d©a_size_t1
),

109 
d©a_size_t2
, 
mty³
,

110 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

111 
t2
.
·»Á
),

112 
‹am
,

113 
sk
, 
cb
[1], (*)task),

114 
sk
, 
out
);

116 
sk
->
bÿ¡_dbt
.
¡©e
 = 
SEND_T1
;

118 
SEND_T1
:

120 
	`ucc__uı_‹¡_»cv
(
sk
);

121 ià((
cŞl_roÙ
 =ğ
¿nk
è|| (
sk
->
bÿ¡_dbt
.
t1
.
»cv
 > 0)) {

122 
i
 = 0; i < 2; i++) {

123 ià((
t1
.
chd»n
[
i
] !ğ
UCC_RANK_INVALID
) &&

124 (
t1
.
chd»n
[
i
] !ğ
cŞl_roÙ
)) {

125 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
bufãr
, 
d©a_size_t1
, 
mty³
,

126 
	`ucc_•_m­_ev®
(

127 
sk
->
sub£t
.
m­
,

128 
t1
.
chd»n
[
i
]),

129 
‹am
, 
sk
),

130 
sk
, 
out
);

134 
out
;

136 
sk
->
bÿ¡_dbt
.
¡©e
 = 
SEND_T2
;

138 
SEND_T2
:

140 
	`ucc__uı_‹¡_»cv
(
sk
);

141 ià((
cŞl_roÙ
 =ğ
¿nk
è|| (
sk
->
bÿ¡_dbt
.
t2
.
»cv
 > 0)) {

142 
i
 = 0; i < 2; i++) {

143 ià((
t2
.
chd»n
[
i
] !ğ
UCC_RANK_INVALID
) &&

144 (
t2
.
chd»n
[
i
] !ğ
cŞl_roÙ
)) {

145 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
	`PTR_OFFSET
(
bufãr
,

146 
d©a_size_t1
),

147 
d©a_size_t2
, 
mty³
,

148 
	`ucc_•_m­_ev®
(

149 
sk
->
sub£t
.
m­
,

150 
t2
.
chd»n
[
i
]),

151 
‹am
, 
sk
),

152 
sk
, 
out
);

156 
out
;

159 
TEST
:

160 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_£nd
(
sk
)) {

161 
sk
->
bÿ¡_dbt
.
¡©e
 = 
TEST
;

165 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

166 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_bcast_dbt_done", 0);

168 
out
:

170 
	}
}

172 
ucc_¡©us_t
 
	$ucc__uı_bÿ¡_dbt_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

174 
ucc__uı_sk_t
 *
sk
 =

175 
	`ucc_d”ived_of
(
cŞl_sk
, 
ucc__uı_sk_t
);

176 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

177 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

178 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

179 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

180 *
bufãr
 = 
¬gs
->
¤c
.
šfo
.buffer;

181 
ucc_memÜy_ty³_t
 
mty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

182 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

183 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

184 
size_t
 
couÁ_t1
 = (
couÁ
 % 2) ? count / 2 + 1

185 : 
couÁ
 / 2;

186 
size_t
 
d©a_size_t1
 = 
couÁ_t1
 * 
	`ucc_dt_size
(
dt
);

187 
size_t
 
d©a_size_t2
 = 
couÁ
 / 2 * 
	`ucc_dt_size
(
dt
);

188 
ucc_¿nk_t
 
cŞl_roÙ
 = 
	`ucc_•_m­_loÿl_¿nk
(

189 
sk
->
sub£t
.
m­
,

190 (
ucc_¿nk_t
)
¬gs
->
roÙ
);

191 
ucc_¿nk_t
 
t1_roÙ
 = 
sk
->
bÿ¡_dbt
.
t1
.
roÙ
;

192 
ucc_¿nk_t
 
t2_roÙ
 = 
sk
->
bÿ¡_dbt
.
t2
.
roÙ
;

193 
uı_g_»cv_nbx_ÿÎback_t
 
cb
[2] = {
»cv_com¶‘iÚ_1
,

194 
»cv_com¶‘iÚ_2
};

196 
sk
->
bÿ¡_dbt
.
t1
.
»cv
 = 0;

197 
sk
->
bÿ¡_dbt
.
t2
.
»cv
 = 0;

198 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

200 ià(
¿nk
 =ğ
cŞl_roÙ
 && cŞl_roÙ !ğ
t1_roÙ
) {

201 
¡©us
 = 
	`ucc__uı_£nd_nb
(
bufãr
, 
d©a_size_t1
, 
mty³
,

202 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, 
t1_roÙ
),

203 
‹am
, 
sk
);

204 ià(
UCC_OK
 !ğ
¡©us
) {

205  
¡©us
;

209 ià(
¿nk
 =ğ
cŞl_roÙ
 && cŞl_roÙ !ğ
t2_roÙ
) {

210 
¡©us
 = 
	`ucc__uı_£nd_nb
(
	`PTR_OFFSET
(
bufãr
, 
d©a_size_t1
),

211 
d©a_size_t2
, 
mty³
,

212 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, 
t2_roÙ
),

213 
‹am
, 
sk
);

214 ià(
UCC_OK
 !ğ
¡©us
) {

215  
¡©us
;

219 ià(
¿nk
 !ğ
cŞl_roÙ
 &&„ªk =ğ
t1_roÙ
) {

220 
¡©us
 = 
	`ucc__uı_»cv_cb
(
bufãr
, 
d©a_size_t1
, 
mty³
,

221 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

222 
cŞl_roÙ
),

223 
‹am
, 
sk
, 
cb
[0], (*)task);

224 ià(
UCC_OK
 !ğ
¡©us
) {

225  
¡©us
;

229 ià(
¿nk
 !ğ
cŞl_roÙ
 &&„ªk =ğ
t2_roÙ
) {

230 
¡©us
 = 
	`ucc__uı_»cv_cb
(
	`PTR_OFFSET
(
bufãr
, 
d©a_size_t1
),

231 
d©a_size_t2
, 
mty³
,

232 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

233 
cŞl_roÙ
),

234 
‹am
, 
sk
, 
cb
[1], (*)task);

235 ià(
UCC_OK
 !ğ
¡©us
) {

236  
¡©us
;

240 
sk
->
bÿ¡_dbt
.
¡©e
 = 
RECV
;

241 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_bcast_dbt_start", 0);

242  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

243 
	}
}

245 
ucc_¡©us_t
 
	$ucc__uı_bÿ¡_dbt_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

247  
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

248 
	}
}

250 
ucc_¡©us_t
 
	$ucc__uı_bÿ¡_dbt_š™
(

251 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

252 
ucc_cŞl_sk_t
 **
sk_h
)

254 
ucc__uı_sk_t
 *
sk
;

255 
ucc_¿nk_t
 
¿nk
, 
size
;

257 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

258 
sk
->
su³r
.
po¡
 = 
ucc__uı_bÿ¡_dbt_¡¬t
;

259 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_bÿ¡_dbt_´og»ss
;

260 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_bÿ¡_dbt_fš®ize
;

261 
sk
->
n_pŞls
 = 
	`ucc_max
(1,ask->n_polls);

262 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

263 
size
 = (
ucc_¿nk_t
)
sk
->
sub£t
.
m­
.
•_num
;

265 
	`ucc_dbt_bud_Œ“s
(
¿nk
, 
size
, &
sk
->
bÿ¡_dbt
.
t1
,

266 &
sk
->
bÿ¡_dbt
.
t2
);

268 *
sk_h
 = &
sk
->
su³r
;

269  
UCC_OK
;

270 
	}
}

	@src/components/tl/ucp/bcast/bcast_knomial.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"bÿ¡.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"_uı_£nd»cv.h
"

12 
	~"uts/ucc_m©h.h
"

14 
	$ucc__uı_bÿ¡_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

16 
ušt32_t
 
i
;

18 
ucc_¿nk_t
 
v¿nk
;

19 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

20 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

21 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

22 
ucc_¿nk_t
 
size
 = (ucc_¿nk_t)
sk
->
sub£t
.
m­
.
•_num
;

24 
ušt32_t
 
¿dix
 = 
sk
->
bÿ¡_kn
.radix;

25 
ucc_¿nk_t
 
roÙ
 = (ucc_¿nk_t)
	`TASK_ARGS
(
sk
).root;

26 
ucc_¿nk_t
 
di¡
 = 
sk
->
bÿ¡_kn
.dist;

27 *
bufãr
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.buffer;

28 
ucc_memÜy_ty³_t
 
mty³
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
;

29 
size_t
 
d©a_size
 = 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
couÁ
 *

30 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
);

31 
ucc_¿nk_t
 
v³”
, 
³”
, 
vroÙ_©_Ëv–
, 
roÙ_©_Ëv–
, 
pos
;

33 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(&(
	`TASK_ARGS
(
sk
)))) {

34 
roÙ
 = 
	`ucc_•_m­_loÿl_¿nk
(
sk
->
sub£t
.
m­
,„oot);

37 
v¿nk
 = (
¿nk
 - 
roÙ
 + 
size
) % size;

39 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

42 
di¡
 >= 1) {

43 ià(
v¿nk
 % 
di¡
 == 0) {

44 
pos
 = (
v¿nk
 / 
di¡
è% 
¿dix
;

45 ià(
pos
 == 0) {

46 
i
 = 
¿dix
 - 1; i >= 1; i--) {

47 
v³”
 = 
v¿nk
 + 
i
 * 
di¡
;

48 ià(
v³”
 < 
size
) {

49 
³”
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

50 (
v³”
 + 
roÙ
è% 
size
);

51 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
bufãr
, 
d©a_size
,

52 
mty³
, 
³”
, 
‹am
,

53 
sk
),

54 
sk
, 
out
);

58 
vroÙ_©_Ëv–
 = 
v¿nk
 - 
pos
 * 
di¡
;

59 
roÙ_©_Ëv–
 = (
vroÙ_©_Ëv–
 + 
roÙ
è% 
size
;

60 
³”
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,

61 
roÙ_©_Ëv–
);

62 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
bufãr
, 
d©a_size
, 
mty³
,

63 
³”
, 
‹am
, 
sk
),

64 
sk
, 
out
);

67 
di¡
 /ğ
¿dix
;

68 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_»cv
(
sk
)) {

69 
sk
->
bÿ¡_kn
.
di¡
 = dist;

73 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

74 
sk
->
bÿ¡_kn
.
di¡
 = dist;

78 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

79 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

80 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_bcast_kn_done", 0);

81 
out
:

83 
	}
}

85 
ucc_¡©us_t
 
	$ucc__uı_bÿ¡_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

87 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

88 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

89 
ucc_¿nk_t
 
size
 = (ucc_¿nk_t)
sk
->
sub£t
.
m­
.
•_num
;

91 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_bcast_kn_start", 0);

92 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

94 
	`CALC_KN_TREE_DIST
(
size
, 
sk
->
bÿ¡_kn
.
¿dix
,ask->bÿ¡_kn.
di¡
);

96  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

97 
	}
}

	@src/components/tl/ucp/bcast/bcast_sag_knomial.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"bÿ¡.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"_uı_£nd»cv.h
"

12 
	~"cŞl_·‰”ns/¤a_knomŸl.h
"

13 
	~"uts/ucc_m©h.h
"

14 
	~"uts/ucc_cŞl_uts.h
"

15 
	~"compÚ’ts/mc/ucc_mc.h
"

16 
	~"../sÿ‰”/sÿ‰”.h
"

17 
	~"../®lg©h”/®lg©h”.h
"

39 
ucc_¡©us_t
 
	$ucc__uı_bÿ¡_§g_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

41 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_schedule_t);

42 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
scheduË
->
su³r
.
b¬gs
.args;

43 
ucc_cŞl_sk_t
 *
ag_sk
, *
sÿ‰”_sk
;

45 
sÿ‰”_sk
 = 
scheduË
->
sks
[0];

46 
sÿ‰”_sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
bufãr
 =‡rgs->src.info.buffer;

47 
sÿ‰”_sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
bufãr
 =‡rgs->
¤c
.info.buffer;

48 
sÿ‰”_sk
->
b¬gs
.
¬gs
.
¤c
.
šfo
.
couÁ
 =‡rgs->src.info.count;

49 
sÿ‰”_sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
 =‡rgs->
¤c
.info.count;

51 
ag_sk
 = 
scheduË
->
sks
[1];

52 
ag_sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
bufãr
 =‡rgs->
¤c
.info.buffer;

53 
ag_sk
->
b¬gs
.
¬gs
.
d¡
.
šfo
.
couÁ
 =‡rgs->
¤c
.info.count;

55 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_bcast_sag_kn_start", 0);

56  
	`ucc_scheduË_¡¬t
(
cŞl_sk
);

57 
	}
}

59 
ucc_¡©us_t


60 
	$ucc__uı_bÿ¡_§g_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

62 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_schedule_t);

63 
ucc_¡©us_t
 
¡©us
;

65 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
scheduË
, "ucp_bcast_sag_kn_done", 0);

66 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
cŞl_sk
);

67 
	`ucc__uı_put_scheduË
(
scheduË
);

68  
¡©us
;

69 
	}
}

71 
ucc_¡©us_t


72 
	$ucc__uı_bÿ¡_§g_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

73 
ucc_ba£_‹am_t
 *
‹am
,

74 
ucc_cŞl_sk_t
 **
sk_h
)

76 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

77 
size_t
 
couÁ
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.count;

78 
ucc_d©©y³_t
 
dty³
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
d©©y³
;

79 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.mem_type;

80 
ucc_ba£_cŞl_¬gs_t
 
¬gs
 = *
cŞl_¬gs
;

81 
ucc_m¿nge_ušt_t
 *
p
 = &
_‹am
->
cfg
.
bÿ¡_§g_kn_¿dix
;

82 
ucc_scheduË_t
 *
scheduË
;

83 
ucc_cŞl_sk_t
 *
sk
, *
rs_sk
;

84 
ucc_¡©us_t
 
¡©us
;

85 
ucc_kn_¿dix_t
 
¿dix
, 
cfg_¿dix
, 
İt_¿dix
;

87 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(&
cŞl_¬gs
->
¬gs
)) {

89  
	`ucc__uı_bÿ¡_knomŸl_š™
(
cŞl_¬gs
, 
‹am
, 
sk_h
);

92 
İt_¿dix
 = (
mem_ty³
 =ğ
UCC_MEMORY_TYPE_HOST
è? 
_‹am
->
İt_¿dix_ho¡
 :

93 
_‹am
->
İt_¿dix
;

95 
cfg_¿dix
 = 
	`ucc__uı_g‘_¿dix_äom_¿nge
(
_‹am
,

96 
couÁ
 * 
	`ucc_dt_size
(
dty³
),

97 
mem_ty³
, 
p
, 
İt_¿dix
);

98 
¿dix
 = 
	`ucc_knomŸl_·‰”n_g‘_mš_¿dix
(
cfg_¿dix
,

99 
	`UCC_TL_TEAM_SIZE
(
_‹am
),

100 
couÁ
);

101 
¡©us
 = 
	`ucc__uı_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
,

102 (
ucc__uı_scheduË_t
 **)&
scheduË
);

103 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

104  
¡©us
;

107 
¬gs
.¬gs.
d¡
.
šfo
.
bufãr
 =‡rgs.¬gs.
¤c
.info.buffer;

108 
¬gs
.¬gs.
d¡
.
šfo
.
mem_ty³
 =‡rgs.¬gs.
¤c
.info.mem_type;

109 
¬gs
.¬gs.
d¡
.
šfo
.
d©©y³
 =‡rgs.¬gs.
¤c
.info.datatype;

110 
¬gs
.¬gs.
d¡
.
šfo
.
couÁ
 =‡rgs.¬gs.
¤c
.info.count;

111 
	`UCC_CHECK_GOTO
(
	`ucc__uı_sÿ‰”_knomŸl_š™_r
(&
¬gs
, 
‹am
, &
sk
, 
¿dix
),

112 
out
, 
¡©us
);

114 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sk
), 
out
, 
¡©us
);

115 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(&
scheduË
->
su³r
,

116 
UCC_EVENT_SCHEDULE_STARTED
, 
sk
,

117 
ucc_sk_¡¬t_hªdËr
),

118 
out
, 
¡©us
);

119 
rs_sk
 = 
sk
;

123 
¬gs
.¬gs.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

124 
¬gs
.¬gs.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

125 
	`UCC_CHECK_GOTO
(

126 
	`ucc__uı_®lg©h”_knomŸl_š™_r
(&
¬gs
, 
‹am
, &
sk
, 
¿dix
), 
out
,

127 
¡©us
);

129 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
sk
), 
out
, 
¡©us
);

130 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(
rs_sk
, 
UCC_EVENT_COMPLETED
,

131 
sk
, 
ucc_sk_¡¬t_hªdËr
),

132 
out
, 
¡©us
);

134 
scheduË
->
su³r
.
po¡
 = 
ucc__uı_bÿ¡_§g_knomŸl_¡¬t
;

135 
scheduË
->
su³r
.
´og»ss
 = 
NULL
;

136 
scheduË
->
su³r
.
fš®ize
 = 
ucc__uı_bÿ¡_§g_knomŸl_fš®ize
;

137 *
sk_h
 = &
scheduË
->
su³r
;

138  
UCC_OK
;

139 
out
:

140 
	`ucc__uı_put_scheduË
(
scheduË
);

141  
¡©us
;

142 
	}
}

	@src/components/tl/ucp/coll_plugins/example/example.c

7 
	~"cÚfig.h
"

8 
	~"compÚ’ts//uı/_uı.h
"

9 
	~"compÚ’ts//uı/_uı_cŞl.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"compÚ’ts//uı/_uı_£nd»cv.h
"

12 
	~"cŞl_·‰”ns/»cursive_knomŸl.h
"

13 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

14 
	~"uts/ucc_m©h.h
"

16 
ucc__cŞl_¶ugš_içû_t
 
	gucc_ı_uı_exam¶e
;

18 
	succ_ı_uı_exam¶e_cÚfig
 {

19 *
	mscÜe_¡r
;

20 } 
	tucc_ı_uı_exam¶e_cÚfig_t
;

22 
	#CONFIG
(
_lib
è((
ucc_ı_uı_exam¶e_cÚfig_t
*)((_lib)->
ı_cÚfigs
[
ucc_ı_uı_exam¶e
.
id
]))

	)

24 
ucc_cÚfig_f›ld_t
 
	gucc_ı_uı_exam¶e_bË
[] = {

26 
ucc_off£tof
(
ucc_ı_uı_exam¶e_cÚfig_t
, 
scÜe_¡r
), 
UCC_CONFIG_TYPE_STRING
},

28 {
NULL
}};

30 
ucs_cÚfig_glob®_li¡_’Œy_t
 
	gucc_ı_uı_exam¶e_cfg_’Œy
 =

32 .
Çme
 = "TLCP_EXAMPLE",

33 .
	g´efix
 = "TL_UCP_",

34 .
	gbË
 = 
ucc_ı_uı_exam¶e_bË
,

35 .
	gsize
 = (
ucc_ı_uı_exam¶e_cÚfig_t
)

38 
UCC_CONFIG_REGISTER_TABLE_ENTRY
(&
ucc_ı_uı_exam¶e_cfg_’Œy
,

39 &
ucc_cÚfig_glob®_li¡
);

41 
	#UCC_TLCP_UCP_EXAMPLE_SCORE
 100

	)

42 
	$ucc_ı_uı_exam¶e_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

44 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

46 
	`_šfo
(
	`TASK_LIB
(
sk
), "completingl_ucp_example collask");

48 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

49 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

50 
	}
}

52 
ucc_¡©us_t
 
	$ucc_ı_uı_exam¶e_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

54 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

55 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

57 
	`_šfo
(
	`TASK_LIB
(
sk
), "startingl_ucp_example collask");

59 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

60 
	`ucc_´og»ss_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

62  
UCC_OK
;

63 
	}
}

65 
ucc_¡©us_t
 
	$ucc_ı_uı_exam¶e_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

66 
ucc_ba£_‹am_t
 *
‹am
,

67 
ucc_cŞl_sk_t
 **
sk_h
)

69 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

70 
ucc__uı_sk_t
 *
sk
 = 
	`ucc__uı_g‘_sk
(
_‹am
);

72 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, 
cŞl_¬gs
, 
‹am
);

73 
sk
->
gged
.
g
 = 
_‹am
->
£q_num
;

74 
_‹am
->
£q_num
 = (_‹am->£q_num + 1è% 
UCC_TL_UCP_MAX_COLL_TAG
;

75 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_cŞl_fš®ize
;

76 
sk
->
su³r
.
po¡
 = 
ucc_ı_uı_exam¶e_¡¬t
;

77 
sk
->
su³r
.
´og»ss
 = 
ucc_ı_uı_exam¶e_´og»ss
;

78 *
sk_h
 = &
sk
->
su³r
;

79  
UCC_OK
;

80 
	}
}

82 
ucc_¡©us_t
 
	$ucc_ı_uı_exam¶e_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

83 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

85 
ucc__uı_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_ucp_team_t);

86 
ucc__uı_lib_t
 *
lib
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
);

87 cÚ¡ *
scÜe_¡r
;

88 
ucc_cŞl_scÜe_t
 *
scÜe
;

89 
ucc_¡©us_t
 
¡©us
;

93 
¡©us
 = 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
);

94 ià(
UCC_OK
 !ğ
¡©us
) {

95 
	`_”rÜ
(
lib
, "failedo‡lloc score");

96  
¡©us
;

98 
¡©us
 = 
	`ucc_cŞl_scÜe_add_¿nge
(
scÜe
, 
UCC_COLL_TYPE_ALLTOALL
, 
UCC_MEMORY_TYPE_HOST
,

99 0, 4096, 
UCC_TLCP_UCP_EXAMPLE_SCORE
,

100 
ucc_ı_uı_exam¶e_cŞl_š™
, 
_‹am
);

101 ià(
UCC_OK
 !ğ
¡©us
) {

102 
	`_”rÜ
(
lib
, "failedo‡dd„ange");

103  
¡©us
;

105 
scÜe_¡r
 = 
	`CONFIG
(
lib
)->score_str;

106 ià(
	`¡¾’
(
scÜe_¡r
) > 0) {

107 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
scÜe_¡r
, 
scÜe
, 
	`UCC_TL_TEAM_SIZE
(
‹am
),

108 
ucc_ı_uı_exam¶e_cŞl_š™
,

109 &
‹am
->
su³r
.su³r, 
UCC_TLCP_UCP_EXAMPLE_SCORE
,

110 
NULL
);

111 ià(
¡©us
 =ğ
UCC_ERR_INVALID_PARAM
) {

113 
¡©us
 = 
UCC_OK
;

116 *
scÜe_p
 = 
scÜe
;

117  
¡©us
;

118 
	}
}

120 
ucc__cŞl_¶ugš_içû_t
 
	gucc_ı_uı_exam¶e
 = {

121 .
su³r
.
Çme
 = "tl_ucp_example",

122 .
	gsu³r
.
	gscÜe
 = 
UCC_TLCP_UCP_EXAMPLE_SCORE
,

123 .
	gcÚfig
.
	gbË
 = 
ucc_ı_uı_exam¶e_bË
,

124 .
	gcÚfig
.
	gsize
 = (
ucc_ı_uı_exam¶e_cÚfig_t
),

125 .
	gg‘_scÜes
 = 
ucc_ı_uı_exam¶e_g‘_scÜes


	@src/components/tl/ucp/fanin/fanin.c

6 
	~"cÚfig.h
"

7 
	~"çnš.h
"

8 
	~"../»duû/»duû.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__uı_çnš_®gs
[
UCC_TL_UCP_FANIN_ALG_LAST
 + 1] = {

12 [
UCC_TL_UCP_FANIN_ALG_KNOMIAL
] =

13 {.
id
 = 
UCC_TL_UCP_FANIN_ALG_KNOMIAL
,

14 .
	gÇme
 = "knomial",

15 .
	gdesc
 = "fanin over knomialree with‡rbitrary„adix"},

16 [
UCC_TL_UCP_FANIN_ALG_LAST
] = {

17 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

19 
ucc_¡©us_t
 
	$ucc__uı_çnš_š™
(
ucc__uı_sk_t
 *
sk
)

21 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

22 
ucc_¿nk_t
 
‹am_size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

23 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

25 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
 = 
NULL
;

26 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
couÁ
 = 0;

27 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

28 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
 = 
UCC_DT_INT8
;

30 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
bufãr
 = 
NULL
;

31 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
couÁ
 = 0;

32 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
mem_ty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

33 
	`TASK_ARGS
(
sk
).
d¡
.
šfo
.
d©©y³
 = 
UCC_DT_INT8
;

35 
sk
->
su³r
.
po¡
 = 
ucc__uı_»duû_knomŸl_¡¬t
;

36 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_»duû_knomŸl_´og»ss
;

37 
sk
->
»duû_kn
.
¿dix
 =

38 
	`ucc_mš
(
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
çnš_kn_¿dix
, 
‹am_size
);

40 
	`CALC_KN_TREE_DIST
(
‹am_size
, 
sk
->
»duû_kn
.
¿dix
,

41 
sk
->
»duû_kn
.
max_di¡
);

42  
¡©us
;

43 
	}
}

	@src/components/tl/ucp/fanin/fanin.h

6 #iâdeà
FANIN_H_


7 
	#FANIN_H_


	)

8 
	~"../_uı.h
"

9 
	~"../_uı_cŞl.h
"

12 
	mUCC_TL_UCP_FANIN_ALG_KNOMIAL
,

13 
	mUCC_TL_UCP_FANIN_ALG_LAST


16 
ucc_ba£_cŞl_®g_šfo_t


17 
ucc__uı_çnš_®gs
[
UCC_TL_UCP_FANIN_ALG_LAST
 + 1];

19 
ucc_¡©us_t
 
ucc__uı_çnš_š™
(
ucc__uı_sk_t
 *
sk
);

	@src/components/tl/ucp/fanout/fanout.c

6 
	~"cÚfig.h
"

7 
	~"çnout.h
"

8 
	~"../bÿ¡/bÿ¡.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__uı_çnout_®gs
[
UCC_TL_UCP_FANOUT_ALG_LAST
 + 1] = {

12 [
UCC_TL_UCP_FANOUT_ALG_KNOMIAL
] =

13 {.
id
 = 
UCC_TL_UCP_FANOUT_ALG_KNOMIAL
,

14 .
	gÇme
 = "knomial",

15 .
	gdesc
 = "fanout over knomialree with‡rbitrary„adix"},

16 [
UCC_TL_UCP_FANOUT_ALG_LAST
] = {

17 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

19 
ucc_¡©us_t
 
	$ucc__uı_çnout_š™
(
ucc__uı_sk_t
 *
sk
)

21 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

22 
ucc_¿nk_t
 
‹am_size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

23 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

25 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
bufãr
 = 
NULL
;

26 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
couÁ
 = 0;

27 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
mem_ty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

28 
	`TASK_ARGS
(
sk
).
¤c
.
šfo
.
d©©y³
 = 
UCC_DT_INT8
;

29 
sk
->
bÿ¡_kn
.
¿dix
 =

30 
	`ucc_mš
(
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
çnout_kn_¿dix
, 
‹am_size
);

32 
sk
->
su³r
.
po¡
 = 
ucc__uı_bÿ¡_knomŸl_¡¬t
;

33 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_bÿ¡_knomŸl_´og»ss
;

34  
¡©us
;

35 
	}
}

	@src/components/tl/ucp/fanout/fanout.h

6 #iâdeà
FANOUT_H_


7 
	#FANOUT_H_


	)

8 
	~"../_uı.h
"

9 
	~"../_uı_cŞl.h
"

12 
	mUCC_TL_UCP_FANOUT_ALG_KNOMIAL
,

13 
	mUCC_TL_UCP_FANOUT_ALG_LAST


16 
ucc_ba£_cŞl_®g_šfo_t


17 
ucc__uı_çnout_®gs
[
UCC_TL_UCP_FANOUT_ALG_LAST
 + 1];

19 
ucc_¡©us_t
 
ucc__uı_çnout_š™
(
ucc__uı_sk_t
 *
sk
);

	@src/components/tl/ucp/gather/gather.c

7 
	~"cÚfig.h
"

8 
	~"g©h”.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__uı_g©h”_®gs
[
UCC_TL_UCP_GATHER_ALG_LAST
 + 1] = {

12 [
UCC_TL_UCP_GATHER_ALG_KNOMIAL
] =

13 {.
id
 = 
UCC_TL_UCP_GATHER_ALG_KNOMIAL
,

14 .
	gÇme
 = "knomial",

15 .
	gdesc
 = "gather over knomialree with‡rbitrary„adix "

17 [
UCC_TL_UCP_GATHER_ALG_LAST
] = {

18 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

20 
ucc_¡©us_t
 
	$ucc__uı_g©h”_š™
(
ucc__uı_sk_t
 *
sk
)

22 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

23 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

24 
ucc_kn_¿dix_t
 
¿dix
;

26 
¿dix
 = 
	`ucc_mš
(
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
g©h”_kn_¿dix
, 
size
);

28  
	`ucc__uı_g©h”_knomŸl_š™_commÚ
(
sk
, 
¿dix
);

29 
	}
}

	@src/components/tl/ucp/gather/gather.h

7 #iâdeà
GATHER_H_


8 
	#GATHER_H_


	)

9 
	~"_uı_cŞl.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

13 
	mUCC_TL_UCP_GATHER_ALG_KNOMIAL
,

14 
	mUCC_TL_UCP_GATHER_ALG_LAST


17 
ucc_ba£_cŞl_®g_šfo_t


18 
ucc__uı_g©h”_®gs
[
UCC_TL_UCP_GATHER_ALG_LAST
 + 1];

24 
	mUCC_GATHER_KN_PHASE_INIT
,

25 
	mUCC_GATHER_KN_PHASE_PROGRESS
,

28 
	#UCC_GATHER_KN_CHECK_PHASE
(
_p
) \

29 
_p
: \

30 
_p
;

	)

32 
	#UCC_GATHER_KN_GOTO_PHASE
(
_pha£
) \

34 
_pha£
) { \

35 
	`UCC_GATHER_KN_CHECK_PHASE
(
UCC_GATHER_KN_PHASE_PROGRESS
); \

36 
	`UCC_GATHER_KN_CHECK_PHASE
(
UCC_GATHER_KN_PHASE_INIT
); \

38 } 0)

	)

40 
ucc_¡©us_t
 
ucc__uı_g©h”_š™
(
ucc__uı_sk_t
 *
sk
);

42 
ucc_¡©us_t
 
ucc__uı_g©h”_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

44 
ucc__uı_g©h”_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

46 
ucc_¡©us_t
 
ucc__uı_g©h”_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

48 
ucc_¡©us_t
 
ucc__uı_g©h”_knomŸl_š™_commÚ
(
ucc__uı_sk_t
 *
sk
,

49 
ucc_kn_¿dix_t
 
¿dix
);

52 
ucc_¡©us_t
 
ucc__uı_g©h”_knomŸl_š™_r
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

53 
ucc_ba£_‹am_t
 *
‹am
,

54 
ucc_cŞl_sk_t
 **
sk_h
,

55 
ucc_kn_¿dix_t
 
¿dix
);

	@src/components/tl/ucp/gather/gather_knomial.c

7 
	~"cÚfig.h
"

8 
	~"g©h”.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"cŞl_·‰”ns/¤a_knomŸl.h
"

14 
	#SAVE_STATE
(
_pha£
) \

16 
sk
->
g©h”_kn
.
pha£
 = 
_pha£
; \

17 } 0)

	)

19 
šlše
 
ušt32_t
 
	$ÿlc_bufãr_size
(
ucc_¿nk_t
 
v¿nk
, 
ušt32_t
 
¿dix
,

20 
ucc_¿nk_t
 
tsize
)

22 
ušt32_t
 
¿dix_v®u©iÚ
;

24 ià(
v¿nk
 == 0) {

25  
tsize
;

28 
¿dix_v®u©iÚ
 = 
	`ÿlc_v®u©iÚ
(
v¿nk
, 
¿dix
);

29  (
ušt32_t
)
	`ucc_mš
(
	`pow
(
¿dix
, 
¿dix_v®u©iÚ
), 
tsize
 - 
v¿nk
);

30 
	}
}

33 
	$ucc__uı_g©h”_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

35 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

36 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

37 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

38 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

39 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

40 
ucc_¿nk_t
 
roÙ
 = (ucc_¿nk_t)
¬gs
->root;

41 
ucc_kn_¿dix_t
 
¿dix
 = 
sk
->
g©h”_kn
.radix;

42 
ucc_¿nk_t
 
v¿nk
 = 
	`VRANK
(
¿nk
, 
roÙ
, 
tsize
);

43 
ucc_memÜy_ty³_t
 
mty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

44 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

45 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
g©h”_kn
.p;

46 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

47 
size_t
 
d©a_size
 = 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
dt_size
;

48 
ucc_cŞl_ty³_t
 
ù
 = 
¬gs
->
cŞl_ty³
;

49 
size_t
 
msg_size
, 
³”_£g_couÁ
;

50 *
sü©ch_off£t
;

51 
ucc_¿nk_t
 
v³”
, 
³”
, 
vroÙ_©_Ëv–
, 
roÙ_©_Ëv–
, 
num_blocks
;

52 
ucc_kn_¿dix_t
 
loİ_¡•
;

53 
±rdiff_t
 
³”_£g_off£t
;

55 ià(
sk
->
g©h”_kn
.
p
.
node_ty³
 =ğ
KN_NODE_EXTRA
) {

56 
	`ucc_as£¹
(
ù
 =ğ
UCC_COLL_TYPE_REDUCE
);

57 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

61 
	`UCC_GATHER_KN_GOTO_PHASE
(
sk
->
g©h”_kn
.
pha£
);

62 
UCC_GATHER_KN_PHASE_INIT
:

63 !
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

64 ià(
sk
->
gged
.
£nd_po¡ed
 > 0) {

65 
UCC_GATHER_KN_PHASE_PROGRESS
;

68 
sü©ch_off£t
 = 
sk
->
g©h”_kn
.
sü©ch
;

69 
vroÙ_©_Ëv–
 = 
	`ucc_knomŸl_·‰”n_g‘_ba£_¿nk
(
p
, 
v¿nk
);

70 ià(
vroÙ_©_Ëv–
 =ğ
v¿nk
) {

71 
loİ_¡•
 = 1;†oİ_¡• < 
¿dix
;†oop_step++) {

72 
v³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
v¿nk
, 
loİ_¡•
);

73 ià(
v³”
 =ğ
UCC_KN_PEER_NULL
) {

76 
	`ucc_kn_g_·‰”n_³”_£g
(
v³”
, 
p
, &
³”_£g_couÁ
,

77 &
³”_£g_off£t
);

78 
³”
 = 
	`INV_VRANK
(
v³”
, 
roÙ
, 
tsize
);

79 ià(
v¿nk
 != 0) {

80 
msg_size
 = 
³”_£g_couÁ
 * 
dt_size
;

81 ià(
¬gs
->
cŞl_ty³
 !ğ
UCC_COLL_TYPE_GATHER
) {

82 
sü©ch_off£t
 = 
	`PTR_OFFSET
(
sk
->
g©h”_kn
.
sü©ch
,

83 
³”_£g_off£t
 * 
dt_size
);

85 
sü©ch_off£t
 = 
	`PTR_OFFSET
(scratch_offset,

86 
d©a_size
 *

87 
sk
->
g©h”_kn
.
di¡
);

89 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
sü©ch_off£t
,

90 
msg_size
, 
mty³
, 
³”
,

91 
‹am
, 
sk
),

92 
sk
, 
out
);

98 
sü©ch_off£t
 = 
	`PTR_OFFSET
(
sk
->
g©h”_kn
.
sü©ch
,

99 
d©a_size
 * 
³”
);

100 
num_blocks
 = 
	`ucc_mš
(
sk
->
g©h”_kn
.
di¡
, 
tsize
 - 
v³”
);

102 ià((
ù
 =ğ
UCC_COLL_TYPE_REDUCE
) ||

103 (
num_blocks
 <ğ
tsize
 - 
³”
)) {

104 
msg_size
 = 
³”_£g_couÁ
 * 
dt_size
;

105 ià(
¬gs
->
cŞl_ty³
 !ğ
UCC_COLL_TYPE_GATHER
) {

106 
sü©ch_off£t
 = 
	`PTR_OFFSET
(
sk
->
g©h”_kn
.
sü©ch
,

107 
³”_£g_off£t
 * 
dt_size
);

109 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
sü©ch_off£t
,

110 
msg_size
, 
mty³
,

111 
³”
, 
‹am
, 
sk
),

112 
sk
, 
out
);

118 
msg_size
 = 
d©a_size
 * (
tsize
 - 
³”
);

119 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
sü©ch_off£t
,

120 
msg_size
, 
mty³
,

121 
³”
, 
‹am
, 
sk
),

122 
sk
, 
out
);

123 
msg_size
 = 
d©a_size
 * (
num_blocks
 - (
tsize
 - 
³”
));

124 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
sk
->
g©h”_kn
.
sü©ch
,

125 
msg_size
, 
mty³
,

126 
³”
, 
‹am
, 
sk
),

127 
sk
, 
out
);

132 ià((
ù
 !ğ
UCC_COLL_TYPE_REDUCE
) &&

133 
	`ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
p
)) {

134 
msg_size
 = 
d©a_size
;

135 ià(
¿nk
 !ğ
roÙ
) {

136 
¡©us
 = 
	`ucc_mc_memıy
(
sk
->
g©h”_kn
.
sü©ch
,

137 
¬gs
->
¤c
.
šfo
.
bufãr
, 
msg_size
,

138 
¬gs
->
¤c
.
šfo
.
mem_ty³
, 
mty³
);

139 } ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

140 
¡©us
 = 
	`ucc_mc_memıy
(

141 
	`PTR_OFFSET
(
sk
->
g©h”_kn
.
sü©ch
, 
d©a_size
 * 
¿nk
),

142 
¬gs
->
¤c
.
šfo
.
bufãr
, 
msg_size
,

143 
¬gs
->
¤c
.
šfo
.
mem_ty³
, 
mty³
);

146 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

147 
sk
->
su³r
.
¡©us
 = status;

151 ià(
¿nk
 =ğ
roÙ
 && 
	`ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
p
è&& !
	`UCC_IS_INPLACE
(*
¬gs
)) {

152 
	`ucc_kn_g_·‰”n_³”_£g
(
v¿nk
, 
p
, &
³”_£g_couÁ
,

153 &
³”_£g_off£t
);

154 
¡©us
 = 
	`ucc_mc_memıy
(

155 
	`PTR_OFFSET
(
sk
->
g©h”_kn
.
sü©ch
, 
³”_£g_off£t
 * 
dt_size
),

156 
	`PTR_OFFSET
(
¬gs
->
¤c
.
šfo
.
bufãr
, 
³”_£g_off£t
 * 
dt_size
), 
³”_£g_couÁ
 * dt_size,

157 
¬gs
->
¤c
.
šfo
.
mem_ty³
, 
mty³
);

158 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

159 
sk
->
su³r
.
¡©us
 = status;

165 
roÙ_©_Ëv–
 = 
	`INV_VRANK
(
vroÙ_©_Ëv–
, 
roÙ
, 
tsize
);

166 
num_blocks
 = 
	`ucc_mš
(
sk
->
g©h”_kn
.
di¡
, 
tsize
 - 
v¿nk
);

167 ià((
ù
 =ğ
UCC_COLL_TYPE_REDUCE
) ||

168 (
roÙ_©_Ëv–
 !ğ
roÙ
) ||

169 (
num_blocks
 <ğ
tsize
 - 
¿nk
)) {

170 
	`ucc_kn_g_·‰”n_³”_£g
(
v¿nk
, 
p
, &
³”_£g_couÁ
,

171 &
³”_£g_off£t
);

172 
msg_size
 = 
³”_£g_couÁ
 * 
dt_size
;

173 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHER
) {

174 
sü©ch_off£t
 = 
sk
->
g©h”_kn
.
sü©ch
;

176 
sü©ch_off£t
 = 
	`PTR_OFFSET
(
sk
->
g©h”_kn
.
sü©ch
,

177 
³”_£g_off£t
 * 
dt_size
);

179 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
sü©ch_off£t
,

180 
msg_size
, 
mty³
,

181 
roÙ_©_Ëv–
, 
‹am
, 
sk
),

182 
sk
, 
out
);

185 
msg_size
 = 
d©a_size
 * (
tsize
 - 
¿nk
);

186 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
sk
->
g©h”_kn
.
sü©ch
,

187 
msg_size
, 
mty³
,

188 
roÙ_©_Ëv–
, 
‹am
, 
sk
),

189 
sk
, 
out
);

190 
msg_size
 = 
d©a_size
 * (
num_blocks
 - (
tsize
 - 
¿nk
));

191 
	`UCPCHECK_GOTO
(

192 
	`ucc__uı_£nd_nb
(
	`PTR_OFFSET
(
sk
->
g©h”_kn
.
sü©ch
,

193 
d©a_size
 * (
tsize
 - 
¿nk
)),

194 
msg_size
, 
mty³
, 
roÙ_©_Ëv–
, 
‹am
,

195 
sk
),

196 
sk
, 
out
);

200 
UCC_GATHER_KN_PHASE_PROGRESS
:

201 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

202 
	`SAVE_STATE
(
UCC_GATHER_KN_PHASE_PROGRESS
);

205 
sk
->
g©h”_kn
.
di¡
 *ğ
¿dix
;

206 
	`ucc_kn_g_·‰”n_Ãxt_™”
(
p
);

209 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

210 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

211 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_gather_kn_done", 0);

212 
out
:

214 
	}
}

216 
ucc_¡©us_t
 
	$ucc__uı_g©h”_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

218 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

219 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

220 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

221 
ucc_¿nk_t
 
roÙ
 = (ucc_¿nk_t)
¬gs
->root;

222 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

223 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

225 ià(
roÙ
 =ğ
Œªk
 && 
	`UCC_IS_INPLACE
(*
¬gs
)) {

226 
¬gs
->
¤c
.
šfo
 =‡rgs->
d¡
.info;

227 
¬gs
->
¤c
.
šfo
.
couÁ
 =‡rgs->
d¡
.šfo.couÁ / 
size
;

230 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHER
) {

231 
	`ucc_kn_g_·‰”n_š™
(
size
, 
	`VRANK
(
Œªk
, 
roÙ
, size),

232 
sk
->
g©h”_kn
.
¿dix
, 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
size
,

233 &
sk
->
g©h”_kn
.
p
);

236 
	`ucc_as£¹
(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE
);

237 
sk
->
g©h”_kn
.
sü©ch
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

238 
	`ucc_kn_gx_·‰”n_š™
(
size
, 
	`VRANK
(
Œªk
, 
roÙ
, size),

239 
sk
->
g©h”_kn
.
¿dix
, 
¬gs
->
d¡
.
šfo
.
couÁ
,

240 &
sk
->
g©h”_kn
.
p
);

243 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_gather_kn_start", 0);

244 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

246 
sk
->
g©h”_kn
.
di¡
 = 1;

247 
sk
->
g©h”_kn
.
pha£
 = 
UCC_GATHER_KN_PHASE_INIT
;

249  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

250 
	}
}

252 
ucc_¡©us_t
 
	$ucc__uı_g©h”_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

254 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

256 ià(
sk
->
g©h”_kn
.
sü©ch_mc_h—d”
) {

257 
	`ucc_mc_ä“
(
sk
->
g©h”_kn
.
sü©ch_mc_h—d”
);

259  
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

260 
	}
}

262 
ucc_¡©us_t
 
	$ucc__uı_g©h”_knomŸl_š™_commÚ
(
ucc__uı_sk_t
 *
sk
,

263 
ucc_kn_¿dix_t
 
¿dix
)

265 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

266 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

267 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

268 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

269 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

270 
ucc_¿nk_t
 
v¿nk
 = 
	`VRANK
(
Œªk
, 
roÙ
, 
tsize
);

271 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

272 
ucc_memÜy_ty³_t
 
mty³
;

273 
ucc_d©©y³_t
 
dt
;

274 
size_t
 
couÁ
, 
d©a_size
;

275 
ušt32_t
 
bufãr_size
;

276 
is_Ëaf
;

278 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
)) {

279 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

280 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

281 
mty³
 = 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

283 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

284 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

285 
mty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

287 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
dt
);

288 
sk
->
su³r
.
po¡
 = 
ucc__uı_g©h”_knomŸl_¡¬t
;

289 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_g©h”_knomŸl_´og»ss
;

290 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_g©h”_knomŸl_fš®ize
;

291 
sk
->
g©h”_kn
.
¿dix
 =„adix;

292 
	`CALC_KN_TREE_DIST
(
tsize
, 
sk
->
g©h”_kn
.
¿dix
,

293 
sk
->
g©h”_kn
.
max_di¡
);

294 
sk
->
g©h”_kn
.
sü©ch_mc_h—d”
 = 
NULL
;

296 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE
) {

297 
sk
->
g©h”_kn
.
sü©ch
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

299 
	`ucc_as£¹
(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHER
);

300 
is_Ëaf
 = ((
v¿nk
 % 
¿dix
 !ğ0è|| (v¿nk =ğ
tsize
 - 1));

301 ià(
v¿nk
 == 0) {

302 
sk
->
g©h”_kn
.
sü©ch
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

303 } ià(
is_Ëaf
) {

304 
sk
->
g©h”_kn
.
sü©ch
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

306 
bufãr_size
 = 
	`ÿlc_bufãr_size
(
v¿nk
, 
sk
->
g©h”_kn
.
¿dix
, 
tsize
);

307 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
g©h”_kn
.
sü©ch_mc_h—d”
,

308 
bufãr_size
 * 
d©a_size
, 
mty³
);

309 
sk
->
g©h”_kn
.
sü©ch
 =ask->g©h”_kn.
sü©ch_mc_h—d”
->
addr
;

313  
¡©us
;

314 
	}
}

316 
ucc_¡©us_t
 
	$ucc__uı_g©h”_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

317 
ucc_ba£_‹am_t
 *
‹am
,

318 
ucc_cŞl_sk_t
 **
sk_h
)

320 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

321 
ucc_¿nk_t
 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

322 
ucc__uı_sk_t
 *
sk
;

323 
ucc_¡©us_t
 
¡©us
;

324 
ucc_kn_¿dix_t
 
¿dix
;

326 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

327 ià(
	`ucc_uÆik–y
(!
sk
)) {

328  
UCC_ERR_NO_MEMORY
;

331 
¿dix
 = 
	`ucc_mš
(
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
g©h”_kn_¿dix
, 
tsize
);

333 
¡©us
 = 
	`ucc__uı_g©h”_knomŸl_š™_commÚ
(
sk
, 
¿dix
);

334 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

335 
	`ucc__uı_put_sk
(
sk
);

336  
¡©us
;

338 *
sk_h
 = &
sk
->
su³r
;

339  
UCC_OK
;

340 
	}
}

342 
ucc_¡©us_t
 
	$ucc__uı_g©h”_knomŸl_š™_r
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

343 
ucc_ba£_‹am_t
 *
‹am
,

344 
ucc_cŞl_sk_t
 **
sk_h
,

345 
ucc_kn_¿dix_t
 
¿dix
)

347 
ucc__uı_sk_t
 *
sk
;

348 
ucc_¡©us_t
 
¡©us
;

350 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

351 ià(
	`ucc_uÆik–y
(!
sk
)) {

352  
UCC_ERR_NO_MEMORY
;

355 
¡©us
 = 
	`ucc__uı_g©h”_knomŸl_š™_commÚ
(
sk
, 
¿dix
);

356 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

357 
	`ucc__uı_put_sk
(
sk
);

358  
¡©us
;

360 *
sk_h
 = &
sk
->
su³r
;

361  
UCC_OK
;

362 
	}
}

	@src/components/tl/ucp/gatherv/gatherv.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"g©h”v.h
"

10 
	~"uts/ucc_cŞl_uts.h
"

12 
ucc_¡©us_t
 
ucc__uı_g©h”v_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

14 
ucc__uı_g©h”v_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

16 
ucc_ba£_cŞl_®g_šfo_t


17 
	gucc__uı_g©h”v_®gs
[
UCC_TL_UCP_GATHERV_ALG_LAST
 + 1] = {

18 [
UCC_TL_UCP_GATHERV_ALG_LINEAR
] =

19 {.
id
 = 
UCC_TL_UCP_GATHERV_ALG_LINEAR
,

20 .
	gÇme
 = "linear",

21 .
	gdesc
 = "linear gatherv‡lgorithm"},

22 [
UCC_TL_UCP_GATHERV_ALG_LAST
] = {

23 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

25 
ucc_¡©us_t
 
ucc__uı_g©h”v_lš—r_š™
(
ucc__uı_sk_t
 *
sk
);

27 
ucc_¡©us_t
 
	$ucc__uı_g©h”v_š™
(
ucc__uı_sk_t
 *
sk
)

29 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

30 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

31 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

33 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
, 
Œªk
)) {

34  
UCC_ERR_NOT_SUPPORTED
;

37  
	`ucc__uı_g©h”v_lš—r_š™
(
sk
);

38 
	}
}

	@src/components/tl/ucp/gatherv/gatherv.h

7 #iâdeà
GATHERV_H_


8 
	#GATHERV_H_


	)

10 
	~"../_uı.h
"

11 
	~"../_uı_cŞl.h
"

14 
	mUCC_TL_UCP_GATHERV_ALG_LINEAR
,

15 
	mUCC_TL_UCP_GATHERV_ALG_LAST


18 
ucc_ba£_cŞl_®g_šfo_t


19 
ucc__uı_g©h”v_®gs
[
UCC_TL_UCP_GATHERV_ALG_LAST
 + 1];

21 
ucc_¡©us_t
 
ucc__uı_g©h”v_š™
(
ucc__uı_sk_t
 *
sk
);

	@src/components/tl/ucp/gatherv/gatherv_linear.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"g©h”v.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"_uı_£nd»cv.h
"

13 
šlše
 
ucc_¿nk_t
 
	$g‘_³”
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
,

14 
ucc_¿nk_t
 
¡•
)

16  (
¿nk
 + 
¡•
è% 
size
;

17 
	}
}

19 
	$ucc__uı_g©h”v_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

21 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

22 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

23 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

24 * 
rbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

25 
ucc_memÜy_ty³_t
 
rmem
 = 
¬gs
->
d¡
.
šfo_v
.
mem_ty³
;

26 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

27 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

28 
pŞls
 = 0;

29 
ucc_¿nk_t
 
³”
, 
po¡s
, 
Äeqs
;

30 
size_t
 
dt_size
, 
d©a_size
, 
d©a_di¥l
;

32 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
g¿nk
)) {

33 
po¡s
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
g©h”v_lš—r_num_po¡s
;

34 
Äeqs
 = (
po¡s
 > 
gsize
 ||…osts == 0) ? gsize :…osts;

35 
dt_size
 = 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
d¡
.
šfo_v
.
d©©y³
);

37 
pŞls
++ < 
sk
->
n_pŞls
) {

38 
	`uı_wÜk”_´og»ss
(
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
wÜk”
.
uı_wÜk”
);

39 (
sk
->
gged
.
»cv_po¡ed
 < 
gsize
) &&

40 ((
sk
->
gged
.
»cv_po¡ed
 -ask->gged.
»cv_com¶‘ed
) <

41 
Äeqs
)) {

42 
³”
 = 
	`g‘_³”
(
g¿nk
, 
gsize
, 
sk
->
gged
.
»cv_po¡ed
);

43 
d©a_size
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,

44 
¬gs
->
d¡
.
šfo_v
.
couÁs
, 
³”
è* 
dt_size
;

45 
d©a_di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

46 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
³”
è* 
dt_size
;

47 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nz
(
	`PTR_OFFSET
(
rbuf
, 
d©a_di¥l
),

48 
d©a_size
, 
rmem
, 
³”
, 
‹am
, 
sk
),

49 
sk
, 
out
);

50 
pŞls
 = 0;

53 ià(
sk
->
gged
.
»cv_po¡ed
 < 
gsize
) {

58 
sk
->
su³r
.
¡©us
 = 
	`ucc__uı_‹¡
(task);

59 
out
:

60 ià(
sk
->
su³r
.
¡©us
 !ğ
UCC_INPROGRESS
) {

61 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
,

64 
	}
}

66 
ucc_¡©us_t
 
	$ucc__uı_g©h”v_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

68 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

69 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

70 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

71 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

72 
ucc_memÜy_ty³_t
 
smem
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

73 
ucc_memÜy_ty³_t
 
rmem
 = 
¬gs
->
d¡
.
šfo_v
.
mem_ty³
;

74 * 
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

75 *
rbuf
;

76 
size_t
 
dt_size
, 
d©a_di¥l
, 
d©a_size
;

78 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_gatherv_linear_start", 0);

79 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

81 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
g¿nk
)) {

82 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

83 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

84 
d©a_size
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,

85 
¬gs
->
d¡
.
šfo_v
.
couÁs
, 
g¿nk
è* 
dt_size
;

86 
d©a_di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

87 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
g¿nk
è* 
dt_size
;

88 
rbuf
 = 
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo_v
.
bufãr
, 
d©a_di¥l
);

90 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nz
(
rbuf
, 
d©a_size
, 
rmem
, 
g¿nk
, 
‹am
,

91 
sk
),

92 
sk
, 
”rÜ
);

93 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nz
(
sbuf
, 
d©a_size
, 
smem
, 
g¿nk
, 
‹am
,

94 
sk
),

95 
sk
, 
”rÜ
);

99 
sk
->
gged
.
£nd_po¡ed
 =ask->gged.
£nd_com¶‘ed
 = 1;

100 
sk
->
gged
.
»cv_po¡ed
 =ask->gged.
»cv_com¶‘ed
 = 1;

103 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

104 
d©a_size
 = 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
dt_size
;

106 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nz
(
sbuf
, 
d©a_size
, 
smem
, 
¬gs
->
roÙ
,

107 
‹am
, 
sk
),

108 
sk
, 
”rÜ
);

111  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

112 
”rÜ
:

113  
sk
->
su³r
.
¡©us
;

115 
	}
}

117 
ucc_¡©us_t
 
	$ucc__uı_g©h”v_lš—r_š™
(
ucc__uı_sk_t
 *
sk
)

119 
sk
->
su³r
.
po¡
 = 
ucc__uı_g©h”v_lš—r_¡¬t
;

120 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_g©h”v_lš—r_´og»ss
;

122 
sk
->
n_pŞls
 = 
	`ucc_max
(1,ask->n_polls);

123  
UCC_OK
;

124 
	}
}

	@src/components/tl/ucp/reduce/reduce.c

6 
	~"»duû.h
"

7 
	~"compÚ’ts/mc/ucc_mc.h
"

9 
ucc_ba£_cŞl_®g_šfo_t


10 
	gucc__uı_»duû_®gs
[
UCC_TL_UCP_REDUCE_ALG_LAST
 + 1] = {

11 [
UCC_TL_UCP_REDUCE_ALG_KNOMIAL
] =

12 {.
id
 = 
UCC_TL_UCP_REDUCE_ALG_KNOMIAL
,

13 .
	gÇme
 = "knomial",

14 .
	gdesc
 = "reduce over knomialree with‡rbitrary„adix "

16 [
UCC_TL_UCP_REDUCE_ALG_DBT
] =

17 {.
id
 = 
UCC_TL_UCP_REDUCE_ALG_DBT
,

18 .
	gÇme
 = "dbt",

19 .
	gdesc
 = "reduce over double binaryree where‡†eaf in oneree "

21 [
UCC_TL_UCP_REDUCE_ALG_SRG
] =

22 {.
id
 = 
UCC_TL_UCP_REDUCE_ALG_SRG
,

23 .
	gÇme
 = "srg",

24 .
	gdesc
 = "recursive knomial scatter-reduce followed by knomial "

26 [
UCC_TL_UCP_REDUCE_ALG_LAST
] = {

27 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

29 
ucc_¡©us_t
 
	$ucc__uı_»duû_š™
(
ucc__uı_sk_t
 *
sk
)

31 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

32 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

33 
ucc_¿nk_t
 
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

34 
ucc_¿nk_t
 
‹am_size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

35 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

36 
ucc_¿nk_t
 
v¿nk
 = (
my¿nk
 - 
roÙ
 + 
‹am_size
) %eam_size;

37 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

38 
ucc_memÜy_ty³_t
 
mty³
;

39 
ucc_d©©y³_t
 
dt
;

40 
size_t
 
couÁ
, 
d©a_size
;

41 
i¦—f
;

42 
£lf_avg
;

44 ià(
roÙ
 =ğ
my¿nk
) {

45 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

46 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

47 
mty³
 = 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

49 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

50 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

51 
mty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

53 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
dt
);

54 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

55 
sk
->
su³r
.
po¡
 = 
ucc__uı_»duû_knomŸl_¡¬t
;

56 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_»duû_knomŸl_´og»ss
;

57 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_»duû_knomŸl_fš®ize
;

58 
sk
->
»duû_kn
.
¿dix
 =

59 
	`ucc_mš
(
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
»duû_kn_¿dix
, 
‹am_size
);

60 
	`CALC_KN_TREE_DIST
(
‹am_size
, 
sk
->
»duû_kn
.
¿dix
,

61 
sk
->
»duû_kn
.
max_di¡
);

62 
i¦—f
 = (
v¿nk
 % 
sk
->
»duû_kn
.
¿dix
 !ğ0 || v¿nk =ğ
‹am_size
 - 1);

63 
£lf_avg
 = (
v¿nk
 % 
sk
->
»duû_kn
.
¿dix
 =ğ0 && 
¬gs
->
İ
 =ğ
UCC_OP_AVG
 &&

64 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
»duû_avg_´e_İ
);

65 
sk
->
»duû_kn
.
sü©ch_mc_h—d”
 = 
NULL
;

67 ià(!
i¦—f
 || 
£lf_avg
) {

71 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
»duû_kn
.
sü©ch_mc_h—d”
,

72 
sk
->
»duû_kn
.
¿dix
 * 
d©a_size
, 
mty³
);

73 
sk
->
»duû_kn
.
sü©ch
 =

74 
sk
->
»duû_kn
.
sü©ch_mc_h—d”
->
addr
;

77  
¡©us
;

78 
	}
}

80 
ucc_¡©us_t
 
	$ucc__uı_»duû_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

81 
ucc_ba£_‹am_t
 *
‹am
,

82 
ucc_cŞl_sk_t
 **
sk_h
)

84 
ucc__uı_sk_t
 *
sk
;

85 
ucc_¡©us_t
 
¡©us
;

87 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

88 
¡©us
 = 
	`ucc__uı_»duû_š™
(
sk
);

89 *
sk_h
 = &
sk
->
su³r
;

90  
¡©us
;

91 
	}
}

	@src/components/tl/ucp/reduce/reduce.h

6 #iâdeà
REDUCE_H_


7 
	#REDUCE_H_


	)

8 
	~"_uı_cŞl.h
"

11 
	mUCC_TL_UCP_REDUCE_ALG_KNOMIAL
,

12 
	mUCC_TL_UCP_REDUCE_ALG_DBT
,

13 
	mUCC_TL_UCP_REDUCE_ALG_SRG
,

14 
	mUCC_TL_UCP_REDUCE_ALG_LAST


17 
ucc_ba£_cŞl_®g_šfo_t


18 
ucc__uı_»duû_®gs
[
UCC_TL_UCP_REDUCE_ALG_LAST
 + 1];

20 
	#UCC_TL_UCP_REDUCE_DEFAULT_ALG_SELECT_STR
 \

21 "»duû:0-32K:@0#»duû:32K-šf:@2"

	)

26 
	mUCC_REDUCE_KN_PHASE_INIT
,

27 
	mUCC_REDUCE_KN_PHASE_PROGRESS
,

28 
	mUCC_REDUCE_KN_PHASE_MULTI


31 
	#UCC_REDUCE_KN_CHECK_PHASE
(
_p
) \

32 
_p
: \

33 
_p
;

	)

35 
	#UCC_REDUCE_KN_GOTO_PHASE
(
_pha£
) \

37 
_pha£
) { \

38 
	`UCC_REDUCE_KN_CHECK_PHASE
(
UCC_REDUCE_KN_PHASE_MULTI
); \

39 
	`UCC_REDUCE_KN_CHECK_PHASE
(
UCC_REDUCE_KN_PHASE_PROGRESS
); \

40 
	`UCC_REDUCE_KN_CHECK_PHASE
(
UCC_REDUCE_KN_PHASE_INIT
); \

42 } 0)

	)

45 
šlše
 
	$ucc__uı_»duû_®g_äom_¡r
(cÚ¡ *
¡r
)

47 
i
;

48 
i
 = 0; i < 
UCC_TL_UCP_REDUCE_ALG_LAST
; i++) {

49 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__uı_»duû_®gs
[
i
].
Çme
)) {

53  
i
;

54 
	}
}

56 
ucc_¡©us_t
 
ucc__uı_»duû_š™
(
ucc__uı_sk_t
 *
sk
);

58 
ucc_¡©us_t
 
ucc__uı_»duû_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

59 
ucc_ba£_‹am_t
 *
‹am
,

60 
ucc_cŞl_sk_t
 **
sk_h
);

62 
ucc_¡©us_t
 
ucc__uı_»duû_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

64 
ucc__uı_»duû_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

66 
ucc_¡©us_t
 
ucc__uı_»duû_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

68 
ucc_¡©us_t
 
ucc__uı_»duû_dbt_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

69 
ucc_ba£_‹am_t
 *
‹am
,

70 
ucc_cŞl_sk_t
 **
sk_h
);

72 
ucc_¡©us_t
 
ucc__uı_»duû_¤g_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

73 
ucc_ba£_‹am_t
 *
‹am
,

74 
ucc_cŞl_sk_t
 **
sk_h
);

	@src/components/tl/ucp/reduce/reduce_dbt.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"»duû.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"_uı_£nd»cv.h
"

12 
	~"uts/ucc_dt_»duû.h
"

15 
	mRECV
,

16 
	mREDUCE
,

17 
	mTEST
,

18 
	mTEST_ROOT
,

21 
	#UCC_REDUCE_DBT_CHECK_STATE
(
_p
) \

22 
_p
: \

23 
_p
;

	)

25 
	#UCC_REDUCE_DBT_GOTO_STATE
(
_¡©e
) \

27 
_¡©e
) { \

28 
	`UCC_REDUCE_DBT_CHECK_STATE
(
REDUCE
); \

29 
	`UCC_REDUCE_DBT_CHECK_STATE
(
TEST
); \

30 
	`UCC_REDUCE_DBT_CHECK_STATE
(
TEST_ROOT
); \

32 } 0)

	)

34 
	$»cv_com¶‘iÚ_commÚ
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

35 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

36 *
u£r_d©a
)

38 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

39 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

40 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in„ecv completion %s",

41 
	`ucs_¡©us_¡ršg
(
¡©us
));

42 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

44 
	`ucc_©omic_add32
(&
sk
->
gged
.
»cv_com¶‘ed
, 1);

45 ià(
»que¡
) {

46 
	`uı_»que¡_ä“
(
»que¡
);

48 
	}
}

50 
	$»cv_com¶‘iÚ_1
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

51 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

52 *
u£r_d©a
)

54 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

56 
sk
->
»duû_dbt
.
Œ“s
[0].
»cv
++;

57 
	`»cv_com¶‘iÚ_commÚ
(
»que¡
, 
¡©us
, 
šfo
, 
u£r_d©a
);

58 
	}
}

60 
	$»cv_com¶‘iÚ_2
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

61 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

62 *
u£r_d©a
)

64 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

66 
sk
->
»duû_dbt
.
Œ“s
[1].
»cv
++;

67 
	`»cv_com¶‘iÚ_commÚ
(
»que¡
, 
¡©us
, 
šfo
, 
u£r_d©a
);

68 
	}
}

70 
šlše
 
	$sšgË_Œ“_»duû
(
ucc__uı_sk_t
 *
sk
, *
sbuf
,

71 *
rbuf
, 
n_chd»n
, 
size_t
 
couÁ
,

72 
size_t
 
d©a_size
, 
ucc_d©©y³_t
 
dt
,

73 
ucc_cŞl_¬gs_t
 *
¬gs
, 
is_avg
)

75 
ucc_¡©us_t
 
¡©us
;

77 
¡©us
 = 
	`ucc_dt_»duû_¡rided
(

78 
sbuf
,
rbuf
,„buf,

79 
n_chd»n
, 
couÁ
, 
d©a_size
,

80 
dt
, 
¬gs
,

81 
is_avg
 ? 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
 : 0,

82 
	`AVG_ALPHA
(
sk
),ask->
»duû_dbt
.
executÜ
,

83 &
sk
->
»duû_dbt
.
‘ask
);

85 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

86 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

88 
sk
->
su³r
.
¡©us
 = status;

91 
	`EXEC_TASK_WAIT
(
sk
->
»duû_dbt
.
‘ask
);

92 
	}
}

94 
	$ucc__uı_»duû_dbt_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

96 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

97 
ucc__uı_sk_t
);

98 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

99 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

100 
ucc_dbt_sšgË_Œ“_t
 *
Œ“s
 = 
sk
->
»duû_dbt
.trees ;

101 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

102 
ucc_¿nk_t
 
cŞl_roÙ
 = (ucc_¿nk_t)
¬gs
->
roÙ
;

103 
is_roÙ
 = 
¿nk
 =ğ
cŞl_roÙ
;

104 
uı_g_»cv_nbx_ÿÎback_t
 
cb
[2] = {
»cv_com¶‘iÚ_1
,

105 
»cv_com¶‘iÚ_2
};

106 *
sbuf
[2], *
rbuf
[2];

107 
ušt32_t
 
i
, 
j
, 
k
;

108 
ucc_memÜy_ty³_t
 
mty³
;

109 
ucc_d©©y³_t
 
dt
;

110 
size_t
 
couÁ
, 
d©a_size
, 
d©a_size_t1
;

111 
size_t
 
couÁs
[2];

112 
avg_´e_İ
, 
avg_po¡_İ
;

114 ià(
is_roÙ
) {

115 
mty³
 = 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

116 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

117 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

119 
mty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

120 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

121 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

124 
couÁs
[0] = (
couÁ
 % 2) ? count / 2 + 1 : count / 2;

125 
couÁs
[1] = 
couÁ
 / 2;

126 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
dt
);

127 
d©a_size_t1
 = 
couÁs
[0] * 
	`ucc_dt_size
(
dt
);

128 
avg_´e_İ
 = ((
¬gs
->
İ
 =ğ
UCC_OP_AVG
) &&

129 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
»duû_avg_´e_İ
);

130 
avg_po¡_İ
 = ((
¬gs
->
İ
 =ğ
UCC_OP_AVG
) &&

131 !
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
»duû_avg_´e_İ
);

133 
rbuf
[0] = 
sk
->
»duû_dbt
.
sü©ch
;

134 
rbuf
[1] = 
	`PTR_OFFSET
Ôbuf[0], 
d©a_size_t1
 * 2);;

135 
sbuf
[0] = 
avg_´e_İ
 ? 
	`PTR_OFFSET
(
rbuf
[0], 
d©a_size
 * 2)

136 : 
¬gs
->
¤c
.
šfo
.
bufãr
;;

137 
sbuf
[1] = 
	`PTR_OFFSET
(sbuf[0], 
d©a_size_t1
);

139 
	`UCC_REDUCE_DBT_GOTO_STATE
(
sk
->
»duû_dbt
.
¡©e
);

140 
i
 = 0; i < 2; i++) {

141 
j
 = 0;

142 
k
 = 0; k < 2; k++) {

143 ià(
Œ“s
[
i
].
chd»n
[
k
] !ğ
UCC_RANK_INVALID
) {

144 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_cb
(

145 
	`PTR_OFFSET
(
rbuf
[
i
], 
couÁs
[i] * 
	`ucc_dt_size
(
dt
è* 
j
),

146 
couÁs
[
i
] * 
	`ucc_dt_size
(
dt
), 
mty³
,

147 
Œ“s
[
i
].
chd»n
[
k
], 
‹am
, 
sk
, 
cb
[i],

148 (*)
sk
),

149 
sk
, 
out
);

150 
j
++;

155 
sk
->
»duû_dbt
.
¡©e
 = 
REDUCE
;

157 
REDUCE
:

159 
	`ucc__uı_‹¡_»cv
(
sk
);

160 
i
 = 0; i < 2; i++) {

161 ià(
Œ“s
[
i
].
»cv
 =ğŒ“s[i].
n_chd»n
 &&

162 !
sk
->
»duû_dbt
.
»duùiÚ_comp
[
i
]) {

163 ià(
Œ“s
[
i
].
n_chd»n
 > 0) {

164 
	`sšgË_Œ“_»duû
(
sk
, 
sbuf
[
i
], 
rbuf
[i], 
Œ“s
[i].
n_chd»n
,

165 
couÁs
[
i
], couÁs[i] * 
	`ucc_dt_size
(
dt
), dt,

166 
¬gs
, 
avg_po¡_İ
 && 
Œ“s
[
i
].
roÙ
 =ğ
¿nk
);

168 
sk
->
»duû_dbt
.
»duùiÚ_comp
[
i
] = 1;

172 
i
 = 0; i < 2; i++) {

173 ià(
¿nk
 !ğ
Œ“s
[
i
].
roÙ
 && 
sk
->
»duû_dbt
.
»duùiÚ_comp
[i] &&

174 !
sk
->
»duû_dbt
.
£nd_comp
[
i
]) {

175 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
((
Œ“s
[
i
].
n_chd»n
 > 0è? 
rbuf
[i]

176 : 
sbuf
[
i
],

177 
couÁs
[
i
] * 
	`ucc_dt_size
(
dt
),

178 
mty³
, 
Œ“s
[
i
].
·»Á
, 
‹am
,

179 
sk
),

180 
sk
, 
out
);

181 
sk
->
»duû_dbt
.
£nd_comp
[
i
] = 1;

185 ià(!
sk
->
»duû_dbt
.
»duùiÚ_comp
[0] ||

186 !
sk
->
»duû_dbt
.
»duùiÚ_comp
[1]) {

189 
TEST
:

190 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_£nd
(
sk
)) {

191 
sk
->
»duû_dbt
.
¡©e
 = 
TEST
;

196 
i
 = 0; i < 2; i++) {

197 ià(
¿nk
 =ğ
Œ“s
[
i
].
roÙ
 && !
is_roÙ
) {

198 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
rbuf
[
i
],

199 
couÁs
[
i
] * 
	`ucc_dt_size
(
dt
),

200 
mty³
, 
cŞl_roÙ
, 
‹am
, 
sk
),

201 
sk
, 
out
);

205 
sk
->
»duû_dbt
.
»duùiÚ_comp
[0] = 
Œ“s
[0].
»cv
;

206 
sk
->
»duû_dbt
.
»duùiÚ_comp
[1] = 
Œ“s
[1].
»cv
;

208 
i
 = 0; i < 2; i++) {

209 ià(
is_roÙ
 && 
¿nk
 !ğ
Œ“s
[
i
].
roÙ
) {

210 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_cb
(
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.
bufãr
,

211 
i
 * 
couÁs
[0] * 
	`ucc_dt_size
(
dt
)),

212 
couÁs
[
i
] * 
	`ucc_dt_size
(
dt
),

213 
mty³
, 
Œ“s
[
i
].
roÙ
, 
‹am
, 
sk
,

214 
cb
[
i
], (*)
sk
),

215 
sk
, 
out
);

216 
sk
->
»duû_dbt
.
»duùiÚ_comp
[
i
]++;

220 
TEST_ROOT
:

222 
	`ucc__uı_‹¡_»cv
(
sk
);

223 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_£nd
(
sk
) ||

224 
sk
->
»duû_dbt
.
»duùiÚ_comp
[0] !ğ
Œ“s
[0].
»cv
 ||

225 
sk
->
»duû_dbt
.
»duùiÚ_comp
[1] !ğ
Œ“s
[1].
»cv
) {

226 
sk
->
»duû_dbt
.
¡©e
 = 
TEST_ROOT
;

230 
i
 = 0; i < 2; i++) {

231 ià(
is_roÙ
 && 
¿nk
 =ğ
Œ“s
[
i
].
roÙ
) {

232 
	`UCPCHECK_GOTO
(
	`ucc_mc_memıy
(
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.
bufãr
,

233 
i
 * 
couÁs
[(˜+ 1è% 2] * 
	`ucc_dt_size
(
dt
)),

234 
rbuf
[
i
], 
couÁs
[i] * 
	`ucc_dt_size
(
dt
),

235 
mty³
, mty³), 
sk
, 
out
);

239 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

240 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_reduce_dbt_done", 0);

241 
out
:

243 
	}
}

245 
ucc_¡©us_t
 
	$ucc__uı_»duû_dbt_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

247 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

248 
ucc__uı_sk_t
);

249 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

250 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

251 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

252 
ucc_¿nk_t
 
‹am_size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

253 
avg_´e_İ
 =

254 
	`UCC_TL_UCP_TEAM_LIB
(
	`TASK_TEAM
(
sk
))->
cfg
.
»duû_avg_´e_İ
;

255 
ucc_d©©y³_t
 
dt
;

256 
size_t
 
couÁ
, 
d©a_size
;

257 
ucc_¡©us_t
 
¡©us
;

259 
sk
->
»duû_dbt
.
Œ“s
[0].
»cv
 = 0;

260 
sk
->
»duû_dbt
.
Œ“s
[1].
»cv
 = 0;

261 
sk
->
»duû_dbt
.
»duùiÚ_comp
[0] = 0;

262 
sk
->
»duû_dbt
.
»duùiÚ_comp
[1] = 0;

263 
sk
->
»duû_dbt
.
£nd_comp
[0] = 0;

264 
sk
->
»duû_dbt
.
£nd_comp
[1] = 0;

266 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

268 ià(
¬gs
->
roÙ
 =ğ
¿nk
) {

269 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

270 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

272 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

273 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

275 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
dt
);

277 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
,

278 &
sk
->
»duû_dbt
.
executÜ
);

279 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

280  
¡©us
;

283 ià(
	`UCC_IS_INPLACE
(*
¬gs
è&& (
¿nk
 =ğ¬gs->
roÙ
)) {

284 
¬gs
->
¤c
.
šfo
.
bufãr
 =‡rgs->
d¡
.info.buffer;

287 ià(
avg_´e_İ
 && 
¬gs
->
İ
 =ğ
UCC_OP_AVG
) {

289 
¡©us
 =

290 
	`ucc_dt_»duû
(
¬gs
->
¤c
.
šfo
.
bufãr
,‡rgs->src.info.buffer,

291 
	`PTR_OFFSET
(
sk
->
»duû_dbt
.
sü©ch
, 
d©a_size
 * 2),

292 
couÁ
, 
dt
, 
¬gs
, 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
,

293 1.0 / ()(
‹am_size
 * 2),

294 
sk
->
»duû_dbt
.
executÜ
, &sk->»duû_dbt.
‘ask
);

295 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

296 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

298  
¡©us
;

300 
	`EXEC_TASK_WAIT
(
sk
->
»duû_dbt
.
‘ask
, 
¡©us
);

303 
sk
->
»duû_dbt
.
¡©e
 = 
RECV
;

304 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_reduce_dbt_start", 0);

305  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

306 
	}
}

308 
ucc_¡©us_t
 
	$ucc__uı_»duû_dbt_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

310 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

312 ià(
sk
->
»duû_dbt
.
sü©ch_mc_h—d”
) {

313 
	`ucc_mc_ä“
(
sk
->
»duû_dbt
.
sü©ch_mc_h—d”
);

316  
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

317 
	}
}

319 
ucc_¡©us_t
 
	$ucc__uı_»duû_dbt_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

320 
ucc_ba£_‹am_t
 *
‹am
,

321 
ucc_cŞl_sk_t
 **
sk_h
)

323 
ucc__uı_‹am_t
 *
_‹am
;

324 
ucc__uı_sk_t
 *
sk
;

325 
ucc_¿nk_t
 
¿nk
, 
size
;

326 
ucc_memÜy_ty³_t
 
mty³
;

327 
ucc_d©©y³_t
 
dt
;

328 
size_t
 
couÁ
;

329 
size_t
 
d©a_size
;

330 
ucc_¡©us_t
 
¡©us
;

332 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

333 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

334 
sk
->
su³r
.
po¡
 = 
ucc__uı_»duû_dbt_¡¬t
;

335 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_»duû_dbt_´og»ss
;

336 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_»duû_dbt_fš®ize
;

337 
_‹am
 = 
	`TASK_TEAM
(
sk
);

338 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
_‹am
);

339 
size
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

340 
	`ucc_dbt_bud_Œ“s
(
¿nk
, 
size
, &
sk
->
»duû_dbt
.
Œ“s
[0],

341 &
sk
->
»duû_dbt
.
Œ“s
[1]);

343 ià(
cŞl_¬gs
->
¬gs
.
roÙ
 =ğ
¿nk
) {

344 
couÁ
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.count;

345 
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

346 
mty³
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
mem_ty³
;

348 
couÁ
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.count;

349 
dt
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
d©©y³
;

350 
mty³
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
mem_ty³
;

352 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
dt
);

353 
sk
->
»duû_dbt
.
sü©ch_mc_h—d”
 = 
NULL
;

354 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
»duû_dbt
.
sü©ch_mc_h—d”
, 3 * 
d©a_size
,

355 
mty³
);

356 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

357  
¡©us
;

359 
sk
->
»duû_dbt
.
sü©ch
 =ask->»duû_dbt.
sü©ch_mc_h—d”
->
addr
;

360 *
sk_h
 = &
sk
->
su³r
;

361  
UCC_OK
;

362 
	}
}

	@src/components/tl/ucp/reduce/reduce_knomial.c

7 
	~"cÚfig.h
"

8 
	~"»duû.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_dt_»duû.h
"

14 
	#SAVE_STATE
(
_pha£
) \

16 
sk
->
»duû_kn
.
pha£
 = 
_pha£
; \

17 } 0)

	)

19 
	$ucc__uı_»duû_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

21 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

22 
ucc__uı_sk_t
);

23 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

24 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

25 
avg_´e_İ
 =

26 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
»duû_avg_´e_İ
;

27 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

28 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

29 
ucc_¿nk_t
 
roÙ
 = (ucc_¿nk_t)
¬gs
->root;

30 
ušt32_t
 
¿dix
 = 
sk
->
»duû_kn
.radix;

31 
ucc_¿nk_t
 
v¿nk
 = (
¿nk
 - 
roÙ
 + 
size
) % size;

32 *
rbuf
 = (
¿nk
 =ğ
roÙ
è? 
¬gs
->
d¡
.
šfo
.
bufãr
 :

33 
sk
->
»duû_kn
.
sü©ch
;

34 
ucc_memÜy_ty³_t
 
mty³
;

35 
ucc_d©©y³_t
 
dt
;

36 
size_t
 
couÁ
, 
d©a_size
;

37 *
»ûived_veùÜs
, *
sü©ch_off£t
;

38 
ucc_¿nk_t
 
v³”
, 
³”
, 
vroÙ_©_Ëv–
, 
roÙ_©_Ëv–
, 
pos
;

39 
ušt32_t
 
i
;

40 
ucc_¡©us_t
 
¡©us
;

41 
is_avg
;

43 ià(
roÙ
 =ğ
¿nk
) {

44 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

45 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

46 
mty³
 = 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

47 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

49 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

50 
d©a_size
 = 
couÁ
 * 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

51 
mty³
 = 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

52 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

54 
»ûived_veùÜs
 = 
	`PTR_OFFSET
(
sk
->
»duû_kn
.
sü©ch
, 
d©a_size
);

56 
UCC_REDUCE_KN_PHASE_PROGRESS
:

57 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

61 
	`UCC_REDUCE_KN_GOTO_PHASE
(
sk
->
»duû_kn
.
pha£
);

63 
UCC_REDUCE_KN_PHASE_INIT
:

65 
sk
->
»duû_kn
.
di¡
 <ğsk->»duû_kn.
max_di¡
) {

66 ià(
v¿nk
 % 
sk
->
»duû_kn
.
di¡
 == 0) {

67 
pos
 = (
v¿nk
 / 
sk
->
»duû_kn
.
di¡
è% 
¿dix
;

68 ià(
pos
 == 0) {

69 
sü©ch_off£t
 = 
»ûived_veùÜs
;

70 
sk
->
»duû_kn
.
chd»n_³r_cyşe
 = 0;

71 
i
 = 1; i < 
¿dix
; i++) {

72 
v³”
 = 
v¿nk
 + 
i
 * 
sk
->
»duû_kn
.
di¡
;

73 ià(
v³”
 >ğ
size
) {

76 
sk
->
»duû_kn
.
chd»n_³r_cyşe
 += 1;

77 
³”
 = (
v³”
 + 
roÙ
è% 
size
;

78 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
sü©ch_off£t
,

79 
d©a_size
, 
mty³
, 
³”
, 
‹am
, 
sk
),

80 
sk
, 
out
);

81 
sü©ch_off£t
 = 
	`PTR_OFFSET
(sü©ch_off£t, 
d©a_size
);

84 
	`SAVE_STATE
(
UCC_REDUCE_KN_PHASE_MULTI
);

85 
UCC_REDUCE_KN_PHASE_PROGRESS
;

86 
UCC_REDUCE_KN_PHASE_MULTI
:

87 ià(
sk
->
»duû_kn
.
chd»n_³r_cyşe
 && 
couÁ
 > 0) {

88 
is_avg
 = 
¬gs
->
İ
 =ğ
UCC_OP_AVG
 &&

89 (
avg_´e_İ
 ? (
sk
->
»duû_kn
.
di¡
 == 1)

90 : (
sk
->
»duû_kn
.
di¡
 ==

91 
sk
->
»duû_kn
.
max_di¡
));

92 
¡©us
 = 
	`ucc_dt_»duû_¡rided
(

93 (
sk
->
»duû_kn
.
di¡
 =ğ1è? 
¬gs
->
¤c
.
šfo
.
bufãr


94 : 
rbuf
,

95 
»ûived_veùÜs
, 
rbuf
,

96 
sk
->
»duû_kn
.
chd»n_³r_cyşe
, 
couÁ
, 
d©a_size
,

97 
dt
, 
¬gs
,

98 
is_avg
 ? 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
 : 0,

99 
	`AVG_ALPHA
(
sk
),ask->
»duû_kn
.
executÜ
,

100 &
sk
->
»duû_kn
.
‘ask
);

101 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

102 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

104 
sk
->
su³r
.
¡©us
 = status;

107 
	`EXEC_TASK_WAIT
(
sk
->
»duû_kn
.
‘ask
);

110 
vroÙ_©_Ëv–
 = 
v¿nk
 - 
pos
 * 
sk
->
»duû_kn
.
di¡
;

111 
roÙ_©_Ëv–
 = (
vroÙ_©_Ëv–
 + 
roÙ
è% 
size
;

112 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
sk
->
»duû_kn
.
sü©ch
,

113 
d©a_size
, 
mty³
, 
roÙ_©_Ëv–
, 
‹am
, 
sk
),

114 
sk
, 
out
);

117 
sk
->
»duû_kn
.
di¡
 *ğ
¿dix
;

118 
	`SAVE_STATE
(
UCC_REDUCE_KN_PHASE_INIT
);

119 
UCC_REDUCE_KN_PHASE_PROGRESS
;

122 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
));

123 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

124 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_reduce_kn_done", 0);

125 
out
:

127 
	}
}

129 
ucc_¡©us_t
 
	$ucc__uı_»duû_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

131 
ucc__uı_sk_t
 *
sk
 =

132 
	`ucc_d”ived_of
(
cŞl_sk
, 
ucc__uı_sk_t
);

133 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

134 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

135 
ušt32_t
 
¿dix
 = 
sk
->
»duû_kn
.radix;

136 
ucc_¿nk_t
 
roÙ
 = (ucc_¿nk_t)
¬gs
->root;

137 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

138 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

139 
ucc_¿nk_t
 
v¿nk
 = (
¿nk
 - 
roÙ
 + 
size
) % size;

140 
i¦—f
 =

141 (
v¿nk
 % 
¿dix
 !ğ0 || v¿nk =ğ
size
 - 1);

142 
avg_´e_İ
 =

143 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
»duû_avg_´e_İ
;

144 
£lf_avg
 = (
¬gs
->
İ
 =ğ
UCC_OP_AVG
 &&

145 
avg_´e_İ
 && 
v¿nk
 % 
¿dix
 == 0);

146 
size_t
 
couÁ
;

147 
ucc_d©©y³_t
 
dt
;

148 
ucc_¡©us_t
 
¡©us
;

150 ià(
roÙ
 =ğ
¿nk
) {

151 
couÁ
 = 
¬gs
->
d¡
.
šfo
.count;

152 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

154 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

155 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

158 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_reduce_kn_start", 0);

159 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

161 ià(
	`UCC_IS_INPLACE
(*
¬gs
è&& (
¿nk
 =ğ
roÙ
)) {

162 
¬gs
->
¤c
.
šfo
.
bufãr
 =‡rgs->
d¡
.info.buffer;

165 ià(
i¦—f
 && !
£lf_avg
) {

166 
sk
->
»duû_kn
.
sü©ch
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

169 ià(
¬gs
->
cŞl_ty³
 !ğ
UCC_COLL_TYPE_FANIN
) {

170 
¡©us
 =

171 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
, &sk->
»duû_kn
.
executÜ
);

172 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

173  
¡©us
;

177 ià(
i¦—f
 && 
£lf_avg
) {

181 
¡©us
 =

182 
	`ucc_dt_»duû
(
¬gs
->
¤c
.
šfo
.
bufãr
,‡rgs->src.info.buffer,

183 
sk
->
»duû_kn
.
sü©ch
, 
couÁ
, 
dt
, 
¬gs
,

184 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
,

185 1.0 / ()(
	`UCC_TL_TEAM_SIZE
(
	`TASK_TEAM
(
sk
)) * 2),

186 
sk
->
»duû_kn
.
executÜ
, &sk->»duû_kn.
‘ask
);

187 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

188 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
),

190 
sk
->
su³r
.
¡©us
 = status;

191  
¡©us
;

193 
	`EXEC_TASK_WAIT
(
sk
->
»duû_kn
.
‘ask
, 
¡©us
);

196 
sk
->
»duû_kn
.
di¡
 = 1;

197 
sk
->
»duû_kn
.
pha£
 = 
UCC_REDUCE_KN_PHASE_INIT
;

199  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

200 
	}
}

202 
ucc_¡©us_t
 
	$ucc__uı_»duû_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

204 
ucc__uı_sk_t
 *
sk
 =

205 
	`ucc_d”ived_of
(
cŞl_sk
, 
ucc__uı_sk_t
);

207 ià(
sk
->
»duû_kn
.
sü©ch_mc_h—d”
) {

208 
	`ucc_mc_ä“
(
sk
->
»duû_kn
.
sü©ch_mc_h—d”
);

210  
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

211 
	}
}

	@src/components/tl/ucp/reduce/reduce_srg_knomial.c

7 
	~"cÚfig.h
"

8 
	~"»duû.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"cŞl_·‰”ns/¤a_knomŸl.h
"

12 
	~"uts/ucc_m©h.h
"

13 
	~"uts/ucc_cŞl_uts.h
"

14 
	~"compÚ’ts/mc/ucc_mc.h
"

15 
	~"../»duû_sÿ‰”/»duû_sÿ‰”.h
"

16 
	~"../g©h”/g©h”.h
"

17 
	~"../®lg©h”/®lg©h”.h
"

40 
	#GET_DT
(
_¬gs
, 
_Œªk
) \

41 (
	`UCC_IS_ROOT
(*(
_¬gs
), 
_Œªk
)) \

42 ? (
_¬gs
)->
d¡
.
šfo
.
d©©y³
 \

43 : (
_¬gs
)->
¤c
.
šfo
.
d©©y³


	)

45 
	#GET_MT
(
_¬gs
, 
_Œªk
) \

46 (
	`UCC_IS_ROOT
(*(
_¬gs
), 
_Œªk
)) \

47 ? (
_¬gs
)->
d¡
.
šfo
.
mem_ty³
 \

48 : (
_¬gs
)->
¤c
.
šfo
.
mem_ty³


	)

50 
	#GET_COUNT
(
_¬gs
, 
_Œªk
) \

51 (
	`UCC_IS_ROOT
(*(
_¬gs
), 
_Œªk
)) \

52 ? (
_¬gs
)->
d¡
.
šfo
.
couÁ
 \

53 : (
_¬gs
)->
¤c
.
šfo
.
couÁ


	)

58 
	$g‘_rs_ag_bufãrs
(
ucc__uı_scheduË_t
 *
rsg_scheduË
,

59 
ucc_cŞl_¬gs_t
 *
»duû_¬gs
,

60 
ucc_¿nk_t
 
Œªk
,

61 **
rs_rbuf
, **
rs_sbuf
,

62 **
g_rbuf
, **
g_sbuf
)

64 ià(
	`UCC_IS_ROOT
(*
»duû_¬gs
, 
Œªk
)) {

65 ià(
	`UCC_IS_INPLACE
(*
»duû_¬gs
)) {

66 *
rs_sbuf
 = 
»duû_¬gs
->
d¡
.
šfo
.
bufãr
;

67 *
rs_rbuf
 = 
rsg_scheduË
->
sü©ch_mc_h—d”
->
addr
;

69 *
g_sbuf
 = 
rsg_scheduË
->
sü©ch_mc_h—d”
->
addr
;

70 *
g_rbuf
 = 
»duû_¬gs
->
d¡
.
šfo
.
bufãr
;

72 *
rs_sbuf
 = 
»duû_¬gs
->
¤c
.
šfo
.
bufãr
;

73 *
rs_rbuf
 = 
»duû_¬gs
->
d¡
.
šfo
.
bufãr
;

76 *
g_sbuf
 = 
»duû_¬gs
->
d¡
.
šfo
.
bufãr
;

77 *
g_rbuf
 = 
»duû_¬gs
->
d¡
.
šfo
.
bufãr
;

80 *
rs_sbuf
 = 
»duû_¬gs
->
¤c
.
šfo
.
bufãr
;

81 *
rs_rbuf
 = 
rsg_scheduË
->
sü©ch_mc_h—d”
->
addr
;

83 *
g_sbuf
 = 
rsg_scheduË
->
sü©ch_mc_h—d”
->
addr
;

86 *
g_rbuf
 = 
rsg_scheduË
->
sü©ch_mc_h—d”
->
addr
;

88 
	}
}

90 
ucc_¡©us_t


91 
	$ucc__uı_»duû_¤g_knomŸl_äag_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

93  
	`ucc_scheduË_¡¬t
(
sk
);

94 
	}
}

96 
ucc_¡©us_t


97 
	$ucc__uı_»duû_¤g_knomŸl_äag_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

99 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

100 
ucc_¡©us_t
 
¡©us
;

102 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

103 
	`ucc__uı_put_scheduË
(
scheduË
);

104  
¡©us
;

105 
	}
}

107 
ucc_¡©us_t


108 
	$ucc__uı_»duû_¤g_knomŸl_äag_£tup
(
ucc_scheduË_p–šed_t
 *
scheduË_p
,

109 
ucc_scheduË_t
 *
äag
, 
äag_num
)

111 
ucc__uı_scheduË_t
 *
rsg_scheduË
 = 
	`ucc_d”ived_of
(
scheduË_p
,

112 
ucc__uı_scheduË_t
);

113 
n_äags
 = 
scheduË_p
->
su³r
.
n_sks
;

114 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
scheduË_p
->
su³r
.su³r.
b¬gs
.args;

115 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
	`TASK_TEAM
(&
scheduË_p
->
su³r
));

116 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
	`GET_DT
(
¬gs
, 
Œªk
));

117 
size_t
 
couÁ
 = 
	`GET_COUNT
(
¬gs
, 
Œªk
);

118 
size_t
 
äag_couÁ
;

119 
size_t
 
off£t
;

120 
ucc_cŞl_¬gs_t
 *
rgs
;

121 *
rs_rbuf
, *
rs_sbuf
, *
g_rbuf
, *
g_sbuf
;

123 
äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
couÁ
, 
n_äags
, 
äag_num
);

124 
off£t
 = 
	`ucc_bufãr_block_off£t
(
couÁ
, 
n_äags
, 
äag_num
);

125 
	`g‘_rs_ag_bufãrs
(
rsg_scheduË
, 
¬gs
, 
Œªk
,

126 &
rs_rbuf
, &
rs_sbuf
, &
g_rbuf
, &
g_sbuf
);

128 
rgs
 = &
äag
->
sks
[0]->
b¬gs
.
¬gs
;

129 
rgs
->
¤c
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
rs_sbuf
, 
off£t
 * 
dt_size
);

130 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
è&& !
	`UCC_IS_INPLACE
(*args)) {

131 
rgs
->
d¡
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
rs_rbuf
, 
off£t
 * 
dt_size
);

133 
rgs
->
¤c
.
šfo
.
couÁ
 = 
äag_couÁ
;

134 
rgs
->
d¡
.
šfo
.
couÁ
 = 
äag_couÁ
;

136 
rgs
 = &
äag
->
sks
[1]->
b¬gs
.
¬gs
;

137 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
è&& !
	`UCC_IS_INPLACE
(*args)) {

138 
rgs
->
¤c
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
g_sbuf
, 
off£t
 * 
dt_size
);

140 
rgs
->
¤c
.
šfo
.
couÁ
 = 
äag_couÁ
;

141 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
)) {

142 
rgs
->
d¡
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
g_rbuf
, 
off£t
 * 
dt_size
);

144 
rgs
->
d¡
.
šfo
.
couÁ
 = 
äag_couÁ
;

146  
UCC_OK
;

147 
	}
}

149 
ucc_¡©us_t


150 
	$ucc__uı_»duû_¤g_knomŸl_äag_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

151 
ucc_scheduË_p–šed_t
 *
¥
,

152 
ucc_ba£_‹am_t
 *
‹am
,

153 
ucc_scheduË_t
 **
äag_p
)

155 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

156 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
_‹am
);

157 
ucc__uı_scheduË_t
 *
rsg_scheduË
 = 
	`ucc_d”ived_of
(
¥
, ucc_tl_ucp_schedule_t);

158 
ucc_d©©y³_t
 
dt
 = 
	`GET_DT
(&
cŞl_¬gs
->
¬gs
, 
Œªk
);

159 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

160 
ucc_memÜy_ty³_t
 
mt
 = 
	`GET_MT
(&
cŞl_¬gs
->
¬gs
, 
Œªk
);

161 
size_t
 
couÁ
 = 
	`GET_COUNT
(&
cŞl_¬gs
->
¬gs
, 
Œªk
);

162 
ucc_ba£_cŞl_¬gs_t
 
¬gs
 = *
cŞl_¬gs
;

163 
ucc_m¿nge_ušt_t
 *
p
 = &
_‹am
->
cfg
.
»duû_¤g_kn_¿dix
;

164 
n_äags
 = 
¥
->
su³r
.
n_sks
;

165 
ucc_kn_¿dix_t
 
¿dix
, 
cfg_¿dix
;

166 
ucc_scheduË_t
 *
scheduË
;

167 
ucc_cŞl_sk_t
 *
g_sk
, *
rs_sk
;

168 
ucc_¡©us_t
 
¡©us
;

169 
±rdiff_t
 
sü©ch_off£t
;

170 *
rs_rbuf
, *
rs_sbuf
, *
g_rbuf
, *
g_sbuf
;

173 
sü©ch_off£t
 = 
	`ucc_bufãr_block_couÁ
(
couÁ
, 
n_äags
, 0);

174 
¡©us
 = 
	`ucc__uı_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
,

175 (
ucc__uı_scheduË_t
 **)&
scheduË
);

176 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

177  
¡©us
;

180 
cfg_¿dix
 = 
	`ucc__uı_g‘_¿dix_äom_¿nge
(
_‹am
, 
couÁ
 * 
dt_size
,

181 
mt
, 
p
, 4);

182 
¿dix
 = 
	`ucc_knomŸl_·‰”n_g‘_mš_¿dix
(
cfg_¿dix
,

183 
	`UCC_TL_TEAM_SIZE
(
_‹am
),

184 
couÁ
);

185 
	`g‘_rs_ag_bufãrs
(
rsg_scheduË
, &
cŞl_¬gs
->
¬gs
, 
Œªk
,

186 &
rs_rbuf
, &
rs_sbuf
, &
g_rbuf
, &
g_sbuf
);

189 
¬gs
.¬gs.
æags
 &ğ~
UCC_COLL_ARGS_FLAG_IN_PLACE
;

190 
¬gs
.¬gs.
¤c
.
šfo
.
bufãr
 = 
rs_sbuf
;

191 
¬gs
.¬gs.
¤c
.
šfo
.
couÁ
 = count;

192 
¬gs
.¬gs.
¤c
.
šfo
.
d©©y³
 = 
dt
;

193 
¬gs
.¬gs.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

194 ià(!
	`UCC_IS_ROOT
(
cŞl_¬gs
->
¬gs
, 
Œªk
è|| 
	`UCC_IS_INPLACE
(coll_args->args)) {

195 
¬gs
.¬gs.
d¡
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
rs_rbuf
,

196 
rsg_scheduË
->
»duû_¤g_kn
.
äag_off£t
 * 
dt_size
);

198 
¬gs
.¬gs.
d¡
.
šfo
.
couÁ
 = count;

199 
¬gs
.¬gs.
d¡
.
šfo
.
d©©y³
 = 
dt
;

200 
¬gs
.¬gs.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

202 
	`UCC_CHECK_GOTO
(
	`ucc__uı_»duû_sÿ‰”_knomŸl_š™_r
(&
¬gs
, 
‹am
,

203 &
rs_sk
, 
¿dix
),

204 
out
, 
¡©us
);

205 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
rs_sk
), 
out
, 
¡©us
);

207 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(&
scheduË
->
su³r
, 
rs_sk
,

208 
UCC_EVENT_SCHEDULE_STARTED
),

209 
out
, 
¡©us
);

212 ià(!
	`UCC_IS_ROOT
(
cŞl_¬gs
->
¬gs
, 
Œªk
è|| 
	`UCC_IS_INPLACE
(coll_args->args)) {

213 
¬gs
.¬gs.
¤c
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
g_sbuf
,

214 
rsg_scheduË
->
»duû_¤g_kn
.
äag_off£t
 * 
dt_size
);

216 
¬gs
.¬gs.
¤c
.
šfo
.
couÁ
 = count;

217 
¬gs
.¬gs.
¤c
.
šfo
.
d©©y³
 = 
dt
;

218 
¬gs
.¬gs.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

219 ià(
	`UCC_IS_ROOT
(
cŞl_¬gs
->
¬gs
, 
Œªk
)) {

220 
¬gs
.¬gs.
d¡
.
šfo
.
bufãr
 = 
	`PTR_OFFSET
(
g_rbuf
,

221 
rsg_scheduË
->
»duû_¤g_kn
.
äag_off£t
 * 
dt_size
);

223 
¬gs
.¬gs.
d¡
.
šfo
.
couÁ
 = count;

224 
¬gs
.¬gs.
d¡
.
šfo
.
d©©y³
 = 
dt
;

225 
¬gs
.¬gs.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

226 ià(
	`UCC_IS_ROOT
(
cŞl_¬gs
->
¬gs
, 
Œªk
è&& !
	`UCC_IS_INPLACE
(coll_args->args)) {

227 
¬gs
.¬gs.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

228 
¬gs
.¬gs.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

231 
	`UCC_CHECK_GOTO
(
	`ucc__uı_g©h”_knomŸl_š™_r
(&
¬gs
, 
‹am
, &
g_sk
, 
¿dix
),

232 
out
, 
¡©us
);

233 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
g_sk
), 
out
, 
¡©us
);

235 
	`UCC_CHECK_GOTO
(
	`ucc_sk_subsüibe_d•
(
rs_sk
, 
g_sk
, 
UCC_EVENT_COMPLETED
),

236 
out
, 
¡©us
);

237 
rsg_scheduË
->
»duû_¤g_kn
.
äag_off£t
 +ğ
sü©ch_off£t
;

238 
scheduË
->
su³r
.
fš®ize
 = 
ucc__uı_»duû_¤g_knomŸl_äag_fš®ize
;

239 
scheduË
->
su³r
.
po¡
 = 
ucc__uı_»duû_¤g_knomŸl_äag_¡¬t
;

240 *
äag_p
 = 
scheduË
;

241  
UCC_OK
;

242 
out
:

243  
¡©us
;

244 
	}
}

246 
ucc_¡©us_t


247 
	$ucc__uı_»duû_¤g_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

249 
ucc__uı_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
,

250 
ucc__uı_scheduË_t
);

251 
ucc_¡©us_t
 
¡©us
;

253 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
scheduË
, "ucp_reduce_srg_kn_done", 0);

254 ià(
scheduË
->
sü©ch_mc_h—d”
) {

255 
	`ucc_mc_ä“
(
scheduË
->
sü©ch_mc_h—d”
);

257 
¡©us
 = 
	`ucc_scheduË_p–šed_fš®ize
(
sk
);

258 
	`ucc__uı_put_scheduË
(&
scheduË
->
su³r
.super);

259  
¡©us
;

260 
	}
}

262 
ucc_¡©us_t
 
	$ucc__uı_»duû_¤g_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

264 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
sk
, "ucp_reduce_srg_kn_start", 0);

265  
	`ucc_scheduË_p–šed_po¡
(
sk
);

266 
	}
}

269 
	$ucc__uı_»duû_¤g_knomŸl_g‘_p–še_·¿ms
(
ucc__uı_‹am_t
 *
‹am
,

270 
ucc_memÜy_ty³_t
 
mty³
,

271 
ucc_p–še_·¿ms_t
 *
µ
)

273 
ucc__uı_lib_cÚfig_t
 *
cfg
 = &
‹am
->cfg;

274 
ucc_mc_©Œ_t
 
mc_©Œ
;

276 ià(!
	`ucc_p–še_·¿ms_is_auto
(&
cfg
->
»duû_¤g_kn_p–še
)) {

277 *
µ
 = 
cfg
->
»duû_¤g_kn_p–še
;

281 ià(
mty³
 =ğ
UCC_MEMORY_TYPE_CUDA
) {

282 
mc_©Œ
.
f›ld_mask
 = 
UCC_MC_ATTR_FIELD_FAST_ALLOC_SIZE
;

283 
	`ucc_mc_g‘_©Œ
(&
mc_©Œ
, 
UCC_MEMORY_TYPE_CUDA
);

284 
µ
->
th»shŞd
 = 
mc_©Œ
.
ç¡_®loc_size
;

285 
µ
->
n_äags
 = 2;

286 
µ
->
Üd”
 = 
UCC_PIPELINE_PARALLEL
;

287 
µ
->
pd•th
 = 2;

288 
µ
->
äag_size
 = 
mc_©Œ
.
ç¡_®loc_size
 /…p->
pd•th
;

290 
µ
->
th»shŞd
 = 
SIZE_MAX
;

291 
µ
->
n_äags
 = 0;

292 
µ
->
pd•th
 = 1;

293 
µ
->
Üd”
 = 
UCC_PIPELINE_PARALLEL
;

294 
µ
->
äag_size
 = 0;

296 
	}
}

298 
ucc_¡©us_t
 
	$ucc__uı_»duû_¤g_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

299 
ucc_ba£_‹am_t
 *
‹am
,

300 
ucc_cŞl_sk_t
 **
sk_h
)

302 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

303 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
cŞl_¬gs
->args;

304 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
_‹am
);

305 
ucc_memÜy_ty³_t
 
mt
 = 
	`GET_MT
(
¬gs
, 
Œªk
);

306 
size_t
 
couÁ
 = 
	`GET_COUNT
(
¬gs
, 
Œªk
);

307 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
	`GET_DT
(
¬gs
, 
Œªk
));

308 
n_äags
, 
p–še_d•th
;

309 
ucc__uı_scheduË_t
 *
scheduË
;

310 
ucc_¡©us_t
 
¡
;

311 
ucc_ba£_cŞl_¬gs_t
 
b¬gs
;

312 
size_t
 
max_äag_couÁ
;

313 
ucc_p–še_·¿ms_t
 
p–še_·¿ms
;

315 
¡
 = 
	`ucc__uı_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
, &
scheduË
);

316 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡
)) {

317 
”r_out
;

320 
scheduË
->
sü©ch_mc_h—d”
 = 
NULL
;

321 
scheduË
->
»duû_¤g_kn
.
äag_off£t
 = 0;

323 
b¬gs
 = *
cŞl_¬gs
;

324 
max_äag_couÁ
 = (
b¬gs
.
mask
 & 
UCC_BASE_CARGS_MAX_FRAG_COUNT
) ?

325 
b¬gs
.
max_äag_couÁ
: 
couÁ
;

326 
	`ucc__uı_»duû_¤g_knomŸl_g‘_p–še_·¿ms
(
_‹am
, 
mt
,

327 &
p–še_·¿ms
);

328 
	`ucc_p–še_näags_pd•th
(&
p–še_·¿ms
, 
max_äag_couÁ
 * 
dt_size
,

329 &
n_äags
, &
p–še_d•th
);

330 
b¬gs
.
max_äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(max_äag_couÁ, 
n_äags
, 0);

331 ià(
n_äags
 > 1) {

332 
b¬gs
.
mask
 |ğ
UCC_BASE_CARGS_MAX_FRAG_COUNT
;

335 ià(!
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
è|| 
	`UCC_IS_INPLACE
(*args)) {

336 
¡
 = 
	`ucc_mc_®loc
(&
scheduË
->
sü©ch_mc_h—d”
, 
b¬gs
.
max_äag_couÁ
 * 
dt_size
 * 
p–še_d•th
, 
mt
);

337 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡
)) {

338 
	`_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "failedo‡lloc scratch memory");

339 
”r_ä“_scheduË
;

343 
¡
 = 
	`ucc_scheduË_p–šed_š™
(&
b¬gs
, 
‹am
,

344 
ucc__uı_»duû_¤g_knomŸl_äag_š™
,

345 
ucc__uı_»duû_¤g_knomŸl_äag_£tup
,

346 
p–še_d•th
, 
n_äags
,

347 
p–še_·¿ms
.
Üd”
,

348 &
scheduË
->
su³r
);

349 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡
)) {

350 
	`_”rÜ
(
‹am
->
cÚ‹xt
->
lib
, "failedo init…ipelined schedule");

351 
”r_ä“_sü©ch
;

354 
scheduË
->
su³r
.su³r.su³r.
fš®ize
 = 
ucc__uı_»duû_¤g_knomŸl_fš®ize
;

355 
scheduË
->
su³r
.su³r.su³r.
po¡
 = 
ucc__uı_»duû_¤g_knomŸl_¡¬t
;

357 *
sk_h
 = &
scheduË
->
su³r
.super.super;

358  
UCC_OK
;

360 
”r_ä“_sü©ch
:

361 
	`ucc_mc_ä“
(
scheduË
->
sü©ch_mc_h—d”
);

362 
”r_ä“_scheduË
:

363 
	`ucc__uı_put_scheduË
(&
scheduË
->
su³r
.super);

364 
”r_out
:

365  
¡
;

366 
	}
}

	@src/components/tl/ucp/reduce_scatter/reduce_scatter.c

7 
	~"_uı.h
"

8 
	~"»duû_sÿ‰”.h
"

9 
	~"uts/ucc_cŞl_uts.h
"

11 
ucc_ba£_cŞl_®g_šfo_t


12 
	gucc__uı_»duû_sÿ‰”_®gs
[
UCC_TL_UCP_REDUCE_SCATTER_ALG_LAST
 + 1] = {

13 [
UCC_TL_UCP_REDUCE_SCATTER_ALG_RING
] =

14 {.
id
 = 
UCC_TL_UCP_REDUCE_SCATTER_ALG_RING
,

15 .
	gÇme
 = "ring",

16 .
	gdesc
 = "O(N)„ing"},

17 [
UCC_TL_UCP_REDUCE_SCATTER_ALG_KNOMIAL
] =

18 {.
id
 = 
UCC_TL_UCP_REDUCE_SCATTER_ALG_KNOMIAL
,

19 .
	gÇme
 = "knomial",

20 .
	gdesc
 = "recursive k-ing with‡rbitrary„adix"},

21 [
UCC_TL_UCP_REDUCE_SCATTER_ALG_LAST
] = {

22 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

	@src/components/tl/ucp/reduce_scatter/reduce_scatter.h

7 #iâdeà
REDUCE_SCATTER_H_


8 
	#REDUCE_SCATTER_H_


	)

9 
	~"_uı_cŞl.h
"

13 
	mUCC_TL_UCP_REDUCE_SCATTER_ALG_RING
,

14 
	mUCC_TL_UCP_REDUCE_SCATTER_ALG_KNOMIAL
,

15 
	mUCC_TL_UCP_REDUCE_SCATTER_ALG_LAST


18 
ucc_ba£_cŞl_®g_šfo_t


19 
ucc__uı_»duû_sÿ‰”_®gs
[
UCC_TL_UCP_REDUCE_SCATTER_ALG_LAST
 + 1];

21 
	#UCC_TL_UCP_REDUCE_SCATTER_DEFAULT_ALG_SELECT_STR
 \

22 "»duû_sÿ‰”:@ršg"

	)

24 
šlše
 
	$ucc__uı_»duû_sÿ‰”_®g_äom_¡r
(cÚ¡ *
¡r
)

26 
i
;

27 
i
 = 0; i < 
UCC_TL_UCP_REDUCE_SCATTER_ALG_LAST
; i++) {

28 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__uı_»duû_sÿ‰”_®gs
[
i
].
Çme
)) {

32  
i
;

33 
	}
}

37 
ucc_¡©us_t


38 
ucc__uı_»duû_sÿ‰”_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

39 
ucc_ba£_‹am_t
 *
‹am
,

40 
ucc_cŞl_sk_t
 **
sk_h
);

43 
ucc_¡©us_t
 
ucc__uı_»duû_sÿ‰”_knomŸl_š™_r
(

44 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

45 
ucc_cŞl_sk_t
 **
sk_h
, 
ucc_kn_¿dix_t
 
¿dix
);

47 
ucc_¡©us_t


48 
ucc__uı_»duû_sÿ‰”_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

49 
ucc_ba£_‹am_t
 * 
‹am
,

50 
ucc_cŞl_sk_t
 ** 
sk_h
);

	@src/components/tl/ucp/reduce_scatter/reduce_scatter_knomial.c

7 
	~"»duû_sÿ‰”.h
"

8 
	~"_uı_£nd»cv.h
"

9 
	~"cŞl_·‰”ns/¤a_knomŸl.h
"

10 
	~"uts/ucc_m©h.h
"

11 
	~"uts/ucc_dt_»duû.h
"

13 
	#SAVE_STATE
(
_pha£
) \

15 
sk
->
»duû_sÿ‰”_kn
.
pha£
 = 
_pha£
; \

16 } 0)

	)

18 
	#GET_COUNT
(
_¬gs
) \

20 
size_t
 
_couÁ
 = 0; \

21 (
_¬gs
)->
cŞl_ty³
) { \

22 
UCC_COLL_TYPE_ALLREDUCE
: \

23 
UCC_COLL_TYPE_REDUCE
: \

24 
_couÁ
 = (
_¬gs
)->
d¡
.
šfo
.
couÁ
; \

26 
UCC_COLL_TYPE_REDUCE_SCATTER
: \

27 
_couÁ
 = 
	`UCC_IS_INPLACE
(*(
_¬gs
)) \

28 ? (
_¬gs
)->
d¡
.
šfo
.
couÁ
 \

29 : (
_¬gs
)->
¤c
.
šfo
.
couÁ
; \

34 
_couÁ
; \

35 })

	)

37 
	#GET_DT
(
_¬gs
) \

38 ((
_¬gs
)->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE_SCATTERV
) \

39 ? (
_¬gs
)->
d¡
.
šfo_v
.
d©©y³
 \

40 : (
_¬gs
)->
d¡
.
šfo
.
d©©y³


	)

42 
	succ__uı_rs_wÜk_buf
 {

43 *
	m¤c_d©a
;

44 *
	md¡_d©a
;

45 *
	m¤c_loİ
;

46 *
	md¡_loİ
;

47 *
	md¡_´oxy
;

48 *
	m»duû_´oxy
;

49 *
	m»duû_loİ
;

50 } 
	tucc__uı_rs_wÜk_buf_t
;

53 
šlše
 
	$g‘_sbuf_rbuf_¬
(
ucc__uı_sk_t
 *
sk
,

54 
size_t
 
block_couÁ
,

55 
ucc__uı_rs_wÜk_buf_t
 *
wb
)

57 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

58 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

59 *
sü©ch
 = 
sk
->
»duû_sÿ‰”_kn
.scratch;

60 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
»duû_sÿ‰”_kn
.p;

61 
size_t
 
off£t
, 
loÿl_£g_couÁ
;

62 
±rdiff_t
 
loÿl_£g_off£t
;

63 *
sbuf
, *
rbuf
;

65 ià(
	`ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
p
)) {

66 
sbuf
 = ((
KN_NODE_PROXY
 =ğ
p
->
node_ty³
è|| 
	`UCC_IS_INPLACE
(*
¬gs
))

67 ? 
¬gs
->
d¡
.
šfo
.
bufãr
:‡rgs->
¤c
.info.buffer;

68 
rbuf
 = 
sü©ch
;

70 
sbuf
 = 
sü©ch
;

71 ià(!
	`ucc_knomŸl_·‰”n_loİ_Ï¡_™”©iÚ
(
p
) ||

72 (
sk
->
»duû_sÿ‰”_kn
.
sü©ch_mc_h—d”
 !ğ
NULL
)) {

73 
rbuf
 = 
	`PTR_OFFSET
(
sbuf
, 
block_couÁ
 * 
dt_size
);

75 
	`ucc_¤a_kn_g‘_off£t_ªd_£gËn
(
¬gs
->
d¡
.
šfo
.
couÁ
, 
dt_size
,

76 
p
->
¿nk
,…->
size
,

77 
p
->
¿dix
, &
loÿl_£g_off£t
,

78 &
loÿl_£g_couÁ
);

79 
loÿl_£g_off£t
 =†oÿl_£g_off£ˆ/ 
dt_size
;

80 ià((
loÿl_£g_off£t
 <ğ
block_couÁ
è|| (
loÿl_£g_couÁ
 == 0)) {

81 
rbuf
 = 
	`PTR_OFFSET
(
sbuf
, 
block_couÁ
 * 
dt_size
);

83 
off£t
 = (
loÿl_£g_off£t
 - 
block_couÁ
è% 
loÿl_£g_couÁ
;

85 
	`ucc_as£¹
(
¬gs
->
d¡
.
šfo
.
couÁ
 - (
block_couÁ
 + 
off£t
) >=

86 
loÿl_£g_couÁ
 * (
	`ucc_kn_compu‹_¡•_¿dix
(
p
) - 1));

87 
rbuf
 = 
	`PTR_OFFSET
(
sbuf
, (
block_couÁ
 + 
off£t
è* 
dt_size
);

92 ià(
	`ucc_knomŸl_·‰”n_loİ_Ï¡_™”©iÚ
(
p
)) {

93 
	`ucc_¤a_kn_g‘_off£t_ªd_£gËn
(
¬gs
->
d¡
.
šfo
.
couÁ
, 
dt_size
, 
p
->
¿nk
,

94 
p
->
size
,…->
¿dix
, &
loÿl_£g_off£t
,

95 &
loÿl_£g_couÁ
);

96 
wb
->
»duû_loİ
 = 
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.
bufãr
, 
loÿl_£g_off£t
);

98 
wb
->
»duû_loİ
 = 
sü©ch
;

100 
wb
->
¤c_d©a
 = 
	`UCC_IS_INPLACE
(*
¬gs
è?‡rgs->
d¡
.
šfo
.
bufãr


101 : 
¬gs
->
¤c
.
šfo
.
bufãr
;

102 
wb
->
¤c_loİ
 = 
sbuf
;

103 
wb
->
d¡_loİ
 = 
rbuf
;

104 
wb
->
d¡_´oxy
 = 
sü©ch
;

105 
wb
->
»duû_´oxy
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

106 
	}
}

109 
šlše
 
	$g‘_sbuf_rbuf_rs
(
ucc__uı_sk_t
 *
sk
,

110 
ucc__uı_rs_wÜk_buf_t
 *
wb
)

112 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

113 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
»duû_sÿ‰”_kn
.p;

114 *
sü©ch
 = 
sk
->
»duû_sÿ‰”_kn
.scratch;

115 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

116 
ucc_¿nk_t
 
Œªk
 = 
sk
->
sub£t
.
my¿nk
;

117 
ucc_¿nk_t
 
tsize
 = 
sk
->
sub£t
.
m­
.
•_num
;

118 
ucc_kn_¿dix_t
 
¿dix
 = 
p
->radix;

119 
size_t
 
max_£g
;

120 *
sbuf
, *
rbuf
, *
d©a_buf
;

122 
max_£g
 = 
sk
->
»duû_sÿ‰”_kn
.max_seg;

124 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

125 
d©a_buf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

126 
wb
->
d¡_d©a
 = 
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.
bufãr
,

127 (
¬gs
->
d¡
.
šfo
.
couÁ
 / 
tsize
) *

128 
Œªk
 * 
dt_size
);

130 
d©a_buf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

131 
wb
->
d¡_d©a
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

134 ià(
KN_NODE_PROXY
 =ğ
p
->
node_ty³
) {

135 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

136 
rbuf
 = 
	`PTR_OFFSET
(
sü©ch
, 
max_£g
 * 
dt_size
);

137 ià(
	`ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
p
)) {

138 
sbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

140 
sbuf
 = 
sü©ch
;

142 
wb
->
d¡_´oxy
 = 
sü©ch
;

143 
wb
->
»duû_´oxy
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

145 
sbuf
 = 
	`PTR_OFFSET
(
sü©ch
, 
max_£g
 * (
¿dix
 - 1è* 
dt_size
);

146 
rbuf
 = 
sü©ch
;

147 
wb
->
d¡_´oxy
 = 
	`PTR_OFFSET
(
sü©ch
,

148 
max_£g
 * (
¿dix
 - 1è* 
dt_size
);

149 
wb
->
»duû_´oxy
 = wb->
d¡_´oxy
;

152 
rbuf
 = 
	`PTR_OFFSET
(
sü©ch
, 
max_£g
 * 
dt_size
);

153 ià(
	`ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
p
)) {

154 
sbuf
 = 
d©a_buf
;

156 
sbuf
 = 
sü©ch
;

160 ià(
	`ucc_knomŸl_·‰”n_loİ_Ï¡_™”©iÚ
(
p
)) {

161 ià(
KN_NODE_PROXY
 =ğ
p
->
node_ty³
) {

162 
wb
->
»duû_loİ
 = 
	`PTR_OFFSET
(
sü©ch
,

163 
max_£g
 * (
¿dix
 - 1è* 
dt_size
);

165 
wb
->
»duû_loİ
 = wb->
d¡_d©a
;

168 ià(
KN_NODE_PROXY
 =ğ
p
->
node_ty³
) {

169 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

170 
wb
->
»duû_loİ
 = 
sü©ch
;

172 
wb
->
»duû_loİ
 = 
	`PTR_OFFSET
(
sü©ch
, 
max_£g
 * (
¿dix
 - 1è* 
dt_size
);

175 
wb
->
»duû_loİ
 = 
sü©ch
;

179 
wb
->
¤c_loİ
 = 
sbuf
;

180 
wb
->
d¡_loİ
 = 
rbuf
;

181 
wb
->
¤c_d©a
 = 
d©a_buf
;

182 
	}
}

184 
šlše
 
	$g‘_rs_wÜk_buf
(
ucc__uı_sk_t
 *
sk
,

185 
size_t
 
block_couÁ
,

186 
ucc__uı_rs_wÜk_buf_t
 *
wb
)

188 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

190 
¬gs
->
cŞl_ty³
) {

191 
UCC_COLL_TYPE_ALLREDUCE
:

192 
UCC_COLL_TYPE_REDUCE
:

193  
	`g‘_sbuf_rbuf_¬
(
sk
, 
block_couÁ
, 
wb
);

194 
UCC_COLL_TYPE_REDUCE_SCATTER
:

195  
	`g‘_sbuf_rbuf_rs
(
sk
, 
wb
);

196 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

198 
	`ucc_as£¹
(0);

201 
	}
}

205 
šlše
 
ucc_¿nk_t
 
	$g‘_physiÿl_¿nk
(
ucc__uı_sk_t
 *
sk
, 
ucc_¿nk_t
 
¿nk
,

206 
ucc_¿nk_t
 
roÙ
, ucc_¿nk_ˆ
size
)

208  
	`INV_VRANK
(
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, 
¿nk
), 
roÙ
, 
size
);

209 
	}
}

211 
	$ucc__uı_»duû_sÿ‰”_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

213 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

214 
ucc__uı_sk_t
);

215 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

216 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

217 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
»duû_sÿ‰”_kn
.p;

218 
ucc_kn_¿dix_t
 
¿dix
 = 
p
->radix;

219 
ušt8_t
 
node_ty³
 = 
p
->node_type;

220 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
d¡
.
šfo
.mem_type;

221 
size_t
 
couÁ
 = 
	`GET_COUNT
(
¬gs
);

222 
ucc_d©©y³_t
 
dt
 = 
	`GET_DT
(
¬gs
);

223 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

224 
size_t
 
d©a_size
 = 
couÁ
 * 
dt_size
;

225 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

226 
ucc_¿nk_t
 
size
 = 
sk
->
sub£t
.
m­
.
•_num
;

227 
ucc_¿nk_t
 
roÙ
 = 0;

228 
size_t
 
loÿl_£g_couÁ
 = 0;

229 
ucc__uı_rs_wÜk_buf_t
 
wb
 = (ucc_tl_ucp_rs_work_buf_t){0};

230 
±rdiff_t
 
³”_£g_off£t
, 
loÿl_£g_off£t
;

231 
ucc_¿nk_t
 
³”
;

232 
ucc_¡©us_t
 
¡©us
;

233 
ucc_kn_¿dix_t
 
¡•_¿dix
, 
loİ_¡•
;

234 
size_t
 
block_couÁ
, 
³”_£g_couÁ
;

235 *
loÿl_d©a
;

236 
is_avg
;

238 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE
) {

239 
roÙ
 = 
¬gs
->root;

240 
¿nk
 = 
	`VRANK
Ôªk, 
roÙ
, 
size
);

243 
	`UCC_KN_REDUCE_GOTO_PHASE
(
sk
->
»duû_sÿ‰”_kn
.
pha£
);

244 
block_couÁ
 = 
	`ucc_¤a_kn_compu‹_block_couÁ
(
couÁ
, 
¿nk
, 
p
);

245 
	`g‘_rs_wÜk_buf
(
sk
, 
block_couÁ
, &
wb
);

246 ià(
KN_NODE_EXTRA
 =ğ
node_ty³
) {

247 
³”
 = 
	`g‘_physiÿl_¿nk
(
sk
, 
	`ucc_knomŸl_·‰”n_g‘_´oxy
(
p
, 
¿nk
),

248 
roÙ
, 
size
);

249 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
wb
.
¤c_d©a
, 
d©a_size
, 
mem_ty³
,

250 
³”
, 
‹am
, 
sk
),

251 
sk
, 
out
);

252 ià(
p
->
ty³
 !ğ
KN_PATTERN_REDUCE_SCATTERX
) {

253 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
wb
.
d¡_d©a
, (
couÁ
 / 
size
è* 
dt_size
,

254 
mem_ty³
, 
³”
, 
‹am
, 
sk
),

255 
sk
, 
out
);

259 ià(
KN_NODE_PROXY
 =ğ
node_ty³
) {

260 
³”
 = 
	`g‘_physiÿl_¿nk
(
sk
, 
	`ucc_knomŸl_·‰”n_g‘_exŒa
(
p
, 
¿nk
),

261 
roÙ
, 
size
);

262 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
wb
.
d¡_´oxy
, 
d©a_size
, 
mem_ty³
,

263 
³”
, 
‹am
, 
sk
),

264 
sk
, 
out
);

267 
UCC_KN_PHASE_EXTRA
:

268 
block_couÁ
 = 
	`ucc_¤a_kn_compu‹_block_couÁ
(
couÁ
, 
¿nk
, 
p
);

269 
	`g‘_rs_wÜk_buf
(
sk
, 
block_couÁ
, &
wb
);

270 ià((
KN_NODE_PROXY
 =ğ
node_ty³
è|| (
KN_NODE_EXTRA
 ==‚ode_type)) {

271 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

272 
	`SAVE_STATE
(
UCC_KN_PHASE_EXTRA
);

275 ià(
KN_NODE_EXTRA
 =ğ
node_ty³
) {

276 
out
;

278 
¡©us
 = 
	`ucc_dt_»duû
(
wb
.
¤c_d©a
, wb.
d¡_´oxy
, wb.
»duû_´oxy
,

279 
couÁ
, 
dt
, 
¬gs
, 0, 0,

280 
sk
->
»duû_sÿ‰”_kn
.
executÜ
,

281 &
sk
->
»duû_sÿ‰”_kn
.
‘ask
);

282 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

283 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo…erform dt„eduction");

284 
sk
->
su³r
.
¡©us
 = status;

288 
UCC_KN_PHASE_EXTRA_REDUCE
:

289 
	`EXEC_TASK_TEST
(
UCC_KN_PHASE_EXTRA_REDUCE
,

291 
sk
->
»duû_sÿ‰”_kn
.
‘ask
);

294 !
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

295 
block_couÁ
 = 
	`ucc_¤a_kn_compu‹_block_couÁ
(
couÁ
, 
¿nk
, 
p
);

296 
loÿl_£g_couÁ
 = 0;

297 
	`ucc_kn_rs_·‰”n_³”_£g
(
¿nk
, 
p
, &
loÿl_£g_couÁ
,

298 &
loÿl_£g_off£t
);

299 
	`g‘_rs_wÜk_buf
(
sk
, 
block_couÁ
, &
wb
);

300 
loİ_¡•
 = 
¿dix
 - 1;†oop_step > 0;†oop_step--) {

301 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
loİ_¡•
);

302 ià(
³”
 =ğ
UCC_KN_PEER_NULL
) {

305 
	`ucc_kn_rs_·‰”n_³”_£g
(
³”
, 
p
, &
³”_£g_couÁ
,

306 &
³”_£g_off£t
);

307 
³”
 = 
	`g‘_physiÿl_¿nk
(
sk
,…“r, 
roÙ
, 
size
);

308 
	`UCPCHECK_GOTO
(

309 
	`ucc__uı_£nd_nb
(
	`PTR_OFFSET
(
wb
.
¤c_loİ
, 
³”_£g_off£t
 * 
dt_size
),

310 
³”_£g_couÁ
 * 
dt_size
, 
mem_ty³
, 
³”
,

311 
‹am
, 
sk
),

312 
sk
, 
out
);

313 
	`UCPCHECK_GOTO
(

314 
	`ucc__uı_»cv_nb
(
wb
.
d¡_loİ
, 
loÿl_£g_couÁ
 * 
dt_size
, 
mem_ty³
,

315 
³”
, 
‹am
, 
sk
),

316 
sk
, 
out
);

317 
wb
.
d¡_loİ
 = 
	`PTR_OFFSET
(wb.d¡_loİ, 
loÿl_£g_couÁ
 * 
dt_size
);

320 
UCC_KN_PHASE_LOOP
:

321 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

322 
	`SAVE_STATE
(
UCC_KN_PHASE_LOOP
);

325 ià(
sk
->
gged
.
£nd_po¡ed
 > 
p
->
™”©iÚ
 * (
¿dix
 - 1)) {

326 
¡•_¿dix
 = 
	`ucc_kn_compu‹_¡•_¿dix
(
p
);

327 
loÿl_£g_couÁ
 = 0;

328 
block_couÁ
 = 
	`ucc_¤a_kn_compu‹_block_couÁ
(
couÁ
, 
¿nk
, 
p
);

329 
	`ucc_kn_rs_·‰”n_³”_£g
(
¿nk
, 
p
, &
loÿl_£g_couÁ
,

330 &
loÿl_£g_off£t
);

331 
	`g‘_rs_wÜk_buf
(
sk
, 
block_couÁ
, &
wb
);

332 
loÿl_d©a
 = 
	`PTR_OFFSET
(
wb
.
¤c_loİ
, 
loÿl_£g_off£t
 * 
dt_size
);

333 
is_avg
 = (
¬gs
->
İ
 =ğ
UCC_OP_AVG
) &&

334 (
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
»duû_avg_´e_İ
 ?

335 
	`ucc_knomŸl_·‰”n_loİ_fœ¡_™”©iÚ
(
p
) :

336 
	`ucc_knomŸl_·‰”n_loİ_Ï¡_™”©iÚ
(
p
));

337 
¡©us
 = 
	`ucc_dt_»duû_¡rided
(
loÿl_d©a
, 
wb
.
d¡_loİ
, wb.
»duû_loİ
,

338 
¡•_¿dix
 - 1, 
loÿl_£g_couÁ
,

339 
loÿl_£g_couÁ
 * 
dt_size
, 
dt
, 
¬gs
,

340 
is_avg
 ? 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
 : 0,

341 
	`AVG_ALPHA
(
sk
),ask->
»duû_sÿ‰”_kn
.
executÜ
,

342 &
sk
->
»duû_sÿ‰”_kn
.
‘ask
);

343 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

344 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo…erform dt„eduction");

345 
sk
->
su³r
.
¡©us
 = status;

349 
UCC_KN_PHASE_REDUCE
:

350 
	`EXEC_TASK_TEST
(
UCC_KN_PHASE_REDUCE
,

352 
sk
->
»duû_sÿ‰”_kn
.
‘ask
);

354 ià((
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE_SCATTER
) &&

355 (
KN_NODE_PROXY
 =ğ
node_ty³
) &&

356 
	`ucc_knomŸl_·‰”n_loİ_Ï¡_™”©iÚ
(
p
)) {

357 
	`g‘_rs_wÜk_buf
(
sk
, 0, &
wb
);

358 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_exŒa
(
p
, 
¿nk
);

359 
³”_£g_couÁ
 = 0;

360 
³”_£g_off£t
 = 0;

361 
	`ucc_kn_rs_·‰”n_exŒa_£g
(
p
, &
³”_£g_couÁ
, &
³”_£g_off£t
);

362 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(

363 
	`PTR_OFFSET
(
wb
.
»duû_loİ
,

364 
³”_£g_off£t
 * 
dt_size
),

365 
³”_£g_couÁ
 * 
dt_size
, 
mem_ty³
, 
³”
, 
‹am
, 
sk
),

366 
sk
, 
out
);

367 
	`ucc_mc_memıy
(
wb
.
d¡_d©a
, wb.
»duû_loİ
, 
³”_£g_couÁ
 * 
dt_size
,

368 
mem_ty³
, mem_type);

370 
	`ucc_kn_rs_·‰”n_Ãxt_™”
(
p
);

373 
UCC_KN_PHASE_COMPLETE
:

374 
UCC_KN_PHASE_PROXY
:

375 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

376 
	`SAVE_STATE
(
UCC_KN_PHASE_PROXY
);

379 
out
:

380 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_reduce_scatter_kn_done",

382 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

383 
	}
}

385 
ucc_¡©us_t
 
	$ucc__uı_»duû_sÿ‰”_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

387 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

388 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

389 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

390 
ucc_¿nk_t
 
size
 = 
sk
->
sub£t
.
m­
.
•_num
;

391 
ucc_cŞl_ty³_t
 
ù
 = 
¬gs
->
cŞl_ty³
;

392 
ucc_¿nk_t
 
roÙ
 = (
ù
 =ğ
UCC_COLL_TYPE_REDUCE
è? 
¬gs
->root : 0;

393 
ucc_¿nk_t
 
¿nk
 = 
	`VRANK
(
sk
->
sub£t
.
my¿nk
, 
roÙ
, 
size
);

394 
size_t
 
couÁ
 = 
	`GET_COUNT
(
¬gs
);

395 
ucc_¡©us_t
 
¡©us
;

397 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_reduce_scatter_kn_start",

399 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

401 ià((
ù
 =ğ
UCC_COLL_TYPE_ALLREDUCE
) ||

402 (
ù
 =ğ
UCC_COLL_TYPE_REDUCE
)) {

403 
	`ucc_kn_rsx_·‰”n_š™
(
size
, 
¿nk
, 
sk
->
»duû_sÿ‰”_kn
.
p
.
¿dix
,

404 
couÁ
, &
sk
->
»duû_sÿ‰”_kn
.
p
);

406 
	`ucc_kn_rs_·‰”n_š™
(
size
, 
¿nk
, 
sk
->
»duû_sÿ‰”_kn
.
p
.
¿dix
,

407 
couÁ
, &
sk
->
»duû_sÿ‰”_kn
.
p
);

410 ià(!
sk
->
»duû_sÿ‰”_kn
.
sü©ch_mc_h—d”
) {

411 
sk
->
»duû_sÿ‰”_kn
.
sü©ch
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

413 
sk
->
»duû_sÿ‰”_kn
.
pha£
 = 
UCC_KN_PHASE_INIT
;

415 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
,

416 &
sk
->
»duû_sÿ‰”_kn
.
executÜ
);

417 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

418  
¡©us
;

421  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

422 
	}
}

424 
ucc_¡©us_t


425 
	$ucc__uı_»duû_sÿ‰”_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

427 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

429 ià(
sk
->
»duû_sÿ‰”_kn
.
sü©ch_mc_h—d”
) {

430 
	`ucc_mc_ä“
(
sk
->
»duû_sÿ‰”_kn
.
sü©ch_mc_h—d”
);

432  
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

433 
	}
}

435 
size_t
 
	$compu‹_sü©ch_size
(
ucc__uı_sk_t
 *
sk
)

437 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

438 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
 = &
sk
->
su³r
.
b¬gs
;

439 
size_t
 
couÁ
 = 
	`GET_COUNT
(
¬gs
);

440 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
	`GET_DT
(
¬gs
));

441 
size_t
 
max_£g
 = 
sk
->
»duû_sÿ‰”_kn
.max_seg;

442 
size_t
 
d©a_size
;

443 
ucc_kn_¿dix_t
 
¡•_¿dix
;

444 
size_t
 
max_»cv_size
;

446 ià((
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_ALLREDUCE
) ||

447 (
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE
)) {

448 ià(
KN_NODE_EXTRA
 !ğ
sk
->
»duû_sÿ‰”_kn
.
p
.
node_ty³
) {

449 ià(
cŞl_¬gs
->
mask
 & 
UCC_BASE_CARGS_MAX_FRAG_COUNT
) {

450 
couÁ
 = 
cŞl_¬gs
->
max_äag_couÁ
;

452 
d©a_size
 = 
couÁ
 * 
dt_size
;

453 
¡•_¿dix
 = 
	`ucc_kn_compu‹_¡•_¿dix
(&
sk
->
»duû_sÿ‰”_kn
.
p
);

454 
max_»cv_size
 = 
	`ucc_¤a_kn_compu‹_£g_size
(
couÁ
, 
¡•_¿dix
, 0) *

455 
¡•_¿dix
 * 
dt_size
;

456 ià(
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
) ||

457 (
KN_NODE_PROXY
 =ğ
sk
->
»duû_sÿ‰”_kn
.
p
.
node_ty³
) ||

458 
max_»cv_size
 > 
d©a_size
) {

459  
	`ucc_max
(
max_»cv_size
, 
d©a_size
);

465 
¡•_¿dix
 = 
sk
->
»duû_sÿ‰”_kn
.
p
.
¿dix
;

466 ià(
KN_NODE_PROXY
 =ğ
sk
->
»duû_sÿ‰”_kn
.
p
.
node_ty³
) {

467 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

468  
max_£g
 * 
¡•_¿dix
 * 
dt_size
;

470  (
max_£g
 * (
¡•_¿dix
 - 1è+ 
couÁ
è* 
dt_size
;

472 } ià(
KN_NODE_EXTRA
 !ğ
sk
->
»duû_sÿ‰”_kn
.
p
.
node_ty³
) {

473  
max_£g
 * 
¡•_¿dix
 * 
dt_size
;

477 
	}
}

479 
ucc_¡©us_t


480 
	$ucc__uı_»duû_sÿ‰”_knomŸl_š™_r
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

481 
ucc_ba£_‹am_t
 *
‹am
,

482 
ucc_cŞl_sk_t
 **
sk_h
,

483 
ucc_kn_¿dix_t
 
¿dix
)

485 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

486 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.mem_type;

487 
size_t
 
couÁ
 = 
	`GET_COUNT
(&
cŞl_¬gs
->
¬gs
);

488 
ucc_cŞl_ty³_t
 
ù
 = 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
;

489 
ucc_sbgp_t
 *
sbgp
;

490 
ucc__uı_sk_t
 *
sk
;

491 
ucc_¡©us_t
 
¡©us
;

492 
size_t
 
sü©ch_size
;

493 
ucc_¿nk_t
 
¿nk
, 
size
;

494 
±rdiff_t
 
max_£g_off£t
;

496 ià(
	`ucc_uÆik–y
(!
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
) &&

497 (
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
mem_ty³
 !=

498 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
mem_ty³
))) {

499  
UCC_ERR_NOT_SUPPORTED
;

502 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

503 
sk
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

504 
sk
->
su³r
.
po¡
 = 
ucc__uı_»duû_sÿ‰”_knomŸl_¡¬t
;

505 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_»duû_sÿ‰”_knomŸl_´og»ss
;

506 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_»duû_sÿ‰”_knomŸl_fš®ize
;

508 ià(
_‹am
->
cfg
.
u£_»Üd”šg
 && 
ù
 =ğ
UCC_COLL_TYPE_ALLREDUCE
) {

509 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
_‹am
->
tİo
, 
UCC_SBGP_FULL_HOST_ORDERED
);

510 
sk
->
sub£t
.
my¿nk
 = 
sbgp
->
group_¿nk
;

511 
sk
->
sub£t
.
m­
 = 
sbgp
->map;

514 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

515 
size
 = 
sk
->
sub£t
.
m­
.
•_num
;

517 ià(
ù
 =ğ
UCC_COLL_TYPE_ALLREDUCE
) {

518 
	`ucc_kn_rsx_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
,

519 
couÁ
, &
sk
->
»duû_sÿ‰”_kn
.
p
);

521 } ià(
ù
 =ğ
UCC_COLL_TYPE_REDUCE
) {

522 
	`ucc_kn_rsx_·‰”n_š™
(
size
, 
	`VRANK
(
¿nk
, 
cŞl_¬gs
->
¬gs
.
roÙ
, size),

523 
¿dix
, 
couÁ
, &
sk
->
»duû_sÿ‰”_kn
.
p
);

525 
	`ucc_kn_rs_·‰”n_š™
(
size
, 
¿nk
, 
¿dix
,

526 
couÁ
, &
sk
->
»duû_sÿ‰”_kn
.
p
);

529 
	`ucc_kn_rs_·‰”n_³”_£g
(0, &
sk
->
»duû_sÿ‰”_kn
.
p
,

530 &
sk
->
»duû_sÿ‰”_kn
.
max_£g
,

531 &
max_£g_off£t
);

532 
sk
->
»duû_sÿ‰”_kn
.
sü©ch_mc_h—d”
 = 
NULL
;

534 
sü©ch_size
 = 
	`compu‹_sü©ch_size
(
sk
);

535 ià(
sü©ch_size
 != 0) {

536 
¡©us
 = 
	`ucc_mc_®loc
(&
sk
->
»duû_sÿ‰”_kn
.
sü©ch_mc_h—d”
,

537 
sü©ch_size
, 
mem_ty³
);

538 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

539 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo‡llocate scratch buffer");

540 
	`ucc__uı_cŞl_fš®ize
(&
sk
->
su³r
);

541  
¡©us
;

543 
sk
->
»duû_sÿ‰”_kn
.
sü©ch
 =

544 
sk
->
»duû_sÿ‰”_kn
.
sü©ch_mc_h—d”
->
addr
;

547 *
sk_h
 = &
sk
->
su³r
;

548  
UCC_OK
;

549 
	}
}

551 
ucc_¡©us_t


552 
	$ucc__uı_»duû_sÿ‰”_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

553 
ucc_ba£_‹am_t
 *
‹am
,

554 
ucc_cŞl_sk_t
 **
sk_h
)

556 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

557 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

558 
size_t
 
couÁ
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.count;

559 
ucc_kn_¿dix_t
 
¿dix
, 
cfg_¿dix
;

561 
cfg_¿dix
 = 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
»duû_sÿ‰”_kn_¿dix
;

562 
¿dix
 = 
	`ucc_knomŸl_·‰”n_g‘_mš_¿dix
(
cfg_¿dix
, 
size
, 
couÁ
);

563  
	`ucc__uı_»duû_sÿ‰”_knomŸl_š™_r
(
cŞl_¬gs
, 
‹am
, 
sk_h
,

564 
¿dix
);

565 
	}
}

	@src/components/tl/ucp/reduce_scatter/reduce_scatter_ring.c

7 
	~"»duû_sÿ‰”.h
"

8 
	~"_uı_£nd»cv.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"uts/ucc_dt_»duû.h
"

14 
	~"uts/ucc_©omic.h
"

16 
	#REVERSED_FRAG
 1

	)

18 
šlše
 
	$£nd_com¶‘iÚ_commÚ
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

19 *
u£r_d©a
)

21 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

23 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

24 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in„s„ing completion %s",

25 
	`ucs_¡©us_¡ršg
(
¡©us
));

26 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

28 
	`ucc_©omic_add32
(&
sk
->
gged
.
£nd_com¶‘ed
, 1);

29 ià(
»que¡
) {

30 
	`uı_»que¡_ä“
(
»que¡
);

32 
	}
}

34 
	$£nd_com¶‘iÚ_1
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

35 *
u£r_d©a
)

37 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

39 
sk
->
»duû_sÿ‰”_ršg
.
s_sü©ch_busy
[0] = 0;

40 
	`£nd_com¶‘iÚ_commÚ
(
»que¡
, 
¡©us
, 
u£r_d©a
);

41 
	}
}

43 
	$£nd_com¶‘iÚ_2
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

44 *
u£r_d©a
)

46 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

48 
sk
->
»duû_sÿ‰”_ršg
.
s_sü©ch_busy
[1] = 0;

49 
	`£nd_com¶‘iÚ_commÚ
(
»que¡
, 
¡©us
, 
u£r_d©a
);

50 
	}
}

52 
šlše
 
	$ucc_ršg_äag_couÁ
(
ucc__uı_sk_t
 *
sk
, 
size_t
 
couÁ
,

53 
ucc_¿nk_t
 
block
, 
size_t
 *
äag_couÁ
)

55 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

56 
size_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

57 
n_äags
, 
äag
;

58 
size_t
 
block_couÁ
;

60 
n_äags
 = 
sk
->
»duû_sÿ‰”_ršg
.n_frags;

61 
äag
 = 
sk
->
»duû_sÿ‰”_ršg
.frag;

63 
block_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
couÁ
, 
size
, 
block
);

64 *
äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
block_couÁ
, 
n_äags
, 
äag
);

65 
	}
}

67 
šlše
 
	$ucc_ršg_äag_block_off£t
(
ucc__uı_sk_t
 *
sk
,

68 
size_t
 
couÁ
, 
ucc_¿nk_t
 
block
,

69 
size_t
 *
block_off£t
,

70 
size_t
 *
äag_off£t
)

72 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

73 
size_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

74 
n_äags
, 
äag
;

75 
size_t
 
block_couÁ
;

77 
n_äags
 = 
sk
->
»duû_sÿ‰”_ršg
.n_frags;

78 
äag
 = 
sk
->
»duû_sÿ‰”_ršg
.frag;

80 
block_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
couÁ
, 
size
, 
block
);

81 *
äag_off£t
 = 
	`ucc_bufãr_block_off£t
(
block_couÁ
, 
n_äags
, 
äag
);

82 *
block_off£t
 = 
	`ucc_bufãr_block_off£t
(
couÁ
, 
size
, 
block
);

83 
	}
}

85 
	$ucc__uı_»duû_sÿ‰”_ršg_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

87 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

88 
ucc__uı_sk_t
);

89 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

90 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

91 
ucc_¿nk_t
 
size
 = 
sk
->
sub£t
.
m­
.
•_num
;

92 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

93 *
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

94 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
d¡
.
šfo
.mem_type;

95 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.couÁ * 
size
;

96 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

97 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

98 
ucc_¿nk_t
 
£ndto
 = (
¿nk
 + 1è% 
size
;

99 
ucc_¿nk_t
 
»cväom
 = (
¿nk
 - 1 + 
size
) % size;

100 
uı_£nd_nbx_ÿÎback_t
 
cb
[2] = {
£nd_com¶‘iÚ_1
, 
£nd_com¶‘iÚ_2
};

101 
ucc_¿nk_t
 
´evblock
, 
»cv_d©a_äom
;

102 
ucc_¡©us_t
 
¡©us
;

103 
size_t
 
max_block_size
, 
block_off£t
, 
äag_couÁ
, 
äag_off£t
, 
fš®_off£t
;

104 
¡•
, 
is_avg
, 
id
;

105 *
r_sü©ch
, *
s_sü©ch
[2], *
»duû_rg‘
;

106 vŞ©*
busy
;

108 
fš®_off£t
 = 0;

109 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

110 
sbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

111 
couÁ
 /ğ
size
;

112 
fš®_off£t
 =

113 
	`ucc_bufãr_block_off£t
(
couÁ
, 
size
, 
	`UCC_TL_TEAM_RANK
(
‹am
));

116 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
, sendto);

117 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
,„ecvfrom);

118 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

119 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, sendto);

120 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,„ecvfrom);

122 
max_block_size
 = 
sk
->
»duû_sÿ‰”_ršg
.
max_block_couÁ
 * 
dt_size
;

123 
busy
 = 
sk
->
»duû_sÿ‰”_ršg
.
s_sü©ch_busy
;

124 
r_sü©ch
 = 
sk
->
»duû_sÿ‰”_ršg
.
sü©ch
;

125 
s_sü©ch
[0] = 
	`PTR_OFFSET
(
r_sü©ch
, 
max_block_size
);

126 
s_sü©ch
[1] = 
	`PTR_OFFSET
(s_sü©ch[0], 
max_block_size
);

128 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_ršg
(
sk
)) {

131 
sk
->
gged
.
»cv_po¡ed
 > 0) {

133 
	`ucc_as£¹
(!
busy
[0] || !busy[1]);

134 
id
 = 
busy
[0] ? 1 : 0;

135 
»duû_rg‘
 = 
s_sü©ch
[
id
];

136 
¡•
 = 
sk
->
gged
.
£nd_po¡ed
;

137 
´evblock
 = (
¿nk
 - 1 - 
¡•
 + 
size
) % size;

138 
´evblock
 =

139 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
, 
´evblock
);

140 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

141 
´evblock
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,…revblock);

144 
	`ucc_as£¹
(
sk
->
gged
.
»cv_po¡ed
 =ğsk->gged.
»cv_com¶‘ed
);

145 
	`ucc_as£¹
(
sk
->
gged
.
»cv_po¡ed
 < 
size
);

147 
	`ucc_ršg_äag_couÁ
(
sk
, 
couÁ
, 
´evblock
, &
äag_couÁ
);

148 
	`ucc_ršg_äag_block_off£t
(
sk
, 
couÁ
, 
´evblock
, &
block_off£t
,

149 &
äag_off£t
);

150 ià(
sk
->
gged
.
»cv_com¶‘ed
 =ğ
size
 - 1) {

151 
»duû_rg‘
 = 
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo
.
bufãr
,

152 (
äag_off£t
 + 
fš®_off£t
è* 
dt_size
);

154 
is_avg
 = (
¬gs
->
İ
 =ğ
UCC_OP_AVG
) &&

155 (
sk
->
gged
.
»cv_com¶‘ed
 =ğ(
size
 - 1));

156 ià(
UCC_OK
 !=

157 (
¡©us
 = 
	`ucc_dt_»duû
(

158 
r_sü©ch
,

159 
	`PTR_OFFSET
(
sbuf
, (
block_off£t
 + 
äag_off£t
è* 
dt_size
),

160 
»duû_rg‘
, 
äag_couÁ
, 
dt
, 
¬gs
,

161 
is_avg
 ? 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
 : 0,

162 
	`AVG_ALPHA
(
sk
),ask->
»duû_sÿ‰”_ršg
.
executÜ
,

163 &
sk
->
»duû_sÿ‰”_ršg
.
‘ask
))) {

164 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo…erform dt„eduction");

165 
sk
->
su³r
.
¡©us
 = status;

168 
	`EXEC_TASK_WAIT
(
sk
->
»duû_sÿ‰”_ršg
.
‘ask
);

169 ià(
sk
->
gged
.
»cv_com¶‘ed
 =ğ
size
 - 1) {

170 
sk
->
gged
.
»cv_po¡ed
 =ask->gged.
»cv_com¶‘ed
 = 0;

173 
	`ucc_as£¹
(
sk
->
gged
.
£nd_po¡ed
 -ask->gged.
£nd_com¶‘ed
 <= 1);

174 
	`ucc_as£¹
(
sk
->
gged
.
£nd_po¡ed
 < 
size
);

176 
busy
[
id
] = 1;

177 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_cb
(
»duû_rg‘
, 
äag_couÁ
 * 
dt_size
,

178 
mem_ty³
, 
£ndto
, 
‹am
, 
sk
, 
cb
[
id
], (*)task),

179 
sk
, 
out
);

181 
»cv_d©a_äom
 = (
¿nk
 - 2 - 
¡•
 + 
size
) % size;

182 
»cv_d©a_äom
 =

183 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
, 
»cv_d©a_äom
);

184 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

185 
»cv_d©a_äom
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,„ecv_data_from);

187 
	`ucc_ršg_äag_couÁ
(
sk
, 
couÁ
, 
»cv_d©a_äom
, &
äag_couÁ
);

189 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
r_sü©ch
, 
äag_couÁ
 * 
dt_size
, 
mem_ty³
,

190 
»cväom
, 
‹am
, 
sk
),

191 
sk
, 
out
);

193 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_ršg
(
sk
)) {

197 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

200 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

201 
out
:

203 
	}
}

205 
ucc_¡©us_t


206 
	$ucc__uı_»duû_sÿ‰”_ršg_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

208 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

209 
ucc_cŞl_¬gs_t
 * 
¬gs
 = &
	`TASK_ARGS
(
sk
);

210 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

211 
ucc_¿nk_t
 
size
 = 
sk
->
sub£t
.
m­
.
•_num
;

212 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

213 
size_t
 
couÁ
 = 
¬gs
->
d¡
.
šfo
.couÁ * 
size
;

214 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
d¡
.
šfo
.
d©©y³
;

215 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

216 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
d¡
.
šfo
.mem_type;

217 * 
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

218 
¡•
 = 0;

219 
ucc_¿nk_t
 
£ndto
 = (
¿nk
 + 1è% 
size
;

220 
ucc_¿nk_t
 
»cväom
 = (
¿nk
 - 1 + 
size
) % size;

221 
ucc_¿nk_t
 
»cv_block
 = (
¿nk
 - 2 - 
¡•
 + 
size
) % size;

222 
ucc_¿nk_t
 
£nd_block
 = (
¿nk
 - 1 - 
¡•
 + 
size
) % size;

223 
size_t
 
block_off£t
, 
äag_couÁ
, 
äag_off£t
;

224 *
r_sü©ch
;

225 
ucc_¡©us_t
 
¡©us
;

227 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

228 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

229 
sbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

230 
couÁ
 /ğ
size
;

232 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
,

233 &
sk
->
»duû_sÿ‰”_ršg
.
executÜ
);

234 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

235  
¡©us
;

238 
r_sü©ch
 = 
sk
->
»duû_sÿ‰”_ršg
.
sü©ch
;

239 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
, sendto);

240 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
,„ecvfrom);

241 
»cv_block
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
,„ecv_block);

242 
£nd_block
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
, send_block);

243 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

244 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, sendto);

245 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,„ecvfrom);

246 
»cv_block
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,„ecv_block);

247 
£nd_block
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, send_block);

250 
	`ucc_ršg_äag_couÁ
(
sk
, 
couÁ
, 
»cv_block
, &
äag_couÁ
);

251 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
r_sü©ch
, 
äag_couÁ
 * 
dt_size
, 
mem_ty³
,

252 
»cväom
, 
‹am
, 
sk
),

253 
sk
, 
out
);

255 
	`ucc_ršg_äag_couÁ
(
sk
, 
couÁ
, 
£nd_block
, &
äag_couÁ
);

256 
	`ucc_ršg_äag_block_off£t
(
sk
, 
couÁ
, 
£nd_block
, &
block_off£t
,

257 &
äag_off£t
);

258 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(

259 
	`PTR_OFFSET
(
sbuf
, (
block_off£t
 + 
äag_off£t
è* 
dt_size
),

260 
äag_couÁ
 * 
dt_size
, 
mem_ty³
, 
£ndto
, 
‹am
, 
sk
),

261 
sk
, 
out
);

263  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

264 
out
:

265  
sk
->
su³r
.
¡©us
;

266 
	}
}

268 
ucc_¡©us_t


269 
	$ucc__uı_»duû_sÿ‰”_ršg_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

271 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

272 ià(
sk
->
»duû_sÿ‰”_ršg
.
äag
 =ğ
REVERSED_FRAG
) {

273 
	`ucc_•_m­_de¡roy
(&
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
);

275  
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

276 
	}
}

278 
ucc_¡©us_t
 
	$ucc__uı_»duû_sÿ‰”_ršg_š™_sub£t
(

279 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

280 
ucc_cŞl_sk_t
 **
sk_h
, 
ucc_sub£t_t
 *
sub£ts
, 
n_äags
, 
äag
,

281 *
sü©ch
, 
size_t
 
max_block_couÁ
)

283 
ucc__uı_sk_t
 *
sk
;

284 
ucc__uı_‹am_t
 *
_‹am
;

285 
ucc_¡©us_t
 
¡©us
;

287 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

288 
_‹am
 = 
	`TASK_TEAM
(
sk
);

289 
sk
->
su³r
.
po¡
 = 
ucc__uı_»duû_sÿ‰”_ršg_¡¬t
;

290 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_»duû_sÿ‰”_ršg_´og»ss
;

291 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_»duû_sÿ‰”_ršg_fš®ize
;

292 
sk
->
sub£t
.
m­
 = 
sub£ts
[
äag
].map;

293 
sk
->
sub£t
.
my¿nk
 = 
sub£ts
[
äag
].myrank;

294 ià(
äag
 =ğ
REVERSED_FRAG
) {

295 ià(
_‹am
->
cfg
.
u£_»Üd”šg
) {

296 
sk
->
sub£t
.
m­
 = 
sub£ts
[0].map;

298 
¡©us
 = 
	`ucc_•_m­_ü—‹_šv”£
(
sub£ts
[
äag
].
m­
,

299 &
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
,

300 
äag
 && 
_‹am
->
cfg
.
u£_»Üd”šg
);

301 ià(
UCC_OK
 !ğ
¡©us
) {

302  
¡©us
;

305 
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

306 
sk
->
»duû_sÿ‰”_ršg
.
šv_m­
.
•_num
 =ask->
sub£t
.
m­
.ep_num;

308 
sk
->
»duû_sÿ‰”_ršg
.
n_äags
 =‚_frags;

309 
sk
->
»duû_sÿ‰”_ršg
.
äag
 = frag;

310 
sk
->
»duû_sÿ‰”_ršg
.
sü©ch
 = scratch;

311 
sk
->
»duû_sÿ‰”_ršg
.
max_block_couÁ
 = max_block_count;

312 
sk
->
»duû_sÿ‰”_ršg
.
s_sü©ch_busy
[0] = 0;

313 
sk
->
»duû_sÿ‰”_ršg
.
s_sü©ch_busy
[1] = 0;

314 *
sk_h
 = &
sk
->
su³r
;

315  
UCC_OK
;

316 
	}
}

318 
ucc_¡©us_t


319 
	$ucc__uı_»duû_sÿ‰”_ršg_sched_po¡
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

321  
	`ucc_scheduË_¡¬t
(
cŞl_sk
);

322 
	}
}

324 
ucc_¡©us_t


325 
	$ucc__uı_»duû_sÿ‰”_ršg_sched_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

327 
ucc__uı_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
,

328 
ucc__uı_scheduË_t
);

329 
ucc_¡©us_t
 
¡©us
;

331 
	`ucc_mc_ä“
(
scheduË
->
sü©ch_mc_h—d”
);

332 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

333 
	`ucc__uı_put_scheduË
(&
scheduË
->
su³r
.super);

334  
¡©us
;

335 
	}
}

337 
ucc_¡©us_t


338 
	$ucc__uı_»duû_sÿ‰”_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

339 
ucc_ba£_‹am_t
 * 
‹am
,

340 
ucc_cŞl_sk_t
 ** 
sk_h
)

342 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

343 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

344 
size_t
 
couÁ
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.count;

345 
ucc_d©©y³_t
 
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
d©©y³
;

346 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

347 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.mem_type;

348 
bidœ
 =

349 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
»duû_sÿ‰”_ršg_bidœeùiÚ®
;

350 
size_t
 
to_®loc_³r_£t
, 
max_£gcouÁ
, 
couÁ_³r_£t
;

351 
ucc__uı_scheduË_t
 *
_scheduË
;

352 
ucc_scheduË_t
 *
scheduË
;

353 
ucc_cŞl_sk_t
 *
ùask
;

354 
ucc_sbgp_t
 *
sbgp
;

355 
ucc_¡©us_t
 
¡©us
;

356 
ucc_sub£t_t
 
s
[2];

357 
i
, 
n_sub£ts
;

359 ià(
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
»duû_avg_´e_İ
 &&

360 
cŞl_¬gs
->
¬gs
.
İ
 =ğ
UCC_OP_AVG
) {

361  
UCC_ERR_NOT_SUPPORTED
;

364 ià(!
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
)) {

365 
couÁ
 *ğ
size
;

368 
¡©us
 = 
	`ucc__uı_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
, &
_scheduË
);

369 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

370  
¡©us
;

373 
scheduË
 = &
_scheduË
->
su³r
.super;

376 
n_sub£ts
 = (
bidœ
 && (
couÁ
 > 
size
)) ? 2 : 1;

378 ià(
_‹am
->
cfg
.
u£_»Üd”šg
) {

379 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
_‹am
->
tİo
, 
UCC_SBGP_FULL_HOST_ORDERED
);

380 
s
[0].
my¿nk
 = 
sbgp
->
group_¿nk
;

381 
s
[0].
m­
 = 
sbgp
->map;

383 
s
[0].
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(
_‹am
);

384 
s
[0].
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

385 
s
[0].
m­
.
•_num
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

387 
s
[1].
m­
 = 
	`ucc_•_m­_ü—‹_»v”£
(
	`UCC_TL_TEAM_SIZE
(
_‹am
));

388 
s
[1].
my¿nk
 = 
	`ucc_•_m­_ev®
(s[1].
m­
, s[0].myrank);

389 
couÁ_³r_£t
 = (
couÁ
 + 
n_sub£ts
 - 1) /‚_subsets;

390 
max_£gcouÁ
 = 
	`ucc_bufãr_block_couÁ
(
couÁ_³r_£t
, 
size
, 0);

393 
to_®loc_³r_£t
 = 
max_£gcouÁ
 * 3;

394 
	`UCC_CHECK_GOTO
(
	`ucc_mc_®loc
(&
_scheduË
->
sü©ch_mc_h—d”
,

395 
to_®loc_³r_£t
 * 
dt_size
 * 
n_sub£ts
,

396 
mem_ty³
),

397 
out
, 
¡©us
);

398 
i
 = 0; i < 
n_sub£ts
; i++) {

399 
	`UCC_CHECK_GOTO
(
	`ucc__uı_»duû_sÿ‰”_ršg_š™_sub£t
(

400 
cŞl_¬gs
, 
‹am
, &
ùask
, 
s
, 
n_sub£ts
, 
i
,

401 
	`PTR_OFFSET
(
_scheduË
->
sü©ch_mc_h—d”
->
addr
,

402 
to_®loc_³r_£t
 * 
i
 * 
dt_size
),

403 
max_£gcouÁ
),

404 
out_ä“
, 
¡©us
);

405 
ùask
->
n_d•s
 = 1;

406 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
ùask
), 
out_ä“
,

407 
¡©us
);

408 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(

409 &
scheduË
->
su³r
, 
UCC_EVENT_SCHEDULE_STARTED
, 
ùask
,

410 
ucc_sk_¡¬t_hªdËr
),

411 
out_ä“
, 
¡©us
);

413 
scheduË
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

414 
scheduË
->
su³r
.
po¡
 = 
ucc__uı_»duû_sÿ‰”_ršg_sched_po¡
;

415 
scheduË
->
su³r
.
fš®ize
 = 
ucc__uı_»duû_sÿ‰”_ršg_sched_fš®ize
;

416 *
sk_h
 = &
scheduË
->
su³r
;

417  
UCC_OK
;

419 
out_ä“
:

420 
	`ucc_mc_ä“
(
_scheduË
->
sü©ch_mc_h—d”
);

421 
out
:

422 
	`ucc__uı_put_scheduË
(
scheduË
);

423  
¡©us
;

424 
	}
}

	@src/components/tl/ucp/reduce_scatterv/reduce_scatterv.c

6 
	~"_uı.h
"

7 
	~"»duû_sÿ‰”v.h
"

8 
	~"uts/ucc_cŞl_uts.h
"

10 
ucc_ba£_cŞl_®g_šfo_t


11 
	gucc__uı_»duû_sÿ‰”v_®gs
[
UCC_TL_UCP_REDUCE_SCATTERV_ALG_LAST
 + 1] = {

12 [
UCC_TL_UCP_REDUCE_SCATTERV_ALG_RING
] =

13 {.
id
 = 
UCC_TL_UCP_REDUCE_SCATTERV_ALG_RING
,

14 .
	gÇme
 = "ring",

15 .
	gdesc
 = "O(N)„ing"},

16 [
UCC_TL_UCP_REDUCE_SCATTERV_ALG_LAST
] = {

17 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

	@src/components/tl/ucp/reduce_scatterv/reduce_scatterv.h

6 #iâdeà
REDUCE_SCATTERV_H_


7 
	#REDUCE_SCATTERV_H_


	)

8 
	~"_uı_cŞl.h
"

12 
	mUCC_TL_UCP_REDUCE_SCATTERV_ALG_RING
,

13 
	mUCC_TL_UCP_REDUCE_SCATTERV_ALG_LAST


16 
ucc_ba£_cŞl_®g_šfo_t


17 
ucc__uı_»duû_sÿ‰”v_®gs
[
UCC_TL_UCP_REDUCE_SCATTERV_ALG_LAST
 + 1];

19 
	#UCC_TL_UCP_REDUCE_SCATTERV_DEFAULT_ALG_SELECT_STR
 \

20 "»duû_sÿ‰”v:@ršg"

	)

22 
šlše
 
	$ucc__uı_»duû_sÿ‰”v_®g_äom_¡r
(cÚ¡ *
¡r
)

24 
i
;

25 
i
 = 0; i < 
UCC_TL_UCP_REDUCE_SCATTERV_ALG_LAST
; i++) {

26 ià(0 =ğ
	`¡rÿ£cmp
(
¡r
, 
ucc__uı_»duû_sÿ‰”v_®gs
[
i
].
Çme
)) {

30  
i
;

31 
	}
}

33 
ucc_¡©us_t


34 
ucc__uı_»duû_sÿ‰”v_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

35 
ucc_ba£_‹am_t
 * 
‹am
,

36 
ucc_cŞl_sk_t
 ** 
sk_h
);

	@src/components/tl/ucp/reduce_scatterv/reduce_scatterv_ring.c

7 
	~"»duû_sÿ‰”v.h
"

8 
	~"_uı_£nd»cv.h
"

9 
	~"cÜe/ucc_´og»ss_queue.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"uts/ucc_dt_»duû.h
"

15 
	#REVERSED_FRAG
 1

	)

17 
šlše
 
	$£nd_com¶‘iÚ_commÚ
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

18 *
u£r_d©a
)

20 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

22 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

23 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in„s„ing completion %s",

24 
	`ucs_¡©us_¡ršg
(
¡©us
));

25 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

27 
	`ucc_©omic_add32
(&
sk
->
gged
.
£nd_com¶‘ed
, 1);

28 ià(
»que¡
) {

29 
	`uı_»que¡_ä“
(
»que¡
);

31 
	}
}

33 
	$£nd_com¶‘iÚ_1
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

34 *
u£r_d©a
)

36 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

38 
sk
->
»duû_sÿ‰”v_ršg
.
s_sü©ch_busy
[0] = 0;

39 
	`£nd_com¶‘iÚ_commÚ
(
»que¡
, 
¡©us
, 
u£r_d©a
);

40 
	}
}

42 
	$£nd_com¶‘iÚ_2
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

43 *
u£r_d©a
)

45 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

47 
sk
->
»duû_sÿ‰”v_ršg
.
s_sü©ch_busy
[1] = 0;

48 
	`£nd_com¶‘iÚ_commÚ
(
»que¡
, 
¡©us
, 
u£r_d©a
);

49 
	}
}

51 
šlše
 
	$ucc_ršg_äag_couÁ
(
ucc__uı_sk_t
 *
sk
,

52 
ucc_¿nk_t
 
block
, 
size_t
 *
äag_couÁ
)

54 
n_äags
, 
äag
;

55 
size_t
 
block_couÁ
;

57 
n_äags
 = 
sk
->
»duû_sÿ‰”v_ršg
.n_frags;

58 
äag
 = 
sk
->
»duû_sÿ‰”v_ršg
.frag;

60 
block_couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(

61 &
	`TASK_ARGS
(
sk
), TASK_ARGSÑask).
d¡
.
šfo_v
.
couÁs
, 
block
);

62 *
äag_couÁ
 = 
	`ucc_bufãr_block_couÁ
(
block_couÁ
, 
n_äags
, 
äag
);

63 
	}
}

65 
šlše
 
size_t
 
	$g‘_block_off£t
(
ucc_cŞl_¬gs_t
 *
¬gs
, 
ucc_¿nk_t
 
block
)

67 
size_t
 
off£t
 = 0;

68 
i
;

70 
i
 = 0; i < 
block
; i++) {

71 
off£t
 +ğ
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
i
);

73  
off£t
;

74 
	}
}

76 
šlše
 
	$ucc_ršg_äag_block_off£t
(
ucc__uı_sk_t
 *
sk
,

77 
ucc_¿nk_t
 
block
,

78 
size_t
 * 
block_off£t
,

79 
size_t
 * 
äag_off£t
)

81 
n_äags
, 
äag
;

82 
size_t
 
block_couÁ
;

84 
n_äags
 = 
sk
->
»duû_sÿ‰”v_ršg
.n_frags;

85 
äag
 = 
sk
->
»duû_sÿ‰”v_ršg
.frag;

87 
block_couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(

88 &
	`TASK_ARGS
(
sk
), TASK_ARGSÑask).
d¡
.
šfo_v
.
couÁs
, 
block
);

89 *
äag_off£t
 = 
	`ucc_bufãr_block_off£t
(
block_couÁ
, 
n_äags
, 
äag
);

90 *
block_off£t
 = 
	`g‘_block_off£t
(&
	`TASK_ARGS
(
sk
), 
block
);

91 
	}
}

93 
	$ucc__uı_»duû_sÿ‰”v_ršg_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

95 
ucc__uı_sk_t
 * 
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

96 
ucc_cŞl_¬gs_t
 * 
¬gs
 = &
	`TASK_ARGS
(
sk
);

97 
ucc__uı_‹am_t
 * 
‹am
 = 
	`TASK_TEAM
(
sk
);

98 
ucc_¿nk_t
 
size
 = 
sk
->
sub£t
.
m­
.
•_num
;

99 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

100 * 
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

101 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
d¡
.
šfo_v
.mem_type;

102 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
d¡
.
šfo_v
.
d©©y³
;

103 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

104 
ucc_¿nk_t
 
£ndto
 = (
¿nk
 + 1è% 
size
;

105 
ucc_¿nk_t
 
»cväom
 = (
¿nk
 - 1 + 
size
) % size;

106 
uı_£nd_nbx_ÿÎback_t
 
cb
[2] = {
£nd_com¶‘iÚ_1
, 
£nd_com¶‘iÚ_2
};

107 
ucc_¿nk_t
 
´evblock
, 
»cv_d©a_äom
;

108 
ucc_¡©us_t
 
¡©us
;

109 
size_t
 
max_block_size
, 
block_off£t
, 
äag_couÁ
, 
äag_off£t
, 
fš®_off£t
;

110 
¡•
, 
is_avg
, 
id
;

111 * 
r_sü©ch
, *
s_sü©ch
[2], *
»duû_rg‘
;

112 vŞ©*
busy
;

114 
fš®_off£t
 = 0;

115 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

116 
sbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

117 
fš®_off£t
 = 
	`g‘_block_off£t
(
¬gs
, 
	`UCC_TL_TEAM_RANK
(
‹am
));

120 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
, sendto);

121 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
,„ecvfrom);

122 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

123 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, sendto);

124 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,„ecvfrom);

126 
max_block_size
 = 
sk
->
»duû_sÿ‰”v_ršg
.
max_block_couÁ
 * 
dt_size
;

127 
busy
 = 
sk
->
»duû_sÿ‰”v_ršg
.
s_sü©ch_busy
;

128 
r_sü©ch
 = 
sk
->
»duû_sÿ‰”v_ršg
.
sü©ch
;

129 
s_sü©ch
[0] = 
	`PTR_OFFSET
(
r_sü©ch
, 
max_block_size
);

130 
s_sü©ch
[1] = 
	`PTR_OFFSET
(s_sü©ch[0], 
max_block_size
);

132 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_ršg
(
sk
)) {

135 
sk
->
gged
.
»cv_po¡ed
 > 0) {

137 
	`ucc_as£¹
(!
busy
[0] || !busy[1]);

138 
id
 = 
busy
[0] ? 1 : 0;

139 
»duû_rg‘
 = 
s_sü©ch
[
id
];

140 
¡•
 = 
sk
->
gged
.
£nd_po¡ed
;

141 
´evblock
 = (
¿nk
 - 1 - 
¡•
 + 
size
) % size;

142 
´evblock
 =

143 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
, 
´evblock
);

145 
	`ucc_as£¹
(
sk
->
gged
.
»cv_po¡ed
 =ğsk->gged.
»cv_com¶‘ed
);

146 
	`ucc_as£¹
(
sk
->
gged
.
»cv_po¡ed
 < 
size
);

147 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

148 
´evblock
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,…revblock);

150 
	`ucc_ršg_äag_couÁ
(
sk
, 
´evblock
, &
äag_couÁ
);

151 
	`ucc_ršg_äag_block_off£t
(
sk
, 
´evblock
, &
block_off£t
,

152 &
äag_off£t
);

153 ià(
sk
->
gged
.
»cv_com¶‘ed
 =ğ
size
 - 1) {

154 
»duû_rg‘
 = 
	`PTR_OFFSET
(
¬gs
->
d¡
.
šfo_v
.
bufãr
,

155 (
äag_off£t
 + 
fš®_off£t
è* 
dt_size
);

157 
is_avg
 =

158 (
¬gs
->
İ
 =ğ
UCC_OP_AVG
è&& (
sk
->
gged
.
»cv_com¶‘ed
 =ğ(
size
 - 1));

159 ià(
UCC_OK
 !=

160 (
¡©us
 = 
	`ucc_dt_»duû
(

161 
r_sü©ch
,

162 
	`PTR_OFFSET
(
sbuf
, (
block_off£t
 + 
äag_off£t
è* 
dt_size
),

163 
»duû_rg‘
, 
äag_couÁ
, 
dt
, 
¬gs
,

164 
is_avg
 ? 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
 : 0,

165 
	`AVG_ALPHA
(
sk
),ask->
»duû_sÿ‰”v_ršg
.
executÜ
,

166 &
sk
->
»duû_sÿ‰”v_ršg
.
‘ask
))) {

167 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo…erform dt„eduction");

168 
sk
->
su³r
.
¡©us
 = status;

171 
	`EXEC_TASK_WAIT
(
sk
->
»duû_sÿ‰”v_ršg
.
‘ask
);

172 ià(
sk
->
gged
.
»cv_com¶‘ed
 =ğ
size
 - 1) {

173 
sk
->
gged
.
»cv_po¡ed
 =ask->gged.
»cv_com¶‘ed
 = 0;

176 
	`ucc_as£¹
(
sk
->
gged
.
£nd_po¡ed
 -ask->gged.
£nd_com¶‘ed
 <= 1);

177 
	`ucc_as£¹
(
sk
->
gged
.
£nd_po¡ed
 < 
size
);

179 
busy
[
id
] = 1;

180 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_cb
(
»duû_rg‘
, 
äag_couÁ
 * 
dt_size
,

181 
mem_ty³
, 
£ndto
, 
‹am
, 
sk
, 
cb
[
id
], (*)task),

182 
sk
, 
out
);

184 
»cv_d©a_äom
 = (
¿nk
 - 2 - 
¡•
 + 
size
) % size;

185 
»cv_d©a_äom
 =

186 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
, 
»cv_d©a_äom
);

187 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

188 
»cv_d©a_äom
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,„ecv_data_from);

190 
	`ucc_ršg_äag_couÁ
(
sk
, 
»cv_d©a_äom
, &
äag_couÁ
);

192 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
r_sü©ch
, 
äag_couÁ
 * 
dt_size
,

193 
mem_ty³
, 
»cväom
, 
‹am
, 
sk
),

194 
sk
, 
out
);

196 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡_ršg
(
sk
)) {

200 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

203 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

204 
out
:

206 
	}
}

208 
ucc_¡©us_t


209 
	$ucc__uı_»duû_sÿ‰”v_ršg_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

211 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

212 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

213 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

214 
ucc_¿nk_t
 
size
 = 
sk
->
sub£t
.
m­
.
•_num
;

215 
ucc_¿nk_t
 
¿nk
 = 
sk
->
sub£t
.
my¿nk
;

216 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
d¡
.
šfo_v
.
d©©y³
;

217 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

218 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
d¡
.
šfo_v
.mem_type;

219 *
sbuf
 = 
¬gs
->
¤c
.
šfo
.
bufãr
;

220 
¡•
 = 0;

221 
ucc_¿nk_t
 
£ndto
 = (
¿nk
 + 1è% 
size
;

222 
ucc_¿nk_t
 
»cväom
 = (
¿nk
 - 1 + 
size
) % size;

223 
ucc_¿nk_t
 
»cv_block
 = (
¿nk
 - 2 - 
¡•
 + 
size
) % size;

224 
ucc_¿nk_t
 
£nd_block
 = (
¿nk
 - 1 - 
¡•
 + 
size
) % size;

225 
size_t
 
block_off£t
, 
äag_couÁ
, 
äag_off£t
;

226 *
r_sü©ch
;

227 
ucc_¡©us_t
 
¡©us
;

229 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

230 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

231 
sbuf
 = 
¬gs
->
d¡
.
šfo_v
.
bufãr
;

233 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
su³r
,

234 &
sk
->
»duû_sÿ‰”v_ršg
.
executÜ
);

235 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

236  
¡©us
;

239 
r_sü©ch
 = 
sk
->
»duû_sÿ‰”v_ršg
.
sü©ch
;

240 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
, sendto);

241 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
,„ecvfrom);

242 
»cv_block
 =

243 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
, 
»cv_block
);

244 
£nd_block
 =

245 
	`ucc_•_m­_ev®
(
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
, 
£nd_block
);

246 ià(
‹am
->
cfg
.
u£_»Üd”šg
) {

247 
£ndto
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, sendto);

248 
»cväom
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,„ecvfrom);

249 
»cv_block
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
,„ecv_block);

250 
£nd_block
 = 
	`ucc_•_m­_ev®
(
sk
->
sub£t
.
m­
, send_block);

253 
	`ucc_ršg_äag_couÁ
(
sk
, 
»cv_block
, &
äag_couÁ
);

254 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(
r_sü©ch
, 
äag_couÁ
 * 
dt_size
, 
mem_ty³
,

255 
»cväom
, 
‹am
, 
sk
),

256 
sk
, 
out
);

258 
	`ucc_ršg_äag_couÁ
(
sk
, 
£nd_block
, &
äag_couÁ
);

259 
	`ucc_ršg_äag_block_off£t
(
sk
, 
£nd_block
, &
block_off£t
, &
äag_off£t
);

260 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(

261 
	`PTR_OFFSET
(
sbuf
, (
block_off£t
 + 
äag_off£t
è* 
dt_size
),

262 
äag_couÁ
 * 
dt_size
, 
mem_ty³
, 
£ndto
, 
‹am
, 
sk
),

263 
sk
, 
out
);

265  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

266 
out
:

267  
sk
->
su³r
.
¡©us
;

268 
	}
}

270 
ucc_¡©us_t


271 
	$ucc__uı_»duû_sÿ‰”v_ršg_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

273 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

275 ià(
sk
->
»duû_sÿ‰”v_ršg
.
äag
 =ğ
REVERSED_FRAG
) {

276 
	`ucc_•_m­_de¡roy
(&
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
);

278  
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

279 
	}
}

281 
ucc_¡©us_t
 
	$ucc__uı_»duû_sÿ‰”v_ršg_š™_sub£t
(

282 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

283 
ucc_cŞl_sk_t
 **
sk_h
, 
ucc_sub£t_t
 *
sub£ts
, 
n_äags
, 
äag
,

284 *
sü©ch
, 
size_t
 
max_block_couÁ
)

286 
ucc__uı_sk_t
 *
sk
;

287 
ucc__uı_‹am_t
 *
_‹am
;

288 
ucc_¡©us_t
 
¡©us
;

290 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

291 
_‹am
 = 
	`TASK_TEAM
(
sk
);

292 
sk
->
su³r
.
po¡
 = 
ucc__uı_»duû_sÿ‰”v_ršg_¡¬t
;

293 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_»duû_sÿ‰”v_ršg_´og»ss
;

294 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_»duû_sÿ‰”v_ršg_fš®ize
;

295 
sk
->
sub£t
.
m­
 = 
sub£ts
[
äag
].map;

296 
sk
->
sub£t
.
my¿nk
 = 
sub£ts
[
äag
].myrank;

297 ià(
äag
 =ğ
REVERSED_FRAG
) {

298 ià(
_‹am
->
cfg
.
u£_»Üd”šg
) {

299 
sk
->
sub£t
.
m­
 = 
sub£ts
[0].map;

301 
¡©us
 = 
	`ucc_•_m­_ü—‹_šv”£
(
sub£ts
[
äag
].
m­
,

302 &
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
,

303 
äag
 && 
_‹am
->
cfg
.
u£_»Üd”šg
);

304 ià(
UCC_OK
 !ğ
¡©us
) {

305  
¡©us
;

308 
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

309 
sk
->
»duû_sÿ‰”v_ršg
.
šv_m­
.
•_num
 =ask->
sub£t
.
m­
.ep_num;

311 
sk
->
»duû_sÿ‰”v_ršg
.
n_äags
 =‚_frags;

312 
sk
->
»duû_sÿ‰”v_ršg
.
äag
 = frag;

313 
sk
->
»duû_sÿ‰”v_ršg
.
sü©ch
 = scratch;

314 
sk
->
»duû_sÿ‰”v_ršg
.
max_block_couÁ
 = max_block_count;

315 
sk
->
»duû_sÿ‰”v_ršg
.
s_sü©ch_busy
[0] = 0;

316 
sk
->
»duû_sÿ‰”v_ršg
.
s_sü©ch_busy
[1] = 0;

317 *
sk_h
 = &
sk
->
su³r
;

318  
UCC_OK
;

319 
	}
}

321 
ucc_¡©us_t


322 
	$ucc__uı_»duû_sÿ‰”v_ršg_sched_po¡
(
ucc_cŞl_sk_t
 *
sk
)

324 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

325 
i
;

327 
i
 = 0; i < 
scheduË
->
n_sks
; i++) {

328 
scheduË
->
sks
[
i
]->
b¬gs
.
¬gs
.
¤c
 = 
sk
->bargs.args.src;

329 
scheduË
->
sks
[
i
]->
b¬gs
.
¬gs
.
d¡
 = 
sk
->bargs.args.dst;

332  
	`ucc_scheduË_¡¬t
(
sk
);

333 
	}
}

335 
ucc_¡©us_t


336 
	$ucc__uı_»duû_sÿ‰”v_ršg_sched_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

338 
ucc__uı_scheduË_t
 *
scheduË
 =

339 
	`ucc_d”ived_of
(
sk
, 
ucc__uı_scheduË_t
);

340 
ucc_¡©us_t
 
¡©us
;

342 
	`ucc_mc_ä“
(
scheduË
->
sü©ch_mc_h—d”
);

343 
¡©us
 = 
	`ucc_scheduË_fš®ize
(
sk
);

344 
	`ucc__uı_put_scheduË
(&
scheduË
->
su³r
.super);

345  
¡©us
;

346 
	}
}

348 
ucc_¡©us_t


349 
	$ucc__uı_»duû_sÿ‰”v_ršg_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

350 
ucc_ba£_‹am_t
 * 
‹am
,

351 
ucc_cŞl_sk_t
 ** 
sk_h
)

353 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

354 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

355 
ucc_d©©y³_t
 
dt
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo_v
.
d©©y³
;

356 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

357 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo_v
.mem_type;

358 
bidœ
 =

359 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
»duû_sÿ‰”v_ršg_bidœeùiÚ®
;

360 
size_t
 
to_®loc_³r_£t
, 
max_£gcouÁ
, 
couÁ_³r_£t
, 
couÁ
;

361 
ucc__uı_scheduË_t
 *
_scheduË
;

362 
ucc_scheduË_t
 *
scheduË
;

363 
ucc_cŞl_sk_t
 *
ùask
;

364 
ucc_sbgp_t
 *
sbgp
;

365 
ucc_¡©us_t
 
¡©us
;

366 
ucc_sub£t_t
 
s
[2];

367 
i
, 
n_sub£ts
;

369 ià(
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
»duû_avg_´e_İ
 &&

370 
cŞl_¬gs
->
¬gs
.
İ
 =ğ
UCC_OP_AVG
) {

371  
UCC_ERR_NOT_SUPPORTED
;

374 ià(
	`UCC_IS_INPLACE
(
cŞl_¬gs
->
¬gs
)) {

375 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(

376 &
cŞl_¬gs
->
¬gs
, cŞl_¬gs->¬gs.
d¡
.
šfo_v
.
couÁs
, 
size
);

378 
couÁ
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.count;

381 
¡©us
 = 
	`ucc__uı_g‘_scheduË
(
_‹am
, 
cŞl_¬gs
, &
_scheduË
);

382 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

383  
¡©us
;

386 
scheduË
 = &
_scheduË
->
su³r
.super;

389 
n_sub£ts
 = (
bidœ
 && (
couÁ
 > 
size
)) ? 2 : 1;

391 ià(
_‹am
->
cfg
.
u£_»Üd”šg
) {

392 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
_‹am
->
tİo
, 
UCC_SBGP_FULL_HOST_ORDERED
);

393 
s
[0].
my¿nk
 = 
sbgp
->
group_¿nk
;

394 
s
[0].
m­
 = 
sbgp
->map;

396 
s
[0].
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(
_‹am
);

397 
s
[0].
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

398 
s
[0].
m­
.
•_num
 = 
	`UCC_TL_TEAM_SIZE
(
_‹am
);

400 
s
[1].
m­
 = 
	`ucc_•_m­_ü—‹_»v”£
(
	`UCC_TL_TEAM_SIZE
(
_‹am
));

401 
s
[1].
my¿nk
 = 
	`ucc_•_m­_ev®
(s[1].
m­
, s[0].myrank);

403 ià(
cŞl_¬gs
->
mask
 & 
UCC_BASE_CARGS_MAX_FRAG_COUNT
) {

404 
max_£gcouÁ
 = 
cŞl_¬gs
->
max_äag_couÁ
;

406 
max_£gcouÁ
 = 
	`ucc_cŞl_¬gs_g‘_max_couÁ
(

407 &
cŞl_¬gs
->
¬gs
, cŞl_¬gs->¬gs.
d¡
.
šfo_v
.
couÁs
, 
size
);

411 
couÁ_³r_£t
 = (
max_£gcouÁ
 + 
n_sub£ts
 - 1) /‚_subsets;

413 
to_®loc_³r_£t
 = 
couÁ_³r_£t
 * 3;

414 
	`UCC_CHECK_GOTO
(
	`ucc_mc_®loc
(&
_scheduË
->
sü©ch_mc_h—d”
,

415 
to_®loc_³r_£t
 * 
dt_size
 * 
n_sub£ts
,

416 
mem_ty³
),

417 
out
, 
¡©us
);

419 
i
 = 0; i < 
n_sub£ts
; i++) {

420 
	`UCC_CHECK_GOTO
(
	`ucc__uı_»duû_sÿ‰”v_ršg_š™_sub£t
(

421 
cŞl_¬gs
, 
‹am
, &
ùask
, 
s
, 
n_sub£ts
, 
i
,

422 
	`PTR_OFFSET
(
_scheduË
->
sü©ch_mc_h—d”
->
addr
,

423 
to_®loc_³r_£t
 * 
i
 * 
dt_size
),

424 
couÁ_³r_£t
),

425 
out_ä“
, 
¡©us
);

426 
ùask
->
n_d•s
 = 1;

427 
	`UCC_CHECK_GOTO
(
	`ucc_scheduË_add_sk
(
scheduË
, 
ùask
), 
out_ä“
,

428 
¡©us
);

429 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(

430 &
scheduË
->
su³r
, 
UCC_EVENT_SCHEDULE_STARTED
, 
ùask
,

431 
ucc_sk_¡¬t_hªdËr
),

432 
out_ä“
, 
¡©us
);

434 
scheduË
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

435 
scheduË
->
su³r
.
po¡
 = 
ucc__uı_»duû_sÿ‰”v_ršg_sched_po¡
;

436 
scheduË
->
su³r
.
fš®ize
 = 
ucc__uı_»duû_sÿ‰”v_ršg_sched_fš®ize
;

437 *
sk_h
 = &
scheduË
->
su³r
;

438  
UCC_OK
;

440 
out_ä“
:

441 
	`ucc_mc_ä“
(
_scheduË
->
sü©ch_mc_h—d”
);

442 
out
:

443 
	`ucc__uı_put_scheduË
(
scheduË
);

444  
¡©us
;

445 
	}
}

	@src/components/tl/ucp/scatter/scatter.h

6 #iâdeà
SCATTER_H_


7 
	#SCATTER_H_


	)

8 
	~"../_uı.h
"

9 
	~"../_uı_cŞl.h
"

13 
ucc_¡©us_t


14 
ucc__uı_sÿ‰”_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

15 
ucc_ba£_‹am_t
 *
‹am
,

16 
ucc_cŞl_sk_t
 **
sk_h
);

19 
ucc_¡©us_t
 
ucc__uı_sÿ‰”_knomŸl_š™_r
(

20 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

21 
ucc_cŞl_sk_t
 **
sk_h
, 
ucc_kn_¿dix_t
 
¿dix
);

	@src/components/tl/ucp/scatter/scatter_knomial.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"_uı_cŞl.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"cÜe/ucc_´og»ss_queue.h
"

12 
	~"compÚ’ts/mc/ucc_mc.h
"

13 
	~"cŞl_·‰”ns/¤a_knomŸl.h
"

14 
	~"uts/ucc_m©h.h
"

15 
	~"uts/ucc_cŞl_uts.h
"

17 
	#SAVE_STATE
(
_pha£
) \

19 
sk
->
sÿ‰”_kn
.
pha£
 = 
_pha£
; \

20 } 0)

	)

23 
	mUCC_SCATTER_KN_PHASE_INIT
,

24 
	mUCC_SCATTER_KN_PHASE_LOOP
,

27 
	$ucc__uı_sÿ‰”_knomŸl_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

29 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
,

30 
ucc__uı_sk_t
);

31 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

32 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

33 
ucc_kn_¿dix_t
 
¿dix
 = 
sk
->
sÿ‰”_kn
.
p
.radix;

34 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
sÿ‰”_kn
.p;

35 *
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

36 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
¤c
.
šfo
.mem_type;

37 
size_t
 
couÁ
 = 
¬gs
->
¤c
.
šfo
.count;

38 
ucc_d©©y³_t
 
dt
 = 
¬gs
->
¤c
.
šfo
.
d©©y³
;

39 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

40 
ucc_¿nk_t
 
roÙ
 = (ucc_¿nk_t)
¬gs
->root;

41 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

42 
ucc_¿nk_t
 
¿nk
 = 
	`VRANK
(
	`UCC_TL_TEAM_RANK
(
‹am
), 
roÙ
, 
size
);

43 
ucc_¿nk_t
 
‹am_size
 = 
size
 - 
p
->
n_exŒa
;

44 *
sbuf
;

45 
ucc_¿nk_t
 
³”
, 
vroÙ
, 
v³”
, 
³”_»cv_di¡
;

46 
ucc_¿nk_t
 
¡•_¿dix
, 
³”_£g_šdex
, 
loÿl_£g_šdex
;

47 
±rdiff_t
 
³”_£g_off£t
, 
off£t
;

48 
ucc_kn_¿dix_t
 
loİ_¡•
;

49 
size_t
 
block_couÁ
, 
³”_£g_couÁ
, 
loÿl_£g_couÁ
;

50 
ucc_¡©us_t
 
¡©us
;

52 
roÙ
 = 
	`VRANK
ÔoÙ,„oÙ, 
size
);

53 
sbuf
 = (
¿nk
 =ğ
roÙ
è? 
¬gs
->
¤c
.
šfo
.
bufãr
 :‡rgs->
d¡
.info.buffer;

55 ià(
sk
->
sÿ‰”_kn
.
pha£
 =ğ
UCC_SCATTER_KN_PHASE_LOOP
) {

56 
UCC_SCATTER_KN_PHASE_LOOP
;

59 ià(
KN_NODE_EXTRA
 =ğ
p
->
node_ty³
) {

60 
out
;

63 !
	`ucc_knomŸl_·‰”n_loİ_dÚe
(
p
)) {

64 
¡•_¿dix
 = 
	`ucc_kn_compu‹_¡•_¿dix
(
p
);

65 
block_couÁ
 = 
	`ucc_¤a_kn_compu‹_block_couÁ
(
couÁ
, 
¿nk
, 
p
);

66 
loÿl_£g_šdex
 = 
	`ucc_kn_compu‹_£g_šdex
(
¿nk
, 
p
->
¿dix_pow
,…);

74 ià((
¿nk
 !ğ
roÙ
è&& (
sk
->
sÿ‰”_kn
.
»cv_di¡
 =ğ
p
->
¿dix_pow
)) {

75 
	`ucc_as£¹
(
sk
->
gged
.
»cv_po¡ed
 == 0);

76 
loÿl_£g_couÁ
 = 
	`ucc_¤a_kn_compu‹_£g_size
(
block_couÁ
,

77 
¡•_¿dix
,

78 
loÿl_£g_šdex
);

79 
loİ_¡•
 = 1;†oİ_¡• < 
¿dix
;†oop_step++) {

80 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
loİ_¡•
);

81 ià(
³”
 =ğ
UCC_KN_PEER_NULL
)

83 
v³”
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
³”
);

84 
vroÙ
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
roÙ
);

85 
³”_»cv_di¡
 = 
	`ucc_knomŸl_ÿlc_»cv_di¡
(
‹am_size
, 
v³”
,

86 
¿dix
, 
vroÙ
);

87 
sk
->
sÿ‰”_kn
.
»cv_size
 = 
loÿl_£g_couÁ
 * 
dt_size
;

88 ià(
³”_»cv_di¡
 < 
sk
->
sÿ‰”_kn
.
»cv_di¡
) {

89 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nb
(

90 
	`PTR_OFFSET
(
rbuf
, 
sk
->
sÿ‰”_kn
.
»cv_off£t
),

91 
loÿl_£g_couÁ
 * 
dt_size
, 
mem_ty³
,

92 
	`INV_VRANK
(
³”
, (
ucc_¿nk_t
)
¬gs
->
roÙ
, 
size
),

93 
‹am
, 
sk
),ask, 
out
);

94 
UCC_SCATTER_KN_PHASE_LOOP
;

106 ià((
roÙ
 =ğ
¿nk
è|| (
sk
->
gged
.
»cv_po¡ed
 > 0)) {

107 
	`ucc_as£¹
(
	`UCC_TL_UCP_TASK_RECV_COMPLETE
(
sk
));

108 
loİ_¡•
 = 1;†oİ_¡• < 
¿dix
;†oop_step++) {

109 
³”
 = 
	`ucc_knomŸl_·‰”n_g‘_loİ_³”
(
p
, 
¿nk
, 
loİ_¡•
);

110 ià(
³”
 =ğ
UCC_KN_PEER_NULL
)

112 
³”_£g_šdex
 =

113 
	`ucc_kn_compu‹_£g_šdex
(
³”
, 
p
->
¿dix_pow
,…);

114 
³”_£g_couÁ
 = 
	`ucc_¤a_kn_compu‹_£g_size
(

115 
block_couÁ
, 
¡•_¿dix
, 
³”_£g_šdex
);

116 
³”_£g_off£t
 = 
	`ucc_¤a_kn_compu‹_£g_off£t
(

117 
block_couÁ
, 
¡•_¿dix
, 
³”_£g_šdex
);

118 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nb
(
	`PTR_OFFSET
(
sbuf
,

119 
sk
->
sÿ‰”_kn
.
»cv_off£t
 + 
³”_£g_off£t
 * 
dt_size
 +

120 
sk
->
sÿ‰”_kn
.
£nd_off£t
),

121 
³”_£g_couÁ
 * 
dt_size
, 
mem_ty³
, 
	`INV_VRANK
(
³”
,

122 (
ucc_¿nk_t
)
¬gs
->
roÙ
, 
size
), 
‹am
, 
sk
),ask, 
out
);

125 
off£t
 = 
	`ucc_¤a_kn_compu‹_£g_off£t
(

126 
block_couÁ
, 
¡•_¿dix
, 
loÿl_£g_šdex
);

127 
sk
->
sÿ‰”_kn
.
£nd_off£t
 +ğ
off£t
 * 
dt_size
;

130 
UCC_SCATTER_KN_PHASE_LOOP
:

131 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
sk
)) {

132 
	`SAVE_STATE
(
UCC_SCATTER_KN_PHASE_LOOP
);

135 
	`ucc_knomŸl_·‰”n_Ãxt_™”©iÚ
(
p
);

138 ià(
sk
->
sÿ‰”_kn
.
»cv_off£t
 =ğ0 && (
¿nk
 !ğ
roÙ
)) {

139 
	`ucc_¤a_kn_g‘_off£t_ªd_£gËn
(
couÁ
, 
dt_size
, 
¿nk
, 
size
, 
¿dix
,

140 &
off£t
, &
loÿl_£g_couÁ
);

141 
¡©us
 = 
	`ucc_mc_memıy
(
	`PTR_OFFSET
(
rbuf
, 
off£t
),

142 
rbuf
, 
sk
->
sÿ‰”_kn
.
»cv_size
, 
mem_ty³
,

143 
mem_ty³
);

144 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

145 
sk
->
su³r
.
¡©us
 = status;

149 
out
:

150 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_scatter_kn_done", 0);

151 
sk
->
su³r
.
¡©us
 = 
UCC_OK
;

152 
	}
}

154 
ucc_¡©us_t
 
	$ucc__uı_sÿ‰”_knomŸl_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

156 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

157 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

158 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

159 
ucc_¿nk_t
 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

160 
ucc_knomŸl_·‰”n_t
 *
p
 = &
sk
->
sÿ‰”_kn
.p;

161 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

162 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

163 
ucc_¿nk_t
 
v¿nk
, 
vroÙ
;

164 
ucc_Ú_off_auto_v®ue_t
 
is_zcİy
;

166 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_scatter_kn_start", 0);

167 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

169 
	`ucc_knomŸl_·‰”n_š™
(
size
, 
	`VRANK
(
¿nk
, 
roÙ
, size),

170 
sk
->
sÿ‰”_kn
.
p
.
¿dix
, &task->scatter_kn.p);

171 
sk
->
sÿ‰”_kn
.
pha£
 = 
UCC_SCATTER_KN_PHASE_INIT
;

172 
vroÙ
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
	`VRANK
(
roÙ
,„oÙ, 
size
));

173 
v¿nk
 = 
	`ucc_knomŸl_·‰”n_loİ_¿nk
(
p
, 
	`VRANK
(
¿nk
, 
roÙ
, 
size
));

174 
sk
->
sÿ‰”_kn
.
»cv_di¡
 = 
	`ucc_knomŸl_ÿlc_»cv_di¡
(
size
 - 
p
->
n_exŒa
,

175 
v¿nk
, 
p
->
¿dix
,

176 
vroÙ
);

177 
sk
->
sÿ‰”_kn
.
»cv_off£t
 = 0;

178 
is_zcİy
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
sÿ‰”_kn_’abË_»cv_zcİy
;

179 ià(((
is_zcİy
 =ğ
UCC_CONFIG_AUTO
) &&

180 (
¬gs
->
¤c
.
šfo
.
mem_ty³
 !ğ
UCC_MEMORY_TYPE_HOST
)) ||

181 (
is_zcİy
 =ğ
UCC_CONFIG_ON
)) {

182 
	`ucc_¤a_kn_g‘_off£t_ªd_£gËn
(
¬gs
->
¤c
.
šfo
.
couÁ
,

183 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
),

184 
	`VRANK
(
¿nk
, 
roÙ
, 
size
), size, 
p
->
¿dix
,

185 &
sk
->
sÿ‰”_kn
.
»cv_off£t
, 
NULL
);

187 
sk
->
sÿ‰”_kn
.
£nd_off£t
 = 0;

189  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

190 
	}
}

192 
ucc_¡©us_t
 
	$ucc__uı_sÿ‰”_knomŸl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

194  
	`ucc__uı_cŞl_fš®ize
(
cŞl_sk
);

195 
	}
}

197 
ucc_¡©us_t
 
	$ucc__uı_sÿ‰”_knomŸl_š™_r
(

198 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

199 
ucc_cŞl_sk_t
 **
sk_h
, 
ucc_kn_¿dix_t
 
¿dix
)

201 
ucc__uı_sk_t
 *
sk
;

203 
	`ucc_as£¹
(
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.
mem_ty³
 ==

204 
cŞl_¬gs
->
¬gs
.
d¡
.
šfo
.
mem_ty³
);

206 
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

207 
sk
->
su³r
.
po¡
 = 
ucc__uı_sÿ‰”_knomŸl_¡¬t
;

208 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_sÿ‰”_knomŸl_´og»ss
;

209 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_sÿ‰”_knomŸl_fš®ize
;

210 
sk
->
sÿ‰”_kn
.
p
.
¿dix
 =„adix;

212 *
sk_h
 = &
sk
->
su³r
;

213  
UCC_OK
;

214 
	}
}

216 
ucc_¡©us_t
 
	$ucc__uı_sÿ‰”_knomŸl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

217 
ucc_ba£_‹am_t
 *
‹am
,

218 
ucc_cŞl_sk_t
 **
sk_h
)

220 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

221 
size_t
 
couÁ
 = 
cŞl_¬gs
->
¬gs
.
¤c
.
šfo
.count;

222 
ucc_kn_¿dix_t
 
¿dix
, 
cfg_¿dix
;

224 
cfg_¿dix
 = 
	`UCC_TL_UCP_TEAM_LIB
(
_‹am
)->
cfg
.
sÿ‰”_kn_¿dix
;

225 
¿dix
 = 
	`ucc_knomŸl_·‰”n_g‘_mš_¿dix
(
cfg_¿dix
,

226 
	`UCC_TL_TEAM_SIZE
(
_‹am
), 
couÁ
);

227  
	`ucc__uı_sÿ‰”_knomŸl_š™_r
(
cŞl_¬gs
, 
‹am
, 
sk_h
, 
¿dix
);

228 
	}
}

	@src/components/tl/ucp/scatterv/scatterv.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"sÿ‰”v.h
"

10 
	~"uts/ucc_cŞl_uts.h
"

12 
ucc_¡©us_t
 
ucc__uı_sÿ‰”v_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

14 
ucc__uı_sÿ‰”v_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
sk
);

16 
ucc_ba£_cŞl_®g_šfo_t


17 
	gucc__uı_sÿ‰”v_®gs
[
UCC_TL_UCP_SCATTERV_ALG_LAST
 + 1] = {

18 [
UCC_TL_UCP_SCATTERV_ALG_LINEAR
] =

19 {.
id
 = 
UCC_TL_UCP_SCATTERV_ALG_LINEAR
,

20 .
	gÇme
 = "linear",

21 .
	gdesc
 = "linear scatterv‡lgorithm"},

22 [
UCC_TL_UCP_SCATTERV_ALG_LAST
] = {

23 .
id
 = 0, .
	gÇme
 = 
NULL
, .
	gdesc
 = NULL}};

25 
ucc_¡©us_t
 
ucc__uı_sÿ‰”v_lš—r_š™
(
ucc__uı_sk_t
 *
sk
);

27 
ucc_¡©us_t
 
	$ucc__uı_sÿ‰”v_š™
(
ucc__uı_sk_t
 *
sk
)

29 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

30 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

31 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

33 ià(!
	`ucc_cŞl_¬gs_is_´edefšed_dt
(
¬gs
, 
Œªk
)) {

34  
UCC_ERR_NOT_SUPPORTED
;

37  
	`ucc__uı_sÿ‰”v_lš—r_š™
(
sk
);

38 
	}
}

	@src/components/tl/ucp/scatterv/scatterv.h

7 #iâdeà
SCATTERV_H_


8 
	#SCATTERV_H_


	)

10 
	~"../_uı.h
"

11 
	~"../_uı_cŞl.h
"

14 
	mUCC_TL_UCP_SCATTERV_ALG_LINEAR
,

15 
	mUCC_TL_UCP_SCATTERV_ALG_LAST


18 
ucc_ba£_cŞl_®g_šfo_t


19 
ucc__uı_sÿ‰”v_®gs
[
UCC_TL_UCP_SCATTERV_ALG_LAST
 + 1];

21 
ucc_¡©us_t
 
ucc__uı_sÿ‰”v_š™
(
ucc__uı_sk_t
 *
sk
);

	@src/components/tl/ucp/scatterv/scatterv_linear.c

7 
	~"cÚfig.h
"

8 
	~"_uı.h
"

9 
	~"sÿ‰”v.h
"

10 
	~"cÜe/ucc_´og»ss_queue.h
"

11 
	~"_uı_£nd»cv.h
"

13 
šlše
 
ucc_¿nk_t
 
	$g‘_³”
(
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
,

14 
ucc_¿nk_t
 
¡•
)

16  (
¿nk
 + 
¡•
è% 
size
;

17 
	}
}

19 
	$ucc__uı_sÿ‰”v_lš—r_´og»ss
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

21 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

22 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

23 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

24 * 
sbuf
 = 
¬gs
->
¤c
.
šfo_v
.
bufãr
;

25 
ucc_memÜy_ty³_t
 
smem
 = 
¬gs
->
¤c
.
šfo_v
.
mem_ty³
;

26 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

27 
ucc_¿nk_t
 
gsize
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

28 
pŞls
 = 0;

29 
ucc_¿nk_t
 
³”
, 
po¡s
, 
Äeqs
;

30 
size_t
 
dt_size
, 
d©a_size
, 
d©a_di¥l
;

32 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
g¿nk
)) {

33 
po¡s
 = 
	`UCC_TL_UCP_TEAM_LIB
(
‹am
)->
cfg
.
sÿ‰”v_lš—r_num_po¡s
;

34 
Äeqs
 = (
po¡s
 > 
gsize
 ||…osts == 0) ? gsize :…osts;

35 
dt_size
 = 
	`ucc_dt_size
(
	`TASK_ARGS
(
sk
).
¤c
.
šfo_v
.
d©©y³
);

37 
pŞls
++ < 
sk
->
n_pŞls
) {

38 
	`uı_wÜk”_´og»ss
(
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
wÜk”
.
uı_wÜk”
);

39 (
sk
->
gged
.
£nd_po¡ed
 < 
gsize
) &&

40 ((
sk
->
gged
.
£nd_po¡ed
 -ask->gged.
£nd_com¶‘ed
) <

41 
Äeqs
)) {

42 
³”
 = 
	`g‘_³”
(
g¿nk
, 
gsize
, 
sk
->
gged
.
£nd_po¡ed
);

43 
d©a_size
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,

44 
¬gs
->
¤c
.
šfo_v
.
couÁs
, 
³”
è* 
dt_size
;

45 
d©a_di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

46 
¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
, 
³”
è* 
dt_size
;

47 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nz
(
	`PTR_OFFSET
(
sbuf
, 
d©a_di¥l
),

48 
d©a_size
, 
smem
, 
³”
, 
‹am
, 
sk
),

49 
sk
, 
out
);

50 
pŞls
 = 0;

53 ià(
sk
->
gged
.
£nd_po¡ed
 < 
gsize
) {

58 
sk
->
su³r
.
¡©us
 = 
	`ucc__uı_‹¡
(task);

59 
out
:

60 ià(
sk
->
su³r
.
¡©us
 !ğ
UCC_INPROGRESS
) {

61 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_scatterv_linear_done",

64 
	}
}

66 
ucc_¡©us_t
 
	$ucc__uı_sÿ‰”v_lš—r_¡¬t
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

68 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

69 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

70 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

71 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

72 
ucc_memÜy_ty³_t
 
smem
 = 
¬gs
->
¤c
.
šfo_v
.
mem_ty³
;

73 
ucc_memÜy_ty³_t
 
rmem
 = 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

74 *
rbuf
 = 
¬gs
->
d¡
.
šfo
.
bufãr
;

75 * 
sbuf
;

76 
size_t
 
dt_size
, 
d©a_di¥l
, 
d©a_size
;

78 
	`UCC_TL_UCP_PROFILE_REQUEST_EVENT
(
cŞl_sk
, "ucp_scatterv_linear_start", 0);

79 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_INPROGRESS
);

81 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
g¿nk
)) {

82 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

83 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
);

84 
d©a_size
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
,

85 
¬gs
->
¤c
.
šfo_v
.
couÁs
, 
g¿nk
è* 
dt_size
;

86 
d©a_di¥l
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
,

87 
¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
, 
g¿nk
è* 
dt_size
;

88 
sbuf
 = 
	`PTR_OFFSET
(
¬gs
->
¤c
.
šfo_v
.
bufãr
, 
d©a_di¥l
);

90 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nz
(
rbuf
, 
d©a_size
, 
rmem
, 
g¿nk
, 
‹am
,

91 
sk
),

92 
sk
, 
”rÜ
);

93 
	`UCPCHECK_GOTO
(
	`ucc__uı_£nd_nz
(
sbuf
, 
d©a_size
, 
smem
, 
g¿nk
, 
‹am
,

94 
sk
),

95 
sk
, 
”rÜ
);

99 
sk
->
gged
.
£nd_po¡ed
 =ask->gged.
£nd_com¶‘ed
 = 1;

100 
sk
->
gged
.
»cv_po¡ed
 =ask->gged.
»cv_com¶‘ed
 = 1;

103 
dt_size
 = 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

104 
d©a_size
 = 
¬gs
->
d¡
.
šfo
.
couÁ
 * 
dt_size
;

106 
	`UCPCHECK_GOTO
(
	`ucc__uı_»cv_nz
(
rbuf
, 
d©a_size
, 
rmem
, 
¬gs
->
roÙ
,

107 
‹am
, 
sk
),

108 
sk
, 
”rÜ
);

111  
	`ucc_´og»ss_queue_’queue
(
	`UCC_TL_CORE_CTX
(
‹am
)->
pq
, &
sk
->
su³r
);

112 
”rÜ
:

113  
sk
->
su³r
.
¡©us
;

115 
	}
}

117 
ucc_¡©us_t
 
	$ucc__uı_sÿ‰”v_lš—r_š™
(
ucc__uı_sk_t
 *
sk
)

119 
sk
->
su³r
.
po¡
 = 
ucc__uı_sÿ‰”v_lš—r_¡¬t
;

120 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_sÿ‰”v_lš—r_´og»ss
;

122 
sk
->
n_pŞls
 = 
	`ucc_max
(1,ask->n_polls);

123  
UCC_OK
;

124 
	}
}

	@src/components/tl/ucp/tl_ucp.c

7 
	~"_uı.h
"

8 
	~"uts/ucc_m®loc.h
"

9 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

11 
	~"®Ìeduû/®Ìeduû.h
"

12 
	~"bÿ¡/bÿ¡.h
"

13 
	~"b¬r›r/b¬r›r.h
"

14 
	~"®ÉßÎ/®ÉßÎ.h
"

15 
	~"®ÉßÎv/®ÉßÎv.h
"

16 
	~"®lg©h”/®lg©h”.h
"

17 
	~"®lg©h”v/®lg©h”v.h
"

18 
	~"»duû_sÿ‰”/»duû_sÿ‰”.h
"

19 
	~"»duû_sÿ‰”v/»duû_sÿ‰”v.h
"

20 
	~"»duû/»duû.h
"

21 
	~"g©h”/g©h”.h
"

22 
	~"g©h”v/g©h”v.h
"

23 
	~"çnout/çnout.h
"

24 
	~"çnš/çnš.h
"

25 
	~"sÿ‰”v/sÿ‰”v.h
"

27 
ucc_¡©us_t
 
ucc__uı_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

28 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
);

30 
ucc_¡©us_t
 
ucc__uı_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
);

32 
ucc_¡©us_t
 
ucc__uı_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

33 
ucc_ba£_ùx_©Œ_t
 *
ba£_©Œ
);

35 
ucc_¡©us_t
 
ucc__uı_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

36 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
);

38 
ucc_¡©us_t
 
ucc__uı_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
, 
ucc_mem_m­__t
 *
_h
,

39 **
·ck_bufãr
);

41 
ucc_¡©us_t
 
ucc__uı_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

42 
ucc_mem_m­__t
 *
memh
);

44 
ucc_cÚfig_f›ld_t
 
	gucc__uı_lib_cÚfig_bË
[] = {

45 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
su³r
),

46 
UCC_CONFIG_TYPE_TABLE
(
ucc__lib_cÚfig_bË
)},

51 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®lg©h”_b©ched_num_po¡s
),

52 
UCC_CONFIG_TYPE_ULUNITS
},

57 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®ÉßÎ_·œwi£_num_po¡s
),

58 
UCC_CONFIG_TYPE_ULUNITS
},

63 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®ÉßÎv_·œwi£_num_po¡s
),

64 
UCC_CONFIG_TYPE_ULUNITS
},

74 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®ÉßÎv_hybrid_num_sü©ch_£nds
),

75 
UCC_CONFIG_TYPE_UINT
},

79 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®ÉßÎv_hybrid_num_sü©ch_»cvs
),

80 
UCC_CONFIG_TYPE_UINT
},

85 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®ÉßÎv_hybrid_·œwi£_num_po¡s
),

86 
UCC_CONFIG_TYPE_UINT
},

90 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®ÉßÎv_hybrid_buff_size
),

91 
UCC_CONFIG_TYPE_MEMUNITS
},

95 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®ÉßÎv_hybrid_chunk_by‹_lim™
),

96 
UCC_CONFIG_TYPE_MEMUNITS
},

102 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
kn_¿dix
), 
UCC_CONFIG_TYPE_UINT
},

106 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
b¬r›r_kn_¿dix
),

107 
UCC_CONFIG_TYPE_UINT
},

110 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
çnš_kn_¿dix
),

111 
UCC_CONFIG_TYPE_UINT
},

114 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
çnout_kn_¿dix
),

115 
UCC_CONFIG_TYPE_UINT
},

119 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®Ìeduû_kn_¿dix
),

120 
UCC_CONFIG_TYPE_UINT_RANGED
},

124 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®Ìeduû_¦idšg_wšdow_buf_size
),

125 
UCC_CONFIG_TYPE_MEMUNITS
},

129 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
,

130 
®Ìeduû_¦idšg_wšdow_put_wšdow_size
),

131 
UCC_CONFIG_TYPE_UINT
},

135 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
,

136 
®Ìeduû_¦idšg_wšdow_num_g‘_bufs
),

137 
UCC_CONFIG_TYPE_UINT
},

141 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®Ìeduû_¤a_kn_¿dix
),

142 
UCC_CONFIG_TYPE_UINT_RANGED
},

146 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®Ìeduû_¤a_kn_p–še
),

147 
UCC_CONFIG_TYPE_PIPELINE_PARAMS
},

151 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
»duû_sÿ‰”_kn_¿dix
),

152 
UCC_CONFIG_TYPE_UINT
},

155 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
®lg©h”_kn_¿dix
),

156 
UCC_CONFIG_TYPE_UINT_RANGED
},

159 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
bÿ¡_kn_¿dix
),

160 
UCC_CONFIG_TYPE_UINT
},

164 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
bÿ¡_§g_kn_¿dix
),

165 
UCC_CONFIG_TYPE_UINT_RANGED
},

168 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
»duû_kn_¿dix
),

169 
UCC_CONFIG_TYPE_UINT
},

173 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
»duû_¤g_kn_p–še
),

174 
UCC_CONFIG_TYPE_PIPELINE_PARAMS
},

178 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
»duû_¤g_kn_¿dix
),

179 
UCC_CONFIG_TYPE_UINT_RANGED
},

182 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
g©h”_kn_¿dix
),

183 
UCC_CONFIG_TYPE_UINT
},

188 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
g©h”v_lš—r_num_po¡s
),

189 
UCC_CONFIG_TYPE_UINT
},

192 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
sÿ‰”_kn_¿dix
),

193 
UCC_CONFIG_TYPE_UINT
},

197 
ucs_off£tof
(
ucc__uı_lib_cÚfig_t
, 
sÿ‰”_kn_’abË_»cv_zcİy
),

198 
UCS_CONFIG_TYPE_ON_OFF_AUTO
},

203 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
sÿ‰”v_lš—r_num_po¡s
),

204 
UCC_CONFIG_TYPE_UINT
},

210 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
»duû_avg_´e_İ
),

211 
UCC_CONFIG_TYPE_BOOL
},

215 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
»duû_sÿ‰”_ršg_bidœeùiÚ®
),

216 
UCC_CONFIG_TYPE_BOOL
},

221 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
»duû_sÿ‰”v_ršg_bidœeùiÚ®
),

222 
UCC_CONFIG_TYPE_BOOL
},

226 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
u£_tİo
),

227 
UCC_CONFIG_TYPE_TERNARY
},

231 
ucc_off£tof
(
ucc__uı_lib_cÚfig_t
, 
u£_»Üd”šg
),

232 
UCC_CONFIG_TYPE_BOOL
},

234 {
NULL
}};

236 cÚ¡ * 
	gucc__uı_loÿl_cİy_Çmes
[] = {

237 [
UCC_TL_UCP_LOCAL_COPY_TYPE_UCP
] = "ucp",

238 [
UCC_TL_UCP_LOCAL_COPY_TYPE_MC
] = "mc",

239 [
UCC_TL_UCP_LOCAL_COPY_TYPE_EC
] = "ec",

240 [
UCC_TL_UCP_LOCAL_COPY_TYPE_AUTO
] = "auto",

241 [
UCC_TL_UCP_LOCAL_COPY_TYPE_LAST
] = 
NULL


244 
ucs_cÚfig_f›ld_t
 
	gucc__uı_cÚ‹xt_cÚfig_bË
[] = {

245 {"", "", 
NULL
, 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
su³r
),

246 
UCC_CONFIG_TYPE_TABLE
(
ucc__cÚ‹xt_cÚfig_bË
)},

252 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
´ecÚÃù
),

253 
UCC_CONFIG_TYPE_UINT
},

257 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
n_pŞls
), 
UCC_CONFIG_TYPE_UINT
},

261 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
oob_ÅŞls
),

262 
UCC_CONFIG_TYPE_UINT
},

265 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
´e_»g_mem
),

266 
UCC_CONFIG_TYPE_UINT
},

273 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
£rviû_wÜk”
),

274 
UCC_CONFIG_TYPE_BOOL
},

279 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
£rviû_thrÙšg_th»sh
),

280 
UCC_CONFIG_TYPE_UINT
},

285 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
loÿl_cİy_ty³
),

286 
UCC_CONFIG_TYPE_ENUM
(
ucc__uı_loÿl_cİy_Çmes
)},

291 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
memty³_cİy_’abË
),

292 
UCC_CONFIG_TYPE_BOOL
},

298 
ucc_off£tof
(
ucc__uı_cÚ‹xt_cÚfig_t
, 
expÜ‹d_memÜy_hªdË
),

299 
UCC_CONFIG_TYPE_BOOL
},

301 {
NULL
}};

303 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__uı_lib_t
, 
ucc_ba£_lib_t
,

304 cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

305 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

307 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__uı_lib_t
, 
ucc_ba£_lib_t
);

309 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__uı_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
,

310 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

311 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

313 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__uı_cÚ‹xt_t
, 
ucc_ba£_cÚ‹xt_t
);

315 
UCC_CLASS_DEFINE_NEW_FUNC
(
ucc__uı_‹am_t
, 
ucc_ba£_‹am_t
,

316 
ucc_ba£_cÚ‹xt_t
 *, cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

318 
ucc_¡©us_t
 
ucc__uı_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
);

320 
ucc_¡©us_t
 
ucc__uı_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
);

322 
ucc_¡©us_t
 
ucc__uı_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

323 
ucc_ba£_‹am_t
 *
‹am
,

324 
ucc_cŞl_sk_t
 **
sk
);

326 
ucc_¡©us_t
 
ucc__uı_pİuÏ‹_rÿche
(*
addr
, 
size_t
 
Ëngth
,

327 
ucs_memÜy_ty³_t
 
mem_ty³
,

328 
ucc__uı_cÚ‹xt_t
 *
ùx
);

330 
ucc_¡©us_t
 
ucc__uı_£rviû_®Ìeduû
(
ucc_ba£_‹am_t
 *
‹am
, *
sbuf
,

331 *
rbuf
, 
ucc_d©©y³_t
 
dt
,

332 
size_t
 
couÁ
, 
ucc_»duùiÚ_İ_t
 
İ
,

333 
ucc_sub£t_t
 
sub£t
,

334 
ucc_cŞl_sk_t
 **
sk
);

336 
ucc_¡©us_t
 
ucc__uı_£rviû_®lg©h”
(
ucc_ba£_‹am_t
 *
‹am
, *
sbuf
,

337 *
rbuf
, 
size_t
 
msgsize
,

338 
ucc_sub£t_t
 
sub£t
,

339 
ucc_cŞl_sk_t
 **
sk_p
);

341 
ucc_¡©us_t
 
ucc__uı_£rviû_bÿ¡
(
ucc_ba£_‹am_t
 *
‹am
, *
buf
,

342 
size_t
 
msgsize
, 
ucc_¿nk_t
 
roÙ
,

343 
ucc_sub£t_t
 
sub£t
,

344 
ucc_cŞl_sk_t
 **
sk_p
);

346 
ucc_¡©us_t
 
ucc__uı_£rviû_‹¡
(
ucc_cŞl_sk_t
 *
sk
);

348 
ucc_¡©us_t
 
ucc__uı_£rviû_ş—nup
(
ucc_cŞl_sk_t
 *
sk
);

350 
ucc__uı_£rviû_upd©e_id
(
ucc_ba£_‹am_t
 *
‹am
, 
ušt16_t
 
id
);

352 
ucc_¡©us_t
 
ucc__uı_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

353 
ucc_cŞl_scÜe_t
 **
scÜe
);

355 
UCC_TL_IFACE_DECLARE
(
uı
, 
UCP
);

357 
ucs_memÜy_ty³_t
 
	gucc_memty³_to_ucs
[
UCC_MEMORY_TYPE_LAST
 + 1] = {

358 [
UCC_MEMORY_TYPE_HOST
] = 
UCS_MEMORY_TYPE_HOST
,

359 [
UCC_MEMORY_TYPE_CUDA
] = 
UCS_MEMORY_TYPE_CUDA
,

360 [
UCC_MEMORY_TYPE_CUDA_MANAGED
] = 
UCS_MEMORY_TYPE_CUDA_MANAGED
,

361 [
UCC_MEMORY_TYPE_ROCM
] = 
UCS_MEMORY_TYPE_ROCM
,

362 [
UCC_MEMORY_TYPE_ROCM_MANAGED
] = 
UCS_MEMORY_TYPE_ROCM_MANAGED
,

363 [
UCC_MEMORY_TYPE_UNKNOWN
] = 
UCS_MEMORY_TYPE_UNKNOWN


366 
UCC_TL_UCP_PROFILE_FUNC_VOID
(
ucc__uı_´e_»gi¡”_mem
, (
‹am
, 
addr
, 
Ëngth
,

367 
mem_ty³
), 
ucc__uı_‹am_t
 *
‹am
, *
addr
,

368 
size_t
 
Ëngth
, 
ucc_memÜy_ty³_t
 
mem_ty³
)

370 *
	gba£_add»ss
 = 
addr
;

371 
size_t
 
	g®loc_Ëngth
 = 
Ëngth
;

372 
ucc_mem_©Œ_t
 
	gmem_©Œ
;

373 
ucc_¡©us_t
 
	g¡©us
;

375 ià((
	gaddr
 =ğ
NULL
è|| (
Ëngth
 == 0)) {

379 
	gmem_©Œ
.
	gf›ld_mask
 = 
UCC_MEM_ATTR_FIELD_BASE_ADDRESS
 |

380 
UCC_MEM_ATTR_FIELD_ALLOC_LENGTH
;

381 
	gmem_©Œ
.
	g®loc_Ëngth
 = 
Ëngth
;

382 
	g¡©us
 = 
ucc_mc_g‘_mem_©Œ
(
addr
, &
mem_©Œ
);

383 ià(
ucc_lik–y
(
¡©us
 =ğ
UCC_OK
)) {

384 
ba£_add»ss
 = 
mem_©Œ
.base_address;

385 
	g®loc_Ëngth
 = 
mem_©Œ
.
®loc_Ëngth
;

387 
_w¬n
(
UCC_TL_TEAM_LIB
(
‹am
), "failedo query base‡ddr‡nd†en");

390 
	g¡©us
 = 
ucc__uı_pİuÏ‹_rÿche
(
ba£_add»ss
, 
®loc_Ëngth
,

391 
ucc_memty³_to_ucs
[
mem_ty³
],

392 
UCC_TL_UCP_TEAM_CTX
(
‹am
));

393 ià(
ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

394 
_w¬n
(
UCC_TL_TEAM_LIB
(
‹am
), "ucc_tl_ucp_mem_map failed");

398 
__©Œibu‹__
((
cÚ¡ruùÜ
)è
	$_uı_içû_š™
()

400 
ucc__uı
.
su³r
.
scŞl
.
®lg©h”
 = 
ucc__uı_£rviû_®lg©h”
;

401 
ucc__uı
.
su³r
.
scŞl
.
®Ìeduû
 = 
ucc__uı_£rviû_®Ìeduû
;

402 
ucc__uı
.
su³r
.
scŞl
.
bÿ¡
 = 
ucc__uı_£rviû_bÿ¡
;

403 
ucc__uı
.
su³r
.
scŞl
.
upd©e_id
 = 
ucc__uı_£rviû_upd©e_id
;

405 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLGATHER
)] =

406 
ucc__uı_®lg©h”_®gs
;

407 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLGATHERV
)] =

408 
ucc__uı_®lg©h”v_®gs
;

409 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLREDUCE
)] =

410 
ucc__uı_®Ìeduû_®gs
;

411 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLTOALL
)] =

412 
ucc__uı_®ÉßÎ_®gs
;

413 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_ALLTOALLV
)] =

414 
ucc__uı_®ÉßÎv_®gs
;

415 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_BARRIER
)] =

416 
ucc__uı_b¬r›r_®gs
;

417 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_BCAST
)] =

418 
ucc__uı_bÿ¡_®gs
;

419 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_FANIN
)] =

420 
ucc__uı_çnš_®gs
;

421 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_FANOUT
)] =

422 
ucc__uı_çnout_®gs
;

423 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_GATHER
)] =

424 
ucc__uı_g©h”_®gs
;

425 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_GATHERV
)] =

426 
ucc__uı_g©h”v_®gs
;

427 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_REDUCE
)] =

428 
ucc__uı_»duû_®gs
;

429 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_REDUCE_SCATTER
)] =

430 
ucc__uı_»duû_sÿ‰”_®gs
;

431 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_REDUCE_SCATTERV
)] =

432 
ucc__uı_»duû_sÿ‰”v_®gs
;

433 
ucc__uı
.
su³r
.
®g_šfo
[
	`ucc_og2
(
UCC_COLL_TYPE_SCATTERV
)] =

434 
ucc__uı_sÿ‰”v_®gs
;

437 ()
	`ucc_compÚ’ts_lßd
("ı_uı", &
ucc__uı
.
su³r
.
cŞl_¶ugšs
);

438 
	}
}

	@src/components/tl/ucp/tl_ucp.h

7 #iâdeà
UCC_TL_UCP_H_


8 
	#UCC_TL_UCP_H_


	)

9 
	~"compÚ’ts//ucc_.h
"

10 
	~"compÚ’ts//ucc__log.h
"

11 
	~"cÜe/ucc_“.h
"

12 
	~"uts/ucc_mpoŞ.h
"

13 
	~"_uı_•_hash.h
"

14 
	~"scheduË/ucc_scheduË_p–šed.h
"

15 
	~<uı/­i/uı.h
>

16 
	~<ucs/memÜy/memÜy_ty³.h
>

17 
	~"cÜe/ucc_£rviû_cŞl.h
"

19 #iâdeà
UCC_TL_UCP_DEFAULT_SCORE


20 
	#UCC_TL_UCP_DEFAULT_SCORE
 10

	)

23 #ifdeà
HAVE_PROFILING_TL_UCP


24 
	~"uts/´ofe/ucc_´ofe.h
"

26 
	~"uts/´ofe/ucc_´ofe_off.h
"

29 
	#UCC_TL_UCP_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

30 
	#UCC_TL_UCP_PROFILE_FUNC_VOID
 
UCC_PROFILE_FUNC_VOID


	)

31 
	#UCC_TL_UCP_PROFILE_REQUEST_NEW
 
UCC_PROFILE_REQUEST_NEW


	)

32 
	#UCC_TL_UCP_PROFILE_REQUEST_EVENT
 
UCC_PROFILE_REQUEST_EVENT


	)

33 
	#UCC_TL_UCP_PROFILE_REQUEST_FREE
 
UCC_PROFILE_REQUEST_FREE


	)

35 
	#MAX_NR_SEGMENTS
 32

	)

36 
	#ONESIDED_SYNC_SIZE
 1

	)

37 
	#ONESIDED_REDUCE_SIZE
 4

	)

39 
	succ__uı_içû
 {

40 
ucc__içû_t
 
	msu³r
;

41 } 
	tucc__uı_içû_t
;

43 
ucc__uı_içû_t
 
ucc__uı
;

45 
	succ__uı_lib_cÚfig
 {

46 
ucc__lib_cÚfig_t
 
	msu³r
;

47 
ušt32_t
 
	mkn_¿dix
;

48 
ušt32_t
 
	mçnš_kn_¿dix
;

49 
ušt32_t
 
	mçnout_kn_¿dix
;

50 
ušt32_t
 
	mb¬r›r_kn_¿dix
;

51 
size_t
 
	m®Ìeduû_¦idšg_wšdow_buf_size
;

52 
ušt32_t
 
	m®Ìeduû_¦idšg_wšdow_put_wšdow_size
;

53 
ušt32_t
 
	m®Ìeduû_¦idšg_wšdow_num_g‘_bufs
;

54 
ucc_m¿nge_ušt_t
 
	m®Ìeduû_kn_¿dix
;

55 
ucc_m¿nge_ušt_t
 
	m®Ìeduû_¤a_kn_¿dix
;

56 
ušt32_t
 
	m»duû_sÿ‰”_kn_¿dix
;

57 
ucc_m¿nge_ušt_t
 
	m®lg©h”_kn_¿dix
;

58 
ušt32_t
 
	mbÿ¡_kn_¿dix
;

59 
ucc_m¿nge_ušt_t
 
	mbÿ¡_§g_kn_¿dix
;

60 
ušt32_t
 
	m»duû_kn_¿dix
;

61 
ucc_p–še_·¿ms_t
 
	m»duû_¤g_kn_p–še
;

62 
ucc_m¿nge_ušt_t
 
	m»duû_¤g_kn_¿dix
;

63 
ušt32_t
 
	mg©h”_kn_¿dix
;

64 
ušt32_t
 
	mg©h”v_lš—r_num_po¡s
;

65 
ušt32_t
 
	msÿ‰”_kn_¿dix
;

66 
ucc_Ú_off_auto_v®ue_t
 
	msÿ‰”_kn_’abË_»cv_zcİy
;

67 
ušt32_t
 
	msÿ‰”v_lš—r_num_po¡s
;

68 
	m®ÉßÎ_·œwi£_num_po¡s
;

69 
	m®ÉßÎv_·œwi£_num_po¡s
;

70 
	m®lg©h”_b©ched_num_po¡s
;

71 
ucc_p–še_·¿ms_t
 
	m®Ìeduû_¤a_kn_p–še
;

72 
	m»duû_avg_´e_İ
;

73 
	m»duû_sÿ‰”_ršg_bidœeùiÚ®
;

74 
	m»duû_sÿ‰”v_ršg_bidœeùiÚ®
;

75 
ušt32_t
 
	m®ÉßÎv_hybrid_¿dix
;

76 
size_t
 
	m®ÉßÎv_hybrid_buff_size
;

77 
size_t
 
	m®ÉßÎv_hybrid_chunk_by‹_lim™
;

78 
ušt32_t
 
	m®ÉßÎv_hybrid_num_sü©ch_£nds
;

79 
ušt32_t
 
	m®ÉßÎv_hybrid_num_sü©ch_»cvs
;

80 
ušt32_t
 
	m®ÉßÎv_hybrid_·œwi£_num_po¡s
;

81 
ucc_‹º¬y_auto_v®ue_t
 
	mu£_tİo
;

82 
	mu£_»Üd”šg
;

83 } 
	tucc__uı_lib_cÚfig_t
;

85 
	eucc__uı_loÿl_cİy_ty³
 {

86 
	mUCC_TL_UCP_LOCAL_COPY_TYPE_UCP
,

87 
	mUCC_TL_UCP_LOCAL_COPY_TYPE_MC
,

88 
	mUCC_TL_UCP_LOCAL_COPY_TYPE_EC
,

89 
	mUCC_TL_UCP_LOCAL_COPY_TYPE_AUTO
,

90 
	mUCC_TL_UCP_LOCAL_COPY_TYPE_LAST


91 } 
	tucc__uı_loÿl_cİy_ty³_t
;

93 
	succ__uı_cÚ‹xt_cÚfig
 {

94 
ucc__cÚ‹xt_cÚfig_t
 
	msu³r
;

95 
ušt32_t
 
	m´ecÚÃù
;

96 
ušt32_t
 
	mn_pŞls
;

97 
ušt32_t
 
	moob_ÅŞls
;

98 
ušt32_t
 
	m´e_»g_mem
;

99 
ušt32_t
 
	m£rviû_wÜk”
;

100 
ušt32_t
 
	m£rviû_thrÙšg_th»sh
;

101 
ucc__uı_loÿl_cİy_ty³_t
 
	mloÿl_cİy_ty³
;

102 
	mmemty³_cİy_’abË
;

103 
ušt32_t
 
	mexpÜ‹d_memÜy_hªdË
;

104 } 
	tucc__uı_cÚ‹xt_cÚfig_t
;

106 
ucc__uı_lib_cÚfig_t
 
	tucc__uı_‹am_cÚfig_t
;

108 
	succ__uı_lib
 {

109 
ucc__lib_t
 
	msu³r
;

110 
ucc__uı_lib_cÚfig_t
 
	mcfg
;

111 **
	mı_cÚfigs
;

112 } 
	tucc__uı_lib_t
;

113 
UCC_CLASS_DECLARE
(
ucc__uı_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *,

114 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

116 
	succ__uı_»mÙe_šfo
 {

117 * 
	mva_ba£
;

118 
size_t
 
	mËn
;

119 * 
	mmem_h
;

120 * 
	m·cked_key
;

121 
size_t
 
	m·cked_key_Ën
;

122 } 
	tucc__uı_»mÙe_šfo_t
;

124 
	succ__uı_memh_d©a
 {

125 
ucc__uı_»mÙe_šfo_t
 
	mršfo
;

126 *
	m·cked_memh
;

127 
size_t
 
	m·cked_memh_Ën
;

128 
uı_rkey_h
 
	mrkey
;

129 } 
	tucc__uı_memh_d©a_t
;

131 
	succ__uı_wÜk”
 {

132 
uı_cÚ‹xt_h
 
	muı_cÚ‹xt
;

133 
uı_wÜk”_h
 
	muı_wÜk”
;

134 
size_t
 
	muı_add¾’
;

135 
uı_add»ss_t
 * 
	mwÜk”_add»ss
;

136 
_uı_•_hash_t
 *
	m•_hash
;

137 
uı_•_h
 * 
	m•s
;

138 } 
	tucc__uı_wÜk”_t
;

140 
ucc__uı_sk
 
	tucc__uı_sk_t
;

141 
ucc__uı_cÚ‹xt
 
	tucc__uı_cÚ‹xt_t
;

142 
ucc__uı_cİy_sk
 
	tucc__uı_cİy_sk_t
;

144 
	$ucc_¡©us_t
 (*
	tucc__uı_cİy_po¡_â_t
)(*
	td¡
,

145 
	tucc_memÜy_ty³_t
 
	td¡_mty³
,

146 *
	t¤c
,

147 
	tucc_memÜy_ty³_t
 
	t¤c_mty³
,

148 
	tsize_t
 
	tsize
,

149 
	tucc__uı_sk_t
 *
	tcŞl_sk
,

150 
	tucc__uı_cİy_sk_t
 **
	tcİy_sk
);

151 
	$ucc_¡©us_t
 (*
	tucc__uı_cİy_‹¡_â_t
)(
	tucc__uı_cÚ‹xt_t
 *
	tùx
,

152 
	tucc__uı_cİy_sk_t
 *
	tcİy_sk
);

153 
	$ucc_¡©us_t
 (*
	tucc__uı_cİy_fš®ize_â_t
)(
	tucc__uı_cİy_sk_t
 *
	tcİy_sk
);

155 
	succ__uı_‹am
 {

156 
ucc__‹am_t
 
su³r
;

157 
ucc_¡©us_t
 
¡©us
;

158 
ušt32_t
 
£q_num
;

159 
ucc__uı_sk_t
 *
´ecÚÃù_sk
;

160 * 
va_ba£
[
MAX_NR_SEGMENTS
];

161 
size_t
 
ba£_Ëngth
[
MAX_NR_SEGMENTS
];

162 
ucc__uı_wÜk”_t
 * 
wÜk”
;

163 
ucc__uı_‹am_cÚfig_t
 
cfg
;

164 cÚ¡ * 
tunšg_¡r
;

165 
ucc_tİo_t
 *
tİo
;

166 
ucc_•_m­_t
 
ùx_m­
;

167 
ucc_¿nk_t
 
İt_¿dix
;

168 
ucc_¿nk_t
 
İt_¿dix_ho¡
;

169 } 
	tucc__uı_‹am_t
;

170 
	`UCC_CLASS_DECLARE
(
ucc__uı_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *,

171 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *);

173 
	$ucc_¡©us_t
 (*
	tucc__uı_£nd_nb_â_t
)(*
	tbufãr
, 
	tsize_t
 
	tmsgËn
,

174 
	tucc_memÜy_ty³_t
 
	tmty³
,

175 
	tucc_¿nk_t
 
	tde¡_group_¿nk
,

176 
	tucc__uı_‹am_t
 *
	t‹am
,

177 
	tucc__uı_sk_t
 *
	tsk
);

179 
	$ucc_¡©us_t
 (*
	tucc__uı_»cv_nb_â_t
)(*
	tbufãr
, 
	tsize_t
 
	tmsgËn
,

180 
	tucc_memÜy_ty³_t
 
	tmty³
,

181 
	tucc_¿nk_t
 
	tde¡_group_¿nk
,

182 
	tucc__uı_‹am_t
 *
	t‹am
,

183 
	tucc__uı_sk_t
 *
	tsk
);

185 
	$ucc_¡©us_t
 (*
	tucc__uı_»cv_nz_â_t
)(*
	tbufãr
, 
	tsize_t
 
	tmsgËn
,

186 
	tucc_memÜy_ty³_t
 
	tmty³
,

187 
	tucc_¿nk_t
 
	tde¡_group_¿nk
,

188 
	tucc__uı_‹am_t
 *
	t‹am
,

189 
	tucc__uı_sk_t
 *
	tsk
);

191 
	$ucc_¡©us_t
 (*
	tucc__uı_£nd_nz_â_t
)(*
	tbufãr
, 
	tsize_t
 
	tmsgËn
,

192 
	tucc_memÜy_ty³_t
 
	tmty³
,

193 
	tucc_¿nk_t
 
	tde¡_group_¿nk
,

194 
	tucc__uı_‹am_t
 *
	t‹am
,

195 
	tucc__uı_sk_t
 *
	tsk
);

197 
	succ__uı_cÚ‹xt
 {

198 
ucc__cÚ‹xt_t
 
su³r
;

199 
ucc__uı_cÚ‹xt_cÚfig_t
 
cfg
;

200 
ucc__uı_wÜk”_t
 
wÜk”
;

201 
ucc__uı_wÜk”_t
 
£rviû_wÜk”
;

203 
ucc__uı_£nd_nb_â_t
 
ucc__uı_£nd_nb
;

204 
ucc__uı_»cv_nb_â_t
 
ucc__uı_»cv_nb
;

205 
ucc__uı_£nd_nz_â_t
 
ucc__uı_£nd_nz
;

206 
ucc__uı_»cv_nz_â_t
 
ucc__uı_»cv_nz
;

207 } 
£nd»cv_cbs
;

208 
ušt32_t
 
£rviû_wÜk”_thrÙšg_couÁ
;

209 
ucc_mpoŞ_t
 
»q_mp
;

210 
ucc__uı_»mÙe_šfo_t
 * 
»mÙe_šfo
;

211 
uı_rkey_h
 * 
rkeys
;

212 
ušt64_t
 
n_ršfo_£gs
;

213 
ušt64_t
 
uı_memÜy_ty³s
;

214 
tİo_»quœed
;

216 
ucc__uı_cİy_po¡_â_t
 
po¡
;

217 
ucc__uı_cİy_‹¡_â_t
 
‹¡
;

218 
ucc__uı_cİy_fš®ize_â_t
 
fš®ize
;

219 } 
cİy
;

220 } 
	tucc__uı_cÚ‹xt_t
;

221 
	`UCC_CLASS_DECLARE
(
ucc__uı_cÚ‹xt_t
, cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *,

222 cÚ¡ 
ucc_ba£_cÚfig_t
 *);

224 
ucc_cÚfig_f›ld_t
 
ucc__uı_lib_cÚfig_bË
[];

226 
	#UCC_TL_UCP_SUPPORTED_COLLS
 \

227 (
UCC_COLL_TYPE_ALLGATHER
 | \

228 
UCC_COLL_TYPE_ALLGATHERV
 | \

229 
UCC_COLL_TYPE_ALLREDUCE
 | \

230 
UCC_COLL_TYPE_ALLTOALL
 | \

231 
UCC_COLL_TYPE_ALLTOALLV
 | \

232 
UCC_COLL_TYPE_BARRIER
 | \

233 
UCC_COLL_TYPE_BCAST
 | \

234 
UCC_COLL_TYPE_FANIN
 | \

235 
UCC_COLL_TYPE_FANOUT
 | \

236 
UCC_COLL_TYPE_GATHER
 | \

237 
UCC_COLL_TYPE_GATHERV
 | \

238 
UCC_COLL_TYPE_REDUCE
 | \

239 
UCC_COLL_TYPE_REDUCE_SCATTER
 | \

240 
UCC_COLL_TYPE_REDUCE_SCATTERV
 | \

241 
UCC_COLL_TYPE_SCATTERV
)

	)

243 
	#UCC_TL_UCP_TEAM_LIB
(
_‹am
) \

244 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
->
lib
, 
ucc__uı_lib_t
))

	)

246 
	#UCC_TL_UCP_TEAM_CTX
(
_‹am
) \

247 (
	`ucc_d”ived_of
((
_‹am
)->
su³r
.su³r.
cÚ‹xt
, 
ucc__uı_cÚ‹xt_t
))

	)

249 
	#USE_SERVICE_WORKER
(
_‹am
) \

250 (
	`UCC_TL_IS_SERVICE_TEAM
(
_‹am
è&& 
	`UCC_TL_UCP_TEAM_CTX
(_‹am)->
cfg
.
£rviû_wÜk”
)

	)

252 
	#UCC_TL_UCP_TASK_TEAM
(
_sk
) \

253 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
, 
ucc__uı_‹am_t
))

	)

255 
	#UCC_TL_CTX_HAS_OOB
(
_ùx
) \

256 ((
_ùx
)->
su³r
.su³r.
ucc_cÚ‹xt
->
·¿ms
.
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
)

	)

258 
	#UCC_TL_CTX_OOB
(
_ùx
) \

259 ((
_ùx
)->
su³r
.su³r.
ucc_cÚ‹xt
->
·¿ms
.
oob
)

	)

261 
	#UCC_TL_UCP_REMOTE_RKEY
(
_ùx
, 
_¿nk
, 
_£g
) \

262 ((
_ùx
)->
rkeys
[
_¿nk
 * _ùx->
n_ršfo_£gs
 + 
_£g
])

	)

273 
	#UCC_TL_UCP_MEMH_TL_HEADERS
 2

	)

275 
	#UCC_TL_UCP_MEMH_TL_PACKED_HEADERS
 2

	)

277 
	#UCC_TL_UCP_MEMH_TL_HEADER_SIZE
 \

278 ((
size_t
è* 
UCC_TL_UCP_MEMH_TL_HEADERS
)

	)

280 
	#UCC_TL_UCP_MEMH_TL_PACKED_HEADER_SIZE
 \

281 ((
size_t
) * \

282 (
UCC_TL_UCP_MEMH_TL_HEADERS
 + 
UCC_TL_UCP_MEMH_TL_PACKED_HEADERS
))

	)

284 
	#UCC_TL_UCP_MEMH_TL_KEY_SIZE
(
bufãr
) \

285 (*(
size_t
 *)(
	`PTR_OFFSET
(
bufãr
, 
UCC_TL_UCP_MEMH_TL_HEADER_SIZE
)))

	)

287 
	#UCC_TL_UCP_MEMH_TL_PACKED_MEMH
(
bufãr
) \

288 (
	`PTR_OFFSET
(
bufãr
, 
UCC_TL_UCP_MEMH_TL_PACKED_HEADER_SIZE
 + \

289 
	`UCC_TL_UCP_MEMH_TL_KEY_SIZE
(
bufãr
)))

	)

291 
ucs_memÜy_ty³_t
 
ucc_memty³_to_ucs
[
UCC_MEMORY_TYPE_LAST
+1];

293 
	`ucc__uı_´e_»gi¡”_mem
(
ucc__uı_‹am_t
 *
‹am
, *
addr
,

294 
size_t
 
Ëngth
, 
ucc_memÜy_ty³_t
 
mem_ty³
);

296 
ucc_¡©us_t
 
	`ucc__uı_ùx_»mÙe_pİuÏ‹
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

297 
ucc_mem_m­_·¿ms_t
 
m­
,

298 
ucc_‹am_oob_cŞl_t
 
oob
);

	@src/components/tl/ucp/tl_ucp_coll.c

7 
	~"_uı.h
"

8 
	~"_uı_cŞl.h
"

9 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
	~"cÜe/ucc_‹am.h
"

11 
	~"b¬r›r/b¬r›r.h
"

12 
	~"®ÉßÎ/®ÉßÎ.h
"

13 
	~"®ÉßÎv/®ÉßÎv.h
"

14 
	~"®Ìeduû/®Ìeduû.h
"

15 
	~"®lg©h”/®lg©h”.h
"

16 
	~"®lg©h”v/®lg©h”v.h
"

17 
	~"»duû_sÿ‰”/»duû_sÿ‰”.h
"

18 
	~"»duû_sÿ‰”v/»duû_sÿ‰”v.h
"

19 
	~"bÿ¡/bÿ¡.h
"

20 
	~"»duû/»duû.h
"

21 
	~"g©h”/g©h”.h
"

22 
	~"g©h”v/g©h”v.h
"

23 
	~"çnš/çnš.h
"

24 
	~"çnout/çnout.h
"

25 
	~"sÿ‰”v/sÿ‰”v.h
"

27 cÚ¡ 
ucc__uı_deçuÉ_®g_desc_t


28 
	gucc__uı_deçuÉ_®g_descs
[
UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
] = {

30 .
£Ëù_¡r
 = 
NULL
,

31 .
	g¡r_g‘_â
 = 
ucc__uı_®lg©h”_scÜe_¡r_g‘


34 .
	g£Ëù_¡r
 = 
UCC_TL_UCP_ALLGATHERV_DEFAULT_ALG_SELECT_STR
,

35 .
	g¡r_g‘_â
 = 
NULL


38 .
	g£Ëù_¡r
 = 
NULL
,

39 .
	g¡r_g‘_â
 = 
ucc__uı_®ÉßÎ_scÜe_¡r_g‘


42 .
	g£Ëù_¡r
 = 
UCC_TL_UCP_ALLREDUCE_DEFAULT_ALG_SELECT_STR
,

43 .
	g¡r_g‘_â
 = 
NULL


46 .
	g£Ëù_¡r
 = 
UCC_TL_UCP_BCAST_DEFAULT_ALG_SELECT_STR
,

47 .
	g¡r_g‘_â
 = 
NULL


50 .
	g£Ëù_¡r
 = 
UCC_TL_UCP_REDUCE_DEFAULT_ALG_SELECT_STR
,

51 .
	g¡r_g‘_â
 = 
NULL


54 .
	g£Ëù_¡r
 = 
UCC_TL_UCP_REDUCE_SCATTER_DEFAULT_ALG_SELECT_STR
,

55 .
	g¡r_g‘_â
 = 
NULL


58 .
	g£Ëù_¡r
 = 
UCC_TL_UCP_REDUCE_SCATTERV_DEFAULT_ALG_SELECT_STR
,

59 .
	g¡r_g‘_â
 = 
NULL


62 .
	g£Ëù_¡r
 = 
UCC_TL_UCP_ALLTOALLV_DEFAULT_ALG_SELECT_STR
,

63 .
	g¡r_g‘_â
 = 
NULL


67 
ucc_¡©us_t
 
	$ucc__uı_‹am_deçuÉ_scÜe_¡r_®loc
(
ucc__uı_‹am_t
 *
‹am
,

68 *
deçuÉ_£Ëù_¡r
[
UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
])

70 
ucc_¡©us_t
 
¡
 = 
UCC_OK
;

71 
i
;

73 
i
 = 0; i < 
UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
; i++) {

74 ià(
ucc__uı_deçuÉ_®g_descs
[
i
].
£Ëù_¡r
) {

75 
deçuÉ_£Ëù_¡r
[
i
] = 
	`¡rdup
(
ucc__uı_deçuÉ_®g_descs
[i].
£Ëù_¡r
);

77 
deçuÉ_£Ëù_¡r
[
i
] = 
ucc__uı_deçuÉ_®g_descs
[i].
	`¡r_g‘_â
(
‹am
);

79 ià(!
deçuÉ_£Ëù_¡r
[
i
]) {

80 
¡
 = 
UCC_ERR_NO_MEMORY
;

81 
ex™
;

86 
ex™
:

87  
¡
;

88 
	}
}

90 
	$ucc__uı_‹am_deçuÉ_scÜe_¡r_ä“
(

91 *
deçuÉ_£Ëù_¡r
[
UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
])

93 
i
;

95 
i
 = 0; i < 
UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
; i++) {

96 
	`ucc_ä“
(
deçuÉ_£Ëù_¡r
[
i
]);

98 
	}
}

100 
	$ucc__uı_£nd_com¶‘iÚ_cb_¡
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

101 *
u£r_d©a
)

103 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

104 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

105 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in send completion %s",

106 
	`ucs_¡©us_¡ršg
(
¡©us
));

107 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

109 ++
sk
->
gged
.
£nd_com¶‘ed
;

110 
	`uı_»que¡_ä“
(
»que¡
);

111 
	}
}

113 
	$ucc__uı_£nd_com¶‘iÚ_cb_mt
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

114 *
u£r_d©a
)

116 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

117 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

118 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in send completion %s",

119 
	`ucs_¡©us_¡ršg
(
¡©us
));

120 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

122 
	`ucc_©omic_add32
(&
sk
->
gged
.
£nd_com¶‘ed
, 1);

123 
	`uı_»que¡_ä“
(
»que¡
);

124 
	}
}

126 
	$ucc__uı_put_com¶‘iÚ_cb
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

127 *
u£r_d©a
)

129 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

130 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

131 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in…ut completion %s",

132 
	`ucs_¡©us_¡ršg
(
¡©us
));

133 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

135 
sk
->
Úesided
.
put_com¶‘ed
++;

136 
	`uı_»que¡_ä“
(
»que¡
);

137 
	}
}

139 
	$ucc__uı_g‘_com¶‘iÚ_cb
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

140 *
u£r_d©a
)

142 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

143 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

144 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in get completion %s",

145 
	`ucs_¡©us_¡ršg
(
¡©us
));

146 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

148 
sk
->
Úesided
.
g‘_com¶‘ed
++;

149 
	`uı_»que¡_ä“
(
»que¡
);

150 
	}
}

152 
	$ucc__uı_»cv_com¶‘iÚ_cb_mt
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

153 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

154 *
u£r_d©a
)

156 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

157 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

158 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in„ecv completion %s",

159 
	`ucs_¡©us_¡ršg
(
¡©us
));

160 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

162 
	`ucc_©omic_add32
(&
sk
->
gged
.
»cv_com¶‘ed
, 1);

163 
	`uı_»que¡_ä“
(
»que¡
);

164 
	}
}

166 
	$ucc__uı_»cv_com¶‘iÚ_cb_¡
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

167 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

168 *
u£r_d©a
)

170 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

171 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

172 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in„ecv completion %s",

173 
	`ucs_¡©us_¡ršg
(
¡©us
));

174 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

176 ++
sk
->
gged
.
»cv_com¶‘ed
;

177 
	`uı_»que¡_ä“
(
»que¡
);

178 
	}
}

180 
ucc_¡©us_t
 
	$ucc__uı_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
)

182 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
cŞl_sk
, ucc_tl_ucp_task_t);

184 
	`_Œaû
(
	`UCC_TASK_LIB
(
sk
), "finalizingask %p",ask);

185 
	`ucc__uı_put_sk
(
sk
);

186  
UCC_OK
;

187 
	}
}

189 
ucc_¡©us_t
 
	$ucc__uı_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

190 
ucc_ba£_‹am_t
 *
‹am
,

191 
ucc_cŞl_sk_t
 **
sk_h
)

193 
ucc__uı_sk_t
 *
sk
 = 
	`ucc__uı_š™_sk
(
cŞl_¬gs
, 
‹am
);

194 
ucc_¡©us_t
 
¡©us
;

196 
cŞl_¬gs
->
¬gs
.
cŞl_ty³
) {

197 
UCC_COLL_TYPE_BARRIER
:

198 
¡©us
 = 
	`ucc__uı_b¬r›r_š™
(
sk
);

200 
UCC_COLL_TYPE_ALLTOALL
:

201 
¡©us
 = 
	`ucc__uı_®ÉßÎ_š™
(
sk
);

203 
UCC_COLL_TYPE_ALLTOALLV
:

204 
¡©us
 = 
	`ucc__uı_®ÉßÎv_š™
(
sk
);

206 
UCC_COLL_TYPE_ALLREDUCE
:

207 
¡©us
 = 
	`ucc__uı_®Ìeduû_š™
(
sk
);

209 
UCC_COLL_TYPE_ALLGATHER
:

210 
¡©us
 = 
	`ucc__uı_®lg©h”_š™
(
sk
);

212 
UCC_COLL_TYPE_ALLGATHERV
:

213 
¡©us
 = 
	`ucc__uı_®lg©h”v_š™
(
sk
);

215 
UCC_COLL_TYPE_BCAST
:

216 
¡©us
 = 
	`ucc__uı_bÿ¡_š™
(
sk
);

218 
UCC_COLL_TYPE_REDUCE
:

219 
¡©us
 = 
	`ucc__uı_»duû_š™
(
sk
);

221 
UCC_COLL_TYPE_GATHER
:

222 
¡©us
 = 
	`ucc__uı_g©h”_š™
(
sk
);

224 
UCC_COLL_TYPE_FANIN
:

225 
¡©us
 = 
	`ucc__uı_çnš_š™
(
sk
);

227 
UCC_COLL_TYPE_FANOUT
:

228 
¡©us
 = 
	`ucc__uı_çnout_š™
(
sk
);

230 
UCC_COLL_TYPE_SCATTERV
:

231 
¡©us
 = 
	`ucc__uı_sÿ‰”v_š™
(
sk
);

233 
UCC_COLL_TYPE_GATHERV
:

234 
¡©us
 = 
	`ucc__uı_g©h”v_š™
(
sk
);

237 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

239 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

240 
	`ucc__uı_put_sk
(
sk
);

241  
¡©us
;

243 
	`_Œaû
(
‹am
->
cÚ‹xt
->
lib
, "š™ cŞÈ»q %p", 
sk
);

244 *
sk_h
 = &
sk
->
su³r
;

245  
¡©us
;

246 
	}
}

248 
šlše
 
	$®g_id_äom_¡r
(
ucc_cŞl_ty³_t
 
cŞl_ty³
, cÚ¡ *
¡r
)

250 
cŞl_ty³
) {

251 
UCC_COLL_TYPE_ALLGATHER
:

252  
	`ucc__uı_®lg©h”_®g_äom_¡r
(
¡r
);

253 
UCC_COLL_TYPE_ALLGATHERV
:

254  
	`ucc__uı_®lg©h”v_®g_äom_¡r
(
¡r
);

255 
UCC_COLL_TYPE_ALLREDUCE
:

256  
	`ucc__uı_®Ìeduû_®g_äom_¡r
(
¡r
);

257 
UCC_COLL_TYPE_ALLTOALL
:

258  
	`ucc__uı_®ÉßÎ_®g_äom_¡r
(
¡r
);

259 
UCC_COLL_TYPE_ALLTOALLV
:

260  
	`ucc__uı_®ÉßÎv_®g_äom_¡r
(
¡r
);

261 
UCC_COLL_TYPE_BCAST
:

262  
	`ucc__uı_bÿ¡_®g_äom_¡r
(
¡r
);

263 
UCC_COLL_TYPE_REDUCE
:

264  
	`ucc__uı_»duû_®g_äom_¡r
(
¡r
);

265 
UCC_COLL_TYPE_REDUCE_SCATTER
:

266  
	`ucc__uı_»duû_sÿ‰”_®g_äom_¡r
(
¡r
);

267 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

268  
	`ucc__uı_»duû_sÿ‰”v_®g_äom_¡r
(
¡r
);

273 
	}
}

275 
ucc_¡©us_t
 
	$ucc__uı_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

276 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

277 
ucc_memÜy_ty³_t
 
mem_ty³
,

278 
ucc_ba£_cŞl_š™_â_t
 *
š™
)

280 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

282 ià(
®g_id_¡r
) {

283 
®g_id
 = 
	`®g_id_äom_¡r
(
cŞl_ty³
, 
®g_id_¡r
);

286 
cŞl_ty³
) {

287 
UCC_COLL_TYPE_ALLGATHER
:

288 
®g_id
) {

289 
UCC_TL_UCP_ALLGATHER_ALG_KNOMIAL
:

290 *
š™
 = 
ucc__uı_®lg©h”_knomŸl_š™
;

292 
UCC_TL_UCP_ALLGATHER_ALG_RING
:

293 *
š™
 = 
ucc__uı_®lg©h”_ršg_š™
;

295 
UCC_TL_UCP_ALLGATHER_ALG_NEIGHBOR
:

296 *
š™
 = 
ucc__uı_®lg©h”_ÃighbÜ_š™
;

298 
UCC_TL_UCP_ALLGATHER_ALG_BRUCK
:

299 *
š™
 = 
ucc__uı_®lg©h”_bruck_š™
;

301 
UCC_TL_UCP_ALLGATHER_ALG_SPARBIT
:

302 *
š™
 = 
ucc__uı_®lg©h”_¥¬b™_š™
;

304 
UCC_TL_UCP_ALLGATHER_ALG_LINEAR
:

305 *
š™
 = 
ucc__uı_®lg©h”_lš—r_š™
;

307 
UCC_TL_UCP_ALLGATHER_ALG_LINEAR_BATCHED
:

308 *
š™
 = 
ucc__uı_®lg©h”_lš—r_b©ched_š™
;

311 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

315 
UCC_COLL_TYPE_ALLGATHERV
:

316 
®g_id
) {

317 
UCC_TL_UCP_ALLGATHERV_ALG_KNOMIAL
:

318 *
š™
 = 
ucc__uı_®lg©h”v_knomŸl_š™
;

320 
UCC_TL_UCP_ALLGATHERV_ALG_RING
:

321 *
š™
 = 
ucc__uı_®lg©h”v_ršg_š™
;

324 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

328 
UCC_COLL_TYPE_ALLREDUCE
:

329 
®g_id
) {

330 
UCC_TL_UCP_ALLREDUCE_ALG_KNOMIAL
:

331 *
š™
 = 
ucc__uı_®Ìeduû_knomŸl_š™
;

333 
UCC_TL_UCP_ALLREDUCE_ALG_SRA_KNOMIAL
:

334 *
š™
 = 
ucc__uı_®Ìeduû_¤a_knomŸl_š™
;

336 
UCC_TL_UCP_ALLREDUCE_ALG_DBT
:

337 *
š™
 = 
ucc__uı_®Ìeduû_dbt_š™
;

339 
UCC_TL_UCP_ALLREDUCE_ALG_SLIDING_WINDOW
:

340 *
š™
 = 
ucc__uı_®Ìeduû_¦idšg_wšdow_š™
;

343 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

347 
UCC_COLL_TYPE_BCAST
:

348 
®g_id
) {

349 
UCC_TL_UCP_BCAST_ALG_KNOMIAL
:

350 *
š™
 = 
ucc__uı_bÿ¡_knomŸl_š™
;

352 
UCC_TL_UCP_BCAST_ALG_SAG_KNOMIAL
:

353 *
š™
 = 
ucc__uı_bÿ¡_§g_knomŸl_š™
;

355 
UCC_TL_UCP_BCAST_ALG_DBT
:

356 *
š™
 = 
ucc__uı_bÿ¡_dbt_š™
;

359 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

363 
UCC_COLL_TYPE_ALLTOALL
:

364 
®g_id
) {

365 
UCC_TL_UCP_ALLTOALL_ALG_PAIRWISE
:

366 *
š™
 = 
ucc__uı_®ÉßÎ_·œwi£_š™
;

368 
UCC_TL_UCP_ALLTOALL_ALG_BRUCK
:

369 *
š™
 = 
ucc__uı_®ÉßÎ_bruck_š™
;

371 
UCC_TL_UCP_ALLTOALL_ALG_ONESIDED
:

372 *
š™
 = 
ucc__uı_®ÉßÎ_Úesided_š™
;

375 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

379 
UCC_COLL_TYPE_ALLTOALLV
:

380 
®g_id
) {

381 
UCC_TL_UCP_ALLTOALLV_ALG_PAIRWISE
:

382 *
š™
 = 
ucc__uı_®ÉßÎv_·œwi£_š™
;

384 
UCC_TL_UCP_ALLTOALLV_ALG_HYBRID
:

385 *
š™
 = 
ucc__uı_®ÉßÎv_hybrid_š™
;

387 
UCC_TL_UCP_ALLTOALLV_ALG_ONESIDED
:

388 *
š™
 = 
ucc__uı_®ÉßÎv_Úesided_š™
;

391 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

395 
UCC_COLL_TYPE_REDUCE
:

396 
®g_id
) {

397 
UCC_TL_UCP_REDUCE_ALG_KNOMIAL
:

398 *
š™
 = 
ucc__uı_»duû_knomŸl_š™
;

400 
UCC_TL_UCP_REDUCE_ALG_DBT
:

401 *
š™
 = 
ucc__uı_»duû_dbt_š™
;

403 
UCC_TL_UCP_REDUCE_ALG_SRG
:

404 *
š™
 = 
ucc__uı_»duû_¤g_knomŸl_š™
;

407 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

411 
UCC_COLL_TYPE_REDUCE_SCATTER
:

412 
®g_id
) {

413 
UCC_TL_UCP_REDUCE_SCATTER_ALG_RING
:

414 *
š™
 = 
ucc__uı_»duû_sÿ‰”_ršg_š™
;

416 
UCC_TL_UCP_REDUCE_SCATTER_ALG_KNOMIAL
:

417 *
š™
 = 
ucc__uı_»duû_sÿ‰”_knomŸl_š™
;

420 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

424 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

425 
®g_id
) {

426 
UCC_TL_UCP_REDUCE_SCATTERV_ALG_RING
:

427 *
š™
 = 
ucc__uı_»duû_sÿ‰”v_ršg_š™
;

430 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

435 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

438  
¡©us
;

439 
	}
}

	@src/components/tl/ucp/tl_ucp_coll.h

8 #iâdeà
UCC_TL_UCP_COLL_H_


9 
	#UCC_TL_UCP_COLL_H_


	)

11 
	~"_uı.h
"

12 
	~"scheduË/ucc_scheduË_p–šed.h
"

13 
	~"cŞl_·‰”ns/»cursive_knomŸl.h
"

14 
	~"cŞl_·‰”ns/doubË_bš¬y_Œ“.h
"

15 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

16 
	~"compÚ’ts/ec/ucc_ec.h
"

17 
	~"_uı_g.h
"

19 
	#UCC_UUNITS_AUTO_RADIX
 4

	)

20 
	#UCC_TL_UCP_TASK_PLUGIN_MAX_DATA
 128

	)

21 
	#UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
 9

	)

23 
ucc_¡©us_t
 
ucc__uı_‹am_deçuÉ_scÜe_¡r_®loc
(
ucc__uı_‹am_t
 *
‹am
,

24 *
deçuÉ_£Ëù_¡r
[
UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
]);

26 
ucc__uı_‹am_deçuÉ_scÜe_¡r_ä“
(

27 *
deçuÉ_£Ëù_¡r
[
UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
]);

29 
	#CALC_KN_TREE_DIST
(
_size
, 
_¿dix
, 
_di¡
) \

31 
_di¡
 = 1; \

32 
_di¡
 * 
_¿dix
 < 
_size
) { \

33 
_di¡
 *ğ
_¿dix
; \

35 } 0)

	)

37 
	#VRANK
(
_¿nk
, 
_roÙ
, 
_‹am_size
) \

38 (((
_¿nk
è- (
_roÙ
è+ (
_‹am_size
)è% (_‹am_size))

	)

40 
	#INV_VRANK
(
_¿nk
, 
_roÙ
, 
_‹am_size
) \

41 (((
_¿nk
è+ (
_roÙ
)è% (
_‹am_size
))

	)

43 
	#EXEC_TASK_TEST
(
_pha£
, 
_”rmsg
, 
_‘ask
) do { \

44 ià(
_‘ask
 !ğ
NULL
) { \

45 
¡©us
 = 
	`ucc_“_executÜ_sk_‹¡
(
_‘ask
); \

46 ià(
¡©us
 > 0) { \

47 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
; \

48 
	`SAVE_STATE
(
_pha£
); \

51 
	`ucc_“_executÜ_sk_fš®ize
(
_‘ask
); \

52 
_‘ask
 = 
NULL
; \

53 ià(
	`ucc_uÆik–y
(
¡©us
 < 0)) { \

54 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), 
_”rmsg
); \

55 
sk
->
su³r
.
¡©us
 = status; \

59 } 0)

	)

61 
	#EXEC_TASK_WAIT
(
_‘ask
, ...) \

63 ià(
_‘ask
 !ğ
NULL
) { \

65 
¡©us
 = 
	`ucc_“_executÜ_sk_‹¡
(
_‘ask
); \

66 } 
¡©us
 > 0); \

67 ià(
¡©us
 < 0) { \

68 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure inƒeaskƒeask"); \

69 
sk
->
su³r
.
¡©us
 = status; \

70  
__VA_ARGS__
; \

72 
	`ucc_“_executÜ_sk_fš®ize
(
_‘ask
); \

73 ià(
	`ucc_uÆik–y
(
¡©us
 < 0)) { \

74 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failedo finalizeƒeask"); \

75 
sk
->
su³r
.
¡©us
 = status; \

76  
__VA_ARGS__
; \

79 } 0)

	)

81 * (*
	tucc__uı_scÜe_¡r_g‘_â_t
)(
	tucc__uı_‹am_t
 *
	t‹am
);

82 
	succ__uı_deçuÉ_®g_desc
 {

83 *
	m£Ëù_¡r
;

84 
ucc__uı_scÜe_¡r_g‘_â_t
 
	m¡r_g‘_â
;

85 } 
	tucc__uı_deçuÉ_®g_desc_t
;

87 
	eucc__uı_sk_æags
 {

89 
	mUCC_TL_UCP_TASK_FLAG_SUBSET
 = 
UCC_BIT
(0),

92 
ucc__uı_®Ìeduû_sw_p–še


93 
	tucc__uı_®Ìeduû_sw_p–še
;

94 
ucc__uı_®Ìeduû_sw_ho¡_®lg©h”


95 
	tucc__uı_®Ìeduû_sw_ho¡_®lg©h”
;

96 
ucc__uı_dpu_ofæßd_buf_šfo


97 
	tucc__uı_dpu_ofæßd_buf_šfo_t
;

99 
	succ__uı_sk
 {

100 
ucc_cŞl_sk_t
 
	msu³r
;

101 
ušt32_t
 
	mæags
;

104 
ušt32_t
 
	m£nd_po¡ed
;

105 
ušt32_t
 
	m£nd_com¶‘ed
;

106 
ušt32_t
 
	m»cv_po¡ed
;

107 
ušt32_t
 
	m»cv_com¶‘ed
;

108 
ušt32_t
 
	mg
;

109 } 
	mgged
;

111 
ušt32_t
 
	mput_po¡ed
;

112 
ušt32_t
 
	mput_com¶‘ed
;

113 
ušt32_t
 
	mg‘_po¡ed
;

114 
ušt32_t
 
	mg‘_com¶‘ed
;

115 } 
	mÚesided
;

117 
ušt32_t
 
	mn_pŞls
;

118 
ucc_sub£t_t
 
	msub£t
;

121 
	mpha£
;

122 
ucc_knomŸl_·‰”n_t
 
	mp
;

123 } 
	mb¬r›r
;

125 
	mpha£
;

126 
ucc_knomŸl_·‰”n_t
 
	mp
;

127 *
	msü©ch
;

128 *
	m»duû_bufs
[
UCC_EE_EXECUTOR_NUM_BUFS
];

129 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch_mc_h—d”
;

130 
ucc_“_executÜ_sk_t
 *
	m‘ask
;

131 
ucc_“_executÜ_t
 *
	mexecutÜ
;

132 } 
	m®Ìeduû_kn
;

134 
ucc__uı_®Ìeduû_sw_p–še
 *
	mpe
;

135 
ucs_¡©us_±r_t
 *
	mput_»que¡s
;

136 
ucc__uı_®Ìeduû_sw_ho¡_®lg©h”
 *
	m®lg©h”_d©a
;

137 
ucc_cŞl_sk_t
 *
	m®lg©h”_sk
;

138 
ucc_“_executÜ_sk_t
 *
	m»duû_sk
;

139 
ucc__uı_dpu_ofæßd_buf_šfo_t
 *
	mbufs
;

140 } 
	m®Ìeduû_¦idšg_wšdow
;

142 
	mpha£
;

143 
ucc_knomŸl_·‰”n_t
 
	mp
;

144 *
	msü©ch
;

145 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch_mc_h—d”
;

146 
ucc_“_executÜ_sk_t
 *
	m‘ask
;

147 
ucc_“_executÜ_t
 *
	mexecutÜ
;

148 
size_t
 
	mmax_£g
;

149 } 
	m»duû_sÿ‰”_kn
;

151 *
	msü©ch
;

152 
size_t
 
	mmax_block_couÁ
;

153 
ucc_•_m­_t
 
	mšv_m­
;

154 
	mn_äags
;

155 
	mäag
;

156 
	ms_sü©ch_busy
[2];

157 
ucc_“_executÜ_sk_t
 *
	m‘ask
;

158 
ucc_“_executÜ_t
 *
	mexecutÜ
;

159 } 
	m»duû_sÿ‰”_ršg
;

161 *
	msü©ch
;

162 
size_t
 
	mmax_block_couÁ
;

163 
ucc_•_m­_t
 
	mšv_m­
;

164 
	mn_äags
;

165 
	mäag
;

166 
	ms_sü©ch_busy
[2];

167 
ucc_“_executÜ_sk_t
 *
	m‘ask
;

168 
ucc_“_executÜ_t
 *
	mexecutÜ
;

169 } 
	m»duû_sÿ‰”v_ršg
;

171 
	mpha£
;

172 
ucc_knomŸl_·‰”n_t
 
	mp
;

173 
ucc_¿nk_t
 
	m»cv_di¡
;

174 
±rdiff_t
 
	m£nd_off£t
;

175 
±rdiff_t
 
	m»cv_off£t
;

176 
size_t
 
	m»cv_size
;

177 } 
	msÿ‰”_kn
;

179 
	mpha£
;

180 
ucc_knomŸl_·‰”n_t
 
	mp
;

181 *
	msbuf
;

182 
ucc__uı_cİy_sk_t
 *
	mcİy_sk
;

183 
ucc_¿nk_t
 
	m»cv_di¡
;

184 } 
	m®lg©h”_kn
;

193 
ucc_¿nk_t
 (*
g‘_£nd_block
)(
ucc_sub£t_t
 *
	msub£t
,

194 
ucc_¿nk_t
 
	mŒªk
,

195 
ucc_¿nk_t
 
	mtsize
,

196 
	m¡•
);

197 
ucc_¿nk_t
 (*
g‘_»cv_block
)(
ucc_sub£t_t
 *
	msub£t
,

198 
ucc_¿nk_t
 
	mŒªk
,

199 
ucc_¿nk_t
 
	mtsize
,

200 
	m¡•
);

201 } 
	m®lg©h”_ršg
;

203 
	mÄeqs
;

204 
ucc__uı_cİy_sk_t
 *
	mcİy_sk
;

205 } 
	m®lg©h”_lš—r
;

207 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch_h—d”
;

208 
size_t
 
	msü©ch_size
;

209 } 
	m®lg©h”_bruck
;

211 
ušt32_t
 
	mi
;

212 
	md©a_ex³ùed
;

213 } 
	m®lg©h”_¥¬b™
;

215 
ucc_¿nk_t
 
	mdi¡
;

216 
ušt32_t
 
	m¿dix
;

217 } 
	mbÿ¡_kn
;

219 
ucc_dbt_sšgË_Œ“_t
 
	mt1
;

220 
ucc_dbt_sšgË_Œ“_t
 
	mt2
;

221 
	m¡©e
;

222 } 
	mbÿ¡_dbt
;

224 
ucc_¿nk_t
 
	mdi¡
;

225 
ucc_¿nk_t
 
	mmax_di¡
;

226 
	mchd»n_³r_cyşe
;

227 
ušt32_t
 
	m¿dix
;

228 
	mpha£
;

229 *
	msü©ch
;

230 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch_mc_h—d”
;

231 
ucc_“_executÜ_sk_t
 *
	m‘ask
;

232 
ucc_“_executÜ_t
 *
	mexecutÜ
;

233 } 
	m»duû_kn
;

235 
	m¡©e
;

236 
ucc_dbt_sšgË_Œ“_t
 
	mŒ“s
[2];

237 
	m»duùiÚ_comp
[2];

238 
	m£nd_comp
[2];

239 *
	msü©ch
;

240 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch_mc_h—d”
;

241 
ucc_“_executÜ_sk_t
 *
	m‘ask
;

242 
ucc_“_executÜ_t
 *
	mexecutÜ
;

243 } 
	m»duû_dbt
;

245 
	mpha£
;

246 
ucc_knomŸl_·‰”n_t
 
	mp
;

247 
ucc_¿nk_t
 
	mdi¡
;

248 
ucc_¿nk_t
 
	mmax_di¡
;

249 
ušt32_t
 
	m¿dix
;

250 * 
	msü©ch
;

251 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch_mc_h—d”
;

252 } 
	mg©h”_kn
;

254 
size_t
 
	mm”ge_buf_size
;

255 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch_mc_h—d”
;

256 
size_t
 
	mby‹_£nd_lim™
;

257 
	mpha£
;

258 
ušt32_t
 
	m¿dix
;

259 
ušt32_t
 
	mcur_¿dix
;

260 
ušt32_t
 
	m™”©iÚ
;

261 
ucc_¿nk_t
 
	mcur_out
;

262 
size_t
 
	mŒaffic_š
;

263 
size_t
 
	mŒaffic_out
;

264 
ucc_¿nk_t
 
	mnum_š
;

265 
ucc_¿nk_t
 
	mnum2£nd
;

266 
ucc_¿nk_t
 
	mnum2»cv
;

267 } 
	m®ÉßÎv_hybrid
;

269 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch_mc_h—d”
;

270 
ucc_“_executÜ_sk_t
 *
	m‘ask
;

271 *
	m¤c
;

272 *
	md¡
;

273 
ucc_¿nk_t
 
	m™”©iÚ
;

274 
	mpha£
;

275 } 
	m®ÉßÎ_bruck
;

276 
	m¶ugš_d©a
[
UCC_TL_UCP_TASK_PLUGIN_MAX_DATA
];

278 } 
	tucc__uı_sk_t
;

280 
	succ__uı_scheduË
 {

281 
ucc_scheduË_p–šed_t
 
	msu³r
;

282 
ucc_mc_bufãr_h—d”_t
 *
	msü©ch_mc_h—d”
;

284 
±rdiff_t
 
	mäag_off£t
;

285 } 
	m»duû_¤g_kn
;

286 } 
	tucc__uı_scheduË_t
;

288 
	#TASK_TEAM
(
_sk
) \

289 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
, 
ucc__uı_‹am_t
))

	)

290 
	#TASK_CTX
(
_sk
) \

291 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
, 
ucc__uı_cÚ‹xt_t
))

	)

292 
	#TASK_LIB
(
_sk
) \

293 (
	`ucc_d”ived_of
((
_sk
)->
su³r
.
‹am
->
cÚ‹xt
->
lib
, 
ucc__uı_lib_t
))

	)

294 
	#TASK_ARGS
(
_sk
è(_sk)->
su³r
.
b¬gs
.
¬gs


	)

296 
	#AVG_ALPHA
(
_sk
è(1.0 / ()
	`UCC_TL_TEAM_SIZE
(
	`TASK_TEAM
(_sk)))

	)

298 
šlše
 
	$ucc__uı_sk_»£t
(
ucc__uı_sk_t
 *
sk
,

299 
ucc_¡©us_t
 
¡©us
)

301 
sk
->
gged
.
£nd_po¡ed
 = 0;

302 
sk
->
gged
.
£nd_com¶‘ed
 = 0;

303 
sk
->
gged
.
»cv_po¡ed
 = 0;

304 
sk
->
gged
.
»cv_com¶‘ed
 = 0;

305 
sk
->
su³r
.
¡©us
 = status;

306 
	}
}

308 
šlše
 
ucc__uı_sk_t
 *
	$ucc__uı_g‘_sk
(
ucc__uı_‹am_t
 *
‹am
)

310 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

311 
ucc__uı_sk_t
 *
sk
 = 
	`ucc_mpoŞ_g‘
(&
ùx
->
»q_mp
);;

313 
	`UCC_TL_UCP_PROFILE_REQUEST_NEW
(
sk
, "tl_ucp_task", 0);

314 
sk
->
su³r
.
æags
 = 0;

315 
sk
->
æags
 = 0;

316 
sk
->
n_pŞls
 = 
ùx
->
cfg
.n_polls;

317 
sk
->
su³r
.
‹am
 = &team->super.super;

318 
sk
->
sub£t
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

319 
sk
->
sub£t
.
m­
.
•_num
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

320 
sk
->
sub£t
.
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

321 
	`ucc__uı_sk_»£t
(
sk
, 
UCC_OPERATION_INITIALIZED
);

322  
sk
;

323 
	}
}

325 
šlše
 
	$ucc__uı_put_sk
(
ucc__uı_sk_t
 *
sk
)

327 
	`UCC_TL_UCP_PROFILE_REQUEST_FREE
(
sk
);

328 
	`ucc_mpoŞ_put
(
sk
);

329 
	}
}

331 
šlše
 
ucc_¡©us_t


332 
	$ucc__uı_g‘_scheduË
(
ucc__uı_‹am_t
 *
‹am
,

333 
ucc_ba£_cŞl_¬gs_t
 *
¬gs
,

334 
ucc__uı_scheduË_t
 **
scheduË
)

336 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

338 *
scheduË
 = 
	`ucc_mpoŞ_g‘
(&
ùx
->
»q_mp
);

339 ià(
	`ucc_uÆik–y
(!(*
scheduË
))) {

340  
UCC_ERR_NO_MEMORY
;

343 
	`UCC_TL_UCP_PROFILE_REQUEST_NEW
(
scheduË
, "tl_ucp_sched", 0);

344  
	`ucc_scheduË_š™
(&((*
scheduË
)->
su³r
.su³r), 
¬gs
,

345 &
‹am
->
su³r
.super);

346 
	}
}

348 
šlše
 
	$ucc__uı_put_scheduË
(
ucc_scheduË_t
 *
scheduË
)

350 
	`UCC_TL_UCP_PROFILE_REQUEST_FREE
(
scheduË
);

351 
	`ucc_mpoŞ_put
(
scheduË
);

352 
	}
}

354 
ucc_¡©us_t
 
ucc__uı_cŞl_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

355 
ucc_ba£_‹am_t
 * 
‹am
,

356 
ucc_cŞl_sk_t
 ** 
sk_h
);

358 
ucc_¡©us_t
 
ucc__uı_cŞl_fš®ize
(
ucc_cŞl_sk_t
 *
cŞl_sk
);

360 
šlše
 
ucc__uı_sk_t
 *

361 
	$ucc__uı_š™_sk
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
)

363 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

364 
ucc__uı_sk_t
 *
sk
 = 
	`ucc__uı_g‘_sk
(
_‹am
);

366 ià(
	`ucc_uÆik–y
(!
sk
)) {

367  
NULL
;

370 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, 
cŞl_¬gs
, 
‹am
);

372 ià(
	`UCC_COLL_ARGS_ACTIVE_SET
(&
cŞl_¬gs
->
¬gs
)) {

373 
sk
->
gged
.
g
 = (
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_TAG
)

374 ? 
cŞl_¬gs
->
¬gs
.
g
 : 
UCC_TL_UCP_ACTIVE_SET_TAG
;

375 
sk
->
æags
 |ğ
UCC_TL_UCP_TASK_FLAG_SUBSET
;

376 
sk
->
sub£t
.
m­
 = 
	`ucc_aùive_£t_to_•_m­
(&
cŞl_¬gs
->
¬gs
);

377 
sk
->
sub£t
.
my¿nk
 =

378 
	`ucc_•_m­_loÿl_¿nk
(
sk
->
sub£t
.
m­
,

379 
	`UCC_TL_TEAM_RANK
(
_‹am
));

380 
	`ucc_as£¹
(
cŞl_¬gs
->
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_BCAST
);

382 ià(
cŞl_¬gs
->
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_TAG
) {

383 
sk
->
gged
.
g
 = 
cŞl_¬gs
->
¬gs
.tag;

385 
_‹am
->
£q_num
 = (_‹am->£q_num + 1è% 
UCC_TL_UCP_MAX_COLL_TAG
;

386 
sk
->
gged
.
g
 = 
_‹am
->
£q_num
;

390 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_cŞl_fš®ize
;

391  
sk
;

392 
	}
}

394 
	#UCC_TL_UCP_TASK_P2P_COMPLETE
(
_sk
) \

395 (((
_sk
)->
gged
.
£nd_po¡ed
 =ğ(_sk)->gged.
£nd_com¶‘ed
) && \

396 ((
_sk
)->
gged
.
»cv_po¡ed
 =ğ(_sk)->gged.
»cv_com¶‘ed
))

	)

398 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_‹¡
(
ucc__uı_sk_t
 *
sk
)

400 
pŞls
 = 0;

402 ià(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
)) {

403  
UCC_OK
;

405 
pŞls
++ < 
sk
->
n_pŞls
) {

406 ià(
	`UCC_TL_UCP_TASK_P2P_COMPLETE
(
sk
)) {

407  
UCC_OK
;

409 
	`uı_wÜk”_´og»ss
(
	`UCC_TL_UCP_TASK_TEAM
(
sk
)->
wÜk”
->
uı_wÜk”
);

411  
UCC_INPROGRESS
;

412 
	}
}

414 
	#UCC_TL_UCP_TASK_RECV_COMPLETE
(
_sk
) \

415 (((
_sk
)->
gged
.
»cv_po¡ed
 =ğ(_sk)->gged.
»cv_com¶‘ed
))

	)

417 
	#UCC_TL_UCP_TASK_SEND_COMPLETE
(
_sk
) \

418 (((
_sk
)->
gged
.
£nd_po¡ed
 =ğ(_sk)->gged.
£nd_com¶‘ed
))

	)

420 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_‹¡_»cv
(
ucc__uı_sk_t
 *
sk
)

422 
pŞls
 = 0;

424 ià(
	`UCC_TL_UCP_TASK_RECV_COMPLETE
(
sk
)) {

425  
UCC_OK
;

427 
pŞls
++ < 
sk
->
n_pŞls
) {

428 ià(
	`UCC_TL_UCP_TASK_RECV_COMPLETE
(
sk
)) {

429  
UCC_OK
;

431 
	`uı_wÜk”_´og»ss
(
	`UCC_TL_UCP_TASK_TEAM
(
sk
)->
wÜk”
->
uı_wÜk”
);

433  
UCC_INPROGRESS
;

434 
	}
}

436 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_‹¡_£nd
(
ucc__uı_sk_t
 *
sk
)

438 
pŞls
 = 0;

440 ià(
	`UCC_TL_UCP_TASK_SEND_COMPLETE
(
sk
)) {

441  
UCC_OK
;

443 
pŞls
++ < 
sk
->
n_pŞls
) {

444 ià(
	`UCC_TL_UCP_TASK_SEND_COMPLETE
(
sk
)) {

445  
UCC_OK
;

447 
	`uı_wÜk”_´og»ss
(
	`UCC_TL_UCP_TASK_TEAM
(
sk
)->
wÜk”
->
uı_wÜk”
);

449  
UCC_INPROGRESS
;

450 
	}
}

452 
	#UCC_TL_UCP_TASK_RING_P2P_COMPLETE
(
_sk
) \

453 ((((
_sk
)->
gged
.
£nd_po¡ed
 - (_sk)->gged.
£nd_com¶‘ed
) <= 1) && \

454 ((
_sk
)->
gged
.
»cv_po¡ed
 =ğ(_sk)->gged.
»cv_com¶‘ed
))

	)

456 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_‹¡_ršg
(
ucc__uı_sk_t
 *
sk
)

458 
pŞls
 = 0;

460 ià(
	`UCC_TL_UCP_TASK_RING_P2P_COMPLETE
(
sk
)) {

461  
UCC_OK
;

463 
pŞls
++ < 
sk
->
n_pŞls
) {

464 ià(
	`UCC_TL_UCP_TASK_RING_P2P_COMPLETE
(
sk
)) {

465  
UCC_OK
;

467 
	`uı_wÜk”_´og»ss
(
	`TASK_CTX
(
sk
)->
wÜk”
.
uı_wÜk”
);

469  
UCC_INPROGRESS
;

470 
	}
}

472 
	#UCC_TL_UCP_TASK_ONESIDED_P2P_COMPLETE
(
_sk
) \

473 (((
_sk
)->
Úesided
.
put_po¡ed
 =ğ(_sk)->Úesided.
put_com¶‘ed
) && \

474 ((
_sk
)->
Úesided
.
g‘_po¡ed
 =ğ(_sk)->Úesided.
g‘_com¶‘ed
))

	)

476 
	#UCC_TL_UCP_TASK_ONESIDED_SYNC_COMPLETE
(
_sk
, 
_’d
) \

477 (*((*)(
	`TASK_ARGS
(
_sk
).
glob®_wÜk_bufãr
)è=ğ
_’d
)

	)

479 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_‹¡_Úesided
(
ucc__uı_sk_t
 *
sk
,

480 
sync_’d
)

482 
pŞls
 = 0;

484 ià(
	`UCC_TL_UCP_TASK_ONESIDED_P2P_COMPLETE
(
sk
) &&

485 
	`UCC_TL_UCP_TASK_ONESIDED_SYNC_COMPLETE
(
sk
, 
sync_’d
)) {

486  
UCC_OK
;

488 
pŞls
++ < 
sk
->
n_pŞls
) {

489 ià(
	`UCC_TL_UCP_TASK_ONESIDED_P2P_COMPLETE
(
sk
) &&

490 
	`UCC_TL_UCP_TASK_ONESIDED_SYNC_COMPLETE
(
sk
, 
sync_’d
)) {

491  
UCC_OK
;

493 
	`uı_wÜk”_´og»ss
(
	`UCC_TL_UCP_TASK_TEAM
(
sk
)->
wÜk”
->
uı_wÜk”
);

495  
UCC_INPROGRESS
;

496 
	}
}

498 
ucc_¡©us_t
 
ucc__uı_®g_id_to_š™
(
®g_id
, cÚ¡ *
®g_id_¡r
,

499 
ucc_cŞl_ty³_t
 
cŞl_ty³
,

500 
ucc_memÜy_ty³_t
 
mem_ty³
,

501 
ucc_ba£_cŞl_š™_â_t
 *
š™
);

503 
šlše
 

504 
	$ucc__uı_g‘_¿dix_äom_¿nge
(
ucc__uı_‹am_t
 *
‹am
,

505 
size_t
 
msgsize
,

506 
ucc_memÜy_ty³_t
 
mem_ty³
,

507 
ucc_m¿nge_ušt_t
 *
p
,

508 
ucc_¿nk_t
 
deçuÉ_v®ue
)

510 
¿dix
;

512 
¿dix
 = 
	`ucc_m¿nge_ušt_g‘
(
p
, 
msgsize
, 
mem_ty³
);

514 ià(
UCC_UUNITS_AUTO
 =ğ
¿dix
) {

515  
deçuÉ_v®ue
;

517  
¿dix
;

518 
	}
}

525 
šlše
 
	$ucc__uı_g‘_knomŸl_¿dix
(
ucc__uı_‹am_t
 *
‹am
,

526 
size_t
 
couÁ
,

527 
ucc_d©©y³_t
 
dty³
,

528 
ucc_memÜy_ty³_t
 
mem_ty³
,

529 
ucc_m¿nge_ušt_t
 *
p
,

530 
Ãed_sü©ch
)

532 
size_t
 
msgsize
 = 
couÁ
 * 
	`ucc_dt_size
(
dty³
);

533 
İt_¿dix
, 
cfg_¿dix
, 
¿dix
;

535 
İt_¿dix
 = (
mem_ty³
 =ğ
UCC_MEMORY_TYPE_HOST
è? 
‹am
->
İt_¿dix_ho¡
 :

536 
‹am
->
İt_¿dix
;

537 
cfg_¿dix
 = 
	`ucc__uı_g‘_¿dix_äom_¿nge
(
‹am
, 
msgsize
, 
mem_ty³
, 
p
,

538 
İt_¿dix
);

539 ià(
Ãed_sü©ch
) {

540 
¿dix
 = 
	`ucc_knomŸl_·‰”n_g‘_mš_¿dix
(
cfg_¿dix
, 
	`UCC_TL_TEAM_SIZE
(
‹am
), 
couÁ
);

542 
¿dix
 = 
	`ucc_mš
(
cfg_¿dix
, 
	`UCC_TL_TEAM_SIZE
(
‹am
));

545  
¿dix
;

546 
	}
}

	@src/components/tl/ucp/tl_ucp_context.c

7 
	~"_uı.h
"

8 
	~"_uı_g.h
"

9 
	~"_uı_cŞl.h
"

10 
	~"_uı_•.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_¡ršg.h
"

13 
	~"uts/¬ch/ıu.h
"

14 
	~"scheduË/ucc_scheduË_p–šed.h
"

15 
	~"_uı_cİy.h
"

16 
	~<lim™s.h
>

18 
	~"_uı_£nd»cv.h
"

20 
	#UCP_CHECK
(
funùiÚ
, 
msg
, 
go
, 
ùx
) \

21 
¡©us
 = 
funùiÚ
; \

22 ià(
UCS_OK
 !ğ
¡©us
) { \

23 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, 
msg
 ", %s", 
	`ucs_¡©us_¡ršg
(
¡©us
)); \

24 
ucc_¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
); \

25 
go
; \

26 }

	)

28 
	#CHECK
(
‹¡
, 
msg
, 
go
, 
»tuº_¡©us
, 
ùx
) \

29 ià(
‹¡
) { \

30 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, 
msg
); \

31 
ucc_¡©us
 = 
»tuº_¡©us
; \

32 
go
; \

33 }

	)

35 
	#MAX_NET_DEVICES_STR_LEN
 512

	)

37 
	$ucc__uı_£rviû_wÜk”_´og»ss
(*
´og»ss_¬g
)

39 
ucc__uı_cÚ‹xt_t
 *
ùx
 = (ucc__uı_cÚ‹xt_ˆ*)
´og»ss_¬g
;

40 
thrÙšg_couÁ
 =

41 
	`ucc_©omic_çdd32
(&
ùx
->
£rviû_wÜk”_thrÙšg_couÁ
, 1);

43 ià(
thrÙšg_couÁ
 =ğ
ùx
->
cfg
.
£rviû_thrÙšg_th»sh
) {

44 
ùx
->
£rviû_wÜk”_thrÙšg_couÁ
 = 0;

45  
	`uı_wÜk”_´og»ss
(
ùx
->
£rviû_wÜk”
.
uı_wÜk”
);

49 
	}
}

51 
šlše
 
ucc_¡©us_t


52 
	$ucc__uı_•s_•hash_š™
(cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

53 
ucc__uı_cÚ‹xt_t
 * 
ùx
,

54 
_uı_•_hash_t
 **
•_hash
, 
uı_•_h
 **
•s
)

56 ià(
·¿ms
->
cÚ‹xt
->·¿ms.
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
) {

58 *
•s
 = 
	`ucc_ÿÎoc
(
·¿ms
->
cÚ‹xt
->·¿ms.
oob
.
n_oob_•s
,

59 (
uı_•_h
), "ucp_eps");

60 ià(!(*
•s
)) {

61 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

63 
·¿ms
->
cÚ‹xt
->·¿ms.
oob
.
n_oob_•s
 * (
uı_•_h
));

64  
UCC_ERR_NO_MEMORY
;

67 *
•s
 = 
NULL
;

68 *
•_hash
 = 
	`kh_š™
(
_uı_•_hash
);

70  
UCC_OK
;

71 
	}
}

73 
šlše
 
ucc_¡©us_t


74 
	$ucc__uı_cÚ‹xt_£rviû_š™
(cÚ¡ *
´efix
, 
uı_·¿ms_t
 
uı_·¿ms
,

75 
uı_wÜk”_·¿ms_t
 
wÜk”_·¿ms
,

76 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

77 
ucc__uı_cÚ‹xt_t
 * 
ùx
)

79 
uı_cÚfig_t
 *
uı_cÚfig
 = 
NULL
;

80 
ucc_¡©us_t
 
ucc_¡©us
;

81 
uı_cÚ‹xt_h
 
uı_cÚ‹xt_£rviû
;

82 
uı_wÜk”_h
 
uı_wÜk”_£rviû
;

83 
ucs_¡©us_t
 
¡©us
;

84 * 
£rviû_´efix
;

86 
ucc_¡©us
 = 
	`ucc_¡r_cÚÿt
(
´efix
, "_SERVICE", &
£rviû_´efix
);

87 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

88 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo concat service…refix str");

89  
ucc_¡©us
;

91 
	`UCP_CHECK
(
	`uı_cÚfig_»ad
(
£rviû_´efix
, 
NULL
, &
uı_cÚfig
),

92 "çedØ»ad uı cÚfigu¿tiÚ", 
”r_cfg_»ad
, 
ùx
);

93 
	`ucc_ä“
(
£rviû_´efix
);

94 
£rviû_´efix
 = 
NULL
;

96 
	`UCP_CHECK
(
	`uı_š™
(&
uı_·¿ms
, 
uı_cÚfig
, &
uı_cÚ‹xt_£rviû
),

97 "çedØš™ uı cÚ‹xˆfÜ s”viû wÜk”", 
”r_cfg
, 
ùx
);

98 
	`uı_cÚfig_»Ëa£
(
uı_cÚfig
);

99 
uı_cÚfig
 = 
NULL
;

101 
	`UCP_CHECK
(
	`uı_wÜk”_ü—‹
(
uı_cÚ‹xt_£rviû
, &
wÜk”_·¿ms
,

102 &
uı_wÜk”_£rviû
),

103 "çedØü—‹ uı s”viû wÜk”", 
”r_wÜk”_ü—‹
, 
ùx
);

105 
ùx
->
£rviû_wÜk”
.
uı_cÚ‹xt
 = 
uı_cÚ‹xt_£rviû
;

106 
ùx
->
£rviû_wÜk”
.
uı_wÜk”
 = 
uı_wÜk”_£rviû
;

107 
ùx
->
£rviû_wÜk”
.
wÜk”_add»ss
 = 
NULL
;

109 
	`CHECK
(
UCC_OK
 !ğ
	`ucc__uı_•s_•hash_š™
(
·¿ms
, 
ùx
,

110 &
ùx
->
£rviû_wÜk”
.
•_hash
,

111 &
ùx
->
£rviû_wÜk”
.
•s
),

113 
”r_th»ad_mode
, 
UCC_ERR_NO_MESSAGE
, 
ùx
);

115 
ùx
->
£rviû_wÜk”_thrÙšg_couÁ
 = 0;

116 
	`CHECK
(
UCC_OK
 !=

117 
	`ucc_cÚ‹xt_´og»ss_»gi¡”
(

118 
·¿ms
->
cÚ‹xt
,

119 (
ucc_cÚ‹xt_´og»ss_â_t
)
ucc__uı_£rviû_wÜk”_´og»ss
,

120 
ùx
),

122 
”r_th»ad_mode
, 
UCC_ERR_NO_MESSAGE
, 
ùx
);

124  
UCC_OK
;

126 
”r_th»ad_mode
:

127 
	`uı_wÜk”_de¡roy
(
uı_wÜk”_£rviû
);

128 
”r_wÜk”_ü—‹
:

129 
	`uı_ş—nup
(
uı_cÚ‹xt_£rviû
);

130 
”r_cfg
:

131 ià(
uı_cÚfig
) {

132 
	`uı_cÚfig_»Ëa£
(
uı_cÚfig
);

134 
”r_cfg_»ad
:

135 ià(
£rviû_´efix
) {

136 
	`ucc_ä“
(
£rviû_´efix
);

138  
ucc_¡©us
;

139 
	}
}

141 
	$UCC_CLASS_INIT_FUNC
(
ucc__uı_cÚ‹xt_t
,

142 cÚ¡ 
ucc_ba£_cÚ‹xt_·¿ms_t
 *
·¿ms
,

143 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

145 
ucc__uı_cÚ‹xt_cÚfig_t
 *
_uı_cÚfig
 =

146 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__uı_cÚ‹xt_cÚfig_t
);

147 
uı_cÚfig_t
 *
uı_cÚfig
 = 
NULL
;

148 
ucc__uı_lib_t
 *
lib
;

149 
ucc_¡©us_t
 
ucc_¡©us
 = 
UCC_OK
;

150 
uı_cÚ‹xt_©Œ_t
 
cÚ‹xt_©Œ
;

151 
uı_wÜk”_·¿ms_t
 
wÜk”_·¿ms
;

152 
uı_wÜk”_©Œ_t
 
wÜk”_©Œ
;

153 
uı_·¿ms_t
 
uı_·¿ms
;

154 
uı_cÚ‹xt_h
 
uı_cÚ‹xt
;

155 
uı_wÜk”_h
 
uı_wÜk”
;

156 
ucs_¡©us_t
 
¡©us
;

157 * 
´efix
;

158 
Ãt_deviûs_¡r
[
MAX_NET_DEVICES_STR_LEN
];

160 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__cÚ‹xt_t
, &
_uı_cÚfig
->
su³r
,

161 
·¿ms
->
cÚ‹xt
);

162 
	`memıy
(&
£lf
->
cfg
, 
_uı_cÚfig
, (*tl_ucp_config));

163 
lib
 = 
	`ucc_d”ived_of
(
£lf
->
su³r
.su³r.lib, 
ucc__uı_lib_t
);

164 
´efix
 = 
	`¡rdup
(
·¿ms
->prefix);

165 ià(!
´efix
) {

166 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo duplicate…refix str");

167  
UCC_ERR_NO_MEMORY
;

169 
´efix
[
	`¡¾’
(prefix) - 1] = '\0';

170 
	`UCP_CHECK
(
	`uı_cÚfig_»ad
(
´efix
, 
NULL
, &
uı_cÚfig
),

171 "çedØ»ad uı cÚfigu¿tiÚ", 
”r_cfg_»ad
, 
£lf
);

172 ià(!
_uı_cÚfig
->
memty³_cİy_’abË
) {

173 
	`UCP_CHECK
(
	`uı_cÚfig_modify
(
uı_cÚfig
, "MEMTYPE_COPY_ENABLE", "no"),

175 
”r_cfg
, 
£lf
);

176 ià(
_uı_cÚfig
->
loÿl_cİy_ty³
 =ğ
UCC_TL_UCP_LOCAL_COPY_TYPE_MC
) {

177 
	`_šfo
(
£lf
->
su³r
.su³r.
lib
, "memtype copy is disabled in UCX, "

180 } ià(
_uı_cÚfig
->
loÿl_cİy_ty³
 =ğ
UCC_TL_UCP_LOCAL_COPY_TYPE_EC
) {

181 
	`_šfo
(
£lf
->
su³r
.su³r.
lib
, "memtype copy is disabled in UCX, "

188 ià(!
	`ucc_cÚfig_Çmes_¬¿y_is_®l
(&
£lf
->
su³r
.su³r.
ucc_cÚ‹xt
->
Ãt_deviûs
)) {

189 
ucc_¡©us
 = 
	`ucc_cÚfig_Çmes_¬¿y_to_¡ršg
(

190 &
£lf
->
su³r
.su³r.
ucc_cÚ‹xt
->
Ãt_deviûs
, 
Ãt_deviûs_¡r
,

191 
MAX_NET_DEVICES_STR_LEN
);

192 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

193 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo convert‚et deviceso string");

194 
”r_cfg
;

196 
	`ucc_´št
("Ãt_deviûs_¡r: %s", 
Ãt_deviûs_¡r
);

197 
	`UCP_CHECK
(
	`uı_cÚfig_modify
(
uı_cÚfig
, "NET_DEVICES", 
Ãt_deviûs_¡r
),

198 "çedØ£ˆÃˆdeviûs", 
”r_cfg
, 
£lf
);

201 
uı_·¿ms
.
f›ld_mask
 =

202 
UCP_PARAM_FIELD_FEATURES
 | 
UCP_PARAM_FIELD_TAG_SENDER_MASK
 | 
UCP_PARAM_FIELD_NAME
;

203 
uı_·¿ms
.
ã©u»s
 =

204 
UCP_FEATURE_TAG
 | 
UCP_FEATURE_AM
 | 
UCP_FEATURE_RMA
 | 
UCP_FEATURE_AMO64
;

205 ià(
£lf
->
cfg
.
expÜ‹d_memÜy_hªdË
) {

206 
uı_·¿ms
.
ã©u»s
 |ğ
UCP_FEATURE_EXPORTED_MEMH
;

208 
uı_·¿ms
.
g_£nd”_mask
 = 
UCC_TL_UCP_TAG_SENDER_MASK
;

209 
uı_·¿ms
.
Çme
 = "UCC_UCP_CONTEXT";

211 ià(
·¿ms
->
e¡im©ed_num_µn
 > 0) {

212 
uı_·¿ms
.
f›ld_mask
 |ğ
UCP_PARAM_FIELD_ESTIMATED_NUM_PPN
;

213 
uı_·¿ms
.
e¡im©ed_num_µn
 = 
·¿ms
->estimated_num_ppn;

216 ià(
·¿ms
->
e¡im©ed_num_•s
 > 0) {

217 
uı_·¿ms
.
f›ld_mask
 |ğ
UCP_PARAM_FIELD_ESTIMATED_NUM_EPS
;

218 
uı_·¿ms
.
e¡im©ed_num_•s
 = 
·¿ms
->estimated_num_eps;

221 
	`UCP_CHECK
(
	`uı_š™
(&
uı_·¿ms
, 
uı_cÚfig
, &
uı_cÚ‹xt
),

222 "çedØš™ uı cÚ‹xt", 
”r_cfg
, 
£lf
);

223 
	`uı_cÚfig_»Ëa£
(
uı_cÚfig
);

224 
uı_cÚfig
 = 
NULL
;

226 
cÚ‹xt_©Œ
.
f›ld_mask
 = 
UCP_ATTR_FIELD_MEMORY_TYPES
;

227 
	`UCP_CHECK
(
	`uı_cÚ‹xt_qu”y
(
uı_cÚ‹xt
, &
cÚ‹xt_©Œ
),

228 "çedØqu”y suµÜ‹d memÜyy³s", 
”r_wÜk”_ü—‹
,

229 
£lf
);

231 
£lf
->
uı_memÜy_ty³s
 = 
cÚ‹xt_©Œ
.
memÜy_ty³s
;

232 
wÜk”_·¿ms
.
f›ld_mask
 = 
UCP_WORKER_PARAM_FIELD_THREAD_MODE
;

233 
·¿ms
->
th»ad_mode
) {

234 
UCC_THREAD_SINGLE
:

235 
UCC_THREAD_FUNNELED
:

236 
wÜk”_·¿ms
.
th»ad_mode
 = 
UCS_THREAD_MODE_SINGLE
;

237 
£lf
->
£nd»cv_cbs
.
ucc__uı_£nd_nb
 = 
ucc__uı_£nd_nb_¡
;

238 
£lf
->
£nd»cv_cbs
.
ucc__uı_»cv_nb
 = 
ucc__uı_»cv_nb_¡
;

239 
£lf
->
£nd»cv_cbs
.
ucc__uı_£nd_nz
 = 
ucc__uı_£nd_nz_¡
;

240 
£lf
->
£nd»cv_cbs
.
ucc__uı_»cv_nz
 = 
ucc__uı_»cv_nz_¡
;

242 
UCC_THREAD_MULTIPLE
:

243 
wÜk”_·¿ms
.
th»ad_mode
 = 
UCS_THREAD_MODE_MULTI
;

244 
£lf
->
£nd»cv_cbs
.
ucc__uı_£nd_nb
 = 
ucc__uı_£nd_nb_mt
;

245 
£lf
->
£nd»cv_cbs
.
ucc__uı_»cv_nb
 = 
ucc__uı_»cv_nb_mt
;

246 
£lf
->
£nd»cv_cbs
.
ucc__uı_£nd_nz
 = 
ucc__uı_£nd_nz_mt
;

247 
£lf
->
£nd»cv_cbs
.
ucc__uı_»cv_nz
 = 
ucc__uı_»cv_nz_mt
;

251 
	`ucc_as£¹
(0);

255 
	`UCP_CHECK
(
	`uı_wÜk”_ü—‹
(
uı_cÚ‹xt
, &
wÜk”_·¿ms
, &
uı_wÜk”
),

256 "çedØü—‹ uı wÜk”", 
”r_wÜk”_ü—‹
, 
£lf
);

258 ià(
·¿ms
->
th»ad_mode
 =ğ
UCC_THREAD_MULTIPLE
) {

259 
wÜk”_©Œ
.
f›ld_mask
 = 
UCP_WORKER_ATTR_FIELD_THREAD_MODE
;

260 
	`uı_wÜk”_qu”y
(
uı_wÜk”
, &
wÜk”_©Œ
);

261 ià(
wÜk”_©Œ
.
th»ad_mode
 !ğ
UCS_THREAD_MODE_MULTI
) {

262 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

264 
ucc_¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

265 
”r_th»ad_mode
;

269 
£lf
->
wÜk”
.
uı_cÚ‹xt
 = ucp_context;

270 
£lf
->
wÜk”
.
uı_wÜk”
 = ucp_worker;

271 
£lf
->
wÜk”
.
wÜk”_add»ss
 = 
NULL
;

273 
£lf
->
tİo_»quœed
 = (((
lib
->
cfg
.
u£_tİo
 =ğ
UCC_TRY
 ||

274 
lib
->
cfg
.
u£_tİo
 =ğ
UCC_AUTO
) &&

275 (
£lf
->
su³r
.su³r.
ucc_cÚ‹xt
->
·¿ms
.
mask
 &

276 
UCC_CONTEXT_PARAM_FIELD_OOB
)) ||

277 
lib
->
cfg
.
u£_tİo
 =ğ
UCC_YES
) ? 1 : 0;

279 
ucc_¡©us
 = 
	`ucc_mpoŞ_š™
(

280 &
£lf
->
»q_mp
, 0,

281 
	`ucc_max
((
ucc__uı_sk_t
), (
ucc__uı_scheduË_t
)), 0,

282 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
, &
ucc_cŞl_sk_mpoŞ_İs
,

283 
·¿ms
->
th»ad_mode
, "tl_ucp_req_mp");

284 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

285 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

287 
”r_th»ad_mode
;

290 
	`CHECK
(
UCC_OK
 !ğ
	`ucc_cÚ‹xt_´og»ss_»gi¡”
(

291 
·¿ms
->
cÚ‹xt
,

292 (
ucc_cÚ‹xt_´og»ss_â_t
)
uı_wÜk”_´og»ss
,

293 
£lf
->
wÜk”
.
uı_wÜk”
),

294 "çedØ»gi¡”…rog»s funùiÚ", 
”r_th»ad_mode
,

295 
UCC_ERR_NO_MESSAGE
, 
£lf
);

297 
£lf
->
»mÙe_šfo
 = 
NULL
;

298 
£lf
->
n_ršfo_£gs
 = 0;

299 
£lf
->
rkeys
 = 
NULL
;

300 ià(
·¿ms
->·¿ms.
mask
 & 
UCC_CONTEXT_PARAM_FIELD_MEM_PARAMS
 &&

301 
·¿ms
->·¿ms.
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
) {

302 
ucc_¡©us
 = 
	`ucc__uı_ùx_»mÙe_pİuÏ‹
(

303 
£lf
, 
·¿ms
->·¿ms.
mem_·¿ms
,…¬ams->·¿ms.
oob
);

304 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

305 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
, "failedo gather RMA information");

306 
”r_th»ad_mode
;

310 
	`CHECK
(
UCC_OK
 !ğ
	`ucc__uı_•s_•hash_š™
(

311 
·¿ms
, 
£lf
, &£lf->
wÜk”
.
•_hash
, &£lf->wÜk”.
•s
),

312 "çedØ®loÿ‹ memÜy fÜƒndpošˆ¡Üage", 
”r_th»ad_mode
,

313 
UCC_ERR_NO_MESSAGE
, 
£lf
);

315 ià(
£lf
->
cfg
.
£rviû_wÜk”
) {

316 
	`CHECK
(
UCC_OK
 !ğ
	`ucc__uı_cÚ‹xt_£rviû_š™
(

317 
´efix
, 
uı_·¿ms
, 
wÜk”_·¿ms
, 
·¿ms
, 
£lf
),

318 "çedØš™ s”viû wÜk”", 
”r_cfg
, 
UCC_ERR_NO_MESSAGE
,

319 
£lf
);

321 
	`ucc_ä“
(
´efix
);

322 
´efix
 = 
NULL
;

324 
£lf
->
cfg
.
loÿl_cİy_ty³
) {

325 
UCC_TL_UCP_LOCAL_COPY_TYPE_MC
:

326 
£lf
->
cİy
.
po¡
 = 
ucc__uı_mc_cİy_po¡
;

327 
£lf
->
cİy
.
‹¡
 = 
ucc__uı_mc_cİy_‹¡
;

328 
£lf
->
cİy
.
fš®ize
 = 
ucc__uı_mc_cİy_fš®ize
;

329 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "using MC for†ocal copy");

331 
UCC_TL_UCP_LOCAL_COPY_TYPE_EC
:

332 
UCC_TL_UCP_LOCAL_COPY_TYPE_AUTO
:

333 
£lf
->
cfg
.
loÿl_cİy_ty³
 = 
UCC_TL_UCP_LOCAL_COPY_TYPE_EC
;

334 
£lf
->
cİy
.
po¡
 = 
ucc__uı_ec_cİy_po¡
;

335 
£lf
->
cİy
.
‹¡
 = 
ucc__uı_ec_cİy_‹¡
;

336 
£lf
->
cİy
.
fš®ize
 = 
ucc__uı_ec_cİy_fš®ize
;

337 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "using EC for†ocal copy");

339 
UCC_TL_UCP_LOCAL_COPY_TYPE_UCP
:

340 
£lf
->
cİy
.
po¡
 = 
ucc__uı_uı_cİy_po¡
;

341 
£lf
->
cİy
.
‹¡
 = 
ucc__uı_uı_cİy_‹¡
;

342 
£lf
->
cİy
.
fš®ize
 = 
ucc__uı_uı_cİy_fš®ize
;

343 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "using UCP for†ocal copy");

346 
£lf
->
cİy
.
po¡
 = 
ucc__uı_ec_cİy_po¡
;

347 
£lf
->
cİy
.
‹¡
 = 
ucc__uı_ec_cİy_‹¡
;

348 
£lf
->
cİy
.
fš®ize
 = 
ucc__uı_ec_cİy_fš®ize
;

349 
	`_”rÜ
(
£lf
->
su³r
.su³r.
lib
,

351 
£lf
->
cfg
.
loÿl_cİy_ty³
);

354 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "initializedl context: %p", self);

355  
UCC_OK
;

357 
”r_th»ad_mode
:

358 
	`uı_wÜk”_de¡roy
(
uı_wÜk”
);

359 
”r_wÜk”_ü—‹
:

360 
	`uı_ş—nup
(
uı_cÚ‹xt
);

361 
”r_cfg
:

362 ià(
uı_cÚfig
) {

363 
	`uı_cÚfig_»Ëa£
(
uı_cÚfig
);

365 
”r_cfg_»ad
:

366 ià(
´efix
) {

367 
	`ucc_ä“
(
´efix
);

369  
ucc_¡©us
;

370 
	}
}

372 
	$ucc__uı_cÚ‹xt_b¬r›r
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

373 
ucc_cÚ‹xt_oob_cŞl_t
 *
oob
)

375 *
rbuf
;

376 
ucc_¡©us_t
 
¡©us
;

377 
sbuf
;

378 *
»q
;

380 ià(
	`ucc_uÆik–y
(
oob
->
n_oob_•s
 < 2)) {

384 
rbuf
 = 
	`ucc_m®loc
((è* 
oob
->
n_oob_•s
, "tmp_barrier");

385 ià(!
rbuf
) {

386 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

388 (è* 
oob
->
n_oob_•s
);

391 ià(
UCC_OK
 =ğ
oob
->
	`®lg©h”
(&
sbuf
, 
rbuf
, (), oob->
cŞl_šfo
,

392 &
»q
)) {

393 
	`ucc_as£¹
(
»q
 !ğ
NULL
);

394 
UCC_OK
 !ğ(
¡©us
 = 
oob
->
	`»q_‹¡
(
»q
))) {

395 
	`uı_wÜk”_´og»ss
(
ùx
->
wÜk”
.
uı_wÜk”
);

396 ià(
ùx
->
cfg
.
£rviû_wÜk”
 != 0) {

397 
	`uı_wÜk”_´og»ss
(
ùx
->
£rviû_wÜk”
.
uı_wÜk”
);

399 ià(
¡©us
 < 0) {

400 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedoest oob„eq");

404 
oob
->
	`»q_ä“
(
»q
);

406 
	`ucc_ä“
(
rbuf
);

407 
	}
}

409 
ucc_¡©us_t
 
	$ucc__uı_ršfo_de¡roy
(
ucc__uı_cÚ‹xt_t
 *
ùx
)

411 
ucc_¿nk_t
 
size
 = 
	`UCC_TL_CTX_OOB
(
ùx
).
n_oob_•s
;

412 
i
, 
j
;

414 
i
 = 0; i < 
size
; i++) {

415 
j
 = 0; j < 
ùx
->
n_ršfo_£gs
; j++) {

416 ià(
	`UCC_TL_UCP_REMOTE_RKEY
(
ùx
, 
i
, 
j
)) {

417 
	`uı_rkey_de¡roy
(
	`UCC_TL_UCP_REMOTE_RKEY
(
ùx
, 
i
, 
j
));

421 
i
 = 0; i < 
ùx
->
n_ršfo_£gs
; i++) {

422 ià(
ùx
->
»mÙe_šfo
[
i
].
mem_h
) {

423 
	`uı_mem_unm­
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, ctx->
»mÙe_šfo
[
i
].
mem_h
);

425 ià(
ùx
->
»mÙe_šfo
[
i
].
·cked_key
) {

426 
	`uı_rkey_bufãr_»Ëa£
(
ùx
->
»mÙe_šfo
[
i
].
·cked_key
);

429 
	`ucc_ä“
(
ùx
->
»mÙe_šfo
);

430 
	`ucc_ä“
(
ùx
->
rkeys
);

431 
ùx
->
»mÙe_šfo
 = 
NULL
;

432 
ùx
->
rkeys
 = 
NULL
;

434  
UCC_OK
;

435 
	}
}

437 
šlše
 
	$ucc__uı_•s_ş—nup
(
ucc__uı_wÜk”_t
 * 
wÜk”
,

438 
ucc__uı_cÚ‹xt_t
 *
ùx
)

440 
	`ucc__uı_şo£_•s
(
wÜk”
, 
ùx
);

441 ià(
wÜk”
->
•s
) {

442 
	`ucc_ä“
(
wÜk”
->
•s
);

444 
	`kh_de¡roy
(
_uı_•_hash
, 
wÜk”
->
•_hash
);

446 
	}
}

448 
šlše
 
	$ucc__uı_wÜk”_ş—nup
(
ucc__uı_wÜk”_t
 
wÜk”
)

450 ià(
wÜk”
.
wÜk”_add»ss
) {

451 
	`uı_wÜk”_»Ëa£_add»ss
(
wÜk”
.
uı_wÜk”
, wÜk”.
wÜk”_add»ss
);

453 
	`uı_wÜk”_de¡roy
(
wÜk”
.
uı_wÜk”
);

454 
	`uı_ş—nup
(
wÜk”
.
uı_cÚ‹xt
);

455 
	}
}

457 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__uı_cÚ‹xt_t
)

459 
	`_debug
(
£lf
->
su³r
.su³r.
lib
, "finalizingl context: %p", self);

460 ià(
£lf
->
»mÙe_šfo
) {

461 
	`ucc__uı_ršfo_de¡roy
(
£lf
);

463 
	`ucc_cÚ‹xt_´og»ss_d”egi¡”
(

464 
£lf
->
su³r
.su³r.
ucc_cÚ‹xt
,

465 (
ucc_cÚ‹xt_´og»ss_â_t
)
uı_wÜk”_´og»ss
,

466 
£lf
->
wÜk”
.
uı_wÜk”
);

467 ià(
£lf
->
cfg
.
£rviû_wÜk”
 != 0) {

468 
	`ucc_cÚ‹xt_´og»ss_d”egi¡”
(

469 
£lf
->
su³r
.su³r.
ucc_cÚ‹xt
,

470 (
ucc_cÚ‹xt_´og»ss_â_t
)
ucc__uı_£rviû_wÜk”_´og»ss
,

471 
£lf
);

473 
	`ucc_mpoŞ_ş—nup
(&
£lf
->
»q_mp
, 1);

474 
	`ucc__uı_•s_ş—nup
(&
£lf
->
wÜk”
, self);

475 ià(
£lf
->
cfg
.
£rviû_wÜk”
 != 0) {

476 
	`ucc__uı_•s_ş—nup
(&
£lf
->
£rviû_wÜk”
, self);

478 ià(
	`UCC_TL_CTX_HAS_OOB
(
£lf
)) {

479 
	`ucc__uı_cÚ‹xt_b¬r›r
(
£lf
, &
	`UCC_TL_CTX_OOB
(self));

481 
	`ucc__uı_wÜk”_ş—nup
(
£lf
->
wÜk”
);

482 ià(
£lf
->
cfg
.
£rviû_wÜk”
 != 0) {

483 
	`ucc__uı_wÜk”_ş—nup
(
£lf
->
£rviû_wÜk”
);

485 
	}
}

487 
UCC_CLASS_DEFINE
(
ucc__uı_cÚ‹xt_t
, 
ucc__cÚ‹xt_t
);

489 
ucc_¡©us_t
 
	$ucc__uı_pİuÏ‹_rÿche
(*
addr
, 
size_t
 
Ëngth
,

490 
ucs_memÜy_ty³_t
 
mem_ty³
,

491 
ucc__uı_cÚ‹xt_t
 *
ùx
)

493 
uı_mem_m­_·¿ms_t
 
mm­_·¿ms
;

494 
uı_mem_h
 
mh
;

495 
ucs_¡©us_t
 
¡©us
;

497 
mm­_·¿ms
.
f›ld_mask
 = 
UCP_MEM_MAP_PARAM_FIELD_ADDRESS
 |

498 
UCP_MEM_MAP_PARAM_FIELD_LENGTH
 |

499 
UCP_MEM_MAP_PARAM_FIELD_MEMORY_TYPE
;

500 
mm­_·¿ms
.
add»ss
 = 
addr
;

501 
mm­_·¿ms
.
Ëngth
 =†ength;

502 
mm­_·¿ms
.
memÜy_ty³
 = 
mem_ty³
;

505 
¡©us
 = 
	`uı_mem_m­
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, &
mm­_·¿ms
, &
mh
);

506 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCS_OK
)) {

507  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

510 
¡©us
 = 
	`uı_mem_unm­
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, 
mh
);

511 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCS_OK
)) {

512  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

515  
UCC_OK
;

516 
	}
}

518 
ucc_¡©us_t
 
	$ucc__uı_ùx_»mÙe_pİuÏ‹
(
ucc__uı_cÚ‹xt_t
 * 
ùx
,

519 
ucc_mem_m­_·¿ms_t
 
m­
,

520 
ucc_cÚ‹xt_oob_cŞl_t
 
oob
)

522 
ušt32_t
 
size
 = 
oob
.
n_oob_•s
;

523 
ušt64_t
 
n£gs
 = 
m­
.
n_£gm’ts
;

524 
uı_mem_m­_·¿ms_t
 
mm­_·¿ms
;

525 
uı_mem_h
 
mh
;

526 
ucs_¡©us_t
 
¡©us
;

527 
ucc_¡©us_t
 
ucc_¡©us
;

528 
i
;

530 ià(
size
 < 2) {

531 
	`_”rÜ
(

532 
ùx
->
su³r
.su³r.
lib
,

534 
size
);

535  
UCC_ERR_INVALID_PARAM
;

537 ià(
n£gs
 > 
MAX_NR_SEGMENTS
) {

538 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "cannot map morehan %d segments",

539 
MAX_NR_SEGMENTS
);

540  
UCC_ERR_INVALID_PARAM
;

542 
ùx
->
rkeys
 =

543 (
uı_rkey_h
 *)
	`ucc_ÿÎoc
((uı_rkey_h), 
n£gs
 * 
size
, "ucp_ctx_rkeys");

544 ià(
NULL
 =ğ
ùx
->
rkeys
) {

545 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo‡llocated %zu bytes",

546 (
uı_rkey_h
è* 
n£gs
 * 
size
);

547  
UCC_ERR_NO_MEMORY
;

549 
ùx
->
»mÙe_šfo
 = (
ucc__uı_»mÙe_šfo_t
 *)
	`ucc_ÿÎoc
(

550 
n£gs
, (
ucc__uı_»mÙe_šfo_t
), "ucp_remote_info");

551 ià(
NULL
 =ğ
ùx
->
»mÙe_šfo
) {

552 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo‡llocated %zu bytes",

553 (
ucc__uı_»mÙe_šfo_t
è* 
n£gs
);

554 
ucc_¡©us
 = 
UCC_ERR_NO_MEMORY
;

555 
ç_®loc_»mÙe_£gs
;

558 
i
 = 0; i < 
n£gs
; i++) {

559 
mm­_·¿ms
.
f›ld_mask
 =

560 
UCP_MEM_MAP_PARAM_FIELD_ADDRESS
 | 
UCP_MEM_MAP_PARAM_FIELD_LENGTH
;

561 
mm­_·¿ms
.
add»ss
 = 
m­
.
£gm’ts
[
i
].address;

562 
mm­_·¿ms
.
Ëngth
 = 
m­
.
£gm’ts
[
i
].
Ën
;

564 
¡©us
 = 
	`uı_mem_m­
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, &
mm­_·¿ms
, &
mh
);

565 ià(
UCS_OK
 !ğ
¡©us
) {

566 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

567 "uı_mem_m­ faed w™hƒ¼Ü code: %d", 
¡©us
);

568 
ucc_¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

569 
ç_mem_m­
;

571 
ùx
->
»mÙe_šfo
[
i
].
mem_h
 = (*)
mh
;

572 
¡©us
 = 
	`uı_rkey_·ck
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, 
mh
,

573 &
ùx
->
»mÙe_šfo
[
i
].
·cked_key
,

574 &
ùx
->
»mÙe_šfo
[
i
].
·cked_key_Ën
);

575 ià(
UCS_OK
 !ğ
¡©us
) {

576 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

577 "çedØ·ck UCP key w™hƒ¼Ü code: %d", 
¡©us
);

578 
ucc_¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

579 
ç_mem_m­
;

581 
ùx
->
»mÙe_šfo
[
i
].
va_ba£
 = 
m­
.
£gm’ts
[i].
add»ss
;

582 
ùx
->
»mÙe_šfo
[
i
].
Ën
 = 
m­
.
£gm’ts
[i].len;

584 
ùx
->
n_ršfo_£gs
 = 
n£gs
;

586  
UCC_OK
;

587 
ç_mem_m­
:

588 
i
 = 0; i < 
n£gs
; i++) {

589 ià(
ùx
->
»mÙe_šfo
[
i
].
mem_h
) {

590 
	`uı_mem_unm­
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, ctx->
»mÙe_šfo
[
i
].
mem_h
);

592 ià(
ùx
->
»mÙe_šfo
[
i
].
·cked_key
) {

593 
	`uı_rkey_bufãr_»Ëa£
(
ùx
->
»mÙe_šfo
[
i
].
·cked_key
);

596 
ç_®loc_»mÙe_£gs
:

597 
	`ucc_ä“
(
ùx
->
»mÙe_šfo
);

598 
	`ucc_ä“
(
ùx
->
rkeys
);

599  
ucc_¡©us
;

600 
	}
}

602 
	$ucc__uı_ùx_»mÙe_·ck_d©a
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

603 *
·ck
)

605 
ušt64_t
 
n£gs
 = 
ùx
->
n_ršfo_£gs
;

606 
ušt64_t
 
off£t
 = 0;

607 
size_t
 
£ùiÚ_off£t
 = (
ušt64_t
è* 
n£gs
;

608 *
keys
;

609 
ušt64_t
 *
rvas
;

610 
ušt64_t
 *
Ëns
;

611 
ušt64_t
 *
key_sizes
;

612 
i
;

616 
rvas
 = 
·ck
;

617 
Ëns
 = 
	`PTR_OFFSET
(
·ck
, 
£ùiÚ_off£t
);

618 
key_sizes
 = 
	`PTR_OFFSET
(
·ck
, (
£ùiÚ_off£t
 * 2));

619 
keys
 = 
	`PTR_OFFSET
(
·ck
, (
£ùiÚ_off£t
 * 3));

621 
i
 = 0; i < 
n£gs
; i++) {

622 
rvas
[
i
] = (
ušt64_t
)
ùx
->
»mÙe_šfo
[i].
va_ba£
;

623 
Ëns
[
i
] = 
ùx
->
»mÙe_šfo
[i].
Ën
;

624 
key_sizes
[
i
] = 
ùx
->
»mÙe_šfo
[i].
·cked_key_Ën
;

625 
	`memıy
(
	`PTR_OFFSET
(
keys
, 
off£t
), 
ùx
->
»mÙe_šfo
[
i
].
·cked_key
,

626 
ùx
->
»mÙe_šfo
[
i
].
·cked_key_Ën
);

627 
off£t
 +ğ
ùx
->
»mÙe_šfo
[
i
].
·cked_key_Ën
;

629 
	}
}

631 
ucc_¡©us_t
 
	$ucc__uı_mem_m­_memhbuf
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

632 *
·ck_bufãr
, 
uı_mem_h
 *
mh
)

634 
uı_mem_m­_·¿ms_t
 
mm­_·¿ms
;

635 
ucs_¡©us_t
 
¡©us
;

636 *
·cked_memh
;

638 *
mh
 = 
NULL
;

640 
·cked_memh
 = 
	`UCC_TL_UCP_MEMH_TL_PACKED_MEMH
(
·ck_bufãr
);

642 
mm­_·¿ms
.
f›ld_mask
 = 
UCP_MEM_MAP_PARAM_FIELD_EXPORTED_MEMH_BUFFER
;

643 
mm­_·¿ms
.
expÜ‹d_memh_bufãr
 = 
·cked_memh
;

645 
¡©us
 = 
	`uı_mem_m­
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, &
mm­_·¿ms
, 
mh
);

646 ià(
UCS_OK
 !ğ
¡©us
) {

647 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

649 
	`ucs_¡©us_¡ršg
(
¡©us
));

650  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

652  
UCC_OK
;

653 
	}
}

655 
ucc_¡©us_t
 
	$ucc__uı_mem_m­_expÜt
(
ucc__uı_cÚ‹xt_t
 *
ùx
, *
add»ss
,

656 
size_t
 
Ën
,

657 
ucc_mem_m­_mode_t
 
mode
,

658 
ucc__uı_memh_d©a_t
 *
m_d©a
)

660 
ucc_¡©us_t
 
ucc_¡©us
 = 
UCC_OK
;

661 
uı_mem_h
 
mh
;

662 
uı_mem_m­_·¿ms_t
 
mm­_·¿ms
;

663 
ucs_¡©us_t
 
¡©us
;

665 ià(
mode
 =ğ
UCC_MEM_MAP_MODE_EXPORT
) {

666 
mm­_·¿ms
.
add»ss
 =‡ddress;

667 
mm­_·¿ms
.
Ëngth
 = 
Ën
;

668 
mm­_·¿ms
.
f›ld_mask
 =

669 
UCP_MEM_MAP_PARAM_FIELD_ADDRESS
 | 
UCP_MEM_MAP_PARAM_FIELD_LENGTH
;

671 
¡©us
 = 
	`uı_mem_m­
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, &
mm­_·¿ms
, &
mh
);

672 ià(
UCS_OK
 !ğ
¡©us
) {

673 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "ucp_mem_map failed withƒrror code: %d",

674 
¡©us
);

675 
ucc_¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

676  
ucc_¡©us
;

678 
m_d©a
->
ršfo
.
mem_h
 = 
mh
;

679 
m_d©a
->
ršfo
.
va_ba£
 = 
add»ss
;

680 
m_d©a
->
ršfo
.
Ën
 =†en;

682  
ucc_¡©us
;

683 
	}
}

685 
ucc_¡©us_t
 
	$ucc__uı_mem_m­_ofæßd_impÜt
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

686 *
add»ss
, 
size_t
 
Ën
,

687 
ucc__uı_memh_d©a_t
 *
m_d©a
,

688 
ucc_mem_m­_memh_t
 *
l_memh
,

689 
ucc_mem_m­__t
 *
_h
)

691 
i
 = 0;

692 
size_t
 
off£t
 = 0;

693 
uı_mem_h
 
mh
;

694 
ucc_¡©us_t
 
ucc_¡©us
;

695 *
Çme
;

696 
size_t
 *
·cked_size
;

698 ; 
i
 < 
l_memh
->
num_s
; i++) {

699 
Çme
 = (*)
	`PTR_OFFSET
(
l_memh
->
·ck_bufãr
, 
off£t
);

700 
·cked_size
 = (
size_t
 *)
	`PTR_OFFSET
(
l_memh
->
·ck_bufãr
,

701 
off£t
 + 
UCC_MEM_MAP_TL_NAME_LEN
);

703 ià(
	`¡ºcmp
(
_h
->
_Çme
, 
Çme
, 
UCC_MEM_MAP_TL_NAME_LEN
 - 1) == 0) {

707 
off£t
 +ğ*
·cked_size
;

709 ià(
i
 =ğ
l_memh
->
num_s
) {

710 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "unableo find TL UCP in memory handle");

711  
UCC_ERR_NOT_FOUND
;

714 
ucc_¡©us
 = 
	`ucc__uı_mem_m­_memhbuf
(

715 
ùx
, 
	`PTR_OFFSET
(
l_memh
->
·ck_bufãr
, 
off£t
), &
mh
);

716 ià(
ucc_¡©us
 !ğ
UCC_OK
) {

717 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "ucp_mem_map failedo map memh");

718  
ucc_¡©us
;

720 
m_d©a
->
ršfo
.
mem_h
 = 
mh
;

721 
m_d©a
->
ršfo
.
va_ba£
 = 
add»ss
;

722 
m_d©a
->
ršfo
.
Ën
 =†en;

724  
UCC_OK
;

725 
	}
}

727 
ucc_¡©us_t
 
	$ucc__uı_mem_m­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

728 
ucc_mem_m­_memh_t
 *
memh
, 
ucc_mem_m­__t
 *
_h
)

730 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`ucc_d”ived_of
(
cÚ‹xt
, ucc_tl_ucp_context_t);

731 
ucc_¡©us_t
 
ucc_¡©us
 = 
UCC_OK
;

732 
ucc__uı_memh_d©a_t
 *
m_d©a
;

734 
m_d©a
 = 
	`ucc_ÿÎoc
(1, (
ucc__uı_memh_d©a_t
), "tl data");

735 ià(!
m_d©a
) {

736 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo‡llocatel data");

737  
UCC_ERR_NO_MEMORY
;

739 
_h
->
_d©a
 = 
m_d©a
;

741 
	`¡ºıy
(
_h
->
_Çme
, "uı", 
UCC_MEM_MAP_TL_NAME_LEN
 - 1);

744 ià(
mode
 =ğ
UCC_MEM_MAP_MODE_EXPORT
) {

745 
ucc_¡©us
 = 
	`ucc__uı_mem_m­_expÜt
(
ùx
, 
memh
->
add»ss
, memh->
Ën
, 
mode
, 
m_d©a
);

746 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

747 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedoƒxport memory handles");

749 } ià(
mode
 =ğ
UCC_MEM_MAP_MODE_IMPORT_OFFLOAD
) {

750 
ucc_¡©us
 = 
	`ucc__uı_mem_m­_ofæßd_impÜt
(
ùx
, 
memh
->
add»ss
, memh->
Ën
,

751 
m_d©a
, 
memh
, 
_h
);

752 ià(
UCC_OK
 !ğ
ucc_¡©us
) {

753 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "failedo import memory handle");

754 
	`ucc_ä“
(
m_d©a
);

755  
ucc_¡©us
;

758  
ucc_¡©us
;

759 
	}
}

761 
ucc_¡©us_t
 
	$ucc__uı_mem_unm­
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

762 
ucc_mem_m­__t
 *
memh
)

764 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`ucc_d”ived_of
(
cÚ‹xt
, ucc_tl_ucp_context_t);

765 
ucc__uı_memh_d©a_t
 *
d©a
;

766 
ucs_¡©us_t
 
¡©us
;

768 ià(!
memh
) {

769  
UCC_OK
;

772 
d©a
 = (
ucc__uı_memh_d©a_t
 *)
memh
->
_d©a
;

773 ià(
mode
 =ğ
UCC_MEM_MAP_MODE_EXPORT
 || mod=ğ
UCC_MEM_MAP_MODE_EXPORT_OFFLOAD
) {

774 
¡©us
 = 
	`uı_mem_unm­
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, 
d©a
->
ršfo
.
mem_h
);

775 ià(
¡©us
 !ğ
UCS_OK
) {

776 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

777 "uı_mem_unm­ faed w™hƒ¼Ü cod%d", 
¡©us
);

778  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

780 } ià(
mode
 =ğ
UCC_MEM_MAP_MODE_IMPORT
 || mod=ğ
UCC_MEM_MAP_MODE_IMPORT_OFFLOAD
) {

782 ià(
d©a
->
·cked_memh
) {

783 
	`uı_memh_bufãr_»Ëa£
(
d©a
->
·cked_memh
, 
NULL
);

785 ià(
d©a
->
ršfo
.
·cked_key
) {

786 
	`uı_rkey_bufãr_»Ëa£
(
d©a
->
ršfo
.
·cked_key
);

788 ià(
d©a
->
rkey
) {

789 
	`uı_rkey_de¡roy
(
d©a
->
rkey
);

792 
	`ucc_”rÜ
("UnknowÀmem m­ mod’‹»d: %d", 
mode
);

793  
UCC_ERR_INVALID_PARAM
;

795  
UCC_OK
;

796 
	}
}

798 
ucc_¡©us_t
 
	$ucc__uı_memh_·ck
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

799 
ucc_mem_m­_mode_t
 
mode
, 
ucc_mem_m­__t
 *
_h
,

800 **
·ck_bufãr
)

802 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`ucc_d”ived_of
(
cÚ‹xt
, ucc_tl_ucp_context_t);

803 
ucc__uı_memh_d©a_t
 *
d©a
 = 
_h
->
_d©a
;

804 
ucc_¡©us_t
 
ucc_¡©us
 = 
UCC_OK
;

805 *
·cked_bufãr
;

806 
size_t
 *
key_size
;

807 
size_t
 *
memh_size
;

808 
uı_memh_·ck_·¿ms_t
 
·ck_·¿ms
;

809 
ucs_¡©us_t
 
¡©us
;

811 ià(!
d©a
 || !d©a->
ršfo
.
mem_h
) {

812 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "unableo…ack memory handle without TL handles");

813  
UCC_ERR_INVALID_PARAM
;

815 ià(
ùx
->
cfg
.
expÜ‹d_memÜy_hªdË
 && 
mode
 =ğ
UCC_MEM_MAP_MODE_EXPORT
) {

816 
·ck_·¿ms
.
f›ld_mask
 = 
UCP_MEMH_PACK_PARAM_FIELD_FLAGS
;

817 
·ck_·¿ms
.
æags
 = 
UCP_MEMH_PACK_FLAG_EXPORT
;

819 
¡©us
 = 
	`uı_memh_·ck
(
d©a
->
ršfo
.
mem_h
, &
·ck_·¿ms
, &d©a->
·cked_memh
,

820 &
d©a
->
·cked_memh_Ën
);

821 ià(
¡©us
 !ğ
UCS_OK
) {

823 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "ucp_memh_pack()„eturnedƒrror %s",

824 
	`ucs_¡©us_¡ršg
(
¡©us
));

825 
d©a
->
·cked_memh
 = 
NULL
;

826 
d©a
->
·cked_memh_Ën
 = 0;

827  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

830 
¡©us
 =

831 
	`uı_rkey_·ck
(
ùx
->
wÜk”
.
uı_cÚ‹xt
, 
d©a
->
ršfo
.
mem_h
,

832 &
d©a
->
ršfo
.
·cked_key
, &d©a->ršfo.
·cked_key_Ën
);

833 ià(
¡©us
 !ğ
UCS_OK
) {

834 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "unableo…ack„key withƒrror %s",

835 
	`ucs_¡©us_¡ršg
(
¡©us
));

836 
ucc_¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

837 
çed_rkey_·ck
;

844 
·cked_bufãr
 = 
	`ucc_m®loc
((
size_t
è* 2 + 
d©a
->
·cked_memh_Ën
 +

845 
d©a
->
ršfo
.
·cked_key_Ën
,

847 ià(!
·cked_bufãr
) {

848 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

850 
d©a
->
·cked_memh_Ën
 + d©a->
ršfo
.
·cked_key_Ën
 + 2 * (
size_t
));

851 
ucc_¡©us
 = 
UCC_ERR_NO_MEMORY
;

852 
çed_®loc_bufãr
;

854 
key_size
 = 
·cked_bufãr
;

855 *
key_size
 = 
d©a
->
ršfo
.
·cked_key_Ën
;

856 
memh_size
 = 
	`PTR_OFFSET
(
·cked_bufãr
, (
size_t
));

857 *
memh_size
 = 
d©a
->
·cked_memh_Ën
;

858 
	`memıy
(
	`PTR_OFFSET
(
·cked_bufãr
, 
UCC_TL_UCP_MEMH_TL_HEADER_SIZE
),

859 
d©a
->
ršfo
.
·cked_key
, *
key_size
);

860 
	`memıy
(
	`PTR_OFFSET
(
·cked_bufãr
,

861 
UCC_TL_UCP_MEMH_TL_HEADER_SIZE
 + 
d©a
->
ršfo
.
·cked_key_Ën
),

862 
d©a
->
·cked_memh
, *
memh_size
);

864 
_h
->
·cked_size
 =

865 
UCC_TL_UCP_MEMH_TL_HEADER_SIZE
 + 
d©a
->
·cked_memh_Ën
 + d©a->
ršfo
.
·cked_key_Ën
;

866 *
·ck_bufãr
 = 
·cked_bufãr
;

867  
ucc_¡©us
;

869 
çed_®loc_bufãr
:

870 
	`uı_rkey_bufãr_»Ëa£
(
d©a
->
ršfo
.
·cked_key
);

871 
çed_rkey_·ck
:

872 ià(
d©a
->
·cked_memh
) {

873 
	`uı_memh_bufãr_»Ëa£
(
d©a
->
·cked_memh
, 
NULL
);

875  
ucc_¡©us
;

876 
	}
}

878 
ucc_¡©us_t
 
	$ucc__uı_g‘_cÚ‹xt_©Œ
(cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *
cÚ‹xt
,

879 
ucc_ba£_ùx_©Œ_t
 *
©Œ
)

881 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`ucc_d”ived_of
(
cÚ‹xt
, ucc_tl_ucp_context_t);

882 
ušt64_t
 * 
off£t
 = (ušt64_ˆ*)
©Œ
->©Œ.
ùx_addr
;

883 
ucs_¡©us_t
 
ucs_¡©us
;

884 
size_t
 
·cked_Ëngth
;

885 
i
;

887 
	`ucc_ba£_ùx_©Œ_ş—r
(
©Œ
);

889 ià(
©Œ
->©Œ.
mask
 & (
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR_LEN
 |

890 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
)) {

891 ià(
NULL
 =ğ
ùx
->
wÜk”
.
wÜk”_add»ss
) {

892 
ucs_¡©us
 = 
	`uı_wÜk”_g‘_add»ss
(
ùx
->
wÜk”
.
uı_wÜk”
,

893 &
ùx
->
wÜk”
.
wÜk”_add»ss
,

894 &
ùx
->
wÜk”
.
uı_add¾’
);

895 ià(
UCS_OK
 !ğ
ucs_¡©us
) {

896 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

898  
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

900 ià(
ùx
->
cfg
.
£rviû_wÜk”
 != 0 &&

901 (
NULL
 =ğ
ùx
->
£rviû_wÜk”
.
wÜk”_add»ss
)) {

902 
ucs_¡©us
 =

903 
	`uı_wÜk”_g‘_add»ss
(
ùx
->
£rviû_wÜk”
.
uı_wÜk”
,

904 &
ùx
->
£rviû_wÜk”
.
wÜk”_add»ss
,

905 &
ùx
->
£rviû_wÜk”
.
uı_add¾’
);

906 ià(
UCS_OK
 !ğ
ucs_¡©us
) {

907 
	`_”rÜ
(

908 
ùx
->
su³r
.su³r.
lib
,

910  
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

916 ià(
©Œ
->©Œ.
mask
 & 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR_LEN
) {

917 
·cked_Ëngth
 = 
TL_UCP_EP_ADDRLEN_SIZE
 + 
ùx
->
wÜk”
.
uı_add¾’
;

918 ià(
ùx
->
cfg
.
£rviû_wÜk”
 != 0) {

919 
·cked_Ëngth
 +=

920 
TL_UCP_EP_ADDRLEN_SIZE
 + 
ùx
->
£rviû_wÜk”
.
uı_add¾’
;

922 ià(
NULL
 !ğ
ùx
->
»mÙe_šfo
) {

923 
·cked_Ëngth
 +ğ
ùx
->
n_ršfo_£gs
 * ((
size_t
) * 3);

924 
i
 = 0; i < 
ùx
->
n_ršfo_£gs
; i++) {

925 
·cked_Ëngth
 +ğ
ùx
->
»mÙe_šfo
[
i
].
·cked_key_Ën
;

928 
©Œ
->©Œ.
ùx_addr_Ën
 = 
·cked_Ëngth
;

931 ià(
©Œ
->©Œ.
mask
 & 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
) {

932 *
off£t
 = 
ùx
->
wÜk”
.
uı_add¾’
;

933 
off£t
 = 
	`TL_UCP_EP_ADDR_WORKER
(offset);

934 
	`memıy
(
off£t
, 
ùx
->
wÜk”
.
wÜk”_add»ss
, ctx->wÜk”.
uı_add¾’
);

935 
off£t
 = 
	`PTR_OFFSET
(off£t, 
ùx
->
wÜk”
.
uı_add¾’
);

936 ià(
ùx
->
cfg
.
£rviû_wÜk”
 != 0) {

937 *
off£t
 = 
ùx
->
£rviû_wÜk”
.
uı_add¾’
;

938 
off£t
 = 
	`TL_UCP_EP_ADDR_WORKER
(offset);

939 
	`memıy
(
off£t
, 
ùx
->
£rviû_wÜk”
.
wÜk”_add»ss
,

940 
ùx
->
£rviû_wÜk”
.
uı_add¾’
);

941 
off£t
 = 
	`PTR_OFFSET
(off£t, 
ùx
->
£rviû_wÜk”
.
uı_add¾’
);

943 ià(
NULL
 !ğ
ùx
->
»mÙe_šfo
) {

944 
	`ucc__uı_ùx_»mÙe_·ck_d©a
(
ùx
, 
off£t
);

948 ià(
©Œ
->©Œ.
mask
 & 
UCC_CONTEXT_ATTR_FIELD_WORK_BUFFER_SIZE
) {

949 
©Œ
->©Œ.
glob®_wÜk_bufãr_size
 =

950 
ONESIDED_SYNC_SIZE
 + 
ONESIDED_REDUCE_SIZE
;

953 
©Œ
->
tİo_»quœed
 = 
ùx
->topo_required;

955  
UCC_OK
;

956 
	}
}

	@src/components/tl/ucp/tl_ucp_copy.c

7 
	~"_uı.h
"

8 
	~"_uı_cŞl.h
"

9 
	~"_uı_g.h
"

10 
	~"_uı_•.h
"

11 
	~"_uı_£nd»cv.h
"

12 
	~"_uı_cİy.h
"

14 
ucc_¡©us_t
 
	$ucc__uı_mc_cİy_po¡
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

15 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

16 
size_t
 
size
,

17 
ucc__uı_sk_t
 *
cŞl_sk
,

18 
ucc__uı_cİy_sk_t
 **
cİy_sk
)

20  
	`ucc_mc_memıy
(
d¡
, 
¤c
, 
size
, 
d¡_mty³
, 
¤c_mty³
);

21 
	}
}

23 
ucc_¡©us_t
 
	$ucc__uı_mc_cİy_‹¡
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

24 
ucc__uı_cİy_sk_t
 *
cİy_sk
)

27  
UCC_OK
;

28 
	}
}

30 
ucc_¡©us_t
 
	$ucc__uı_mc_cİy_fš®ize
(
ucc__uı_cİy_sk_t
 *
cİy_sk
)

32  
UCC_OK
;

33 
	}
}

35 
ucc_¡©us_t
 
	$ucc__uı_ec_cİy_po¡
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

36 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

37 
size_t
 
size
,

38 
ucc__uı_sk_t
 *
cŞl_sk
,

39 
ucc__uı_cİy_sk_t
 **
cİy_sk
)

41 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
 = {0};

42 
ucc_“_executÜ_sk_t
 **
“e_sk
 = (ucc_“_executÜ_sk_ˆ**)
cİy_sk
;

43 
ucc_¡©us_t
 
¡©us
;

44 
ucc_“_executÜ_t
 *
exec
;

46 
¡©us
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
cŞl_sk
->
su³r
, &
exec
);

47 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

48  
¡©us
;

51 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

52 
—rgs
.
cİy
.
d¡
 = dst;

53 
—rgs
.
cİy
.
¤c
 = src;

54 
—rgs
.
cİy
.
Ën
 = 
size
;

56  
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
, 
“e_sk
);

57 
	}
}

59 
ucc_¡©us_t
 
	$ucc__uı_ec_cİy_‹¡
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

60 
ucc__uı_cİy_sk_t
 *
cİy_sk
)

62 
ucc_“_executÜ_sk_t
 *
“e_sk
 = (ucc_“_executÜ_sk_ˆ*)
cİy_sk
;

64  
	`ucc_“_executÜ_sk_‹¡
(
“e_sk
);

65 
	}
}

67 
ucc_¡©us_t
 
	$ucc__uı_ec_cİy_fš®ize
(
ucc__uı_cİy_sk_t
 *
cİy_sk
)

69 
ucc_“_executÜ_sk_t
 *
“e_sk
 = (ucc_“_executÜ_sk_ˆ*)
cİy_sk
;

71  
	`ucc_“_executÜ_sk_fš®ize
(
“e_sk
);

72 
	}
}

74 
	$ucc__uı_cİy_£nd_com¶‘iÚ_cb
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

75 *
u£r_d©a
)

77 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

78 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

79 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in copy send completion %s",

80 
	`ucs_¡©us_¡ršg
(
¡©us
));

82 
	`uı_»que¡_ä“
(
»que¡
);

83 
	}
}

85 
	$ucc__uı_cİy_»cv_com¶‘iÚ_cb
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

86 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

87 *
u£r_d©a
)

89 
ucc__uı_sk_t
 *
sk
 = (ucc__uı_sk_ˆ*)
u£r_d©a
;

90 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

91 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), "failure in copy„ecv completion %s",

92 
	`ucs_¡©us_¡ršg
(
¡©us
));

93 
sk
->
su³r
.
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(status);

96 
	}
}

98 
ucc_¡©us_t
 
	$ucc__uı_uı_cİy_po¡
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

99 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

100 
size_t
 
size
, 
ucc__uı_sk_t
 *
sk
,

101 
ucc__uı_cİy_sk_t
 **
cİy_sk
)

103 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

104 
ucc__uı_‹am_t
 *
‹am
 = 
	`TASK_TEAM
(
sk
);

105 
ucc_¿nk_t
 
Œªk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

106 
ucc_¿nk_t
 
de¡_group_¿nk
 = 
Œªk
;

107 
uı_»que¡_·¿m_t
 
»q_·¿m
;

108 
ucc_¡©us_t
 
¡©us
;

109 
uı_•_h
 
•
;

110 
uı_g_t
 
uı_g
, 
uı_g_mask
;

111 
ucs_¡©us_±r_t
 
uı_¡©us
;

113 
	`UCC_TL_UCP_MAKE_RECV_TAG
(
uı_g
, 
uı_g_mask
,

114 (
¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_TAG
),

115 
sk
->
gged
.
g
, 
Œªk
,

116 
‹am
->
su³r
.su³r.
·¿ms
.
id
,

117 
‹am
->
su³r
.su³r.
·¿ms
.
scİe_id
,

118 
‹am
->
su³r
.su³r.
·¿ms
.
scİe
);

119 
»q_·¿m
.
İ_©Œ_mask
 =

120 
UCP_OP_ATTR_FIELD_CALLBACK
 | 
UCP_OP_ATTR_FIELD_DATATYPE
 |

121 
UCP_OP_ATTR_FIELD_USER_DATA
 | 
UCP_OP_ATTR_FIELD_MEMORY_TYPE
;

122 
»q_·¿m
.
d©©y³
 = 
	`uı_dt_make_cÚtig
(
size
);

123 
»q_·¿m
.
memÜy_ty³
 = 
ucc_memty³_to_ucs
[
d¡_mty³
];

124 
»q_·¿m
.
cb
.
»cv
 = 
ucc__uı_cİy_»cv_com¶‘iÚ_cb
;

125 
»q_·¿m
.
u£r_d©a
 = 
sk
;

126 
uı_¡©us
 = 
	`uı_g_»cv_nbx
(
‹am
->
wÜk”
->
uı_wÜk”
, 
d¡
, 1, 
uı_g
,

127 
uı_g_mask
, &
»q_·¿m
);

128 
	`UCC_TL_UCP_CHECK_REQ_STATUS
();

129 (*
cİy_sk
)ğ
uı_¡©us
;

131 
¡©us
 = 
	`ucc__uı_g‘_•
(
‹am
, 
Œªk
, &
•
);

132 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

133  
¡©us
;

135 
uı_g
 = 
	`UCC_TL_UCP_MAKE_SEND_TAG
((
¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_TAG
),

136 
sk
->
gged
.
g
, 
Œªk
, 
‹am
->
su³r
.su³r.
·¿ms
.
id
,

137 
‹am
->
su³r
.su³r.
·¿ms
.
scİe_id
,—m->su³r.su³r.·¿ms.
scİe
);

138 
»q_·¿m
.
İ_©Œ_mask
 =

139 
UCP_OP_ATTR_FIELD_CALLBACK
 | 
UCP_OP_ATTR_FIELD_DATATYPE
 |

140 
UCP_OP_ATTR_FIELD_USER_DATA
 | 
UCP_OP_ATTR_FIELD_MEMORY_TYPE
;

141 
»q_·¿m
.
d©©y³
 = 
	`uı_dt_make_cÚtig
(
size
);

142 
»q_·¿m
.
memÜy_ty³
 = 
ucc_memty³_to_ucs
[
¤c_mty³
];

143 
»q_·¿m
.
cb
.
£nd
 = 
ucc__uı_cİy_£nd_com¶‘iÚ_cb
;

144 
»q_·¿m
.
u£r_d©a
 = 
sk
;

145 
uı_¡©us
 = 
	`uı_g_£nd_nbx
(
•
, 
¤c
, 1, 
uı_g
, &
»q_·¿m
);

146 
	`UCC_TL_UCP_CHECK_REQ_STATUS
();

148  
UCC_OK
;

149 
	}
}

151 
ucc_¡©us_t
 
	$ucc__uı_uı_cİy_‹¡
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

152 
ucc__uı_cİy_sk_t
 *
cİy_sk
)

154 
ucs_¡©us_±r_t
 
»q_¡©us
 = (ucs_¡©us_±r_t)
cİy_sk
;

156 
	`uı_wÜk”_´og»ss
(
ùx
->
wÜk”
.
uı_wÜk”
);

157  
	`ucs_¡©us_to_ucc_¡©us
(
	`uı_»que¡_check_¡©us
(
»q_¡©us
));

158 
	}
}

160 
ucc_¡©us_t
 
	$ucc__uı_uı_cİy_fš®ize
(
ucc__uı_cİy_sk_t
 *
cİy_sk
)

162 
ucs_¡©us_±r_t
 
»q_¡©us
 = (ucs_¡©us_±r_t)
cİy_sk
;

163 
	`uı_»que¡_ä“
(
»q_¡©us
);

164  
UCC_OK
;

165 
	}
}

	@src/components/tl/ucp/tl_ucp_copy.h

7 
	~"_uı.h
"

8 
	~"_uı_cŞl.h
"

10 
	#COPY_TASK_TEST
(
_pha£
, 
_ùx
, 
_”rmsg
, 
_ùask
) do { \

11 ià(
_ùask
 !ğ
NULL
) { \

12 
¡©us
 = 
_ùx
->
cİy
.
	`‹¡
(
ùx
, 
_ùask
); \

13 ià(
¡©us
 > 0) { \

14 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
; \

15 
	`SAVE_STATE
(
_pha£
); \

18 
_ùx
->
cİy
.
	`fš®ize
(
_ùask
); \

19 
_ùask
 = 
NULL
; \

20 ià(
	`ucc_uÆik–y
(
¡©us
 < 0)) { \

21 
	`_”rÜ
(
	`UCC_TASK_LIB
(
sk
), 
_”rmsg
); \

22 
sk
->
su³r
.
¡©us
 = status; \

26 } 0)

	)

28 
	uucc__uı_cİy_sk
 {

29 
ucc_“_executÜ_sk_t
 
	m“_sk
;

30 
ucs_¡©us_±r_t
 
	muı_sk
;

31 } 
	tucc__uı_cİy_sk_t
;

34 
ucc_¡©us_t
 
ucc__uı_mc_cİy_po¡
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

35 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

36 
size_t
 
size
,

37 
ucc__uı_sk_t
 *
cŞl_sk
,

38 
ucc__uı_cİy_sk_t
 **
cİy_sk
);

40 
ucc_¡©us_t
 
ucc__uı_mc_cİy_‹¡
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

41 
ucc__uı_cİy_sk_t
 *
cİy_sk
);

43 
ucc_¡©us_t
 
ucc__uı_mc_cİy_fš®ize
(
ucc__uı_cİy_sk_t
 *
cİy_sk
);

46 
ucc_¡©us_t
 
ucc__uı_ec_cİy_po¡
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

47 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

48 
size_t
 
size
,

49 
ucc__uı_sk_t
 *
cŞl_sk
,

50 
ucc__uı_cİy_sk_t
 **
cİy_sk
);

52 
ucc_¡©us_t
 
ucc__uı_ec_cİy_‹¡
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

53 
ucc__uı_cİy_sk_t
 *
cİy_sk
);

55 
ucc_¡©us_t
 
ucc__uı_ec_cİy_fš®ize
(
ucc__uı_cİy_sk_t
 *
cİy_sk
);

58 
ucc_¡©us_t
 
ucc__uı_uı_cİy_po¡
(*
d¡
, 
ucc_memÜy_ty³_t
 
d¡_mty³
,

59 *
¤c
, 
ucc_memÜy_ty³_t
 
¤c_mty³
,

60 
size_t
 
size
,

61 
ucc__uı_sk_t
 *
cŞl_sk
,

62 
ucc__uı_cİy_sk_t
 **
cİy_sk
);

64 
ucc_¡©us_t
 
ucc__uı_uı_cİy_‹¡
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

65 
ucc__uı_cİy_sk_t
 *
cİy_sk
);

67 
ucc_¡©us_t
 
ucc__uı_uı_cİy_fš®ize
(
ucc__uı_cİy_sk_t
 *
cİy_sk
);

	@src/components/tl/ucp/tl_ucp_dpu_offload.c

7 
	~"_uı_dpu_ofæßd.h
"

9 
ucc_¡©us_t
 
	$ucc__uı_®Ìeduû_¦idšg_wšdow_»gi¡”
(

10 
uı_cÚ‹xt_h
 
uı_cÚ‹xt
, 
ucc__uı_‹am_t
 *
_‹am
,

11 
ucc__uı_®Ìeduû_sw_expÜt_buf
 *
ebuf
, *
·cked_memh
)

13 
uı_mem_m­_·¿ms_t
 
·¿ms
 = {0};

14 
ucs_¡©us_t
 
ucs_¡©us
, 
unm­_¡©us
;

16 
ebuf
->
uı_cÚ‹xt
 = ucp_context;

18 
·¿ms
.
f›ld_mask
 = 
UCP_MEM_MAP_PARAM_FIELD_EXPORTED_MEMH_BUFFER
;

19 
·¿ms
.
expÜ‹d_memh_bufãr
 = 
·cked_memh
;

21 
ucs_¡©us
 = 
	`uı_mem_m­
(
uı_cÚ‹xt
, &
·¿ms
, &
ebuf
->
memh
);

22 ià(
UCS_OK
 !ğ
ucs_¡©us
) {

23 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

25 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
));

26  
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

29 
ucs_¡©us
 = 
	`uı_rkey_·ck
(
uı_cÚ‹xt
, 
ebuf
->
memh
, &ebuf->
·cked_key
,

30 &
ebuf
->
·cked_key_Ën
);

31 ià(
UCS_OK
 !ğ
ucs_¡©us
) {

32 
unm­_¡©us
 = 
	`uı_mem_unm­
(
uı_cÚ‹xt
, 
ebuf
->
memh
);

33 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
_‹am
),

35 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
),

36 
unm­_¡©us
 =ğ
UCS_OK
 ? "" :

38  
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

41  
UCC_OK
;

42 
	}
}

	@src/components/tl/ucp/tl_ucp_dpu_offload.h

7 #iâdeà
UCC_TL_UCP_DPU_OFFLOAD_H_


8 
	#UCC_TL_UCP_DPU_OFFLOAD_H_


	)

10 
	~"_uı.h
"

11 
	~"scheduË/ucc_scheduË_p–šed.h
"

12 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

13 
	~"compÚ’ts/ec/ucc_ec.h
"

14 
	~"_uı_g.h
"

17 
	#ALLREDUCE_PACKED_KEY_MAX_LEN
 1024

	)

19 
	succ__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo
 {

20 *
	m·cked_¤c_memh
;

21 *
	m·cked_d¡_memh
;

22 } 
	tucc__uı_®Ìeduû_sw_glob®_wÜk_buf_šfo_t
;

24 
	succ__uı_®Ìeduû_sw_expÜt_buf
 {

25 
uı_cÚ‹xt_h
 
	muı_cÚ‹xt
;

26 
uı_mem_h
 
	mmemh
;

27 *
	m·cked_memh
;

28 *
	m·cked_key
;

29 
size_t
 
	m·cked_key_Ën
;

32 
	succ__uı_®Ìeduû_sw_ho¡_®lg©h”
 {

33 *
	m¤c_buf
;

34 *
	md¡_buf
;

35 
	m·cked_¤c_key
[
ALLREDUCE_PACKED_KEY_MAX_LEN
];

36 
	m·cked_d¡_key
[
ALLREDUCE_PACKED_KEY_MAX_LEN
];

37 } 
	tucc__uı_®Ìeduû_sw_ho¡_®lg©h”_t
;

39 
	succ__uı_dpu_ofæßd_buf_šfo
 {

40 
uı_rkey_h
 *
	m¤c_rkeys
;

41 
uı_rkey_h
 *
	md¡_rkeys
;

42 **
	msbufs
;

43 **
	mrbufs
;

44 
ucc__uı_®Ìeduû_sw_expÜt_buf
 *
	m¤c_ebuf
;

45 
ucc__uı_®Ìeduû_sw_expÜt_buf
 *
	md¡_ebuf
;

46 } 
	tucc__uı_dpu_ofæßd_buf_šfo_t
;

48 
ucc_¡©us_t
 
ucc__uı_®Ìeduû_¦idšg_wšdow_»gi¡”
(

49 
uı_cÚ‹xt_h
 
uı_cÚ‹xt
, 
ucc__uı_‹am_t
 *
_‹am
,

50 
ucc__uı_®Ìeduû_sw_expÜt_buf
 *
ebuf
, *
·cked_memh
);

	@src/components/tl/ucp/tl_ucp_ep.c

7 
	~"_uı.h
"

8 
	~"_uı_•.h
"

11 
	$ucc__uı_”r_hªdËr
(*
¬g
, 
uı_•_h
 
•
, 
ucs_¡©us_t
 
¡©us
)

16 
	}
}

18 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_cÚÃù_•
(
ucc__uı_cÚ‹xt_t
 *
ùx
,

19 
is_£rviû
, 
uı_•_h
 *
•
,

20 *
uı_add»ss
)

22 
uı_wÜk”_h
 
wÜk”
 =

23 (
is_£rviû
è? 
ùx
->
£rviû_wÜk”
.
uı_wÜk”
 : ctx->
wÜk”
.ucp_worker;

24 
uı_•_·¿ms_t
 
•_·¿ms
;

25 
ucs_¡©us_t
 
¡©us
;

26 ià(*
•
) {

28  
UCC_OK
;

30 
•_·¿ms
.
f›ld_mask
 = 
UCP_EP_PARAM_FIELD_REMOTE_ADDRESS
;

31 
•_·¿ms
.
add»ss
 = (
uı_add»ss_t
 *)
uı_add»ss
;

33 ià(!
	`UCC_TL_CTX_HAS_OOB
(
ùx
)) {

34 
•_·¿ms
.
”r_mode
 = 
UCP_ERR_HANDLING_MODE_PEER
;

35 
•_·¿ms
.
”r_hªdËr
.
cb
 = 
ucc__uı_”r_hªdËr
;

36 
•_·¿ms
.
”r_hªdËr
.
¬g
 = 
NULL
;

37 
•_·¿ms
.
f›ld_mask
 |ğ
UCP_EP_PARAM_FIELD_ERR_HANDLING_MODE
 |

38 
UCP_EP_PARAM_FIELD_ERR_HANDLER
;

40 
¡©us
 = 
	`uı_•_ü—‹
(
wÜk”
, &
•_·¿ms
, 
•
);

42 ià(
	`ucc_uÆik–y
(
UCS_OK
 !ğ
¡©us
)) {

43 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
, "ucp„eturned connectƒrror: %s",

44 
	`ucs_¡©us_¡ršg
(
¡©us
));

45  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

47  
UCC_OK
;

48 
	}
}

50 
ucc_¡©us_t
 
	$ucc__uı_cÚÃù_‹am_•
(
ucc__uı_‹am_t
 *
‹am
,

51 
ucc_¿nk_t
 
cÜe_¿nk
, 
uı_•_h
 *
•
)

53 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

54 
u£_£rviû_wÜk”
 = 
	`USE_SERVICE_WORKER
(
‹am
);

55 *
addr
;

57 
addr
 = 
	`ucc_g‘_‹am_•_addr
(
	`UCC_TL_CORE_CTX
(
‹am
), 
	`UCC_TL_CORE_TEAM
(team),

58 
cÜe_¿nk
, 
ucc__uı
.
su³r
.su³r.
id
);

59 
addr
 = 
u£_£rviû_wÜk”
 ? 
	`TL_UCP_EP_ADDR_WORKER_SERVICE
(addr)

60 : 
	`TL_UCP_EP_ADDR_WORKER
(
addr
);

62  
	`ucc__uı_cÚÃù_•
(
ùx
, 
u£_£rviû_wÜk”
, 
•
, 
addr
);

63 
	}
}

68 
šlše
 
uı_•_h
 
	$g‘_Ãxt_•_to_şo£
(
ucc__uı_wÜk”_t
 * 
wÜk”
,

69 
ucc__uı_cÚ‹xt_t
 *
ùx
, *
i
)

71 
uı_•_h
 
•
 = 
NULL
;

72 
ucc_¿nk_t
 
size
;

74 ià(
wÜk”
->
•s
) {

75 
size
 = (
ucc_¿nk_t
)
ùx
->
su³r
.su³r.
ucc_cÚ‹xt
->
·¿ms
.
oob
.
n_oob_•s
;

76 
NULL
 =ğ
•
 && (*
i
è< 
size
) {

77 
•
 = 
wÜk”
->
•s
[*
i
];

78 
wÜk”
->
•s
[*
i
] = 
NULL
;

79 (*
i
)++;

82 
•
 = 
	`_uı_hash_pİ
(
wÜk”
->
•_hash
);

84  
•
;

85 
	}
}

87 
	$ucc__uı_şo£_•s
(
ucc__uı_wÜk”_t
 * 
wÜk”
,

88 
ucc__uı_cÚ‹xt_t
 *
ùx
)

90 
i
 = 0;

91 
uı_•_h
 
•
;

92 
ucs_¡©us_t
 
¡©us
;

93 
ucs_¡©us_±r_t
 
şo£_»q
;

94 
uı_»que¡_·¿m_t
 
·¿m
;

96 
·¿m
.
İ_©Œ_mask
 = 
UCP_OP_ATTR_FIELD_FLAGS
;

97 
·¿m
.
æags
 = 0;

98 
•
 = 
	`g‘_Ãxt_•_to_şo£
(
wÜk”
, 
ùx
, &
i
);

99 
•
) {

100 
şo£_»q
 = 
	`uı_•_şo£_nbx
(
•
, &
·¿m
);

102 ià(
	`UCS_PTR_IS_PTR
(
şo£_»q
)) {

104 
	`uı_wÜk”_´og»ss
(
ùx
->
wÜk”
.
uı_wÜk”
);

105 ià(
ùx
->
cfg
.
£rviû_wÜk”
 != 0) {

106 
	`uı_wÜk”_´og»ss
(
ùx
->
£rviû_wÜk”
.
uı_wÜk”
);

108 
¡©us
 = 
	`uı_»que¡_check_¡©us
(
şo£_»q
);

109 } 
¡©us
 =ğ
UCS_INPROGRESS
);

110 
	`uı_»que¡_ä“
(
şo£_»q
);

112 
¡©us
 = 
	`UCS_PTR_STATUS
(
şo£_»q
);

114 
	`ucc_as£¹
(
¡©us
 <ğ
UCS_OK
);

115 ià(
¡©us
 !ğ
UCS_OK
) {

116 
	`_”rÜ
(
ùx
->
su³r
.su³r.
lib
,

118 
•
, 
	`ucs_¡©us_¡ršg
(
¡©us
));

120 
•
 = 
	`g‘_Ãxt_•_to_şo£
(
wÜk”
, 
ùx
, &
i
);

122 
	}
}

	@src/components/tl/ucp/tl_ucp_ep.h

7 
	~"cÚfig.h
"

9 #iâdeà
UCC_TL_UCP_EP_H_


10 
	#UCC_TL_UCP_EP_H_


	)

11 
	~"ucc/­i/ucc.h
"

12 
	~<uı/­i/uı.h
>

13 
	~"_uı.h
"

14 
	~"cÜe/ucc_‹am.h
"

25 
	#TL_UCP_EP_ADDRLEN_SIZE
 8

	)

26 
	#TL_UCP_EP_ADDR_WORKER_LEN
(
_addr
è(*((
ušt64_t
*)(_addr)))

	)

27 
	#TL_UCP_EP_ADDR_WORKER
(
_addr
è
	`PTR_OFFSET
((_addr), 
TL_UCP_EP_ADDRLEN_SIZE
)

	)

28 
	#TL_UCP_EP_OFFSET_WORKER_INFO
(
_addr
) \

29 
	`PTR_OFFSET
((
_addr
), \

30 
TL_UCP_EP_ADDRLEN_SIZE
 + 
	`TL_UCP_EP_ADDR_WORKER_LEN
(
_addr
))

	)

31 
	#TL_UCP_EP_ADDR_WORKER_SERVICE
(
_addr
) \

32 
	`TL_UCP_EP_ADDR_WORKER
(
	`TL_UCP_EP_OFFSET_WORKER_INFO
(
_addr
))

	)

33 
	#TL_UCP_EP_ADDR_ONESIDED_INFO
(
_addr
, 
_ùx
) \

34 
_ùx
->
cfg
.
£rviû_wÜk”
 \

35 ? 
	`TL_UCP_EP_OFFSET_WORKER_INFO
(TL_UCP_EP_OFFSET_WORKER_INFO(
_addr
)) \

36 : 
	`TL_UCP_EP_OFFSET_WORKER_INFO
(
_addr
)

	)

38 
ucc__uı_cÚ‹xt
 
	tucc__uı_cÚ‹xt_t
;

39 
ucc__uı_‹am
 
	tucc__uı_‹am_t
;

41 
ucc_¡©us_t
 
ucc__uı_cÚÃù_‹am_•
(
ucc__uı_‹am_t
 *
‹am
,

42 
ucc_¿nk_t
 
‹am_¿nk
, 
uı_•_h
 *
•
);

44 
ucc__uı_şo£_•s
(
ucc__uı_wÜk”_t
 * 
wÜk”
,

45 
ucc__uı_cÚ‹xt_t
 *
ùx
);

47 
šlše
 
ucc_cÚ‹xt_addr_h—d”_t
 *

48 
	$ucc__uı_g‘_‹am_•_h—d”
(
ucc__uı_‹am_t
 *
‹am
, 
ucc_¿nk_t
 
cÜe_¿nk
)

51  
	`ucc_g‘_‹am_•_h—d”
(
	`UCC_TL_CORE_CTX
(
‹am
), 
	`UCC_TL_CORE_TEAM
(team),

52 
cÜe_¿nk
);

53 
	}
}

55 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_g‘_•
(
ucc__uı_‹am_t
 *
‹am
,

56 
ucc_¿nk_t
 
¿nk
, 
uı_•_h
 *
•
)

58 
ucc_cÚ‹xt_addr_h—d”_t
 *
h
 = 
NULL
;

59 
ucc_¿nk_t
 
ùx_¿nk
 = 0;

60 
ucc_¡©us_t
 
¡©us
;

61 
ucc_¿nk_t
 
cÜe_¿nk
;

62 
cÜe_¿nk
 = 
	`ucc_•_m­_ev®
(
	`UCC_TL_TEAM_MAP
(
‹am
), 
¿nk
);

63 ià(
‹am
->
wÜk”
->
•s
) {

64 
ucc_‹am_t
 *
cÜe_‹am
 = 
	`UCC_TL_CORE_TEAM
(
‹am
);

67 
	`ucc_as£¹
((
NULL
 !ğ
cÜe_‹am
è|| 
	`UCC_TL_IS_SERVICE_TEAM
(
‹am
));

68 
ùx_¿nk
 = 
cÜe_‹am
 ? 
	`ucc_g‘_ùx_¿nk
(cÜe_‹am, 
cÜe_¿nk
)

69 : 
cÜe_¿nk
;

70 *
•
 = 
‹am
->
wÜk”
->
•s
[
ùx_¿nk
];

72 
h
 = 
	`ucc__uı_g‘_‹am_•_h—d”
(
‹am
, 
cÜe_¿nk
);

73 *
•
 = 
	`_uı_hash_g‘
(
‹am
->
wÜk”
->
•_hash
, 
h
->
ùx_id
);

75 ià(
NULL
 =ğ(*
•
)) {

77 
¡©us
 = 
	`ucc__uı_cÚÃù_‹am_•
(
‹am
, 
cÜe_¿nk
, 
•
);

78 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

79 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo connecteamƒp");

80 *
•
 = 
NULL
;

81  
¡©us
;

83 ià(!
h
) {

84 
‹am
->
wÜk”
->
•s
[
ùx_¿nk
] = *
•
;

86 
	`_uı_hash_put
(
‹am
->
wÜk”
->
•_hash
, 
h
->
ùx_id
, *
•
);

89  
UCC_OK
;

90 
	}
}

	@src/components/tl/ucp/tl_ucp_ep_hash.h

7 #iâdeà
UCC_TL_UCP_EP_HASH_H_


8 
	#UCC_TL_UCP_EP_HASH_H_


	)

9 
	~"cÚfig.h
"

10 
	~"cÜe/ucc_cÚ‹xt.h
"

11 
	~"uts/khash.h
"

12 
	~<¡dšt.h
>

14 
šlše
 
ušt32_t
 
	$_uı_ùx_id_hash_â_im¶
(
ušt32_t
 
h
, ušt32_ˆ
k
)

16 
ušt32_t
 
H
 = 
h
 & 0xf8000000;

17 
h
 = h << 5;

18 
h
 = h ^ ( 
H
 >> 27 );

19 
h
 = h ^ 
k
;

20  
h
;

21 
	}
}

24 
šlše
 
khšt32_t
 
	$_uı_ùx_id_hash_â
(
ucc_cÚ‹xt_id_t
 
k
)

26 
ušt32_t
 
h
 = 0;

28 
	`ucc_as£¹
((
k
.
pi
.
ho¡_hash
) == 8);

29 
h
 = 
	`_uı_ùx_id_hash_â_im¶
(h,

30 
	`kh_št64_hash_func
(
k
.
pi
.
ho¡_hash
));

31 
h
 = 
	`_uı_ùx_id_hash_â_im¶
(h, 
k
.
pi
.
pid
);

32 
h
 = 
	`_uı_ùx_id_hash_â_im¶
(h, 
k
.
£q_num
);

33  (
khšt32_t
)
h
;

34 
	}
}

36 
	#_uı_ùx_id_equ®_â
(
_a
, 
_b
) \

37 (((
_a
).
pi
.
ho¡_hash
 =ğ(
_b
).pi.host_hash) && \

38 ((
_a
).
pi
.
pid
 =ğ(
_b
).pi.pidè&& ((_a).
£q_num
 =ğ(_b).£q_num))

	)

40 
KHASH_INIT
(
_uı_•_hash
, 
ucc_cÚ‹xt_id_t
, *, 1, \

41 
_uı_ùx_id_hash_â
, 
_uı_ùx_id_equ®_â
);

43 
	#_uı_•_hash_t
 
	`khash_t
(
_uı_•_hash
)

	)

45 
šlše
 * 
	$_uı_hash_g‘
(
_uı_•_hash_t
 *
h
, 
ucc_cÚ‹xt_id_t
 
key
)

47 
kh™”_t
 
k
;

48 *
v®ue
;

49 
k
 = 
	`kh_g‘
(
_uı_•_hash
, 
h
 , 
key
);

50 ià(
k
 =ğ
	`kh_’d
(
h
)) {

51  
NULL
;

53 
v®ue
 = 
	`kh_v®ue
(
h
, 
k
);

54  
v®ue
;

55 
	}
}

57 
šlše
 
	$_uı_hash_put
(
_uı_•_hash_t
 *
h
, 
ucc_cÚ‹xt_id_t
 
key
,

58 *
v®ue
)

60 
»t
;

61 
kh™”_t
 
k
;

62 
k
 = 
	`kh_put
(
_uı_•_hash
, 
h
, 
key
, &
»t
);

63 
	`kh_v®ue
(
h
, 
k
èğ
v®ue
;

64 
	}
}

66 
šlše
 * 
	$_uı_hash_pİ
(
_uı_•_hash_t
 *
h
)

68 *
•
 = 
NULL
;

69 
kh™”_t
 
k
;

70 
k
 = 
	`kh_begš
(
h
);

71 
k
 !ğ
	`kh_’d
(
h
)) {

72 ià(
	`kh_exi¡
(
h
, 
k
)) {

73 
•
 = 
	`kh_v®ue
(
h
, 
k
);

76 
k
++;

78 ià(
•
) {

79 
	`kh_d–
(
_uı_•_hash
, 
h
, 
k
);

81  
•
;

82 
	}
}

	@src/components/tl/ucp/tl_ucp_lib.c

7 
	~"_uı.h
"

8 
	~"uts/ucc_m®loc.h
"

11 
	$UCC_CLASS_INIT_FUNC
(
ucc__uı_lib_t
, cÚ¡ 
ucc_ba£_lib_·¿ms_t
 *
·¿ms
,

12 cÚ¡ 
ucc_ba£_cÚfig_t
 *
cÚfig
)

14 cÚ¡ 
ucc__uı_lib_cÚfig_t
 *
_uı_cÚfig
 =

15 
	`ucc_d”ived_of
(
cÚfig
, 
ucc__uı_lib_cÚfig_t
);

16 
n_¶ugšs
 =

17 
ucc__uı
.
su³r
.
cŞl_¶ugšs
.
n_compÚ’ts
;

18 
ucc__cŞl_¶ugš_içû_t
 *
ı
;

19 
i
;

20 
ucc_¡©us_t
 
¡©us
;

22 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__lib_t
, &
ucc__uı
.
su³r
,

23 &
_uı_cÚfig
->
su³r
);

24 
¡©us
 = 
	`ucc_cÚfig_şÚe_bË
(
_uı_cÚfig
, &
£lf
->
cfg
,

25 
ucc__uı_lib_cÚfig_bË
);

26 ià(
UCC_OK
 !ğ
¡©us
) {

27  
¡©us
;

30 ià(
_uı_cÚfig
->
kn_¿dix
 > 0) {

31 
£lf
->
cfg
.
b¬r›r_kn_¿dix
 = 
_uı_cÚfig
->
kn_¿dix
;

32 
£lf
->
cfg
.
»duû_sÿ‰”_kn_¿dix
 = 
_uı_cÚfig
->
kn_¿dix
;

33 
£lf
->
cfg
.
bÿ¡_kn_¿dix
 = 
_uı_cÚfig
->
kn_¿dix
;

34 
£lf
->
cfg
.
»duû_kn_¿dix
 = 
_uı_cÚfig
->
kn_¿dix
;

35 
£lf
->
cfg
.
sÿ‰”_kn_¿dix
 = 
_uı_cÚfig
->
kn_¿dix
;

36 
£lf
->
cfg
.
g©h”_kn_¿dix
 = 
_uı_cÚfig
->
kn_¿dix
;

38 
£lf
->
cfg
.
®ÉßÎv_hybrid_¿dix
 = 2;

39 
£lf
->
ı_cÚfigs
 = 
NULL
;

40 ià(
n_¶ugšs
) {

41 
£lf
->
ı_cÚfigs
 = 
	`ucc_m®loc
((*)*
n_¶ugšs
, "tlcp_configs");

42 ià(!
£lf
->
ı_cÚfigs
) {

43 
	`_”rÜ
(&
£lf
->
su³r
, "failedo‡llocate %zd bytes forlcp_configs",

44 (*)*
n_¶ugšs
);

45 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

46 
”r
;

48 
i
 = 0; i < 
n_¶ugšs
; i++) {

49 
ı
 = 
	`ucc_d”ived_of
(
ucc__uı
.
su³r
.
cŞl_¶ugšs
.
compÚ’ts
[
i
],

50 
ucc__cŞl_¶ugš_içû_t
);

51 
ı
->
id
 = 
i
;

52 
£lf
->
ı_cÚfigs
[
i
] = 
	`ucc_m®loc
(
ı
->
cÚfig
.
size
, "tlcp_cfg");

53 ià(!
£lf
->
ı_cÚfigs
[
i
]) {

54 
	`_”rÜ
(&
£lf
->
su³r
, "failedo‡llocate %zd bytes forlcp_cfg",

55 
ı
->
cÚfig
.
size
);

56 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

57 
”r_cfg
;

59 
¡©us
 = 
	`ucc_cÚfig_·r£r_fl_İts
(
£lf
->
ı_cÚfigs
[
i
],

60 &
ı
->
cÚfig
,

61 
·¿ms
->
fuÎ_´efix
, 0);

62 ià(
¡©us
 !ğ
UCC_OK
) {

63 
	`_”rÜ
(&
£lf
->
su³r
, "failedo„eadlcp config");

64 
”r_cfg
;

68 
	`_debug
(&
£lf
->
su³r
, "initialized†ib object: %p", self);

69  
UCC_OK
;

71 
”r_cfg
:

72 
i
--; i >= 0; i--) {

73 
	`ucc_ä“
(
£lf
->
ı_cÚfigs
[
i
]);

75 
”r
:

76  
¡©us
;

77 
	}
}

79 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__uı_lib_t
)

81 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(&
£lf
->
cfg
, 
ucc__uı_lib_cÚfig_bË
);

82 
	`_debug
(&
£lf
->
su³r
, "finalizing†ib object: %p", self);

83 
	}
}

85 
UCC_CLASS_DEFINE
(
ucc__uı_lib_t
, 
ucc__lib_t
);

87 
ucc_¡©us_t
 
	$ucc__uı_g‘_lib_©Œ
(cÚ¡ 
ucc_ba£_lib_t
 *
lib
,

88 
ucc_ba£_lib_©Œ_t
 *
ba£_©Œ
)

90 
ucc__lib_©Œ_t
 *
©Œ
 = 
	`ucc_d”ived_of
(
ba£_©Œ
, ucc_tl_lib_attr_t);

91 
ucs_¡©us_t
 
¡©us
;

92 
uı_lib_©Œ_t
 
·¿ms
;

93 
	`mem£t
(&
·¿ms
, 0, (
uı_lib_©Œ_t
));

94 
·¿ms
.
f›ld_mask
 = 
UCP_LIB_ATTR_FIELD_MAX_THREAD_LEVEL
;

95 
¡©us
 = 
	`uı_lib_qu”y
(&
·¿ms
);

96 ià(
¡©us
 !ğ
UCS_OK
) {

97 
	`ucc_”rÜ
("failedo query UCP†ib‡ttributes");

98  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

100 
·¿ms
.
max_th»ad_Ëv–
)

102 
UCS_THREAD_MODE_SINGLE
:

103 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_SINGLE
;

106 
UCS_THREAD_MODE_SERIALIZED
:

107 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_SINGLE
;

110 
UCS_THREAD_MODE_MULTI
:

111 
©Œ
->
su³r
.©Œ.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

115 
	`ucc_”rÜ
("Unsupported UCShread mode");

116  
UCC_ERR_NO_RESOURCE
;

118 
©Œ
->
su³r
.©Œ.
cŞl_ty³s
 = 
UCC_TL_UCP_SUPPORTED_COLLS
;

119 
©Œ
->
su³r
.
æags
 = 
UCC_BASE_LIB_FLAG_TEAM_ID_REQUIRED
;

120 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MIN_TEAM_SIZE
) {

121 
©Œ
->
su³r
.
mš_‹am_size
 = 
lib
->min_team_size;

124 ià(
ba£_©Œ
->
mask
 & 
UCC_BASE_LIB_ATTR_FIELD_MAX_TEAM_SIZE
) {

125 
©Œ
->
su³r
.
max_‹am_size
 = 
UCC_RANK_MAX
;

128  
UCC_OK
;

129 
	}
}

131 
ucc_¡©us_t
 
	$ucc__uı_g‘_lib_´İ”t›s
(
ucc_ba£_lib_´İ”t›s_t
 *
´İ
)

133 
´İ
->
deçuÉ_‹am_size
 = 2;

134 
´İ
->
mš_‹am_size
 = 2;

135 
´İ
->
max_‹am_size
 = 
UCC_RANK_MAX
;

136  
UCC_OK
;

137 
	}
}

	@src/components/tl/ucp/tl_ucp_reduce.h

7 #iâdeà
UCC_TL_UCP_REDUCE_H_


8 
	#UCC_TL_UCP_REDUCE_H_


	)

9 
	~"_uı_cŞl.h
"

10 
	~"uts/ucc_dt_»duû.h
"

	@src/components/tl/ucp/tl_ucp_sendrecv.h

8 
	~"cÚfig.h
"

10 #iâdeà
UCC_TL_UCP_SENDRECV_H_


11 
	#UCC_TL_UCP_SENDRECV_H_


	)

13 
	~"_uı_g.h
"

14 
	~"_uı_•.h
"

15 
	~"uts/ucc_comp”_def.h
"

16 
	~"compÚ’ts/mc/ba£/ucc_mc_ba£.h
"

18 
ucc__uı_£nd_com¶‘iÚ_cb_¡
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

19 *
u£r_d©a
);

20 
ucc__uı_£nd_com¶‘iÚ_cb_mt
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

21 *
u£r_d©a
);

24 
ucc__uı_put_com¶‘iÚ_cb
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

25 *
u£r_d©a
);

27 
ucc__uı_g‘_com¶‘iÚ_cb
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

28 *
u£r_d©a
);

30 
ucc__uı_»cv_com¶‘iÚ_cb_¡
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

31 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

32 *
u£r_d©a
);

33 
ucc__uı_»cv_com¶‘iÚ_cb_mt
(*
»que¡
, 
ucs_¡©us_t
 
¡©us
,

34 cÚ¡ 
uı_g_»cv_šfo_t
 *
šfo
,

35 *
u£r_d©a
);

37 
	#UCC_TL_UCP_MAKE_TAG
(
_u£r_g
, 
_g
, 
_¿nk
, 
_id
, 
_scİe_id
, 
_scİe
) \

38 ((((
ušt64_t
è(
_u£r_g
)è<< 
UCC_TL_UCP_USER_TAG_BITS_OFFSET
) | \

39 (((
ušt64_t
è(
_g
)è<< 
UCC_TL_UCP_TAG_BITS_OFFSET
) | \

40 (((
ušt64_t
è(
_¿nk
)è<< 
UCC_TL_UCP_SENDER_BITS_OFFSET
) | \

41 (((
ušt64_t
è(
_scİe
)è<< 
UCC_TL_UCP_SCOPE_BITS_OFFSET
) | \

42 (((
ušt64_t
è(
_scİe_id
)è<< 
UCC_TL_UCP_SCOPE_ID_BITS_OFFSET
) | \

43 (((
ušt64_t
è(
_id
)è<< 
UCC_TL_UCP_ID_BITS_OFFSET
))

	)

45 
	#UCC_TL_UCP_MAKE_SEND_TAG
(
_u£r_g
, 
_g
, 
_¿nk
, 
_id
, 
_scİe_id
, 
_scİe
) \

46 
	`UCC_TL_UCP_MAKE_TAG
(
_u£r_g
, 
_g
, 
_¿nk
, 
_id
, 
_scİe_id
, 
_scİe
)

	)

48 
	#UCC_TL_UCP_MAKE_RECV_TAG
(
_uı_g
, 
_uı_g_mask
, 
_u£r_g
, 
_g
, \

49 
_¤c
, 
_id
, 
_scİe_id
, 
_scİe
) \

51 
	`ucc_as£¹
((
_g
è<ğ
UCC_TL_UCP_MAX_TAG
); \

52 
	`ucc_as£¹
((
_¤c
è<ğ
UCC_TL_UCP_MAX_SENDER
); \

53 
	`ucc_as£¹
((
_id
è<ğ
UCC_TL_UCP_MAX_ID
); \

54 (
_uı_g_mask
èğ(
ušt64_t
)(-1); \

55 (
_uı_g
) = \

56 
	`UCC_TL_UCP_MAKE_TAG
((
_u£r_g
), (
_g
), (
_¤c
), (
_id
), \

57 (
_scİe_id
), (
_scİe
)); \

58 } 0)

	)

60 
	#UCC_TL_UCP_CHECK_REQ_STATUS
() \

62 ià(
	`ucc_uÆik–y
(
	`UCS_PTR_IS_ERR
(
uı_¡©us
))) { \

63 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), \

65 
sk
->
gged
.
g
, 
de¡_group_¿nk
, \

66 
‹am
->
su³r
.su³r.
·¿ms
.
id
, \

67 
	`ucs_¡©us_¡ršg
(
	`UCS_PTR_STATUS
(
uı_¡©us
))); \

68 
	`uı_»que¡_ÿnûl
(
‹am
->
wÜk”
->
uı_wÜk”
, 
uı_¡©us
); \

69 
	`uı_»que¡_ä“
(
uı_¡©us
); \

70  
	`ucs_¡©us_to_ucc_¡©us
(
	`UCS_PTR_STATUS
(
uı_¡©us
)); \

72 } 0)

	)

74 
šlše
 
ucs_¡©us_±r_t


75 
	$ucc__uı_£nd_commÚ
(*
bufãr
, 
size_t
 
msgËn
, 
ucc_memÜy_ty³_t
 
mty³
,

76 
ucc_¿nk_t
 
de¡_group_¿nk
, 
ucc__uı_‹am_t
 *
‹am
,

77 
ucc__uı_sk_t
 *
sk
, 
uı_£nd_nbx_ÿÎback_t
 
cb
, *
u£r_d©a
)

79 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

80 
uı_»que¡_·¿m_t
 
»q_·¿m
;

81 
ucc_¡©us_t
 
¡©us
;

82 
uı_•_h
 
•
;

83 
uı_g_t
 
uı_g
;

85 
¡©us
 = 
	`ucc__uı_g‘_•
(
‹am
, 
de¡_group_¿nk
, &
•
);

86 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

87  
	`UCS_STATUS_PTR
(
UCS_ERR_NO_MESSAGE
);

89 
uı_g
 = 
	`UCC_TL_UCP_MAKE_SEND_TAG
((
¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_TAG
),

90 
sk
->
gged
.
g
, 
	`UCC_TL_TEAM_RANK
(
‹am
),—m->
su³r
.su³r.
·¿ms
.
id
,

91 
‹am
->
su³r
.su³r.
·¿ms
.
scİe_id
,—m->su³r.su³r.·¿ms.
scİe
);

92 
»q_·¿m
.
İ_©Œ_mask
 =

93 
UCP_OP_ATTR_FIELD_CALLBACK
 | 
UCP_OP_ATTR_FIELD_DATATYPE
 |

94 
UCP_OP_ATTR_FIELD_USER_DATA
 | 
UCP_OP_ATTR_FIELD_MEMORY_TYPE
;

95 
»q_·¿m
.
d©©y³
 = 
	`uı_dt_make_cÚtig
(
msgËn
);

96 
»q_·¿m
.
cb
.
£nd
 = cb;

97 
»q_·¿m
.
memÜy_ty³
 = 
ucc_memty³_to_ucs
[
mty³
];

98 
»q_·¿m
.
u£r_d©a
 = user_data;

99 
sk
->
gged
.
£nd_po¡ed
++;

100  
	`uı_g_£nd_nbx
(
•
, 
bufãr
, 1, 
uı_g
, &
»q_·¿m
);

101 
	}
}

103 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_£nd_nb_¡
(*
bufãr
, 
size_t
 
msgËn
,

104 
ucc_memÜy_ty³_t
 
mty³
,

105 
ucc_¿nk_t
 
de¡_group_¿nk
,

106 
ucc__uı_‹am_t
 *
‹am
,

107 
ucc__uı_sk_t
 *
sk
)

109 
ucs_¡©us_±r_t
 
uı_¡©us
;

111 
uı_¡©us
 = 
	`ucc__uı_£nd_commÚ
(

112 
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
, 
sk
,

113 
ucc__uı_£nd_com¶‘iÚ_cb_¡
, (*)
sk
);

114 ià(
UCS_OK
 !ğ
uı_¡©us
) {

115 
	`UCC_TL_UCP_CHECK_REQ_STATUS
();

117 ++
sk
->
gged
.
£nd_com¶‘ed
;

119  
UCC_OK
;

120 
	}
}

122 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_£nd_nb_mt
(*
bufãr
, 
size_t
 
msgËn
,

123 
ucc_memÜy_ty³_t
 
mty³
,

124 
ucc_¿nk_t
 
de¡_group_¿nk
,

125 
ucc__uı_‹am_t
 *
‹am
,

126 
ucc__uı_sk_t
 *
sk
)

128 
ucs_¡©us_±r_t
 
uı_¡©us
;

130 
uı_¡©us
 = 
	`ucc__uı_£nd_commÚ
(

131 
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
, 
sk
,

132 
ucc__uı_£nd_com¶‘iÚ_cb_mt
, (*)
sk
);

133 ià(
UCS_OK
 !ğ
uı_¡©us
) {

134 
	`UCC_TL_UCP_CHECK_REQ_STATUS
();

136 
	`ucc_©omic_add32
(&
sk
->
gged
.
£nd_com¶‘ed
, 1);

138  
UCC_OK
;

139 
	}
}

141 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_£nd_nb
(*
bufãr
, 
size_t
 
msgËn
,

142 
ucc_memÜy_ty³_t
 
mty³
,

143 
ucc_¿nk_t
 
de¡_group_¿nk
,

144 
ucc__uı_‹am_t
 *
‹am
,

145 
ucc__uı_sk_t
 *
sk
)

147  
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
£nd»cv_cbs
.
	`ucc__uı_£nd_nb
(

148 
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
, 
sk
);

149 
	}
}

151 
šlše
 
ucc_¡©us_t


152 
	$ucc__uı_£nd_cb
(*
bufãr
, 
size_t
 
msgËn
, 
ucc_memÜy_ty³_t
 
mty³
,

153 
ucc_¿nk_t
 
de¡_group_¿nk
, 
ucc__uı_‹am_t
 *
‹am
,

154 
ucc__uı_sk_t
 *
sk
, 
uı_£nd_nbx_ÿÎback_t
 
cb
, *
u£r_d©a
)

156 
ucs_¡©us_±r_t
 
uı_¡©us
;

158 
uı_¡©us
 = 
	`ucc__uı_£nd_commÚ
(
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
,

159 
‹am
, 
sk
, 
cb
, 
u£r_d©a
);

160 ià(
UCS_OK
 !ğ
uı_¡©us
) {

161 
	`UCC_TL_UCP_CHECK_REQ_STATUS
();

163 
	`cb
(
NULL
, 
UCS_OK
, 
u£r_d©a
);

165  
UCC_OK
;

166 
	}
}

168 
šlše
 
ucs_¡©us_±r_t


169 
	$ucc__uı_»cv_commÚ
(*
bufãr
, 
size_t
 
msgËn
, 
ucc_memÜy_ty³_t
 
mty³
,

170 
ucc_¿nk_t
 
de¡_group_¿nk
, 
ucc__uı_‹am_t
 *
‹am
,

171 
ucc__uı_sk_t
 *
sk
, 
uı_g_»cv_nbx_ÿÎback_t
 
cb
, *
u£r_d©a
)

173 
ucc_cŞl_¬gs_t
 *
¬gs
 = &
	`TASK_ARGS
(
sk
);

174 
uı_»que¡_·¿m_t
 
»q_·¿m
;

175 
uı_g_t
 
uı_g
, 
uı_g_mask
;

178 
	`UCC_TL_UCP_MAKE_RECV_TAG
(
uı_g
, 
uı_g_mask
,

179 (
¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_TAG
),

180 
sk
->
gged
.
g
, 
de¡_group_¿nk
,

181 
‹am
->
su³r
.su³r.
·¿ms
.
id
,

182 
‹am
->
su³r
.su³r.
·¿ms
.
scİe_id
,

183 
‹am
->
su³r
.su³r.
·¿ms
.
scİe
);

184 
»q_·¿m
.
İ_©Œ_mask
 =

185 
UCP_OP_ATTR_FIELD_CALLBACK
 | 
UCP_OP_ATTR_FIELD_DATATYPE
 |

186 
UCP_OP_ATTR_FIELD_USER_DATA
 | 
UCP_OP_ATTR_FIELD_MEMORY_TYPE
;

187 
»q_·¿m
.
d©©y³
 = 
	`uı_dt_make_cÚtig
(
msgËn
);

188 
»q_·¿m
.
cb
.
»cv
 = cb;

189 
»q_·¿m
.
memÜy_ty³
 = 
ucc_memty³_to_ucs
[
mty³
];

190 
»q_·¿m
.
u£r_d©a
 = user_data;

191 
sk
->
gged
.
»cv_po¡ed
++;

192  
	`uı_g_»cv_nbx
(
‹am
->
wÜk”
->
uı_wÜk”
, 
bufãr
, 1, 
uı_g
,

193 
uı_g_mask
, &
»q_·¿m
);

194 
	}
}

196 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_»cv_nb_mt
(*
bufãr
, 
size_t
 
msgËn
,

197 
ucc_memÜy_ty³_t
 
mty³
,

198 
ucc_¿nk_t
 
de¡_group_¿nk
,

199 
ucc__uı_‹am_t
 *
‹am
,

200 
ucc__uı_sk_t
 *
sk
)

202 
ucs_¡©us_±r_t
 
uı_¡©us
;

204 
uı_¡©us
 = 
	`ucc__uı_»cv_commÚ
(

205 
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
, 
sk
,

206 
ucc__uı_»cv_com¶‘iÚ_cb_mt
, (*)
sk
);

207 ià(
UCS_OK
 !ğ
uı_¡©us
) {

208 
	`UCC_TL_UCP_CHECK_REQ_STATUS
();

210 
	`ucc_©omic_add32
(&
sk
->
gged
.
»cv_com¶‘ed
, 1);

212  
UCC_OK
;

213 
	}
}

215 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_»cv_nb_¡
(*
bufãr
, 
size_t
 
msgËn
,

216 
ucc_memÜy_ty³_t
 
mty³
,

217 
ucc_¿nk_t
 
de¡_group_¿nk
,

218 
ucc__uı_‹am_t
 *
‹am
,

219 
ucc__uı_sk_t
 *
sk
)

221 
ucs_¡©us_±r_t
 
uı_¡©us
;

223 
uı_¡©us
 = 
	`ucc__uı_»cv_commÚ
(

224 
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
, 
sk
,

225 
ucc__uı_»cv_com¶‘iÚ_cb_¡
, (*)
sk
);

226 ià(
UCS_OK
 !ğ
uı_¡©us
) {

227 
	`UCC_TL_UCP_CHECK_REQ_STATUS
();

229 ++
sk
->
gged
.
»cv_com¶‘ed
;

231  
UCC_OK
;

232 
	}
}

234 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_»cv_nb
(*
bufãr
, 
size_t
 
msgËn
,

235 
ucc_memÜy_ty³_t
 
mty³
,

236 
ucc_¿nk_t
 
de¡_group_¿nk
,

237 
ucc__uı_‹am_t
 *
‹am
,

238 
ucc__uı_sk_t
 *
sk
)

240  
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
£nd»cv_cbs
.
	`ucc__uı_»cv_nb
(

241 
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
, 
sk
);

242 
	}
}

244 
šlše
 
ucc_¡©us_t


245 
	$ucc__uı_»cv_cb
(*
bufãr
, 
size_t
 
msgËn
, 
ucc_memÜy_ty³_t
 
mty³
,

246 
ucc_¿nk_t
 
de¡_group_¿nk
, 
ucc__uı_‹am_t
 *
‹am
,

247 
ucc__uı_sk_t
 *
sk
, 
uı_g_»cv_nbx_ÿÎback_t
 
cb
,

248 *
u£r_d©a
)

250 
ucs_¡©us_±r_t
 
uı_¡©us
;

252 
uı_¡©us
 = 
	`ucc__uı_»cv_commÚ
(
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
,

253 
‹am
, 
sk
, 
cb
, 
u£r_d©a
);

254 ià(
UCS_OK
 !ğ
uı_¡©us
) {

255 
	`UCC_TL_UCP_CHECK_REQ_STATUS
();

257 
	`cb
(
NULL
, 
UCS_OK
, NULL, 
u£r_d©a
);

259  
UCC_OK
;

260 
	}
}

263 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_»cv_nz_mt
(*
bufãr
, 
size_t
 
msgËn
,

264 
ucc_memÜy_ty³_t
 
mty³
,

265 
ucc_¿nk_t
 
de¡_group_¿nk
,

266 
ucc__uı_‹am_t
 *
‹am
,

267 
ucc__uı_sk_t
 *
sk
)

269 ià(
msgËn
 == 0) {

270 
sk
->
gged
.
»cv_po¡ed
++;

271 
	`ucc_©omic_add32
(&
sk
->
gged
.
»cv_com¶‘ed
, 1);

272  
UCC_OK
;

274  
	`ucc__uı_»cv_nb_mt
(
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
,

275 
sk
);

276 
	}
}

279 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_»cv_nz_¡
(*
bufãr
, 
size_t
 
msgËn
,

280 
ucc_memÜy_ty³_t
 
mty³
,

281 
ucc_¿nk_t
 
de¡_group_¿nk
,

282 
ucc__uı_‹am_t
 *
‹am
,

283 
ucc__uı_sk_t
 *
sk
)

285 ià(
msgËn
 == 0) {

286 
sk
->
gged
.
»cv_po¡ed
++;

287 
sk
->
gged
.
»cv_com¶‘ed
++;

288  
UCC_OK
;

290  
	`ucc__uı_»cv_nb_¡
(
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
,

291 
sk
);

292 
	}
}

295 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_£nd_nz_mt
(*
bufãr
, 
size_t
 
msgËn
,

296 
ucc_memÜy_ty³_t
 
mty³
,

297 
ucc_¿nk_t
 
de¡_group_¿nk
,

298 
ucc__uı_‹am_t
 *
‹am
,

299 
ucc__uı_sk_t
 *
sk
)

301 ià(
msgËn
 == 0) {

302 
sk
->
gged
.
£nd_po¡ed
++;

303 
	`ucc_©omic_add32
(&
sk
->
gged
.
£nd_com¶‘ed
, 1);

304  
UCC_OK
;

306  
	`ucc__uı_£nd_nb_mt
(
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
,

307 
sk
);

308 
	}
}

311 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_£nd_nz_¡
(*
bufãr
, 
size_t
 
msgËn
,

312 
ucc_memÜy_ty³_t
 
mty³
,

313 
ucc_¿nk_t
 
de¡_group_¿nk
,

314 
ucc__uı_‹am_t
 *
‹am
,

315 
ucc__uı_sk_t
 *
sk
)

317 ià(
msgËn
 == 0) {

318 
sk
->
gged
.
£nd_po¡ed
++;

319 
sk
->
gged
.
£nd_com¶‘ed
++;

320  
UCC_OK
;

322  
	`ucc__uı_£nd_nb_¡
(
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
,

323 
sk
);

324 
	}
}

326 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_£nd_nz
(*
bufãr
, 
size_t
 
msgËn
,

327 
ucc_memÜy_ty³_t
 
mty³
,

328 
ucc_¿nk_t
 
de¡_group_¿nk
,

329 
ucc__uı_‹am_t
 *
‹am
,

330 
ucc__uı_sk_t
 *
sk
)

332  
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
£nd»cv_cbs
.
	`ucc__uı_£nd_nz
(

333 
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
, 
sk
);

334 
	}
}

336 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_»cv_nz
(*
bufãr
, 
size_t
 
msgËn
,

337 
ucc_memÜy_ty³_t
 
mty³
,

338 
ucc_¿nk_t
 
de¡_group_¿nk
,

339 
ucc__uı_‹am_t
 *
‹am
,

340 
ucc__uı_sk_t
 *
sk
)

342  
	`UCC_TL_UCP_TEAM_CTX
(
‹am
)->
£nd»cv_cbs
.
	`ucc__uı_»cv_nz
(

343 
bufãr
, 
msgËn
, 
mty³
, 
de¡_group_¿nk
, 
‹am
, 
sk
);

344 
	}
}

346 
šlše
 
ucc_¡©us_t
 
	$fšd__šdex
(
ucc_mem_m­_mem_h
 
m­_memh
, *
_šdex
)

348 
ucc_mem_m­_memh_t
 *
memh
 = (ucc_mem_m­_memh_ˆ*)
m­_memh
;

349 
i
 = 0;

351 ; 
i
 < 
memh
->
num_s
; i++) {

352 ià(
	`¡ºcmp
(
memh
->
_h
[
i
].
_Çme
, "ucp", 3) == 0) {

353 *
_šdex
 = 
i
;

354  
UCC_OK
;

357  
UCC_ERR_NOT_FOUND
;

358 
	}
}

360 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_g‘_memh
(
ucc__uı_‹am_t
 *
‹am
,

361 
ucc_mem_m­_mem_h
 
m­_memh
,

362 **
uı_memh
)

364 
ucc_mem_m­_memh_t
 *
memh
 = 
m­_memh
;

365 
_šdex
 = 0;

366 
ucc__uı_memh_d©a_t
 *
_d©a
;

367 
ucc_¡©us_t
 
¡©us
;

369 
¡©us
 = 
	`fšd__šdex
(
memh
, &
_šdex
);

370 ià(
¡©us
 =ğ
UCC_ERR_NOT_FOUND
) {

371 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
),

374  
¡©us
;

376 
_d©a
 = (
ucc__uı_memh_d©a_t
 *)
memh
->
_h
[
_šdex
].tl_data;

377 *
uı_memh
 = 
_d©a
->
ršfo
.
mem_h
;

378  
UCC_OK
;

379 
	}
}

381 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_check_memh
(
uı_•_h
 *
•
, 
ucc_¿nk_t
 
me
,

382 
ucc_¿nk_t
 
³”
, *
va
,

383 
ušt64_t
 *
rva
, 
uı_rkey_h
 *
rkey
,

384 
_šdex
,

385 
ucc_mem_m­_mem_h
 *
d¡_m­_memh
)

387 
ucc_mem_m­_memh_t
 **
d¡_memh
 = (ucc_mem_m­_memh_ˆ**)
d¡_m­_memh
;

388 
ucc__uı_memh_d©a_t
 *
d¡__d©a
 = 
NULL
;

389 
ušt64_t
 
ba£
;

390 
ušt64_t
 
’d
;

391 
ucs_¡©us_t
 
ucs_¡©us
;

392 
i
;

393 
size_t
 
off£t
;

395 
ba£
 = (
ušt64_t
)
d¡_memh
[
me
]->
add»ss
;

396 
’d
 = 
ba£
 + 
d¡_memh
[
me
]->
Ën
;

398 ià(!((
ušt64_t
)
va
 >ğ
ba£
 && (ušt64_t)v¨< 
’d
)) {

399  
UCC_ERR_NOT_FOUND
;

401 *
rva
 = (
ušt64_t
)
	`PTR_OFFSET
(
d¡_memh
[
³”
]->
add»ss
,

402 ((
ušt64_t
)
va
 - (ušt64_t)
d¡_memh
[
me
]->
add»ss
));

403 
d¡__d©a
 = (
ucc__uı_memh_d©a_t
 *)
d¡_memh
[
³”
]->
_h
[
_šdex
].
_d©a
;

404 ià(
NULL
 =ğ
d¡__d©a
->
rkey
) {

405 
off£t
 = 0;

407 
i
 = 0; i < 
_šdex
; i++) {

408 *
Çme
 = 
	`PTR_OFFSET
(
d¡_memh
[
³”
]->
·ck_bufãr
, 
off£t
);

409 
size_t
 *
·cked_size
 = 
	`PTR_OFFSET
(
d¡_memh
[
³”
]->
·ck_bufãr
, 
off£t


410 + 
UCC_MEM_MAP_TL_NAME_LEN
);

411 ià(
	`¡ºcmp
(
Çme
, "ucp", 3) == 0) {

414 
off£t
 +ğ
UCC_MEM_MAP_TL_NAME_LEN
 + (
size_t
è+ *
·cked_size
;

416 
ucs_¡©us
 = 
	`uı_•_rkey_uÅack
(

417 *
•
, 
	`PTR_OFFSET
(
d¡_memh
[
³”
]->
·ck_bufãr
, 
off£t
 +

418 (
size_t
) *

419 (
UCC_TL_UCP_MEMH_TL_HEADERS
 + 
UCC_TL_UCP_MEMH_TL_PACKED_HEADERS
)),

420 &
d¡__d©a
->
rkey
);

421 ià(
UCS_OK
 !ğ
ucs_¡©us
) {

422  
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

426 *
rkey
 = 
d¡__d©a
->rkey;

427  
UCC_OK
;

428 
	}
}

430 
šlše
 
ucc_¡©us_t


431 
	$ucc__uı_»sŞve_p2p_by_va
(
ucc__uı_‹am_t
 *
‹am
, *
va
, 
uı_•_h
 *
•
,

432 
ucc_¿nk_t
 
³”
, 
ušt64_t
 *
rva
, 
uı_rkey_h
 *
rkey
,

433 *
£gm’t
, 
ucc_mem_m­_mem_h
 *
d¡_memh
)

435 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

436 
ucc_¿nk_t
 
g¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

437 
±rdiff_t
 
key_off£t
 = 0;

438 cÚ¡ 
size_t
 
£ùiÚ_off£t
 = (
ušt64_t
è* 
ùx
->
n_ršfo_£gs
;

439 
_šdex
 = 0;

440 
ucc_¿nk_t
 
cÜe_¿nk
;

441 
ušt64_t
 *
rvas
;

442 
ušt64_t
 *
key_sizes
;

443 *
keys
;

444 *
off£t
;

445 
±rdiff_t
 
ba£_off£t
;

446 
ucc_¡©us_t
 
¡©us
;

448 *
£gm’t
 = -1;

449 
cÜe_¿nk
 = 
	`ucc_•_m­_ev®
(
	`UCC_TL_TEAM_MAP
(
‹am
), 
³”
);

450 
	`ucc_as£¹
(
	`UCC_TL_CORE_TEAM
(
‹am
è!ğ
NULL
);

451 
³”
 = 
	`ucc_g‘_ùx_¿nk
(
	`UCC_TL_CORE_TEAM
(
‹am
), 
cÜe_¿nk
);

453 
off£t
 = 
	`ucc_g‘_‹am_•_addr
(
	`UCC_TL_CORE_CTX
(
‹am
), 
	`UCC_TL_CORE_TEAM
(team),

454 
cÜe_¿nk
, 
ucc__uı
.
su³r
.su³r.
id
);

456 
ba£_off£t
 = (
±rdiff_t
)(
	`TL_UCP_EP_ADDR_ONESIDED_INFO
(
off£t
, 
ùx
));

457 
rvas
 = (
ušt64_t
 *)
ba£_off£t
;

458 
key_sizes
 = 
	`PTR_OFFSET
(
ba£_off£t
, (
£ùiÚ_off£t
 * 2));

459 
keys
 = 
	`PTR_OFFSET
(
ba£_off£t
, (
£ùiÚ_off£t
 * 3));

461 
i
 = 0; i < 
ùx
->
n_ršfo_£gs
; i++) {

462 
ušt64_t
 
ba£
 = (ušt64_t)
‹am
->
va_ba£
[
i
];

463 
ušt64_t
 
’d
 = 
ba£
 + 
‹am
->
ba£_Ëngth
[
i
];

464 ià((
ušt64_t
)
va
 >ğ
ba£
 &&

465 (
ušt64_t
)
va
 < 
’d
) {

466 *
£gm’t
 = 
i
;

469 
key_off£t
 +ğ
key_sizes
[
i
];

471 ià(
	`ucc_uÆik–y
(0 > *
£gm’t
)) {

472 ià(
d¡_memh
) {

474 
¡©us
 = 
	`fšd__šdex
(
d¡_memh
[
g¿nk
], &
_šdex
);

475 ià(
¡©us
 =ğ
UCC_ERR_NOT_FOUND
) {

476 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
),

478  
¡©us
;

481 
¡©us
 = 
	`ucc__uı_check_memh
(
•
, 
g¿nk
, 
³”
, 
va
, 
rva
, 
rkey
, 
_šdex
, 
d¡_memh
);

482 ià(
¡©us
 =ğ
UCC_OK
) {

483  
UCC_OK
;

487 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
),

488 "©‹m±Ø³rfÜm oÃ-sided o³¿tiÚ oÀnÚ-»gi¡”ed memÜy %p", 
va
);

489  
UCC_ERR_NOT_FOUND
;

491 ià(
	`ucc_uÆik–y
(
NULL
 =ğ
	`UCC_TL_UCP_REMOTE_RKEY
(
ùx
, 
³”
, *
£gm’t
))) {

492 
ucs_¡©us_t
 
ucs_¡©us
 =

493 
	`uı_•_rkey_uÅack
(*
•
, 
	`PTR_OFFSET
(
keys
, 
key_off£t
),

494 &
	`UCC_TL_UCP_REMOTE_RKEY
(
ùx
, 
³”
, *
£gm’t
));

495 ià(
UCS_OK
 !ğ
ucs_¡©us
) {

496  
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

499 *
rkey
 = 
	`UCC_TL_UCP_REMOTE_RKEY
(
ùx
, 
³”
, *
£gm’t
);

500 *
rva
 = 
rvas
[*
£gm’t
] + ((
ušt64_t
)
va
 - (ušt64_t)
‹am
->
va_ba£
[*segment]);

501  
UCC_OK
;

502 
	}
}

504 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_æush
(
ucc__uı_‹am_t
 *
‹am
)

506 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

507 
ucs_¡©us_±r_t
 
»q
;

509 
»q
 = 
	`uı_wÜk”_æush_nbx
(
‹am
->
wÜk”
->
uı_wÜk”
, &
»q_·¿m
);

510 ià(
UCS_OK
 !ğ
»q
) {

511 ià(
	`UCS_PTR_IS_ERR
(
»q
)) {

512  
	`ucs_¡©us_to_ucc_¡©us
(
	`UCS_PTR_STATUS
(
»q
));

514 
	`uı_»que¡_ä“
(
»q
);

516  
UCC_OK
;

517 
	}
}

519 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_•_æush
(
ucc_¿nk_t
 
de¡_group_¿nk
,

520 
ucc__uı_‹am_t
 *
‹am
)

522 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

523 
ucc_¡©us_t
 
¡©us
;

524 
ucs_¡©us_±r_t
 
»q
;

525 
uı_•_h
 
•
;

527 
¡©us
 = 
	`ucc__uı_g‘_•
(
‹am
, 
de¡_group_¿nk
, &
•
);

528 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

529  
¡©us
;

532 
»q
 = 
	`uı_•_æush_nbx
(
•
, &
»q_·¿m
);

533 ià(
UCS_OK
 !ğ
»q
) {

534 ià(
	`UCS_PTR_IS_ERR
(
»q
)) {

535  
	`ucs_¡©us_to_ucc_¡©us
(
	`UCS_PTR_STATUS
(
»q
));

537 
	`uı_»que¡_ä“
(
»q
);

539  
UCC_OK
;

540 
	}
}

542 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_put_nb
(*
bufãr
, *
rg‘
,

543 
size_t
 
msgËn
,

544 
ucc_¿nk_t
 
de¡_group_¿nk
,

545 
ucc_mem_m­_mem_h
 
¤c_memh
,

546 
ucc_mem_m­_mem_h
 *
de¡_memh
,

547 
ucc__uı_‹am_t
 *
‹am
,

548 
ucc__uı_sk_t
 *
sk
)

550 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

551 
£gm’t
 = 0;

552 
uı_rkey_h
 
rkey
 = 
NULL
;

553 
ušt64_t
 
rva
 = 0;

554 *
uı_memh
 = 
NULL
;

555 
ucs_¡©us_±r_t
 
uı_¡©us
;

556 
ucc_¡©us_t
 
¡©us
;

557 
uı_•_h
 
•
;

559 
¡©us
 = 
	`ucc__uı_g‘_•
(
‹am
, 
de¡_group_¿nk
, &
•
);

560 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

561  
¡©us
;

564 ià(
¤c_memh
) {

565 
¡©us
 = 
	`ucc__uı_g‘_memh
(
‹am
, 
¤c_memh
, &
uı_memh
);

566 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

567  
¡©us
;

571 
¡©us
 = 
	`ucc__uı_»sŞve_p2p_by_va
(
‹am
, 
rg‘
, &
•
, 
de¡_group_¿nk
,

572 &
rva
, &
rkey
, &
£gm’t
, 
de¡_memh
);

573 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

574  
¡©us
;

577 
»q_·¿m
.
İ_©Œ_mask
 =

578 
UCP_OP_ATTR_FIELD_CALLBACK
 | 
UCP_OP_ATTR_FIELD_USER_DATA
;

579 
»q_·¿m
.
cb
.
£nd
 = 
ucc__uı_put_com¶‘iÚ_cb
;

580 
»q_·¿m
.
u£r_d©a
 = (*)
sk
;

581 ià(
uı_memh
) {

582 
»q_·¿m
.
İ_©Œ_mask
 |ğ
UCP_OP_ATTR_FIELD_MEMH
;

583 
»q_·¿m
.
memh
 = 
uı_memh
;

586 
uı_¡©us
 = 
	`uı_put_nbx
(
•
, 
bufãr
, 
msgËn
, 
rva
, 
rkey
, &
»q_·¿m
);

588 
sk
->
Úesided
.
put_po¡ed
++;

589 ià(
UCS_OK
 !ğ
uı_¡©us
) {

590 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

591  
	`ucs_¡©us_to_ucc_¡©us
(
	`UCS_PTR_STATUS
(
uı_¡©us
));

594 
sk
->
Úesided
.
put_com¶‘ed
++;

596  
UCC_OK
;

597 
	}
}

599 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_g‘_nb
(*
bufãr
, *
rg‘
,

600 
size_t
 
msgËn
,

601 
ucc_¿nk_t
 
de¡_group_¿nk
,

602 
ucc_mem_m­_mem_h
 
¤c_memh
,

603 
ucc_mem_m­_mem_h
 *
de¡_memh
,

604 
ucc__uı_‹am_t
 *
‹am
,

605 
ucc__uı_sk_t
 *
sk
)

607 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

608 
£gm’t
 = 0;

609 
uı_rkey_h
 
rkey
 = 
NULL
;

610 
ušt64_t
 
rva
 = 0;

611 *
uı_memh
 = 
NULL
;

612 
ucs_¡©us_±r_t
 
uı_¡©us
;

613 
ucc_¡©us_t
 
¡©us
;

614 
uı_•_h
 
•
;

616 
¡©us
 = 
	`ucc__uı_g‘_•
(
‹am
, 
de¡_group_¿nk
, &
•
);

617 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

618  
¡©us
;

621 ià(
¤c_memh
) {

622 
¡©us
 = 
	`ucc__uı_g‘_memh
(
‹am
, 
¤c_memh
, &
uı_memh
);

623 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

624  
¡©us
;

628 
¡©us
 = 
	`ucc__uı_»sŞve_p2p_by_va
(
‹am
, 
rg‘
, &
•
, 
de¡_group_¿nk
,

629 &
rva
, &
rkey
, &
£gm’t
, 
de¡_memh
);

630 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

631  
¡©us
;

634 
»q_·¿m
.
İ_©Œ_mask
 =

635 
UCP_OP_ATTR_FIELD_CALLBACK
 | 
UCP_OP_ATTR_FIELD_USER_DATA
;

636 
»q_·¿m
.
cb
.
£nd
 = 
ucc__uı_g‘_com¶‘iÚ_cb
;

637 
»q_·¿m
.
u£r_d©a
 = (*)
sk
;

638 ià(
uı_memh
) {

639 
»q_·¿m
.
İ_©Œ_mask
 |ğ
UCP_OP_ATTR_FIELD_MEMH
;

640 
»q_·¿m
.
memh
 = 
uı_memh
;

643 
uı_¡©us
 = 
	`uı_g‘_nbx
(
•
, 
bufãr
, 
msgËn
, 
rva
, 
rkey
, &
»q_·¿m
);

645 
sk
->
Úesided
.
g‘_po¡ed
++;

646 ià(
UCS_OK
 !ğ
uı_¡©us
) {

647 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

648  
	`ucs_¡©us_to_ucc_¡©us
(
	`UCS_PTR_STATUS
(
uı_¡©us
));

651 
sk
->
Úesided
.
g‘_com¶‘ed
++;

654  
UCC_OK
;

655 
	}
}

657 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_©omic_šc
(* 
rg‘
,

658 
ucc_¿nk_t
 
de¡_group_¿nk
,

659 
ucc_mem_m­_mem_h
 *
de¡_memh
,

660 
ucc__uı_‹am_t
 *
‹am
)

662 
uı_»que¡_·¿m_t
 
»q_·¿m
 = {0};

663 
£gm’t
 = 0;

664 
ušt64_t
 
Úe
 = 1;

665 
uı_rkey_h
 
rkey
 = 
NULL
;

666 
ušt64_t
 
rva
 = 0;

667 
ucs_¡©us_±r_t
 
uı_¡©us
;

668 
ucc_¡©us_t
 
¡©us
;

669 
uı_•_h
 
•
;

671 
¡©us
 = 
	`ucc__uı_g‘_•
(
‹am
, 
de¡_group_¿nk
, &
•
);

672 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

673  
¡©us
;

676 
¡©us
 = 
	`ucc__uı_»sŞve_p2p_by_va
(
‹am
, 
rg‘
, &
•
, 
de¡_group_¿nk
,

677 &
rva
, &
rkey
, &
£gm’t
, 
de¡_memh
);

678 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

679  
¡©us
;

682 
»q_·¿m
.
İ_©Œ_mask
 = 
UCP_OP_ATTR_FIELD_DATATYPE
;

683 
»q_·¿m
.
d©©y³
 = 
	`uı_dt_make_cÚtig
((
ušt64_t
));

685 
uı_¡©us
 = 
	`uı_©omic_İ_nbx
(
•
, 
UCP_ATOMIC_OP_ADD
, &
Úe
, 1, 
rva
, 
rkey
,

686 &
»q_·¿m
);

688 ià(
UCS_OK
 !ğ
uı_¡©us
) {

689 ià(
	`UCS_PTR_IS_ERR
(
uı_¡©us
)) {

690  
	`ucs_¡©us_to_ucc_¡©us
(
	`UCS_PTR_STATUS
(
uı_¡©us
));

692 
	`uı_»que¡_ä“
(
uı_¡©us
);

694  
UCC_OK
;

695 
	}
}

697 
	#UCPCHECK_GOTO
(
_cmd
, 
_sk
, 
_Ïb–
) \

699 
ucc_¡©us_t
 
_¡©us
 = (
_cmd
); \

700 ià(
UCC_OK
 !ğ
_¡©us
) { \

701 
_sk
->
su³r
.
¡©us
 = 
_¡©us
; \

702 
_Ïb–
; \

704 } 0)

	)

	@src/components/tl/ucp/tl_ucp_service_coll.c

7 
	~"_uı.h
"

8 
	~"_uı_cŞl.h
"

9 
	~"_uı_g.h
"

10 
	~"®Ìeduû/®Ìeduû.h
"

11 
	~"®lg©h”/®lg©h”.h
"

12 
	~"bÿ¡/bÿ¡.h
"

15 
ucc_¿nk_t
 
	$ucc__uı_£rviû_ršg_g‘_£nd_block
(
ucc_sub£t_t
 *
sub£t
,

16 
ucc_¿nk_t
 
Œªk
,

17 
ucc_¿nk_t
 
tsize
,

18 
¡•
)

20  (
Œªk
 - 
¡•
 + 
tsize
) %size;

21 
	}
}

24 
ucc_¿nk_t
 
	$ucc__uı_£rviû_ršg_g‘_»cv_block
(
ucc_sub£t_t
 *
sub£t
,

25 
ucc_¿nk_t
 
Œªk
,

26 
ucc_¿nk_t
 
tsize
,

27 
¡•
)

29  (
Œªk
 - 
¡•
 - 1 + 
tsize
) %size;

30 
	}
}

32 
ucc_¡©us_t
 
	$ucc__uı_£rviû_cŞl_¡¬t_executÜ
(
ucc_cŞl_sk_t
 *
sk
)

34 
ucc_“_executÜ_·¿ms_t
 
•¬ams
;

35 
ucc_¡©us_t
 
¡©us
;

37 
•¬ams
.
mask
 = 
UCC_EE_EXECUTOR_PARAM_FIELD_TYPE
;

38 
•¬ams
.
“_ty³
 = 
UCC_EE_CPU_THREAD
;

40 
¡©us
 = 
	`ucc_“_executÜ_š™
(&
•¬ams
, &
sk
->
executÜ
);

41 ià(
¡©us
 !ğ
UCC_OK
) {

42  
¡©us
;

45 
¡©us
 = 
	`ucc_“_executÜ_¡¬t
(
sk
->
executÜ
, 
NULL
);

46 ià(
¡©us
 !ğ
UCC_OK
) {

47 
	`ucc_“_executÜ_fš®ize
(
sk
->
executÜ
);

48  
¡©us
;

51 
sk
->
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR_STOP
;

53  
UCC_OK
;

54 
	}
}

56 
ucc_¡©us_t
 
	$ucc__uı_£rviû_cŞl_¡İ_executÜ
(
ucc_cŞl_sk_t
 *
sk
)

58 
ucc_¡©us_t
 
¡©us
, 
gl_¡©us
;

60 
gl_¡©us
 = 
UCC_OK
;

61 
¡©us
 = 
	`ucc_“_executÜ_¡İ
(
sk
->
executÜ
);

62 ià(
¡©us
 !ğ
UCC_OK
) {

63 
gl_¡©us
 = 
¡©us
;

66 
¡©us
 = 
	`ucc_“_executÜ_fš®ize
(
sk
->
executÜ
);

67 ià(
¡©us
 !ğ
UCC_OK
) {

68 
gl_¡©us
 = 
¡©us
;

71  
gl_¡©us
;

72 
	}
}

74 
ucc_¡©us_t
 
	$ucc__uı_£rviû_®Ìeduû
(
ucc_ba£_‹am_t
 *
‹am
, *
sbuf
,

75 *
rbuf
, 
ucc_d©©y³_t
 
dt
,

76 
size_t
 
couÁ
, 
ucc_»duùiÚ_İ_t
 
İ
,

77 
ucc_sub£t_t
 
sub£t
,

78 
ucc_cŞl_sk_t
 **
sk_p
)

80 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

81 
ucc__uı_sk_t
 *
sk
 = 
	`ucc__uı_g‘_sk
(
_‹am
);

82 
ucc_¡©us_t
 
¡©us
;

84 
ucc_ba£_cŞl_¬gs_t
 
b¬gs
 = {

85 .
¬gs
 = {

86 .
mask
 = 0,

87 .
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLREDUCE
,

88 .
İ
 = op,

89 .
¤c
.
šfo
 = {

90 .
bufãr
 = 
sbuf
,

91 .
couÁ
 = count,

92 .
d©©y³
 = 
dt
,

93 .
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST


95 .
d¡
.
šfo
 = {

96 .
bufãr
 = 
rbuf
,

97 .
couÁ
 = count,

98 .
d©©y³
 = 
dt
,

99 .
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST


104 
¡©us
 = 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, &
b¬gs
, 
‹am
);

105 ià(
¡©us
 !ğ
UCC_OK
) {

106 
ä“_sk
;

108 
sk
->
æags
 = 
UCC_TL_UCP_TASK_FLAG_SUBSET
;

109 
sk
->
sub£t
 = subset;

110 
sk
->
gged
.
g
 = 
UCC_TL_UCP_SERVICE_TAG
;

111 
sk
->
n_pŞls
 = 
	`UCC_TL_UCP_TEAM_CTX
(
_‹am
)->
cfg
.
oob_ÅŞls
;

112 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®Ìeduû_knomŸl_´og»ss
;

113 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_®Ìeduû_knomŸl_fš®ize
;

115 
¡©us
 = 
	`ucc__uı_®Ìeduû_knomŸl_š™_commÚ
(
sk
);

116 ià(
¡©us
 !ğ
UCC_OK
) {

117 
ä“_sk
;

120 
¡©us
 = 
	`ucc__uı_£rviû_cŞl_¡¬t_executÜ
(&
sk
->
su³r
);

121 ià(
¡©us
 !ğ
UCC_OK
) {

122 
ä“_sk
;

125 
¡©us
 = 
	`ucc__uı_®Ìeduû_knomŸl_¡¬t
(&
sk
->
su³r
);

126 ià(
¡©us
 !ğ
UCC_OK
) {

127 
fš®ize_cŞl
;

130 *
sk_p
 = &
sk
->
su³r
;

131  
¡©us
;

133 
fš®ize_cŞl
:

134 
	`ucc__uı_®Ìeduû_knomŸl_fš®ize
(&
sk
->
su³r
);

135 
	`ucc__uı_£rviû_cŞl_¡İ_executÜ
(&
sk
->
su³r
);

136 
ä“_sk
:

137 
	`ucc__uı_put_sk
(
sk
);

138  
¡©us
;

139 
	}
}

141 
ucc_¡©us_t
 
	$ucc__uı_£rviû_®lg©h”
(
ucc_ba£_‹am_t
 *
‹am
, *
sbuf
,

142 *
rbuf
, 
size_t
 
msgsize
,

143 
ucc_sub£t_t
 
sub£t
,

144 
ucc_cŞl_sk_t
 **
sk_p
)

146 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

147 
ucc__uı_sk_t
 *
sk
 = 
	`ucc__uı_g‘_sk
(
_‹am
);

148 
ušt32_t
 
ÅŞls
 =

149 
	`UCC_TL_UCP_TEAM_CTX
(
_‹am
)->
cfg
.
oob_ÅŞls
;

150 
š_¶aû
 =

151 
sbuf
 =ğ
	`PTR_OFFSET
(
rbuf
, 
msgsize
 * 
sub£t
.
my¿nk
);

152 
ucc_ba£_cŞl_¬gs_t
 
b¬gs
 = {

153 .
¬gs
 = {

154 .
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLGATHER
,

155 .
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
,

156 .
æags
 = 
š_¶aû
 ? 
UCC_COLL_ARGS_FLAG_IN_PLACE
 : 0,

157 .
¤c
.
šfo
 = {.
bufãr
 = 
sbuf
,

158 .
couÁ
 = 
msgsize
,

159 .
d©©y³
 = 
UCC_DT_UINT8
,

160 .
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
},

161 .
d¡
.
šfo
 = {.
bufãr
 = 
rbuf
,

162 .
couÁ
 = 
msgsize
 * 
sub£t
.
m­
.
•_num
,

163 .
d©©y³
 = 
UCC_DT_UINT8
,

164 .
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
}

167 
ucc_¡©us_t
 
¡©us
;

169 
¡©us
 = 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, &
b¬gs
, 
‹am
);

170 ià(
¡©us
 !ğ
UCC_OK
) {

171 
ä“_sk
;

173 
sk
->
®lg©h”_ršg
.
g‘_£nd_block
 = 
ucc__uı_£rviû_ršg_g‘_£nd_block
;

174 
sk
->
®lg©h”_ršg
.
g‘_»cv_block
 = 
ucc__uı_£rviû_ršg_g‘_»cv_block
;

175 
sk
->
æags
 = 
UCC_TL_UCP_TASK_FLAG_SUBSET
;

176 
sk
->
sub£t
 = subset;

177 
sk
->
gged
.
g
 = 
UCC_TL_UCP_SERVICE_TAG
;

178 
sk
->
n_pŞls
 = 
ÅŞls
;

179 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_®lg©h”_ršg_´og»ss
;

180 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_cŞl_fš®ize
;

182 
¡©us
 = 
	`ucc__uı_®lg©h”_ršg_¡¬t
(&
sk
->
su³r
);

183 ià(
¡©us
 !ğ
UCC_OK
) {

184 
fš®ize_cŞl
;

187 *
sk_p
 = &
sk
->
su³r
;

188  
¡©us
;

189 
fš®ize_cŞl
:

190 
	`ucc__uı_cŞl_fš®ize
(*
sk_p
);

191 
ä“_sk
:

192 
	`ucc__uı_put_sk
(
sk
);

193  
¡©us
;

194 
	}
}

196 
ucc_¡©us_t
 
	$ucc__uı_£rviû_bÿ¡
(
ucc_ba£_‹am_t
 *
‹am
, *
buf
,

197 
size_t
 
msgsize
, 
ucc_¿nk_t
 
roÙ
,

198 
ucc_sub£t_t
 
sub£t
,

199 
ucc_cŞl_sk_t
 **
sk_p
)

201 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

202 
ucc__uı_sk_t
 *
sk
 = 
	`ucc__uı_g‘_sk
(
_‹am
);

203 
ucc_ba£_cŞl_¬gs_t
 
b¬gs
 = {

204 .
¬gs
 = {

205 .
cŞl_ty³
 = 
UCC_COLL_TYPE_BCAST
,

206 .
¤c
.
šfo
 = {

207 .
bufãr
 = 
buf
,

208 .
couÁ
 = 
msgsize
,

209 .
d©©y³
 = 
UCC_DT_INT8
,

210 .
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST


212 .
roÙ
 =„oot

215 
ucc_¡©us_t
 
¡©us
;

217 
¡©us
 = 
	`ucc_cŞl_sk_š™
(&
sk
->
su³r
, &
b¬gs
, 
‹am
);

218 ià(
¡©us
 !ğ
UCC_OK
) {

219 
ä“_sk
;

221 
sk
->
æags
 = 
UCC_TL_UCP_TASK_FLAG_SUBSET
;

222 
sk
->
sub£t
 = subset;

223 
sk
->
gged
.
g
 = 
UCC_TL_UCP_SERVICE_TAG
;

224 
sk
->
n_pŞls
 = 
	`UCC_TL_UCP_TEAM_CTX
(
_‹am
)->
cfg
.
oob_ÅŞls
;

225 
sk
->
su³r
.
´og»ss
 = 
ucc__uı_bÿ¡_knomŸl_´og»ss
;

226 
sk
->
su³r
.
fš®ize
 = 
ucc__uı_cŞl_fš®ize
;

227 
sk
->
bÿ¡_kn
.
¿dix
 = 2;

228 
¡©us
 = 
	`ucc__uı_bÿ¡_knomŸl_¡¬t
(&
sk
->
su³r
);

229 ià(
¡©us
 !ğ
UCC_OK
) {

230 
fš®ize_cŞl
;

233 *
sk_p
 = &
sk
->
su³r
;

234  
¡©us
;

235 
fš®ize_cŞl
:

236 
	`ucc__uı_cŞl_fš®ize
(*
sk_p
);

237 
ä“_sk
:

238 
	`ucc__uı_put_sk
(
sk
);

239  
¡©us
;

240 
	}
}

242 
	$ucc__uı_£rviû_upd©e_id
(
ucc_ba£_‹am_t
 *
‹am
, 
ušt16_t
 
id
) {

243 
ucc__uı_‹am_t
 *
_‹am
 = 
	`ucc_d”ived_of
(
‹am
, ucc_tl_ucp_team_t);

245 
_‹am
->
su³r
.su³r.
·¿ms
.
id
 = id;

246 
	}
}

	@src/components/tl/ucp/tl_ucp_tag.h

7 #iâdeà
UCC_TL_UCP_TAG_H_


8 
	#UCC_TL_UCP_TAG_H_


	)

9 
	~"uts/ucc_comp”_def.h
"

19 
	#UCC_TL_UCP_RESERVED_BITS
 2

	)

20 
	#UCC_TL_UCP_SCOPE_BITS
 3

	)

21 
	#UCC_TL_UCP_SCOPE_ID_BITS
 3

	)

22 
	#UCC_TL_UCP_USER_TAG_BITS
 1

	)

23 
	#UCC_TL_UCP_TAG_BITS
 15

	)

24 
	#UCC_TL_UCP_SENDER_BITS
 24

	)

25 
	#UCC_TL_UCP_ID_BITS
 16

	)

27 
	#UCC_TL_UCP_RESERVED_BITS_OFFSET
 \

28 (
UCC_TL_UCP_ID_BITS
 + 
UCC_TL_UCP_SENDER_BITS
 + 
UCC_TL_UCP_SCOPE_ID_BITS
 + \

29 
UCC_TL_UCP_SCOPE_BITS
 + 
UCC_TL_UCP_TAG_BITS
 + 
UCC_TL_UCP_USER_TAG_BITS
)

	)

31 
	#UCC_TL_UCP_USER_TAG_BITS_OFFSET
 \

32 (
UCC_TL_UCP_ID_BITS
 + 
UCC_TL_UCP_SENDER_BITS
 + 
UCC_TL_UCP_SCOPE_ID_BITS
 + \

33 
UCC_TL_UCP_SCOPE_BITS
 + 
UCC_TL_UCP_TAG_BITS
)

	)

35 
	#UCC_TL_UCP_TAG_BITS_OFFSET
 \

36 (
UCC_TL_UCP_ID_BITS
 + 
UCC_TL_UCP_SENDER_BITS
 + 
UCC_TL_UCP_SCOPE_ID_BITS
 + \

37 
UCC_TL_UCP_SCOPE_BITS
)

	)

39 
	#UCC_TL_UCP_SCOPE_BITS_OFFSET
 \

40 (
UCC_TL_UCP_ID_BITS
 + 
UCC_TL_UCP_SENDER_BITS
 + 
UCC_TL_UCP_SCOPE_ID_BITS
)

	)

42 
	#UCC_TL_UCP_SCOPE_ID_BITS_OFFSET
 (
UCC_TL_UCP_ID_BITS
 + 
UCC_TL_UCP_SENDER_BITS
)

	)

43 
	#UCC_TL_UCP_SENDER_BITS_OFFSET
 (
UCC_TL_UCP_ID_BITS
)

	)

44 
	#UCC_TL_UCP_ID_BITS_OFFSET
 0

	)

46 
	#UCC_TL_UCP_MAX_TAG
 
	`UCC_MASK
(
UCC_TL_UCP_TAG_BITS
)

	)

47 
	#UCC_TL_UCP_RESERVED_TAGS
 8

	)

48 
	#UCC_TL_UCP_MAX_COLL_TAG
 (
UCC_TL_UCP_MAX_TAG
 - 
UCC_TL_UCP_RESERVED_TAGS
)

	)

49 
	#UCC_TL_UCP_SERVICE_TAG
 (
UCC_TL_UCP_MAX_COLL_TAG
 + 1)

	)

50 
	#UCC_TL_UCP_ACTIVE_SET_TAG
 (
UCC_TL_UCP_MAX_COLL_TAG
 + 2)

	)

51 
	#UCC_TL_UCP_MAX_SENDER
 
	`UCC_MASK
(
UCC_TL_UCP_SENDER_BITS
)

	)

52 
	#UCC_TL_UCP_MAX_ID
 
	`UCC_MASK
(
UCC_TL_UCP_ID_BITS
)

	)

54 
	#UCC_TL_UCP_TAG_SENDER_MASK
 \

55 
	`UCC_MASK
(
UCC_TL_UCP_ID_BITS
 + 
UCC_TL_UCP_SENDER_BITS
 + \

56 
UCC_TL_UCP_SCOPE_ID_BITS
 + 
UCC_TL_UCP_SCOPE_BITS
)

	)

58 
	#UCC_TL_UCP_GET_SENDER
(
_g
è((
ušt32_t
)(((_gè>> 
UCC_TL_UCP_SENDER_BITS_OFFSET
) & \

59 
	`UCC_MASK
(
UCC_TL_UCP_SENDER_BITS
)))

	)

	@src/components/tl/ucp/tl_ucp_team.c

7 
	~"_uı.h
"

8 
	~"_uı_•.h
"

9 
	~"_uı_cŞl.h
"

10 
	~"_uı_£nd»cv.h
"

11 
	~"uts/ucc_m®loc.h
"

12 
	~"uts/ucc_·r£r.h
"

13 
	~"uts/ucc_¡ršg.h
"

14 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

16 
šlše
 
ucc_¡©us_t
 
	$ucc__uı_g‘_tİo
(
ucc__uı_‹am_t
 *
‹am
)

18 
ucc_sub£t_t
 
sub£t
;

19 
ucc_¡©us_t
 
¡©us
;

21 
¡©us
 = 
	`ucc_•_m­_ü—‹_Ã¡ed
(&
	`UCC_TL_CORE_TEAM
(
‹am
)->
ùx_m­
,

22 &
	`UCC_TL_TEAM_MAP
(
‹am
),

23 &
‹am
->
ùx_m­
);

24 ià(
UCC_OK
 !ğ
¡©us
) {

25 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo create ctx map");

26  
¡©us
;

28 
sub£t
.
m­
 = 
‹am
->
ùx_m­
;

29 
sub£t
.
my¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

31 
¡©us
 = 
	`ucc_tİo_š™
(
sub£t
, 
	`UCC_TL_CORE_CTX
(
‹am
)->
tİo
, &team->topo);

33 ià(
UCC_OK
 !ğ
¡©us
) {

34 
	`_”rÜ
(
	`UCC_TL_TEAM_LIB
(
‹am
), "failedo initeamopo");

35 
”r_tİo_š™
;

38  
UCC_OK
;

39 
”r_tİo_š™
:

40 
	`ucc_•_m­_de¡roy_Ã¡ed
(&
‹am
->
ùx_m­
);

41  
¡©us
;

42 
	}
}

44 
	$UCC_CLASS_INIT_FUNC
(
ucc__uı_‹am_t
, 
ucc_ba£_cÚ‹xt_t
 *
_cÚ‹xt
,

45 cÚ¡ 
ucc_ba£_‹am_·¿ms_t
 *
·¿ms
)

47 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`ucc_d”ived_of
(
_cÚ‹xt
,

48 
ucc__uı_cÚ‹xt_t
);

49 
ucc_kn_¿dix_t
 
max_¿dix
, 
mš_¿dix
;

50 
ucc_¿nk_t
 
tsize
;

51 
ucc_¡©us_t
 
¡©us
;

53 
	`UCC_CLASS_CALL_SUPER_INIT
(
ucc__‹am_t
, &
ùx
->
su³r
, 
·¿ms
);

56 
£lf
->
´ecÚÃù_sk
 = 
NULL
;

57 
£lf
->
£q_num
 = 0;

58 
£lf
->
¡©us
 = 
UCC_INPROGRESS
;

59 
£lf
->
tunšg_¡r
 = "";

60 
£lf
->
tİo
 = 
NULL
;

61 
£lf
->
İt_¿dix
 = 
UCC_UUNITS_AUTO_RADIX
;

62 
£lf
->
İt_¿dix_ho¡
 = 
UCC_UUNITS_AUTO_RADIX
;

64 
¡©us
 = 
	`ucc_cÚfig_şÚe_bË
(&
	`UCC_TL_UCP_TEAM_LIB
(
£lf
)->
cfg
, &self->cfg,

65 
ucc__uı_lib_cÚfig_bË
);

66 ià(
UCC_OK
 !ğ
¡©us
) {

67  
¡©us
;

70 ià(
ùx
->
tİo_»quœed
) {

71 
¡©us
 = 
	`ucc__uı_g‘_tİo
(
£lf
);

72 ià(
UCC_OK
 !ğ
¡©us
) {

73  
¡©us
;

77 ià(
ucc_glob®_cÚfig
.
fe_cfg
 && !
	`UCC_TL_IS_SERVICE_TEAM
(
£lf
) &&

78 
ùx
->
tİo_»quœed
 && 
_cÚ‹xt
->
lib
->
u£_tunšg
) {

79 
¡©us
 = 
	`ucc_add_‹am_£ùiÚs
(&
£lf
->
cfg
, 
ucc__uı_lib_cÚfig_bË
,

80 
£lf
->
tİo
, &£lf->
tunšg_¡r
,

82 
	`UCC_TL_CORE_CTX
(
£lf
)->
lib
->
fuÎ_´efix
,

83 
ucc__uı
.
su³r
.
_lib_cÚfig
.
´efix
);

84 ià(
¡©us
 !ğ
UCC_OK
) {

85 
	`ucc_debug
("section‚ot found");

89 ià(!
£lf
->
tİo
 && s–f->
cfg
.
u£_»Üd”šg
) {

90 
	`_debug
(
_cÚ‹xt
->
lib
,

92 
£lf
->
cfg
.
u£_»Üd”šg
 = 0;

95 ià(
£lf
->
tİo
 && !
	`UCC_TL_IS_SERVICE_TEAM
(self)) {

96 
tsize
 = 
	`UCC_TL_TEAM_SIZE
(
£lf
);

98 
mš_¿dix
 = 
	`ucc_mš
(
tsize
, 3);

99 
max_¿dix
 = 
tsize
;

100 
£lf
->
İt_¿dix
 = 
	`ucc_kn_g‘_İt_¿dix
(
tsize
, 
mš_¿dix
, 
max_¿dix
);

101 ià(
	`ucc_tİo_is_sšgË_µn
(
£lf
->
tİo
)) {

102 
£lf
->
İt_¿dix_ho¡
 = s–f->
İt_¿dix
;

104 ià(
£lf
->
tİo
->tİo->
sock_bound
) {

105 
mš_¿dix
 = 2;

106 
max_¿dix
 = 
	`ucc_mš
(
tsize
, 
	`ucc_tİo_mš_sock‘_size
(
£lf
->
tİo
));

107 
£lf
->
İt_¿dix_ho¡
 = 
	`ucc_kn_g‘_İt_¿dix
(
tsize
, 
mš_¿dix
,

108 
max_¿dix
);

111 
	`_debug
(
_cÚ‹xt
->
lib
, "opt knomial„adix: general %d host %d",

112 
£lf
->
İt_¿dix
, s–f->
İt_¿dix_ho¡
);

115 
	`_debug
(
_cÚ‹xt
->
lib
, "po¡edÈ‹am: %p", 
£lf
);

116  
UCC_OK
;

117 
	}
}

119 
	$UCC_CLASS_CLEANUP_FUNC
(
ucc__uı_‹am_t
)

121 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(&
£lf
->
cfg
, 
ucc__uı_lib_cÚfig_bË
);

122 
	`_debug
(
£lf
->
su³r
.su³r.
cÚ‹xt
->
lib
, "finalizingleam: %p", self);

123 
	}
}

125 
UCC_CLASS_DEFINE_DELETE_FUNC
(
ucc__uı_‹am_t
, 
ucc_ba£_‹am_t
);

126 
UCC_CLASS_DEFINE
(
ucc__uı_‹am_t
, 
ucc__‹am_t
);

128 
ucc_¡©us_t
 
	$ucc__uı_‹am_de¡roy
(
ucc_ba£_‹am_t
 *
_‹am
)

130 
ucc__uı_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_ucp_team_t);

132 ià(
‹am
->
tİo
) {

133 
	`ucc_•_m­_de¡roy_Ã¡ed
(&
‹am
->
ùx_m­
);

134 
	`ucc_tİo_ş—nup
(
‹am
->
tİo
);

136 
	`UCC_CLASS_DELETE_FUNC_NAME
(
ucc__uı_‹am_t
)(
_‹am
);

137  
UCC_OK
;

138 
	}
}

140 
ucc_¡©us_t
 
	$ucc__uı_‹am_´ecÚÃù
(
ucc__uı_‹am_t
 *
‹am
)

142 
ucc_¿nk_t
 
¤c
, 
d¡
, 
size
, 
¿nk
;

143 
ucc_¡©us_t
 
¡©us
;

144 
i
;

146 
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

147 
¿nk
 = 
	`UCC_TL_TEAM_RANK
(
‹am
);

148 ià(!
‹am
->
´ecÚÃù_sk
) {

149 
‹am
->
´ecÚÃù_sk
 = 
	`ucc__uı_g‘_sk
(team);

150 
‹am
->
´ecÚÃù_sk
->
gged
.
g
 = 0;

151 
‹am
->
´ecÚÃù_sk
->
su³r
.
b¬gs
.
¬gs
.
mask
 = 0;

153 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
‹am
->
´ecÚÃù_sk
)) {

154 
	`uı_wÜk”_´og»ss
(
‹am
->
wÜk”
->
uı_wÜk”
);

155  
UCC_INPROGRESS
;

157 
i
 = 
‹am
->
´ecÚÃù_sk
->
gged
.
£nd_po¡ed
; i < 
size
; i++) {

158 
¤c
 = (
¿nk
 - 
i
 + 
size
) % size;

159 
d¡
 = (
¿nk
 + 
i
è% 
size
;

160 
¡©us
 = 
	`ucc__uı_£nd_nb
(
NULL
, 0, 
UCC_MEMORY_TYPE_UNKNOWN
, 
¤c
, 
‹am
,

161 
‹am
->
´ecÚÃù_sk
);

162 ià(
UCC_OK
 !ğ
¡©us
) {

163  
¡©us
;

165 
¡©us
 = 
	`ucc__uı_»cv_nb
(
NULL
, 0, 
UCC_MEMORY_TYPE_UNKNOWN
, 
d¡
, 
‹am
,

166 
‹am
->
´ecÚÃù_sk
);

167 ià(
UCC_OK
 !ğ
¡©us
) {

168  
¡©us
;

170 ià(
UCC_INPROGRESS
 =ğ
	`ucc__uı_‹¡
(
‹am
->
´ecÚÃù_sk
)) {

171  
UCC_INPROGRESS
;

174 
	`_debug
(
	`UCC_TL_TEAM_LIB
(
‹am
), "preconnectedleam: %p,‚um_eps %d",

175 
‹am
, 
size
);

176 
	`ucc__uı_put_sk
(
‹am
->
´ecÚÃù_sk
);

177 
‹am
->
´ecÚÃù_sk
 = 
NULL
;

178  
UCC_OK
;

179 
	}
}

181 
ucc_¡©us_t
 
	$ucc__uı_‹am_ü—‹_‹¡
(
ucc_ba£_‹am_t
 *
_‹am
)

183 
ucc__uı_‹am_t
 * 
‹am
 = 
	`ucc_d”ived_of
(
_‹am
, ucc_tl_ucp_team_t);

184 
ucc__uı_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

185 
i
;

186 
ucc_¡©us_t
 
¡©us
;

188 ià(
	`USE_SERVICE_WORKER
(
‹am
)) {

189 
‹am
->
wÜk”
 = &
ùx
->
£rviû_wÜk”
;

191 
‹am
->
wÜk”
 = &
ùx
->worker;

194 ià(
‹am
->
¡©us
 =ğ
UCC_OK
) {

195  
UCC_OK
;

198 ià(
	`UCC_TL_TEAM_SIZE
(
‹am
è<ğ
ùx
->
cfg
.
´ecÚÃù
) {

199 
¡©us
 = 
	`ucc__uı_‹am_´ecÚÃù
(
‹am
);

200 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

201  
UCC_INPROGRESS
;

202 } ià(
UCC_OK
 !ğ
¡©us
) {

203 
”r_´ecÚÃù
;

207 ià(
ùx
->
»mÙe_šfo
) {

208 
i
 = 0; i < 
ùx
->
n_ršfo_£gs
; i++) {

209 
‹am
->
va_ba£
[
i
] = 
ùx
->
»mÙe_šfo
[i].va_base;

210 
‹am
->
ba£_Ëngth
[
i
] = 
ùx
->
»mÙe_šfo
[i].
Ën
;

214 
	`_debug
(
_‹am
->
cÚ‹xt
->
lib
, "š™ŸlizedÈ‹am: %p", 
‹am
);

215 
‹am
->
¡©us
 = 
UCC_OK
;

216  
UCC_OK
;

218 
”r_´ecÚÃù
:

219  
¡©us
;

220 
	}
}

222 
ucc_¡©us_t
 
	$ucc__uı_‹am_g‘_scÜes
(
ucc_ba£_‹am_t
 *
_‹am
,

223 
ucc_cŞl_scÜe_t
 **
scÜe_p
)

225 
ucc__uı_‹am_t
 *
‹am
 = 
	`ucc_d”ived_of
(
_‹am
,

226 
ucc__uı_‹am_t
);

227 
ucc_compÚ’t_äamewÜk_t
 *
¶ugšs
 = &
ucc__uı
.
su³r
.
cŞl_¶ugšs
;

228 
ucc__uı_cÚ‹xt_t
 *
_ùx
 = 
	`UCC_TL_UCP_TEAM_CTX
(
‹am
);

229 
ucc_ba£_cÚ‹xt_t
 *
ùx
 = 
	`UCC_TL_TEAM_CTX
(
‹am
);

230 
mt_n
 = 0;

231 
ucc_memÜy_ty³_t
 
mem_ty³s
[
UCC_MEMORY_TYPE_LAST
];

232 
ucc_cŞl_scÜe_t
 *
scÜe
, *
ı_scÜe
;

233 
ucc__cŞl_¶ugš_içû_t
 *
ı
;

234 
ucc_¡©us_t
 
¡©us
;

235 
i
;

236 *
ucc__uı_deçuÉ_®g_£Ëù_¡r


237 [
UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
];

238 
ucc_cŞl_scÜe_‹am_šfo_t
 
‹am_šfo
;

240 
i
 = 0; i < 
UCC_MEMORY_TYPE_LAST
; i++) {

241 ià(
_ùx
->
uı_memÜy_ty³s
 & 
	`UCC_BIT
(
ucc_memty³_to_ucs
[
i
])) {

242 
	`_debug
(
_‹am
->
cÚ‹xt
->
lib
,

244 
ucc_memÜy_ty³_Çmes
[
i
]);

245 
mem_ty³s
[
mt_n
++] = (
ucc_memÜy_ty³_t
)
i
;

249 
‹am_šfo
.
®g_â
 = 
ucc__uı_®g_id_to_š™
;

250 
‹am_šfo
.
deçuÉ_scÜe
 = 
UCC_TL_UCP_DEFAULT_SCORE
;

251 
‹am_šfo
.
š™
 = 
ucc__uı_cŞl_š™
;

252 
‹am_šfo
.
num_mem_ty³s
 = 
mt_n
;

253 
‹am_šfo
.
suµÜ‹d_mem_ty³s
 = 
mem_ty³s
;

254 
‹am_šfo
.
suµÜ‹d_cŞls
 = 
UCC_TL_UCP_SUPPORTED_COLLS
;

255 
‹am_šfo
.
size
 = 
	`UCC_TL_TEAM_SIZE
(
‹am
);

259 
¡©us
 = 
	`ucc_cŞl_scÜe_bud_deçuÉ
(
_‹am
, 
UCC_TL_UCP_DEFAULT_SCORE
,

260 
ucc__uı_cŞl_š™
, 
UCC_TL_UCP_SUPPORTED_COLLS
,

261 
mem_ty³s
, 
mt_n
, &
scÜe
);

262 ià(
UCC_OK
 !ğ
¡©us
) {

263  
¡©us
;

265 
¡©us
 = 
	`ucc__uı_‹am_deçuÉ_scÜe_¡r_®loc
(
‹am
,

266 
ucc__uı_deçuÉ_®g_£Ëù_¡r
);

267 ià(
UCC_OK
 !ğ
¡©us
) {

268  
¡©us
;

270 
i
 = 0; i < 
UCC_TL_UCP_N_DEFAULT_ALG_SELECT_STR
; i++) {

271 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(

272 
ucc__uı_deçuÉ_®g_£Ëù_¡r
[
i
], &
‹am_šfo
,

273 &
‹am
->
su³r
.su³r, 
scÜe
);

274 ià(
UCC_OK
 !ğ
¡©us
) {

275 
	`_”rÜ
(
_‹am
->
cÚ‹xt
->
lib
,

277 
ucc__uı_deçuÉ_®g_£Ëù_¡r
[
i
]);

278 
”r
;

282 ià(
	`¡¾’
(
ùx
->
scÜe_¡r
) > 0) {

283 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
ùx
->
scÜe_¡r
, &
‹am_šfo
,

284 &
‹am
->
su³r
.su³r, 
scÜe
);

285 } ià(
	`¡¾’
(
‹am
->
tunšg_¡r
) > 0) {

286 
¡©us
 = 
	`ucc_cŞl_scÜe_upd©e_äom_¡r
(
‹am
->
tunšg_¡r
, &
‹am_šfo
,

287 &
‹am
->
su³r
.su³r, 
scÜe
);

290 ià((
¡©us
 < 0è&& (¡©u !ğ
UCC_ERR_INVALID_PARAM
) &&

291 (
¡©us
 !ğ
UCC_ERR_NOT_SUPPORTED
)) {

292 
”r
;

295 
i
 = 0; i < 
¶ugšs
->
n_compÚ’ts
; i++) {

296 
ı
 = 
	`ucc_d”ived_of
(
¶ugšs
->
compÚ’ts
[
i
],

297 
ucc__cŞl_¶ugš_içû_t
);

298 
¡©us
 = 
ı
->
	`g‘_scÜes
(
_‹am
, &
ı_scÜe
);

299 ià(
UCC_OK
 !ğ
¡©us
) {

300 
”r
;

302 
¡©us
 = 
	`ucc_cŞl_scÜe_m”ge_š
(&
scÜe
, 
ı_scÜe
);

303 ià(
UCC_OK
 !ğ
¡©us
) {

304 
”r
;

307 
	`ucc__uı_‹am_deçuÉ_scÜe_¡r_ä“
(
ucc__uı_deçuÉ_®g_£Ëù_¡r
);

308 *
scÜe_p
 = 
scÜe
;

309  
UCC_OK
;

310 
”r
:

311 
	`ucc__uı_‹am_deçuÉ_scÜe_¡r_ä“
(
ucc__uı_deçuÉ_®g_£Ëù_¡r
);

312 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

313  
¡©us
;

314 
	}
}

	@src/components/topo/ucc_sbgp.c

7 
	~"ucc_sbgp.h
"

8 
	~"ucc_tİo.h
"

9 
	~"uts/ucc_log.h
"

10 
	~"uts/ucc_m®loc.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~"uts/ucc_comp”_def.h
"

13 
	~<lim™s.h
>

15 *
	gucc_sbgp_ty³_¡r
[
UCC_SBGP_LAST
] = {

19 cÚ¡ * 
	$ucc_sbgp_¡r
(
ucc_sbgp_ty³_t
 
ty³
)

21  
ucc_sbgp_ty³_¡r
[
ty³
];

22 
	}
}

24 
	#UCC_TOPO_IS_BOUND
(
_tİo
, 
_sbgp_ty³
) \

25 (
UCC_SBGP_SOCKET
 =ğ(
_sbgp_ty³
) || \

26 
UCC_SBGP_SOCKET_LEADERS
 =ğ(
_sbgp_ty³
)) ? \

27 (
_tİo
)->
tİo
->
sock_bound
 : (_tİo)->tİo->
numa_bound


	)

29 
šlše
 
	$ucc_¿nks_Ú_loÿl_¢
(
ucc_¿nk_t
 
¿nk1
, ucc_¿nk_ˆ
¿nk2
,

30 
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_ty³_t
 
ty³
)

32 
ucc_¿nk_t
 
ùx_¿nk1
 = 
	`ucc_•_m­_ev®
(
tİo
->
£t
.
m­
, 
¿nk1
);

33 
ucc_¿nk_t
 
ùx_¿nk2
 = 
	`ucc_•_m­_ev®
(
tİo
->
£t
.
m­
, 
¿nk2
);

34 
ucc_´oc_šfo_t
 *
´oc1
 = &
tİo
->tİo->
´ocs
[
ùx_¿nk1
];

35 
ucc_´oc_šfo_t
 *
´oc2
 = &
tİo
->tİo->
´ocs
[
ùx_¿nk2
];

36 
bound
 = 
	`UCC_TOPO_IS_BOUND
(
tİo
, 
ty³
);

38 ià(!
bound
) {

41  
´oc1
->
ho¡_hash
 =ğ
´oc2
->host_hash &&

42 ((
UCC_SBGP_SOCKET
 =ğ
ty³
è? 
´oc1
->
sock‘_id
 =ğ
´oc2
->socket_id

43 : 
´oc1
->
numa_id
 =ğ
´oc2
->numa_id);

44 
	}
}

46 
šlše
 
ucc_¡©us_t
 
	$sbgp_ü—‹_¢
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 *
sbgp
,

47 
ucc_¿nk_t
 
group_¿nk
,

48 
®low_size_1
)

50 
ucc_sbgp_t
 *
node_sbgp
 = &
tİo
->
sbgps
[
UCC_SBGP_NODE
];

51 
ucc_¿nk_t
 
Ær
 = 
tİo
->
node_Ëad”_¿nk
;

52 
ucc_¿nk_t
 
¢_¿nk
 = 0, 
¢_size
 = 0;

53 
i
, 
r
, 
Ær_pos
;

54 
ucc_¿nk_t
 *
loÿl_¿nks
;

56 
	`ucc_as£¹
(
node_sbgp
->
¡©us
 =ğ
UCC_SBGP_ENABLED
);

57 
loÿl_¿nks
 =

58 
	`ucc_m®loc
(
node_sbgp
->
group_size
 * (
ucc_¿nk_t
), "local_ranks");

59 ià(!
loÿl_¿nks
) {

60 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for†ocal_ranks‡rray",

61 
node_sbgp
->
group_size
 * (
ucc_¿nk_t
));

62  
UCC_ERR_NO_MEMORY
;

64 
i
 = 0; i < 
node_sbgp
->
group_size
; i++) {

65 
r
 = 
	`ucc_•_m­_ev®
(
node_sbgp
->
m­
, 
i
);

66 ià(
	`ucc_¿nks_Ú_loÿl_¢
(
r
, 
group_¿nk
, 
tİo
, 
sbgp
->
ty³
)) {

67 
loÿl_¿nks
[
¢_size
] = 
r
;

68 ià(
r
 =ğ
group_¿nk
) {

69 
¢_¿nk
 = 
¢_size
;

71 
¢_size
++;

74 
sbgp
->
group_size
 = 
¢_size
;

75 
sbgp
->
group_¿nk
 = 
¢_¿nk
;

76 
Ær_pos
 = -1;

77 
i
 = 0; i < 
¢_size
; i++) {

78 ià(
Ær
 =ğ
loÿl_¿nks
[
i
]) {

79 
Ær_pos
 = 
i
;

83 ià(
Ær_pos
 > 0) {

84 ià(
¢_¿nk
 == 0)

85 
sbgp
->
group_¿nk
 = 
Ær_pos
;

86 ià(
¢_¿nk
 =ğ
Ær_pos
)

87 
sbgp
->
group_¿nk
 = 0;

88 
	`SWAP
(
loÿl_¿nks
[
Ær_pos
],†ocal_ranks[0], );

90 ià(
¢_size
 > 1 || 
®low_size_1
) {

91 
sbgp
->
¡©us
 = 
UCC_SBGP_ENABLED
;

92 
sbgp
->
¿nk_m­
 = 
loÿl_¿nks
;

94 
sbgp
->
¡©us
 = 
UCC_SBGP_NOT_EXISTS
;

95 
	`ucc_ä“
(
loÿl_¿nks
);

97  
UCC_OK
;

98 
	}
}

100 
ucc_¡©us_t
 
	$ucc_sbgp_ü—‹_node
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 *
sbgp
)

102 
ucc_sub£t_t
 *
£t
 = &
tİo
->set;

103 
ucc_¿nk_t
 
group_size
 = 
	`ucc_sub£t_size
(
£t
);

104 
ucc_¿nk_t
 
group_¿nk
 = 
£t
->
my¿nk
;

105 
ucc_¿nk_t
 
max_loÿl_size
 = 256;

106 
ucc_¿nk_t
 
ùx_Ær
 = 
tİo
->
node_Ëad”_¿nk_id
;

107 
ucc_¿nk_t
 
node_¿nk
 = 0, 
node_size
 = 0;

108 
i
;

109 
ucc_¿nk_t
 *
loÿl_¿nks
, *
tmp
;

110 
loÿl_¿nks
 =

111 
	`ucc_m®loc
(
max_loÿl_size
 * (
ucc_¿nk_t
), "local_ranks");

112 ià(!
loÿl_¿nks
) {

113 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for†ocal_ranks‡rray",

114 
max_loÿl_size
 * (
ucc_¿nk_t
));

115  
UCC_ERR_NO_MEMORY
;

117 
i
 = 0; i < 
group_size
; i++) {

118 ià(
	`ucc_¿nk_Ú_loÿl_node
(
i
, 
tİo
)) {

119 ià(
node_size
 =ğ
max_loÿl_size
) {

120 
max_loÿl_size
 *= 2;

121 
tmp
 = 
	`ucc_»®loc
(
loÿl_¿nks
,

122 
max_loÿl_size
 * (
ucc_¿nk_t
));

123 ià(!
tmp
) {

124 
	`ucc_”rÜ
(

126 
max_loÿl_size
 * (
ucc_¿nk_t
));

127 
	`ucc_ä“
(
loÿl_¿nks
);

128  
UCC_ERR_NO_MEMORY
;

130 
loÿl_¿nks
 = 
tmp
;

132 
loÿl_¿nks
[
node_size
] = 
i
;

134 ià(
i
 =ğ
group_¿nk
) {

135 
node_¿nk
 = 
node_size
;

137 
node_size
++;

140 ià(0 =ğ
node_size
) {

142 
	`ucc_ä“
(
loÿl_¿nks
);

143  
UCC_ERR_NOT_FOUND
;

145 
sbgp
->
group_size
 = 
node_size
;

146 
sbgp
->
group_¿nk
 = 
node_¿nk
;

147 
sbgp
->
¿nk_m­
 = 
loÿl_¿nks
;

148 ià(0 < 
ùx_Ær
 && ctx_Æ¸< 
node_size
) {

151 
sbgp
->
¿nk_m­
 = 
	`ucc_m®loc
(
node_size
 * (
ucc_¿nk_t
), "rank_map");

152 ià(!
sbgp
->
¿nk_m­
) {

153 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for„ank_map‡rray",

154 
node_size
 * (
ucc_¿nk_t
));

155 
	`ucc_ä“
(
loÿl_¿nks
);

156  
UCC_ERR_NO_MEMORY
;

158 
i
 = 
ùx_Ær
; i < 
node_size
; i++) {

159 
sbgp
->
¿nk_m­
[
i
 - 
ùx_Ær
] = 
loÿl_¿nks
[i];

162 
i
 = 0; i < 
ùx_Ær
; i++) {

163 
sbgp
->
¿nk_m­
[
node_size
 - 
ùx_Ær
 + 
i
] = 
loÿl_¿nks
[i];

165 
sbgp
->
group_¿nk
 = (
node_¿nk
 + 
node_size
 - 
ùx_Ær
) %‚ode_size;

166 
	`ucc_ä“
(
loÿl_¿nks
);

168 
tİo
->
node_Ëad”_¿nk
 = 
sbgp
->
¿nk_m­
[0];

169 ià(
node_size
 > 1) {

170 
sbgp
->
¡©us
 = 
UCC_SBGP_ENABLED
;

172 
sbgp
->
¡©us
 = 
UCC_SBGP_NOT_EXISTS
;

174  
UCC_OK
;

175 
	}
}

177 
	$ucc_com·»_Æ_¿nks
(cÚ¡ *
a
, cÚ¡ *
b
)

179 
ucc_¿nk_t
 *
r1
 = (ucc_¿nk_ˆ*)
a
;

180 
ucc_¿nk_t
 *
r2
 = (ucc_¿nk_ˆ*)
b
;

182 if(*
r1
 > *
r2
) {

185 if(*
r1
 =ğ*
r2
) {

191 
	}
}

193 
ucc_¡©us_t
 
	$sbgp_ü—‹_node_Ëad”s
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 *
sbgp
,

194 
ùx_Ær
)

196 
ucc_sub£t_t
 *
£t
 = &
tİo
->set;

197 
ucc_¿nk_t
 
comm_size
 = 
	`ucc_sub£t_size
(
£t
);

198 
ucc_¿nk_t
 
comm_¿nk
 = 
£t
->
my¿nk
;

199 
ucc_¿nk_t
 
mš_sbgp_size
 = 
UCC_RANK_MAX
;

200 
ucc_¿nk_t
 
max_sbgp_size
 = 0;

201 
ucc_¿nk_t
 
max_ùx_sbgp_size
 = 0;

202 
ucc_¿nk_t
 *
Æ_¬¿y_3
 = 
NULL
;

203 
i_am_node_Ëad”
 = 0;

204 
sock‘_bound
 = 
tİo
->tİo->
sock_bound
;

205 
numa_bound
 = 
tİo
->topo->numa_bound;

206 
bound
 = 
sock‘_bound
 || 
numa_bound
;

207 
ucc_¿nk_t
 
Âodes
 = 
tİo
->topo->nnodes;

208 
ucc_¿nk_t
 
n_node_Ëad”s
, 
ùx_¿nk
, 
i
;

209 
ucc_¿nk_t
 *
Æ_¬¿y_1
, *
Æ_¬¿y_2
;

210 
ucc_ho¡_id_t
 
ho¡_id
;

211 
ušt8_t
 
sbgp_id
;

213 
	`ucc_as£¹
(
comm_size
 !ğ0 && 
Âodes
 != 0);

215 ià(
tİo
->
mš_µn
 !ğ
UCC_RANK_MAX
 && 
ùx_Ær
 >=opo->min_ppn) {

216 
sbgp
->
¡©us
 = 
UCC_SBGP_NOT_EXISTS
;

217  
UCC_OK
;

219 
Æ_¬¿y_1
 = 
	`ucc_m®loc
(
Âodes
 * (
ucc_¿nk_t
), "nl_array_1");

220 ià(!
Æ_¬¿y_1
) {

221 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for‚l_array_1",

222 
Âodes
 * (
ucc_¿nk_t
));

223  
UCC_ERR_NO_MEMORY
;

225 
Æ_¬¿y_2
 = 
	`ucc_m®loc
(
Âodes
 * (
ucc_¿nk_t
), "nl_array_2");

226 ià(!
Æ_¬¿y_2
) {

227 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for‚l_array_2",

228 
Âodes
 * (
ucc_¿nk_t
));

229 
	`ucc_ä“
(
Æ_¬¿y_1
);

230  
UCC_ERR_NO_MEMORY
;

233 ià(
bound
) {

234 
max_ùx_sbgp_size
 = 
sock‘_bound
 ? 
tİo
->tİo->
max_n_sock‘s
 :

235 
tİo
->tİo->
max_n_numas
;

236 
Æ_¬¿y_3
 = 
	`ucc_m®loc
(
max_ùx_sbgp_size
 * 
Âodes
 *

237 (
ucc_¿nk_t
), "nl_array_3");

238 ià(!
Æ_¬¿y_3
) {

239 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for‚l_array_3",

240 
max_ùx_sbgp_size
 * 
Âodes
 * (
ucc_¿nk_t
));

241 
	`ucc_ä“
(
Æ_¬¿y_1
);

242 
	`ucc_ä“
(
Æ_¬¿y_2
);

243  
UCC_ERR_NO_MEMORY
;

246 
	`mem£t
(
Æ_¬¿y_3
, 0, 
max_ùx_sbgp_size
 * 
Âodes
 * (
ucc_¿nk_t
));

249 
i
 = 0; i < 
Âodes
; i++) {

250 
Æ_¬¿y_1
[
i
] = 0;

251 
Æ_¬¿y_2
[
i
] = 
UCC_RANK_MAX
;

254 
i
 = 0; i < 
comm_size
; i++) {

255 
ùx_¿nk
 = 
	`ucc_•_m­_ev®
(
£t
->
m­
, 
i
);

256 
ho¡_id
 = 
tİo
->tİo->
´ocs
[
ùx_¿nk
].host_id;

257 ià(
bound
) {

258 
sbgp_id
 = 
sock‘_bound
 ? 
tİo
->tİo->
´ocs
[
ùx_¿nk
].
sock‘_id
 :

259 
tİo
->tİo->
´ocs
[
ùx_¿nk
].
numa_id
;

260 
Æ_¬¿y_3
[
sbgp_id
 + 
ho¡_id
 * 
max_ùx_sbgp_size
]++;

264 ià(
Æ_¬¿y_1
[
ho¡_id
] =ğ0 ||‚l_¬¿y_1[ho¡_id] =ğ
ùx_Ær
) {

265 
Æ_¬¿y_2
[
ho¡_id
] = 
i
;

267 
Æ_¬¿y_1
[
ho¡_id
]++;

270 
i
 = 0; i < 
Âodes
; i++) {

271 ià(
Æ_¬¿y_1
[
i
] > 
tİo
->
max_µn
) {

272 
tİo
->
max_µn
 = 
Æ_¬¿y_1
[
i
];

274 ià(
Æ_¬¿y_1
[
i
] !ğ0 &&‚l_¬¿y_1[i] < 
tİo
->
mš_µn
) {

275 
tİo
->
mš_µn
 = 
Æ_¬¿y_1
[
i
];

279 ià(
bound
) {

280 
i
 = 0; i < 
Âodes
 * 
max_ùx_sbgp_size
; i++) {

281 ià(
Æ_¬¿y_3
[
i
] == 0) {

284 
mš_sbgp_size
 = 
	`ucc_mš
(mš_sbgp_size, 
Æ_¬¿y_3
[
i
]);

285 
max_sbgp_size
 = 
	`ucc_max
(max_sbgp_size, 
Æ_¬¿y_3
[
i
]);

287 ià(
sock‘_bound
) {

288 
tİo
->
mš_sock‘_size
 = 
mš_sbgp_size
;

289 
tİo
->
max_sock‘_size
 = 
max_sbgp_size
;

291 
tİo
->
mš_numa_size
 = 
mš_sbgp_size
;

292 
tİo
->
max_numa_size
 = 
max_sbgp_size
;

294 
	`ucc_ä“
(
Æ_¬¿y_3
);

297 
n_node_Ëad”s
 = 0;

298 ià(
ùx_Ær
 >ğ
tİo
->
mš_µn
) {

301 
sk
;

304 
i
 = 0; i < 
Âodes
; i++) {

305 ià(
Æ_¬¿y_2
[
i
] !ğ
UCC_RANK_MAX
) {

306 ià(
comm_¿nk
 =ğ
Æ_¬¿y_2
[
i
]) {

307 
i_am_node_Ëad”
 = 1;

308 
sbgp
->
group_¿nk
 = 
n_node_Ëad”s
;

310 
Æ_¬¿y_1
[
n_node_Ëad”s
++] = 
Æ_¬¿y_2
[
i
];

315 
	`qsÜt
(
Æ_¬¿y_1
, 
n_node_Ëad”s
, (
ucc_¿nk_t
), 
ucc_com·»_Æ_¿nks
);

316 ià(
i_am_node_Ëad”
) {

317 
i
 = 0; i < 
n_node_Ëad”s
; i++) {

319 ià(
Æ_¬¿y_1
[
i
] =ğ
comm_¿nk
) {

320 
sbgp
->
group_¿nk
 = 
i
;

326 
sk
:

327 
	`ucc_ä“
(
Æ_¬¿y_2
);

329 ià(
n_node_Ëad”s
 > 1) {

330 
sbgp
->
group_size
 = 
n_node_Ëad”s
;

331 ià(
i_am_node_Ëad”
) {

332 
sbgp
->
¡©us
 = 
UCC_SBGP_ENABLED
;

334 
sbgp
->
¡©us
 = 
UCC_SBGP_DISABLED
;

336 
sbgp
->
¿nk_m­
 = 
Æ_¬¿y_1
;

338 
	`ucc_ä“
(
Æ_¬¿y_1
);

339 
sbgp
->
¡©us
 = 
UCC_SBGP_NOT_EXISTS
;

341  
UCC_OK
;

342 
	}
}

344 
	#GET_SN_ID
(
_tİo
, 
_´oc
, 
_ty³
) \

345 (((
_ty³
è=ğ
UCC_SBGP_SOCKET_LEADERS
) \

346 ? (
_tİo
)->
tİo
->
´ocs
[(
_´oc
)].
sock‘_id
 \

347 : (
_tİo
)->
tİo
->
´ocs
[(
_´oc
)].
numa_id
)

	)

349 
ucc_¡©us_t
 
	$sbgp_ü—‹_¢_Ëad”s
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 *
sbgp
)

351 
ucc_sub£t_t
 * 
£t
 = &
tİo
->set;

352 
ucc_sbgp_t
 * 
node_sbgp
 = &
tİo
->
sbgps
[
UCC_SBGP_NODE
];

353 
ucc_¿nk_t
 
comm_¿nk
 = 
£t
->
my¿nk
;

354 
ucc_¿nk_t
 
Ær
 = 
tİo
->
node_Ëad”_¿nk
;

355 
i_am_¢_Ëad”
 = (
Ær
 =ğ
comm_¿nk
);

356 
ucc_¿nk_t
 
n_¢_Ëad”s
 = 1;

357 
max_n_¢s
 = (
sbgp
->
ty³
 =ğ
UCC_SBGP_SOCKET_LEADERS
)

358 ? 
tİo
->tİo->
max_n_sock‘s


359 : 
tİo
->tİo->
max_n_numas
;

360 
ucc_¿nk_t
 *
¦_¬¿y
;

361 
ucc_sock‘_id_t
 
Ær_sock_id
;

362 
i
;

364 
¦_¬¿y
 = 
	`ucc_m®loc
(
max_n_¢s
 * (
ucc_¿nk_t
), "sl_array");

365 ià(!
¦_¬¿y
) {

366 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for sl_array",

367 
max_n_¢s
 * (
ucc_¿nk_t
));

368  
UCC_ERR_NO_MEMORY
;

370 
i
 = 0; i < 
max_n_¢s
; i++) {

371 
¦_¬¿y
[
i
] = 
UCC_RANK_MAX
;

373 
Ær_sock_id
 = 
	`GET_SN_ID
(
tİo
, 
	`ucc_•_m­_ev®
(
£t
->
m­
, 
Ær
), 
sbgp
->
ty³
);

374 
¦_¬¿y
[
Ær_sock_id
] = 
Ær
;

376 
i
 = 0; i < 
node_sbgp
->
group_size
; i++) {

377 
ucc_¿nk_t
 
r
 = 
	`ucc_•_m­_ev®
(
node_sbgp
->
m­
, 
i
);

378 
ucc_¿nk_t
 
ùx_¿nk
 = 
	`ucc_•_m­_ev®
(
£t
->
m­
, 
r
);

379 
ucc_sock‘_id_t
 
¢_id
 = 
	`GET_SN_ID
(
tİo
, 
ùx_¿nk
, 
sbgp
->
ty³
);

380 ià(
¦_¬¿y
[
¢_id
] =ğ
UCC_RANK_MAX
) {

381 
n_¢_Ëad”s
++;

382 
¦_¬¿y
[
¢_id
] = 
r
;

383 ià(
r
 =ğ
comm_¿nk
) {

384 
i_am_¢_Ëad”
 = 1;

388 ià(
UCC_SBGP_SOCKET_LEADERS
 =ğ
sbgp
->
ty³
) {

389 
tİo
->
n_sock‘s
 = 
n_¢_Ëad”s
;

391 
	`ucc_as£¹
(
UCC_SBGP_NUMA_LEADERS
 =ğ
sbgp
->
ty³
);

392 
tİo
->
n_numas
 = 
n_¢_Ëad”s
;

394 ià(
n_¢_Ëad”s
 > 1) {

395 
ucc_¿nk_t
 
¦_¿nk
 = 
UCC_RANK_INVALID
;

396 
sbgp
->
¿nk_m­
 =

397 
	`ucc_m®loc
((
ucc_¿nk_t
è* 
n_¢_Ëad”s
, "rank_map");

398 ià(!
sbgp
->
¿nk_m­
) {

399 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for„ank_map",

400 
n_¢_Ëad”s
 * (
ucc_¿nk_t
));

401 
	`ucc_ä“
(
¦_¬¿y
);

402  
UCC_ERR_NO_MEMORY
;

404 
n_¢_Ëad”s
 = 0;

405 
i
 = 0; i < 
max_n_¢s
; i++) {

406 ià(
¦_¬¿y
[
i
] !ğ
UCC_RANK_MAX
) {

407 
sbgp
->
¿nk_m­
[
n_¢_Ëad”s
] = 
¦_¬¿y
[
i
];

408 ià(
comm_¿nk
 =ğ
¦_¬¿y
[
i
]) {

409 
¦_¿nk
 = 
n_¢_Ëad”s
;

411 
n_¢_Ëad”s
++;

414 
Ær_pos
 = -1;

415 
i
 = 0; i < 
n_¢_Ëad”s
; i++) {

416 ià(
sbgp
->
¿nk_m­
[
i
] =ğ
Ær
) {

417 
Ær_pos
 = 
i
;

421 
	`ucc_as£¹
(
Ær_pos
 >= 0);

422 
sbgp
->
group_¿nk
 = 
¦_¿nk
;

423 ià(
Ær_pos
 > 0) {

424 ià(
¦_¿nk
 == 0)

425 
sbgp
->
group_¿nk
 = 
Ær_pos
;

426 ià(
¦_¿nk
 =ğ
Ær_pos
)

427 
sbgp
->
group_¿nk
 = 0;

428 
	`SWAP
(
sbgp
->
¿nk_m­
[
Ær_pos
], sbgp->rank_map[0], );

431 
sbgp
->
group_size
 = 
n_¢_Ëad”s
;

432 ià(
i_am_¢_Ëad”
) {

433 
sbgp
->
¡©us
 = 
UCC_SBGP_ENABLED
;

435 
sbgp
->
¡©us
 = 
UCC_SBGP_DISABLED
;

438 
sbgp
->
¡©us
 = 
UCC_SBGP_NOT_EXISTS
;

440 
	`ucc_ä“
(
¦_¬¿y
);

441  
UCC_OK
;

442 
	}
}

444 
šlše
 
ucc_¡©us_t
 
	$sbgp_ü—‹_fuÎ
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 *
sbgp
)

446 
sbgp
->
¡©us
 = 
UCC_SBGP_ENABLED
;

447 
sbgp
->
group_size
 = 
	`ucc_sub£t_size
(&
tİo
->
£t
);

448 
sbgp
->
group_¿nk
 = 
tİo
->
£t
.
my¿nk
;

449 
sbgp
->
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

450 
sbgp
->
m­
.
•_num
 = 
	`ucc_sub£t_size
(&
tİo
->
£t
);

452  
UCC_OK
;

453 
	}
}

455 
	s´oc_šfo_id
 {

456 
ucc_´oc_šfo_t
 
	mšfo
;

457 
ucc_¿nk_t
 
	mid
;

458 } 
	t´oc_šfo_id_t
;

460 
	$ucc_com·»_´oc_šfo_id
(cÚ¡ *
a
, cÚ¡ *
b
)

462 cÚ¡ 
ucc_´oc_šfo_t
 *
d1
 = &((cÚ¡ 
´oc_šfo_id_t
 *)
a
)->
šfo
;

463 cÚ¡ 
ucc_´oc_šfo_t
 *
d2
 = &((cÚ¡ 
´oc_šfo_id_t
 *)
b
)->
šfo
;

465 ià(
d1
->
ho¡_hash
 !ğ
d2
->host_hash) {

466  
d1
->
ho¡_hash
 > 
d2
->host_hash ? 1 : -1;

467 } ià(
d1
->
sock‘_id
 !ğ
d2
->socket_id) {

468  
d1
->
sock‘_id
 - 
d2
->socket_id;

469 } ià(
d1
->
numa_id
 !ğ
d2
->numa_id) {

470  
d1
->
numa_id
 - 
d2
->numa_id;

474 
	}
}

476 
ucc_¡©us_t
 
	$sbgp_ü—‹_fuÎ_Üd”ed
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 *
sbgp
)

478 
ucc_¿nk_t
 
gsize
 = 
	`ucc_sub£t_size
(&
tİo
->
£t
);

479 
ucc_´oc_šfo_t
 *
pšfo
 = 
tİo
->tİo->
´ocs
;

480 
ucc_ho¡_id_t
 *
vis™ed
;

481 
´oc_šfo_id_t
 *
sÜ‹d
;

482 
ucc_¿nk_t
 
i
, 
j
, 
num_vis™ed
;

483 
is_sÜ‹d
, 
d
;

485 
	`ucc_as£¹
(
gsize
 > 0);

486 
sbgp
->
¡©us
 = 
UCC_SBGP_ENABLED
;

487 
sbgp
->
group_size
 = 
gsize
;

488 
sbgp
->
group_¿nk
 = 
tİo
->
£t
.
my¿nk
;

489 
sbgp
->
¿nk_m­
 = 
	`ucc_m®loc
((
ucc_¿nk_t
è* 
gsize
, "rank_map");

490 ià(
	`ucc_uÆik–y
(!
sbgp
->
¿nk_m­
)) {

491 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for„ank_map",

492 
gsize
 * (
ucc_¿nk_t
));

493  
UCC_ERR_NO_MEMORY
;

496 
vis™ed
 = (
ucc_ho¡_id_t
 *)
	`ucc_m®loc
(
gsize
 * (ucc_host_id_t),

498 ià(
	`ucc_uÆik–y
(!
vis™ed
)) {

499 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for†ist of visited‚odes",

500 
gsize
 * (
ucc_ho¡_id_t
));

501 
	`ucc_ä“
(
sbgp
->
¿nk_m­
);

502  
UCC_ERR_NO_MEMORY
;

505 
is_sÜ‹d
 = 1;

506 
num_vis™ed
 = 1;

507 
vis™ed
[0] = 
pšfo
[0].
ho¡_hash
;

508 
i
 = 1; i < 
gsize
; i++) {

509 ià(
pšfo
[
i
].
ho¡_hash
 !=…info[i-1].host_hash) {

511 
j
 = 0; j < 
num_vis™ed
; j++) {

512 ià(
vis™ed
[
j
] =ğ
pšfo
[
i
].
ho¡_hash
) {

516 ià(
j
 < 
num_vis™ed
) {

518 
is_sÜ‹d
 = 0;

522 
vis™ed
[
num_vis™ed
++] = 
pšfo
[
i
].
ho¡_hash
;

524 
d
 = 
	`ucc_com·»_´oc_šfo_id
(&
pšfo
[
i
 - 1].
ho¡_hash
,

525 &
pšfo
[
i
].
ho¡_hash
);

527 ià(
d
 > 0) {

528 
is_sÜ‹d
 = 0;

533 
	`ucc_ä“
(
vis™ed
);

535 ià(
is_sÜ‹d
) {

536 
i
 = 0; i < 
gsize
; i++) {

537 
sbgp
->
¿nk_m­
[
i
] = i;

539  
UCC_OK
;

542 
sÜ‹d
 = (
´oc_šfo_id_t
 *)
	`ucc_m®loc
(
gsize
 * (proc_info_id_t),

544 ià(
	`ucc_uÆik–y
(!
sÜ‹d
)) {

545 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for sorted…roc info",

546 
gsize
 * (
´oc_šfo_id_t
));

547 
	`ucc_ä“
(
sbgp
->
¿nk_m­
);

548  
UCC_ERR_NO_MEMORY
;

551 
i
 = 0; i < 
gsize
; i++) {

552 
sÜ‹d
[
i
].
šfo
 = 
tİo
->tİo->
´ocs
[i];

553 
sÜ‹d
[
i
].
id
 = i;

556 
	`qsÜt
(
sÜ‹d
, 
gsize
, (
´oc_šfo_id_t
), 
ucc_com·»_´oc_šfo_id
);

557 
i
 = 0; i < 
gsize
; i++) {

558 ià(
sÜ‹d
[
i
].
id
 =ğ
tİo
->
£t
.
my¿nk
) {

559 
sbgp
->
group_¿nk
 = 
i
;

561 
sbgp
->
¿nk_m­
[
i
] = 
sÜ‹d
[i].
id
;

568 
	`ucc_ä“
(
sÜ‹d
);

569  
UCC_OK
;

570 
	}
}

572 
ucc_¡©us_t
 
	$ucc_sbgp_ü—‹
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_ty³_t
 
ty³
)

574 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

575 
ucc_sbgp_t
 * 
sbgp
 = &
tİo
->
sbgps
[
ty³
];

576 
¢_bound
 = 
	`UCC_TOPO_IS_BOUND
(
tİo
, 
ty³
);

578 
sbgp
->
ty³
 =ype;

579 
sbgp
->
¡©us
 = 
UCC_SBGP_NOT_EXISTS
;

580 
sbgp
->
¿nk_m­
 = 
NULL
;

581 
ty³
) {

582 
UCC_SBGP_NODE
:

583 
¡©us
 = 
	`ucc_sbgp_ü—‹_node
(
tİo
, 
sbgp
);

585 
UCC_SBGP_FULL
:

586 
¡©us
 = 
	`sbgp_ü—‹_fuÎ
(
tİo
, 
sbgp
);

588 
UCC_SBGP_FULL_HOST_ORDERED
:

589 
¡©us
 = 
	`sbgp_ü—‹_fuÎ_Üd”ed
(
tİo
, 
sbgp
);

591 
UCC_SBGP_SOCKET
:

592 
UCC_SBGP_NUMA
:

593 ià(!
¢_bound
) {

596 ià(
tİo
->
sbgps
[
UCC_SBGP_NODE
].
¡©us
 =ğ
UCC_SBGP_NOT_INIT
) {

597 
	`ucc_sbgp_ü—‹
(
tİo
, 
UCC_SBGP_NODE
);

599 ià(
tİo
->
sbgps
[
UCC_SBGP_NODE
].
¡©us
 =ğ
UCC_SBGP_ENABLED
) {

600 
¡©us
 = 
	`sbgp_ü—‹_¢
(
tİo
, 
sbgp
,İo->
£t
.
my¿nk
, 0);

603 
UCC_SBGP_NODE_LEADERS
:

604 
	`ucc_as£¹
(
UCC_SBGP_DISABLED
 !ğ
tİo
->
sbgps
[
UCC_SBGP_NODE
].
¡©us
);

605 
¡©us
 =

606 
	`sbgp_ü—‹_node_Ëad”s
(
tİo
, 
sbgp
,İo->
node_Ëad”_¿nk_id
);

608 
UCC_SBGP_NET
:

609 ià(
tİo
->
sbgps
[
UCC_SBGP_NODE
].
¡©us
 =ğ
UCC_SBGP_NOT_INIT
) {

610 
	`ucc_sbgp_ü—‹
(
tİo
, 
UCC_SBGP_NODE
);

612 
	`ucc_as£¹
(
UCC_SBGP_DISABLED
 !ğ
tİo
->
sbgps
[
UCC_SBGP_NODE
].
¡©us
);

613 
¡©us
 = 
	`sbgp_ü—‹_node_Ëad”s
(

614 
tİo
, 
sbgp
,İo->
sbgps
[
UCC_SBGP_NODE
].
group_¿nk
);

616 
UCC_SBGP_SOCKET_LEADERS
:

617 
UCC_SBGP_NUMA_LEADERS
:

618 ià(!
¢_bound
) {

621 ià(
tİo
->
sbgps
[
UCC_SBGP_NODE
].
¡©us
 =ğ
UCC_SBGP_NOT_INIT
) {

622 
	`ucc_sbgp_ü—‹
(
tİo
, 
UCC_SBGP_NODE
);

624 ià(
tİo
->
sbgps
[
UCC_SBGP_NODE
].
¡©us
 =ğ
UCC_SBGP_ENABLED
) {

625 
¡©us
 = 
	`sbgp_ü—‹_¢_Ëad”s
(
tİo
, 
sbgp
);

629 
¡©us
 = 
UCC_ERR_NOT_IMPLEMENTED
;

632 ià(
sbgp
->
¿nk_m­
 && sbgp->
ty³
 !ğ
UCC_SBGP_FULL
) {

633 
sbgp
->
m­
 = 
	`ucc_•_m­_äom_¬¿y
(&sbgp->
¿nk_m­
, sbgp->
group_size
,

634 
	`ucc_sub£t_size
(&
tİo
->
£t
), 1);

636 ià(
sbgp
->
¿nk_m­
 && sbgp->
¡©us
 =ğ
UCC_SBGP_NOT_EXISTS
) {

637 
	`ucc_ä“
(
sbgp
->
¿nk_m­
);

639  
¡©us
;

640 
	}
}

642 
ucc_¡©us_t
 
	$ucc_sbgp_ş—nup
(
ucc_sbgp_t
 *
sbgp
)

644 ià(
sbgp
->
¿nk_m­
) {

645 
	`ucc_ä“
(
sbgp
->
¿nk_m­
);

646 
sbgp
->
¿nk_m­
 = 
NULL
;

648  
UCC_OK
;

649 
	}
}

651 
	$ucc_sbgp_´št
(
ucc_sbgp_t
 *
sbgp
)

653 
i
;

654 ià(
sbgp
->
group_¿nk
 =ğ0 && sbgp->
¡©us
 =ğ
UCC_SBGP_ENABLED
) {

655 
	`´štf
("sbgp: %15s: group_size %4d,eam_ranks=[ ",

656 
	`ucc_sbgp_¡r
(
sbgp
->
ty³
), sbgp->
group_size
);

657 
i
 = 0; i < 
sbgp
->
group_size
; i++) {

658 
	`´štf
("%d ", 
sbgp
->
¿nk_m­
[
i
]);

660 
	`´štf
("]");

661 
	`´štf
("\n");

663 
	}
}

665 
ucc_¡©us_t
 
	$ucc_sbgp_ü—‹_®l_¢s
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
_sbgps
,

666 *
n_sbgps
, 
ucc_sbgp_ty³_t
 
ty³
)

668 
¢_bound
 = 
	`UCC_TOPO_IS_BOUND
(
tİo
, 
ty³
);

669 
ucc_sbgp_t
 *
sbgps
;

670 
ucc_sbgp_t
 * 
¢_Ëad”s_sbgp
;

671 
n_¢_groups
, 
i
;

672 
ucc_¿nk_t
 
¦_¿nk
;

673 
ucc_¡©us_t
 
¡©us
;

675 ià(!
¢_bound
) {

676  
UCC_ERR_NOT_FOUND
;

679 
¢_Ëad”s_sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, (
UCC_SBGP_SOCKET
 =ğ
ty³
)

680 ? 
UCC_SBGP_SOCKET_LEADERS


681 : 
UCC_SBGP_NUMA_LEADERS
);

682 
n_¢_groups
 = (
UCC_SBGP_SOCKET
 =ğ
ty³
è? 
tİo
->
n_sock‘s
 :İo->
n_numas
;

683 
	`ucc_as£¹
(
n_¢_groups
 >= 1);

685 ià(
tİo
->
sbgps
[
UCC_SBGP_NODE
].
¡©us
 !ğ
UCC_SBGP_ENABLED
 ||

686 
tİo
->
sbgps
[
UCC_SBGP_NODE
].
group_size
 < 1) {

688  
UCC_ERR_NOT_FOUND
;

691 
sbgps
 = 
	`ucc_ÿÎoc
(
n_¢_groups
, (
ucc_sbgp_t
), "sn_sbgps");

692 ià(!
sbgps
) {

693  
UCC_ERR_NO_MEMORY
;

696 
i
 = 0; i < 
n_¢_groups
; i++) {

697 
sbgps
[
i
].
ty³
 =ype;

698 
¦_¿nk
 = (
n_¢_groups
 > 1)

699 ? 
	`ucc_•_m­_ev®
(
¢_Ëad”s_sbgp
->
m­
, 
i
)

700 : 
	`ucc_•_m­_ev®
(
tİo
->
sbgps
[
UCC_SBGP_NODE
].
m­
, 0);

701 
¡©us
 = 
	`sbgp_ü—‹_¢
(
tİo
, &
sbgps
[
i
], 
¦_¿nk
, 1);

702 ià(
UCC_OK
 !ğ
¡©us
) {

703 
	`ucc_”rÜ
("çedØü—‹ sock‘ sbg°fÜ sl_¿nk %d:%u", 
i
,

704 
¦_¿nk
);

705 
”rÜ
;

707 ià(
sbgps
[
i
].
¿nk_m­
) {

708 
sbgps
[
i
].
m­
 =

709 
	`ucc_•_m­_äom_¬¿y
(&
sbgps
[
i
].
¿nk_m­
, sbgps[i].
group_size
,

710 
	`ucc_sub£t_size
(&
tİo
->
£t
), 1);

713 *
_sbgps
 = 
sbgps
;

714 *
n_sbgps
 = 
n_¢_groups
;

715  
UCC_OK
;

716 
”rÜ
:

717 
	`ucc_ä“
(
sbgps
);

718  
¡©us
;

719 
	}
}

721 
ucc_¡©us_t
 
	$ucc_sbgp_ü—‹_®l_sock‘s
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

722 *
n_sbgps
)

724  
	`ucc_sbgp_ü—‹_®l_¢s
(
tİo
, 
sbgps
, 
n_sbgps
, 
UCC_SBGP_SOCKET
);

725 
	}
}

727 
ucc_¡©us_t
 
	$ucc_sbgp_ü—‹_®l_numas
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

728 *
n_sbgps
)

730  
	`ucc_sbgp_ü—‹_®l_¢s
(
tİo
, 
sbgps
, 
n_sbgps
, 
UCC_SBGP_NUMA
);

731 
	}
}

	@src/components/topo/ucc_sbgp.h

5 #iâdeà
UCC_SBGP_H_


6 
	#UCC_SBGP_H_


	)

7 
	~"ucc/­i/ucc.h
"

8 
	~"uts/ucc_d©a¡ruù.h
"

9 
	~"uts/ucc_cŞl_uts.h
"

11 
	eucc_sbgp_ty³_t


13 
	mUCC_SBGP_NUMA
,

16 
	mUCC_SBGP_SOCKET
,

19 
	mUCC_SBGP_NODE
,

20 
	mUCC_SBGP_NODE_LEADERS
,

25 
	mUCC_SBGP_NET
,

30 
	mUCC_SBGP_SOCKET_LEADERS
,

35 
	mUCC_SBGP_NUMA_LEADERS
,

36 
	mUCC_SBGP_FULL
,

37 
	mUCC_SBGP_FULL_HOST_ORDERED
,

39 
	mUCC_SBGP_LAST


40 } 
	tucc_sbgp_ty³_t
;

42 
	eucc_sbgp_¡©us_t


44 
	mUCC_SBGP_NOT_INIT
,

45 
	mUCC_SBGP_DISABLED
,

46 
	mUCC_SBGP_ENABLED
,

47 
	mUCC_SBGP_NOT_EXISTS
,

48 } 
	tucc_sbgp_¡©us_t
;

50 
ucc_tİo
 
	tucc_tİo_t
;

51 
	succ_sbgp_t
 {

52 
ucc_sbgp_ty³_t
 
	mty³
;

53 
ucc_sbgp_¡©us_t
 
	m¡©us
;

54 
ucc_¿nk_t
 
	mgroup_size
;

55 
ucc_¿nk_t
 
	mgroup_¿nk
;

56 
ucc_¿nk_t
 *
	m¿nk_m­
;

57 
ucc_•_m­_t
 
	mm­
;

58 } 
	tucc_sbgp_t
;

60 cÚ¡ * 
ucc_sbgp_¡r
(
ucc_sbgp_ty³_t
 
ty³
);

76 
ucc_¡©us_t
 
ucc_sbgp_ü—‹
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_ty³_t
 
ty³
);

78 
ucc_¡©us_t
 
ucc_sbgp_ş—nup
(
ucc_sbgp_t
 *
sbgp
);

83 
ucc_¡©us_t
 
ucc_sbgp_ü—‹_®l_sock‘s
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

84 *
n_sbgps
);

86 
ucc_¡©us_t
 
ucc_sbgp_ü—‹_®l_numas
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

87 *
n_sbgps
);

89 
ucc_¡©us_t
 
ucc_sbgp_ü—‹_node
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 *
sbgp
);

91 
šlše
 
ucc_sub£t_t
 
	$ucc_sbgp_to_sub£t
(
ucc_sbgp_t
 *
sbgp
)

93 
ucc_sub£t_t
 
s
 = {

94 .
m­
 = 
sbgp
->map,

95 .
my¿nk
 = 
sbgp
->
group_¿nk


97  
s
;

98 
	}
}

100 
ucc_sbgp_´št
(
ucc_sbgp_t
 *
sbgp
);

	@src/components/topo/ucc_topo.c

7 
	~"cÚfig.h
"

8 
	~"ucc_tİo.h
"

9 
	~"cÜe/ucc_cÚ‹xt.h
"

10 
	~"uts/ucc_m®loc.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	~<¡ršg.h
>

13 
	~<lim™s.h
>

15 
	$ucc_com·»_´oc_šfo
(cÚ¡ *
a
, cÚ¡ *
b
)

17 cÚ¡ 
ucc_´oc_šfo_t
 *
d1
 = (cÚ¡ ucc_´oc_šfo_ˆ*)
a
;

18 cÚ¡ 
ucc_´oc_šfo_t
 *
d2
 = (cÚ¡ ucc_´oc_šfo_ˆ*)
b
;

20 ià(
d1
->
ho¡_hash
 !ğ
d2
->host_hash) {

21  
d1
->
ho¡_hash
 > 
d2
->host_hash ? 1 : -1;

22 } ià(
d1
->
sock‘_id
 !ğ
d2
->socket_id) {

23  
d1
->
sock‘_id
 - 
d2
->socket_id;

24 } ià(
d1
->
numa_id
 !ğ
d2
->numa_id) {

25  
d1
->
numa_id
 - 
d2
->numa_id;

27  
d1
->
pid
 - 
d2
->pid;

29 
	}
}

31 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_tİo_compu‹_Ïyout
(
ucc_cÚ‹xt_tİo_t
 *
tİo
,

32 
ucc_¿nk_t
 
size
)

34 
ucc_¿nk_t
 
cu¼’t_µn
 = 1;

35 
ucc_¿nk_t
 
mš_µn
 = 
UCC_RANK_MAX
;

36 
ucc_¿nk_t
 
max_µn
 = 0;

37 
ucc_¿nk_t
 
Âodes
 = 1;

38 
max_sockid
 = 0;

39 
max_numaid
 = 0;

40 
ucc_´oc_šfo_t
 *
sÜ‹d
;

41 
ucc_ho¡_id_t
 
cu¼’t_hash
, 
hash
;

42 
i
, 
j
;

44 
sÜ‹d
 = (
ucc_´oc_šfo_t
 *)
	`ucc_m®loc
(
size
 * (ucc_proc_info_t),

46 ià(!
sÜ‹d
) {

47 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for…roc sorted",

48 
size
 * (
ucc_´oc_šfo_t
));

49  
UCC_ERR_NO_MEMORY
;

51 
	`memıy
(
sÜ‹d
, 
tİo
->
´ocs
, 
size
 * (
ucc_´oc_šfo_t
));

52 
	`qsÜt
(
sÜ‹d
, 
size
, (
ucc_´oc_šfo_t
), 
ucc_com·»_´oc_šfo
);

53 
cu¼’t_hash
 = 
sÜ‹d
[0].
ho¡_hash
;

55 
i
 = 1; i < 
size
; i++) {

56 
hash
 = 
sÜ‹d
[
i
].
ho¡_hash
;

57 ià(
hash
 !ğ
cu¼’t_hash
) {

58 
j
 = 0; j < 
size
; j++) {

59 ià(
tİo
->
´ocs
[
j
].
ho¡_hash
 =ğ
cu¼’t_hash
) {

60 
tİo
->
´ocs
[
j
].
ho¡_id
 = 
Âodes
 - 1;

63 ià(
cu¼’t_µn
 > 
max_µn
)

64 
max_µn
 = 
cu¼’t_µn
;

65 ià(
cu¼’t_µn
 < 
mš_µn
)

66 
mš_µn
 = 
cu¼’t_µn
;

67 
Âodes
++;

68 
cu¼’t_hash
 = 
hash
;

69 
cu¼’t_µn
 = 1;

71 
cu¼’t_µn
++;

74 
j
 = 0; j < 
size
; j++) {

75 ià(
tİo
->
´ocs
[
j
].
sock‘_id
 > 
max_sockid
) {

76 
max_sockid
 = 
tİo
->
´ocs
[
j
].
sock‘_id
;

78 ià(
tİo
->
´ocs
[
j
].
numa_id
 > 
max_numaid
) {

79 
max_numaid
 = 
tİo
->
´ocs
[
j
].
numa_id
;

81 ià(
tİo
->
´ocs
[
j
].
ho¡_hash
 =ğ
cu¼’t_hash
) {

82 
tİo
->
´ocs
[
j
].
ho¡_id
 = 
Âodes
 - 1;

86 ià(
cu¼’t_µn
 > 
max_µn
) {

87 
max_µn
 = 
cu¼’t_µn
;

89 ià(
cu¼’t_µn
 < 
mš_µn
) {

90 
mš_µn
 = 
cu¼’t_µn
;

93 
	`ucc_ä“
(
sÜ‹d
);

95 
tİo
->
Âodes
 =‚nodes;

96 
tİo
->
mš_µn
 = min_ppn;

97 
tİo
->
max_µn
 = max_ppn;

98 
tİo
->
max_n_sock‘s
 = 
max_sockid
 + 1;

99 
tİo
->
max_n_numas
 = 
max_numaid
 + 1;

100  
UCC_OK
;

101 
	}
}

103 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_tİo_š™
(
ucc_addr_¡Üage_t
 * 
¡Üage
,

104 
ucc_cÚ‹xt_tİo_t
 **
_tİo
)

106 
ucc_cÚ‹xt_addr_h—d”_t
 *
h
;

107 
ucc_cÚ‹xt_tİo_t
 *
tİo
;

108 
i
;

109 
ucc_¡©us_t
 
¡©us
;

111 ià(
¡Üage
->
size
 < 2) {

113  
UCC_ERR_NO_MESSAGE
;

116 
tİo
 = 
	`ucc_m®loc
((*topo), "topo");

117 ià(!
tİo
) {

118 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜİo", (*
tİo
));

119  
UCC_ERR_NO_MEMORY
;

122 
tİo
->
sock_bound
 = 1;

123 
tİo
->
numa_bound
 = 1;

124 
tİo
->
n_´ocs
 = 
¡Üage
->
size
;

125 
tİo
->
´ocs
 = (
ucc_´oc_šfo_t
 *)
	`ucc_m®loc
(

126 
¡Üage
->
size
 * (
ucc_´oc_šfo_t
), "topo_procs");

127 ià(!
tİo
->
´ocs
) {

128 
	`ucc_”rÜ
("failedo‡llocate %zd bytes foropo_procs",

129 
¡Üage
->
size
 * (
ucc_´oc_šfo_t
));

130 
	`ucc_ä“
(
tİo
);

131  
UCC_ERR_NO_MEMORY
;

133 
i
 = 0; i < 
¡Üage
->
size
; i++) {

134 
h
 = (
ucc_cÚ‹xt_addr_h—d”_t
 *)
	`PTR_OFFSET
(
¡Üage
->storage,

135 
¡Üage
->
addr_Ën
 * 
i
);

136 
tİo
->
´ocs
[
i
] = 
h
->
ùx_id
.
pi
;

137 ià(
h
->
ùx_id
.
pi
.
sock‘_id
 =ğ
UCC_SOCKET_ID_INVALID
) {

138 
tİo
->
sock_bound
 = 0;

140 ià(
h
->
ùx_id
.
pi
.
numa_id
 =ğ
UCC_NUMA_ID_INVALID
) {

141 
tİo
->
numa_bound
 = 0;

144 
¡©us
 = 
	`ucc_cÚ‹xt_tİo_compu‹_Ïyout
(
tİo
, 
¡Üage
->
size
);

145 ià(
UCC_OK
 !ğ
¡©us
) {

146 
	`ucc_ä“
(
tİo
->
´ocs
);

147 
	`ucc_ä“
(
tİo
);

148  
¡©us
;

151 *
_tİo
 = 
tİo
;

152  
UCC_OK
;

153 
	}
}

155 
	$ucc_cÚ‹xt_tİo_ş—nup
(
ucc_cÚ‹xt_tİo_t
 *
tİo
)

157 ià(
tİo
) {

158 
	`ucc_ä“
(
tİo
->
´ocs
);

159 
	`ucc_ä“
(
tİo
);

161 
	}
}

163 
ucc_¡©us_t
 
	$ucc_tİo_š™
(
ucc_sub£t_t
 
£t
, 
ucc_cÚ‹xt_tİo_t
 *
ùx_tİo
,

164 
ucc_tİo_t
 **
_tİo
)

166 
ucc_tİo_t
 *
tİo
 = 
	`ucc_m®loc
((*topo), "topo");

167 
i
;

168 ià(!
tİo
) {

169  
UCC_ERR_NO_MEMORY
;

171 
tİo
->tİØğ
ùx_tİo
;

172 
i
 = 0; i < 
UCC_SBGP_LAST
; i++) {

173 
tİo
->
sbgps
[
i
].
¡©us
 = 
UCC_SBGP_NOT_INIT
;

175 
tİo
->
n_sock‘s
 = -1;

176 
tİo
->
node_Ëad”_¿nk
 = 
UCC_RANK_INVALID
;

177 
tİo
->
node_Ëad”_¿nk_id
 = 0;

178 
tİo
->
£t
 = set;

179 
tİo
->
mš_µn
 = 
UCC_RANK_MAX
;

180 
tİo
->
max_µn
 = 0;

181 
tİo
->
mš_sock‘_size
 = 
UCC_RANK_MAX
;

182 
tİo
->
max_sock‘_size
 = 0;

183 
tİo
->
mš_numa_size
 = 
UCC_RANK_MAX
;

184 
tİo
->
max_numa_size
 = 0;

185 
tİo
->
®l_sock‘s
 = 
NULL
;

186 
tİo
->
®l_numas
 = 
NULL
;

187 
tİo
->
®l_nodes
 = 
NULL
;

188 
tİo
->
node_Ëad”s
 = 
NULL
;

190 *
_tİo
 = 
tİo
;

191  
UCC_OK
;

192 
	}
}

194 
	$ucc_tİo_ş—nup
(
ucc_tİo_t
 *
tİo
)

196 
i
;

197 ià(
tİo
) {

198 
i
 = 0; i < 
UCC_SBGP_LAST
; i++) {

199 ià(
tİo
->
sbgps
[
i
].
¡©us
 =ğ
UCC_SBGP_ENABLED
 ||

200 
tİo
->
sbgps
[
i
].
¡©us
 =ğ
UCC_SBGP_DISABLED
) {

201 
	`ucc_sbgp_ş—nup
(&
tİo
->
sbgps
[
i
]);

204 ià(
tİo
->
®l_sock‘s
) {

205 
i
 = 0; i < 
tİo
->
n_sock‘s
; i++) {

206 ià(
tİo
->
®l_sock‘s
[
i
].
¡©us
 =ğ
UCC_SBGP_ENABLED
) {

207 
	`ucc_sbgp_ş—nup
(&
tİo
->
®l_sock‘s
[
i
]);

210 
	`ucc_ä“
(
tİo
->
®l_sock‘s
);

212 ià(
tİo
->
®l_numas
) {

213 
i
 = 0; i < 
tİo
->
n_numas
; i++) {

214 ià(
tİo
->
®l_numas
[
i
].
¡©us
 =ğ
UCC_SBGP_ENABLED
) {

215 
	`ucc_sbgp_ş—nup
(&
tİo
->
®l_numas
[
i
]);

218 
	`ucc_ä“
(
tİo
->
®l_numas
);

220 ià(
tİo
->
®l_nodes
) {

221 
i
 = 0; i < 
tİo
->
n_nodes
; i++) {

222 ià(
tİo
->
®l_nodes
[
i
].
¡©us
 =ğ
UCC_SBGP_ENABLED
) {

223 
	`ucc_sbgp_ş—nup
(&
tİo
->
®l_nodes
[
i
]);

226 
	`ucc_ä“
(
tİo
->
®l_nodes
);

228 ià(
tİo
->
node_Ëad”s
) {

229 
	`ucc_ä“
(
tİo
->
node_Ëad”s
);

231 
	`ucc_ä“
(
tİo
);

233 
	}
}

235 
ucc_sbgp_t
 *
	$ucc_tİo_g‘_sbgp
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_ty³_t
 
ty³
)

237 ià(
tİo
->
sbgps
[
ty³
].
¡©us
 =ğ
UCC_SBGP_NOT_INIT
) {

238 ià(
UCC_OK
 !ğ
	`ucc_sbgp_ü—‹
(
tİo
, 
ty³
)) {

239 
	`ucc_”rÜ
("çedØü—‹ sbg°%s", 
	`ucc_sbgp_¡r
(
ty³
));

243  &
tİo
->
sbgps
[
ty³
];

244 
	}
}

246 
	$ucc_tİo_is_sšgË_node
(
ucc_tİo_t
 *
tİo
)

248 
ucc_sbgp_t
 *
sbgp
;

250 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

251 ià(
UCC_SBGP_ENABLED
 =ğ
sbgp
->
¡©us
 &&

252 
sbgp
->
group_size
 =ğ
	`ucc_sub£t_size
(&
tİo
->
£t
)) {

256 
	}
}

258 
ucc_¡©us_t
 
	$ucc_tİo_g‘_®l_sock‘s
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

259 *
n_sbgps
)

261 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

263 ià(!
tİo
->
®l_sock‘s
) {

264 
¡©us
 = 
	`ucc_sbgp_ü—‹_®l_sock‘s
(
tİo
, &tİo->
®l_sock‘s
, 
n_sbgps
);

267 *
sbgps
 = 
tİo
->
®l_sock‘s
;

268 *
n_sbgps
 = 
tİo
->
n_sock‘s
;

270  
¡©us
;

271 
	}
}

273 
ucc_¡©us_t
 
	$ucc_tİo_g‘_®l_numas
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

274 *
n_sbgps
)

276 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

278 ià(!
tİo
->
®l_numas
) {

279 
¡©us
 = 
	`ucc_sbgp_ü—‹_®l_numas
(
tİo
, &tİo->
®l_numas
, 
n_sbgps
);

282 *
sbgps
 = 
tİo
->
®l_numas
;

283 *
n_sbgps
 = 
tİo
->
n_numas
;

285  
¡©us
;

286 
	}
}

291 
ucc_¡©us_t
 
	$ucc_sbgp_ü—‹_®l_nodes
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
_sbgps
,

292 *
n_sbgps
)

294 
ucc_¿nk_t
 
my¿nk
 = 
tİo
->
£t
.myrank;

295 
ucc_¿nk_t
 
Ëad”_¿nk
 = 
UCC_RANK_INVALID
;

296 
ucc_sbgp_t
 *
sbgps
, *
Ëad”_sbgp
;

297 
ucc_¿nk_t
 
i
;

298 
ucc_¡©us_t
 
¡©us
;

299 
ucc_¿nk_t
 
Âodes
;

301 
Ëad”_sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

303 ià(
Ëad”_sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_INIT
 ||

304 
Ëad”_sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_EXISTS
) {

305 
	`ucc_debug
("could‚ot create‡ll_nodes subgroups,†eader subgroup "

307  
UCC_ERR_INVALID_PARAM
;

310 
Âodes
 = 
Ëad”_sbgp
->
group_size
;

312 
sbgps
 = 
	`ucc_ÿÎoc
(
Âodes
, (
ucc_sbgp_t
), "sbgps");

313 ià(!
sbgps
) {

314 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for sbgps‡rray",

315 
Âodes
 * (
ucc_sbgp_t
));

316  
UCC_ERR_NO_MEMORY
;

319 
i
 = 0; i < 
Âodes
; i++) {

320 
ucc_¿nk_t
 
ldr_‹am_¿nk
 = 
	`ucc_•_m­_ev®
(
Ëad”_sbgp
->
m­
, 
i
);

321 
tİo
->
£t
.
my¿nk
 = 
ldr_‹am_¿nk
;

322 ià(
	`ucc_¿nk_Ú_loÿl_node
(
my¿nk
, 
tİo
)) {

323 
Ëad”_¿nk
 = 
tİo
->
node_Ëad”_¿nk
;

325 
¡©us
 = 
	`ucc_sbgp_ü—‹_node
(
tİo
, &
sbgps
[
i
]);

326 ià(
¡©us
 =ğ
UCC_ERR_NOT_FOUND
) {

328 
sbgps
[
i
].
¡©us
 = 
UCC_SBGP_NOT_EXISTS
;

330 } ià(
¡©us
 !ğ
UCC_OK
) {

331 
	`ucc_”rÜ
("çedØü—‹‡Î_nodsubgrou°%d", 
i
);

332 
”rÜ
;

334 ià(
sbgps
[
i
].
¿nk_m­
 && sbgps[i].
ty³
 !ğ
UCC_SBGP_FULL
) {

335 
sbgps
[
i
].
m­
 = 
	`ucc_•_m­_äom_¬¿y
(

336 &
sbgps
[
i
].
¿nk_m­
, sbgps[i].
group_size
,

337 
	`ucc_sub£t_size
(&
tİo
->
£t
), 1);

339 ià(
sbgps
[
i
].
¿nk_m­
 && sbgps[i].
¡©us
 =ğ
UCC_SBGP_NOT_EXISTS
) {

340 
	`ucc_ä“
(
sbgps
[
i
].
¿nk_m­
);

346 
tİo
->
£t
.
my¿nk
 = myrank;

347 
	`ucc_as£¹
(
Ëad”_¿nk
 !ğ
UCC_RANK_INVALID
);

348 
tİo
->
node_Ëad”_¿nk
 = 
Ëad”_¿nk
;

350 *
_sbgps
 = 
sbgps
;

351 *
n_sbgps
 = 
Âodes
;

353  
UCC_OK
;

354 
”rÜ
:

355 
tİo
->
£t
.
my¿nk
 = myrank;

356 
i
 = 0; i < 
Âodes
; i++) {

357 ià(
sbgps
[
i
].
¿nk_m­
) {

358 
	`ucc_ä“
(
sbgps
[
i
].
¿nk_m­
);

361 
	`ucc_ä“
(
sbgps
);

362  
¡©us
;

363 
	}
}

365 
ucc_¡©us_t
 
	$ucc_tİo_g‘_®l_nodes
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

366 *
n_sbgps
)

368 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

370 ià(!
tİo
->
®l_nodes
) {

371 
¡©us
 = 
	`ucc_sbgp_ü—‹_®l_nodes
(
tİo
, &tİo->
®l_nodes
, &tİo->
n_nodes
);

374 *
sbgps
 = 
tİo
->
®l_nodes
;

375 *
n_sbgps
 = 
tİo
->
n_nodes
;

377  
¡©us
;

378 
	}
}

380 
ucc_¡©us_t
 
	$ucc_tİo_g‘_node_Ëad”s
(
ucc_tİo_t
 *
tİo
, 
ucc_¿nk_t
 **
node_Ëad”s_out
)

382 
ucc_sub£t_t
 *
£t
 = &
tİo
->set;

383 
ucc_¿nk_t
 
size
 = 
	`ucc_sub£t_size
(
£t
);

384 
ucc_¿nk_t
 
Âodes
 = 
tİo
->topo->nnodes;

385 
ucc_¿nk_t
 
i
;

386 
ucc_¿nk_t
 *
¿nks_£’_³r_node
;

387 
ucc_¿nk_t
 *
³r_node_Ëad”s
;

388 
ucc_¿nk_t
 *
node_Ëad”s
;

390 ià(
tİo
->
node_Ëad”s
) {

391 *
node_Ëad”s_out
 = 
tİo
->
node_Ëad”s
;

392  
UCC_OK
;

395 
	`ucc_as£¹
(
Âodes
 > 1);

398 
node_Ëad”s
 = 
	`ucc_m®loc
((
ucc_¿nk_t
è* 
size
, "node_leaders");

399 ià(!
node_Ëad”s
) {

400 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for‚ode_leaders‡rray",

401 
size
 * (
ucc_¿nk_t
));

402  
UCC_ERR_NO_MEMORY
;

405 
¿nks_£’_³r_node
 = 
	`ucc_ÿÎoc
(
Âodes
, (
ucc_¿nk_t
), "ranks_seen_per_node");

406 ià(!
¿nks_£’_³r_node
) {

407 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for„anks_seen_per_node‡rray",

408 
Âodes
 * (
ucc_¿nk_t
));

409 
	`ucc_ä“
(
node_Ëad”s
);

410  
UCC_ERR_NO_MEMORY
;

413 
³r_node_Ëad”s
 = 
	`ucc_ÿÎoc
(
Âodes
, (
ucc_¿nk_t
), "per_node_leaders");

414 ià(!
³r_node_Ëad”s
) {

415 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for…er_node_leaders‡rray",

416 
Âodes
 * (
ucc_¿nk_t
));

417 
	`ucc_ä“
(
node_Ëad”s
);

418 
	`ucc_ä“
(
¿nks_£’_³r_node
);

419  
UCC_ERR_NO_MEMORY
;

423 
i
 = 0; i < 
size
; i++) {

424 
ucc_¿nk_t
 
ùx_¿nk
 = 
	`ucc_•_m­_ev®
(
£t
->
m­
, 
i
);

425 
ucc_ho¡_id_t
 
cu¼’t_ho¡
 = 
tİo
->tİo->
´ocs
[
ùx_¿nk
].
ho¡_id
;

428 
¿nks_£’_³r_node
[
cu¼’t_ho¡
]++;

431 ià(
¿nks_£’_³r_node
[
cu¼’t_ho¡
] =ğ
tİo
->
node_Ëad”_¿nk_id
 + 1) {

432 
³r_node_Ëad”s
[
cu¼’t_ho¡
] = 
i
;

437 
i
 = 0; i < 
size
; i++) {

438 
ucc_¿nk_t
 
ùx_¿nk
 = 
	`ucc_•_m­_ev®
(
£t
->
m­
, 
i
);

439 
ucc_ho¡_id_t
 
cu¼’t_ho¡
 = 
tİo
->tİo->
´ocs
[
ùx_¿nk
].
ho¡_id
;

441 
node_Ëad”s
[
i
] = 
³r_node_Ëad”s
[
cu¼’t_ho¡
];

444 
tİo
->
node_Ëad”s
 =‚ode_leaders;

446 *
node_Ëad”s_out
 = 
node_Ëad”s
;

447 
	`ucc_ä“
(
¿nks_£’_³r_node
);

448 
	`ucc_ä“
(
³r_node_Ëad”s
);

449  
UCC_OK
;

450 
	}
}

	@src/components/topo/ucc_topo.h

5 #iâdeà
UCC_TOPO_H_


6 
	#UCC_TOPO_H_


	)

7 
	~"ucc_sbgp.h
"

8 
	~"uts/ucc_´oc_šfo.h
"

16 
	succ_cÚ‹xt_tİo
 {

17 
ucc_´oc_šfo_t
 *
	m´ocs
;

18 
ucc_¿nk_t
 
	mn_´ocs
;

19 
ucc_¿nk_t
 
	mÂodes
;

20 
ucc_¿nk_t
 
	mmš_µn
;

23 
ucc_¿nk_t
 
	mmax_µn
;

24 
ucc_¿nk_t
 
	mmax_n_sock‘s
;

26 
ušt32_t
 
	msock_bound
;

28 
ucc_¿nk_t
 
	mmax_n_numas
;

30 
ušt32_t
 
	mnuma_bound
;

32 } 
	tucc_cÚ‹xt_tİo_t
;

34 
ucc_addr_¡Üage
 
	tucc_addr_¡Üage_t
;

46 
	succ_tİo
 {

47 
ucc_cÚ‹xt_tİo_t
 *
	mtİo
;

48 
ucc_sbgp_t
 
	msbgps
[
UCC_SBGP_LAST
];

49 
ucc_sbgp_t
 *
	m®l_sock‘s
;

50 
	mn_sock‘s
;

51 
ucc_sbgp_t
 *
	m®l_numas
;

52 
	mn_numas
;

53 
ucc_sbgp_t
 *
	m®l_nodes
;

54 
	mn_nodes
;

55 
ucc_¿nk_t
 
	mnode_Ëad”_¿nk_id
;

59 
ucc_¿nk_t
 
	mnode_Ëad”_¿nk
;

61 
ucc_¿nk_t
 *
	mnode_Ëad”s
;

63 
ucc_sub£t_t
 
	m£t
;

65 
ucc_¿nk_t
 
	mmš_µn
;

66 
ucc_¿nk_t
 
	mmax_µn
;

67 
ucc_¿nk_t
 
	mmš_sock‘_size
;

69 
ucc_¿nk_t
 
	mmax_sock‘_size
;

71 
ucc_¿nk_t
 
	mmš_numa_size
;

73 
ucc_¿nk_t
 
	mmax_numa_size
;

75 } 
	tucc_tİo_t
;

82 
ucc_¡©us_t
 
ucc_cÚ‹xt_tİo_š™
(
ucc_addr_¡Üage_t
 * 
¡Üage
,

83 
ucc_cÚ‹xt_tİo_t
 **
tİo
);

84 
ucc_cÚ‹xt_tİo_ş—nup
(
ucc_cÚ‹xt_tİo_t
 *
tİo
);

87 
ucc_¡©us_t
 
ucc_tİo_š™
(
ucc_sub£t_t
 
£t
, 
ucc_cÚ‹xt_tİo_t
 *
tİo
,

88 
ucc_tİo_t
 **
sub£t_tİo
);

89 
ucc_tİo_ş—nup
(
ucc_tİo_t
 *
sub£t_tİo
);

91 
ucc_sbgp_t
 *
ucc_tİo_g‘_sbgp
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_ty³_t
 
ty³
);

93 
ucc_tİo_is_sšgË_node
(
ucc_tİo_t
 *
tİo
);

95 
ucc_¡©us_t
 
ucc_tİo_g‘_®l_sock‘s
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

96 *
n_sbgps
);

99 
ucc_¡©us_t
 
ucc_tİo_g‘_®l_numas
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

100 *
n_sbgps
);

103 
ucc_¡©us_t
 
ucc_tİo_g‘_®l_nodes
(
ucc_tİo_t
 *
tİo
, 
ucc_sbgp_t
 **
sbgps
,

104 *
n_sbgps
);

106 
šlše
 
	$ucc_¿nk_Ú_loÿl_node
(
ucc_¿nk_t
 
‹am_¿nk
, 
ucc_tİo_t
 *
tİo
)

108 
ucc_´oc_šfo_t
 *
´ocs
 = 
tİo
->topo->procs;

109 
ucc_¿nk_t
 
ùx_¿nk
 = 
	`ucc_•_m­_ev®
(
tİo
->
£t
.
m­
, 
‹am_¿nk
);

110 
ucc_¿nk_t
 
my_ùx_¿nk
 = 
	`ucc_•_m­_ev®
(
tİo
->
£t
.
m­
,İo->£t.
my¿nk
);

112  
´ocs
[
ùx_¿nk
].
ho¡_hash
 =ğ´ocs[
my_ùx_¿nk
].host_hash;

113 
	}
}

116 
šlše
 
ucc_¿nk_t
 
	$ucc_tİo_mš_µn
(
ucc_tİo_t
 *
tİo
)

118 
ucc_sbgp_t
 *
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

120 ià(
sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_EXISTS
) {

121 
	`ucc_as£¹
(
	`ucc_tİo_is_sšgË_node
(
tİo
));

122  
	`ucc_sub£t_size
(&
tİo
->
£t
);

124  
tİo
->
mš_µn
;

125 
	}
}

128 
šlše
 
ucc_¿nk_t
 
	$ucc_tİo_max_µn
(
ucc_tİo_t
 *
tİo
)

130 
ucc_sbgp_t
 *
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

132 ià(
sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_EXISTS
) {

133 
	`ucc_as£¹
(
	`ucc_tİo_is_sšgË_node
(
tİo
));

134  
	`ucc_sub£t_size
(&
tİo
->
£t
);

136  
tİo
->
max_µn
;

137 
	}
}

139 
šlše
 
	$ucc_tİo_is_sšgË_µn
(
ucc_tİo_t
 *
tİo
)

141  
	`ucc_tİo_max_µn
(
tİo
) == 1;

142 
	}
}

145 
šlše
 
	$ucc_tİo_isİ²
(
ucc_tİo_t
 *
tİo
)

147  
	`ucc_tİo_max_µn
(
tİo
è=ğ
	`ucc_tİo_mš_µn
(topo);

148 
	}
}

154 
šlše
 
ucc_¿nk_t
 
	$ucc_tİo_mš_sock‘_size
(
ucc_tİo_t
 *
tİo
)

156 
ucc_sbgp_t
 *
sbgp
;

158 
	`ucc_as£¹
(
tİo
->tİo->
sock_bound
);

159 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

161 ià(
sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_INIT
) {

162  
UCC_RANK_INVALID
;

165  
tİo
->
mš_sock‘_size
;

166 
	}
}

172 
šlše
 
ucc_¿nk_t
 
	$ucc_tİo_max_sock‘_size
(
ucc_tİo_t
 *
tİo
)

174 
ucc_sbgp_t
 *
sbgp
;

176 
	`ucc_as£¹
(
tİo
->tİo->
sock_bound
);

177 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

179 ià(
sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_INIT
) {

180  
UCC_RANK_INVALID
;

183  
tİo
->
max_sock‘_size
;

184 
	}
}

190 
šlše
 
ucc_¿nk_t
 
	$ucc_tİo_mš_numa_size
(
ucc_tİo_t
 *
tİo
)

192 
ucc_sbgp_t
 *
sbgp
;

194 
	`ucc_as£¹
(
tİo
->tİo->
numa_bound
);

195 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

197 ià(
sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_INIT
) {

198  
UCC_RANK_INVALID
;

201  
tİo
->
mš_numa_size
;

202 
	}
}

208 
šlše
 
ucc_¿nk_t
 
	$ucc_tİo_max_numa_size
(
ucc_tİo_t
 *
tİo
)

210 
ucc_sbgp_t
 *
sbgp
;

212 
	`ucc_as£¹
(
tİo
->tİo->
numa_bound
);

213 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

215 ià(
sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_INIT
) {

216  
UCC_RANK_INVALID
;

219  
tİo
->
max_numa_size
;

220 
	}
}

222 
šlše
 
	$ucc_tİo_n_sock‘s
(
ucc_tİo_t
 *
tİo
)

224 
ucc_sbgp_t
 *
sbgp
;

226 ià(!
tİo
->tİo->
sock_bound
) {

229 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET_LEADERS
);

230 ià(
sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_EXISTS
) {

233  
sbgp
->
group_size
;

234 
	}
}

236 
šlše
 
	$ucc_tİo_n_numas
(
ucc_tİo_t
 *
tİo
)

238 
ucc_sbgp_t
 *
sbgp
;

240 ià(!
tİo
->tİo->
numa_bound
) {

243 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NUMA_LEADERS
);

244 ià(
sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_EXISTS
) {

247  
sbgp
->
group_size
;

248 
	}
}

250 
šlše
 
ucc_¿nk_t
 
	$ucc_tİo_Âodes
(
ucc_tİo_t
 *
tİo
)

252 
ucc_sbgp_t
 *
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

254 ià(
sbgp
->
¡©us
 =ğ
UCC_SBGP_NOT_EXISTS
) {

255 
	`ucc_as£¹
(
	`ucc_tİo_is_sšgË_node
(
tİo
));

258  
sbgp
->
group_size
;

259 
	}
}

264 
ucc_¡©us_t
 
ucc_tİo_g‘_node_Ëad”s
(
ucc_tİo_t
 *
tİo
, 
ucc_¿nk_t
 **
node_Ëad”s_out
);

	@src/core/ucc_coll.c

7 
	~"cÚfig.h
"

8 
	~"ucc_‹am.h
"

9 
	~"ucc_cÚ‹xt.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"compÚ’ts/ec/ucc_ec.h
"

12 
	~"compÚ’ts/ş/ucc_ş.h
"

13 
	~"uts/ucc_m®loc.h
"

14 
	~"uts/ucc_log.h
"

15 
	~"uts/ucc_cŞl_uts.h
"

16 
	~"uts/ucc_time.h
"

17 
	~"uts/´ofe/ucc_´ofe_cÜe.h
"

18 
	~"scheduË/ucc_scheduË.h
"

19 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

20 
	~"ucc_“.h
"

22 
	#UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
_šfo
) do { \

23 ià((
_šfo
).
mem_ty³
 =ğ
UCC_MEMORY_TYPE_UNKNOWN
) { \

24 
ucc_mem_©Œ_t
 
mem_©Œ
; \

25 
ucc_¡©us_t
 
¡
; \

26 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
; \

27 
¡
 = 
	`ucc_mc_g‘_mem_©Œ
((
_šfo
).
bufãr
, &
mem_©Œ
); \

28 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) { \

29  
¡
; \

31 (
_šfo
).
mem_ty³
 = 
mem_©Œ
.mem_type; \

33 } 0)

	)

35 
	#UCC_BUFFER_INFO_CHECK_DATATYPE
(
_šfo1
, 
_šfo2
) do { \

36 ià((
_šfo1
).
d©©y³
 !ğ(
_šfo2
).datatype) { \

37 
	`ucc_”rÜ
("datatype missmatch"); \

38  
UCC_ERR_INVALID_PARAM
; \

40 } 0)

	)

42 #ià
ENABLE_DEBUG
 == 1

43 
ucc_¡©us_t
 
	$ucc_check_cŞl_¬gs
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
,

44 
ucc_¿nk_t
 
¿nk
)

46 
cŞl_¬gs
->
cŞl_ty³
) {

47 
UCC_COLL_TYPE_ALLREDUCE
:

48 
UCC_COLL_TYPE_REDUCE_SCATTER
:

49 ià(!
	`UCC_IS_INPLACE
(*
cŞl_¬gs
)) {

50 
	`UCC_BUFFER_INFO_CHECK_DATATYPE
(
cŞl_¬gs
->
¤c
.
šfo
,

51 
cŞl_¬gs
->
d¡
.
šfo
);

54 
UCC_COLL_TYPE_REDUCE
:

55 ià(!
	`UCC_IS_INPLACE
(*
cŞl_¬gs
è&& 
	`UCC_IS_ROOT
(*cŞl_¬gs, 
¿nk
)) {

56 
	`UCC_BUFFER_INFO_CHECK_DATATYPE
(
cŞl_¬gs
->
¤c
.
šfo
,

57 
cŞl_¬gs
->
d¡
.
šfo
);

60 
UCC_COLL_TYPE_BCAST
:

61 
UCC_COLL_TYPE_BARRIER
:

62 
UCC_COLL_TYPE_FANIN
:

63 
UCC_COLL_TYPE_FANOUT
:

64 ià(
	`UCC_IS_INPLACE
(*
cŞl_¬gs
)) {

65 
	`ucc_w¬n
("Inplace flag for %s is‚ot defined by UCC API",

66 
	`ucc_cŞl_ty³_¡r
(
cŞl_¬gs
->
cŞl_ty³
));

70  
UCC_OK
;

72  
UCC_OK
;

73 
	}
}

75 
	#ucc_check_cŞl_¬gs
(...è
UCC_OK


	)

78 
ucc_¡©us_t
 
	$ucc_cŞl_¬gs_check_mem_ty³
(
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
,

79 
ucc_¿nk_t
 
¿nk
)

81 
cŞl_¬gs
->
cŞl_ty³
) {

82 
UCC_COLL_TYPE_BARRIER
:

83 
UCC_COLL_TYPE_FANIN
:

84 
UCC_COLL_TYPE_FANOUT
:

85  
UCC_OK
;

86 
UCC_COLL_TYPE_BCAST
:

87 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo
);

88  
UCC_OK
;

89 
UCC_COLL_TYPE_ALLREDUCE
:

90 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
d¡
.
šfo
);

91 ià(!
	`UCC_IS_INPLACE
(*
cŞl_¬gs
)) {

92 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo
);

94 
cŞl_¬gs
->
¤c
.
šfo
.
mem_ty³
 = cŞl_¬gs->
d¡
.info.mem_type;

96  
UCC_OK
;

97 
UCC_COLL_TYPE_ALLGATHER
:

98 
UCC_COLL_TYPE_ALLTOALL
:

99 
UCC_COLL_TYPE_REDUCE_SCATTER
:

100 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
d¡
.
šfo
);

101 ià(!
	`UCC_IS_INPLACE
(*
cŞl_¬gs
)) {

102 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo
);

104  
UCC_OK
;

105 
UCC_COLL_TYPE_ALLGATHERV
:

106 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

107 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
d¡
.
šfo_v
);

108 ià(!
	`UCC_IS_INPLACE
(*
cŞl_¬gs
)) {

109 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo
);

111  
UCC_OK
;

112 
UCC_COLL_TYPE_ALLTOALLV
:

113 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
d¡
.
šfo_v
);

114 ià(!
	`UCC_IS_INPLACE
(*
cŞl_¬gs
)) {

115 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo_v
);

117  
UCC_OK
;

118 
UCC_COLL_TYPE_GATHER
:

120 
UCC_COLL_TYPE_REDUCE
:

121 ià(!
	`UCC_IS_ROOT
(*
cŞl_¬gs
, 
¿nk
)) {

122 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo
);

124 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
d¡
.
šfo
);

125 ià(!
	`UCC_IS_INPLACE
(*
cŞl_¬gs
)) {

126 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo
);

129  
UCC_OK
;

130 
UCC_COLL_TYPE_GATHERV
:

131 ià(
	`UCC_IS_ROOT
(*
cŞl_¬gs
, 
¿nk
)) {

132 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
d¡
.
šfo_v
);

134 ià(!(
	`UCC_IS_INPLACE
(*
cŞl_¬gs
è&& 
	`UCC_IS_ROOT
(*cŞl_¬gs, 
¿nk
))) {

135 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo
);

137  
UCC_OK
;

138 
UCC_COLL_TYPE_SCATTER
:

139 ià(
	`UCC_IS_ROOT
(*
cŞl_¬gs
, 
¿nk
)) {

140 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo
);

142 ià(!(
	`UCC_IS_INPLACE
(*
cŞl_¬gs
è&& 
	`UCC_IS_ROOT
(*cŞl_¬gs, 
¿nk
))) {

143 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
d¡
.
šfo
);

145  
UCC_OK
;

146 
UCC_COLL_TYPE_SCATTERV
:

147 ià(
	`UCC_IS_ROOT
(*
cŞl_¬gs
, 
¿nk
)) {

148 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
¤c
.
šfo_v
);

150 ià(!(
	`UCC_IS_INPLACE
(*
cŞl_¬gs
è&& 
	`UCC_IS_ROOT
(*cŞl_¬gs, 
¿nk
))) {

151 
	`UCC_BUFFER_INFO_CHECK_MEM_TYPE
(
cŞl_¬gs
->
d¡
.
šfo
);

153  
UCC_OK
;

155 
	`ucc_”rÜ
("unknown collectiveype");

156  
UCC_ERR_INVALID_PARAM
;

158 
	}
}

160 
	#UCC_COLL_TYPE_SKIP_ZERO_SIZE
 \

161 (
UCC_COLL_TYPE_ALLREDUCE
 | \

162 
UCC_COLL_TYPE_ALLGATHER
 | \

163 
UCC_COLL_TYPE_ALLTOALL
 | \

164 
UCC_COLL_TYPE_BCAST
 | \

165 
UCC_COLL_TYPE_GATHER
 | \

166 
UCC_COLL_TYPE_REDUCE
 | \

167 
UCC_COLL_TYPE_SCATTER
)

	)

169 
UCC_CORE_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_cŞËùive_š™
,

170 (
cŞl_¬gs
, 
»que¡
, 
‹am
), 
ucc_cŞl_¬gs_t
 *coll_args,

171 
ucc_cŞl_»q_h
 *
»que¡
, 
ucc_‹am_h
 
‹am
)

173 
ucc_ba£_cŞl_¬gs_t
 
	gİ_¬gs
 = {0};

174 
ucc_cŞl_sk_t
 *
	gsk
;

175 
ucc_¡©us_t
 
	g¡©us
;

176 
ucc_“_executÜ_·¿ms_t
 
	g·¿ms
;

177 
ucc_memÜy_ty³_t
 
	gcŞl_mem_ty³
;

178 
ucc_“_ty³_t
 
	gcŞl_“_ty³
;

179 
size_t
 
	gcŞl_size
;

181 ià(
ucc_uÆik–y
(
‹am
->
¡©e
 !ğ
UCC_TEAM_ACTIVE
)) {

182 
ucc_”rÜ
("‹am %°i u£d befÜ‹am c»©i com¶‘ed", 
‹am
);

183  
	gUCC_ERR_INVALID_PARAM
;

188 ià(
	gUCC_COLL_TYPE_SKIP_ZERO_SIZE
 & 
	gcŞl_¬gs
->
	gcŞl_ty³
) {

189 
	gcŞl_size
 = 
ucc_cŞl_¬gs_msgsize
(
cŞl_¬gs
, 
‹am
->
¿nk
,—m->
size
);

190 ià(
	gcŞl_size
 == 0) {

191 
sk
 = 
ucc_mpoŞ_g‘
(&
‹am
->
cÚ‹xts
[0]->
lib
->
¡ub_sks_mp
);

192 ià(
ucc_uÆik–y
(!
sk
)) {

193 
ucc_”rÜ
("failedo‡llocate dummyask");

194  
	gUCC_ERR_NO_MEMORY
;

196 
	gİ_¬gs
.
	gmask
 = 0;

197 
memıy
(&
İ_¬gs
.
¬gs
, 
cŞl_¬gs
, (
ucc_cŞl_¬gs_t
));

198 
	gİ_¬gs
.
	g‹am
 = 
‹am
;

199 
	gİ_¬gs
.
	g¬gs
.
	gæags
 = 0;

200 
UCC_COPY_PARAM_BY_FIELD
(&
İ_¬gs
.
¬gs
, 
cŞl_¬gs
,

201 
UCC_COLL_ARGS_FIELD_FLAGS
, 
æags
);

202 
ucc_cŞl_sk_š™
(
sk
, &
İ_¬gs
, 
NULL
);

203 
	g´št_Œaû
;

207 ià(
UCC_COLL_ARGS_ACTIVE_SET
(
cŞl_¬gs
) &&

208 (
	gUCC_COLL_TYPE_BCAST
 !ğ
cŞl_¬gs
->
cŞl_ty³
)) {

209 
ucc_w¬n
("Active Sets‡re only supported for bcast");

210  
	gUCC_ERR_NOT_SUPPORTED
;

213 
	g¡©us
 = 
ucc_cŞl_¬gs_check_mem_ty³
(
cŞl_¬gs
, 
‹am
->
¿nk
);

214 ià(
ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

215 
ucc_”rÜ
("memoryype detection failed");

216  
	g¡©us
;

219 
	g¡©us
 = 
ucc_check_cŞl_¬gs
(
cŞl_¬gs
, 
‹am
->
¿nk
);

220 ià(
ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

221 
ucc_”rÜ
("collective‡rguments check failed");

222  
	g¡©us
;

226 
memıy
(&
İ_¬gs
.
¬gs
, 
cŞl_¬gs
, (
ucc_cŞl_¬gs_t
));

227 
	gİ_¬gs
.
	g‹am
 = 
‹am
;

229 
	gİ_¬gs
.
	g¬gs
.
	gæags
 = 0;

230 
UCC_COPY_PARAM_BY_FIELD
(&
İ_¬gs
.
¬gs
, 
cŞl_¬gs
, 
UCC_COLL_ARGS_FIELD_FLAGS
,

231 
æags
);

233 ià(!
ucc_cŞl_¬gs_is_mem_symm‘ric
(&
İ_¬gs
.
¬gs
, 
‹am
->
¿nk
) &&

234 
ucc_cŞl_¬gs_is_roÙed
(
İ_¬gs
.
¬gs
.
cŞl_ty³
)) {

235 
	g¡©us
 = 
ucc_cŞl_¬gs_š™_asymm‘ric_bufãr
(&
İ_¬gs
.
¬gs
, 
‹am
,

236 &
İ_¬gs
.
asymm‘ric_§ve_šfo
);

237 ià(
ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

238 
ucc_”rÜ
("handling‡symmetric memory failed");

239  
	g¡©us
;

242 
	gİ_¬gs
.
	gasymm‘ric_§ve_šfo
.
	gsü©ch
 = 
NULL
;

245 
	g¡©us
 = 
ucc_cŞl_š™
(
‹am
->
scÜe_m­
, &
İ_¬gs
, &
sk
);

246 ià(
	gUCC_ERR_NOT_SUPPORTED
 =ğ
¡©us
) {

247 
ucc_debug
("failedo init collective:‚ot supported");

248 
	gä“_sü©ch
;

249 } ià(
ucc_uÆik–y
(
¡©us
 < 0)) {

250 
	gcŞl_¬gs_¡r
[256] = {0};

251 
ucc_cŞl_¬gs_¡r
(&
İ_¬gs
.
¬gs
, 
‹am
->
¿nk
,—m->
size
, 
cŞl_¬gs_¡r
,

252 (
cŞl_¬gs_¡r
));

253 
ucc_”rÜ
("çedØš™ cŞËùive: %s,ƒ¼: (%dè%s", 
cŞl_¬gs_¡r
,

254 
¡©us
, 
ucc_¡©us_¡ršg
(status));

255 
	gä“_sü©ch
;

258 
	gsk
->
	gæags
 |ğ
UCC_COLL_TASK_FLAG_TOP_LEVEL
;

259 ià(
	gsk
->
	gæags
 & 
	gUCC_COLL_TASK_FLAG_EXECUTOR
) {

260 
	gsk
->
	gæags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR_STOP
;

261 
	gcŞl_mem_ty³
 = 
ucc_cŞl_¬gs_mem_ty³
(&
İ_¬gs
.
¬gs
, 
‹am
->
¿nk
);

262 
	gcŞl_mem_ty³
) {

263 
	gUCC_MEMORY_TYPE_CUDA
:

264 
UCC_MEMORY_TYPE_CUDA_MANAGED
:

265 
cŞl_“_ty³
 = 
UCC_EE_CUDA_STREAM
;

267 
	gUCC_MEMORY_TYPE_ROCM
:

268 
cŞl_“_ty³
 = 
UCC_EE_ROCM_STREAM
;

270 
	gUCC_MEMORY_TYPE_HOST
:

271 
cŞl_“_ty³
 = 
UCC_EE_CPU_THREAD
;

274 
ucc_”rÜ
("no suitableƒxecutor‡vailable for memoryype %s",

275 
ucc_memÜy_ty³_Çmes
[
cŞl_mem_ty³
]);

276 
	g¡©us
 = 
UCC_ERR_INVALID_PARAM
;

277 
	gcŞl_fš®ize
;

279 
	g·¿ms
.
	gmask
 = 
UCC_EE_EXECUTOR_PARAM_FIELD_TYPE
;

280 
	g·¿ms
.
	g“_ty³
 = 
cŞl_“_ty³
;

281 
	g¡©us
 = 
ucc_“_executÜ_š™
(&
·¿ms
, &
sk
->
executÜ
);

282 ià(
	gUCC_OK
 !ğ
¡©us
) {

283 
ucc_”rÜ
("çedØš™ƒxecutÜ: %s", 
ucc_¡©us_¡ršg
(
¡©us
));

284 
	gcŞl_fš®ize
;

288 ià(
	gcŞl_¬gs
->
	gmask
 & 
	gUCC_COLL_ARGS_FIELD_CB
) {

289 
	gsk
->
	gcb
 = 
cŞl_¬gs
->
cb
;

290 
	gsk
->
	gæags
 |ğ
UCC_COLL_TASK_FLAG_CB
;

292 
	gsk
->
	g£q_num
 = 
‹am
->
£q_num
++;

294 
ucc_as£¹
(
sk
->
su³r
.
¡©us
 =ğ
UCC_OPERATION_INITIALIZED
);

296 
	g´št_Œaû
:

297 *
»que¡
 = &
sk
->
su³r
;

298 ià(
ucc_uÆik–y
(
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
 >=

299 
UCC_LOG_LEVEL_DIAG
)) {

300 
cŞl_¡r
[256];

301 
ucc_cŞl_¡r
(
sk
, 
cŞl_¡r
, (coll_str),

302 
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
);

303 ià(
	gucc_glob®_cÚfig
.
	gcŞl_Œaû
.
	glog_Ëv–
 <ğ
UCC_LOG_LEVEL_INFO
) {

304 ià(
‹am
->
¿nk
 == 0) {

305 
ucc_log_compÚ’t_cŞËùive_Œaû
(

306 
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
, "coll_init: %s",

307 
cŞl_¡r
);

310 
ucc_cŞl_Œaû_debug
("cŞl_š™: %s", 
cŞl_¡r
);

314  
	gUCC_OK
;

316 
	gcŞl_fš®ize
:

317 
sk
->
fš®ize
(task);

318 
	gä“_sü©ch
:

319 ià(
İ_¬gs
.
asymm‘ric_§ve_šfo
.
sü©ch
 !ğ
NULL
) {

320 
ucc_mc_ä“
(
İ_¬gs
.
asymm‘ric_§ve_šfo
.
sü©ch
);

322  
	g¡©us
;

329 
	#COLL_POST_STATUS_CHECK
(
_sk
) do { \

330 ià((
_sk
)->
su³r
.
¡©us
 !ğ
UCC_OPERATION_INITIALIZED
) { \

331 ià(!(
UCC_OK
 =ğ(
_sk
)->
su³r
.
¡©us
 && \

332 
	`UCC_IS_PERSISTENT
((
_sk
)->
b¬gs
.
¬gs
))) { \

333 
	`ucc_”rÜ
("%s„equest with invalid status %s is being…osted", \

334 
	`UCC_IS_PERSISTENT
((
_sk
)->
b¬gs
.
¬gs
) \

336 
	`ucc_¡©us_¡ršg
((
_sk
)->
su³r
.
¡©us
)); \

337  
UCC_ERR_INVALID_PARAM
; \

340 } 0)

	)

342 
UCC_CORE_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_cŞËùive_po¡
, (
»que¡
),

343 
ucc_cŞl_»q_h
 
»que¡
)

345 
ucc_cŞl_sk_t
 *
	gsk
 = 
ucc_d”ived_of
(
»que¡
, ucc_coll_task_t);

346 
ucc_¡©us_t
 
	g¡©us
;

348 ià(
	gucc_glob®_cÚfig
.
	gcŞl_Œaû
.
	glog_Ëv–
 >ğ
UCC_LOG_LEVEL_DEBUG
) {

349 
ucc_¿nk_t
 
¿nk
 = 
sk
->
b¬gs
.
‹am
->rank;

350 ià(
	gucc_glob®_cÚfig
.
	gcŞl_Œaû
.
	glog_Ëv–
 =ğ
UCC_LOG_LEVEL_DEBUG
) {

351 ià(
¿nk
 == 0) {

352 
ucc_log_compÚ’t_cŞËùive_Œaû
(

353 
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
,

354 "cŞÈpo¡:„eq %p, seq_num %u", 
sk
,ask->
£q_num
);

357 
ucc_log_compÚ’t_cŞËùive_Œaû
(

358 
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
,

359 "cŞÈpo¡:„ªk %d„eq %p, seq_num %u", 
¿nk
, 
sk
,

360 
sk
->
£q_num
);

364 ià(
	gsk
->
	gb¬gs
.
	gasymm‘ric_§ve_šfo
.
	gsü©ch
 !ğ
NULL
 &&

365 (
sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTER
 ||

366 
sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTERV
)) {

367 
¡©us
 = 
ucc_cİy_asymm‘ric_bufãr
(
sk
);

368 ià(
	g¡©us
 !ğ
UCC_OK
) {

369 
ucc_”rÜ
("failure copying in‡symmetric buffer: %s",

370 
ucc_¡©us_¡ršg
(
¡©us
));

371  
	g¡©us
;

375 
COLL_POST_STATUS_CHECK
(
sk
);

376 ià(
UCC_COLL_TIMEOUT_REQUIRED
(
sk
)) {

377 
	gsk
->
	g¡¬t_time
 = 
ucc_g‘_time
();

380 ià(
	gsk
->
	gæags
 & 
	gUCC_COLL_TASK_FLAG_EXECUTOR
) {

381 
	g¡©us
 = 
ucc_“_executÜ_¡¬t
(
sk
->
executÜ
, 
NULL
);

382 ià(
ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

383 
ucc_”rÜ
("failedo startƒxecutor: %s",

384 
ucc_¡©us_¡ršg
(
¡©us
));

387  
	gsk
->
po¡
(
sk
);

390 
ucc_¡©us_t
 
	$ucc_cŞËùive_Œigg”ed_po¡
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
)

392 
ucc_cŞl_sk_t
 *
sk
 = 
	`ucc_d”ived_of
(
ev
->
»q
, ucc_coll_task_t);

394 ià(
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
 >ğ
UCC_LOG_LEVEL_DEBUG
) {

395 
ucc_¿nk_t
 
¿nk
 = 
sk
->
b¬gs
.
‹am
->rank;

396 ià(
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
 =ğ
UCC_LOG_LEVEL_DEBUG
) {

397 ià(
¿nk
 == 0) {

398 
	`ucc_log_compÚ’t_cŞËùive_Œaû
(

399 
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
,

400 "cŞÈŒigg”ed_po¡:„eq %p, seq_num %u", 
sk
,

401 
sk
->
£q_num
);

404 
	`ucc_log_compÚ’t_cŞËùive_Œaû
(

405 
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
,

406 "cŞÈŒigg”ed_po¡:„ªk %d„eq %p, seq_num %u", 
¿nk
, 
sk
,

407 
sk
->
£q_num
);

411 
	`COLL_POST_STATUS_CHECK
(
sk
);

412 ià(
	`UCC_COLL_TIMEOUT_REQUIRED
(
sk
)) {

413 
sk
->
¡¬t_time
 = 
	`ucc_g‘_time
();

415  
sk
->
	`Œigg”ed_po¡
(
“
, 
ev
,ask);

416 
	}
}

418 
UCC_CORE_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_cŞËùive_š™_ªd_po¡
,

419 (
cŞl_¬gs
, 
»que¡
, 
‹am
), 
ucc_cŞl_¬gs_t
 *coll_args,

420 
ucc_cŞl_»q_h
 *
»que¡
, 
ucc_‹am_h
 
‹am
)

422 
ucc_”rÜ
("ucc_collective_init_and_post() is‚ot implemented");

424  
	gUCC_ERR_NOT_IMPLEMENTED
;

427 
ucc_¡©us_t
 
	$ucc_cŞËùive_fš®ize_š‹º®
(
ucc_cŞl_sk_t
 *
sk
)

429 
ucc_¡©us_t
 
¡
;

431 ià(
	`ucc_uÆik–y
(
sk
->
su³r
.
¡©us
 =ğ
UCC_INPROGRESS
)) {

432 
	`ucc_”rÜ
("attempto finalizeask with status UCC_INPROGRESS");

433  
UCC_ERR_INVALID_PARAM
;

436 ià(
sk
->
b¬gs
.
asymm‘ric_§ve_šfo
.
sü©ch
) {

437 
¡
 = 
	`ucc_cŞl_¬gs_ä“_asymm‘ric_bufãr
(
sk
);

438 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

439 
	`ucc_”rÜ
("”rÜ f»ešg‡symm‘riøbuf: %s", 
	`ucc_¡©us_¡ršg
(
¡
));

443 ià(
sk
->
executÜ
) {

444 
¡
 = 
	`ucc_“_executÜ_fš®ize
(
sk
->
executÜ
);

445 ià(
	`ucc_uÆik–y
(
¡
 !ğ
UCC_OK
)) {

446 
	`ucc_”rÜ
("executÜ fš®iz”rÜ: %s", 
	`ucc_¡©us_¡ršg
(
¡
));

449  
sk
->
	`fš®ize
(task);

450 
	}
}

452 
UCC_CORE_PROFILE_FUNC
(
ucc_¡©us_t
, 
ucc_cŞËùive_fš®ize
, (
»que¡
),

453 
ucc_cŞl_»q_h
 
»que¡
)

455 
ucc_cŞl_sk_t
 *
	gsk
 = 
ucc_d”ived_of
(
»que¡
, ucc_coll_task_t);

457 ià(
	gucc_glob®_cÚfig
.
	gcŞl_Œaû
.
	glog_Ëv–
 >ğ
UCC_LOG_LEVEL_DEBUG
) {

458 ià(
sk
->
‹am
) {

459 
ucc_¿nk_t
 
¿nk
 = 
sk
->
‹am
->
·¿ms
.team->rank;

460 ià(
	gucc_glob®_cÚfig
.
	gcŞl_Œaû
.
	glog_Ëv–
 =ğ
UCC_LOG_LEVEL_DEBUG
) {

461 ià(
¿nk
 == 0) {

462 
ucc_log_compÚ’t_cŞËùive_Œaû
(

463 
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
,

464 "cŞÈfš®ize:„eq %p, seq_num %u", 
sk
,ask->
£q_num
);

467 
ucc_log_compÚ’t_cŞËùive_Œaû
(

468 
ucc_glob®_cÚfig
.
cŞl_Œaû
.
log_Ëv–
,

469 "cŞÈfš®ize:„ªk %d„eq %p, seq_num %u", 
¿nk
, 
sk
,

470 
sk
->
£q_num
);

474  
ucc_cŞËùive_fš®ize_š‹º®
(
sk
);

477 
ucc_¡©us_t
 
	$ucc_Œigg”ed_sk_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

479 
	`ucc_Œaû
("fš®izšgrigg”edƒvask %p", 
sk
);

480 
	`ucc_ä“
(
sk
);

481  
UCC_OK
;

482 
	}
}

485 
	$ucc_Œigg”ed_sk_cb
(*
sk
, 
ucc_¡©us_t
 
¡
)

487 
	`ucc_Œigg”ed_sk_fš®ize
((
ucc_cŞl_sk_t
*)
sk
);

488 
	}
}

490 
ucc_¡©us_t
 
	$ucc_Œigg”_com¶‘e
(
ucc_cŞl_sk_t
 *
·»Á_sk
,

491 
ucc_cŞl_sk_t
 *
sk
)

493 
ucc_¡©us_t
 
¡©us
;

495 
	`ucc_Œaû
("eventriggered,ƒv_task %p, coll_task %p, seq_num %u",

496 
·»Á_sk
, 
sk
,ask->
£q_num
);

498 ià(!(
sk
->
æags
 & 
UCC_COLL_TASK_FLAG_EXECUTOR
)) {

499 
sk
->
executÜ
 = 
·»Á_sk
->executor;

500 
sk
->
æags
 |ğ(
UCC_COLL_TASK_FLAG_EXECUTOR_STOP
 |

501 
UCC_COLL_TASK_FLAG_EXECUTOR_DESTROY
);

504 
¡©us
 = 
sk
->
	`po¡
(task);

505 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

506 
	`ucc_”rÜ
("failedo…ostriggered coll,ask %p, seq_num %u, %s",

507 
sk
,ask->
£q_num
, 
	`ucc_¡©us_¡ršg
(
¡©us
));

509  
¡©us
;

510 
	}
}

512 
	$ucc_Œigg”_‹¡
(
ucc_cŞl_sk_t
 *
sk
)

514 
ucc_¡©us_t
 
¡©us
;

515 
ucc_ev_t
 
po¡_ev’t
;

516 
ucc_ev_t
 *
ev
;

517 
ucc_“_executÜ_·¿ms_t
 
·¿ms
;

519 ià(
sk
->
ev
 =ğ
NULL
) {

520 ià((
sk
->
“
->
“_ty³
 =ğ
UCC_EE_CUDA_STREAM
) ||

521 (
sk
->
“
->
“_ty³
 =ğ
UCC_EE_ROCM_STREAM
)) {

523 
sk
->
ev
 = (
ucc_ev_t
 *) 0xFFFF;

524 
sk
->
executÜ
 = 
NULL
;

525 } ià(
UCC_OK
 =ğ
	`ucc_“_g‘_ev’t_š‹º®
(
sk
->
“
, &
ev
,

526 &
sk
->
“
->
ev’t_š_queue
)) {

527 
	`ucc_Œaû
("Œigg”edƒv’ˆ¬rived,ƒv_sk %p", 
sk
);

528 
sk
->
ev
 =ƒv;

529 
sk
->
executÜ
 = 
NULL
;

531 
sk
->
¡©us
 = 
UCC_OK
;

536 ià(
sk
->
executÜ
 =ğ
NULL
) {

537 ià(
sk
->
Œigg”ed_sk
->
Œigg”ed_po¡_£tup
) {

538 
¡©us
 = 
sk
->
Œigg”ed_sk
->
	`Œigg”ed_po¡_£tup
(task->triggered_task);

539 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

540 
	`ucc_”rÜ
("error inriggered…ost setup, %s",

541 
	`ucc_¡©us_¡ršg
(
¡©us
));

542 
sk
->
¡©us
 = status;

546 ià(
sk
->
Œigg”ed_sk
->
executÜ
) {

547 
sk
->
executÜ
 =ask->
Œigg”ed_sk
->executor;

552 
·¿ms
.
mask
 = 
UCC_EE_EXECUTOR_PARAM_FIELD_TYPE
 |

553 
UCC_EE_EXECUTOR_PARAM_FIELD_TASK_TYPES
;

554 
·¿ms
.
“_ty³
 = 
sk
->
“
->ee_type;

555 
·¿ms
.
sk_ty³s
 = 0;

556 
¡©us
 = 
	`ucc_“_executÜ_š™
(&
·¿ms
, &
sk
->
executÜ
);

557 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

558 
	`ucc_”rÜ
("error inƒeƒxecutor init, %s",

559 
	`ucc_¡©us_¡ršg
(
¡©us
));

560 
sk
->
¡©us
 = status;

564 
¡©us
 = 
	`ucc_“_executÜ_¡¬t
(
sk
->
executÜ
,ask->
“
->
“_cÚ‹xt
);

565 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

566 
	`ucc_”rÜ
("error inƒeƒxecutor start, %s",

567 
	`ucc_¡©us_¡ršg
(
¡©us
));

568 
sk
->
¡©us
 = status;

572 
po¡_ev’t
.
ev_ty³
 = 
UCC_EVENT_COLLECTIVE_POST
;

573 
po¡_ev’t
.
ev_cÚ‹xt_size
 = 0;

574 
po¡_ev’t
.
ev_cÚ‹xt
 = 
NULL
;

575 
po¡_ev’t
.
»q
 = &
sk
->
Œigg”ed_sk
->
su³r
;

576 
	`ucc_“_£t_ev’t_š‹º®
(
sk
->
“
, &
po¡_ev’t
,

577 &
sk
->
“
->
ev’t_out_queue
);

580 ià(
	`ucc_“_executÜ_¡©us
(
sk
->
executÜ
è=ğ
UCC_OK
) {

581 
sk
->
¡©us
 = 
UCC_OK
;

583 
	}
}

585 
ucc_¡©us_t
 
	$ucc_Œigg”ed_po¡
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
,

586 
ucc_cŞl_sk_t
 *
sk
)

588 
ucc_cŞl_sk_t
 *
ev_sk
;

589 
ucc_¡©us_t
 
¡©us
;

591 ià(
ev
->
ev_ty³
 !ğ
UCC_EVENT_COMPUTE_COMPLETE
) {

592 
	`ucc_”rÜ
("ev’ˆty³ %d i nÙ suµÜ‹d", 
ev
->
ev_ty³
);

593  
UCC_ERR_NOT_IMPLEMENTED
;

595 
sk
->
“
 =ƒe;

596 
sk
->
su³r
.
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

597 
ev_sk
 = 
	`ucc_m®loc
((*ev_task), "ev_task");

598 ià(!
ev_sk
) {

599 
	`ucc_”rÜ
("failedo‡llocate %zd bytes forƒv_task",

600 (*
ev_sk
));

601  
UCC_ERR_NO_MEMORY
;

604 
	`ucc_cŞl_sk_cÚ¡ruù
(
ev_sk
);

605 
	`ucc_cŞl_sk_š™
(
ev_sk
, 
NULL
, 
sk
->
‹am
);

606 
ev_sk
->
“
 =ƒe;

607 
ev_sk
->
ev
 = 
NULL
;

608 
ev_sk
->
Œigg”ed_sk
 = 
sk
;

609 
ev_sk
->
æags
 = 
UCC_COLL_TASK_FLAG_CB
;

610 
ev_sk
->
cb
.cb = 
ucc_Œigg”ed_sk_cb
;

611 
ev_sk
->
cb
.
d©a
 =ƒv_task;

612 
ev_sk
->
fš®ize
 = 
ucc_Œigg”ed_sk_fš®ize
;

613 
ev_sk
->
´og»ss
 = 
ucc_Œigg”_‹¡
;

614 
ev_sk
->
¡©us
 = 
UCC_INPROGRESS
;

616 ià(
	`UCC_COLL_TIMEOUT_REQUIRED
(
sk
)) {

617 
	`UCC_COLL_SET_TIMEOUT
(
ev_sk
, 
sk
->
b¬gs
.
¬gs
.
timeout
);

619 
¡©us
 = 
	`ucc_ev’t_mªag”_subsüibe
(
ev_sk
, 
UCC_EVENT_COMPLETED
, 
sk
,

620 
ucc_Œigg”_com¶‘e
);

621 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

622  
¡©us
;

625  
	`ucc_´og»ss_queue_’queue
(
sk
->
b¬gs
.
‹am
->
cÚ‹xts
[0]->
pq
, 
ev_sk
);

626 
	}
}

	@src/core/ucc_constructor.c

7 
	~"cÚfig.h
"

8 
	~"ucc_glob®_İts.h
"

9 
	~"uts/ucc_m®loc.h
"

10 
	~"uts/ucc_compÚ’t.h
"

11 
	~"uts/ucc_log.h
"

12 
	~"uts/ucc_sys.h
"

13 
	~"uts/ucc_¡ršg.h
"

14 
	~"uts/ucc_´oc_šfo.h
"

15 
	~"uts/´ofe/ucc_´ofe.h
"

16 
	~"ucc/­i/ucc_v”siÚ.h
"

17 
	~<dlfú.h
>

18 
	~<±h»ad.h
>

20 
ucc_¡©us_t
 
	$ucc_check_cÚfig_fe
()

22 
ucc_glob®_cÚfig_t
 *
cfg
 = &
ucc_glob®_cÚfig
;

23 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

24 cÚ¡ * 
deçuÉ_sh¬e_Çme
 = "/share/ucc.conf";

25 cÚ¡ * 
deçuÉ_home_Çme
 = "/ucc.conf";

26 cÚ¡ * 
home
;

27 * 
f’ame
;

30 ià(
	`¡¾’
(
cfg
->
cfg_f’ame
) == 0) {

32  
UCC_OK
;

34 ià(0 !ğ
	`¡rÿ£cmp
(
cfg
->
cfg_f’ame
, "auto")) {

36 
¡©us
 = 
	`ucc_·r£_fe_cÚfig
(
cfg
->
cfg_f’ame
,

37 &
ucc_glob®_cÚfig
.
fe_cfg
);

38 ià(
UCC_ERR_NOT_FOUND
 =ğ
¡©us
) {

40 
	`ucc_w¬n
("çedØİ’ cÚfig fe: %s", 
cfg
->
cfg_f’ame
);

42  
¡©us
;

46 ià(
NULL
 !ğ(
home
 = 
	`g‘’v
("HOME"))) {

47 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`ucc_¡r_cÚÿt
(
home
 ,
deçuÉ_home_Çme
,

48 &
f’ame
))) {

49  
¡©us
;

51 
¡©us
 = 
	`ucc_·r£_fe_cÚfig
(
f’ame
, &
ucc_glob®_cÚfig
.
fe_cfg
);

52 
	`ucc_ä“
(
f’ame
);

53 ià(
UCC_ERR_NOT_FOUND
 !ğ
¡©us
) {

56  
¡©us
;

60 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`ucc_¡r_cÚÿt
(
cfg
->
š¡®l_·th
,

61 
deçuÉ_sh¬e_Çme
, &
f’ame
))) {

62  
¡©us
;

64 
¡©us
 = 
	`ucc_·r£_fe_cÚfig
(
f’ame
, &
ucc_glob®_cÚfig
.
fe_cfg
);

65 
	`ucc_ä“
(
f’ame
);

66  
¡©us
;

67 
	}
}

69 
ucc_¡©us_t
 
	$š™_lib_·ths
()

71 cÚ¡ *
so_·th
 = 
	`ucc_sys_g‘_lib_·th
();

72 
ucc_¡©us_t
 
¡©us
;

73 *
lib_·th
;

75 ià(!
so_·th
) {

76  
UCC_ERR_NOT_FOUND
;

78 
¡©us
 = 
	`ucc_sys_dœÇme
(
so_·th
, &
lib_·th
);

79 ià(
UCC_OK
 !ğ
¡©us
) {

80  
¡©us
;

83 
¡©us
 = 
	`ucc_sys_dœÇme
(
lib_·th
, &
ucc_glob®_cÚfig
.
š¡®l_·th
);

84 ià(
UCC_OK
 !ğ
¡©us
) {

85 
out
;

87 
¡©us
 = 
	`ucc_sys_·th_još
(
lib_·th
, 
UCC_MODULE_SUBDIR
,

88 &
ucc_glob®_cÚfig
.
compÚ’t_·th
);

89 
out
:

90 
	`ä“
(
lib_·th
);

91  
¡©us
;

92 
	}
}

94 
UCC_CONFIG_REGISTER_TABLE
(
ucc_glob®_cÚfig_bË
, "UCC glob®", 
NULL
,

95 
ucc_glob®_cÚfig
, &
ucc_cÚfig_glob®_li¡
)

97 
±h»ad_mu‹x_t
 
	gucc_cÚ¡ruùÜ_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

99 
ucc_¡©us_t
 
	$ucc_cÚ¡ruùÜ
()

101 
ucc_glob®_cÚfig_t
 *
cfg
 = &
ucc_glob®_cÚfig
;

102 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

103 
Dl_šfo
 
dl_šfo
;

104 
»t
;

106 
	`±h»ad_mu‹x_lock
(&
ucc_cÚ¡ruùÜ_mu‹x
);

107 ià(
cfg
->
š™Ÿlized
) {

108 
ex™_uÆock_mu‹x
;

111 
cfg
->
š™Ÿlized
 = 1;

112 
¡©us
 = 
	`ucc_cÚfig_·r£r_fl_İts
(

113 &
ucc_glob®_cÚfig
, 
	`UCC_CONFIG_GET_TABLE
(
ucc_glob®_cÚfig_bË
),

115 ià(
UCC_OK
 !ğ
¡©us
) {

116 
	`ucc_”rÜ
("failedo…arse global options");

117 
ex™_uÆock_mu‹x
;

120 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`š™_lib_·ths
())) {

121 
	`ucc_”rÜ
("failedo init ucc components…ath");

122 
ex™_uÆock_mu‹x
;

125 
¡©us
 = 
	`ucc_check_cÚfig_fe
();

126 ià(
UCC_OK
 !ğ
¡©us
 && 
UCC_ERR_NOT_FOUND
 != status) {

128 
ex™_uÆock_mu‹x
;

131 
¡©us
 = 
	`ucc_compÚ’ts_lßd
("ş", &
cfg
->
ş_äamewÜk
);

132 ià(
UCC_OK
 !ğ
¡©us
) {

133 
	`ucc_”rÜ
("no CL components were found inhe "

134 "ucømoduË dœ: %s", 
cfg
->
compÚ’t_·th
);

135 
ex™_uÆock_mu‹x
;

137 
¡©us
 = 
	`ucc_compÚ’t_check_scÜes_uniq
(&
cfg
->
ş_äamewÜk
);

138 ià(
UCC_OK
 !ğ
¡©us
) {

139 
	`ucc_”rÜ
("CLs must have distinct uniq default scores");

140 
ex™_uÆock_mu‹x
;

142 
¡©us
 = 
	`ucc_compÚ’ts_lßd
("", &
cfg
->
_äamewÜk
);

143 ià(
UCC_OK
 !ğ
¡©us
) {

145 
	`ucc_debug
("no TL components were found inhe "

146 "ucømoduË dœ: %s", 
cfg
->
compÚ’t_·th
);

148 
¡©us
 = 
	`ucc_compÚ’t_check_scÜes_uniq
(&
cfg
->
_äamewÜk
);

149 ià(
UCC_OK
 !ğ
¡©us
) {

150 
	`ucc_”rÜ
("TLs must have distinct uniq default scores");

151 
ex™_uÆock_mu‹x
;

153 
¡©us
 = 
	`ucc_compÚ’ts_lßd
("mc", &
cfg
->
mc_äamewÜk
);

154 ià(
UCC_OK
 !ğ
¡©us
) {

155 
	`ucc_”rÜ
("no memory components were found inhe "

156 "ucømoduË dœ: %s", 
cfg
->
compÚ’t_·th
);

157 
ex™_uÆock_mu‹x
;

159 
¡©us
 = 
	`ucc_compÚ’ts_lßd
("ec", &
cfg
->
ec_äamewÜk
);

160 ià(
¡©us
 !ğ
UCC_OK
) {

161 ià(
¡©us
 =ğ
UCC_ERR_NOT_FOUND
) {

162 
	`ucc_šfo
("noƒxecution components were found inhe "

165 
cfg
->
compÚ’t_·th
);

167 
	`ucc_”rÜ
("failedo†oadƒxecution components %d (%s)",

168 
¡©us
, 
	`ucc_¡©us_¡ršg
(status));

169 
ex™_uÆock_mu‹x
;

173 ià(
UCC_OK
 !ğ
	`ucc_loÿl_´oc_šfo_š™
()) {

174 
	`ucc_”rÜ
("failedo initialize†ocal…roc info");

175 
ex™_uÆock_mu‹x
;

177 #ifdeà
HAVE_PROFILING


178 
	`ucc_´ofe_š™
(
cfg
->
´ofe_mode
, cfg->
´ofe_fe
,

179 
cfg
->
´ofe_log_size
);

181 ià(
ucc_glob®_cÚfig
.
log_compÚ’t
.
log_Ëv–
 >ğ
UCC_LOG_LEVEL_INFO
) {

182 
»t
 = 
	`dÏddr
(
ucc_š™_v”siÚ
, &
dl_šfo
);

183 ià(
»t
 == 0) {

184 
	`ucc_”rÜ
("failedo get ucc_init_version handler");

185 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

186 
ex™_uÆock_mu‹x
;

188 
	`ucc_šfo
("version: %s,†oaded from: %s, cfg file: %s",

189 
	`ucc_g‘_v”siÚ_¡ršg
(), 
dl_šfo
.
dli_âame
,

190 
ucc_glob®_cÚfig
.
fe_cfg
 ?

191 
ucc_glob®_cÚfig
.
fe_cfg
->
f’ame
: "n/a");

194 
ex™_uÆock_mu‹x
:

195 
	`±h»ad_mu‹x_uÆock
(&
ucc_cÚ¡ruùÜ_mu‹x
);

196  
¡©us
;

197 
	}
}

199 
__©Œibu‹__
((
de¡ruùÜ
)è
	$ucc_de¡ruùÜ
()

201 ià(
ucc_glob®_cÚfig
.
š™Ÿlized
) {

202 #ifdeà
HAVE_PROFILING


203 
	`ucc_´ofe_ş—nup
();

205 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(&
ucc_glob®_cÚfig
,

206 
ucc_glob®_cÚfig_bË
);

207 ià(
ucc_glob®_cÚfig
.
fe_cfg
) {

208 
	`ucc_»Ëa£_fe_cÚfig
(
ucc_glob®_cÚfig
.
fe_cfg
);

210 
	`ä“
(
ucc_glob®_cÚfig
.
compÚ’t_·th
);

211 
	`ä“
(
ucc_glob®_cÚfig
.
š¡®l_·th
);

213 
	}
}

	@src/core/ucc_context.c

7 
	~"cÚfig.h
"

8 
	~"ucc_cÚ‹xt.h
"

9 
	~"compÚ’ts/ş/ucc_ş.h
"

10 
	~"compÚ’ts//ucc_.h
"

11 
	~"uts/ucc_m®loc.h
"

12 
	~"uts/ucc_log.h
"

13 
	~"uts/ucc_li¡.h
"

14 
	~"uts/ucc_¡ršg.h
"

15 
	~"ucc_´og»ss_queue.h
"

17 
ušt32_t
 
	gucc_cÚ‹xt_£q_num
 = 0;

18 
ucc_cÚfig_f›ld_t
 
	gucc_cÚ‹xt_cÚfig_bË
[] = {

22 
ucc_off£tof
(
ucc_cÚ‹xt_cÚfig_t
, 
e¡im©ed_num_•s
),

23 
UCC_CONFIG_TYPE_UINT
},

27 
ucc_off£tof
(
ucc_cÚ‹xt_cÚfig_t
, 
lock_ä“_´og»ss_q
),

28 
UCC_CONFIG_TYPE_UINT
},

33 
ucc_off£tof
(
ucc_cÚ‹xt_cÚfig_t
, 
e¡im©ed_num_µn
),

34 
UCC_CONFIG_TYPE_UINT
},

40 
ucc_off£tof
(
ucc_cÚ‹xt_cÚfig_t
, 
‹am_ids_poŞ_size
),

41 
UCC_CONFIG_TYPE_UINT
},

46 
ucc_off£tof
(
ucc_cÚ‹xt_cÚfig_t
, 
š‹º®_oob
), 
UCC_CONFIG_TYPE_UINT
},

50 
ucc_off£tof
(
ucc_cÚ‹xt_cÚfig_t
, 
thrÙe_´og»ss
),

51 
UCC_CONFIG_TYPE_UINT
},

57 
ucc_off£tof
(
ucc_cÚ‹xt_cÚfig_t
, 
Ãt_deviûs
), 
UCC_CONFIG_TYPE_STRING_ARRAY
},

59 {
NULL
}};

60 
UCC_CONFIG_REGISTER_TABLE
(
ucc_cÚ‹xt_cÚfig_bË
, "UCC cÚ‹xt", 
NULL
,

61 
ucc_cÚ‹xt_cÚfig_t
, &
ucc_cÚfig_glob®_li¡
);

63 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_cÚfig_»ad
(
ucc_lib_šfo_t
 *
lib
, cÚ¡ *
f’ame
,

64 
ucc_cÚ‹xt_cÚfig_t
 **
cÚfig_p
)

66 
ucc_ş_cÚ‹xt_cÚfig_t
 *
ş_cÚfig
 = 
NULL
;

67 
ucc__cÚ‹xt_cÚfig_t
 *
_cÚfig
 = 
NULL
;

68 
i
;

69 
ucc_¡©us_t
 
¡©us
;

70 
ucc_cÚ‹xt_cÚfig_t
 *
cÚfig
;

72 ià(
f’ame
 !ğ
NULL
) {

73 
	`ucc_”rÜ
("read from file is‚ot implemented");

74  
UCC_ERR_NOT_IMPLEMENTED
;

76 
cÚfig
 = (
ucc_cÚ‹xt_cÚfig_t
 *)
	`ucc_m®loc
((ucc_context_config_t),

78 ià(
cÚfig
 =ğ
NULL
) {

79 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for context config",

80 (
ucc_cÚ‹xt_cÚfig_t
));

81  
UCC_ERR_NO_MEMORY
;

84 
¡©us
 = 
	`ucc_cÚfig_·r£r_fl_İts
(
cÚfig
,

85 
	`UCC_CONFIG_GET_TABLE
(
ucc_cÚ‹xt_cÚfig_bË
),

86 
lib
->
fuÎ_´efix
, 0);

87 ià(
¡©us
 !ğ
UCC_OK
) {

88 
	`ucc_”rÜ
("failedo„ead UCC core context config");

89 
”r_cÚfig
;

92 
cÚfig
->
lib
 =†ib;

93 
cÚfig
->
ş_cfgs
 = (
ucc_ş_cÚ‹xt_cÚfig_t
 **)
	`ucc_ÿÎoc
(

94 
lib
->
n_ş_libs_İ’ed
, (
ucc_ş_cÚ‹xt_cÚfig_t
 *),

96 ià(
cÚfig
->
ş_cfgs
 =ğ
NULL
) {

97 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for cl configs‡rray",

98 (
ucc_ş_cÚ‹xt_cÚfig_t
 *));

99 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

100 
”r_cÚfig
;

103 
cÚfig
->
_cfgs
 = (
ucc__cÚ‹xt_cÚfig_t
 **)
	`ucc_ÿÎoc
(

104 
lib
->
n__libs_İ’ed
, (
ucc__cÚ‹xt_cÚfig_t
 *),

106 ià(
cÚfig
->
_cfgs
 =ğ
NULL
) {

107 
	`ucc_”rÜ
("failedo‡llocate %zd bytes forl configs‡rray",

108 (
ucc__cÚ‹xt_cÚfig_t
 *));

109 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

110 
”r_cÚfigs
;

113 
cÚfig
->
n_ş_cfg
 = 0;

114 
i
 = 0; i < 
lib
->
n_ş_libs_İ’ed
; i++) {

115 
	`ucc_as£¹
(
NULL
 !ğ
lib
->
ş_libs
[
i
]->
içû
->
ş_cÚ‹xt_cÚfig
.
bË
);

116 
¡©us
 =

117 
	`ucc_ş_cÚ‹xt_cÚfig_»ad
(
lib
->
ş_libs
[
i
], 
cÚfig
, &
ş_cÚfig
);

118 ià(
UCC_OK
 !ğ
¡©us
) {

119 
	`ucc_”rÜ
("failedo„ead CL \"%s\" context configuration",

120 
lib
->
ş_libs
[
i
]->
içû
->
su³r
.
Çme
);

121 
”r_ş_cÚfig
;

123 
cÚfig
->
ş_cfgs
[cÚfig->
n_ş_cfg
] = 
ş_cÚfig
;

124 
cÚfig
->
n_ş_cfg
++;

127 
cÚfig
->
n__cfg
 = 0;

128 
i
 = 0; i < 
lib
->
n__libs_İ’ed
; i++) {

129 
	`ucc_as£¹
(
NULL
 !ğ
lib
->
_libs
[
i
]->
içû
->
_cÚ‹xt_cÚfig
.
bË
);

130 
¡©us
 =

131 
	`ucc__cÚ‹xt_cÚfig_»ad
(
lib
->
_libs
[
i
], 
cÚfig
, &
_cÚfig
);

132 ià(
UCC_OK
 !ğ
¡©us
) {

133 
	`ucc_”rÜ
("failedo„ead TL \"%s\" context configuration",

134 
lib
->
_libs
[
i
]->
içû
->
su³r
.
Çme
);

135 
”r__cÚfig
;

137 
cÚfig
->
_cfgs
[cÚfig->
n__cfg
] = 
_cÚfig
;

138 
cÚfig
->
n__cfg
++;

141 *
cÚfig_p
 = 
cÚfig
;

142  
UCC_OK
;

144 
”r__cÚfig
:

145 
i
 = 0; i < 
cÚfig
->
n__cfg
; i++) {

146 
	`ucc_ba£_cÚfig_»Ëa£
(&
cÚfig
->
_cfgs
[
i
]->
su³r
.super);

149 
”r_ş_cÚfig
:

150 
i
 = 0; i < 
cÚfig
->
n_ş_cfg
; i++) {

151 
	`ucc_ba£_cÚfig_»Ëa£
(&
cÚfig
->
ş_cfgs
[
i
]->
su³r
.super);

153 
	`ucc_ä“
(
cÚfig
->
_cfgs
);

155 
”r_cÚfigs
:

156 
	`ucc_ä“
(
cÚfig
->
ş_cfgs
);

158 
”r_cÚfig
:

159 
	`ucc_ä“
(
cÚfig
);

160  
¡©us
;

161 
	}
}

163 
šlše
 
ucc_ş_cÚ‹xt_cÚfig_t
 *

164 
	$fšd_ş_cÚ‹xt_cÚfig
(
ucc_cÚ‹xt_cÚfig_t
 *
cfg
, cÚ¡ *
Çme
)

166 
i
;

167 
i
 = 0; i < 
cfg
->
n_ş_cfg
; i++) {

168 ià(
cfg
->
ş_cfgs
[
i
] &&

169 (0 =ğ
	`¡rcmp
(
cfg
->
ş_cfgs
[
i
]->
ş_lib
->
içû
->
su³r
.
Çme
,

170 
Çme
))) {

171  
cfg
->
ş_cfgs
[
i
];

174  
NULL
;

175 
	}
}

177 
šlše
 
ucc__cÚ‹xt_cÚfig_t
 *

178 
	$fšd__cÚ‹xt_cÚfig
(
ucc_cÚ‹xt_cÚfig_t
 *
cfg
, cÚ¡ *
Çme
)

180 
i
;

181 
i
 = 0; i < 
cfg
->
n__cfg
; i++) {

182 ià(
cfg
->
_cfgs
[
i
] &&

183 (0 =ğ
	`¡rcmp
(
cfg
->
_cfgs
[
i
]->
_lib
->
içû
->
su³r
.
Çme
,

184 
Çme
))) {

185  
cfg
->
_cfgs
[
i
];

188  
NULL
;

189 
	}
}

198 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_cÚfig_modify
(
ucc_cÚ‹xt_cÚfig_t
 *
cÚfig
,

199 cÚ¡ *
compÚ’ts
,

200 cÚ¡ *
Çme
,

201 cÚ¡ *
v®ue
)

203 
i
;

204 
ucc_¡©us_t
 
¡©us
;

205 
ucc_ş_cÚ‹xt_cÚfig_t
 *
ş_cfg
;

206 
ucc__cÚ‹xt_cÚfig_t
 *
_cfg
;

207 **
tok’s
;

208 cÚ¡ *
compÚ’t
;

209 
n_tok’s
;

211 ià(
NULL
 =ğ
compÚ’ts
) {

213 
¡©us
 = 
	`ucc_cÚfig_·r£r_£t_v®ue
(
cÚfig
, 
ucc_cÚ‹xt_cÚfig_bË
, 
Çme
,

214 
v®ue
);

215 ià(
UCC_OK
 !ğ
¡©us
) {

216 
	`ucc_”rÜ
("failedo modify CORE configuration,‚ame %s, value %s",

217 
Çme
, 
v®ue
);;

218  
¡©us
;

220 } ià(0 !ğ
	`¡rcmp
(
compÚ’ts
, "all")) {

221 
tok’s
 = 
	`ucc_¡r_¥l™
(
compÚ’ts
, ",");

222 ià(!
tok’s
) {

223  
UCC_ERR_INVALID_PARAM
;

225 
n_tok’s
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s
);

227 
i
 = 0; i < 
n_tok’s
; i++) {

228 ià(
	`¡¾’
(
tok’s
[
i
]) < 4) {

229 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

230 
”r_šput
;

232 
compÚ’t
 = 
tok’s
[
i
] + 3;

233 ià(0 =ğ
	`¡ºcmp
(
tok’s
[
i
], "cl/", 3)) {

234 
ş_cfg
 = 
	`fšd_ş_cÚ‹xt_cÚfig
(
cÚfig
, 
compÚ’t
);

235 ià(!
ş_cfg
) {

236 
	`ucc_šfo
("required CL %s is‚ot…art ofhe context",

237 
compÚ’t
);

238 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

239 
”r
;

241 
¡©us
 = 
	`ucc_cÚfig_·r£r_£t_v®ue
(

242 
ş_cfg
, cl_cfg->
ş_lib
->
içû
->
ş_cÚ‹xt_cÚfig
.
bË
, 
Çme
,

243 
v®ue
);

244 ià(
UCC_OK
 !ğ
¡©us
) {

245 
	`ucc_”rÜ
("failedo modify CL \"%s\" configuration,‚ame %s, "

246 "v®u%s", 
compÚ’t
, 
Çme
, 
v®ue
);

247 
”r
;

249 } ià(0 =ğ
	`¡ºcmp
(
tok’s
[
i
], "tl/", 3)) {

250 
_cfg
 = 
	`fšd__cÚ‹xt_cÚfig
(
cÚfig
, 
compÚ’t
);

251 ià(!
_cfg
) {

252 
	`ucc_šfo
("required TL %s is‚ot…art ofhe context",

253 
compÚ’t
);

254 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

255 
”r
;

257 
¡©us
 = 
	`ucc_cÚfig_·r£r_£t_v®ue
(

258 
_cfg
,l_cfg->
_lib
->
içû
->
_cÚ‹xt_cÚfig
.
bË
, 
Çme
,

259 
v®ue
);

260 ià(
UCC_OK
 !ğ
¡©us
) {

261 
	`ucc_”rÜ
("failedo modify TL \"%s\" configuration,‚ame %s, "

262 "v®u%s", 
compÚ’t
, 
Çme
, 
v®ue
);

263 
”r
;

266 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

267 
	`ucc_”rÜ
("šv®id compÚ’ˆÇm%s", 
tok’s
[
i
]);

268 
”r_šput
;

271 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

273 
i
 = 0; i < 
cÚfig
->
n_ş_cfg
; i++) {

274 ià(
cÚfig
->
ş_cfgs
[
i
]) {

275 
¡©us
 = 
	`ucc_cÚfig_·r£r_£t_v®ue
(

276 
cÚfig
->
ş_cfgs
[
i
],

277 
cÚfig
->
ş_cfgs
[
i
]->
ş_lib
->
içû
->
ş_cÚ‹xt_cÚfig
.
bË
,

278 
Çme
, 
v®ue
);

279 ià(
UCC_OK
 !ğ
¡©us
) {

280 
	`ucc_”rÜ
("failedo modify CL \"%s\" configuration,‚ame "

282 
cÚfig
->
ş_cfgs
[
i
]->
ş_lib
->
içû
->
su³r
.
Çme
,‚ame,

283 
v®ue
);

284  
¡©us
;

289  
UCC_OK
;

291 
”r_šput
:

292 
	`ucc_”rÜ
("incorrect component‚ame %s is…rovided. "

294 
tok’s
[
i
]);

295 
”r
:

296 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

297  
¡©us
;

298 
	}
}

300 
	$ucc_cÚ‹xt_cÚfig_»Ëa£
(
ucc_cÚ‹xt_cÚfig_t
 *
cÚfig
)

302 
i
;

304 
i
 = 0; i < 
cÚfig
->
n__cfg
; i++) {

305 
	`ucc_ba£_cÚfig_»Ëa£
(&
cÚfig
->
_cfgs
[
i
]->
su³r
.super);

308 
i
 = 0; i < 
cÚfig
->
n_ş_cfg
; i++) {

309 
	`ucc_ba£_cÚfig_»Ëa£
(&
cÚfig
->
ş_cfgs
[
i
]->
su³r
.super);

312 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(
cÚfig
, 
ucc_cÚ‹xt_cÚfig_bË
);

313 
	`ucc_ä“
(
cÚfig
->
_cfgs
);

314 
	`ucc_ä“
(
cÚfig
->
ş_cfgs
);

315 
	`ucc_ä“
(
cÚfig
);

316 
	}
}

325 
	$ucc_cÚ‹xt_cÚfig_´št
(cÚ¡ 
ucc_cÚ‹xt_cÚfig_h
 
cÚfig
, 
FILE
 *
¡»am
,

326 cÚ¡ *
t™Ë
,

327 
ucc_cÚfig_´št_æags_t
 
´št_æags
)

329 
i
;

330 
´št_h—d”
 = 
´št_æags
 & 
UCC_CONFIG_PRINT_HEADER
;

331 
æags
 = 
´št_æags
;

334 
æags
 |ğ
UCC_CONFIG_PRINT_HEADER
;

336 ià(
´št_h—d”
) {

337 
	`ucc_cÚfig_·r£r_´št_İts
(

338 
¡»am
, 
t™Ë
, 
cÚfig
,

339 
ucc_cÚ‹xt_cÚfig_bË
, "",

340 
cÚfig
->
lib
->
fuÎ_´efix
, 
UCC_CONFIG_PRINT_HEADER
);

343 
	`ucc_cÚfig_·r£r_´št_İts
(

344 
¡»am
, "CORE",

345 
cÚfig
, 
ucc_cÚ‹xt_cÚfig_bË
, "",

346 
cÚfig
->
lib
->
fuÎ_´efix
, (
ucc_cÚfig_´št_æags_t
)
æags
);

348 
i
 = 0; i < 
cÚfig
->
n_ş_cfg
; i++) {

349 
	`ucc_cÚfig_·r£r_´št_İts
(

350 
¡»am
, 
cÚfig
->
lib
->
ş_libs
[
i
]->
içû
->
ş_cÚ‹xt_cÚfig
.
Çme
,

351 
cÚfig
->
ş_cfgs
[
i
],

352 
cÚfig
->
lib
->
ş_libs
[
i
]->
içû
->
ş_cÚ‹xt_cÚfig
.
bË
,

353 
cÚfig
->
lib
->
ş_libs
[
i
]->
içû
->
ş_cÚ‹xt_cÚfig
.
´efix
,

354 
cÚfig
->
lib
->
fuÎ_´efix
, (
ucc_cÚfig_´št_æags_t
)
æags
);

356 
	}
}

358 
šlše
 
	$ucc_cİy_cÚ‹xt_·¿ms
(
ucc_cÚ‹xt_·¿ms_t
 *
d¡
,

359 cÚ¡ 
ucc_cÚ‹xt_·¿ms_t
 *
¤c
)

361 
d¡
->
mask
 = 
¤c
->mask;

362 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_CONTEXT_PARAM_FIELD_TYPE
, 
ty³
);

363 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_CONTEXT_PARAM_FIELD_OOB
, 
oob
);

364 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_CONTEXT_PARAM_FIELD_ID
, 
ùx_id
);

365 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_CONTEXT_PARAM_FIELD_SYNC_TYPE
,

366 
sync_ty³
);

367 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_CONTEXT_PARAM_FIELD_MEM_PARAMS
, 
mem_·¿ms
);

368 
	}
}

370 
ucc_¡©us_t
 
	$ucc_ü—‹__cÚ‹xts
(
ucc_cÚ‹xt_t
 *
ùx
,

371 
ucc_cÚ‹xt_cÚfig_t
 *
ùx_cÚfig
,

372 
ucc_ba£_cÚ‹xt_·¿ms_t
 
b_·¿ms
)

374 
ucc_lib_šfo_t
 *
lib
 = 
ùx
->lib;

375 
ucc__lib_t
 *
_lib
;

376 
ucc_ba£_cÚ‹xt_t
 *
b_ùx
;

377 
i
, 
num_s
;

378 
ucc_¡©us_t
 
¡©us
;

379 
ucc_ba£_lib_©Œ_t
 
©Œ
;

380 
ùx_£rviû_‹am
;

382 
ùx_£rviû_‹am
 = 
ùx_cÚfig
->
š‹º®_oob
 &&

383 
b_·¿ms
.
·¿ms
.
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
;

384 
num_s
 = 
ùx_cÚfig
->
n__cfg
;

385 
ùx
->
_ùx
 = (
ucc__cÚ‹xt_t
 **)
	`ucc_m®loc
(

386 (
ucc__cÚ‹xt_t
 *è* 
num_s
, "tl_ctx_array");

387 ià(!
ùx
->
_ùx
) {

388 
	`ucc_”rÜ
("failedo‡llocate %zd bytes forl_ctx‡rray",

389 (
ucc__cÚ‹xt_t
 *è* 
num_s
);

390  
UCC_ERR_NO_MEMORY
;

392 
ùx
->
n__ùx
 = 0;

393 
i
 = 0; i < 
num_s
; i++) {

394 
_lib
 = 
ùx_cÚfig
->
_cfgs
[
i
]->tl_lib;

395 
¡©us
 = 
_lib
->
içû
->
lib
.
	`g‘_©Œ
(&_lib->
su³r
, &
©Œ
);

396 ià(
UCC_OK
 !ğ
¡©us
) {

397 
	`ucc_”rÜ
("failedo queryl†ib %s‡ttr",

398 
_lib
->
içû
->
su³r
.
Çme
);

399  
¡©us
;

401 ià((
©Œ
.
æags
 & 
UCC_BASE_LIB_FLAG_CTX_SERVICE_TEAM_REQUIRED
) &&

402 (!
ùx_£rviû_‹am
)) {

403 
	`ucc_debug
("can‚ot createl/%s context because context service "

405 
_lib
->
içû
->
su³r
.
Çme
);

409 
¡©us
 = 
_lib
->
içû
->
cÚ‹xt
.
	`ü—‹
(

410 &
b_·¿ms
, &
ùx_cÚfig
->
_cfgs
[
i
]->
su³r
.su³r, &
b_ùx
);

411 ià(
UCC_OK
 !ğ
¡©us
) {

414 ià(
UCC_ERR_LAST
 !ğ
¡©us
) {

415 ià(
	`ucc__is_»quœed
(
lib
, 
_lib
->
içû
, 1)) {

416 
	`ucc_”rÜ
("failedo createl context for %s",

417 
_lib
->
içû
->
su³r
.
Çme
);

419 
	`ucc_debug
("failedo createl context for %s",

420 
_lib
->
içû
->
su³r
.
Çme
);

425 
ùx
->
_ùx
[ùx->
n__ùx
] = 
	`ucc_d”ived_of
(
b_ùx
, 
ucc__cÚ‹xt_t
);

426 
ùx
->
n__ùx
++;

428 ià(
ùx
->
n__ùx
 == 0) {

429 
	`ucc_”rÜ
("nol contexts were created");

430 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

431 
”r
;

435 
ùx
->
®l_s
.
couÁ
 = ctx->
n__ùx
;

436 
ùx
->
®l_s
.
Çmes
 = 
	`ucc_m®loc
((*è* ctx->
n__ùx
, "all_tls");

437 ià(!
ùx
->
®l_s
.
Çmes
) {

438 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for‡ll_tls‚ames",

439 (*è* 
ùx
->
n__ùx
);

440 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

441 
”r
;

444 
i
 = 0; i < 
ùx
->
n__ùx
; i++) {

445 
ùx
->
®l_s
.
Çmes
[
i
] = (*)
	`ucc_d”ived_of
(ùx->
_ùx
[i]->
su³r
.
lib
,

446 
ucc__lib_t
)->
içû
->
su³r
.
Çme
;

448  
UCC_OK
;

449 
”r
:

450 
i
 = 0; i < 
ùx
->
n__ùx
; i++) {

451 
_lib
 = 
	`ucc_d”ived_of
(
ùx
->
_ùx
[
i
]->
su³r
.
lib
, 
ucc__lib_t
);

452 
_lib
->
içû
->
cÚ‹xt
.
	`de¡roy
(&
ùx
->
_ùx
[
i
]->
su³r
);

454 
	`ucc_ä“
(
ùx
->
_ùx
);

455  
¡©us
;

456 
	}
}

458 
ucc_¡©us_t
 
	$ucc_cÜe_addr_exchªge
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_oob_cŞl_t
 *
oob
,

459 
ucc_addr_¡Üage_t
 *
addr_¡Üage
)

461 
size_t
 *
addr_Ëns
;

462 
ucc_cÚ‹xt_©Œ_t
 
©Œ
;

463 
ucc_¡©us_t
 
¡©us
;

464 
ucc_¿nk_t
 
i
;

465 
size_t
 
max_add¾’
;

467 
pŞl
:

468 ià(
addr_¡Üage
->
oob_»q
) {

469 
¡©us
 = 
oob
->
	`»q_‹¡
(
addr_¡Üage
->
oob_»q
);

470 ià(
¡©us
 < 0) {

471 
oob
->
	`»q_ä“
(
addr_¡Üage
->
oob_»q
);

472 
	`ucc_”rÜ
("oob„eqest failed duringeam‡ddrƒxchange");

473  
¡©us
;

474 } ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

475  
¡©us
;

477 
oob
->
	`»q_ä“
(
addr_¡Üage
->
oob_»q
);

478 
addr_¡Üage
->
oob_»q
 = 
NULL
;

480 ià(0 =ğ
addr_¡Üage
->
addr_Ën
) {

481 ià(
NULL
 =ğ
addr_¡Üage
->
¡Üage
) {

482 
addr_¡Üage
->
size
 = 
oob
->
n_oob_•s
;

483 
©Œ
.
mask
 = 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR_LEN
 |

484 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
;

485 
¡©us
 = 
	`ucc_cÚ‹xt_g‘_©Œ
(
cÚ‹xt
, &
©Œ
);

486 ià(
UCC_OK
 !ğ
¡©us
) {

487 
	`ucc_”rÜ
("failedo query ctx‡ddress");

488  
¡©us
;

490 
addr_¡Üage
->
¡Üage
 = 
	`ucc_m®loc
(

491 
addr_¡Üage
->
size
 * (
size_t
), "max_addrlen_tmp");

492 ià(!
addr_¡Üage
->
¡Üage
) {

493 
	`ucc_”rÜ
(

495 
addr_¡Üage
->
size
 * (
size_t
));

496  
UCC_ERR_NO_MEMORY
;

499 
¡©us
 = 
oob
->
	`®lg©h”
(&
cÚ‹xt
->
©Œ
.
ùx_addr_Ën
,

500 
addr_¡Üage
->
¡Üage
, (
size_t
),

501 
oob
->
cŞl_šfo
, &
addr_¡Üage
->
oob_»q
);

502 ià(
UCC_OK
 !ğ
¡©us
) {

503 
	`ucc_”rÜ
("failedo start oob‡llgather");

504  
¡©us
;

506 
pŞl
;

508 
addr_Ëns
 = (
size_t
 *)
addr_¡Üage
->
¡Üage
;

509 
	`ucc_as£¹
(
addr_¡Üage
->
¡Üage
 !ğ
NULL
);

510 
i
 = 0; i < 
addr_¡Üage
->
size
; i++) {

511 ià(
addr_Ëns
[
i
] > 
addr_¡Üage
->
addr_Ën
) {

512 
addr_¡Üage
->
addr_Ën
 = 
addr_Ëns
[
i
];

515 ià(
addr_¡Üage
->
addr_Ën
 == 0 ) {

516 
	`ucc_ä“
(
addr_¡Üage
->
¡Üage
);

517 
addr_¡Üage
->
¡Üage
 = 
NULL
;

518  
UCC_OK
;

520 
max_add¾’
 = 
addr_¡Üage
->
addr_Ën
;

521 
addr_¡Üage
->
¡Üage
 =

522 
	`ucc_»®loc
(
addr_¡Üage
->
¡Üage
,

523 (
addr_¡Üage
->
size
 + 1è* 
max_add¾’
, "addr_storage");

524 ià(!
addr_¡Üage
->
¡Üage
) {

525 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for‡ddr storage",

526 
addr_¡Üage
->
size
 * 
max_add¾’
);

527  
UCC_ERR_NO_MEMORY
;

529 
	`memıy
(

530 
	`PTR_OFFSET
(
addr_¡Üage
->
¡Üage
, 
max_add¾’
 *‡ddr_¡Üage->
size
),

531 
cÚ‹xt
->
©Œ
.
ùx_addr
, cÚ‹xt->©Œ.
ùx_addr_Ën
);

532 
¡©us
 = 
oob
->
	`®lg©h”
(

533 
	`PTR_OFFSET
(
addr_¡Üage
->
¡Üage
, 
max_add¾’
 *‡ddr_¡Üage->
size
),

534 
addr_¡Üage
->
¡Üage
, 
max_add¾’
, 
oob
->
cŞl_šfo
,

535 &
addr_¡Üage
->
oob_»q
);

536 ià(
UCC_OK
 !ğ
¡©us
) {

537 
	`ucc_”rÜ
("failedo start oob‡llgather");

538  
¡©us
;

540 
pŞl
;

542 
	`ucc_as£¹
(
addr_¡Üage
->
addr_Ën
);

546 
ucc_¿nk_t
 
r
 = 
UCC_RANK_MAX
;

547 
j
;

548 
ucc_cÚ‹xt_addr_h—d”_t
 *
h
, *
h0
;

550 
addr_¡Üage
->
æags
 = 
UCC_ADDR_STORAGE_FLAG_TLS_SYMMETRIC
;

551 
h0
 = 
	`UCC_ADDR_STORAGE_RANK_HEADER
(
addr_¡Üage
, 0);

552 
i
 = 0; i < 
addr_¡Üage
->
size
; i++) {

553 
h
 = 
	`UCC_ADDR_STORAGE_RANK_HEADER
(
addr_¡Üage
, 
i
);

554 ià(
	`UCC_CTX_ID_EQUAL
(
cÚ‹xt
->
id
, 
h
->
ùx_id
)) {

557 ià(
r
 !ğ
UCC_RANK_MAX
) {

558 
	`ucc_”rÜ
("´oøšfØcŞlisiÚ: %d %d", 
r
, 
i
);

559  
UCC_ERR_NO_MESSAGE
;

561 
r
 = 
i
;

563 ià(
h
->
n_compÚ’ts
 =ğ
h0
->n_components) {

565 
j
 = 0; j < 
h
->
n_compÚ’ts
; j++) {

566 ià(
h
->
compÚ’ts
[
j
].
id
 !ğ
h0
->components[j].id) {

567 
addr_¡Üage
->
æags
 = 0;

572 
addr_¡Üage
->
æags
 = 0;

575 
addr_¡Üage
->
¿nk
 = 
r
;

578  
UCC_OK
;

579 
	}
}

581 
	$»move__ùx_äom_¬¿y
(
ucc__cÚ‹xt_t
 **
¬¿y
, *
size
,

582 
ucc__cÚ‹xt_t
 *
_ùx
)

584 
i
;

586 
i
 = 0; i < (*
size
); i++) {

587 ià(
¬¿y
[
i
] =ğ
_ùx
) {

591 ià(
i
 =ğ(*
size
)) {

596 (*
size
)--;

597 ; 
i
 < (*
size
); i++) {

598 
¬¿y
[
i
] =‡rray[i + 1];

600 
	}
}

602 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_ü—‹_´oc_šfo
(
ucc_lib_h
 
lib
,

603 cÚ¡ 
ucc_cÚ‹xt_·¿ms_t
 *
·¿ms
,

604 cÚ¡ 
ucc_cÚ‹xt_cÚfig_h
 
cÚfig
,

605 
ucc_cÚ‹xt_h
 *
cÚ‹xt
,

606 
ucc_´oc_šfo_t
 *
´oc_šfo
)

608 
ušt32_t
 
tİo_»quœed
 = 0;

609 
ušt64_t
 
ü—‹d_ùx_couÁ”
 = 0;

610 
ucc_ba£_cÚ‹xt_·¿ms_t
 
b_·¿ms
;

611 
ucc_ba£_cÚ‹xt_t
 *
b_ùx
;

612 
ucc_ba£_ùx_©Œ_t
 
c_©Œ
;

613 
ucc_ş_lib_©Œ_t
 
l_©Œ
;

614 
ucc_ş_lib_t
 *
ş_lib
;

615 
ucc__cÚ‹xt_t
 *
_ùx
;

616 
ucc__lib_t
 *
_lib
;

617 
ucc_cÚ‹xt_t
 *
ùx
;

618 
ucc_¡©us_t
 
¡©us
;

619 
ušt64_t
 
i
, 
j
, 
n__ùx
;

620 
num_şs
;

622 
num_şs
 = 
cÚfig
->
n_ş_cfg
;

623 
ùx
 = 
	`ucc_ÿÎoc
(1, (
ucc_cÚ‹xt_t
), "ucc_context");

624 ià(!
ùx
) {

625 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ucc_context",

626 (
ucc_cÚ‹xt_t
));

627 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

628 
”rÜ
;

630 
ùx
->
Ãt_deviûs
.
couÁ
 = 0;

631 
	`ucc_cÚfig_Çmes_¬¿y_dup
(&
ùx
->
Ãt_deviûs
, &
cÚfig
->net_devices);

633 
ùx
->
thrÙe_´og»ss
 = 
cÚfig
->throttle_progress;

634 
ùx
->
¿nk
 = 
UCC_RANK_MAX
;

635 
ùx
->
lib
 =†ib;

636 
ùx
->
ids
.
poŞ_size
 = 
cÚfig
->
‹am_ids_poŞ_size
;

637 
	`ucc_li¡_h—d_š™
(&
ùx
->
´og»ss_li¡
);

638 
	`ucc_cİy_cÚ‹xt_·¿ms
(&
ùx
->
·¿ms
,…arams);

639 
	`ucc_cİy_cÚ‹xt_·¿ms
(&
b_·¿ms
.
·¿ms
,…arams);

640 
b_·¿ms
.
cÚ‹xt
 = 
ùx
;

641 
b_·¿ms
.
e¡im©ed_num_•s
 = 
cÚfig
->estimated_num_eps;

642 
b_·¿ms
.
e¡im©ed_num_µn
 = 
cÚfig
->estimated_num_ppn;

643 
b_·¿ms
.
´efix
 = 
lib
->
fuÎ_´efix
;

644 
b_·¿ms
.
th»ad_mode
 = 
lib
->
©Œ
.thread_mode;

645 ià(
·¿ms
->
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
) {

646 
ùx
->
¿nk
 = 
·¿ms
->
oob
.
oob_•
;

648 
¡©us
 = 
	`ucc_ü—‹__cÚ‹xts
(
ùx
, 
cÚfig
, 
b_·¿ms
);

649 ià(
UCC_OK
 !ğ
¡©us
) {

651 
	`ucc_”rÜ
("failedo createl contexts");

652 
”rÜ_ùx
;

655 
ùx
->
ş_ùx
 = (
ucc_ş_cÚ‹xt_t
 **)
	`ucc_m®loc
(

656 (
ucc_ş_cÚ‹xt_t
 *è* 
num_şs
, "cl_ctx_array");

657 ià(!
ùx
->
ş_ùx
) {

658 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for cl_ctx‡rray",

659 (
ucc_ş_cÚ‹xt_t
 *è* 
num_şs
);

660 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

661 
”rÜ_ùx
;

663 
ùx
->
n_ş_ùx
 = 0;

664 
ùx
->
ş_æags
 = 0;

665 
i
 = 0; i < 
num_şs
; i++) {

666 
ş_lib
 = 
cÚfig
->
ş_cfgs
[
i
]->cl_lib;

668 
¡©us
 = 
ş_lib
->
içû
->
cÚ‹xt
.
	`ü—‹
(

669 &
b_·¿ms
, &
cÚfig
->
ş_cfgs
[
i
]->
su³r
.su³r, &
b_ùx
);

670 ià(
UCC_OK
 !ğ
¡©us
) {

671 ià(
lib
->
¥ecific_şs_»que¡ed
) {

672 
	`ucc_”rÜ
("failedo create cl context for %s",

673 
ş_lib
->
içû
->
su³r
.
Çme
);

674 
”rÜ_ùx_ü—‹
;

678 ià(
UCC_ERR_LAST
 !ğ
¡©us
) {

680 
	`ucc_w¬n
("failedo create cl context for %s, skipping",

681 
ş_lib
->
içû
->
su³r
.
Çme
);

686 
ùx
->
ş_ùx
[ùx->
n_ş_ùx
] = 
	`ucc_d”ived_of
(
b_ùx
, 
ucc_ş_cÚ‹xt_t
);

687 
ùx
->
n_ş_ùx
++;

689 
	`mem£t
(&
c_©Œ
, 0, (c_attr));

690 
¡©us
 = 
ş_lib
->
içû
->
cÚ‹xt
.
	`g‘_©Œ
(
b_ùx
, &
c_©Œ
);

691 ià(
¡©us
 !ğ
UCC_OK
) {

692 
	`ucc_”rÜ
("failedo query context‡ttributes for %s",

693 
ş_lib
->
içû
->
su³r
.
Çme
);

694 
”rÜ_ùx_ü—‹
;

696 ià(
c_©Œ
.
tİo_»quœed
) {

697 
tİo_»quœed
 = 1;

700 
	`mem£t
(&
l_©Œ
, 0, (l_attr));

701 
¡©us
 = 
ş_lib
->
içû
->
lib
.
	`g‘_©Œ
(&ş_lib->
su³r
, &
l_©Œ
.super);

702 ià(
UCC_OK
 !ğ
¡©us
) {

703 
	`ucc_”rÜ
("çedØqu”y†ib % ©Œ", 
ş_lib
->
içû
->
su³r
.
Çme
);

704 
”rÜ_ùx_ü—‹
;

706 
ùx
->
ş_æags
 |ğ
l_©Œ
.
su³r
.
æags
;

708 ià(0 =ğ
ùx
->
n_ş_ùx
) {

709 
	`ucc_”rÜ
("no CL context created in ucc_context_create");

710 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

711 
”rÜ_ùx
;

717 
ùx
->
th»ad_mode
 = ((
·¿ms
->
ty³
 =ğ
UCC_CONTEXT_EXCLUSIVE
) &&

718 (
·¿ms
->
mask
 & 
UCC_CONTEXT_PARAM_FIELD_TYPE
))

719 ? 
UCC_THREAD_SINGLE


720 : 
lib
->
©Œ
.
th»ad_mode
;

721 
¡©us
 = 
	`ucc_´og»ss_queue_š™
(&
ùx
->
pq
, ctx->
th»ad_mode
,

722 
cÚfig
->
lock_ä“_´og»ss_q
);

723 ià(
UCC_OK
 !ğ
¡©us
) {

724 
	`ucc_”rÜ
("çedØš™…rog»s queufÜ cÚ‹xˆ%p", 
ùx
);

725 
”rÜ_ùx_ü—‹
;

727 
ùx
->
id
.
pi
 = *
´oc_šfo
;

728 
ùx
->
id
.
£q_num
 = 
	`ucc_©omic_çdd32
(&
ucc_cÚ‹xt_£q_num
, 1);

729 ià(
·¿ms
->
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
 &&

730 
·¿ms
->
oob
.
n_oob_•s
 > 1) {

734 
¡©us
 = 
	`ucc_cÜe_addr_exchªge
(
ùx
, &ùx->
·¿ms
.
oob
,

735 &
ùx
->
addr_¡Üage
);

736 ià(
¡©us
 < 0) {

737 
	`ucc_”rÜ
("failedoƒxchange‡ddresses during context "

739 
	`ucc_¡©us_¡ršg
(
¡©us
));

740 
”rÜ_ùx_ü—‹
;

742 } 
¡©us
 =ğ
UCC_INPROGRESS
);

744 ià(
tİo_»quœed
) {

746 
¡©us
 = 
	`ucc_cÚ‹xt_tİo_š™
(&
ùx
->
addr_¡Üage
, &ùx->
tİo
);

747 ià(
UCC_OK
 !ğ
¡©us
) {

748 
	`ucc_ä“
(
ùx
->
addr_¡Üage
.
¡Üage
);

749 
	`ucc_”rÜ
("failedo init ctxopo");

750 
”rÜ_ùx_ü—‹
;

753 
	`ucc_as£¹
(
ùx
->
addr_¡Üage
.
¿nk
 =ğ
·¿ms
->
oob
.
oob_•
);

755 ià(
cÚfig
->
š‹º®_oob
) {

756 ià(
·¿ms
->
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
 &&

757 
·¿ms
->
oob
.
n_oob_•s
 > 1) {

758 
ucc_ba£_‹am_·¿ms_t
 
t_·¿ms
;

759 
ucc_ba£_‹am_t
 * 
b_‹am
;

760 
¡©us
 = 
	`ucc__cÚ‹xt_g‘
(
ùx
, "uı", &ùx->
£rviû_ùx
);

761 ià(
UCC_OK
 !ğ
¡©us
) {

762 ià(
cÚfig
->
š‹º®_oob
 == 2) {

763 
	`ucc_”rÜ
(

766 
”rÜ_ùx_ü—‹
;

768 
	`ucc_debug
("TL UCP context is‚ot‡vailable, "

771 
	`mem£t
(&
t_·¿ms
.
m­
, 0, (
ucc_•_m­_t
));

772 
	`mem£t
(&
t_·¿ms
.
·¿ms
, 0, (
ucc_‹am_·¿ms_t
));

773 
t_·¿ms
.
·¿ms
.
mask
 = 
UCC_TEAM_PARAM_FIELD_EP
 |

774 
UCC_TEAM_PARAM_FIELD_EP_RANGE
 |

775 
UCC_TEAM_PARAM_FIELD_OOB
;

776 
t_·¿ms
.
·¿ms
.
oob
.
®lg©h”
 = 
ùx
->params.oob.allgather;

777 
t_·¿ms
.
·¿ms
.
oob
.
»q_‹¡
 = 
ùx
->params.oob.req_test;

778 
t_·¿ms
.
·¿ms
.
oob
.
»q_ä“
 = 
ùx
->params.oob.req_free;

779 
t_·¿ms
.
·¿ms
.
oob
.
cŞl_šfo
 = 
ùx
->params.oob.coll_info;

780 
t_·¿ms
.
·¿ms
.
oob
.
n_oob_•s
 = 
ùx
->params.oob.n_oob_eps;

781 
t_·¿ms
.
·¿ms
.
•_¿nge
 = 
UCC_COLLECTIVE_EP_RANGE_CONTIG
;

782 
t_·¿ms
.
·¿ms
.
•
 = 
ùx
->
¿nk
;

783 
t_·¿ms
.
¿nk
 = 
ùx
->rank;

784 
t_·¿ms
.
size
 = 
ùx
->
·¿ms
.
oob
.
n_oob_•s
;

786 
t_·¿ms
.
scİe
 = 
UCC_CL_LAST
 + 1;

787 
t_·¿ms
.
scİe_id
 = 0;

788 
t_·¿ms
.
id
 = 0;

789 
t_·¿ms
.
‹am
 = 
NULL
;

790 
t_·¿ms
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

791 
t_·¿ms
.
m­
.
•_num
 =_·¿ms.
size
;

792 
¡©us
 = 
	`UCC_TL_CTX_IFACE
(
ùx
->
£rviû_ùx
)

793 ->
‹am
.
	`ü—‹_po¡
(&
ùx
->
£rviû_ùx
->
su³r
,

794 &
t_·¿ms
, &
b_‹am
);

795 ià(
UCC_OK
 !ğ
¡©us
) {

796 
	`ucc_”rÜ
("ctx serviceeam create…ost failed with status: %s",

797 
	`ucc_¡©us_¡ršg
(
¡©us
));

798 
”rÜ_ùx_ü—‹
;

801 
¡©us
 = 
	`UCC_TL_CTX_IFACE
(
ùx
->
£rviû_ùx
)

802 ->
‹am
.
	`ü—‹_‹¡
(
b_‹am
);

803 } 
UCC_INPROGRESS
 =ğ
¡©us
);

804 ià(
¡©us
 < 0) {

805 
	`ucc_”rÜ
("failedo create ctx serviceeam with status: %s",

806 
	`ucc_¡©us_¡ršg
(
¡©us
));

807 
”rÜ_ùx_ü—‹
;

809 
ùx
->
£rviû_‹am
 = 
	`ucc_d”ived_of
(
b_‹am
, 
ucc__‹am_t
);

811 } ià(
cÚfig
->
š‹º®_oob
 == 2) {

812 
	`ucc_”rÜ
("UCC_INTERNAL_OOB was force„equested for context "

814 
”rÜ_ùx_ü—‹
;

818 
n__ùx
 = 
ùx
->n_tl_ctx;

819 
i
 = 0; i < 
n__ùx
; i++) {

820 
_ùx
 = 
ùx
->_ùx[
i
];

821 
_lib
 = 
	`ucc_d”ived_of
(
_ùx
->
su³r
.
lib
, 
ucc__lib_t
);

822 ià(
_lib
->
içû
->
cÚ‹xt
.
ü—‹_•og
) {

823 
¡©us
 = 
_lib
->
içû
->
cÚ‹xt
.
	`ü—‹_•og
(&
_ùx
->
su³r
);

824 ià(
UCC_OK
 =ğ
¡©us
) {

825 
ü—‹d_ùx_couÁ”
++;

827 ià(
	`ucc__is_»quœed
(
lib
, 
_lib
->
içû
, 1)) {

828 
	`ucc_”rÜ
("ctx createƒpilog for %s failed with status: %s",

829 
_lib
->
içû
->
su³r
.
Çme
, 
	`ucc_¡©us_¡ršg
(
¡©us
));

830 
”rÜ_ùx_ü—‹_•og
;

832 
	`ucc_debug
("ctx createƒpilog for %s failed with status: %s",

833 
_lib
->
içû
->
su³r
.
Çme
, 
	`ucc_¡©us_¡ršg
(
¡©us
));

834 
_lib
->
içû
->
cÚ‹xt
.
	`de¡roy
(&
_ùx
->
su³r
);

835 
j
 = 0; j < 
ùx
->
n_ş_ùx
; j++) {

836 
	`»move__ùx_äom_¬¿y
(
ùx
->
ş_ùx
[
j
]->
_ùxs
,

837 &
ùx
->
ş_ùx
[
j
]->
n__ùxs
,

838 
_ùx
);

840 
	`»move__ùx_äom_¬¿y
(
ùx
->
_ùx
, &ùx->
n__ùx
,

841 
_ùx
);

845 
ü—‹d_ùx_couÁ”
++;

848 ià(0 =ğ
ü—‹d_ùx_couÁ”
) {

849 
	`ucc_”rÜ
("no TL context created");

850 
¡©us
 = 
UCC_ERR_NO_RESOURCE
;

851 
”rÜ_ùx_ü—‹_•og
;

854 
	`ucc_debug
("created ucc context %p for†ib %s:ype %s,hread mode %s, oob %s,‚umƒps %d,‚um…pn %d",

855 
ùx
, 
lib
->
fuÎ_´efix
,

856 
·¿ms
->
mask
 & 
UCC_CONTEXT_PARAM_FIELD_TYPE
 ? 
	`ucc_cÚ‹xt_ty³_¡r
Õ¬ams->
ty³
) : "n/a",

857 
	`ucc_th»ad_mode_¡r
(
ùx
->
th»ad_mode
),

858 
·¿ms
->
mask
 & 
UCC_CONTEXT_PARAM_FIELD_OOB
 ? "true" : "false",

859 
cÚfig
->
e¡im©ed_num_•s
,

860 
cÚfig
->
e¡im©ed_num_µn
);

861 *
cÚ‹xt
 = 
ùx
;

862  
UCC_OK
;

864 
”rÜ_ùx_ü—‹_•og
:

865 
j
 = 0; j < 
ü—‹d_ùx_couÁ”
; j++) {

866 
_ùx
 = 
ùx
->_ùx[
j
];

867 
_lib
 = 
	`ucc_d”ived_of
(
_ùx
->
su³r
.
lib
, 
ucc__lib_t
);

868 
_lib
->
içû
->
cÚ‹xt
.
	`de¡roy
(&
_ùx
->
su³r
);

870 
”rÜ_ùx_ü—‹
:

871 
i
 = 0; i < 
ùx
->
n_ş_ùx
; i++) {

872 
cÚfig
->
ş_cfgs
[
i
]->
ş_lib
->
içû
->
cÚ‹xt
.
	`de¡roy
(

873 &
ùx
->
ş_ùx
[
i
]->
su³r
);

875 
	`ucc_ä“
(
ùx
->
ş_ùx
);

876 
”rÜ_ùx
:

877 
	`ucc_ä“
(
ùx
);

878 
”rÜ
:

879  
¡©us
;

880 
	}
}

882 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_ü—‹
(
ucc_lib_h
 
lib
,

883 cÚ¡ 
ucc_cÚ‹xt_·¿ms_t
 *
·¿ms
,

884 cÚ¡ 
ucc_cÚ‹xt_cÚfig_h
 
cÚfig
,

885 
ucc_cÚ‹xt_h
 *
cÚ‹xt
)

887  
	`ucc_cÚ‹xt_ü—‹_´oc_šfo
(
lib
, 
·¿ms
, 
cÚfig
, 
cÚ‹xt
,

888 &
ucc_loÿl_´oc
);

889 
	}
}

891 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_ä“_©Œ
(
ucc_cÚ‹xt_©Œ_t
 *
cÚ‹xt_©Œ
)

893 ià(
cÚ‹xt_©Œ
->
mask
 & 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
) {

894 
	`ucc_ä“
(
cÚ‹xt_©Œ
->
ùx_addr
);

896  
UCC_OK
;

897 
	}
}

899 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_de¡roy
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
)

901 
ucc_ş_cÚ‹xt_t
 *
ş_ùx
;

902 
ucc_ş_lib_t
 *
ş_lib
;

903 
ucc__cÚ‹xt_t
 *
_ùx
;

904 
ucc__lib_t
 *
_lib
;

905 
i
;

906 
ucc_¡©us_t
 
¡©us
;

908 ià(
UCC_OK
 !ğ
	`ucc_cÚ‹xt_ä“_©Œ
(&
cÚ‹xt
->
©Œ
)) {

909 
	`ucc_”rÜ
("failedo free context‡ttributes");

911 
i
 = 0; i < 
cÚ‹xt
->
n_ş_ùx
; i++) {

912 
ş_ùx
 = 
cÚ‹xt
->ş_ùx[
i
];

913 
ş_lib
 = 
	`ucc_d”ived_of
(
ş_ùx
->
su³r
.
lib
, 
ucc_ş_lib_t
);

914 
ş_lib
->
içû
->
cÚ‹xt
.
	`de¡roy
(&
ş_ùx
->
su³r
);

916 
	`ucc_ä“
(
cÚ‹xt
->
ş_ùx
);

918 
i
 = 0; i < 
cÚ‹xt
->
n__ùx
; i++) {

919 
_ùx
 = 
cÚ‹xt
->_ùx[
i
];

920 ià((
cÚ‹xt
->
£rviû_‹am
è&& (
_ùx
 =ğcÚ‹xt->
£rviû_ùx
)) {

925 
_lib
 = 
	`ucc_d”ived_of
(
_ùx
->
su³r
.
lib
, 
ucc__lib_t
);

926 ià(
_ùx
->
»f_couÁ
 != 0 ) {

927 
	`ucc_šfo
(" ctx % i ¡Èš u£", 
_lib
->
içû
->
su³r
.
Çme
);

929 
_lib
->
içû
->
cÚ‹xt
.
	`de¡roy
(&
_ùx
->
su³r
);

932 ià(
cÚ‹xt
->
£rviû_‹am
) {

935 
UCC_INPROGRESS
 ==

936 (
¡©us
 = 
	`UCC_TL_CTX_IFACE
(
cÚ‹xt
->
£rviû_ùx
)

937 ->
‹am
.
	`de¡roy
(&
cÚ‹xt
->
£rviû_‹am
->
su³r
))) {

938 
	`ucc_cÚ‹xt_´og»ss
(
cÚ‹xt
);

940 ià(
¡©us
 < 0) {

941 
	`ucc_”rÜ
("failedo destroy ctx serviceeam");

943 
	`ucc__cÚ‹xt_put
(
cÚ‹xt
->
£rviû_ùx
);

944 
_lib
 = 
	`ucc_d”ived_of
(
cÚ‹xt
->
£rviû_ùx
->
su³r
.
lib
, 
ucc__lib_t
);

945 ià(
cÚ‹xt
->
£rviû_ùx
->
»f_couÁ
 != 0 ) {

946 
	`ucc_šfo
(" ctx % i ¡Èš u£", 
_lib
->
içû
->
su³r
.
Çme
);

948 
_lib
->
içû
->
cÚ‹xt
.
	`de¡roy
(&cÚ‹xt->
£rviû_ùx
->
su³r
);

951 
	`ucc_cÚfig_Çmes_¬¿y_ä“
(&
cÚ‹xt
->
Ãt_deviûs
);

952 
	`ucc_cÚ‹xt_tİo_ş—nup
(
cÚ‹xt
->
tİo
);

953 
	`ucc_´og»ss_queue_fš®ize
(
cÚ‹xt
->
pq
);

954 
	`ucc_ä“
(
cÚ‹xt
->
addr_¡Üage
.
¡Üage
);

955 
	`ucc_ä“
(
cÚ‹xt
->
®l_s
.
Çmes
);

956 
	`ucc_ä“
(
cÚ‹xt
->
_ùx
);

957 
	`ucc_ä“
(
cÚ‹xt
->
ids
.
poŞ
);

958 
	`ucc_ä“
(
cÚ‹xt
);

959  
UCC_OK
;

960 
	}
}

962 
	succ_cÚ‹xt_´og»ss_’Œy
 {

963 
ucc_li¡_lšk_t
 
	mli¡_–em
;

964 
ucc_cÚ‹xt_´og»ss_â_t
 
	mâ
;

965 *
	m¬g
;

966 } 
	tucc_cÚ‹xt_´og»ss_’Œy_t
;

968 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_´og»ss_»gi¡”
(
ucc_cÚ‹xt_t
 *
ùx
,

969 
ucc_cÚ‹xt_´og»ss_â_t
 
â
,

970 *
´og»ss_¬g
)

972 
ucc_cÚ‹xt_´og»ss_’Œy_t
 *
’Œy
 =

973 
	`ucc_m®loc
((*
’Œy
), "progress_entry");

974 ià(!
’Œy
) {

975 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for…rogressƒntry",

976 (*
’Œy
));

977  
UCC_ERR_NO_MEMORY
;

979 
’Œy
->
â
 = fn;

980 
’Œy
->
¬g
 = 
´og»ss_¬g
;

981 
	`ucc_li¡_add_
(&
ùx
->
´og»ss_li¡
, &
’Œy
->
li¡_–em
);

982  
UCC_OK
;

983 
	}
}

985 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_´og»ss_d”egi¡”
(
ucc_cÚ‹xt_t
 *
ùx
,

986 
ucc_cÚ‹xt_´og»ss_â_t
 
â
,

987 *
´og»ss_¬g
)

989 
ucc_cÚ‹xt_´og»ss_’Œy_t
 *
’Œy
, *
tmp
;

990 
	`ucc_li¡_fÜ_—ch_§ã
(
’Œy
, 
tmp
, &
ùx
->
´og»ss_li¡
, 
li¡_–em
) {

991 ià(
’Œy
->
â
 =ğâ &&ƒÁry->
¬g
 =ğ
´og»ss_¬g
) {

992 
	`ucc_li¡_d–
(&
’Œy
->
li¡_–em
);

993 
	`ucc_ä“
(
’Œy
);

994  
UCC_OK
;

997  
UCC_ERR_NOT_FOUND
;

998 
	}
}

1000 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_´og»ss
(
ucc_cÚ‹xt_h
 
cÚ‹xt
)

1002 
ÿÎ_num
 = 0;

1003 
ucc_¡©us_t
 
¡©us
;

1004 
ucc_cÚ‹xt_´og»ss_’Œy_t
 *
’Œy
;

1005 
is_em±y
;

1007 
is_em±y
 = 
	`ucc_´og»ss_queue_is_em±y
(
cÚ‹xt
->
pq
);

1008 ià(
	`ucc_lik–y
(
is_em±y
)) {

1009 
ÿÎ_num
--;

1010 ià(
	`ucc_lik–y
(
ÿÎ_num
 >= 0)) {

1011  
UCC_OK
;

1014 
	`ucc_li¡_fÜ_—ch
(
’Œy
, &
cÚ‹xt
->
´og»ss_li¡
, 
li¡_–em
) {

1015 
’Œy
->
	`â
ÓÁry->
¬g
);

1017 
ÿÎ_num
 = 
cÚ‹xt
->
thrÙe_´og»ss
;

1018  
UCC_OK
;

1024 
¡©us
 = (
ucc_¡©us_t
)
	`ucc_´og»ss_queue
(
cÚ‹xt
->
pq
);

1025  (
¡©us
 >ğ0 ? 
UCC_OK
 : status);

1026 
	}
}

1028 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_·ck_addr
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
,

1029 
ucc_cÚ‹xt_addr_Ën_t
 *
addr_Ën
,

1030 *
n_·cked
,

1031 
ucc_cÚ‹xt_addr_h—d”_t
 *
h
)

1033 
ucc_cÚ‹xt_addr_Ën_t
 
tÙ®_Ën
 = 0;

1034 
±rdiff_t
 
off£t
 = 0;

1035 
i
, 
·cked
, 
Ï¡_·cked
;

1036 
ucc_ba£_ùx_©Œ_t
 
©Œ
;

1037 
ucc_ş_lib_t
 *
ş_lib
;

1038 
ucc__lib_t
 *
_lib
;

1039 
ucc_¡©us_t
 
¡©us
;

1042 
©Œ
.©Œ.
mask
 = 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR_LEN
;

1043 ià(
h
) {

1044 
©Œ
.©Œ.
mask
 |ğ
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
;

1045 
off£t
 = (
±rdiff_t
)
	`UCC_CONTEXT_ADDR_DATA
(
h
) - (ptrdiff_t)h;

1046 
Ï¡_·cked
 = 0;

1048 
·cked
 = 0;

1050 
i
 = 0; i < 
cÚ‹xt
->
n_ş_ùx
; i++) {

1051 
ş_lib
 = 
	`ucc_d”ived_of
(
cÚ‹xt
->
ş_ùx
[
i
]->
su³r
.
lib
, 
ucc_ş_lib_t
);

1052 
©Œ
.©Œ.
ùx_addr
 = 
	`PTR_OFFSET
(
h
, 
off£t
);

1053 
¡©us
 =

1054 
ş_lib
->
içû
->
cÚ‹xt
.
	`g‘_©Œ
(&cÚ‹xt->
ş_ùx
[
i
]->
su³r
, &
©Œ
);

1055 ià(
UCC_OK
 !ğ
¡©us
) {

1056 
	`ucc_”rÜ
("failedo query‡ddr†en from %s",

1057 
ş_lib
->
su³r
.
log_compÚ’t
.
Çme
);

1058  
¡©us
;

1060 
tÙ®_Ën
 +ğ
©Œ
.©Œ.
ùx_addr_Ën
;

1061 
·cked
++;

1062 ià(
h
) {

1063 
h
->
compÚ’ts
[
Ï¡_·cked
].
id
 = 
ş_lib
->
içû
->
su³r
.id;

1064 
h
->
compÚ’ts
[
Ï¡_·cked
].
off£t
 = offset;

1065 
Ï¡_·cked
++;

1066 
off£t
 +ğ
©Œ
.©Œ.
ùx_addr_Ën
;

1070 
i
 = 0; i < 
cÚ‹xt
->
n__ùx
; i++) {

1071 
_lib
 = 
	`ucc_d”ived_of
(
cÚ‹xt
->
_ùx
[
i
]->
su³r
.
lib
, 
ucc__lib_t
);

1072 
©Œ
.©Œ.
ùx_addr
 = 
	`PTR_OFFSET
(
h
, 
off£t
);

1073 
¡©us
 =

1074 
_lib
->
içû
->
cÚ‹xt
.
	`g‘_©Œ
(&cÚ‹xt->
_ùx
[
i
]->
su³r
, &
©Œ
);

1075 ià(
UCC_OK
 !ğ
¡©us
) {

1076 
	`ucc_”rÜ
("failedo query‡ddr†en from %s",

1077 
_lib
->
su³r
.
log_compÚ’t
.
Çme
);

1078  
¡©us
;

1080 
tÙ®_Ën
 +ğ
©Œ
.©Œ.
ùx_addr_Ën
;

1081 
·cked
++;

1082 ià(
h
) {

1083 
h
->
compÚ’ts
[
Ï¡_·cked
].
id
 = 
_lib
->
içû
->
su³r
.id;

1084 
h
->
compÚ’ts
[
Ï¡_·cked
].
off£t
 = offset;

1085 
Ï¡_·cked
++;

1086 
off£t
 +ğ
©Œ
.©Œ.
ùx_addr_Ën
;

1090 ià(
addr_Ën
) {

1091 *
addr_Ën
 = 
tÙ®_Ën
 + 
	`UCC_CONTEXT_ADDR_HEADER_SIZE
(
·cked
);

1094 ià(
n_·cked
) {

1095 *
n_·cked
 = 
·cked
;

1097  
UCC_OK
;

1098 
	}
}

1100 
ucc_¡©us_t
 
	$ucc_cÚ‹xt_g‘_©Œ
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
,

1101 
ucc_cÚ‹xt_©Œ_t
 *
cÚ‹xt_©Œ
)

1103 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

1104 
ucc_cÚ‹xt_addr_h—d”_t
 *
h
;

1105 ià(
cÚ‹xt_©Œ
->
mask
 & (
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR_LEN
 |

1106 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
)) {

1107 ià(!(
cÚ‹xt
->
©Œ
.
mask
 & 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR_LEN
)) {

1110 
¡©us
 = 
	`ucc_cÚ‹xt_·ck_addr
(
cÚ‹xt
, &cÚ‹xt->
©Œ
.
ùx_addr_Ën
,

1111 &
cÚ‹xt
->
n_addr_·cked
, 
NULL
);

1112 ià(
UCC_OK
 !ğ
¡©us
) {

1113 
	`ucc_”rÜ
("failedo calc ucc context‡ddress†ength");

1114  
¡©us
;

1116 
cÚ‹xt
->
©Œ
.
mask
 |ğ
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR_LEN
;

1118 
cÚ‹xt_©Œ
->
ùx_addr_Ën
 = 
cÚ‹xt
->
©Œ
.ctx_addr_len;

1121 ià(
cÚ‹xt_©Œ
->
mask
 & 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
) {

1122 ià(!(
cÚ‹xt
->
©Œ
.
mask
 & 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
)) {

1124 
h
 = 
	`ucc_m®loc
(
cÚ‹xt
->
©Œ
.
ùx_addr_Ën
, "ucc_context_address");

1125 ià(!
h
) {

1126 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ucc_context_address",

1127 
cÚ‹xt
->
©Œ
.
ùx_addr_Ën
);

1128  
UCC_ERR_NO_MEMORY
;

1130 
h
->
ùx_id
 = 
cÚ‹xt
->
id
;

1131 
h
->
n_compÚ’ts
 = 
cÚ‹xt
->
n_addr_·cked
;

1132 
¡©us
 = 
	`ucc_cÚ‹xt_·ck_addr
(
cÚ‹xt
, 
NULL
, NULL, 
h
);

1133 ià(
UCC_OK
 !ğ
¡©us
) {

1134 
	`ucc_”rÜ
("failedo calc ucc context‡ddress†ength");

1135  
¡©us
;

1137 
cÚ‹xt
->
©Œ
.
mask
 |ğ
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
;

1138 
cÚ‹xt
->
©Œ
.
ùx_addr
 = (
ucc_cÚ‹xt_addr_h
)
h
;

1140 
cÚ‹xt_©Œ
->
ùx_addr
 = 
cÚ‹xt
->
©Œ
.ctx_addr;

1143 ià(
cÚ‹xt_©Œ
->
mask
 & 
UCC_CONTEXT_ATTR_FIELD_WORK_BUFFER_SIZE
) {

1144 
ušt64_t
 
max_bufãr_size
 = 0;

1145 
i
;

1146 
ucc_ba£_ùx_©Œ_t
 
©Œ
;

1147 
ucc__lib_t
 * 
_lib
;

1149 
	`mem£t
(&
©Œ
.©Œ, 0, (
ucc_cÚ‹xt_©Œ_t
));

1150 
©Œ
.©Œ.
mask
 = 
UCC_CONTEXT_ATTR_FIELD_WORK_BUFFER_SIZE
;

1151 
©Œ
.©Œ.
glob®_wÜk_bufãr_size
 = 0;

1152 
i
 = 0; i < 
cÚ‹xt
->
n__ùx
; i++) {

1153 
_lib
 =

1154 
	`ucc_d”ived_of
(
cÚ‹xt
->
_ùx
[
i
]->
su³r
.
lib
, 
ucc__lib_t
);

1155 
¡©us
 = 
_lib
->
içû
->
cÚ‹xt
.
	`g‘_©Œ
(&cÚ‹xt->
_ùx
[
i
]->
su³r
,

1156 &
©Œ
);

1157 ià(
UCC_OK
 !ğ
¡©us
) {

1158 
	`ucc_”rÜ
("failedo obtain global work buffer size");

1159  
¡©us
;

1161 ià(
©Œ
.©Œ.
glob®_wÜk_bufãr_size
 > 
max_bufãr_size
) {

1162 
max_bufãr_size
 = 
©Œ
.©Œ.
glob®_wÜk_bufãr_size
;

1165 
cÚ‹xt_©Œ
->
glob®_wÜk_bufãr_size
 = 
max_bufãr_size
;

1168  
¡©us
;

1169 
	}
}

1171 
ucc_¡©us_t
 
	$ucc_mem_m­_impÜt
(
ucc_cÚ‹xt_h
 
cÚ‹xt
,

1172 
ucc_mem_m­_mode_t
 
mode
,

1173 cÚ¡ 
ucc_mem_m­_·¿ms_t
 *
·¿ms
, 
size_t
 *
memh_size
,

1174 
ucc_mem_m­_mem_h
 *
memh
)

1176 
ucc_cÚ‹xt_t
 *
ùx
 = (ucc_cÚ‹xt_ˆ*)
cÚ‹xt
;

1177 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

1178 
ucc_cÚfig_Çmes_¬¿y_t
 *
s
 = &
ùx
->
®l_s
;

1179 
size_t
 
off£t
 = 0;

1180 
i
;

1181 
ucc_mem_m­_memh_t
 *
loÿl_memh
;

1182 
ucc__lib_t
 *
_lib
;

1184 ià(!
memh
) {

1185 
	`ucc_”rÜ
("cannot import NULL memory handle");

1186  
UCC_ERR_INVALID_PARAM
;

1188 ià(!
·¿ms
) {

1189 
	`ucc_”rÜ
("params cannot be NULL");

1190  
UCC_ERR_INVALID_PARAM
;

1193 
loÿl_memh
 = *
memh
;

1196 
loÿl_memh
->
_h
 = (
ucc_mem_m­__t
 *)
	`ucc_ÿÎoc
(

1197 
ùx
->
n__ùx
, (
ucc_mem_m­__t
), "tl memh");

1198 
i
 = 0; i < 
ùx
->
n__ùx
; i++) {

1199 
off£t
 = 0;

1200 
j
 = 0; j < 
loÿl_memh
->
num_s
; j++) {

1201 *
Çme
 = 
	`PTR_OFFSET
(
loÿl_memh
->
·ck_bufãr
, 
off£t
);

1202 
size_t
 *
·cked_size
 = 
	`PTR_OFFSET
(
loÿl_memh
->
·ck_bufãr
, 
off£t
 + 
UCC_MEM_MAP_TL_NAME_LEN
);

1203 ià(
	`¡rcmp
(
Çme
, 
s
->
Çmes
[
i
]) == 0) {

1204 
_lib
 = 
	`ucc_d”ived_of
(
ùx
->
_ùx
[
i
]->
su³r
.
lib
, 
ucc__lib_t
);

1205 
	`¡ºıy
(
loÿl_memh
->
_h
[
j
].
_Çme
, 
s
->
Çmes
[
i
], 
UCC_MEM_MAP_TL_NAME_LEN
 - 1);

1206 
¡©us
 = 
_lib
->
içû
->
cÚ‹xt
.
	`mem_m­
(

1207 (cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *)
ùx
->
_ùx
[
i
], 
mode
,

1208 
loÿl_memh
, &loÿl_memh->
_h
[
j
]);

1209 ià(
¡©us
 < 
UCC_ERR_NOT_IMPLEMENTED
) {

1210 
	`ucc_”rÜ
("çedØimpÜˆmem m­ memh %d", 
¡©us
);

1211  
¡©us
;

1214 
off£t
 +ğ
UCC_MEM_MAP_TL_NAME_LEN
 + (
size_t
è+ *
·cked_size
;

1217 
loÿl_memh
->
mode
 = mode;

1219 
loÿl_memh
->
cÚ‹xt
 = 
ùx
;

1220 *
memh_size
 = 0;

1222  
¡©us
;

1223 
	}
}

1225 
ucc_¡©us_t
 
	$ucc_mem_m­_expÜt
(
ucc_cÚ‹xt_h
 
cÚ‹xt
,

1226 
ucc_mem_m­_mode_t
 
mode
,

1227 cÚ¡ 
ucc_mem_m­_·¿ms_t
 *
·¿ms
,

1228 
size_t
 *
memh_size
,

1229 
ucc_mem_m­_mem_h
 *
memh
)

1231 
ucc_cÚ‹xt_t
 *
ùx
 = (ucc_cÚ‹xt_ˆ*)
cÚ‹xt
;

1232 
size_t
 
tÙ®_·ck_size
 = 0;

1233 
·cked_s
 = 0;

1234 
size_t
 
off£t
 = 0;

1235 
ucc_cÚfig_Çmes_¬¿y_t
 *
s_Çmes
 = &
ùx
->
®l_s
;

1236 
ucc_mem_m­_memh_t
 *
loÿl_memh
;

1237 
ucc_mem_m­_memh_t
 *
expÜ‹d_memh
;

1238 **
·cked_bufãrs
;

1239 
ucc_¡©us_t
 
¡©us
;

1240 
ucc__lib_t
 *
_lib
;

1241 
i
;

1242 
s
;

1243 
h_šdex
;

1245 ià(
mode
 =ğ
UCC_MEM_MAP_MODE_EXPORT
) {

1246 
loÿl_memh
 = (
ucc_mem_m­_memh_t
 *)
	`ucc_ÿÎoc
(1, (ucc_mem_map_memh_t),

1248 ià(!
loÿl_memh
) {

1249 
	`ucc_”rÜ
("failedo‡llocate‡†ocal memory handle");

1250  
UCC_ERR_NO_MEMORY
;

1253 
loÿl_memh
->
_h
 = (
ucc_mem_m­__t
 *)
	`ucc_ÿÎoc
(

1254 
ùx
->
n__ùx
, (
ucc_mem_m­__t
), "tl memh");

1255 ià(!
loÿl_memh
->
_h
) {

1256 
	`ucc_”rÜ
("failedo‡llocate‡†ocal memory handle");

1257 
	`ucc_ä“
(
loÿl_memh
);

1258  
UCC_ERR_NO_MEMORY
;

1260 
loÿl_memh
->
add»ss
 = 
·¿ms
->
£gm’ts
[0].address;

1261 
loÿl_memh
->
Ën
 = 
·¿ms
->
£gm’ts
[0].len;

1263 ià(!
memh
) {

1264 
	`ucc_”rÜ
("unableoƒxport map NULL memory handle");

1265  
UCC_ERR_INVALID_PARAM
;

1267 
loÿl_memh
 = *
memh
;

1269 
·cked_bufãrs
 =

1270 (**)
	`ucc_ÿÎoc
(
ùx
->
n__ùx
, (*), "packed buffers");

1271 ià(!
·cked_bufãrs
) {

1272 ià(
mode
 =ğ
UCC_MEM_MAP_MODE_EXPORT
) {

1273 
	`ucc_ä“
(
loÿl_memh
->
_h
);

1274 
	`ucc_ä“
(
loÿl_memh
);

1276 
	`ucc_”rÜ
("failedo‡llocate space for…acked buffers");

1277  
UCC_ERR_NO_MEMORY
;

1280 ià(
mode
 !ğ
UCC_MEM_MAP_MODE_EXPORT_OFFLOAD
) {

1282 
i
 = 0; i < 
ùx
->
n__ùx
; i++) {

1283 
_lib
 = 
	`ucc_d”ived_of
(
ùx
->
_ùx
[
i
]->
su³r
.
lib
, 
ucc__lib_t
);

1285 
¡©us
 = 
_lib
->
içû
->
cÚ‹xt
.
	`mem_m­
(

1286 (cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *)
ùx
->
_ùx
[
i
], 
mode
,

1287 
loÿl_memh
, &loÿl_memh->
_h
[
i
]);

1288 ià(
¡©us
 !ğ
UCC_OK
) {

1289 ià(
¡©us
 < 
UCC_ERR_NOT_IMPLEMENTED
) {

1290 
	`ucc_”rÜ
("failedo map memory");

1291 
çed_mem_m­
;

1293 ià(
¡©us
 =ğ
UCC_ERR_NOT_IMPLEMENTED
 ||

1294 
¡©us
 =ğ
UCC_ERR_NOT_SUPPORTED
) {

1296 
loÿl_memh
->
_h
[
i
].
·cked_size
 = 0;

1302 
i
 = 0; i < 
ùx
->
n__ùx
; i++) {

1303 
_lib
 = 
	`ucc_d”ived_of
(
ùx
->
_ùx
[
i
]->
su³r
.
lib
, 
ucc__lib_t
);

1304 ià(
mode
 !ğ
UCC_MEM_MAP_MODE_EXPORT_OFFLOAD
) {

1305 
h_šdex
 = 
i
;

1307 
h_šdex
 = -1;

1308 
j
 = 0; j < 
loÿl_memh
->
num_s
; j++) {

1309 ià(
	`¡rcmp
(
loÿl_memh
->
_h
[
j
].
_Çme
, 
s_Çmes
->
Çmes
[
i
]) == 0) {

1310 
h_šdex
 = 
j
;

1314 ià(
h_šdex
 == -1) {

1320 
¡©us
 = 
_lib
->
içû
->
cÚ‹xt
.
	`memh_·ck
(

1321 (cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *)
ùx
->
_ùx
[
i
],

1322 
mode
, &
loÿl_memh
->
_h
[
h_šdex
], &
·cked_bufãrs
[tlh_index]);

1323 ià(
¡©us
 !ğ
UCC_OK
) {

1324 ià(
¡©us
 < 
UCC_ERR_NOT_IMPLEMENTED
) {

1325 
	`ucc_”rÜ
("failedo…ack memory handles");

1326 
çed_·ck
;

1329 ià(
loÿl_memh
->
_h
[
h_šdex
].
·cked_size
) {

1330 ++
·cked_s
;

1332 
tÙ®_·ck_size
 +ğ
loÿl_memh
->
_h
[
h_šdex
].
·cked_size
;

1334 ià(
·cked_s
 == 0) {

1335 
	`ucc_debug
("No TLs‡vailable for…acking");

1336 
	`ucc_ä“
(
·cked_bufãrs
);

1337 ià(
mode
 =ğ
UCC_MEM_MAP_MODE_EXPORT
) {

1338 
	`ucc_ä“
(
loÿl_memh
->
_h
);

1339 
	`ucc_ä“
(
loÿl_memh
);

1341  
UCC_OK
;

1345 
expÜ‹d_memh
 = (
ucc_mem_m­_memh_t
 *)
	`ucc_ÿÎoc
(

1347 (
ucc_mem_m­_memh_t
è+ 
tÙ®_·ck_size
 +

1348 2 * (
size_t
è* 
·cked_s
,

1350 ià(!
expÜ‹d_memh
) {

1351 
	`ucc_”rÜ
("failedo‡llocate handle forƒxported buffers");

1352 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

1353 
çed_·ck
;

1357 ià(
mode
 =ğ
UCC_MEM_MAP_MODE_EXPORT
) {

1358 
expÜ‹d_memh
->
_h
 = (
ucc_mem_m­__t
 *)
	`ucc_ÿÎoc
(

1359 
·cked_s
, (
ucc_mem_m­__t
), "packedl memh");

1360 ià(!
expÜ‹d_memh
->
_h
) {

1361 
	`ucc_”rÜ
("failedo‡llocate handle forƒxported buffers'l handles");

1362 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

1363 
	`ucc_ä“
(
expÜ‹d_memh
);

1364 
çed_·ck
;

1366 
i
 = 0, 
off£t
 = 0, 
s
 = 0; i < 
ùx
->
n__ùx
; i++) {

1367 ià(
loÿl_memh
->
_h
[
i
].
·cked_size
) {

1368 
	`¡ºıy
(
	`PTR_OFFSET
(
expÜ‹d_memh
->
·ck_bufãr
, 
off£t
),

1369 
loÿl_memh
->
_h
[
i
].
_Çme
, 
UCC_MEM_MAP_TL_NAME_LEN
);

1370 
off£t
 +ğ
UCC_MEM_MAP_TL_NAME_LEN
;

1371 
	`memıy
(
	`PTR_OFFSET
(
expÜ‹d_memh
->
·ck_bufãr
, 
off£t
),

1372 &
loÿl_memh
->
_h
[
i
].
·cked_size
, (
size_t
));

1373 
off£t
 +ğ(
size_t
);

1374 
	`memıy
(
	`PTR_OFFSET
(
expÜ‹d_memh
->
·ck_bufãr
, 
off£t
),

1375 
·cked_bufãrs
[
i
], 
loÿl_memh
->
_h
[i].
·cked_size
);

1376 
	`ucc_ä“
(
·cked_bufãrs
[
i
]);

1377 
off£t
 +ğ
loÿl_memh
->
_h
[
i
].
·cked_size
;

1378 
	`memıy
(&
expÜ‹d_memh
->
_h
[
s
++], &
loÿl_memh
->_h[
i
],

1379 (
ucc_mem_m­__t
));

1383 
expÜ‹d_memh
->
_h
 = 
loÿl_memh
->tl_h;

1385 
i
 = 0; i < 
loÿl_memh
->
num_s
; i++) {

1387 
	`¡ºıy
(
	`PTR_OFFSET
(
expÜ‹d_memh
->
·ck_bufãr
, 
off£t
),

1388 
loÿl_memh
->
_h
[
i
].
_Çme
, 
UCC_MEM_MAP_TL_NAME_LEN
);

1389 
off£t
 +ğ
UCC_MEM_MAP_TL_NAME_LEN
;

1390 
	`memıy
(
	`PTR_OFFSET
(
expÜ‹d_memh
->
·ck_bufãr
, 
off£t
),

1391 &
loÿl_memh
->
_h
[
i
].
·cked_size
, (
size_t
));

1392 
off£t
 +ğ(
size_t
);

1393 
	`memıy
(
	`PTR_OFFSET
(
expÜ‹d_memh
->
·ck_bufãr
, 
off£t
),

1394 
·cked_bufãrs
[
i
], 
loÿl_memh
->
_h
[i].
·cked_size
);

1395 
	`ucc_ä“
(
·cked_bufãrs
[
i
]);

1396 
off£t
 +ğ
loÿl_memh
->
_h
[
i
].
·cked_size
;

1398 ; 
i
 < 
ùx
->
n__ùx
; i++) {

1399 
	`ucc_ä“
(
·cked_bufãrs
[
i
]);

1403 
expÜ‹d_memh
->
mode
 = mode;

1404 
expÜ‹d_memh
->
cÚ‹xt
 = 
ùx
;

1405 
expÜ‹d_memh
->
add»ss
 = 
loÿl_memh
->address;

1406 
expÜ‹d_memh
->
Ën
 = 
loÿl_memh
->len;

1407 
expÜ‹d_memh
->
num_s
 = 
·cked_s
;

1408 *
memh
 = 
expÜ‹d_memh
;

1409 *
memh_size
 = (
ucc_mem_m­_memh_t
è+ 
off£t
;

1410 ià(
mode
 =ğ
UCC_MEM_MAP_MODE_EXPORT
) {

1411 
	`ucc_ä“
(
loÿl_memh
->
_h
);

1413 
	`ucc_ä“
(
loÿl_memh
);

1414 
	`ucc_ä“
(
·cked_bufãrs
);

1415  
UCC_OK
;

1416 
çed_·ck
:

1417 
j
 = 0; j < 
i
; j++) {

1418 
	`ucc_ä“
(
·cked_bufãrs
[
j
]);

1420 
i
 = 
ùx
->
n__ùx
;

1421 
çed_mem_m­
:

1422 
j
 = 0; j < 
i
; j++) {

1423 
_lib
 = 
	`ucc_d”ived_of
(
ùx
->
_ùx
[
i
]->
su³r
.
lib
, 
ucc__lib_t
);

1424 
_lib
->
içû
->
cÚ‹xt
.
	`mem_unm­
((cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *)
ùx
,

1425 
UCC_MEM_MAP_MODE_EXPORT
,

1426 &
loÿl_memh
->
_h
[
j
]);

1428 
	`ucc_ä“
(
loÿl_memh
);

1429 
	`ucc_ä“
(
·cked_bufãrs
);

1430 *
memh
 = 
NULL
;

1431 *
memh_size
 = 0;

1432  
¡©us
;

1433 
	}
}

1435 
ucc_¡©us_t
 
	$ucc_mem_m­
(
ucc_cÚ‹xt_h
 
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

1436 cÚ¡ 
ucc_mem_m­_·¿ms_t
 *
·¿ms
, 
size_t
 *
memh_size
,

1437 
ucc_mem_m­_mem_h
 *
memh
)

1439 ià(
mode
 >ğ
UCC_MEM_MAP_MODE_LAST
) {

1440 
	`ucc_”rÜ
("Inv®id memÜy m­ mode: %d", 
mode
);

1441  
UCC_ERR_INVALID_PARAM
;

1443 ià(
mode
 =ğ
UCC_MEM_MAP_MODE_IMPORT
 || mod=ğ
UCC_MEM_MAP_MODE_IMPORT_OFFLOAD
) {

1444  
	`ucc_mem_m­_impÜt
(
cÚ‹xt
, 
mode
, 
·¿ms
, 
memh_size
, 
memh
);

1446 ià(
·¿ms
->
n_£gm’ts
 > 1) {

1447 
	`ucc_”rÜ
("UCC only supports one mapping…er call");

1448  
UCC_ERR_INVALID_PARAM
;

1450  
	`ucc_mem_m­_expÜt
(
cÚ‹xt
, 
mode
, 
·¿ms
, 
memh_size
, 
memh
);

1451 
	}
}

1453 
ucc_¡©us_t
 
	$ucc_mem_unm­
(
ucc_mem_m­_mem_h
 *
memh
)

1455 
ucc_cÚ‹xt_t
 *
ùx
;

1456 
ucc_¡©us_t
 
¡©us
;

1457 
ucc_mem_m­_memh_t
 *
lmemh
;

1458 
ucc__lib_t
 *
_lib
;

1459 
i
;

1460 
j
;

1461 
ucc_cÚfig_Çmes_¬¿y_t
 *
s
;

1463 ià(!
memh
) {

1464 
	`ucc_w¬n
("unableo free NULL memh");

1465  
UCC_ERR_INVALID_PARAM
;

1468 
lmemh
 = *
memh
;

1469 
ùx
 = (
ucc_cÚ‹xt_t
 *)
lmemh
->
cÚ‹xt
;

1470 
s
 = &
ùx
->
®l_s
;

1471 
i
 = 0; i < 
ùx
->
n__ùx
; i++) {

1472 
j
 = 0; j < 
lmemh
->
num_s
; j++) {

1473 ià(
	`¡rcmp
(
lmemh
->
_h
[
j
].
_Çme
, 
s
->
Çmes
[
i
]) == 0) {

1474 
_lib
 = 
	`ucc_d”ived_of
(
ùx
->
_ùx
[
i
]->
su³r
.
lib
, 
ucc__lib_t
);

1475 
¡©us
 = 
_lib
->
içû
->
cÚ‹xt
.
	`mem_unm­
(

1476 (cÚ¡ 
ucc_ba£_cÚ‹xt_t
 *)
ùx
->
_ùx
[
i
], 
lmemh
->
mode
,

1477 &
lmemh
->
_h
[
j
]);

1478 ià(
¡©us
 < 
UCC_ERR_NOT_IMPLEMENTED
) {

1479 
	`ucc_”rÜ
("error during unmap operation on TL %s",

1480 
lmemh
->
_h
[
j
].
_Çme
);

1481  
¡©us
;

1486  
UCC_OK
;

1487 
	}
}

	@src/core/ucc_context.h

7 #iâdeà
UCC_CONTEXT_H_


8 
	#UCC_CONTEXT_H_


	)

10 
	~"ucc/­i/ucc.h
"

11 
	~"ucc_´og»ss_queue.h
"

12 
	~"uts/ucc_li¡.h
"

13 
	~"uts/ucc_´oc_šfo.h
"

14 
	~"compÚ’ts/tİo/ucc_tİo.h
"

16 
	#UCC_MEM_MAP_TL_NAME_LEN
 8

	)

18 
ucc_lib_šfo
 
	tucc_lib_šfo_t
;

19 
ucc_ş_cÚ‹xt
 
	tucc_ş_cÚ‹xt_t
;

20 
ucc__cÚ‹xt
 
	tucc__cÚ‹xt_t
;

21 
ucc_ş_cÚ‹xt_cÚfig
 
	tucc_ş_cÚ‹xt_cÚfig_t
;

22 
ucc__cÚ‹xt_cÚfig
 
	tucc__cÚ‹xt_cÚfig_t
;

23 
ucc__‹am
 
	tucc__‹am_t
;

25 (*
	tucc_cÚ‹xt_´og»ss_â_t
)(*
	t´og»ss_¬g
);

27 
	succ_‹am_id_poŞ
 {

28 
ušt64_t
 *
poŞ
;

29 
ušt32_t
 
poŞ_size
;

30 } 
	tucc_‹am_id_poŞ_t
;

32 
	succ_cÚ‹xt_id
 {

33 
ucc_´oc_šfo_t
 
pi
;

34 
ušt32_t
 
£q_num
;

35 } 
	tucc_cÚ‹xt_id_t
;

37 
	#UCC_CTX_ID_EQUAL
(
_id1
, 
_id2
è(
	`UCC_PROC_INFO_EQUAL
((_id1).
pi
, (_id2).pi) \

38 && (
_id1
).
£q_num
 =ğ(
_id2
).£q_num)

	)

42 
UCC_ADDR_STORAGE_FLAG_TLS_SYMMETRIC
 = 
	`UCC_BIT
(0),

45 
	succ_addr_¡Üage
 {

46 *
¡Üage
;

47 *
oob_»q
;

48 
size_t
 
addr_Ën
;

49 
ucc_¿nk_t
 
size
;

50 
ucc_¿nk_t
 
¿nk
;

51 
ušt64_t
 
æags
;

52 } 
	tucc_addr_¡Üage_t
;

54 
	succ_cÚ‹xt
 {

55 
ucc_lib_šfo_t
 *
lib
;

56 
ucc_cÚ‹xt_·¿ms_t
 
·¿ms
;

57 
ucc_cÚ‹xt_©Œ_t
 
©Œ
;

58 
ucc_th»ad_mode_t
 
th»ad_mode
;

59 
ucc_ş_cÚ‹xt_t
 **
ş_ùx
;

60 
ucc__cÚ‹xt_t
 **
_ùx
;

61 
ucc__cÚ‹xt_t
 *
£rviû_ùx
;

62 
n_ş_ùx
;

63 
n__ùx
;

68 
n_addr_·cked
;

69 
ucc_cÚfig_Çmes_¬¿y_t
 
®l_s
;

70 
ucc_cÚfig_Çmes_¬¿y_t
 
Ãt_deviûs
;

71 
ucc_li¡_lšk_t
 
´og»ss_li¡
;

72 
ucc_´og»ss_queue_t
 *
pq
;

73 
ucc_‹am_id_poŞ_t
 
ids
;

74 
ucc_cÚ‹xt_id_t
 
id
;

75 
ucc_addr_¡Üage_t
 
addr_¡Üage
;

79 
ucc_¿nk_t
 
¿nk
;

80 
ucc_cÚ‹xt_tİo_t
 *
tİo
;

81 
ušt64_t
 
ş_æags
;

82 
ucc__‹am_t
 *
£rviû_‹am
;

83 
št32_t
 
thrÙe_´og»ss
;

84 } 
	tucc_cÚ‹xt_t
;

86 
	succ_cÚ‹xt_cÚfig
 {

87 
ucc_lib_šfo_t
 *
lib
;

88 
ucc_ş_cÚ‹xt_cÚfig_t
 **
ş_cfgs
;

89 
ucc__cÚ‹xt_cÚfig_t
 **
_cfgs
;

90 
n_ş_cfg
;

91 
n__cfg
;

92 
ušt32_t
 
‹am_ids_poŞ_size
;

93 
ušt32_t
 
e¡im©ed_num_•s
;

94 
ušt32_t
 
e¡im©ed_num_µn
;

95 
ušt32_t
 
lock_ä“_´og»ss_q
;

96 
ušt32_t
 
š‹º®_oob
;

97 
ušt32_t
 
thrÙe_´og»ss
;

98 
ucs_cÚfig_Çmes_¬¿y_t
 
Ãt_deviûs
;

99 } 
	tucc_cÚ‹xt_cÚfig_t
;

101 
	succ_mem_m­__t
 {

102 
size_t
 
·cked_size
;

103 
_Çme
[
UCC_MEM_MAP_TL_NAME_LEN
];

104 *
_d©a
;

105 } 
	tucc_mem_m­__t
;

107 
	succ_mem_m­_memh_t
 {

108 
ucc_mem_m­_mode_t
 
mode
;

109 
ucc_cÚ‹xt_h
 
cÚ‹xt
;

110 *
add»ss
;

111 
size_t
 
Ën
;

112 
ucc_mem_m­__t
 *
_h
;

113 
num_s
;

114 
·ck_bufãr
[0];

115 } 
	tucc_mem_m­_memh_t
;

119 
ucc_¡©us_t
 
	`ucc_cÚ‹xt_ü—‹_´oc_šfo
(
ucc_lib_h
 
lib
,

120 cÚ¡ 
ucc_cÚ‹xt_·¿ms_t
 *
·¿ms
,

121 cÚ¡ 
ucc_cÚ‹xt_cÚfig_h
 
cÚfig
,

122 
ucc_cÚ‹xt_h
 *
cÚ‹xt
,

123 
ucc_´oc_šfo_t
 *
´oc_šfo
);

132 
ucc_¡©us_t
 
	`ucc_cÚ‹xt_´og»ss_»gi¡”
(
ucc_cÚ‹xt_t
 *
ùx
,

133 
ucc_cÚ‹xt_´og»ss_â_t
 
â
,

134 *
´og»ss_¬g
);

136 
ucc_¡©us_t
 
	`ucc_cÚ‹xt_´og»ss_d”egi¡”
(
ucc_cÚ‹xt_t
 *
ùx
,

137 
ucc_cÚ‹xt_´og»ss_â_t
 
â
,

138 *
´og»ss_¬g
);

151 
ucc_¡©us_t
 
	`ucc_cÜe_addr_exchªge
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_oob_cŞl_t
 *
oob
,

152 
ucc_addr_¡Üage_t
 *
addr_¡Üage
);

160 
	succ_cÚ‹xt_addr_h—d”
 {

161 
ucc_cÚ‹xt_id_t
 
ùx_id
;

162 
n_compÚ’ts
;

164 
id
;

165 
±rdiff_t
 
off£t
;

167 } 
compÚ’ts
[1];

168 } 
	tucc_cÚ‹xt_addr_h—d”_t
;

170 
	#UCC_CONTEXT_ADDR_HEADER_SIZE
(
_n_compÚ’ts
) \

172 
ucc_cÚ‹xt_addr_h—d”_t
 
_h
; \

173 
size_t
 
_size
; \

174 
_size
 = (
_h
è+ (_h.
compÚ’ts
[0]è* (
_n_compÚ’ts
 - 1); \

175 
_size
; \

176 
	}
})

	)

178 
	#UCC_CONTEXT_ADDR_DATA
(
_h—d”
) \

179 
	`PTR_OFFSET
(
_h—d”
, 
	`UCC_CONTEXT_ADDR_HEADER_SIZE
(_h—d”->
n_compÚ’ts
))

	)

181 
	#UCC_ADDR_STORAGE_RANK_HEADER
(
_¡Üage
, 
_¿nk
) \

182 (
ucc_cÚ‹xt_addr_h—d”_t
 *)
	`PTR_OFFSET
((
_¡Üage
)->
¡Üage
, \

183 (
_¡Üage
)->
addr_Ën
 *(
_¿nk
))

	)

	@src/core/ucc_dt.c

6 
	~"ucc_dt.h
"

7 
	~"uts/ucc_m®loc.h
"

8 
	~"uts/ucc_m©h.h
"

10 
size_t
 
	gucc_dt_´edefšed_sizes
[
UCC_DT_PREDEFINED_LAST
] = {

11 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT8
)] = 1,

12 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT8
)] = 1,

13 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT16
)] = 2,

14 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT16
)] = 2,

15 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT16
)] = 2,

16 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_BFLOAT16
)] = 2,

17 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT32
)] = 4,

18 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT32
)] = 4,

19 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT32
)] = 4,

20 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT64
)] = 8,

21 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT64
)] = 8,

22 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT64
)] = 8,

23 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT128
)] = 16,

24 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_INT128
)] = 16,

25 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_UINT128
)] = 16,

26 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT32_COMPLEX
)] = 8,

27 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT64_COMPLEX
)] = 16,

28 [
UCC_DT_PREDEFINED_ID
(
UCC_DT_FLOAT128_COMPLEX
)] = 32};

30 
ucc_¡©us_t
 
	$ucc_dt_ü—‹_g’”ic
(cÚ¡ 
ucc_g’”ic_dt_İs_t
 *
İs
, *
cÚ‹xt
,

31 
ucc_d©©y³_t
 *
d©©y³_p
)

33 
ucc_dt_g’”ic_t
 *
dt_g’
;

34 
»t
;

36 
»t
 = 
	`ucc_posix_mem®ign
((**)&
dt_g’
,

37 
	`ucc_max
((*), 
	`UCC_BIT
(
UCC_DATATYPE_SHIFT
)),

38 (*
dt_g’
), "generic_dt");

39 ià(
»t
 != 0) {

40  
UCC_ERR_NO_MEMORY
;

43 
dt_g’
->
İs
 = *ops;

44 
dt_g’
->
cÚ‹xt
 = context;

45 *
d©©y³_p
 = 
	`ucc_dt_äom_g’”ic
(
dt_g’
);

46  
UCC_OK
;

47 
	}
}

49 
	$ucc_dt_de¡roy
(
ucc_d©©y³_t
 
d©©y³
)

51 
ucc_dt_g’”ic_t
 *
dt_g’
;

53 ià(
	`UCC_DT_IS_GENERIC
(
d©©y³
)) {

54 
dt_g’
 = 
	`ucc_dt_to_g’”ic
(
d©©y³
);

55 
	`ucc_ä“
(
dt_g’
);

57 
	}
}

	@src/core/ucc_dt.h

7 #iâdeà
UCC_DT_H_


8 
	#UCC_DT_H_


	)

9 
	~"cÚfig.h
"

10 
	~"ucc/­i/ucc.h
"

11 
	~"uts/ucc_as£¹.h
"

13 
	succ_dt_g’”ic
 {

14 *
	mcÚ‹xt
;

15 
ucc_g’”ic_dt_İs_t
 
	mİs
;

16 } 
	tucc_dt_g’”ic_t
;

18 
	#UCC_DT_PREDEFINED_ID
(
_dt
è((_dtè>> 
UCC_DATATYPE_SHIFT
)

	)

20 
	#UCC_DT_IS_GENERIC
(
_dt
) \

21 (((
_dt
è& 
UCC_DATATYPE_CLASS_MASK
è=ğ
UCC_DATATYPE_GENERIC
)

	)

23 
	#UCC_DT_IS_PREDEFINED
(
_dt
) \

24 (((
_dt
è& 
UCC_DATATYPE_CLASS_MASK
è=ğ
UCC_DATATYPE_PREDEFINED
)

	)

26 
	#UCC_DT_GENERIC_IS_CONTIG
(
_dt
è(((_dt)->
İs
.
mask
 & 
UCC_GENERIC_DT_OPS_FIELD_FLAGS
) && \

27 ((
_dt
)->
İs
.
æags
 & 
UCC_GENERIC_DT_OPS_FLAG_CONTIG
))

	)

29 
	#UCC_DT_GENERIC_HAS_REDUCE
(
_dt
è(((_dt)->
İs
.
mask
 & 
UCC_GENERIC_DT_OPS_FIELD_FLAGS
) && \

30 ((
_dt
)->
İs
.
æags
 & 
UCC_GENERIC_DT_OPS_FLAG_REDUCE
))

	)

32 
	#UCC_DT_IS_CONTIG
(
_dt
è(
	`UCC_DT_IS_GENERIC
(_dt) && \

33 
	`UCC_DT_GENERIC_IS_CONTIG
(
	`ucc_dt_to_g’”ic
(
_dt
)))

	)

35 
	#UCC_DT_HAS_REDUCE
(
_dt
è(
	`UCC_DT_IS_GENERIC
(_dt) && \

36 
	`UCC_DT_GENERIC_HAS_REDUCE
(
	`ucc_dt_to_g’”ic
(
_dt
)))

	)

38 
šlše


39 
ucc_dt_g’”ic_t
* 
	$ucc_dt_to_g’”ic
(
ucc_d©©y³_t
 
d©©y³
)

41  (
ucc_dt_g’”ic_t
*)(*)(
d©©y³
 & ~
UCC_DATATYPE_CLASS_MASK
);

42 
	}
}

44 
šlše


45 
ucc_d©©y³_t
 
	$ucc_dt_äom_g’”ic
(
ucc_dt_g’”ic_t
* 
dt_g’
)

47  ((
ušŒ_t
)
dt_g’
è| 
UCC_DATATYPE_GENERIC
;

48 
	}
}

50 
šlše
 
size_t
 
	$ucc_cÚtig_dt_size
(
ucc_d©©y³_t
 
d©©y³
)

52  
	`ucc_dt_to_g’”ic
(
d©©y³
)->
İs
.
cÚtig_size
;

53 
	}
}

55 
size_t
 
ucc_dt_´edefšed_sizes
[
UCC_DT_PREDEFINED_LAST
];

57 
šlše
 
size_t
 
	$ucc_dt_size
(
ucc_d©©y³_t
 
dt
)

59 ià(
	`UCC_DT_IS_PREDEFINED
(
dt
)) {

60  
ucc_dt_´edefšed_sizes
[
	`UCC_DT_PREDEFINED_ID
(
dt
)];

61 } ià(
	`UCC_DT_IS_CONTIG
(
dt
)) {

62  
	`ucc_cÚtig_dt_size
(
dt
);

67 
	`ucc_as£¹
(0);

68  
SIZE_MAX
;

69 
	}
}

	@src/core/ucc_ee.c

7 
	~"cÚfig.h
"

8 
	~"ucc_‹am.h
"

9 
	~"ucc_“.h
"

10 
	~"ucc_lib.h
"

11 
	~"compÚ’ts/ş/ucc_ş.h
"

12 
	~"compÚ’ts//ucc_.h
"

14 cÚ¡ *
	gucc_“_ev_Çmes
[] = {

15 [
UCC_EVENT_COLLECTIVE_POST
] = "COLL_POST",

16 [
UCC_EVENT_COLLECTIVE_COMPLETE
] = "COLL_COMPLETE",

17 [
UCC_EVENT_COMPUTE_COMPLETE
] = "COMPUTE_COMPLETE",

18 [
UCC_EVENT_OVERFLOW
] = "OVERFLOW",

21 
ucc_¡©us_t
 
	$ucc_“_ü—‹
(
ucc_‹am_h
 
‹am
, cÚ¡ 
ucc_“_·¿ms_t
 *
·¿ms
,

22 
ucc_“_h
 *
“_p
)

24 
ucc_“_t
 *
“
;

26 
“
 = 
	`ucc_m®loc
((
ucc_“_t
), "uccƒxecutionƒngine");

27 ià(!
“
) {

28 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for uccƒxecutionƒngine",

29 (
ucc_“_t
));

30  
UCC_ERR_NO_MEMORY
;

33 
“
->
‹am
 =eam;

34 
“
->
“_ty³
 = 
·¿ms
->ee_type;

35 
“
->
“_cÚ‹xt_size
 = 
·¿ms
->ee_context_size;

36 
“
->
“_cÚ‹xt
 = 
·¿ms
->ee_context;

37 
	`ucc_¥šlock_š™
(&
“
->
lock
, 0);

38 
	`ucc_queue_h—d_š™
(&
“
->
ev’t_š_queue
);

39 
	`ucc_queue_h—d_š™
(&
“
->
ev’t_out_queue
);

40 *
“_p
 = 
“
;

42 
	`ucc_debug
("“ i ü—‹d: %°“_cÚ‹xt: %p", 
“
, 
·¿ms
->
“_cÚ‹xt
);

44  
UCC_OK
;

45 
	}
}

47 
ucc_¡©us_t
 
	$ucc_“_de¡roy
(
ucc_“_h
 
“
)

49 
	`ucc_debug
("“ i de¡royed: %p", 
“
);

50 
	`ucc_¥šlock_de¡roy
(&
“
->
lock
);

51 
	`ucc_ä“
(
“
);

53  
UCC_OK
;

54 
	}
}

56 
ucc_¡©us_t
 
	$ucc_“_g‘_ev’t_š‹º®
(
ucc_“_h
 
“
, 
ucc_ev_t
 **
ev
, 
ucc_queue_h—d_t
 *
queue
)

58 
ucc_ev’t_desc_t
 *
ev’t_desc
;

59 
ucc_queue_–em_t
 *
–em
;

61 
	`ucc_¥š_lock
(&
“
->
lock
);

62 ià(
	`ucc_queue_is_em±y
(
queue
)) {

63 
	`ucc_¥š_uÆock
(&
“
->
lock
);

64  
UCC_ERR_NOT_FOUND
;

67 
–em
 = 
	`ucc_queue_puÎ
(
queue
);

68 
	`ucc_¥š_uÆock
(&
“
->
lock
);

70 
	`ucc_as£¹
(
–em
 !ğ
NULL
);

72 
ev’t_desc
 = 
	`ucc_cÚš”_of
(
–em
, 
ucc_ev’t_desc_t
, 
queue
);

73 *
ev
 = &
ev’t_desc
->ev;

75 
	`ucc_debug
("EE Event Get.ƒe:%p, queue:%pƒv_type:%s ",

76 
“
, 
queue
, 
ucc_“_ev_Çmes
[
ev’t_desc
->
ev
.
ev_ty³
]);

77  
UCC_OK
;

78 
	}
}

80 
ucc_¡©us_t
 
	$ucc_“_g‘_ev’t
(
ucc_“_h
 
“
, 
ucc_ev_t
 **
ev
)

82  
	`ucc_“_g‘_ev’t_š‹º®
(
“
, 
ev
, &“->
ev’t_out_queue
);

83 
	}
}

85 
ucc_¡©us_t
 
	$ucc_“_ack_ev’t
(
ucc_“_h
 
“
,

86 
ucc_ev_t
 *
ev
)

88 
ucc_ev’t_desc_t
 *
ev’t_desc
;

90 
ev’t_desc
 = 
	`ucc_cÚš”_of
(
ev
, 
ucc_ev’t_desc_t
,ƒv);

92 
	`ucc_ä“
(
ev’t_desc
);

93  
UCC_OK
;

94 
	}
}

96 
ucc_¡©us_t
 
	$ucc_“_£t_ev’t_š‹º®
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
, 
ucc_queue_h—d_t
 *
queue
)

98 
ucc_ev’t_desc_t
 *
ev’t_desc
;

100 
ev’t_desc
 = 
	`ucc_m®loc
((
ucc_ev’t_desc_t
), "event descriptor");

101 ià(
	`ucc_uÆik–y
(!
ev’t_desc
)) {

102 
	`ucc_”rÜ
("failedo‡llocate uccƒvent descriptor");

103  
UCC_ERR_NO_MEMORY
;

106 
ev’t_desc
->
ev
 = *ev;

108 
	`ucc_¥š_lock
(&
“
->
lock
);

109 
	`ucc_queue_push
(
queue
, &
ev’t_desc
->queue);

110 
	`ucc_¥š_uÆock
(&
“
->
lock
);

111 
	`ucc_debug
("EE Event Set.ƒe:%p, queue:%pƒv_type:%s ",

112 
“
, 
queue
, 
ucc_“_ev_Çmes
[
ev
->
ev_ty³
]);

114  
UCC_OK
;

115 
	}
}

117 
ucc_¡©us_t
 
	$ucc_“_£t_ev’t
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
)

119  
	`ucc_“_£t_ev’t_š‹º®
(
“
, 
ev
, &“->
ev’t_š_queue
);

120 
	}
}

122 
ucc_¡©us_t
 
	$ucc_“_wa™
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
)

124 
UCC_OK
 !ğ
	`ucc_“_g‘_ev’t
(
“
, &
ev
)) {

125 
	`ucc_´og»ss_queue
(
“
->
‹am
->
cÚ‹xts
[0]->
pq
);

128  
UCC_OK
;

130 
	}
}

	@src/core/ucc_ee.h

6 #iâdeà
UCC_EE_H_


7 
	#UCC_EE_H_


	)

9 
	~"ucc/­i/ucc.h
"

10 
	~"uts/ucc_d©a¡ruù.h
"

11 
	~"uts/ucc_queue.h
"

12 
	~"uts/ucc_¥šlock.h
"

14 cÚ¡ *
ucc_“_ev_Çmes
[];

16 
	succ_“
 {

17 
ucc_‹am_h
 
	m‹am
;

18 
ucc_“_ty³_t
 
	m“_ty³
;

19 
ucc_¥šlock_t
 
	mlock
;

20 
ucc_queue_h—d_t
 
	mev’t_š_queue
;

21 
ucc_queue_h—d_t
 
	mev’t_out_queue
;

22 
size_t
 
	m“_cÚ‹xt_size
;

23 *
	m“_cÚ‹xt
;

24 } 
	tucc_“_t
;

26 
	succ_ev’t_desc
 {

27 
ucc_queue_–em_t
 
	mqueue
;

28 
ucc_ev_t
 
	mev
;

29 } 
	tucc_ev’t_desc_t
;

31 
ucc_¡©us_t
 
ucc_“_g‘_ev’t_š‹º®
(
ucc_“_h
 
“
, 
ucc_ev_t
 **
ev
, 
ucc_queue_h—d_t
 *
queue
);

33 
ucc_¡©us_t
 
ucc_“_£t_ev’t_š‹º®
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
, 
ucc_queue_h—d_t
 *
queue
);

	@src/core/ucc_global_opts.c

7 
	~"ucc_glob®_İts.h
"

8 
	~"uts/ucc_comp”_def.h
"

9 
	~"uts/ucc_d©a¡ruù.h
"

10 
	~"uts/´ofe/ucc_´ofe.h
"

12 
UCC_LIST_HEAD
(
ucc_cÚfig_glob®_li¡
);

14 
ucc_glob®_cÚfig_t
 
	gucc_glob®_cÚfig
 = {

15 .
log_compÚ’t
 = {
UCC_LOG_LEVEL_WARN
, "UCC"},

16 .
	gcŞl_Œaû
 = {
UCC_LOG_LEVEL_WARN
, "UCC_COLL"},

17 .
	gcompÚ’t_·th
 = 
NULL
,

18 .
	gš¡®l_·th
 = 
NULL
,

19 .
	gš™Ÿlized
 = 0,

20 .
	g´ofe_mode
 = 0,

21 .
	g´ofe_fe
 = "",

22 .
	g´ofe_log_size
 = 0,

23 .
	gfe_cfg
 = 0};

25 
ucc_cÚfig_f›ld_t
 
	gucc_glob®_cÚfig_bË
[] = {

31 
ucc_off£tof
(
ucc_glob®_cÚfig_t
, 
log_compÚ’t
),

32 
UCC_CONFIG_TYPE_LOG_COMP
},

39 
ucc_off£tof
(
ucc_glob®_cÚfig_t
, 
cŞl_Œaû
),

40 
UCC_CONFIG_TYPE_LOG_COMP


47 
ucc_off£tof
(
ucc_glob®_cÚfig_t
, 
´ofe_mode
),

48 
UCC_CONFIG_TYPE_BITMAP
(
ucs_´ofe_mode_Çmes
)},

54 
ucc_off£tof
(
ucc_glob®_cÚfig_t
, 
´ofe_fe
), 
UCC_CONFIG_TYPE_STRING
},

58 
ucc_off£tof
(
ucc_glob®_cÚfig_t
, 
´ofe_log_size
),

59 
UCC_CONFIG_TYPE_MEMUNITS
},

66 
ucc_off£tof
(
ucc_glob®_cÚfig_t
, 
cfg_f’ame
), 
UCC_CONFIG_TYPE_STRING
},

68 {
NULL
}};

	@src/core/ucc_global_opts.h

7 #iâdeà
UCC_GLOBAL_OPTS_H_


8 
	#UCC_GLOBAL_OPTS_H_


	)

10 
	~"cÚfig.h
"

11 
	~"uts/ucc_compÚ’t.h
"

13 
	~"uts/ucc_·r£r.h
"

14 
	~"uts/ucc_log.h
"

16 
	succ_glob®_cÚfig
 {

18 
ucc_log_compÚ’t_cÚfig_t
 
	mlog_compÚ’t
;

20 
ucc_log_compÚ’t_cÚfig_t
 
	mcŞl_Œaû
;

21 
ucc_compÚ’t_äamewÜk_t
 
	mş_äamewÜk
;

22 
ucc_compÚ’t_äamewÜk_t
 
	m_äamewÜk
;

23 
ucc_compÚ’t_äamewÜk_t
 
	mmc_äamewÜk
;

24 
ucc_compÚ’t_äamewÜk_t
 
	mec_äamewÜk
;

27 *
	mcompÚ’t_·th
;

28 *
	mš¡®l_·th
;

29 
	mš™Ÿlized
;

31 
ušt64_t
 
	m´ofe_mode
;

34 *
	m´ofe_fe
;

37 
size_t
 
	m´ofe_log_size
;

38 *
	mcfg_f’ame
;

39 
ucc_fe_cÚfig_t
 *
	mfe_cfg
;

40 } 
	tucc_glob®_cÚfig_t
;

42 
ucc_glob®_cÚfig_t
 
ucc_glob®_cÚfig
;

43 
ucc_cÚfig_f›ld_t
 
ucc_glob®_cÚfig_bË
[];

45 
ucc_¡©us_t
 
ucc_cÚ¡ruùÜ
();

46 
ucs_li¡_lšk_t
 
ucc_cÚfig_glob®_li¡
;

	@src/core/ucc_lib.c

7 
	~"cÚfig.h
"

9 
	~"ucc_glob®_İts.h
"

10 
	~"ucc_lib.h
"

11 
	~"uts/ucc_log.h
"

12 
	~"uts/ucc_m®loc.h
"

13 
	~"uts/ucc_·r£r.h
"

14 
	~"uts/ucc_m©h.h
"

15 
	~"compÚ’ts/ş/ucc_ş.h
"

16 
	~"compÚ’ts//ucc_.h
"

17 
	~"compÚ’ts/mc/ucc_mc.h
"

18 
	~"compÚ’ts/ec/ucc_ec.h
"

20 
UCS_CONFIG_DEFINE_ARRAY
(
ş_ty³s
, (
ucc_ş_ty³_t
),

21 
UCS_CONFIG_TYPE_ENUM
(
ucc_ş_Çmes
));

23 
ucc_cÚfig_f›ld_t
 
	gucc_lib_cÚfig_bË
[] = {

25 
ucc_off£tof
(
ucc_lib_cÚfig_t
, 
şs
), 
UCC_CONFIG_TYPE_ARRAY
(
ş_ty³s
)},

27 {
NULL
}

30 
UCC_CONFIG_REGISTER_TABLE
(
ucc_lib_cÚfig_bË
, "UCC", 
NULL
, 
ucc_lib_cÚfig_t
,

31 &
ucc_cÚfig_glob®_li¡
)

33 
šlše
 
	$ucc_ş_»que¡ed
(cÚ¡ 
ucc_lib_cÚfig_t
 *
cfg
, 
ş_ty³
)

35 
i
;

36 
i
 = 0; i < 
cfg
->
şs
.
couÁ
; i++) {

37 ià(
cfg
->
şs
.
ty³s
[
i
] =ğ
ş_ty³
) {

42 
	}
}

44 
šlše
 
	$ucc_cİy_lib_·¿ms
(
ucc_lib_·¿ms_t
 *
d¡
,

45 cÚ¡ 
ucc_lib_·¿ms_t
 *
¤c
)

47 
d¡
->
mask
 = 
¤c
->mask;

48 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_LIB_PARAM_FIELD_THREAD_MODE
,

49 
th»ad_mode
);

50 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_LIB_PARAM_FIELD_COLL_TYPES
,

51 
cŞl_ty³s
);

52 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_LIB_PARAM_FIELD_REDUCTION_TYPES
,

53 
»duùiÚ_ty³s
);

54 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_LIB_PARAM_FIELD_SYNC_TYPE
, 
sync_ty³
);

55 
	}
}

65 
ucc_¡©us_t
 
	$ucc_ş_lib_š™
(cÚ¡ 
ucc_lib_·¿ms_t
 *
u£r_·¿ms
,

66 cÚ¡ 
ucc_lib_cÚfig_t
 *
cÚfig
,

67 
ucc_lib_šfo_t
 *
lib
)

69 
n_şs
 = 
ucc_glob®_cÚfig
.
ş_äamewÜk
.
n_compÚ’ts
;

70 
ušt64_t
 
suµÜ‹d_cŞl_ty³s
 = 0;

71 
ucc_th»ad_mode_t
 
highe¡_tm
 = 
UCC_THREAD_SINGLE
;

72 
ucc_th»ad_mode_t
 
lowe¡_tm
 = 
UCC_THREAD_MULTIPLE
;

73 
ucc_lib_·¿ms_t
 
·¿ms
 = *
u£r_·¿ms
;

74 
ucc_ş_lib_cÚfig_t
 *
ş_cÚfig
 = 
NULL
;

75 
ucc_ş_içû_t
 *
ş_içû
;

76 
ucc_ş_lib_©Œ_t
 *
©Œs
;

77 
ucc_ba£_lib_t
 * 
b_lib
;

78 
ucc_ba£_lib_·¿ms_t
 
b_·¿ms
;

79 
ucc_ş_lib_t
 *
ş_lib
;

80 
ucc_¡©us_t
 
¡©us
;

81 
i
;

83 
lib
->
ş_libs
 =

84 (
ucc_ş_lib_t
 **)
	`ucc_m®loc
((ucc_ş_lib_ˆ*è* 
n_şs
, "cl_libs");

85 ià(!
lib
->
ş_libs
) {

86 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for cl_libs",

87 (
ucc_ş_lib_t
 *è* 
n_şs
);

88 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

89 
”rÜ
;

92 
lib
->
ş_©Œs
 = (
ucc_ş_lib_©Œ_t
 *)

93 
	`ucc_ÿÎoc
(
n_şs
, (
ucc_ş_lib_©Œ_t
), "cl_attrs");

94 ià(!
lib
->
ş_©Œs
) {

95 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for cl_attrs",

96 (
ucc_ş_lib_©Œ_t
è* 
n_şs
);

97 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

98 
”rÜ
;

100 
©Œs
 = 
lib
->
ş_©Œs
;

102 ià(!(
·¿ms
.
mask
 & 
UCC_LIB_PARAM_FIELD_THREAD_MODE
)) {

103 
·¿ms
.
mask
 |ğ
UCC_LIB_PARAM_FIELD_THREAD_MODE
;

104 
·¿ms
.
th»ad_mode
 = 
UCC_THREAD_SINGLE
;

106 
	`mem£t
(&
b_·¿ms
, 0, (
ucc_ba£_lib_·¿ms_t
));

107 
	`ucc_cİy_lib_·¿ms
(&
b_·¿ms
.
·¿ms
, &params);

108 
	`ucc_as£¹
(
cÚfig
->
şs
.
couÁ
 >= 1);

109 
lib
->
¥ecific_şs_»que¡ed
 = (0 =ğ
	`ucc_ş_»que¡ed
(
cÚfig
, 
UCC_CL_ALL
));

110 
lib
->
n_ş_libs_İ’ed
 = 0;

111 
i
 = 0; i < 
n_şs
; i++) {

112 
ş_içû
 = 
	`ucc_d”ived_of
(
ucc_glob®_cÚfig
.
ş_äamewÜk
.
compÚ’ts
[
i
],

113 
ucc_ş_içû_t
);

116 ià(
lib
->
¥ecific_şs_»que¡ed
 &&

117 (0 =ğ
	`ucc_ş_»que¡ed
(
cÚfig
, 
ş_içû
->
ty³
))) {

120 
¡©us
 = 
	`ucc_ş_lib_cÚfig_»ad
(
ş_içû
, 
lib
->
fuÎ_´efix
, &
ş_cÚfig
);

121 ià(
UCC_OK
 !ğ
¡©us
) {

122 
	`ucc_”rÜ
("failedo„ead CL \"%s\"†ib configuration",

123 
ş_içû
->
su³r
.
Çme
);

124 
”rÜ_cfg_»ad
;

127 
¡©us
 = 
ş_içû
->
lib
.
	`š™
(&
b_·¿ms
, &
ş_cÚfig
->
su³r
.su³r, &
b_lib
);

128 ià(
UCC_OK
 !ğ
¡©us
) {

129 ià(
lib
->
¥ecific_şs_»que¡ed
) {

130 
	`ucc_”rÜ
("lib_init failed for component: %s",

131 
ş_içû
->
su³r
.
Çme
);

132 
”rÜ_ş_š™
;

134 
	`ucc_debug
("lib_init failed for component: %s, skipping",

135 
ş_içû
->
su³r
.
Çme
);

136 
	`ucc_ba£_cÚfig_»Ëa£
(&
ş_cÚfig
->
su³r
.super);

140 
	`ucc_ba£_cÚfig_»Ëa£
(&
ş_cÚfig
->
su³r
.super);

141 
ş_lib
 = 
	`ucc_d”ived_of
(
b_lib
, 
ucc_ş_lib_t
);

142 
lib
->
ş_libs
[lib->
n_ş_libs_İ’ed
] = 
ş_lib
;

143 
¡©us
 = 
ş_içû
->
lib
.
	`g‘_©Œ
(&
ş_lib
->
su³r
,

144 &
©Œs
[
lib
->
n_ş_libs_İ’ed
].
su³r
);

145 ià(
UCC_OK
 !ğ
¡©us
) {

146 
	`ucc_”rÜ
("failedo query cl†ib %s‡ttr",

147 
ş_lib
->
içû
->
su³r
.
Çme
);

148  
¡©us
;

150 
	`ucc_debug
("lib_prefix \"%s\": initialized component \"%s\" score %d",

151 
cÚfig
->
fuÎ_´efix
, 
ş_içû
->
su³r
.
Çme
,

152 
ş_içû
->
su³r
.
scÜe
);

153 ià(
©Œs
[
lib
->
n_ş_libs_İ’ed
].
su³r
.
©Œ
.
th»ad_mode
 > 
highe¡_tm
) {

154 
highe¡_tm
 = 
©Œs
[
lib
->
n_ş_libs_İ’ed
].
su³r
.
©Œ
.
th»ad_mode
;

156 ià(
©Œs
[
i
].
su³r
.
©Œ
.
th»ad_mode
 < 
lowe¡_tm
) {

157 
lowe¡_tm
 = 
©Œs
[
lib
->
n_ş_libs_İ’ed
].
su³r
.
©Œ
.
th»ad_mode
;

159 
lib
->
n_ş_libs_İ’ed
++;

162 ià(
lib
->
n_ş_libs_İ’ed
 == 0) {

163 
	`ucc_”rÜ
("lib_init failed:‚o CL†ibs were opened");

164 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

165 
”rÜ
;

168 ià(
highe¡_tm
 < 
·¿ms
.
th»ad_mode
) {

172 
	`ucc_šfo
("selected set of CLs does‚ot…rovidehe„equested "

174 
lib
->
©Œ
.
th»ad_mode
 = 
lowe¡_tm
;

175 } ià(
lowe¡_tm
 < 
highe¡_tm
) {

179 
n_ş_libs_f‹»d
 = 0;

180 
lib
->
©Œ
.
th»ad_mode
 = 
·¿ms
.thread_mode;

181 
i
 = 0; i < 
lib
->
n_ş_libs_İ’ed
; i++) {

182 ià(
©Œs
[
i
].
su³r
.
©Œ
.
th»ad_mode
 >ğ
·¿ms
.thread_mode) {

183 
lib
->
ş_libs
[
n_ş_libs_f‹»d
] =†ib->ş_libs[
i
];

184 
©Œs
[
n_ş_libs_f‹»d
] =‡‰rs[
i
];

185 
n_ş_libs_f‹»d
++;

188 
lib
->
n_ş_libs_İ’ed
 = 
n_ş_libs_f‹»d
;

189 
	`ucc_as£¹
(
n_ş_libs_f‹»d
 > 0);

193 
lib
->
©Œ
.
th»ad_mode
 = 
·¿ms
.thread_mode;

196 
i
 = 0; i < 
lib
->
n_ş_libs_İ’ed
; i++) {

197 
suµÜ‹d_cŞl_ty³s
 |ğ
©Œs
[
i
].
su³r
.
©Œ
.
cŞl_ty³s
;

202 ià(
·¿ms
.
mask
 & 
UCC_LIB_PARAM_FIELD_COLL_TYPES
 &&

203 ((
·¿ms
.
cŞl_ty³s
 & 
suµÜ‹d_cŞl_ty³s
) !=…arams.coll_types)) {

204 
	`ucc_debug
("selected set of CLs does‚ot…rovide‡llhe„equested "

207 
lib
->
©Œ
.
cŞl_ty³s
 = 
suµÜ‹d_cŞl_ty³s
;

208  
UCC_OK
;

210 
”rÜ_ş_š™
:

211 
	`ucc_ba£_cÚfig_»Ëa£
(&
ş_cÚfig
->
su³r
.super);

212 
”rÜ_cfg_»ad
:

213 
i
 = 0; i < 
lib
->
n_ş_libs_İ’ed
; i++) {

214 
lib
->
ş_libs
[
i
]->
içû
->lib.
	`fš®ize
(&lib->ş_libs[i]->
su³r
);

216 
”rÜ
:

217 
	`ucc_ä“
(
lib
->
ş_©Œs
);

218 
	`ucc_ä“
(
lib
->
ş_libs
);

219  
¡©us
;

220 
	}
}

222 
	$ucc__is_»quœed
(
ucc_lib_šfo_t
 *
lib
, 
ucc__içû_t
 *
_içû
,

223 
fÜûd
)

225 
i
;

227 
i
 = 0; i < 
lib
->
n_ş_libs_İ’ed
; i++) {

228 ià(
	`ucc_cÚfig_Çmes_£¬ch
(
fÜûd


229 ? 
lib
->
ş_©Œs
[
i
].
s_fÜûd


230 : 
lib
->
ş_©Œs
[
i
].
s
,

231 
_içû
->
su³r
.
Çme
) >= 0) {

236 
	}
}

238 
ucc_¡©us_t
 
	$ucc__lib_š™
(cÚ¡ 
ucc_lib_·¿ms_t
 *
u£r_·¿ms
,

239 
ucc_lib_šfo_t
 *
lib
)

241 
ucc_¡©us_t
 
¡©us
;

242 
i
, 
n_s
;

243 
ucc__lib_t
 *
_lib
;

244 
ucc__lib_cÚfig_t
 *
_cÚfig
;

245 
ucc_ba£_lib_t
 * 
b_lib
;

246 
ucc_ba£_lib_·¿ms_t
 
b_·¿ms
;

247 
ucc__içû_t
 *
_içû
;

249 
	`ucc_cİy_lib_·¿ms
(&
b_·¿ms
.
·¿ms
, 
u£r_·¿ms
);

250 
b_·¿ms
.
fuÎ_´efix
 = 
lib
->full_prefix;

251 
n_s
 = 
ucc_glob®_cÚfig
.
_äamewÜk
.
n_compÚ’ts
;

252 
lib
->
_libs
 =

253 (
ucc__lib_t
 **)
	`ucc_m®loc
((ucc__lib_ˆ*è* 
n_s
, "tl_libs");

254 
lib
->
n__libs_İ’ed
 = 0;

255 ià(!
lib
->
_libs
) {

256 
	`ucc_”rÜ
("failedo‡llocate %zd bytes forl_libs",

257 (
ucc__lib_t
 *è* 
n_s
);

258  
UCC_ERR_NO_MEMORY
;

261 
i
=0; i<
n_s
; i++) {

262 
_içû
 = 
	`ucc_d”ived_of
(
ucc_glob®_cÚfig
.
_äamewÜk
.
compÚ’ts
[
i
],

263 
ucc__içû_t
);

268 ià(
	`ucc__is_»quœed
(
lib
, 
_içû
, 0)) {

269 
¡©us
 = 
	`ucc__lib_cÚfig_»ad
(
_içû
, 
lib
->
fuÎ_´efix
,

270 &
_cÚfig
);

271 ià(
UCC_OK
 !ğ
¡©us
) {

272 
	`ucc_w¬n
("failedo„ead TL \"%s\"†ib configuration",

273 
_içû
->
su³r
.
Çme
);

277 
¡©us
 = 
_içû
->
lib
.
	`š™
(&
b_·¿ms
, &
_cÚfig
->
su³r
.super,

278 &
b_lib
);

279 
	`ucc_ba£_cÚfig_»Ëa£
(&
_cÚfig
->
su³r
.super);

280 ià(
UCC_OK
 !ğ
¡©us
) {

281 
	`ucc_debug
("lib_init failed for component: %s, skipping",

282 
_içû
->
su³r
.
Çme
);

285 
_lib
 = 
	`ucc_d”ived_of
(
b_lib
, 
ucc__lib_t
);

286 
lib
->
_libs
[lib->
n__libs_İ’ed
++] = 
_lib
;

289  
UCC_OK
;

290 
	}
}

292 
ucc_¡©us_t
 
	$ucc_š™_v”siÚ
(
­i_majÜ_v”siÚ
,

293 
­i_mšÜ_v”siÚ
,

294 cÚ¡ 
ucc_lib_·¿ms_t
 *
·¿ms
,

295 cÚ¡ 
ucc_lib_cÚfig_h
 
cÚfig
, 
ucc_lib_h
 *
lib_p
)

297 
majÜ_v”siÚ
, 
mšÜ_v”siÚ
, 
»Ëa£_numb”
;

298 
ucc_¡©us_t
 
¡©us
;

299 
ucc_lib_šfo_t
 *
lib
;

300 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

301 .
th»ad_mode
 = 
·¿ms
->thread_mode,

303 
ucc_ec_·¿ms_t
 
ec_·¿ms
 = {

304 .
th»ad_mode
 = 
·¿ms
->thread_mode,

307 *
lib_p
 = 
NULL
;

309 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`ucc_cÚ¡ruùÜ
())) {

310  
¡©us
;

312 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`ucc_mc_š™
(&
mc_·¿ms
))) {

313  
¡©us
;

315 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`ucc_ec_š™
(&
ec_·¿ms
))) {

316  
¡©us
;

319 
	`ucc_g‘_v”siÚ
(&
majÜ_v”siÚ
, &
mšÜ_v”siÚ
, &
»Ëa£_numb”
);

321 ià((
­i_majÜ_v”siÚ
 !ğ
majÜ_v”siÚ
) ||

322 ((
­i_majÜ_v”siÚ
 =ğ
majÜ_v”siÚ
) &&

323 (
­i_mšÜ_v”siÚ
 > 
mšÜ_v”siÚ
))) {

324 
	`ucc_w¬n
(

326 
­i_majÜ_v”siÚ
, 
­i_mšÜ_v”siÚ
, 
majÜ_v”siÚ
, 
mšÜ_v”siÚ
,

327 
»Ëa£_numb”
);

330 
lib
 = 
	`ucc_ÿÎoc
(1, (
ucc_lib_šfo_t
), "lib_info");

331 ià(!
lib
) {

332 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for†ib_info",

333 (
ucc_lib_šfo_t
));

334  
UCC_ERR_NO_MEMORY
;

336 
lib
->
fuÎ_´efix
 = 
	`¡rdup
(
cÚfig
->full_prefix);

337 ià(!
lib
->
fuÎ_´efix
) {

338 
	`ucc_”rÜ
("failed strdup for full_prefix");

339 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

340 
”rÜ
;

349 
¡©us
 = 
	`ucc_ş_lib_š™
(
·¿ms
, 
cÚfig
, 
lib
);

350 ià(
UCC_OK
 !ğ
¡©us
) {

351 
”rÜ
;

354 
¡©us
 = 
	`ucc__lib_š™
(
·¿ms
, 
lib
);

355 ià(
UCC_OK
 !ğ
¡©us
) {

356 
”rÜ
;

359 
¡©us
 = 
	`ucc_mpoŞ_š™
(&
lib
->
¡ub_sks_mp
, 0, (
ucc_cŞl_sk_t
), 0,

360 
UCC_CACHE_LINE_SIZE
, 8, 
UINT_MAX
,

361 &
ucc_cŞl_sk_mpoŞ_İs
, 
UCC_THREAD_MULTIPLE
,

363 ià(
¡©us
 !ğ
UCC_OK
) {

364 
”rÜ
;

367 *
lib_p
 = 
lib
;

368  
UCC_OK
;

369 
”rÜ
:

370 
	`ucc_ä“
(
lib
);

371  
¡©us
;

372 
	}
}

374 
ucc_¡©us_t
 
	$ucc_lib_cÚfig_»ad
(cÚ¡ *
’v_´efix
, cÚ¡ *
f’ame
,

375 
ucc_lib_cÚfig_t
 **
cÚfig_p
)

377 
ucc_lib_cÚfig_t
 *
cÚfig
;

378 
ucc_¡©us_t
 
¡©us
;

379 
size_t
 
fuÎ_´efix_Ën
;

380 cÚ¡ *
ba£_´efix
 = "UCC_";

382 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`ucc_cÚ¡ruùÜ
())) {

383  
¡©us
;

386 ià(
f’ame
 !ğ
NULL
) {

387 
	`ucc_”rÜ
("read from file is‚ot implemented");

388 
¡©us
 = 
UCC_ERR_NOT_IMPLEMENTED
;

389 
”r
;

391 
cÚfig
 = 
	`ucc_m®loc
((*config), "lib_config");

392 ià(
cÚfig
 =ğ
NULL
) {

393 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for†ib_config",

394 (*
cÚfig
));

395 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

396 
”r
;

402 
fuÎ_´efix_Ën
 =

403 
	`¡¾’
(
ba£_´efix
è+ (
’v_´efix
 ? strlen(env_prefix) : 0) + 2;

404 
cÚfig
->
fuÎ_´efix
 = 
	`ucc_m®loc
(
fuÎ_´efix_Ën
, "full_prefix");

405 ià(!
cÚfig
->
fuÎ_´efix
) {

406 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for full_prefix",

407 
fuÎ_´efix_Ën
);

408 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

409 
”r_ä“_cÚfig
;

411 ià(
’v_´efix
) {

412 
	`ucc_¢´štf_§ã
(
cÚfig
->
fuÎ_´efix
, 
fuÎ_´efix_Ën
, "%s_%s",

413 
’v_´efix
, 
ba£_´efix
);

415 
	`ucc_¡ºıy_§ã
(
cÚfig
->
fuÎ_´efix
, 
ba£_´efix
,

416 
	`¡¾’
(
ba£_´efix
) + 1);

419 
¡©us
 = 
	`ucc_cÚfig_·r£r_fl_İts
(
cÚfig
,

420 
	`UCC_CONFIG_GET_TABLE
(
ucc_lib_cÚfig_bË
),

421 
cÚfig
->
fuÎ_´efix
, 0);

422 ià(
¡©us
 !ğ
UCC_OK
) {

423 
	`ucc_”rÜ
("failedo„ead UCC†ib config");

424 
”r_ä“_´efix
;

426 *
cÚfig_p
 = 
cÚfig
;

427  
UCC_OK
;

429 
”r_ä“_´efix
:

430 
	`ucc_ä“
(
cÚfig
->
fuÎ_´efix
);

431 
”r_ä“_cÚfig
:

432 
	`ucc_ä“
(
cÚfig
);

433 
”r
:

434  
¡©us
;

435 
	}
}

437 
	$ucc_lib_cÚfig_»Ëa£
(
ucc_lib_cÚfig_t
 *
cÚfig
)

439 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(
cÚfig
, 
ucc_lib_cÚfig_bË
);

440 
	`ucc_ä“
(
cÚfig
->
fuÎ_´efix
);

441 
	`ucc_ä“
(
cÚfig
);

442 
	}
}

444 
	$ucc_lib_cÚfig_´št
(cÚ¡ 
ucc_lib_cÚfig_h
 
cÚfig
, 
FILE
 *
¡»am
,

445 cÚ¡ *
t™Ë
,

446 
ucc_cÚfig_´št_æags_t
 
´št_æags
)

448 
	`ucc_cÚfig_·r£r_´št_İts
(
¡»am
, 
t™Ë
, 
cÚfig
, 
ucc_lib_cÚfig_bË
,

449 
NULL
, 
cÚfig
->
fuÎ_´efix
, 
´št_æags
);

450 
	}
}

452 
ucc_¡©us_t
 
	$ucc_lib_cÚfig_modify
(
ucc_lib_cÚfig_h
 
cÚfig
, cÚ¡ *
Çme
,

453 cÚ¡ *
v®ue
)

455  
	`ucc_cÚfig_·r£r_£t_v®ue
(
cÚfig
, 
ucc_lib_cÚfig_bË
, 
Çme
,

456 
v®ue
);

457 
	}
}

459 
ucc_¡©us_t
 
	$ucc_lib_g‘_©Œ
(
ucc_lib_h
 
lib_p
, 
ucc_lib_©Œ_t
 *
lib_©Œ
)

461 
ucc_lib_šfo_t
 *
lib
 = (ucc_lib_šfo_ˆ*)
lib_p
;

463 ià(
lib_©Œ
->
mask
 & 
UCC_LIB_ATTR_FIELD_THREAD_MODE
) {

464 
lib_©Œ
->
th»ad_mode
 = 
lib
->
©Œ
.thread_mode;

466 ià(
lib_©Œ
->
mask
 & 
UCC_LIB_ATTR_FIELD_COLL_TYPES
) {

467 
lib_©Œ
->
cŞl_ty³s
 = 
lib
->
©Œ
.coll_types;

469 ià((
lib_©Œ
->
mask
 & 
UCC_LIB_ATTR_FIELD_REDUCTION_TYPES
) ||

470 (
lib_©Œ
->
mask
 & 
UCC_LIB_ATTR_FIELD_SYNC_TYPE
)) {

471  
UCC_ERR_NOT_SUPPORTED
;

473  
UCC_OK
;

474 
	}
}

476 
ucc_¡©us_t
 
	$ucc_fš®ize
(
ucc_lib_šfo_t
 *
lib
)

478 
i
;

479 
ucc_¡©us_t
 
¡©us
, 
gl_¡©us
;

481 
gl_¡©us
 = 
UCC_OK
;

482 
	`ucc_as£¹
(
lib
->
n_ş_libs_İ’ed
 > 0);

483 
	`ucc_as£¹
(
lib
->
ş_libs
 !ğ
NULL
);

485 
	`ucc_mpoŞ_ş—nup
(&
lib
->
¡ub_sks_mp
, 1);

486 
i
 = 0; i < 
lib
->
n__libs_İ’ed
; i++) {

487 
lib
->
_libs
[
i
]->
içû
->lib.
	`fš®ize
(&lib->_libs[i]->
su³r
);

489 
i
 = 0; i < 
lib
->
n_ş_libs_İ’ed
; i++) {

490 
lib
->
ş_libs
[
i
]->
içû
->lib.
	`fš®ize
(&lib->ş_libs[i]->
su³r
);

492 
¡©us
 = 
	`ucc_mc_fš®ize
();

493 ià(
¡©us
 !ğ
UCC_OK
) {

494 
gl_¡©us
 = 
¡©us
;

497 
¡©us
 = 
	`ucc_ec_fš®ize
();

498 ià(
¡©us
 !ğ
UCC_OK
) {

499 
gl_¡©us
 = 
¡©us
;

502 
	`ucc_ä“
(
lib
->
_libs
);

503 
	`ucc_ä“
(
lib
->
ş_libs
);

504 
	`ucc_ä“
(
lib
->
fuÎ_´efix
);

505 
	`ucc_ä“
(
lib
->
ş_©Œs
);

506 
	`ucc_ä“
(
lib
);

508  
gl_¡©us
;

509 
	}
}

	@src/core/ucc_lib.h

7 #iâdeà
UCC_LIB_H_


8 
	#UCC_LIB_H_


	)

10 
	~"cÚfig.h
"

11 
	~"ucc/­i/ucc.h
"

12 
	~"compÚ’ts/ş/ucc_ş_ty³.h
"

13 
	~"uts/ucc_·r£r.h
"

14 
	~"uts/ucc_mpoŞ.h
"

16 
ucc_ş_lib
 
	tucc_ş_lib_t
;

17 
ucc__lib
 
	tucc__lib_t
;

18 
ucc_ş_lib_©Œ
 
	tucc_ş_lib_©Œ_t
;

19 
ucc__içû
 
	tucc__içû_t
;

21 
	succ_lib_cÚfig
 {

22 *
	mfuÎ_´efix
;

24 
ucc_ş_ty³_t
 *
	mty³s
;

25 
	mcouÁ
;

26 } 
	mşs
;

27 } 
	tucc_lib_cÚfig_t
;

29 
	succ_lib_šfo
 {

30 *
	mfuÎ_´efix
;

31 
	mn_ş_libs_İ’ed
;

32 
	mn__libs_İ’ed
;

33 
ucc_ş_lib_t
 **
	mş_libs
;

34 
ucc__lib_t
 **
	m_libs
;

35 
ucc_lib_©Œ_t
 
	m©Œ
;

36 
	m¥ecific_şs_»que¡ed
;

37 
ucc_ş_lib_©Œ_t
 *
	mş_©Œs
;

38 
ucc_mpoŞ_t
 
	m¡ub_sks_mp
;

39 } 
	tucc_lib_šfo_t
;

41 
ucc__is_»quœed
(
ucc_lib_šfo_t
 *
lib
, 
ucc__içû_t
 *
_içû
,

42 
fÜûd
);

	@src/core/ucc_progress_queue.c

6 
	~"cÚfig.h
"

7 
	~"ucc_´og»ss_queue.h
"

9 
ucc_¡©us_t
 
ucc_pq_¡_š™
(
ucc_´og»ss_queue_t
 **
pq
);

10 
ucc_¡©us_t
 
ucc_pq_mt_š™
(
ucc_´og»ss_queue_t
 **
pq
, 
ušt32_t
 
lock_ä“_´og»ss_q
);

12 
ucc_¡©us_t
 
	$ucc_´og»ss_queue_š™
(
ucc_´og»ss_queue_t
 **
pq
,

13 
ucc_th»ad_mode_t
 
tm
,

14 
ušt32_t
 
lock_ä“_´og»ss_q
)

16 ià(
tm
 =ğ
UCC_THREAD_SINGLE
) {

17  
	`ucc_pq_¡_š™
(
pq
);

19  
	`ucc_pq_mt_š™
(
pq
, 
lock_ä“_´og»ss_q
);

21 
	}
}

23 
	$ucc_´og»ss_queue_fš®ize
(
ucc_´og»ss_queue_t
 *
pq
)

25  
pq
->
	`fš®ize
(pq);

26 
	}
}

	@src/core/ucc_progress_queue.h

7 #iâdeà
UCC_PROGRESS_QUEUE_H_


8 
	#UCC_PROGRESS_QUEUE_H_


	)

10 
	~"ucc/­i/ucc.h
"

11 
	~"scheduË/ucc_scheduË.h
"

13 
ucc_´og»ss_queue
 
	tucc_´og»ss_queue_t
;

14 
	succ_´og»ss_queue
 {

15 (*
	m’queue
)(
ucc_´og»ss_queue_t
 *
	mpq
, 
ucc_cŞl_sk_t
 *
	msk
);

16 (*
	mdequeue
)(
ucc_´og»ss_queue_t
 *
	mpq
, 
ucc_cŞl_sk_t
 **
	msk
);

17 (*
	m´og»ss
)(
ucc_´og»ss_queue_t
 *
	mpq
);

18 (*
	mis_em±y
)(
ucc_´og»ss_queue_t
 *
	mpq
);

19 (*
	mfš®ize
)(
ucc_´og»ss_queue_t
 *
	mpq
);

22 
ucc_¡©us_t
 
ucc_´og»ss_queue_š™
(
ucc_´og»ss_queue_t
 **
pq
,

23 
ucc_th»ad_mode_t
 
tm
,

24 
ušt32_t
 
lock_ä“_´og»ss_q
);

26 
šlše
 
	$ucc_´og»ss_’queue
(
ucc_´og»ss_queue_t
 *
pq
,

27 
ucc_cŞl_sk_t
 *
sk
)

29 
pq
->
	`’queue
Õq, 
sk
);

30 
	}
}

32 
šlše
 
ucc_¡©us_t
 
	$ucc_´og»ss_queue_’queue
(
ucc_´og»ss_queue_t
 *
pq
,

33 
ucc_cŞl_sk_t
 *
sk
)

35 
sk
->
	`´og»ss
(task);

36 ià(
sk
->
¡©us
 !ğ
UCC_INPROGRESS
) {

38  
	`ucc_sk_com¶‘e
(
sk
);

41 
sk
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

42 
pq
->
	`’queue
Õq, 
sk
);

43  
UCC_OK
;

44 
	}
}

46 
šlše
 
	$ucc_´og»ss_queue
(
ucc_´og»ss_queue_t
 *
pq
)

48  
pq
->
	`´og»ss
(pq);

49 
	}
}

51 
šlše
 
	$ucc_´og»ss_queue_is_em±y
(
ucc_´og»ss_queue_t
 *
pq
)

53  
pq
->
	`is_em±y
(pq);

54 
	}
}

56 
ucc_´og»ss_queue_fš®ize
(
ucc_´og»ss_queue_t
 *
pq
);

	@src/core/ucc_progress_queue_mt.c

7 
	~"cÚfig.h
"

8 
	~"ucc_´og»ss_queue.h
"

9 
	~"uts/ucc_m®loc.h
"

10 
	~"uts/ucc_log.h
"

11 
	~"uts/ucc_time.h
"

12 
	~"uts/ucc_¥šlock.h
"

13 
	~"uts/ucc_li¡.h
"

14 
	~"uts/ucc_lock_ä“_queue.h
"

15 
	~"uts/ucc_cŞl_uts.h
"

17 
	succ_pq_mt
 {

18 
ucc_´og»ss_queue_t
 
	msu³r
;

19 
ucc_lf_queue_t
 
	mlf_queue
;

20 } 
	tucc_pq_mt_t
;

22 
	succ_pq_mt_locked
 {

23 
ucc_´og»ss_queue_t
 
	msu³r
;

24 
ucc_¥šlock_t
 
	mqueue_lock
;

25 
ucc_li¡_lšk_t
 
	mqueue
;

26 } 
	tucc_pq_mt_locked_t
;

28 
	$ucc_pq_locked_mt_’queue
(
ucc_´og»ss_queue_t
 *
pq
,

29 
ucc_cŞl_sk_t
 *
sk
)

31 
ucc_pq_mt_locked_t
 *
pq_mt
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_mt_locked_t);

33 
	`ucc_¥š_lock
(&
pq_mt
->
queue_lock
);

34 
	`ucc_li¡_add_
(&
pq_mt
->
queue
, &
sk
->
li¡_–em
);

35 
	`ucc_¥š_uÆock
(&
pq_mt
->
queue_lock
);

36 
	}
}

38 
	$ucc_pq_mt_’queue
(
ucc_´og»ss_queue_t
 *
pq
, 
ucc_cŞl_sk_t
 *
sk
)

40 
ucc_pq_mt_t
 *
pq_mt
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_mt_t);

42 
	`ucc_lf_queue_’queue
(&
pq_mt
->
lf_queue
, &
sk
->
lf_–em
);

43 
	}
}

45 
	$ucc_pq_locked_mt_dequeue
(
ucc_´og»ss_queue_t
 *
pq
,

46 
ucc_cŞl_sk_t
 **
pİ³d_sk
)

48 
ucc_pq_mt_locked_t
 *
pq_mt
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_mt_locked_t);

49 *
pİ³d_sk
 = 
NULL
;

51 
	`ucc_¥š_lock
(&
pq_mt
->
queue_lock
);

52 ià(!
	`ucc_li¡_is_em±y
(&
pq_mt
->
queue
)) {

53 *
pİ³d_sk
 =

54 
	`ucc_li¡_exŒaù_h—d
(&
pq_mt
->
queue
, 
ucc_cŞl_sk_t
, 
li¡_–em
);

56 
	`ucc_¥š_uÆock
(&
pq_mt
->
queue_lock
);

57 
	}
}

59 
	$ucc_pq_mt_dequeue
(
ucc_´og»ss_queue_t
 *
pq
,

60 
ucc_cŞl_sk_t
 **
pİ³d_sk
)

62 
ucc_pq_mt_t
 *
pq_mt
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_mt_t);

63 
ucc_lf_queue_–em_t
 *
–em
 = 
	`ucc_lf_queue_dequeue
(&
pq_mt
->
lf_queue
, 1);

64 *
pİ³d_sk
 =

65 
–em
 ? 
	`ucc_cÚš”_of
ÓËm, 
ucc_cŞl_sk_t
, 
lf_–em
è: 
NULL
;

66 
	}
}

68 
	$ucc_pq_mt_´og»ss
(
ucc_´og»ss_queue_t
 *
pq
)

70 
n_´og»s£d
 = 0;

71 
time¡amp
 = -1;

72 
ucc_cŞl_sk_t
 *
sk
;

73 
ucc_¡©us_t
 
¡©us
;

75 
pq
->
	`dequeue
Õq, &
sk
);

76 ià(
sk
) {

77 ià(
sk
->
´og»ss
) {

78 
sk
->
	`´og»ss
(task);

80 ià(
UCC_INPROGRESS
 =ğ
sk
->
¡©us
) {

81 ià(
	`UCC_COLL_TIMEOUT_REQUIRED
(
sk
)) {

82 ià(
time¡amp
 < 0) {

83 
time¡amp
 = 
	`ucc_g‘_time
();

85 ià(
	`ucc_uÆik–y
(
time¡amp
 - 
sk
->
¡¬t_time
 >

86 
sk
->
b¬gs
.
¬gs
.
timeout
)) {

87 
sk
->
¡©us
 = 
UCC_ERR_TIMED_OUT
;

88 
	`ucc_sk_com¶‘e
(
sk
);

89  
UCC_ERR_TIMED_OUT
;

93 
pq
->
	`’queue
Õq, 
sk
);

94  
n_´og»s£d
;

96 
n_´og»s£d
++;

97 ià(
	`ucc_uÆik–y
(0 > (
¡©us
 = 
	`ucc_sk_com¶‘e
(
sk
)))) {

98  
¡©us
;

101  
n_´og»s£d
;

102 
	}
}

104 
	$ucc_pq_locked_mt_is_em±y
(
ucc_´og»ss_queue_t
 *
pq
)

106 
ucc_pq_mt_locked_t
 *
pq_mt
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_mt_locked_t);

109  
	`ucc_li¡_is_em±y
(&
pq_mt
->
queue
);

110 
	}
}

112 
	$ucc_pq_mt_is_em±y
(
ucc_´og»ss_queue_t
 *
pq
)

116 
	}
}

118 
	$ucc_pq_locked_mt_fš®ize
(
ucc_´og»ss_queue_t
 *
pq
)

120 
ucc_pq_mt_locked_t
 *
pq_mt
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_mt_locked_t);

121 
	`ucc_¥šlock_de¡roy
(&
pq_mt
->
queue_lock
);

122 
	`ucc_ä“
(
pq_mt
);

123 
	}
}

125 
	$ucc_pq_mt_fš®ize
(
ucc_´og»ss_queue_t
 *
pq
)

127 
ucc_pq_mt_t
 *
pq_mt
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_mt_t);

128 
	`ucc_lf_queue_de¡roy
(&
pq_mt
->
lf_queue
);

129 
	`ucc_ä“
(
pq_mt
);

130 
	}
}

132 
ucc_¡©us_t
 
	$ucc_pq_mt_š™
(
ucc_´og»ss_queue_t
 **
pq
,

133 
ušt32_t
 
lock_ä“_´og»ss_q
)

135 ià(
lock_ä“_´og»ss_q
) {

136 
ucc_pq_mt_t
 *
pq_mt
 = 
	`ucc_m®loc
((*pq_mt), "pq_mt");

137 ià(!
pq_mt
) {

138 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜ…q_mt", (*
pq_mt
));

139  
UCC_ERR_NO_MEMORY
;

141 
	`ucc_lf_queue_š™
(&
pq_mt
->
lf_queue
);

142 
pq_mt
->
su³r
.
’queue
 = 
ucc_pq_mt_’queue
;

143 
pq_mt
->
su³r
.
dequeue
 = 
ucc_pq_mt_dequeue
;

144 
pq_mt
->
su³r
.
´og»ss
 = 
ucc_pq_mt_´og»ss
;

145 
pq_mt
->
su³r
.
fš®ize
 = 
ucc_pq_mt_fš®ize
;

146 
pq_mt
->
su³r
.
is_em±y
 = 
ucc_pq_mt_is_em±y
;

147 *
pq
 = &
pq_mt
->
su³r
;

149 
ucc_pq_mt_locked_t
 *
pq_mt
 = 
	`ucc_m®loc
((*pq_mt), "pq_mt");

150 ià(!
pq_mt
) {

151 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜ…q_mt", (*
pq_mt
));

152  
UCC_ERR_NO_MEMORY
;

154 
	`ucc_¥šlock_š™
(&
pq_mt
->
queue_lock
, 0);

155 
	`ucc_li¡_h—d_š™
(&
pq_mt
->
queue
);

156 
pq_mt
->
su³r
.
’queue
 = 
ucc_pq_locked_mt_’queue
;

157 
pq_mt
->
su³r
.
dequeue
 = 
ucc_pq_locked_mt_dequeue
;

158 
pq_mt
->
su³r
.
´og»ss
 = 
ucc_pq_mt_´og»ss
;

159 
pq_mt
->
su³r
.
fš®ize
 = 
ucc_pq_locked_mt_fš®ize
;

160 
pq_mt
->
su³r
.
is_em±y
 = 
ucc_pq_locked_mt_is_em±y
;

161 *
pq
 = &
pq_mt
->
su³r
;

163  
UCC_OK
;

164 
	}
}

	@src/core/ucc_progress_queue_st.c

7 
	~"cÚfig.h
"

8 
	~"ucc_´og»ss_queue.h
"

9 
	~"uts/ucc_m®loc.h
"

10 
	~"uts/ucc_log.h
"

11 
	~"uts/ucc_time.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

14 
	succ_pq_¡
 {

15 
ucc_´og»ss_queue_t
 
	msu³r
;

16 
ucc_li¡_lšk_t
 
	mli¡
;

17 } 
	tucc_pq_¡_t
;

19 
	$ucc_pq_¡_´og»ss
(
ucc_´og»ss_queue_t
 *
pq
)

21 
ucc_pq_¡_t
 *
pq_¡
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_st_t);

22 
n_´og»s£d
 = 0;

23 
time¡amp
 = -1;

24 
ucc_cŞl_sk_t
 *
sk
, *
tmp
;

25 
ucc_¡©us_t
 
¡©us
;

27 
	`ucc_li¡_fÜ_—ch_§ã
(
sk
, 
tmp
, &
pq_¡
->
li¡
, 
li¡_–em
) {

28 
	`ucc_as£¹
((
sk
->
¡©us
 !ğ
UCC_OPERATION_INITIALIZED
) &&

29 (
sk
->
su³r
.
¡©us
 !ğ
UCC_OPERATION_INITIALIZED
));

30 ià(
sk
->
´og»ss
) {

31 
	`ucc_as£¹
(
sk
->
¡©us
 !ğ
UCC_OK
);

32 
sk
->
	`´og»ss
(task);

34 ià(
UCC_INPROGRESS
 =ğ
sk
->
¡©us
) {

35 ià(
	`UCC_COLL_TIMEOUT_REQUIRED
(
sk
)) {

36 ià(
time¡amp
 < 0) {

37 
time¡amp
 = 
	`ucc_g‘_time
();

39 ià(
	`ucc_uÆik–y
(
time¡amp
 - 
sk
->
¡¬t_time
 >

40 
sk
->
b¬gs
.
¬gs
.
timeout
)) {

41 
sk
->
¡©us
 = 
UCC_ERR_TIMED_OUT
;

42 
	`ucc_li¡_d–
(&
sk
->
li¡_–em
);

43 
	`ucc_sk_com¶‘e
(
sk
);

44  
UCC_ERR_TIMED_OUT
;

49 
	`ucc_li¡_d–
(&
sk
->
li¡_–em
);

50 
n_´og»s£d
++;

51 ià(0 > (
¡©us
 = 
	`ucc_sk_com¶‘e
(
sk
))) {

52  
¡©us
;

55  
n_´og»s£d
;

56 
	}
}

58 
	$ucc_pq_¡_’queue
(
ucc_´og»ss_queue_t
 *
pq
, 
ucc_cŞl_sk_t
 *
sk
)

60 
ucc_pq_¡_t
 *
pq_¡
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_st_t);

62 
	`ucc_li¡_add_
(&
pq_¡
->
li¡
, &
sk
->
li¡_–em
);

63 
	}
}

65 
	$ucc_pq_¡_fš®ize
(
ucc_´og»ss_queue_t
 *
pq
)

67 
ucc_pq_¡_t
 *
pq_¡
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_st_t);

68 
	`ucc_ä“
(
pq_¡
);

69 
	}
}

71 
	$ucc_pq_¡_is_em±y
(
ucc_´og»ss_queue_t
 *
pq
)

73 
ucc_pq_¡_t
 *
pq_¡
 = 
	`ucc_d”ived_of
(
pq
, ucc_pq_st_t);

75  
	`ucc_li¡_is_em±y
(&
pq_¡
->
li¡
);

76 
	}
}

78 
ucc_¡©us_t
 
	$ucc_pq_¡_š™
(
ucc_´og»ss_queue_t
 **
pq
)

80 
ucc_pq_¡_t
 *
pq_¡
 = 
	`ucc_m®loc
((*pq_st), "pq_st");

81 ià(!
pq_¡
) {

82 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜ…q_¡", (*
pq_¡
));

83  
UCC_ERR_NO_MEMORY
;

85 
	`ucc_li¡_h—d_š™
(&
pq_¡
->
li¡
);

86 
pq_¡
->
su³r
.
’queue
 = 
ucc_pq_¡_’queue
;

87 
pq_¡
->
su³r
.
dequeue
 = 
NULL
;

88 
pq_¡
->
su³r
.
´og»ss
 = 
ucc_pq_¡_´og»ss
;

89 
pq_¡
->
su³r
.
fš®ize
 = 
ucc_pq_¡_fš®ize
;

90 
pq_¡
->
su³r
.
is_em±y
 = 
ucc_pq_¡_is_em±y
;

92 *
pq
 = &
pq_¡
->
su³r
;

93  
UCC_OK
;

94 
	}
}

	@src/core/ucc_service_coll.c

7 
	~"ucc_£rviû_cŞl.h
"

8 
	~"ucc_‹am.h
"

10 
ušt64_t
 
	$ucc_£rviû_cŞl_m­_cb
(
ušt64_t
 
•
, *
cb_ùx
)

12 
ucc_£rviû_cŞl_»q_t
 *
»q
 = 
cb_ùx
;

13 
ucc_‹am_t
 *
‹am
 = 
»q
->team;

14 
ucc_¿nk_t
 
‹am_¿nk
;

16 
‹am_¿nk
 = 
	`ucc_•_m­_ev®
(
»q
->
sub£t
.
m­
, (
ucc_¿nk_t
)
•
);

17  
	`ucc_•_m­_ev®
(
‹am
->
ùx_m­
, 
‹am_¿nk
);

18 
	}
}

20 
šlše
 
ucc_¡©us_t


21 
	$ucc_£rviû_cŞl_»q_š™
(
ucc_‹am_t
 *
‹am
, 
ucc_sub£t_t
 *
sub£t
,

22 
ucc__‹am_t
 **
£rviû_‹am
,

23 
ucc_£rviû_cŞl_»q_t
 **
_»q
)

25 
ucc_cÚ‹xt_t
 *
ùx
 = 
‹am
->
cÚ‹xts
[0];

26 
ucc_£rviû_cŞl_»q_t
 *
»q
;

28 *
£rviû_‹am
 = 
NULL
;

29 
»q
 = 
	`ucc_m®loc
((*req), "service_req");

30 ià(!
»q
) {

31 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for service coll„eq",

32 (*
»q
));

33  
UCC_ERR_NO_MEMORY
;

35 
»q
->
‹am
 =eam;

36 
»q
->
sub£t
 = *subset;

38 ià(
ùx
->
£rviû_‹am
) {

39 *
£rviû_‹am
 = 
ùx
->service_team;

40 
sub£t
->
m­
.
ty³
 = 
UCC_EP_MAP_CB
;

41 
sub£t
->
m­
.
cb
.cb = 
ucc_£rviû_cŞl_m­_cb
;

42 
sub£t
->
m­
.
cb
.
cb_ùx
 = 
»q
;

44 
	`ucc_as£¹
(
‹am
->
£rviû_‹am
 !ğ
NULL
);

45 *
£rviû_‹am
 = 
‹am
->service_team;

48 *
_»q
 = 
»q
;

49  
UCC_OK
;

50 
	}
}

52 
ucc_¡©us_t
 
	$ucc_£rviû_®Ìeduû
(
ucc_‹am_t
 *
‹am
, *
sbuf
, *
rbuf
,

53 
ucc_d©©y³_t
 
dt
, 
size_t
 
couÁ
,

54 
ucc_»duùiÚ_İ_t
 
İ
, 
ucc_sub£t_t
 
sub£t
,

55 
ucc_£rviû_cŞl_»q_t
 **
»q
)

57 
ucc__‹am_t
 *
¡—m
;

58 
ucc__içû_t
 *
_içû
;

59 
ucc_¡©us_t
 
¡©us
;

61 
¡©us
 = 
	`ucc_£rviû_cŞl_»q_š™
(
‹am
, &
sub£t
, &
¡—m
, 
»q
);

62 ià(
UCC_OK
 !ğ
¡©us
) {

63  
¡©us
;

66 
_içû
 = 
	`UCC_TL_TEAM_IFACE
(
¡—m
);

67 
¡©us
 = 
_içû
->
scŞl
.
	`®Ìeduû
(&
¡—m
->
su³r
, 
sbuf
, 
rbuf
, 
dt
, 
couÁ
, 
İ
,

68 
sub£t
, &(*
»q
)->
sk
);

69 ià(
¡©us
 < 0) {

70 
	`ucc_ä“
(*
»q
);

71 
	`ucc_”rÜ
("çedØ¡¬ˆ£rviû‡Î»duû fÜ—m %p: %s", 
‹am
,

72 
	`ucc_¡©us_¡ršg
(
¡©us
));

73  
¡©us
;

76  
UCC_OK
;

77 
	}
}

79 
ucc_¡©us_t
 
	$ucc_£rviû_®lg©h”
(
ucc_‹am_t
 *
‹am
, *
sbuf
, *
rbuf
,

80 
size_t
 
msgsize
, 
ucc_sub£t_t
 
sub£t
,

81 
ucc_£rviû_cŞl_»q_t
 **
»q
)

83 
ucc__‹am_t
 *
¡—m
;

84 
ucc__içû_t
 *
_içû
;

85 
ucc_¡©us_t
 
¡©us
;

87 
¡©us
 = 
	`ucc_£rviû_cŞl_»q_š™
(
‹am
, &
sub£t
, &
¡—m
, 
»q
);

88 ià(
UCC_OK
 !ğ
¡©us
) {

89  
¡©us
;

92 
_içû
 = 
	`UCC_TL_TEAM_IFACE
(
¡—m
);

93 
¡©us
 = 
_içû
->
scŞl
.
	`®lg©h”
(&
¡—m
->
su³r
, 
sbuf
, 
rbuf
, 
msgsize
,

94 
sub£t
, &(*
»q
)->
sk
);

95 ià(
¡©us
 < 0) {

96 
	`ucc_ä“
(*
»q
);

97 
	`ucc_”rÜ
("çedØ¡¬ˆ£rviû‡Î»duû fÜ—m %p: %s", 
‹am
,

98 
	`ucc_¡©us_¡ršg
(
¡©us
));

99  
¡©us
;

102  
UCC_OK
;

103 
	}
}

105 
ucc_¡©us_t
 
	$ucc_£rviû_bÿ¡
(
ucc_‹am_t
 *
‹am
, *
buf
, 
size_t
 
msgsize
,

106 
ucc_¿nk_t
 
roÙ
, 
ucc_sub£t_t
 
sub£t
,

107 
ucc_£rviû_cŞl_»q_t
 **
»q
)

109 
ucc__‹am_t
 *
¡—m
;

110 
ucc__içû_t
 *
_içû
;

111 
ucc_¡©us_t
 
¡©us
;

113 
¡©us
 = 
	`ucc_£rviû_cŞl_»q_š™
(
‹am
, &
sub£t
, &
¡—m
, 
»q
);

114 ià(
UCC_OK
 !ğ
¡©us
) {

115  
¡©us
;

118 
_içû
 = 
	`UCC_TL_TEAM_IFACE
(
¡—m
);

119 
¡©us
 = 
_içû
->
scŞl
.
	`bÿ¡
(&
¡—m
->
su³r
, 
buf
, 
msgsize
,

120 
roÙ
, 
sub£t
, &(*
»q
)->
sk
);

121 ià(
¡©us
 < 0) {

122 
	`ucc_ä“
(*
»q
);

123 
	`ucc_”rÜ
("çedØ¡¬ˆ£rviû bÿ¡ fÜ—m %p: %s", 
‹am
,

124 
	`ucc_¡©us_¡ršg
(
¡©us
));

125  
¡©us
;

128  
UCC_OK
;

129 
	}
}

131 
ucc_¡©us_t
 
	$ucc_£rviû_cŞl_‹¡
(
ucc_£rviû_cŞl_»q_t
 *
»q
)

133 
ucc_¡©us_t
 
¡©us
;

135 
¡©us
 = 
	`ucc_cŞËùive_‹¡
(&
»q
->
sk
->
su³r
);

136 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

137 
	`ucc_cÚ‹xt_´og»ss
(
»q
->
‹am
->
cÚ‹xts
[0]);

139  
¡©us
;

140 
	}
}

142 
ucc_¡©us_t
 
	$ucc_£rviû_cŞl_fš®ize
(
ucc_£rviû_cŞl_»q_t
 *
»q
)

144 
ucc_¡©us_t
 
¡©us
;

146 
¡©us
 = 
	`ucc_cŞËùive_fš®ize_š‹º®
(
»q
->
sk
);

147 
	`ucc_ä“
(
»q
);

148  
¡©us
;

149 
	}
}

151 
	succ_š‹º®_oob_cŞl_šfo
 {

152 
ucc_‹am_t
 *
	m‹am
;

153 
ucc_sub£t_t
 
	msub£t
;

154 } 
	tucc_š‹º®_oob_cŞl_šfo_t
;

156 
ucc_¡©us_t
 
	$ucc_š‹º®_oob_®lg©h”
(*
sbuf
, *
rbuf
,

157 
size_t
 
size
, *
cŞl_šfo
,

158 **
»que¡
)

160 
ucc_š‹º®_oob_cŞl_šfo_t
 *
ci
 = 
cŞl_šfo
;

161 
ucc_£rviû_cŞl_»q_t
 *
»q
 = 
NULL
;

162 
ucc_¡©us_t
 
¡©us
;

164 
¡©us
 =

165 
	`ucc_£rviû_®lg©h”
(
ci
->
‹am
, 
sbuf
, 
rbuf
, 
size
, ci->
sub£t
, &
»q
);

166 *
»que¡
 = (*)
»q
;

167  
¡©us
;

168 
	}
}

170 
ucc_¡©us_t
 
	$ucc_š‹º®_oob_‹¡
(*
»que¡
)

172 
ucc_£rviû_cŞl_»q_t
 *
»q
 = 
»que¡
;

173  
	`ucc_£rviû_cŞl_‹¡
(
»q
);

174 
	}
}

176 
ucc_¡©us_t
 
	$ucc_š‹º®_oob_ä“
(*
»que¡
)

178 
ucc_£rviû_cŞl_»q_t
 *
»q
 = 
»que¡
;

179  
	`ucc_£rviû_cŞl_fš®ize
(
»q
);

180 
	}
}

182 
ucc_¡©us_t
 
	$ucc_š‹º®_oob_š™
(
ucc_‹am_t
 *
‹am
, 
ucc_sub£t_t
 
sub£t
,

183 
ucc_‹am_oob_cŞl_t
 *
oob
)

185 
ucc_š‹º®_oob_cŞl_šfo_t
 *
ci
;

187 
ci
 = 
	`ucc_m®loc
((*ci), "internal_coll_info");

188 ià(!
ci
) {

189 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for internal_coll_info",

190 (*
ci
));

191  
UCC_ERR_NO_MEMORY
;

194 
ci
->
‹am
 =eam;

195 
ci
->
sub£t
 = subset;

196 
oob
->
cŞl_šfo
 = 
ci
;

197 
oob
->
®lg©h”
 = 
ucc_š‹º®_oob_®lg©h”
;

198 
oob
->
»q_‹¡
 = 
ucc_š‹º®_oob_‹¡
;

199 
oob
->
»q_ä“
 = 
ucc_š‹º®_oob_ä“
;

200 
oob
->
n_oob_•s
 = (
ušt32_t
)
sub£t
.
m­
.
•_num
;

201 
oob
->
oob_•
 = (
ušt32_t
)
sub£t
.
my¿nk
;

203  
UCC_OK
;

204 
	}
}

206 
	$ucc_š‹º®_oob_fš®ize
(
ucc_‹am_oob_cŞl_t
 *
oob
)

208 
	`ucc_ä“
(
oob
->
cŞl_šfo
);

209 
	}
}

	@src/core/ucc_service_coll.h

6 #iâdeà
UCC_SERVICE_COLL_H_


7 
	#UCC_SERVICE_COLL_H_


	)

9 
	~"ucc/­i/ucc.h
"

10 
	~"compÚ’ts//ucc_.h
"

12 
	succ_£rviû_cŞl_»q
 {

13 
ucc_cŞl_sk_t
 *
	msk
;

14 
ucc_‹am_t
 *
	m‹am
;

15 * 
	md©a
;

16 
ucc_sub£t_t
 
	msub£t
;

17 } 
	tucc_£rviû_cŞl_»q_t
;

19 
ucc_¡©us_t
 
ucc_£rviû_®Ìeduû
(
ucc_‹am_t
 *
‹am
, *
sbuf
, *
rbuf
,

20 
ucc_d©©y³_t
 
dt
, 
size_t
 
couÁ
,

21 
ucc_»duùiÚ_İ_t
 
İ
, 
ucc_sub£t_t
 
sub£t
,

22 
ucc_£rviû_cŞl_»q_t
 **
»q
);

24 
ucc_¡©us_t
 
ucc_£rviû_®lg©h”
(
ucc_‹am_t
 *
‹am
, *
sbuf
, *
rbuf
,

25 
size_t
 
msgsize
, 
ucc_sub£t_t
 
sub£t
,

26 
ucc_£rviû_cŞl_»q_t
 **
»q
);

28 
ucc_¡©us_t
 
ucc_£rviû_bÿ¡
(
ucc_‹am_t
 *
‹am
, *
buf
, 
size_t
 
msgsize
,

29 
ucc_¿nk_t
 
roÙ
, 
ucc_sub£t_t
 
sub£t
,

30 
ucc_£rviû_cŞl_»q_t
 **
»q
);

32 
ucc_¡©us_t
 
ucc_£rviû_cŞl_‹¡
(
ucc_£rviû_cŞl_»q_t
 *
»q
);

34 
ucc_¡©us_t
 
ucc_£rviû_cŞl_fš®ize
(
ucc_£rviû_cŞl_»q_t
 *
»q
);

36 
ucc_¡©us_t
 
ucc_š‹º®_oob_š™
(
ucc_‹am_t
 *
‹am
, 
ucc_sub£t_t
 
sub£t
,

37 
ucc_‹am_oob_cŞl_t
 *
oob
);

39 
ucc_š‹º®_oob_fš®ize
(
ucc_‹am_oob_cŞl_t
 *
oob
);

41 
ucc_¡©us_t
 
ucc_cŞËùive_fš®ize_š‹º®
(
ucc_cŞl_sk_t
 *
sk
);

	@src/core/ucc_team.c

8 
	~"cÚfig.h
"

9 
	~"ucc_‹am.h
"

10 
	~"ucc_lib.h
"

11 
	~"compÚ’ts/ş/ucc_ş.h
"

12 
	~"compÚ’ts//ucc_.h
"

13 
	~"ucc_£rviû_cŞl.h
"

15 
ucc_¡©us_t
 
ucc_‹am_®loc_id
(
ucc_‹am_t
 *
‹am
);

16 
ucc_‹am_»Ëa£_id
(
ucc_‹am_t
 *
‹am
);

18 
	$ucc_cİy_‹am_·¿ms
(
ucc_‹am_·¿ms_t
 *
d¡
, cÚ¡ ucc_‹am_·¿ms_ˆ*
¤c
)

20 
d¡
->
mask
 = 
¤c
->mask;

21 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_ORDERING
, 
Üd”šg
);

22 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_OUTSTANDING_COLLS
,

23 
out¡ªdšg_cŞls
);

24 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_EP
, 
•
);

25 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_EP_RANGE
, 
•_¿nge
);

27 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_TEAM_SIZE
,

28 
‹am_size
);

29 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_SYNC_TYPE
,

30 
sync_ty³
);

31 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_OOB
, 
oob
);

32 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_P2P_CONN
, 
p2p_cÚn
);

33 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_MEM_PARAMS
,

34 
mem_·¿ms
);

35 
	`UCC_COPY_PARAM_BY_FIELD
(
d¡
, 
¤c
, 
UCC_TEAM_PARAM_FIELD_EP_MAP
, 
•_m­
);

36 
	}
}

38 
ucc_¡©us_t
 
	$ucc_‹am_g‘_©Œ
(
ucc_‹am_h
 
‹am
, 
ucc_‹am_©Œ_t
 *
‹am_©Œ
)

40 
ušt64_t
 
suµÜ‹d_f›lds
 =

41 
UCC_TEAM_ATTR_FIELD_SIZE
 | 
UCC_TEAM_ATTR_FIELD_EP
;

43 ià(
‹am_©Œ
->
mask
 & ~
suµÜ‹d_f›lds
) {

44 
	`ucc_”rÜ
("ucc_team_get_attr() is‚ot implemented for specified field");

45  
UCC_ERR_NOT_IMPLEMENTED
;

48 ià(
‹am_©Œ
->
mask
 & 
UCC_TEAM_ATTR_FIELD_SIZE
) {

49 
‹am_©Œ
->
size
 = 
‹am
->size;

52 ià(
‹am_©Œ
->
mask
 & 
UCC_TEAM_ATTR_FIELD_EP
) {

53 
‹am_©Œ
->
•
 = 
‹am
->
¿nk
;

56  
UCC_OK
;

57 
	}
}

59 
ucc_¡©us_t
 
	$ucc_‹am_ü—‹_po¡_sšgË
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
,

60 
ucc_‹am_t
 *
‹am
)

62 
ucc_¡©us_t
 
¡©us
;

64 ià(
cÚ‹xt
->
£rviû_‹am
 && 
‹am
->
size
 > 1) {

66 
ucc_sub£t_t
 
sub£t
 = {.
my¿nk
 = 
‹am
->
¿nk
,

67 .
m­
.
•_num
 = 
‹am
->
size
,

68 .
m­
.
ty³
 = 
UCC_EP_MAP_FULL
};

69 
¡©us
 = 
	`ucc_š‹º®_oob_š™
(
‹am
, 
sub£t
, &‹am->
bp
.
·¿ms
.
oob
);

70 ià(
UCC_OK
 !ğ
¡©us
) {

71  
¡©us
;

73 
‹am
->
bp
.
·¿ms
.
mask
 |ğ
UCC_TEAM_PARAM_FIELD_OOB
;

76 
‹am
->
ş_‹ams
 = 
	`ucc_m®loc
((
ucc_ş_‹am_t
 *è* 
cÚ‹xt
->
n_ş_ùx
);

77 ià(!
‹am
->
ş_‹ams
) {

78 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for cleams‡rray",

79 (
ucc_ş_‹am_t
 *è* 
cÚ‹xt
->
n_ş_ùx
);

80  
UCC_ERR_NO_MEMORY
;

82 
‹am
->
bp
.
¿nk
 =eam->rank;

83 
‹am
->
bp
.
size
 =eam->size;

84 
‹am
->
bp
.team =eam;

85 
‹am
->
bp
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

86 
‹am
->
bp
.
m­
.
•_num
 =—m->
size
;

87 
‹am
->
¡©e
 = (‹am->
size
 > 1è? 
UCC_TEAM_ADDR_EXCHANGE


88 : 
UCC_TEAM_CL_CREATE
;

89 
‹am
->
Ï¡_‹am_ü—‹_po¡ed
 = -1;

90  
UCC_OK
;

91 
	}
}

93 
ucc_¡©us_t
 
	$ucc_‹am_ü—‹_po¡
(
ucc_cÚ‹xt_h
 *
cÚ‹xts
, 
ušt32_t
 
num_cÚ‹xts
,

94 cÚ¡ 
ucc_‹am_·¿ms_t
 *
·¿ms
,

95 
ucc_‹am_h
 *
Ãw_‹am
)

97 
ušt64_t
 
‹am_size
 = 0;

98 
ušt64_t
 
‹am_¿nk
 = 
UINT64_MAX
;

99 
ucc_‹am_t
 *
‹am
;

100 
ucc_¡©us_t
 
¡©us
;

102 ià(
num_cÚ‹xts
 < 1) {

103  
UCC_ERR_INVALID_PARAM
;

104 } ià(
num_cÚ‹xts
 > 1) {

105 
	`ucc_”rÜ
("team creation from multiple contexts is‚ot supported yet");

106  
UCC_ERR_NOT_SUPPORTED
;

109 ià(
·¿ms
->
mask
 & 
UCC_TEAM_PARAM_FIELD_TEAM_SIZE
) {

110 
‹am_size
 = 
·¿ms
->team_size;

113 ià(
·¿ms
->
mask
 & 
UCC_TEAM_PARAM_FIELD_OOB
) {

114 ià(
‹am_size
 > 0 && 
·¿ms
->
oob
.
n_oob_•s
 !=eam_size) {

115 
	`ucc_”rÜ
(

118 ()
·¿ms
->
‹am_size
,

119 ()
·¿ms
->
oob
.
n_oob_•s
);

120  
UCC_ERR_INVALID_PARAM
;

122 
‹am_size
 = 
·¿ms
->
oob
.
n_oob_•s
;

125 ià(
·¿ms
->
mask
 & 
UCC_TEAM_PARAM_FIELD_EP_MAP
) {

126 ià(
‹am_size
 > 0 && 
·¿ms
->
•_m­
.
•_num
 !=eam_size) {

127 
	`ucc_”rÜ
(

130 ()
·¿ms
->
‹am_size
,

131 ()
·¿ms
->
oob
.
n_oob_•s
,

132 ()
·¿ms
->
•_m­
.
•_num
);

133  
UCC_ERR_INVALID_PARAM
;

135 
‹am_size
 = 
·¿ms
->
•_m­
.
•_num
;

137 ià(
‹am_size
 < 1) {

138 
	`ucc_w¬n
("minimal size of UCCeam is 1,…rovided %llu",

139 ()
‹am_size
);

140  
UCC_ERR_INVALID_PARAM
;

143 ià((
·¿ms
->
mask
 & 
UCC_TEAM_PARAM_FIELD_EP
) &&

144 (
·¿ms
->
mask
 & 
UCC_TEAM_PARAM_FIELD_EP_RANGE
) &&

145 (
·¿ms
->
•_¿nge
 =ğ
UCC_COLLECTIVE_EP_RANGE_CONTIG
)) {

146 ià((
·¿ms
->
mask
 & 
UCC_TEAM_PARAM_FIELD_OOB
) &&

147 (
·¿ms
->
oob
.
oob_•
 !ğ·¿ms->
•
)) {

148 
	`ucc_”rÜ
(

151 ()
·¿ms
->
•
,

152 ()
·¿ms
->
oob
.
oob_•
);

153  
UCC_ERR_INVALID_PARAM
;

155 
‹am_¿nk
 = 
·¿ms
->
•
;

156 } ià(
·¿ms
->
mask
 & 
UCC_TEAM_PARAM_FIELD_OOB
) {

157 
‹am_¿nk
 = 
·¿ms
->
oob
.
oob_•
;

160 ià(
‹am_¿nk
 =ğ
UINT64_MAX
) {

162 
	`ucc_”rÜ
("either UCC_TEAM_PARAM_FIELD_EP(RANGE) "

164  
UCC_ERR_INVALID_PARAM
;

167 ià(
‹am_size
 > (
ušt64_t
)
UCC_RANK_MAX
) {

168 
	`ucc_”rÜ
("team size isoo†arge: %llu, max supported %u",

169 ()
‹am_size
, 
UCC_RANK_MAX
);

170  
UCC_ERR_INVALID_PARAM
;

173 ià(
‹am_¿nk
 > (
ušt64_t
)
UCC_RANK_MAX
) {

174 
	`ucc_”rÜ
("team„ank isoo†arge: %llu, max supported %u",

175 ()
‹am_¿nk
, 
UCC_RANK_MAX
);

176  
UCC_ERR_INVALID_PARAM
;

179 
‹am
 = 
	`ucc_ÿÎoc
(1, (
ucc_‹am_t
), "ucc_team");

180 ià(!
‹am
) {

181 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ucceam",

182 (
ucc_‹am_t
));

183  
UCC_ERR_NO_MEMORY
;

185 
‹am
->
ruÁime_oob
 = 
·¿ms
->
oob
;

186 
‹am
->
num_cÚ‹xts
 =‚um_contexts;

187 
‹am
->
size
 = (
ucc_¿nk_t
)
‹am_size
;

188 
‹am
->
¿nk
 = (
ucc_¿nk_t
)
‹am_¿nk
;

189 
‹am
->
£q_num
 = 0;

190 
‹am
->
cÚ‹xts
 = 
	`ucc_m®loc
((
ucc_cÚ‹xt_t
 *è* 
num_cÚ‹xts
,

192 ià(!
‹am
->
cÚ‹xts
) {

193 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ucceam contexts‡rray",

194 (
ucc_cÚ‹xt_t
è* 
num_cÚ‹xts
);

195 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

196 
”r_ùx_®loc
;

199 
	`memıy
(
‹am
->
cÚ‹xts
, cÚ‹xts, (
ucc_cÚ‹xt_t
 *è* 
num_cÚ‹xts
);

200 
	`ucc_cİy_‹am_·¿ms
(&
‹am
->
bp
.
·¿ms
,…arams);

202 ià((
·¿ms
->
mask
 & 
UCC_TEAM_PARAM_FIELD_ID
) &&

203 (
·¿ms
->
id
 <ğ
UCC_TEAM_ID_MAX
)) {

204 
‹am
->
id
 = ((
ušt16_t
)
·¿ms
->idè| 
UCC_TEAM_ID_EXTERNAL_BIT
;

206 
¡©us
 = 
	`ucc_‹am_ü—‹_po¡_sšgË
(
cÚ‹xts
[0], 
‹am
);

207 *
Ãw_‹am
 = 
‹am
;

208  
¡©us
;

210 
”r_ùx_®loc
:

211 *
Ãw_‹am
 = 
NULL
;

212 
	`ucc_ä“
(
‹am
);

213  
¡©us
;

214 
	}
}

216 
ucc_¡©us_t
 
	$ucc_‹am_ü—‹_£rviû_‹am
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
,

217 
ucc_‹am_t
 *
‹am
)

219 
ucc_¡©us_t
 
¡©us
;

220 ià(
cÚ‹xt
->
£rviû_‹am
) {

223  
UCC_OK
;

225 ià(!
‹am
->
£rviû_‹am
) {

226 
ucc_ba£_‹am_·¿ms_t
 
b_·¿ms
;

227 
ucc_ba£_‹am_t
 * 
b_‹am
;

228 
¡©us
 = 
	`ucc__cÚ‹xt_g‘
(
cÚ‹xt
, "uı", &cÚ‹xt->
£rviû_ùx
);

229 ià(
UCC_OK
 !ğ
¡©us
) {

230 
	`ucc_w¬n
("TL UCP context is‚ot‡vailable, "

232  
¡©us
;

234 
	`memıy
(&
b_·¿ms
, &
‹am
->
bp
, (
ucc_ba£_‹am_·¿ms_t
));

235 
b_·¿ms
.
scİe
 =

236 
UCC_CL_LAST
 + 1;

237 
b_·¿ms
.
scİe_id
 = 0;

238 
b_·¿ms
.
id
 = 0;

239 
b_·¿ms
.
‹am
 =eam;

240 
b_·¿ms
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

241 
¡©us
 = 
	`UCC_TL_CTX_IFACE
(
cÚ‹xt
->
£rviû_ùx
)

242 ->
‹am
.
	`ü—‹_po¡
(&
cÚ‹xt
->
£rviû_ùx
->
su³r
, &
b_·¿ms
,

243 &
b_‹am
);

244 ià(
UCC_OK
 !ğ
¡©us
) {

245 
	`ucc_”rÜ
("tl ucp serviceeam create…ost failed");

246  
¡©us
;

248 
‹am
->
£rviû_‹am
 = 
	`ucc_d”ived_of
(
b_‹am
, 
ucc__‹am_t
);

250 
¡©us
 = 
	`UCC_TL_CTX_IFACE
(
cÚ‹xt
->
£rviû_ùx
)

251 ->
‹am
.
	`ü—‹_‹¡
(&‹am->
£rviû_‹am
->
su³r
);

252 ià(
¡©us
 < 0) {

253 
‹am
->
£rviû_‹am
 = 
NULL
;

254 
	`ucc_”rÜ
("failedo create servicel ucpeam");

256  
¡©us
;

257 
	}
}

259 
ucc_¡©us_t
 
	$ucc_‹am_ü—‹_şs
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
,

260 
ucc_‹am_t
 *
‹am
)

262 
ucc_ş_içû_t
 *
ş_içû
;

263 
ucc_ba£_‹am_t
 *
b_‹am
;

264 
ucc_¡©us_t
 
¡©us
;

265 
ucc_sub£t_t
 
sub£t
;

266 
i
;

268 ià(
cÚ‹xt
->
tİo
 && !
‹am
->tİØ&&—m->
size
 > 1) {

271 
sub£t
.
m­
 = 
‹am
->
ùx_m­
;

272 
sub£t
.
my¿nk
 = 
‹am
->
¿nk
;

273 
¡©us
 = 
	`ucc_tİo_š™
(
sub£t
, 
cÚ‹xt
->
tİo
, &
‹am
->topo);

274 ià(
UCC_OK
 !ğ
¡©us
) {

275 
	`ucc_w¬n
("failedo initeamopo");

279 ià(
‹am
->
Ï¡_‹am_ü—‹_po¡ed
 >= 0) {

280 
ş_içû
 = 
	`UCC_CL_CTX_IFACE
(
cÚ‹xt
->
ş_ùx
[
‹am
->
Ï¡_‹am_ü—‹_po¡ed
]);

281 
b_‹am
 = &
‹am
->
ş_‹ams
[‹am->
Ï¡_‹am_ü—‹_po¡ed
]->
su³r
;

282 
¡©us
 = 
ş_içû
->
‹am
.
	`ü—‹_‹¡
(
b_‹am
);

283 ià(
¡©us
 < 0) {

284 
‹am
->
n_ş_‹ams
--;

285 
	`ucc_debug
("çedØü—‹ CL % ‹am", 
ş_içû
->
su³r
.
Çme
);

286 
ş_içû
->
‹am
.
	`de¡roy
(
b_‹am
);

287 } ià(
¡©us
 =ğ
UCC_INPROGRESS
) {

288  
¡©us
;

292 
i
 = 
‹am
->
Ï¡_‹am_ü—‹_po¡ed
 + 1; i < 
cÚ‹xt
->
n_ş_ùx
; i++) {

293 
ş_içû
 = 
	`UCC_CL_CTX_IFACE
(
cÚ‹xt
->
ş_ùx
[
i
]);

294 
¡©us
 = 
ş_içû
->
‹am
.
	`ü—‹_po¡
(&
cÚ‹xt
->
ş_ùx
[
i
]->
su³r
,

295 &
‹am
->
bp
, &
b_‹am
);

296 ià(
¡©us
 !ğ
UCC_OK
) {

297 
	`ucc_debug
("çedØü—‹ CL % ‹am", 
ş_içû
->
su³r
.
Çme
);

300 
¡©us
 = 
ş_içû
->
‹am
.
	`ü—‹_‹¡
(
b_‹am
);

301 ià(
¡©us
 < 0) {

302 
	`ucc_debug
("çedØü—‹ CL % ‹am", 
ş_içû
->
su³r
.
Çme
);

303 
ş_içû
->
‹am
.
	`de¡roy
(
b_‹am
);

306 
‹am
->
ş_‹ams
[‹am->
n_ş_‹ams
++] =

307 
	`ucc_d”ived_of
(
b_‹am
, 
ucc_ş_‹am_t
);

308 ià(
¡©us
 =ğ
UCC_INPROGRESS
) {

309 
‹am
->
Ï¡_‹am_ü—‹_po¡ed
 = 
i
;

312  
UCC_INPROGRESS
;

315 ià(0 =ğ
‹am
->
n_ş_‹ams
) {

316 
	`ucc_”rÜ
("no CLeams were created");

317  
UCC_ERR_NO_MESSAGE
;

319  
UCC_OK
;

320 
	}
}

322 
šlše
 
ucc_¡©us_t
 
	$ucc_‹am_exchªge
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
,

323 
ucc_‹am_t
 * 
‹am
)

325 
ucc_‹am_oob_cŞl_t
 
oob
 = 
‹am
->
ruÁime_oob
;

326 
ucc_¡©us_t
 
¡©us
;

328 ià(!
cÚ‹xt
->
addr_¡Üage
.
¡Üage
) {

332  
	`ucc_cÜe_addr_exchªge
(
cÚ‹xt
, &
oob
, &
‹am
->
addr_¡Üage
);

335 
	`ucc_as£¹
(
cÚ‹xt
->
addr_¡Üage
.
¡Üage
 !ğ
NULL
);

336 ià(
‹am
->
bp
.
·¿ms
.
mask
 & 
UCC_TEAM_PARAM_FIELD_EP_MAP
) {

337 
‹am
->
ùx_m­
 =—m->
bp
.
·¿ms
.
•_m­
;

339 ià(!
‹am
->
ùx_¿nks
) {

340 
‹am
->
ùx_¿nks
 =

341 
	`ucc_m®loc
(
‹am
->
size
 * (
ucc_¿nk_t
), "ctx_ranks");

342 ià(!
‹am
->
ùx_¿nks
) {

343 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ctx„anks‡rray",

344 
‹am
->
size
 * (
ucc_¿nk_t
));

345  
UCC_ERR_NO_MEMORY
;

347 
¡©us
 = 
oob
.
	`®lg©h”
(&
cÚ‹xt
->
¿nk
, 
‹am
->
ùx_¿nks
,

348 (
ucc_¿nk_t
), 
oob
.
cŞl_šfo
,

349 &
‹am
->
oob_»q
);

350 ià(
UCC_OK
 !ğ
¡©us
) {

351 
	`ucc_”rÜ
("failedo start oob‡llgather for…roc infoƒxchange");

352 
	`ucc_ä“
(
‹am
->
ùx_¿nks
);

353  
¡©us
;

356 
¡©us
 = 
oob
.
	`»q_‹¡
(
‹am
->
oob_»q
);

357 ià(
¡©us
 < 0) {

358 
oob
.
	`»q_ä“
(
‹am
->
oob_»q
);

359 
	`ucc_”rÜ
("oob„eqest failed duringeam…roc infoƒxchange");

360  
¡©us
;

361 } ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

362  
¡©us
;

364 
oob
.
	`»q_ä“
(
‹am
->
oob_»q
);

365 
	`ucc_as£¹
(
‹am
->
size
 >= 2);

366 
‹am
->
ùx_m­
 = 
	`ucc_•_m­_äom_¬¿y
(&‹am->
ùx_¿nks
,—m->
size
,

367 
cÚ‹xt
->
addr_¡Üage
.
size
, 1);

369 
	`ucc_debug
("‹am %°¿nk %d, ctx_¿nk %d, m­_ty³ %d", 
‹am
,—m->
¿nk
,

370 
cÚ‹xt
->
¿nk
, 
‹am
->
ùx_m­
.
ty³
);

371  
UCC_OK
;

372 
	}
}

374 
ucc_¡©us_t
 
	$ucc_‹am_bud_scÜe_m­
(
ucc_‹am_t
 *
‹am
)

376 
ucc_cŞl_scÜe_t
 *
scÜe
, *
scÜe_m”ge
, *
scÜe_Ãxt
;

377 
ucc_¡©us_t
 
¡©us
;

378 
i
;

380 
	`ucc_as£¹
(
‹am
->
n_ş_‹ams
 > 0);

381 
¡©us
 = 
	`UCC_CL_TEAM_IFACE
(
‹am
->
ş_‹ams
[0])

382 ->
‹am
.
	`g‘_scÜes
(&‹am->
ş_‹ams
[0]->
su³r
, &
scÜe
);

383 ià(
UCC_OK
 !ğ
¡©us
) {

384 
	`ucc_”rÜ
("failedo get cl %s scores",

385 
	`UCC_CL_TEAM_IFACE
(
‹am
->
ş_‹ams
[0])->
su³r
.
Çme
);

386  
¡©us
;

388 
i
 = 1; i < 
‹am
->
n_ş_‹ams
; i++) {

389 
¡©us
 = 
	`UCC_CL_TEAM_IFACE
(
‹am
->
ş_‹ams
[
i
])

390 ->
‹am
.
	`g‘_scÜes
(&‹am->
ş_‹ams
[
i
]->
su³r
, &
scÜe_Ãxt
);

391 ià(
UCC_OK
 !ğ
¡©us
) {

392 
	`ucc_”rÜ
("failedo get cl %s scores",

393 
	`UCC_CL_TEAM_IFACE
(
‹am
->
ş_‹ams
[
i
])->
su³r
.
Çme
);

394 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

395  
¡©us
;

397 
¡©us
 = 
	`ucc_cŞl_scÜe_m”ge
(
scÜe
, 
scÜe_Ãxt
, &
scÜe_m”ge
, 1);

398 ià(
UCC_OK
 !ğ
¡©us
) {

399 
	`ucc_”rÜ
("failedo merge scores");

400 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

401 
	`ucc_cŞl_scÜe_ä“
(
scÜe_Ãxt
);

402  
¡©us
;

404 
scÜe
 = 
scÜe_m”ge
;

406 
¡©us
 = 
	`ucc_cŞl_scÜe_bud_m­
(
scÜe
, &
‹am
->
scÜe_m­
);

407 ià(
UCC_OK
 !ğ
¡©us
) {

408 
	`ucc_”rÜ
("failedo build score map");

410  
¡©us
;

411 
	}
}

413 
ucc_¡©us_t
 
	$ucc_‹am_ü—‹_‹¡_sšgË
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
,

414 
ucc_‹am_t
 *
‹am
)

416 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

418 
‹am
->
¡©e
) {

419 
UCC_TEAM_ADDR_EXCHANGE
:

420 
¡©us
 = 
	`ucc_‹am_exchªge
(
cÚ‹xt
, 
‹am
);

421 ià(
UCC_OK
 !ğ
¡©us
) {

422 
out
;

424 
‹am
->
¡©e
 = 
UCC_TEAM_SERVICE_TEAM
;

426 
UCC_TEAM_SERVICE_TEAM
:

427 ià((
cÚ‹xt
->
ş_æags
 & 
UCC_BASE_LIB_FLAG_SERVICE_TEAM_REQUIRED
) ||

428 ((
cÚ‹xt
->
ş_æags
 & 
UCC_BASE_LIB_FLAG_TEAM_ID_REQUIRED
) &&

429 (
‹am
->
id
 == 0))) {

434 
¡©us
 = 
	`ucc_‹am_ü—‹_£rviû_‹am
(
cÚ‹xt
, 
‹am
);

435 ià(
UCC_OK
 !ğ
¡©us
) {

436 
out
;

439 
‹am
->
¡©e
 = 
UCC_TEAM_ALLOC_ID
;

441 
UCC_TEAM_ALLOC_ID
:

442 ià(
cÚ‹xt
->
ş_æags
 & 
UCC_BASE_LIB_FLAG_TEAM_ID_REQUIRED
) {

443 
¡©us
 = 
	`ucc_‹am_®loc_id
(
‹am
);

444 ià(
UCC_OK
 !ğ
¡©us
) {

445 
out
;

448 
‹am
->
bp
.
id
 =eam->id;

449 
‹am
->
¡©e
 = 
UCC_TEAM_CL_CREATE
;

450 ià(
‹am
->
£rviû_‹am
) {

452 
	`UCC_TL_TEAM_IFACE
(
‹am
->
£rviû_‹am
)->
scŞl
.
upd©e_id


453 (&
‹am
->
£rviû_‹am
->
su³r
,—m->
id
);

456 
UCC_TEAM_CL_CREATE
:

457 
¡©us
 = 
	`ucc_‹am_ü—‹_şs
(
cÚ‹xt
, 
‹am
);

459 
UCC_TEAM_ACTIVE
:

460  
UCC_OK
;

462 
out
:

463 ià(
UCC_OK
 =ğ
¡©us
) {

464 
‹am
->
¡©e
 = 
UCC_TEAM_ACTIVE
;

465 
¡©us
 = 
	`ucc_‹am_bud_scÜe_m­
(
‹am
);

468 ià(
UCC_OK
 =ğ
¡©us
 &&

469 
ucc_glob®_cÚfig
.
log_compÚ’t
.
log_Ëv–
 >ğ
UCC_LOG_LEVEL_INFO
 &&

470 
‹am
->
¿nk
 == 0) {

471 
	`ucc_šfo
("===== COLL_SCORE_MAP (team_id %d, size %u) =====",

472 
‹am
->
id
,—m->
size
);

473 
	`ucc_cŞl_scÜe_m­_´št_šfo
(
‹am
->
scÜe_m­
,

474 
ucc_glob®_cÚfig
.
log_compÚ’t
.
log_Ëv–
);

475 
	`ucc_šfo
("================================================");

479  
¡©us
;

480 
	}
}

482 
ucc_¡©us_t
 
	$ucc_‹am_ü—‹_‹¡
(
ucc_‹am_h
 
‹am
)

484 ià(
NULL
 =ğ
‹am
) {

485 
	`ucc_”rÜ
("ucc_team_create_test: invalideam handle: NULL");

486  
UCC_ERR_INVALID_PARAM
;

489 
	`ucc_as£¹
(
‹am
->
num_cÚ‹xts
 == 1);

490 ià(
‹am
->
¡©e
 =ğ
UCC_TEAM_ACTIVE
) {

491  
UCC_OK
;

493  
	`ucc_‹am_ü—‹_‹¡_sšgË
(
‹am
->
cÚ‹xts
[0],eam);

494 
	}
}

496 
ucc_¡©us_t
 
	$ucc_‹am_de¡roy_sšgË
(
ucc_‹am_h
 
‹am
)

498 
ucc_ş_içû_t
 *
ş_içû
;

499 
i
;

500 
ucc_¡©us_t
 
¡©us
;

502 ià(
‹am
->
£rviû_‹am
) {

503 ià(
UCC_OK
 !ğ(
¡©us
 = 
	`UCC_TL_CTX_IFACE
(
‹am
->
cÚ‹xts
[0]->
£rviû_ùx
)

504 ->
‹am
.
	`de¡roy
(&‹am->
£rviû_‹am
->
su³r
))) {

505  
¡©us
;

507 
‹am
->
£rviû_‹am
 = 
NULL
;

508 
	`ucc__cÚ‹xt_put
(
‹am
->
cÚ‹xts
[0]->
£rviû_ùx
);

510 
i
 = 0; i < 
‹am
->
n_ş_‹ams
; i++) {

511 ià(!
‹am
->
ş_‹ams
[
i
])

513 
ş_içû
 = 
	`UCC_CL_TEAM_IFACE
(
‹am
->
ş_‹ams
[
i
]);

514 ià(
UCC_OK
 !=

515 (
¡©us
 = 
ş_içû
->
‹am
.
	`de¡roy
(&‹am->
ş_‹ams
[
i
]->
su³r
))) {

516  
¡©us
;

518 
‹am
->
ş_‹ams
[
i
] = 
NULL
;

521 
	`ucc_tİo_ş—nup
(
‹am
->
tİo
);

523 ià(
‹am
->
cÚ‹xts
[0]->
£rviû_‹am
 &&—m->
size
 > 1) {

524 
	`ucc_š‹º®_oob_fš®ize
(&
‹am
->
bp
.
·¿ms
.
oob
);

527 ià((
ucc_glob®_cÚfig
.
log_compÚ’t
.
log_Ëv–
 >ğ
UCC_LOG_LEVEL_INFO
) &&

528 (
‹am
->
¿nk
 == 0)) {

529 
	`ucc_šfo
("‹am de¡royed,—m_id %d", 
‹am
->
id
);

532 
	`ucc_cŞl_scÜe_ä“_m­
(
‹am
->
scÜe_m­
);

533 
	`ucc_ä“
(
‹am
->
addr_¡Üage
.
¡Üage
);

534 
	`ucc_ä“
(
‹am
->
ùx_¿nks
);

535 
	`ucc_‹am_»Ëa£_id
(
‹am
);

536 
	`ucc_ä“
(
‹am
->
ş_‹ams
);

537 
	`ucc_ä“
(
‹am
->
cÚ‹xts
);

538 
	`ucc_ä“
(
‹am
);

539  
UCC_OK
;

540 
	}
}

542 
ucc_¡©us_t
 
	$ucc_‹am_de¡roy
(
ucc_‹am_h
 
‹am
)

544 ià(
NULL
 =ğ
‹am
) {

545 
	`ucc_”rÜ
("ucc_team_destroy: invalideam handle: NULL");

546  
UCC_ERR_INVALID_PARAM
;

549 ià(
‹am
->
¡©e
 !ğ
UCC_TEAM_ACTIVE
) {

550 
	`ucc_”rÜ
("‹am %°i u£d befÜ‹am_ü—‹ i com¶‘ed", 
‹am
);

551  
UCC_ERR_INVALID_PARAM
;

555 
	`ucc_as£¹
(
‹am
->
num_cÚ‹xts
 == 1);

556  
	`ucc_‹am_de¡roy_sšgË
(
‹am
);

557 
	}
}

559 
šlše
 

560 
	$fšd_fœ¡_£t_ªd_z”o
(
ušt64_t
 *
v®ue
) {

561 
i
;

562 
i
=0; i<64; i++) {

563 ià(*
v®ue
 & ((
ušt64_t
)1 << 
i
)) {

564 *
v®ue
 &ğ~((
ušt64_t
)1 << 
i
);

565  
i
+1;

569 
	}
}

571 
šlše
 

572 
	$£t_id_b™
(
ušt64_t
 *
loÿl
, 
id
) {

573 
m­_pos
 = 
id
 / 64;

574 
pos
 = (
id
-1) % 64;

575 
	`ucc_as£¹
(
id
 >= 1);

576 
loÿl
[
m­_pos
] |ğ((
ušt64_t
)1 << 
pos
);

577 
	}
}

579 
ucc_¡©us_t
 
	$ucc_‹am_®loc_id
(
ucc_‹am_t
 *
‹am
)

582 
ucc_cÚ‹xt_t
 *
ùx
 = 
‹am
->
cÚ‹xts
[0];

583 
ušt64_t
 *
loÿl
, *
glob®
;

584 
ucc_¡©us_t
 
¡©us
;

585 
pos
, 
i
;

587 ià(
‹am
->
id
 > 0) {

588 
	`ucc_as£¹
(
	`UCC_TEAM_ID_IS_EXTERNAL
(
‹am
));

589  
UCC_OK
;

592 ià(!
ùx
->
ids
.
poŞ
) {

593 
ùx
->
ids
.
poŞ
 = 
	`ucc_m®loc
(ùx->ids.
poŞ_size
*2*(
ušt64_t
), "ids_pool");

594 ià(!
ùx
->
ids
.
poŞ
) {

595 
	`ucc_”rÜ
("failedo‡llocate %zd bytes foream_ids_pool",

596 
ùx
->
ids
.
poŞ_size
*2*(
ušt64_t
));

597  
UCC_ERR_NO_MEMORY
;

600 
	`mem£t
(
ùx
->
ids
.
poŞ
, 255, ctx->ids.
poŞ_size
*2*(
ušt64_t
));

602 
loÿl
 = 
ùx
->
ids
.
poŞ
;

603 
glob®
 = 
ùx
->
ids
.
poŞ
 + ctx->ids.
poŞ_size
;

605 ià(!
‹am
->
¤eq
) {

606 
ucc_sub£t_t
 
sub£t
 = {.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
,

607 .
m­
.
•_num
 = 
‹am
->
size
,

608 .
my¿nk
 = 
‹am
->
¿nk
};

609 
¡©us
 = 
	`ucc_£rviû_®Ìeduû
(
‹am
, 
loÿl
, 
glob®
, 
UCC_DT_UINT64
,

610 
ùx
->
ids
.
poŞ_size
,

611 
UCC_OP_BAND
, 
sub£t
,

612 &
‹am
->
¤eq
);

613 ià(
¡©us
 < 0) {

614  
¡©us
;

617 
	`ucc_cÚ‹xt_´og»ss
(
ùx
);

618 
¡©us
 = 
	`ucc_£rviû_cŞl_‹¡
(
‹am
->
¤eq
);

619 ià(
¡©us
 < 0) {

620 
	`ucc_”rÜ
("service‡llreduceest failure: %s",

621 
	`ucc_¡©us_¡ršg
(
¡©us
));

622  
¡©us
;

623 } ià(
¡©us
 !ğ
UCC_OK
) {

624  
¡©us
;

626 
	`ucc_£rviû_cŞl_fš®ize
(
‹am
->
¤eq
);

627 
‹am
->
¤eq
 = 
NULL
;

628 
	`memıy
(
loÿl
, 
glob®
, 
ùx
->
ids
.
poŞ_size
*(
ušt64_t
));

629 
pos
 = 0;

630 
i
=0; i<
ùx
->
ids
.
poŞ_size
; i++) {

631 ià((
pos
 = 
	`fšd_fœ¡_£t_ªd_z”o
(&
loÿl
[
i
])) > 0) {

635 ià(
pos
 > 0) {

636 
	`ucc_as£¹
(
pos
 <= 64);

637 
‹am
->
id
 = (
ušt16_t
)(
i
*64+
pos
);

638 
	`ucc_debug
("®loÿ‹d ID %d fÜ—m %p", 
‹am
->
id
,eam);

640 
	`ucc_w¬n
("could‚ot‡llocateeam id, whole id space is occupied, "

642  
UCC_ERR_NO_RESOURCE
;

644 
	`ucc_as£¹
(
‹am
->
id
 > 0);

645  
UCC_OK
;

646 
	}
}

648 
	$ucc_‹am_»Ëa£_id
(
ucc_‹am_t
 *
‹am
)

650 
ucc_cÚ‹xt_t
 *
ùx
 = 
‹am
->
cÚ‹xts
[0];

652 ià(0 !ğ
‹am
->
id
 && !
	`UCC_TEAM_ID_IS_EXTERNAL
(team)) {

653 
	`£t_id_b™
(
ùx
->
ids
.
poŞ
, 
‹am
->
id
);

655 
	}
}

	@src/core/ucc_team.h

7 #iâdeà
UCC_TEAM_H_


8 
	#UCC_TEAM_H_


	)

10 
	~"ucc/­i/ucc.h
"

11 
	~"uts/ucc_d©a¡ruù.h
"

12 
	~"uts/ucc_cŞl_uts.h
"

13 
	~"ucc_cÚ‹xt.h
"

14 
	~"uts/ucc_m©h.h
"

15 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

16 
	~"compÚ’ts/ş/ucc_ş.h
"

17 
	~"compÚ’ts//ucc_.h
"

18 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

20 
ucc_£rviû_cŞl_»q
 
	tucc_£rviû_cŞl_»q_t
;

22 
	mUCC_TEAM_ADDR_EXCHANGE
,

23 
	mUCC_TEAM_SERVICE_TEAM
,

24 
	mUCC_TEAM_ALLOC_ID
,

25 
	mUCC_TEAM_CL_CREATE
,

26 
	mUCC_TEAM_ACTIVE
,

27 } 
	tucc_‹am_¡©e_t
;

29 
	succ_‹am
 {

30 
ucc_‹am_¡©e_t
 
	m¡©e
;

31 
ucc_cÚ‹xt_t
 ** 
	mcÚ‹xts
;

32 
ušt32_t
 
	mnum_cÚ‹xts
;

33 
ucc_ba£_‹am_·¿ms_t
 
	mbp
;

34 
ucc_‹am_oob_cŞl_t
 
	mruÁime_oob
;

35 
ucc_ş_‹am_t
 ** 
	mş_‹ams
;

36 
	mn_ş_‹ams
;

37 
	mÏ¡_‹am_ü—‹_po¡ed
;

38 
ušt16_t
 
	mid
;

39 
ucc_¿nk_t
 
	m¿nk
;

40 
ucc_¿nk_t
 
	msize
;

41 
ucc__‹am_t
 * 
	m£rviû_‹am
;

42 
ucc_£rviû_cŞl_»q_t
 *
	m¤eq
;

43 
ucc_addr_¡Üage_t
 
	maddr_¡Üage
;

44 
ucc_¿nk_t
 * 
	mùx_¿nks
;

45 * 
	moob_»q
;

46 
ucc_•_m­_t
 
	mùx_m­
;

48 
ucc_tİo_t
 *
	mtİo
;

49 
ucc_scÜe_m­_t
 *
	mscÜe_m­
;

50 
ušt32_t
 
	m£q_num
;

51 } 
	tucc_‹am_t
;

54 
	#UCC_TEAM_ID_EXTERNAL_BIT
 ((
ušt16_t
)
	`UCC_BIT
(15))

	)

55 
	#UCC_TEAM_ID_IS_EXTERNAL
(
_‹am
è(
‹am
->
id
 & 
UCC_TEAM_ID_EXTERNAL_BIT
)

	)

56 
	#UCC_TEAM_ID_MAX
 ((
ušt16_t
)
	`UCC_BIT
(15è- 1)

	)

58 
ucc_cİy_‹am_·¿ms
(
ucc_‹am_·¿ms_t
 *
d¡
, cÚ¡ ucc_‹am_·¿ms_ˆ*
¤c
);

67 
šlše
 
ucc_cÚ‹xt_addr_h—d”_t
 *

68 
	$ucc_g‘_‹am_•_h—d”
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
, 
ucc_‹am_t
 *
‹am
,

69 
ucc_¿nk_t
 
¿nk
)

71 
ucc_addr_¡Üage_t
 *
¡Üage
 = 
cÚ‹xt
->
addr_¡Üage
.storage

72 ? &
cÚ‹xt
->
addr_¡Üage


73 : &
‹am
->
addr_¡Üage
;

74 
ucc_¿nk_t
 
¡Üage_¿nk
 =

75 
cÚ‹xt
->
addr_¡Üage
.
¡Üage


76 ? (
‹am
 ? 
	`ucc_•_m­_ev®
Ñ—m->
ùx_m­
, 
¿nk
) :„ank)

77 : 
¿nk
;

79  
	`UCC_ADDR_STORAGE_RANK_HEADER
(
¡Üage
, 
¡Üage_¿nk
);

80 
	}
}

85 
šlše
 *
	$ucc_g‘_‹am_•_addr
(
ucc_cÚ‹xt_t
 *
cÚ‹xt
,

86 
ucc_‹am_t
 *
‹am
, 
ucc_¿nk_t
 
¿nk
,

87 
compÚ’t_id
)

89 
ucc_cÚ‹xt_addr_h—d”_t
 *
h
 = 
	`ucc_g‘_‹am_•_h—d”
(
cÚ‹xt
, 
‹am
,

90 
¿nk
);

91 *
addr
 = 
NULL
;

92 
i
;

93 
i
 = 0; i < 
h
->
n_compÚ’ts
; i++) {

94 ià(
h
->
compÚ’ts
[
i
].
id
 =ğ
compÚ’t_id
) {

95 
addr
 = 
	`PTR_OFFSET
(
h
, h->
compÚ’ts
[
i
].
off£t
);

99 
	`ucc_as£¹
(
NULL
 !ğ
addr
);

100  
addr
;

101 
	}
}

103 
šlše
 
ucc_¿nk_t
 
	$ucc_g‘_ùx_¿nk
(
ucc_‹am_t
 *
‹am
, 
ucc_¿nk_t
 
‹am_¿nk
)

105  
	`ucc_•_m­_ev®
(
‹am
->
ùx_m­
, 
‹am_¿nk
);

106 
	}
}

108 
šlše
 
ucc_ho¡_id_t
 
	$ucc_‹am_¿nk_ho¡_id
(
ucc_¿nk_t
 
¿nk
, 
ucc_‹am_t
 *
‹am
)

110  
‹am
->
tİo
->tİo->
´ocs
[
	`ucc_g‘_ùx_¿nk
Ñ—m, 
¿nk
)].
ho¡_id
;

111 
	}
}

113 
šlše
 
	$ucc_‹am_¿nks_Ú_§me_node
(
ucc_¿nk_t
 
¿nk1
, ucc_¿nk_ˆ
¿nk2
,

114 
ucc_‹am_t
 *
‹am
)

116 
ucc_cÚ‹xt_addr_h—d”_t
 *
h1
 = 
	`ucc_g‘_‹am_•_h—d”
(
‹am
->
cÚ‹xts
[0],

117 
‹am
, 
¿nk1
);

118 
ucc_cÚ‹xt_addr_h—d”_t
 *
h2
 = 
	`ucc_g‘_‹am_•_h—d”
(
‹am
->
cÚ‹xts
[0],

119 
‹am
, 
¿nk2
);

121  
h1
->
ùx_id
.
pi
.
ho¡_hash
 =ğ
h2
->ctx_id.pi.host_hash;

122 
	}
}

124 
šlše
 
	$ucc_‹am_m­_is_sšgË_node
(
ucc_‹am_t
 *
‹am
,

125 
ucc_•_m­_t
 
m­
)

127 
ušt64_t
 
i
;

128 
ucc_¿nk_t
 
r
, 
r0
;

130 
r0
 = 
	`ucc_•_m­_ev®
(
m­
, 0);

131 
i
 = 1; i < 
m­
.
•_num
; i++) {

132 
r
 = 
	`ucc_•_m­_ev®
(
m­
, 
i
);

133 ià(!
	`ucc_‹am_¿nks_Ú_§me_node
(
r0
, 
r
, 
‹am
)) {

138 
	}
}

	@src/schedule/ucc_schedule.c

5 
	~"ucc_scheduË.h
"

6 
	~"uts/ucc_comp”_def.h
"

7 
	~"uts/ucc_mpoŞ.h
"

8 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

9 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

10 
	~"cÜe/ucc_cÚ‹xt.h
"

12 
	$ucc_cŞl_sk_mpoŞ_obj_š™
(
ucc_mpoŞ_t
 *
mp
, *
obj
,

13 *
chunk
)

15 
ucc_cŞl_sk_t
 *
sk
 = 
obj
;

17 
	`ucc_cŞl_sk_cÚ¡ruù
(
sk
);

18 
	}
}

20 
	$ucc_cŞl_sk_mpoŞ_obj_ş—nup
(
ucc_mpoŞ_t
 *
mp
, *
obj
)

22 
ucc_cŞl_sk_t
 *
sk
 = 
obj
;

24 
	`ucc_cŞl_sk_de¡ruù
(
sk
);

25 
	}
}

27 
ucc_mpoŞ_İs
 
	gucc_cŞl_sk_mpoŞ_İs
 = {

28 .
chunk_®loc
 = 
ucc_mpoŞ_hug‘lb_m®loc
,

29 .
	gchunk_»Ëa£
 = 
ucc_mpoŞ_hug‘lb_ä“
,

30 .
	gobj_š™
 = 
ucc_cŞl_sk_mpoŞ_obj_š™
,

31 .
	gobj_ş—nup
 = 
ucc_cŞl_sk_mpoŞ_obj_ş—nup


34 
ucc_¡©us_t
 
	$ucc_ev’t_mªag”_š™
(
ucc_cŞl_sk_t
 *
sk
)

36 
ucc_ev’t_mªag”_t
 *
em
;

38 
	`ucc_li¡_fÜ_—ch
(
em
, &
sk
->
em_li¡
, 
li¡_–em
) {

39 
em
->
n_li¡’”s
 = 0;

41  
UCC_OK
;

42 
	}
}

44 
ucc_¡©us_t
 
	$ucc_ev’t_mªag”_subsüibe
(
ucc_cŞl_sk_t
 *
·»Á_sk
,

45 
ucc_ev’t_t
 
ev’t
, 
ucc_cŞl_sk_t
 *
sk
,

46 
ucc_sk_ev’t_hªdËr_p
 
hªdËr
)

48 
ucc_ev’t_mªag”_t
 *
em
;

50 
	`ucc_li¡_fÜ_—ch
(
em
, &
·»Á_sk
->
em_li¡
, 
li¡_–em
) {

51 ià(
em
->
n_li¡’”s
 < 
MAX_LISTENERS
) {

52 
£t
:

53 
em
->
li¡’”s
[em->
n_li¡’”s
].
sk
 =ask;

54 
em
->
li¡’”s
[em->
n_li¡’”s
].
ev’t
 =ƒvent;

55 
em
->
li¡’”s
[em->
n_li¡’”s
].
hªdËr
 = handler;

56 
em
->
n_li¡’”s
++;

57  
UCC_OK
;

60 
em
 = 
	`ucc_m®loc
((*em), "em");

61 ià(
	`ucc_uÆik–y
(!
em
)) {

62 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜƒv’t_mªag”", (*
em
));

63  
UCC_ERR_NO_MEMORY
;

65 
em
->
n_li¡’”s
 = 0;

66 
	`ucc_li¡_add_
(&
·»Á_sk
->
em_li¡
, &
em
->
li¡_–em
);

67 
£t
;

68 
	}
}

70 
	$ucc_cŞl_sk_cÚ¡ruù
(
ucc_cŞl_sk_t
 *
sk
)

72 
	`ucc_li¡_h—d_š™
(&
sk
->
em_li¡
);

73 
	}
}

75 
	$ucc_cŞl_sk_de¡ruù
(
ucc_cŞl_sk_t
 *
sk
)

77 
ucc_ev’t_mªag”_t
 *
em
, *
m
;

79 
	`ucc_li¡_fÜ_—ch_§ã
(
em
, 
m
, &
sk
->
em_li¡
, 
li¡_–em
) {

80 
	`ucc_li¡_d–
(&
em
->
li¡_–em
);

81 
	`ä“
(
em
);

83 
	}
}

85 
ucc_¡©us_t
 
	$ucc_dummy_po¡
(
ucc_cŞl_sk_t
 *
sk
)

87 
sk
->
¡©us
 = 
UCC_OK
;

88  
	`ucc_sk_com¶‘e
(
sk
);

89 
	}
}

91 
ucc_¡©us_t
 
	$ucc_dummy_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

93 
	`ucc_mpoŞ_put
(
sk
);

94  
UCC_OK
;

95 
	}
}

98 
	$ucc_dummy_´og»ss
(
ucc_cŞl_sk_t
 *
sk
)

101 
	`ucc_as£¹_®ways
(0);

102 
	}
}

104 
ucc_¡©us_t
 
	$ucc_cŞl_sk_š™
(
ucc_cŞl_sk_t
 *
sk
,

105 
ucc_ba£_cŞl_¬gs_t
 *
b¬gs
,

106 
ucc_ba£_‹am_t
 *
‹am
)

108 
sk
->
æags
 = 0;

109 
sk
->
“
 = 
NULL
;

110 
sk
->
‹am
 =eam;

111 
sk
->
n_d•s
 = 0;

112 
sk
->
n_d•s_§tisf›d
 = 0;

113 
sk
->
b¬gs
.
¬gs
.
mask
 = 0;

114 
sk
->
scheduË
 = 
NULL
;

115 
sk
->
executÜ
 = 
NULL
;

116 
sk
->
su³r
.
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

117 
sk
->
Œigg”ed_po¡_£tup
 = 
NULL
;

118 
sk
->
Œigg”ed_po¡
 = 
ucc_Œigg”ed_po¡
;

119 
sk
->
po¡
 = 
ucc_dummy_po¡
;

120 
sk
->
fš®ize
 = 
ucc_dummy_fš®ize
;

121 
sk
->
´og»ss
 = 
ucc_dummy_´og»ss
;

124 
sk
->
b¬gs
.
asymm‘ric_§ve_šfo
.
sü©ch
 = 
NULL
;

126 ià(
b¬gs
) {

127 
	`memıy
(&
sk
->
b¬gs
, bargs, (*bargs));

129 
	`ucc_lf_queue_š™_–em
(&
sk
->
lf_–em
);

130  
	`ucc_ev’t_mªag”_š™
(
sk
);

131 
	}
}

133 
ucc_¡©us_t
 
	$ucc_cŞl_sk_g‘_executÜ
(
ucc_cŞl_sk_t
 *
sk
,

134 
ucc_“_executÜ_t
 **
exec
)

136 
ucc_¡©us_t
 
¡
 = 
UCC_OK
;

138 ià(
sk
->
executÜ
 =ğ
NULL
) {

139 ià(
	`ucc_uÆik–y
(!
sk
->
scheduË
)) {

140 
	`ucc_”rÜ
("executor wasn't initialized forhe collective");

141  
UCC_ERR_INVALID_PARAM
;

143 
¡
 = 
	`ucc_cŞl_sk_g‘_executÜ
(&
sk
->
scheduË
->
su³r
,

144 &
sk
->
executÜ
);

147 *
exec
 = 
sk
->
executÜ
;

148  
¡
;

149 
	}
}

151 
ucc_¡©us_t
 
	$ucc_sk_”rÜ_hªdËr
(
ucc_cŞl_sk_t
 *
·»Á_sk
,

152 
ucc_cŞl_sk_t
 *
sk
)

154 
ucc_ev’t_mªag”_t
 *
em
;

155 
ucc_cŞl_sk_t
 *
li¡’”
;

156 
i
;

158 
sk
->
su³r
.
¡©us
 = 
·»Á_sk
->super.status;

160 
	`ucc_li¡_fÜ_—ch
(
em
, &
·»Á_sk
->
em_li¡
, 
li¡_–em
) {

161 
i
 = 0; i < 
em
->
n_li¡’”s
; i++) {

162 
li¡’”
 = 
em
->
li¡’”s
[
i
].
sk
;

163 ià(
li¡’”
->
su³r
.
¡©us
 !ğ
·»Á_sk
->super.status) {

165 
	`ucc_sk_”rÜ_hªdËr
(
sk
, 
li¡’”
);

169  
UCC_OK
;

170 
	}
}

172 
ucc_¡©us_t
 
	$ucc_ev’t_mªag”_nÙify
(
ucc_cŞl_sk_t
 *
·»Á_sk
,

173 
ucc_ev’t_t
 
ev’t
)

175 
ucc_ev’t_mªag”_t
 *
em
;

176 
ucc_cŞl_sk_t
 *
sk
;

177 
ucc_¡©us_t
 
¡©us
;

178 
i
;

180 
	`ucc_li¡_fÜ_—ch
(
em
, &
·»Á_sk
->
em_li¡
, 
li¡_–em
) {

181 
i
 = 0; i < 
em
->
n_li¡’”s
; i++) {

182 
sk
 = 
em
->
li¡’”s
[
i
].task;

183 ià(
	`ucc_uÆik–y
(
ev’t
 =ğ
UCC_EVENT_ERROR
)) {

184 
	`ucc_sk_”rÜ_hªdËr
(
·»Á_sk
, 
sk
);

187 ià(
em
->
li¡’”s
[
i
].
ev’t
 ==ƒvent) {

188 
¡©us
 = 
em
->
li¡’”s
[
i
].
	`hªdËr
(
·»Á_sk
, 
sk
);

189 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

190  
¡©us
;

195  
UCC_OK
;

196 
	}
}

198 
ucc_¡©us_t


199 
	$ucc_scheduË_com¶‘ed_hªdËr
(
ucc_cŞl_sk_t
 *
·»Á_sk
,

200 
ucc_cŞl_sk_t
 *
sk
)

202 
ucc_scheduË_t
 *
£lf
 = 
	`ucc_cÚš”_of
(
sk
, ucc_scheduË_t, 
su³r
);

203 
ušt32_t
 
n_com¶‘ed_sks
;

205 
n_com¶‘ed_sks
 = 
	`ucc_©omic_çdd32
(&
£lf
->n_completed_tasks, 1);

207 ià(
n_com¶‘ed_sks
 + 1 =ğ
£lf
->
n_sks
) {

208 
£lf
->
su³r
.
¡©us
 = 
UCC_OK
;

209 
	`ucc_sk_com¶‘e
(&
£lf
->
su³r
);

211  
UCC_OK
;

212 
	}
}

214 
ucc_¡©us_t
 
	$ucc_scheduË_š™
(
ucc_scheduË_t
 *
scheduË
,

215 
ucc_ba£_cŞl_¬gs_t
 *
b¬gs
,

216 
ucc_ba£_‹am_t
 *
‹am
)

218 
ucc_¡©us_t
 
¡©us
;

220 
¡©us
 = 
	`ucc_cŞl_sk_š™
(&
scheduË
->
su³r
, 
b¬gs
, 
‹am
);

221 
scheduË
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_IS_SCHEDULE
;

222 
scheduË
->
ùx
 = 
‹am
->
cÚ‹xt
->
ucc_cÚ‹xt
;

223 
scheduË
->
n_sks
 = 0;

224  
¡©us
;

225 
	}
}

227 
ucc_¡©us_t
 
	$ucc_scheduË_add_sk
(
ucc_scheduË_t
 *
scheduË
,

228 
ucc_cŞl_sk_t
 *
sk
)

230 
ucc_¡©us_t
 
¡©us
;

232 
¡©us
 = 
	`ucc_ev’t_mªag”_subsüibe
(
sk
, 
UCC_EVENT_COMPLETED_SCHEDULE
,

233 &
scheduË
->
su³r
,

234 
ucc_scheduË_com¶‘ed_hªdËr
);

235 
sk
->
scheduË
 = schedule;

236 
scheduË
->
sks
[scheduË->
n_sks
++] = 
sk
;

237 ià(
sk
->
æags
 & 
UCC_COLL_TASK_FLAG_EXECUTOR
) {

238 
scheduË
->
su³r
.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

240  
¡©us
;

241 
	}
}

243 
ucc_¡©us_t
 
	$ucc_scheduË_¡¬t
(
ucc_cŞl_sk_t
 *
sk
)

245 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

247 
scheduË
->
n_com¶‘ed_sks
 = 0;

248 
scheduË
->
su³r
.
¡©us
 = 
UCC_INPROGRESS
;

249 
scheduË
->
su³r
.su³r.
¡©us
 = 
UCC_INPROGRESS
;

250  
	`ucc_ev’t_mªag”_nÙify
(&
scheduË
->
su³r
,

251 
UCC_EVENT_SCHEDULE_STARTED
);

252 
	}
}

254 
ucc_¡©us_t
 
	$ucc_sk_¡¬t_hªdËr
(
ucc_cŞl_sk_t
 *
·»Á
,

255 
ucc_cŞl_sk_t
 *
sk
)

257 
sk
->
¡¬t_time
 = 
·»Á
->start_time;

258  
sk
->
	`po¡
(task);

259 
	}
}

261 
ucc_¡©us_t
 
	$ucc_scheduË_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

263 
ucc_scheduË_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

264 
ucc_¡©us_t
 
¡©us_ov”®l
 = 
UCC_OK
;

265 
ucc_¡©us_t
 
¡©us
;

266 
i
;

268 
i
 = 0; i < 
scheduË
->
n_sks
; i++) {

269 ià(
scheduË
->
sks
[
i
]->
fš®ize
) {

270 
¡©us
 = 
scheduË
->
sks
[
i
]->
	`fš®ize
(schedule->tasks[i]);

271 ià(
UCC_OK
 !ğ
¡©us
) {

272 
¡©us_ov”®l
 = 
¡©us
;

276  
¡©us_ov”®l
;

277 
	}
}

	@src/schedule/ucc_schedule.h

7 #iâdeà
UCC_SCHEDULE_H_


8 
	#UCC_SCHEDULE_H_


	)

10 
	~"ucc/­i/ucc.h
"

11 
	~"uts/ucc_li¡.h
"

12 
	~"uts/ucc_log.h
"

13 
	~"uts/ucc_lock_ä“_queue.h
"

14 
	~"uts/ucc_cŞl_uts.h
"

15 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

16 
	~"compÚ’ts/ec/ucc_ec.h
"

17 
	~"compÚ’ts/mc/ucc_mc.h
"

19 
	#MAX_LISTENERS
 4

	)

22 
	mUCC_EVENT_COMPLETED
 = 0,

23 
	mUCC_EVENT_SCHEDULE_STARTED
,

24 
	mUCC_EVENT_TASK_STARTED
,

25 
	mUCC_EVENT_COMPLETED_SCHEDULE
,

27 
	mUCC_EVENT_ERROR
,

28 
	mUCC_EVENT_LAST


29 } 
	tucc_ev’t_t
;

31 
ucc_cŞl_sk
 
	tucc_cŞl_sk_t
;

33 
ucc_scheduË
 
	tucc_scheduË_t
;

35 
ucc_ba£_‹am
 
	tucc_ba£_‹am_t
;

37 
	$ucc_¡©us_t
 (*
	tucc_cŞl_po¡_â_t
)(
	tucc_cŞl_sk_t
 *
	tsk
);

39 (*
	tucc_cŞl_´og»ss_â_t
)(
	tucc_cŞl_sk_t
 *
	tsk
);

41 
	$ucc_¡©us_t
 (*
	tucc_cŞl_fš®ize_â_t
)(
	tucc_cŞl_sk_t
 *
	tsk
);

43 
	$ucc_¡©us_t
 (*
	tucc_sk_ev’t_hªdËr_p
)(
	tucc_cŞl_sk_t
 *
	t·»Á
,

44 
	tucc_cŞl_sk_t
 *
	tsk
);

47 
	$ucc_¡©us_t
 (*
	tucc_cŞl_Œigg”ed_po¡_£tup_â_t
)(
	tucc_cŞl_sk_t
 *
	tsk
);

49 
	$ucc_¡©us_t
 (*
	tucc_cŞl_Œigg”ed_po¡_â_t
)(
	tucc_“_h
 
	t“
, 
	tucc_ev_t
 *
	tev
,

50 
	tucc_cŞl_sk_t
 *
	tsk
);

52 
	succ_em_li¡’”
 {

53 
ucc_cŞl_sk_t
 *
sk
;

54 
ucc_sk_ev’t_hªdËr_p
 
hªdËr
;

55 
ucc_ev’t_t
 
ev’t
;

56 } 
	tucc_em_li¡’”_t
;

58 
	succ_ev’t_mªag”
 {

59 
ucc_li¡_lšk_t
 
li¡_–em
;

60 
n_li¡’”s
;

61 
ucc_em_li¡’”_t
 
li¡’”s
[
MAX_LISTENERS
];

62 } 
	tucc_ev’t_mªag”_t
;

65 
UCC_COLL_TASK_FLAG_CB
 = 
	`UCC_BIT
(0),

67 
UCC_COLL_TASK_FLAG_EXECUTOR
 = 
	`UCC_BIT
(1),

69 
UCC_COLL_TASK_FLAG_TOP_LEVEL
 = 
	`UCC_BIT
(2),

71 
UCC_COLL_TASK_FLAG_EXECUTOR_STOP
 = 
	`UCC_BIT
(3),

73 
UCC_COLL_TASK_FLAG_EXECUTOR_DESTROY
 = 
	`UCC_BIT
(4),

75 
UCC_COLL_TASK_FLAG_IS_SCHEDULE
 = 
	`UCC_BIT
(5),

77 
UCC_COLL_TASK_FLAG_IS_PIPELINED_SCHEDULE
 = 
	`UCC_BIT
(6),

81 
	succ_cŞl_sk
 {

82 
ucc_cŞl_»q_t
 
su³r
;

88 
ucc_¡©us_t
 
¡©us
;

89 
ucc_li¡_lšk_t
 
em_li¡
;

90 
ucc_ba£_cŞl_¬gs_t
 
b¬gs
;

91 
ucc_ba£_‹am_t
 *
‹am
;

92 
ucc_scheduË_t
 *
scheduË
;

93 
ušt32_t
 
æags
;

94 
ucc_cŞl_po¡_â_t
 
po¡
;

95 
ucc_cŞl_Œigg”ed_po¡_£tup_â_t
 
Œigg”ed_po¡_£tup
;

96 
ucc_cŞl_Œigg”ed_po¡_â_t
 
Œigg”ed_po¡
;

97 
ucc_cŞl_´og»ss_â_t
 
´og»ss
;

98 
ucc_cŞl_fš®ize_â_t
 
fš®ize
;

99 
ucc_cŞl_ÿÎback_t
 
cb
;

100 
ucc_“_h
 
“
;

101 
ucc_ev_t
 *
ev
;

102 
ucc_cŞl_sk_t
 *
Œigg”ed_sk
;

103 
ucc_“_executÜ_t
 *
executÜ
;

106 
ucc_li¡_lšk_t
 
li¡_–em
;

108 
ucc_lf_queue_–em_t
 
lf_–em
;

110 
ušt32_t
 
n_d•s
;

111 
ušt32_t
 
n_d•s_§tisf›d
;

112 
ušt32_t
 
n_d•s_ba£
;

114 
¡¬t_time
;

115 
ušt32_t
 
£q_num
;

116 } 
	tucc_cŞl_sk_t
;

118 
ucc_mpoŞ_İs
 
ucc_cŞl_sk_mpoŞ_İs
;

119 
ucc_cÚ‹xt
 
	tucc_cÚ‹xt_t
;

121 
	#UCC_SCHEDULE_MAX_TASKS
 8

	)

123 
	succ_scheduË
 {

124 
ucc_cŞl_sk_t
 
su³r
;

125 
ušt32_t
 
n_com¶‘ed_sks
;

126 
ušt32_t
 
n_sks
;

127 
ucc_cÚ‹xt_t
 *
ùx
;

128 
ucc_cŞl_sk_t
 *
sks
[
UCC_SCHEDULE_MAX_TASKS
];

129 } 
	tucc_scheduË_t
;

131 
	`ucc_cŞl_sk_cÚ¡ruù
(
ucc_cŞl_sk_t
 *
sk
);

133 
	`ucc_cŞl_sk_de¡ruù
(
ucc_cŞl_sk_t
 *
sk
);

135 
ucc_¡©us_t
 
	`ucc_cŞl_sk_š™
(
ucc_cŞl_sk_t
 *
sk
,

136 
ucc_ba£_cŞl_¬gs_t
 *
¬gs
,

137 
ucc_ba£_‹am_t
 *
‹am
);

139 
ucc_¡©us_t
 
	`ucc_cŞl_sk_g‘_executÜ
(
ucc_cŞl_sk_t
 *
sk
,

140 
ucc_“_executÜ_t
 **
exec
);

142 
ucc_¡©us_t
 
	`ucc_ev’t_mªag”_subsüibe
(
ucc_cŞl_sk_t
 *
·»Á_sk
,

143 
ucc_ev’t_t
 
ev’t
,

144 
ucc_cŞl_sk_t
 *
sk
,

145 
ucc_sk_ev’t_hªdËr_p
 
hªdËr
);

147 
ucc_¡©us_t
 
	`ucc_ev’t_mªag”_nÙify
(
ucc_cŞl_sk_t
 *
·»Á_sk
,

148 
ucc_ev’t_t
 
ev’t
);

150 
ucc_¡©us_t
 
	`ucc_scheduË_š™
(
ucc_scheduË_t
 *
scheduË
,

151 
ucc_ba£_cŞl_¬gs_t
 *
b¬gs
,

152 
ucc_ba£_‹am_t
 *
‹am
);

154 
ucc_¡©us_t
 
	`ucc_scheduË_add_sk
(
ucc_scheduË_t
 *
scheduË
,

155 
ucc_cŞl_sk_t
 *
sk
);

157 
ucc_¡©us_t
 
	`ucc_scheduË_¡¬t
(
ucc_cŞl_sk_t
 *
sk
);

159 
ucc_¡©us_t
 
	`ucc_sk_¡¬t_hªdËr
(
ucc_cŞl_sk_t
 *
·»Á
,

160 
ucc_cŞl_sk_t
 *
sk
);

161 
ucc_¡©us_t
 
	`ucc_scheduË_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

163 
ucc_¡©us_t
 
	`ucc_d•’d’cy_hªdËr
(
ucc_cŞl_sk_t
 *
·»Á
,

164 
ucc_cŞl_sk_t
 *
sk
);

166 
ucc_¡©us_t
 
	`ucc_Œigg”ed_po¡
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
,

167 
ucc_cŞl_sk_t
 *
sk
);

169 
šlše
 
ucc_¡©us_t
 
	$ucc_sk_com¶‘e
(
ucc_cŞl_sk_t
 *
sk
)

171 
ucc_¡©us_t
 
¡©us
 = 
sk
->status;

172 
ucc_cŞl_ÿÎback_t
 
cb
 = 
sk
->cb;

173 
has_cb
 = 
sk
->
æags
 & 
UCC_COLL_TASK_FLAG_CB
;

174 
has_sched
 = 
sk
->
scheduË
 !ğ
NULL
;

176 
	`ucc_as£¹
((
¡©us
 =ğ
UCC_OK
) || (status < 0));

188 ià(
	`ucc_lik–y
(
¡©us
 =ğ
UCC_OK
)) {

189 
ucc_bufãr_šfo_asymm‘ric_memty³_t
 *
§ve
 = &
sk
->
b¬gs
.
asymm‘ric_§ve_šfo
;

190 ià(
§ve
->
sü©ch
 &&

191 
sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 !ğ
UCC_COLL_TYPE_SCATTERV
 &&

192 
sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 !ğ
UCC_COLL_TYPE_SCATTER
) {

193 
¡©us
 = 
	`ucc_cİy_asymm‘ric_bufãr
(
sk
);

194 ià(
¡©us
 !ğ
UCC_OK
) {

195 
	`ucc_”rÜ
("failure copying out‡symmetric buffer: %s",

196 
	`ucc_¡©us_¡ršg
(
¡©us
));

199 
¡©us
 = 
	`ucc_ev’t_mªag”_nÙify
(
sk
, 
UCC_EVENT_COMPLETED
);

202 ià(
UCC_ERR_TIMED_OUT
 =ğ
¡©us
) {

203 
cŞl_¡r
[256];

204 
	`ucc_cŞl_¡r
(
sk
, 
cŞl_¡r
, (coll_str),

205 
UCC_LOG_LEVEL_DEBUG
);

206 
	`ucc_w¬n
("timeout %g sec. hasƒxpired on %s",

207 
sk
->
b¬gs
.
¬gs
.
timeout
, 
cŞl_¡r
);

209 
	`ucc_”rÜ
("çu» iÀsk %p, %s", 
sk
,

210 
	`ucc_¡©us_¡ršg
(
sk
->
¡©us
));

212 
	`ucc_ev’t_mªag”_nÙify
(
sk
, 
UCC_EVENT_ERROR
);

215 ià((
sk
->
executÜ
è&& (sk->
æags
 & 
UCC_COLL_TASK_FLAG_EXECUTOR_STOP
)) {

216 
¡©us
 = 
	`ucc_“_executÜ_¡İ
(
sk
->
executÜ
);

217 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

218 
	`ucc_”rÜ
("çedØ¡İƒxecutÜ %s", 
	`ucc_¡©us_¡ršg
(
¡©us
));

222 ià((
sk
->
executÜ
è&& (sk->
æags
 & 
UCC_COLL_TASK_FLAG_EXECUTOR_DESTROY
)) {

223 
¡©us
 = 
	`ucc_“_executÜ_fš®ize
(
sk
->
executÜ
);

224 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

225 
	`ucc_”rÜ
("failedo finalizeƒxecutor %s",

226 
	`ucc_¡©us_¡ršg
(
¡©us
));

228 
sk
->
executÜ
 = 
NULL
;

231 
sk
->
su³r
.
¡©us
 = status;

232 ià(
has_cb
) {

233 
cb
.
	`cb
(cb.
d©a
, 
¡©us
);

236 ià(
has_sched
 && 
¡©us
 =ğ
UCC_OK
) {

237 
¡©us
 = 
	`ucc_ev’t_mªag”_nÙify
(
sk
, 
UCC_EVENT_COMPLETED_SCHEDULE
);

240  
¡©us
;

241 
	}
}

243 
šlše
 
ucc_¡©us_t
 
	$ucc_sk_subsüibe_d•
(
ucc_cŞl_sk_t
 *
rg‘
,

244 
ucc_cŞl_sk_t
 *
subsüib”
,

245 
ucc_ev’t_t
 
ev’t
)

247 
ucc_¡©us_t
 
¡©us
 =

248 
	`ucc_ev’t_mªag”_subsüibe
(
rg‘
, 
ev’t
, 
subsüib”
,

249 
ucc_d•’d’cy_hªdËr
);

250 
subsüib”
->
n_d•s
++;

251  
¡©us
;

252 
	}
}

254 
	#UCC_TASK_LIB
(
_sk
è(((
ucc_cŞl_sk_t
 *)_sk)->
‹am
->
cÚ‹xt
->
lib
)

	)

255 
	#UCC_TASK_CORE_CTX
(
_sk
) \

256 (((
ucc_cŞl_sk_t
 *)
_sk
)->
‹am
->
cÚ‹xt
->
ucc_cÚ‹xt
)

	)

258 
	#UCC_TASK_THREAD_MODE
(
_sk
è(
	`UCC_TASK_CORE_CTX
(_sk)->
th»ad_mode
)

	)

	@src/schedule/ucc_schedule_pipelined.c

7 
	~"ucc_scheduË.h
"

8 
	~"ucc_scheduË_p–šed.h
"

9 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

10 
	~"cÜe/ucc_cÚ‹xt.h
"

12 cÚ¡ * 
	gucc_p–še_Üd”_Çmes
[] = {

13 [
UCC_PIPELINE_PARALLEL
] = "parallel",

14 [
UCC_PIPELINE_ORDERED
] = "ordered",

15 [
UCC_PIPELINE_SEQUENTIAL
] = "sequential",

16 [
UCC_PIPELINE_LAST
] = 
NULL


19 
ucc_¡©us_t
 
	$ucc_äag_¡¬t_hªdËr
(
ucc_cŞl_sk_t
 *
·»Á
,

20 
ucc_cŞl_sk_t
 *
sk
)

22 
ucc_scheduË_p–šed_t
 *
scheduË
 = 
	`ucc_d”ived_of
(
·»Á
,

23 
ucc_scheduË_p–šed_t
);

24 
ucc_scheduË_t
 *
äag
 = 
	`ucc_d”ived_of
(
sk
, ucc_schedule_t);

25 
ucc_¡©us_t
 
¡
;

27 
sk
->
¡¬t_time
 = 
·»Á
->start_time;

28 ià(
scheduË
->
äag_£tup
) {

29 
¡
 = 
scheduË
->
	`äag_£tup
(scheduË, 
äag
, scheduË->
n_äags_¡¬‹d
);

30 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡
)) {

31 
	`ucc_”rÜ
("failedo setup fragment %d of…ipelined schedule",

32 
scheduË
->
n_äags_¡¬‹d
);

33  
¡
;

37 
scheduË
->
Ãxt_äag_to_po¡
 = (schedule->next_frag_to_post + 1) %

38 
scheduË
->
n_äags
;

39 
	`ucc_Œaû_»q
("sched %p started frag %p frag_num %d‚ext_to_post %d",

40 
scheduË
, 
äag
, scheduË->
n_äags_¡¬‹d
,

41 
scheduË
->
Ãxt_äag_to_po¡
);

42 
scheduË
->
n_äags_¡¬‹d
++;

43 
scheduË
->
n_äags_š_p–še
++;

44  
sk
->
	`po¡
(task);

45 
	}
}

47 
ucc_¡©us_t


48 
	$ucc_scheduË_p–šed_com¶‘ed_hªdËr
(
ucc_cŞl_sk_t
 *
·»Á_sk
,

49 
ucc_cŞl_sk_t
 *
sk
)

51 
ucc_scheduË_p–šed_t
 *
scheduË
 =

52 
	`ucc_cÚš”_of
(
sk
, 
ucc_scheduË_p–šed_t
, 
su³r
);

53 
ucc_scheduË_t
 *
äag
 = 
	`ucc_d”ived_of
(
·»Á_sk
, ucc_schedule_t);

54 
i
;

56 ià(
	`UCC_TASK_THREAD_MODE
(
sk
è=ğ
UCC_THREAD_MULTIPLE
) {

57 
	`ucc_»cursive_¥š_lock
(&
scheduË
->
lock
);

60 
scheduË
->
su³r
.
n_com¶‘ed_sks
 += 1;

61 
scheduË
->
n_äags_š_p–še
--;

62 
	`ucc_Œaû_»q
(

64 
scheduË
, 
äag
, scheduË->
su³r
.
n_com¶‘ed_sks
,

65 
scheduË
->
n_äags_¡¬‹d
, scheduË->
su³r
.
n_sks
);

66 ià(
scheduË
->
su³r
.
n_com¶‘ed_sks
 =ğscheduË->su³r.
n_sks
) {

67 
scheduË
->
su³r
.su³r.
¡©us
 = 
UCC_OK
;

68 ià(
	`UCC_TASK_THREAD_MODE
(
sk
è=ğ
UCC_THREAD_MULTIPLE
) {

69 
	`ucc_»cursive_¥š_uÆock
(&
scheduË
->
lock
);

71 
	`ucc_sk_com¶‘e
(
sk
);

72  
UCC_OK
;

74 (
scheduË
->
su³r
.
n_com¶‘ed_sks
 + scheduË->
n_äags_š_p–še
 <

75 
scheduË
->
su³r
.
n_sks
) &&

76 (
äag
->
su³r
.
¡©us
 =ğ
UCC_OK
)) {

78 ià(
äag
 =ğ
scheduË
->
äags
[scheduË->
Ãxt_äag_to_po¡
]) {

79 
	`ucc_Œaû_»q
("sched %°»¡¬tšg f¿g %d %p", 
scheduË
,

80 
scheduË
->
Ãxt_äag_to_po¡
, 
äag
);

81 
äag
->
su³r
.
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

82 
äag
->
n_com¶‘ed_sks
 = 0;

83 
i
 = 0; i < 
äag
->
n_sks
; i++) {

84 
äag
->
sks
[
i
]->
n_d•s
 +ğäag->sks[i]->
n_d•s_ba£
;

85 
äag
->
sks
[
i
]->
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

87 
	`ucc_äag_¡¬t_hªdËr
(&
scheduË
->
su³r
.su³r, &
äag
->super);

89 
äag
 = 
scheduË
->
äags
[scheduË->
Ãxt_äag_to_po¡
];

90 ià(&
äag
->
su³r
 =ğ
·»Á_sk
) {

94 ià(
	`UCC_TASK_THREAD_MODE
(
sk
è=ğ
UCC_THREAD_MULTIPLE
) {

95 
	`ucc_»cursive_¥š_uÆock
(&
scheduË
->
lock
);

97  
UCC_OK
;

98 
	}
}

100 
ucc_¡©us_t
 
	$ucc_scheduË_p–šed_fš®ize
(
ucc_cŞl_sk_t
 *
sk
)

102 
ucc_scheduË_p–šed_t
 *
scheduË_p
 =

103 
	`ucc_d”ived_of
(
sk
, 
ucc_scheduË_p–šed_t
);

104 
ucc_scheduË_t
 **
äags
 = 
scheduË_p
->frags;

105 
i
;

107 
	`ucc_Œaû_»q
("scheduË…–šed %°i com¶‘e", 
scheduË_p
);

108 
i
 = 0; i < 
scheduË_p
->
n_äags
; i++) {

109 
scheduË_p
->
äags
[
i
]->
su³r
.
	`fš®ize
(&frags[i]->super);

112 ià(
	`UCC_TASK_THREAD_MODE
(
sk
è=ğ
UCC_THREAD_MULTIPLE
) {

113 
	`ucc_»cursive_¥šlock_de¡roy
(&
scheduË_p
->
lock
);

116  
UCC_OK
;

117 
	}
}

119 
ucc_¡©us_t
 
	$ucc_scheduË_p–šed_po¡
(
ucc_cŞl_sk_t
 *
sk
)

121 
ucc_scheduË_p–šed_t
 *
scheduË_p
 =

122 
	`ucc_d”ived_of
(
sk
, 
ucc_scheduË_p–šed_t
);

123 
ucc_scheduË_t
 **
äags
 = 
scheduË_p
->frags;

124 
i
, 
j
;

126 
scheduË_p
->
su³r
.su³r.su³r.
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

127 
scheduË_p
->
su³r
.
n_com¶‘ed_sks
 = 0;

128 
scheduË_p
->
n_äags_¡¬‹d
 = 0;

129 
scheduË_p
->
Ãxt_äag_to_po¡
 = 0;

130 
scheduË_p
->
n_äags_š_p–še
 = 0;

132 
i
 = 0; i < 
scheduË_p
->
n_äags
; i++) {

133 
äags
[
i
]->
n_com¶‘ed_sks
 = 0;

134 
äags
[
i
]->
su³r
.su³r.
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

135 
j
 = 0; j < 
äags
[0]->
n_sks
; j++) {

136 
äags
[
i
]->
sks
[
j
]->
n_d•s
 = f¿gs[i]->sks[j]->
n_d•s_ba£
;

137 
äags
[
i
]->
sks
[
j
]->
n_d•s_§tisf›d
 = 0;

138 
äags
[
i
]->
sks
[
j
]->
su³r
.
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

139 ià(
i
 =ğ0 && 
scheduË_p
->
n_äags
 > 1 &&

140 
UCC_PIPELINE_PARALLEL
 !ğ
scheduË_p
->
Üd”
) {

141 
äags
[0]->
sks
[
j
]->
n_d•s_§tisf›d
++;

146  
	`ucc_scheduË_¡¬t
(
sk
);

147 
	}
}

149 
ucc_¡©us_t
 
	$ucc_scheduË_p–šed_š™
(
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
,

150 
ucc_ba£_‹am_t
 *
‹am
,

151 
ucc_scheduË_äag_š™_â_t
 
äag_š™
,

152 
ucc_scheduË_äag_£tup_â_t
 
äag_£tup
,

153 
n_äags
, 
n_äags_tÙ®
,

154 
ucc_p–še_Üd”_t
 
Üd”
,

155 
ucc_scheduË_p–šed_t
 *
scheduË
)

157 
ucc_ev’t_t
 
sk_d•’d’cy_ev’t
 = 
UCC_EVENT_LAST
;

158 
i
, 
j
;

159 
ucc_¡©us_t
 
¡©us
;

160 
ucc_scheduË_t
 **
äags
;

162 ià(
	`ucc_uÆik–y
(
n_äags
 > 
UCC_SCHEDULE_PIPELINED_MAX_FRAGS
)) {

163 
	`ucc_”rÜ
("n_frags %dƒxceeds max†imit of %d",

164 
n_äags
, 
UCC_SCHEDULE_PIPELINED_MAX_FRAGS
);

165  
UCC_ERR_INVALID_PARAM
;

168 ià(
n_äags
 > 1) {

170 
Üd”
) {

171 
UCC_PIPELINE_PARALLEL
:

173 
sk_d•’d’cy_ev’t
 = 
UCC_EVENT_LAST
;

175 
UCC_PIPELINE_ORDERED
:

177 
sk_d•’d’cy_ev’t
 = 
UCC_EVENT_TASK_STARTED
;

179 
UCC_PIPELINE_SEQUENTIAL
:

181 
sk_d•’d’cy_ev’t
 = 
UCC_EVENT_COMPLETED
;

184  
UCC_ERR_INVALID_PARAM
;

188 
¡©us
 = 
	`ucc_scheduË_š™
(&
scheduË
->
su³r
, 
cŞl_¬gs
, 
‹am
);

189 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

190 
	`ucc_”rÜ
("failedo init…ipelined schedule");

191  
¡©us
;

194 ià(
	`UCC_TASK_THREAD_MODE
(&
scheduË
->
su³r
.su³rè=ğ
UCC_THREAD_MULTIPLE
) {

195 
	`ucc_»cursive_¥šlock_š™
(&
scheduË
->
lock
, 0);

198 
scheduË
->
su³r
.su³r.
æags
 |ğ
UCC_COLL_TASK_FLAG_IS_PIPELINED_SCHEDULE
;

199 
scheduË
->
su³r
.
n_sks
 = 
n_äags_tÙ®
;

200 
scheduË
->
n_äags
 =‚_frags;

201 
scheduË
->
Üd”
 = order;

202 
scheduË
->
äag_£tup
 = frag_setup;

203 
scheduË
->
Ãxt_äag_to_po¡
 = 0;

204 
scheduË
->
n_äags_š_p–še
 = 0;

205 
scheduË
->
su³r
.su³r.
fš®ize
 = 
ucc_scheduË_p–šed_fš®ize
;

206 
scheduË
->
su³r
.su³r.
po¡
 = 
ucc_scheduË_p–šed_po¡
;

207 
äags
 = 
scheduË
->frags;

208 
i
 = 0; i < 
n_äags
; i++) {

209 
¡©us
 = 
	`äag_š™
(
cŞl_¬gs
, 
scheduË
, 
‹am
, &
äags
[
i
]);

210 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

211 
	`ucc_”rÜ
("failedo initialize fragment for…ipeline");

212 
”r
;

214 
äags
[
i
]->
su³r
.
scheduË
 = &schedule->super;

215 ià(
äags
[
i
]->
su³r
.
æags
 & 
UCC_COLL_TASK_FLAG_EXECUTOR
) {

216 
scheduË
->
su³r
.su³r.
æags
 |ğ
UCC_COLL_TASK_FLAG_EXECUTOR
;

218 
äags
[
i
]->
su³r
.
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

219 
äags
[
i
]->
su³r
.su³r.
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

222 
i
 = 0; i < 
n_äags
; i++) {

223 
j
 = 0; j < 
äags
[
i
]->
n_sks
; j++) {

224 
äags
[
i
]->
sks
[
j
]->
n_d•s_ba£
 = f¿gs[i]->sks[j]->
n_d•s
;

225 ià(
sk_d•’d’cy_ev’t
 !ğ
UCC_EVENT_LAST
) {

226 
	`UCC_CHECK_GOTO
(

227 
	`ucc_ev’t_mªag”_subsüibe
(

228 
äags
[(
i
 + 
n_äags
 - 1è%‚_äags]->
sks
[
j
],

229 
sk_d•’d’cy_ev’t
, 
äags
[
i
]->
sks
[
j
],

230 
ucc_d•’d’cy_hªdËr
),

231 
”r
, 
¡©us
);

232 
äags
[
i
]->
sks
[
j
]->
n_d•s_ba£
++;

235 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(

236 &
scheduË
->
su³r
.su³r, 
UCC_EVENT_SCHEDULE_STARTED
,

237 &
äags
[
i
]->
su³r
, 
ucc_äag_¡¬t_hªdËr
),

238 
”r
, 
¡©us
);

239 
	`UCC_CHECK_GOTO
(
	`ucc_ev’t_mªag”_subsüibe
(

240 &
äags
[
i
]->
su³r
, 
UCC_EVENT_COMPLETED_SCHEDULE
,

241 &
scheduË
->
su³r
.super,

242 
ucc_scheduË_p–šed_com¶‘ed_hªdËr
),

243 
”r
, 
¡©us
);

245  
UCC_OK
;

246 
”r
:

247 
i
 = i - 1; i >= 0; i--) {

248 
äags
[
i
]->
su³r
.
	`fš®ize
(&frags[i]->super);

250  
¡©us
;

251 
	}
}

253 
ucc_¡©us_t
 
	$ucc_d•’d’cy_hªdËr
(
ucc_cŞl_sk_t
 *
·»Á
,

254 
ucc_cŞl_sk_t
 *
sk
)

256 
ucc_¡©us_t
 
¡©us
;

257 
ušt32_t
 
n_d•s_§tisf›d
;

259 
n_d•s_§tisf›d
 = 
	`ucc_©omic_çdd32
(&
sk
->n_deps_satisfied, 1);

260 
	`ucc_as£¹
(
sk
->
n_d•s_§tisf›d
 >‚_deps_satisfied);

262 
	`ucc_Œaû_»q
("sk %p,‚_d• %d, s©isf›d %d", 
sk
,ask->
n_d•s
,

263 
n_d•s_§tisf›d
);

264 ià(
sk
->
n_d•s
 =ğ
n_d•s_§tisf›d
 + 1) {

265 
sk
->
¡¬t_time
 = 
·»Á
->start_time;

266 
¡©us
 = 
sk
->
	`po¡
(task);

267 ià(
¡©us
 >= 0) {

268 
	`ucc_ev’t_mªag”_nÙify
(
sk
, 
UCC_EVENT_TASK_STARTED
);

270  
¡©us
;

273  
UCC_OK
;

274 
	}
}

	@src/schedule/ucc_schedule_pipelined.h

7 #iâdeà
UCC_SCHEDULE_PIPELINED_H_


8 
	#UCC_SCHEDULE_PIPELINED_H_


	)

10 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

12 
	#UCC_SCHEDULE_FRAG_MAX_TASKS
 8

	)

13 
	#UCC_SCHEDULE_PIPELINED_MAX_FRAGS
 4

	)

15 
ucc_scheduË_p–šed
 
	tucc_scheduË_p–šed_t
;

21 
	$ucc_¡©us_t
 (*
	tucc_scheduË_äag_š™_â_t
)(

22 
	tucc_ba£_cŞl_¬gs_t
 *
	tcŞl_¬gs
, 
	tucc_scheduË_p–šed_t
 *
	tscheduË_p
,

23 
	tucc_ba£_‹am_t
 *
	t‹am
, 
	tucc_scheduË_t
 **
	täag
);

31 
	$ucc_¡©us_t
 (*
	tucc_scheduË_äag_£tup_â_t
)(

32 
	tucc_scheduË_p–šed_t
 *
	tscheduË_p
, 
	tucc_scheduË_t
 *
	täag
, 
	täag_num
);

36 
UCC_PIPELINE_PARALLEL
,

39 
UCC_PIPELINE_ORDERED
,

41 
UCC_PIPELINE_SEQUENTIAL
,

45 
UCC_PIPELINE_LAST


46 } 
	tucc_p–še_Üd”_t
;

48 
	succ_p–še_·¿ms
 {

49 
size_t
 
th»shŞd
;

50 
size_t
 
äag_size
;

51 
n_äags
;

52 
pd•th
;

53 
ucc_p–še_Üd”_t
 
Üd”
;

54 } 
	tucc_p–še_·¿ms_t
;

56 
šlše
 
	$ucc_p–še_näags_pd•th
(
ucc_p–še_·¿ms_t
 *
p
,

57 
size_t
 
msgsize
, *
n_äags
,

58 *
p–še_d•th
)

60 
mš_num_äags
;

62 *
n_äags
 = 1;

63 ià(
msgsize
 > 
p
->
th»shŞd
) {

64 
mš_num_äags
 = 
	`ucc_div_round_up
(
msgsize
, 
p
->
äag_size
);

65 *
n_äags
 = 
	`ucc_max
(
mš_num_äags
, 
p
->n_frags);

67 *
p–še_d•th
 = 
	`ucc_mš
(*
n_äags
, 
p
->
pd•th
);

68 
	}
}

70 cÚ¡ * 
ucc_p–še_Üd”_Çmes
[];

71 
	succ_scheduË_p–šed
 {

72 
ucc_scheduË_t
 
	msu³r
;

74 
ucc_scheduË_t
 * 
	mäags
[
UCC_SCHEDULE_PIPELINED_MAX_FRAGS
];

77 
	mn_äags
;

80 
	mn_äags_¡¬‹d
;

82 
	mn_äags_š_p–še
;

86 
ucc_p–še_Üd”_t
 
	mÜd”
;

87 
	mÃxt_äag_to_po¡
;

88 
ucc_scheduË_äag_£tup_â_t
 
	mäag_£tup
;

89 
ucc_»cursive_¥šlock_t
 
	mlock
;

90 } 
	tucc_scheduË_p–šed_t
;

98 
ucc_¡©us_t
 
ucc_scheduË_p–šed_š™
(

99 
ucc_ba£_cŞl_¬gs_t
 *
cŞl_¬gs
, 
ucc_ba£_‹am_t
 *
‹am
,

100 
ucc_scheduË_äag_š™_â_t
 
äag_š™
,

101 
ucc_scheduË_äag_£tup_â_t
 
äag_£tup
, 
n_äags
, 
n_äags_tÙ®
,

102 
ucc_p–še_Üd”_t
 
Üd”
, 
ucc_scheduË_p–šed_t
 *
scheduË_p
);

104 
ucc_¡©us_t
 
ucc_scheduË_p–šed_po¡
(
ucc_cŞl_sk_t
 *
sk
);

106 
ucc_¡©us_t
 
ucc_scheduË_p–šed_fš®ize
(
ucc_cŞl_sk_t
 *
sk
);

	@src/ucc/api/ucc.h

11 #iâdeà
UCC_H_


12 
	#UCC_H_


	)

14 
	~<ucc/­i/ucc_def.h
>

15 
	~<ucc/­i/ucc_v”siÚ.h
>

16 
	~<ucc/­i/ucc_¡©us.h
>

17 
	~<¡dio.h
>

19 
BEGIN_C_DECLS


148 
	mUCC_COLL_TYPE_ALLGATHER
 = 
UCC_BIT
(0),

149 
	mUCC_COLL_TYPE_ALLGATHERV
 = 
UCC_BIT
(1),

150 
	mUCC_COLL_TYPE_ALLREDUCE
 = 
UCC_BIT
(2),

151 
	mUCC_COLL_TYPE_ALLTOALL
 = 
UCC_BIT
(3),

152 
	mUCC_COLL_TYPE_ALLTOALLV
 = 
UCC_BIT
(4),

153 
	mUCC_COLL_TYPE_BARRIER
 = 
UCC_BIT
(5),

154 
	mUCC_COLL_TYPE_BCAST
 = 
UCC_BIT
(6),

155 
	mUCC_COLL_TYPE_FANIN
 = 
UCC_BIT
(7),

156 
	mUCC_COLL_TYPE_FANOUT
 = 
UCC_BIT
(8),

157 
	mUCC_COLL_TYPE_GATHER
 = 
UCC_BIT
(9),

158 
	mUCC_COLL_TYPE_GATHERV
 = 
UCC_BIT
(10),

159 
	mUCC_COLL_TYPE_REDUCE
 = 
UCC_BIT
(11),

160 
	mUCC_COLL_TYPE_REDUCE_SCATTER
 = 
UCC_BIT
(12),

161 
	mUCC_COLL_TYPE_REDUCE_SCATTERV
 = 
UCC_BIT
(13),

162 
	mUCC_COLL_TYPE_SCATTER
 = 
UCC_BIT
(14),

163 
	mUCC_COLL_TYPE_SCATTERV
 = 
UCC_BIT
(15),

164 
	mUCC_COLL_TYPE_LAST


165 } 
	tucc_cŞl_ty³_t
;

170 
	eucc_memÜy_ty³
 {

171 
	mUCC_MEMORY_TYPE_HOST
,

172 
	mUCC_MEMORY_TYPE_CUDA
,

173 
	mUCC_MEMORY_TYPE_CUDA_MANAGED
,

174 
	mUCC_MEMORY_TYPE_ROCM
,

175 
	mUCC_MEMORY_TYPE_ROCM_MANAGED
,

176 
	mUCC_MEMORY_TYPE_LAST
,

177 
	mUCC_MEMORY_TYPE_UNKNOWN
 = 
UCC_MEMORY_TYPE_LAST


178 } 
	tucc_memÜy_ty³_t
;

201 
ušt64_t
 
	tucc_d©©y³_t
;

203 
	#UCC_DT_INT8
 
	`UCC_PREDEFINED_DT
(0)

	)

204 
	#UCC_DT_INT16
 
	`UCC_PREDEFINED_DT
(1)

	)

205 
	#UCC_DT_INT32
 
	`UCC_PREDEFINED_DT
(2)

	)

206 
	#UCC_DT_INT64
 
	`UCC_PREDEFINED_DT
(3)

	)

207 
	#UCC_DT_INT128
 
	`UCC_PREDEFINED_DT
(4)

	)

208 
	#UCC_DT_UINT8
 
	`UCC_PREDEFINED_DT
(5)

	)

209 
	#UCC_DT_UINT16
 
	`UCC_PREDEFINED_DT
(6)

	)

210 
	#UCC_DT_UINT32
 
	`UCC_PREDEFINED_DT
(7)

	)

211 
	#UCC_DT_UINT64
 
	`UCC_PREDEFINED_DT
(8)

	)

212 
	#UCC_DT_UINT128
 
	`UCC_PREDEFINED_DT
(9)

	)

213 
	#UCC_DT_FLOAT16
 
	`UCC_PREDEFINED_DT
(10)

	)

214 
	#UCC_DT_FLOAT32
 
	`UCC_PREDEFINED_DT
(11)

	)

215 
	#UCC_DT_FLOAT64
 
	`UCC_PREDEFINED_DT
(12)

	)

216 
	#UCC_DT_BFLOAT16
 
	`UCC_PREDEFINED_DT
(13)

	)

217 
	#UCC_DT_FLOAT128
 
	`UCC_PREDEFINED_DT
(14)

	)

218 
	#UCC_DT_FLOAT32_COMPLEX
 
	`UCC_PREDEFINED_DT
(15)

	)

219 
	#UCC_DT_FLOAT64_COMPLEX
 
	`UCC_PREDEFINED_DT
(16)

	)

220 
	#UCC_DT_FLOAT128_COMPLEX
 
	`UCC_PREDEFINED_DT
(17)

	)

221 
	#UCC_DT_PREDEFINED_LAST
 18

	)

226 
	eucc_g’”ic_dt_İs_f›ld
 {

227 
	mUCC_GENERIC_DT_OPS_FIELD_FLAGS
 = 
UCC_BIT
(0),

237 
	mUCC_GENERIC_DT_OPS_FLAG_CONTIG
 = 
UCC_BIT
(0),

242 
	mUCC_GENERIC_DT_OPS_FLAG_REDUCE
 = 
UCC_BIT
(1),

252 } 
	tucc_g’”ic_dt_İs_æags_t
;

267 
	succ_»duû_cb_·¿ms
 {

268 
ušt64_t
 
	mmask
;

269 *
	m¤c1
;

270 *
	m¤c2
;

272 *
	md¡
;

273 
size_t
 
	mn_veùÜs
;

274 
size_t
 
	mcouÁ
;

275 
size_t
 
	m¡ride
;

276 
ucc_dt_g’”ic_t
 *
	mdt
;

278 *
	mcb_ùx
;

280 } 
	tucc_»duû_cb_·¿ms_t
;

289 
	succ_g’”ic_dt_İs
 {

290 
ušt64_t
 
	mmask
;

291 
ušt64_t
 
	mæags
;

292 
size_t
 
	mcÚtig_size
;

306 * (*
	m¡¬t_·ck
)(*
	mcÚ‹xt
, cÚ¡ *
	mbufãr
, 
size_t
 
	mcouÁ
);

321 * (*
	m¡¬t_uÅack
)(*
	mcÚ‹xt
, *
	mbufãr
, 
size_t
 
	mcouÁ
);

336 
size_t
 (*
·cked_size
)(*
	m¡©e
);

354 
size_t
 (*
·ck
è(*
	m¡©e
, size_ˆ
	moff£t
, *
	mde¡
, size_ˆ
	mmax_Ëngth
);

371 
ucc_¡©us_t
 (*
uÅack
)(*
	m¡©e
, 
size_t
 
	moff£t
, cÚ¡ *
	m¤c
, size_ˆ
	mËngth
);

387 (*
	mfšish
)(*
	m¡©e
);

399 
ucc_¡©us_t
 (*
cb
)(cÚ¡ 
ucc_»duû_cb_·¿ms_t
 *
	m·¿ms
);

400 *
	mcb_ùx
;

401 } 
	m»duû
;

402 } 
	tucc_g’”ic_dt_İs_t
;

426 
ucc_¡©us_t
 
ucc_dt_ü—‹_g’”ic
(cÚ¡ 
ucc_g’”ic_dt_İs_t
 *
İs
, *
cÚ‹xt
,

427 
ucc_d©©y³_t
 *
d©©y³_p
);

433 
ucc_dt_de¡roy
(
ucc_d©©y³_t
 
d©©y³
);

455 
	mUCC_OP_SUM
,

456 
	mUCC_OP_PROD
,

457 
	mUCC_OP_MAX
,

458 
	mUCC_OP_MIN
,

459 
	mUCC_OP_LAND
,

460 
	mUCC_OP_LOR
,

461 
	mUCC_OP_LXOR
,

462 
	mUCC_OP_BAND
,

463 
	mUCC_OP_BOR
,

464 
	mUCC_OP_BXOR
,

465 
	mUCC_OP_MAXLOC
,

466 
	mUCC_OP_MINLOC
,

467 
	mUCC_OP_AVG
,

468 
	mUCC_OP_LAST


469 } 
	tucc_»duùiÚ_İ_t
;

494 
	mUCC_THREAD_SINGLE
 = 0,

495 
	mUCC_THREAD_FUNNELED
 = 1,

496 
	mUCC_THREAD_MULTIPLE
 = 2

497 } 
	tucc_th»ad_mode_t
;

522 
	mUCC_NO_SYNC_COLLECTIVES
 = 0,

523 
	mUCC_SYNC_COLLECTIVES
 = 1

524 } 
	tucc_cŞl_sync_ty³_t
;

535 
	eucc_lib_·¿ms_f›ld
{

536 
	mUCC_LIB_PARAM_FIELD_THREAD_MODE
 = 
UCC_BIT
(0),

537 
	mUCC_LIB_PARAM_FIELD_COLL_TYPES
 = 
UCC_BIT
(1),

538 
	mUCC_LIB_PARAM_FIELD_REDUCTION_TYPES
 = 
UCC_BIT
(2),

539 
	mUCC_LIB_PARAM_FIELD_SYNC_TYPE
 = 
UCC_BIT
(3)

546 
	eucc_lib_©Œ_f›ld
{

547 
	mUCC_LIB_ATTR_FIELD_THREAD_MODE
 = 
UCC_BIT
(0),

548 
	mUCC_LIB_ATTR_FIELD_COLL_TYPES
 = 
UCC_BIT
(1),

549 
	mUCC_LIB_ATTR_FIELD_REDUCTION_TYPES
 = 
UCC_BIT
(2),

550 
	mUCC_LIB_ATTR_FIELD_SYNC_TYPE
 = 
UCC_BIT
(3)

573 
	succ_lib_·¿ms
 {

574 
ušt64_t
 
	mmask
;

575 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

576 
ušt64_t
 
	mcŞl_ty³s
;

577 
ušt64_t
 
	m»duùiÚ_ty³s
;

578 
ucc_cŞl_sync_ty³_t
 
	msync_ty³
;

579 } 
	tucc_lib_·¿ms_t
;

600 
	succ_lib_©Œ
 {

601 
ušt64_t
 
	mmask
;

602 
ucc_th»ad_mode_t
 
	mth»ad_mode
;

603 
ušt64_t
 
	mcŞl_ty³s
;

604 
ušt64_t
 
	m»duùiÚ_ty³s
;

605 
ucc_cŞl_sync_ty³_t
 
	msync_ty³
;

606 } 
	tucc_lib_©Œ_t
;

638 
ucc_¡©us_t
 
ucc_lib_cÚfig_»ad
(cÚ¡ *
’v_´efix
, cÚ¡ *
f’ame
,

639 
ucc_lib_cÚfig_h
 *
cÚfig
);

662 
ucc_lib_cÚfig_»Ëa£
(
ucc_lib_cÚfig_h
 
cÚfig
);

686 
ucc_lib_cÚfig_´št
(cÚ¡ 
ucc_lib_cÚfig_h
 
cÚfig
, 
FILE
 *
¡»am
,

687 cÚ¡ *
t™Ë
, 
ucc_cÚfig_´št_æags_t
 
´št_æags
);

711 
ucc_¡©us_t
 
ucc_lib_cÚfig_modify
(
ucc_lib_cÚfig_h
 
cÚfig
, cÚ¡ *
Çme
,

712 cÚ¡ *
v®ue
);

724 
ucc_g‘_v”siÚ
(*
majÜ_v”siÚ
, *
mšÜ_v”siÚ
,

725 *
»Ëa£_numb”
);

734 cÚ¡ *
ucc_g‘_v”siÚ_¡ršg
();

744 
ucc_¡©us_t
 
ucc_š™_v”siÚ
(
­i_majÜ_v”siÚ
,

745 
­i_mšÜ_v”siÚ
,

746 cÚ¡ 
ucc_lib_·¿ms_t
 *
·¿ms
,

747 cÚ¡ 
ucc_lib_cÚfig_h
 
cÚfig
,

748 
ucc_lib_h
 *
lib_p
);

779 
šlše
 
ucc_¡©us_t
 
	$ucc_š™
(cÚ¡ 
ucc_lib_·¿ms_t
 *
·¿ms
,

780 cÚ¡ 
ucc_lib_cÚfig_h
 
cÚfig
,

781 
ucc_lib_h
 *
lib_p
)

783  
	`ucc_š™_v”siÚ
(
UCC_API_MAJOR
, 
UCC_API_MINOR
, 
·¿ms
, 
cÚfig
,

784 
lib_p
);

785 
	}
}

809 
ucc_¡©us_t
 
ucc_fš®ize
(
ucc_lib_h
 
lib_p
);

833 
ucc_¡©us_t
 
ucc_lib_g‘_©Œ
(
ucc_lib_h
 
lib_p
, 
ucc_lib_©Œ_t
 *
lib_©Œ
);

846 
	mUCC_CONTEXT_EXCLUSIVE
 = 0 ,

847 
	mUCC_CONTEXT_SHARED


848 } 
	tucc_cÚ‹xt_ty³_t
;

854 
	eucc_cÚ‹xt_·¿ms_f›ld
 {

855 
	mUCC_CONTEXT_PARAM_FIELD_TYPE
 = 
UCC_BIT
(0),

856 
	mUCC_CONTEXT_PARAM_FIELD_SYNC_TYPE
 = 
UCC_BIT
(1),

857 
	mUCC_CONTEXT_PARAM_FIELD_OOB
 = 
UCC_BIT
(2),

858 
	mUCC_CONTEXT_PARAM_FIELD_ID
 = 
UCC_BIT
(3),

859 
	mUCC_CONTEXT_PARAM_FIELD_MEM_PARAMS
 = 
UCC_BIT
(4)

866 
	eucc_cÚ‹xt_©Œ_f›ld
 {

867 
	mUCC_CONTEXT_ATTR_FIELD_TYPE
 = 
UCC_BIT
(0),

868 
	mUCC_CONTEXT_ATTR_FIELD_SYNC_TYPE
 = 
UCC_BIT
(1),

869 
	mUCC_CONTEXT_ATTR_FIELD_CTX_ADDR
 = 
UCC_BIT
(2),

870 
	mUCC_CONTEXT_ATTR_FIELD_CTX_ADDR_LEN
 = 
UCC_BIT
(3),

871 
	mUCC_CONTEXT_ATTR_FIELD_WORK_BUFFER_SIZE
 = 
UCC_BIT
(4)

879 
	succ_oob_cŞl
 {

880 
ucc_¡©us_t
 (*
®lg©h”
)(*
	m¤c_buf
, *
	m»cv_buf
, 
size_t
 
	msize
,

881 *
	m®lg©h”_šfo
, **
	m»que¡
);

882 
ucc_¡©us_t
 (*
»q_‹¡
)(*
	m»que¡
);

883 
ucc_¡©us_t
 (*
»q_ä“
)(*
	m»que¡
);

884 *
	mcŞl_šfo
;

885 
ušt32_t
 
	mn_oob_•s
;

888 
ušt32_t
 
	moob_•
;

895 } 
	tucc_oob_cŞl_t
;

897 
ucc_oob_cŞl_t
 
	tucc_cÚ‹xt_oob_cŞl_t
;

898 
ucc_oob_cŞl_t
 
	tucc_‹am_oob_cŞl_t
;

904 
	succ_mem_m­
 {

905 * 
	madd»ss
;

906 
size_t
 
	mËn
;

907 } 
	tucc_mem_m­_t
;

913 
	succ_mem_m­_·¿ms
 {

914 
ucc_mem_m­_t
 *
	m£gm’ts
;

915 
ušt64_t
 
	mn_£gm’ts
;

916 } 
	tucc_mem_m­_·¿ms_t
;

940 
	succ_cÚ‹xt_·¿ms
 {

941 
ušt64_t
 
	mmask
;

942 
ucc_cÚ‹xt_ty³_t
 
	mty³
;

943 
ucc_cŞl_sync_ty³_t
 
	msync_ty³
;

944 
ucc_cÚ‹xt_oob_cŞl_t
 
	moob
;

945 
ušt64_t
 
	mùx_id
;

946 
ucc_mem_m­_·¿ms_t
 
	mmem_·¿ms
;

947 } 
	tucc_cÚ‹xt_·¿ms_t
;

968 
	succ_cÚ‹xt_©Œ
 {

969 
ušt64_t
 
	mmask
;

970 
ucc_cÚ‹xt_ty³_t
 
	mty³
;

971 
ucc_cŞl_sync_ty³_t
 
	msync_ty³
;

972 
ucc_cÚ‹xt_addr_h
 
	mùx_addr
;

973 
ucc_cÚ‹xt_addr_Ën_t
 
	mùx_addr_Ën
;

974 
ušt64_t
 
	mglob®_wÜk_bufãr_size
;

975 } 
	tucc_cÚ‹xt_©Œ_t
;

1007 
ucc_¡©us_t
 
ucc_cÚ‹xt_cÚfig_»ad
(
ucc_lib_h
 
lib_hªdË
,

1008 cÚ¡ *
f’ame
,

1009 
ucc_cÚ‹xt_cÚfig_h
 *
cÚfig
);

1030 
ucc_cÚ‹xt_cÚfig_»Ëa£
(
ucc_cÚ‹xt_cÚfig_h
 
cÚfig
);

1054 
ucc_cÚ‹xt_cÚfig_´št
(cÚ¡ 
ucc_cÚ‹xt_cÚfig_h
 
cÚfig
, 
FILE
 *
¡»am
,

1055 cÚ¡ *
t™Ë
, 
ucc_cÚfig_´št_æags_t
 
´št_æags
);

1081 
ucc_¡©us_t
 
ucc_cÚ‹xt_cÚfig_modify
(
ucc_cÚ‹xt_cÚfig_h
 
cÚfig
,

1082 cÚ¡ *
compÚ’t
, cÚ¡ *
Çme
,

1083 cÚ¡ *
v®ue
);

1114 
ucc_¡©us_t
 
ucc_cÚ‹xt_ü—‹
(
ucc_lib_h
 
lib_hªdË
,

1115 cÚ¡ 
ucc_cÚ‹xt_·¿ms_t
 *
·¿ms
,

1116 cÚ¡ 
ucc_cÚ‹xt_cÚfig_h
 
cÚfig
,

1117 
ucc_cÚ‹xt_h
 *
cÚ‹xt
);

1139 
ucc_¡©us_t
 
ucc_cÚ‹xt_´og»ss
(
ucc_cÚ‹xt_h
 
cÚ‹xt
);

1162 
ucc_¡©us_t
 
ucc_cÚ‹xt_de¡roy
(
ucc_cÚ‹xt_h
 
cÚ‹xt
);

1184 
ucc_¡©us_t
 
ucc_cÚ‹xt_g‘_©Œ
(
ucc_cÚ‹xt_h
 
cÚ‹xt
,

1185 
ucc_cÚ‹xt_©Œ_t
 *
cÚ‹xt_©Œ
);

1197 
	eucc_‹am_·¿ms_f›ld
 {

1198 
	mUCC_TEAM_PARAM_FIELD_ORDERING
 = 
UCC_BIT
(0),

1199 
	mUCC_TEAM_PARAM_FIELD_OUTSTANDING_COLLS
 = 
UCC_BIT
(1),

1200 
	mUCC_TEAM_PARAM_FIELD_EP
 = 
UCC_BIT
(2),

1201 
	mUCC_TEAM_PARAM_FIELD_EP_LIST
 = 
UCC_BIT
(3),

1202 
	mUCC_TEAM_PARAM_FIELD_EP_RANGE
 = 
UCC_BIT
(4),

1203 
	mUCC_TEAM_PARAM_FIELD_TEAM_SIZE
 = 
UCC_BIT
(5),

1204 
	mUCC_TEAM_PARAM_FIELD_SYNC_TYPE
 = 
UCC_BIT
(6),

1205 
	mUCC_TEAM_PARAM_FIELD_OOB
 = 
UCC_BIT
(7),

1206 
	mUCC_TEAM_PARAM_FIELD_P2P_CONN
 = 
UCC_BIT
(8),

1207 
	mUCC_TEAM_PARAM_FIELD_MEM_PARAMS
 = 
UCC_BIT
(9),

1208 
	mUCC_TEAM_PARAM_FIELD_EP_MAP
 = 
UCC_BIT
(10),

1209 
	mUCC_TEAM_PARAM_FIELD_ID
 = 
UCC_BIT
(11),

1210 
	mUCC_TEAM_PARAM_FIELD_FLAGS
 = 
UCC_BIT
(12)

1217 
	eucc_‹am_©Œ_f›ld
 {

1218 
	mUCC_TEAM_ATTR_FIELD_POST_ORDERING
 = 
UCC_BIT
(0),

1219 
	mUCC_TEAM_ATTR_FIELD_OUTSTANDING_CALLS
 = 
UCC_BIT
(1),

1220 
	mUCC_TEAM_ATTR_FIELD_EP
 = 
UCC_BIT
(2),

1221 
	mUCC_TEAM_ATTR_FIELD_EP_RANGE
 = 
UCC_BIT
(3),

1222 
	mUCC_TEAM_ATTR_FIELD_SYNC_TYPE
 = 
UCC_BIT
(4),

1223 
	mUCC_TEAM_ATTR_FIELD_MEM_PARAMS
 = 
UCC_BIT
(5),

1224 
	mUCC_TEAM_ATTR_FIELD_SIZE
 = 
UCC_BIT
(6),

1225 
	mUCC_TEAM_ATTR_FIELD_EPS
 = 
UCC_BIT
(7)

1232 
	eucc_‹am_æags
 {

1233 
	mUCC_TEAM_FLAG_COLL_WORK_BUFFER
 = 
UCC_BIT
(0)

1246 
	succ_‹am_p2p_cÚn
 {

1247 (*
	mcÚn_šfo_lookup
)(*
	mcÚn_ùx
, 
ušt64_t
 
	m•
, 
ucc_p2p_cÚn_t
 **
	mcÚn_šfo
, *
	m»que¡
);

1248 (*
	mcÚn_šfo_»Ëa£
)(
ucc_p2p_cÚn_t
 *
	mcÚn_šfo
);

1249 *
	mcÚn_ùx
;

1250 
ucc_¡©us_t
 (*
»q_‹¡
)(*
	m»que¡
);

1251 
ucc_¡©us_t
 (*
»q_ä“
)(*
	m»que¡
);

1252 } 
	tucc_‹am_p2p_cÚn_t
;

1264 
	mUCC_COLLECTIVE_POST_ORDERED
 = 0,

1270 
	mUCC_COLLECTIVE_POST_UNORDERED
 = 1,

1276 
	mUCC_COLLECTIVE_INIT_ORDERED
 = 2,

1282 
	mUCC_COLLECTIVE_INIT_UNORDERED
 = 3,

1288 
	mUCC_COLLECTIVE_INIT_AND_POST_ORDERED
 = 4,

1294 
	mUCC_COLLECTIVE_INIT_AND_POST_UNORDERED
 = 5

1295 } 
	tucc_po¡_Üd”šg_t
;

1302 
	mUCC_COLLECTIVE_EP_RANGE_CONTIG
 = 0,

1303 
	mUCC_COLLECTIVE_EP_RANGE_NONCONTIG
 = 1

1304 } 
	tucc_•_¿nge_ty³_t
;

1310 
	succ_•_m­_¡rided
 {

1311 
ušt64_t
 
	m¡¬t
;

1312 
št64_t
 
	m¡ride
;

1319 
	succ_•_m­_¬¿y
 {

1320 *
	mm­
;

1321 
size_t
 
	m–em_size
;

1328 
	succ_•_m­_cb
 {

1329 
ušt64_t
 (*
cb
)(ušt64_ˆ
	m•
, *
	mcb_ùx
);

1330 *
	mcb_ùx
;

1338 
	mUCC_EP_MAP_FULL
 = 1,

1339 
	mUCC_EP_MAP_STRIDED
 = 2,

1340 
	mUCC_EP_MAP_ARRAY
 = 3,

1342 
	mUCC_EP_MAP_CB
 = 4,

1343 } 
	tucc_•_m­_ty³_t
;

1349 
	succ_•_m­_t
 {

1350 
ucc_•_m­_ty³_t
 
	mty³
;

1351 
ušt64_t
 
	m•_num
;

1353 
ucc_•_m­_¡rided
 
	m¡rided
;

1354 
ucc_•_m­_¬¿y
 
	m¬¿y
;

1355 
ucc_•_m­_cb
 
	mcb
;

1357 } 
	tucc_•_m­_t
;

1382 
	succ_‹am_·¿ms
 {

1384 
ušt64_t
 
	mmask
;

1385 
ušt64_t
 
	mæags
;

1389 
ucc_po¡_Üd”šg_t
 
	mÜd”šg
;

1396 
ušt64_t
 
	mout¡ªdšg_cŞls
;

1403 
ušt64_t
 
	m•
;

1408 
ušt64_t
 *
	m•_li¡
;

1413 
ucc_•_¿nge_ty³_t
 
	m•_¿nge
;

1419 
ušt64_t
 
	m‹am_size
;

1425 
ucc_cŞl_sync_ty³_t
 
	msync_ty³
;

1451 
ucc_‹am_oob_cŞl_t
 
	moob
;

1456 
ucc_‹am_p2p_cÚn_t
 
	mp2p_cÚn
;

1463 
ucc_mem_m­_·¿ms_t
 
	mmem_·¿ms
;

1472 
ucc_•_m­_t
 
	m•_m­
;

1483 
ušt64_t
 
	mid
;

1484 } 
	tucc_‹am_·¿ms_t
;

1505 
	succ_‹am_©Œ
 {

1506 
ušt64_t
 
	mmask
;

1507 
ucc_po¡_Üd”šg_t
 
	mÜd”šg
;

1508 
ušt64_t
 
	mout¡ªdšg_cŞls
;

1509 
ušt64_t
 
	m•
;

1510 
ucc_•_¿nge_ty³_t
 
	m•_¿nge
;

1511 
ucc_cŞl_sync_ty³_t
 
	msync_ty³
;

1512 
ucc_mem_m­_·¿ms_t
 
	mmem_·¿ms
;

1513 
ušt32_t
 
	msize
;

1514 
ušt64_t
 *
	m•s
;

1515 } 
	tucc_‹am_©Œ_t
;

1548 
ucc_¡©us_t
 
ucc_‹am_ü—‹_po¡
(
ucc_cÚ‹xt_h
 *
cÚ‹xts
,

1549 
ušt32_t
 
num_cÚ‹xts
,

1550 cÚ¡ 
ucc_‹am_·¿ms_t
 *
‹am_·¿ms
,

1551 
ucc_‹am_h
 *
Ãw_‹am
);

1574 
ucc_¡©us_t
 
ucc_‹am_ü—‹_‹¡
(
ucc_‹am_h
 
‹am
);

1603 
ucc_¡©us_t
 
ucc_‹am_de¡roy
(
ucc_‹am_h
 
‹am
);

1625 
ucc_¡©us_t
 
ucc_‹am_g‘_©Œ
(
ucc_‹am_h
 
‹am
,

1626 
ucc_‹am_©Œ_t
 *
‹am_©Œ
);

1656 
ucc_¡©us_t
 
ucc_‹am_ü—‹_äom_·»Á
(
ušt64_t
 
my_•
, 
ušt32_t
 
šşuded
,

1657 
ucc_‹am_h
 
·»Á_‹am
,

1658 
ucc_‹am_h
 *
Ãw_‹am
);

1670 
	mUCC_COLL_ARGS_FLAG_IN_PLACE
 = 
UCC_BIT
(0),

1674 
	mUCC_COLL_ARGS_FLAG_PERSISTENT
 = 
UCC_BIT
(1),

1685 
	mUCC_COLL_ARGS_FLAG_COUNT_64BIT
 = 
UCC_BIT
(2),

1688 
	mUCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
 = 
UCC_BIT
(3),

1692 
	mUCC_COLL_ARGS_FLAG_CONTIG_SRC_BUFFER
 = 
UCC_BIT
(4),

1698 
	mUCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
 = 
UCC_BIT
(5),

1704 
	mUCC_COLL_ARGS_FLAG_TIMEOUT
 = 
UCC_BIT
(6),

1713 
	mUCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
 = 
UCC_BIT
(7),

1719 
	mUCC_COLL_ARGS_FLAG_SRC_MEMH_GLOBAL
 = 
UCC_BIT
(8),

1723 
	mUCC_COLL_ARGS_FLAG_DST_MEMH_GLOBAL
 = 
UCC_BIT
(9),

1727 } 
	tucc_cŞl_¬gs_æags_t
;

1733 
	mUCC_COLL_ARGS_HINT_OPTIMIZE_OVERLAP_CPU
 = 
UCC_BIT
(24),

1742 
	mUCC_COLL_ARGS_HINT_OPTIMIZE_OVERLAP_GPU
 = 
UCC_BIT
(25),

1751 
	mUCC_COLL_ARGS_HINT_OPTIMIZE_LATENCY
 = 
UCC_BIT
(26),

1759 
	mUCC_COLL_ARGS_HINT_CONTIG_SRC_BUFFER
 = 
UCC_COLL_ARGS_FLAG_CONTIG_SRC_BUFFER
,

1762 
	mUCC_COLL_ARGS_HINT_CONTIG_DST_BUFFER
 = 
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER


1766 } 
	tucc_cŞl_¬gs_hšts_t
;

1771 
	succ_cŞl_bufãr_šfo_v
 {

1772 *
	mbufãr
;

1773 
ucc_couÁ_t
 *
	mcouÁs
;

1775 
ucc_ašt_t
 *
	mdi¥Ïûm’ts
;

1784 
ucc_d©©y³_t
 
	md©©y³
;

1785 
ucc_memÜy_ty³_t
 
	mmem_ty³
;

1787 } 
	tucc_cŞl_bufãr_šfo_v_t
;

1792 
	succ_cŞl_bufãr_šfo
 {

1793 *
	mbufãr
;

1794 
ucc_couÁ_t
 
	mcouÁ
;

1795 
ucc_d©©y³_t
 
	md©©y³
;

1796 
ucc_memÜy_ty³_t
 
	mmem_ty³
;

1798 } 
	tucc_cŞl_bufãr_šfo_t
;

1804 
	mUCC_ERR_TYPE_LOCAL
 = 0,

1805 
	mUCC_ERR_TYPE_GLOBAL
 = 1

1806 } 
	tucc_”rÜ_ty³_t
;

1811 
	eucc_cŞl_¬gs_f›ld
 {

1812 
	mUCC_COLL_ARGS_FIELD_FLAGS
 = 
UCC_BIT
(0),

1813 
	mUCC_COLL_ARGS_FIELD_TAG
 = 
UCC_BIT
(1),

1814 
	mUCC_COLL_ARGS_FIELD_CB
 = 
UCC_BIT
(2),

1815 
	mUCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
 = 
UCC_BIT
(3),

1816 
	mUCC_COLL_ARGS_FIELD_ACTIVE_SET
 = 
UCC_BIT
(4),

1817 
	mUCC_COLL_ARGS_FIELD_MEM_MAP_SRC_MEMH
 = 
UCC_BIT
(5),

1818 
	mUCC_COLL_ARGS_FIELD_MEM_MAP_DST_MEMH
 = 
UCC_BIT
(6),

1821 *
	tucc_mem_m­_mem_h
;

1856 
	succ_cŞl_¬gs
 {

1857 
ušt64_t
 
	mmask
;

1858 
ucc_cŞl_ty³_t
 
	mcŞl_ty³
;

1860 
ucc_cŞl_bufãr_šfo_t
 
	mšfo
;

1861 
ucc_cŞl_bufãr_šfo_v_t
 
	mšfo_v
;

1862 } 
	m¤c
;

1864 
ucc_cŞl_bufãr_šfo_t
 
	mšfo
;

1865 
ucc_cŞl_bufãr_šfo_v_t
 
	mšfo_v
;

1866 } 
	md¡
;

1867 
ucc_»duùiÚ_İ_t
 
	mİ
;

1872 
ušt64_t
 
	mæags
;

1874 
ušt64_t
 
	mroÙ
;

1876 
ucc_”rÜ_ty³_t
 
	m”rÜ_ty³
;

1877 
ucc_cŞl_id_t
 
	mg
;

1878 *
	mglob®_wÜk_bufãr
;

1888 
ucc_cŞl_ÿÎback_t
 
	mcb
;

1889 
	mtimeout
;

1891 
ušt64_t
 
	m¡¬t
;

1892 
št64_t
 
	m¡ride
;

1893 
ušt64_t
 
	msize
;

1894 } 
	maùive_£t
;

1896 
ucc_mem_m­_mem_h
 
	mloÿl_memh
;

1899 
ucc_mem_m­_mem_h
 *
	mglob®_memh
;

1904 } 
	m¤c_memh
;

1906 
ucc_mem_m­_mem_h
 
	mloÿl_memh
;

1909 
ucc_mem_m­_mem_h
 *
	mglob®_memh
;

1914 } 
	md¡_memh
;

1915 } 
	tucc_cŞl_¬gs_t
;

1944 
ucc_¡©us_t
 
ucc_cŞËùive_š™
(
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
,

1945 
ucc_cŞl_»q_h
 *
»que¡
, 
ucc_‹am_h
 
‹am
);

1967 
ucc_¡©us_t
 
ucc_cŞËùive_po¡
(
ucc_cŞl_»q_h
 
»que¡
);

1995 
ucc_¡©us_t
 
ucc_cŞËùive_š™_ªd_po¡
(
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
,

1996 
ucc_cŞl_»q_h
 *
»que¡
,

1997 
ucc_‹am_h
 
‹am
);

2018 
šlše
 
ucc_¡©us_t
 
	$ucc_cŞËùive_‹¡
(
ucc_cŞl_»q_h
 
»que¡
)

2020  
»que¡
->
¡©us
;

2021 
	}
}

2044 
ucc_¡©us_t
 
ucc_cŞËùive_fš®ize
(
ucc_cŞl_»q_h
 
»que¡
);

2050 
	eucc_ev’t_ty³
 {

2051 
	mUCC_EVENT_COLLECTIVE_POST
 = 
UCC_BIT
(0),

2052 
	mUCC_EVENT_COLLECTIVE_COMPLETE
 = 
UCC_BIT
(1),

2053 
	mUCC_EVENT_COMPUTE_COMPLETE
 = 
UCC_BIT
(2),

2054 
	mUCC_EVENT_OVERFLOW
 = 
UCC_BIT
(3)

2055 } 
	tucc_ev’t_ty³_t
;

2061 
	eucc_“_ty³
 {

2062 
	mUCC_EE_FIRST
 = 0,

2063 
	mUCC_EE_CUDA_STREAM
 = 
UCC_EE_FIRST
,

2064 
	mUCC_EE_CPU_THREAD
,

2065 
	mUCC_EE_ROCM_STREAM
,

2066 
	mUCC_EE_LAST
,

2067 
	mUCC_EE_UNKNOWN
 = 
UCC_EE_LAST


2068 } 
	tucc_“_ty³_t
;

2074 
	succ_ev’t
 {

2075 
ucc_ev’t_ty³_t
 
	mev_ty³
;

2076 * 
	mev_cÚ‹xt
;

2077 
size_t
 
	mev_cÚ‹xt_size
;

2078 
ucc_cŞl_»q_h
 
	m»q
;

2079 } 
	tucc_ev_t
;

2085 
	succ_“_·¿ms
 {

2086 
ucc_“_ty³_t
 
	m“_ty³
;

2087 * 
	m“_cÚ‹xt
;

2088 
size_t
 
	m“_cÚ‹xt_size
;

2089 } 
	tucc_“_·¿ms_t
;

2119 
ucc_¡©us_t
 
ucc_“_ü—‹
(
ucc_‹am_h
 
‹am
, cÚ¡ 
ucc_“_·¿ms_t
 *
·¿ms
,

2120 
ucc_“_h
 *
“
);

2144 
ucc_¡©us_t
 
ucc_“_de¡roy
(
ucc_“_h
 
“
);

2169 
ucc_¡©us_t
 
ucc_“_g‘_ev’t
(
ucc_“_h
 
“
, 
ucc_ev_t
 **
ev
);

2192 
ucc_¡©us_t
 
ucc_“_ack_ev’t
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
);

2215 
ucc_¡©us_t
 
ucc_“_£t_ev’t
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
);

2236 
ucc_¡©us_t
 
ucc_“_wa™
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
ev
);

2260 
ucc_¡©us_t
 
ucc_cŞËùive_Œigg”ed_po¡
(
ucc_“_h
 
“
, 
ucc_ev_t
 *
“_ev’t
);

2266 
	mUCC_MEM_MAP_MODE_EXPORT
 = 0,

2269 
	mUCC_MEM_MAP_MODE_IMPORT
 = 1,

2271 
	mUCC_MEM_MAP_MODE_EXPORT_OFFLOAD
 = 2,

2275 
	mUCC_MEM_MAP_MODE_IMPORT_OFFLOAD
 = 3,

2278 
	mUCC_MEM_MAP_MODE_LAST
 = 4

2279 } 
	tucc_mem_m­_mode_t
;

2304 
ucc_¡©us_t
 
ucc_mem_m­
(
ucc_cÚ‹xt_h
 
cÚ‹xt
, 
ucc_mem_m­_mode_t
 
mode
,

2305 cÚ¡ 
ucc_mem_m­_·¿ms_t
 *
·¿ms
, 
size_t
 *
memh_size
,

2306 
ucc_mem_m­_mem_h
 *
memh
);

2320 
ucc_¡©us_t
 
ucc_mem_unm­
(
ucc_mem_m­_mem_h
 *
memh
);

2322 
	gEND_C_DECLS


	@src/ucc/api/ucc_def.h

9 #iâdeà
UCC_DEF_H_


10 
	#UCC_DEF_H_


	)

12 
	~<ucc/­i/ucc_¡©us.h
>

13 
	~<¡ddef.h
>

14 
	~<¡dšt.h
>

25 
ucc_lib_šfo
* 
	tucc_lib_h
;

38 
ucc_cÚ‹xt
* 
	tucc_cÚ‹xt_h
;

50 
ucc_‹am
* 
	tucc_‹am_h
;

61 
ucc_cŞl_»q
* 
	tucc_cŞl_»q_h
;

62 
	succ_cŞl_»q
 {

63 
ucc_¡©us_t
 
	m¡©us
;

64 } 
	tucc_cŞl_»q_t
;

74 
	succ_cŞl_ÿÎback
 {

75 (*
	mcb
)(*
	md©a
, 
ucc_¡©us_t
 
	m¡©us
);

76 *
	md©a
;

77 } 
	tucc_cŞl_ÿÎback_t
;

85 
ucc_mem_hªdË
* 
	tucc_mem_h
;

92 
ucc_lib_cÚfig
* 
	tucc_lib_cÚfig_h
;

99 
ucc_cÚ‹xt_cÚfig
* 
	tucc_cÚ‹xt_cÚfig_h
;

106 
ušt64_t
 
	tucc_couÁ_t
;

112 
ušt64_t
 
	tucc_ašt_t
;

115 
	#UCC_BIT
(
i
è(1uÈ<< (i))

	)

117 
	#UCC_MASK
(
i
è(
	`UCC_BIT
(iè- 1)

	)

125 
	mUCC_CONFIG_PRINT_CONFIG
 = 
UCC_BIT
(0),

126 
	mUCC_CONFIG_PRINT_HEADER
 = 
UCC_BIT
(1),

127 
	mUCC_CONFIG_PRINT_DOC
 = 
UCC_BIT
(2),

128 
	mUCC_CONFIG_PRINT_HIDDEN
 = 
UCC_BIT
(3)

129 } 
	tucc_cÚfig_´št_æags_t
;

135 
ušt16_t
 
	tucc_cŞl_id_t
 ;

140 *
	tucc_p2p_cÚn_t
;

145 * 
	tucc_cÚ‹xt_addr_h
;

150 
size_t
 
	tucc_cÚ‹xt_addr_Ën_t
;

160 
ucc_“
* 
	tucc_“_h
;

162 
ucc_dt_g’”ic
 
	tucc_dt_g’”ic_t
;

169 
	mUCC_DATATYPE_PREDEFINED
 = 0,

170 
	mUCC_DATATYPE_GENERIC
 = 
UCC_BIT
(0),

171 
	mUCC_DATATYPE_SHIFT
 = 3,

172 
	mUCC_DATATYPE_CLASS_MASK
 = 
UCC_MASK
(
UCC_DATATYPE_SHIFT
)

173 } 
	tucc_dt_ty³_t
;

175 
	#UCC_PREDEFINED_DT
(
_id
) \

176 (
ucc_d©©y³_t
)((((
ušt64_t
)(
_id
)è<< 
UCC_DATATYPE_SHIFT
) | \

177 (
UCC_DATATYPE_PREDEFINED
))

	)

	@src/ucc/api/ucc_status.h

9 #iâdeà
UCC_STATUS_H_


10 
	#UCC_STATUS_H_


	)

12 #ifdeà
__ılu¥lus


13 
	#BEGIN_C_DECLS
 "C" {

	)

14 
	#END_C_DECLS
 }

	)

16 
	#BEGIN_C_DECLS


	)

17 
	#END_C_DECLS


	)

20 
BEGIN_C_DECLS


28 
UCC_OK
 = 0,

30 
UCC_INPROGRESS
 = 1,

32 
UCC_OPERATION_INITIALIZED
 = 2,

35 
UCC_ERR_NOT_SUPPORTED
 = -1,

36 
UCC_ERR_NOT_IMPLEMENTED
 = -2,

37 
UCC_ERR_INVALID_PARAM
 = -3,

38 
UCC_ERR_NO_MEMORY
 = -4,

39 
UCC_ERR_NO_RESOURCE
 = -5,

40 
UCC_ERR_NO_MESSAGE
 = -6,

41 
UCC_ERR_NOT_FOUND
 = -7,

42 
UCC_ERR_TIMED_OUT
 = -8,

43 
UCC_ERR_LAST
 = -100,

44 } 
	tucc_¡©us_t
;

51 cÚ¡ *
ucc_¡©us_¡ršg
(
ucc_¡©us_t
 
¡©us
);

53 
	gEND_C_DECLS


	@src/utils/arch/aarch64/cpu.c

8 #ià
defšed
(
__¯rch64__
)

10 #ifdeà
HAVE_CONFIG_H


11 
	~"cÚfig.h
"

14 
	~"uts/¬ch/ıu.h
"

15 
	~<¡dio.h
>

17 
	$ucc_¯rch64_ıuid_äom_´oc
(
ucc_¯rch64_ıuid_t
 *
ıuid
)

19 
buf
[256];

20 
v®ue
;

21 
FILE
* 
f
;

23 
ıuid
->
im¶em’‹r
 = -1;

24 
ıuid
->
¬ch™eùu»
 = -1;

25 
ıuid
->
v¬ŸÁ
 = -1;

26 
ıuid
->
·¹
 = -1;

27 
ıuid
->
»visiÚ
 = -1;

29 
f
 = 
	`fİ’
("/proc/cpuinfo","r");

30 ià(!
f
) {

34 
	`fg‘s
(
buf
, (buf), 
f
)) {

35 ià(
	`ssÿnf
(
buf
, "CPU im¶em’‹¸: 0x%x", &
v®ue
) == 1) {

36 
ıuid
->
im¶em’‹r
 = 
v®ue
;

37 } ià(
	`ssÿnf
(
buf
, "CPU‡rch™eùu» : %d", &
v®ue
) == 1) {

38 
ıuid
->
¬ch™eùu»
 = 
v®ue
;

39 } ià(
	`ssÿnf
(
buf
, "CPU v¬ŸÁ : 0x%x", &
v®ue
) == 1) {

40 
ıuid
->
v¬ŸÁ
 = 
v®ue
;

41 } ià(
	`ssÿnf
(
buf
, "CPU…¬ˆ: 0x%x", &
v®ue
) == 1) {

42 
ıuid
->
·¹
 = 
v®ue
;

43 } ià(
	`ssÿnf
(
buf
, "CPU„evisiÚ : %d", &
v®ue
) == 1) {

44 
ıuid
->
»visiÚ
 = 
v®ue
;

47 ià((
ıuid
->
im¶em’‹r
 !ğ-1è&& (ıuid->
¬ch™eùu»
 != -1) &&

48 (
ıuid
->
v¬ŸÁ
 !ğ-1è&& (ıuid->
·¹
 !ğ-1è&& (ıuid->
»visiÚ
 != -1)) {

53 
	`fşo£
(
f
);

54 
	}
}

56 
	$ucc_¯rch64_ıuid
(
ucc_¯rch64_ıuid_t
 *
ıuid
)

58 
ucc_¯rch64_ıuid_t
 
ÿched_ıuid
;

59 
š™Ÿlized
 = 0;

61 ià(!
š™Ÿlized
) {

62 
	`ucc_¯rch64_ıuid_äom_´oc
(&
ÿched_ıuid
);

63 
	`ucc_memÜy_ıu_¡Üe_ãnû
();

64 
š™Ÿlized
 = 1;

67 
	`ucc_memÜy_ıu_lßd_ãnû
();

68 *
ıuid
 = 
ÿched_ıuid
;

69 
	}
}

	@src/utils/arch/aarch64/cpu.h

9 #iâdeà
UCC_AARCH64_CPU_H_


10 
	#UCC_AARCH64_CPU_H_


	)

12 
	#UCC_ARCH_CACHE_LINE_SIZE
 64

	)

18 
	#ucc_¯rch64_dmb
(
_İ
è
asm
 vŞ©("dmb " #_İ ::: "memÜy")

	)

19 
	#ucc_¯rch64_isb
(
_İ
è
asm
 vŞ©("isb " #_İ ::: "memÜy")

	)

20 
	#ucc_¯rch64_dsb
(
_İ
è
asm
 vŞ©("dsb " #_İ ::: "memÜy")

	)

30 
	#ucc_memÜy_bus_¡Üe_ãnû
(è
	`ucc_¯rch64_dmb
(
osh¡
)

	)

31 
	#ucc_memÜy_bus_lßd_ãnû
(è
	`ucc_¯rch64_dmb
(
oshld
)

	)

33 
	#ucc_memÜy_ıu_ãnû
(è
	`ucc_¯rch64_dmb
(
ish
)

	)

34 
	#ucc_memÜy_ıu_¡Üe_ãnû
(è
	`ucc_¯rch64_dsb
(
ish¡
)

	)

35 
	#ucc_memÜy_ıu_lßd_ãnû
(è
	`ucc_¯rch64_dmb
(
ishld
)

	)

37 
	succ_¯rch64_ıuid
 {

38 
	mim¶em’‹r
;

39 
	m¬ch™eùu»
;

40 
	mv¬ŸÁ
;

41 
	m·¹
;

42 
	m»visiÚ
;

43 } 
	tucc_¯rch64_ıuid_t
;

48 
ucc_¯rch64_ıuid
(
ucc_¯rch64_ıuid_t
 *
ıuid
);

50 
šlše
 
ucc_ıu_v’dÜ_t
 
	$ucc_¬ch_g‘_ıu_v’dÜ
()

52 
ucc_¯rch64_ıuid_t
 
ıuid
;

53 
	`ucc_¯rch64_ıuid
(&
ıuid
);

55 ià((
ıuid
.
im¶em’‹r
 =ğ0x46è&& (ıuid.
¬ch™eùu»
 == 8)) {

56  
UCC_CPU_VENDOR_FUJITSU_ARM
;

59 ià((
ıuid
.
im¶em’‹r
 =ğ0x41è&& (ıuid.
¬ch™eùu»
 == 8)) {

60  
UCC_CPU_VENDOR_NVIDIA
;

63  
UCC_CPU_VENDOR_GENERIC_ARM
;

64 
	}
}

66 
šlše
 
ucc_ıu_mod–_t
 
	$ucc_¬ch_g‘_ıu_mod–
()

68 
ucc_¯rch64_ıuid_t
 
ıuid
;

69 
	`ucc_¯rch64_ıuid
(&
ıuid
);

71 ià((
	`ucc_¬ch_g‘_ıu_v’dÜ
(è=ğ
UCC_CPU_VENDOR_NVIDIA
) &&

72 (
ıuid
.
·¹
 == 0xd4f)) {

73  
UCC_CPU_MODEL_NVIDIA_GRACE
;

76  
UCC_CPU_MODEL_ARM_AARCH64
;

77 
	}
}

	@src/utils/arch/cpu.h

10 #iâdeà
UCC_ARCH_CPU_H


11 
	#UCC_ARCH_CPU_H


	)

13 #ifdeà
HAVE_CONFIG_H


14 
	~"cÚfig.h
"

17 
	~"uts/ucc_comp”_def.h
"

18 
	~<¡ddef.h
>

21 
	eucc_ıu_mod–
 {

22 
	mUCC_CPU_MODEL_UNKNOWN
,

23 
	mUCC_CPU_MODEL_INTEL_IVYBRIDGE
,

24 
	mUCC_CPU_MODEL_INTEL_SANDYBRIDGE
,

25 
	mUCC_CPU_MODEL_INTEL_NEHALEM
,

26 
	mUCC_CPU_MODEL_INTEL_WESTMERE
,

27 
	mUCC_CPU_MODEL_INTEL_HASWELL
,

28 
	mUCC_CPU_MODEL_INTEL_BROADWELL
,

29 
	mUCC_CPU_MODEL_INTEL_SKYLAKE
,

30 
	mUCC_CPU_MODEL_ARM_AARCH64
,

31 
	mUCC_CPU_MODEL_AMD_NAPLES
,

32 
	mUCC_CPU_MODEL_AMD_ROME
,

33 
	mUCC_CPU_MODEL_AMD_MILAN
,

34 
	mUCC_CPU_MODEL_AMD_GENOA
,

35 
	mUCC_CPU_MODEL_ZHAOXIN_ZHANGJIANG
,

36 
	mUCC_CPU_MODEL_ZHAOXIN_WUDAOKOU
,

37 
	mUCC_CPU_MODEL_ZHAOXIN_LUJIAZUI
,

38 
	mUCC_CPU_MODEL_NVIDIA_GRACE
,

39 
	mUCC_CPU_MODEL_LAST


40 } 
	tucc_ıu_mod–_t
;

43 
	eucc_ıu_v’dÜ
 {

44 
	mUCC_CPU_VENDOR_UNKNOWN
,

45 
	mUCC_CPU_VENDOR_INTEL
,

46 
	mUCC_CPU_VENDOR_AMD
,

47 
	mUCC_CPU_VENDOR_GENERIC_ARM
,

48 
	mUCC_CPU_VENDOR_GENERIC_PPC
,

49 
	mUCC_CPU_VENDOR_GENERIC_RISCV
,

50 
	mUCC_CPU_VENDOR_FUJITSU_ARM
,

51 
	mUCC_CPU_VENDOR_ZHAOXIN
,

52 
	mUCC_CPU_VENDOR_NVIDIA
,

53 
	mUCC_CPU_VENDOR_LAST


54 } 
	tucc_ıu_v’dÜ_t
;

56 
šlše
 
ucc_ıu_v’dÜ_t
 
	$ucc_g‘_v’dÜ_äom_¡r
(cÚ¡ *
v_Çme
)

58 ià(
	`¡rÿ£cmp
(
v_Çme
, "intel") == 0)

59  
UCC_CPU_VENDOR_INTEL
;

60 ià(
	`¡rÿ£cmp
(
v_Çme
, "amd") == 0)

61  
UCC_CPU_VENDOR_AMD
;

62 ià(
	`¡rÿ£cmp
(
v_Çme
, "arm") == 0)

63  
UCC_CPU_VENDOR_GENERIC_ARM
;

64 ià(
	`¡rÿ£cmp
(
v_Çme
, "ppc") == 0)

65  
UCC_CPU_VENDOR_GENERIC_PPC
;

66 ià(
	`¡rÿ£cmp
(
v_Çme
, "riscv") == 0)

67  
UCC_CPU_VENDOR_GENERIC_RISCV
;

68 ià(
	`¡rÿ£cmp
(
v_Çme
, "fujitsu") == 0)

69  
UCC_CPU_VENDOR_FUJITSU_ARM
;

70 ià(
	`¡rÿ£cmp
(
v_Çme
, "zhaoxin") == 0)

71  
UCC_CPU_VENDOR_ZHAOXIN
;

72 ià(
	`¡rÿ£cmp
(
v_Çme
, "nvidia") == 0)

73  
UCC_CPU_VENDOR_NVIDIA
;

74  
UCC_CPU_VENDOR_UNKNOWN
;

75 
	}
}

77 
šlše
 
ucc_ıu_mod–_t
 
	$ucc_g‘_mod–_äom_¡r
(cÚ¡ *
m_Çme
)

79 ià(
	`¡rÿ£cmp
(
m_Çme
, "ivybridge") == 0)

80  
UCC_CPU_MODEL_INTEL_IVYBRIDGE
;

81 ià(
	`¡rÿ£cmp
(
m_Çme
, "sandybridge") == 0)

82  
UCC_CPU_MODEL_INTEL_SANDYBRIDGE
;

83 ià(
	`¡rÿ£cmp
(
m_Çme
, "nehalem") == 0)

84  
UCC_CPU_MODEL_INTEL_NEHALEM
;

85 ià(
	`¡rÿ£cmp
(
m_Çme
, "westmere") == 0)

86  
UCC_CPU_MODEL_INTEL_WESTMERE
;

87 ià(
	`¡rÿ£cmp
(
m_Çme
, "haswell") == 0)

88  
UCC_CPU_MODEL_INTEL_HASWELL
;

89 ià(
	`¡rÿ£cmp
(
m_Çme
, "broadwell") == 0)

90  
UCC_CPU_MODEL_INTEL_BROADWELL
;

91 ià(
	`¡rÿ£cmp
(
m_Çme
, "skylake") == 0)

92  
UCC_CPU_MODEL_INTEL_SKYLAKE
;

93 ià(
	`¡rÿ£cmp
(
m_Çme
, "aarch64") == 0)

94  
UCC_CPU_MODEL_ARM_AARCH64
;

95 ià(
	`¡rÿ£cmp
(
m_Çme
, "naples") == 0)

96  
UCC_CPU_MODEL_AMD_NAPLES
;

97 ià(
	`¡rÿ£cmp
(
m_Çme
, "rome") == 0)

98  
UCC_CPU_MODEL_AMD_ROME
;

99 ià(
	`¡rÿ£cmp
(
m_Çme
, "milan") == 0)

100  
UCC_CPU_MODEL_AMD_MILAN
;

101 ià(
	`¡rÿ£cmp
(
m_Çme
, "genoa") == 0)

102  
UCC_CPU_MODEL_AMD_GENOA
;

103 ià(
	`¡rÿ£cmp
(
m_Çme
, "zhangjiang") == 0)

104  
UCC_CPU_MODEL_ZHAOXIN_ZHANGJIANG
;

105 ià(
	`¡rÿ£cmp
(
m_Çme
, "wudaokou") == 0)

106  
UCC_CPU_MODEL_ZHAOXIN_WUDAOKOU
;

107 ià(
	`¡rÿ£cmp
(
m_Çme
, "lujiazui") == 0)

108  
UCC_CPU_MODEL_ZHAOXIN_LUJIAZUI
;

109 ià(
	`¡rÿ£cmp
(
m_Çme
, "grace") == 0)

110  
UCC_CPU_MODEL_NVIDIA_GRACE
;

111  
UCC_CPU_MODEL_UNKNOWN
;

112 
	}
}

114 #ià
defšed
(
__x86_64__
)

115 
	~"x86_64/ıu.h
"

116 #–ià
defšed
(
__pow”pc64__
)

117 
	~"µc64/ıu.h
"

118 #–ià
defšed
(
__¯rch64__
)

119 
	~"¯rch64/ıu.h
"

120 #–ià
defšed
(
__riscv
è&& (
__riscv_xËn
 == 64)

121 
	~"riscv64/ıu.h
"

126 
	#UCC_CACHE_LINE_SIZE
 
UCC_ARCH_CACHE_LINE_SIZE


	)

	@src/utils/arch/cuda_def.h

7 #iâdeà
UCC_CUDA_DEF_H


8 
	#UCC_CUDA_DEF_H


	)

10 
	~"cÚfig.h
"

12 #ià
HAVE_CUDA


14 
	~"uts/ucc_log.h
"

15 
	~<cuda_ruÁime.h
>

16 
	~<cuda.h
>

18 
šlše
 
ucc_¡©us_t
 
	$cuda_”rÜ_to_ucc_¡©us
(
cudaE¼Ü_t
 
cuda_¡©us
)

20 
ucc_¡©us_t
 
ucc_¡©us
;

22 
cuda_¡©us
) {

23 
cudaSucûss
:

24 
ucc_¡©us
 = 
UCC_OK
;

26 
cudaE¼ÜNÙR—dy
:

27 
ucc_¡©us
 = 
UCC_INPROGRESS
;

29 
cudaE¼ÜInv®idV®ue
:

30 
ucc_¡©us
 = 
UCC_ERR_INVALID_PARAM
;

33 
ucc_¡©us
 = 
UCC_ERR_NO_MESSAGE
;

35  
ucc_¡©us
;

36 
	}
}

38 
	#CUDA_FUNC
(
_func
) \

40 
ucc_¡©us_t
 
_¡©us
; \

42 
cudaE¼Ü_t
 
_»suÉ
 = (
_func
); \

43 ià(
	`ucc_uÆik–y
(
cudaSucûss
 !ğ
_»suÉ
)) { \

44 
	`ucc_”rÜ
("%s() failed: %d(%s)", \

45 #_func, 
_»suÉ
, 
	`cudaG‘E¼ÜSŒšg
(_result)); \

47 
_¡©us
 = 
	`cuda_”rÜ_to_ucc_¡©us
(
_»suÉ
); \

49 
_¡©us
; \

50 })

	)

52 
	#CUDADRV_FUNC
(
_func
) \

54 
ucc_¡©us_t
 
_¡©us
 = 
UCC_OK
; \

56 
CU»suÉ
 
_»suÉ
 = (
_func
); \

57 cÚ¡ *
cu_”r_¡r
; \

58 ià(
	`ucc_uÆik–y
(
CUDA_SUCCESS
 !ğ
_»suÉ
)) { \

59 
	`cuG‘E¼ÜSŒšg
(
_»suÉ
, &
cu_”r_¡r
); \

60 
	`ucc_”rÜ
("%s() failed: %d(%s)", \

61 #_func, 
_»suÉ
, 
cu_”r_¡r
); \

62 
_¡©us
 = 
UCC_ERR_NO_MESSAGE
; \

65 
_¡©us
; \

66 })

	)

68 
	#CUDA_CHECK
(
_cmd
) \

71 
ucc_¡©us_t
 
_cuda_¡©us
 = 
	`CUDA_FUNC
(
_cmd
); \

72 ià(
	`ucc_uÆik–y
(
_cuda_¡©us
 !ğ
UCC_OK
)) { \

73  
_cuda_¡©us
; \

75 } 0)

	)

77 
	#CUDADRV_CHECK
(
_cmd
) \

80 
ucc_¡©us_t
 
_cuda_¡©us
 = 
	`CUDADRV_FUNC
(
_cmd
); \

81 ià(
	`ucc_uÆik–y
(
_cuda_¡©us
 !ğ
UCC_OK
)) { \

82  
_cuda_¡©us
; \

84 } 0)

	)

86 
	#CUDA_CHECK_GOTO
(
_cmd
, 
_Ïb–
, 
_cuda_¡©us
) \

88 
_cuda_¡©us
 = 
	`CUDA_FUNC
(
_cmd
); \

89 ià(
	`ucc_uÆik–y
(
_cuda_¡©us
 !ğ
UCC_OK
)) { \

90 
_Ïb–
; \

92 } 0)

	)

	@src/utils/arch/ppc64/cpu.h

9 #iâdeà
UCC_PPC64_CPU_H_


10 
	#UCC_PPC64_CPU_H_


	)

12 
	#UCC_ARCH_CACHE_LINE_SIZE
 128

	)

15 
	#ucc_memÜy_bus_ãnû
(è
asm
 vŞ©("sync"::: "memÜy")

	)

16 
	#ucc_memÜy_bus_¡Üe_ãnû
(è
	`ucc_memÜy_bus_ãnû
()

	)

17 
	#ucc_memÜy_bus_lßd_ãnû
(è
	`ucc_memÜy_bus_ãnû
()

	)

19 
	#ucc_memÜy_ıu_ãnû
(è
	`ucc_memÜy_bus_ãnû
()

	)

20 
	#ucc_memÜy_ıu_¡Üe_ãnû
(è
asm
 volatile ("lwsync \n" \

21 ::: "memÜy")

	)

22 
	#ucc_memÜy_ıu_lßd_ãnû
(è
asm
 volatile ("lwsync \n" \

24 ::: "memÜy")

	)

26 
šlše
 
ucc_ıu_mod–_t
 
	$ucc_¬ch_g‘_ıu_mod–
()

28  
UCC_CPU_MODEL_UNKNOWN
;

29 
	}
}

31 
šlše
 
ucc_ıu_v’dÜ_t
 
	$ucc_¬ch_g‘_ıu_v’dÜ
()

33  
UCC_CPU_VENDOR_GENERIC_PPC
;

34 
	}
}

	@src/utils/arch/riscv64/cpu.h

9 #iâdeà
UCC_UTILS_ARCH_RISCV64_CPU_H_


10 
	#UCC_UTILS_ARCH_RISCV64_CPU_H_


	)

12 
	#UCC_ARCH_CACHE_LINE_SIZE
 64

	)

15 
	#ucc_memÜy_bus_ãnû
(è
asm
 vŞ©e("ãnû iÜw, iÜw" ::: "memÜy")

	)

16 
	#ucc_memÜy_bus_¡Üe_ãnû
(è
asm
 vŞ©e("ãnû ow, ow" ::: "memÜy")

	)

17 
	#ucc_memÜy_bus_lßd_ãnû
(è
asm
 vŞ©e("ãnû ir, ir" ::: "memÜy")

	)

19 
	#ucc_memÜy_ıu_ãnû
(è
asm
 vŞ©e("ãnû„w,„w" ::: "memÜy")

	)

20 
	#ucc_memÜy_ıu_¡Üe_ãnû
(è
asm
 vŞ©e("ãnû„w, w" ::: "memÜy")

	)

21 
	#ucc_memÜy_ıu_lßd_ãnû
(è
asm
 vŞ©e("ãnû„,„w" ::: "memÜy")

	)

23 
šlše
 
ucc_ıu_mod–_t
 
	$ucc_¬ch_g‘_ıu_mod–
()

25  
UCC_CPU_MODEL_UNKNOWN
;

26 
	}
}

28 
šlše
 
ucc_ıu_v’dÜ_t
 
	$ucc_¬ch_g‘_ıu_v’dÜ
()

30  
UCC_CPU_VENDOR_GENERIC_RISCV
;

31 
	}
}

	@src/utils/arch/rocm_def.h

8 #iâdeà
UCC_ROCM_DEF_H


9 
	#UCC_ROCM_DEF_H


	)

11 
	~"cÚfig.h
"

13 #ià
HAVE_ROCM


15 
	~"uts/ucc_log.h
"

16 
	~<h/h_ruÁime_­i.h
>

18 
	#ROCMCHECK
(
cmd
) do { \

19 
hE¼Ü_t
 
e
 = 
cmd
; \

20 if(
e
 !ğ
hSucûss
) { \

21 
	`ucc_”rÜ
("ROCm faed w™h„‘:%d(%s)", 
e
, \

22 
	`hG‘E¼ÜSŒšg
(
e
)); \

23  
UCC_ERR_NO_MESSAGE
; \

25 } 0)

	)

27 
	#ROCM_FUNC
(
_func
) \

29 
ucc_¡©us_t
 
_¡©us
 = 
UCC_OK
; \

31 
hE¼Ü_t
 
_»suÉ
 = (
_func
); \

32 ià(
hSucûss
 !ğ
_»suÉ
) { \

33 
	`ucc_”rÜ
("%s() failed: %d(%s)", \

34 #_func, 
_»suÉ
, 
	`hG‘E¼ÜSŒšg
(_result)); \

35 
_¡©us
 = 
UCC_ERR_INVALID_PARAM
; \

38 
_¡©us
; \

39 })

	)

	@src/utils/arch/x86_64/cpu.c

9 #ià
defšed
(
__x86_64__
)

11 #ifdeà
HAVE_CONFIG_H


12 
	~"cÚfig.h
"

15 
	~"uts/¬ch/ıu.h
"

17 
	#X86_CPUID_GENUINEINTEL
 "G’uÁ–šeI"

	)

18 
	#X86_CPUID_AUTHENTICAMD
 "AuthcAMD’ti"

	)

19 
	#X86_CPUID_CENTAURHAULS
 "C’ul§urH"

	)

20 
	#X86_CPUID_SHANGHAI
 " Sha˜‡ngh"

	)

21 
	#X86_CPUID_GET_MODEL
 0x00000001u

	)

22 
	#X86_CPUID_GET_BASE_VALUE
 0x00000000u

	)

23 
	#X86_CPUID_GET_EXTD_VALUE
 0x00000007u

	)

24 
	#X86_CPUID_GET_MAX_VALUE
 0x80000000u

	)

25 
	#X86_CPUID_INVARIANT_TSC
 0x80000007u

	)

26 
	#X86_CPUID_GET_CACHE_INFO
 0x00000002u

	)

27 
	#X86_CPUID_GET_LEAF4_INFO
 0x00000004u

	)

29 
	uucc_x86_ıu_»gi¡”s
 {

32 
ušt32_t
 
	m—x
;

33 
ušt8_t
 
	mmax_™”
;

37 
ušt32_t
 
	mebx
;

38 
ušt32_t
 
	mecx
;

39 
ušt32_t
 
	medx
;

41 
	mid
[(
ušt32_t
) * 3];

45 
ušt32_t
 
	mv®ue
;

46 
ušt8_t
 
	mg
[(
ušt32_t
)];

47 } 
	m»g
[4];

48 } 
	tUCC_S_PACKED
 
	tucc_x86_ıu_»gi¡”s
;

51 
	uucc_x86_ıu_v”siÚ
 {

53 
	m¡•pšg
 : 4;

54 
	mmod–
 : 4;

55 
	mçmy
 : 4;

56 
	mty³
 : 2;

57 
	munu£d
 : 2;

58 
	mext_mod–
 : 4;

59 
	mext_çmy
 : 8;

61 
ušt32_t
 
	m»g
;

62 } 
	tUCC_S_PACKED
 
	tucc_x86_ıu_v”siÚ_t
;

64 
UCC_F_NOOPTIMIZE
 
šlše
 
	$ucc_x86_ıuid
(
ušt32_t
 
Ëv–
,

65 
ušt32_t
 *
a
, ušt32_ˆ*
b
,

66 
ušt32_t
 *
c
, ušt32_ˆ*
d
)

68 
asm
 volatile ("cpuid\n\t"

69 : "÷"(*
a
), "=b"(*
b
), "=c"(*
c
), "=d"(*
d
)

70 : "0"(
Ëv–
));

71 
	}
}

73 
ucc_ıu_v’dÜ_t
 
	$ucc_¬ch_g‘_ıu_v’dÜ
()

75 
ucc_x86_ıu_»gi¡”s
 
»g
 = {};

77 
	`ucc_x86_ıuid
(
X86_CPUID_GET_BASE_VALUE
,

78 
	`ucc_uÇligÃd_±r
(&
»g
.
—x
), ucc_uÇligÃd_±r(&»g.
ebx
),

79 
	`ucc_uÇligÃd_±r
(&
»g
.
ecx
), ucc_uÇligÃd_±r(&»g.
edx
));

80 ià(!
	`memcmp
(
»g
.
id
, 
X86_CPUID_GENUINEINTEL
, (X86_CPUID_GENUINEINTEL) - 1)) {

81  
UCC_CPU_VENDOR_INTEL
;

82 } ià(!
	`memcmp
(
»g
.
id
, 
X86_CPUID_AUTHENTICAMD
, (X86_CPUID_AUTHENTICAMD) - 1)) {

83  
UCC_CPU_VENDOR_AMD
;

84 } ià(!
	`memcmp
(
»g
.
id
, 
X86_CPUID_CENTAURHAULS
, (X86_CPUID_CENTAURHAULS) - 1) ||

85 !
	`memcmp
(
»g
.
id
, 
X86_CPUID_SHANGHAI
, (X86_CPUID_SHANGHAI) - 1)) {

86  
UCC_CPU_VENDOR_ZHAOXIN
;

89  
UCC_CPU_VENDOR_UNKNOWN
;

90 
	}
}

92 
ucc_ıu_mod–_t
 
	$ucc_¬ch_g‘_ıu_mod–
()

94 
ucc_x86_ıu_v”siÚ_t
 
v”siÚ
 = {};

95 
ušt32_t
 
_ebx
, 
_ecx
, 
_edx
;

96 
ušt32_t
 
mod–
, 
çmy
;

99 
	`ucc_x86_ıuid
(
X86_CPUID_GET_MODEL
, 
	`ucc_uÇligÃd_±r
(&
v”siÚ
.
»g
),

100 &
_ebx
, &
_ecx
, &
_edx
);

102 
mod–
 = 
v”siÚ
.model;

103 
çmy
 = 
v”siÚ
.family;

106 ià(
çmy
 == 0xf) {

107 
çmy
 +ğ
v”siÚ
.
ext_çmy
;

109 ià((
çmy
 == 0x6) || (family == 0x7) || (family == 0xf) ||

110 (
çmy
 == 0x17) || (family == 0x19)) {

111 
mod–
 = (
v”siÚ
.
ext_mod–
 << 4) | model;

114 ià(
	`ucc_¬ch_g‘_ıu_v’dÜ
(è=ğ
UCC_CPU_VENDOR_ZHAOXIN
) {

115 ià(
çmy
 == 0x06) {

116 
mod–
) {

118  
UCC_CPU_MODEL_ZHAOXIN_ZHANGJIANG
;

122 ià(
çmy
 == 0x07) {

123 
mod–
) {

125  
UCC_CPU_MODEL_ZHAOXIN_WUDAOKOU
;

127  
UCC_CPU_MODEL_ZHAOXIN_LUJIAZUI
;

132 ià(
çmy
 == 0x06) {

133 
mod–
) {

136  
UCC_CPU_MODEL_INTEL_IVYBRIDGE
;

139  
UCC_CPU_MODEL_INTEL_SANDYBRIDGE
;

144  
UCC_CPU_MODEL_INTEL_NEHALEM
;

148  
UCC_CPU_MODEL_INTEL_WESTMERE
;

153  
UCC_CPU_MODEL_INTEL_HASWELL
;

158  
UCC_CPU_MODEL_INTEL_BROADWELL
;

162  
UCC_CPU_MODEL_INTEL_SKYLAKE
;

166 ià(
çmy
 == 0x17) {

167 
mod–
) {

169  
UCC_CPU_MODEL_AMD_NAPLES
;

171  
UCC_CPU_MODEL_AMD_ROME
;

175 ià(
çmy
 == 0x19) {

176 
mod–
) {

179  
UCC_CPU_MODEL_AMD_MILAN
;

181  
UCC_CPU_MODEL_AMD_GENOA
;

186  
UCC_CPU_MODEL_UNKNOWN
;

187 
	}
}

	@src/utils/arch/x86_64/cpu.h

8 #iâdeà
UCC_X86_64_H_


9 
	#UCC_X86_64_H_


	)

11 
	~"uts/ucc_comp”_def.h
"

13 
	#UCC_ARCH_CACHE_LINE_SIZE
 64

	)

19 
	#ucc_memÜy_bus_¡Üe_ãnû
(è
asm
 vŞ©("sãnû" ::: "memÜy")

	)

20 
	#ucc_memÜy_bus_lßd_ãnû
(è
asm
 vŞ©("lãnû" ::: "memÜy")

	)

22 
	#ucc_memÜy_ıu_ãnû
(è
	`ucc_comp”_ãnû
()

	)

23 
	#ucc_memÜy_ıu_¡Üe_ãnû
(è
	`ucc_comp”_ãnû
()

	)

24 
	#ucc_memÜy_ıu_lßd_ãnû
(è
	`ucc_comp”_ãnû
()

	)

26 
ucc_ıu_mod–_t
 
	$ucc_¬ch_g‘_ıu_mod–
(è
UCC_F_NOOPTIMIZE
;

27 
ucc_ıu_v’dÜ_t
 
	`ucc_¬ch_g‘_ıu_v’dÜ
();

	@src/utils/ini.c

9 #ià
defšed
(
_MSC_VER
è&& !defšed(
_CRT_SECURE_NO_WARNINGS
)

10 
	#_CRT_SECURE_NO_WARNINGS


	)

13 #ifdeà
HAVE_CONFIG_H


14 
	~"cÚfig.h
"

17 
	~<¡dio.h
>

18 
	~<ùy³.h
>

19 
	~<¡ršg.h
>

21 
	~"ši.h
"

23 #ià!
UCC_INI_USE_STACK


24 #ià
UCC_INI_CUSTOM_ALLOCATOR


25 
	~<¡ddef.h
>

26 * 
ši_m®loc
(
size_t
 
size
);

27 
ši_ä“
(* 
±r
);

28 * 
ši_»®loc
(* 
±r
, 
size_t
 
size
);

30 
	~<¡dlib.h
>

31 
	#ši_m®loc
 
m®loc


	)

32 
	#ši_ä“
 
ä“


	)

33 
	#ši_»®loc
 
»®loc


	)

37 
	#MAX_SECTION
 128

	)

38 
	#MAX_NAME
 50

	)

42 cÚ¡ * 
	m±r
;

43 
size_t
 
	mnum_Ëá
;

44 } 
	tši_·r£_¡ršg_ùx
;

47 * 
	$r¡r
(* 
s
)

49 * 
p
 = 
s
 + 
	`¡¾’
(s);

50 
p
 > 
s
 && 
	`is¥aû
(()(*--p)))

51 *
p
 = '\0';

52  
s
;

53 
	}
}

56 * 
	$lsk
(cÚ¡ * 
s
)

58 *
s
 && 
	`is¥aû
(()(*s)))

59 
s
++;

60  (*)
s
;

61 
	}
}

66 * 
	$fšd_ch¬s_Ü_comm’t
(cÚ¡ * 
s
, cÚ¡ * 
ch¬s
)

68 #ià
UCC_INI_ALLOW_INLINE_COMMENTS


69 
was_¥aû
 = 0;

70 *
s
 && (!
ch¬s
 || !
	`¡rchr
(chars, *s)) &&

71 !(
was_¥aû
 && 
	`¡rchr
(
UCC_INI_INLINE_COMMENT_PREFIXES
, *
s
))) {

72 
was_¥aû
 = 
	`is¥aû
(()(*
s
));

73 
s
++;

76 *
s
 && (!
ch¬s
 || !
	`¡rchr
(chars, *s))) {

77 
s
++;

80  (*)
s
;

81 
	}
}

85 * 
	$¡ºıy0
(* 
de¡
, cÚ¡ * 
¤c
, 
size_t
 
size
)

88 
size_t
 
i
;

89 
i
 = 0; i < 
size
 - 1 && 
¤c
[i]; i++)

90 
de¡
[
i
] = 
¤c
[i];

91 
de¡
[
i
] = '\0';

92  
de¡
;

93 
	}
}

96 
	$ucc_ši_·r£_¡»am
(
ši_»ad”
 
»ad”
, * 
¡»am
, 
ši_hªdËr
 
hªdËr
,

97 * 
u£r
)

100 #ià
UCC_INI_USE_STACK


101 
lše
[
UCC_INI_MAX_LINE
];

102 
max_lše
 = 
UCC_INI_MAX_LINE
;

104 * 
lše
;

105 
size_t
 
max_lše
 = 
UCC_INI_INITIAL_ALLOC
;

107 #ià
UCC_INI_ALLOW_REALLOC
 && !
UCC_INI_USE_STACK


108 * 
Ãw_lše
;

109 
size_t
 
off£t
;

111 
£ùiÚ
[
MAX_SECTION
] = "";

112 
´ev_Çme
[
MAX_NAME
] = "";

114 * 
¡¬t
;

115 * 
’d
;

116 * 
Çme
;

117 * 
v®ue
;

118 
lš’o
 = 0;

119 
”rÜ
 = 0;

121 #ià!
UCC_INI_USE_STACK


122 
lše
 = (*)
	`ši_m®loc
(
UCC_INI_INITIAL_ALLOC
);

123 ià(!
lše
) {

128 #ià
UCC_INI_HANDLER_LINENO


129 
	#HANDLER
(
u
, 
s
, 
n
, 
v
è
	`hªdËr
(u, s,‚, v, 
lš’o
)

	)

131 
	#HANDLER
(
u
, 
s
, 
n
, 
v
è
	`hªdËr
(u, s,‚, v)

	)

135 
	`»ad”
(
lše
, ()
max_lše
, 
¡»am
è!ğ
NULL
) {

136 #ià
UCC_INI_ALLOW_REALLOC
 && !
INI_USE_STACK


137 
off£t
 = 
	`¡¾’
(
lše
);

138 
off£t
 =ğ
max_lše
 - 1 && 
lše
[offset - 1] != '\n') {

139 
max_lše
 *= 2;

140 ià(
max_lše
 > 
UCC_INI_MAX_LINE
)

141 
max_lše
 = 
UCC_INI_MAX_LINE
;

142 
Ãw_lše
 = 
	`ši_»®loc
(
lše
, 
max_lše
);

143 ià(!
Ãw_lše
) {

144 
	`ši_ä“
(
lše
);

147 
lše
 = 
Ãw_lše
;

148 ià(
	`»ad”
(
lše
 + 
off£t
, ()(
max_lše
 - off£t), 
¡»am
è=ğ
NULL
)

150 ià(
max_lše
 >ğ
UCC_INI_MAX_LINE
)

152 
off£t
 +ğ
	`¡¾’
(
lše
 + offset);

156 
lš’o
++;

158 
¡¬t
 = 
lše
;

159 #ià
UCC_INI_ALLOW_BOM


160 ià(
lš’o
 =ğ1 && ()
¡¬t
[0] == 0xEF &&

161 ()
¡¬t
[1] == 0xBB &&

162 ()
¡¬t
[2] == 0xBF) {

163 
¡¬t
 += 3;

166 
¡¬t
 = 
	`lsk
(
	`r¡r
(start));

168 ià(
	`¡rchr
(
UCC_INI_START_COMMENT_PREFIXES
, *
¡¬t
)) {

171 #ià
UCC_INI_ALLOW_MULTILINE


172 ià(*
´ev_Çme
 && *
¡¬t
 && s¹ > 
lše
) {

175 ià(!
	`HANDLER
(
u£r
, 
£ùiÚ
, 
´ev_Çme
, 
¡¬t
è&& !
”rÜ
)

176 
”rÜ
 = 
lš’o
;

179 ià(*
¡¬t
 == '[') {

181 
’d
 = 
	`fšd_ch¬s_Ü_comm’t
(
¡¬t
 + 1, "]");

182 ià(*
’d
 == ']') {

183 *
’d
 = '\0';

184 
	`¡ºıy0
(
£ùiÚ
, 
¡¬t
 + 1, (section));

185 *
´ev_Çme
 = '\0';

186 #ià
UCC_INI_CALL_HANDLER_ON_NEW_SECTION


187 ià(!
	`HANDLER
(
u£r
, 
£ùiÚ
, 
NULL
, NULLè&& !
”rÜ
)

188 
”rÜ
 = 
lš’o
;

191 ià(!
”rÜ
) {

193 
”rÜ
 = 
lš’o
;

196 ià(*
¡¬t
) {

198 
’d
 = 
	`fšd_ch¬s_Ü_comm’t
(
¡¬t
, "=:");

199 ià(*
’d
 == '=' || *end == ':') {

200 *
’d
 = '\0';

201 
Çme
 = 
	`r¡r
(
¡¬t
);

202 
v®ue
 = 
’d
 + 1;

203 #ià
UCC_INI_ALLOW_INLINE_COMMENTS


204 
’d
 = 
	`fšd_ch¬s_Ü_comm’t
(
v®ue
, 
NULL
);

205 ià(*
’d
)

206 *
’d
 = '\0';

208 
v®ue
 = 
	`lsk
(value);

209 
	`r¡r
(
v®ue
);

212 
	`¡ºıy0
(
´ev_Çme
, 
Çme
, (prev_name));

213 ià(!
	`HANDLER
(
u£r
, 
£ùiÚ
, 
Çme
, 
v®ue
è&& !
”rÜ
)

214 
”rÜ
 = 
lš’o
;

216 ià(!
”rÜ
) {

218 #ià
UCC_INI_ALLOW_NO_VALUE


219 *
’d
 = '\0';

220 
Çme
 = 
	`r¡r
(
¡¬t
);

221 ià(!
	`HANDLER
(
u£r
, 
£ùiÚ
, 
Çme
, 
NULL
è&& !
”rÜ
)

222 
”rÜ
 = 
lš’o
;

224 
”rÜ
 = 
lš’o
;

229 #ià
UCC_INI_STOP_ON_FIRST_ERROR


230 ià(
”rÜ
)

235 #ià!
UCC_INI_USE_STACK


236 
	`ši_ä“
(
lše
);

239  
”rÜ
;

240 
	}
}

243 
	$ucc_ši_·r£_fe
(
FILE
* 
fe
, 
ši_hªdËr
 
hªdËr
, * 
u£r
)

245  
	`ucc_ši_·r£_¡»am
((
ši_»ad”
)
fg‘s
, 
fe
, 
hªdËr
, 
u£r
);

246 
	}
}

249 
	$ucc_ši_·r£
(cÚ¡ * 
f’ame
, 
ši_hªdËr
 
hªdËr
, * 
u£r
)

251 
FILE
* 
fe
;

252 
”rÜ
;

254 
fe
 = 
	`fİ’
(
f’ame
, "r");

255 ià(!
fe
)

257 
”rÜ
 = 
	`ucc_ši_·r£_fe
(
fe
, 
hªdËr
, 
u£r
);

258 
	`fşo£
(
fe
);

259  
”rÜ
;

260 
	}
}

264 * 
	$ši_»ad”_¡ršg
(* 
¡r
, 
num
, * 
¡»am
) {

265 
ši_·r£_¡ršg_ùx
* 
ùx
 = (ši_·r£_¡ršg_ùx*)
¡»am
;

266 cÚ¡ * 
ùx_±r
 = 
ùx
->
±r
;

267 
size_t
 
ùx_num_Ëá
 = 
ùx
->
num_Ëá
;

268 * 
¡½
 = 
¡r
;

269 
c
;

271 ià(
ùx_num_Ëá
 =ğ0 || 
num
 < 2)

272  
NULL
;

274 
num
 > 1 && 
ùx_num_Ëá
 != 0) {

275 
c
 = *
ùx_±r
++;

276 
ùx_num_Ëá
--;

277 *
¡½
++ = 
c
;

278 ià(
c
 == '\n')

280 
num
--;

283 *
¡½
 = '\0';

284 
ùx
->
±r
 = 
ùx_±r
;

285 
ùx
->
num_Ëá
 = 
ùx_num_Ëá
;

286  
¡r
;

287 
	}
}

290 
	$ucc_ši_·r£_¡ršg
(cÚ¡ * 
¡ršg
, 
ši_hªdËr
 
hªdËr
, * 
u£r
) {

291 
ši_·r£_¡ršg_ùx
 
ùx
;

293 
ùx
.
±r
 = 
¡ršg
;

294 
ùx
.
num_Ëá
 = 
	`¡¾’
(
¡ršg
);

295  
	`ucc_ši_·r£_¡»am
((
ši_»ad”
)
ši_»ad”_¡ršg
, &
ùx
, 
hªdËr
,

296 
u£r
);

297 
	}
}

	@src/utils/ini.h

9 #iâdeà
UCC_CONFIG_INI_H


10 
	#UCC_CONFIG_INI_H


	)

13 #ifdeà
__ılu¥lus


17 
	~<¡dio.h
>

20 #iâdeà
UCC_INI_HANDLER_LINENO


21 
	#UCC_INI_HANDLER_LINENO
 0

	)

25 #ià
UCC_INI_HANDLER_LINENO


26 (*
ši_hªdËr
)(* 
	tu£r
, cÚ¡ * 
	t£ùiÚ
,

27 cÚ¡ * 
	tÇme
, cÚ¡ * 
	tv®ue
,

28 
	tlš’o
);

30 (*
ši_hªdËr
)(* 
	tu£r
, cÚ¡ * 
	t£ùiÚ
,

31 cÚ¡ * 
	tÇme
, cÚ¡ * 
	tv®ue
);

35 * (*
	tši_»ad”
)(* 
	t¡r
, 
	tnum
, * 
	t¡»am
);

48 
ucc_ši_·r£
(cÚ¡ * 
f’ame
, 
ši_hªdËr
 
hªdËr
, * 
u£r
);

52 
ucc_ši_·r£_fe
(
FILE
* 
fe
, 
ši_hªdËr
 
hªdËr
, * 
u£r
);

57 
ucc_ši_·r£_¡»am
(
ši_»ad”
 
»ad”
, * 
¡»am
, 
ši_hªdËr
 
hªdËr
,

58 * 
u£r
);

63 
ucc_ši_·r£_¡ršg
(cÚ¡ * 
¡ršg
, 
ši_hªdËr
 
hªdËr
, * 
u£r
);

68 #iâdeà
UCC_INI_ALLOW_MULTILINE


69 
	#UCC_INI_ALLOW_MULTILINE
 1

	)

74 #iâdeà
UCC_INI_ALLOW_BOM


75 
	#UCC_INI_ALLOW_BOM
 1

	)

80 #iâdeà
UCC_INI_START_COMMENT_PREFIXES


81 
	#UCC_INI_START_COMMENT_PREFIXES
 ";#"

	)

87 #iâdeà
UCC_INI_ALLOW_INLINE_COMMENTS


88 
	#UCC_INI_ALLOW_INLINE_COMMENTS
 1

	)

90 #iâdeà
UCC_INI_INLINE_COMMENT_PREFIXES


91 
	#UCC_INI_INLINE_COMMENT_PREFIXES
 ";"

	)

95 #iâdeà
UCC_INI_USE_STACK


96 
	#UCC_INI_USE_STACK
 1

	)

101 #iâdeà
UCC_INI_MAX_LINE


102 
	#UCC_INI_MAX_LINE
 500

	)

108 #iâdeà
UCC_INI_ALLOW_REALLOC


109 
	#UCC_INI_ALLOW_REALLOC
 0

	)

114 #iâdeà
UCC_INI_INITIAL_ALLOC


115 
	#UCC_INI_INITIAL_ALLOC
 200

	)

119 #iâdeà
UCC_INI_STOP_ON_FIRST_ERROR


120 
	#UCC_INI_STOP_ON_FIRST_ERROR
 0

	)

126 #iâdeà
UCC_INI_CALL_HANDLER_ON_NEW_SECTION


127 
	#UCC_INI_CALL_HANDLER_ON_NEW_SECTION
 0

	)

133 #iâdeà
UCC_INI_ALLOW_NO_VALUE


134 
	#UCC_INI_ALLOW_NO_VALUE
 0

	)

141 #iâdeà
UCC_INI_CUSTOM_ALLOCATOR


142 
	#UCC_INI_CUSTOM_ALLOCATOR
 0

	)

146 #ifdeà
__ılu¥lus


	@src/utils/khash.h

117 #iâdeà
__AC_KHASH_H


118 
	#__AC_KHASH_H


	)

126 
	#AC_VERSION_KHASH_H
 "0.2.8"

	)

128 
	~<¡dlib.h
>

129 
	~<¡ršg.h
>

130 
	~<lim™s.h
>

134 #ifdeà
__şªg_ª®yz”__


135 
	~<as£¹.h
>

136 
	#kas£¹
(...è
	`as£¹
(
__VA_ARGS__
)

	)

137 
	#kmem£t_ª®yz”
(
P
, 
Z
, 
N
è
	`kmem£t
(P, Z, N)

	)

139 
	#kas£¹
(...)

	)

140 
	#kmem£t_ª®yz”
(
P
, 
Z
, 
N
)

	)

145 #ià
UINT_MAX
 == 0xffffffffu

146 
	tkhšt32_t
;

147 #–ià
ULONG_MAX
 == 0xffffffffu

148 
	tkhšt32_t
;

151 #ià
ULONG_MAX
 =ğ
ULLONG_MAX


152 
	tkhšt64_t
;

154 
	tkhšt64_t
;

157 #iâdeà
kh_šlše


158 #ifdeà
_MSC_VER


159 
	#kh_šlše
 
__šlše


	)

161 
	#kh_šlše
 
šlše


	)

165 #iâdeà
klib_unu£d


166 #ià(
defšed
 
__şªg__
 && 
__şªg_majÜ__
 >ğ3è|| (defšed 
__GNUC__
 && __GNUC__ >= 3)

167 
	#klib_unu£d
 
	`__©Œibu‹__
 ((
__unu£d__
))

	)

169 
	#klib_unu£d


	)

173 
khšt32_t
 
	tkhšt_t
;

174 
khšt_t
 
	tkh™”_t
;

176 
	#__ac_i£m±y
(
æag
, 
i
è((æag[i>>4]>>((i&0xfU)<<1))&2)

	)

177 
	#__ac_isd–
(
æag
, 
i
è((æag[i>>4]>>((i&0xfU)<<1))&1)

	)

178 
	#__ac_i£™h”
(
æag
, 
i
è((æag[i>>4]>>((i&0xfU)<<1))&3)

	)

179 
	#__ac_£t_isd–_çl£
(
æag
, 
i
è(æag[i>>4]&=~(1ul<<((i&0xfU)<<1)))

	)

180 
	#__ac_£t_i£m±y_çl£
(
æag
, 
i
è(æag[i>>4]&=~(2ul<<((i&0xfU)<<1)))

	)

181 
	#__ac_£t_isbÙh_çl£
(
æag
, 
i
è(æag[i>>4]&=~(3ul<<((i&0xfU)<<1)))

	)

182 
	#__ac_£t_isd–_Œue
(
æag
, 
i
è(æag[i>>4]|=1ul<<((i&0xfU)<<1))

	)

184 
	#__ac_fsize
(
m
è((mè< 16? 1 : (m)>>4)

	)

186 #iâdeà
kroundup32


187 
	#kroundup32
(
x
è(--(x), (x)|=(x)>>1, (x)|=(x)>>2, (x)|=(x)>>4, (x)|=(x)>>8, (x)|=(x)>>16, ++(x))

	)

190 #iâdeà
kÿÎoc


191 
	#kÿÎoc
(
N
,
Z
è
	`ÿÎoc
(N,Z)

	)

193 #iâdeà
km®loc


194 
	#km®loc
(
Z
è
	`m®loc
(Z)

	)

196 #iâdeà
k»®loc


197 
	#k»®loc
(
P
,
Z
è
	`»®loc
(P,Z)

	)

199 #iâdeà
kä“


200 
	#kä“
(
P
è
	`ä“
(P)

	)

202 #iâdeà
kmem£t


203 
	#kmem£t
(
P
,
Z
,
N
è
	`mem£t
(P,Z,N)

	)

206 cÚ¡ 
	g__ac_HASH_UPPER
 = 0.77;

208 
	#__KHASH_TYPE
(
Çme
, 
khkey_t
, 
khv®_t
) \

209 
kh_
##
	tÇme
##
	t_s
 { \

210 
khšt_t
 
n_buck‘s
, 
size
, 
n_occup›d
, 
uµ”_bound
; \

211 
khšt32_t
 *
æags
; \

212 
khkey_t
 *
keys
; \

213 
khv®_t
 *
v®s
; \

214 } 
	tkh_
##
	tÇme
##
	t_t
;

	)

216 
	#__KHASH_PROTOTYPES
(
Çme
, 
khkey_t
, 
khv®_t
) \

217 
kh_
##
Çme
##
_t
 *
kh_š™_
##
	`Çme
(); \

218 
kh_
##
Çme
##
_t
 *
kh_š™_
##Çme##
	`_š¶aû
(kh_##Çme##_ˆ*
h
); \

219 
kh_de¡roy_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
); \

220 
kh_de¡roy_
##
Çme
##
	`_š¶aû
(
kh_
##Çme##
_t
 *
h
); \

221 
kh_ş—r_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
); \

222 
khšt_t
 
kh_g‘_
##
	`Çme
(cÚ¡ 
kh_
##
Çme
##
_t
 *
h
, 
khkey_t
 
key
); \

223 
kh_»size_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
, 
khšt_t
 
Ãw_n_buck‘s
); \

224 
khšt_t
 
kh_put_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
, 
khkey_t
 
key
, *
»t
); \

225 
kh_d–_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
, 
khšt_t
 
x
);

	)

227 
	#__KHASH_IMPL
(
Çme
, 
SCOPE
, 
khkey_t
, 
khv®_t
, 
kh_is_m­
, 
__hash_func
, 
__hash_equ®
) \

228 
SCOPE
 
kh_
##
Çme
##
_t
 *
kh_š™_
##
	`Çme
() { \

229  (
kh_
##
Çme
##
_t
*)
	`kÿÎoc
(1, (kh_##name##_t)); \

231 
SCOPE
 
kh_
##
Çme
##
_t
 *
kh_š™_
##Çme##
	`_š¶aû
(kh_##Çme##_ˆ*
h
) { \

232  (
kh_
##
Çme
##
_t
*)
	`kmem£t
(
h
, 0, (kh_##name##_t)); \

234 
SCOPE
 
kh_de¡roy_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
) \

236 ià(
h
) { \

237 
	`kä“
((*)
h
->
keys
); kä“(h->
æags
); \

238 
	`kä“
((*)
h
->
v®s
); \

239 
	`kä“
(
h
); \

242 
SCOPE
 
kh_de¡roy_
##
Çme
##
	`_š¶aû
(
kh_
##Çme##
_t
 *
h
) \

244 
	`kä“
((*)
h
->
keys
); \

245 
	`kä“
((*)
h
->
æags
); \

246 
	`kä“
((*)
h
->
v®s
); \

248 
SCOPE
 
kh_ş—r_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
) \

250 ià(
h
 && h->
æags
) { \

251 
	`mem£t
(
h
->
æags
, 0x¯, 
	`__ac_fsize
(h->
n_buck‘s
è* (
khšt32_t
)); \

252 
h
->
size
 = h->
n_occup›d
 = 0; \

255 
SCOPE
 
khšt_t
 
kh_g‘_
##
	`Çme
(cÚ¡ 
kh_
##
Çme
##
_t
 *
h
, 
khkey_t
 
key
) \

257 ià(
h
->
n_buck‘s
) { \

258 
khšt_t
 
k
, 
i
, 
Ï¡
, 
mask
, 
¡•
 = 0; \

259 
mask
 = 
h
->
n_buck‘s
 - 1; \

261 
	`kas£¹
(
h
->
æags
 !ğ
NULL
); \

263 
k
 = 
	`__hash_func
(
key
); 
i
 = k & 
mask
; \

264 
Ï¡
 = 
i
; \

265 !
	`__ac_i£m±y
(
h
->
æags
, 
i
è&& (
	`__ac_isd–
(h->æags, iè|| !
	`__hash_equ®
(h->
keys
[i], 
key
))) { \

266 
i
 = (˜+ (++
¡•
)è& 
mask
; \

267 ià(
i
 =ğ
Ï¡
è 
h
->
n_buck‘s
; \

269  
	`__ac_i£™h”
(
h
->
æags
, 
i
)? h->
n_buck‘s
 : i; \

272 
SCOPE
 
kh_»size_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
, 
khšt_t
 
Ãw_n_buck‘s
) \

274 
khšt32_t
 *
Ãw_æags
 = 0; \

275 
khšt_t
 
j
 = 1; \

277 
	`kroundup32
(
Ãw_n_buck‘s
); \

278 ià(
Ãw_n_buck‘s
 < 4)‚ew_n_buckets = 4; \

279 ià(
h
->
size
 >ğ(
khšt_t
)(
Ãw_n_buck‘s
 * 
__ac_HASH_UPPER
 + 0.5)è
j
 = 0; \

281 
Ãw_æags
 = (
khšt32_t
*)
	`km®loc
(
	`__ac_fsize
(
Ãw_n_buck‘s
) * (khint32_t)); \

282 ià(!
Ãw_æags
)  -1; \

283 
	`mem£t
(
Ãw_æags
, 0x¯, 
	`__ac_fsize
(
Ãw_n_buck‘s
è* (
khšt32_t
)); \

284 ià(
h
->
n_buck‘s
 < 
Ãw_n_buck‘s
) { \

285 
khkey_t
 *
Ãw_keys
 = (khkey_t*)
	`k»®loc
((*)
h
->
keys
, 
Ãw_n_buck‘s
 * (khkey_t)); \

286 ià(!
Ãw_keys
è{ 
	`kä“
(
Ãw_æags
);  -1; } \

287 
h
->
keys
 = 
Ãw_keys
; \

288 
	`kmem£t_ª®yz”
(
h
->
keys
 + (h->
n_buck‘s
 * (
khkey_t
)), 0, \

289 (
Ãw_n_buck‘s
 - 
h
->
n_buck‘s
è* (
khkey_t
)); \

290 ià(
kh_is_m­
) { \

291 
khv®_t
 *
Ãw_v®s
 = (khv®_t*)
	`k»®loc
((*)
h
->
v®s
, 
Ãw_n_buck‘s
 * (khval_t)); \

292 ià(!
Ãw_v®s
è{ 
	`kä“
(
Ãw_æags
);  -1; } \

293 
h
->
v®s
 = 
Ãw_v®s
; \

298 ià(
j
) { \

299 
j
 = 0; j !ğ
h
->
n_buck‘s
; ++j) { \

300 ià(
	`__ac_i£™h”
(
h
->
æags
, 
j
) == 0) { \

301 
khkey_t
 
key
 = 
h
->
keys
[
j
]; \

302 
khv®_t
 
v®
; \

303 
khšt_t
 
Ãw_mask
; \

304 
Ãw_mask
 = 
Ãw_n_buck‘s
 - 1; \

305 ià(
kh_is_m­
è
v®
 = 
h
->
v®s
[
j
]; \

306 
	`__ac_£t_isd–_Œue
(
h
->
æags
, 
j
); \

308 
khšt_t
 
k
, 
i
, 
¡•
 = 0; \

309 
k
 = 
	`__hash_func
(
key
); \

310 
i
 = 
k
 & 
Ãw_mask
; \

311 !
	`__ac_i£m±y
(
Ãw_æags
, 
i
)è˜ğ(˜+ (++
¡•
)è& 
Ãw_mask
; \

312 
	`__ac_£t_i£m±y_çl£
(
Ãw_æags
, 
i
); \

313 ià(
i
 < 
h
->
n_buck‘s
 && 
	`__ac_i£™h”
(h->
æags
, i) == 0) { \

314 { 
khkey_t
 
tmp
 = 
h
->
keys
[
i
]; h->keys[i] = 
key
; key =mp; } \

315 ià(
kh_is_m­
è{ 
khv®_t
 
tmp
 = 
h
->
v®s
[
i
]; h->v®s[i] = 
v®
; val =mp; } \

316 
	`__ac_£t_isd–_Œue
(
h
->
æags
, 
i
); \

318 
h
->
keys
[
i
] = 
key
; \

319 ià(
kh_is_m­
è
h
->
v®s
[
i
] = 
v®
; \

325 ià(
h
->
n_buck‘s
 > 
Ãw_n_buck‘s
) { \

326 
h
->
keys
 = (
khkey_t
*)
	`k»®loc
((*)h->keys, 
Ãw_n_buck‘s
 * (khkey_t)); \

327 ià(
kh_is_m­
è
h
->
v®s
 = (
khv®_t
*)
	`k»®loc
((*)h->v®s, 
Ãw_n_buck‘s
 * (khval_t)); \

329 
	`kä“
(
h
->
æags
); \

330 
h
->
æags
 = 
Ãw_æags
; \

331 
h
->
n_buck‘s
 = 
Ãw_n_buck‘s
; \

332 
h
->
n_occup›d
 = h->
size
; \

333 
h
->
uµ”_bound
 = (
khšt_t
)(h->
n_buck‘s
 * 
__ac_HASH_UPPER
 + 0.5); \

337 
SCOPE
 
khšt_t
 
kh_put_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
, 
khkey_t
 
key
, *
»t
) \

339 
khšt_t
 
x
; \

340 ià(
h
->
n_occup›d
 >ğh->
uµ”_bound
) { \

341 ià(
h
->
n_buck‘s
 > (h->
size
<<1)) { \

342 ià(
kh_»size_
##
	`Çme
(
h
, h->
n_buck‘s
 - 1) < 0) { \

343 *
»t
 = -1;  
h
->
n_buck‘s
; \

345 } ià(
kh_»size_
##
	`Çme
(
h
, h->
n_buck‘s
 + 1) < 0) { \

346 *
»t
 = -1;  
h
->
n_buck‘s
; \

350 
	`kas£¹
(
h
->
æags
 !ğ
NULL
); \

353 
khšt_t
 
k
, 
i
, 
s™e
, 
Ï¡
, 
mask
 = 
h
->
n_buck‘s
 - 1, 
¡•
 = 0; \

354 
x
 = 
s™e
 = 
h
->
n_buck‘s
; 
k
 = 
	`__hash_func
(
key
); 
i
 = k & 
mask
; \

355 ià(
	`__ac_i£m±y
(
h
->
æags
, 
i
)è
x
 = i; \

357 
Ï¡
 = 
i
; \

358 !
	`__ac_i£m±y
(
h
->
æags
, 
i
è&& (
	`__ac_isd–
(h->æags, iè|| !
	`__hash_equ®
(h->
keys
[i], 
key
))) { \

359 ià(
	`__ac_isd–
(
h
->
æags
, 
i
)è
s™e
 = i; \

360 
i
 = (˜+ (++
¡•
)è& 
mask
; \

361 ià(
i
 =ğ
Ï¡
è{ 
x
 = 
s™e
; ; } \

363 ià(
x
 =ğ
h
->
n_buck‘s
) { \

364 ià(
	`__ac_i£m±y
(
h
->
æags
, 
i
è&& 
s™e
 !ğh->
n_buck‘s
è
x
 = site; \

365 
x
 = 
i
; \

369 ià(
	`__ac_i£m±y
(
h
->
æags
, 
x
)) { \

370 
h
->
keys
[
x
] = 
key
; \

371 
	`__ac_£t_isbÙh_çl£
(
h
->
æags
, 
x
); \

372 ++
h
->
size
; ++h->
n_occup›d
; \

373 *
»t
 = 1; \

374 } ià(
	`__ac_isd–
(
h
->
æags
, 
x
)) { \

375 
h
->
keys
[
x
] = 
key
; \

376 
	`__ac_£t_isbÙh_çl£
(
h
->
æags
, 
x
); \

377 ++
h
->
size
; \

378 *
»t
 = 2; \

379 } *
»t
 = 0; \

380  
x
; \

382 
SCOPE
 
kh_d–_
##
	`Çme
(
kh_
##
Çme
##
_t
 *
h
, 
khšt_t
 
x
) \

384 ià(
x
 !ğ
h
->
n_buck‘s
 && !
	`__ac_i£™h”
(h->
æags
, x)) { \

385 
	`__ac_£t_isd–_Œue
(
h
->
æags
, 
x
); \

386 --
h
->
size
; \

388 }

	)

390 
	#KHASH_DECLARE
(
Çme
, 
khkey_t
, 
khv®_t
) \

391 
	`__KHASH_TYPE
(
Çme
, 
khkey_t
, 
khv®_t
) \

392 
	`__KHASH_PROTOTYPES
(
Çme
, 
khkey_t
, 
khv®_t
)

	)

394 
	#KHASH_INIT2
(
Çme
, 
SCOPE
, 
khkey_t
, 
khv®_t
, 
kh_is_m­
, 
__hash_func
, 
__hash_equ®
) \

395 
	`__KHASH_TYPE
(
Çme
, 
khkey_t
, 
khv®_t
) \

396 
	`__KHASH_IMPL
(
Çme
, 
SCOPE
, 
khkey_t
, 
khv®_t
, 
kh_is_m­
, 
__hash_func
, 
__hash_equ®
)

	)

398 
	#KHASH_INIT
(
Çme
, 
khkey_t
, 
khv®_t
, 
kh_is_m­
, 
__hash_func
, 
__hash_equ®
) \

399 
	`KHASH_INIT2
(
Çme
, 
kh_šlše
 
klib_unu£d
, 
khkey_t
, 
khv®_t
, 
kh_is_m­
, 
__hash_func
, 
__hash_equ®
)

	)

401 
	#KHASH_TYPE
(
Çme
, 
khkey_t
, 
khv®_t
) \

402 
	`__KHASH_TYPE
(
Çme
, 
khkey_t
, 
khv®_t
)

	)

404 
	#KHASH_IMPL
(
Çme
, 
khkey_t
, 
khv®_t
, 
kh_is_m­
, 
__hash_func
, 
__hash_equ®
) \

405 
	`__KHASH_IMPL
(
Çme
, 
kh_šlše
 
klib_unu£d
, 
khkey_t
, 
khv®_t
, 
kh_is_m­
, 
__hash_func
, 
__hash_equ®
)

	)

414 
	#kh_št_hash_func
(
key
è(
khšt32_t
)(key)

	)

418 
	#kh_št_hash_equ®
(
a
, 
b
è(×è=ğ(b))

	)

424 
	#kh_št64_hash_func
(
key
è(
khšt32_t
)((key)>>33^(key)^(key)<<11)

	)

428 
	#kh_št64_hash_equ®
(
a
, 
b
è(×è=ğ(b))

	)

434 
kh_šlše
 
khšt_t
 
	$__ac_X31_hash_¡ršg
(cÚ¡ *
s
)

436 
khšt_t
 
h
 = (khšt_t)*
s
;

437 ià(
h
è++
s
 ; *s; ++sèh = (h << 5è- h + (
khšt_t
)*s;

438  
h
;

439 
	}
}

445 
	#kh_¡r_hash_func
(
key
è
	`__ac_X31_hash_¡ršg
(key)

	)

449 
	#kh_¡r_hash_equ®
(
a
, 
b
è(
	`¡rcmp
×, bè=ğ0è

	)

451 
kh_šlše
 
khšt_t
 
	$__ac_Wªg_hash
(
khšt_t
 
key
)

453 
key
 += ~(key << 15);

454 
key
 ^= (key >> 10);

455 
key
 += (key << 3);

456 
key
 ^= (key >> 6);

457 
key
 += ~(key << 11);

458 
key
 ^= (key >> 16);

459  
key
;

460 
	}
}

461 
	#kh_št_hash_func2
(
key
è
	`__ac_Wªg_hash
((
khšt_t
)key)

	)

471 
	#khash_t
(
Çme
è
kh_
##Çme##
_t


	)

478 
	#kh_š™
(
Çme
è
kh_š™_
##
	`Çme
()

	)

485 
	#kh_š™_š¶aû
(
Çme
, 
h
è
kh_š™_
##Çme##
	`_š¶aû
(h)

	)

492 
	#kh_de¡roy
(
Çme
, 
h
è
kh_de¡roy_
##
	`Çme
(h)

	)

499 
	#kh_de¡roy_š¶aû
(
Çme
, 
h
è
kh_de¡roy_
##Çme##
	`_š¶aû
(h)

	)

506 
	#kh_ş—r
(
Çme
, 
h
è
kh_ş—r_
##
	`Çme
(h)

	)

514 
	#kh_»size
(
Çme
, 
h
, 
s
è
kh_»size_
##
	`Çme
(h, s)

	)

527 
	#kh_put
(
Çme
, 
h
, 
k
, 
r
è
kh_put_
##
	`Çme
(h, k,„)

	)

529 
	eucs_kh_put
 {

530 
	mUCS_KH_PUT_FAILED
 = -1,

531 
	mUCS_KH_PUT_KEY_PRESENT
 = 0,

532 
	mUCS_KH_PUT_BUCKET_EMPTY
 = 1,

533 
	mUCS_KH_PUT_BUCKET_CLEAR
 = 2

534 } 
	tucs_kh_put_t
;

543 
	#kh_g‘
(
Çme
, 
h
, 
k
è
kh_g‘_
##
	`Çme
(h, k)

	)

551 
	#kh_d–
(
Çme
, 
h
, 
k
è
kh_d–_
##
	`Çme
(h, k)

	)

559 
	#kh_exi¡
(
h
, 
x
è(!
	`__ac_i£™h”
((h)->
æags
, (x)))

	)

567 
	#kh_key
(
h
, 
x
è((h)->
keys
[x])

	)

576 
	#kh_v®
(
h
, 
x
è((h)->
v®s
[x])

	)

581 
	#kh_v®ue
(
h
, 
x
è((h)->
v®s
[x])

	)

588 
	#kh_begš
(
h
è(
khšt_t
)(0)

	)

595 
	#kh_’d
(
h
è((h)->
n_buck‘s
)

	)

602 
	#kh_size
(
h
è((h)->
size
)

	)

609 
	#kh_n_buck‘s
(
h
è((h)->
n_buck‘s
)

	)

618 
	#kh_fÜ—ch
(
h
, 
kv¬
, 
vv¬
, 
code
è{ 
khšt_t
 
__i
; \

619 
__i
 = 
	`kh_begš
(
h
); __˜!ğ
	`kh_’d
(h); ++__i) { \

620 ià(!
	`kh_exi¡
(
h
,
__i
)) ; \

621 (
kv¬
èğ
	`kh_key
(
h
,
__i
); \

622 (
vv¬
èğ
	`kh_v®
(
h
,
__i
); \

623 
code
; \

624 } }

	)

632 
	#kh_fÜ—ch_key
(
h
, 
kv¬
, 
code
è{ 
khšt_t
 
__i
; \

633 
__i
 = 
	`kh_begš
(
h
); __˜!ğ
	`kh_’d
(h); ++__i) { \

634 ià(!
	`kh_exi¡
(
h
,
__i
)) ; \

635 (
kv¬
èğ
	`kh_key
(
h
,
__i
); \

636 
code
; \

637 } }

	)

645 
	#kh_fÜ—ch_v®ue
(
h
, 
vv¬
, 
code
è{ 
khšt_t
 
__i
; \

646 
__i
 = 
	`kh_begš
(
h
); __˜!ğ
	`kh_’d
(h); ++__i) { \

647 ià(!
	`kh_exi¡
(
h
,
__i
)) ; \

648 (
vv¬
èğ
	`kh_v®
(
h
,
__i
); \

649 
code
; \

650 } }

	)

658 
	#KHASH_SET_INIT_INT
(
Çme
) \

659 
	`KHASH_INIT
(
Çme
, 
khšt32_t
, , 0, 
kh_št_hash_func
, 
kh_št_hash_equ®
)

	)

666 
	#KHASH_MAP_INIT_INT
(
Çme
, 
khv®_t
) \

667 
	`KHASH_INIT
(
Çme
, 
khšt32_t
, 
khv®_t
, 1, 
kh_št_hash_func
, 
kh_št_hash_equ®
)

	)

673 
	#KHASH_SET_INIT_INT64
(
Çme
) \

674 
	`KHASH_INIT
(
Çme
, 
khšt64_t
, , 0, 
kh_št64_hash_func
, 
kh_št64_hash_equ®
)

	)

681 
	#KHASH_MAP_INIT_INT64
(
Çme
, 
khv®_t
) \

682 
	`KHASH_INIT
(
Çme
, 
khšt64_t
, 
khv®_t
, 1, 
kh_št64_hash_func
, 
kh_št64_hash_equ®
)

	)

684 cÚ¡ *
	tkh_c¡r_t
;

689 
	#KHASH_SET_INIT_STR
(
Çme
) \

690 
	`KHASH_INIT
(
Çme
, 
kh_c¡r_t
, , 0, 
kh_¡r_hash_func
, 
kh_¡r_hash_equ®
)

	)

697 
	#KHASH_MAP_INIT_STR
(
Çme
, 
khv®_t
) \

698 
	`KHASH_INIT
(
Çme
, 
kh_c¡r_t
, 
khv®_t
, 1, 
kh_¡r_hash_func
, 
kh_¡r_hash_equ®
)

	)

	@src/utils/profile/ucc_profile.c

7 
	~"ucc_´ofe.h
"

8 
	~"uts/ucc_comp”_def.h
"

10 
ucs_´ofe_cÚ‹xt_t
 *
	gucc_´ofe_ùx
;

12 
ucc_¡©us_t
 
	$ucc_´ofe_š™
(
´ofe_mode
, cÚ¡ *
fe_Çme
,

13 
size_t
 
max_fe_size
)

15 
ucs_¡©us_t
 
¡©us
;

17 
¡©us
 = 
	`ucs_´ofe_š™
(
´ofe_mode
, 
fe_Çme
, 
max_fe_size
,

18 &
ucc_´ofe_ùx
);

19  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

20 
	}
}

22 
	$ucc_´ofe_ş—nup
()

24 
	`ucs_´ofe_ş—nup
(
ucc_´ofe_ùx
);

25 
	}
}

	@src/utils/profile/ucc_profile.h

7 #iâdeà
UCC_PROFILE_H_


8 
	#UCC_PROFILE_H_


	)

10 
	~<ucs/´ofe/´ofe_defs.h
>

11 
	~"ucc/­i/ucc_¡©us.h
"

13 #ifdeà
HAVE_PROFILING


14 
	~"ucc_´ofe_Ú.h
"

16 
	~"ucc_´ofe_off.h
"

28 
ucc_¡©us_t
 
ucc_´ofe_š™
(
´ofe_mode
, cÚ¡ *
fe_Çme
,

29 
size_t
 
max_fe_size
);

34 
ucc_´ofe_ş—nup
();

	@src/utils/profile/ucc_profile_core.h

1 #ifdeà
HAVE_PROFILING_CORE


2 
	~"uts/´ofe/ucc_´ofe.h
"

4 
	~"uts/´ofe/ucc_´ofe_off.h
"

6 
	#UCC_CORE_PROFILE_FUNC
 
UCC_PROFILE_FUNC


	)

	@src/utils/profile/ucc_profile_off.h

7 #iâdeà
UCC_PROFILE_OFF_H_


8 
	#UCC_PROFILE_OFF_H_


	)

10 #undeà
UCC_PROFILE_FUNC


11 #undeà
UCC_PROFILE_REQUEST_NEW


12 #undeà
UCC_PROFILE_REQUEST_EVENT


13 #undeà
UCC_PROFILE_REQUEST_FREE


15 
	#UCC_PROFILE_FUNC
(
_»t_ty³
, 
_Çme
, 
_¬gli¡
, ...è_»t_ty³ 
	`_Çme
(
__VA_ARGS__
)

	)

16 
	#UCC_PROFILE_FUNC_VOID
(
_Çme
, 
_¬gli¡
, ...è
	`_Çme
(
__VA_ARGS__
)

	)

17 
	#UCC_PROFILE_REQUEST_NEW
(...è
UCS_EMPTY_STATEMENT


	)

18 
	#UCC_PROFILE_REQUEST_EVENT
(...è
UCS_EMPTY_STATEMENT


	)

19 
	#UCC_PROFILE_REQUEST_FREE
(...è
UCS_EMPTY_STATEMENT


	)

	@src/utils/profile/ucc_profile_on.h

7 #iâdeà
UCC_PROFILE_ON_H_


8 
	#UCC_PROFILE_ON_H_


	)

10 
	~"cÜe/ucc_glob®_İts.h
"

11 
	~<ucs/´ofe/´ofe_Ú.h
>

13 
ucs_´ofe_cÚ‹xt_t
 *
ucc_´ofe_ùx
;

16 #undeà
UCC_PROFILE_FUNC


17 #undeà
UCC_PROFILE_FUNC_VOID


18 #undeà
UCC_PROFILE_REQUEST_NEW


19 #undeà
UCC_PROFILE_REQUEST_EVENT


20 #undeà
UCC_PROFILE_REQUEST_FREE


22 #ifdeà
UCS_PROFILE_LOC_ID_DISABLED


34 
	#UCC_PROFILE_FUNC
(
_»t_ty³
, 
_Çme
, 
_¬gli¡
, ...) \

35 
	`UCS_PROFILE_CTX_FUNC_ALWAYS
(
ucc_´ofe_ùx
, 
_»t_ty³
, 
_Çme
, 
_¬gli¡
, ## 
__VA_ARGS__
)

	)

48 
	#UCC_PROFILE_FUNC_VOID
(
_Çme
, 
_¬gli¡
, ...) \

49 
	`UCS_PROFILE_CTX_FUNC_VOID_ALWAYS
(
ucc_´ofe_ùx
, 
_Çme
, 
_¬gli¡
, ## 
__VA_ARGS__
)

	)

58 
	#UCC_PROFILE_REQUEST_NEW
(
_»q
, 
_Çme
, 
_·¿m32
) \

59 
	`UCS_PROFILE_CTX_RECORD_ALWAYS
(
ucc_´ofe_ùx
, 
UCS_PROFILE_TYPE_REQUEST_NEW
, \

60 (
_Çme
), (
_·¿m32
), (
ušŒ_t
)(
_»q
));

	)

69 
	#UCC_PROFILE_REQUEST_EVENT
(
_»q
, 
_Çme
, 
_·¿m32
) \

70 
	`UCS_PROFILE_CTX_RECORD_ALWAYS
(
ucc_´ofe_ùx
, 
UCS_PROFILE_TYPE_REQUEST_EVENT
, \

71 (
_Çme
), (
_·¿m32
), (
ušŒ_t
)(
_»q
));

	)

78 
	#UCC_PROFILE_REQUEST_FREE
(
_»q
) \

79 
	`UCS_PROFILE_CTX_RECORD_ALWAYS
(
ucc_´ofe_ùx
, 
UCS_PROFILE_TYPE_REQUEST_FREE
, \

80 "", 0, (
ušŒ_t
)(
_»q
));

	)

82 
	#UCC_PROFILE_FUNC
(
_»t_ty³
, 
_Çme
, 
_¬gli¡
, ...) \

83 
	`_UCS_PROFILE_CTX_FUNC
(
ucc_´ofe_ùx
, 
_»t_ty³
, 
_Çme
, 
_¬gli¡
, ## 
__VA_ARGS__
)

	)

85 
	#UCC_PROFILE_FUNC_VOID
(
_Çme
, 
_¬gli¡
, ...) \

86 
	`_UCS_PROFILE_CTX_FUNC_VOID
(
ucc_´ofe_ùx
, 
_Çme
, 
_¬gli¡
, ## 
__VA_ARGS__
)

	)

88 
	#UCC_PROFILE_REQUEST_NEW
(
_»q
, 
_Çme
, 
_·¿m32
) \

89 
	`UCS_PROFILE_CTX_RECORD
(
ucc_´ofe_ùx
, 
UCS_PROFILE_TYPE_REQUEST_NEW
, \

90 (
_Çme
), (
_·¿m32
), (
ušŒ_t
)(
_»q
));

	)

92 
	#UCC_PROFILE_REQUEST_EVENT
(
_»q
, 
_Çme
, 
_·¿m32
) \

93 
	`UCS_PROFILE_CTX_RECORD
(
ucc_´ofe_ùx
, 
UCS_PROFILE_TYPE_REQUEST_EVENT
, \

94 (
_Çme
), (
_·¿m32
), (
ušŒ_t
)(
_»q
));

	)

96 
	#UCC_PROFILE_REQUEST_FREE
(
_»q
) \

97 
	`UCS_PROFILE_CTX_RECORD
(
ucc_´ofe_ùx
, 
UCS_PROFILE_TYPE_REQUEST_FREE
, \

98 "", 0, (
ušŒ_t
)(
_»q
));

	)

	@src/utils/ucc_assert.c

7 
	~"ucc_as£¹.h
"

8 
	~"ucc_log.h
"

9 
	~<¡dio.h
>

19 cÚ¡ * 
	$ucc_ba£Çme
(cÚ¡ *
·th
)

21 cÚ¡ *
Çme
 = 
	`¡¼chr
(
·th
, '/');

23  (
Çme
 =ğ
NULL
è? 
·th
 :‚ame + 1;

24 
	}
}

26 
	$ucc_çl_”rÜ_mes§ge
(cÚ¡ *
fe
, 
lše
,

27 cÚ¡ *
funùiÚ
, *
mes§ge_buf
)

29 *
mes§ge_lše
, *
§ve_±r
 = 
NULL
;

31 
	`ucc_log_æush
();

33 
mes§ge_lše
 = (
mes§ge_buf
 =ğ
NULL
) ? NULL :

34 
	`¡¹ok_r
(
mes§ge_buf
, "\n", &
§ve_±r
);

35 
mes§ge_lše
 !ğ
NULL
) {

36 
	`ucc_log_çl_”rÜ
("%13s:%-4u %s", 
	`ucc_ba£Çme
(
fe
), 
lše
, 
mes§ge_lše
);

37 
mes§ge_lše
 = 
	`¡¹ok_r
(
NULL
, "\n", &
§ve_±r
);

40 
	`abÜt
();

41 
	}
}

43 
	$ucc_çl_”rÜ_fÜm©
(cÚ¡ *
fe
, 
lše
,

44 cÚ¡ *
funùiÚ
, cÚ¡ *
fÜm©
, ...)

46 cÚ¡ 
size_t
 
bufãr_size
 = 
	`ucc_log_g‘_bufãr_size
();

47 *
bufãr
;

48 
va_li¡
 
­
;

50 
bufãr
 = 
	`®loÿ
(
bufãr_size
);

51 
	`va_¡¬t
(
­
, 
fÜm©
);

53 
	`v¢´štf
(
bufãr
, 
bufãr_size
, 
fÜm©
, 
­
);

54 
	`va_’d
(
­
);

56 
	`ucc_çl_”rÜ_mes§ge
(
fe
, 
lše
, 
funùiÚ
, 
bufãr
);

57 
	}
}

	@src/utils/ucc_assert.h

7 #iâdeà
UCC_ASSERT_H


8 
	#UCC_ASSERT_H


	)

10 
	~"ucc_comp”_def.h
"

12 #ià
ENABLE_DEBUG
 =ğ1 || 
UCC_ENABLE_ASSERT
 == 1

13 
	~<as£¹.h
>

14 
	#ucc_as£¹
(
_cÚd
è
	`ucc_as£¹_®ways
(_cÚd)

	)

15 
	#ucc_as£¹_sy¡em
(
_cÚd
è
	`as£¹
(_cÚd)

	)

17 
	#ucc_as£¹
(
_cÚd
)

	)

18 
	#ucc_as£¹_sy¡em
(
_cÚd
)

	)

21 
	gBEGIN_C_DECLS


26 
	#ucc_as£¹_®ways
(
_ex´essiÚ
) \

28 ià(!
	`ucc_lik–y
(
_ex´essiÚ
)) { \

29 
	`ucc_çl_”rÜ_fÜm©
(
__FILE__
, 
__LINE__
, 
__FUNCTION__
, \

32 } 0)

	)

45 
	$ucc_çl_”rÜ_mes§ge
(cÚ¡ *
fe
, 
lše
,

46 cÚ¡ *
funùiÚ
, *
mes§ge_buf
)

47 
UCS_F_NORETURN
;

58 
	$ucc_çl_”rÜ_fÜm©
(cÚ¡ *
fe
, 
lše
,

59 cÚ¡ *
funùiÚ
, cÚ¡ *
fÜm©
, ...)

60 
UCC_F_NORETURN
;

62 
END_C_DECLS


	@src/utils/ucc_atomic.h

6 #iâdeà
UCC_ATOMIC_H_


7 
	#UCC_ATOMIC_H_


	)

9 
	~"cÚfig.h
"

10 
	~<ucs/¬ch/©omic.h
>

12 
	#ucc_©omic_add32
 
ucs_©omic_add32


	)

13 
	#ucc_©omic_çdd32
 
ucs_©omic_çdd32


	)

14 
	#ucc_©omic_çdd8
 
ucs_©omic_çdd8


	)

15 
	#ucc_©omic_sub32
 
ucs_©omic_sub32


	)

16 
	#ucc_©omic_add64
 
ucs_©omic_add64


	)

17 
	#ucc_©omic_sub64
 
ucs_©omic_sub64


	)

18 
	#ucc_©omic_csw­8
 
ucs_©omic_csw­8


	)

19 
	#ucc_©omic_csw­64
 
ucs_©omic_csw­64


	)

20 
	#ucc_©omic_boŞ_csw­8
 
ucs_©omic_boŞ_csw­8


	)

21 
	#ucc_©omic_boŞ_csw­64
 
ucs_©omic_boŞ_csw­64


	)

	@src/utils/ucc_class.h

6 #iâdeà
UCC_CLASS_H_


7 
	#UCC_CLASS_H_


	)

9 
	~"cÚfig.h
"

10 
	~<ucs/ty³/şass.h
>

11 
	~"uts/ucc_comp”_def.h
"

13 
	#UCC_CLASS_DEFINE
 
UCS_CLASS_DEFINE


	)

14 
	#UCC_CLASS_DELETE
 
UCS_CLASS_DELETE


	)

15 
	#UCC_CLASS_CLEANUP_FUNC
 
UCS_CLASS_CLEANUP_FUNC


	)

16 
	#UCC_CLASS_CLEANUP
 
UCS_CLASS_CLEANUP


	)

17 
	#UCC_CLASS_NEW_FUNC_NAME
 
UCS_CLASS_NEW_FUNC_NAME


	)

19 
	#UCC_CLASS_INIT_FUNC
(
_ty³
, ...) \

20 
ucc_¡©us_t
 
	`_UCS_CLASS_INIT_NAME
(
_ty³
)(_ty³ *
£lf
, \

21 
ucs_şass_t
 *
_myşass
, \

22 *
_š™_couÁ
, ## 
__VA_ARGS__
) \

23 

	)

24 
	#UCC_CLASS_DECLARE
(
_ty³
, ...) \

25 
ucs_şass_t
 
	`_UCS_CLASS_DECL_NAME
(
_ty³
); \

26 
	`UCC_CLASS_INIT_FUNC
(
_ty³
, ## 
__VA_ARGS__
); \

27 

	)

28 
	#UCC_CLASS_INIT
(
_ty³
, 
_obj
, ...) \

30 
ucs_şass_t
 *
_şs
 = &
	`_UCS_CLASS_DECL_NAME
(
_ty³
); \

31 
_š™_couÁ”
 = 1; \

32 
ucc_¡©us_t
 
__¡©us
; \

34 
__¡©us
 = 
	`_UCS_CLASS_INIT_NAME
(
_ty³
)((_ty³*)(
_obj
), 
_şs
, \

35 &
_š™_couÁ”
, ## 
__VA_ARGS__
); \

36 ià(
__¡©us
 !ğ
UCC_OK
) { \

37 
	`ucs_şass_ÿÎ_ş—nup_chaš
(&
	`_UCS_CLASS_DECL_NAME
(
_ty³
), \

38 (
_obj
), 
_š™_couÁ”
); \

41 (
__¡©us
); \

42 })

	)

44 
	#UCC_CLASS_NEW
(
_ty³
, 
_obj
, ...) \

45 
	`_UCC_CLASS_NEW
 (
_ty³
, 
_obj
, ## 
__VA_ARGS__
)

	)

47 
	#_UCC_CLASS_NEW
(
_ty³
, 
_obj
, ...) \

49 
ucs_şass_t
 *
şs
 = &
	`_UCS_CLASS_DECL_NAME
(
_ty³
); \

50 
ucc_¡©us_t
 
_¡©us
; \

51 *
obj
; \

53 
obj
 = 
	`ucs_şass_m®loc
(
şs
); \

54 ià(
obj
 !ğ
NULL
) { \

55 
_¡©us
 = 
	`UCC_CLASS_INIT
(
_ty³
, 
obj
, ## 
__VA_ARGS__
); \

56 ià(
_¡©us
 =ğ
UCC_OK
) { \

57 *(
_obj
èğ(
	`ty³of
(*(_obj)))
obj
; \

59 
	`ucs_şass_ä“
(
obj
); \

62 
_¡©us
 = 
UCC_ERR_NO_MEMORY
; \

65 (
_¡©us
); \

66 })

	)

68 
	#UCC_CLASS_CALL_SUPER_INIT
(
_su³rşass
, ...) \

71 
ucc_¡©us_t
 
_¡©us
 = 
	`_UCS_CLASS_INIT_NAME
(
_su³rşass
)( \

72 &
£lf
->
su³r
, 
_myşass
->
su³rşass
, 
_š™_couÁ
, \

73 ##
__VA_ARGS__
); \

74 ià(
	`ucc_uÆik–y
(
_¡©us
 !ğ
UCC_OK
)) { \

75  
_¡©us
; \

77 ià(
_myşass
->
su³rşass
 !ğ&
	`_UCS_CLASS_DECL_NAME
()) { \

78 ++(*
_š™_couÁ
); \

81 }

	)

83 
	#UCC_CLASS_CALL_BASE_INIT
() \

86 ià((
_š™_couÁ
 =ğ
NULL
è|| (
_myşass
 == NULL)) { \

87  
UCC_ERR_INVALID_PARAM
; \

90 }

	)

92 
	#UCC_CLASS_DECLARE_NAMED_NEW_FUNC
(
_Çme
, 
_¬gty³
, ...) \

93 
ucc_¡©us_t
 
	`_Çme
(
	`UCS_PP_FOREACH
( \

94 
_UCS_CLASS_INIT_ARG_DEFINE
, 
_
, \

95 
	`UCS_PP_ZIP
((
	`UCS_PP_SEQ
(
	`UCS_PP_NUM_ARGS
(
__VA_ARGS__
))), (__VA_ARGS__))) \

96 
_¬gty³
 **
obj_p
)

	)

98 
	#UCC_CLASS_DEFINE_NAMED_NEW_FUNC
(
_Çme
, 
_ty³
, 
_¬gty³
, ...) \

99 
	`UCC_CLASS_DECLARE_NAMED_NEW_FUNC
(
_Çme
, 
_¬gty³
, ##
__VA_ARGS__
) \

101 
ucc_¡©us_t
 
¡©us
; \

102 
ucs_¡©us_t
 
ucs_¡©us
; \

103 *
obj_p
 = 
NULL
; \

104 
¡©us
 = 
	`UCC_CLASS_NEW
( \

105 
_ty³
, \

106 
obj_p
 
	`UCS_PP_FOREACH
(
_UCS_CLASS_INIT_ARG_PASS
, 
_
, \

107 
	`UCS_PP_SEQ
(
	`UCS_PP_NUM_ARGS
(
__VA_ARGS__
)))); \

108 
ucs_¡©us
 = 
	`ucc_¡©us_to_ucs_¡©us
(
¡©us
); \

109 
	`ucs_şass_check_Ãw_func_»suÉ
(
ucs_¡©us
, *
obj_p
); \

110  
¡©us
; \

111 }

	)

113 
	#UCC_CLASS_DECLARE_NEW_FUNC
(
_ty³
, 
_¬gty³
, ...) \

114 
	`UCC_CLASS_DECLARE_NAMED_NEW_FUNC
(
	`UCS_CLASS_NEW_FUNC_NAME
(
_ty³
), 
_¬gty³
, \

115 ##
__VA_ARGS__
)

	)

117 
	#UCC_CLASS_DEFINE_NEW_FUNC
(
_ty³
, 
_¬gty³
, ...) \

118 
	`UCC_CLASS_DEFINE_NAMED_NEW_FUNC
(
	`UCS_CLASS_NEW_FUNC_NAME
(
_ty³
), _type, \

119 
_¬gty³
, ##
__VA_ARGS__
)

	)

121 
	#UCC_CLASS_DECLARE_DELETE_FUNC
 
UCS_CLASS_DECLARE_DELETE_FUNC


	)

122 
	#UCC_CLASS_DEFINE_DELETE_FUNC
 
UCS_CLASS_DEFINE_DELETE_FUNC


	)

123 
	#UCC_CLASS_DELETE_FUNC_NAME
 
UCS_CLASS_DELETE_FUNC_NAME


	)

	@src/utils/ucc_coll_utils.c

7 
	~"ucc_cŞl_uts.h
"

8 
	~"compÚ’ts/ba£/ucc_ba£_içû.h
"

9 
	~"cÜe/ucc_‹am.h
"

10 
	~"scheduË/ucc_scheduË_p–šed.h
"

12 
	#STR_TYPE_CHECK
(
_¡r
, 
_p
, 
_´efix
) \

14 ià((0 =ğ
	`¡rÿ£cmp
(
	`_UCC_PP_MAKE_STRING
(
_p
), 
_¡r
))) { \

15  
_´efix
##
_p
; \

17 } 0)

	)

19 
	#STR_COLL_TYPE_CHECK
(
_¡r
, 
_p
è
	`STR_TYPE_CHECK
(_¡r, _p, 
UCC_COLL_TYPE_
)

	)

21 
ucc_cŞl_ty³_t
 
	$ucc_cŞl_ty³_äom_¡r
(cÚ¡ *
¡r
)

23 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
ALLGATHER
);

24 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
ALLGATHERV
);

25 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
ALLREDUCE
);

26 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
ALLTOALL
);

27 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
ALLTOALLV
);

28 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
BARRIER
);

29 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
BCAST
);

30 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
FANIN
);

31 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
FANOUT
);

32 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
GATHER
);

33 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
GATHERV
);

34 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
REDUCE
);

35 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
REDUCE_SCATTER
);

36 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
REDUCE_SCATTERV
);

37 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
SCATTER
);

38 
	`STR_COLL_TYPE_CHECK
(
¡r
, 
SCATTERV
);

39  
UCC_COLL_TYPE_LAST
;

40 
	}
}

42 
	#STR_MEM_TYPE_CHECK
(
_¡r
, 
_p
) \

44 ià(0 =ğ
	`¡rÿ£cmp
("CudaMªaged", 
_¡r
)) { \

45 
	`STR_TYPE_CHECK
("cuda_mªaged", 
_p
, 
UCC_MEMORY_TYPE_
); \

46 } ià(0 =ğ
	`¡rÿ£cmp
("RocmMªaged", 
_¡r
)) { \

47 
	`STR_TYPE_CHECK
("rocm_mªaged", 
_p
, 
UCC_MEMORY_TYPE_
); \

49 
	`STR_TYPE_CHECK
(
_¡r
, 
_p
, 
UCC_MEMORY_TYPE_
); \

50 } 0)

	)

52 
ucc_memÜy_ty³_t
 
	$ucc_mem_ty³_äom_¡r
(cÚ¡ *
¡r
)

54 
	`STR_MEM_TYPE_CHECK
(
¡r
, 
HOST
);

55 
	`STR_MEM_TYPE_CHECK
(
¡r
, 
CUDA
);

56 
	`STR_MEM_TYPE_CHECK
(
¡r
, 
CUDA_MANAGED
);

57 
	`STR_MEM_TYPE_CHECK
(
¡r
, 
ROCM
);

58 
	`STR_MEM_TYPE_CHECK
(
¡r
, 
ROCM_MANAGED
);

59  
UCC_MEMORY_TYPE_LAST
;

60 
	}
}

63 
	$ucc_cŞl_¬gs_is_mem_symm‘ric
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

64 
ucc_¿nk_t
 
¿nk
)

66 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

68 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

71 
¬gs
->
cŞl_ty³
) {

72 
UCC_COLL_TYPE_BARRIER
:

73 
UCC_COLL_TYPE_BCAST
:

74 
UCC_COLL_TYPE_FANIN
:

75 
UCC_COLL_TYPE_FANOUT
:

77 
UCC_COLL_TYPE_ALLTOALL
:

78 
UCC_COLL_TYPE_ALLREDUCE
:

79 
UCC_COLL_TYPE_ALLGATHER
:

80 
UCC_COLL_TYPE_REDUCE_SCATTER
:

81  
¬gs
->
d¡
.
šfo
.
mem_ty³
 =ğ¬gs->
¤c
.info.mem_type;

82 
UCC_COLL_TYPE_ALLGATHERV
:

83 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

84  
¬gs
->
d¡
.
šfo_v
.
mem_ty³
 =ğ¬gs->
¤c
.
šfo
.mem_type;

85 
UCC_COLL_TYPE_ALLTOALLV
:

86  
¬gs
->
d¡
.
šfo_v
.
mem_ty³
 =ğ¬gs->
¤c
.info_v.mem_type;

87 
UCC_COLL_TYPE_REDUCE
:

88 
UCC_COLL_TYPE_GATHER
:

89 
UCC_COLL_TYPE_SCATTER
:

90  
roÙ
 !ğ
¿nk
 ||

91 (
¬gs
->
d¡
.
šfo
.
mem_ty³
 =ğ¬gs->
¤c
.info.mem_type);

92 
UCC_COLL_TYPE_GATHERV
:

93  
roÙ
 !ğ
¿nk
 ||

94 (
¬gs
->
d¡
.
šfo_v
.
mem_ty³
 =ğ¬gs->
¤c
.
šfo
.mem_type);

95 
UCC_COLL_TYPE_SCATTERV
:

96  
roÙ
 !ğ
¿nk
 ||

97 (
¬gs
->
d¡
.
šfo
.
mem_ty³
 =ğ¬gs->
¤c
.
šfo_v
.mem_type);

102 
	}
}

108 
ucc_¡©us_t


109 
	$ucc_cŞl_¬gs_š™_asymm‘ric_bufãr
(
ucc_cŞl_¬gs_t
 *
¬gs
,

110 
ucc_‹am_h
 
‹am
,

111 
ucc_bufãr_šfo_asymm‘ric_memty³_t
 *
§ve_šfo
)

113 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

115 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

116  
UCC_ERR_INVALID_PARAM
;

118 
¬gs
->
cŞl_ty³
) {

119 
UCC_COLL_TYPE_REDUCE
:

120 
UCC_COLL_TYPE_GATHER
:

122 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
¤c
.
šfo
.mem_type;

123 ià(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTERV
) {

124 
mem_ty³
 = 
¬gs
->
¤c
.
šfo_v
.mem_type;

126 
	`memıy
(&
§ve_šfo
->
Şd_asymm‘ric_bufãr
.
šfo
,

127 &
¬gs
->
d¡
.
šfo
, (
ucc_cŞl_bufãr_šfo_t
));

128 
¡©us
 = 
	`ucc_mc_®loc
(&
§ve_šfo
->
sü©ch
,

129 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo
.
d©©y³
) *

130 
¬gs
->
d¡
.
šfo
.
couÁ
,

131 
mem_ty³
);

132 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

133 
	`ucc_”rÜ
("failedo‡llocate„eplacement "

135  
¡©us
;

137 
¬gs
->
d¡
.
šfo
.
bufãr
 = 
§ve_šfo
->
sü©ch
->
addr
;

138 
¬gs
->
d¡
.
šfo
.
mem_ty³
 = mem_type;

139  
UCC_OK
;

141 
UCC_COLL_TYPE_GATHERV
:

143 
	`memıy
(&
§ve_šfo
->
Şd_asymm‘ric_bufãr
.
šfo_v
,

144 &
¬gs
->
d¡
.
šfo_v
, (
ucc_cŞl_bufãr_šfo_v_t
));

145 
¡©us
 = 
	`ucc_mc_®loc
(&
§ve_šfo
->
sü©ch
,

146 
	`ucc_cŞl_¬gs_g‘_v_bufãr_size
(
¬gs
,

147 
¬gs
->
d¡
.
šfo_v
.
couÁs
,

148 
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
,

149 
‹am
->
size
),

150 
¬gs
->
¤c
.
šfo
.
mem_ty³
);

151 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

152 
	`ucc_”rÜ
("failedo‡llocate„eplacement "

154  
¡©us
;

156 
¬gs
->
d¡
.
šfo_v
.
bufãr
 = 
§ve_šfo
->
sü©ch
->
addr
;

157 
¬gs
->
d¡
.
šfo_v
.
mem_ty³
 =‡rgs->
¤c
.
šfo
.mem_type;

158  
UCC_OK
;

160 
UCC_COLL_TYPE_SCATTER
:

162 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
d¡
.
šfo
.mem_type;

163 
	`memıy
(&
§ve_šfo
->
Şd_asymm‘ric_bufãr
.
šfo
,

164 &
¬gs
->
¤c
.
šfo
, (
ucc_cŞl_bufãr_šfo_t
));

165 
¡©us
 = 
	`ucc_mc_®loc
(&
§ve_šfo
->
sü©ch
,

166 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
è*‡rgs->¤c.šfo.
couÁ
,

167 
mem_ty³
);

168 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

169 
	`ucc_”rÜ
("failedo‡llocate„eplacement "

171  
¡©us
;

173 
¬gs
->
¤c
.
šfo
.
bufãr
 = 
§ve_šfo
->
sü©ch
->
addr
;

174 
¬gs
->
¤c
.
šfo
.
mem_ty³
 = mem_type;

175  
UCC_OK
;

177 
UCC_COLL_TYPE_SCATTERV
:

179 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¬gs
->
d¡
.
šfo
.mem_type;

180 
	`memıy
(&
§ve_šfo
->
Şd_asymm‘ric_bufãr
.
šfo_v
,

181 &
¬gs
->
¤c
.
šfo_v
, (
ucc_cŞl_bufãr_šfo_v_t
));

182 
¡©us
 = 
	`ucc_mc_®loc
(&
§ve_šfo
->
sü©ch
,

183 
	`ucc_cŞl_¬gs_g‘_v_bufãr_size
(
¬gs
,

184 
¬gs
->
¤c
.
šfo_v
.
couÁs
,

185 
¬gs
->
¤c
.
šfo_v
.
di¥Ïûm’ts
,

186 
‹am
->
size
),

187 
mem_ty³
);

188 ià(
	`ucc_uÆik–y
(
UCC_OK
 !ğ
¡©us
)) {

189 
	`ucc_”rÜ
("failedo‡llocate„eplacement "

191  
¡©us
;

193 
¬gs
->
¤c
.
šfo_v
.
bufãr
 = 
§ve_šfo
->
sü©ch
->
addr
;

194 
¬gs
->
¤c
.
šfo_v
.
mem_ty³
 = mem_type;

195  
UCC_OK
;

200  
UCC_ERR_INVALID_PARAM
;

201 
	}
}

203 
ucc_¡©us_t


204 
	$ucc_cŞl_¬gs_ä“_asymm‘ric_bufãr
(
ucc_cŞl_sk_t
 *
sk
)

206 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

207 
ucc_bufãr_šfo_asymm‘ric_memty³_t
 *
§ve
 = &
sk
->
b¬gs
.
asymm‘ric_§ve_šfo
;

209 ià(
	`UCC_IS_INPLACE
(
sk
->
b¬gs
.
¬gs
)) {

210  
UCC_ERR_INVALID_PARAM
;

213 ià(
§ve
->
sü©ch
 =ğ
NULL
) {

214 
	`ucc_”rÜ
("failureryingo free NULL‡symmetric buffer");

215  
UCC_ERR_INVALID_PARAM
;

218 
¡©us
 = 
	`ucc_mc_ä“
(
§ve
->
sü©ch
);

219 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

220 
	`ucc_”rÜ
("error freeing scratch‡symmetric buffer: %s",

221 
	`ucc_¡©us_¡ršg
(
¡©us
));

223 
§ve
->
sü©ch
 = 
NULL
;

225  
¡©us
;

226 
	}
}

228 
ucc_¡©us_t
 
	$ucc_cİy_asymm‘ric_bufãr
(
ucc_cŞl_sk_t
 *
sk
)

230 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

231 
ucc_cŞl_¬gs_t
 *
cŞl_¬gs
 = &
sk
->
b¬gs
.
¬gs
;

232 
ucc_bufãr_šfo_asymm‘ric_memty³_t
 *
§ve
 = &
sk
->
b¬gs
.
asymm‘ric_§ve_šfo
;

233 
ucc_¿nk_t
 
size
 = 
sk
->
‹am
->
·¿ms
.size;

235 if(
sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTERV
) {

237 
¡©us
 = 
	`ucc_mc_memıy
(
§ve
->
sü©ch
->
addr
,

238 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo_v
.
bufãr
,

239 
	`ucc_cŞl_¬gs_g‘_v_bufãr_size
(
cŞl_¬gs
,

240 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo_v
.
couÁs
,

241 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo_v
.
di¥Ïûm’ts
,

242 
size
),

243 
§ve
->
sü©ch
->
mt
,

244 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo_v
.
mem_ty³
);

245 } if(
sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTER
) {

247 
¡©us
 = 
	`ucc_mc_memıy
(
§ve
->
sü©ch
->
addr
,

248 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo
.
bufãr
,

249 
	`ucc_dt_size
(
§ve
->
Şd_asymm‘ric_bufãr
.
šfo
.
d©©y³
) *

250 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo
.
couÁ
,

251 
§ve
->
sü©ch
->
mt
,

252 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo
.
mem_ty³
);

253 } if(
sk
->
b¬gs
.
¬gs
.
cŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHERV
) {

255 
¡©us
 = 
	`ucc_mc_memıy
(
§ve
->
Şd_asymm‘ric_bufãr
.
šfo_v
.
bufãr
,

256 
§ve
->
sü©ch
->
addr
,

257 
	`ucc_cŞl_¬gs_g‘_v_bufãr_size
(
cŞl_¬gs
,

258 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo_v
.
couÁs
,

259 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo_v
.
di¥Ïûm’ts
,

260 
size
),

261 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo_v
.
mem_ty³
,

262 
§ve
->
sü©ch
->
mt
);

265 
¡©us
 = 
	`ucc_mc_memıy
(
§ve
->
Şd_asymm‘ric_bufãr
.
šfo
.
bufãr
,

266 
§ve
->
sü©ch
->
addr
,

267 
	`ucc_dt_size
(
§ve
->
Şd_asymm‘ric_bufãr
.
šfo
.
d©©y³
) *

268 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo
.
couÁ
,

269 
§ve
->
Şd_asymm‘ric_bufãr
.
šfo
.
mem_ty³
,

270 
§ve
->
sü©ch
->
mt
);

272 ià(
	`ucc_uÆik–y
(
¡©us
 !ğ
UCC_OK
)) {

273 
	`ucc_”rÜ
("error copying backo old‡symmetric buffer: %s",

274 
	`ucc_¡©us_¡ršg
(
¡©us
));

276  
¡©us
;

277 
	}
}

279 
	$ucc_cŞl_¬gs_is_´edefšed_dt
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
, 
ucc_¿nk_t
 
¿nk
)

281 
¬gs
->
cŞl_ty³
) {

282 
UCC_COLL_TYPE_BARRIER
:

283 
UCC_COLL_TYPE_FANIN
:

284 
UCC_COLL_TYPE_FANOUT
:

286 
UCC_COLL_TYPE_ALLREDUCE
:

287 
UCC_COLL_TYPE_REDUCE_SCATTER
:

288 
UCC_COLL_TYPE_ALLGATHER
:

289 
UCC_COLL_TYPE_ALLTOALL
:

290  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
d¡
.
šfo
.
d©©y³
) &&

291 (
	`UCC_IS_INPLACE
(*
¬gs
) ||

292 
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo
.
d©©y³
));

293 
UCC_COLL_TYPE_ALLGATHERV
:

294 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

295  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
) &&

296 (
	`UCC_IS_INPLACE
(*
¬gs
) ||

297 
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo
.
d©©y³
));

298 
UCC_COLL_TYPE_ALLTOALLV
:

299  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
) &&

300 (
	`UCC_IS_INPLACE
(*
¬gs
) ||

301 
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
));

302 
UCC_COLL_TYPE_BCAST
:

303  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

304 
UCC_COLL_TYPE_GATHER
:

305 
UCC_COLL_TYPE_REDUCE
:

306 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
¿nk
)) {

307  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
d¡
.
šfo
.
d©©y³
) &&

308 (
	`UCC_IS_INPLACE
(*
¬gs
) ||

309 
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo
.
d©©y³
));

311  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

313 
UCC_COLL_TYPE_GATHERV
:

314 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
¿nk
)) {

315  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
) &&

316 (
	`UCC_IS_INPLACE
(*
¬gs
) ||

317 
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo
.
d©©y³
));

319  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

321 
UCC_COLL_TYPE_SCATTER
:

322 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
¿nk
)) {

323  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo
.
d©©y³
) &&

324 (
	`UCC_IS_INPLACE
(*
¬gs
) ||

325 
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
d¡
.
šfo
.
d©©y³
));

327  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

329 
UCC_COLL_TYPE_SCATTERV
:

330 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
¿nk
)) {

331  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
¤c
.
šfo_v
.
d©©y³
) &&

332 (
	`UCC_IS_INPLACE
(*
¬gs
) ||

333 
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
d¡
.
šfo
.
d©©y³
));

335  
	`UCC_DT_IS_PREDEFINED
(
¬gs
->
d¡
.
šfo
.
d©©y³
);

338 
	`ucc_”rÜ
("šv®id cŞËùivty³ %d", 
¬gs
->
cŞl_ty³
);

341 
	}
}

343 
ucc_memÜy_ty³_t
 
	$ucc_cŞl_¬gs_mem_ty³
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

344 
ucc_¿nk_t
 
¿nk
)

346 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

348 
¬gs
->
cŞl_ty³
) {

349 
UCC_COLL_TYPE_BARRIER
:

350 
UCC_COLL_TYPE_FANIN
:

351 
UCC_COLL_TYPE_FANOUT
:

352  
UCC_MEMORY_TYPE_NOT_APPLY
;

353 
UCC_COLL_TYPE_BCAST
:

354  
¬gs
->
¤c
.
šfo
.
mem_ty³
;

355 
UCC_COLL_TYPE_ALLTOALL
:

356 
UCC_COLL_TYPE_ALLREDUCE
:

357 
UCC_COLL_TYPE_ALLGATHER
:

358 
UCC_COLL_TYPE_REDUCE_SCATTER
:

359  
¬gs
->
d¡
.
šfo
.
mem_ty³
;

360 
UCC_COLL_TYPE_ALLGATHERV
:

361 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

362 
UCC_COLL_TYPE_ALLTOALLV
:

363  
¬gs
->
d¡
.
šfo_v
.
mem_ty³
;

364 
UCC_COLL_TYPE_REDUCE
:

365 
UCC_COLL_TYPE_GATHER
:

366  (
roÙ
 =ğ
¿nk
è? 
¬gs
->
d¡
.
šfo
.
mem_ty³


367 : 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

368 
UCC_COLL_TYPE_SCATTER
:

369  (
roÙ
 =ğ
¿nk
è? 
¬gs
->
¤c
.
šfo
.
mem_ty³


370 : 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

371 
UCC_COLL_TYPE_GATHERV
:

372  (
roÙ
 =ğ
¿nk
è? 
¬gs
->
d¡
.
šfo_v
.
mem_ty³


373 : 
¬gs
->
¤c
.
šfo
.
mem_ty³
;

374 
UCC_COLL_TYPE_SCATTERV
:

375  (
roÙ
 =ğ
¿nk
è? 
¬gs
->
¤c
.
šfo_v
.
mem_ty³


376 : 
¬gs
->
d¡
.
šfo
.
mem_ty³
;

380  
UCC_MEMORY_TYPE_UNKNOWN
;

381 
	}
}

383 
size_t
 
	$ucc_cŞl_¬gs_msgsize
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
, 
ucc_¿nk_t
 
¿nk
,

384 
ucc_¿nk_t
 
size
)

386 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

388 
¬gs
->
cŞl_ty³
) {

389 
UCC_COLL_TYPE_BARRIER
:

390 
UCC_COLL_TYPE_FANIN
:

391 
UCC_COLL_TYPE_FANOUT
:

393 
UCC_COLL_TYPE_BCAST
:

394  
¬gs
->
¤c
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->¤c.šfo.
d©©y³
);

395 
UCC_COLL_TYPE_ALLREDUCE
:

396 
UCC_COLL_TYPE_ALLTOALL
:

397 
UCC_COLL_TYPE_ALLGATHER
:

398 
UCC_COLL_TYPE_REDUCE_SCATTER
:

399  
¬gs
->
d¡
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->d¡.šfo.
d©©y³
);

400 
UCC_COLL_TYPE_ALLGATHERV
:

401 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

402  
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
,

403 
size
) *

404 
	`ucc_dt_size
(
¬gs
->
d¡
.
šfo_v
.
d©©y³
);

405 
UCC_COLL_TYPE_ALLTOALLV
:

406 
UCC_COLL_TYPE_GATHERV
:

407 
UCC_COLL_TYPE_SCATTERV
:

412  
UCC_MSG_SIZE_ASYMMETRIC
;

413 
UCC_COLL_TYPE_REDUCE
:

414  (
roÙ
 =ğ
¿nk
)

415 ? 
¬gs
->
d¡
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->d¡.šfo.
d©©y³
)

416 : 
¬gs
->
¤c
.
šfo
.
couÁ
 *

417 
	`ucc_dt_size
(
¬gs
->
¤c
.
šfo
.
d©©y³
);

418 
UCC_COLL_TYPE_GATHER
:

419  (
roÙ
 =ğ
¿nk
)

420 ? 
¬gs
->
d¡
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->d¡.šfo.
d©©y³
)

421 : 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->¤c.šfo.
d©©y³
) *

422 
size
;

423 
UCC_COLL_TYPE_SCATTER
:

424  (
roÙ
 =ğ
¿nk
)

425 ? 
¬gs
->
¤c
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->¤c.šfo.
d©©y³
)

426 : 
¬gs
->
d¡
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs->d¡.šfo.
d©©y³
) *

427 
size
;

429 
	`ucc_as£¹
(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_LAST
);

432 
	}
}

434 
šlše
 
št64_t
 
	$ucc_•_m­_g‘_–em
(**
¬¿y
, 
i
, 
is64
)

436 ià(
is64
) {

437  (
št64_t
è(*(
ušt64_t
 **)(
¬¿y
))[
i
];

439  (
št64_t
è(*(
ucc_¿nk_t
 **)(
¬¿y
))[
i
];

441 
	}
}

443 
šlše
 
ucc_•_m­_t


444 
	$ucc_•_m­_äom_¬¿y_g’”ic
(**
¬¿y
, 
ucc_¿nk_t
 
size
,

445 
ucc_¿nk_t
 
fuÎ_size
, 
Ãed_ä“
, 
is64
)

447 
is_cÚ¡_¡ride
 = 0;

448 
ucc_•_m­_t
 
m­
;

449 
št64_t
 
¡ride
;

450 
ucc_¿nk_t
 
i
;

452 
m­
.
ty³
 = (
ucc_•_m­_ty³_t
)0;

453 
m­
.
•_num
 = 
size
;

454 ià(
size
 > 1) {

456 
¡ride
 = 
	`ucc_•_m­_g‘_–em
(
¬¿y
, 1, 
is64
) -

457 
	`ucc_•_m­_g‘_–em
(
¬¿y
, 0, 
is64
);

458 
is_cÚ¡_¡ride
 = 1;

459 
i
 = 2; i < 
size
; i++) {

460 ià((
	`ucc_•_m­_g‘_–em
(
¬¿y
, 
i
, 
is64
) -

461 
	`ucc_•_m­_g‘_–em
(
¬¿y
, 
i
 - 1, 
is64
)è!ğ
¡ride
) {

462 
is_cÚ¡_¡ride
 = 0;

467 ià(
is_cÚ¡_¡ride
) {

468 ià((
¡ride
 =ğ1è&& (
size
 =ğ
fuÎ_size
)) {

469 
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

473 
m­
.
ty³
 = 
UCC_EP_MAP_STRIDED
;

474 
m­
.
¡rided
.
¡¬t
 = (
ušt64_t
è
	`ucc_•_m­_g‘_–em
(
¬¿y
, 0,

475 
is64
);

476 
m­
.
¡rided
.
¡ride
 = stride;

478 ià(
Ãed_ä“
) {

479 
	`ucc_ä“
(*
¬¿y
);

480 *
¬¿y
 = 
NULL
;

483 
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

484 
m­
.
¬¿y
.map = (*)(*array);

485 
m­
.
¬¿y
.
–em_size
 = 
is64
 ? (
ušt64_t
è: (
ucc_¿nk_t
);

488  
m­
;

489 
	}
}

491 
ucc_•_m­_t
 
	$ucc_•_m­_äom_¬¿y
(
ucc_¿nk_t
 **
¬¿y
, ucc_¿nk_ˆ
size
,

492 
ucc_¿nk_t
 
fuÎ_size
, 
Ãed_ä“
)

494  
	`ucc_•_m­_äom_¬¿y_g’”ic
((**è
¬¿y
, 
size
, 
fuÎ_size
,

495 
Ãed_ä“
, 0);

496 
	}
}

498 
ucc_•_m­_t
 
	$ucc_•_m­_äom_¬¿y_64
(
ušt64_t
 **
¬¿y
, 
ucc_¿nk_t
 
size
,

499 
ucc_¿nk_t
 
fuÎ_size
, 
Ãed_ä“
)

501  
	`ucc_•_m­_äom_¬¿y_g’”ic
((**è
¬¿y
, 
size
, 
fuÎ_size
,

502 
Ãed_ä“
, 1);

503 
	}
}

505 
	$ucc_cŞl_¬gs_is_roÙed
(
ucc_cŞl_ty³_t
 
ù
)

507 ià(
ù
 =ğ
UCC_COLL_TYPE_REDUCE
 || cˆ=ğ
UCC_COLL_TYPE_BCAST
 ||

508 
ù
 =ğ
UCC_COLL_TYPE_GATHER
 || cˆ=ğ
UCC_COLL_TYPE_SCATTER
 ||

509 
ù
 =ğ
UCC_COLL_TYPE_FANIN
 || cˆ=ğ
UCC_COLL_TYPE_FANOUT
 ||

510 
ù
 =ğ
UCC_COLL_TYPE_GATHERV
 || cˆ=ğ
UCC_COLL_TYPE_SCATTERV
) {

514 
	}
}

516 
	#COLL_ARGS_HEADER_STR_MAX_SIZE
 32

	)

517 
	$ucc_cŞl_¬gs_¡r
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
, 
ucc_¿nk_t
 
Œªk
,

518 
ucc_¿nk_t
 
tsize
, *
¡r
, 
size_t
 
Ën
)

520 
ucc_cŞl_ty³_t
 
ù
 = 
¬gs
->
cŞl_ty³
;

521 
ucc_¿nk_t
 
roÙ
 = 
¬gs
->root;

522 
ucc_cŞl_bufãr_šfo_t
 
¤c_šfo
 = {0};

523 
ucc_cŞl_bufãr_šfo_t
 
d¡_šfo
 = {0};

524 
hdr
[
COLL_ARGS_HEADER_STR_MAX_SIZE
] = "";

525 
tmp
[32];

526 
size_t
 
couÁ
;

527 
Ëá
, 
has_¤c
, 
has_d¡
;

529 
	`ucc_¢´štf_§ã
(
hdr
, 
COLL_ARGS_HEADER_STR_MAX_SIZE
, "%s",

530 
	`ucc_cŞl_ty³_¡r
(
ù
));

531 ià(
	`ucc_cŞl_¬gs_is_»duùiÚ
(
ù
)) {

532 
	`ucc_¢´štf_§ã
(
tmp
, (tmp), " %s",

533 
	`ucc_»duùiÚ_İ_¡r
(
¬gs
->
İ
));

534 
Ëá
 = 
COLL_ARGS_HEADER_STR_MAX_SIZE
 - 
	`¡¾’
(
hdr
);

535 
	`¡ºÿt
(
hdr
, 
tmp
, 
Ëá
);

538 ià(
	`UCC_IS_INPLACE
(*
¬gs
)) {

539 
	`ucc_¢´štf_§ã
(
tmp
, (tmp), " inplace");

540 
Ëá
 = 
COLL_ARGS_HEADER_STR_MAX_SIZE
 - 
	`¡¾’
(
hdr
);

541 
	`¡ºÿt
(
hdr
, 
tmp
, 
Ëá
);

544 ià(
	`UCC_IS_PERSISTENT
(*
¬gs
)) {

545 
	`ucc_¢´štf_§ã
(
tmp
, (tmp), "…ersistent");

546 
Ëá
 = 
COLL_ARGS_HEADER_STR_MAX_SIZE
 - 
	`¡¾’
(
hdr
);

547 
	`¡ºÿt
(
hdr
, 
tmp
, 
Ëá
);

550 ià(
	`ucc_cŞl_¬gs_is_roÙed
(
ù
)) {

551 
	`ucc_¢´štf_§ã
(
tmp
, Ñmp), "„oÙ %u", 
roÙ
);

552 
Ëá
 = 
COLL_ARGS_HEADER_STR_MAX_SIZE
 - 
	`¡¾’
(
hdr
);

553 
	`¡ºÿt
(
hdr
, 
tmp
, 
Ëá
);

556 
has_¤c
 = 
has_d¡
 = 0;

557 
ù
) {

558 
UCC_COLL_TYPE_ALLGATHER
:

559 
UCC_COLL_TYPE_ALLREDUCE
:

560 
UCC_COLL_TYPE_ALLTOALL
:

561 
UCC_COLL_TYPE_REDUCE_SCATTER
:

562 
d¡_šfo
 = 
¬gs
->
d¡
.
šfo
;

563 
has_d¡
 = 1;

564 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

565 
¤c_šfo
 = 
¬gs
->
¤c
.
šfo
;

566 
has_¤c
 = 1;

569 
UCC_COLL_TYPE_ALLGATHERV
:

570 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

571 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
,

572 
tsize
);

573 
d¡_šfo
.
bufãr
 = 
¬gs
->
d¡
.
šfo_v
.buffer;

574 
d¡_šfo
.
couÁ
 = count;

575 
d¡_šfo
.
d©©y³
 = 
¬gs
->
d¡
.
šfo_v
.datatype;

576 
d¡_šfo
.
mem_ty³
 = 
¬gs
->
d¡
.
šfo_v
.mem_type;

577 
has_d¡
 = 1;

578 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

579 
¤c_šfo
 = 
¬gs
->
¤c
.
šfo
;

580 
has_¤c
 = 1;

583 
UCC_COLL_TYPE_ALLTOALLV
:

584 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
,

585 
tsize
);

586 
d¡_šfo
.
bufãr
 = 
¬gs
->
d¡
.
šfo_v
.buffer;

587 
d¡_šfo
.
couÁ
 = count;

588 
d¡_šfo
.
d©©y³
 = 
¬gs
->
d¡
.
šfo_v
.datatype;

589 
d¡_šfo
.
mem_ty³
 = 
¬gs
->
d¡
.
šfo_v
.mem_type;

590 
has_d¡
 = 1;

591 ià(!
	`UCC_IS_INPLACE
(*
¬gs
)) {

592 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
,

593 
tsize
);

594 
¤c_šfo
.
bufãr
 = 
¬gs
->
¤c
.
šfo_v
.buffer;

595 
¤c_šfo
.
couÁ
 = count;

596 
¤c_šfo
.
d©©y³
 = 
¬gs
->
¤c
.
šfo_v
.datatype;

597 
¤c_šfo
.
mem_ty³
 = 
¬gs
->
¤c
.
šfo_v
.mem_type;

598 
has_¤c
 = 1;

600 
UCC_COLL_TYPE_BARRIER
:

601 
UCC_COLL_TYPE_FANIN
:

602 
UCC_COLL_TYPE_FANOUT
:

604 
UCC_COLL_TYPE_BCAST
:

605 
¤c_šfo
 = 
¬gs
->
¤c
.
šfo
;

606 
has_¤c
 = 1;

608 
UCC_COLL_TYPE_GATHER
:

609 
UCC_COLL_TYPE_REDUCE
:

610 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
)) {

611 
d¡_šfo
 = 
¬gs
->
d¡
.
šfo
;

612 
has_d¡
 = 1;

614 ià(!
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
è|| !
	`UCC_IS_INPLACE
(*args)) {

615 
¤c_šfo
 = 
¬gs
->
¤c
.
šfo
;

616 
has_¤c
 = 1;

619 
UCC_COLL_TYPE_GATHERV
:

620 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
)) {

621 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
,

622 
tsize
);

623 
d¡_šfo
.
bufãr
 = 
¬gs
->
d¡
.
šfo_v
.buffer;

624 
d¡_šfo
.
couÁ
 = count;

625 
d¡_šfo
.
d©©y³
 = 
¬gs
->
d¡
.
šfo_v
.datatype;

626 
d¡_šfo
.
mem_ty³
 = 
¬gs
->
d¡
.
šfo_v
.mem_type;

627 
has_d¡
 = 1;

629 ià(!
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
è|| !
	`UCC_IS_INPLACE
(*args)) {

630 
¤c_šfo
 = 
¬gs
->
¤c
.
šfo
;

631 
has_¤c
 = 1;

634 
UCC_COLL_TYPE_SCATTER
:

635 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
)) {

636 
¤c_šfo
 = 
¬gs
->
¤c
.
šfo
;

637 
has_¤c
 = 1;

639 ià(!
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
è|| !
	`UCC_IS_INPLACE
(*args)) {

640 
d¡_šfo
 = 
¬gs
->
d¡
.
šfo
;

641 
has_d¡
 = 1;

644 
UCC_COLL_TYPE_SCATTERV
:

645 ià(
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
)) {

646 
couÁ
 = 
	`ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
¬gs
,‡rgs->
¤c
.
šfo_v
.
couÁs
,

647 
tsize
);

648 
¤c_šfo
.
bufãr
 = 
¬gs
->
¤c
.
šfo_v
.buffer;

649 
¤c_šfo
.
couÁ
 = count;

650 
¤c_šfo
.
d©©y³
 = 
¬gs
->
¤c
.
šfo_v
.datatype;

651 
¤c_šfo
.
mem_ty³
 = 
¬gs
->
¤c
.
šfo_v
.mem_type;

652 
has_¤c
 = 1;

654 ià(!
	`UCC_IS_ROOT
(*
¬gs
, 
Œªk
è|| !
	`UCC_IS_INPLACE
(*args)) {

655 
d¡_šfo
 = 
¬gs
->
d¡
.
šfo
;

656 
has_d¡
 = 1;

660 
	`ucc_as£¹
(
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_LAST
);

664 ià(
has_¤c
 && 
has_d¡
) {

665 
	`ucc_¢´štf_§ã
(
¡r
, 
Ën
,

667 
hdr
, 
¤c_šfo
.
bufãr
, src_šfo.
couÁ
,

668 
	`ucc_d©©y³_¡r
(
¤c_šfo
.
d©©y³
),

669 
	`ucc_mem_ty³_¡r
(
¤c_šfo
.
mem_ty³
),

670 
d¡_šfo
.
bufãr
, d¡_šfo.
couÁ
,

671 
	`ucc_d©©y³_¡r
(
d¡_šfo
.
d©©y³
),

672 
	`ucc_mem_ty³_¡r
(
d¡_šfo
.
mem_ty³
));

673 } ià(
has_¤c
 && !
has_d¡
) {

674 
	`ucc_¢´štf_§ã
(
¡r
, 
Ën
,

676 
hdr
, 
¤c_šfo
.
bufãr
, src_šfo.
couÁ
,

677 
	`ucc_d©©y³_¡r
(
¤c_šfo
.
d©©y³
),

678 
	`ucc_mem_ty³_¡r
(
¤c_šfo
.
mem_ty³
));

679 } ià(!
has_¤c
 && 
has_d¡
) {

680 
	`ucc_¢´štf_§ã
(
¡r
, 
Ën
,

682 
hdr
, 
d¡_šfo
.
bufãr
, d¡_šfo.
couÁ
,

683 
	`ucc_d©©y³_¡r
(
d¡_šfo
.
d©©y³
),

684 
	`ucc_mem_ty³_¡r
(
d¡_šfo
.
mem_ty³
));

686 
	`ucc_¢´štf_§ã
(
¡r
, 
Ën
, "%s", 
hdr
);

688 
	}
}

690 
	$ucc_cŞl_sk_compÚ’ts_¡r
(cÚ¡ 
ucc_cŞl_sk_t
 *
sk
, *
¡r
,

691 
size_t
 *
Ën
)

693 
ucc_scheduË_t
 *
scheduË
;

694 
ucc_scheduË_p–šed_t
 *
scheduË_p–šed
;

695 
i
;

697 ià(
sk
->
æags
 & 
UCC_COLL_TASK_FLAG_IS_PIPELINED_SCHEDULE
) {

698 
scheduË_p–šed
 = 
	`ucc_d”ived_of
(
sk
, 
ucc_scheduË_p–šed_t
);

699 
i
 = 0; i < 
scheduË_p–šed
->
n_äags
; i++) {

700 
	`ucc_cŞl_sk_compÚ’ts_¡r
(&
scheduË_p–šed
->
äags
[
i
]->
su³r
,

701 
¡r
, 
Ën
);

703 } ià(
sk
->
æags
 & 
UCC_COLL_TASK_FLAG_IS_SCHEDULE
) {

704 
scheduË
 = 
	`ucc_d”ived_of
(
sk
, 
ucc_scheduË_t
);

705 
i
 = 0; i < 
scheduË
->
n_sks
; i++) {

706 
	`ucc_cŞl_sk_compÚ’ts_¡r
(
scheduË
->
sks
[
i
], 
¡r
, 
Ën
);

709 ià(!
	`¡r¡r
(
¡r
, 
sk
->
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
)) {

710 ià(*
Ën
 == 0) {

711 
	`¥rštf
(
¡r
 + *
Ën
, "%s",

712 
sk
->
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
);

713 *
Ën
 = 
	`¡¾’
(
sk
->
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
) +

714 *
Ën
;

716 
	`¥rštf
(
¡r
 + *
Ën
, ", %s",

717 
sk
->
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
);

718 *
Ën
 = 
	`¡¾’
(
sk
->
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
) +

719 *
Ën
 + 2;

723 
	}
}

725 
	$ucc_cŞl_¡r
(cÚ¡ 
ucc_cŞl_sk_t
 *
sk
, *
¡r
, 
size_t
 
Ën
,

726 
v”bos™y
)

728 
ucc_‹am_t
 *
‹am
 = 
sk
->
b¬gs
.team;

729 
rc
;

731 ià(
v”bos™y
 >ğ
UCC_LOG_LEVEL_DIAG
) {

732 
	`ucc_cŞl_¬gs_¡r
(&
sk
->
b¬gs
.
¬gs
, 
‹am
->
¿nk
,—m->
size
, 
¡r
, 
Ën
);

735 ià(
v”bos™y
 >ğ
UCC_LOG_LEVEL_INFO
) {

736 
size_t
 
_šfo_Ën
 = 0;

737 
sk_šfo
[64], 
ş_šfo
[16], 
_šfo
[32];

739 ià(!
sk
->
‹am
) {

741 
	`¡ºıy
(
ş_šfo
, "NoOp", (cl_info));

742 
	`¡ºıy
(
_šfo
, "NoOp", (tl_info));

744 ià(
sk
->
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
[0] == 'C') {

746 
	`ucc_¡ºıy_§ã
(
ş_šfo
,

747 
sk
->
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
,

748 (
ş_šfo
));

749 
	`ucc_cŞl_sk_compÚ’ts_¡r
(
sk
, 
_šfo
, &
_šfo_Ën
);

751 
	`ucc_¡ºıy_§ã
(
ş_šfo
, "CL_BASIC", (cl_info));

752 
	`ucc_¡ºıy_§ã
(
_šfo
,

753 
sk
->
‹am
->
cÚ‹xt
->
lib
->
log_compÚ’t
.
Çme
,

754 (
_šfo
));

756 
	`ucc_cŞl_¬gs_¡r
(&
sk
->
b¬gs
.
¬gs
, 
‹am
->
¿nk
,—m->
size
, 
¡r
, 
Ën
);

757 
rc
 = 
	`ucc_¢´štf_§ã
(
sk_šfo
, (task_info),

759 
ş_šfo
, 
_šfo
, 
‹am
->
id
);

760 ià(
rc
 < 0) {

763 
	`¡ºÿt
(
¡r
, 
sk_šfo
, 
Ën
 - 
	`¡¾’
(str));

766 ià(
v”bos™y
 >ğ
UCC_LOG_LEVEL_DEBUG
) {

767 
sk_šfo
[64];

768 
	`ucc_¢´štf_§ã
(
sk_šfo
, (task_info),

770 
‹am
->
¿nk
,

771 
	`ucc_•_m­_ev®
(
‹am
->
ùx_m­
,—m->
¿nk
),

772 
sk
->
£q_num
,ask);

773 
	`¡ºÿt
(
¡r
, 
sk_šfo
, 
Ën
 - 
	`¡¾’
(str));

775 
	}
}

777 
	succ_•_m­_Ã¡ed
 {

778 
ucc_•_m­_t
 *
	mba£_m­
;

779 
ucc_•_m­_t
 *
	msub_m­
;

780 } 
	tucc_•_m­_Ã¡ed_t
;

782 
ušt64_t
 
	$ucc_•_m­_Ã¡ed_cb
(
ušt64_t
 
•
, *
cb_ùx
)

784 
ucc_•_m­_Ã¡ed_t
 *
Ã¡ed
 = 
cb_ùx
;

785 
ucc_¿nk_t
 
r
;

787 
r
 = 
	`ucc_•_m­_ev®
(*
Ã¡ed
->
sub_m­
, (
ucc_¿nk_t
)
•
);

788  (
ušt64_t
)
	`ucc_•_m­_ev®
(*
Ã¡ed
->
ba£_m­
, 
r
);

789 
	}
}

791 
ucc_¡©us_t
 
	$ucc_•_m­_ü—‹_Ã¡ed
(
ucc_•_m­_t
 *
ba£_m­
,

792 
ucc_•_m­_t
 *
sub_m­
,

793 
ucc_•_m­_t
 *
out
)

795 
ucc_•_m­_Ã¡ed_t
 *
Ã¡ed
;

797 
Ã¡ed
 = 
	`ucc_m®loc
((*nested), "nested_map");

798 ià(
	`ucc_uÆik–y
(!
Ã¡ed
)) {

799 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for‚ested map",

800 (*
Ã¡ed
));

801  
UCC_ERR_NO_MEMORY
;

803 
Ã¡ed
->
ba£_m­
 = base_map;

804 
Ã¡ed
->
sub_m­
 = sub_map;

805 
out
->
ty³
 = 
UCC_EP_MAP_CB
;

806 
out
->
•_num
 = 
sub_m­
->ep_num;

807 
out
->
cb
.cb = 
ucc_•_m­_Ã¡ed_cb
;

808 
out
->
cb
.
cb_ùx
 = 
Ã¡ed
;

810  
UCC_OK
;

811 
	}
}

813 
	$ucc_•_m­_de¡roy_Ã¡ed
(
ucc_•_m­_t
 *
out
)

815 
	`ucc_ä“
(
out
->
cb
.
cb_ùx
);

816 
	}
}

818 
ucc_•_m­_t
 
	$ucc_•_m­_ü—‹_»v”£
(
ucc_¿nk_t
 
size
)

820 
ucc_•_m­_t
 
m­
 = {.
ty³
 = 
UCC_EP_MAP_STRIDED
,

821 .
•_num
 = 
size
,

822 .
¡rided
.
¡¬t
 = 
size
 - 1,

823 .
¡rided
.
¡ride
 = -1};

824  
m­
;

825 
	}
}

827 
	$ucc_•_m­_is_id’t™y
(cÚ¡ 
ucc_•_m­_t
 *
m­
)

829 ià((
m­
->
ty³
 =ğ
UCC_EP_MAP_FULL
) ||

830 ((
m­
->
ty³
 =ğ
UCC_EP_MAP_STRIDED
) &&

831 (
m­
->
¡rided
.
¡¬t
 == 0) &&

832 (
m­
->
¡rided
.
¡ride
 == 1))) {

837 
	}
}

839 
šlše
 
	$ucc_•_m­_is_»v”£
(
ucc_•_m­_t
 *
m­
,

840 
»v”£d_»Üd”ed_æag
)

842  (((
m­
->
ty³
 =ğ
UCC_EP_MAP_STRIDED
) &&

843 (
m­
->
¡rided
.
¡¬t
 =ğm­->
•_num
 - 1) &&

844 (
m­
->
¡rided
.
¡ride
 =ğ-1)è|| 
»v”£d_»Üd”ed_æag
);

845 
	}
}

847 
ucc_¡©us_t
 
	$ucc_•_m­_ü—‹_šv”£
(
ucc_•_m­_t
 
m­
, ucc_•_m­_ˆ*
šv_m­
,

848 
»v”£d_»Üd”ed_æag
)

850 
ucc_•_m­_t
 
šv
;

851 
ucc_¿nk_t
 
i
, 
r
;

852 
ucc_¿nk_t
 
max_¿nk
;

854 ià(
	`ucc_•_m­_is_»v”£
(&
m­
, 
»v”£d_»Üd”ed_æag
)) {

855 
šv
 = 
m­
;

857 
šv
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

858 
šv
.
•_num
 = 
m­
.ep_num;

859 
šv
.
¬¿y
.
–em_size
 = (
ucc_¿nk_t
);

860 
max_¿nk
 = 0;

861 
i
 = 0; i < 
m­
.
•_num
; i++) {

862 
r
 = (
ucc_¿nk_t
)
	`ucc_•_m­_ev®
(
m­
, 
i
);

863 ià(
r
 > 
max_¿nk
) {

864 
max_¿nk
 = 
r
;

867 
šv
.
¬¿y
.
m­
 =

868 
	`ucc_m®loc
((
ucc_¿nk_t
è* (
max_¿nk
 + 1), "inv_map");

869 ià(!
šv
.
¬¿y
.
m­
) {

870 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for inv map\n",

871 (
ucc_¿nk_t
è* 
m­
.
•_num
);

872  
UCC_ERR_NO_MEMORY
;

874 
i
 = 0; i < 
m­
.
•_num
; i++) {

875 
r
 = (
ucc_¿nk_t
)
	`ucc_•_m­_ev®
(
m­
, 
i
);

876 *((
ucc_¿nk_t
 *)
	`PTR_OFFSET
(
šv
.
¬¿y
.
m­
, (ucc_¿nk_tè* 
r
)) =

877 
i
;

880 *
šv_m­
 = 
šv
;

881  
UCC_OK
;

882 
	}
}

884 
	$ucc_•_m­_de¡roy
(
ucc_•_m­_t
 *
m­
)

886 ià(
m­
->
ty³
 =ğ
UCC_EP_MAP_ARRAY
) {

887 
	`ucc_ä“
(
m­
->
¬¿y
.map);

889 
	}
}

	@src/utils/ucc_coll_utils.h

7 #iâdeà
UCC_COLL_UTILS_H_


8 
	#UCC_COLL_UTILS_H_


	)

10 
	~"cÚfig.h
"

11 
	~"ucc_d©a¡ruù.h
"

12 
	~"ucc_m©h.h
"

13 
	~"uts/ucc_time.h
"

14 
	~"uts/ucc_as£¹.h
"

15 
	~<¡ršg.h
>

17 
	#UCC_COLL_TYPE_NUM
 (
	`ucc_og2
(
UCC_COLL_TYPE_LAST
 - 1è+ 1)

	)

19 
	#UCC_COLL_TYPE_ALL
 ((
UCC_COLL_TYPE_LAST
 << 1è- 3)

	)

21 
	#UCC_MEMORY_TYPE_ASYMMETRIC
 \

22 ((
ucc_memÜy_ty³_t
)(()
UCC_MEMORY_TYPE_LAST
 + 1))

	)

24 
	#UCC_MEMORY_TYPE_NOT_APPLY
 \

25 ((
ucc_memÜy_ty³_t
)(()
UCC_MEMORY_TYPE_LAST
 + 2))

	)

27 
	#UCC_MSG_SIZE_INVALID
 
SIZE_MAX


	)

29 
	#UCC_MSG_SIZE_ASYMMETRIC
 (
UCC_MSG_SIZE_INVALID
 - 1)

	)

31 
	#UCC_IS_INPLACE
(
_¬gs
) \

32 (((
_¬gs
).
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) && \

33 ((
_¬gs
).
æags
 & 
UCC_COLL_ARGS_FLAG_IN_PLACE
))

	)

35 
	#UCC_IS_PERSISTENT
(
_¬gs
) \

36 (((
_¬gs
).
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) && \

37 ((
_¬gs
).
æags
 & 
UCC_COLL_ARGS_FLAG_PERSISTENT
))

	)

39 
	#UCC_IS_ROOT
(
_¬gs
, 
_my¿nk
è((_¬gs).
roÙ
 =ğ(_my¿nk))

	)

41 
	#UCC_COLL_TIMEOUT_REQUIRED
(
_sk
) \

42 (((
_sk
)->
b¬gs
.
¬gs
.
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) && \

43 ((
_sk
)->
b¬gs
.
¬gs
.
æags
 & 
UCC_COLL_ARGS_FLAG_TIMEOUT
))

	)

45 
	#UCC_COLL_SET_TIMEOUT
(
_sk
, 
_timeout
) do { \

46 (
_sk
)->
b¬gs
.
¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
; \

47 (
_sk
)->
b¬gs
.
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_TIMEOUT
; \

48 (
_sk
)->
b¬gs
.
¬gs
.
timeout
 = 
_timeout
; \

49 (
_sk
)->
¡¬t_time
 = 
	`ucc_g‘_time
(); \

50 } 0)

	)

52 
	#UCC_COLL_ARGS_COUNT64
(
_¬gs
) \

53 (((
_¬gs
)->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) && \

54 ((
_¬gs
)->
æags
 & 
UCC_COLL_ARGS_FLAG_COUNT_64BIT
))

	)

56 
	#UCC_COLL_ARGS_DISPL64
(
_¬gs
) \

57 (((
_¬gs
)->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) && \

58 ((
_¬gs
)->
æags
 & 
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
))

	)

60 
	#UCC_COLL_IS_SRC_CONTIG
(
_¬gs
) \

61 (((
_¬gs
)->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) && \

62 ((
_¬gs
)->
æags
 & 
UCC_COLL_ARGS_FLAG_CONTIG_SRC_BUFFER
))

	)

64 
	#UCC_COLL_IS_DST_CONTIG
(
_¬gs
) \

65 (((
_¬gs
)->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) && \

66 ((
_¬gs
)->
æags
 & 
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
))

	)

68 
	#UCC_COLL_ARGS_CONTIG_BUFFER
(
_¬gs
) \

69 (
	`UCC_COLL_IS_SRC_CONTIG
(
_¬gs
è&& 
	`UCC_COLL_IS_DST_CONTIG
(_¬gs))

	)

71 
	#UCC_COLL_ARGS_ACTIVE_SET
(
_¬gs
) \

72 ((
_¬gs
)->
mask
 & 
UCC_COLL_ARGS_FIELD_ACTIVE_SET
)

	)

74 
	#UCC_MEM_TYPE_MASK_FULL
 (
	`UCC_BIT
(
UCC_MEMORY_TYPE_HOST
) | \

75 
	`UCC_BIT
(
UCC_MEMORY_TYPE_CUDA
) | \

76 
	`UCC_BIT
(
UCC_MEMORY_TYPE_CUDA_MANAGED
) | \

77 
	`UCC_BIT
(
UCC_MEMORY_TYPE_ROCM
) | \

78 
	`UCC_BIT
(
UCC_MEMORY_TYPE_ROCM_MANAGED
))

	)

80 
šlše
 
	$ucc_cŞl_¬gs_is_»duùiÚ
(
ucc_cŞl_ty³_t
 
ù
)

82 ià(
ù
 =ğ
UCC_COLL_TYPE_ALLREDUCE
 || cˆ=ğ
UCC_COLL_TYPE_REDUCE
 ||

83 
ù
 =ğ
UCC_COLL_TYPE_REDUCE_SCATTER
 ||

84 
ù
 =ğ
UCC_COLL_TYPE_REDUCE_SCATTERV
) {

88 
	}
}

90 
šlše
 
size_t


91 
	$ucc_cŞl_¬gs_g‘_couÁ
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
, cÚ¡ 
ucc_couÁ_t
 *
couÁs
,

92 
ucc_¿nk_t
 
idx
)

94 ià(
	`UCC_COLL_ARGS_COUNT64
(
¬gs
)) {

95  ((
ušt64_t
 *)
couÁs
)[
idx
];

97  ((
ušt32_t
 *)
couÁs
)[
idx
];

98 
	}
}

100 
šlše
 

101 
	$ucc_cŞl_¬gs_£t_couÁ
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
, cÚ¡ 
ucc_couÁ_t
 *
couÁs
,

102 
ucc_¿nk_t
 
idx
, 
size_t
 
v®
)

104 ià(
	`UCC_COLL_ARGS_COUNT64
(
¬gs
)) {

105 ((
ušt64_t
 *)
couÁs
)[
idx
] = (ušt64_t)
v®
;

107 ((
ušt32_t
 *)
couÁs
)[
idx
] = (ušt32_t)
v®
;

109 
	}
}

111 
šlše
 
size_t
 
	$ucc_cŞl_¬gs_g‘_max_couÁ
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

112 cÚ¡ 
ucc_couÁ_t
 * 
couÁs
,

113 
ucc_¿nk_t
 
size
)

115 
size_t
 
max_couÁ
 = 0, 
c
;

116 
i
;

118 
i
 = 0; i < 
size
; i++) {

119 
c
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
, 
couÁs
, 
i
);

120 ià(
c
 > 
max_couÁ
) {

121 
max_couÁ
 = 
c
;

124  
max_couÁ
;

125 
	}
}

127 
šlše
 
size_t


128 
	$ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

129 cÚ¡ 
ucc_ašt_t
 *
di¥Ïûm’ts
, 
ucc_¿nk_t
 
idx
)

131 ià(
	`UCC_COLL_ARGS_DISPL64
(
¬gs
)) {

132  ((
ušt64_t
 *)
di¥Ïûm’ts
)[
idx
];

134  ((
ušt32_t
 *)
di¥Ïûm’ts
)[
idx
];

135 
	}
}

137 
šlše
 

138 
	$ucc_cŞl_¬gs_£t_di¥Ïûm’t
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

139 cÚ¡ 
ucc_ašt_t
 *
di¥Ïûm’ts
, 
ucc_¿nk_t
 
idx
,

140 
size_t
 
v®
)

142 ià(
	`UCC_COLL_ARGS_DISPL64
(
¬gs
)) {

143 ((
ušt64_t
 *)
di¥Ïûm’ts
)[
idx
] = (ušt64_t)
v®
;

145 ((
ušt32_t
 *)
di¥Ïûm’ts
)[
idx
] = (ušt32_t)
v®
;

147 
	}
}

149 
šlše
 
size_t


150 
	$ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

151 cÚ¡ 
ucc_couÁ_t
 *
couÁs
, 
ucc_¿nk_t
 
size
)

153 
size_t
 
couÁ
 = 0;

154 
ucc_¿nk_t
 
i
;

156 ià((
¬gs
->
mask
 & 
UCC_COLL_ARGS_FIELD_FLAGS
) &&

157 (
¬gs
->
æags
 & 
UCC_COLL_ARGS_FLAG_COUNT_64BIT
)) {

158 
i
 = 0; i < 
size
; i++) {

159 
couÁ
 +ğ((
ušt64_t
 *)
couÁs
)[
i
];

162 
i
 = 0; i < 
size
; i++) {

163 
couÁ
 +ğ((
ušt32_t
 *)
couÁs
)[
i
];

167  
couÁ
;

168 
	}
}

172 
šlše
 
	$ucc_cŞl_¬gs_is_di¥_cÚtig
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

173 
ucc_¿nk_t
 
size
)

175 
size_t
 
couÁ_accumuÏtÜ
 = 0;

176 
size_t
 
di¥s
;

177 
ucc_¿nk_t
 
i
;

179 ià(!
	`UCC_COLL_IS_DST_CONTIG
(
¬gs
)) {

180 
i
 = 0; i < 
size
; i++) {

181 
di¥s
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(

182 
¬gs
,‡rgs->
d¡
.
šfo_v
.
di¥Ïûm’ts
, 
i
);

183 ià(
di¥s
 !ğ
couÁ_accumuÏtÜ
) {

186 
couÁ_accumuÏtÜ
 +ğ
	`ucc_cŞl_¬gs_g‘_couÁ
(

187 
¬gs
,‡rgs->
d¡
.
šfo_v
.
couÁs
, 
i
);

192 
	}
}

194 
šlše
 
size_t


195 
	$ucc_cŞl_¬gs_g‘_v_bufãr_size
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

196 cÚ¡ 
ucc_couÁ_t
 *
couÁs
,

197 cÚ¡ 
ucc_ašt_t
 *
di¥Ïûm’ts
,

198 
ucc_¿nk_t
 
size
)

200 
ucc_¿nk_t
 
i
;

201 
size_t
 
max_di¥
, 
idx_couÁ
;

203 
max_di¥
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
, 
di¥Ïûm’ts
, 0);

204 
idx_couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
, 
couÁs
, 0);

205 
i
 = 1; i < 
size
; i++) {

206 
size_t
 
di¥_i
 = 
	`ucc_cŞl_¬gs_g‘_di¥Ïûm’t
(
¬gs
, 
di¥Ïûm’ts
, 
i
);

207 ià(
di¥_i
 > 
max_di¥
) {

208 
max_di¥
 = 
di¥_i
;

209 
idx_couÁ
 = 
	`ucc_cŞl_¬gs_g‘_couÁ
(
¬gs
, 
couÁs
, 
i
);

213  
max_di¥
 + 
idx_couÁ
;

214 
	}
}

215 
ucc_ba£_cŞl_¬gs
 
	tucc_ba£_cŞl_¬gs_t
;

217 
ucc_cŞl_ty³_t
 
ucc_cŞl_ty³_äom_¡r
(cÚ¡ *
¡r
);

219 
ucc_memÜy_ty³_t
 
ucc_mem_ty³_äom_¡r
(cÚ¡ *
¡r
);

221 
size_t
 
ucc_cŞl_¬gs_msgsize
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

222 
ucc_¿nk_t
 
¿nk
, ucc_¿nk_ˆ
size
);

224 
ucc_memÜy_ty³_t
 
ucc_cŞl_¬gs_mem_ty³
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
,

225 
ucc_¿nk_t
 
¿nk
);

228 
šlše
 
ucc_¿nk_t
 
	$ucc_•_m­_ev®
(
ucc_•_m­_t
 
m­
, 
ucc_¿nk_t
 
¿nk
)

230 
ucc_¿nk_t
 
r
;

231 
m­
.
ty³
) {

232 
UCC_EP_MAP_FULL
:

233 
r
 = 
¿nk
;

235 
UCC_EP_MAP_STRIDED
:

236 
r
 = 
m­
.
¡rided
.
¡¬t
 + 
¿nk
*m­.¡rided.
¡ride
;

238 
UCC_EP_MAP_ARRAY
:

239 
r
 = *((
ucc_¿nk_t
*)((
±rdiff_t
)
m­
.
¬¿y
.m­ + 
¿nk
*m­.¬¿y.
–em_size
));

241 
UCC_EP_MAP_CB
:

242 
r
 = (
ucc_¿nk_t
)
m­
.
cb
.
	`cb
(
¿nk
, m­.cb.
cb_ùx
);

245 
r
 = 
UCC_RANK_INVALID
;

247  
r
;

248 
	}
}

259 
ucc_•_m­_t
 
ucc_•_m­_äom_¬¿y
(
ucc_¿nk_t
 **
¬¿y
, ucc_¿nk_ˆ
size
,

260 
ucc_¿nk_t
 
fuÎ_size
, 
Ãed_ä“
);

271 
ucc_•_m­_t
 
ucc_•_m­_äom_¬¿y_64
(
ušt64_t
 **
¬¿y
, 
ucc_¿nk_t
 
size
,

272 
ucc_¿nk_t
 
fuÎ_size
, 
Ãed_ä“
);

274 
ucc_cŞl_sk
 
	tucc_cŞl_sk_t
;

275 
ucc_cŞl_¡r
(cÚ¡ 
ucc_cŞl_sk_t
 *
sk
, *
¡r
, 
size_t
 
Ën
,

276 
v”bos™y
);

278 
ucc_cŞl_¬gs_¡r
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
, 
ucc_¿nk_t
 
Œªk
,

279 
ucc_¿nk_t
 
tsize
, *
¡r
, 
size_t
 
Ën
);

283 
ucc_•_m­_t
 
ucc_•_m­_ü—‹_»v”£
(
ucc_¿nk_t
 
size
);

293 
ucc_¡©us_t
 
ucc_•_m­_ü—‹_šv”£
(
ucc_•_m­_t
 
m­
, ucc_•_m­_ˆ*
šv_m­
,

294 
»v”£d_»Üd”ed_æag
);

296 
ucc_¡©us_t
 
ucc_•_m­_ü—‹_Ã¡ed
(
ucc_•_m­_t
 *
ba£_m­
,

297 
ucc_•_m­_t
 *
sub_m­
,

298 
ucc_•_m­_t
 *
out
);

300 
ucc_•_m­_is_id’t™y
(cÚ¡ 
ucc_•_m­_t
 *
m­
);

302 
ucc_•_m­_de¡roy_Ã¡ed
(
ucc_•_m­_t
 *
out
);

304 
ucc_•_m­_de¡roy
(
ucc_•_m­_t
 *
m­
);

313 
šlše
 
size_t
 
	$ucc_bufãr_block_couÁ
(
size_t
 
tÙ®_couÁ
,

314 
ucc_¿nk_t
 
n_blocks
,

315 
ucc_¿nk_t
 
block
)

317 
size_t
 
block_couÁ
 = 
tÙ®_couÁ
 / 
n_blocks
;

318 
size_t
 
Ëá
 = 
tÙ®_couÁ
 % 
n_blocks
;

320  (
block
 < 
Ëá
è? 
block_couÁ
 + 1 : block_count;

321 
	}
}

323 
šlše
 
size_t
 
	$ucc_bufãr_block_off£t
(
size_t
 
tÙ®_couÁ
,

324 
ucc_¿nk_t
 
n_blocks
,

325 
ucc_¿nk_t
 
block
)

327 
size_t
 
block_couÁ
 = 
tÙ®_couÁ
 / 
n_blocks
;

328 
size_t
 
Ëá
 = 
tÙ®_couÁ
 % 
n_blocks
;

329 
size_t
 
off£t
 = 
block
 * 
block_couÁ
 + 
Ëá
;

331  (
block
 < 
Ëá
è? 
off£t
 - (left - block) : offset;

332 
	}
}

334 
šlše
 
size_t
 
	$ucc_bufãr_veùÜ_block_off£t
(
ucc_couÁ_t
 *
couÁs
,

335 
is64
,

336 
ucc_¿nk_t
 
¿nk
)

338 
size_t
 
off£t
 = 0;

339 
ucc_¿nk_t
 
i
;

341 ià(
is64
) {

342 
i
 = 0; i < 
¿nk
; i++) {

343 
off£t
 +ğ((
ušt64_t
 *)
couÁs
)[
i
];

346 
i
 = 0; i < 
¿nk
; i++) {

347 
off£t
 +ğ((
ušt32_t
 *)
couÁs
)[
i
];

350  
off£t
;

351 
	}
}

358 
šlše
 
ucc_¿nk_t
 
	$ucc_•_m­_loÿl_¿nk
(
ucc_•_m­_t
 
m­
,

359 
ucc_¿nk_t
 
¿nk
)

361 
ucc_¿nk_t
 
i
, 
loÿl_¿nk
 = 
UCC_RANK_INVALID
;

362 
št64_t
 
v¿nk
;

364 
m­
.
ty³
) {

365 
UCC_EP_MAP_FULL
:

366 
loÿl_¿nk
 = 
¿nk
;

368 
UCC_EP_MAP_STRIDED
:

369 
v¿nk
 = (
št64_t
)
¿nk
 - (št64_t)
m­
.
¡rided
.
¡¬t
;

370 
v¿nk
 /ğ
m­
.
¡rided
.
¡ride
;

371 
	`ucc_as£¹
(
v¿nk
 >ğ0 && v¿nk < 
m­
.
•_num
);

372 
loÿl_¿nk
 = (
ucc_¿nk_t
)
v¿nk
;

374 
UCC_EP_MAP_ARRAY
:

375 
UCC_EP_MAP_CB
:

376 
i
 = 0; i < 
m­
.
•_num
; i++) {

377 ià(
¿nk
 =ğ
	`ucc_•_m­_ev®
(
m­
, 
i
)) {

378 
loÿl_¿nk
 = 
i
;

385  
loÿl_¿nk
;

386 
	}
}

388 
šlše
 
ucc_•_m­_t
 
	$ucc_aùive_£t_to_•_m­
(
ucc_cŞl_¬gs_t
 *
¬gs
)

390 
ucc_•_m­_t
 
m­
;

392 
m­
.
ty³
 = 
UCC_EP_MAP_STRIDED
;

393 
m­
.
•_num
 = 
¬gs
->
aùive_£t
.
size
;

394 
m­
.
¡rided
.
¡¬t
 = 
¬gs
->
aùive_£t
.start;

395 
m­
.
¡rided
.
¡ride
 = 
¬gs
->
aùive_£t
.stride;

396  
m­
;

397 
	}
}

399 
šlše
 
size_t
 
	$ucc_bufãr_block_couÁ_®igÃd
(
size_t
 
tÙ®_couÁ
,

400 
ucc_¿nk_t
 
n_blocks
,

401 
ucc_¿nk_t
 
block
,

402 
®ignm’t
)

404 
size_t
 
block_couÁ
 = 
	`ucc_®ign_up_pow2
(
	`ucc_max
(
tÙ®_couÁ
 / 
n_blocks
, 1),

405 
®ignm’t
);

406 
size_t
 
off£t
 = 
block_couÁ
 * 
block
;

408  (
tÙ®_couÁ
 < 
off£t
è? 0: 
	`ucc_mš
ÑÙ®_couÁ - off£t, 
block_couÁ
);

409 
	}
}

411 
šlše
 
size_t
 
	$ucc_bufãr_block_off£t_®igÃd
(
size_t
 
tÙ®_couÁ
,

412 
ucc_¿nk_t
 
n_blocks
,

413 
ucc_¿nk_t
 
block
,

414 
®ignm’t
)

416 
size_t
 
block_couÁ
 = 
	`ucc_®ign_up_pow2
(
	`ucc_max
(
tÙ®_couÁ
 / 
n_blocks
, 1),

417 
®ignm’t
);

418 
size_t
 
off£t
 = 
block_couÁ
 * 
block
;

420  
	`ucc_mš
(
off£t
, 
tÙ®_couÁ
);

421 
	}
}

427 
ucc_cŞl_¬gs_is_´edefšed_dt
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
, 
ucc_¿nk_t
 
¿nk
);

429 
ucc_cŞl_¬gs_is_mem_symm‘ric
(cÚ¡ 
ucc_cŞl_¬gs_t
 *
¬gs
, 
ucc_¿nk_t
 
¿nk
);

431 
ucc_cŞl_¬gs_is_roÙed
(
ucc_cŞl_ty³_t
 
ù
);

433 
ucc_bufãr_šfo_asymm‘ric_memty³
 
	tucc_bufãr_šfo_asymm‘ric_memty³_t
;

434 
ucc_mc_bufãr_h—d”
 
	tucc_mc_bufãr_h—d”_t
;

436 
ucc_¡©us_t


437 
ucc_cŞl_¬gs_š™_asymm‘ric_bufãr
(
ucc_cŞl_¬gs_t
 *
¬gs
,

438 
ucc_‹am_h
 
‹am
,

439 
ucc_bufãr_šfo_asymm‘ric_memty³_t
 *
§ve_šfo
);

441 
ucc_¡©us_t


442 
ucc_cŞl_¬gs_ä“_asymm‘ric_bufãr
(
ucc_cŞl_sk_t
 *
sk
);

444 
ucc_¡©us_t
 
ucc_cİy_asymm‘ric_bufãr
(
ucc_cŞl_sk_t
 *
sk
);

	@src/utils/ucc_compiler_def.h

7 #iâdeà
UCC_COMPILER_DEF_H_


8 
	#UCC_COMPILER_DEF_H_


	)

10 
	~"cÚfig.h
"

11 
	~"ucc/­i/ucc_¡©us.h
"

12 
	~<ucs/ty³/¡©us.h
>

13 
	~<ucs/sys/¡ršg.h
>

14 
	~<ucs/sys/´•roûssÜ.h
>

15 
	~<ucs/sys/comp”_def.h
>

16 
	~<ucs/debug/log_def.h
>

18 #iâdeà
SIZE_MAX


19 
	#SIZE_MAX
 ((
size_t
è-1)

	)

22 
	#ucc_off£tof
 
ucs_off£tof


	)

23 
	#ucc_cÚš”_of
 
ucs_cÚš”_of


	)

24 
	#ucc_d”ived_of
 
ucs_d”ived_of


	)

25 
	#ucc_¡ºıy_§ã
 
ucs_¡ºıy_§ã


	)

26 
	#ucc_¢´štf_§ã
 
¢´štf


	)

27 
	#ucc_lik–y
 
ucs_lik–y


	)

28 
	#ucc_uÆik–y
 
ucs_uÆik–y


	)

29 
	#ucc_¡ršg_¥l™
 
ucs_¡ršg_¥l™


	)

38 
	#UCC_STATIC_ASSERT
(
_cÚd
) \

39 0è{0:(
_cÚd
):;}

	)

44 
	#ucc_comp”_ãnû
(è
asm
 vŞ©e(""::: "memÜy")

	)

46 
ucs_log_compÚ’t_cÚfig_t
 
	tucc_log_compÚ’t_cÚfig_t
;

47 
	tucc_scÜe_t
;

49 
	#_UCC_PP_MAKE_STRING
(
x
è#x

	)

50 
	#UCC_PP_MAKE_STRING
(
x
è
	`_UCC_PP_MAKE_STRING
(x)

	)

51 
	#UCC_PP_QUOTE
 
UCS_PP_QUOTE


	)

52 
	#UCC_EMPTY_STATEMENT
 {}

	)

55 
	#UCC_S_PACKED
 
	`__©Œibu‹__
((
·cked
))

	)

60 
	#ucc_uÇligÃd_±r
(
_±r
è({*
_p
 = (*)(_±r); _p;})

	)

63 #ià
defšed
(
HAVE_ATTRIBUTE_NOOPTIMIZE
) && (HAVE_ATTRIBUTE_NOOPTIMIZE == 1)

64 
	#UCC_F_NOOPTIMIZE
 
	`__©Œibu‹__
((
	`İtimize
("O0")))

	)

66 
	#UCC_F_NOOPTIMIZE


	)

70 
	#UCC_F_NORETURN
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

72 
	#UCC_COPY_PARAM_BY_FIELD
(
_d¡
, 
_¤c
, 
_FIELD
, 
_f›ld
) \

74 ià((
_¤c
)->
mask
 & (
_FIELD
)) { \

75 (
_d¡
)->
_f›ld
 = (
_¤c
)->_field; \

77 } 0)

	)

79 
šlše
 
ucc_¡©us_t
 
	$ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us_t
 
¡©us
)

81 
¡©us
) {

82 
UCS_OK
:

83  
UCC_OK
;

84 
UCS_INPROGRESS
:

85  
UCC_INPROGRESS
;

86 
UCS_ERR_NO_MEMORY
:

87  
UCC_ERR_NO_MEMORY
;

88 
UCS_ERR_INVALID_PARAM
:

89  
UCC_ERR_INVALID_PARAM
;

90 
UCS_ERR_NO_RESOURCE
:

91  
UCC_ERR_NO_RESOURCE
;

95  
UCC_ERR_NO_MESSAGE
;

96 
	}
}

98 
šlše
 
ucs_¡©us_t
 
	$ucc_¡©us_to_ucs_¡©us
(
ucc_¡©us_t
 
¡©us
)

100 
¡©us
) {

101 
UCC_OK
:

102  
UCS_OK
;

103 
UCC_INPROGRESS
:

104  
UCS_INPROGRESS
;

105 
UCC_ERR_NO_MEMORY
:

106  
UCS_ERR_NO_MEMORY
;

107 
UCC_ERR_INVALID_PARAM
:

108  
UCS_ERR_INVALID_PARAM
;

109 
UCC_ERR_NO_RESOURCE
:

110  
UCS_ERR_NO_RESOURCE
;

114  
UCS_ERR_NO_MESSAGE
;

115 
	}
}

117 
	#ucc_fÜ_—ch_b™
 
ucs_fÜ_—ch_b™


	)

119 
	#UCC_CHECK_GOTO
(
_cmd
, 
_Ïb–
, 
_¡©us
) \

121 
_¡©us
 = (
_cmd
); \

122 ià(
	`ucc_uÆik–y
(
_¡©us
 !ğ
UCC_OK
)) { \

123 
_Ïb–
; \

125 } 0)

	)

128 #ià
defšed
(
__şªg__
)

129 
	#ucc_assume
(
x
è
	`__butš_assume
(x)

	)

130 #–ià
defšed
(
__NVCOMPILER
)

131 
	#ucc_assume
(
x
è
	`__butš_assume
(x)

	)

132 #–ià
defšed
(
__GNUC__
)

133 #ià(
__GNUC__
 >= 13)

135 
	#ucc_assume
(
x
è
	`__©Œibu‹__
((
	`assume
(x)))

	)

138 
	#ucc_assume
(
x
è((xè? ()0 : 
	`__butš_uÄ—chabË
())

	)

141 
	#ucc_assume
(
x
èdØ{} 0è

	)

	@src/utils/ucc_component.c

5 
	~"cÚfig.h
"

6 
	~"ucc_m®loc.h
"

7 
	~"ucc_compÚ’t.h
"

8 
	~"ucc_log.h
"

9 
	~"ucc_m©h.h
"

10 
	~"cÜe/ucc_glob®_İts.h
"

11 
	~"uts/ucc_¡ršg.h
"

13 
	~<sys/ty³s.h
>

14 
	~<sys/¡©.h
>

15 
	~<”r.h
>

16 
	~<lšk.h
>

17 
	~<dlfú.h
>

18 
	~<glob.h
>

19 
	~<uni¡d.h
>

20 
	~<as£¹.h
>

22 
	#IFACE_NAME_LEN_MAX
 \

23 (
UCC_MAX_FRAMEWORK_NAME_LEN
 + 
UCC_MAX_COMPONENT_NAME_LEN
 + 32)

	)

25 
ucc_¡©us_t
 
	$ucc_compÚ’t_lßd_Úe
(cÚ¡ *
so_·th
,

26 cÚ¡ *
äamewÜk_Çme
,

27 
ucc_compÚ’t_içû_t
 **
c_içû
)

29 
äamewÜk_·‰”n
[
UCC_MAX_FRAMEWORK_NAME_LEN
 + 16];

30 *
”rÜ
, 
içû_¡ruù
[
IFACE_NAME_LEN_MAX
];

31 *
hªdË
;

32 
ucc_compÚ’t_içû_t
 *
içû
;

33 
±rdiff_t
 
ba£Çme_¡¬t
;

34 
size_t
 
içû_¡ruù_Çme_Ën
;

36 
	`ucc_¢´štf_§ã
(
äamewÜk_·‰”n
, (framework_pattern), "ucc_%s_",

37 
äamewÜk_Çme
);

38 
ba£Çme_¡¬t
 =

39 ((
±rdiff_t
)
	`ucc_¡r¡r_Ï¡
(
so_·th
, 
äamewÜk_·‰”n
) -

40 (
±rdiff_t
)
so_·th
);

41 ià(
ba£Çme_¡¬t
 < 0) {

42  
UCC_ERR_NO_MESSAGE
;

49 
içû_¡ruù_Çme_Ën
 = 
	`¡¾’
(
so_·th
è- 
ba£Çme_¡¬t
 - 3;

50 
	`ucc_¡ºıy_§ã
(
içû_¡ruù
, 
so_·th
 + 
ba£Çme_¡¬t
,

51 
içû_¡ruù_Çme_Ën
 + 1);

53 
hªdË
 = 
	`dlİ’
(
so_·th
, 
RTLD_LAZY
);

54 ià(!
hªdË
) {

55 
”rÜ
 = 
	`dË¼Ü
();

56 
	`ucc_debug
("failedo†oad UCC component†ibrary: %s (%s)",

57 
so_·th
, 
”rÜ
);

58 
”rÜ
;

60 
içû
 = (
ucc_compÚ’t_içû_t
 *)
	`dlsym
(
hªdË
, 
içû_¡ruù
);

61 ià((
”rÜ
 = 
	`dË¼Ü
()è!ğ
NULL
) {

62 
	`ucc_”rÜ
("çedØg‘ içû % äom % objeù (%s)", 
içû_¡ruù
,

63 
so_·th
, 
”rÜ
);

64 
içû_”rÜ
;

66 ià(!
içû
) {

67 
	`ucc_”rÜ
("içû % i NULL iÀ% objeù", 
içû_¡ruù
, 
so_·th
);

68 
içû_”rÜ
;

70 
içû
->
dl_hªdË
 = 
hªdË
;

71 
içû
->
id
 = 
	`ucc_¡r_hash_djb2
(içû->
Çme
);

72 (*
c_içû
èğ
içû
;

73  
UCC_OK
;

75 
içû_”rÜ
:

76 
	`dlşo£
(
hªdË
);

77 
”rÜ
:

78 *
c_içû
 = 
NULL
;

79  
UCC_ERR_NO_MESSAGE
;

80 
	}
}

82 
	#CHECK_COMPONENT_UNIQ
(
_äamewÜk
, 
_f›ld
) \

84 
ucc_compÚ’t_içû_t
 **
c
 = 
_äamewÜk
->
compÚ’ts
; \

85 
i
, 
j
; \

86 
i
 = 0; i < 
äamewÜk
->
n_compÚ’ts
; i++) { \

87 
j
 = 
i
 + 1; j < 
äamewÜk
->
n_compÚ’ts
; j++) { \

88 ià(
c
[
i
]->
_f›ld
 =ğc[
j
]->_field) { \

89 
	`ucc_”rÜ
("components %s‡nd %s havehe same " \

90 "deçuÉ " 
	`UCC_PP_MAKE_STRING
(
_f›ld
) " %lu", \

91 
c
[
i
]->
Çme
, c[
j
]->name, \

92 ()
c
[
i
]->
_f›ld
); \

93  
UCC_ERR_INVALID_PARAM
; \

97 } 0)

	)

99 
ucc_¡©us_t


100 
	$ucc_compÚ’t_check_scÜes_uniq
(
ucc_compÚ’t_äamewÜk_t
 *
äamewÜk
)

102 
	`CHECK_COMPONENT_UNIQ
(
äamewÜk
, 
scÜe
);

103  
UCC_OK
;

104 
	}
}

106 
ucc_¡©us_t


107 
	$ucc_compÚ’t_check_ids_uniq
(
ucc_compÚ’t_äamewÜk_t
 *
äamewÜk
)

109 
	`CHECK_COMPONENT_UNIQ
(
äamewÜk
, 
id
);

110  
UCC_OK
;

111 
	}
}

113 
ucc_¡©us_t
 
	$ucc_compÚ’ts_lßd
(cÚ¡ *
äamewÜk_Çme
,

114 
ucc_compÚ’t_äamewÜk_t
 *
äamewÜk
)

116 
glob_t
 
globbuf
;

117 
i
, 
n_lßded
;

118 *
fuÎ_·‰”n
;

119 
ucc_¡©us_t
 
¡©us
;

120 
size_t
 
·‰”n_size
;

121 
ucc_compÚ’t_içû_t
 **
içûs
 = 
NULL
;

123 
äamewÜk
->
n_compÚ’ts
 = 0;

124 
äamewÜk
->
compÚ’ts
 = 
NULL
;

126 ià(
	`¡¾’
(
äamewÜk_Çme
) == 0 ||

127 
	`¡¾’
(
äamewÜk_Çme
è> 
UCC_MAX_FRAMEWORK_NAME_LEN
) {

128 
	`ucc_”rÜ
("unsupported framework_name†ength: %s,†en %zd",

129 
äamewÜk_Çme
, 
	`¡¾’
(framework_name));

130  
UCC_ERR_INVALID_PARAM
;

133 
·‰”n_size
 =

134 
	`¡¾’
(
ucc_glob®_cÚfig
.
compÚ’t_·th
è+ sŒËn(
äamewÜk_Çme
) + 16;

135 
fuÎ_·‰”n
 = (*)
	`ucc_m®loc
(
·‰”n_size
, "full_pattern");

136 ià(!
fuÎ_·‰”n
) {

137 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for full_pattern",

138 
·‰”n_size
);

139  
UCC_ERR_NO_MEMORY
;

141 
	`ucc_¢´štf_§ã
(
fuÎ_·‰”n
, 
·‰”n_size
, "%s/libucc_%s_*.so",

142 
ucc_glob®_cÚfig
.
compÚ’t_·th
, 
äamewÜk_Çme
);

143 
	`glob
(
fuÎ_·‰”n
, 0, 
NULL
, &
globbuf
);

144 
	`ucc_ä“
(
fuÎ_·‰”n
);

145 
n_lßded
 = 0;

147 
	`dË¼Ü
();

148 
içûs
 = (
ucc_compÚ’t_içû_t
 **)
	`ucc_m®loc
(

149 
globbuf
.
gl_·thc
 * (
ucc_compÚ’t_içû_t
 *), "ifaces");

150 ià(!
içûs
) {

151 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ifaces",

152 
globbuf
.
gl_·thc
 * (
ucc_compÚ’t_içû_t
 *));

153  
UCC_ERR_NO_MEMORY
;

156 
i
 = 0; i < 
globbuf
.
gl_·thc
; i++) {

157 
¡©us
 = 
	`ucc_compÚ’t_lßd_Úe
(
globbuf
.
gl_·thv
[
i
], 
äamewÜk_Çme
,

158 &
içûs
[
n_lßded
]);

159 ià(
¡©us
 !ğ
UCC_OK
) {

162 
n_lßded
++;

165 
	`as£¹
(
n_lßded
 <ğ
globbuf
.
gl_·thc
);

166 ià(
globbuf
.
gl_·thc
 > 0) {

167 
	`globä“
(&
globbuf
);

169 ià(!
n_lßded
) {

170 ià(
içûs
) {

171 
	`ucc_ä“
(
içûs
);

173  
UCC_ERR_NOT_FOUND
;

176 
içûs
 = 
	`ucc_»®loc
(içûs, 
n_lßded
 * (
ucc_compÚ’t_içû_t
 *),

178 
äamewÜk
->
compÚ’ts
 = 
içûs
;

179 
äamewÜk
->
n_compÚ’ts
 = 
n_lßded
;

180 ià(
UCC_OK
 !ğ
	`ucc_compÚ’t_check_ids_uniq
(
äamewÜk
)) {

186 
	`ucc_”rÜ
("all components of‡ framwork must have uniq‚ame hash");

187 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

188 
”r
;

191 
äamewÜk
->
Çmes
.names =

192 
	`ucc_m®loc
((*è* 
n_lßded
, "components_names");

193 ià(!
äamewÜk
->
Çmes
.names) {

194 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for components‚ames",

195 (*è* 
n_lßded
);

196 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

197 
”r
;

199 
äamewÜk
->
Çmes
.
couÁ
 = 
n_lßded
;

200 
i
 = 0; i < 
n_lßded
; i++) {

201 
äamewÜk
->
Çmes
.Çmes[
i
] = 
	`¡rdup
(äamewÜk->
compÚ’ts
[i]->
Çme
);

203  
UCC_OK
;

204 
”r
:

205 
	`ucc_ä“
(
äamewÜk
->
compÚ’ts
);

206  
¡©us
;

207 
	}
}

209 
ucc_compÚ’t_içû_t
* 
	$ucc_g‘_compÚ’t
(
ucc_compÚ’t_äamewÜk_t
 *
äamewÜk
,

210 cÚ¡ *
compÚ’t_Çme
)

212 
i
;

213 
i
 = 0; i < 
äamewÜk
->
n_compÚ’ts
; i++) {

214 ià(0 =ğ
	`¡rcmp
(
äamewÜk
->
compÚ’ts
[
i
]->
Çme
, 
compÚ’t_Çme
)) {

215  
äamewÜk
->
compÚ’ts
[
i
];

218  
NULL
;

219 
	}
}

221 * 
	$ucc_g‘_äamewÜk_compÚ’ts_li¡
(
ucc_compÚ’t_äamewÜk_t
 *
äamewÜk
,

222 cÚ¡ * 
d–im™”
)

224 *
li¡
 = 
NULL
;

225 
size_t
 
Ën
 = 0;

226 
i
;

228 
i
 = 0; i < 
äamewÜk
->
n_compÚ’ts
; i++) {

230 
Ën
 +ğ
	`¡¾’
(
äamewÜk
->
compÚ’ts
[
i
]->
Çme
) + 1;

232 ià(
Ën
) {

233 
li¡
 = 
	`ucc_m®loc
(
Ën
 + 1, "components_list");

234 ià(!
li¡
) {

235 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜ compÚ’ts_li¡", 
Ën
);

236  
NULL
;

238 
li¡
[0] = '\0';

239 
i
 = 0; i < 
äamewÜk
->
n_compÚ’ts
; i++) {

240 
	`¡ºÿt
(
li¡
, 
äamewÜk
->
compÚ’ts
[
i
]->
Çme
, 
Ën
);

241 
Ën
 -ğ
	`¡¾’
(
äamewÜk
->
compÚ’ts
[
i
]->
Çme
);

242 ià(
i
 < 
äamewÜk
->
n_compÚ’ts
 - 1) {

243 
	`¡ºÿt
(
li¡
, 
d–im™”
, 
Ën
);

244 
Ën
 -ğ
	`¡¾’
(
d–im™”
);

248  
li¡
;

249 
	}
}

	@src/utils/ucc_component.h

6 #iâdeà
UCC_COMPONENT_H_


7 
	#UCC_COMPONENT_H_


	)

9 
	~"cÚfig.h
"

10 
	~"ucc/­i/ucc.h
"

11 
	~"uts/ucc_comp”_def.h
"

12 
	~"uts/ucc_·r£r.h
"

14 
	#UCC_MAX_FRAMEWORK_NAME_LEN
 64

	)

15 
	#UCC_MAX_COMPONENT_NAME_LEN
 64

	)

17 
	succ_compÚ’t_içû
 {

18 cÚ¡ *
	mÇme
;

19 
	mid
;

20 *
	mdl_hªdË
;

21 
ucc_scÜe_t
 
	mscÜe
;

22 } 
	tucc_compÚ’t_içû_t
;

24 
	succ_compÚ’t_äamewÜk
 {

25 *
	mäamewÜk_Çme
;

26 
	mn_compÚ’ts
;

27 
ucc_compÚ’t_içû_t
 **
	mcompÚ’ts
;

28 
ucc_cÚfig_Çmes_¬¿y_t
 
	mÇmes
;

29 } 
	tucc_compÚ’t_äamewÜk_t
;

38 
ucc_¡©us_t
 
ucc_compÚ’ts_lßd
(cÚ¡ *
äamewÜk_Çme
,

39 
ucc_compÚ’t_äamewÜk_t
 *
äamewÜk
);

44 
ucc_compÚ’t_içû_t
* 
ucc_g‘_compÚ’t
(
ucc_compÚ’t_äamewÜk_t
 *
äamewÜk
,

45 cÚ¡ *
compÚ’t_Çme
);

46 
ucc_¡©us_t


47 
ucc_compÚ’t_check_scÜes_uniq
(
ucc_compÚ’t_äamewÜk_t
 *
äamewÜk
);

48 * 
ucc_g‘_äamewÜk_compÚ’ts_li¡
(
ucc_compÚ’t_äamewÜk_t
 *
äamewÜk
,

49 cÚ¡ * 
d–im™”
);

	@src/utils/ucc_datastruct.c

7 
	~"ucc_d©a¡ruù.h
"

8 
	~"ucc_m®loc.h
"

9 
	~"ucc_comp”_def.h
"

10 
	~"ucc_log.h
"

12 
ucc_¡©us_t
 
	$ucc_m¿nge_ušt_cİy
(
ucc_m¿nge_ušt_t
 *
d¡
,

13 cÚ¡ 
ucc_m¿nge_ušt_t
 *
¤c
)

15 
ucc_m¿nge_t
 *
r
, *
r_dup
;

17 
d¡
->
deçuÉ_v®ue
 = 
¤c
->default_value;

18 
	`ucc_li¡_h—d_š™
(&
d¡
->
¿nges
);

19 
	`ucc_li¡_fÜ_—ch
(
r
, &
¤c
->
¿nges
, 
li¡_–em
) {

20 
r_dup
 = 
	`ucc_m®loc
((*r_dup), "range_dup");

21 ià(
	`ucc_uÆik–y
(!
r_dup
)) {

22 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for mrange",

23 (*
r_dup
));

24 
”r
;

26 
r_dup
->
¡¬t
 = 
r
->start;

27 
r_dup
->
’d
 = 
r
->end;

28 
r_dup
->
v®ue
 = 
r
->value;

29 
r_dup
->
mty³s
 = 
r
->mtypes;

30 
	`ucc_li¡_add_
(&
d¡
->
¿nges
, &
r_dup
->
li¡_–em
);

33  
UCC_OK
;

34 
”r
:

35 
	`ucc_m¿nge_ušt_de¡roy
(
d¡
);

36  
UCC_ERR_NO_MEMORY
;

37 
	}
}

39 
	$ucc_m¿nge_ušt_de¡roy
(
ucc_m¿nge_ušt_t
 *
·¿m
)

41 
ucc_m¿nge_t
 *
r
, *
r_tmp
;

43 
	`ucc_li¡_fÜ_—ch_§ã
(
r
, 
r_tmp
, &
·¿m
->
¿nges
, 
li¡_–em
) {

44 
	`ucc_li¡_d–
(&
r
->
li¡_–em
);

45 
	`ucc_ä“
(
r
);

47 
	}
}

	@src/utils/ucc_datastruct.h

6 #iâdeà
UCC_DATASTRUCT_H_


7 
	#UCC_DATASTRUCT_H_


	)

8 
	~<ucc/­i/ucc.h
>

9 
	~"ucc_li¡.h
"

10 
	~<¡dšt.h
>

12 
	#UCC_LIST_HEAD
 
UCS_LIST_HEAD


	)

13 
ušt32_t
 
	tucc_¿nk_t
;

14 
	#UCC_RANK_INVALID
 
UINT32_MAX


	)

15 
	#UCC_RANK_MAX
 
UCC_RANK_INVALID
 - 1

	)

17 
	succ_sub£t
 {

18 
ucc_•_m­_t
 
	mm­
;

19 
ucc_¿nk_t
 
	mmy¿nk
;

20 } 
	tucc_sub£t_t
;

22 
šlše
 
ucc_¿nk_t
 
	$ucc_sub£t_size
(
ucc_sub£t_t
 *
£t
)

24  (
ucc_¿nk_t
)
£t
->
m­
.
•_num
;

25 
	}
}

27 
	succ_m¿nge
 {

28 
ucc_li¡_lšk_t
 
	mli¡_–em
;

29 
size_t
 
	m¡¬t
;

30 
size_t
 
	m’d
;

31 
ušt32_t
 
	mmty³s
;

32 
	mv®ue
;

33 } 
	tucc_m¿nge_t
;

35 
	succ_m¿nge_ušt
 {

36 
ucc_li¡_lšk_t
 
	m¿nges
;

37 
	mdeçuÉ_v®ue
;

38 } 
	tucc_m¿nge_ušt_t
;

40 
ucc_¡©us_t
 
ucc_m¿nge_ušt_cİy
(
ucc_m¿nge_ušt_t
 *
d¡
,

41 cÚ¡ 
ucc_m¿nge_ušt_t
 *
¤c
);

43 
ucc_m¿nge_ušt_de¡roy
(
ucc_m¿nge_ušt_t
 *
·¿m
);

45 
šlše
 
	$ucc_m¿nge_ušt_g‘
(
ucc_m¿nge_ušt_t
 *
·¿m
,

46 
size_t
 
¿nge_v®ue
,

47 
ucc_memÜy_ty³_t
 
mem_ty³
)

49 
ucc_m¿nge_t
 *
r
;

51 
	`ucc_li¡_fÜ_—ch
(
r
, &
·¿m
->
¿nges
, 
li¡_–em
) {

52 ià(
r
->
¡¬t
 <ğ
¿nge_v®ue
 &&„ªge_v®u<ğr->
’d
 &&

53 (
	`UCC_BIT
(
mem_ty³
è& 
r
->
mty³s
)) {

54  
r
->
v®ue
;

57  
·¿m
->
deçuÉ_v®ue
;

58 
	}
}

	@src/utils/ucc_dt_reduce.h

6 #iâdeà
UCC_DT_REDUCE_H_


7 
	#UCC_DT_REDUCE_H_


	)

9 
	~"compÚ’ts/ec/ba£/ucc_ec_ba£.h
"

10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"compÚ’ts/ec/ucc_ec.h
"

13 
šlše
 
ucc_¡©us_t


14 
	$ucc_dt_»duû_u£rdefšed
(*
¤c1
, *
¤c2
, *
d¡
, 
size_t
 
n_veùÜs
,

15 
size_t
 
couÁ
, size_ˆ
¡ride
, 
ucc_dt_g’”ic_t
 *
dt
)

17 
ucc_»duû_cb_·¿ms_t
 
·¿ms
 = {.
mask
 = 0,

18 .
¤c1
 = src1,

19 .
¤c2
 = src2,

20 .
d¡
 = dst,

21 .
n_veùÜs
 =‚_vectors,

22 .
couÁ
 = count,

23 .
¡ride
 = stride,

24 .
dt
 = dt};

26  
dt
->
İs
.
»duû
.
	`cb
(&
·¿ms
);

27 
	}
}

29 
šlše
 
ucc_¡©us_t


30 
	$ucc_dt_»duû_¡rided
(*
¤c1
, *
¤c2
, *
d¡
, 
size_t
 
n_veùÜs
,

31 
size_t
 
couÁ
, size_ˆ
¡ride
, 
ucc_d©©y³_t
 
dt
,

32 
ucc_cŞl_¬gs_t
 *
¬gs
, 
ušt16_t
 
æags
, 
®pha
,

33 
ucc_“_executÜ_t
 *
exec
, 
ucc_“_executÜ_sk_t
 **
sk
)

35 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

37 ià(
couÁ
 =ğ0 || 
n_veùÜs
 == 0) {

38 *
sk
 = 
NULL
;

39  
UCC_OK
;

41 ià(!
	`UCC_DT_IS_PREDEFINED
(
dt
)) {

42 
	`ucc_as£¹
(
	`UCC_DT_HAS_REDUCE
(
dt
));

43 *
sk
 = 
NULL
;

44  
	`ucc_dt_»duû_u£rdefšed
(
¤c1
, 
¤c2
, 
d¡
, 
n_veùÜs
, 
couÁ
,

45 
¡ride
, 
	`ucc_dt_to_g’”ic
(
dt
));

47 
—rgs
.
æags
 = flags;

48 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
;

49 
—rgs
.
»duû_¡rided
.
couÁ
 = count;

50 
—rgs
.
»duû_¡rided
.
dt
 = dt;

51 
—rgs
.
»duû_¡rided
.
İ
 = 
¬gs
->op;

52 
—rgs
.
»duû_¡rided
.
n_¤c2
 = 
n_veùÜs
;

53 
—rgs
.
»duû_¡rided
.
d¡
 = dst;

54 
—rgs
.
»duû_¡rided
.
¤c1
 = src1;

55 
—rgs
.
»duû_¡rided
.
¤c2
 = src2;

56 
—rgs
.
»duû_¡rided
.
¡ride
 = stride;

57 
—rgs
.
»duû_¡rided
.
®pha
 =‡lpha;

59  
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
, 
sk
);

61 
	}
}

63 
šlše
 
ucc_¡©us_t
 
	$ucc_dt_»duû
(*
¤c1
, *
¤c2
, *
d¡
,

64 
size_t
 
couÁ
, 
ucc_d©©y³_t
 
dt
,

65 
ucc_cŞl_¬gs_t
 *
¬gs
, 
ušt16_t
 
æags
,

66 
®pha
, 
ucc_“_executÜ_t
 *
exec
,

67 
ucc_“_executÜ_sk_t
 **
sk
)

69  
	`ucc_dt_»duû_¡rided
(
¤c1
, 
¤c2
, 
d¡
, 1, 
couÁ
, 0, 
dt
, 
¬gs
, 
æags
,

70 
®pha
, 
exec
, 
sk
);

71 
	}
}

73 
šlše
 
ucc_¡©us_t
 
	$ucc_dt_»duû_muÉi
(**
¤cs
, *
d¡
,

74 
size_t
 
n_¤cs
,

75 
size_t
 
couÁ
, 
ucc_d©©y³_t
 
dt
,

76 
ucc_cŞl_¬gs_t
 *
¬gs
,

77 
ušt16_t
 
æags
, 
®pha
,

78 
ucc_“_executÜ_t
 *
exec
,

79 
ucc_“_executÜ_sk_t
 **
sk
)

81 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

83 
	`ucc_as£¹
(
n_¤cs
 <ğ
UCC_EE_EXECUTOR_NUM_BUFS
);

84 ià(
couÁ
 =ğ0 || 
n_¤cs
 == 0) {

85 *
sk
 = 
NULL
;

86  
UCC_OK
;

89 ià(!
	`UCC_DT_IS_PREDEFINED
(
dt
)) {

90 
	`ucc_as£¹
(
	`UCC_DT_HAS_REDUCE
(
dt
));

91 *
sk
 = 
NULL
;

92  
	`ucc_dt_»duû_u£rdefšed
(
¤cs
, 
NULL
, 
d¡
, 
n_¤cs
, 
couÁ
, 0,

93 
	`ucc_dt_to_g’”ic
(
dt
));

95 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_REDUCE
;

96 
—rgs
.
æags
 = flags;

97 
—rgs
.
»duû
.
®pha
 =‡lpha;

98 
—rgs
.
»duû
.
couÁ
 = count;

99 
—rgs
.
»duû
.
dt
 = dt;

100 
—rgs
.
»duû
.
İ
 = 
¬gs
->op;

101 
—rgs
.
»duû
.
d¡
 = dst;

102 
—rgs
.
»duû
.
n_¤cs
 =‚_srcs;

103 
size_t
 
i
 = 0; i < 
n_¤cs
; i++) {

104 
—rgs
.
»duû
.
¤cs
[
i
] = srcs[i];

107  
	`ucc_“_executÜ_sk_po¡
(
exec
, &
—rgs
, 
sk
);

109 
	}
}

	@src/utils/ucc_list.h

6 #iâdeà
UCC_LIST_H_


7 
	#UCC_LIST_H_


	)

9 
	~"cÚfig.h
"

10 
	~<ucs/d©a¡ruù/li¡.h
>

12 
	#ucc_li¡_lšk_t
 
ucs_li¡_lšk_t


	)

13 
	#ucc_li¡_h—d_š™
 
ucs_li¡_h—d_š™


	)

14 
	#ucc_li¡_add_
 
ucs_li¡_add_


	)

15 
	#ucc_li¡_d–
 
ucs_li¡_d–


	)

16 
	#ucc_li¡_fÜ_—ch_§ã
 
ucs_li¡_fÜ_—ch_§ã


	)

17 
	#ucc_li¡_fÜ_—ch
 
ucs_li¡_fÜ_—ch


	)

18 
	#ucc_li¡_is_em±y
 
ucs_li¡_is_em±y


	)

19 
	#ucc_li¡_exŒaù_h—d
 
ucs_li¡_exŒaù_h—d


	)

20 
	#ucc_li¡_Ëngth
 
ucs_li¡_Ëngth


	)

21 
	#ucc_li¡_h—d
 
ucs_li¡_h—d


	)

22 
	#ucc_li¡_
 
ucs_li¡_


	)

23 
	#ucc_li¡_Ãxt
 
ucs_li¡_Ãxt


	)

24 
	#ucc_li¡_š£¹_aá”
 
ucs_li¡_š£¹_aá”


	)

25 
	#ucc_li¡_š£¹_befÜe
 
ucs_li¡_š£¹_befÜe


	)

27 
	#ucc_li¡_de¡ruù
(
_li¡
, 
_–em_ty³
, 
_–em_de¡ruù
, 
_memb”
) \

29 
_–em_ty³
 *
_–em
, *
_tmp
; \

30 
	`ucc_li¡_fÜ_—ch_§ã
(
_–em
, 
_tmp
, 
_li¡
, 
_memb”
) \

32 
	`ucc_li¡_d–
(&
_–em
->
_memb”
); \

33 
	`_–em_de¡ruù
(
_–em
); \

35 } 0)

	)

	@src/utils/ucc_lock_free_queue.h

6 #iâdeà
UCC_LOCKFREE_QUEUE_H_


7 
	#UCC_LOCKFREE_QUEUE_H_


	)

9 
	~"uts/ucc_¥šlock.h
"

10 
	~"uts/ucc_©omic.h
"

11 
	~"uts/ucc_li¡.h
"

12 
	~<¡ršg.h
>

17 
	#LINE_SIZE
 8

	)

18 
	#NUM_POOLS
 2

	)

20 
	succ_lf_queue_–em
 {

21 
ušt8_t
 
	mwas_queued
;

22 
ucc_li¡_lšk_t
 
	mlocked_li¡_–em
;

23 } 
	tucc_lf_queue_–em_t
;

25 
	succ_lf_queue
 {

26 
ucc_¥šlock_t
 
	mlocked_queue_lock
[
NUM_POOLS
];

27 
ucc_lf_queue_–em_t
 *
	m–em’ts
[
NUM_POOLS
][
LINE_SIZE
];

28 
ušt8_t
 
	mwhich_poŞ
;

29 
ucc_li¡_lšk_t
 
	mlocked_queue
[
NUM_POOLS
];

30 } 
	tucc_lf_queue_t
;

32 
šlše
 
	$ucc_lf_queue_š™_–em
(
ucc_lf_queue_–em_t
 *
–em
){

33 
–em
->
was_queued
 = 0;

34 
	}
}

36 
šlše
 
	$ucc_lf_queue_’queue
(
ucc_lf_queue_t
 * 
queue
,

37 
ucc_lf_queue_–em_t
 *
–em
)

39 
ušt8_t
 
which_poŞ
 = 
–em
->
was_queued
 ^ (
queue
->which_pool & 1);

40 
i
;

41 
i
 = 0; i < 
LINE_SIZE
; i++) {

42 ià(
	`ucc_©omic_boŞ_csw­64
(

43 (
ušt64_t
 *)&(
queue
->
–em’ts
[
which_poŞ
][
i
]), 0LL,

44 (
ušt64_t
)
–em
)) {

48 
	`ucc_¥š_lock
(&
queue
->
locked_queue_lock
[
which_poŞ
]);

49 
	`ucc_li¡_add_
(&
queue
->
locked_queue
[
which_poŞ
],

50 &
–em
->
locked_li¡_–em
);

51 
	`ucc_¥š_uÆock
(&
queue
->
locked_queue_lock
[
which_poŞ
]);

52 
	}
}

54 
šlše
 
ucc_lf_queue_–em_t
 *
	$ucc_lf_queue_dequeue
(
ucc_lf_queue_t
 *
queue
,

55 
is_fœ¡_ÿÎ
)

58 
ušt8_t
 
cu¼_which_poŞ
 = 
queue
->
which_poŞ
;

59 
ušt8_t
 
which_poŞ
 = 
cu¼_which_poŞ
 & 1;

60 
i
;

61 
ucc_lf_queue_–em_t
 *
–em
;

62 
i
 = 0; i < 
LINE_SIZE
; i++) {

63 
–em
 = 
queue
->
–em’ts
[
which_poŞ
][
i
];

64 ià(
–em
) {

65 ià(
	`ucc_©omic_boŞ_csw­64
(

66 (
ušt64_t
 *)&(
queue
->
–em’ts
[
which_poŞ
][
i
]),

67 (
ušt64_t
)
–em
, 0LL)) {

68 
–em
->
was_queued
 = 1;

69  
–em
;

73 
–em
 = 
NULL
;

74 
	`ucc_¥š_lock
(&
queue
->
locked_queue_lock
[
which_poŞ
]);

75 ià(!
	`ucc_li¡_is_em±y
(&
queue
->
locked_queue
[
which_poŞ
])) {

76 
–em
 = 
	`ucc_li¡_exŒaù_h—d
(&
queue
->
locked_queue
[
which_poŞ
],

77 
ucc_lf_queue_–em_t
, 
locked_li¡_–em
);

78 
–em
->
was_queued
 = 1;

80 
	`ucc_¥š_uÆock
(&
queue
->
locked_queue_lock
[
which_poŞ
]);

81 ià(!
–em
) {

82 ià(
	`ucc_©omic_boŞ_csw­8
(&
queue
->
which_poŞ
, 
cu¼_which_poŞ
,

83 
cu¼_which_poŞ
 + 1è&& 
is_fœ¡_ÿÎ
) {

84  
	`ucc_lf_queue_dequeue
(
queue
, 0);

87  
–em
;

88 
	}
}

90 
šlše
 
	$ucc_lf_queue_de¡roy
(
ucc_lf_queue_t
 *
queue
)

92 
	`ucc_¥šlock_de¡roy
(&
queue
->
locked_queue_lock
[0]);

93 
	`ucc_¥šlock_de¡roy
(&
queue
->
locked_queue_lock
[1]);

94 
	}
}

96 
šlše
 
	$ucc_lf_queue_š™
(
ucc_lf_queue_t
 *
queue
)

98 
	`mem£t
(&
queue
->
–em’ts
, 0,

99 
NUM_POOLS
 * 
LINE_SIZE
 * (
ucc_lf_queue_–em_t
 *));

100 
	`ucc_¥šlock_š™
(&
queue
->
locked_queue_lock
[0], 0);

101 
	`ucc_¥šlock_š™
(&
queue
->
locked_queue_lock
[1], 0);

102 
	`ucc_li¡_h—d_š™
(&
queue
->
locked_queue
[0]);

103 
	`ucc_li¡_h—d_š™
(&
queue
->
locked_queue
[1]);

104 
queue
->
which_poŞ
 = 0;

105 
	}
}

	@src/utils/ucc_log.h

7 #iâdeà
UCC_LOG_H_


8 
	#UCC_LOG_H_


	)

10 
	~"cÚfig.h
"

11 
	~"cÜe/ucc_glob®_İts.h
"

12 
	~"cÜe/ucc_dt.h
"

13 
	~<ucs/debug/log_def.h
>

15 
	#UCC_LOG_LEVEL_ERROR
 
UCS_LOG_LEVEL_ERROR


	)

16 
	#UCC_LOG_LEVEL_WARN
 
UCS_LOG_LEVEL_WARN


	)

17 
	#UCC_LOG_LEVEL_DIAG
 
UCS_LOG_LEVEL_DIAG


	)

18 
	#UCC_LOG_LEVEL_INFO
 
UCS_LOG_LEVEL_INFO


	)

19 
	#UCC_LOG_LEVEL_DEBUG
 
UCS_LOG_LEVEL_DEBUG


	)

20 
	#UCC_LOG_LEVEL_TRACE
 
UCS_LOG_LEVEL_TRACE


	)

22 
	#ucc_log_g‘_bufãr_size
 
ucs_log_g‘_bufãr_size


	)

23 
	#ucc_log_çl_”rÜ
 
ucs_log_çl_”rÜ


	)

24 
	#ucc_log_æush
 
ucs_log_æush


	)

27 
	#ucc_log_compÚ’t
(
_Ëv–
, 
_compÚ’t
, 
_fmt
, ...) \

29 
	`ucs_log_compÚ’t
(
_Ëv–
, &
_compÚ’t
, 
_fmt
, ##
__VA_ARGS__
); \

30 } 0)

	)

33 
	#ucc_log_compÚ’t_glob®
(
_Ëv–
, 
fmt
, ...) \

34 
	`ucc_log_compÚ’t
(
_Ëv–
, 
ucc_glob®_cÚfig
.
log_compÚ’t
, 
fmt
, \

35 ##
__VA_ARGS__
)

	)

36 
	#ucc_”rÜ
(
_fmt
, ...) \

37 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_ERROR
, 
_fmt
, ##
__VA_ARGS__
)

	)

38 
	#ucc_w¬n
(
_fmt
, ...) \

39 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_WARN
, 
_fmt
, ##
__VA_ARGS__
)

	)

40 
	#ucc_dŸg
(
_fmt
, ...) \

41 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_DIAG
, 
_fmt
, ##
__VA_ARGS__
)

	)

42 
	#ucc_šfo
(
_fmt
, ...) \

43 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_INFO
, 
_fmt
, ##
__VA_ARGS__
)

	)

44 
	#ucc_debug
(
_fmt
, ...) \

45 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_DEBUG
, 
_fmt
, ##
__VA_ARGS__
)

	)

46 
	#ucc_Œaû
(
_fmt
, ...) \

47 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_TRACE
, 
_fmt
, ##
__VA_ARGS__
)

	)

48 
	#ucc_Œaû_»q
(
_fmt
, ...) \

49 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_TRACE_REQ
, 
_fmt
, ##
__VA_ARGS__
)

	)

50 
	#ucc_Œaû_d©a
(
_fmt
, ...) \

51 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_TRACE_DATA
, 
_fmt
, ##
__VA_ARGS__
)

	)

52 
	#ucc_Œaû_async
(
_fmt
, ...) \

53 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_TRACE_ASYNC
, 
_fmt
, ##
__VA_ARGS__
)

	)

54 
	#ucc_Œaû_func
(
_fmt
, ...) \

55 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_TRACE_FUNC
, "%s(" 
_fmt
 ")", \

56 
__FUNCTION__
, ##
__VA_ARGS__
)

	)

57 
	#ucc_Œaû_pŞl
(
_fmt
, ...) \

58 
	`ucc_log_compÚ’t_glob®
(
UCS_LOG_LEVEL_TRACE_POLL
, 
_fmt
, ##
__VA_ARGS__
)

	)

61 
	#ucc_log_compÚ’t_cŞËùive_Œaû
(
_Ëv–
, 
fmt
, ...) \

62 
	`ucc_log_compÚ’t
(
_Ëv–
, 
ucc_glob®_cÚfig
.
cŞl_Œaû
, 
fmt
, \

63 ##
__VA_ARGS__
)

	)

65 
	#ucc_cŞl_Œaû_šfo
(
_fmt
, ...) \

66 
	`ucc_log_compÚ’t_cŞËùive_Œaû
(
UCS_LOG_LEVEL_INFO
, 
_fmt
, ##
__VA_ARGS__
)

	)

67 
	#ucc_cŞl_Œaû_debug
(
_fmt
, ...) \

68 
	`ucc_log_compÚ’t_cŞËùive_Œaû
(
UCS_LOG_LEVEL_DEBUG
, 
_fmt
, ##
__VA_ARGS__
)

	)

83 
	#ucc_´št
(
_fmt
, ...) \

85 
	`ucs_log_di¥©ch
(
__FILE__
, 
__LINE__
, 
__FUNCTION__
, \

86 
UCS_LOG_LEVEL_PRINT
, \

87 &
ucc_glob®_cÚfig
.
log_compÚ’t
, \

88 
_fmt
, ## 
__VA_ARGS__
); \

89 } 0)

	)

91 
šlše
 cÚ¡ * 
	$ucc_cŞl_ty³_¡r
(
ucc_cŞl_ty³_t
 
ù
)

93 
ù
) {

94 
UCC_COLL_TYPE_BARRIER
:

96 
UCC_COLL_TYPE_BCAST
:

98 
UCC_COLL_TYPE_ALLREDUCE
:

100 
UCC_COLL_TYPE_REDUCE
:

102 
UCC_COLL_TYPE_ALLTOALL
:

104 
UCC_COLL_TYPE_ALLTOALLV
:

106 
UCC_COLL_TYPE_ALLGATHER
:

108 
UCC_COLL_TYPE_ALLGATHERV
:

110 
UCC_COLL_TYPE_GATHER
:

112 
UCC_COLL_TYPE_GATHERV
:

114 
UCC_COLL_TYPE_SCATTER
:

116 
UCC_COLL_TYPE_SCATTERV
:

118 
UCC_COLL_TYPE_FANIN
:

120 
UCC_COLL_TYPE_FANOUT
:

122 
UCC_COLL_TYPE_REDUCE_SCATTER
:

124 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

130 
	}
}

132 
šlše
 cÚ¡ * 
	$ucc_d©©y³_¡r
(
ucc_d©©y³_t
 
dt
)

134 
dt
) {

135 
UCC_DT_INT8
:

137 
UCC_DT_UINT8
:

139 
UCC_DT_INT16
:

141 
UCC_DT_UINT16
:

143 
UCC_DT_FLOAT16
:

145 
UCC_DT_BFLOAT16
:

147 
UCC_DT_INT32
:

149 
UCC_DT_UINT32
:

151 
UCC_DT_FLOAT32
:

153 
UCC_DT_INT64
:

155 
UCC_DT_UINT64
:

157 
UCC_DT_FLOAT64
:

159 
UCC_DT_FLOAT128
:

161 
UCC_DT_INT128
:

163 
UCC_DT_UINT128
:

165 
UCC_DT_FLOAT32_COMPLEX
:

167 
UCC_DT_FLOAT64_COMPLEX
:

169 
UCC_DT_FLOAT128_COMPLEX
:

174 
	}
}

176 
šlše
 cÚ¡ * 
	$ucc_»duùiÚ_İ_¡r
(
ucc_»duùiÚ_İ_t
 
İ
)

178 
İ
) {

179 
UCC_OP_SUM
:

181 
UCC_OP_PROD
:

183 
UCC_OP_MAX
:

185 
UCC_OP_MIN
:

187 
UCC_OP_LAND
:

189 
UCC_OP_LOR
:

191 
UCC_OP_LXOR
:

193 
UCC_OP_BAND
:

195 
UCC_OP_BOR
:

197 
UCC_OP_BXOR
:

199 
UCC_OP_MAXLOC
:

201 
UCC_OP_MINLOC
:

203 
UCC_OP_AVG
:

206  
NULL
;

208 
	}
}

210 
šlše
 cÚ¡ * 
	$ucc_mem_ty³_¡r
(
ucc_memÜy_ty³_t
 
ù
)

212 ()
ù
) {

213 
UCC_MEMORY_TYPE_HOST
:

215 
UCC_MEMORY_TYPE_CUDA
:

217 
UCC_MEMORY_TYPE_CUDA_MANAGED
:

219 
UCC_MEMORY_TYPE_ROCM
:

221 
UCC_MEMORY_TYPE_ROCM_MANAGED
:

223 
UCC_MEMORY_TYPE_ASYMMETRIC
:

225 
UCC_MEMORY_TYPE_NOT_APPLY
:

231 
	}
}

233 
šlše
 cÚ¡ * 
	$ucc_th»ad_mode_¡r
(
ucc_th»ad_mode_t
 
tm
)

235 
tm
) {

236 
UCC_THREAD_SINGLE
:

238 
UCC_THREAD_FUNNELED
:

240 
UCC_THREAD_MULTIPLE
:

245 
	}
}

247 
šlše
 cÚ¡ * 
	$ucc_cÚ‹xt_ty³_¡r
(
ucc_cÚ‹xt_ty³_t
 
ù
)

249 
ù
) {

250 
UCC_CONTEXT_EXCLUSIVE
:

252 
UCC_CONTEXT_SHARED
:

257 
	}
}

	@src/utils/ucc_malloc.h

6 #iâdeà
UCC_MALLOC_H_


7 
	#UCC_MALLOC_H_


	)

9 
	~"cÚfig.h
"

10 
	~<¡dlib.h
>

12 
	#ucc_m®loc
(
_s
, ...è
	`m®loc
(_s)

	)

13 
	#ucc_posix_mem®ign
(
_±r
, 
_®ign
, 
_size
, ...è
	`posix_mem®ign
(_±r, _®ign, _size)

	)

14 
	#ucc_ÿÎoc
(
_n
, 
_s
, ...è
	`ÿÎoc
(_n, _s)

	)

15 
	#ucc_»®loc
(
_p
, 
_s
, ...è
	`»®loc
(_p, _s)

	)

16 
	#ucc_ä“
(
_p
è
	`ä“
(_p)

	)

	@src/utils/ucc_math.c

6 
	~"ucc/­i/ucc.h
"

7 
	~"ucc_m©h.h
"

9 
	$_com·»
(cÚ¡ *
a
, cÚ¡ *
b
)

11  (*(*)
a
 - *(*)
b
);

12 
	}
}

14 
	$_com·»_šv
(cÚ¡ *
a
, cÚ¡ *
b
)

16  (*(*)
b
 - *(*)
a
);

17 
	}
}

19 
šlše
 
	$_unique
(*
fœ¡
, *
Ï¡
)

21 *
begš
 = 
fœ¡
;

22 *
»suÉ
 = 
fœ¡
;

23 ià(
fœ¡
 =ğ
Ï¡
) {

26 ++
fœ¡
 !ğ
Ï¡
) {

27 ià(!(*
»suÉ
 =ğ*
fœ¡
)) {

28 *(++
»suÉ
èğ*
fœ¡
;

31  (++
»suÉ
 - 
begš
);

32 
	}
}

34 
	$ucc_sÜt_uniq
(*
¬¿y
, 
Ën
, 
šv”£
)

36 
	`qsÜt
(
¬¿y
, 
Ën
, (), 
šv”£
 ? 
_com·»_šv
 : 
_com·»
);

37  
	`_unique
(
¬¿y
,‡¼ay + 
Ën
);

38 
	}
}

	@src/utils/ucc_math.h

7 #iâdeà
UCC_MATH_H_


8 
	#UCC_MATH_H_


	)

10 
	~"cÚfig.h
"

11 
	~<ucs/sys/m©h.h
>

12 
	~"ucc_d©a¡ruù.h
"

13 
	~"ucc/­i/ucc.h
"

14 
	~"ucc_comp”_def.h
"

16 
	#ucc_mš
(
_a
, 
_b
è
	`ucs_mš
((_a), (_b))

	)

17 
	#ucc_max
(
_a
, 
_b
è
	`ucs_max
((_a), (_b))

	)

18 
	#ucc_og2
(
_v
è
	`ucs_og2
((_v))

	)

19 
	#ucc_û
(
_a
, 
_b
è(((_a)%(_b))?((_a)/(_b)+1)*(_b):(_a))

	)

21 
	#DO_OP_MAX
(
_v1
, 
_v2
è(_v1 > _v2 ? _v1 : _v2)

	)

22 
	#DO_OP_MIN
(
_v1
, 
_v2
è(_v1 < _v2 ? _v1 : _v2)

	)

23 
	#DO_OP_SUM
(
_v1
, 
_v2
è(_v1 + _v2)

	)

24 
	#DO_OP_PROD
(
_v1
, 
_v2
è(_v1 * _v2)

	)

25 
	#DO_OP_LAND
(
_v1
, 
_v2
è(_v1 && _v2)

	)

26 
	#DO_OP_BAND
(
_v1
, 
_v2
è(_v1 & _v2)

	)

27 
	#DO_OP_LOR
(
_v1
, 
_v2
è(_v1 || _v2)

	)

28 
	#DO_OP_BOR
(
_v1
, 
_v2
è(_v1 | _v2)

	)

29 
	#DO_OP_LXOR
(
_v1
, 
_v2
è((!_v1è!ğ(!_v2))

	)

30 
	#DO_OP_BXOR
(
_v1
, 
_v2
è(_v1 ^ _v2)

	)

32 
	#PTR_OFFSET
(
_±r
, 
_off£t
) \

33 ((*)((
±rdiff_t
)(
_±r
è+ (
size_t
)(
_off£t
)))

	)

38 
	#ucc_couÁ_Œašg_z”o_b™s
(
_n
) \

39 (((
_n
è<ğ4è? 
	`__butš_ùz
((
ušt32_t
)(_n)è: 
	`__butš_ùzl
(_n))

	)

44 
	#ucc_couÁ_Ëadšg_z”o_b™s
(
_n
) \

45 (((
_n
è<ğ4è? 
	`__butš_şz
((
ušt32_t
)(_n)è: 
	`__butš_şzl
(_n))

	)

49 
šlše
 
	$ucc_¡r_hash_djb2
(cÚ¡ *
¡r
)

51 
hash
 = 5381;

52 
c
;

54 '\0' !ğ(
c
 = *
¡r
++)) {

55 
hash
 = ((hash << 5è+ hashè+ 
c
;

57  
hash
;

58 
	}
}

62 
ucc_sÜt_uniq
(*
¬¿y
, 
Ën
, 
šv”£
);

64 
	#SWAP
(
_x
, 
_y
, 
_ty³
) \

66 
_ty³
 
_tmp
 = (
_x
); \

67 (
_x
èğ(
_y
); \

68 (
_y
èğ
_tmp
; \

69 } 0)

	)

71 
	#ucc_div_round_up
(
_n
, 
_d
è(((_nè+ (_dè- 1è/ (_d))

	)

74 
šlše
 
ušt32_t
 
	$ÿlc_v®u©iÚ
(
ušt32_t
 
n
, ušt32_ˆ
p
)

76 
ušt32_t
 
v
 = 0;

77 
ušt32_t
 
q
 = 
n
;

78 
q
 % 
p
 == 0) {

79 
v
++;

80 
q
 /ğ
p
;

82  
v
;

83 
	}
}

85 
šlše
 
	$bæßt16toæßt32
(cÚ¡ *
bæßt16_±r
)

87 
»s
 = 0;

88 #ià
UCC_BIG_ENDIAN


89 ((
ušt16_t
 *)(&
»s
))[0] = *((ušt16_ˆ*)
bæßt16_±r
);

91 ((
ušt16_t
 *)(&
»s
))[1] = *((ušt16_ˆ*)
bæßt16_±r
);

93  
»s
;

94 
	}
}

96 
šlše
 
	$æßt32tobæßt16
(
æßt_v®
, *
bæßt16_±r
)

98 #ià
UCC_BIG_ENDIAN


99 *((
ušt16_t
 *)
bæßt16_±r
èğ((ušt16_ˆ*)(&
æßt_v®
))[0];

101 *((
ušt16_t
 *)
bæßt16_±r
èğ((ušt16_ˆ*)(&
æßt_v®
))[1];

103 
	}
}

105 
	#ucc_·ddšg
(
_n
, 
_®ignm’t
) \

106 Ğ((
_®ignm’t
è- (
_n
è% (_®ignm’t)è% (_®ignm’tè)

	)

108 
	#ucc_®ign_down
(
_n
, 
_®ignm’t
) \

109 Ğ(
_n
è- ((_nè% (
_®ignm’t
)è)

	)

111 
	#ucc_®ign_up
(
_n
, 
_®ignm’t
) \

112 Ğ(
_n
è+ 
	`ucc_·ddšg
(_n, 
_®ignm’t
è)

	)

114 
	#ucc_®ign_down_pow2
(
_n
, 
_®ignm’t
) \

115 Ğ(
_n
è& ~((
_®ignm’t
è- 1è)

	)

117 
	#ucc_®ign_up_pow2
(
_n
, 
_®ignm’t
) \

118 
	`ucc_®ign_down_pow2
((
_n
è+ (
_®ignm’t
è- 1, _®ignm’t)

	)

121 
šlše
 
	$lognum
(
n
)

123 
couÁ
 = 1;

124 
lognum
 = 0;

126 
couÁ
 < 
n
) {

127 
couÁ
 = count << 1;

128 
lognum
++;

130  
lognum
;

131 
	}
}

134 
šlše
 
ušt32_t
 
	$ucc_og2_û
(
ušt32_t
 
n
)

136 
x
 = 
	`ucc_couÁ_Ëadšg_z”o_b™s
(
n
);

137 ià(!(
n
 & (n - 1))) {

138  31 - 
x
;

140  31 - 
x
 + 1;

141 
	}
}

144 
šlše
 
	$ucc_round_up_pow”2
(
v®ue
)

146 ià(
v®ue
 <= 1) {

149  1 << (32 - 
	`ucc_couÁ_Ëadšg_z”o_b™s
(
v®ue
 - 1));

150 
	}
}

	@src/utils/ucc_math_op.h

7 #iâdeà
UCC_MATH_OP_H_


8 
	#UCC_MATH_OP_H_


	)

9 
	~"ucc_m©h.h
"

11 
	#DO_OP_2
(
_İ
, 
_v1
, 
_v2
è(_v1 _İ _v2)

	)

12 
	#DO_OP_3
(
_İ
, 
_v1
, 
_v2
, 
_v3
è(_v1 _İ _v2 _İ _v3)

	)

13 
	#DO_OP_4
(
_İ
, 
_v1
, 
_v2
, 
_v3
, 
_v4
è(_v1 _İ _v2 _İ _v3 _İ _v4)

	)

14 
	#DO_OP_5
(
_İ
, 
_v1
, 
_v2
, 
_v3
, 
_v4
, 
_v5
) \

15 (
_v1
 
_İ
 
_v2
 _İ 
_v3
 _İ 
_v4
 _İ 
_v5
)

	)

16 
	#DO_OP_6
(
_İ
, 
_v1
, 
_v2
, 
_v3
, 
_v4
, 
_v5
, 
_v6
) \

17 (
_v1
 
_İ
 
_v2
 _İ 
_v3
 _İ 
_v4
 _İ 
_v5
 _İ 
_v6
)

	)

18 
	#DO_OP_7
(
_İ
, 
_v1
, 
_v2
, 
_v3
, 
_v4
, 
_v5
, 
_v6
, 
_v7
) \

19 (
_v1
 
_İ
 
_v2
 _İ 
_v3
 _İ 
_v4
 _İ 
_v5
 _İ 
_v6
 _İ 
_v7
)

	)

20 
	#DO_OP_8
(
_İ
, 
_v1
, 
_v2
, 
_v3
, 
_v4
, 
_v5
, 
_v6
, 
_v7
, 
_v8
) \

21 (
_v1
 
_İ
 
_v2
 _İ 
_v3
 _İ 
_v4
 _İ 
_v5
 _İ 
_v6
 _İ 
_v7
 _İ 
_v8
)

	)

23 
	#DO_OP_SUM_2
(...è
	`DO_OP_2
(+, 
__VA_ARGS__
)

	)

24 
	#DO_OP_SUM_3
(...è
	`DO_OP_3
(+, 
__VA_ARGS__
)

	)

25 
	#DO_OP_SUM_4
(...è
	`DO_OP_4
(+, 
__VA_ARGS__
)

	)

26 
	#DO_OP_SUM_5
(...è
	`DO_OP_5
(+, 
__VA_ARGS__
)

	)

27 
	#DO_OP_SUM_6
(...è
	`DO_OP_6
(+, 
__VA_ARGS__
)

	)

28 
	#DO_OP_SUM_7
(...è
	`DO_OP_7
(+, 
__VA_ARGS__
)

	)

29 
	#DO_OP_SUM_8
(...è
	`DO_OP_8
(+, 
__VA_ARGS__
)

	)

31 
	#DO_OP_PROD_2
(...è
	`DO_OP_2
(*, 
__VA_ARGS__
)

	)

32 
	#DO_OP_PROD_3
(...è
	`DO_OP_3
(*, 
__VA_ARGS__
)

	)

33 
	#DO_OP_PROD_4
(...è
	`DO_OP_4
(*, 
__VA_ARGS__
)

	)

34 
	#DO_OP_PROD_5
(...è
	`DO_OP_5
(*, 
__VA_ARGS__
)

	)

35 
	#DO_OP_PROD_6
(...è
	`DO_OP_6
(*, 
__VA_ARGS__
)

	)

36 
	#DO_OP_PROD_7
(...è
	`DO_OP_7
(*, 
__VA_ARGS__
)

	)

37 
	#DO_OP_PROD_8
(...è
	`DO_OP_8
(*, 
__VA_ARGS__
)

	)

39 
	#DO_OP_LAND_2
(...è
	`DO_OP_2
(&&, 
__VA_ARGS__
)

	)

40 
	#DO_OP_LAND_3
(...è
	`DO_OP_3
(&&, 
__VA_ARGS__
)

	)

41 
	#DO_OP_LAND_4
(...è
	`DO_OP_4
(&&, 
__VA_ARGS__
)

	)

42 
	#DO_OP_LAND_5
(...è
	`DO_OP_5
(&&, 
__VA_ARGS__
)

	)

43 
	#DO_OP_LAND_6
(...è
	`DO_OP_6
(&&, 
__VA_ARGS__
)

	)

44 
	#DO_OP_LAND_7
(...è
	`DO_OP_7
(&&, 
__VA_ARGS__
)

	)

45 
	#DO_OP_LAND_8
(...è
	`DO_OP_8
(&&, 
__VA_ARGS__
)

	)

47 
	#DO_OP_BAND_2
(...è
	`DO_OP_2
(&, 
__VA_ARGS__
)

	)

48 
	#DO_OP_BAND_3
(...è
	`DO_OP_3
(&, 
__VA_ARGS__
)

	)

49 
	#DO_OP_BAND_4
(...è
	`DO_OP_4
(&, 
__VA_ARGS__
)

	)

50 
	#DO_OP_BAND_5
(...è
	`DO_OP_5
(&, 
__VA_ARGS__
)

	)

51 
	#DO_OP_BAND_6
(...è
	`DO_OP_6
(&, 
__VA_ARGS__
)

	)

52 
	#DO_OP_BAND_7
(...è
	`DO_OP_7
(&, 
__VA_ARGS__
)

	)

53 
	#DO_OP_BAND_8
(...è
	`DO_OP_8
(&, 
__VA_ARGS__
)

	)

55 
	#DO_OP_LOR_2
(...è
	`DO_OP_2
(||, 
__VA_ARGS__
)

	)

56 
	#DO_OP_LOR_3
(...è
	`DO_OP_3
(||, 
__VA_ARGS__
)

	)

57 
	#DO_OP_LOR_4
(...è
	`DO_OP_4
(||, 
__VA_ARGS__
)

	)

58 
	#DO_OP_LOR_5
(...è
	`DO_OP_5
(||, 
__VA_ARGS__
)

	)

59 
	#DO_OP_LOR_6
(...è
	`DO_OP_6
(||, 
__VA_ARGS__
)

	)

60 
	#DO_OP_LOR_7
(...è
	`DO_OP_7
(||, 
__VA_ARGS__
)

	)

61 
	#DO_OP_LOR_8
(...è
	`DO_OP_8
(||, 
__VA_ARGS__
)

	)

63 
	#DO_OP_BOR_2
(...è
	`DO_OP_2
(|, 
__VA_ARGS__
)

	)

64 
	#DO_OP_BOR_3
(...è
	`DO_OP_3
(|, 
__VA_ARGS__
)

	)

65 
	#DO_OP_BOR_4
(...è
	`DO_OP_4
(|, 
__VA_ARGS__
)

	)

66 
	#DO_OP_BOR_5
(...è
	`DO_OP_5
(|, 
__VA_ARGS__
)

	)

67 
	#DO_OP_BOR_6
(...è
	`DO_OP_6
(|, 
__VA_ARGS__
)

	)

68 
	#DO_OP_BOR_7
(...è
	`DO_OP_7
(|, 
__VA_ARGS__
)

	)

69 
	#DO_OP_BOR_8
(...è
	`DO_OP_8
(|, 
__VA_ARGS__
)

	)

71 
	#DO_OP_BXOR_2
(...è
	`DO_OP_2
(^, 
__VA_ARGS__
)

	)

72 
	#DO_OP_BXOR_3
(...è
	`DO_OP_3
(^, 
__VA_ARGS__
)

	)

73 
	#DO_OP_BXOR_4
(...è
	`DO_OP_4
(^, 
__VA_ARGS__
)

	)

74 
	#DO_OP_BXOR_5
(...è
	`DO_OP_5
(^, 
__VA_ARGS__
)

	)

75 
	#DO_OP_BXOR_6
(...è
	`DO_OP_6
(^, 
__VA_ARGS__
)

	)

76 
	#DO_OP_BXOR_7
(...è
	`DO_OP_7
(^, 
__VA_ARGS__
)

	)

77 
	#DO_OP_BXOR_8
(...è
	`DO_OP_8
(^, 
__VA_ARGS__
)

	)

79 
	#DO_OP__3
(
_OP
, 
_v1
, 
_v2
, 
_v3
è
	`_OP
(_OP(_v1, _v2), _v3)

	)

80 
	#DO_OP__4
(
_OP
, 
_v1
, 
_v2
, 
_v3
, 
_v4
è
	`_OP
(_OP(_v1, _v2), _OP(_v3, _v4))

	)

81 
	#DO_OP__5
(
_OP
, 
_v1
, 
_v2
, 
_v3
, 
_v4
, 
_v5
) \

82 
	`_OP
(_OP(
_v1
, 
_v2
), 
	`DO_OP__3
(
_OP
, 
_v3
, 
_v4
, 
_v5
))

	)

83 
	#DO_OP__6
(
_OP
, 
_v1
, 
_v2
, 
_v3
, 
_v4
, 
_v5
, 
_v6
) \

84 
	`_OP
(
	`DO_OP__3
(
_OP
, 
_v1
, 
_v2
, 
_v3
), DO_OP__3(_OP, 
_v4
, 
_v5
, 
_v6
))

	)

85 
	#DO_OP__7
(
_OP
, 
_v1
, 
_v2
, 
_v3
, 
_v4
, 
_v5
, 
_v6
, 
_v7
) \

86 
	`_OP
(
	`DO_OP__3
(
_OP
, 
_v1
, 
_v2
, 
_v3
), 
	`DO_OP__4
(_OP, 
_v4
, 
_v5
, 
_v6
, 
_v7
))

	)

87 
	#DO_OP__8
(
_OP
, 
_v1
, 
_v2
, 
_v3
, 
_v4
, 
_v5
, 
_v6
, 
_v7
, 
_v8
) \

88 
	`_OP
(
	`DO_OP__4
(
_OP
, 
_v1
, 
_v2
, 
_v3
, 
_v4
), DO_OP__4(_OP, 
_v5
, 
_v6
, 
_v7
, 
_v8
))

	)

90 
	#DO_OP_MAX_2
(
_v1
, 
_v2
è
	`DO_OP_MAX
(_v1, _v2)

	)

91 
	#DO_OP_MAX_3
(...è
	`DO_OP__3
(
DO_OP_MAX
, 
__VA_ARGS__
)

	)

92 
	#DO_OP_MAX_4
(...è
	`DO_OP__4
(
DO_OP_MAX
, 
__VA_ARGS__
)

	)

93 
	#DO_OP_MAX_5
(...è
	`DO_OP__5
(
DO_OP_MAX
, 
__VA_ARGS__
)

	)

94 
	#DO_OP_MAX_6
(...è
	`DO_OP__6
(
DO_OP_MAX
, 
__VA_ARGS__
)

	)

95 
	#DO_OP_MAX_7
(...è
	`DO_OP__7
(
DO_OP_MAX
, 
__VA_ARGS__
)

	)

96 
	#DO_OP_MAX_8
(...è
	`DO_OP__8
(
DO_OP_MAX
, 
__VA_ARGS__
)

	)

98 
	#DO_OP_MIN_2
(
_v1
, 
_v2
è
	`DO_OP_MIN
(_v1, _v2)

	)

99 
	#DO_OP_MIN_3
(...è
	`DO_OP__3
(
DO_OP_MIN
, 
__VA_ARGS__
)

	)

100 
	#DO_OP_MIN_4
(...è
	`DO_OP__4
(
DO_OP_MIN
, 
__VA_ARGS__
)

	)

101 
	#DO_OP_MIN_5
(...è
	`DO_OP__5
(
DO_OP_MIN
, 
__VA_ARGS__
)

	)

102 
	#DO_OP_MIN_6
(...è
	`DO_OP__6
(
DO_OP_MIN
, 
__VA_ARGS__
)

	)

103 
	#DO_OP_MIN_7
(...è
	`DO_OP__7
(
DO_OP_MIN
, 
__VA_ARGS__
)

	)

104 
	#DO_OP_MIN_8
(...è
	`DO_OP__8
(
DO_OP_MIN
, 
__VA_ARGS__
)

	)

106 
	#DO_OP_LXOR_2
(
_v1
, 
_v2
è
	`DO_OP_LXOR
(_v1, _v2)

	)

107 
	#DO_OP_LXOR_3
(...è
	`DO_OP__3
(
DO_OP_LXOR
, 
__VA_ARGS__
)

	)

108 
	#DO_OP_LXOR_4
(...è
	`DO_OP__4
(
DO_OP_LXOR
, 
__VA_ARGS__
)

	)

109 
	#DO_OP_LXOR_5
(...è
	`DO_OP__5
(
DO_OP_LXOR
, 
__VA_ARGS__
)

	)

110 
	#DO_OP_LXOR_6
(...è
	`DO_OP__6
(
DO_OP_LXOR
, 
__VA_ARGS__
)

	)

111 
	#DO_OP_LXOR_7
(...è
	`DO_OP__7
(
DO_OP_LXOR
, 
__VA_ARGS__
)

	)

112 
	#DO_OP_LXOR_8
(...è
	`DO_OP__8
(
DO_OP_LXOR
, 
__VA_ARGS__
)

	)

	@src/utils/ucc_mpool.c

1 
	~"ucc_mpoŞ.h
"

2 
	~"ucc_m®loc.h
"

3 
	~"ucc_log.h
"

5 
ucc_mpoŞ_İs_t
 
	gucc_deçuÉ_mpoŞ_İs
 = {

6 .
chunk_®loc
 = 
ucc_mpoŞ_hug‘lb_m®loc
,

7 .
	gchunk_»Ëa£
 = 
ucc_mpoŞ_hug‘lb_ä“
,

8 .
	gobj_š™
 = 
NULL
,

9 .
	gobj_ş—nup
 = 
NULL


12 
ucs_¡©us_t


13 
	$ucc_mpoŞ_chunk_®loc_w¿µ”
(
ucs_mpoŞ_t
 *
mp
, 
size_t
 *
size_p
, **
chunk_p
)

15 
ucc_mpoŞ_t
 *
mpoŞ
 = 
	`ucc_d”ived_of
(
mp
, ucc_mpool_t);

16 
ucc_¡©us_t
 
¡
;

18 
¡
 = 
mpoŞ
->
ucc_İs
->
	`chunk_®loc
(mpoŞ, 
size_p
, 
chunk_p
);

19  
	`ucc_¡©us_to_ucs_¡©us
(
¡
);

20 
	}
}

22 
	$ucc_mpoŞ_chunk_»Ëa£_w¿µ”
(
ucs_mpoŞ_t
 *
mp
, *
chunk
)

24 
ucc_mpoŞ_t
 *
mpoŞ
 = 
	`ucc_d”ived_of
(
mp
, ucc_mpool_t);

25 
mpoŞ
->
ucc_İs
->
	`chunk_»Ëa£
(mpoŞ, 
chunk
);

26 
	}
}

28 
	$ucc_mpoŞ_obj_š™_w¿µ”
(
ucs_mpoŞ_t
 *
mp
, *
obj
, *
chunk
)

30 
ucc_mpoŞ_t
 *
mpoŞ
 = 
	`ucc_d”ived_of
(
mp
, ucc_mpool_t);

31 
mpoŞ
->
ucc_İs
->
	`obj_š™
(mpoŞ, 
obj
, 
chunk
);

32 
	}
}

34 
	$ucc_mpoŞ_obj_ş—nup_w¿µ”
(
ucs_mpoŞ_t
 *
mp
, *
obj
)

36 
ucc_mpoŞ_t
 *
mpoŞ
 = 
	`ucc_d”ived_of
(
mp
, ucc_mpool_t);

37 
mpoŞ
->
ucc_İs
->
	`obj_ş—nup
(mpoŞ, 
obj
);

38 
	}
}

40 
ucc_¡©us_t
 
	$ucc_mpoŞ_š™
(
ucc_mpoŞ_t
 *
mp
, 
size_t
 
´iv_size
, size_ˆ
–em_size
,

41 
size_t
 
®ign_off£t
, size_ˆ
®ignm’t
,

42 
–ems_³r_chunk
, 
max_–ems
,

43 
ucc_mpoŞ_İs_t
 *
İs
, 
ucc_th»ad_mode_t
 
tm
,

44 cÚ¡ *
Çme
)

46 
ucs_mpoŞ_İs_t
 *
ucs_İs
 = 
	`ucc_ÿÎoc
(1, (*ucs_ops), "mpool_ops");

47 #ià
UCS_HAVE_MPOOL_PARAMS


48 
ucs_mpoŞ_·¿ms_t
 
·¿ms
;

51 ià(!
ucs_İs
) {

52 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for mpool ucs ops",

53 (*
ucs_İs
));

54  
UCC_ERR_NO_MEMORY
;

57 
	`ucc_¥šlock_š™
(&
mp
->
lock
, 0);

58 
mp
->
tm
 =m;

59 
mp
->
ucc_İs
 = 
İs
 ? op : &
ucc_deçuÉ_mpoŞ_İs
;

60 
ucs_İs
->
chunk_®loc
 = 
ucc_mpoŞ_chunk_®loc_w¿µ”
;

61 
ucs_İs
->
chunk_»Ëa£
 = 
ucc_mpoŞ_chunk_»Ëa£_w¿µ”
;

62 ià(
mp
->
ucc_İs
->
obj_š™
 !ğ
NULL
) {

63 
ucs_İs
->
obj_š™
 = 
ucc_mpoŞ_obj_š™_w¿µ”
;

65 ià(
mp
->
ucc_İs
->
obj_ş—nup
 !ğ
NULL
) {

66 
ucs_İs
->
obj_ş—nup
 = 
ucc_mpoŞ_obj_ş—nup_w¿µ”
;

68 #ià
UCS_HAVE_MPOOL_PARAMS


69 
	`ucs_mpoŞ_·¿ms_»£t
(&
·¿ms
);

70 
·¿ms
.
´iv_size
 =…riv_size;

71 
·¿ms
.
–em_size
 =ƒlem_size;

72 
·¿ms
.
®ign_off£t
 =‡lign_offset;

73 
·¿ms
.
®ignm’t
 =‡lignment;

74 
·¿ms
.
m®loc_§ã
 = 0;

75 
·¿ms
.
–ems_³r_chunk
 =ƒlems_per_chunk;

76 
·¿ms
.
max_chunk_size
 = 
SIZE_MAX
;

77 
·¿ms
.
max_–ems
 = max_elems;

78 
·¿ms
.
grow_çùÜ
 = 1.0;

79 
·¿ms
.
İs
 = 
ucs_İs
;

80 
·¿ms
.
Çme
 =‚ame;

82  
	`ucs_¡©us_to_ucc_¡©us
(
	`ucs_mpoŞ_š™
(&
·¿ms
, &
mp
->
su³r
));

84  
	`ucs_¡©us_to_ucc_¡©us
(

85 
	`ucs_mpoŞ_š™
(&
mp
->
su³r
, 
´iv_size
, 
–em_size
, 
®ign_off£t
,

86 
®ignm’t
, 
–ems_³r_chunk
, 
max_–ems
, 
ucs_İs
, 
Çme
));

88 
	}
}

90 
	$ucc_mpoŞ_ş—nup
(
ucc_mpoŞ_t
 *
mp
, 
Ëak_check
)

92 *
İs
 = (*)
mp
->
su³r
.
d©a
->ops;

94 
	`ucs_mpoŞ_ş—nup
(&
mp
->
su³r
, 
Ëak_check
);

95 
	`ucc_ä“
(
İs
);

96 
	`ucc_¥šlock_de¡roy
(&
mp
->
lock
);

97 
	}
}

99 
ucc_¡©us_t
 
	$ucc_mpoŞ_hug‘lb_m®loc
(
ucc_mpoŞ_t
 *
mp
, 
size_t
 *
size_p
,

100 **
chunk_p
)

102 
ucs_¡©us_t
 
¡
;

104 
¡
 = 
	`ucs_mpoŞ_hug‘lb_m®loc
(&
mp
->
su³r
, 
size_p
, 
chunk_p
);

105  
	`ucs_¡©us_to_ucc_¡©us
(
¡
);

106 
	}
}

108 
	$ucc_mpoŞ_hug‘lb_ä“
(
ucc_mpoŞ_t
 *
mp
, *
chunk
)

110 
	`ucs_mpoŞ_hug‘lb_ä“
(&
mp
->
su³r
, 
chunk
);

111 
	}
}

	@src/utils/ucc_mpool.h

6 #iâdeà
UCC_MPOOL_H_


7 
	#UCC_MPOOL_H_


	)

9 
	~"cÚfig.h
"

10 
	~"ucc/­i/ucc.h
"

11 
	~<ucs/d©a¡ruù/mpoŞ.h
>

12 
	~"ucc_comp”_def.h
"

13 
	~"ucc_¥šlock.h
"

15 
ucc_mpoŞ
 
	tucc_mpoŞ_t
;

17 
	succ_mpoŞ_İs
 {

18 
ucc_¡©us_t
 (*
chunk_®loc
)(
ucc_mpoŞ_t
 *
	mmp
, 
size_t
 *
	msize_p
,

19 **
	mchunk_p
);

20 (*
	mchunk_»Ëa£
)(
ucc_mpoŞ_t
 *
	mmp
, *
	mchunk
);

21 (*
	mobj_š™
)(
ucc_mpoŞ_t
 *
	mmp
, *
	mobj
, *
	mchunk
);

22 (*
	mobj_ş—nup
)(
ucc_mpoŞ_t
 *
	mmp
, *
	mobj
);

23 } 
	tucc_mpoŞ_İs_t
;

25 
	succ_mpoŞ
 {

26 
ucs_mpoŞ_t
 
	msu³r
;

27 
ucc_mpoŞ_İs_t
 * 
	mucc_İs
;

28 
ucc_th»ad_mode_t
 
	mtm
;

29 
ucc_¥šlock_t
 
	mlock
;

32 
ucc_¡©us_t
 
ucc_mpoŞ_š™
(
ucc_mpoŞ_t
 *
mp
, 
size_t
 
´iv_size
, size_ˆ
–em_size
,

33 
size_t
 
®ign_off£t
, size_ˆ
®ignm’t
,

34 
–ems_³r_chunk
, 
max_–ems
,

35 
ucc_mpoŞ_İs_t
 *
İs
, 
ucc_th»ad_mode_t
 
tm
,

36 cÚ¡ *
Çme
);

38 
ucc_mpoŞ_ş—nup
(
ucc_mpoŞ_t
 *
mp
, 
Ëak_check
);

40 
ucc_¡©us_t
 
ucc_mpoŞ_hug‘lb_m®loc
(
ucc_mpoŞ_t
 *
mp
, 
size_t
 *
size_p
,

41 **
chunk_p
);

43 
ucc_mpoŞ_hug‘lb_ä“
(
ucc_mpoŞ_t
 *
mp
, *
chunk
);

45 
šlše
 *
	$ucc_mpoŞ_g‘
(
ucc_mpoŞ_t
 *
mp
)

47 *
»t
;

49 ià(
UCC_THREAD_SINGLE
 =ğ
mp
->
tm
) {

50  
	`ucs_mpoŞ_g‘
(&
mp
->
su³r
);

52 
	`ucc_¥š_lock
(&
mp
->
lock
);

53 
»t
 = 
	`ucs_mpoŞ_g‘
(&
mp
->
su³r
);

54 
	`ucc_¥š_uÆock
(&
mp
->
lock
);

55  
»t
;

56 
	}
}

58 
šlše
 
	$ucc_mpoŞ_put
(*
obj
)

60 
ucs_mpoŞ_–em_t
 *
–em
 = (ucs_mpoŞ_–em_ˆ*)
obj
 - 1;

61 
ucc_mpoŞ_t
 * 
mp
 = 
	`ucc_d”ived_of
(
–em
->
mpoŞ
, ucc_mpool_t);

63 ià(
UCC_THREAD_SINGLE
 =ğ
mp
->
tm
) {

64 
	`ucs_mpoŞ_put
(
obj
);

67 
	`ucc_¥š_lock
(&
mp
->
lock
);

68 
	`ucs_mpoŞ_put
(
obj
);

69 
	`ucc_¥š_uÆock
(&
mp
->
lock
);

70 
	}
}

	@src/utils/ucc_parser.c

7 
	~"ucc_·r£r.h
"

8 
	~"ucc_m®loc.h
"

9 
	~"ucc_log.h
"

10 
	~"ucc_¡ršg.h
"

11 
	~"ši.h
"

12 
	~"scheduË/ucc_scheduË.h
"

13 
	~"scheduË/ucc_scheduË_p–šed.h
"

15 
	#UCC_ADD_KEY_VALUE_TO_HASH
(
_ty³
, 
_h
, 
_Çme
, 
_v®
) \

17 
kh™”_t
 
_™”
; \

18 
_»s
; \

19 *
_dup
; \

20 
_™”
 = 
	`kh_g‘
(
_ty³
, 
_h
, 
_Çme
); \

21 ià(
_™”
 !ğ
	`kh_’d
(
_h
)) { \

22 
	`ucc_w¬n
("found du¶iÿ‹ '%s' iÀcÚfig fe", 
_Çme
); \

25 
_dup
 = 
	`¡rdup
(
_Çme
); \

26 ià(!
_dup
) { \

27 
	`ucc_”rÜ
("failedo dup str for kh_put"); \

30 
_™”
 = 
	`kh_put
(
_ty³
, 
_h
, 
_dup
, &
_»s
); \

31 ià(
_»s
 =ğ
UCS_KH_PUT_FAILED
) { \

32 
	`ucc_ä“
(
_dup
); \

33 
	`ucc_”rÜ
("š£¹šg '%s'ØcÚfig m­ faed", 
_Çme
); \

37 
_dup
 = 
	`¡rdup
(
_v®
); \

38 ià(!
_dup
) { \

39 
	`ucc_”rÜ
("failedo dup str for kh_val"); \

42 
	`kh_v®
(
_h
, 
_™”
èğ
_dup
; \

44 } 0)

	)

46 
	$ucc_check_£ùiÚ
(
ucc_£ùiÚ_desc_t
 
£c_desc
,

47 
ucc_ıu_v’dÜ_t
 
v’dÜ
,

48 
ucc_ıu_mod–_t
 
mod–
,

49 
ucc_¿nk_t
 
‹am_size
,

50 
ucc_¿nk_t
 
µn_mš
,

51 
ucc_¿nk_t
 
µn_max
,

52 
ucc_¿nk_t
 
sock_mš
,

53 
ucc_¿nk_t
 
sock_max
,

54 
ucc_¿nk_t
 
Âodes
)

56 ià(
£c_desc
.
mask
 & 
UCC_TUNING_DESC_FIELD_VENDOR
) {

57 ià(
£c_desc
.
v’dÜ
 != vendor) {

61 ià(
£c_desc
.
mask
 & 
UCC_TUNING_DESC_FIELD_MODEL
) {

62 ià(
£c_desc
.
mod–
 != model) {

66 ià(
£c_desc
.
mask
 & 
UCC_TUNING_DESC_FIELD_TEAM_SIZE
) {

67 ià(
‹am_size
 < 
£c_desc
.
mš_‹am_size
 ||

68 
‹am_size
 > 
£c_desc
.
max_‹am_size
) {

72 ià(
£c_desc
.
mask
 & 
UCC_TUNING_DESC_FIELD_PPN
) {

73 ià(
µn_mš
 < 
£c_desc
.
mš_µn
 || 
µn_max
 > sec_desc.
max_µn
) {

77 ià(
£c_desc
.
mask
 & 
UCC_TUNING_DESC_FIELD_SOCK
) {

78 ià(
sock_mš
 < 
£c_desc
.
mš_sock
 || 
sock_max
 > sec_desc.
max_sock
) {

82 ià(
£c_desc
.
mask
 & 
UCC_TUNING_DESC_FIELD_NNODES
) {

83 ià(
Âodes
 < 
£c_desc
.
mš_Âodes
 ||‚node > sec_desc.
max_Âodes
) {

88 
	}
}

90 
šlše
 
	$ucc_check_¿nge
(*
¿nge_¡r
, 
ucc_¿nk_t
 *
begš
,

91 
ucc_¿nk_t
 *
’d
)

93 **
¿nge
 = 
	`ucc_¡r_¥l™
(
¿nge_¡r
, "-");

94 *
¡r_’d
;

95 
n_¿nge
;

96 
pbegš
, 
³nd
;

98 ià(!
¿nge
) {

99 
¥l™_”r
;

102 
n_¿nge
 = 
	`ucc_¡r_¥l™_couÁ
(
¿nge
);

103 
pbegš
 = 
	`¡¹Ş
(
¿nge
[0], &
¡r_’d
, 10);

104 
³nd
 = 
pbegš
;

106 ià(
n_¿nge
 > 2 || *
¡r_’d
 !ğ'\0' || 
pbegš
 < 0) {

107 
v®_”r
;

110 ià(
n_¿nge
 == 2) {

111 
³nd
 = 
	`¡¹Ş
(
¿nge
[1], &
¡r_’d
, 10);

112 ià(*
¡r_’d
 !ğ'\0' || 
³nd
 < 0) {

113 
v®_”r
;

116 *
begš
 = (
ucc_¿nk_t
)
pbegš
;

117 *
’d
 = (
ucc_¿nk_t
)
³nd
;

118 
	`ucc_¡r_¥l™_ä“
(
¿nge
);

121 
v®_”r
:

122 
	`ucc_¡r_¥l™_ä“
(
¿nge
);

123 
¥l™_”r
:

124 
	`ucc_w¬n
("invalid„ange defined in section‚ame\n");

126 
	}
}

128 
šlše
 
ucc_¡©us_t


129 
	$ucc_·r£_£ùiÚ_Çme_to_desc
(cÚ¡ *
£c_Çme
, 
ucc_£ùiÚ_desc_t
 *
desc
)

131 **
¥l™
, **
cur_¡r
;

132 
n_¥l™
, 
i
;

134 
¥l™
 = 
	`ucc_¡r_¥l™
(
£c_Çme
, " ");

135 ià(!
¥l™
) {

136 
	`ucc_w¬n
("invalid section‚ame\n");

137  
UCC_ERR_INVALID_PARAM
;

140 
desc
->
mask
 = 0;

141 
n_¥l™
 = 
	`ucc_¡r_¥l™_couÁ
(
¥l™
);

142 
i
 = 0; i < 
n_¥l™
; i++) {

143 
cur_¡r
 = 
	`ucc_¡r_¥l™
(
¥l™
[
i
], "=");

144 ià(!
cur_¡r
) {

145 
	`ucc_w¬n
("invalid section key=value definition\n");

146 
”r_cur_¡r
;

148 ià(
	`¡rÿ£cmp
(
cur_¡r
[0], "vendor") == 0) {

149 
desc
->
v’dÜ
 = 
	`ucc_g‘_v’dÜ_äom_¡r
(
cur_¡r
[1]);

150 
desc
->
mask
 |ğ
UCC_TUNING_DESC_FIELD_VENDOR
;

152 ià(
	`¡rcmp
(
cur_¡r
[0], "model") == 0) {

153 
desc
->
mod–
 = 
	`ucc_g‘_mod–_äom_¡r
(
cur_¡r
[1]);

154 
desc
->
mask
 |ğ
UCC_TUNING_DESC_FIELD_MODEL
;

156 ià(
	`¡rcmp
(
cur_¡r
[0], "team_size") == 0) {

157 ià(!
	`ucc_check_¿nge
(
cur_¡r
[1], &
desc
->
mš_‹am_size
,

158 &
desc
->
max_‹am_size
)) {

159 
”r_key
;

161 
desc
->
mask
 |ğ
UCC_TUNING_DESC_FIELD_TEAM_SIZE
;

163 ià(
	`¡rcmp
(
cur_¡r
[0], "ppn") == 0) {

164 ià(!
	`ucc_check_¿nge
(
cur_¡r
[1], &
desc
->
mš_µn
,

165 &
desc
->
max_µn
)) {

166 
”r_key
;

168 
desc
->
mask
 |ğ
UCC_TUNING_DESC_FIELD_PPN
;

170 ià(
	`¡rcmp
(
cur_¡r
[0], "sock") == 0) {

171 ià(!
	`ucc_check_¿nge
(
cur_¡r
[1], &
desc
->
mš_sock
,

172 &
desc
->
max_sock
)) {

173 
”r_key
;

175 
desc
->
mask
 |ğ
UCC_TUNING_DESC_FIELD_SOCK
;

177 ià(
	`¡rcmp
(
cur_¡r
[0], "nnodes") == 0) {

178 ià(!
	`ucc_check_¿nge
(
cur_¡r
[1], &
desc
->
mš_Âodes
,

179 &
desc
->
max_Âodes
)) {

180 
”r_key
;

182 
desc
->
mask
 |ğ
UCC_TUNING_DESC_FIELD_NNODES
;

184 
	`ucc_w¬n
("key %s‚ot defined‡s…art ofuning section…arams\n",

185 
cur_¡r
[0]);

186 
”r_key
;

188 
	`ucc_¡r_¥l™_ä“
(
cur_¡r
);

190 
	`ucc_¡r_¥l™_ä“
(
¥l™
);

191  
UCC_OK
;

192 
”r_key
:

193 
	`ucc_¡r_¥l™_ä“
(
cur_¡r
);

194 
”r_cur_¡r
:

195 
	`ucc_¡r_¥l™_ä“
(
¥l™
);

196  
UCC_ERR_INVALID_PARAM
;

197 
	}
}

199 
ucc_¡©us_t
 
	$ucc_cÚfig_Çmes_¬¿y_m”ge
(
ucc_cÚfig_Çmes_¬¿y_t
 *
d¡
,

200 cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
¤c
)

202 
i
, 
n_Ãw
;

204 
n_Ãw
 = 0;

205 ià(
d¡
->
couÁ
 == 0) {

206  
	`ucc_cÚfig_Çmes_¬¿y_dup
(
d¡
, 
¤c
);

208 
i
 = 0; i < 
¤c
->
couÁ
; i++) {

209 ià(
	`ucc_cÚfig_Çmes_£¬ch
(
d¡
, 
¤c
->
Çmes
[
i
]) < 0) {

211 
n_Ãw
++;

215 ià(
n_Ãw
) {

216 
d¡
->
Çmes
 =

217 
	`ucc_»®loc
(
d¡
->
Çmes
, (d¡->
couÁ
 + 
n_Ãw
) * (*),

219 ià(
	`ucc_uÆik–y
(!
d¡
->
Çmes
)) {

220  
UCC_ERR_NO_MEMORY
;

222 
i
 = 0; i < 
¤c
->
couÁ
; i++) {

223 ià(
	`ucc_cÚfig_Çmes_£¬ch
(
d¡
, 
¤c
->
Çmes
[
i
]) < 0) {

224 
d¡
->
Çmes
[d¡->
couÁ
++] = 
	`¡rdup
(
¤c
->Çmes[
i
]);

225 ià(
	`ucc_uÆik–y
(!
d¡
->
Çmes
[d¡->
couÁ
 - 1])) {

226 
	`ucc_”rÜ
("failedo dup config_names_arrayƒntry");

227  
UCC_ERR_NO_MEMORY
;

233  
UCC_OK
;

234 
	}
}

236 
ucc_¡©us_t
 
	$ucc_cÚfig_Çmes_¬¿y_dup
(
ucc_cÚfig_Çmes_¬¿y_t
 *
d¡
,

237 cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
¤c
)

239 
i
;

241 ià(
d¡
->
couÁ
 != 0) {

242 
	`ucc_cÚfig_Çmes_¬¿y_ä“
(
d¡
);

244 
d¡
->
Çmes
 = 
	`ucc_m®loc
((*è* 
¤c
->
couÁ
, "ucc_config_names_array");

245 ià(!
d¡
->
Çmes
) {

246 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for ucc_config_names_array",

247 (*è* 
¤c
->
couÁ
);

248  
UCC_ERR_NO_MEMORY
;

250 
d¡
->
couÁ
 = 
¤c
->count;

251 
i
 = 0; i < 
¤c
->
couÁ
; i++) {

252 
d¡
->
Çmes
[
i
] = 
	`¡rdup
(
¤c
->names[i]);

253 ià(!
d¡
->
Çmes
[
i
]) {

254 
	`ucc_”rÜ
("failedo dup config_names_arrayƒntry");

255 
”r
;

258  
UCC_OK
;

259 
”r
:

260 
i
 = i - 1; i >= 0; i--) {

261 
	`ä“
(
d¡
->
Çmes
[
i
]);

263  
UCC_ERR_NO_MEMORY
;

264 
	}
}

266 
ucc_¡©us_t
 
	$ucc_cÚfig_Çmes_¬¿y_to_¡ršg
(cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
¬¿y
,

267 *
¡r
, 
size_t
 
max
)

269 
size_t
 
cur_Ën
 = 0;

270 
size_t
 
i
;

271 
»t
;

273 ià(!
¡r
 || !
¬¿y
 || 
max
 == 0) {

274  
UCC_ERR_INVALID_PARAM
;

277 
i
 = 0; i < 
¬¿y
->
couÁ
; i++) {

278 
»t
 = 
	`¢´štf
(
¡r
 + 
cur_Ën
, 
max
 - cur_len, "%s%s",

279 
¬¿y
->
Çmes
[
i
],

280 (
i
 < 
¬¿y
->
couÁ
 - 1) ? "," : "");

281 ià(
»t
 < 0) {

282  
UCC_ERR_NO_MEMORY
;

284 
cur_Ën
 +ğ
»t
;

286  
UCC_OK
;

287 
	}
}

290 
	$ucc_cÚfig_Çmes_¬¿y_ä“
(
ucc_cÚfig_Çmes_¬¿y_t
 *
¬¿y
)

292 
i
;

293 ià(
¬¿y
->
Çmes
 !ğ
NULL
) {

294 
i
 = 0; i < 
¬¿y
->
couÁ
; i++) {

295 
	`ä“
(
¬¿y
->
Çmes
[
i
]);

297 
	`ucc_ä“
(
¬¿y
->
Çmes
);

299 
¬¿y
->
couÁ
 = 0;

300 
	}
}

302 
	$ucc_cÚfig_Çmes_£¬ch
(cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
cÚfig_Çmes
,

303 cÚ¡ * 
¡r
)

305 
i
;

307 
i
 = 0; i < 
cÚfig_Çmes
->
couÁ
; ++i) {

308 ià(!
	`¡rcmp
(
cÚfig_Çmes
->
Çmes
[
i
], 
¡r
)) {

309  
i
;

314 
	}
}

316 
ucc_¡©us_t
 
	$ucc_cÚfig_®low_li¡_´oûss
(cÚ¡ 
ucc_cÚfig_®low_li¡_t
 * 
li¡
,

317 cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
®l
,

318 
ucc_cÚfig_Çmes_li¡_t
 * 
out
)

320 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

321 
i
;

323 
out
->
¬¿y
.
Çmes
 = 
NULL
;

324 
out
->
»que¡ed
 = 0;

326 
li¡
->
mode
){

327 
UCC_CONFIG_ALLOW_LIST_ALLOW
:

328 
out
->
»que¡ed
 = 1;

329 
¡©us
 = 
	`ucc_cÚfig_Çmes_¬¿y_dup
(&
out
->
¬¿y
, &
li¡
->array);

331 
UCC_CONFIG_ALLOW_LIST_ALLOW_ALL
:

332 
¡©us
 = 
	`ucc_cÚfig_Çmes_¬¿y_dup
(&
out
->
¬¿y
, 
®l
);

334 
UCC_CONFIG_ALLOW_LIST_NEGATE
:

335 
out
->
¬¿y
.
couÁ
 = 0;

336 
out
->
¬¿y
.
Çmes
 = 
	`ucc_m®loc
((*è* 
®l
->
couÁ
, "names");

337 ià(!
out
->
¬¿y
.
Çmes
) {

338 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for‚ames‡rray",

339 (*è* 
®l
->
couÁ
);

340 
¡©us
 = 
UCC_ERR_NO_MEMORY
;

343 
i
 = 0; i < 
®l
->
couÁ
; i++) {

344 ià(
	`ucc_cÚfig_Çmes_£¬ch
(&
li¡
->
¬¿y
, 
®l
->
Çmes
[
i
]) < 0) {

345 
out
->
¬¿y
.
Çmes
[out->¬¿y.
couÁ
++] = 
	`¡rdup
(
®l
->Çmes[
i
]);

350 
	`ucc_as£¹
(0);

352  
¡©us
;

353 
	}
}

355 
	$ucc_fe_·r£_hªdËr
(*
¬g
, cÚ¡ *
£ùiÚ
,

356 cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

358 
ucc_fe_cÚfig_t
 *
cfg
 = 
¬g
;

359 
	`khash_t
(
ucc_cfg_fe
è*
v¬s
 = &
cfg
->vars;

360 
	`khash_t
(
ucc_£ùiÚs
è*
£ùiÚs
 = &
cfg
->sections;

361 
ucc_£ùiÚ_w¿p_t
 *
£c_w¿p
;

362 
kh™”_t
 
™”
;

363 
»suÉ
;

364 *
dup
;

365 
ucc_¡©us_t
 
¡©us
;

367 ià(!
Çme
) {

370 ià(
NULL
 !ğ
	`g‘’v
(
Çme
)) {

376 ià(
	`¡¾’
(
Çme
è< 4 || 
NULL
 =ğ
	`¡r¡r
(name, "UCC_")) {

377 
	`ucc_w¬n
("incorrect…arameter‚ame %s "

379 
Çme
);

383 ià(
	`¡¾’
(
£ùiÚ
) > 0) {

385 
™”
 = 
	`kh_g‘
(
ucc_£ùiÚs
, 
£ùiÚs
, 
£ùiÚ
);

386 ià(
™”
 =ğ
	`kh_’d
(
£ùiÚs
)) {

387 
£c_w¿p
 = 
	`ucc_ÿÎoc
(1, (*sec_wrap),

388 
	`¡rÿt
("£ùiÚ cfg: ", 
£ùiÚ
));

389 ià(!
£c_w¿p
) {

390 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for section config",

391 (*
£c_w¿p
));

394 
dup
 = 
	`¡rdup
(
£ùiÚ
);

395 ià(!
dup
) {

396 
	`ucc_ä“
(
£c_w¿p
);

397 
	`ucc_”rÜ
("failedo dup str for kh_put");

400 
™”
 = 
	`kh_put
(
ucc_£ùiÚs
, 
£ùiÚs
, 
dup
, &
»suÉ
);

401 ià(
»suÉ
 =ğ
UCS_KH_PUT_FAILED
) {

402 
	`ucc_ä“
(
£c_w¿p
);

403 
	`ucc_ä“
(
dup
);

404 
	`ucc_”rÜ
("š£¹šg '%s'ØcÚfig m­ faed", 
Çme
);

407 
¡©us
 = 
	`ucc_·r£_£ùiÚ_Çme_to_desc
(
£ùiÚ
, &
£c_w¿p
->
desc
);

408 ià(
¡©us
 !ğ
UCC_OK
) {

409 
	`ucc_ä“
(
£c_w¿p
);

410 
	`ucc_ä“
(
dup
);

414 
	`kh_š™_š¶aû
(
ucc_£c
, &
£c_w¿p
->
v®s_h
);

415 
	`kh_v®
(
£ùiÚs
, 
™”
èğ
£c_w¿p
;

417 
£c_w¿p
 = 
	`kh_v®
(
£ùiÚs
, 
™”
);

419 
	`UCC_ADD_KEY_VALUE_TO_HASH
(
ucc_£c
, &
£c_w¿p
->
v®s_h
, 
Çme
, 
v®ue
);

422 
	`UCC_ADD_KEY_VALUE_TO_HASH
(
ucc_cfg_fe
, 
v¬s
, 
Çme
, 
v®ue
);

423 
	}
}

425 
ucc_¡©us_t
 
	$ucc_·r£_fe_cÚfig
(cÚ¡ * 
f’ame
,

426 
ucc_fe_cÚfig_t
 **
cfg_p
)

428 
ucc_fe_cÚfig_t
 *
cfg
;

429 
»t
;

430 
ucc_¡©us_t
 
¡©us
;

432 
cfg
 = 
	`ucc_ÿÎoc
(1, (*cfg), "file_cfg");

433 ià(!
cfg
) {

434 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for file config",

435 (*
cfg
));

436  
UCC_ERR_NO_MEMORY
;

438 
	`kh_š™_š¶aû
(
ucc_cfg_fe
, &
cfg
->
v¬s
);

439 
	`kh_š™_š¶aû
(
ucc_£ùiÚs
, &
cfg
->
£ùiÚs
);

440 
»t
 = 
	`ucc_ši_·r£
(
f’ame
, 
ucc_fe_·r£_hªdËr
, 
cfg
);

441 ià(-1 =ğ
»t
) {

444 
¡©us
 = 
UCC_ERR_NOT_FOUND
;

445 
out
;

446 } ià(
»t
) {

447 
	`ucc_”rÜ
("çedØ·r£ cÚfig f%s", 
f’ame
);

448 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

449 
out
;

451 
cfg
->
f’ame
 = 
	`¡rdup
(filename);

453 *
cfg_p
 = 
cfg
;

454  
UCC_OK
;

455 
out
:

456 
	`ucc_ä“
(
cfg
);

457  
¡©us
;

458 
	}
}

460 
	$ucc_»Ëa£_fe_cÚfig
(
ucc_fe_cÚfig_t
 *
cfg
)

462 cÚ¡ *
key
, *
£ùiÚ_key
;

463 *
v®ue
, *
£ùiÚ_v®
;

464 
	`khash_t
(
ucc_£c
è*
£ùiÚ
;

465 
ucc_£ùiÚ_w¿p_t
 *
£c_w¿p
;

466 
j
;

468 
	`ucc_ä“
(
cfg
->
f’ame
);

469 
	`kh_fÜ—ch
(&
cfg
->
v¬s
, 
key
, 
v®ue
, {

470 
	`ucc_ä“
((*)
key
);

471 
	`ucc_ä“
(
v®ue
);

472 }è
	`kh_de¡roy_š¶aû
(
ucc_cfg_fe
, &
cfg
->
v¬s
);

474 
	`kh_fÜ—ch
(&
cfg
->
£ùiÚs
, 
key
, 
£c_w¿p
, {

475 
£ùiÚ
 = &
£c_w¿p
->
v®s_h
;

476 
j
 = 
	`kh_begš
(
£ùiÚ
); j !ğ
	`kh_’d
(section); ++j) {

477 ià(!
	`kh_exi¡
(
£ùiÚ
, 
j
)) ;

478 
£ùiÚ_key
 = 
	`kh_key
(
£ùiÚ
, 
j
);

479 
£ùiÚ_v®
 = 
	`kh_v®
(
£ùiÚ
, 
j
);

480 
	`ucc_ä“
((*)
£ùiÚ_key
);

481 
	`ucc_ä“
(
£ùiÚ_v®
);

483 
	`ucc_ä“
((*)
key
);

484 
	`kh_de¡roy_š¶aû
(
ucc_£c
, 
£ùiÚ
);

485 }è
	`kh_de¡roy_š¶aû
(
ucc_£ùiÚs
, &
cfg
->
£ùiÚs
);

487 
	`ucc_ä“
(
cfg
);

488 
	}
}

490 cÚ¡ *
	$ucc_fe_cÚfig_g‘_by_£ùiÚ
(
ucc_fe_cÚfig_t
 *
cfg
,

491 cÚ¡ *
v¬_Çme
,

492 cÚ¡ *
£ùiÚ
)

494 
	`khash_t
(
ucc_£ùiÚs
è*
£ùiÚs
 = &
cfg
->sections;

495 
	`khash_t
(
ucc_£c
è*
£c
;

496 
kh™”_t
 
™”
;

497 
ucc_£ùiÚ_w¿p_t
 *
£c_w¿p
;

499 
™”
 = 
	`kh_g‘
(
ucc_£ùiÚs
, 
£ùiÚs
, 
£ùiÚ
);

500 ià(
™”
 =ğ
	`kh_’d
(
£ùiÚs
)) {

502  
NULL
;

504 
£c_w¿p
 = 
	`kh_v®
(
£ùiÚs
, 
™”
);

505 
£c
 = &
£c_w¿p
->
v®s_h
;

506 
™”
 = 
	`kh_g‘
(
ucc_£c
, 
£c
, 
v¬_Çme
);

507 ià(
™”
 =ğ
	`kh_’d
(
£c
)) {

509  
NULL
;

511  
	`kh_v®
(
£c
, 
™”
);

512 
	}
}

514 cÚ¡ *
	$ucc_fe_cÚfig_g‘
(
ucc_fe_cÚfig_t
 *
cfg
,

515 cÚ¡ *
v¬_Çme
,

516 cÚ¡ *
£ùiÚ
)

518 
	`khash_t
(
ucc_cfg_fe
è*
v¬s
 = &
cfg
->vars;

519 
kh™”_t
 
™”
;

521 ià(
	`¡¾’
(
£ùiÚ
) > 0) {

522  (
	`ucc_fe_cÚfig_g‘_by_£ùiÚ
(
cfg
, 
v¬_Çme
, 
£ùiÚ
));

524 
™”
 = 
	`kh_g‘
(
ucc_cfg_fe
, 
v¬s
, 
v¬_Çme
);

525 ià(
™”
 =ğ
	`kh_’d
(
v¬s
)) {

527  
NULL
;

529  
	`kh_v®
(
v¬s
, 
™”
);

530 
	}
}

532 
ucc_¡©us_t
 
	$ucc_­¶y_fe_cfg_v®ue
(* 
İts
,

533 
ucc_cÚfig_f›ld_t
 *
f›lds
,

534 cÚ¡ * 
ba£_´efix
,

535 cÚ¡ *
compÚ’t_´efix
,

536 cÚ¡ *
Çme
,

537 cÚ¡ *
£ùiÚ
)

539 
v¬
[512];

540 
size_t
 
Ëá
 = (
v¬
);

541 cÚ¡ *
ba£_´efix_v¬
;

542 cÚ¡ *
cfg_v®ue
;

544 
	`ucc_¡ºıy_§ã
(
v¬
, 
ba£_´efix
, 
Ëá
);

545 
Ëá
 -ğ
	`¡¾’
(
ba£_´efix
);

546 
	`¡ºÿt
(
v¬
, 
compÚ’t_´efix
, 
Ëá
);

547 
Ëá
 -ğ
	`¡¾’
(
compÚ’t_´efix
);

548 
	`¡ºÿt
(
v¬
, 
Çme
, 
Ëá
);

550 
ba£_´efix_v¬
 = 
	`¡r¡r
(
v¬
, "UCC_");

551 
cfg_v®ue
 =

552 
	`ucc_fe_cÚfig_g‘
(
ucc_glob®_cÚfig
.
fe_cfg
, 
ba£_´efix_v¬
,

553 
£ùiÚ
);

554 ià(
cfg_v®ue
) {

555  
	`ucc_cÚfig_·r£r_£t_v®ue
(
İts
, 
f›lds
, 
Çme
, 
cfg_v®ue
);

558 ià(
ba£_´efix_v¬
 !ğ
v¬
) {

559 
cfg_v®ue
 = 
	`ucc_fe_cÚfig_g‘
(
ucc_glob®_cÚfig
.
fe_cfg
, 
v¬
,

560 
£ùiÚ
);

561 ià(
cfg_v®ue
) {

562  
	`ucc_cÚfig_·r£r_£t_v®ue
(
İts
, 
f›lds
, 
Çme
, 
cfg_v®ue
);

566  
UCC_ERR_NOT_FOUND
;

567 
	}
}

569 
ucc_¡©us_t
 
	$ucc_­¶y_fe_cfg
(*
İts
, 
ucc_cÚfig_f›ld_t
 *
f›lds
,

570 cÚ¡ *
’v_´efix
,

571 cÚ¡ *
compÚ’t_´efix
,

572 cÚ¡ *
£ùiÚ
)

574 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

576 
f›lds
->
Çme
 !ğ
NULL
) {

577 ià(
	`¡¾’
(
f›lds
->
Çme
) == 0) {

578 
¡©us
 = 
	`ucc_­¶y_fe_cfg
(

579 
İts
, (
ucc_cÚfig_f›ld_t
 *)
f›lds
->
·r£r
.
¬g
, 
’v_´efix
,

580 
compÚ’t_´efix
, 
£ùiÚ
);

581 ià(
UCC_OK
 !ğ
¡©us
) {

582  
¡©us
;

584 
f›lds
++;

587 
¡©us
 = 
	`ucc_­¶y_fe_cfg_v®ue
(

588 
İts
, 
f›lds
, 
’v_´efix
, 
compÚ’t_´efix
 ? component_prefix : "",

589 
f›lds
->
Çme
, 
£ùiÚ
);

590 ià(
¡©us
 =ğ
UCC_ERR_NOT_FOUND
 && 
compÚ’t_´efix
) {

591 
¡©us
 = 
	`ucc_­¶y_fe_cfg_v®ue
(
İts
, 
f›lds
, 
’v_´efix
, "",

592 
f›lds
->
Çme
, 
£ùiÚ
);

594 ià(
¡©us
 !ğ
UCC_OK
 && stu !ğ
UCC_ERR_NOT_FOUND
) {

595  
¡©us
;

598 
f›lds
++;

600  
UCC_OK
;

601 
	}
}

610 
ucc_¡©us_t
 
	$ucc_add_‹am_£ùiÚs
(*
‹am_cfg
,

611 
ucc_cÚfig_f›ld_t
 *
_f›lds
,

612 
ucc_tİo_t
 *
‹am_tİo
,

613 cÚ¡ **
tunšg_¡r
,

614 cÚ¡ *
tuÃ_key
,

615 cÚ¡ *
’v_´efix
,

616 cÚ¡ *
compÚ’t_´efix
)

618 
	`khash_t
(
ucc_£ùiÚs
è*
£ùiÚs
 = &
ucc_glob®_cÚfig
.
fe_cfg
->sections;

619 
ucc_ıu_v’dÜ_t
 
v’dÜ
 = 
	`ucc_¬ch_g‘_ıu_v’dÜ
();

620 
ucc_ıu_mod–_t
 
mod–
 = 
	`ucc_¬ch_g‘_ıu_mod–
();

621 
ucc_¿nk_t
 
µn_mš
 = 
	`ucc_tİo_mš_µn
(
‹am_tİo
);

622 
ucc_¿nk_t
 
µn_max
 = 
	`ucc_tİo_max_µn
(
‹am_tİo
);

623 
ucc_¿nk_t
 
sock_mš
 = 
	`ucc_tİo_mš_sock‘_size
(
‹am_tİo
);

624 
ucc_¿nk_t
 
sock_max
 = 
	`ucc_tİo_max_sock‘_size
(
‹am_tİo
);

625 
ucc_¿nk_t
 
Âodes
 = 
	`ucc_tİo_Âodes
(
‹am_tİo
);

626 
ucc_¿nk_t
 
‹am_size
 = 
‹am_tİo
->
£t
.
m­
.
•_num
;

627 
found
 = 0;

628 
	`khash_t
(
ucc_£c
è*
£c_h
;

629 
kh™”_t
 
i
, 
j
;

630 cÚ¡ *
£c_Çme
;

631 
ucc_£ùiÚ_w¿p_t
 *
£c
;

632 
ucc_¡©us_t
 
¡©us
;

634 
i
 = 
	`kh_begš
(
£ùiÚs
); i !ğ
	`kh_’d
(sections); ++i) {

635 ià(!
	`kh_exi¡
(
£ùiÚs
, 
i
)) ;

636 
£c_Çme
 = 
	`kh_key
(
£ùiÚs
, 
i
);

637 
£c
 = 
	`kh_v®
(
£ùiÚs
, 
i
);

638 ià(
	`ucc_check_£ùiÚ
(
£c
->
desc
, 
v’dÜ
, 
mod–
, 
‹am_size
,

639 
µn_mš
, 
µn_max
, 
sock_mš
, 
sock_max
, 
Âodes
)) {

640 
£c_h
 = &
£c
->
v®s_h
;

641 
j
 = 
	`kh_g‘
(
ucc_£c
, 
£c_h
, 
tuÃ_key
);

642 ià(
j
 !ğ
	`kh_’d
(
£c_h
)) {

643 *
tunšg_¡r
 = 
	`kh_v®
(
£c_h
, 
j
);

645 
¡©us
 = 
	`ucc_­¶y_fe_cfg
(
‹am_cfg
, 
_f›lds
, 
’v_´efix
,

646 
compÚ’t_´efix
, 
£c_Çme
);

647 
found
 = 1;

650  
found
 ? 
¡©us
 : 
UCC_ERR_NOT_FOUND
;

651 
	}
}

653 
ucc_¡©us_t
 
	$ucc_cÚfig_·r£r_fl_İts
(*
İts
, 
ucs_cÚfig_glob®_li¡_’Œy_t
 *
’Œy
,

654 cÚ¡ *
’v_´efix
, 
ignÜe_”rÜs
)

656 
ucs_¡©us_t
 
ucs_¡©us
;

657 
ucc_¡©us_t
 
¡©us
;

659 #ià
UCS_HAVE_CONFIG_GLOBAL_LIST_ENTRY_FLAGS


660 
ucs_¡©us
 = 
	`ucs_cÚfig_·r£r_fl_İts
(
İts
, 
’Œy
, 
’v_´efix
,

661 
ignÜe_”rÜs
);

663 
ucs_¡©us
 = 
	`ucs_cÚfig_·r£r_fl_İts
(
İts
, 
’Œy
->
bË
, 
’v_´efix
,

664 
’Œy
->
´efix
, 0);

667 
¡©us
 = 
	`ucs_¡©us_to_ucc_¡©us
(
ucs_¡©us
);

668 ià(
UCC_OK
 =ğ
¡©us
 && 
ucc_glob®_cÚfig
.
fe_cfg
) {

669 
¡©us
 = 
	`ucc_­¶y_fe_cfg
(
İts
, 
’Œy
->
bË
, 
’v_´efix
,

670 
’Œy
->
´efix
, "");

673  
¡©us
;

674 
	}
}

676 
	$ucc_cÚfig_·r£r_´št_®l_İts
(
FILE
 *
¡»am
, cÚ¡ *
´efix
,

677 
ucc_cÚfig_´št_æags_t
 
æags
,

678 
ucc_li¡_lšk_t
 * 
cÚfig_li¡
)

680 
ucc_cÚfig_glob®_li¡_’Œy_t
 *
’Œy
;

681 
ucs_cÚfig_´št_æags_t
 
ucs_æags
;

682 
ucc_¡©us_t
 
¡©us
;

683 
t™Ë
[64];

684 * 
İts
;

686 
ucs_æags
 = 
	`ucc_´št_æags_to_ucs_´št_æags
(
æags
);

687 
	`ucc_li¡_fÜ_—ch
(
’Œy
, 
cÚfig_li¡
, 
li¡
)

689 ià((
’Œy
->
bË
 =ğ
NULL
è|| (’Œy->bË[0].
Çme
 == NULL)) {

694 
İts
 = 
	`ucc_m®loc
(
’Œy
->
size
, "tmp_opts");

695 ià(
İts
 =ğ
NULL
) {

696 
	`ucc_”rÜ
("could‚ot‡llocate configuration of size %zu",

697 
’Œy
->
size
);

701 
¡©us
 = 
	`ucc_cÚfig_·r£r_fl_İts
(
İts
, 
’Œy
, 
´efix
, 0);

702 ià(
¡©us
 !ğ
UCC_OK
) {

703 
	`ucc_ä“
(
İts
);

707 
	`¢´štf
(
t™Ë
, Ñ™Ë), "% cÚfigu¿tiÚ", 
’Œy
->
Çme
);

708 
	`UCS_CONFIG_PARSER_PRINT_OPTS
(
¡»am
, 
t™Ë
, 
İts
, 
’Œy
->
bË
,

709 
’Œy
->
´efix
,…»fix, 
ucs_æags
);

710 
	`ucs_cÚfig_·r£r_»Ëa£_İts
(
İts
, 
’Œy
->
bË
);

711 
	`ucc_ä“
(
İts
);

713 
	}
}

715 
ucc_¡©us_t
 
	$ucc_cÚfig_şÚe_bË
(cÚ¡ *
¤c
, *
d¡
,

716 cÚ¡ *
¬g
)

718  
	`ucs_¡©us_to_ucc_¡©us
(
	`ucs_cÚfig_şÚe_bË
(
¤c
, 
d¡
, 
¬g
));

719 
	}
}

721 
ucc_p–še_·¿ms_t
 
	gucc_p–še_·¿ms_auto
 = {

722 .
th»shŞd
 = 0,

723 .
	gn_äags
 = 0,

724 .
	gäag_size
 = 0,

725 .
	gpd•th
 = 0,

726 .
	gÜd”
 = 
UCC_PIPELINE_PARALLEL
,

729 
ucc_p–še_·¿ms_t
 
	gucc_p–še_·¿ms_no
 = {

730 .
th»shŞd
 = 
SIZE_MAX
,

731 .
	gn_äags
 = 0,

732 .
	gäag_size
 = 0,

733 .
	gpd•th
 = 1,

734 .
	gÜd”
 = 
UCC_PIPELINE_PARALLEL
,

737 
ucc_p–še_·¿ms_t
 
	gucc_p–še_·¿ms_deçuÉ
 = {

738 .
th»shŞd
 = 
SIZE_MAX
,

739 .
	gn_äags
 = 2,

740 .
	gäag_size
 = 
SIZE_MAX
,

741 .
	gpd•th
 = 2,

742 .
	gÜd”
 = 
UCC_PIPELINE_SEQUENTIAL
,

745 
	$ucc_p–še_·¿ms_is_auto
(cÚ¡ 
ucc_p–še_·¿ms_t
 *
p
)

747 ià((
p
->
th»shŞd
 =ğ
ucc_p–še_·¿ms_auto
.threshold) &&

748 (
p
->
n_äags
 =ğ
ucc_p–še_·¿ms_auto
.n_frags) &&

749 (
p
->
äag_size
 =ğ
ucc_p–še_·¿ms_auto
.frag_size) &&

750 (
p
->
pd•th
 =ğ
ucc_p–še_·¿ms_auto
.pdepth) &&

751 (
p
->
Üd”
 =ğ
ucc_p–še_·¿ms_auto
.order)) {

756 
	}
}

758 
	$ucc_cÚfig_ssÿnf_p–še_·¿ms
(cÚ¡ *
buf
, *
de¡
,

759 cÚ¡ *
¬g
)

761 
ucc_p–še_·¿ms_t
 *
p
 = 
de¡
;

762 
ucc_¡©us_t
 
¡©us
;

763 
i
, 
n_tok’s
, 
Üd”
;

764 ** 
tok’s
, **
t2
;

766 ià(
	`¡¾’
(
buf
) == 0) {

771 ià(!
	`¡rÿ£cmp
(
buf
, 
UCS_VALUE_AUTO_STR
)) {

772 *
p
 = 
ucc_p–še_·¿ms_auto
;

776 ià(!
	`¡rÿ£cmp
(
buf
, "n")) {

777 *
p
 = 
ucc_p–še_·¿ms_no
;

781 *
p
 = 
ucc_p–še_·¿ms_deçuÉ
;

782 
tok’s
 = 
	`ucc_¡r_¥l™
(
buf
, ":");

783 ià(!
tok’s
) {

786 
n_tok’s
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s
);

788 
i
 = 0; i < 
n_tok’s
; i++) {

789 ià((
Üd”
 = 
	`ucc_¡ršg_fšd_š_li¡
(

790 
tok’s
[
i
], 
ucc_p–še_Üd”_Çmes
, 0)) >= 0) {

791 
p
->
Üd”
 = (
ucc_p–še_Üd”_t
)order;

794 
t2
 = 
	`ucc_¡r_¥l™
(
tok’s
[
i
], "=");

795 ià(!
t2
) {

796 
out
;

798 ià(
	`ucc_¡r_¥l™_couÁ
(
t2
) != 2) {

799 
out
;

801 ià(0 =ğ
	`¡rcmp
(
t2
[0], "thresh")) {

802 
¡©us
 = 
	`ucc_¡r_to_memun™s
(
t2
[1], &
p
->
th»shŞd
);

803 ià(
UCC_OK
 !ğ
¡©us
) {

804 
out
;

806 } ià(0 =ğ
	`¡rcmp
(
t2
[0], "fragsize")) {

807 
¡©us
 = 
	`ucc_¡r_to_memun™s
(
t2
[1], &
p
->
äag_size
);

808 ià(
UCC_OK
 !ğ
¡©us
) {

809 
out
;

811 } ià(0 =ğ
	`¡rcmp
(
t2
[0], "nfrags")) {

812 
¡©us
 = 
	`ucc_¡r_is_numb”
(
t2
[1]);

813 ià(
UCC_OK
 !ğ
¡©us
) {

814 
out
;

816 
p
->
n_äags
 = 
	`©oi
(
t2
[1]);

817 } ià(0 =ğ
	`¡rcmp
(
t2
[0], "pdepth")) {

818 
¡©us
 = 
	`ucc_¡r_is_numb”
(
t2
[1]);

819 ià(
UCC_OK
 !ğ
¡©us
) {

820 
out
;

822 
p
->
pd•th
 = 
	`©oi
(
t2
[1]);

824 
	`ucc_¡r_¥l™_ä“
(
t2
);

826 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

828 
out
:

829 ià(
t2
) {

830 
	`ucc_¡r_¥l™_ä“
(
t2
);

832 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

834 
	}
}

836 
	$ucc_cÚfig_¥rštf_p–še_·¿ms
(*
buf
, 
size_t
 
max
, cÚ¡ *
¤c
,

837 cÚ¡ *
¬g
)

839 cÚ¡ 
ucc_p–še_·¿ms_t
 *
p
 = 
¤c
;

840 
th»sh
[32], 
äag_size
[32];

842 ià(
	`ucc_p–še_·¿ms_is_auto
(
p
)) {

843  
	`¢´štf
(
buf
, 
max
, "auto");

845 ià(!
	`memcmp
(
p
, &
ucc_p–še_·¿ms_no
, (*p))) {

846  
	`¢´štf
(
buf
, 
max
, "n");

848  
	`¢´štf
(

849 
buf
, 
max
, "thresh=%s:nfrags=%d:fragsize=%s:pdepth=%d:order=%s",

850 
	`ucs_memun™s_to_¡r
(
p
->
th»shŞd
, 
th»sh
, Ñh»sh)),…->
n_äags
,

851 
	`ucs_memun™s_to_¡r
(
p
->
äag_size
, frag_size, (frag_size)),

852 
p
->
pd•th
, 
ucc_p–še_Üd”_Çmes
[p->
Üd”
]);

853 
	}
}

855 
ucs_¡©us_t
 
	$ucc_cÚfig_şÚe_p–še_·¿ms
(cÚ¡ *
¤c
, *
de¡
,

856 cÚ¡ *
¬g
)

858 
	`memıy
(
de¡
, 
¤c
, (
ucc_p–še_·¿ms_t
));

859  
UCS_OK
;

860 
	}
}

862 
	$ucc_cÚfig_»Ëa£_p–še_·¿ms
(*
±r
, cÚ¡ *
¬g
)

864 
	}
}

866 
	$ucc_cÚfig_ssÿnf_ušt_¿nged
(cÚ¡ *
buf
, *
de¡
,

867 cÚ¡ *
¬g
)

869 
ucc_m¿nge_ušt_t
 *
p
 = 
de¡
;

870 **
¿nges
, **
tok’s
;

871 
n_¿nges
, 
i
, 
j
, 
n_tok’s
;

872 
size_t
 
¡¬t
, 
’d
;

873 
ucc_m¿nge_t
 *
r
;

874 
ušt32_t
 
mt_m­
;

876 
	`ucc_li¡_h—d_š™
(&
p
->
¿nges
);

878 ià(!
	`¡rÿ£cmp
(
buf
, 
UCS_VALUE_AUTO_STR
)) {

879 
p
->
deçuÉ_v®ue
 = 
UCC_UUNITS_AUTO
;

883 
¿nges
 = 
	`ucc_¡r_¥l™
(
buf
, ",");

884 ià(!
¿nges
) {

887 
n_¿nges
 = 
	`ucc_¡r_¥l™_couÁ
(
¿nges
);

888 
i
 = 0; i < 
n_¿nges
; i++) {

889 
tok’s
 = 
	`ucc_¡r_¥l™
(
¿nges
[
i
], ":");

890 ià(!
tok’s
) {

891 
”r_¿nges
;

893 
n_tok’s
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s
);

894 ià(
n_tok’s
 > 3 ||

895 (
UCC_OK
 !ğ
	`ucc_¡r_is_numb”
(
tok’s
[
n_tok’s
 - 1]) &&

896 
	`¡rÿ£cmp
(
tok’s
[
n_tok’s
 - 1], 
UCS_VALUE_AUTO_STR
) != 0)) {

897 
”r_tok’s
;

899 ià(
n_tok’s
 == 1) {

900 ià(!
	`¡rÿ£cmp
(
tok’s
[
n_tok’s
 - 1], 
UCS_VALUE_AUTO_STR
)) {

902 
p
->
deçuÉ_v®ue
 = 
UCC_UUNITS_AUTO
;

905 
p
->
deçuÉ_v®ue
 = 
	`©oi
(
tok’s
[0]);

908 
r
 = 
	`ucc_m®loc
((*r), "mrange");

909 ià(!
r
) {

910 
”r_tok’s
;

912 
r
->
mty³s
 = 
UCC_MEM_TYPE_MASK_FULL
;

913 
r
->
¡¬t
 = 0;

914 
r
->
’d
 = 
SIZE_MAX
;

916 
j
 = 0; j < 
n_tok’s
; j++) {

917 ià(
UCC_OK
 =ğ
	`ucc_¡r_is_numb”
(
tok’s
[
j
])) {

919 
r
->
v®ue
 = 
	`©oi
(
tok’s
[
j
]);

922 ià(
UCC_OK
 =ğ
	`ucc_¡r_to_mty³_m­
(
tok’s
[
j
], "^", &
mt_m­
)) {

923 
r
->
mty³s
 = 
mt_m­
;

926 ià(
UCC_OK
 ==

927 
	`ucc_¡r_to_memun™s_¿nge
(
tok’s
[
j
], &
¡¬t
, &
’d
)) {

928 
r
->
¡¬t
 = start;

929 
r
->
’d
 =ƒnd;

932 
	`ucc_ä“
(
r
);

933 
”r_tok’s
;

936 
	`ucc_li¡_add_
(&
p
->
¿nges
, &
r
->
li¡_–em
);

938 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

940 
	`ucc_¡r_¥l™_ä“
(
¿nges
);

944 
”r_tok’s
:

945 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

946 
”r_¿nges
:

947 
	`ucc_¡r_¥l™_ä“
(
¿nges
);

949 
	}
}

951 
	#MAX_TMP_BUF_LENGTH
 128

	)

952 
	$ucc_cÚfig_¥rštf_ušt_¿nged
(*
buf
, 
size_t
 
max
, cÚ¡ *
¤c
,

953 cÚ¡ *
¬g
)

955 cÚ¡ 
ucc_m¿nge_ušt_t
 *
s
 = 
¤c
;

956 
ucc_m¿nge_t
 *
r
;

957 
tmp_¡¬t
[
MAX_TMP_BUF_LENGTH
];

958 
tmp_’d
[
MAX_TMP_BUF_LENGTH
];

959 
tmp_mty³s
[
MAX_TMP_BUF_LENGTH
];

960 
size_t
 
Ï¡
;

962 
	`ucc_li¡_fÜ_—ch
(
r
, &
s
->
¿nges
, 
li¡_–em
) {

963 
	`ucs_memun™s_to_¡r
(
r
->
¡¬t
, 
tmp_¡¬t
, 
MAX_TMP_BUF_LENGTH
);

964 
	`ucs_memun™s_to_¡r
(
r
->
’d
, 
tmp_’d
, 
MAX_TMP_BUF_LENGTH
);

965 ià(
r
->
mty³s
 =ğ
UCC_MEM_TYPE_MASK_FULL
) {

966 
	`ucc_¢´štf_§ã
(
buf
, 
max
, "%s-%s:%u", 
tmp_¡¬t
, 
tmp_’d
,

967 
r
->
v®ue
);

969 
	`ucc_mty³_m­_to_¡r
(
r
->
mty³s
, "^", 
tmp_mty³s
, 
MAX_TMP_BUF_LENGTH
);

970 
	`ucc_¢´štf_§ã
(
buf
, 
max
, "%s-%s:%s:%u", 
tmp_¡¬t
, 
tmp_’d
,

971 
tmp_mty³s
, 
r
->
v®ue
);

973 
Ï¡
 = 
	`¡¾’
(
buf
);

974 ià(
max
 - 
Ï¡
 - 1 <= 0) {

979 
buf
[
Ï¡
] = ',';

980 
buf
[
Ï¡
 + 1] = '\0';

981 
max
 -ğ
Ï¡
 + 1;

982 
buf
 +ğ
Ï¡
 + 1;

985 ià(
s
->
deçuÉ_v®ue
 =ğ
UCC_UUNITS_AUTO
) {

986 
	`ucc_¢´štf_§ã
(
buf
, 
max
, "%s", "auto");

988 
	`ucc_¢´štf_§ã
(
buf
, 
max
, "%u", 
s
->
deçuÉ_v®ue
);

992 
	}
}

994 
ucs_¡©us_t
 
	$ucc_cÚfig_şÚe_ušt_¿nged
(cÚ¡ *
¤c
, *
de¡
,

995 cÚ¡ *
¬g
)

997  
	`ucc_¡©us_to_ucs_¡©us
(
	`ucc_m¿nge_ušt_cİy
(
de¡
, 
¤c
));

998 
	}
}

1000 
	$ucc_cÚfig_»Ëa£_ušt_¿nged
(*
±r
, cÚ¡ *
¬g
)

1002 
	`ucc_m¿nge_ušt_de¡roy
(
±r
);

1003 
	}
}

	@src/utils/ucc_parser.h

7 #iâdeà
UCC_PARSER_H_


8 
	#UCC_PARSER_H_


	)

10 
	~"cÚfig.h
"

11 
	~"ucc/­i/ucc_¡©us.h
"

12 
	~"ucc/­i/ucc_def.h
"

13 
	~"uts/ucc_d©a¡ruù.h
"

14 
	~"uts/ucc_comp”_def.h
"

15 
	~"uts/ucc_li¡.h
"

16 
	~"uts/¬ch/ıu.h
"

17 
	~"khash.h
"

18 
	~"compÚ’ts/tİo/ucc_tİo.h
"

20 
	~<ucs/cÚfig/·r£r.h
>

21 
	~<ucs/sys/´•roûssÜ.h
>

22 
	~<ucs/sys/comp”_def.h
>

23 
	~<ucs/cÚfig/ty³s.h
>

24 
	~<ucs/cÚfig/·r£r.h
>

26 
ucs_cÚfig_f›ld_t
 
	tucc_cÚfig_f›ld_t
;

27 
ucs_cÚfig_Çmes_¬¿y_t
 
	tucc_cÚfig_Çmes_¬¿y_t
;

28 
ucs_cÚfig_glob®_li¡_’Œy_t
 
	tucc_cÚfig_glob®_li¡_’Œy_t
;

29 
ucs_cÚfig_®low_li¡_t
 
	tucc_cÚfig_®low_li¡_t
;

31 
ucc_fe_cÚfig
 
	tucc_fe_cÚfig_t
;

33 #ià
UCS_HAVE_CONFIG_GLOBAL_LIST_ENTRY_FLAGS


34 
	#UCC_CONFIG_DECLARE_TABLE
(
_bË
, 
_Çme
, 
_´efix
, 
_ty³
) \

35 
ucc_cÚfig_glob®_li¡_’Œy_t
 
_bË
##
_cÚfig_’Œy
 = { \

36 .
Çme
 = 
_Çme
, \

37 .
´efix
 = 
_´efix
, \

38 .
bË
 = 
_bË
, \

39 .
size
 = (
_ty³
), \

40 .
li¡
 = {
NULL
, NULL}, \

41 .
æags
 = 0 \

42 };

	)

44 
	#UCC_CONFIG_DECLARE_TABLE
(
_bË
, 
_Çme
, 
_´efix
, 
_ty³
) \

45 
ucc_cÚfig_glob®_li¡_’Œy_t
 
_bË
##
_cÚfig_’Œy
 = { \

46 .
Çme
 = 
_Çme
, \

47 .
´efix
 = 
_´efix
, \

48 .
bË
 = 
_bË
, \

49 .
size
 = (
_ty³
), \

50 .
li¡
 = {
NULL
, NULL}, \

51 };

	)

54 #ifdeà
UCS_HAVE_PARSER_PRINT_FILTER_ARG


55 
	#UCS_CONFIG_PARSER_PRINT_OPTS
(
_¡»am
, 
_t™Ë
, 
_İts
, 
_f›lds
, 
_»fix
, 
_´efix
, 
_æags
) \

56 
	`ucs_cÚfig_·r£r_´št_İts
((
_¡»am
), (
_t™Ë
), (
_İts
), (
_f›lds
), (
_»fix
), (
_´efix
), (
_æags
), 
NULL
)

	)

58 
	#UCS_CONFIG_PARSER_PRINT_OPTS
(
_¡»am
, 
_t™Ë
, 
_İts
, 
_f›lds
, 
_»fix
, 
_´efix
, 
_æags
) \

59 
	`ucs_cÚfig_·r£r_´št_İts
((
_¡»am
), (
_t™Ë
), (
_İts
), (
_f›lds
), (
_»fix
), (
_´efix
), (
_æags
))

	)

62 
	#UCC_CONFIG_GET_TABLE
(
_bË
è&_bË##
_cÚfig_’Œy


	)

63 
	#UCC_CONFIG_TYPE_LOG_COMP
 
UCS_CONFIG_TYPE_LOG_COMP


	)

64 
	#UCC_CONFIG_REGISTER_TABLE
 
UCS_CONFIG_REGISTER_TABLE


	)

65 
	#UCC_CONFIG_REGISTER_TABLE_ENTRY
 
UCS_CONFIG_REGISTER_TABLE_ENTRY


	)

66 
	#UCC_CONFIG_TYPE_LOG_COMP
 
UCS_CONFIG_TYPE_LOG_COMP


	)

67 
	#UCC_CONFIG_TYPE_STRING
 
UCS_CONFIG_TYPE_STRING


	)

68 
	#UCC_CONFIG_TYPE_INT
 
UCS_CONFIG_TYPE_INT


	)

69 
	#UCC_CONFIG_TYPE_UINT
 
UCS_CONFIG_TYPE_UINT


	)

70 
	#UCC_CONFIG_TYPE_STRING_ARRAY
 
UCS_CONFIG_TYPE_STRING_ARRAY


	)

71 
	#UCC_CONFIG_TYPE_ALLOW_LIST
 
UCS_CONFIG_TYPE_ALLOW_LIST


	)

72 
	#UCC_CONFIG_TYPE_ARRAY
 
UCS_CONFIG_TYPE_ARRAY


	)

73 
	#UCC_CONFIG_TYPE_TABLE
 
UCS_CONFIG_TYPE_TABLE


	)

74 
	#UCC_CONFIG_TYPE_ULUNITS
 
UCS_CONFIG_TYPE_ULUNITS


	)

75 
	#UCC_CONFIG_TYPE_ENUM
 
UCS_CONFIG_TYPE_ENUM


	)

76 
	#UCC_CONFIG_TYPE_MEMUNITS
 
UCS_CONFIG_TYPE_MEMUNITS


	)

77 
	#UCC_ULUNITS_AUTO
 
UCS_ULUNITS_AUTO


	)

78 
	#UCC_CONFIG_TYPE_BITMAP
 
UCS_CONFIG_TYPE_BITMAP


	)

79 
	#UCC_CONFIG_TYPE_MEMUNITS
 
UCS_CONFIG_TYPE_MEMUNITS


	)

80 
	#UCC_CONFIG_TYPE_BOOL
 
UCS_CONFIG_TYPE_BOOL


	)

81 
	#UCC_CONFIG_ALLOW_LIST_NEGATE
 
UCS_CONFIG_ALLOW_LIST_NEGATE


	)

82 
	#UCC_CONFIG_ALLOW_LIST_ALLOW_ALL
 
UCS_CONFIG_ALLOW_LIST_ALLOW_ALL


	)

83 
	#UCC_CONFIG_ALLOW_LIST_ALLOW
 
UCS_CONFIG_ALLOW_LIST_ALLOW


	)

84 
	#UCC_CONFIG_TYPE_TERNARY
 
UCS_CONFIG_TYPE_TERNARY


	)

85 
	#UCC_CONFIG_TYPE_ON_OFF_AUTO
 
UCS_CONFIG_TYPE_ON_OFF_AUTO


	)

86 
	#UCC_UUNITS_AUTO
 (()-2)

	)

88 
	eucc_‹º¬y_auto_v®ue
 {

89 
	mUCC_NO
 = 
UCS_NO
,

90 
	mUCC_YES
 = 
UCS_YES
,

91 
	mUCC_TRY
 = 
UCS_TRY
,

92 
	mUCC_AUTO
 = 
UCS_AUTO
,

93 
	mUCC_TERNARY_LAST


94 } 
	tucc_‹º¬y_auto_v®ue_t
;

96 
	eucc_Ú_off_auto_v®ue
 {

97 
	mUCC_CONFIG_OFF
 = 
UCS_CONFIG_OFF
,

98 
	mUCC_CONFIG_ON
 = 
UCS_CONFIG_ON
,

99 
	mUCC_CONFIG_AUTO
 = 
UCS_CONFIG_AUTO
,

100 
	mUCC_CONFIG_ON_OFF_LAST


101 } 
	tucc_Ú_off_auto_v®ue_t
;

103 
	etunšg_mask
 {

104 
	mUCC_TUNING_DESC_FIELD_VENDOR
 = 
UCC_BIT
(0),

105 
	mUCC_TUNING_DESC_FIELD_MODEL
 = 
UCC_BIT
(1),

106 
	mUCC_TUNING_DESC_FIELD_TEAM_SIZE
 = 
UCC_BIT
(2),

107 
	mUCC_TUNING_DESC_FIELD_PPN
 = 
UCC_BIT
(3),

108 
	mUCC_TUNING_DESC_FIELD_NNODES
 = 
UCC_BIT
(4),

109 
	mUCC_TUNING_DESC_FIELD_SOCK
 = 
UCC_BIT
(5)

112 
	succ_£ùiÚ_desc
 {

113 
ušt64_t
 
	mmask
;

114 
ucc_ıu_v’dÜ_t
 
	mv’dÜ
;

115 
ucc_ıu_mod–_t
 
	mmod–
;

116 
ucc_¿nk_t
 
	mmš_‹am_size
;

117 
ucc_¿nk_t
 
	mmax_‹am_size
;

118 
ucc_¿nk_t
 
	mmš_µn
;

119 
ucc_¿nk_t
 
	mmax_µn
;

120 
ucc_¿nk_t
 
	mmš_sock
;

121 
ucc_¿nk_t
 
	mmax_sock
;

122 
ucc_¿nk_t
 
	mmš_Âodes
;

123 
ucc_¿nk_t
 
	mmax_Âodes
;

124 } 
	tucc_£ùiÚ_desc_t
;

126 
KHASH_MAP_INIT_STR
(
ucc_£c
, *);

128 
	succ_£ùiÚ_w¿p
 {

129 
ucc_£ùiÚ_desc_t
 
	mdesc
;

130 
khash_t
(
ucc_£c
è
	mv®s_h
;

131 } 
	tucc_£ùiÚ_w¿p_t
;

133 
KHASH_MAP_INIT_STR
(
ucc_cfg_fe
, *);

134 
KHASH_MAP_INIT_STR
(
ucc_£ùiÚs
, 
ucc_£ùiÚ_w¿p_t
 *);

136 
	succ_fe_cÚfig
 {

137 *
	mf’ame
;

138 
khash_t
(
ucc_cfg_fe
è
	mv¬s
;

139 
khash_t
(
ucc_£ùiÚs
è
	m£ùiÚs
;

140 } 
	tucc_fe_cÚfig_t
;

148 
	succ_cÚfig_Çmes_li¡
 {

151 
ucc_cÚfig_Çmes_¬¿y_t
 
	m¬¿y
;

152 
	m»que¡ed
;

154 
ucc_cÚfig_®low_li¡_t
 
	mli¡
;

156 } 
	tucc_cÚfig_Çmes_li¡_t
;

158 
ucc_¡©us_t
 
ucc_cÚfig_·r£r_fl_İts
(*
İts
,

159 
ucs_cÚfig_glob®_li¡_’Œy_t
 *
’Œy
,

160 cÚ¡ *
’v_´efix
,

161 
ignÜe_”rÜs
);

163 
ucc_¡©us_t
 
ucc_add_‹am_£ùiÚs
(*
‹am_cfg
,

164 
ucc_cÚfig_f›ld_t
 *
_f›ld
,

165 
ucc_tİo_t
 *
‹am_tİo
,

166 cÚ¡ **
tunšg_¡r
,

167 cÚ¡ *
tuÃ_key
,

168 cÚ¡ *
’v_´efix
,

169 cÚ¡ *
compÚ’t_´efix
);

171 
šlše
 

172 
	$ucc_cÚfig_·r£r_»Ëa£_İts
(*
İts
, 
ucc_cÚfig_f›ld_t
 *
f›lds
)

174 
	`ucs_cÚfig_·r£r_»Ëa£_İts
(
İts
, 
f›lds
);

175 
	}
}

177 
šlše
 
ucc_¡©us_t


178 
	$ucc_cÚfig_·r£r_£t_v®ue
(*
İts
, 
ucc_cÚfig_f›ld_t
 *
f›lds
,

179 cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

181 
ucs_¡©us_t
 
¡©us
;

183 #ià
UCS_HAVE_PARSER_SET_VALUE_TABLE_PREFIX


184 
¡©us
 = 
	`ucs_cÚfig_·r£r_£t_v®ue
(
İts
, 
f›lds
, 
NULL
, 
Çme
, 
v®ue
);

186 
¡©us
 = 
	`ucs_cÚfig_·r£r_£t_v®ue
(
İts
, 
f›lds
, 
Çme
, 
v®ue
);

188  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

189 
	}
}

191 
šlše
 
ucs_cÚfig_´št_æags_t


192 
	$ucc_´št_æags_to_ucs_´št_æags
(
ucc_cÚfig_´št_æags_t
 
æags
)

194 
ucs_æags
 = 0;

196 ià(
æags
 & 
UCC_CONFIG_PRINT_CONFIG
) {

197 
ucs_æags
 |ğ
UCS_CONFIG_PRINT_CONFIG
;

199 ià(
æags
 & 
UCC_CONFIG_PRINT_HEADER
) {

200 
ucs_æags
 |ğ
UCS_CONFIG_PRINT_HEADER
;

202 ià(
æags
 & 
UCC_CONFIG_PRINT_DOC
) {

203 
ucs_æags
 |ğ
UCS_CONFIG_PRINT_DOC
;

205 ià(
æags
 & 
UCC_CONFIG_PRINT_HIDDEN
) {

206 
ucs_æags
 |ğ
UCS_CONFIG_PRINT_HIDDEN
;

209  (
ucs_cÚfig_´št_æags_t
)
ucs_æags
;

210 
	}
}

212 
šlše
 
	$ucc_cÚfig_·r£r_´št_İts
(
FILE
 *
¡»am
, cÚ¡ *
t™Ë
,

213 cÚ¡ *
İts
,

214 
ucc_cÚfig_f›ld_t
 *
f›lds
,

215 cÚ¡ *
bË_´efix
,

216 cÚ¡ *
´efix
,

217 
ucc_cÚfig_´št_æags_t
 
æags
)

219 
ucs_cÚfig_´št_æags_t
 
ucs_æags
;

221 
ucs_æags
 = 
	`ucc_´št_æags_to_ucs_´št_æags
(
æags
);

222 
	`UCS_CONFIG_PARSER_PRINT_OPTS
(
¡»am
, 
t™Ë
, 
İts
, 
f›lds
, 
bË_´efix
,

223 
´efix
, 
ucs_æags
);

224 
	}
}

226 
ucc_cÚfig_·r£r_´št_®l_İts
(
FILE
 *
¡»am
, cÚ¡ *
´efix
,

227 
ucc_cÚfig_´št_æags_t
 
æags
,

228 
ucc_li¡_lšk_t
 * 
cÚfig_li¡
);

230 
ucc_¡©us_t
 
ucc_cÚfig_Çmes_¬¿y_dup
(
ucc_cÚfig_Çmes_¬¿y_t
 *
d¡
,

231 cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
¤c
);

233 
ucc_¡©us_t
 
ucc_cÚfig_Çmes_¬¿y_m”ge
(
ucc_cÚfig_Çmes_¬¿y_t
 *
d¡
,

234 cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
¤c
);

236 
ucc_¡©us_t
 
ucc_cÚfig_Çmes_¬¿y_to_¡ršg
(cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
¬¿y
,

237 *
¡r
, 
size_t
 
max
);

239 
ucc_cÚfig_Çmes_¬¿y_ä“
(
ucc_cÚfig_Çmes_¬¿y_t
 *
¬¿y
);

241 
ucc_cÚfig_Çmes_£¬ch
(cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
cÚfig_Çmes
,

242 cÚ¡ * 
¡r
);

244 
šlše


245 
	$ucc_cÚfig_Çmes_¬¿y_is_®l
(cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
¬¿y
)

247  (
¬¿y
->
couÁ
 =ğ1è&& (0 =ğ
	`¡rcmp
×¼ay->
Çmes
[0], "all"));

248 
	}
}

250 
ucc_¡©us_t
 
ucc_cÚfig_®low_li¡_´oûss
(cÚ¡ 
ucc_cÚfig_®low_li¡_t
 * 
li¡
,

251 cÚ¡ 
ucc_cÚfig_Çmes_¬¿y_t
 *
®l
,

252 
ucc_cÚfig_Çmes_li¡_t
 * 
out
);

254 
ucc_¡©us_t
 
ucc_·r£_fe_cÚfig
(cÚ¡ * 
f’ame
,

255 
ucc_fe_cÚfig_t
 **
cfg
);

256 
ucc_»Ëa£_fe_cÚfig
(
ucc_fe_cÚfig_t
 *
cfg
);

258 
ucc_p–še_·¿ms
 
	tucc_p–še_·¿ms_t
;

260 
ucc_¡©us_t
 
ucc_cÚfig_şÚe_bË
(cÚ¡ *
¤c
, *
d¡
,

261 cÚ¡ *
¬g
);

263 
ucc_p–še_·¿ms_is_auto
(cÚ¡ 
ucc_p–še_·¿ms_t
 *
p
);

265 
ucc_cÚfig_ssÿnf_p–še_·¿ms
(cÚ¡ *
buf
, *
de¡
,

266 cÚ¡ *
¬g
);

268 
ucc_cÚfig_¥rštf_p–še_·¿ms
(*
buf
, 
size_t
 
max
, cÚ¡ *
¤c
,

269 cÚ¡ *
¬g
);

271 
ucs_¡©us_t
 
ucc_cÚfig_şÚe_p–še_·¿ms
(cÚ¡ *
¤c
, *
de¡
,

272 cÚ¡ *
¬g
);

274 
ucc_cÚfig_»Ëa£_p–še_·¿ms
(*
±r
, cÚ¡ *
¬g
);

276 
ucc_cÚfig_ssÿnf_ušt_¿nged
(cÚ¡ *
buf
, *
de¡
, cÚ¡ *
¬g
);

278 
ucc_cÚfig_¥rštf_ušt_¿nged
(*
buf
, 
size_t
 
max
, cÚ¡ *
¤c
,

279 cÚ¡ *
¬g
);

281 
ucs_¡©us_t
 
ucc_cÚfig_şÚe_ušt_¿nged
(cÚ¡ *
¤c
, *
de¡
,

282 cÚ¡ *
¬g
);

284 
ucc_cÚfig_»Ëa£_ušt_¿nged
(*
±r
, cÚ¡ *
¬g
);

286 #ifdeà
UCS_HAVE_PARSER_CONFIG_DOC


287 
	#UCC_CONFIG_TYPE_UINT_RANGED
 \

289 
ucc_cÚfig_ssÿnf_ušt_¿nged
, 
ucc_cÚfig_¥rštf_ušt_¿nged
, \

290 
ucc_cÚfig_şÚe_ušt_¿nged
, 
ucc_cÚfig_»Ëa£_ušt_¿nged
, \

291 
ucs_cÚfig_h–p_g’”ic
, 
ucs_cÚfig_doc_nİ
, \

295 }

	)

297 
	#UCC_CONFIG_TYPE_PIPELINE_PARAMS
 \

299 
ucc_cÚfig_ssÿnf_p–še_·¿ms
, 
ucc_cÚfig_¥rštf_p–še_·¿ms
, \

300 
ucc_cÚfig_şÚe_p–še_·¿ms
, \

301 
ucc_cÚfig_»Ëa£_p–še_·¿ms
, 
ucs_cÚfig_h–p_g’”ic
, \

302 
ucs_cÚfig_doc_nİ
, \

305 }

	)

307 
	#UCC_CONFIG_TYPE_UINT_RANGED
 \

309 
ucc_cÚfig_ssÿnf_ušt_¿nged
, 
ucc_cÚfig_¥rštf_ušt_¿nged
, \

310 
ucc_cÚfig_şÚe_ušt_¿nged
, 
ucc_cÚfig_»Ëa£_ušt_¿nged
, \

311 
ucs_cÚfig_h–p_g’”ic
, "[<munit>-<munit>:[mtype]:value," \

314 }

	)

316 
	#UCC_CONFIG_TYPE_PIPELINE_PARAMS
 \

318 
ucc_cÚfig_ssÿnf_p–še_·¿ms
, 
ucc_cÚfig_¥rštf_p–še_·¿ms
, \

319 
ucc_cÚfig_şÚe_p–še_·¿ms
, \

320 
ucc_cÚfig_»Ëa£_p–še_·¿ms
, 
ucs_cÚfig_h–p_g’”ic
, \

323 }

	)

	@src/utils/ucc_proc_info.c

7 
	~"ucc_´oc_šfo.h
"

8 
	~"ucc_log.h
"

9 
	~"uts/ucc_m®loc.h
"

10 
	~"uts/ucc_m©h.h
"

11 
	~<”ºo.h
>

12 
	~<sched.h
>

13 
	~<lim™s.h
>

14 
	~<¡dšt.h
>

15 
	~"cÚfig.h
"

16 #ifdeà
HAVE_UCS_GET_SYSTEM_ID


17 
	~<ucs/sys/uid.h
>

19 
	~<dlfú.h
>

21 
ucc_´oc_šfo_t
 
	gucc_loÿl_´oc
;

22 
	gucc_loÿl_ho¡Çme
[
HOST_NAME_MAX
];

24 cÚ¡ * 
	$ucc_ho¡Çme
()

26  
ucc_loÿl_ho¡Çme
;

27 
	}
}

29 
ušt64_t
 
	$ucc_g‘_sy¡em_id
()

31 #ifdeà
HAVE_UCS_GET_SYSTEM_ID


32  
	`ucs_g‘_sy¡em_id
();

34  
	`ucc_¡r_hash_djb2
(
ucc_loÿl_ho¡Çme
);

36 
	}
}

38 
	tıu_mask_t
;

39 
	#NCPUBITS
 (8 * (
ıu_mask_t
))

	)

41 
	#CPUELT
(
ıu
è((ıuè/ 
NCPUBITS
)

	)

42 
	#CPUMASK
(
ıu
è((
ıu_mask_t
)1 << ((ıuè% 
NCPUBITS
))

	)

44 
	#SBGP_CPU_ISSET
(
ıu
, 
£tsize
, 
ıu£
) \

46 
size_t
 
__ıu
 = (
ıu
); \

47 
__ıu
 < 8 * (
£tsize
) \

48 ? ((((cÚ¡ 
ıu_mask_t
 *)((
ıu£
)->
__b™s
))[
	`__CPUELT
(
__ıu
)] & \

49 
	`CPUMASK
(
__ıu
))) != 0 \

51 })

	)

53 
	$·r£_ıu£t_fe
(
FILE
 *
fe
, *
Ä_psbl_ıus
)

55 
¡¬t
, 
¡İ
;

56 
	`fsÿnf
(
fe
, "%lu", &
¡¬t
) == 1) {

57 
c
 = 
	`fg‘c
(
fe
);

58 
¡İ
 = 
¡¬t
;

59 ià(
c
 == '-') {

60 ià(
	`fsÿnf
(
fe
, "%lu", &
¡İ
) != 1) {

62 
”ºo
 = 
EINVAL
;

65 
c
 = 
	`fg‘c
(
fe
);

68 ià(
c
 =ğ
EOF
 || c == '\n') {

69 *
Ä_psbl_ıus
 = ()
¡İ
 + 1;

73 ià(
c
 != ',') {

75 
”ºo
 = 
EINVAL
;

80 
	}
}

82 
ucc_¡©us_t
 
	$ucc_g‘_bound_sock‘_id
(
ucc_sock‘_id_t
 *
sock‘id
)

84 
ıu_£t_t
 *
ıu£t
 = 
NULL
;

85 
sockid
 = -1, 
sockid2
 = -1;

86 
Œy
, 
i
, 
n_sock‘s
, 
ıu
, 
Ä_ıus
, 
Ä_psbl_ıus
 = 0;

87 
size_t
 
£tsize
;

88 
FILE
 * 
åŒ
, *
possibË
;

89 
¡r
[1024];

90 * 
sock‘_ids
, 
tmpid
;

93 
Ä_ıus
 = 
	`syscÚf
(
_SC_NPROCESSORS_CONF
);

96 
possibË
 = 
	`fİ’
("/sys/devices/system/cpu/possible", "r");

97 ià(
possibË
) {

98 ià(
	`·r£_ıu£t_fe
(
possibË
, &
Ä_psbl_ıus
) == 0) {

99 ià(
Ä_ıus
 < 
Ä_psbl_ıus
 + 1)

100 
Ä_ıus
 = 
Ä_psbl_ıus
;

102 
	`fşo£
(
possibË
);

105 ià(!
Ä_ıus
) {

106  
UCC_ERR_NO_MESSAGE
;

114 
£tsize
 = ((
Ä_ıus
 + 
NCPUBITS
 - 1è/ NCPUBITSè* (
ıu_mask_t
);

115 
ıu£t
 = 
	`__sched_ıu®loc
(
Ä_ıus
);

116 ià(
NULL
 =ğ
ıu£t
) {

117  
UCC_ERR_NO_MESSAGE
;

119 
Œy
 = 1000;

120 0 < 
	`sched_g‘affš™y
(0, 
£tsize
, 
ıu£t
è&& 
Œy
 > 0) {

121 
	`__sched_ıuä“
(
ıu£t
);

122 
Œy
--;

123 
Ä_ıus
 *= 2;

124 
ıu£t
 = 
	`__sched_ıu®loc
(
Ä_ıus
);

125 ià(
NULL
 =ğ
ıu£t
) {

126 
Œy
 = 0;

129 
£tsize
 = ((
Ä_ıus
 + 
NCPUBITS
 - 1è/ NCPUBITSè* (
ıu_mask_t
);

134 ià(
Œy
 == 0) {

135 
	`ucc_w¬n
("Error when manuallyryingo discover socket_id using "

137 
	`__sched_ıuä“
(
ıu£t
);

138  
UCC_ERR_NO_MESSAGE
;

141 
sock‘_ids
 = 
	`ucc_m®loc
(
Ä_ıus
 * (), "socket_ids");

142 ià(!
sock‘_ids
) {

143 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for socket_ids‡rray",

144 
Ä_ıus
 * ());

145 
	`__sched_ıuä“
(
ıu£t
);

146  
UCC_ERR_NO_MEMORY
;

149 
ıu
 = 0; cpu < 
Ä_ıus
; cpu++) {

150 
sock‘_ids
[
ıu
] = -1;

151 
	`¥rštf
(
¡r
, "/sys/bus/cpu/devices/cpu%d/topology/physical_package_id",

152 
ıu
);

153 
åŒ
 = 
	`fİ’
(
¡r
, "r");

154 ià(!
åŒ
) {

159 ià((1 =ğ
	`fsÿnf
(
åŒ
, "%d", &
tmpid
)) && (tmpid >= 0)) {

160 
sock‘_ids
[
ıu
] = 
tmpid
;

161 ià(
	`SBGP_CPU_ISSET
(
ıu
, 
£tsize
, 
ıu£t
)) {

162 ià(
sockid
 == -1) {

163 
sockid
 = 
tmpid
;

164 } ià(
tmpid
 !ğ
sockid
 && 
sockid2
 == -1) {

165 
sockid2
 = 
tmpid
;

169 
	`fşo£
(
åŒ
);

173 ià((
sockid
 !ğ-1è&& (
sockid2
 == -1)) {

177 
n_sock‘s
 = 
	`ucc_sÜt_uniq
(
sock‘_ids
, 
Ä_ıus
, 0);

178 
i
 = 0; i < 
n_sock‘s
; i++) {

179 ià(
sock‘_ids
[
i
] =ğ
sockid
) {

180 ià(
i
 > ()
UCC_MAX_SOCKET_ID
) {

181 
	`ucc_debug
("toØÏrgsock‘ id %d", 
i
);

182 
	`__sched_ıuä“
(
ıu£t
);

183  
UCC_ERR_NOT_SUPPORTED
;

185 *
sock‘id
 = 
i
;

189 
	`ucc_as£¹
(((*
sock‘id
è!ğ
UCC_SOCKET_ID_INVALID
è&& ((*sock‘idè< 
Ä_ıus
));

191 
	`__sched_ıuä“
(
ıu£t
);

192 
	`ucc_ä“
(
sock‘_ids
);

193  
UCC_OK
;

194 
	}
}

196 
	#LOAD_NUMA_SYM
(
_sym
) \

198 *
h
 = 
	`dlsym
(
hªdË
, 
_sym
); \

199 ià((
”rÜ
 = 
	`dË¼Ü
()è!ğ
NULL
) { \

200 
	`ucc_debug
("%s", 
”rÜ
); \

201 
¡©us
 = 
UCC_ERR_NOT_FOUND
; \

202 
”rÜ
; \

204 
h
; \

205 })

	)

207 
ucc_¡©us_t
 
	$ucc_g‘_bound_numa_id
(
ucc_numa_id_t
 *
numaid
)

209 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

210 * 
”rÜ
;

211 * 
hªdË
, *
ıumask
;

212 
i
, 
numa_node
, 
n_cfg_ıus
, 
Â
;

213 (*
ucc_numa_avaabË
)();

214 (*
ucc_numa_num_cÚfigu»d_ıus
)();

215 *(*
ucc_numa_®loÿ‹_ıumask
)();

216 *(*
ucc_numa_sched_g‘affš™y
)(, *);

217 (*
ucc_numa_b™mask_isb™£t
)(*, );

218 (*
ucc_numa_node_of_ıu
)();

219 (*
ucc_numa_b™mask_ä“
)(*);

221 
hªdË
 = 
	`dlİ’
("libnuma.so", 
RTLD_LAZY
);

222 ià(!
hªdË
) {

223 
	`ucc_debug
("%s", 
	`dË¼Ü
());

224  
UCC_ERR_NOT_FOUND
;

227 
ucc_numa_avaabË
 =

228 ((*)())
	`LOAD_NUMA_SYM
("numa_available");

229 
ucc_numa_num_cÚfigu»d_ıus
 =

230 ((*)())
	`LOAD_NUMA_SYM
("numa_num_configured_cpus");

231 
ucc_numa_®loÿ‹_ıumask
 =

232 (*(*)())
	`LOAD_NUMA_SYM
("numa_allocate_cpumask");

233 
ucc_numa_sched_g‘affš™y
 =

234 (*(*)(, *))
	`LOAD_NUMA_SYM
("numa_sched_getaffinity");

235 
ucc_numa_b™mask_isb™£t
 =

236 ((*)(*, ))
	`LOAD_NUMA_SYM
("numa_bitmask_isbitset");

237 
ucc_numa_node_of_ıu
 =

238 ((*)())
	`LOAD_NUMA_SYM
("numa_node_of_cpu");

239 
ucc_numa_b™mask_ä“
 =

240 ((*)(*))
	`LOAD_NUMA_SYM
("numa_bitmask_free");

242 ià(-1 =ğ
	`ucc_numa_avaabË
()) {

243 
	`ucc_debug
("libnuma is‚ot‡vailable");

244 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

245 
”rÜ
;

250 
ıumask
 = 
	`ucc_numa_®loÿ‹_ıumask
();

251 ià(!
ıumask
) {

252 
	`ucc_”rÜ
("numa_allocate_cpumask failed");

253 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

254 
”rÜ
;

256 
	`ucc_numa_sched_g‘affš™y
(
	`g‘pid
(), 
ıumask
);

257 
numa_node
 = -1;

258 
n_cfg_ıus
 = 
	`ucc_numa_num_cÚfigu»d_ıus
();

259 
i
 = 0; i < 
n_cfg_ıus
; i++) {

260 ià(
	`ucc_numa_b™mask_isb™£t
(
ıumask
, 
i
)) {

261 
Â
 = 
	`ucc_numa_node_of_ıu
(
i
);

262 ià(
numa_node
 == -1) {

263 
numa_node
 = 
Â
;

264 } ià(
numa_node
 !ğ
Â
 &&‚uma_node >= 0) {

267 
numa_node
 = -1;

272 
	`ucc_numa_b™mask_ä“
(
ıumask
);

273 ià(
numa_node
 >= 0) {

274 ià(
numa_node
 > ()
UCC_MAX_NUMA_ID
) {

275 
	`ucc_debug
("toØÏrgnum¨id %d", 
numa_node
);

276 
¡©us
 = 
UCC_ERR_NOT_SUPPORTED
;

277 
”rÜ
;

279 *
numaid
 = 
numa_node
;

281 
”rÜ
:

282 
	`dlşo£
(
hªdË
);

283  
¡©us
;

284 
	}
}

286 
ucc_¡©us_t
 
	$ucc_loÿl_´oc_šfo_š™
()

288 
ucc_loÿl_´oc
.
ho¡_hash
 = 
	`g‘ho¡id
();

289 ià(
	`g‘ho¡Çme
(
ucc_loÿl_ho¡Çme
, (ucc_local_hostname))) {

290 
	`ucc_w¬n
("couldn't get†ocal hostname");

291 
ucc_loÿl_ho¡Çme
[0] = '\0';

293 
	`¡¹ok
(
ucc_loÿl_ho¡Çme
, ".");

294 
	`ucc_as£¹
((
ucc_ho¡_id_t
) >= ());

295 
ucc_loÿl_´oc
.
ho¡_hash
 = 
	`ucc_g‘_sy¡em_id
();

297 
ucc_loÿl_´oc
.
pid
 = 
	`g‘pid
();

298 
ucc_loÿl_´oc
.
sock‘_id
 = 
UCC_SOCKET_ID_INVALID
;

299 
ucc_loÿl_´oc
.
numa_id
 = 
UCC_NUMA_ID_INVALID
;

301 ià(
UCC_OK
 !ğ
	`ucc_g‘_bound_sock‘_id
(&
ucc_loÿl_´oc
.
sock‘_id
)) {

302 
	`ucc_debug
("failedo get bound socket id");

305 ià(
UCC_OK
 !ğ
	`ucc_g‘_bound_numa_id
(&
ucc_loÿl_´oc
.
numa_id
)) {

306 
	`ucc_debug
("failedo get bound‚uma id");

309 
	`ucc_debug
("proc…id %d, host %s, host_hash %lu, sockid %d,‚umaid %d",

310 
ucc_loÿl_´oc
.
pid
, 
ucc_loÿl_ho¡Çme
, ucc_loÿl_´oc.
ho¡_hash
,

311 ()
ucc_loÿl_´oc
.
sock‘_id
, ()ucc_loÿl_´oc.
numa_id
);

313  
UCC_OK
;

314 
	}
}

	@src/utils/ucc_proc_info.h

6 #iâdeà
UCC_PROC_INFO_H_


7 
	#UCC_PROC_INFO_H_


	)

9 
	~"cÚfig.h
"

10 
	~"ucc/­i/ucc.h
"

11 
	~<uni¡d.h
>

13 
ušt64_t
 
	tucc_ho¡_id_t
;

14 
ušt8_t
 
	tucc_sock‘_id_t
;

15 
ušt8_t
 
	tucc_numa_id_t
;

17 
	#UCC_SOCKET_ID_INVALID
 ((
ucc_sock‘_id_t
)-1)

	)

18 
	#UCC_NUMA_ID_INVALID
 ((
ucc_numa_id_t
)-1)

	)

20 
	#UCC_MAX_SOCKET_ID
 (
UCC_SOCKET_ID_INVALID
 - 1)

	)

21 
	#UCC_MAX_NUMA_ID
 (
UCC_NUMA_ID_INVALID
 - 1)

	)

23 
	succ_´oc_šfo
 {

24 
ucc_ho¡_id_t
 
	mho¡_hash
;

25 
ucc_sock‘_id_t
 
	msock‘_id
;

26 
ucc_numa_id_t
 
	mnuma_id
;

27 
ucc_ho¡_id_t
 
	mho¡_id
;

28 
pid_t
 
	mpid
;

29 } 
	tucc_´oc_šfo_t
;

31 
ucc_´oc_šfo_t
 
ucc_loÿl_´oc
;

33 
	#UCC_PROC_INFO_EQUAL
(
_pi1
, 
_pi2
) \

34 (((
_pi1
).
ho¡_hash
 =ğ(
_pi2
).host_hash) && \

35 ((
_pi1
).
pid
 =ğ(
_pi2
).pid))

36 

	)

37 
ucc_¡©us_t
 
ucc_loÿl_´oc_šfo_š™
();

39 
ušt64_t
 
ucc_g‘_sy¡em_id
();

41 cÚ¡ * 
ucc_ho¡Çme
();

	@src/utils/ucc_queue.h

7 #iâdeà
UCC_QUEUE_H_


8 
	#UCC_QUEUE_H_


	)

10 
	~<¡ddef.h
>

11 
	~<as£¹.h
>

13 
ucc_queue_–em
 
	tucc_queue_–em_t
;

14 
ucc_queue_h—d
 
	tucc_queue_h—d_t
;

15 
ucc_queue_–em_t
** 
	tucc_queue_™”_t
;

21 
	succ_queue_–em
 {

22 
ucc_queue_–em_t
 *
	mÃxt
;

29 
	succ_queue_h—d
 {

30 
ucc_queue_–em_t
 *
	mh—d
;

31 
ucc_queue_–em_t
 **
	m±a
;

39 
šlše
 
	$ucc_queue_h—d_š™
(
ucc_queue_h—d_t
 *
queue
)

41 #ifdeà
__şªg_ª®yz”__


42 
queue
->
h—d
 = (
ucc_queue_–em_t
*)(*)queue;

44 
queue
->
±a
 = &queue->
h—d
;

45 
	}
}

50 
šlše
 
size_t
 
	$ucc_queue_Ëngth
(
ucc_queue_h—d_t
 *
queue
)

52 
ucc_queue_–em_t
 **
³Ëm
;

53 
size_t
 
Ëngth
;

55 
Ëngth
 = 0;

56 
³Ëm
 = &
queue
->
h—d
;…–em !ğqueue->
±a
;…–em = &(*³Ëm)->
Ãxt
) {

57 ++
Ëngth
;

59  
Ëngth
;

60 
	}
}

65 
šlše
 
	$ucc_queue_is_em±y
(
ucc_queue_h—d_t
 *
queue
)

67  
queue
->
±a
 =ğ&queue->
h—d
;

68 
	}
}

76 
šlše
 
	$ucc_queue_push
(
ucc_queue_h—d_t
 *
queue
, 
ucc_queue_–em_t
 *
–em
)

78 *
queue
->
±a
 = 
–em
;

79 
queue
->
±a
 = &
–em
->
Ãxt
;

80 #ià
UCC_ENABLE_ASSERT


81 
–em
->
Ãxt
 = 
NULL
;

83 
	}
}

91 
šlše
 
	$ucc_queue_push_h—d
(
ucc_queue_h—d_t
 *
queue
,

92 
ucc_queue_–em_t
 *
–em
)

94 
–em
->
Ãxt
 = 
queue
->
h—d
;

95 
queue
->
h—d
 = 
–em
;

96 ià(
queue
->
±a
 =ğ&queue->
h—d
) {

97 
queue
->
±a
 = &
–em
->
Ãxt
;

99 
	}
}

107 
šlše
 
ucc_queue_–em_t
 *
	$ucc_queue_puÎ_nÚ_em±y
(
ucc_queue_h—d_t
 *
queue
)

109 
ucc_queue_–em_t
 *
–em
;

111 
–em
 = 
queue
->
h—d
;

112 
queue
->
h—d
 = 
–em
->
Ãxt
;

113 ià(
queue
->
±a
 =ğ&
–em
->
Ãxt
) {

114 
queue
->
±a
 = &queue->
h—d
;

116  
–em
;

117 
	}
}

124 
šlše
 
	$ucc_queue_d–_™”
(
ucc_queue_h—d_t
 *
queue
, 
ucc_queue_™”_t
 
™”
)

126 
	`as£¹
((
™”
 !ğ
NULL
) && (*iter != NULL));

128 ià(
queue
->
±a
 =ğ&(*
™”
)->
Ãxt
) {

129 
queue
->
±a
 = 
™”
;

130 *
™”
 = 
NULL
;

132 *
™”
 = (*™”)->
Ãxt
;

135 
	}
}

143 
šlše
 
ucc_queue_–em_t
 *
	$ucc_queue_puÎ
(
ucc_queue_h—d_t
 *
queue
)

145 ià(
	`ucc_queue_is_em±y
(
queue
))

146  
NULL
;

147  
	`ucc_queue_puÎ_nÚ_em±y
(
queue
);

148 
	}
}

157 
šlše
 
	$ucc_queue_¥liû
(
ucc_queue_h—d_t
 *
queue
,

158 
ucc_queue_h—d_t
 *
Ãw_–ems
)

160 ià(!
	`ucc_queue_is_em±y
(
Ãw_–ems
)) {

161 *
queue
->
±a
 = 
Ãw_–ems
->
h—d
;

162 
queue
->
±a
 = 
Ãw_–ems
->ptail;

163 
Ãw_–ems
->
±a
 = &Ãw_–ems->
h—d
;

165 
	}
}

176 
	#ucc_queue_puÎ_–em_nÚ_em±y
(
queue
, 
ty³
, 
memb”
) \

177 
	`ucc_cÚš”_of
(
	`ucc_queue_puÎ_nÚ_em±y
(
queue
), 
ty³
, 
memb”
)

	)

188 
	#ucc_queue_h—d_–em_nÚ_em±y
(
queue
, 
ty³
, 
memb”
) \

189 
	`ucc_cÚš”_of
((
queue
)->
h—d
, 
ty³
, 
memb”
)

	)

200 
	#ucc_queue__–em_nÚ_em±y
(
queue
, 
ty³
, 
memb”
) \

201 
	`ucc_cÚš”_of
((
queue
)->
±a
, 
ty³
, 
memb”
)

	)

210 
	#ucc_queue_fÜ_—ch
(
–em
, 
queue
, 
memb”
) \

212 *(
queue
)->
±a
 = (
ucc_queue_–em_t
*)(*)(queue), \

213 
–em
 = 
	`ucc_cÚš”_of
((
queue
)->
h—d
, 
	`ty³of
(*–em), 
memb”
); \

214 (
	`UCC_PTR_BYTE_OFFSET
(
–em
, 
	`ucc_off£tof
(
	`ty³of
(*–em), 
memb”
)) != \

215 (*)(
queue
)); \

216 
–em
 = 
	`ucc_cÚš”_of
ÓËm->
memb”
.
Ãxt
, 
	`ty³of
(*–em), memb”))

	)

227 
	#ucc_queue_fÜ_—ch_§ã
(
–em
, 
™”
, 
queue
, 
memb”
) \

228 
™”
 = &(
queue
)->
h—d
, \

229 
–em
 = 
	`ucc_cÚš”_of
(*
™”
, 
	`ty³of
(*–em), 
memb”
); \

230 
™”
 !ğ(
queue
)->
±a
; \

231 
™”
 = (*™” =ğ&
–em
->
memb”
è? &(*™”)->
Ãxt
 : iter, \

232 
–em
 = 
	`ucc_cÚš”_of
(*
™”
, 
	`ty³of
(*–em), 
memb”
))

	)

244 
	#ucc_queue_fÜ_—ch_exŒaù
(
–em
, 
queue
, 
memb”
, 
cÚd
) \

245 
–em
 = 
	`ucc_cÚš”_of
((
queue
)->
h—d
, 
	`ty³of
(*–em), 
memb”
); \

247 !
	`ucc_queue_is_em±y
(
queue
è&& (
cÚd
è&& 
	`ucc_queue_puÎ_nÚ_em±y
(queue); \

249 
–em
 = 
	`ucc_cÚš”_of
((
queue
)->
h—d
, 
	`ty³of
(*–em), 
memb”
))

	)

256 
šlše
 
ucc_queue_™”_t
 
	$ucc_queue_™”_begš
(
ucc_queue_h—d_t
 *
q
)

258  &
q
->
h—d
;

259 
	}
}

261 
šlše
 
ucc_queue_™”_t
 
	$ucc_queue_™”_Ãxt
(
ucc_queue_™”_t
 
i
)

263  &(*
i
)->
Ãxt
;

264 
	}
}

266 
šlše
 
	$ucc_queue_™”_’d
(
ucc_queue_h—d_t
 *
q
, 
ucc_queue_™”_t
 
i
)

268  
i
 =ğ
q
->
±a
;

269 
	}
}

271 
šlše
 
	$ucc_queue_»move
(
ucc_queue_h—d_t
 *
queue
, 
ucc_queue_–em_t
 *
–em
)

273 
ucc_queue_™”_t
 
™”
 = 
	`ucc_queue_™”_begš
(
queue
);

275 !
	`ucc_queue_™”_’d
(
queue
, 
™”
)) {

276 ià(*
™”
 =ğ
–em
) {

277 
	`ucc_queue_d–_™”
(
queue
, 
™”
);

280 
™”
 = 
	`ucc_queue_™”_Ãxt
(iter);

282 
	}
}

284 
	#ucc_queue_™”_–em
(
–em
, 
™”
, 
memb”
) \

285 
	`ucc_cÚš”_of
(*
™”
, 
	`ty³of
(*
–em
), 
memb”
)

	)

	@src/utils/ucc_rcache.h

7 #iâdeà
UCC_RCACHE_H_


8 
	#UCC_RCACHE_H_


	)

10 
	~<ucs/memÜy/rÿche.h
>

11 
	~<ucm/­i/ucm.h
>

12 
	~<uts/ucc_sys.h
>

15 
	#ucc_rÿche_t
 
ucs_rÿche_t


	)

16 
	#ucc_rÿche_İs_t
 
ucs_rÿche_İs_t


	)

17 
	#ucc_rÿche_·¿ms_t
 
ucs_rÿche_·¿ms_t


	)

18 
	#ucc_rÿche_»giÚ_t
 
ucs_rÿche_»giÚ_t


	)

20 
šlše
 
	$ucc_rÿche_£t_deçuÉ_·¿ms
(
ucs_rÿche_·¿ms_t
 *
rÿche_·¿ms
)

22 
rÿche_·¿ms
->
»giÚ_¡ruù_size
 = (
ucs_rÿche_»giÚ_t
);

23 
rÿche_·¿ms
->
ucm_ev’ts
 = 0;

24 
rÿche_·¿ms
->
ucm_ev’t_´iÜ™y
 = 1000;

25 
rÿche_·¿ms
->
İs
 = 
NULL
;

26 
rÿche_·¿ms
->
cÚ‹xt
 = 
NULL
;

27 
rÿche_·¿ms
->
æags
 = 0;

28 
rÿche_·¿ms
->
max_»giÚs
 = 
UCS_MEMUNITS_INF
;

29 
rÿche_·¿ms
->
max_size
 = 
UCS_MEMUNITS_INF
;

30 
rÿche_·¿ms
->
max_uÄ–—£d
 = 
UCS_MEMUNITS_INF
;

31 
	}
}

33 
	#ucc_rÿche_de¡roy
 
ucs_rÿche_de¡roy


	)

34 
	#ucc_rÿche_»giÚ_hŞd
 
ucs_rÿche_»giÚ_hŞd


	)

35 
	#ucc_rÿche_»giÚ_put
 
ucs_rÿche_»giÚ_put


	)

36 
	#ucc_rÿche_»giÚ_šv®id©e
 
ucs_rÿche_»giÚ_šv®id©e


	)

38 
šlše
 

39 
	$ucc_rÿche_m”ge_cb_em±y
(*
cÚ‹xt
, 
ucs_rÿche_t
 *
rÿche
,

40 *
¬g
, 
ucs_rÿche_»giÚ_t
 *
»giÚ
)

43 
	}
}

46 
šlše
 
ucc_¡©us_t


47 
	$ucc_rÿche_ü—‹
(cÚ¡ 
ucc_rÿche_·¿ms_t
 *
·¿ms
,

48 cÚ¡ *
Çme
, 
ucc_rÿche_t
 **
rÿche_p
)

50 #iâdeà
UCS_HAVE_RCACHE_REGION_ALIGNMENT


51 
ucc_rÿche_·¿ms_t
 
·¿ms_dup
 = *
·¿ms
;

52 
·¿ms_dup
.
®ignm’t
 = 
UCS_PGT_ADDR_ALIGN
;

53 
·¿ms_dup
.
max_®ignm’t
 = 
	`ucc_g‘_·ge_size
();

55  
	`ucs_¡©us_to_ucc_¡©us
(
	`ucs_rÿche_ü—‹
(

56 &
·¿ms_dup
, 
Çme
, 
NULL
, 
rÿche_p
));

58  
	`ucs_¡©us_to_ucc_¡©us
(
	`ucs_rÿche_ü—‹
(

59 
·¿ms
, 
Çme
, 
NULL
, 
rÿche_p
));

61 
	}
}

66 
šlše
 
ucc_¡©us_t


67 
	$ucc_rÿche_g‘
(
ucc_rÿche_t
 *
rÿche
, *
add»ss
, 
size_t
 
Ëngth
,

68 *
¬g
, 
ucc_rÿche_»giÚ_t
 **
»giÚ_p
)

70 
ucs_¡©us_t
 
¡©us
;

72 #ifdeà
UCS_HAVE_RCACHE_REGION_ALIGNMENT


73 
¡©us
 = 
	`ucs_rÿche_g‘
(
rÿche
, 
add»ss
, 
Ëngth
, 
UCS_PGT_ADDR_ALIGN
,

74 
PROT_READ
 | 
PROT_WRITE
, 
¬g
, 
»giÚ_p
);

76 
¡©us
 = 
	`ucs_rÿche_g‘
(
rÿche
, 
add»ss
, 
Ëngth
,

77 
PROT_READ
 | 
PROT_WRITE
, 
¬g
, 
»giÚ_p
);

80  
	`ucs_¡©us_to_ucc_¡©us
(
¡©us
);

81 
	}
}

	@src/utils/ucc_spinlock.h

6 #iâdeà
UCC_SPINLOCK_H_


7 
	#UCC_SPINLOCK_H_


	)

9 
	~"cÚfig.h
"

10 
	~"ucs/ty³/¥šlock.h
"

12 
	#ucc_¥šlock_t
 
ucs_¥šlock_t


	)

13 
	#ucc_¥šlock_š™
 
ucs_¥šlock_š™


	)

14 
	#ucc_¥šlock_de¡roy
 
ucs_¥šlock_de¡roy


	)

15 
	#ucc_¥š_lock
 
ucs_¥š_lock


	)

16 
	#ucc_¥š_Œy_lock
 
ucs_¥š_Œy_lock


	)

17 
	#ucc_¥š_uÆock
 
ucs_¥š_uÆock


	)

19 
	#ucc_»cursive_¥šlock_t
 
ucs_»cursive_¥šlock_t


	)

20 
	#ucc_»cursive_¥šlock_š™
 
ucs_»cursive_¥šlock_š™


	)

21 
	#ucc_»cursive_¥šlock_de¡roy
 
ucs_»cursive_¥šlock_de¡roy


	)

22 
	#ucc_»cursive_¥š_is_owÃr
 
ucs_»cursive_¥š_is_owÃr


	)

23 
	#ucc_»cursive_¥š_lock
 
ucs_»cursive_¥š_lock


	)

24 
	#ucc_»cursive_¥š_Œylock
 
ucs_»cursive_¥š_Œylock


	)

25 
	#ucc_»cursive_¥š_uÆock
 
ucs_»cursive_¥š_uÆock


	)

	@src/utils/ucc_status.c

6 
	~"cÚfig.h
"

7 
	~"ucc/­i/ucc_¡©us.h
"

8 
	~<¡dio.h
>

10 cÚ¡ *
	$ucc_¡©us_¡ršg
(
ucc_¡©us_t
 
¡©us
)

12 
”rÜ_¡r
[128] = {0};

14 
¡©us
) {

15 
UCC_OK
:

17 
UCC_INPROGRESS
:

19 
UCC_OPERATION_INITIALIZED
:

21 
UCC_ERR_NOT_SUPPORTED
:

23 
UCC_ERR_NOT_IMPLEMENTED
:

25 
UCC_ERR_INVALID_PARAM
:

27 
UCC_ERR_NO_MEMORY
:

29 
UCC_ERR_NO_RESOURCE
:

31 
UCC_ERR_NO_MESSAGE
:

33 
UCC_ERR_NOT_FOUND
:

35 
UCC_ERR_TIMED_OUT
:

38 
	`¢´štf
(
”rÜ_¡r
, Ó¼Ü_¡rè- 1, "UnknowÀ”rÜ %d", 
¡©us
);

39  
”rÜ_¡r
;

41 
	}
}

	@src/utils/ucc_string.c

6 
	~"ucc_¡ršg.h
"

7 
	~"ucc_m®loc.h
"

8 
	~"ucc_log.h
"

9 
	~"ucc_cŞl_uts.h
"

10 
	~<ùy³.h
>

11 
	~<ucs/sys/¡ršg.h
>

13 **
	$ucc_¡r_¥l™
(cÚ¡ *
¡r
, cÚ¡ *
d–im
)

15 
®loc_size
 = 8;

16 
size
 = 0;

17 **
out
;

18 *
¡r_cİy
, *
tok’
, *
§v•Œ
;

19 
i
;

20 
out
 = 
	`ucc_m®loc
(
®loc_size
 * (*), "str_split");

21 ià(!
out
) {

22 
	`ucc_”rÜ
("failedo‡llocate %zd bytes for str_split",

23 
®loc_size
 * (*));

24  
NULL
;

26 
¡r_cİy
 = 
	`¡rdup
(
¡r
);

27 ià(!
¡r_cİy
) {

28 
	`ucc_”rÜ
("failedo duplicate string");

29 
”rÜ
;

31 
tok’
 = 
	`¡¹ok_r
(
¡r_cİy
, 
d–im
, &
§v•Œ
);

32 
NULL
 !ğ
tok’
) {

33 
out
[
size
] = 
	`¡rdup
(
tok’
);

34 ià(!
out
[
size
]) {

35 
	`ucc_”rÜ
("failedo duplicate string");

36 
”rÜ
;

38 
size
++;

39 ià(
size
 =ğ(
®loc_size
 - 1)) {

40 
®loc_size
 *= 2;

41 
out
 = 
	`ucc_»®loc
(out, 
®loc_size
 * (*), "str_split");

42 ià(!
out
) {

43 
	`ucc_”rÜ
("failedo„eallocate %zd bytes for str_split",

44 
®loc_size
 * (*));

45 
”rÜ
;

48 
tok’
 = 
	`¡¹ok_r
(
NULL
, 
d–im
, &
§v•Œ
);

50 
out
[
size
] = 
NULL
;

51 
	`ucc_ä“
(
¡r_cİy
);

52  
out
;

53 
”rÜ
:

54 ià(
out
) {

55 
i
 = 0; i < 
size
; i++) {

56 
	`ucc_ä“
(
out
[
i
]);

58 
	`ucc_ä“
(
out
);

60 
	`ucc_ä“
(
¡r_cİy
);

61  
NULL
;

62 
	}
}

64 
	$ucc_¡r_¥l™_couÁ
(**
¥l™
)

66 
couÁ
;

67 ià(
NULL
 =ğ
¥l™
) {

70 
couÁ
 = 0;

71 
NULL
 !ğ(*
¥l™
)) {

72 
couÁ
++;

73 
¥l™
++;

75  
couÁ
;

76 
	}
}

78 
	$ucc_¡r_¥l™_ä“
(**
¥l™
)

80 **
™”
 = 
¥l™
;

81 ià(
NULL
 =ğ
¥l™
) {

84 
NULL
 !ğ(*
™”
)) {

85 
	`ucc_ä“
(*
™”
);

86 
™”
++;

88 
	`ä“
(
¥l™
);

89 
	}
}

91 
ucc_¡©us_t
 
	$ucc_¡r_is_numb”
(cÚ¡ *
¡r
)

93 
i
, 
Ën
;

94 
Ën
 = 
	`¡¾’
(
¡r
);

95 
i
 = 0; i < 
Ën
; i++) {

96 ià(!
	`isdig™
(
¡r
[
i
])) {

97  
UCC_ERR_INVALID_PARAM
;

100  
UCC_OK
;

101 
	}
}

103 
ucc_¡©us_t
 
	$ucc_¡r_to_memun™s
(cÚ¡ *
buf
, *
de¡
)

105  
	`ucs_¡©us_to_ucc_¡©us
(
	`ucs_¡r_to_memun™s
(
buf
, 
de¡
));

106 
	}
}

108 cÚ¡ * 
	$ucc_¡r¡r_Ï¡
(cÚ¡ * 
¡ršg
, cÚ¡ * 
·‰”n
)

110 cÚ¡ *
found
 = 
NULL
;

112 (
¡ršg
 = 
	`¡r¡r
(¡ršg, 
·‰”n
))) {

113 
found
 = 
¡ršg
++;

115  
found
;

116 
	}
}

118 
ucc_¡©us_t
 
	$ucc_¡r_cÚÿt_n
(cÚ¡ *
¡rs
[], 
n
, **
out
)

120 
size_t
 
Ën
 = 1;

121 *
r¡
;

122 
i
;

124 
i
 = 0; i < 
n
; i++) {

125 
Ën
 +ğ
	`¡¾’
(
¡rs
[
i
]);

128 
r¡
 = 
	`ucc_m®loc
(
Ën
, "str_concat");

129 ià(!
r¡
) {

130 
	`ucc_”rÜ
("çedØ®loÿ‹ %zd by‹ fÜ cÚÿ‹Ç‹d sŒšg", 
Ën
);

131  
UCC_ERR_NO_MEMORY
;

133 
	`ucc_¡ºıy_§ã
(
r¡
, 
¡rs
[0], 
Ën
);

135 
i
 = 1; i < 
n
; i++) {

136 
Ën
 -ğ
	`¡¾’
(
¡rs
[
i
 - 1]);

137 
	`¡ºÿt
(
r¡
, 
¡rs
[
i
], 
Ën
);

139 *
out
 = 
r¡
;

140  
UCC_OK
;

141 
	}
}

143 
ucc_¡©us_t
 
	$ucc_¡r_cÚÿt
(cÚ¡ *
¡r1
, cÚ¡ *
¡r2
, **
out
)

145 cÚ¡ *
¡rs
[2] = {
¡r1
, 
¡r2
};

147  
	`ucc_¡r_cÚÿt_n
(
¡rs
, 2, 
out
);

148 
	}
}

150 
ucc_¡©us_t
 
	$ucc_¡r_to_memun™s_¿nge
(cÚ¡ *
¡r
, 
size_t
 *
¡¬t
,

151 
size_t
 *
’d
)

153 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

154 **
mun™s
;

155 
n_mun™s
;

157 
mun™s
 = 
	`ucc_¡r_¥l™
(
¡r
, "-");

158 ià(!
mun™s
) {

159  
UCC_ERR_NO_MEMORY
;

161 
n_mun™s
 = 
	`ucc_¡r_¥l™_couÁ
(
mun™s
);

162 ià(
n_mun™s
 !ğ2 || 
UCC_OK
 !ğ
	`ucc_¡r_to_memun™s
(
mun™s
[0], 
¡¬t
) ||

163 
UCC_OK
 !ğ
	`ucc_¡r_to_memun™s
(
mun™s
[1], 
’d
)) {

164 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

167 
	`ucc_¡r_¥l™_ä“
(
mun™s
);

168  
¡©us
;

169 
	}
}

171 
ucc_¡©us_t
 
	$ucc_¡r_to_mty³_m­
(cÚ¡ *
¡r
, cÚ¡ *
d–im
,

172 
ušt32_t
 *
mt_m­
)

174 
ucc_¡©us_t
 
¡©us
 = 
UCC_OK
;

175 ** 
tok’s
;

176 
i
, 
n_tok’s
;

177 
ucc_memÜy_ty³_t
 
t
;

179 *
mt_m­
 = 0;

180 
tok’s
 = 
	`ucc_¡r_¥l™
(
¡r
, 
d–im
);

181 ià(!
tok’s
) {

182  
UCC_ERR_NO_MEMORY
;

184 
n_tok’s
 = 
	`ucc_¡r_¥l™_couÁ
(
tok’s
);

186 
i
 = 0; i < 
n_tok’s
; i++) {

187 
t
 = 
	`ucc_mem_ty³_äom_¡r
(
tok’s
[
i
]);

188 ià(
t
 =ğ
UCC_MEMORY_TYPE_LAST
) {

190 
¡©us
 = 
UCC_ERR_INVALID_PARAM
;

191 
out
;

193 *
mt_m­
 |ğ
	`UCC_BIT
(
t
);

195 
out
:

196 
	`ucc_¡r_¥l™_ä“
(
tok’s
);

197  
¡©us
;

198 
	}
}

200 
	$ucc_mty³_m­_to_¡r
(
ušt32_t
 
mt_m­
, cÚ¡ *
d–im
,

201 *
buf
, 
size_t
 
max
)

203 
i
;

204 
size_t
 
Ï¡
;

206 
i
 = 0; i < 
UCC_MEMORY_TYPE_LAST
; i++) {

207 ià(
	`UCC_BIT
(
i
è& 
mt_m­
) {

208 
	`ucc_¢´štf_§ã
(
buf
, 
max
, "%s%s",

209 
	`ucc_mem_ty³_¡r
((
ucc_memÜy_ty³_t
)
i
), 
d–im
);

210 
Ï¡
 = 
	`¡¾’
(
buf
);

211 ià(
max
 - 
Ï¡
 -1 <= 0) {

216 
max
 -ğ
Ï¡
;

217 
buf
 +ğ
Ï¡
;

221 
buf
 -ğ
	`¡¾’
(
d–im
);

222 *
buf
 = '\0';

223 
	}
}

225 
ssize_t
 
	$ucc_¡ršg_fšd_š_li¡
(cÚ¡ *
¡r
, cÚ¡ **
¡ršg_li¡
,

226 
ÿ£_£ns™ive
)

228 
size_t
 
i
;

230 
i
 = 0; 
¡ršg_li¡
[i] !ğ
NULL
; ++i) {

231 ià((
ÿ£_£ns™ive
 && (
	`¡rcmp
(
¡ršg_li¡
[
i
], 
¡r
) == 0)) ||

232 (!
ÿ£_£ns™ive
 && (
	`¡rÿ£cmp
(
¡ršg_li¡
[
i
], 
¡r
) == 0))) {

233  
i
;

238 
	}
}

	@src/utils/ucc_string.h

7 #iâdeà
UCC_STRING_H_


8 
	#UCC_STRING_H_


	)

10 
	~"cÚfig.h
"

11 
	~"ucc/­i/ucc_def.h
"

12 
	~<sys/ty³s.h
>

14 
	#ucc_memun™s_¿nge_¡r
 
ucs_memun™s_¿nge_¡r


	)

16 ** 
ucc_¡r_¥l™
(cÚ¡ *
¡r
, cÚ¡ *
d–im
);

18 
ucc_¡r_¥l™_couÁ
(**
¥l™
);

20 
ucc_¡r_¥l™_ä“
(**
¥l™
);

22 
ucc_¡©us_t
 
ucc_¡r_is_numb”
(cÚ¡ *
¡r
);

24 
ucc_¡©us_t
 
ucc_¡r_to_memun™s
(cÚ¡ *
buf
, *
de¡
);

27 cÚ¡ * 
ucc_¡r¡r_Ï¡
(cÚ¡ * 
¡ršg
, cÚ¡ * 
·‰”n
);

31 
ucc_¡©us_t
 
ucc_¡r_cÚÿt
(cÚ¡ *
¡r1
, cÚ¡ *
¡r2
,

32 **
out
);

34 
ucc_¡©us_t
 
ucc_¡r_cÚÿt_n
(cÚ¡ *
¡rs
[], 
n
, **
out
);

36 
ucc_¡©us_t
 
ucc_¡r_to_mty³_m­
(cÚ¡ *
¡r
, cÚ¡ * 
d–im
,

37 
ušt32_t
 *
mt_m­
);

39 
ucc_mty³_m­_to_¡r
(
ušt32_t
 
mt_m­
, cÚ¡ *
d–im
,

40 *
buf
, 
size_t
 
max
);

42 
ucc_¡©us_t
 
ucc_¡r_to_memun™s_¿nge
(cÚ¡ *
¡r
, 
size_t
 *
¡¬t
,

43 
size_t
 *
’d
);

54 
ssize_t
 
ucc_¡ršg_fšd_š_li¡
(cÚ¡ *
¡r
, cÚ¡ **
¡ršg_li¡
,

55 
ÿ£_£ns™ive
);

	@src/utils/ucc_sys.c

6 
	~"ucc_sys.h
"

7 
	~"ucc_m©h.h
"

8 
	~"ucc_log.h
"

9 
	~<sys/shm.h
>

10 
	~<uni¡d.h
>

11 
	~<”ºo.h
>

12 
	~<dlfú.h
>

13 
	~<libg’.h
>

14 
	~"ucc_¡ršg.h
"

16 
ucc_¡©us_t
 
	$ucc_sysv_®loc
(
size_t
 *
size
, **
addr
, *
shm_id
)

18 
size_t
 
®loc_size
;

19 *
±r
;

20 
»t
;

22 
®loc_size
 = 
	`ucc_®ign_up
(*
size
, 
	`g‘·gesize
());

24 *
shm_id
 = 
	`shmg‘
(
IPC_PRIVATE
, 
®loc_size
, 
IPC_CREAT
 | 0666);

25 ià(*
shm_id
 < 0) {

26 
	`ucc_”rÜ
("failedo shmget with IPC_PRIVATE, size %zd, IPC_CREAT "

27 "”ºo: %d(%s)", 
®loc_size
, 
”ºo
, 
	`¡»¼Ü
(errno));

28  
UCC_ERR_NO_RESOURCE
;

31 
±r
 = 
	`shm©
(*
shm_id
, 
NULL
, 0);

35 
»t
 = 
	`shmùl
(*
shm_id
, 
IPC_RMID
, 
NULL
);

36 ià(
»t
 != 0) {

37 
	`ucc_w¬n
("shmùl(IPC_RMID, shmid=%dè”ºo: %d(%s)", *
shm_id
, 
”ºo
,

38 
	`¡»¼Ü
(
”ºo
));

41 ià(
±r
 == (*)-1) {

42 
	`ucc_”rÜ
("çedØshm©ƒ¼no: %d(%s)", 
”ºo
, 
	`¡»¼Ü
(errno));

43 ià(
”ºo
 =ğ
ENOMEM
) {

44  
UCC_ERR_NO_MEMORY
;

46  
UCC_ERR_NO_MESSAGE
;

49 *
size
 = 
®loc_size
;

50 *
addr
 = 
±r
;

52  
UCC_OK
;

53 
	}
}

55 
ucc_¡©us_t
 
	$ucc_sysv_ä“
(*
addr
)

57 
»t
;

59 
»t
 = 
	`shmdt
(
addr
);

60 ià(
»t
) {

61 
	`ucc_w¬n
("çedØd‘ach shm‡ˆ%p,ƒ¼no: %d(%s)", 
addr
, 
”ºo
,

62 
	`¡»¼Ü
(
”ºo
));

63  
UCC_ERR_INVALID_PARAM
;

66  
UCC_OK
;

67 
	}
}

72 
size_t
 
	$ucc_g‘_·ge_size
()

74 
·ge_size
 = 0;

75 ià(
·ge_size
 == 0) {

76 
·ge_size
 = 
	`syscÚf
(
_SC_PAGESIZE
);

77 ià(
·ge_size
 < 0) {

78 
·ge_size
 = 4096;

79 
	`ucc_debug
("_SC_PAGESIZE undefined, setting default valueo %ld",

80 
·ge_size
);

84  
·ge_size
;

85 
	}
}

87 
ucc_¡©us_t
 
	$ucc_sys_g‘_lib_šfo
(
Dl_šfo
 *
dl_šfo
)

89 
»t
;

91 ()
	`dË¼Ü
();

92 
»t
 = 
	`dÏddr
(
ucc_sys_g‘_lib_šfo
, 
dl_šfo
);

93 ià(
»t
 == 0) {

94  
UCC_ERR_NO_MESSAGE
;

97  
UCC_OK
;

98 
	}
}

101 cÚ¡ * 
	$ucc_sys_g‘_lib_·th
()

103 
ucc_¡©us_t
 
¡©us
;

104 
Dl_šfo
 
dl_šfo
;

106 
¡©us
 = 
	`ucc_sys_g‘_lib_šfo
(&
dl_šfo
);

107 ià(
¡©us
 !ğ
UCC_OK
) {

108  
NULL
;

111  
dl_šfo
.
dli_âame
;

112 
	}
}

114 
ucc_¡©us_t
 
	$ucc_sys_dœÇme
(cÚ¡ *
·th
, **
out
)

116 *
·th_dup
 = 
	`¡rdup
(
·th
);

117 *
dœÇme_·th
;

119 ià(!
·th_dup
) {

120  
UCC_ERR_NO_MEMORY
;

122 
dœÇme_·th
 = 
	`¡rdup
(
	`dœÇme
(
·th_dup
));

123 
	`ä“
(
·th_dup
);

124 *
out
 = 
dœÇme_·th
;

125  
UCC_OK
;

126 
	}
}

128 
ucc_¡©us_t
 
	$ucc_sys_·th_još
(cÚ¡ *
·th1
, cÚ¡ *
·th2
, **
out
)

130 cÚ¡ *
¡rs
[3] = {
·th1
, "/", 
·th2
};

132  
	`ucc_¡r_cÚÿt_n
(
¡rs
, 3, 
out
);

133 
	}
}

	@src/utils/ucc_sys.h

6 #iâdeà
UCC_SYS_H_


7 
	#UCC_SYS_H_


	)

9 
	~"ucc/­i/ucc_¡©us.h
"

10 
	~"uts/ucc_comp”_def.h
"

11 
	~"uts/ucc_log.h
"

12 
	~<¡ddef.h
>

13 
	~<uni¡d.h
>

14 
	~<as£¹.h
>

16 
ucc_¡©us_t
 
ucc_sysv_®loc
(
size_t
 *
size
, **
addr
, *
shm_id
);

18 
ucc_¡©us_t
 
ucc_sysv_ä“
(*
addr
);

20 cÚ¡ * 
ucc_sys_g‘_lib_·th
();

22 
ucc_¡©us_t
 
ucc_sys_dœÇme
(cÚ¡ *
·th
, **
out
);

24 
ucc_¡©us_t
 
ucc_sys_·th_još
(cÚ¡ *
·th1
, cÚ¡ *
·th2
,

25 **
out
);

27 
size_t
 
ucc_g‘_·ge_size
();

	@src/utils/ucc_time.h

6 #iâdeà
UCC_TIME_H_


7 
	#UCC_TIME_H_


	)

8 
	~"cÚfig.h
"

9 
	~<sys/time.h
>

11 
	#UCC_USEC_PER_SEC
 1000000uÈ

	)

16 
šlše
 
	$ucc_g‘_time
()

18 
timev®
 
tv
;

19 
	`g‘timeofday
(&
tv
, 
NULL
);

20  
tv
.
tv_£c
 + (tv.
tv_u£c
 / ()
UCC_USEC_PER_SEC
);

21 
	}
}

	@test/cmake/main.cpp

1 
	~<ucc/­i/ucc.h
>

2 
	~<ÿs£¹
>

4 
	$maš
(
¬gc
, *
¬gv
[]) {

5 
ucc_¡©us_t
 
¡
;

7 
ucc_lib_cÚfig_h
 
lib_cÚfig
;

8 
¡
 = 
	`ucc_lib_cÚfig_»ad
(
nuÎ±r
,‚uÎ±r, &
lib_cÚfig
);

9 
	`as£¹
(
¡
 =ğ
UCC_OK
);

11 
ucc_lib_·¿ms_t
 
lib_·¿ms
 = {};

12 
lib_·¿ms
.
mask
 = 
UCC_LIB_PARAM_FIELD_THREAD_MODE
;

13 
lib_·¿ms
.
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

15 
ucc_lib_h
 
lib
;

16 
¡
 = 
	`ucc_š™
(&
lib_·¿ms
, 
lib_cÚfig
, &
lib
);

17 
	`as£¹
(
¡
 =ğ
UCC_OK
);

19 
	`ucc_lib_cÚfig_»Ëa£
(
lib_cÚfig
);

20 
	`ucc_fš®ize
(
lib
);

22 
	}
}

	@test/gtest/active_set/test_active_set.cc

6 
	~"commÚ/‹¡_ucc.h
"

7 
	~<unÜd”ed_£t
>

9 
	g¡d
::
	ttu¶e
<
	tušt64_t
, ušt64_t, 
	tšt64_t
, ušt64_t, 
	tsize_t
,

10 
	tucc_memÜy_ty³_t
> 
	tİ_t
;

11 
usšg
 
	gP¬am
 = 
¡d
::
tu¶e
<¡d::
veùÜ
<
İ_t
>, 
	gucc_job_’v_t
, >;

13 
	#OP_T
(
_roÙ
, 
_a£t_¡¬t
, 
_a£t_¡ride
, 
_a£t_size
, 
_msg_size
, 
_mt
) ({ \

14 
İ_t
 
	`_İ
(
_roÙ
, 
_a£t_¡¬t
, 
_a£t_¡ride
, 
_a£t_size
, \

15 
_msg_size
, 
UCC_MEMORY_TYPE_
 ## 
_mt
); \

16 
_İ
; \

17 })

	)

19 
şass
 
	g‹¡_aùive_£t
 : 
public
 
ucc
::
‹¡
,

20 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am
>

22 
public
:

23 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

24 
d©a_š™
(
¡d
::
veùÜ
<
İ_t
> &
İs
, 
UccT—m_h
 
‹am
) {

25 
ucc_¿nk_t
 
	gtsize
 = 
‹am
->
´ocs
.
size
();

26 
	gùxs
.
»size
(
İs
.
size
());

27 
	gi
 = 0; i < 
	gİs
.
size
(); i++) {

28 
ušt64_t
 
	ga£t_roÙ
 = 
¡d
::
g‘
<0>(
İs
[
i
]);

29 
ušt64_t
 
	ga£t_¡¬t
 = 
¡d
::
g‘
<1>(
İs
[
i
]);

30 
št64_t
 
	ga£t_¡ride
 = 
¡d
::
g‘
<2>(
İs
[
i
]);

31 
ušt64_t
 
	ga£t_size
 = 
¡d
::
g‘
<3>(
İs
[
i
]);

32 
size_t
 
	gmsgËn
 = 
¡d
::
g‘
<4>(
İs
[
i
]);

33 
ucc_memÜy_ty³_t
 
	gmt
 = 
¡d
::
g‘
<5>(
İs
[
i
]);

37 
ušt64_t
 
	gto_add
 = 
a£t_¡¬t
;

38 
	g¡d
::
unÜd”ed_£t
<
ušt64_t
> 
a£t
{
to_add
};

40 
	ga£t
.
size
(è!ğ
a£t_size
) {

41 
to_add
 = (to_add + 
a£t_¡ride
è% 
tsize
;

44 
EXPECT_EQ
(
a£t
.
fšd
(
to_add
),‡£t.
’d
());

45 
	ga£t
.
š£¹
(
to_add
);

48 
	gùxs
[
i
].
»size
(
tsize
);

49 
	gj
 = 0; j < 
	gtsize
; j++) {

50 ià(
	ga£t
.
fšd
(
j
è=ğ
a£t
.
’d
()) {

51 
ùxs
[
i
][
j
] = 
NULL
;

54 
	gùxs
[
i
][
j
] = (
g‹¡_ucc_cŞl_ùx_t
*)

55 
ÿÎoc
(1, (
g‹¡_ucc_cŞl_ùx_t
));

56 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = (ucc_coll_args_t*)

57 
ÿÎoc
(1, (
ucc_cŞl_¬gs_t
));

59 
	gùxs
[
i
][
j
]->
	g¬gs
 = 
cŞl
;

61 
	gcŞl
->
	gmask
 =

62 
UCC_COLL_ARGS_FIELD_ACTIVE_SET
 | 
UCC_COLL_ARGS_FIELD_TAG
;

63 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_BCAST
;

64 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mt
;

65 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
msgËn
;

66 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
UCC_DT_INT8
;

67 
	gcŞl
->
	groÙ
 = 
a£t_roÙ
;

68 
	gcŞl
->
	gaùive_£t
.
	gsize
 = 
a£t_size
;

69 
	gcŞl
->
	gaùive_£t
.
	g¡¬t
 = 
a£t_¡¬t
;

70 
	gcŞl
->
	gaùive_£t
.
	g¡ride
 = 
a£t_¡ride
;

71 
	gcŞl
->
	gg
 = 
i
;

73 
	gùxs
[
i
][
j
]->
	grbuf_size
 = 
msgËn
;

74 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
i
][
j
]->
¤c_mc_h—d”
,

75 
ùxs
[
i
][
j
]->
rbuf_size
, 
mt
));

76 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
i
][
j
]->
¤c_mc_h—d”
->
addr
;

78 
	gk
 = 0; k < 
	gùxs
[
i
][
j
]->
	grbuf_size
; k++) {

79 ((
	gušt8_t
 *)
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
)[
k
] = (
ušt8_t
) 0;

82 ià(
	gj
 =ğ
a£t_roÙ
) {

83 
ùxs
[
i
][
j
]->
š™_buf
 = 
ucc_m®loc
(ùxs[i][j]->
rbuf_size
,

85 
EXPECT_NE
(
ùxs
[
i
][
j
]->
š™_buf
, 
nuÎ±r
);

86 
ušt8_t
 *
	gsbuf
 = (ušt8_t*)
ùxs
[
i
][
j
]->
š™_buf
;

87 
	gk
 = 0; k < 
	gùxs
[
i
][
j
]->
	grbuf_size
; k++) {

88 
	gsbuf
[
k
] = (
ušt8_t
è
a£t_roÙ
;

90 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
,

91 
ùxs
[
i
][
j
]->
š™_buf
,

92 
ùxs
[
i
][
j
]->
rbuf_size
, 
mt
,

93 
UCC_MEMORY_TYPE_HOST
));

100 
d©a_fši
(
UccT—m_h
 
‹am
)

102 
	gi
 = 0; i < 
	gùxs
.
size
(); i++) {

103 
	gj
 = 0; j < 
	gùxs
[
i
].
size
(); j++ ) {

104 
g‹¡_ucc_cŞl_ùx_t
 *
	gùx
 = 
ùxs
[
i
][
j
];

105 ià(!
	gùx
) {

108 
ucc_cŞl_¬gs_t
* 
	gcŞl
 = 
ùx
->
¬gs
;

109 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

110 ià(
	gj
 =ğ
cŞl
->
roÙ
) {

111 
ucc_ä“
(
ùx
->
š™_buf
);

113 
ä“
(
cŞl
);

114 
ä“
(
ùx
);

116 
	gùxs
[
i
].
ş—r
();

118 
	gùxs
.
ş—r
();

121 
boŞ
 
d©a_v®id©e_Úe
(
UccCŞlCtxVec
 
ùx
, 
UccT—m_h
 
‹am
)

123 
boŞ
 
	g»t
 = 
Œue
;

124 
	groÙ
 = 0;

125 
ucc_memÜy_ty³_t
 
	gmem_ty³
;

126 
ušt8_t
 *
	gr¡
;

128 
	gi
 = 0; i < 
	gùx
.
size
(); i++) {

129 ià(!
	gùx
[
i
]) {

133 
	groÙ
 = 
ùx
[
i
]->
¬gs
->
roÙ
;

134 
	gmem_ty³
 = 
ùx
[
i
]->
¬gs
->
¤c
.
šfo
.
mem_ty³
;

136 
	gr¡
 = (
ušt8_t
*è
ucc_m®loc
(
ùx
[
i
]->
rbuf_size
, "dsts buf");

137 
EXPECT_NE
(
r¡
, 
nuÎ±r
);

139 
UCC_CHECK
(
ucc_mc_memıy
(
r¡
, 
ùx
[
i
]->
¬gs
->
¤c
.
šfo
.
bufãr
,

140 
ùx
[
i
]->
rbuf_size
,

141 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

143 
	gj
 = 0; j < 
	gùx
[
roÙ
]->
	grbuf_size
; j++) {

144 ià((
	gušt8_t
è
	groÙ
 !ğ
r¡
[
j
]) {

145 
»t
 = 
çl£
;

150 
ucc_ä“
(
r¡
);

153  
	g»t
;

155 
boŞ
 
d©a_v®id©e
(
UccT—m_h
 
‹am
) {

156 autØ&
	gc
 : 
ùxs
) {

157 ià(
Œue
 !ğ
d©a_v®id©e_Úe
(
c
, 
‹am
)) {

158  
	gçl£
;

161  
	gŒue
;

165 
	$UCC_TEST_P
(
‹¡_aùive_£t
, 
sšgË
)

167 autØ
İs
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

168 cÚ¡ 
ucc_job_’v_t
 
’v
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

169 cÚ¡ 
n_´ocs
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

171 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

172 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

174 
	`d©a_š™
(
İs
, 
‹am
);

175 autØ&
c
 : 
ùxs
) {

176 
UccReq
 
	`»q
(
‹am
, 
c
);

177 
»q
.
	`¡¬t
();

178 
»q
.
	`wa™
();

180 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
‹am
));

181 
	`d©a_fši
(
‹am
);

182 
	}
}

184 
	$UCC_TEST_P
(
‹¡_aùive_£t
, 
muÉË
)

186 autØ
İs
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

187 cÚ¡ 
ucc_job_’v_t
 
’v
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

188 cÚ¡ 
n_´ocs
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

190 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

191 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

193 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

195 
	`d©a_š™
(
İs
, 
‹am
);

196 autØ&
c
 : 
ùxs
) {

197 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
c
));

199 
UccReq
::
	`¡¬Î
(
»qs
);

200 
UccReq
::
	`wa™®l
(
»qs
);

201 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
‹am
));

202 
	`d©a_fši
(
‹am
);

203 
	}
}

205 
ucc_job_’v_t
 
	gknomŸl_’v
 = {{"UCC_TL_UCP_TUNE", "bcast:@knomial:0-inf:inf"},

207 
ucc_job_’v_t
 
dbt_’v
;

209 
	gINSTANTIATE_TEST_CASE_P


211 , 
	g‹¡_aùive_£t
,

212 ::
‹¡šg
::
Combše


214 ::
‹¡šg
::
V®ues


216 
¡d
::
veùÜ
<
İ_t
>

219 
OP_T
(0, 0, 1, 16, 8, 
HOST
),

220 
OP_T
(0, 0, 2, 8, 6, 
HOST
),

221 
OP_T
(3, 3, 8, 2, 65530, 
HOST
),

222 
OP_T
(2, 1, 1, 2, 65531, 
HOST
),

223 
OP_T
(0, 0, 1, 2, 8, 
HOST
),

224 
OP_T
(3, 3, 4, 2, 1024, 
HOST
),

225 
OP_T
(7, 3, 4, 2, 1023, 
HOST
),

226 
OP_T
(3, 11, -8, 2, 65530, 
HOST
),

227 
OP_T
(11, 11, -8, 2, 65531, 
HOST
),

228 
OP_T
(5, 7, -2, 2, 123456, 
HOST
),

229 
OP_T
(7, 7, -2, 2, 123455, 
HOST
),

230 
OP_T
(0, 0, 1, 4, 1337, 
HOST
),

231 
OP_T
(2, 0, 2, 4, 64, 
HOST
),

232 
OP_T
(6, 0, 3, 3, 1335, 
HOST
),

233 
OP_T
(4, 7, -1, 6, 18, 
HOST
)

237 ::
‹¡šg
::
V®ues
(
knomŸl_’v
, 
dbt_’v
),

238 ::
‹¡šg
::
V®ues
(16)

	@test/gtest/asym_mem/test_asymmetric_memory.cc

6 
	~"commÚ/‹¡_ucc.h
"

8 #ifdeà
HAVE_CUDA


10 
usšg
 
	gP¬am
 = 
¡d
::
tu¶e
<
ucc_cŞl_ty³_t
, 
	gucc_memÜy_ty³_t
,

11 
	gucc_memÜy_ty³_t
, >;

13 
şass
 
	g‹¡_asymm‘ric_memÜy
 : 
public
 
ucc
::
‹¡
,

14 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am
>

16 
public
:

17 
UccCŞlCtxVec
 
ùxs
;

18 
d©a_š™
(
ucc_cŞl_ty³_t
 
cŞl_ty³
, 
ucc_memÜy_ty³_t
 
¤c_mem_ty³
,

19 
ucc_memÜy_ty³_t
 
d¡_mem_ty³
, 
UccT—m_h
 
‹am
, 
boŞ
 
³rsi¡’t
 = 
çl£
) {

20 
ucc_¿nk_t
 
tsize
 = 
‹am
->
´ocs
.
size
();

21 
	groÙ
 = 0;

22 
size_t
 
	gmsgËn
 = 2048;

23 
size_t
 
	g¤c_modif›r
 = 1;

24 
size_t
 
	gd¡_modif›r
 = 1;

25 
	gùxs
.
»size
(
tsize
);

27 ià(
	gcŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHER
) {

28 
d¡_modif›r
 = 
tsize
;

29 } ià(
	gcŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTER
) {

30 
¤c_modif›r
 = 
tsize
;

33 
	gi
 = 0; i < 
	gtsize
; i++) {

34 
	gùxs
[
i
] = (
g‹¡_ucc_cŞl_ùx_t
*)

35 
ÿÎoc
(1, (
g‹¡_ucc_cŞl_ùx_t
));

36 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = (ucc_coll_args_t*)

37 
ÿÎoc
(1, (
ucc_cŞl_¬gs_t
));

39 
	gùxs
[
i
]->
	g¬gs
 = 
cŞl
;

40 
	gcŞl
->
	gcŞl_ty³
 = 
cŞl_ty³
;

41 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
¤c_mem_ty³
;

42 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
msgËn
 * 
¤c_modif›r
;

43 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
UCC_DT_INT8
;

44 
	gcŞl
->
	groÙ
 = 
roÙ
;

45 ià(
	g³rsi¡’t
) {

46 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

47 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

50 ià(
	gi
 =ğ
roÙ
 || 
cŞl_ty³
 !ğ
UCC_COLL_TYPE_SCATTER
) {

51 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
i
]->
¤c_mc_h—d”
,

52 
msgËn
 * 
¤c_modif›r
, 
¤c_mem_ty³
));

53 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
i
]->
¤c_mc_h—d”
->
addr
;

55 
	gùxs
[
i
]->
	gš™_buf
 = 
ucc_m®loc
(
msgËn
 * 
¤c_modif›r
,

57 
EXPECT_NE
(
ùxs
[
i
]->
š™_buf
, 
nuÎ±r
);

58 
ušt8_t
 *
	gsbuf
 = (ušt8_t*)
ùxs
[
i
]->
š™_buf
;

59 
	gj
 = 0; j < 
msgËn
 * 
	g¤c_modif›r
; j++) {

60 
	gsbuf
[
j
] = (
ušt8_t
) 1;

62 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
,

63 
ùxs
[
i
]->
š™_buf
,

64 
msgËn
 * 
¤c_modif›r
, 
¤c_mem_ty³
,

65 
UCC_MEMORY_TYPE_HOST
));

68 
	gùxs
[
i
]->
	grbuf_size
 = 
msgËn
 * 
d¡_modif›r
;

69 ià(
	gi
 =ğ
roÙ
 || 
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTER
) {

70 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
i
]->
d¡_mc_h—d”
,

71 
ùxs
[
i
]->
rbuf_size
, 
d¡_mem_ty³
));

72 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
i
]->
d¡_mc_h—d”
->
addr
;

73 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
ùxs
[
i
]->
rbuf_size
;

74 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
UCC_DT_INT8
;

75 
	gcŞl
->
	gd¡
.
	gšfo
.
	gmem_ty³
 = 
d¡_mem_ty³
;

80 
d©a_fši
()

82 
	gi
 = 0; i < 
	gùxs
.
size
(); i++) {

83 
g‹¡_ucc_cŞl_ùx_t
 *
	gùx
 = 
ùxs
[
i
];

84 ià(!
	gùx
) {

87 
ucc_cŞl_¬gs_t
* 
	gcŞl
 = 
ùx
->
¬gs
;

88 ià(
	gi
 =ğ
cŞl
->
roÙ
 || cŞl->
cŞl_ty³
 !ğ
UCC_COLL_TYPE_SCATTER
) {

89 
ucc_ä“
(
ùx
->
š™_buf
);

90 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

92 ià(
	gi
 =ğ
cŞl
->
roÙ
 || cŞl->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTER
) {

93 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
d¡_mc_h—d”
));

95 
ä“
(
cŞl
);

96 
ä“
(
ùx
);

98 
	gùxs
.
ş—r
();

101 
boŞ
 
d©a_v®id©e
(
ušt8_t
 
d©a
 = 1)

103 
boŞ
 
»t
 = 
Œue
;

104 
	groÙ
 = 0;

105 
ušt8_t
 
	g»suÉ
 = 
d©a
;

106 
ucc_memÜy_ty³_t
 
	gd¡_mem_ty³
;

107 
ušt8_t
 *
	gr¡
;

109 ià(
	gùxs
[0]->
	g¬gs
->
	gcŞl_ty³
 =ğ
UCC_COLL_TYPE_REDUCE
) {

110 
»suÉ
 *ğ(
ušt8_t
è
ùxs
.
size
();

113 
	gi
 = 0; i < 
	gùxs
.
size
(); i++) {

114 ià(!
	gùxs
[
i
]) {

118 
	groÙ
 = 
ùxs
[
i
]->
¬gs
->
roÙ
;

120 ià(
	gi
 =ğ
roÙ
 || 
ùxs
[
i
]->
¬gs
->
cŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTER
) {

121 
d¡_mem_ty³
 = 
ùxs
[
i
]->
¬gs
->
d¡
.
šfo
.
mem_ty³
;

123 
	gr¡
 = (
ušt8_t
*è
ucc_m®loc
(
ùxs
[
i
]->
rbuf_size
, "validation buf");

124 
EXPECT_NE
(
r¡
, 
nuÎ±r
);

126 
UCC_CHECK
(
ucc_mc_memıy
(
r¡
, 
ùxs
[
i
]->
¬gs
->
d¡
.
šfo
.
bufãr
,

127 
ùxs
[
i
]->
rbuf_size
,

128 
UCC_MEMORY_TYPE_HOST
, 
d¡_mem_ty³
));

130 
	gj
 = 0; j < 
	gùxs
[
i
]->
	grbuf_size
; j++) {

131 ià(
	g»suÉ
 !ğ
r¡
[
j
]) {

132 
»t
 = 
çl£
;

137 
ucc_ä“
(
r¡
);

141  
	g»t
;

144 
d©a_upd©e
(
ušt8_t
 
d©a
) {

145 
ucc_¿nk_t
 
	gtsize
 = 
ùxs
.
size
();

146 
size_t
 
	gmsgËn
 = 2048;

147 
size_t
 
	g¤c_modif›r
 = 1;

148 
ucc_cŞl_ty³_t
 
	gcŞl_ty³
 = 
ùxs
[0]->
¬gs
->
cŞl_ty³
;

149 
	groÙ
 = 
ùxs
[0]->
¬gs
->
roÙ
;

150 
ucc_memÜy_ty³_t
 
	g¤c_mem_ty³
 = 
ùxs
[0]->
¬gs
->
¤c
.
šfo
.
mem_ty³
;

152 ià(
	gcŞl_ty³
 =ğ
UCC_COLL_TYPE_SCATTER
) {

153 
¤c_modif›r
 = 
tsize
;

156 
	gi
 = 0; i < 
	gtsize
; i++) {

157 ià(
	gi
 =ğ
roÙ
 || 
cŞl_ty³
 !ğ
UCC_COLL_TYPE_SCATTER
) {

158 
ucc_cŞl_¬gs_t
 *
cŞl
 = 
ùxs
[
i
]->
¬gs
;

159 
ušt8_t
 *
	gsbuf
 = (ušt8_t*)
ùxs
[
i
]->
š™_buf
;

160 
	gj
 = 0; j < 
msgËn
 * 
	g¤c_modif›r
; j++) {

161 
	gsbuf
[
j
] = (
ušt8_t
è
d©a
;

163 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
,

164 
ùxs
[
i
]->
š™_buf
,

165 
msgËn
 * 
¤c_modif›r
, 
¤c_mem_ty³
,

166 
UCC_MEMORY_TYPE_HOST
));

173 
şass
 
	g‹¡_asymm‘ric_memÜy_v
 : 
public
 
ucc
::
‹¡
,

174 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am
>

176 
public
:

177 
UccCŞlCtxVec
 
ùxs
;

178 
d©a_š™
(
ucc_cŞl_ty³_t
 
cŞl_ty³
, 
ucc_memÜy_ty³_t
 
¤c_mem_ty³
,

179 
ucc_memÜy_ty³_t
 
d¡_mem_ty³
, 
UccT—m_h
 
‹am
) {

180 
	gÅrocs
 = 
‹am
->
n_´ocs
;

181 
size_t
 
	gcouÁ
 = 2048;

182 
ucc_¿nk_t
 
	groÙ
 = 0;

183 
ucc_cŞl_¬gs_t
 *
	gcŞl
;

184 *
	gcouÁs
, *
	gdi¥ls
;

185 
size_t
 
	gmy_couÁ
, 
	g®l_couÁs
;

187 
	gùxs
.
»size
(
Årocs
);

188 autØ
	gr
 = 0;„ < 
	gÅrocs
;„++) {

189 
	gcŞl
 = (
ucc_cŞl_¬gs_t
 *)
ÿÎoc
(1, (ucc_coll_args_t));

190 
	gmy_couÁ
 = (
Årocs
 - 
r
è* 
couÁ
;

191 
	gùxs
[
r
] =

192 (
g‹¡_ucc_cŞl_ùx_t
 *)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

193 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

194 
	gcŞl
->
	gmask
 = 0;

195 
	gcŞl
->
	gæags
 = 0;

196 
	gcŞl
->
	gcŞl_ty³
 = 
cŞl_ty³
;

197 
	gcŞl
->
	groÙ
 = 
roÙ
;

198 ià(
	gcŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHERV
) {

199 
cŞl
->
¤c
.
šfo
.
mem_ty³
 = 
¤c_mem_ty³
;

200 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
my_couÁ
;

201 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
UCC_DT_INT8
;

203 
	gùxs
[
r
]->
	gš™_buf
 =

204 
ucc_m®loc
(
ucc_dt_size
(
UCC_DT_INT8
è* 
my_couÁ
, "init buf");

205 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

206 
	gi
 = 0; i < 
my_couÁ
 * 
ucc_dt_size
(
UCC_DT_INT8
); i++) {

207 
ušt8_t
 *
	gsbuf
 = (ušt8_ˆ*)
ùxs
[
r
]->
š™_buf
;

208 
	gsbuf
[
i
] = ((˜+ 
r
) % 256);

211 ià(
	gr
 =ğ
roÙ
) {

212 
®l_couÁs
 = 0;

213 
	gcouÁs
 = (*)
m®loc
((è* 
Årocs
);

214 
EXPECT_NE
(
couÁs
, 
nuÎ±r
);

215 
	gdi¥ls
 = (*)
m®loc
((è* 
Årocs
);

216 
EXPECT_NE
(
di¥ls
, 
nuÎ±r
);

218 
	gi
 = 0; i < 
	gÅrocs
; i++) {

219 
	gcouÁs
[
i
] = (
Årocs
 - iè* 
couÁ
;

220 
	gdi¥ls
[
i
] = 
®l_couÁs
;

221 
	g®l_couÁs
 +ğ
couÁs
[
i
];

224 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gmem_ty³
 = 
d¡_mem_ty³
;

225 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
 *)
couÁs
;

226 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
 *)
di¥ls
;

227 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gd©©y³
 = 
UCC_DT_INT8
;

229 
	gùxs
[
r
]->
	grbuf_size
 = 
ucc_dt_size
(
UCC_DT_INT8
è* 
®l_couÁs
;

230 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

231 
ùxs
[
r
]->
rbuf_size
, 
d¡_mem_ty³
));

232 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

235 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

236 
ucc_dt_size
(
UCC_DT_INT8
è* 
my_couÁ
,

237 
¤c_mem_ty³
));

238 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

239 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
,

240 
ùxs
[
r
]->
š™_buf
,

241 
ucc_dt_size
(
UCC_DT_INT8
è* 
my_couÁ
,

242 
¤c_mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

245 
	gcŞl
->
	gd¡
.
	gšfo
.
	gmem_ty³
 = 
d¡_mem_ty³
;

246 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
my_couÁ
;

247 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
UCC_DT_INT8
;

249 ià(
	gr
 =ğ
roÙ
) {

250 
®l_couÁs
 = 0;

251 
	gcouÁs
 = (*)
m®loc
((è* 
Årocs
);

252 
EXPECT_NE
(
couÁs
, 
nuÎ±r
);

253 
	gdi¥ls
 = (*)
m®loc
((è* 
Årocs
);

254 
EXPECT_NE
(
di¥ls
, 
nuÎ±r
);

256 
	gi
 = 0; i < 
	gÅrocs
; i++) {

257 
	gcouÁs
[
i
] = (
Årocs
 - iè* 
couÁ
;

258 
	gdi¥ls
[
i
] = 
®l_couÁs
;

259 
	g®l_couÁs
 +ğ
couÁs
[
i
];

262 
	gùxs
[
r
]->
	gš™_buf
 =

263 
ucc_m®loc
(
ucc_dt_size
(
UCC_DT_INT8
è* 
®l_couÁs
, "init buf");

264 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

265 
ušt8_t
 *
	gsbuf
 = (ušt8_t*)
ùxs
[
r
]->
š™_buf
;

266 
	gp
 = 0;… < 
	gÅrocs
;…++) {

267 
	gi
 = 0; i < 
ucc_dt_size
(
UCC_DT_INT8
è* 
	gcouÁs
[
p
]; i++) {

268 
	gsbuf
[(
di¥ls
[
p
] * 
ucc_dt_size
(
UCC_DT_INT8
è+ 
	gi
)] =

269 (
ušt8_t
)((
i
 + 
p
) % 256);

273 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gmem_ty³
 = 
¤c_mem_ty³
;

274 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
 *)
couÁs
;

275 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
 *)
di¥ls
;

276 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gd©©y³
 = 
UCC_DT_INT8
;

278 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

279 
ucc_dt_size
(
UCC_DT_INT8
è* 
®l_couÁs
,

280 
¤c_mem_ty³
));

281 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

282 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo_v
.
bufãr
,

283 
ùxs
[
r
]->
š™_buf
, 
ucc_dt_size
(
UCC_DT_INT8
è* 
®l_couÁs
,

284 
¤c_mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

286 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

287 
ucc_dt_size
(
UCC_DT_INT8
è* 
my_couÁ
,

288 
d¡_mem_ty³
));

289 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

294 
boŞ
 
d©a_v®id©e
()

296 
boŞ
 
	g»t
 = 
Œue
;

297 
	groÙ
 = 
ùxs
[0]->
¬gs
->
roÙ
;

298 *
	gdi¥ls
 = (*)
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
;

299 
size_t
 
	gdt_size
;

300 
ucc_memÜy_ty³_t
 
	gd¡_mem_ty³
;

301 
ucc_couÁ_t
 
	gmy_couÁ
;

302 
ušt8_t
 *
	gd¡s
;

304 ià(
	gùxs
[
roÙ
]->
	g¬gs
->
	gcŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHERV
) {

305 
dt_size
 = 
ucc_dt_size
(
ùxs
[
roÙ
]->
¬gs
->
¤c
.
šfo
.
d©©y³
);

306 
	gd¡_mem_ty³
 = 
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo_v
.
mem_ty³
;

307 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
d¡_mem_ty³
) {

308 
d¡s
 = (
ušt8_t
 *)
ucc_m®loc
(
ùxs
[
roÙ
]->
rbuf_size
, "dsts buf");

309 
ucc_as£¹
(
d¡s
 !ğ
nuÎ±r
);

310 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
, 
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo_v
.
bufãr
,

311 
ùxs
[
roÙ
]->
rbuf_size
,

312 
UCC_MEMORY_TYPE_HOST
, 
d¡_mem_ty³
));

314 
	gd¡s
 = (
ušt8_t
 *)
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo_v
.
bufãr
;

317 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

318 
	gmy_couÁ
 = 
ùxs
[
r
]->
¬gs
->
¤c
.
šfo
.
couÁ
;

319 
	gi
 = 0; i < 
my_couÁ
 * 
	gdt_size
; i++) {

320 ià((
	gušt8_t
)((
	gi
 + 
	gr
) % 256) !=

321 
d¡s
[(
di¥ls
[
r
] * 
dt_size
 + 
i
)]) {

322 
»t
 = 
çl£
;

328 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
d¡_mem_ty³
) {

329 
ucc_ä“
(
d¡s
);

333 
	gd¡_mem_ty³
 = 
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo
.
mem_ty³
;

334 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

335 
	gdt_size
 = 
ucc_dt_size
((
ùxs
[
r
])->
¬gs
->
d¡
.
šfo
.
d©©y³
);

336 
	gmy_couÁ
 = (
ùxs
[
r
])->
¬gs
->
d¡
.
šfo
.
couÁ
;

337 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
d¡_mem_ty³
) {

338 
d¡s
 = (
ušt8_t
 *)
ucc_m®loc
(
my_couÁ
 * 
dt_size
, "dsts buf");

339 
ucc_as£¹
(
d¡s
 !ğ
nuÎ±r
);

340 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
, 
ùxs
[
r
]->
¬gs
->
d¡
.
šfo
.
bufãr
,

341 
my_couÁ
 * 
dt_size
,

342 
UCC_MEMORY_TYPE_HOST
, 
d¡_mem_ty³
));

344 
	gd¡s
 = (
ušt8_t
 *)
ùxs
[
r
]->
¬gs
->
d¡
.
šfo
.
bufãr
;

347 
	gi
 = 0; i < 
my_couÁ
 * 
	gdt_size
; i++) {

348 ià((
	gušt8_t
)((
	gi
 + 
	gr
) % 256) !=

349 
d¡s
[
i
]) {

350 
»t
 = 
çl£
;

355 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
d¡_mem_ty³
) {

356 
ucc_ä“
(
d¡s
);

357 ià(!
	g»t
) {

364  
	g»t
;

367 
d©a_fši
()

369 
	groÙ
 = 
ùxs
[0]->
¬gs
->
roÙ
;

370 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

371 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

372 ià(
	gcŞl
->
	gcŞl_ty³
 =ğ
UCC_COLL_TYPE_GATHERV
) {

373 ià(
r
 =ğ
roÙ
) {

374 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
d¡_mc_h—d”
));

375 
ä“
(
cŞl
->
d¡
.
šfo_v
.
couÁs
);

376 
ä“
(
cŞl
->
d¡
.
šfo_v
.
di¥Ïûm’ts
);

378 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
¤c_mc_h—d”
));

381 ià(
	gr
 =ğ
roÙ
) {

382 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
¤c_mc_h—d”
));

383 
ä“
(
cŞl
->
¤c
.
šfo_v
.
couÁs
);

384 
ä“
(
cŞl
->
¤c
.
šfo_v
.
di¥Ïûm’ts
);

386 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
d¡_mc_h—d”
));

388 
ucc_ä“
(
ùxs
[
r
]->
š™_buf
);

389 
ä“
(
cŞl
);

390 
ä“
(
ùxs
[
r
]);

392 
	gùxs
.
ş—r
();

396 
	#TEST_ASYM_DECLARE
 \

397 cÚ¡ 
ucc_cŞl_ty³_t
 
cŞl_ty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
()); \

398 cÚ¡ 
ucc_memÜy_ty³_t
 
¤c_mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
()); \

399 cÚ¡ 
ucc_memÜy_ty³_t
 
d¡_mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
()); \

400 cÚ¡ 
n_´ocs
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
()); \

402 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
); \

403 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
); \

405 
	`d©a_š™
(
cŞl_ty³
, 
¤c_mem_ty³
, 
d¡_mem_ty³
, 
‹am
); \

406 
UccReq
 
	`»q
(
‹am
, 
ùxs
); \

407 ià(
»q
.
¡©us
 !ğ
UCC_OK
) { \

408 
	`d©a_fši
(); \

409 
	`GTEST_SKIP
() << "ucc_collective_init„eturned " \

410 << 
	`ucc_¡©us_¡ršg
(
»q
.
¡©us
); \

412 
»q
.
	`¡¬t
(); \

413 
»q
.
	`wa™
(); \

414 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
()); \

415 
	`d©a_fši
();

	)

417 
	$UCC_TEST_P
(
‹¡_asymm‘ric_memÜy
, 
sšgË
)

419 
TEST_ASYM_DECLARE


420 
	}
}

422 
	$UCC_TEST_P
(
‹¡_asymm‘ric_memÜy
, 
³rsi¡’t
)

424 cÚ¡ 
ucc_cŞl_ty³_t
 
cŞl_ty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

425 cÚ¡ 
ucc_memÜy_ty³_t
 
¤c_mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

426 cÚ¡ 
ucc_memÜy_ty³_t
 
d¡_mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

427 cÚ¡ 
n_´ocs
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

428 
times
 = 3;

430 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
);

431 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

433 
	`d©a_š™
(
cŞl_ty³
, 
¤c_mem_ty³
, 
d¡_mem_ty³
, 
‹am
, 
Œue
);

434 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

435 ià(
»q
.
¡©us
 !ğ
UCC_OK
) {

436 
	`d©a_fši
();

437 
	`GTEST_SKIP
() << "ucc_collective_init„eturned "

438 << 
	`ucc_¡©us_¡ršg
(
»q
.
¡©us
);

440 ; 
times
 > 0;imes--) {

441 
	`d©a_upd©e
(
times
);

442 
»q
.
	`¡¬t
();

443 
»q
.
	`wa™
();

444 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
times
));

446 
	`d©a_fši
();

447 
	}
}

449 
	gINSTANTIATE_TEST_CASE_P


451 , 
	g‹¡_asymm‘ric_memÜy
,

452 ::
‹¡šg
::
Combše


454 ::
‹¡šg
::
V®ues
(
UCC_COLL_TYPE_REDUCE
, 
UCC_COLL_TYPE_GATHER
, 
UCC_COLL_TYPE_SCATTER
),

455 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
),

456 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
),

457 ::
‹¡šg
::
V®ues
(8)

461 
	$UCC_TEST_P
(
‹¡_asymm‘ric_memÜy_v
, 
sšgË_v
)

463 
TEST_ASYM_DECLARE


464 
	}
}

466 
	gINSTANTIATE_TEST_CASE_P


468 , 
	g‹¡_asymm‘ric_memÜy_v
,

469 ::
‹¡šg
::
Combše


471 ::
‹¡šg
::
V®ues
(
UCC_COLL_TYPE_GATHERV
, 
UCC_COLL_TYPE_SCATTERV
),

472 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
),

473 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
),

474 ::
‹¡šg
::
V®ues
(8)

	@test/gtest/coll/test_allgather.cc

7 
	~"commÚ/‹¡_ucc.h
"

8 
	~"uts/ucc_m©h.h
"

10 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<, 
	gucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , 
	gg‹¡_ucc_š¶aû_t
>;

11 
usšg
 
	gP¬am_1
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , 
	gg‹¡_ucc_š¶aû_t
>;

12 
usšg
 
	gP¬am_2
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , 
	gg‹¡_ucc_š¶aû_t
, 
	g¡d
::
¡ršg
>;

14 
şass
 
	g‹¡_®lg©h”
 : 
public
 
UccCŞlArgs
,…ubliø
	gucc
::
‹¡


16 
public
:

17 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
, 
size_t
 
sšgË_¿nk_couÁ
,

18 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

20 
	gùxs
.
»size
(
Årocs
);

21 autØ
	gr
 = 0;„ < 
	gÅrocs
;„++) {

22 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = (ucc_coll_args_t*)

23 
ÿÎoc
(1, (
ucc_cŞl_¬gs_t
));

24 
	gùxs
[
r
] = (
g‹¡_ucc_cŞl_ùx_t
*)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

25 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

27 
	gcŞl
->
	gmask
 = 0;

28 
	gcŞl
->
	gæags
 = 0;

29 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_ALLGATHER
;

30 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

31 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
sšgË_¿nk_couÁ
;

32 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dty³
;

33 
	gcŞl
->
	gd¡
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

34 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
sšgË_¿nk_couÁ
 * 
Årocs
;

35 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
dty³
;

37 
	gùxs
[
r
]->
	gš™_buf
 =

38 
ucc_m®loc
(
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
, "init buf");

39 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

40 
ušt8_t
 *
	gsbuf
 = (ušt8_ˆ*)
ùxs
[
r
]->
š™_buf
;

41 
	gi
 = 0; i < 
ucc_dt_size
(
dty³
è* 
	gsšgË_¿nk_couÁ
; i++) {

42 
	gsbuf
[
i
] = 
r
;

45 
	gùxs
[
r
]->
	grbuf_size
 = 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
 * 
Årocs
;

46 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
, ctxs[r]->
rbuf_size
,

47 
mem_ty³
));

48 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

49 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

50 
cŞl
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

51 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

52 
UCC_CHECK
(
ucc_mc_memıy
(

53 (*)((
±rdiff_t
)
cŞl
->
d¡
.
šfo
.
bufãr
 +

54 
r
 * 
sšgË_¿nk_couÁ
 * 
ucc_dt_size
(
dty³
)),

55 
ùxs
[
r
]->
š™_buf
, 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
,

56 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

58 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

59 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
,

60 
mem_ty³
));

61 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

62 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

63 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
,

64 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

66 ià(
	g³rsi¡’t
) {

67 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

68 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

72 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

74 
g‹¡_ucc_cŞl_ùx_t
* 
	gùx
 : 
ùxs
) {

75 
ucc_cŞl_¬gs_t
* 
cŞl
 = 
ùx
->
¬gs
;

76 ià(
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
) {

77 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

79 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
d¡_mc_h—d”
));

80 
ucc_ä“
(
ùx
->
š™_buf
);

81 
ä“
(
cŞl
);

82 
ä“
(
ùx
);

84 
	gùxs
.
ş—r
();

86 
»£t
(
UccCŞlCtxVec
 
ùxs
)

88 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

89 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

90 
size_t
 
	gsšgË_¿nk_couÁ
 = 
cŞl
->
d¡
.
šfo
.
couÁ
 / 
ùxs
.
size
();

91 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
d¡
.
šfo
.
d©©y³
;

92 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo
.
bufãr
,

93 
sšgË_¿nk_couÁ
 * 
ucc_dt_size
(
dty³
è* 
ùxs
.
size
(),

94 
mem_ty³
, 0);

95 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

96 
UCC_CHECK
(
ucc_mc_memıy
(

97 (*)((
±rdiff_t
)
cŞl
->
d¡
.
šfo
.
bufãr
 +

98 
r
 * 
sšgË_¿nk_couÁ
 * 
ucc_dt_size
(
dty³
)),

99 
ùxs
[
r
]->
š™_buf
, 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
,

100 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

104 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

106 
boŞ
 
	g»t
 = 
Œue
;

107 
	g¡d
::
veùÜ
<
ušt8_t
 *> 
d¡s
(
ùxs
.
size
());

108 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

109 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

110 
	gd¡s
[
r
] = (
ušt8_t
 *è
ucc_m®loc
(
ùxs
[r]->
rbuf_size
, "dsts buf");

111 
EXPECT_NE
(
d¡s
[
r
], 
nuÎ±r
);

112 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
[
r
], 
ùxs
[r]->
¬gs
->
d¡
.
šfo
.
bufãr
,

113 
ùxs
[
r
]->
rbuf_size
, 
UCC_MEMORY_TYPE_HOST
,

114 
mem_ty³
));

117 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

118 
	gd¡s
[
r
] = (
ušt8_t
 *)(
ùxs
[r]->
¬gs
->
d¡
.
šfo
.
bufãr
);

121 
	gi
 = 0; i < 
	gùxs
.
size
(); i++) {

122 
ušt8_t
 *
	grbuf
 = 
d¡s
[
i
];

123 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

124 
size_t
 
	g¿nk_size
 = 
ucc_dt_size
((
ùxs
[
r
])->
¬gs
->
¤c
.
šfo
.
d©©y³
) *

125 (
ùxs
[
r
])->
¬gs
->
¤c
.
šfo
.
couÁ
;

126 
	gj
 = 0; j < 
	g¿nk_size
; j++) {

127 ià(
	gr
 !ğ
rbuf
[
r
*
¿nk_size
 + 
j
]) {

128 
»t
 = 
çl£
;

134 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

135 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

136 
ucc_ä“
(
d¡s
[
r
]);

139  
	g»t
;

143 
şass
 
	g‹¡_®lg©h”_0
 : 
public
 
‹¡_®lg©h”
,

144 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {};

146 
	$UCC_TEST_P
(
‹¡_®lg©h”_0
, 
sšgË
)

148 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

149 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

150 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

151 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

152 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

153 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

154 
size
 = 
‹am
->
´ocs
.
	`size
();

155 
UccCŞlCtxVec
 
ùxs
;

157 
	`£t_š¶aû
(
š¶aû
);

158 
	`SET_MEM_TYPE
(
mem_ty³
);

160 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

161 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

162 
»q
.
	`¡¬t
();

163 
»q
.
	`wa™
();

164 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

165 
	`d©a_fši
(
ùxs
);

166 
	}
}

168 
	$UCC_TEST_P
(
‹¡_®lg©h”_0
, 
sšgË_³rsi¡’t
)

170 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

171 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

172 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

173 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

174 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

175 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

176 
size
 = 
‹am
->
´ocs
.
	`size
();

177 cÚ¡ 
n_ÿÎs
 = 3;

178 
UccCŞlCtxVec
 
ùxs
;

180 
	`£t_š¶aû
(
š¶aû
);

181 
	`SET_MEM_TYPE
(
mem_ty³
);

183 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
Œue
);

184 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

186 autØ
i
 = 0; i < 
n_ÿÎs
; i++) {

187 
»q
.
	`¡¬t
();

188 
»q
.
	`wa™
();

189 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

190 
	`»£t
(
ùxs
);

193 
	`d©a_fši
(
ùxs
);

194 
	}
}

196 
INSTANTIATE_TEST_CASE_P
(

197 , 
‹¡_®lg©h”_0
,

198 ::
‹¡šg
::
Combše
(

199 ::
‹¡šg
::
Rªge
(1, 
UccJob
::
nSticT—ms
),

200 
PREDEFINED_DTYPES
,

201 #ifdeà
HAVE_CUDA


202 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

203 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

205 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

207 ::
‹¡šg
::
V®ues
(1,3,8192),

208 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

211 
şass
 
	g‹¡_®lg©h”_1
 : 
public
 
‹¡_®lg©h”
,

212 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {};

214 
	$UCC_TEST_P
(
‹¡_®lg©h”_1
, 
muÉË_ho¡
)

216 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

217 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

218 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

219 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

220 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

221 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

223 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

224 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

225 
size
 = 
‹am
->
´ocs
.
	`size
();

226 
UccCŞlCtxVec
 
ùx
;

228 
this
->
	`£t_š¶aû
(
š¶aû
);

229 
	`SET_MEM_TYPE
(
mem_ty³
);

231 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùx
, 
çl£
);

232 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

233 
ùxs
.
	`push_back
(
ùx
);

235 
UccReq
::
	`¡¬Î
(
»qs
);

236 
UccReq
::
	`wa™®l
(
»qs
);

238 autØ
ùx
 : 
ùxs
) {

239 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

240 
	`d©a_fši
(
ùx
);

242 
	}
}

244 
INSTANTIATE_TEST_CASE_P
(

245 , 
‹¡_®lg©h”_1
,

246 ::
‹¡šg
::
Combše
(

247 
PREDEFINED_DTYPES
,

248 #ifdeà
HAVE_CUDA


249 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

250 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

252 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

254 ::
‹¡šg
::
V®ues
(1,3,8192),

255 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

257 
şass
 
	g‹¡_®lg©h”_®g
 : 
public
 
‹¡_®lg©h”
,

258 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_2
> {};

260 
	$UCC_TEST_P
(
‹¡_®lg©h”_®g
, 
®g
)

262 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

263 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

264 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

265 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

266 
n_´ocs
 = 5;

267 
tuÃ
[32];

269 
	`¥rštf
(
tuÃ
, "®lg©h”:@%s:šf", 
¡d
::
g‘
<4>(
	`G‘P¬am
()).
	`c_¡r
());

270 
ucc_job_’v_t
 
’v
 = {{"UCC_CL_BASIC_TUNE", "inf"},

271 {"UCC_TL_UCP_TUNE", 
tuÃ
},

273 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

274 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

275 
UccCŞlCtxVec
 
ùxs
;

277 
	`£t_š¶aû
(
š¶aû
);

278 
	`SET_MEM_TYPE
(
mem_ty³
);

280 
	`d©a_š™
(
n_´ocs
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

281 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

282 
»q
.
	`¡¬t
();

283 
»q
.
	`wa™
();

284 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

285 
	`d©a_fši
(
ùxs
);

286 
	}
}

288 
INSTANTIATE_TEST_CASE_P
(

289 , 
‹¡_®lg©h”_®g
,

290 ::
‹¡šg
::
Combše
(

291 
PREDEFINED_DTYPES
,

292 #ifdeà
HAVE_CUDA


293 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

294 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

296 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

298 ::
‹¡šg
::
V®ues
(1,3,8192),

299 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
),

300 ::
‹¡šg
::
V®ues
("knomial", "ring", "neighbor", "bruck", "sparbit", "linear", "batched")),

301 [](cÚ¡ 
‹¡šg
::
Te¡P¬amInfo
<
‹¡_®lg©h”_®g
::
P¬amTy³
>& 
šfo
) {

302 
¡d
::
¡ršg
 
Çme
;

303 
Çme
 +ğ
ucc_d©©y³_¡r
(
¡d
::
g‘
<0>(
šfo
.
·¿m
));

304 
Çme
 +ğ
¡d
::
¡ršg
("_"è+ std::¡ršg(
ucc_mem_ty³_¡r
(¡d::
g‘
<1>(
šfo
.
·¿m
)));

305 
Çme
 +ğ
¡d
::
¡ršg
("_couÁ_")+¡d::
to_¡ršg
(¡d::
g‘
<2>(
šfo
.
·¿m
));

306 
Çme
 +ğ
¡d
::
¡ršg
("_š¶aû_")+¡d::
to_¡ršg
(¡d::
g‘
<3>(
šfo
.
·¿m
));

307 
Çme
 +ğ
¡d
::
¡ršg
("_")+¡d::
g‘
<4>(
šfo
.
·¿m
);

308  
Çme
;

	@test/gtest/coll/test_allgatherv.cc

7 
	~"commÚ/‹¡_ucc.h
"

8 
	~"uts/ucc_m©h.h
"

10 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<, 
	gucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , 
	gg‹¡_ucc_š¶aû_t
, 
	gboŞ
>;

11 
usšg
 
	gP¬am_1
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , 
	gg‹¡_ucc_š¶aû_t
, 
	gboŞ
>;

12 
usšg
 
	gP¬am_2
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , 
	gg‹¡_ucc_š¶aû_t
, 
	g¡d
::
¡ršg
, 
	gboŞ
>;

14 
size_t
 
	gnÚcÚtig_·ddšg
 = 1;

16 
şass
 
	g‹¡_®lg©h”v
 : 
public
 
UccCŞlArgs
,…ubliø
	gucc
::
‹¡


18 
public
:

19 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
, 
size_t
 
couÁ
,

20 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
) {

21 
	gùxs
.
»size
(
Årocs
);

22 autØ
	gr
 = 0;„ < 
	gÅrocs
;„++) {

23 *
	gcouÁs
;

24 *
	gdi¥ls
;

25 
size_t
 
	gmy_couÁ
 = (
Årocs
 - 
r
è* 
couÁ
;

26 
size_t
 
	gdi¥_couÁ”
 = 0;

27 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = (ucc_cŞl_¬gs_t*)
ÿÎoc
(1, (ucc_coll_args_t));

29 
	gùxs
[
r
] = (
g‹¡_ucc_cŞl_ùx_t
*)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

30 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

32 
	gcouÁs
 = (*)
m®loc
((è* 
Årocs
);

33 
	gdi¥ls
 = (*)
m®loc
((è* 
Årocs
);

35 ià(
	gis_cÚtig
) {

36 
	gi
 = 0; i < 
	gÅrocs
; i++) {

37 
	gcouÁs
[
i
] = (
Årocs
 - iè* 
couÁ
;

38 
	gdi¥ls
[
i
] = 
di¥_couÁ”
;

39 
	gdi¥_couÁ”
 +ğ
couÁs
[
i
];

41 
	gcŞl
->
	gæags
 = 
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
;

43 
	gi
 = 0; i < 
	gÅrocs
; i++) {

44 
	gcouÁs
[
i
] = (
Årocs
 - iè* 
couÁ
;

45 
	gdi¥ls
[
i
] = 
di¥_couÁ”
;

46 
	gdi¥_couÁ”
 +ğ
couÁs
[
i
] + 
nÚcÚtig_·ddšg
;

49 
	gcŞl
->
	gmask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

50 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_ALLGATHERV
;

52 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

53 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = 
my_couÁ
;

54 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dty³
;

56 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gmem_ty³
 = 
mem_ty³
;

57 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
*)
couÁs
;

58 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
*)
di¥ls
;

59 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gd©©y³
 = 
dty³
;

61 
	gùxs
[
r
]->
	gš™_buf
 = 
ucc_m®loc
(
ucc_dt_size
(
dty³
è* 
my_couÁ
, "init buf");

62 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

63 
	gi
 = 0; i < (
ucc_dt_size
(
dty³
è* 
	gmy_couÁ
); i++) {

64 
ušt8_t
 *
	gsbuf
 = (ušt8_t*)
ùxs
[
r
]->
š™_buf
;

65 
	gsbuf
[
i
] = 
r
;

68 
	gùxs
[
r
]->
	grbuf_size
 = 
ucc_dt_size
(
dty³
è* 
di¥_couÁ”
;

69 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
, ctxs[r]->
rbuf_size
,

70 
mem_ty³
));

71 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

72 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

73 
cŞl
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

74 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

75 
UCC_CHECK
(
ucc_mc_memıy
((*)((
±rdiff_t
)
cŞl
->
d¡
.
šfo_v
.
bufãr
 +

76 
di¥ls
[
r
] * 
ucc_dt_size
(
dty³
)),

77 
ùxs
[
r
]->
š™_buf
, 
ucc_dt_size
(
dty³
è* 
my_couÁ
,

78 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

80 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

81 
ucc_dt_size
(
dty³
è* 
my_couÁ
,

82 
mem_ty³
));

83 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

84 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

85 
ucc_dt_size
(
dty³
è* 
my_couÁ
, 
mem_ty³
,

86 
UCC_MEMORY_TYPE_HOST
));

88 ià(
	g³rsi¡’t
) {

89 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

90 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

94 
»£t
(
UccCŞlCtxVec
 
ùxs
)

96 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

97 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

98 
size_t
 
	gmy_couÁ
 = 
cŞl
->
¤c
.
šfo
.
couÁ
;

99 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
d¡
.
šfo_v
.
d©©y³
;

100 * 
	gdi¥ls
 = (*)
cŞl
->
d¡
.
šfo_v
.
di¥Ïûm’ts
;

102 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo_v
.
bufãr
, 
ùxs
[
r
]->
rbuf_size
, 
mem_ty³
,

104 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

105 
UCC_CHECK
(
ucc_mc_memıy
(

106 (*)((
±rdiff_t
)
cŞl
->
d¡
.
šfo_v
.
bufãr
 +

107 
di¥ls
[
r
] * 
ucc_dt_size
(
dty³
)),

108 
ùxs
[
r
]->
š™_buf
, 
ucc_dt_size
(
dty³
è* 
my_couÁ
, 
mem_ty³
,

109 
UCC_MEMORY_TYPE_HOST
));

113 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

115 
g‹¡_ucc_cŞl_ùx_t
* 
	gùx
 : 
ùxs
) {

116 
ucc_cŞl_¬gs_t
* 
cŞl
 = 
ùx
->
¬gs
;

117 ià(
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
) {

118 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

120 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
d¡_mc_h—d”
));

121 
ä“
(
cŞl
->
d¡
.
šfo_v
.
di¥Ïûm’ts
);

122 
ä“
(
cŞl
->
d¡
.
šfo_v
.
couÁs
);

123 
ucc_ä“
(
ùx
->
š™_buf
);

124 
ä“
(
cŞl
);

125 
ä“
(
ùx
);

127 
	gùxs
.
ş—r
();

129 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

131 
boŞ
 
	g»t
 = 
Œue
;

132 
	g¡d
::
veùÜ
<
ušt8_t
 *> 
d¡s
(
ùxs
.
size
());

134 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

135 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

136 
	gd¡s
[
r
] = (
ušt8_t
 *è
ucc_m®loc
(
ùxs
[r]->
rbuf_size
, "ctxs buf");

137 
EXPECT_NE
(
d¡s
[
r
], 
nuÎ±r
);

138 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
[
r
], 
ùxs
[r]->
¬gs
->
d¡
.
šfo_v
.
bufãr
,

139 
ùxs
[
r
]->
rbuf_size
, 
UCC_MEMORY_TYPE_HOST
,

140 
mem_ty³
));

143 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

144 
	gd¡s
[
r
] = (
ušt8_t
 *)(
ùxs
[r]->
¬gs
->
d¡
.
šfo_v
.
bufãr
);

148 
	gi
 = 0; i < 
	gùxs
.
size
(); i++) {

149 
size_t
 
	g¿nk_size
 = 0;

150 
ušt8_t
 *
	grbuf
 = 
d¡s
[
i
];

151 
	gis_cÚtig
 = 
UCC_COLL_IS_DST_CONTIG
(
ùxs
[
i
]->
¬gs
);

152 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

153 
	grbuf
 +ğ
¿nk_size
;

154 
	g¿nk_size
 = 
ucc_dt_size
((
ùxs
[
r
])->
¬gs
->
¤c
.
šfo
.
d©©y³
) *

155 (
ùxs
[
r
])->
¬gs
->
¤c
.
šfo
.
couÁ
;

156 
	gj
 = 0; j < 
	g¿nk_size
; j++) {

157 ià(
	gr
 !ğ
rbuf
[
j
]) {

158 
»t
 = 
çl£
;

162 ià(!
	gis_cÚtig
) {

163 
	grbuf
 +ğ
nÚcÚtig_·ddšg
 * 
ucc_dt_size
((
ùxs
[
r
])->
¬gs
->
¤c
.
šfo
.
d©©y³
);

167 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

168 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

169 
ucc_ä“
(
d¡s
[
r
]);

172  
	g»t
;

176 
şass
 
	g‹¡_®lg©h”v_0
 : 
public
 
‹¡_®lg©h”v
,

177 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {};

179 
	$UCC_TEST_P
(
‹¡_®lg©h”v_0
, 
sšgË
)

181 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

182 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

183 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

184 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

185 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

186 cÚ¡ 
boŞ
 
cÚtig
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

187 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

188 
size
 = 
‹am
->
´ocs
.
	`size
();

189 
UccCŞlCtxVec
 
ùxs
;

191 
	`£t_š¶aû
(
š¶aû
);

192 
	`£t_cÚtig
(
cÚtig
);

193 
	`SET_MEM_TYPE
(
mem_ty³
);

195 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

196 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

197 
»q
.
	`¡¬t
();

198 
»q
.
	`wa™
();

199 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));;

200 
	`d©a_fši
(
ùxs
);

201 
	}
}

203 
	$UCC_TEST_P
(
‹¡_®lg©h”v_0
, 
sšgË_³rsi¡’t
)

205 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

206 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

207 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

208 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

209 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

210 cÚ¡ 
boŞ
 
cÚtig
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

211 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

212 
size
 = 
‹am
->
´ocs
.
	`size
();

213 cÚ¡ 
n_ÿÎs
 = 3;

214 
UccCŞlCtxVec
 
ùxs
;

216 
	`£t_š¶aû
(
š¶aû
);

217 
	`£t_cÚtig
(
cÚtig
);

218 
	`SET_MEM_TYPE
(
mem_ty³
);

220 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
Œue
);

221 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

223 autØ
i
 = 0; i < 
n_ÿÎs
; i++) {

224 
»q
.
	`¡¬t
();

225 
»q
.
	`wa™
();

226 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

227 
	`»£t
(
ùxs
);

229 
	`d©a_fši
(
ùxs
);

230 
	}
}

232 
INSTANTIATE_TEST_CASE_P
(

233 , 
‹¡_®lg©h”v_0
,

234 ::
‹¡šg
::
Combše
(

235 ::
‹¡šg
::
Rªge
(1, 
UccJob
::
nSticT—ms
),

236 
PREDEFINED_DTYPES
,

237 #ifdeà
HAVE_CUDA


238 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

239 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

241 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

243 ::
‹¡šg
::
V®ues
(1,3,8192),

244 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
),

245 ::
‹¡šg
::
BoŞ
()

248 
şass
 
	g‹¡_®lg©h”v_1
 : 
public
 
‹¡_®lg©h”v
,

249 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {};

251 
	$UCC_TEST_P
(
‹¡_®lg©h”v_1
, 
muÉË
)

253 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

254 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

255 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

256 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

257 cÚ¡ 
boŞ
 
cÚtig
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

258 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

259 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

261 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

262 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

263 
size
 = 
‹am
->
´ocs
.
	`size
();

264 
UccCŞlCtxVec
 
ùx
;

266 
this
->
	`£t_š¶aû
(
š¶aû
);

267 
this
->
	`£t_cÚtig
(
cÚtig
);

268 
	`SET_MEM_TYPE
(
mem_ty³
);

270 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùx
, 
çl£
);

271 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

272 
ùxs
.
	`push_back
(
ùx
);

274 
UccReq
::
	`¡¬Î
(
»qs
);

275 
UccReq
::
	`wa™®l
(
»qs
);

277 autØ
ùx
 : 
ùxs
) {

278 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

279 
	`d©a_fši
(
ùx
);

281 
	}
}

283 
INSTANTIATE_TEST_CASE_P
(

284 , 
‹¡_®lg©h”v_1
,

285 ::
‹¡šg
::
Combše
(

286 
PREDEFINED_DTYPES
,

287 #ifdeà
HAVE_CUDA


288 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

289 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

291 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

293 ::
‹¡šg
::
V®ues
(1,3,8192),

294 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
),

295 ::
‹¡šg
::
BoŞ
())

298 
şass
 
	g‹¡_®lg©h”v_®g
 : 
public
 
‹¡_®lg©h”v
,

299 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_2
> {};

301 
	$UCC_TEST_P
(
‹¡_®lg©h”v_®g
, 
®g
)

303 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

304 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

305 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

306 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

307 cÚ¡ 
boŞ
 
cÚtig
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

308 
n_´ocs
 = 5;

309 
tuÃ
[32];

311 
	`¥rštf
(
tuÃ
, "®lg©h”v:@%s:šf", 
¡d
::
g‘
<4>(
	`G‘P¬am
()).
	`c_¡r
());

312 
ucc_job_’v_t
 
’v
 = {{"UCC_CL_BASIC_TUNE", "inf"},

313 {"UCC_TL_UCP_TUNE", 
tuÃ
}};

314 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

315 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

316 
UccCŞlCtxVec
 
ùxs
;

318 
	`£t_š¶aû
(
š¶aû
);

319 
	`£t_cÚtig
(
cÚtig
);

320 
	`SET_MEM_TYPE
(
mem_ty³
);

322 
	`d©a_š™
(
n_´ocs
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

323 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

324 
»q
.
	`¡¬t
();

325 
»q
.
	`wa™
();

326 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

327 
	`d©a_fši
(
ùxs
);

328 
	}
}

330 
INSTANTIATE_TEST_CASE_P
(

331 , 
‹¡_®lg©h”v_®g
,

332 ::
‹¡šg
::
Combše
(

333 
PREDEFINED_DTYPES
,

334 #ifdeà
HAVE_CUDA


335 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

336 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

338 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

340 ::
‹¡šg
::
V®ues
(1,3,8192),

341 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
),

342 ::
‹¡šg
::
V®ues
("knomial", "ring"),

343 ::
‹¡šg
::
BoŞ
()),

344 [](cÚ¡ 
‹¡šg
::
Te¡P¬amInfo
<
‹¡_®lg©h”v_®g
::
P¬amTy³
>& 
šfo
) {

345 
¡d
::
¡ršg
 
Çme
;

346 
Çme
 +ğ
ucc_d©©y³_¡r
(
¡d
::
g‘
<0>(
šfo
.
·¿m
));

347 
Çme
 +ğ
¡d
::
¡ršg
("_"è+ std::¡ršg(
ucc_mem_ty³_¡r
(¡d::
g‘
<1>(
šfo
.
·¿m
)));

348 
Çme
 +ğ
¡d
::
¡ršg
("_couÁ_")+¡d::
to_¡ršg
(¡d::
g‘
<2>(
šfo
.
·¿m
));

349 
Çme
 +ğ
¡d
::
¡ršg
("_š¶aû_")+¡d::
to_¡ršg
(¡d::
g‘
<3>(
šfo
.
·¿m
));

350 
Çme
 +ğ
¡d
::
¡ršg
("_cÚtig_")+¡d::
to_¡ršg
(¡d::
g‘
<5>(
šfo
.
·¿m
));

351 
Çme
 +ğ
¡d
::
¡ršg
("_")+¡d::
g‘
<4>(
šfo
.
·¿m
);

352  
Çme
;

	@test/gtest/coll/test_allreduce.cc

6 
	~"cÜe/‹¡_mc_»duû.h
"

7 
	~"commÚ/‹¡_ucc.h
"

8 
	~"uts/ucc_m©h.h
"

11 
	~"‹¡_®Ìeduû_¦idšg_wšdow.h
"

13 
	~<¬¿y
>

15 
	g‹m¶©e
<
ty³Çme
 
	gT
>

16 
şass
 
	g‹¡_®Ìeduû
 : 
public
 
UccCŞlArgs
,…ubliø
	g‹¡šg
::
Te¡
 {

17 
public
:

18 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dt
, 
size_t
 
couÁ
,

19 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

21 
	gùxs
.
»size
(
Årocs
);

22 
	gr
 = 0;„ < 
	gÅrocs
;„++) {

23 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = (ucc_coll_args_t*)

24 
ÿÎoc
(1, (
ucc_cŞl_¬gs_t
));

26 
	gùxs
[
r
] = (
g‹¡_ucc_cŞl_ùx_t
*)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

27 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

29 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_ALLREDUCE
;

30 
	gcŞl
->
	gİ
 = 
T
::
»dİ
;

31 
	gcŞl
->
	gglob®_wÜk_bufãr
 = 
NULL
;

33 
	gùxs
[
r
]->
	gš™_buf
 = 
ucc_m®loc
(
ucc_dt_size
(
dt
è* 
couÁ
, "init buf");

34 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

35 
	gi
 = 0; i < 
	gcouÁ
; i++) {

36 
ty³Çme
 
	gT
::
ty³
 * 
±r
;

37 
	g±r
 = (
ty³Çme
 
T
::
ty³
 *)
ùxs
[
r
]->
š™_buf
;

43 
	g±r
[
i
] = (
ty³Çme
 
T
::
ty³
)((˜+ 
r
 + 1) % 8);

46 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

47 
ucc_dt_size
(
dt
è* 
couÁ
, 
mem_ty³
));

48 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

49 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

50 
cŞl
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

51 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

52 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
d¡
.
šfo
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

53 
ucc_dt_size
(
dt
è* 
couÁ
, 
mem_ty³
,

54 
UCC_MEMORY_TYPE_HOST
));

55 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

56 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = 
SIZE_MAX
;

57 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = (
ucc_d©©y³_t
)-1;

59 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

60 
ucc_dt_size
(
dt
è* 
couÁ
, 
mem_ty³
));

61 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

62 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

63 
ucc_dt_size
(
dt
è* 
couÁ
, 
mem_ty³
,

64 
UCC_MEMORY_TYPE_HOST
));

65 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

66 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
couÁ
;

67 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dt
;

69 
	gcŞl
->
	gd¡
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

70 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
couÁ
;

71 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
dt
;

72 ià(
	g³rsi¡’t
) {

73 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

74 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

78 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
) {

79 
g‹¡_ucc_cŞl_ùx_t
* 
	gùx
 : 
ùxs
) {

80 
ucc_cŞl_¬gs_t
* 
cŞl
 = 
ùx
->
¬gs
;

81 ià(
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
) {

82 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

84 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
d¡_mc_h—d”
));

85 
ucc_ä“
(
ùx
->
š™_buf
);

86 
ä“
(
cŞl
);

87 
ä“
(
ùx
);

89 
	gùxs
.
ş—r
();

91 
»£t
(
UccCŞlCtxVec
 
ùxs
)

93 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

94 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

95 
size_t
 
	gcouÁ
 = 
cŞl
->
d¡
.
šfo
.
couÁ
;

96 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
d¡
.
šfo
.
d©©y³
;

97 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo
.
bufãr
, 
couÁ
 * 
ucc_dt_size
(
dty³
),

98 
mem_ty³
, 0);

100 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

101 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
d¡
.
šfo
.
bufãr
,

102 
ùxs
[
r
]->
š™_buf
,

103 
ucc_dt_size
(
dty³
è* 
couÁ
, 
mem_ty³
,

104 
UCC_MEMORY_TYPE_HOST
));

108 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

110 
size_t
 
	gcouÁ
 = (
ùxs
[0])->
¬gs
->
d¡
.
šfo
.
couÁ
;

111 
	g¡d
::
veùÜ
<
ty³Çme
 
T
::
ty³
 *> 
d¡s
(
ùxs
.
size
());

113 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

114 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

115 
	gd¡s
[
r
] = (
ty³Çme
 
T
::
ty³
 *è
ucc_m®loc
(
couÁ
 * (typename T::type), "dsts buf");

116 
EXPECT_NE
(
d¡s
[
r
], 
nuÎ±r
);

117 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
[
r
], 
ùxs
[r]->
¬gs
->
d¡
.
šfo
.
bufãr
,

118 
couÁ
 * (
ty³Çme
 
T
::
ty³
), 
UCC_MEMORY_TYPE_HOST
,

119 
mem_ty³
));

122 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

123 
	gd¡s
[
r
] = (
ty³Çme
 
T
::
ty³
 *)(
ùxs
[r]->
¬gs
->
d¡
.
šfo
.
bufãr
);

126 
	gi
 = 0; i < 
	gcouÁ
; i++) {

127 
ty³Çme
 
	gT
::
ty³
 
»s
 =

128 ((
ty³Çme
 
T
::
ty³
 *)((
ùxs
[0])->
š™_buf
))[
i
];

129 
	gr
 = 1;„ < 
	gùxs
.
size
();„++) {

130 
	g»s
 = 
T
::
do_İ
(
»s
, ((
ty³Çme
 T::
ty³
 *)((
ùxs
[
r
])->
š™_buf
))[
i
]);

132 ià(
	gT
::
»dİ
 =ğ
UCC_OP_AVG
) {

133 ià(
T
::
dt
 =ğ
UCC_DT_BFLOAT16
){

134 
æßt32tobæßt16
(
bæßt16toæßt32
(&
»s
è/ ()
ùxs
.
size
(),

135 &
»s
);

137 
	g»s
 = 
»s
 / (
ty³Çme
 
T
::
ty³
)
ùxs
.
size
();

140 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

141 
	gT
::
as£¹_equ®
(
»s
, 
d¡s
[
r
][
i
]);

144 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

145 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

146 
ucc_ä“
(
d¡s
[
r
]);

149  
	gŒue
;

152 
	g‹m¶©e
<
ty³Çme
 
	gT
>

153 
şass
 
	g‹¡_®Ìeduû_ho¡
 : 
public
 
‹¡_®Ìeduû
<
T
> {};

155 
	g‹m¶©e
<
ty³Çme
 
	gT
>

156 
şass
 
	g‹¡_®Ìeduû_cuda
 : 
public
 
‹¡_®Ìeduû
<
T
> {};

158 
TYPED_TEST_CASE
(
‹¡_®Ìeduû_ho¡
, 
CŞlReduûTy³OpsHo¡
);

159 
TYPED_TEST_CASE
(
‹¡_®Ìeduû_cuda
, 
CŞlReduûTy³OpsCuda
);

161 
	#TEST_DECLARE
(
_mem_ty³
, 
_š¶aû
, 
_»³©
, 
_³rsi¡’t
) \

163 
¡d
::
¬¿y
<, 3> 
couÁs
{4, 256, 65536}; \

164 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) { \

165 
couÁ
 : 
couÁs
) { \

166 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
]; \

167 
size
 = 
‹am
->
´ocs
.
	`size
(); \

168 
UccCŞlCtxVec
 
ùxs
; \

169 
	`SET_MEM_TYPE
(
_mem_ty³
); \

170 
this
->
	`£t_š¶aû
(
_š¶aû
); \

171 
this
->
	`d©a_š™
(
size
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, 
_³rsi¡’t
);\

172 
UccReq
 
	`»q
(
‹am
, 
ùxs
); \

173 autØ
i
 = 0; i < 
_»³©
; i++) { \

174 
»q
.
	`¡¬t
(); \

175 
»q
.
	`wa™
(); \

176 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
)); \

177 
this
->
	`»£t
(
ùxs
); \

179 
this
->
	`d©a_fši
(
ùxs
); \

182 }

	)

184 
	$TYPED_TEST
(
‹¡_®Ìeduû_ho¡
, 
sšgË
) {

185 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
, 1, 0);

186 
	}
}

188 
	$TYPED_TEST
(
‹¡_®Ìeduû_ho¡
, 
sšgË_³rsi¡’t
)

190 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
, 3, 1);

191 
	}
}

193 
	$TYPED_TEST
(
‹¡_®Ìeduû_ho¡
, 
sšgË_š¶aû
) {

194 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
, 1, 0);

195 
	}
}

197 
	$TYPED_TEST
(
‹¡_®Ìeduû_ho¡
, 
sšgË_³rsi¡’t_š¶aû
)

199 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
, 3, 1);

200 
	}
}

202 #ifdeà
HAVE_CUDA


203 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
sšgË
) {

204 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
, 1, 0);

205 
	}
}

207 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
sšgË_³rsi¡’t
)

209 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
, 3, 1);

210 
	}
}

212 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
sšgË_š¶aû
) {

213 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
, 1, 0);

214 
	}
}

216 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
sšgË_³rsi¡’t_š¶aû
)

218 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
, 3, 1);

219 
	}
}

220 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
sšgË_mªaged
) {

221 
	`TEST_DECLARE
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
, 1, 0);

222 
	}
}

224 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
sšgË_³rsi¡’t_mªaged
)

226 
	`TEST_DECLARE
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
, 3, 1);

227 
	}
}

229 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
sšgË_š¶aû_mªaged
) {

230 
	`TEST_DECLARE
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
, 1, 0);

231 
	}
}

233 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
sšgË_³rsi¡’t_š¶aû_mªaged
)

235 
	`TEST_DECLARE
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
, 3, 1);

236 
	}
}

239 
	#TEST_DECLARE_MULTIPLE
(
_mem_ty³
, 
_š¶aû
) \

241 
¡d
::
¬¿y
<, 3> 
couÁs
{4, 256, 65536}; \

242 
couÁ
 : 
couÁs
) { \

243 
¡d
::
veùÜ
<
UccReq
> 
»qs
; \

244 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
; \

245 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) { \

246 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
]; \

247 
size
 = 
‹am
->
´ocs
.
	`size
(); \

248 
UccCŞlCtxVec
 
ùx
; \

249 
this
->
	`£t_š¶aû
(
_š¶aû
); \

250 
	`SET_MEM_TYPE
(
_mem_ty³
); \

251 
this
->
	`d©a_š™
(
size
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùx
, 
çl£
); \

252 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
)); \

253 
ùxs
.
	`push_back
(
ùx
); \

255 
UccReq
::
	`¡¬Î
(
»qs
); \

256 
UccReq
::
	`wa™®l
(
»qs
); \

257 autØ
ùx
 : 
ùxs
) { \

258 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùx
)); \

259 
this
->
	`d©a_fši
(
ùx
); \

262 }

	)

264 
	$TYPED_TEST
(
‹¡_®Ìeduû_ho¡
, 
muÉË
) {

265 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
);

266 
	}
}

268 
	$TYPED_TEST
(
‹¡_®Ìeduû_ho¡
, 
muÉË_š¶aû
) {

269 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
);

270 
	}
}

272 #ifdeà
HAVE_CUDA


273 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
muÉË
) {

274 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
);

275 
	}
}

277 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
muÉË_š¶aû
) {

278 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
);

279 
	}
}

280 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
muÉË_mªaged
) {

281 
	`TEST_DECLARE_MULTIPLE
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
);

282 
	}
}

284 
	$TYPED_TEST
(
‹¡_®Ìeduû_cuda
, 
muÉË_š¶aû_mªaged
) {

285 
	`TEST_DECLARE_MULTIPLE
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
);

286 
	}
}

289 
	g‹m¶©e
<
ty³Çme
 
	gT
>

290 
şass
 
	g‹¡_®Ìeduû_®g
 : 
public
 
‹¡_®Ìeduû
<
T
>

293 
usšg
 
	g‹¡_®Ìeduû_®g_ty³
 = ::
‹¡šg
::
Ty³s
<
Ty³OpPaœ
<
UCC_DT_INT32
, 
	gsum
>>;

294 
TYPED_TEST_CASE
(
‹¡_®Ìeduû_®g
, 
‹¡_®Ìeduû_®g_ty³
);

296 
	$TYPED_TEST
(
‹¡_®Ìeduû_®g
, 
¤a_knomŸl_p–šed
) {

297 
n_´ocs
 = 15;

298 
ucc_job_’v_t
 
’v
 = {{"UCC_CL_BASIC_TUNE", "inf"},

301 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

302 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

303 
»³©
 = 3;

304 
UccCŞlCtxVec
 
ùxs
;

305 
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mt
 = {
UCC_MEMORY_TYPE_HOST
};

307 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) {

308 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA
);

310 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
)) {

311 
mt
.
	`push_back
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
);

314 autØ
couÁ
 : {65536, 123567}) {

315 autØ
š¶aû
 : {
TEST_NO_INPLACE
, 
TEST_INPLACE
}) {

316 autØ
m
 : 
mt
) {

317 
	`SET_MEM_TYPE
(
m
);

318 
this
->
	`£t_š¶aû
(
š¶aû
);

319 
this
->
	`d©a_š™
(
n_´ocs
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, 
Œue
);

320 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

322 autØ
i
 = 0; i < 
»³©
; i++) {

323 
»q
.
	`¡¬t
();

324 
»q
.
	`wa™
();

325 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
));

326 
this
->
	`»£t
(
ùxs
);

328 
this
->
	`d©a_fši
(
ùxs
);

332 
	}
}

334 
	$TYPED_TEST
(
‹¡_®Ìeduû_®g
, 
dbt
) {

335 
n_´ocs
 = 15;

336 
ucc_job_’v_t
 
’v
 = {{"UCC_CL_BASIC_TUNE", "inf"},

338 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

339 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

340 
»³©
 = 3;

341 
UccCŞlCtxVec
 
ùxs
;

342 
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mt
 = {
UCC_MEMORY_TYPE_HOST
};

344 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) {

345 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA
);

347 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
)) {

348 
mt
.
	`push_back
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
);

351 autØ
couÁ
 : {65536, 123567}) {

352 autØ
š¶aû
 : {
TEST_NO_INPLACE
, 
TEST_INPLACE
}) {

353 autØ
m
 : 
mt
) {

354 
	`SET_MEM_TYPE
(
m
);

355 
this
->
	`£t_š¶aû
(
š¶aû
);

356 
this
->
	`d©a_š™
(
n_´ocs
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, 
Œue
);

357 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

359 autØ
i
 = 0; i < 
»³©
; i++) {

360 
»q
.
	`¡¬t
();

361 
»q
.
	`wa™
();

362 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
));

363 
this
->
	`»£t
(
ùxs
);

365 
this
->
	`d©a_fši
(
ùxs
);

369 
	}
}

371 
	$TYPED_TEST
(
‹¡_®Ìeduû_®g
, 
¿b
) {

372 
n_´ocs
 = 15;

373 
ucc_job_’v_t
 
’v
 = {{"UCC_CL_HIER_TUNE", "allreduce:@rab:0-inf:inf"},

375 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

376 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

377 
»³©
 = 3;

378 
UccCŞlCtxVec
 
ùxs
;

379 
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mt
 = {
UCC_MEMORY_TYPE_HOST
};

381 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) {

382 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA
);

385 autØ
couÁ
 : {8, 65536, 123567}) {

386 autØ
š¶aû
 : {
TEST_NO_INPLACE
, 
TEST_INPLACE
}) {

387 autØ
m
 : 
mt
) {

388 
	`SET_MEM_TYPE
(
m
);

389 
this
->
	`£t_š¶aû
(
š¶aû
);

390 
this
->
	`d©a_š™
(
n_´ocs
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, 
Œue
);

391 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

393 autØ
i
 = 0; i < 
»³©
; i++) {

394 
»q
.
	`¡¬t
();

395 
»q
.
	`wa™
();

396 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
));

397 
this
->
	`»£t
(
ùxs
);

399 
this
->
	`d©a_fši
(
ùxs
);

403 
	}
}

405 
	$TYPED_TEST
(
‹¡_®Ìeduû_®g
, 
¿b_p–šed
) {

406 
n_´ocs
 = 15;

407 
ucc_job_’v_t
 
’v
 = {{"UCC_CL_HIER_TUNE", "allreduce:@rab:0-inf:inf"},

410 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

411 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

412 
»³©
 = 3;

413 
UccCŞlCtxVec
 
ùxs
;

414 
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mt
 = {
UCC_MEMORY_TYPE_HOST
};

416 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) {

417 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA
);

420 autØ
couÁ
 : {65536, 123567}) {

421 autØ
š¶aû
 : {
TEST_NO_INPLACE
, 
TEST_INPLACE
}) {

422 autØ
m
 : 
mt
) {

423 
	`SET_MEM_TYPE
(
m
);

424 
this
->
	`£t_š¶aû
(
š¶aû
);

425 
this
->
	`d©a_š™
(
n_´ocs
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, 
Œue
);

426 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

428 autØ
i
 = 0; i < 
»³©
; i++) {

429 
»q
.
	`¡¬t
();

430 
»q
.
	`wa™
();

431 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
));

432 
this
->
	`»£t
(
ùxs
);

434 
this
->
	`d©a_fši
(
ùxs
);

438 
	}
}

440 #ifdeà
HAVE_UCX


441 
	$TYPED_TEST
(
‹¡_®Ìeduû_®g
, 
¦idšg_wšdow
)

443 
n_´ocs
 = 8;

444 
ucc_job_’v_t
 
’v
 = {{"UCC_TL_UCP_TUNE", "allreduce:@sliding_window"},

446 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL_ONESIDED
, 
’v
);

447 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

448 
»³©
 = 3;

449 
‹¡_uı_šfo_t
 *
uı_šfos
 = 
NULL
;

450 
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mt
 = {
UCC_MEMORY_TYPE_HOST
};

451 
ucs_¡©us_t
 
ucs_¡©us
 = 
UCS_OK
;

452 
UccCŞlCtxVec
 
ùxs
;

454 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(

455 
UCC_MEMORY_TYPE_CUDA
)) {

456 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA
);

459 autØ
couÁ
 : {65536, 123567}) {

460 autØ
š¶aû
 : {
TEST_NO_INPLACE
, 
TEST_INPLACE
}) {

461 autØ
m
 : 
mt
) {

462 
	`SET_MEM_TYPE
(
m
);

463 
this
->
	`£t_š¶aû
(
š¶aû
);

464 
this
->
	`d©a_š™
(
n_´ocs
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, 
Œue
);

467 
ucs_¡©us
 = 
	`£tup_gwbi
(
n_´ocs
, 
ùxs
, &
uı_šfos
, 
š¶aû
 =ğ
TEST_INPLACE
);

468 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

469 
	`ä“_gwbi
(
n_´ocs
, 
ùxs
, 
uı_šfos
, 
š¶aû
 =ğ
TEST_INPLACE
);

470 
this
->
	`d©a_fši
(
ùxs
);

471 ià(
ucs_¡©us
 =ğ
UCS_ERR_UNSUPPORTED
) {

472 
	`GTEST_SKIP
() << "Exported memory key‚ot supported";

474 
	`GTEST_FAIL
(è<< 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
);

478 autØ
i
 = 0; i < 
»³©
; i++) {

479 
this
->
	`»£t
(
ùxs
);

482 
	`ä“_gwbi
(
n_´ocs
, 
ùxs
, 
uı_šfos
, 
š¶aû
 =ğ
TEST_INPLACE
);

483 
uı_šfos
 = 
NULL
;

484 
this
->
	`d©a_fši
(
ùxs
);

488 
	}
}

491 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

492 
şass
 
	g‹¡_®Ìeduû_avg_Üd”
 : 
public
 
‹¡_®Ìeduû
<
T
> {

495 
usšg
 
	g‹¡_®Ìeduû_avg_Üd”_ty³
 = ::
‹¡šg
::
Ty³s
<

496 
Ty³OpPaœ
<
UCC_DT_FLOAT32
, 
	gavg
>, 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64
,‡vg>,

497 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT128
, 
	gavg
>, Ty³OpPaœ<
	gUCC_DT_FLOAT32_COMPLEX
,‡vg>,

498 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64_COMPLEX
, 
	gavg
>,

499 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT128_COMPLEX
, 
	gavg
>, Ty³OpPaœ<
	gUCC_DT_BFLOAT16
,‡vg>>;

501 
TYPED_TEST_CASE
(
‹¡_®Ìeduû_avg_Üd”
, 
‹¡_®Ìeduû_avg_Üd”_ty³
);

503 
	$TYPED_TEST
(
‹¡_®Ìeduû_avg_Üd”
, 
avg_po¡_İ
)

505 
n_´ocs
 = 15;

506 
ucc_job_’v_t
 
’v
 = {{"UCC_TL_UCP_REDUCE_AVG_PRE_OP", "0"}};

507 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

508 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

509 
»³©
 = 3;

510 
UccCŞlCtxVec
 
ùxs
;

511 
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mt
 = {
UCC_MEMORY_TYPE_HOST
};

513 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) {

514 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA
);

516 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
)) {

517 
mt
.
	`push_back
Ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
);

520 autØ
couÁ
 : {4, 256, 65536}) {

521 autØ
š¶aû
 : {
TEST_NO_INPLACE
, 
TEST_INPLACE
}) {

522 autØ
m
 : 
mt
) {

523 
	`CHECK_TYPE_OP_SKIP
(
Ty³P¬am
::
dt
, Ty³P¬am::
»dİ
, 
m
);

524 
	`SET_MEM_TYPE
(
m
);

525 
this
->
	`£t_š¶aû
(
š¶aû
);

526 
this
->
	`d©a_š™
(
n_´ocs
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, 
Œue
);

527 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

529 autØ
i
 = 0; i < 
»³©
; i++) {

530 
»q
.
	`¡¬t
();

531 
»q
.
	`wa™
();

532 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
));

533 
this
->
	`»£t
(
ùxs
);

535 
this
->
	`d©a_fši
(
ùxs
);

539 
	}
}

	@test/gtest/coll/test_allreduce_sliding_window.cc

13 
	~"commÚ/‹¡_ucc.h
"

15 #ifdeà
HAVE_UCX


17 
	~"cÜe/‹¡_mc_»duû.h
"

18 
	~"uts/ucc_m©h.h
"

20 
	~<¬¿y
>

22 
	~"‹¡_®Ìeduû_¦idšg_wšdow.h
"

24 
	$‹¡_š™_uı
(
uı_cÚ‹xt_h
 *
uı_ùx
, 
uı_cÚfig_t
 **
uı_cÚfig_p
)

26 
ucs_¡©us_t
 
ucs_¡©us
;

27 
uı_cÚfig_t
 *
uı_cÚfig
;

28 
uı_·¿ms_t
 
uı_·¿ms
;

29 
uı_cÚ‹xt_h
 
uı_cÚ‹xt
;

31 
ucs_¡©us
 = 
	`uı_cÚfig_»ad
(
NULL
, NULL, &
uı_cÚfig
);

32 
	`EXPECT_EQ
(
UCS_OK
, 
ucs_¡©us
) << "ucp_config_read()„eturnedƒrror: "

33 << 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
);

35 
uı_·¿ms
.
f›ld_mask
 = 
UCP_PARAM_FIELD_FEATURES
;

36 
uı_·¿ms
.
ã©u»s
 = 
UCP_FEATURE_TAG
 | 
UCP_FEATURE_RMA
 |

37 
UCP_FEATURE_AMO64
 | 
UCP_FEATURE_EXPORTED_MEMH
;

39 
ucs_¡©us
 = 
	`uı_š™
(&
uı_·¿ms
, 
uı_cÚfig
, &
uı_cÚ‹xt
);

40 
	`EXPECT_EQ
(
UCS_OK
, 
ucs_¡©us
) << "ucp_init()„eturnedƒrror: "

41 << 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
);

43 *
uı_ùx
 = 
uı_cÚ‹xt
;

44 *
uı_cÚfig_p
 = 
uı_cÚfig
;

45 
	}
}

47 
ucs_¡©us_t
 
	$bufãr_expÜt_ucc
(
uı_cÚ‹xt_h
 
uı_cÚ‹xt
, *
buf
, 
size_t
 
Ën
,

48 
expÜt_buf
 *
ebuf
)

50 
ucs_¡©us_t
 
ucs_¡©us
 = 
UCS_OK
;

51 
uı_mem_m­_·¿ms_t
 
·¿ms
;

52 
uı_memh_·ck_·¿ms_t
 
·ck_·¿ms
;

54 
ebuf
->
uı_cÚ‹xt
 = ucp_context;

56 
·¿ms
.
f›ld_mask
 =

57 
UCP_MEM_MAP_PARAM_FIELD_ADDRESS
 | 
UCP_MEM_MAP_PARAM_FIELD_LENGTH
;

58 
·¿ms
.
add»ss
 = 
buf
;

59 
·¿ms
.
Ëngth
 = 
Ën
;

61 
ucs_¡©us
 = 
	`uı_mem_m­
(
uı_cÚ‹xt
, &
·¿ms
, &
ebuf
->
memh
);

62 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

63 
	`´štf
("uı_mem_m­(è»tuºedƒ¼Ü: %s\n", 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
));

64  
ucs_¡©us
;

67 
·ck_·¿ms
.
f›ld_mask
 = 
UCP_MEMH_PACK_PARAM_FIELD_FLAGS
;

68 
·ck_·¿ms
.
æags
 = 
UCP_MEMH_PACK_FLAG_EXPORT
;

70 
ucs_¡©us
 = 
	`uı_memh_·ck
(
ebuf
->
memh
, &
·ck_·¿ms
, &ebuf->
·cked_memh
,

71 &
ebuf
->
·cked_memh_Ën
);

72 ià(
ucs_¡©us
 !ğ
UCS_OK
) {

73 
	`´štf
("uı_memh_·ck(è»tuºedƒ¼Ü: %s\n", 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
));

74  
ucs_¡©us
;

77  
ucs_¡©us
;

78 
	}
}

80 
ucs_¡©us_t
 
	$£tup_gwbi
(
n_´ocs
, 
UccCŞlCtxVec
 &
ùxs
,

81 
‹¡_uı_šfo_t
 **
uı_šfos_p
 , 
boŞ
 
š¶aû
)

83 
i
;

84 
ucs_¡©us_t
 
ucs_¡©us
 = 
UCS_OK
;

86 
‹¡_uı_šfo_t
 *
uı_šfos
 =

87 (
‹¡_uı_šfo_t
 *)
	`ucc_m®loc
(Ñe¡_uı_šfo_tè* 
n_´ocs
);

88 
	`EXPECT_NE
(
uı_šfos
, 
nuÎ±r
);

89 *
uı_šfos_p
 = 
uı_šfos
;

92 autØ
ùx
 : 
ùxs
) {

93 
glob®_wÜk_buf_šfo
 *
gwbi
 =

94 (
glob®_wÜk_buf_šfo
 *)
	`ucc_m®loc
(

95 (
glob®_wÜk_buf_šfo
),

98 
	`EXPECT_NE
(
gwbi
, 
nuÎ±r
);

100 
ùx
->
¬gs
->
glob®_wÜk_bufãr
 = 
gwbi
;

104 
i
 = 0; i < 
n_´ocs
; i++) {

105 
	`‹¡_š™_uı
(&
uı_šfos
[
i
].
uı_ùx
, &uı_šfos[i].
uı_cÚfig
);

106 
uı_šfos
[
i
].
¤c_ebuf
 = {0};

107 
uı_šfos
[
i
].
d¡_ebuf
 = {0};

111 
i
 = 0; i < 
n_´ocs
; i++) {

113 
glob®_wÜk_buf_šfo
 *
gwbi
 =

114 (
glob®_wÜk_buf_šfo
 *)
ùxs
[
i
]

115 ->
¬gs
->
glob®_wÜk_bufãr
;

117 
‹¡_uı_šfo_t
 * 
uı_šfo
 = &
uı_šfos
[
i
];

118 
expÜt_buf
 *
d¡_ebuf
 = &
uı_šfo
->dst_ebuf;

119 
size_t
 
d¡_Ën
 = 
ùxs
[
i
]->
¬gs
->
d¡
.
šfo
.
couÁ
 *

120 
	`ucc_dt_size
(
ùxs
[
i
]->
¬gs
->
d¡
.
šfo
.
d©©y³
);

122 
ucs_¡©us
 = 
	`bufãr_expÜt_ucc
(

123 
uı_šfo
->
uı_ùx
, 
ùxs
[
i
]->
¬gs
->
d¡
.
šfo
.
bufãr
,

124 
d¡_Ën
, 
d¡_ebuf
);

125 ià(
ucs_¡©us
 !ğ
UCS_OK
)  ucs_status;

127 
gwbi
->
·cked_d¡_memh
 = 
d¡_ebuf
->
·cked_memh
;

129 ià(!
š¶aû
) {

130 
size_t
 
¤c_Ën
 = 
ùxs
[
i
]->
¬gs
->
¤c
.
šfo
.
couÁ
 *

131 
	`ucc_dt_size
(
ùxs
[
i
]->
¬gs
->
¤c
.
šfo
.
d©©y³
);

132 
expÜt_buf
 *
¤c_ebuf
 = &
uı_šfo
->src_ebuf;

133 
ucs_¡©us
 = 
	`bufãr_expÜt_ucc
(

134 
uı_šfo
->
uı_ùx
, 
ùxs
[
i
]->
¬gs
->
¤c
.
šfo
.
bufãr
,

135 
¤c_Ën
, 
¤c_ebuf
);

136 ià(
ucs_¡©us
 !ğ
UCS_OK
)  ucs_status;

138 
gwbi
->
·cked_¤c_memh
 = 
¤c_ebuf
->
·cked_memh
;

143 autØ
ùx
 : 
ùxs
) {

144 
ùx
->
¬gs
->
mask
 |=

145 
UCC_COLL_ARGS_FIELD_FLAGS
 | 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
;

146 
ùx
->
¬gs
->
æags
 |ğ
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
;

149  
ucs_¡©us
;

150 
	}
}

152 
	$ä“_gwbi
(
n_´ocs
, 
UccCŞlCtxVec
 &
ùxs
, 
‹¡_uı_šfo_t
 *
uı_šfos
,

153 
boŞ
 
š¶aû
)

155 
i
, 
k
;

156 
ucs_¡©us_t
 
ucs_¡©us
;

159 
i
 = 0; i < 
n_´ocs
; i++) {

161 
‹¡_uı_šfo_t
 *
uı_šfo
 = &
uı_šfos
[
i
];

163 ià(!
š¶aû
) {

164 
expÜt_buf
 *
¤c_ebuf
 = &
uı_šfo
->src_ebuf;

165 ià(
¤c_ebuf
->
memh
 != 0) {

166 
ucs_¡©us
 = 
	`uı_mem_unm­
(
uı_šfo
->
uı_ùx
, 
¤c_ebuf
->
memh
);

167 
	`ASSERT_EQ
(
UCS_OK
, 
ucs_¡©us
) << "ucp_mem_unmap()„eturnedƒrror: "

168 << 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
);

172 
expÜt_buf
 *
d¡_ebuf
 = &
uı_šfo
->dst_ebuf;

173 ià(
d¡_ebuf
->
memh
 != 0) {

174 
ucs_¡©us
 = 
	`uı_mem_unm­
(
uı_šfo
->
uı_ùx
, 
d¡_ebuf
->
memh
);

175 
	`ASSERT_EQ
(
UCS_OK
, 
ucs_¡©us
) << "ucp_mem_unmap()„eturnedƒrror: "

176 << 
	`ucs_¡©us_¡ršg
(
ucs_¡©us
);

181 
i
 = 0; i < 
n_´ocs
; i++) {

182 
	`uı_cÚfig_»Ëa£
(
uı_šfos
[
i
].
uı_cÚfig
);

183 
	`uı_ş—nup
(
uı_šfos
[
i
].
uı_ùx
);

187 
k
 = 0; k < 
n_´ocs
; k++) {

188 
glob®_wÜk_buf_šfo
 *
gwbi
 =

189 (
glob®_wÜk_buf_šfo
 *è
ùxs
[
k
]->
¬gs
->
glob®_wÜk_bufãr
;

191 
	`ucc_ä“
(
gwbi
);

194 
	`ucc_ä“
(
uı_šfos
);

195 
	}
}

	@test/gtest/coll/test_allreduce_sliding_window.h

1 #iâdeà
TEST_ALLREDUCE_SW_H


2 
	#TEST_ALLREDUCE_SW_H


	)

4 
	~"commÚ/‹¡_ucc.h
"

6 #ifdeà
HAVE_UCX


8 
	~<uı/­i/uı.h
>

10 
	sglob®_wÜk_buf_šfo
 {

11 *
	m·cked_¤c_memh
;

12 *
	m·cked_d¡_memh
;

13 } 
	tglob®_wÜk_buf_šfo
;

15 
	sexpÜt_buf
 {

16 
uı_cÚ‹xt_h
 
	muı_cÚ‹xt
;

17 
uı_mem_h
 
	mmemh
;

18 * 
	m·cked_memh
;

19 
size_t
 
	m·cked_memh_Ën
;

20 
ušt64_t
 
	mmemh_id
;

23 
	s‹¡_uı_šfo_t
 {

24 
uı_cÚ‹xt_h
 
	muı_ùx
;

25 
uı_cÚfig_t
 *
	muı_cÚfig
;

26 
expÜt_buf
 
	m¤c_ebuf
;

27 
expÜt_buf
 
	md¡_ebuf
;

28 } 
	t‹¡_uı_šfo_t
;

30 
ä“_gwbi
(
n_´ocs
, 
UccCŞlCtxVec
 &
ùxs
, 
‹¡_uı_šfo_t
 *
uı_šfos
,

31 
boŞ
 
š¶aû
);

32 
ucs_¡©us_t
 
£tup_gwbi
(
n_´ocs
, 
UccCŞlCtxVec
 &
ùxs
,

33 
‹¡_uı_šfo_t
 **
uı_šfos_p
 , 
boŞ
 
š¶aû
);

	@test/gtest/coll/test_alltoall.cc

6 
	~"commÚ/‹¡_ucc.h
"

7 
	~"uts/ucc_m©h.h
"

9 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<, 
	gucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, 
	gg‹¡_ucc_š¶aû_t
, >;

10 
usšg
 
	gP¬am_1
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, 
	gg‹¡_ucc_š¶aû_t
, >;

12 
şass
 
	g‹¡_®ÉßÎ
 : 
public
 
UccCŞlArgs
,…ubliø
	gucc
::
‹¡


14 
public
:

15 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
,

16 
size_t
 
sšgË_¿nk_couÁ
, 
UccCŞlCtxVec
 &
ùxs
,

17 
UccT—m_h
 
‹am
, 
boŞ
 
³rsi¡’t
)

19 
boŞ
 
	gis_Úesided
 = (
NULL
 !ğ
‹am
);

20 *
	gsbuf
;

21 *
	grbuf
;

22 *
	gwÜk_buf
;

24 
	gùxs
.
»size
(
Årocs
);

25 autØ
	gi
 = 0; i < 
	gÅrocs
; i++) {

26 
ucc_cŞl_¬gs_t
 *
	gcŞl
 =

27 (
ucc_cŞl_¬gs_t
 *)
ÿÎoc
(1, (ucc_coll_args_t));

29 
	gùxs
[
i
] =

30 (
g‹¡_ucc_cŞl_ùx_t
 *)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

31 
	gùxs
[
i
]->
	g¬gs
 = 
cŞl
;

33 
	gcŞl
->
	gmask
 = 0;

34 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_ALLTOALL
;

35 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

36 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
sšgË_¿nk_couÁ
 * 
Årocs
;

37 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dty³
;

38 
	gcŞl
->
	gd¡
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

39 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
sšgË_¿nk_couÁ
 * 
Årocs
;

40 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
dty³
;

42 
	gùxs
[
i
]->
	gš™_buf
 = 
ucc_m®loc
(

43 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
 * 
Årocs
, "init buf");

44 
EXPECT_NE
(
ùxs
[
i
]->
š™_buf
, 
nuÎ±r
);

45 
	gr
 = 0;„ < 
	gÅrocs
;„++) {

46 
size_t
 
	g¿nk_size
 = 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
;

47 
®ÉßÎx_š™_buf
(
r
, 
i
,

48 (
ušt8_t
 *)
ùxs
[
i
]->
š™_buf
 + 
r
 * 
¿nk_size
,

49 
¿nk_size
);

51 ià(
	gis_Úesided
) {

52 
	gsbuf
 = 
‹am
->
´ocs
[
i
].
p
->
Úesided_buf
[0];

53 
	grbuf
 = 
‹am
->
´ocs
[
i
].
p
->
Úesided_buf
[1];

54 
	gwÜk_buf
 = (*)
‹am
->
´ocs
[
i
].
p
->
Úesided_buf
[2];

55 
	gcŞl
->
	gmask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
 |

56 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
;

57 
	gcŞl
->
	gæags
 = 
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
;

58 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
sbuf
;

59 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

60 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
rbuf
;

61 
	gcŞl
->
	gd¡
.
	gšfo
.
	gmem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

62 
	gcŞl
->
	gglob®_wÜk_bufãr
 = 
wÜk_buf
;

64 
UCC_CHECK
(
ucc_mc_®loc
(

65 &
ùxs
[
i
]->
d¡_mc_h—d”
,

66 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
 * 
Årocs
, 
mem_ty³
));

67 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
i
]->
d¡_mc_h—d”
->
addr
;

69 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

70 
cŞl
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

71 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

72 
UCC_CHECK
(
ucc_mc_memıy
(

73 
cŞl
->
d¡
.
šfo
.
bufãr
, 
ùxs
[
i
]->
š™_buf
,

74 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
 * 
Årocs
, 
mem_ty³
,

75 
UCC_MEMORY_TYPE_HOST
));

77 ià(!
	gis_Úesided
) {

78 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
i
]->
¤c_mc_h—d”
,

79 
ucc_dt_size
(
dty³
) *

80 
sšgË_¿nk_couÁ
 * 
Årocs
,

81 
mem_ty³
));

82 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
i
]->
¤c_mc_h—d”
->
addr
;

84 
UCC_CHECK
(
ucc_mc_memıy
(

85 
cŞl
->
¤c
.
šfo
.
bufãr
, 
ùxs
[
i
]->
š™_buf
,

86 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
 * 
Årocs
, 
mem_ty³
,

87 
UCC_MEMORY_TYPE_HOST
));

90 ià(
	g³rsi¡’t
) {

91 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

92 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

97 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
, 
size_t
 
sšgË_¿nk_couÁ
,

98 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
 = 
çl£
)

100 
d©a_š™
(
Årocs
, 
dty³
, 
sšgË_¿nk_couÁ
, 
ùxs
, 
NULL
, 
³rsi¡’t
);

103 
»£t
(
UccCŞlCtxVec
 
ùxs
)

105 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

106 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

107 
size_t
 
	gsšgË_¿nk_couÁ
 = 
cŞl
->
d¡
.
šfo
.
couÁ
 / 
ùxs
.
size
();

108 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
d¡
.
šfo
.
d©©y³
;

109 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo
.
bufãr
,

110 
sšgË_¿nk_couÁ
 * 
ucc_dt_size
(
dty³
), 
mem_ty³
, 0);

111 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

112 
UCC_CHECK
(
ucc_mc_memıy
(

113 (*)(
±rdiff_t
)
cŞl
->
d¡
.
šfo
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

114 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
, 
mem_ty³
,

115 
UCC_MEMORY_TYPE_HOST
));

120 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

122 
g‹¡_ucc_cŞl_ùx_t
* 
	gùx
 : 
ùxs
) {

123 
ucc_cŞl_¬gs_t
* 
cŞl
 = 
ùx
->
¬gs
;

124 ià(
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
) {

125 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

127 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
d¡_mc_h—d”
));

128 
ucc_ä“
(
ùx
->
š™_buf
);

129 
ä“
(
cŞl
);

130 
ä“
(
ùx
);

132 
	gùxs
.
ş—r
();

135 
d©a_fši_Úesided
(
UccCŞlCtxVec
 
ùxs
)

137 
g‹¡_ucc_cŞl_ùx_t
 *
	gùx
 : 
ùxs
) {

138 
ucc_cŞl_¬gs_t
 *
cŞl
 = 
ùx
->
¬gs
;

139 
ucc_ä“
(
ùx
->
š™_buf
);

140 
ä“
(
cŞl
);

141 
ä“
(
ùx
);

143 
	gùxs
.
ş—r
();

146 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

148 
boŞ
 
	g»t
 = 
Œue
;

149 
	g¡d
::
veùÜ
<
ušt8_t
 *> 
d¡s
(
ùxs
.
size
());

151 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

152 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

153 
size_t
 
	gbuf_size
 =

154 
ucc_dt_size
(
ùxs
[
r
]->
¬gs
->
d¡
.
šfo
.
d©©y³
) *

155 (
size_t
)
ùxs
[
r
]->
¬gs
->
d¡
.
šfo
.
couÁ
;

156 
	gd¡s
[
r
] = (
ušt8_t
 *è
ucc_m®loc
(
buf_size
, "dsts buf");

157 
EXPECT_NE
(
d¡s
[
r
], 
nuÎ±r
);

158 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
[
r
], 
ùxs
[r]->
¬gs
->
d¡
.
šfo
.
bufãr
,

159 
buf_size
, 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

162 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

163 
	gd¡s
[
r
] = (
ušt8_t
 *)(
ùxs
[r]->
¬gs
->
d¡
.
šfo
.
bufãr
);

166 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

167 
ucc_cŞl_¬gs_t
* 
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

169 
	gi
 = 0; i < 
	gùxs
.
size
(); i++) {

170 
size_t
 
	g¿nk_size
 = 
ucc_dt_size
(
cŞl
->
d¡
.
šfo
.
d©©y³
) *

171 (
size_t
)(
cŞl
->
d¡
.
šfo
.
couÁ
 / 
ùxs
.
size
());

172 ià(0 !ğ
®ÉßÎx_v®id©e_buf
(
i
, 
r
, (
ušt8_t
*)
d¡s
[r] +

173 
¿nk_size
 * 
i
,„ank_size)) {

174 
	g»t
 = 
çl£
;

179 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

180 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

181 
ucc_ä“
(
d¡s
[
r
]);

184  
	g»t
;

188 
şass
 
	g‹¡_®ÉßÎ_0
 : 
public
 
‹¡_®ÉßÎ
,

189 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {};

191 
	$UCC_TEST_P
(
‹¡_®ÉßÎ_0
, 
sšgË
)

193 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

194 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

195 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

196 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

197 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

198 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

199 
size
 = 
‹am
->
´ocs
.
	`size
();

200 
UccCŞlCtxVec
 
ùxs
;

202 
this
->
	`£t_š¶aû
(
š¶aû
);

203 
	`SET_MEM_TYPE
(
mem_ty³
);

205 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

206 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

207 
»q
.
	`¡¬t
();

208 
»q
.
	`wa™
();

209 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

210 
	`d©a_fši
(
ùxs
);

211 
	}
}

213 
	$UCC_TEST_P
(
‹¡_®ÉßÎ_0
, 
sšgË_Úesided
)

215 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

216 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

217 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

218 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

219 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

220 
UccT—m_h
 
»ã»nû_‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

221 
size
 = 
»ã»nû_‹am
->
´ocs
.
	`size
();

222 
ucc_job_’v_t
 
’v
 = {{"UCC_TL_UCP_TUNE", "alltoall:0-inf:@1"}};

223 
boŞ
 
is_cÚtig
 = 
Œue
;

224 
UccJob
 
	`job
(
size
, UccJob::
UCC_JOB_CTX_GLOBAL_ONESIDED
, 
’v
);

225 
UccT—m_h
 
‹am
;

226 
¡d
::
veùÜ
<> 
»ã»nû_¿nks
;

227 
UccCŞlCtxVec
 
ùxs
;

229 autØ
i
 = 0; i < 
»ã»nû_‹am
->
n_´ocs
; i++) {

230 
¿nk
 = 
»ã»nû_‹am
->
´ocs
[
i
].
p
->
job_¿nk
;

231 
»ã»nû_¿nks
.
	`push_back
(
¿nk
);

232 ià(
is_cÚtig
 && 
i
 > 0 &&

233 (
¿nk
 - 
»ã»nû_¿nks
[
i
 - 1] > 1 ||

234 
»ã»nû_¿nks
[
i
 - 1] - 
¿nk
 > 1)) {

235 
is_cÚtig
 = 
çl£
;

238 
‹am
 = 
job
.
	`ü—‹_‹am
(
»ã»nû_¿nks
, 
Œue
, 
is_cÚtig
,rue);

239 
this
->
	`£t_š¶aû
(
š¶aû
);

240 
	`SET_MEM_TYPE
(
mem_ty³
);

241 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
‹am
, 
çl£
);

242 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

243 
»q
.
	`¡¬t
();

244 
»q
.
	`wa™
();

245 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

246 
	`d©a_fši_Úesided
(
ùxs
);

247 
	}
}

249 
	$UCC_TEST_P
(
‹¡_®ÉßÎ_0
, 
sšgË_³rsi¡’t
)

251 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

252 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

253 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

254 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

255 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

256 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

257 
size
 = 
‹am
->
´ocs
.
	`size
();

258 cÚ¡ 
n_ÿÎs
 = 3;

259 
UccCŞlCtxVec
 
ùxs
;

261 
this
->
	`£t_š¶aû
(
š¶aû
);

262 
	`SET_MEM_TYPE
(
mem_ty³
);

264 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
Œue
);

265 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

267 autØ
i
 = 0; i < 
n_ÿÎs
; i++) {

268 
»q
.
	`¡¬t
();

269 
»q
.
	`wa™
();

270 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

271 
	`»£t
(
ùxs
);

273 
	`d©a_fši
(
ùxs
);

274 
	}
}

276 
INSTANTIATE_TEST_CASE_P
(

277 , 
‹¡_®ÉßÎ_0
,

278 ::
‹¡šg
::
Combše
(

279 ::
‹¡šg
::
Rªge
(1, 
UccJob
::
nSticT—ms
),

280 
PREDEFINED_DTYPES
,

281 #ifdeà
HAVE_CUDA


282 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

283 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

285 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

287 ::
‹¡šg
::
V®ues
Ğ
TEST_NO_INPLACE
),

288 ::
‹¡šg
::
V®ues
(1,3)));

290 
şass
 
	g‹¡_®ÉßÎ_1
 : 
public
 
‹¡_®ÉßÎ
,

291 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {};

293 
	$UCC_TEST_P
(
‹¡_®ÉßÎ_1
, 
muÉË
)

295 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

296 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

297 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

298 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

299 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

300 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

302 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

303 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

304 
size
 = 
‹am
->
´ocs
.
	`size
();

305 
UccCŞlCtxVec
 
ùx
;

307 
this
->
	`£t_š¶aû
(
š¶aû
);

308 
	`SET_MEM_TYPE
(
mem_ty³
);

310 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùx
, 
çl£
);

311 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

312 
ùxs
.
	`push_back
(
ùx
);

314 
UccReq
::
	`¡¬Î
(
»qs
);

315 
UccReq
::
	`wa™®l
(
»qs
);

317 autØ
ùx
 : 
ùxs
) {

318 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

319 
	`d©a_fši
(
ùx
);

321 
	}
}

323 
INSTANTIATE_TEST_CASE_P
(

324 , 
‹¡_®ÉßÎ_1
,

325 ::
‹¡šg
::
Combše
(

326 
PREDEFINED_DTYPES
,

327 #ifdeà
HAVE_CUDA


328 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

329 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

331 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

333 ::
‹¡šg
::
V®ues
Ğ
TEST_NO_INPLACE
),

334 ::
‹¡šg
::
V®ues
(1,3,8192)));

	@test/gtest/coll/test_alltoallv.cc

7 
	~"commÚ/‹¡_ucc.h
"

8 
	~"uts/ucc_m©h.h
"

10 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<, 
	gucc_memÜy_ty³_t
, 
	gg‹¡_ucc_š¶aû_t
, 
	gucc_d©©y³_t
>;

11 
usšg
 
	gP¬am_1
 = 
¡d
::
tu¶e
<
ucc_memÜy_ty³_t
, 
	gg‹¡_ucc_š¶aû_t
, 
	gucc_d©©y³_t
>;

13 
	g‹m¶©e
 <
şass
 
	gT
>

14 
şass
 
	g‹¡_®ÉßÎv
 : 
public
 
UccCŞlArgs
,…ubliø
	gucc
::
‹¡


16 
public
:

17 
ušt64_t
 
cŞl_mask
;

18 
ušt64_t
 
	gcŞl_æags
;

20 
‹¡_®ÉßÎv
(è: 
cŞl_mask
(0), 
cŞl_æags
(0) {}

21 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
, 
size_t
 
couÁ
,

22 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
 = 
çl£
) {

23 
buf_couÁ
;

24 
	gùxs
.
»size
(
Årocs
);

26 autØ
	gr
 = 0;„ < 
	gÅrocs
;„++) {

27 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = (ucc_coll_args_t*)

28 
ÿÎoc
(1, (
ucc_cŞl_¬gs_t
));

30 
	gùxs
[
r
] = (
g‹¡_ucc_cŞl_ùx_t
*)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

31 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

33 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_ALLTOALLV
;

34 
	gcŞl
->
	gmask
 = 
cŞl_mask
;

35 
	gcŞl
->
	gæags
 = 
cŞl_æags
;

37 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gmem_ty³
 = 
mem_ty³
;

38 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
*)
m®loc
((
T
è* 
Årocs
);

39 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gd©©y³
 = 
dty³
;

40 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
*)
m®loc
((
T
è* 
Årocs
);

42 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gmem_ty³
 = 
mem_ty³
;

43 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
*)
m®loc
((
T
è* 
Årocs
);

44 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gd©©y³
 = 
dty³
;

45 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
*)
m®loc
((
T
è* 
Årocs
);

47 
	gbuf_couÁ
 = 0;

48 
	gi
 = 0; i < 
	gÅrocs
; i++) {

49 
	g¿nk_couÁ
 = (
Årocs
 + 
r
 - 
i
è* 
couÁ
;

50 ((
	gT
*)
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gcouÁs
)[
i
] = 
¿nk_couÁ
;

51 ((
	gT
*)
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gdi¥Ïûm’ts
)[
i
] = 
buf_couÁ
;

52 
	gbuf_couÁ
 +ğ
¿nk_couÁ
;

55 ((
	gT
*)
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gcouÁs
)[(
r
 + 1è% 
Årocs
] = 0;

56 
	gùxs
[
r
]->
	gš™_buf
 = 
ucc_m®loc
(
buf_couÁ
 * 
ucc_dt_size
(
dty³
), "init buf");

57 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

58 
	gi
 = 0; i < 
	gÅrocs
; i++) {

59 
®ÉßÎx_š™_buf
(
r
, 
i
, (
ušt8_t
*)
ùxs
[r]->
š™_buf
 +

60 ((
T
*)
cŞl
->
¤c
.
šfo_v
.
di¥Ïûm’ts
)[
i
] * 
ucc_dt_size
(
dty³
),

61 ((
T
*)
cŞl
->
¤c
.
šfo_v
.
couÁs
)[
i
] * 
ucc_dt_size
(
dty³
));

63 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

64 
buf_couÁ
 * 
ucc_dt_size
(
dty³
), 
mem_ty³
));

65 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

66 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo_v
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

67 
buf_couÁ
 * 
ucc_dt_size
(
dty³
), 
mem_ty³
,

68 
UCC_MEMORY_TYPE_HOST
));

72 
	gbuf_couÁ
 = 0;

73 
	gi
 = 0; i < 
	gÅrocs
; i++) {

74 
	g¿nk_couÁ
 = (
Årocs
 - 
r
 + 
i
è* 
couÁ
;

75 ((
	gT
*)
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gcouÁs
)[
i
] = 
¿nk_couÁ
;

76 ((
	gT
*)
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
)[
i
] = 
buf_couÁ
;

77 
	gbuf_couÁ
 +ğ
¿nk_couÁ
;

79 ((
	gT
*)
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gcouÁs
)[(
r
 - 1 + 
Årocs
) %‚procs] = 0;

80 
	gùxs
[
r
]->
	grbuf_size
 = 
buf_couÁ
 * 
ucc_dt_size
(
dty³
);

81 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

82 
buf_couÁ
 * 
ucc_dt_size
(
dty³
), 
mem_ty³
));

83 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

84 ià(
	g³rsi¡’t
) {

85 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

86 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

90 
»£t
(
UccCŞlCtxVec
 
ùxs
)

92 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

93 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

94 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo_v
.
bufãr
, 
ùxs
[
r
]->
rbuf_size
, 
mem_ty³
,

98 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

100 
boŞ
 
	g»t
 = 
Œue
;

101 
	g¡d
::
veùÜ
<
ušt8_t
 *> 
d¡s
(
ùxs
.
size
());

103 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

104 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

105 
	gd¡s
[
r
] = (
ušt8_t
 *è
ucc_m®loc
(
ùxs
[r]->
rbuf_size
, "dsts buf");

106 
EXPECT_NE
(
d¡s
[
r
], 
nuÎ±r
);

107 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
[
r
], 
ùxs
[r]->
¬gs
->
d¡
.
šfo_v
.
bufãr
,

108 
ùxs
[
r
]->
rbuf_size
, 
UCC_MEMORY_TYPE_HOST
,

109 
mem_ty³
));

112 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

113 
	gd¡s
[
r
] = (
ušt8_t
 *)(
ùxs
[r]->
¬gs
->
d¡
.
šfo_v
.
bufãr
);

116 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

117 
ucc_cŞl_¬gs_t
* 
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

118 
	gi
 = 0; i < 
	gùxs
.
size
(); i++) {

119 
size_t
 
	g¿nk_size
 = 
ucc_dt_size
(
cŞl
->
d¡
.
šfo_v
.
d©©y³
) *

120 (
size_t
)((
T
*)
cŞl
->
d¡
.
šfo_v
.
couÁs
)[
i
];

121 
size_t
 
	g¿nk_offs
 = 
ucc_dt_size
(
cŞl
->
d¡
.
šfo_v
.
d©©y³
) *

122 (
size_t
)((
T
*)
cŞl
->
d¡
.
šfo_v
.
di¥Ïûm’ts
)[
i
];

123 ià(0 !ğ
®ÉßÎx_v®id©e_buf
(
r
, 
i
, (
ušt8_t
*)
d¡s
[r] +

124 
¿nk_offs
, 
¿nk_size
)) {

125 
	g»t
 = 
çl£
;

130 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

131 
r
 = 0; 
	gr
 < 
	gùxs
.
size
();„++) {

132 
ucc_ä“
(
d¡s
[
r
]);

135  
	g»t
;

137 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

139 
g‹¡_ucc_cŞl_ùx_t
* 
	gùx
 : 
ùxs
) {

140 
ucc_cŞl_¬gs_t
* 
cŞl
 = 
ùx
->
¬gs
;

141 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

142 
ä“
(
cŞl
->
¤c
.
šfo_v
.
couÁs
);

143 
ä“
(
cŞl
->
¤c
.
šfo_v
.
di¥Ïûm’ts
);

144 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
d¡_mc_h—d”
));

145 
ä“
(
cŞl
->
d¡
.
šfo_v
.
couÁs
);

146 
ä“
(
cŞl
->
d¡
.
šfo_v
.
di¥Ïûm’ts
);

147 
ucc_ä“
(
ùx
->
š™_buf
);

148 
ä“
(
cŞl
);

149 
ä“
(
ùx
);

151 
	gùxs
.
ş—r
();

155 
şass
 
	g‹¡_®ÉßÎv_0
 : 
public
 
‹¡_®ÉßÎv
 <
ušt64_t
>,

156 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {};

158 
	$UCC_TEST_P
(
‹¡_®ÉßÎv_0
, 
sšgË
)

160 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

161 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

162 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

163 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

164 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

165 
size
 = 
‹am
->
´ocs
.
	`size
();

166 
UccCŞlCtxVec
 
ùxs
;

168 
cŞl_mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

169 
cŞl_æags
 = 
UCC_COLL_ARGS_FLAG_COUNT_64BIT
 |

170 
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
;

171 
	`£t_š¶aû
(
š¶aû
);

172 
	`SET_MEM_TYPE
(
mem_ty³
);

174 
	`d©a_š™
(
size
, 
dty³
, 1, 
ùxs
, 
çl£
);

175 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

176 
»q
.
	`¡¬t
();

177 
»q
.
	`wa™
();

179 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

180 
	`d©a_fši
(
ùxs
);

181 
	}
}

183 
	$UCC_TEST_P
(
‹¡_®ÉßÎv_0
, 
sšgË_³rsi¡’t
)

185 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

186 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

187 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

188 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

189 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

190 
size
 = 
‹am
->
´ocs
.
	`size
();

191 cÚ¡ 
n_ÿÎs
 = 3;

192 
UccCŞlCtxVec
 
ùxs
;

194 
cŞl_mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

195 
cŞl_æags
 =

196 
UCC_COLL_ARGS_FLAG_COUNT_64BIT
 | 
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
;

197 
	`£t_š¶aû
(
š¶aû
);

198 
	`SET_MEM_TYPE
(
mem_ty³
);

200 
	`d©a_š™
(
size
, 
dty³
, 1, 
ùxs
, 
Œue
);

201 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

203 autØ
i
 = 0; i < 
n_ÿÎs
; i++) {

204 
»q
.
	`¡¬t
();

205 
»q
.
	`wa™
();

206 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

207 
	`»£t
(
ùxs
);

209 
	`d©a_fši
(
ùxs
);

210 
	}
}

212 
şass
 
	g‹¡_®ÉßÎv_1
 : 
public
 
‹¡_®ÉßÎv
 <
ušt32_t
>,

213 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {};

215 
	$UCC_TEST_P
(
‹¡_®ÉßÎv_1
, 
sšgË
)

217 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

218 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

219 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

220 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

221 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

222 
size
 = 
‹am
->
´ocs
.
	`size
();

223 
UccCŞlCtxVec
 
ùxs
;

225 
	`£t_š¶aû
(
š¶aû
);

226 
	`SET_MEM_TYPE
(
mem_ty³
);

228 
	`d©a_š™
(
size
, 
dty³
, 1, 
ùxs
, 
çl£
);

229 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

230 
»q
.
	`¡¬t
();

231 
»q
.
	`wa™
();

233 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

234 
	`d©a_fši
(
ùxs
);

235 
	}
}

237 
INSTANTIATE_TEST_CASE_P
(

238 64, 
‹¡_®ÉßÎv_0
,

239 ::
‹¡šg
::
Combše
(

240 ::
‹¡šg
::
Rªge
(1, 
UccJob
::
nSticT—ms
),

241 #ifdeà
HAVE_CUDA


242 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

243 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

245 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

247 ::
‹¡šg
::
V®ues
Ğ
TEST_NO_INPLACE
),

248 
PREDEFINED_DTYPES
));

251 
INSTANTIATE_TEST_CASE_P
(

252 32, 
‹¡_®ÉßÎv_1
,

253 ::
‹¡šg
::
Combše
(

254 ::
‹¡šg
::
Rªge
(1, 
UccJob
::
nSticT—ms
),

255 #ifdeà
HAVE_CUDA


256 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

257 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

259 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

261 ::
‹¡šg
::
V®ues
Ğ
TEST_NO_INPLACE
),

262 
PREDEFINED_DTYPES
));

264 
şass
 
	g‹¡_®ÉßÎv_2
 : 
public
 
‹¡_®ÉßÎv
<
ušt64_t
>,

265 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {};

267 
şass
 
	g‹¡_®ÉßÎv_3
 : 
public
 
‹¡_®ÉßÎv
<
ušt32_t
>,

268 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {};

270 
şass
 
	g‹¡_®ÉßÎv_®g
 : 
public
 
‹¡_®ÉßÎv
<
ušt32_t
>,

271 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {};

273 
	$UCC_TEST_P
(
‹¡_®ÉßÎv_®g
, 
hybrid
)

275 
n_´ocs
 = 15;

276 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

277 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

278 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

280 
	`ASSERT_NE
(
š¶aû
, 
TEST_INPLACE
);

281 
ucc_job_’v_t
 
’v
 = {{"UCC_CL_BASIC_TUNE", "inf"},

283 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

284 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

285 
UccCŞlCtxVec
 
ùxs
;

287 
	`SET_MEM_TYPE
(
mem_ty³
);

288 
	`d©a_š™
(
n_´ocs
, 
dty³
, 16, 
ùxs
, 
çl£
);

289 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

290 
»q
.
	`¡¬t
();

291 
»q
.
	`wa™
();

293 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

294 
	`d©a_fši
(
ùxs
);

295 
	}
}

297 
	$UCC_TEST_P
(
‹¡_®ÉßÎv_2
, 
muÉË
)

299 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

300 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

301 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

302 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

303 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

305 
cŞl_mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

306 
cŞl_æags
 = 
UCC_COLL_ARGS_FLAG_COUNT_64BIT
 |

307 
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
;

309 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

310 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

311 
size
 = 
‹am
->
´ocs
.
	`size
();

312 
UccCŞlCtxVec
 
ùx
;

314 
this
->
	`£t_š¶aû
(
š¶aû
);

315 
	`SET_MEM_TYPE
(
mem_ty³
);

317 
	`d©a_š™
(
size
, 
dty³
, 1, 
ùx
, 
çl£
);

318 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

319 
ùxs
.
	`push_back
(
ùx
);

321 
UccReq
::
	`¡¬Î
(
»qs
);

322 
UccReq
::
	`wa™®l
(
»qs
);

324 autØ
ùx
 : 
ùxs
) {

325 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

326 
	`d©a_fši
(
ùx
);

328 
	}
}

330 
	$UCC_TEST_P
(
‹¡_®ÉßÎv_3
, 
muÉË
)

332 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

333 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

334 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

335 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

336 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

338 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

339 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

340 
size
 = 
‹am
->
´ocs
.
	`size
();

341 
UccCŞlCtxVec
 
ùx
;

343 
this
->
	`£t_š¶aû
(
š¶aû
);

344 
	`SET_MEM_TYPE
(
mem_ty³
);

346 
	`d©a_š™
(
size
, 
dty³
, 1, 
ùx
, 
çl£
);

347 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

348 
ùxs
.
	`push_back
(
ùx
);

350 
UccReq
::
	`¡¬Î
(
»qs
);

351 
UccReq
::
	`wa™®l
(
»qs
);

353 autØ
ùx
 : 
ùxs
) {

354 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

355 
	`d©a_fši
(
ùx
);

357 
	}
}

359 
INSTANTIATE_TEST_CASE_P
(

360 
®ÉßÎv_®gs
, 
‹¡_®ÉßÎv_®g
,

361 ::
‹¡šg
::
Combše
(

362 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

363 ::
‹¡šg
::
V®ues
(
TEST_NO_INPLACE
),

364 
PREDEFINED_DTYPES
));

366 
INSTANTIATE_TEST_CASE_P
(

367 64, 
‹¡_®ÉßÎv_2
,

368 ::
‹¡šg
::
Combše
(

369 #ifdeà
HAVE_CUDA


370 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

371 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

373 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

375 ::
‹¡šg
::
V®ues
Ğ
TEST_NO_INPLACE
),

376 
PREDEFINED_DTYPES
));

378 
INSTANTIATE_TEST_CASE_P
(

379 32, 
‹¡_®ÉßÎv_3
,

380 ::
‹¡šg
::
Combše
(

381 #ifdeà
HAVE_CUDA


382 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

383 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

385 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

387 ::
‹¡šg
::
V®ues
Ğ
TEST_NO_INPLACE
),

388 
PREDEFINED_DTYPES
));

	@test/gtest/coll/test_barrier.cc

7 
	~"commÚ/‹¡_ucc.h
"

9 şas 
	c‹¡_b¬r›r
 : 
public
 
ucc
::
‹¡


11 
public
:

12 
ucc_cŞl_¬gs_t
 
cŞl
;

13 
	$‹¡_b¬r›r
() {

14 
cŞl
.
mask
 = 0;

15 
cŞl
.
cŞl_ty³
 = 
UCC_COLL_TYPE_BARRIER
;

17 
	}
};

19 
	$UCC_TEST_F
(
‹¡_b¬r›r
, 
sšgË_2´oc
)

21 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticJob
()->
	`ü—‹_‹am
(2);

22 
UccReq
 
	`»q
(
‹am
, &
cŞl
);

23 
»q
.
	`¡¬t
();

24 
»q
.
	`wa™
();

25 
	}
}

27 
	$UCC_TEST_F
(
‹¡_b¬r›r
, 
sšgË_max_´ocs
)

29 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
().
	`back
();

30 
UccReq
 
	`»q
(
‹am
, &
cŞl
);

31 
»q
.
	`¡¬t
();

32 
»q
.
	`wa™
();

33 
	}
}

35 
	$UCC_TEST_F
(
‹¡_b¬r›r
, 
muÉË
)

37 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

38 autØ&
‹am
 : 
UccJob
::
	`g‘SticT—ms
()) {

39 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, &
cŞl
));

41 
UccReq
::
	`¡¬Î
(
»qs
);

42 
UccReq
::
	`wa™®l
(
»qs
);

43 
	}
}

	@test/gtest/coll/test_bcast.cc

6 
	~"commÚ/‹¡_ucc.h
"

7 
	~"uts/ucc_m©h.h
"

9 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<, 
	gucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , >;

10 
usšg
 
	gP¬am_1
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , >;

11 
usšg
 
	gP¬am_2
 = 
¡d
::
tu¶e
<
ucc_memÜy_ty³_t
, 
	gucc_job_’v_t
, , >;

13 
şass
 
	g‹¡_bÿ¡
 : 
public
 
UccCŞlArgs
,…ubliø
	gucc
::
‹¡


15 
´iv©e
:

16 
roÙ
;

17 
	gpublic
:

18 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
, 
size_t
 
couÁ
,

19 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

21 
	gùxs
.
»size
(
Årocs
);

22 autØ
	gr
 = 0;„ < 
	gÅrocs
;„++) {

23 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = (ucc_coll_args_t*)

24 
ÿÎoc
(1, (
ucc_cŞl_¬gs_t
));

26 
	gùxs
[
r
] = (
g‹¡_ucc_cŞl_ùx_t
*)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

27 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

29 
	gcŞl
->
	gmask
 = 0;

30 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_BCAST
;

31 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

32 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
couÁ
;

33 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dty³
;

34 
	gcŞl
->
	groÙ
 = 
roÙ
;

36 
	gùxs
[
r
]->
	grbuf_size
 = 
ucc_dt_size
(
dty³
è* 
couÁ
;

38 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
, ctxs[r]->
rbuf_size
,

39 
mem_ty³
));

40 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

41 ià(
	gr
 =ğ
roÙ
) {

42 
ùxs
[
r
]->
š™_buf
 = 
ucc_m®loc
(ùxs[r]->
rbuf_size
, "init buf");

43 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

44 
ušt8_t
 *
	gsbuf
 = (ušt8_t*)
ùxs
[
r
]->
š™_buf
;

45 
	gi
 = 0; i < 
	gùxs
[
r
]->
	grbuf_size
; i++) {

46 
	gsbuf
[
i
] = (
ušt8_t
)i;

48 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

49 
ùxs
[
r
]->
rbuf_size
, 
mem_ty³
,

50 
UCC_MEMORY_TYPE_HOST
));

52 ià(
	g³rsi¡’t
) {

53 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

54 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

58 
»£t
(
UccCŞlCtxVec
 
ùxs
)

60 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

61 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

62 
size_t
 
	gcouÁ
 = 
cŞl
->
¤c
.
šfo
.
couÁ
;

63 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
¤c
.
šfo
.
d©©y³
;

64 ià(
	gr
 !ğ
roÙ
) {

65 
ş—r_bufãr
(
cŞl
->
¤c
.
šfo
.
bufãr
, 
couÁ
 * 
ucc_dt_size
(
dty³
),

66 
mem_ty³
, 0);

68 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

69 
ùxs
[
r
]->
rbuf_size
, 
mem_ty³
,

70 
UCC_MEMORY_TYPE_HOST
));

75 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

77 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

78 
g‹¡_ucc_cŞl_ùx_t
 *
	gùx
 = 
ùxs
[
r
];

79 
ucc_cŞl_¬gs_t
* 
	gcŞl
 = 
ùx
->
¬gs
;

80 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

81 ià(
	gr
 =ğ
cŞl
->
roÙ
) {

82 
ucc_ä“
(
ùx
->
š™_buf
);

84 
ä“
(
cŞl
);

85 
ä“
(
ùx
);

87 
	gùxs
.
ş—r
();

89 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

91 
boŞ
 
	g»t
 = 
Œue
;

92 
	groÙ
 = 
ùxs
[0]->
¬gs
->
roÙ
;

93 
ušt8_t
 *
	gd¡s
;

95 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

96 
d¡s
 = (
ušt8_t
*è
ucc_m®loc
(
ùxs
[
roÙ
]->
rbuf_size
, "dsts buf");

97 
EXPECT_NE
(
d¡s
, 
nuÎ±r
);

98 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
, 
ùxs
[
roÙ
]->
¬gs
->
¤c
.
šfo
.
bufãr
,

99 
ùxs
[
roÙ
]->
rbuf_size
,

100 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

102 
	gd¡s
 = (
ušt8_t
*)
ùxs
[
roÙ
]->
¬gs
->
¤c
.
šfo
.
bufãr
;

104 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

105 
ucc_cŞl_¬gs_t
* 
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

106 ià(
	gcŞl
->
	groÙ
 =ğ
r
) {

109 
	gi
 = 0; i < 
	gùxs
[
r
]->
	grbuf_size
; i++) {

110 ià((
	gušt8_t
)
	gi
 !ğ
d¡s
[
i
]) {

111 
»t
 = 
çl£
;

116 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

117 
ucc_ä“
(
d¡s
);

119  
	g»t
;

121 
£t_roÙ
(
_roÙ
)

123 
	groÙ
 = 
_roÙ
;

127 
şass
 
	g‹¡_bÿ¡_0
 : 
public
 
‹¡_bÿ¡
,

128 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {};

130 
	$UCC_TEST_P
(
‹¡_bÿ¡_0
, 
sšgË
)

132 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

133 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

134 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

135 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

136 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

137 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

138 
size
 = 
‹am
->
´ocs
.
	`size
();

139 
UccCŞlCtxVec
 
ùxs
;

141 
	`SET_MEM_TYPE
(
mem_ty³
);

142 
	`£t_roÙ
(
roÙ
);

144 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

145 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

146 
»q
.
	`¡¬t
();

147 
»q
.
	`wa™
();

148 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

149 
	`d©a_fši
(
ùxs
);

150 
	}
}

152 
	$UCC_TEST_P
(
‹¡_bÿ¡_0
, 
sšgË_³rsi¡’t
)

154 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

155 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

156 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

157 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

158 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

159 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

160 
size
 = 
‹am
->
´ocs
.
	`size
();

161 cÚ¡ 
n_ÿÎs
 = 3;

162 
UccCŞlCtxVec
 
ùxs
;

164 
	`SET_MEM_TYPE
(
mem_ty³
);

165 
	`£t_roÙ
(
roÙ
);

167 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
Œue
);

168 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

170 autØ
i
 = 0; i < 
n_ÿÎs
; i++) {

171 
»q
.
	`¡¬t
();

172 
»q
.
	`wa™
();

173 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

174 
	`»£t
(
ùxs
);

177 
	`d©a_fši
(
ùxs
);

178 
	}
}

180 
INSTANTIATE_TEST_CASE_P
(

181 , 
‹¡_bÿ¡_0
,

182 ::
‹¡šg
::
Combše
(

183 ::
‹¡šg
::
Rªge
(1, 
UccJob
::
nSticT—ms
),

184 
PREDEFINED_DTYPES
,

185 #ifdeà
HAVE_CUDA


186 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

187 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

189 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

191 ::
‹¡šg
::
V®ues
(1,3,65536),

192 ::
‹¡šg
::
V®ues
(0,1)));

194 
şass
 
	g‹¡_bÿ¡_1
 : 
public
 
‹¡_bÿ¡
,

195 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {};

197 
	$UCC_TEST_P
(
‹¡_bÿ¡_1
, 
muÉË
)

199 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

200 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

201 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

202 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

203 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

204 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

206 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

207 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

208 
size
 = 
‹am
->
´ocs
.
	`size
();

209 
UccCŞlCtxVec
 
ùx
;

211 ià(
size
 =ğ1 && 
roÙ
 > 0) {

216 
	`SET_MEM_TYPE
(
mem_ty³
);

217 
	`£t_roÙ
(
roÙ
);

219 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùx
, 
çl£
);

220 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

221 
ùxs
.
	`push_back
(
ùx
);

223 
UccReq
::
	`¡¬Î
(
»qs
);

224 
UccReq
::
	`wa™®l
(
»qs
);

226 autØ
ùx
 : 
ùxs
) {

227 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

228 
	`d©a_fši
(
ùx
);

230 
	}
}

232 
INSTANTIATE_TEST_CASE_P
(

233 , 
‹¡_bÿ¡_1
,

234 ::
‹¡šg
::
Combše
(

235 
PREDEFINED_DTYPES
,

236 #ifdeà
HAVE_CUDA


237 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

238 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

240 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

242 ::
‹¡šg
::
V®ues
(1,3,65536),

243 ::
‹¡šg
::
V®ues
(0,1)));

245 
şass
 
	g‹¡_bÿ¡_®g
 : 
public
 
‹¡_bÿ¡
,

246 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_2
>

249 
	$UCC_TEST_P
(
‹¡_bÿ¡_®g
,) {

250 cÚ¡ 
ucc_memÜy_ty³_t
 
mt
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

251 cÚ¡ 
ucc_job_’v_t
 
’v
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

252 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

253 cÚ¡ 
n_´ocs
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

254 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

255 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

256 
»³©
 = 1;

257 
UccCŞlCtxVec
 
ùxs
;

259 
	`SET_MEM_TYPE
(
mt
);

260 
roÙ
 = 0;„oÙ < 
n_´ocs
;„oot++) {

261 
this
->
	`£t_roÙ
(
roÙ
);

262 
this
->
	`d©a_š™
(
n_´ocs
, 
UCC_DT_INT8
, 
couÁ
, 
ùxs
, 
çl£
);

263 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

265 autØ
i
 = 0; i < 
»³©
; i++) {

266 
»q
.
	`¡¬t
();

267 
»q
.
	`wa™
();

268 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
));

269 
this
->
	`»£t
(
ùxs
);

271 
this
->
	`d©a_fši
(
ùxs
);

273 
	}
}

275 
ucc_job_’v_t
 
	gtwo_¡•_’v
 = {{"UCC_CL_HIER_TUNE", "bcast:@2step:0-inf:inf"},

277 
ucc_job_’v_t
 
	gdbt_’v
 = {{"UCC_TL_UCP_TUNE", "bcast:@dbt:0-inf:inf"},

279 
ucc_job_’v_t
 
	gcuda_’v
 = {{"UCC_TL_CUDA_TUNE", "bcast:cuda:@0:0-inf:inf"},

281 
ucc_job_’v_t
 
	gho¡_mÿ¡_’v
 = {{"UCC_TLS", "ucp,mlx5"},

288 
ucc_job_’v_t
 
	gho¡_mÿ¡_»l_’v
 = {{"UCC_TLS", "ucp,mlx5"},

296 
ucc_job_’v_t
 
	gcuda_mÿ¡_’v
 = {{"UCC_TLS", "ucp,mlx5"},

303 
ucc_job_’v_t
 
	gcuda_mÿ¡_»l_’v
 = {{"UCC_TLS", "ucp,mlx5"},

311 
INSTANTIATE_TEST_CASE_P
(

312 , 
‹¡_bÿ¡_®g
,

313 ::
‹¡šg
::
Combše
(

314 #ifdeà
HAVE_CUDA


315 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
, 
UCC_MEMORY_TYPE_CUDA
,

316 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

317 ::
‹¡šg
::
V®ues
(
two_¡•_’v
, 
dbt_’v
, 
cuda_’v
, 
ho¡_mÿ¡_’v
, 
ho¡_mÿ¡_»l_’v
,

318 
cuda_mÿ¡_’v
, 
cuda_mÿ¡_»l_’v
),

320 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

321 ::
‹¡šg
::
V®ues
(
two_¡•_’v
, 
dbt_’v
, 
ho¡_mÿ¡_’v
, 
ho¡_mÿ¡_»l_’v
),

323 ::
‹¡šg
::
V®ues
(8, 65536),

324 ::
‹¡šg
::
V®ues
(15, 16)));

	@test/gtest/coll/test_gather.cc

6 
	~"commÚ/‹¡_ucc.h
"

7 
	~"uts/ucc_m©h.h
"

9 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<, 
	gucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , ,

10 
	gg‹¡_ucc_š¶aû_t
>;

11 
usšg
 
	gP¬am_1
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , ,

12 
	gg‹¡_ucc_š¶aû_t
>;

14 
şass
 
	g‹¡_g©h”
 : 
public
 
UccCŞlArgs
,…ubliø
	gucc
::
‹¡
 {

15 
´iv©e
:

16 
roÙ
;

18 
	gpublic
:

19 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
, 
size_t
 
sšgË_¿nk_couÁ
,

20 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

22 
	gùxs
.
»size
(
Årocs
);

23 autØ
	gr
 = 0;„ < 
	gÅrocs
;„++) {

24 
ucc_cŞl_¬gs_t
 *
	gcŞl
 =

25 (
ucc_cŞl_¬gs_t
 *)
ÿÎoc
(1, (ucc_coll_args_t));

26 
	gùxs
[
r
] =

27 (
g‹¡_ucc_cŞl_ùx_t
 *)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

28 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

30 
	gcŞl
->
	gmask
 = 0;

31 
	gcŞl
->
	gæags
 = 0;

32 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_GATHER
;

33 
	gcŞl
->
	groÙ
 = 
roÙ
;

34 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

35 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
sšgË_¿nk_couÁ
;

36 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dty³
;

38 
	gùxs
[
r
]->
	gš™_buf
 =

39 
ucc_m®loc
(
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
, "init buf");

40 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

41 
	gi
 = 0; i < 
sšgË_¿nk_couÁ
 * 
ucc_dt_size
(
dty³
); i++) {

42 
ušt8_t
 *
	g±r
 = (ušt8_ˆ*)
ùxs
[
r
]->
š™_buf
;

43 
	g±r
[
i
] = ((˜+ 
r
) % 256);

46 ià(
	gr
 =ğ
roÙ
) {

47 
cŞl
->
d¡
.
šfo
.
mem_ty³
 = mem_type;

48 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
sšgË_¿nk_couÁ
 * 
Årocs
;

49 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
dty³
;

50 
	gùxs
[
r
]->
	grbuf_size
 =

51 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
 * 
Årocs
;

52 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

53 
ùxs
[
r
]->
rbuf_size
, 
mem_ty³
));

54 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

55 ià(
	gš¶aû
) {

56 
UCC_CHECK
(
ucc_mc_memıy
(

57 (*)((
±rdiff_t
)
cŞl
->
d¡
.
šfo
.
bufãr
 +

58 
r
 * 
sšgË_¿nk_couÁ
 * 
ucc_dt_size
(
dty³
)),

59 
ùxs
[
r
]->
š™_buf
,

60 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
, 
mem_ty³
,

61 
UCC_MEMORY_TYPE_HOST
));

64 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

65 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

66 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
,

67 
mem_ty³
));

68 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

69 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
,

70 
ùxs
[
r
]->
š™_buf
,

71 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
,

72 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

74 ià(
	gš¶aû
) {

75 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

76 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

78 ià(
	g³rsi¡’t
) {

79 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

80 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

84 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

86 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

87 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

88 ià(
	gr
 =ğ
roÙ
) {

89 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
d¡_mc_h—d”
));

91 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

92 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
¤c_mc_h—d”
));

94 
ucc_ä“
(
ùxs
[
r
]->
š™_buf
);

95 
ä“
(
cŞl
);

96 
ä“
(
ùxs
[
r
]);

98 
	gùxs
.
ş—r
();

100 
»£t
(
UccCŞlCtxVec
 
ùxs
)

102 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
roÙ
]->
¬gs
;

103 
size_t
 
	gsšgË_¿nk_couÁ
 = 
cŞl
->
d¡
.
šfo
.
couÁ
 / 
ùxs
.
size
();

104 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
d¡
.
šfo
.
d©©y³
;

105 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo
.
bufãr
,

106 
sšgË_¿nk_couÁ
 * 
ucc_dt_size
(
dty³
è* 
ùxs
.
size
(),

107 
mem_ty³
, 0);

108 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

109 
UCC_CHECK
(
ucc_mc_memıy
(

110 (*)((
±rdiff_t
)
cŞl
->
d¡
.
šfo
.
bufãr
 +

111 
roÙ
 * 
sšgË_¿nk_couÁ
 * 
ucc_dt_size
(
dty³
)),

112 
ùxs
[
roÙ
]->
š™_buf
, 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
,

113 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

116 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

118 
boŞ
 
	g»t
 = 
Œue
;

119 
	groÙ
 = 
ùxs
[0]->
¬gs
->
roÙ
;

120 
size_t
 
	gcouÁ
 = (
ùxs
[
roÙ
])->
¬gs
->
d¡
.
šfo
.
couÁ
;

121 
size_t
 
	gsšgË_¿nk_couÁ
 = 
couÁ
 / 
ùxs
.
size
();

122 
size_t
 
	gdt_size
 = 
ucc_dt_size
(
ùxs
[0]->
¬gs
->
¤c
.
šfo
.
d©©y³
);

123 
ušt8_t
 *
	gd¡s
;

125 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

126 
d¡s
 = (
ušt8_t
 *)
ucc_m®loc
(
couÁ
 * 
dt_size
, "dsts buf");

127 
EXPECT_NE
(
d¡s
, 
nuÎ±r
);

128 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
, 
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo
.
bufãr
,

129 
couÁ
 * 
dt_size
,

130 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

132 
	gd¡s
 = (
ušt8_t
 *)
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo
.
bufãr
;

134 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

135 
	gi
 = 0; i < 
sšgË_¿nk_couÁ
 * 
	gdt_size
; i++) {

136 ià((
	gušt8_t
)((
	gi
 + 
	gr
) % 256) !=

137 
d¡s
[(
r
 * 
sšgË_¿nk_couÁ
 * 
dt_size
 + 
i
)]) {

138 
»t
 = 
çl£
;

143 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

144 
ucc_ä“
(
d¡s
);

146  
	g»t
;

148 
£t_roÙ
(
_roÙ
)

150 
	groÙ
 = 
_roÙ
;

154 
şass
 
	g‹¡_g©h”_0
 : 
public
 
‹¡_g©h”
,

155 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {

158 
	$UCC_TEST_P
(
‹¡_g©h”_0
, 
sšgË
)

160 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

161 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

162 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

163 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

164 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

165 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

166 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

167 
size
 = 
‹am
->
´ocs
.
	`size
();

168 
UccCŞlCtxVec
 
ùxs
;

170 
	`£t_š¶aû
(
š¶aû
);

171 
	`SET_MEM_TYPE
(
mem_ty³
);

172 
	`£t_roÙ
(
roÙ
);

174 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

175 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

176 
»q
.
	`¡¬t
();

177 
»q
.
	`wa™
();

178 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

179 
	`d©a_fši
(
ùxs
);

180 
	}
}

182 
	$UCC_TEST_P
(
‹¡_g©h”_0
, 
sšgË_³rsi¡’t
)

184 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

185 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

186 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

187 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

188 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

189 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

190 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

191 
size
 = 
‹am
->
´ocs
.
	`size
();

192 cÚ¡ 
n_ÿÎs
 = 3;

193 
UccCŞlCtxVec
 
ùxs
;

195 
	`£t_š¶aû
(
š¶aû
);

196 
	`SET_MEM_TYPE
(
mem_ty³
);

197 
	`£t_roÙ
(
roÙ
);

199 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
Œue
);

200 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

202 autØ
i
 = 0; i < 
n_ÿÎs
; i++) {

203 
»q
.
	`¡¬t
();

204 
»q
.
	`wa™
();

205 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

206 
	`»£t
(
ùxs
);

209 
	`d©a_fši
(
ùxs
);

210 
	}
}

212 
INSTANTIATE_TEST_CASE_P
(

213 , 
‹¡_g©h”_0
,

214 ::
‹¡šg
::
Combše
(::‹¡šg::
Rªge
(1, 
UccJob
::
nSticT—ms
),

215 
PREDEFINED_DTYPES
,

216 #ifdeà
HAVE_CUDA


217 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
,

218 
UCC_MEMORY_TYPE_CUDA
,

219 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

221 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

223 ::
‹¡šg
::
V®ues
(1, 3, 8192),

224 ::
‹¡šg
::
V®ues
(0, 1),

225 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

227 
şass
 
	g‹¡_g©h”_1
 : 
public
 
‹¡_g©h”
,

228 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {

231 
	$UCC_TEST_P
(
‹¡_g©h”_1
, 
muÉË_ho¡
)

233 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

234 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

235 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

236 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

237 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

238 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

239 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

241 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

242 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

243 
size
 = 
‹am
->
´ocs
.
	`size
();

244 
UccCŞlCtxVec
 
ùx
;

246 ià(
size
 =ğ1 && 
roÙ
 > 0) {

251 
this
->
	`£t_š¶aû
(
š¶aû
);

252 
	`SET_MEM_TYPE
(
mem_ty³
);

253 
	`£t_roÙ
(
roÙ
);

255 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùx
, 
çl£
);

256 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

257 
ùxs
.
	`push_back
(
ùx
);

259 
UccReq
::
	`¡¬Î
(
»qs
);

260 
UccReq
::
	`wa™®l
(
»qs
);

262 autØ
ùx
 : 
ùxs
) {

263 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

264 
	`d©a_fši
(
ùx
);

266 
	}
}

268 
INSTANTIATE_TEST_CASE_P
(

269 , 
‹¡_g©h”_1
,

270 ::
‹¡šg
::
Combše
(
PREDEFINED_DTYPES
,

271 #ifdeà
HAVE_CUDA


272 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
,

273 
UCC_MEMORY_TYPE_CUDA
,

274 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

276 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

278 ::
‹¡šg
::
V®ues
(1, 3, 8192),

279 ::
‹¡šg
::
V®ues
(0, 1),

280 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

	@test/gtest/coll/test_gatherv.cc

6 
	~"commÚ/‹¡_ucc.h
"

7 
	~"uts/ucc_m©h.h
"

9 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<, 
	gucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , ,

10 
	gg‹¡_ucc_š¶aû_t
>;

11 
usšg
 
	gP¬am_1
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , ,

12 
	gg‹¡_ucc_š¶aû_t
>;

14 
şass
 
	g‹¡_g©h”v
 : 
public
 
UccCŞlArgs
,…ubliø
	gucc
::
‹¡
 {

15 
´iv©e
:

16 
roÙ
;

18 
	gpublic
:

19 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
, 
size_t
 
couÁ
,

20 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

22 
ucc_cŞl_¬gs_t
 *
	gcŞl
;

23 *
	gcouÁs
, *
	gdi¥ls
;

24 
size_t
 
	gmy_couÁ
, 
	g®l_couÁs
;

25 
	gùxs
.
»size
(
Årocs
);

26 autØ
	gr
 = 0;„ < 
	gÅrocs
;„++) {

27 
	gcŞl
 = (
ucc_cŞl_¬gs_t
 *)
ÿÎoc
(1, (ucc_coll_args_t));

28 
	gmy_couÁ
 = (
Årocs
 - 
r
è* 
couÁ
;

29 
	gùxs
[
r
] =

30 (
g‹¡_ucc_cŞl_ùx_t
 *)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

31 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

32 
	gcŞl
->
	gmask
 = 0;

33 
	gcŞl
->
	gæags
 = 0;

34 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_GATHERV
;

35 
	gcŞl
->
	groÙ
 = 
roÙ
;

36 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

37 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
my_couÁ
;

38 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dty³
;

40 
	gùxs
[
r
]->
	gš™_buf
 =

41 
ucc_m®loc
(
ucc_dt_size
(
dty³
è* 
my_couÁ
, "init buf");

42 
ASSERT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

43 
	gi
 = 0; i < 
my_couÁ
 * 
ucc_dt_size
(
dty³
); i++) {

44 
ušt8_t
 *
	gsbuf
 = (ušt8_ˆ*)
ùxs
[
r
]->
š™_buf
;

45 
	gsbuf
[
i
] = ((˜+ 
r
) % 256);

48 ià(
	gr
 =ğ
roÙ
) {

49 
®l_couÁs
 = 0;

50 
	gcouÁs
 = (*)
m®loc
((è* 
Årocs
);

51 
ASSERT_NE
(
couÁs
, 
nuÎ±r
);

52 
	gdi¥ls
 = (*)
m®loc
((è* 
Årocs
);

53 
ASSERT_NE
(
di¥ls
, 
nuÎ±r
);

55 
	gi
 = 0; i < 
	gÅrocs
; i++) {

56 
	gcouÁs
[
i
] = (
Årocs
 - iè* 
couÁ
;

57 
	gdi¥ls
[
i
] = 
®l_couÁs
;

58 
	g®l_couÁs
 +ğ
couÁs
[
i
];

61 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gmem_ty³
 = 
mem_ty³
;

62 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
 *)
couÁs
;

63 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
 *)
di¥ls
;

64 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gd©©y³
 = 
dty³
;

66 
	gùxs
[
r
]->
	grbuf_size
 = 
ucc_dt_size
(
dty³
è* 
®l_couÁs
;

67 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

68 
ùxs
[
r
]->
rbuf_size
, 
mem_ty³
));

69 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

70 ià(
	gš¶aû
) {

71 
UCC_CHECK
(
ucc_mc_memıy
(

72 (*)((
±rdiff_t
)
cŞl
->
d¡
.
šfo_v
.
bufãr
 +

73 
di¥ls
[
r
] * 
ucc_dt_size
(
dty³
)),

74 
ùxs
[
r
]->
š™_buf
,

75 
ucc_dt_size
(
dty³
è* 
my_couÁ
, 
mem_ty³
,

76 
UCC_MEMORY_TYPE_HOST
));

79 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

80 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

81 
ucc_dt_size
(
dty³
è* 
my_couÁ
,

82 
mem_ty³
));

83 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

84 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
,

85 
ùxs
[
r
]->
š™_buf
,

86 
ucc_dt_size
(
dty³
è* 
my_couÁ
,

87 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

89 ià(
	gš¶aû
) {

90 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

91 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

93 ià(
	g³rsi¡’t
) {

94 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

95 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

99 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

101 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

102 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

103 ià(
	gr
 =ğ
roÙ
) {

104 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
d¡_mc_h—d”
));

105 
ä“
(
cŞl
->
d¡
.
šfo_v
.
couÁs
);

106 
ä“
(
cŞl
->
d¡
.
šfo_v
.
di¥Ïûm’ts
);

108 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

109 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
¤c_mc_h—d”
));

111 
ucc_ä“
(
ùxs
[
r
]->
š™_buf
);

112 
ä“
(
cŞl
);

113 
ä“
(
ùxs
[
r
]);

115 
	gùxs
.
ş—r
();

117 
»£t
(
UccCŞlCtxVec
 
ùxs
)

119 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
roÙ
]->
¬gs
;

120 
size_t
 
	gmy_couÁ
 = 
cŞl
->
¤c
.
šfo
.
couÁ
;

121 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
d¡
.
šfo_v
.
d©©y³
;

122 * 
	gdi¥ls
 = (*)
cŞl
->
d¡
.
šfo_v
.
di¥Ïûm’ts
;

124 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo_v
.
bufãr
, 
ùxs
[
roÙ
]->
rbuf_size
,

125 
mem_ty³
, 0);

126 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

127 
UCC_CHECK
(
ucc_mc_memıy
(

128 (*)((
±rdiff_t
)
cŞl
->
d¡
.
šfo_v
.
bufãr
 +

129 
di¥ls
[
roÙ
] * 
ucc_dt_size
(
dty³
)),

130 
ùxs
[
roÙ
]->
š™_buf
, 
ucc_dt_size
(
dty³
è* 
my_couÁ
,

131 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

134 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

136 
boŞ
 
	g»t
 = 
Œue
;

137 
	groÙ
 = 
ùxs
[0]->
¬gs
->
roÙ
;

138 *
	gdi¥ls
 = (*)
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo_v
.
di¥Ïûm’ts
;

139 
size_t
 
	gdt_size
 = 
ucc_dt_size
(
ùxs
[
roÙ
]->
¬gs
->
¤c
.
šfo
.
d©©y³
);

140 
ucc_couÁ_t
 
	gmy_couÁ
;

141 
ušt8_t
 *
	gd¡s
;

143 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

144 
d¡s
 = (
ušt8_t
 *)
ucc_m®loc
(
ùxs
[
roÙ
]->
rbuf_size
, "dsts buf");

145 
ucc_as£¹
(
d¡s
 !ğ
nuÎ±r
);

146 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
, 
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo_v
.
bufãr
,

147 
ùxs
[
roÙ
]->
rbuf_size
,

148 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

150 
	gd¡s
 = (
ušt8_t
 *)
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo_v
.
bufãr
;

153 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

154 
	gmy_couÁ
 = 
ùxs
[
r
]->
¬gs
->
¤c
.
šfo
.
couÁ
;

155 
	gi
 = 0; i < 
my_couÁ
 * 
	gdt_size
; i++) {

156 ià((
	gušt8_t
)((
	gi
 + 
	gr
) % 256) !=

157 
d¡s
[(
di¥ls
[
r
] * 
dt_size
 + 
i
)]) {

158 
»t
 = 
çl£
;

164 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

165 
ucc_ä“
(
d¡s
);

167  
	g»t
;

169 
£t_roÙ
(
_roÙ
)

171 
	groÙ
 = 
_roÙ
;

175 
şass
 
	g‹¡_g©h”v_0
 : 
public
 
‹¡_g©h”v
,

176 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {

179 
	$UCC_TEST_P
(
‹¡_g©h”v_0
, 
sšgË
)

181 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

182 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

183 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

184 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

185 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

186 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

187 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

188 
size
 = 
‹am
->
´ocs
.
	`size
();

189 
UccCŞlCtxVec
 
ùxs
;

191 ià(
size
 <ğ
roÙ
) {

192 
	`GTEST_SKIP
();

195 
	`£t_š¶aû
(
š¶aû
);

196 
	`SET_MEM_TYPE
(
mem_ty³
);

197 
	`£t_roÙ
(
roÙ
);

199 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

200 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

201 
»q
.
	`¡¬t
();

202 
»q
.
	`wa™
();

203 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

204 
	`d©a_fši
(
ùxs
);

205 
	}
}

207 
	$UCC_TEST_P
(
‹¡_g©h”v_0
, 
sšgË_³rsi¡’t
)

209 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

210 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

211 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

212 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

213 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

214 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

215 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

216 
size
 = 
‹am
->
´ocs
.
	`size
();

217 cÚ¡ 
n_ÿÎs
 = 3;

218 
UccCŞlCtxVec
 
ùxs
;

220 ià(
size
 <ğ
roÙ
) {

221 
	`GTEST_SKIP
();

224 
	`£t_š¶aû
(
š¶aû
);

225 
	`SET_MEM_TYPE
(
mem_ty³
);

226 
	`£t_roÙ
(
roÙ
);

228 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
Œue
);

229 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

231 autØ
i
 = 0; i < 
n_ÿÎs
; i++) {

232 
»q
.
	`¡¬t
();

233 
»q
.
	`wa™
();

234 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

235 
	`»£t
(
ùxs
);

238 
	`d©a_fši
(
ùxs
);

239 
	}
}

241 
INSTANTIATE_TEST_CASE_P
(

242 , 
‹¡_g©h”v_0
,

243 ::
‹¡šg
::
Combše
(::‹¡šg::
Rªge
(1, 
UccJob
::
nSticT—ms
),

244 
PREDEFINED_DTYPES
,

245 #ifdeà
HAVE_CUDA


246 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
,

247 
UCC_MEMORY_TYPE_CUDA
,

248 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

250 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

252 ::
‹¡šg
::
V®ues
(1, 3, 8192),

253 ::
‹¡šg
::
V®ues
(0, 1),

254 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

256 
şass
 
	g‹¡_g©h”v_1
 : 
public
 
‹¡_g©h”v
,

257 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {

260 
	$UCC_TEST_P
(
‹¡_g©h”v_1
, 
muÉË_ho¡
)

262 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

263 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

264 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

265 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

266 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

267 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

268 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

270 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

271 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

272 
size
 = 
‹am
->
´ocs
.
	`size
();

273 
UccCŞlCtxVec
 
ùx
;

275 ià(
size
 <ğ
roÙ
) {

280 
this
->
	`£t_š¶aû
(
š¶aû
);

281 
	`SET_MEM_TYPE
(
mem_ty³
);

282 
	`£t_roÙ
(
roÙ
);

284 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùx
, 
çl£
);

285 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

286 
ùxs
.
	`push_back
(
ùx
);

288 
UccReq
::
	`¡¬Î
(
»qs
);

289 
UccReq
::
	`wa™®l
(
»qs
);

291 autØ
ùx
 : 
ùxs
) {

292 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

293 
	`d©a_fši
(
ùx
);

295 
	}
}

297 
INSTANTIATE_TEST_CASE_P
(

298 , 
‹¡_g©h”v_1
,

299 ::
‹¡šg
::
Combše
(
PREDEFINED_DTYPES
,

300 #ifdeà
HAVE_CUDA


301 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
,

302 
UCC_MEMORY_TYPE_CUDA
,

303 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

305 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

307 ::
‹¡šg
::
V®ues
(1, 3, 8192),

308 ::
‹¡šg
::
V®ues
(0, 1),

309 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

	@test/gtest/coll/test_reduce.cc

7 
	~"cÜe/‹¡_mc_»duû.h
"

8 
	~"commÚ/‹¡_ucc.h
"

9 
	~"uts/ucc_m©h.h
"

11 
	~<¬¿y
>

13 
	g‹m¶©e
<
ty³Çme
 
	gT
>

14 
şass
 
	g‹¡_»duû
 : 
public
 
UccCŞlArgs
,…ubliø
	g‹¡šg
::
Te¡
 {

15 
´iv©e
:

16 
roÙ
 = 0;

17 
	gpublic
:

18 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dt
, 
size_t
 
couÁ
,

19 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

21 
	gùxs
.
»size
(
Årocs
);

22 
	gr
 = 0;„ < 
	gÅrocs
;„++) {

23 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = (ucc_coll_args_t*)

24 
ÿÎoc
(1, (
ucc_cŞl_¬gs_t
));

26 
	gùxs
[
r
] = (
g‹¡_ucc_cŞl_ùx_t
*)
ÿÎoc
(1,

27 (
g‹¡_ucc_cŞl_ùx_t
));

28 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

29 
	gùxs
[
r
]->
	gš™_buf
 = 
ucc_m®loc
(
ucc_dt_size
(
dt
è* 
couÁ
,

31 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

32 
	gi
 = 0; i < 
	gcouÁ
; i++) {

33 
ty³Çme
 
	gT
::
ty³
 * 
±r
;

34 
	g±r
 = (
ty³Çme
 
T
::
ty³
 *)
ùxs
[
r
]->
š™_buf
;

40 
	g±r
[
i
] = (
ty³Çme
 
T
::
ty³
)((˜+ 
r
 + 1) % 8);

43 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_REDUCE
;

44 
	gcŞl
->
	gİ
 = 
T
::
»dİ
;

45 
	gcŞl
->
	groÙ
 = 
roÙ
;

46 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

47 
cŞl
->
¤c
.
šfo
.
mem_ty³
 = mem_type;

48 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
couÁ
;

49 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dt
;

50 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

51 
ucc_dt_size
(
dt
è* 
couÁ
, 
mem_ty³
));

52 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

53 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
,

54 
ùxs
[
r
]->
š™_buf
,

55 
ucc_dt_size
(
dt
è* 
couÁ
, 
mem_ty³
,

56 
UCC_MEMORY_TYPE_HOST
));

58 ià(
	gr
 =ğ
roÙ
) {

59 
cŞl
->
d¡
.
šfo
.
mem_ty³
 = mem_type;

60 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
couÁ
;

61 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
dt
;

62 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

63 
ucc_dt_size
(
dt
è* 
couÁ
, 
mem_ty³
));

64 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

65 ià(
	gš¶aû
) {

66 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
d¡
.
šfo
.
bufãr
,

67 
ùxs
[
r
]->
š™_buf
, 
ucc_dt_size
(
dt
è* 
couÁ
,

68 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

71 ià(
	gš¶aû
) {

72 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

73 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

75 ià(
	g³rsi¡’t
) {

76 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

77 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

81 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
) {

82 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

83 
ucc_cŞl_¬gs_t
* 
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

84 ià(
	gr
 =ğ
roÙ
) {

85 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
d¡_mc_h—d”
));

87 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

88 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
¤c_mc_h—d”
));

90 
ucc_ä“
(
ùxs
[
r
]->
š™_buf
);

91 
ä“
(
cŞl
);

92 
ä“
(
ùxs
[
r
]);

94 
	gùxs
.
ş—r
();

96 
»£t
(
UccCŞlCtxVec
 
ùxs
)

98 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
roÙ
]->
¬gs
;

99 
size_t
 
	gcouÁ
 = 
cŞl
->
d¡
.
šfo
.
couÁ
;

100 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
d¡
.
šfo
.
d©©y³
;

101 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo
.
bufãr
, 
couÁ
 * 
ucc_dt_size
(
dty³
),

102 
mem_ty³
, 0);

103 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

104 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
d¡
.
šfo
.
bufãr
,

105 
ùxs
[
roÙ
]->
š™_buf
,

106 
ucc_dt_size
(
dty³
è* 
couÁ
, 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

109 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

111 
size_t
 
	gcouÁ
 = (
ùxs
[0])->
¬gs
->
¤c
.
šfo
.
couÁ
;

112 
ty³Çme
 
	gT
::
ty³
 * 
d¡s
;

114 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

115 
d¡s
 = (
ty³Çme
 
T
::
ty³
 *)

116 
ucc_m®loc
(
couÁ
 * (
ty³Çme
 
T
::
ty³
), "dsts buf");

117 
EXPECT_NE
(
d¡s
, 
nuÎ±r
);

118 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
, 
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo
.
bufãr
,

119 
couÁ
 * (
ty³Çme
 
T
::
ty³
),

120 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

122 
	gd¡s
 = (
ty³Çme
 
T
::
ty³
 *)
ùxs
[
roÙ
]->
¬gs
->
d¡
.
šfo
.
bufãr
;

124 
	gi
 = 0; i < 
	gcouÁ
; i++) {

125 
ty³Çme
 
	gT
::
ty³
 
»s
 =

126 ((
ty³Çme
 
T
::
ty³
 *)((
ùxs
[0])->
š™_buf
))[
i
];

127 
	gr
 = 1;„ < 
	gùxs
.
size
();„++) {

128 
	g»s
 = 
T
::
do_İ
(
»s
,

129 ((
ty³Çme
 
T
::
ty³
 *)((
ùxs
[
r
])->
š™_buf
))[
i
]);

131 ià(
	gT
::
»dİ
 =ğ
UCC_OP_AVG
) {

132 ià(
T
::
dt
 =ğ
UCC_DT_BFLOAT16
){

133 
æßt32tobæßt16
(
bæßt16toæßt32
(&
»s
è/ ()
ùxs
.
size
(),

134 &
»s
);

136 
	g»s
 = 
»s
 / (
ty³Çme
 
T
::
ty³
)
ùxs
.
size
();

139 
	gT
::
as£¹_equ®
(
»s
, 
d¡s
[
i
]);

141 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

142 
ucc_ä“
(
d¡s
);

144  
	gŒue
;

148 
	g‹m¶©e
<
ty³Çme
 
	gT
>

149 
şass
 
	g‹¡_»duû_ho¡
 : 
public
 
‹¡_»duû
<
T
> {};

151 
	g‹m¶©e
<
ty³Çme
 
	gT
>

152 
şass
 
	g‹¡_»duû_cuda
 : 
public
 
‹¡_»duû
<
T
> {};

154 
TYPED_TEST_CASE
(
‹¡_»duû_ho¡
, 
CŞlReduûTy³OpsHo¡
);

155 
TYPED_TEST_CASE
(
‹¡_»duû_cuda
, 
CŞlReduûTy³OpsCuda
);

157 
	#TEST_DECLARE
(
_mem_ty³
, 
_š¶aû
, 
_»³©
, 
_³rsi¡’t
) \

159 
¡d
::
¬¿y
<, 3> 
couÁs
{4, 256, 65536}; \

160 
	`CHECK_TYPE_OP_SKIP
(
Ty³P¬am
::
dt
, Ty³P¬am::
»dİ
, 
_mem_ty³
); \

161 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) { \

162 
couÁ
 : 
couÁs
) { \

163 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
]; \

164 
size
 = 
‹am
->
´ocs
.
	`size
(); \

165 
UccCŞlCtxVec
 
ùxs
; \

166 
	`SET_MEM_TYPE
(
_mem_ty³
); \

167 
this
->
	`£t_š¶aû
(
_š¶aû
); \

168 
this
->
	`d©a_š™
(
size
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, 
_³rsi¡’t
);\

169 
UccReq
 
	`»q
(
‹am
, 
ùxs
); \

170 
	`CHECK_REQ_NOT_SUPPORTED_SKIP
(
»q
, 
this
->
	`d©a_fši
(
ùxs
)); \

171 autØ
i
 = 0; i < 
_»³©
; i++) { \

172 
»q
.
	`¡¬t
(); \

173 
»q
.
	`wa™
(); \

174 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
)); \

175 
this
->
	`»£t
(
ùxs
); \

177 
this
->
	`d©a_fši
(
ùxs
); \

180 }

	)

182 
	$TYPED_TEST
(
‹¡_»duû_ho¡
, 
sšgË
) {

183 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
, 1, 0);

184 
	}
}

186 
	$TYPED_TEST
(
‹¡_»duû_ho¡
, 
sšgË_³rsi¡’t
) {

187 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
, 3, 1);

188 
	}
}

190 
	$TYPED_TEST
(
‹¡_»duû_ho¡
, 
sšgË_š¶aû
) {

191 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
, 1, 0);

192 
	}
}

194 
	$TYPED_TEST
(
‹¡_»duû_ho¡
, 
sšgË_³rsi¡’t_š¶aû
) {

195 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
, 3, 1);

196 
	}
}

198 #ifdeà
HAVE_CUDA


199 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
sšgË
) {

200 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
, 1, 0);

201 
	}
}

203 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
sšgË_³rsi¡’t
) {

204 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
, 3, 1);

205 
	}
}

206 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
sšgË_š¶aû
) {

207 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
, 1, 0);

208 
	}
}

210 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
sšgË_³rsi¡’t_š¶aû
) {

211 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
, 3, 1);

212 
	}
}

213 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
sšgË_mªaged
) {

214 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
, 1, 0);

215 
	}
}

217 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
sšgË_³rsi¡’t_mªaged
) {

218 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
, 3, 1);

219 
	}
}

220 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
sšgË_š¶aû_mªaged
) {

221 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
, 1, 0);

222 
	}
}

224 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
sšgË_³rsi¡’t_š¶aû_mªaged
) {

225 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
, 3, 1);

226 
	}
}

229 
	#TEST_DECLARE_MULTIPLE
(
_mem_ty³
, 
_š¶aû
) \

231 
¡d
::
¬¿y
<, 3> 
couÁs
{4, 256, 65536}; \

232 
	`CHECK_TYPE_OP_SKIP
(
Ty³P¬am
::
dt
, Ty³P¬am::
»dİ
, 
_mem_ty³
); \

233 
couÁ
 : 
couÁs
) { \

234 
¡d
::
veùÜ
<
UccReq
> 
»qs
; \

235 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
; \

236 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) { \

237 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
]; \

238 
size
 = 
‹am
->
´ocs
.
	`size
(); \

239 
UccCŞlCtxVec
 
ùx
; \

240 
this
->
	`£t_š¶aû
(
_š¶aû
); \

241 
	`SET_MEM_TYPE
(
_mem_ty³
); \

242 
this
->
	`d©a_š™
(
size
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùx
, 
çl£
); \

243 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
)); \

244 
	`CHECK_REQ_NOT_SUPPORTED_SKIP
(
»qs
.
	`back
(), \

245 
	`DATA_FINI_ALL
(
this
, 
ùxs
)); \

246 
ùxs
.
	`push_back
(
ùx
); \

248 
UccReq
::
	`¡¬Î
(
»qs
); \

249 
UccReq
::
	`wa™®l
(
»qs
); \

250 autØ
ùx
 : 
ùxs
) { \

251 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùx
)); \

252 
this
->
	`d©a_fši
(
ùx
); \

255 }

	)

257 
	$TYPED_TEST
(
‹¡_»duû_ho¡
, 
muÉË
) {

258 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
);

259 
	}
}

261 
	$TYPED_TEST
(
‹¡_»duû_ho¡
, 
muÉË_š¶aû
) {

262 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
);

263 
	}
}

265 #ifdeà
HAVE_CUDA


266 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
muÉË
) {

267 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
);

268 
	}
}

269 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
muÉË_š¶aû
) {

270 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
);

271 
	}
}

272 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
muÉË_mªaged
) {

273 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
);

274 
	}
}

275 
	$TYPED_TEST
(
‹¡_»duû_cuda
, 
muÉË_š¶aû_mªaged
) {

276 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
);

277 
	}
}

280 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	g‹¡_»duû_avg_Üd”
 : 
public
 
‹¡_»duû
<
T
> {

283 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	g‹¡_»duû_dbt
 : 
public
 
‹¡_»duû
<
T
> {

286 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	g‹¡_»duû_2¡•
 : 
public
 
‹¡_»duû
<
T
> {

289 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	g‹¡_»duû_¤g
 : 
public
 
‹¡_»duû
<
T
> {

292 
	#TEST_DECLARE_WITH_ENV
(
_’v
, 
_n_´ocs
, 
_³rsi¡’t
) \

294 
UccJob
 
	`job
(
_n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
_’v
); \

295 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
_n_´ocs
); \

296 
»³©
 = 
_³rsi¡’t
 ? 3 : 1; \

297 
UccCŞlCtxVec
 
ùxs
; \

298 
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mt
 = {
UCC_MEMORY_TYPE_HOST
}; \

299 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) { \

300 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA
); \

302 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA_MANAGED
)) { \

303 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA_MANAGED
); \

305 autØ
couÁ
 : {5, 256, 65536}) { \

306 autØ
š¶aû
 : {
TEST_NO_INPLACE
, 
TEST_INPLACE
}) { \

307 autØ
m
 : 
mt
) { \

308 
	`CHECK_TYPE_OP_SKIP
(
Ty³P¬am
::
dt
, Ty³P¬am::
»dİ
, 
m
); \

309 
	`SET_MEM_TYPE
(
m
); \

310 
this
->
	`£t_š¶aû
(
š¶aû
); \

311 
this
->
	`d©a_š™
(
_n_´ocs
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, \

312 
_³rsi¡’t
); \

313 
UccReq
 
	`»q
(
‹am
, 
ùxs
); \

314 
	`CHECK_REQ_NOT_SUPPORTED_SKIP
(
»q
, 
this
->
	`d©a_fši
(
ùxs
)); \

315 autØ
i
 = 0; i < 
»³©
; i++) { \

316 
»q
.
	`¡¬t
(); \

317 
»q
.
	`wa™
(); \

318 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
)); \

319 
this
->
	`»£t
(
ùxs
); \

321 
this
->
	`d©a_fši
(
ùxs
); \

325 }

	)

327 
TYPED_TEST_CASE
(
‹¡_»duû_avg_Üd”
, 
CŞlReduûTy³OpsAvg
);

328 
TYPED_TEST_CASE
(
‹¡_»duû_dbt
, 
CŞlReduûTy³OpsHo¡
);

329 
TYPED_TEST_CASE
(
‹¡_»duû_2¡•
, 
CŞlReduûTy³OpsHo¡
);

330 
TYPED_TEST_CASE
(
‹¡_»duû_¤g
, 
CŞlReduûTy³OpsHo¡
);

332 
ucc_job_’v_t
 
	gpo¡_İ_’v
 = {{"UCC_TL_UCP_REDUCE_AVG_PRE_OP", "0"}};

333 
ucc_job_’v_t
 
	g»duû_dbt_’v
 = {{"UCC_TL_UCP_TUNE", "reduce:@dbt:0-inf:inf"},

335 
ucc_job_’v_t
 
	g»duû_2¡•_’v
 = {{"UCC_CL_HIER_TUNE", "reduce:@2step:0-inf:inf"},

337 
ucc_job_’v_t
 
	g»duû_¤g_’v
 = {{"UCC_TL_UCP_TUNE", "reduce:@srg:0-inf:inf"},

339 
	$TYPED_TEST
(
‹¡_»duû_avg_Üd”
, 
avg_po¡_İ
) {

340 
	`TEST_DECLARE_WITH_ENV
(
po¡_İ_’v
, 15, 
Œue
);

341 
	}
}

343 
	$TYPED_TEST
(
‹¡_»duû_dbt
, 
»duû_dbt_shiá
) {

344 
	`TEST_DECLARE_WITH_ENV
(
»duû_dbt_’v
, 15, 
Œue
);

345 
	}
}

347 
	$TYPED_TEST
(
‹¡_»duû_dbt
, 
»duû_dbt_mœrÜ
) {

348 
	`TEST_DECLARE_WITH_ENV
(
»duû_dbt_’v
, 16, 
Œue
);

349 
	}
}

351 
	$TYPED_TEST
(
‹¡_»duû_2¡•
, 2
¡•
) {

352 
	`TEST_DECLARE_WITH_ENV
(
»duû_2¡•_’v
, 16, 
çl£
);

353 
	}
}

355 
	$TYPED_TEST
(
‹¡_»duû_¤g
, 
¤g
) {

356 
	`TEST_DECLARE_WITH_ENV
(
»duû_¤g_’v
, 15, 
çl£
);

357 
	}
}

	@test/gtest/coll/test_reduce_scatter.cc

7 
	~"cÜe/‹¡_mc_»duû.h
"

8 
	~"commÚ/‹¡_ucc.h
"

9 
	~"uts/ucc_m©h.h
"

11 
	~<¬¿y
>

13 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

14 
şass
 
	g‹¡_»duû_sÿ‰”
 : 
public
 
UccCŞlArgs
,…ubliø
	g‹¡šg
::
Te¡
 {

15 
public
:

16 
vœtu®
 
Te¡Body
(){};

17 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dt
, 
size_t
 
couÁ
,

18 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

20 
size_t
 
	grcouÁ
;

21 
	gùxs
.
»size
(
Årocs
);

22 ià(
	gcouÁ
 < 
	gÅrocs
) {

23 
	gcouÁ
 = 
Årocs
;

25 
	gcouÁ
 = 
couÁ
 - (couÁ % 
Årocs
);

26 
	grcouÁ
 = 
couÁ
 / 
Årocs
;

27 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

28 
rcouÁ
 = 
couÁ
;

31 
	gr
 = 0;„ < 
	gÅrocs
;„++) {

32 
ucc_cŞl_¬gs_t
 *
	gcŞl
 =

33 (
ucc_cŞl_¬gs_t
 *)
ÿÎoc
(1, (ucc_coll_args_t));

35 
	gùxs
[
r
] =

36 (
g‹¡_ucc_cŞl_ùx_t
 *)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

37 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

39 
	gcŞl
->
	gmask
 = 0;

40 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_REDUCE_SCATTER
;

41 
	gcŞl
->
	gİ
 = 
T
::
»dİ
;

43 
	gùxs
[
r
]->
	gš™_buf
 = 
ucc_m®loc
(
ucc_dt_size
(
dt
è* 
couÁ
, "init buf");

44 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

45 
	gi
 = 0; i < 
	gcouÁ
; i++) {

46 
ty³Çme
 
	gT
::
ty³
 *
±r
;

47 
	g±r
 = (
ty³Çme
 
T
::
ty³
 *)
ùxs
[
r
]->
š™_buf
;

51 
	g±r
[
i
] = (
ty³Çme
 
T
::
ty³
)((˜+ 
r
 + 1) % 8);

54 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

55 
ucc_dt_size
(
dt
è* 
rcouÁ
, 
mem_ty³
));

56 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

57 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
NULL
;

58 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

59 
cŞl
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

60 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

61 
UCC_CHECK
(
ucc_mc_memıy
(

62 
cŞl
->
d¡
.
šfo
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

63 
ucc_dt_size
(
dt
è* 
rcouÁ
, 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

64 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

65 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = 
SIZE_MAX
;

66 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = (
ucc_d©©y³_t
)-1;

68 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

69 
ucc_dt_size
(
dt
è* 
couÁ
, 
mem_ty³
));

70 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

71 
UCC_CHECK
(
ucc_mc_memıy
(

72 
cŞl
->
¤c
.
šfo
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

73 
ucc_dt_size
(
dt
è* 
couÁ
, 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

74 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

75 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
couÁ
;

76 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dt
;

78 
	gcŞl
->
	gd¡
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

79 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
rcouÁ
;

80 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
dt
;

81 ià(
	g³rsi¡’t
) {

82 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

83 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

87 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

89 
g‹¡_ucc_cŞl_ùx_t
 *
	gùx
 : 
ùxs
) {

90 
ucc_cŞl_¬gs_t
 *
cŞl
 = 
ùx
->
¬gs
;

91 ià(
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
) {

92 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

94 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
d¡_mc_h—d”
));

95 
ucc_ä“
(
ùx
->
š™_buf
);

96 
ä“
(
cŞl
);

97 
ä“
(
ùx
);

99 
	gùxs
.
ş—r
();

101 
»£t
(
UccCŞlCtxVec
 
ùxs
)

103 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

104 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

105 
size_t
 
	gcouÁ
 = 
cŞl
->
d¡
.
šfo
.
couÁ
;

106 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
d¡
.
šfo
.
d©©y³
;

107 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo
.
bufãr
, 
couÁ
 * 
ucc_dt_size
(
dty³
),

108 
mem_ty³
, 0);

110 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

111 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
d¡
.
šfo
.
bufãr
,

112 
ùxs
[
r
]->
š™_buf
,

113 
ucc_dt_size
(
dty³
è* 
couÁ
, 
mem_ty³
,

114 
UCC_MEMORY_TYPE_HOST
));

118 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

120 
size_t
 
	gtÙ®_couÁ
, 
	grcouÁ
, 
	goff£t
;

121 
ty³Çme
 
	gT
::
ty³
 *
d¡
, *
	gd¡_p
;

123 ià(
	gTEST_INPLACE
 !ğ
š¶aû
) {

124 
tÙ®_couÁ
 = (
ùxs
[0])->
¬gs
->
¤c
.
šfo
.
couÁ
;

125 
	grcouÁ
 = (
ùxs
[0])->
¬gs
->
d¡
.
šfo
.
couÁ
;

127 
	gtÙ®_couÁ
 = (
ùxs
[0])->
¬gs
->
d¡
.
šfo
.
couÁ
;

128 
	grcouÁ
 = 
tÙ®_couÁ
 / 
ùxs
.
size
();

131 
ucc_as£¹
(
rcouÁ
 * 
ùxs
.
size
(è=ğ
tÙ®_couÁ
);

133 
	gd¡
 = (
ty³Çme
 
T
::
ty³
 *)
ucc_m®loc
(

134 
tÙ®_couÁ
 * (
ty³Çme
 
T
::
ty³
), "dst buf");

135 
	gd¡_p
 = 
d¡
;

136 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

137 
	goff£t
 = (
TEST_INPLACE
 =ğ
š¶aû
)

138 ? 
rcouÁ
 * 
r
 * (
ty³Çme
 
T
::
ty³
)

140 
UCC_CHECK
(
ucc_mc_memıy
(

141 
d¡_p
, 
PTR_OFFSET
(
ùxs
[
r
]->
¬gs
->
d¡
.
šfo
.
bufãr
, 
off£t
),

142 
rcouÁ
 * (
ty³Çme
 
T
::
ty³
), 
UCC_MEMORY_TYPE_HOST
,

143 
mem_ty³
));

144 
	gd¡_p
 +ğ
rcouÁ
;

147 
	gi
 = 0; i < 
	gtÙ®_couÁ
; i++) {

148 
ty³Çme
 
	gT
::
ty³
 
»s
 =

149 ((
ty³Çme
 
T
::
ty³
 *)((
ùxs
[0])->
š™_buf
))[
i
];

150 
	gr
 = 1;„ < 
	gùxs
.
size
();„++) {

151 
	g»s
 = 
T
::
do_İ
(
»s
,

152 ((
ty³Çme
 
T
::
ty³
 *)((
ùxs
[
r
])->
š™_buf
))[
i
]);

154 ià(
	gT
::
»dİ
 =ğ
UCC_OP_AVG
) {

155 
»s
 =„e / (
ty³Çme
 
T
::
ty³
)
ùxs
.
size
();

157 
	gT
::
as£¹_equ®
(
»s
, 
d¡
[
i
]);

159 
ucc_ä“
(
d¡
);

161  
	gŒue
;

165 
	g‹m¶©e
<
ty³Çme
 
	gT
>

166 
şass
 
	g‹¡_»duû_sÿ‰”_ho¡
 : 
public
 
‹¡_»duû_sÿ‰”
<
T
> {};

168 
	g‹m¶©e
<
ty³Çme
 
	gT
>

169 
şass
 
	g‹¡_»duû_sÿ‰”_cuda
 : 
public
 
‹¡_»duû_sÿ‰”
<
T
> {};

171 
TYPED_TEST_CASE
(
‹¡_»duû_sÿ‰”_ho¡
, 
CŞlReduûTy³OpsHo¡
);

172 
TYPED_TEST_CASE
(
‹¡_»duû_sÿ‰”_cuda
, 
CŞlReduûTy³OpsCuda
);

174 
	#TEST_DECLARE
(
_mem_ty³
, 
_š¶aû
, 
_»³©
, 
_³rsi¡’t
) \

176 
¡d
::
¬¿y
<, 1> 
couÁs
{123}; \

177 
	`CHECK_TYPE_OP_SKIP
(
Ty³P¬am
::
dt
, Ty³P¬am::
»dİ
, 
_mem_ty³
); \

178 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) { \

179 
couÁ
 : 
couÁs
) { \

180 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
]; \

181 
size
 = 
‹am
->
´ocs
.
	`size
(); \

182 
UccCŞlCtxVec
 
ùxs
; \

183 
	`SET_MEM_TYPE
(
_mem_ty³
); \

184 
this
->
	`£t_š¶aû
(
_š¶aû
); \

185 
this
->
	`d©a_š™
(
size
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, 
_³rsi¡’t
);\

186 
UccReq
 
	`»q
(
‹am
, 
ùxs
); \

187 
	`CHECK_REQ_NOT_SUPPORTED_SKIP
(
»q
, 
this
->
	`d©a_fši
(
ùxs
)); \

188 autØ
i
 = 0; i < 
_»³©
; i++) { \

189 
»q
.
	`¡¬t
(); \

190 
»q
.
	`wa™
(); \

191 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
)); \

192 
this
->
	`»£t
(
ùxs
); \

194 
this
->
	`d©a_fši
(
ùxs
); \

197 }

	)

199 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_ho¡
, 
sšgË
)

201 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
, 1, 0);

202 
	}
}

204 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_ho¡
, 
sšgË_³rsi¡’t
)

206 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
, 3, 1);

207 
	}
}

209 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_ho¡
, 
sšgË_š¶aû
)

211 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
, 1, 0);

212 
	}
}

214 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_ho¡
, 
sšgË_³rsi¡’t_š¶aû
)

216 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
, 3, 1);

217 
	}
}

219 #ifdeà
HAVE_CUDA


220 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
sšgË
)

222 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
, 1, 0);

223 
	}
}

225 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
sšgË_³rsi¡’t
)

227 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
, 3, 1);

228 
	}
}

230 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
sšgË_š¶aû
)

232 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
, 1, 0);

233 
	}
}

235 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
sšgË_³rsi¡’t_š¶aû
)

237 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
, 3, 1);

238 
	}
}

239 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
sšgË_mªaged
)

241 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
, 1, 0);

242 
	}
}

244 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
sšgË_³rsi¡’t_mªaged
)

246 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
, 3, 1);

247 
	}
}

249 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
sšgË_š¶aû_mªaged
)

251 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
, 1, 0);

252 
	}
}

254 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
sšgË_³rsi¡’t_š¶aû_mªaged
)

256 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
, 3, 1);

257 
	}
}

260 
	#TEST_DECLARE_MULTIPLE
(
_mem_ty³
, 
_š¶aû
) \

262 
¡d
::
¬¿y
<, 3> 
couÁs
{4, 256, 65536}; \

263 
	`CHECK_TYPE_OP_SKIP
(
Ty³P¬am
::
dt
, Ty³P¬am::
»dİ
, 
_mem_ty³
); \

264 
couÁ
 : 
couÁs
) { \

265 
¡d
::
veùÜ
<
UccReq
> 
»qs
; \

266 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
; \

267 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) { \

268 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
]; \

269 
size
 = 
‹am
->
´ocs
.
	`size
(); \

270 
UccCŞlCtxVec
 
ùx
; \

271 
this
->
	`£t_š¶aû
(
_š¶aû
); \

272 
	`SET_MEM_TYPE
(
_mem_ty³
); \

273 
this
->
	`d©a_š™
(
size
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùx
, 
çl£
); \

274 
ùxs
.
	`push_back
(
ùx
); \

275 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
)); \

276 
	`CHECK_REQ_NOT_SUPPORTED_SKIP
(
»qs
.
	`back
(), \

277 
	`DATA_FINI_ALL
(
this
, 
ùxs
)); \

279 
UccReq
::
	`¡¬Î
(
»qs
); \

280 
UccReq
::
	`wa™®l
(
»qs
); \

281 autØ
ùx
 : 
ùxs
) { \

282 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùx
)); \

284 
	`DATA_FINI_ALL
(
this
, 
ùxs
); \

286 }

	)

288 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_ho¡
, 
muÉË
)

290 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
);

291 
	}
}

293 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_ho¡
, 
muÉË_š¶aû
)

295 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
);

296 
	}
}

298 #ifdeà
HAVE_CUDA


299 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
muÉË
)

301 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
);

302 
	}
}

304 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
muÉË_š¶aû
)

306 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
);

307 
	}
}

308 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
muÉË_mªaged
)

310 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
);

311 
	}
}

313 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”_cuda
, 
muÉË_š¶aû_mªaged
)

315 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
);

316 
	}
}

319 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<
ucc_job_’v_t
>;

320 
şass
 
	g‹¡_»duû_sÿ‰”_®g


321 : 
public
 
ucc
::
‹¡
,

322 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {

325 
	$UCC_TEST_P
(
‹¡_»duû_sÿ‰”_®g
,)

327 
‹¡_»duû_sÿ‰”
<
Ty³OpPaœ
<
UCC_DT_INT32
, 
sum
>> 
rs_‹¡
;

328 
n_´ocs
 = 15;

329 cÚ¡ 
ucc_job_’v_t
 
’v
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

330 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

331 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

332 
»³©
 = 3;

333 
UccCŞlCtxVec
 
ùxs
;

334 
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mt
 = {
UCC_MEMORY_TYPE_HOST
};

336 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) {

337 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA
);

339 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA_MANAGED
)) {

340 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA_MANAGED
);

343 autØ
couÁ
 : {65536, 123567}) {

344 autØ
š¶aû
 : {
TEST_NO_INPLACE
, 
TEST_INPLACE
}) {

345 autØ
m
 : 
mt
) {

346 
rs_‹¡
.
	`£t_mem_ty³
(
m
);

347 
rs_‹¡
.
	`£t_š¶aû
(
š¶aû
);

348 
rs_‹¡
.
	`d©a_š™
(
n_´ocs
, 
UCC_DT_INT32
, 
couÁ
, 
ùxs
, 
Œue
);

349 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

351 autØ
i
 = 0; i < 
»³©
; i++) {

352 
»q
.
	`¡¬t
();

353 
»q
.
	`wa™
();

354 
	`EXPECT_EQ
(
Œue
, 
rs_‹¡
.
	`d©a_v®id©e
(
ùxs
));

355 
rs_‹¡
.
	`»£t
(
ùxs
);

357 
rs_‹¡
.
	`d©a_fši
(
ùxs
);

361 
	}
}

363 
ucc_job_’v_t
 
	gršg_unidœ_’v
 = {{"name", "ring_unidirectional"},

368 
ucc_job_’v_t
 
	gršg_bidœ_’v
 = {{"name", "ring_bidirectional"},

373 
ucc_job_’v_t
 
	gknomŸl
 = {{"name", "knomial"},

377 
INSTANTIATE_TEST_CASE_P
(

378 , 
‹¡_»duû_sÿ‰”_®g
,

379 ::
‹¡šg
::
Combše
(

380 ::
‹¡šg
::
V®ues
(
ršg_unidœ_’v
, 
ršg_bidœ_’v
, 
knomŸl
)),

381 [](cÚ¡ 
‹¡šg
::
Te¡P¬amInfo
<
P¬am_0
>& 
šfo
) {

382 cÚ¡ 
ucc_job_’v_t
 
’v
 = 
¡d
::
g‘
<0>(
šfo
.
·¿m
);

383  
’v
[0].
£cÚd
;});

	@test/gtest/coll/test_reduce_scatterv.cc

6 
	~"cÜe/‹¡_mc_»duû.h
"

7 
	~"commÚ/‹¡_ucc.h
"

8 
	~"uts/ucc_m©h.h
"

9 
	~"uts/ucc_cŞl_uts.h
"

10 
	~<¿ndom
>

11 
	~<®gÜ™hm
>

12 
	~<¬¿y
>

14 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

15 
şass
 
	g‹¡_»duû_sÿ‰”v
 : 
public
 
UccCŞlArgs
,…ubliø
	g‹¡šg
::
Te¡
 {

16 
public
:

17 
vœtu®
 
Te¡Body
(){};

20 
	g¡d
::
veùÜ
<
ušt32_t
> 
g’”©e_couÁs
(
Årocs
, 
size_t
 
tÙ®
)

22 
	g¡d
::
deçuÉ_¿ndom_’gše
 
’g
;

23 
	g¡d
::
veùÜ
<
ušt32_t
> 
couÁs
, 
	gtmp
;

24 
	g’g
.
£ed
(123);

25 
	g¡d
::
unifÜm_št_di¡ributiÚ
<> 
urd
(1, 
tÙ®
 - 1);

27 
	gi
 = 0; i < 
	gÅrocs
 - 1; i++) {

28 
	gtmp
.
push_back
(
urd
(
’g
));

30 
	gtmp
.
push_back
(0);

31 
	gtmp
.
push_back
(
tÙ®
);

32 
	g¡d
::
sÜt
(
tmp
.
begš
(),mp.
’d
());

34 
	gi
 = 1; i < 
	gtmp
.
size
(); i++) {

35 
	gcouÁs
.
push_back
(
tmp
[
i
] -mp[i - 1]);

36 
	gtÙ®
 -ğ
couÁs
.
back
();

38 
ucc_as£¹
(
tÙ®
 == 0);

39  
	gcouÁs
;

42 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dt
, 
size_t
 
tÙ®_couÁ
,

43 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

46 
size_t
 
	grcouÁ
 = 
tÙ®_couÁ
;

48 
	gùxs
.
»size
(
Årocs
);

49 autØ
	gcouÁs
 = 
g’”©e_couÁs
(
Årocs
, 
tÙ®_couÁ
);

51 
	gr
 = 0;„ < 
	gÅrocs
;„++) {

52 ià(
	gTEST_INPLACE
 !ğ
š¶aû
) {

53 
rcouÁ
 = 
couÁs
[
r
];

55 
ucc_cŞl_¬gs_t
 *
	gcŞl
 =

56 (
ucc_cŞl_¬gs_t
 *)
ÿÎoc
(1, (ucc_coll_args_t));

58 
	gùxs
[
r
] =

59 (
g‹¡_ucc_cŞl_ùx_t
 *)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

60 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

62 
	gcŞl
->
	gmask
 = 0;

63 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_REDUCE_SCATTERV
;

64 
	gcŞl
->
	gİ
 = 
T
::
»dİ
;

66 
	gùxs
[
r
]->
	gš™_buf
 =

67 
ucc_m®loc
(
ucc_dt_size
(
dt
è* 
tÙ®_couÁ
, "init buf");

68 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

69 
	gi
 = 0; i < 
	gtÙ®_couÁ
; i++) {

70 
ty³Çme
 
	gT
::
ty³
 *
±r
;

71 
	g±r
 = (
ty³Çme
 
T
::
ty³
 *)
ùxs
[
r
]->
š™_buf
;

75 
	g±r
[
i
] = (
ty³Çme
 
T
::
ty³
)((˜+ 
r
 + 1) % 8);

78 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

79 
ucc_dt_size
(
dt
è* 
rcouÁ
, 
mem_ty³
));

80 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

81 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
NULL
;

82 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

83 
cŞl
->
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

84 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

85 
UCC_CHECK
(
ucc_mc_memıy
(

86 
cŞl
->
d¡
.
šfo_v
.
bufãr
, 
ùxs
[
r
]->
š™_buf
,

87 
ucc_dt_size
(
dt
è* 
rcouÁ
, 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

88 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

89 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = 
SIZE_MAX
;

90 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = (
ucc_d©©y³_t
)-1;

92 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

93 
ucc_dt_size
(
dt
è* 
tÙ®_couÁ
,

94 
mem_ty³
));

95 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

96 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
,

97 
ùxs
[
r
]->
š™_buf
,

98 
ucc_dt_size
(
dt
è* 
tÙ®_couÁ
, 
mem_ty³
,

99 
UCC_MEMORY_TYPE_HOST
));

100 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

101 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
tÙ®_couÁ
;

102 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dt
;

104 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gmem_ty³
 = 
mem_ty³
;

105 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gcouÁs
 =

106 (
ucc_couÁ_t
 *)
ucc_m®loc
(
Årocs
 * (
ušt32_t
), "counts");

107 
memıy
(
cŞl
->
d¡
.
šfo_v
.
couÁs
, couÁs.
d©a
(),

108 (
ušt32_t
è* 
Årocs
);

109 
	gcŞl
->
	gd¡
.
	gšfo_v
.
	gd©©y³
 = 
dt
;

110 ià(
	g³rsi¡’t
) {

111 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

112 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

116 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

118 
g‹¡_ucc_cŞl_ùx_t
 *
	gùx
 : 
ùxs
) {

119 
ucc_cŞl_¬gs_t
 *
cŞl
 = 
ùx
->
¬gs
;

120 ià(
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
) {

121 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
¤c_mc_h—d”
));

123 
UCC_CHECK
(
ucc_mc_ä“
(
ùx
->
d¡_mc_h—d”
));

124 
ucc_ä“
(
ùx
->
š™_buf
);

125 
ucc_ä“
(
cŞl
->
d¡
.
šfo_v
.
couÁs
);

126 
ä“
(
cŞl
);

127 
ä“
(
ùx
);

129 
	gùxs
.
ş—r
();

131 
size_t
 
g‘_tÙ®_couÁ
(
UccCŞlCtxVec
 
ùxs
)

133 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[0]->
¬gs
;

135  
ucc_cŞl_¬gs_g‘_tÙ®_couÁ
(
cŞl
, cŞl->
d¡
.
šfo_v
.
couÁs
,

136 
ùxs
.
size
());

139 
»£t
(
UccCŞlCtxVec
 
ùxs
)

141 
size_t
 
	gtÙ®_couÁ
 = 
g‘_tÙ®_couÁ
(
ùxs
);

142 
ušt32_t
 *
	gcouÁs
 = (ušt32_ˆ*)
ùxs
[0]->
¬gs
->
d¡
.
šfo_v
.
couÁs
;

144 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

145 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

146 
ucc_d©©y³_t
 
	gdty³
 = 
cŞl
->
d¡
.
šfo_v
.
d©©y³
;

147 
size_t
 
	grcouÁ
 = (
TEST_INPLACE
 =ğ
š¶aû
è? 
tÙ®_couÁ
 : 
couÁs
[
r
];

149 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo_v
.
bufãr
, 
rcouÁ
 * 
ucc_dt_size
(
dty³
),

150 
mem_ty³
, 0);

152 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

153 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
d¡
.
šfo_v
.
bufãr
,

154 
ùxs
[
r
]->
š™_buf
,

155 
ucc_dt_size
(
dty³
è* 
tÙ®_couÁ
,

156 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

161 
size_t
 
check_off£t
(
UccCŞlCtxVec
 
ùxs
, 
¿nk
)

163 
ušt32_t
 *
	gcouÁs
 = (ušt32_ˆ*)
ùxs
[0]->
¬gs
->
d¡
.
šfo_v
.
couÁs
;

164 
size_t
 
	goff£t
 = 0;

166 ià(
	gTEST_INPLACE
 =ğ
š¶aû
) {

167 
i
 = 0; 
	gi
 < 
	g¿nk
; i++) {

168 
	goff£t
 +ğ
couÁs
[
i
];

172  
off£t
 * (
ty³Çme
 
	gT
::
ty³
);

175 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

177 
size_t
 
	gtÙ®_couÁ
 = 
g‘_tÙ®_couÁ
(
ùxs
);

178 
ušt32_t
 * 
	gcouÁs
 = (ušt32_ˆ*)
ùxs
[0]->
¬gs
->
d¡
.
šfo_v
.
couÁs
;

179 
size_t
 
	grcouÁ
;

180 
ty³Çme
 
	gT
::
ty³
 *
d¡
, *
	gd¡_p
;

182 
	gd¡
 = (
ty³Çme
 
T
::
ty³
 *)
ucc_m®loc
(

183 
tÙ®_couÁ
 * (
ty³Çme
 
T
::
ty³
), "dst buf");

184 
	gd¡_p
 = 
d¡
;

185 
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

186 
	grcouÁ
 = 
couÁs
[
r
];

187 
UCC_CHECK
(
ucc_mc_memıy
(
d¡_p
,

188 
PTR_OFFSET
(
ùxs
[
r
]->
¬gs
->
d¡
.
šfo_v
.
bufãr
,

189 
check_off£t
(
ùxs
, 
r
)),

190 
rcouÁ
 * (
ty³Çme
 
T
::
ty³
),

191 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

192 
	gd¡_p
 +ğ
rcouÁ
;

195 
	gi
 = 0; i < 
	gtÙ®_couÁ
; i++) {

196 
ty³Çme
 
	gT
::
ty³
 
»s
 =

197 ((
ty³Çme
 
T
::
ty³
 *)((
ùxs
[0])->
š™_buf
))[
i
];

198 
	gr
 = 1;„ < 
	gùxs
.
size
();„++) {

199 
	g»s
 = 
T
::
do_İ
(
»s
,

200 ((
ty³Çme
 
T
::
ty³
 *)((
ùxs
[
r
])->
š™_buf
))[
i
]);

202 ià(
	gT
::
»dİ
 =ğ
UCC_OP_AVG
) {

203 
»s
 =„e / (
ty³Çme
 
T
::
ty³
)
ùxs
.
size
();

205 
	gT
::
as£¹_equ®
(
»s
, 
d¡
[
i
]);

207 
ucc_ä“
(
d¡
);

208  
	gŒue
;

212 
	g‹m¶©e
<
ty³Çme
 
	gT
>

213 
şass
 
	g‹¡_»duû_sÿ‰”v_ho¡
 : 
public
 
‹¡_»duû_sÿ‰”v
<
T
> {};

215 
	g‹m¶©e
<
ty³Çme
 
	gT
>

216 
şass
 
	g‹¡_»duû_sÿ‰”v_cuda
 : 
public
 
‹¡_»duû_sÿ‰”v
<
T
> {};

218 
TYPED_TEST_CASE
(
‹¡_»duû_sÿ‰”v_ho¡
, 
CŞlReduûTy³OpsHo¡
);

219 
TYPED_TEST_CASE
(
‹¡_»duû_sÿ‰”v_cuda
, 
CŞlReduûTy³OpsCuda
);

221 
	#TEST_DECLARE
(
_mem_ty³
, 
_š¶aû
, 
_»³©
, 
_³rsi¡’t
) \

223 
¡d
::
¬¿y
<, 3> 
couÁs
{4, 123, 65536}; \

224 
	`CHECK_TYPE_OP_SKIP
(
Ty³P¬am
::
dt
, Ty³P¬am::
»dİ
, 
_mem_ty³
); \

225 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) { \

226 
couÁ
 : 
couÁs
) { \

227 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
]; \

228 
size
 = 
‹am
->
´ocs
.
	`size
(); \

229 
UccCŞlCtxVec
 
ùxs
; \

230 
	`SET_MEM_TYPE
(
_mem_ty³
); \

231 
this
->
	`£t_š¶aû
(
_š¶aû
); \

232 
this
->
	`d©a_š™
(
size
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùxs
, \

233 
_³rsi¡’t
); \

234 
UccReq
 
	`»q
(
‹am
, 
ùxs
); \

235 
	`CHECK_REQ_NOT_SUPPORTED_SKIP
(
»q
, 
this
->
	`d©a_fši
(
ùxs
)); \

236 autØ
i
 = 0; i < 
_»³©
; i++) { \

237 
»q
.
	`¡¬t
(); \

238 
»q
.
	`wa™
(); \

239 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùxs
)); \

240 
this
->
	`»£t
(
ùxs
); \

242 
this
->
	`d©a_fši
(
ùxs
); \

245 }

	)

247 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_ho¡
, 
sšgË
)

249 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
, 1, 0);

250 
	}
}

252 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_ho¡
, 
sšgË_³rsi¡’t
)

254 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
, 3, 1);

255 
	}
}

257 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_ho¡
, 
sšgË_š¶aû
)

259 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
, 1, 0);

260 
	}
}

262 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_ho¡
, 
sšgË_³rsi¡’t_š¶aû
)

264 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
, 3, 1);

265 
	}
}

267 #ifdeà
HAVE_CUDA


268 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
sšgË
)

270 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
, 1, 0);

271 
	}
}

273 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
sšgË_³rsi¡’t
)

275 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
, 3, 1);

276 
	}
}

278 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
sšgË_š¶aû
)

280 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
, 1, 0);

281 
	}
}

283 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
sšgË_³rsi¡’t_š¶aû
)

285 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
, 3, 1);

286 
	}
}

287 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
sšgË_mªaged
)

289 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
, 1, 0);

290 
	}
}

292 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
sšgË_³rsi¡’t_mªaged
)

294 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
, 3, 1);

295 
	}
}

297 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
sšgË_š¶aû_mªaged
)

299 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
, 1, 0);

300 
	}
}

302 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
sšgË_³rsi¡’t_š¶aû_mªaged
)

304 
	`TEST_DECLARE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
, 3, 1);

305 
	}
}

308 
	#TEST_DECLARE_MULTIPLE
(
_mem_ty³
, 
_š¶aû
) \

310 
¡d
::
¬¿y
<, 3> 
couÁs
{4, 123, 65536}; \

311 
	`CHECK_TYPE_OP_SKIP
(
Ty³P¬am
::
dt
, Ty³P¬am::
»dİ
, 
_mem_ty³
); \

312 
couÁ
 : 
couÁs
) { \

313 
¡d
::
veùÜ
<
UccReq
> 
»qs
; \

314 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
; \

315 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) { \

316 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
]; \

317 
size
 = 
‹am
->
´ocs
.
	`size
(); \

318 
UccCŞlCtxVec
 
ùx
; \

319 
this
->
	`£t_š¶aû
(
_š¶aû
); \

320 
	`SET_MEM_TYPE
(
_mem_ty³
); \

321 
this
->
	`d©a_š™
(
size
, 
Ty³P¬am
::
dt
, 
couÁ
, 
ùx
, 
çl£
); \

322 
ùxs
.
	`push_back
(
ùx
); \

323 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
)); \

324 
	`CHECK_REQ_NOT_SUPPORTED_SKIP
(
»qs
.
	`back
(), \

325 
	`DATA_FINI_ALL
(
this
, 
ùxs
)); \

327 
UccReq
::
	`¡¬Î
(
»qs
); \

328 
UccReq
::
	`wa™®l
(
»qs
); \

329 autØ
ùx
 : 
ùxs
) { \

330 
	`EXPECT_EQ
(
Œue
, 
this
->
	`d©a_v®id©e
(
ùx
)); \

332 
	`DATA_FINI_ALL
(
this
, 
ùxs
); \

334 }

	)

336 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_ho¡
, 
muÉË
)

338 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_NO_INPLACE
);

339 
	}
}

341 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_ho¡
, 
muÉË_š¶aû
)

343 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_HOST
, 
TEST_INPLACE
);

344 
	}
}

346 #ifdeà
HAVE_CUDA


347 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
muÉË
)

349 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_NO_INPLACE
);

350 
	}
}

352 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
muÉË_š¶aû
)

354 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA
, 
TEST_INPLACE
);

355 
	}
}

356 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
muÉË_mªaged
)

358 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_NO_INPLACE
);

359 
	}
}

361 
	$TYPED_TEST
(
‹¡_»duû_sÿ‰”v_cuda
, 
muÉË_š¶aû_mªaged
)

363 
	`TEST_DECLARE_MULTIPLE
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
TEST_INPLACE
);

364 
	}
}

367 
şass
 
	g‹¡_»duû_sÿ‰”v_®g


368 : 
public
 
ucc
::
‹¡
,

369 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
¡d
::
¡ršg
> {

372 
	$UCC_TEST_P
(
‹¡_»duû_sÿ‰”v_®g
, 
ršg
)

374 
‹¡_»duû_sÿ‰”v
<
Ty³OpPaœ
<
UCC_DT_INT32
, 
sum
>> 
rsv_‹¡
;

375 
n_´ocs
 = 15;

376 
¡d
::
¡ršg
 
bidœ
 = 
	`G‘P¬am
();

377 
ucc_job_’v_t
 
’v
 = {{"UCC_CL_BASIC_TUNE", "inf"},

380 
bidœ
 == "bidirectional" ? "y" : "n"}};

381 
UccJob
 
	`job
(
n_´ocs
, UccJob::
UCC_JOB_CTX_GLOBAL
, 
’v
);

382 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
n_´ocs
);

383 
»³©
 = 3;

384 
UccCŞlCtxVec
 
ùxs
;

385 
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mt
 = {
UCC_MEMORY_TYPE_HOST
};

387 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) {

388 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA
);

390 ià(
UCC_OK
 =ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA_MANAGED
)) {

391 
mt
.
	`push_back
(
UCC_MEMORY_TYPE_CUDA_MANAGED
);

394 autØ
couÁ
 : {65536, 123567}) {

395 autØ
š¶aû
 : {
TEST_NO_INPLACE
, 
TEST_INPLACE
}) {

396 autØ
m
 : 
mt
) {

397 
rsv_‹¡
.
	`£t_mem_ty³
(
m
);

398 
rsv_‹¡
.
	`£t_š¶aû
(
š¶aû
);

399 
rsv_‹¡
.
	`d©a_š™
(
n_´ocs
, 
UCC_DT_INT32
, 
couÁ
, 
ùxs
, 
Œue
);

400 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

402 autØ
i
 = 0; i < 
»³©
; i++) {

403 
»q
.
	`¡¬t
();

404 
»q
.
	`wa™
();

405 
	`EXPECT_EQ
(
Œue
, 
rsv_‹¡
.
	`d©a_v®id©e
(
ùxs
));

406 
rsv_‹¡
.
	`»£t
(
ùxs
);

408 
rsv_‹¡
.
	`d©a_fši
(
ùxs
);

412 
	}
}

413 
INSTANTIATE_TEST_CASE_P
(, 
‹¡_»duû_sÿ‰”v_®g
,

414 ::
‹¡šg
::
V®ues
("bidirectional", "unidirectional"));

	@test/gtest/coll/test_scatter.cc

6 
	~"commÚ/‹¡_ucc.h
"

7 
	~"uts/ucc_m©h.h
"

9 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<, 
	gucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , ,

10 
	gg‹¡_ucc_š¶aû_t
>;

11 
usšg
 
	gP¬am_1
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , ,

12 
	gg‹¡_ucc_š¶aû_t
>;

14 
şass
 
	g‹¡_sÿ‰”
 : 
public
 
UccCŞlArgs
,…ubliø
	gucc
::
‹¡
 {

15 
´iv©e
:

16 
roÙ
;

18 
	gpublic
:

19 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
, 
size_t
 
sšgË_¿nk_couÁ
,

20 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

22 
ucc_cŞl_¬gs_t
 *
	gcŞl
;

23 
ucc_couÁ_t
 
	gcouÁ
;

25 
	gùxs
.
»size
(
Årocs
);

26 
	gcouÁ
 = 
sšgË_¿nk_couÁ
 * 
Årocs
;

28 autØ
	gr
 = 0;„ < 
	gÅrocs
;„++) {

29 
	gcŞl
 = (
ucc_cŞl_¬gs_t
 *)
ÿÎoc
(1, (ucc_coll_args_t));

30 
	gùxs
[
r
] =

31 (
g‹¡_ucc_cŞl_ùx_t
 *)
ÿÎoc
(1,

32 (
g‹¡_ucc_cŞl_ùx_t
));

33 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

35 
	gcŞl
->
	gmask
 = 0;

36 
	gcŞl
->
	gæags
 = 0;

37 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_SCATTER
;

38 
	gcŞl
->
	groÙ
 = 
roÙ
;

39 
	gcŞl
->
	gd¡
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

40 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
sšgË_¿nk_couÁ
;

41 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
dty³
;

43 ià(
	gr
 =ğ
roÙ
) {

44 
ùxs
[
r
]->
š™_buf
 =

45 
ucc_m®loc
(
ucc_dt_size
(
dty³
è* 
couÁ
,

47 
EXPECT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

48 
ušt8_t
 *
	gsbuf
 = (ušt8_t*)
ùxs
[
r
]->
š™_buf
;

49 
	gp
 = 0;… < 
	gÅrocs
;…++) {

50 
	gi
 = 0; i < 
ucc_dt_size
(
dty³
è* 
	gsšgË_¿nk_couÁ
; i++) {

51 
	gsbuf
[(
p
 * 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
 + 
i
)] = (
ušt8_t
)((i+p) % 256);

55 
	gcŞl
->
	g¤c
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

56 
	gcŞl
->
	g¤c
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
couÁ
;

57 
	gcŞl
->
	g¤c
.
	gšfo
.
	gd©©y³
 = 
dty³
;

58 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

59 
ucc_dt_size
(
dty³
è* 
couÁ
, 
mem_ty³
));

60 
	gcŞl
->
	g¤c
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

61 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo
.
bufãr
,

62 
ùxs
[
r
]->
š™_buf
, 
ucc_dt_size
(
dty³
è* 
couÁ
,

63 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

65 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

66 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

67 
ucc_dt_size
(
dty³
è* 
sšgË_¿nk_couÁ
,

68 
mem_ty³
));

69 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

71 ià(
	gš¶aû
) {

72 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

73 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

75 ià(
	g³rsi¡’t
) {

76 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

77 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

81 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

83 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

84 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

85 ià(
	gr
 =ğ
roÙ
) {

86 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
¤c_mc_h—d”
));

88 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

89 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
d¡_mc_h—d”
));

91 
ucc_ä“
(
ùxs
[
r
]->
š™_buf
);

92 
ä“
(
cŞl
);

93 
ä“
(
ùxs
[
r
]);

95 
	gùxs
.
ş—r
();

97 
»£t
(
UccCŞlCtxVec
 
ùxs
)

99 
ucc_cŞl_¬gs_t
 *
	gcŞl
;

100 
size_t
 
	gsšgË_¿nk_couÁ
 = (
ùxs
[0])->
¬gs
->
d¡
.
šfo
.
couÁ
;

101 
ucc_d©©y³_t
 
	gdty³
 = (
ùxs
[0])->
¬gs
->
d¡
.
šfo
.
d©©y³
;

103 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

104 
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

105 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

106 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo
.
bufãr
,

107 
sšgË_¿nk_couÁ
 * 
ucc_dt_size
(
dty³
),

108 
mem_ty³
, 0);

112 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

114 
boŞ
 
	g»t
 = 
Œue
;

115 
	groÙ
 = 
ùxs
[0]->
¬gs
->
roÙ
;

116 
size_t
 
	gsšgË_¿nk_couÁ
 = (
ùxs
[0])->
¬gs
->
d¡
.
šfo
.
couÁ
;

117 
size_t
 
	gdt_size
 = 
ucc_dt_size
((
ùxs
[0])->
¬gs
->
d¡
.
šfo
.
d©©y³
);

118 
ušt8_t
 *
	gd¡s
;

120 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

121 
d¡s
 = (
ušt8_t
 *)
ucc_m®loc
(
sšgË_¿nk_couÁ
 * 
dt_size
, "dsts buf");

122 
EXPECT_NE
(
d¡s
, 
nuÎ±r
);

124 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

125 ià(
	gr
 =ğ
roÙ
 && 
š¶aû
) {

128 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

129 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
, 
ùxs
[
r
]->
¬gs
->
d¡
.
šfo
.
bufãr
,

130 
sšgË_¿nk_couÁ
 * 
dt_size
,

131 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

133 
	gd¡s
 = (
ušt8_t
 *)
ùxs
[
r
]->
¬gs
->
d¡
.
šfo
.
bufãr
;

136 
	gi
 = 0; i < 
sšgË_¿nk_couÁ
 * 
	gdt_size
; i++) {

137 ià((
	gušt8_t
)((
	gi
 + 
	gr
) % 256) !=

138 
d¡s
[
i
]) {

139 
»t
 = 
çl£
;

144 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

145 
ucc_ä“
(
d¡s
);

147  
	g»t
;

149 
£t_roÙ
(
_roÙ
)

151 
	groÙ
 = 
_roÙ
;

155 
şass
 
	g‹¡_sÿ‰”_0
 : 
public
 
‹¡_sÿ‰”
,

156 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {

159 
	$UCC_TEST_P
(
‹¡_sÿ‰”_0
, 
sšgË
)

161 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

162 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

163 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

164 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

165 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

166 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

167 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

168 
size
 = 
‹am
->
´ocs
.
	`size
();

169 
UccCŞlCtxVec
 
ùxs
;

170 
	`GTEST_SKIP
();

172 
	`£t_š¶aû
(
š¶aû
);

173 
	`SET_MEM_TYPE
(
mem_ty³
);

174 
	`£t_roÙ
(
roÙ
);

176 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

177 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

178 
»q
.
	`¡¬t
();

179 
»q
.
	`wa™
();

180 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

181 
	`d©a_fši
(
ùxs
);

182 
	}
}

184 
	$UCC_TEST_P
(
‹¡_sÿ‰”_0
, 
sšgË_³rsi¡’t
)

186 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

187 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

188 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

189 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

190 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

191 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

192 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

193 
size
 = 
‹am
->
´ocs
.
	`size
();

194 cÚ¡ 
n_ÿÎs
 = 3;

195 
UccCŞlCtxVec
 
ùxs
;

196 
	`GTEST_SKIP
();

198 
	`£t_š¶aû
(
š¶aû
);

199 
	`SET_MEM_TYPE
(
mem_ty³
);

200 
	`£t_roÙ
(
roÙ
);

202 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
Œue
);

203 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

205 autØ
i
 = 0; i < 
n_ÿÎs
; i++) {

206 
»q
.
	`¡¬t
();

207 
»q
.
	`wa™
();

208 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

209 
	`»£t
(
ùxs
);

212 
	`d©a_fši
(
ùxs
);

213 
	}
}

215 
INSTANTIATE_TEST_CASE_P
(

216 , 
‹¡_sÿ‰”_0
,

217 ::
‹¡šg
::
Combše
(::‹¡šg::
Rªge
(1, 
UccJob
::
nSticT—ms
),

218 
PREDEFINED_DTYPES
,

219 #ifdeà
HAVE_CUDA


220 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
,

221 
UCC_MEMORY_TYPE_CUDA
,

222 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

224 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

226 ::
‹¡šg
::
V®ues
(1, 3, 8192),

227 ::
‹¡šg
::
V®ues
(0, 1),

228 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

230 
şass
 
	g‹¡_sÿ‰”_1
 : 
public
 
‹¡_sÿ‰”
,

231 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {

234 
	$UCC_TEST_P
(
‹¡_sÿ‰”_1
, 
muÉË_ho¡
)

236 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

237 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

238 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

239 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

240 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

241 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

242 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

243 
	`GTEST_SKIP
();

245 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

246 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

247 
size
 = 
‹am
->
´ocs
.
	`size
();

248 
UccCŞlCtxVec
 
ùx
;

250 ià(
size
 =ğ1 && 
roÙ
 > 0) {

255 
this
->
	`£t_š¶aû
(
š¶aû
);

256 
	`SET_MEM_TYPE
(
mem_ty³
);

257 
	`£t_roÙ
(
roÙ
);

259 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùx
, 
çl£
);

260 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

261 
ùxs
.
	`push_back
(
ùx
);

263 
UccReq
::
	`¡¬Î
(
»qs
);

264 
UccReq
::
	`wa™®l
(
»qs
);

266 autØ
ùx
 : 
ùxs
) {

267 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

268 
	`d©a_fši
(
ùx
);

270 
	}
}

272 
INSTANTIATE_TEST_CASE_P
(

273 , 
‹¡_sÿ‰”_1
,

274 ::
‹¡šg
::
Combše
(
PREDEFINED_DTYPES
,

275 #ifdeà
HAVE_CUDA


276 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
,

277 
UCC_MEMORY_TYPE_CUDA
,

278 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

280 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

282 ::
‹¡šg
::
V®ues
(1, 3, 8192),

283 ::
‹¡šg
::
V®ues
(0, 1),

284 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

	@test/gtest/coll/test_scatterv.cc

6 
	~"commÚ/‹¡_ucc.h
"

7 
	~"uts/ucc_m©h.h
"

9 
usšg
 
	gP¬am_0
 = 
¡d
::
tu¶e
<, 
	gucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , ,

10 
	gg‹¡_ucc_š¶aû_t
>;

11 
usšg
 
	gP¬am_1
 = 
¡d
::
tu¶e
<
ucc_d©©y³_t
, 
	gucc_memÜy_ty³_t
, , ,

12 
	gg‹¡_ucc_š¶aû_t
>;

14 
şass
 
	g‹¡_sÿ‰”v
 : 
public
 
UccCŞlArgs
,…ubliø
	gucc
::
‹¡
 {

15 
´iv©e
:

16 
roÙ
;

18 
	gpublic
:

19 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
, 
size_t
 
couÁ
,

20 
UccCŞlCtxVec
 &
ùxs
, 
boŞ
 
³rsi¡’t
)

22 
ucc_cŞl_¬gs_t
 *
	gcŞl
;

23 *
	gcouÁs
, *
	gdi¥ls
;

24 
size_t
 
	gmy_couÁ
, 
	g®l_couÁs
;

26 
	gùxs
.
»size
(
Årocs
);

27 autØ
	gr
 = 0;„ < 
	gÅrocs
;„++) {

28 
	gcŞl
 = (
ucc_cŞl_¬gs_t
 *)
ÿÎoc
(1, (ucc_coll_args_t));

29 
	gmy_couÁ
 = (
Årocs
 - 
r
è* 
couÁ
;

30 
	gùxs
[
r
] =

31 (
g‹¡_ucc_cŞl_ùx_t
 *)
ÿÎoc
(1, (gtest_ucc_coll_ctx_t));

32 
	gùxs
[
r
]->
	g¬gs
 = 
cŞl
;

34 
	gcŞl
->
	gmask
 = 0;

35 
	gcŞl
->
	gæags
 = 0;

36 
	gcŞl
->
	gcŞl_ty³
 = 
UCC_COLL_TYPE_SCATTERV
;

37 
	gcŞl
->
	groÙ
 = 
roÙ
;

38 
	gcŞl
->
	gd¡
.
	gšfo
.
	gmem_ty³
 = 
mem_ty³
;

39 
	gcŞl
->
	gd¡
.
	gšfo
.
	gcouÁ
 = (
ucc_couÁ_t
)
my_couÁ
;

40 
	gcŞl
->
	gd¡
.
	gšfo
.
	gd©©y³
 = 
dty³
;

42 ià(
	gr
 =ğ
roÙ
) {

43 
®l_couÁs
 = 0;

44 
	gcouÁs
 = (*)
m®loc
((è* 
Årocs
);

45 
ASSERT_NE
(
couÁs
, 
nuÎ±r
);

46 
	gdi¥ls
 = (*)
m®loc
((è* 
Årocs
);

47 
ASSERT_NE
(
di¥ls
, 
nuÎ±r
);

49 
	gi
 = 0; i < 
	gÅrocs
; i++) {

50 
	gcouÁs
[
i
] = (
Årocs
 - iè* 
couÁ
;

51 
	gdi¥ls
[
i
] = 
®l_couÁs
;

52 
	g®l_couÁs
 +ğ
couÁs
[
i
];

55 
	gùxs
[
r
]->
	gš™_buf
 =

56 
ucc_m®loc
(
ucc_dt_size
(
dty³
è* 
®l_couÁs
, "init buf");

57 
ASSERT_NE
(
ùxs
[
r
]->
š™_buf
, 
nuÎ±r
);

58 
ušt8_t
 *
	gsbuf
 = (ušt8_t*)
ùxs
[
r
]->
š™_buf
;

59 
	gp
 = 0;… < 
	gÅrocs
;…++) {

60 
	gi
 = 0; i < 
ucc_dt_size
(
dty³
è* 
	gcouÁs
[
p
]; i++) {

61 
	gsbuf
[(
di¥ls
[
p
] * 
ucc_dt_size
(
dty³
è+ 
	gi
)] =

62 (
ušt8_t
)((
i
 + 
p
) % 256);

66 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gmem_ty³
 = 
mem_ty³
;

67 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gcouÁs
 = (
ucc_couÁ_t
 *)
couÁs
;

68 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gdi¥Ïûm’ts
 = (
ucc_ašt_t
 *)
di¥ls
;

69 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gd©©y³
 = 
dty³
;

71 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
¤c_mc_h—d”
,

72 
ucc_dt_size
(
dty³
è* 
®l_couÁs
,

73 
mem_ty³
));

74 
	gcŞl
->
	g¤c
.
	gšfo_v
.
	gbufãr
 = 
ùxs
[
r
]->
¤c_mc_h—d”
->
addr
;

75 
UCC_CHECK
(
ucc_mc_memıy
(
cŞl
->
¤c
.
šfo_v
.
bufãr
,

76 
ùxs
[
r
]->
š™_buf
, 
ucc_dt_size
(
dty³
è* 
®l_couÁs
,

77 
mem_ty³
, 
UCC_MEMORY_TYPE_HOST
));

79 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

80 
UCC_CHECK
(
ucc_mc_®loc
(&
ùxs
[
r
]->
d¡_mc_h—d”
,

81 
ucc_dt_size
(
dty³
è* 
my_couÁ
,

82 
mem_ty³
));

83 
	gcŞl
->
	gd¡
.
	gšfo
.
	gbufãr
 = 
ùxs
[
r
]->
d¡_mc_h—d”
->
addr
;

85 ià(
	gš¶aû
) {

86 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

87 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

89 ià(
	g³rsi¡’t
) {

90 
	gcŞl
->
	gmask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

91 
	gcŞl
->
	gæags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

95 
d©a_fši
(
UccCŞlCtxVec
 
ùxs
)

97 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

98 
ucc_cŞl_¬gs_t
 *
	gcŞl
 = 
ùxs
[
r
]->
¬gs
;

99 ià(
	gr
 =ğ
roÙ
) {

100 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
¤c_mc_h—d”
));

101 
ä“
(
cŞl
->
¤c
.
šfo_v
.
couÁs
);

102 
ä“
(
cŞl
->
¤c
.
šfo_v
.
di¥Ïûm’ts
);

104 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

105 
UCC_CHECK
(
ucc_mc_ä“
(
ùxs
[
r
]->
d¡_mc_h—d”
));

107 
ucc_ä“
(
ùxs
[
r
]->
š™_buf
);

108 
ä“
(
cŞl
);

109 
ä“
(
ùxs
[
r
]);

111 
	gùxs
.
ş—r
();

113 
»£t
(
UccCŞlCtxVec
 
ùxs
)

115 
ucc_cŞl_¬gs_t
 *
	gcŞl
;

116 
ucc_d©©y³_t
 
	gdty³
 = (
ùxs
[0])->
¬gs
->
d¡
.
šfo
.
d©©y³
;

117 
size_t
 
	gmy_couÁ
;

119 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

120 ià(
	gr
 !ğ
roÙ
 || !
š¶aû
) {

121 
cŞl
 = 
ùxs
[
r
]->
¬gs
;

122 
	gmy_couÁ
 = 
cŞl
->
d¡
.
šfo
.
couÁ
;

123 
ş—r_bufãr
(
cŞl
->
d¡
.
šfo
.
bufãr
,

124 
my_couÁ
 * 
ucc_dt_size
(
dty³
),

125 
mem_ty³
, 0);

129 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
ùxs
)

131 
boŞ
 
	g»t
 = 
Œue
;

132 
	groÙ
 = 
ùxs
[0]->
¬gs
->
roÙ
;

133 
size_t
 
	gdt_size
;

134 
size_t
 
	gmy_couÁ
;

135 
ušt8_t
 *
	gd¡s
;

137 autØ
	gr
 = 0;„ < 
	gùxs
.
size
();„++) {

138 ià(
	gr
 =ğ
roÙ
 && 
š¶aû
) {

141 
	gdt_size
 = 
ucc_dt_size
((
ùxs
[
r
])->
¬gs
->
d¡
.
šfo
.
d©©y³
);

142 
	gmy_couÁ
 = (
ùxs
[
r
])->
¬gs
->
d¡
.
šfo
.
couÁ
;

143 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

144 
d¡s
 = (
ušt8_t
 *)
ucc_m®loc
(
my_couÁ
 * 
dt_size
, "dsts buf");

145 
ucc_as£¹
(
d¡s
 !ğ
nuÎ±r
);

146 
UCC_CHECK
(
ucc_mc_memıy
(
d¡s
, 
ùxs
[
r
]->
¬gs
->
d¡
.
šfo
.
bufãr
,

147 
my_couÁ
 * 
dt_size
,

148 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

150 
	gd¡s
 = (
ušt8_t
 *)
ùxs
[
r
]->
¬gs
->
d¡
.
šfo
.
bufãr
;

153 
	gi
 = 0; i < 
my_couÁ
 * 
	gdt_size
; i++) {

154 ià((
	gušt8_t
)((
	gi
 + 
	gr
) % 256) !=

155 
d¡s
[
i
]) {

156 
»t
 = 
çl£
;

161 ià(
	gUCC_MEMORY_TYPE_HOST
 !ğ
mem_ty³
) {

162 
ucc_ä“
(
d¡s
);

163 ià(!
	g»t
) {

168  
	g»t
;

170 
£t_roÙ
(
_roÙ
)

172 
	groÙ
 = 
_roÙ
;

176 
şass
 
	g‹¡_sÿ‰”v_0
 : 
public
 
‹¡_sÿ‰”v
,

177 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_0
> {

180 
	$UCC_TEST_P
(
‹¡_sÿ‰”v_0
, 
sšgË
)

182 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

183 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

184 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

185 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

186 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

187 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

188 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

189 
size
 = 
‹am
->
´ocs
.
	`size
();

190 
UccCŞlCtxVec
 
ùxs
;

192 ià(
size
 <ğ
roÙ
) {

193 
	`GTEST_SKIP
();

196 
	`£t_š¶aû
(
š¶aû
);

197 
	`SET_MEM_TYPE
(
mem_ty³
);

198 
	`£t_roÙ
(
roÙ
);

200 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
çl£
);

201 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

202 
»q
.
	`¡¬t
();

203 
»q
.
	`wa™
();

204 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

205 
	`d©a_fši
(
ùxs
);

206 
	}
}

208 
	$UCC_TEST_P
(
‹¡_sÿ‰”v_0
, 
sšgË_³rsi¡’t
)

210 cÚ¡ 
‹am_id
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

211 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

212 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

213 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

214 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

215 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<5>(
	`G‘P¬am
());

216 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
‹am_id
];

217 
size
 = 
‹am
->
´ocs
.
	`size
();

218 cÚ¡ 
n_ÿÎs
 = 3;

219 
UccCŞlCtxVec
 
ùxs
;

221 ià(
size
 <ğ
roÙ
) {

222 
	`GTEST_SKIP
();

225 
	`£t_š¶aû
(
š¶aû
);

226 
	`SET_MEM_TYPE
(
mem_ty³
);

227 
	`£t_roÙ
(
roÙ
);

229 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùxs
, 
Œue
);

230 
UccReq
 
	`»q
(
‹am
, 
ùxs
);

232 autØ
i
 = 0; i < 
n_ÿÎs
; i++) {

233 
»q
.
	`¡¬t
();

234 
»q
.
	`wa™
();

235 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùxs
));

236 
	`»£t
(
ùxs
);

239 
	`d©a_fši
(
ùxs
);

240 
	}
}

242 
INSTANTIATE_TEST_CASE_P
(

243 , 
‹¡_sÿ‰”v_0
,

244 ::
‹¡šg
::
Combše
(::‹¡šg::
Rªge
(1, 
UccJob
::
nSticT—ms
),

245 
PREDEFINED_DTYPES
,

246 #ifdeà
HAVE_CUDA


247 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
,

248 
UCC_MEMORY_TYPE_CUDA
,

249 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

251 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

253 ::
‹¡šg
::
V®ues
(1, 3, 8192),

254 ::
‹¡šg
::
V®ues
(0, 1),

255 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

257 
şass
 
	g‹¡_sÿ‰”v_1
 : 
public
 
‹¡_sÿ‰”v
,

258 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am_1
> {

261 
	$UCC_TEST_P
(
‹¡_sÿ‰”v_1
, 
muÉË_ho¡
)

263 cÚ¡ 
ucc_d©©y³_t
 
dty³
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

264 cÚ¡ 
ucc_memÜy_ty³_t
 
mem_ty³
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

265 cÚ¡ 
couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

266 cÚ¡ 
roÙ
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

267 cÚ¡ 
g‹¡_ucc_š¶aû_t
 
š¶aû
 = 
¡d
::
g‘
<4>(
	`G‘P¬am
());

268 
¡d
::
veùÜ
<
UccReq
> 
»qs
;

269 
¡d
::
veùÜ
<
UccCŞlCtxVec
> 
ùxs
;

271 
tid
 = 0;id < 
UccJob
::
nSticT—ms
;id++) {

272 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticT—ms
()[
tid
];

273 
size
 = 
‹am
->
´ocs
.
	`size
();

274 
UccCŞlCtxVec
 
ùx
;

276 ià(
size
 <ğ
roÙ
) {

281 
this
->
	`£t_š¶aû
(
š¶aû
);

282 
	`SET_MEM_TYPE
(
mem_ty³
);

283 
	`£t_roÙ
(
roÙ
);

285 
	`d©a_š™
(
size
, 
dty³
, 
couÁ
, 
ùx
, 
çl£
);

286 
»qs
.
	`push_back
(
	`UccReq
(
‹am
, 
ùx
));

287 
ùxs
.
	`push_back
(
ùx
);

289 
UccReq
::
	`¡¬Î
(
»qs
);

290 
UccReq
::
	`wa™®l
(
»qs
);

292 autØ
ùx
 : 
ùxs
) {

293 
	`EXPECT_EQ
(
Œue
, 
	`d©a_v®id©e
(
ùx
));

294 
	`d©a_fši
(
ùx
);

296 
	}
}

298 
INSTANTIATE_TEST_CASE_P
(

299 , 
‹¡_sÿ‰”v_1
,

300 ::
‹¡šg
::
Combše
(
PREDEFINED_DTYPES
,

301 #ifdeà
HAVE_CUDA


302 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
,

303 
UCC_MEMORY_TYPE_CUDA
,

304 
UCC_MEMORY_TYPE_CUDA_MANAGED
),

306 ::
‹¡šg
::
V®ues
(
UCC_MEMORY_TYPE_HOST
),

308 ::
‹¡šg
::
V®ues
(1, 3, 8192),

309 ::
‹¡šg
::
V®ues
(0, 1),

310 ::
‹¡šg
::
V®ues
(
TEST_INPLACE
, 
TEST_NO_INPLACE
)));

	@test/gtest/coll_score/test_score.cc

5 
	~"‹¡_scÜe.h
"

7 
	$UCC_TEST_F
(
‹¡_scÜe
, 
®loc_ä“
)

9 
ucc_cŞl_scÜe_t
 *
scÜe
;

10 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
));

11 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

12 
	}
}

14 
	$UCC_TEST_F
(
‹¡_scÜe
, 
add_¿nge
)

16 
ucc_cŞl_ty³_t
 
c
 = 
UCC_COLL_TYPE_BARRIER
;

17 
ucc_memÜy_ty³_t
 
m
 = 
UCC_MEMORY_TYPE_HOST
;

18 
ucc_scÜe_t
 
v®ue
;

19 
ucc_cŞl_scÜe_t
 *
scÜe
;

21 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
));

23 
v®ue
 = 0;

24 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_add_¿nge
(
scÜe
, 
c
, 
m
, 16, 65536, 
v®ue
,

25 
NULL
, NULL));

26 
	`EXPECT_EQ
(0, 
	`ucc_li¡_Ëngth
(&
scÜe
->
scÜes
[
	`ucc_og2
(
c
)][
m
]));

27 
v®ue
 = 10;

28 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_add_¿nge
(
scÜe
, 
c
, 
m
, 16, 65536, 
v®ue
,

29 
NULL
, NULL));

30 
	`EXPECT_EQ
(1, 
	`ucc_li¡_Ëngth
(&
scÜe
->
scÜes
[
	`ucc_og2
(
c
)][
m
]));

31 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

32 
	}
}

34 
	$UCC_TEST_F
(
‹¡_scÜe
, 
add_¿nge_sÜ‹d
)

36 
ucc_cŞl_ty³_t
 
c
 = 
UCC_COLL_TYPE_BARRIER
;

37 
ucc_memÜy_ty³_t
 
m
 = 
UCC_MEMORY_TYPE_HOST
;

38 
ucc_scÜe_t
 
v®ue
;

39 
ucc_cŞl_scÜe_t
 *
scÜe
;

41 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
));

42 
v®ue
 = 10;

43 
	`EXPECT_EQ
(
UCC_OK
,

44 
	`ucc_cŞl_scÜe_add_¿nge
(
scÜe
, 
c
, 
m
, 50, 60, 
v®ue
, 
NULL
, NULL));

45 
	`EXPECT_EQ
(
UCC_OK
,

46 
	`ucc_cŞl_scÜe_add_¿nge
(
scÜe
, 
c
, 
m
, 0, 10, 
v®ue
, 
NULL
, NULL));

47 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_add_¿nge
(
scÜe
, 
c
, 
m
, 100, 1000, 
v®ue
,

48 
NULL
, NULL));

49 
	`EXPECT_EQ
(
UCC_OK
,

50 
	`ucc_cŞl_scÜe_add_¿nge
(
scÜe
, 
c
, 
m
, 20, 40, 
v®ue
, 
NULL
, NULL));

51 
ucc_li¡_lšk_t
 *
li¡
 = &
scÜe
->
scÜes
[
	`ucc_og2
(
c
)][
m
];

52 
	`EXPECT_EQ
(4, 
	`ucc_li¡_Ëngth
(
li¡
));

53 
ucc_msg_¿nge_t
 *
¿nge
;

54 
size_t
 
ex³ùed
[4] = {0, 20, 50, 100};

55 
size_t
 * 
e
 = 
ex³ùed
;

56 
	`ucc_li¡_fÜ_—ch
(
¿nge
, 
li¡
, 
su³r
.
li¡_–em
)

58 
	`EXPECT_EQ
(*
e
, 
¿nge
->
¡¬t
);

59 
e
++;

61 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

62 
	}
}

65 şas 
	c‹¡_scÜe_m”ge
 : 
public
 
‹¡_scÜe
 {

66 
public
:

67 
ucc_cŞl_scÜe_t
 *
scÜe1
;

68 
ucc_cŞl_scÜe_t
 *
	mscÜe2
;

69 
ucc_cŞl_scÜe_t
 *
	mm”ge
;

70 
	$‹¡_scÜe_m”ge
()

72 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe1
));

73 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe2
));

75 ~
	$‹¡_scÜe_m”ge
()

77 
	`ucc_cŞl_scÜe_ä“
(
m”ge
);

78 
	}
}

81 
ucc_¡©us_t
 
	g‹¡_scÜe
::
check_¿nge
(
ucc_cŞl_scÜe_t
 * 
scÜe
,

82 
ucc_cŞl_ty³_t
 
c
,

83 
ucc_memÜy_ty³_t
 
m
,

84 
¡d
::
veùÜ
<
¿nge_t
> 
check
)

86 
ucc_msg_¿nge_t
 *
¿nge
;

87 
ucc_li¡_lšk_t
 *
	gli¡
 = &
scÜe
->
scÜes
[
ucc_og2
(
c
)][
m
];

88 autØ
	gr
 = 
check
.
begš
();

89 ià(
	gcheck
.
size
(è!ğ
ucc_li¡_Ëngth
(
li¡
)) {

90  
UCC_ERR_NO_MESSAGE
;

92 
ucc_li¡_fÜ_—ch
(
¿nge
, 
li¡
, 
su³r
.
li¡_–em
)

94 ià(
	g¿nge
->
	g¡¬t
 !ğ
¡d
::
g‘
<0>(*
r
è|| 
¿nge
->
’d
 != std::get<1>(*r) ||

95 
¿nge
->
su³r
.
scÜe
 !ğ
¡d
::
g‘
<2>(*
r
)) {

96  
UCC_ERR_NO_MESSAGE
;

98 
	gr
++;

100  
	gUCC_OK
;

103 
ucc_¡©us_t
 
	g‹¡_scÜe
::
check_çÎback
(
ucc_cŞl_scÜe_t
 * 
scÜe
,

104 
ucc_cŞl_ty³_t
 
c
,

105 
ucc_memÜy_ty³_t
 
m
,

106 
¡d
::
veùÜ
<¡d::veùÜ<
çÎback_t
> > 
check
)

108 
ucc_li¡_lšk_t
 *
li¡
 = &
scÜe
->
scÜes
[
ucc_og2
(
c
)][
m
];

109 autØ
	gfb
 = 
check
.
begš
();

110 
ucc_li¡_lšk_t
 *
	gçÎback
;

111 
ucc_msg_¿nge_t
 *
	g¿nge
;

112 
ucc_cŞl_’Œy_t
 *
	gfb_r
;

114 ià(
	gcheck
.
size
(è!ğ
ucc_li¡_Ëngth
(
li¡
)) {

115  
UCC_ERR_NO_MESSAGE
;

117 
ucc_li¡_fÜ_—ch
(
¿nge
, 
li¡
, 
su³r
.
li¡_–em
)

119 
	gçÎback
 = &
¿nge
->
çÎback
;

121 ià(
	gfb
->
size
(è!ğ
ucc_li¡_Ëngth
(
çÎback
)) {

122  
UCC_ERR_NO_MESSAGE
;

124 autØ
	gf
 = 
fb
->
begš
();

125 
ucc_li¡_fÜ_—ch
(
fb_r
, 
çÎback
, 
li¡_–em
) {

126 ià(
	gfb_r
->
	gscÜe
 !ğ
¡d
::
g‘
<0>(*
f
) ||

127 (
ušt64_t
)
fb_r
->
š™
 !ğ
¡d
::
g‘
<1>(*
f
)) {

128  
UCC_ERR_NO_MESSAGE
;

130 
	gf
++;

132 
	gfb
++;

134  
	gUCC_OK
;

137 
	g‹¡_scÜe
::
š™_scÜe
(
ucc_cŞl_scÜe_t
 *
scÜe
, 
¡d
::
veùÜ
<
¿nge_t
> 
v
,

138 
ucc_cŞl_ty³_t
 
c
, 
ušt64_t
 
š™_â
, ušt64_ˆ
‹am
)

140 autØ&
	gr
 : 
v
) {

141 
EXPECT_EQ
(
UCC_OK
, 
ucc_cŞl_scÜe_add_¿nge
(

142 
scÜe
, 
c
, 
UCC_MEMORY_TYPE_HOST
, 
¡d
::
g‘
<0>(
r
),

143 
¡d
::
g‘
<1>(
r
), std::get<2>(r),

144 (
ucc_ba£_cŞl_š™_â_t
)
š™_â
,

145 (
ucc_ba£_‹am_t
 *)
‹am
));

149 
	$UCC_TEST_F
(
‹¡_scÜe_m”ge
, 
nÚ_ov”Ïp
)

151 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 10, 10), RANGE(40, 50, 5)}),

152 
UCC_COLL_TYPE_BARRIER
);

153 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(10, 20, 100), RANGE(30, 35, 1)}),

154 
UCC_COLL_TYPE_BARRIER
);

155 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

156 
	`EXPECT_EQ
(
UCC_OK
,

157 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

158 
	`RLIST
({
	`RANGE
(0, 10, 10), RANGE(10, 20, 100),

159 
	`RANGE
(30, 35, 1), RANGE(40, 50, 5)})));

160 
	}
}

162 
	$UCC_TEST_F
(
‹¡_scÜe_m”ge
, 
ov”Ïp_sšgË
)

164 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 100, 10)}), 
UCC_COLL_TYPE_BARRIER
);

165 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(50, 150, 100)}), 
UCC_COLL_TYPE_BARRIER
);

166 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

167 
	`EXPECT_EQ
(
UCC_OK
,

168 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

169 
	`RLIST
({
	`RANGE
(0, 50, 10), RANGE(50, 150, 100)})));

170 
	`ucc_cŞl_scÜe_ä“
(
m”ge
);

172 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe1
));

173 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe2
));

174 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
);

175 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(50, 150, 10)}), 
UCC_COLL_TYPE_BARRIER
);

176 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

177 
	`EXPECT_EQ
(
UCC_OK
,

178 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

179 
	`RLIST
({
	`RANGE
(0, 100, 100), RANGE(100, 150, 10)})));

180 
	}
}

182 
	$UCC_TEST_F
(
‹¡_scÜe_m”ge
, 
šşusive
)

184 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 90, 100)}), 
UCC_COLL_TYPE_BARRIER
);

185 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(30, 60, 10)}), 
UCC_COLL_TYPE_BARRIER
);

186 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

187 
	`EXPECT_EQ
(
UCC_OK
,

188 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

189 
	`RLIST
({
	`RANGE
(0, 90, 100)})));

190 
	`ucc_cŞl_scÜe_ä“
(
m”ge
);

192 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe1
));

193 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe2
));

194 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 90, 10)}), 
UCC_COLL_TYPE_BARRIER
);

195 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(30, 60, 100)}), 
UCC_COLL_TYPE_BARRIER
);

196 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

197 
	`EXPECT_EQ
(
UCC_OK
,

198 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

199 
	`RLIST
({
	`RANGE
(0, 30, 10), RANGE(30, 60, 100),

200 
	`RANGE
(60, 90, 10)})));

201 
	}
}

203 
	$UCC_TEST_F
(
‹¡_scÜe_m”ge
, 
§me_¡¬t
)

205 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
);

206 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(0, 50, 10)}), 
UCC_COLL_TYPE_BARRIER
);

207 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

208 
	`EXPECT_EQ
(
UCC_OK
,

209 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

210 
	`RLIST
({
	`RANGE
(0, 100, 100)})));

211 
	`ucc_cŞl_scÜe_ä“
(
m”ge
);

213 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe1
));

214 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe2
));

215 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 100, 10)}), 
UCC_COLL_TYPE_BARRIER
);

216 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(0, 50, 100)}), 
UCC_COLL_TYPE_BARRIER
);

217 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

218 
	`EXPECT_EQ
(
UCC_OK
,

219 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

220 
	`RLIST
({
	`RANGE
(0, 50, 100), RANGE(50, 100, 10)})));

221 
	`ucc_cŞl_scÜe_ä“
(
m”ge
);

223 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe1
));

224 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe2
));

225 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(1, 100, 10)}), 
UCC_COLL_TYPE_BARRIER
);

226 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(1, 50, 100)}), 
UCC_COLL_TYPE_BARRIER
);

227 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

228 
	`EXPECT_EQ
(
UCC_OK
,

229 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

230 
	`RLIST
({
	`RANGE
(1, 50, 100), RANGE(50, 100, 10)})));

231 
	}
}

233 
	$UCC_TEST_F
(
‹¡_scÜe_m”ge
, 1
_ov”Ïps_mªy
)

235 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
);

236 
	`š™_scÜe
(
scÜe2
,

237 
	`RLIST
({
	`RANGE
(10, 20, 10), RANGE(30, 40, 10), RANGE(60, 70, 10)}),

238 
UCC_COLL_TYPE_BARRIER
);

239 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

240 
	`EXPECT_EQ
(
UCC_OK
,

241 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

242 
	`RLIST
({
	`RANGE
(0, 100, 100)})));

243 
	`ucc_cŞl_scÜe_ä“
(
m”ge
);

245 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe1
));

246 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe2
));

247 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 100, 10)}), 
UCC_COLL_TYPE_BARRIER
);

248 
	`š™_scÜe
(

249 
scÜe2
,

250 
	`RLIST
({
	`RANGE
(10, 20, 100), RANGE(30, 40, 100), RANGE(60, 70, 5)}),

251 
UCC_COLL_TYPE_BARRIER
);

252 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

253 
	`EXPECT_EQ
(
UCC_OK
,

254 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

255 
	`RLIST
({
	`RANGE
(0, 10, 10), RANGE(10, 20, 100),

256 
	`RANGE
(20, 30, 10), RANGE(30, 40, 100),

257 
	`RANGE
(40, 100, 10)})));

258 
	}
}

260 
	$UCC_TEST_F
(
‹¡_scÜe_m”ge
, 
§me_scÜe
)

262 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
);

263 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(100, 200, 100)}), 
UCC_COLL_TYPE_BARRIER
);

264 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

265 
	`EXPECT_EQ
(
UCC_OK
,

266 
	`check_¿nge
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

267 
	`RLIST
({
	`RANGE
(0, 200, 100)})));

268 
	}
}

270 
	$UCC_TEST_F
(
‹¡_scÜe_m”ge
, 
çÎback_sšgË
)

272 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 100, 100), RANGE(200, 300, 5)}),

273 
UCC_COLL_TYPE_BARRIER
, 0x1, 0x2);

274 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(0, 100, 200), RANGE(250, 350, 3)}),

275 
UCC_COLL_TYPE_BARRIER
, 0x3, 0x4);

276 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

280 
	`EXPECT_EQ
(
UCC_OK
,

281 
	`check_çÎback
(
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

282 
	`FB_LLIST
({
	`FB_LIST
({
	`FB
(100, 0x1)}), FB_LIST({}),

283 
	`FB_LIST
({
	`FB
(3, 0x3)}), FB_LIST({})})));

284 
	}
}

286 
	$UCC_TEST_F
(
‹¡_scÜe_m”ge
, 
çÎback_muÉË
)

289 
	`š™_scÜe
(
scÜe1
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
, 0x1,

291 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(0, 100, 300)}), 
UCC_COLL_TYPE_BARRIER
, 0x3,

293 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

295 
scÜe1
 = 
m”ge
;

296 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe2
));

297 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(0, 100, 500)}), 
UCC_COLL_TYPE_BARRIER
, 0x5,

299 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

301 
scÜe1
 = 
m”ge
;

302 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe2
));

303 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(0, 100, 400)}), 
UCC_COLL_TYPE_BARRIER
, 0x7,

305 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

307 
scÜe1
 = 
m”ge
;

308 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe2
));

309 
	`š™_scÜe
(
scÜe2
, 
	`RLIST
({
	`RANGE
(0, 100, 600)}), 
UCC_COLL_TYPE_BARRIER
, 0x9,

311 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_m”ge
(
scÜe1
, 
scÜe2
, &
m”ge
, 1));

313 
	`EXPECT_EQ
(
UCC_OK
, 
	`check_çÎback
(

314 
m”ge
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

315 
	`FB_LLIST
({
	`FB_LIST
({
	`FB
(500, 0x5), FB(400, 0x7),

316 
	`FB
(300, 0x3), FB(100, 0x1)})})));

317 
	}
}

	@test/gtest/coll_score/test_score.h

6 #iâdeà
UCC_TEST_SCORE_H


7 
	#UCC_TEST_SCORE_H


	)

9 
	~"cŞl_scÜe/ucc_cŞl_scÜe.h
"

11 
	~<commÚ/‹¡.h
>

12 
	~<¡ršg
>

13 
	~<veùÜ
>

15 
¡d
::
	ttu¶e
<
	tsize_t
, size_t, 
	tucc_scÜe_t
> 
	t¿nge_t
;

16 
	g¡d
::
	ttu¶e
<
	tucc_scÜe_t
, 
	tušt64_t
> 
	tçÎback_t
;

18 
	#RANGE
(
_¡¬t
, 
_’d
, 
_scÜe
è
¡d
::
	`make_tu¶e
(_¡¬t, _’d, _scÜe)

	)

19 
	#RLIST
(...è
¡d
::
veùÜ
<
¿nge_t
>(
__VA_ARGS__
)

	)

21 
	#FB
(
_scÜe
, 
_š™
è
¡d
::
	`make_tu¶e
(_scÜe, _š™)

	)

22 
	#FB_LIST
(...è
¡d
::
veùÜ
<
çÎback_t
>(
__VA_ARGS__
)

	)

23 
	#FB_LLIST
(...è
¡d
::
veùÜ
<¡d::veùÜ<
çÎback_t
>>(
__VA_ARGS__
)

	)

25 
	#FIRST_RANGE
(
_scÜe
, 
_ù
, 
_mt
) \

27 
ucc_li¡_lšk_t
 *
l
 = \

28 
_scÜe
->
scÜes
[
	`ucc_og2
(
UCC_COLL_TYPE_
##
_ù
)] \

29 [
UCC_MEMORY_TYPE_
##
_mt
] \

30 .
Ãxt
; \

31 
ucc_msg_¿nge_t
 *
¿nge
 = \

32 
	`ucc_cÚš”_of
(
l
, 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
); \

33 
¿nge
; \

34 })

	)

36 şas 
	c‹¡_scÜe
 : 
public
 
ucc
::
‹¡
 {

37 
public
:

38 
ucc_¡©us_t
 
check_¿nge
(
ucc_cŞl_scÜe_t
 *
scÜe
, 
ucc_cŞl_ty³_t
 
c
,

39 
ucc_memÜy_ty³_t
 
m
, 
¡d
::
veùÜ
<
¿nge_t
> 
check
);

40 
ucc_¡©us_t
 
check_çÎback
(
ucc_cŞl_scÜe_t
 *
scÜe
, 
ucc_cŞl_ty³_t
 
c
,

41 
ucc_memÜy_ty³_t
 
m
,

42 
¡d
::
veùÜ
<¡d::veùÜ<
çÎback_t
>> 
check
);

43 
š™_scÜe
(
ucc_cŞl_scÜe_t
 *
scÜe
, 
¡d
::
veùÜ
<
¿nge_t
> 
v
,

44 
ucc_cŞl_ty³_t
 
c
, 
ušt64_t
 
š™_â
 = 0, ušt64_ˆ
‹am
 = 0);

	@test/gtest/coll_score/test_score_str.cc

6 
	~"‹¡_scÜe.h
"

7 şas 
	c‹¡_scÜe_¡r
 : 
public
 
‹¡_scÜe
 {

10 
	#SCORE
(
_scÜe
, 
_ù
, 
_mt
) \

12 
ucc_li¡_lšk_t
 *
l
 = \

13 
_scÜe
->
scÜes
[
	`ucc_og2
(
UCC_COLL_TYPE_
##
_ù
)] \

14 [
UCC_MEMORY_TYPE_
##
_mt
] \

15 .
Ãxt
; \

16 
ucc_msg_¿nge_t
 *
¿nge
 = \

17 
	`ucc_cÚš”_of
(
l
, 
ucc_msg_¿nge_t
, 
su³r
.
li¡_–em
); \

18 
¿nge
->
su³r
.
scÜe
; \

19 })

	)

21 
	$UCC_TEST_F
(
‹¡_scÜe_¡r
, 
check_v®id
)

23 
¡d
::
¡ršg
 
¡r
 = "alltoall:cuda:10";

24 
ucc_cŞl_scÜe_t
 *
scÜe
;

26 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
.
	`c_¡r
(), &
scÜe
, 0,

27 
NULL
, NULL, NULL));

28 
	`EXPECT_EQ
(10, 
	`SCORE
(
scÜe
, 
ALLTOALL
, 
CUDA
));

29 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

31 
¡r
 = "host,Cuda:Bcast,SCATTER:10";

32 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
.
	`c_¡r
(), &
scÜe
, 0,

33 
NULL
, NULL, NULL));

34 
	`EXPECT_EQ
(10, 
	`SCORE
(
scÜe
, 
BCAST
, 
CUDA
));

35 
	`EXPECT_EQ
(10, 
	`SCORE
(
scÜe
, 
BCAST
, 
HOST
));

36 
	`EXPECT_EQ
(10, 
	`SCORE
(
scÜe
, 
SCATTER
, 
CUDA
));

37 
	`EXPECT_EQ
(10, 
	`SCORE
(
scÜe
, 
SCATTER
, 
HOST
));

38 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

40 
¡r
 = "inf:gatHerv";

41 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
.
	`c_¡r
(), &
scÜe
, 0,

42 
NULL
, NULL, NULL));

43 
	`EXPECT_EQ
(
UCC_SCORE_MAX
, 
	`SCORE
(
scÜe
, 
GATHERV
, 
ROCM
));

44 
	`EXPECT_EQ
(
UCC_SCORE_MAX
, 
	`SCORE
(
scÜe
, 
GATHERV
, 
HOST
));

45 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

47 
¡r
 = "alltoall,bCAst:hOst:10#scatter:inf#reduce:1";

48 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
.
	`c_¡r
(), &
scÜe
, 0,

49 
NULL
, NULL, NULL));

50 
	`EXPECT_EQ
(10, 
	`SCORE
(
scÜe
, 
BCAST
, 
HOST
));

51 
	`EXPECT_EQ
(
UCC_SCORE_MAX
, 
	`SCORE
(
scÜe
, 
SCATTER
, 
HOST
));

52 
	`EXPECT_EQ
(
UCC_SCORE_MAX
, 
	`SCORE
(
scÜe
, 
SCATTER
, 
CUDA_MANAGED
));

53 
	`EXPECT_EQ
(1, 
	`SCORE
(
scÜe
, 
REDUCE
, 
HOST
));

54 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

55 
	}
}

57 
	$UCC_TEST_F
(
‹¡_scÜe_¡r
, 
check_šv®id
)

59 
¡d
::
¡ršg
 
¡r
 = "alltoallll:cuda:10";

60 
ucc_cŞl_scÜe_t
 *
scÜe
;

61 
‹¡šg
::
š‹º®
::
	`C­tu»Stdout
();

62 
	`EXPECT_NE
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
.
	`c_¡r
(), &
scÜe
, 0,

63 
NULL
, NULL, NULL));

64 
‹¡šg
::
š‹º®
::
	`G‘C­tu»dStdout
();

65 
	}
}

67 
	$UCC_TEST_F
(
‹¡_scÜe_¡r
, 
check_¿nge_1
)

69 
¡d
::
¡ršg
 
¡r
 = "alltoall:64-256:cuda:10";

70 
ucc_cŞl_scÜe_t
 *
scÜe
;

71 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
.
	`c_¡r
(), &
scÜe
, 0,

72 
NULL
, NULL, NULL));

73 
	`EXPECT_EQ
(
UCC_OK
,

74 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_ALLTOALL
, 
UCC_MEMORY_TYPE_CUDA
,

75 
	`RLIST
({
	`RANGE
(64, 256, 10)})));

77 
	`EXPECT_NE
(
UCC_OK
,

78 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_ALLTOALL
, 
UCC_MEMORY_TYPE_HOST
,

79 
	`RLIST
({
	`RANGE
(64, 256, 10)})));

80 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

82 
¡r
 = "10-20:scatter:host:99";

83 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
.
	`c_¡r
(), &
scÜe
, 0,

84 
NULL
, NULL, NULL));

85 
	`EXPECT_EQ
(
UCC_OK
,

86 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_SCATTER
, 
UCC_MEMORY_TYPE_HOST
,

87 
	`RLIST
({
	`RANGE
(10, 20, 99)})));

88 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

89 
	}
}

91 
	$UCC_TEST_F
(
‹¡_scÜe_¡r
, 
check_¿nge_muÉË
)

93 
¡d
::
¡ršg
 
¡r
 = "alltoall:1k-2k,64-256,4096-5000:cuda:10";

94 
ucc_cŞl_scÜe_t
 *
scÜe
;

95 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
.
	`c_¡r
(), &
scÜe
, 0,

96 
NULL
, NULL, NULL));

97 
	`EXPECT_EQ
(
UCC_OK
,

98 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_ALLTOALL
, 
UCC_MEMORY_TYPE_CUDA
,

99 
	`RLIST
({
	`RANGE
(64, 256, 10), RANGE(1024,2048,10), RANGE(4096,5000,10)})));

100 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

102 
¡r
 = "alltoall,barrier:1k-4K,64-256:cuda:10#20:99-12M:bcast";

103 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc_äom_¡r
(
¡r
.
	`c_¡r
(), &
scÜe
, 0,

104 
NULL
, NULL, NULL));

105 
	`EXPECT_EQ
(
UCC_OK
,

106 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_ALLTOALL
, 
UCC_MEMORY_TYPE_CUDA
,

107 
	`RLIST
({
	`RANGE
(64, 256, 10), RANGE(1024,4096,10)})));

108 
	`EXPECT_EQ
(
UCC_OK
,

109 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_CUDA
,

110 
	`RLIST
({
	`RANGE
(64, 256, 10), RANGE(1024,4096,10)})));

111 
	`EXPECT_EQ
(
UCC_OK
,

112 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BCAST
, 
UCC_MEMORY_TYPE_HOST
,

113 
	`RLIST
({
	`RANGE
(99, 12*1024*1024, 20)})));

114 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

115 
	}
}

	@test/gtest/coll_score/test_score_update.cc

6 
	~"‹¡_scÜe.h
"

8 şas 
	c‹¡_scÜe_upd©e
 : 
public
 
‹¡_scÜe
 {

9 
public
:

10 
ucc_cŞl_scÜe_t
 *
scÜe
;

11 
ucc_cŞl_scÜe_t
 *
	mupd©e
;

13 
	$‹¡_scÜe_upd©e
()

15 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
));

16 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
upd©e
));

18 ~
	$‹¡_scÜe_upd©e
()

20 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

21 
	`ucc_cŞl_scÜe_ä“
(
upd©e
);

22 
	}
}

23 
	$»£t
() {

24 
	`ucc_cŞl_scÜe_ä“
(
scÜe
);

25 
	`ucc_cŞl_scÜe_ä“
(
upd©e
);

26 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
scÜe
));

27 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_®loc
(&
upd©e
));

28 
	}
}

31 
	$UCC_TEST_F
(
‹¡_scÜe_upd©e
, 
nÚ_ov”Ïp
)

33 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 10, 10), RANGE(40, 50, 5)}),

34 
UCC_COLL_TYPE_BARRIER
);

35 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(10, 20, 100), RANGE(30, 35, 1)}),

36 
UCC_COLL_TYPE_BARRIER
);

37 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

38 
UCC_COLL_TYPE_ALL
));

39 
	`EXPECT_EQ
(
UCC_OK
,

40 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

41 
	`RLIST
({
	`RANGE
(0, 10, 10), RANGE(40, 50, 5)})));

42 
	}
}

44 
	$UCC_TEST_F
(
‹¡_scÜe_upd©e
, 
ov”Ïp_sšgË
)

46 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 10)}), 
UCC_COLL_TYPE_BARRIER
);

47 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(50, 150, 100)}), 
UCC_COLL_TYPE_BARRIER
);

48 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

49 
UCC_COLL_TYPE_ALL
));

50 
	`EXPECT_EQ
(
UCC_OK
,

51 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

52 
	`RLIST
({
	`RANGE
(0, 50, 10), RANGE(50, 100, 100)})));

53 
	`»£t
();

55 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
);

56 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(50, 150, 10)}), 
UCC_COLL_TYPE_BARRIER
);

57 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

58 
UCC_COLL_TYPE_ALL
));

59 
	`EXPECT_EQ
(
UCC_OK
,

60 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

61 
	`RLIST
({
	`RANGE
(0, 50, 100), RANGE(50, 100, 10)})));

62 
	}
}

64 
	$UCC_TEST_F
(
‹¡_scÜe_upd©e
, 
šşusive
)

66 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 90, 100)}), 
UCC_COLL_TYPE_BARRIER
);

67 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(30, 60, 10)}), 
UCC_COLL_TYPE_BARRIER
);

68 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

69 
UCC_COLL_TYPE_ALL
));

70 
	`EXPECT_EQ
(
UCC_OK
,

71 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

72 
	`RLIST
({
	`RANGE
(0, 30, 100), RANGE(30, 60, 10),

73 
	`RANGE
(60, 90, 100)})));

74 
	`»£t
();

76 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 90, 10)}), 
UCC_COLL_TYPE_BARRIER
);

77 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(30, 60, 100)}), 
UCC_COLL_TYPE_BARRIER
);

78 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

79 
UCC_COLL_TYPE_ALL
));

80 
	`EXPECT_EQ
(
UCC_OK
,

81 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

82 
	`RLIST
({
	`RANGE
(0, 30, 10), RANGE(30, 60, 100),

83 
	`RANGE
(60, 90, 10)})));

84 
	}
}

86 
	$UCC_TEST_F
(
‹¡_scÜe_upd©e
, 
§me_¡¬t
)

88 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
);

89 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(0, 50, 10)}), 
UCC_COLL_TYPE_BARRIER
);

90 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

91 
UCC_COLL_TYPE_ALL
));

92 
	`EXPECT_EQ
(
UCC_OK
,

93 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

94 
	`RLIST
({
	`RANGE
(0, 50, 10), RANGE(50, 100, 100)})));

95 
	`»£t
();

97 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 10)}), 
UCC_COLL_TYPE_BARRIER
);

98 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(0, 50, 100)}), 
UCC_COLL_TYPE_BARRIER
);

99 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

100 
UCC_COLL_TYPE_ALL
));

101 
	`EXPECT_EQ
(
UCC_OK
,

102 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

103 
	`RLIST
({
	`RANGE
(0, 50, 100), RANGE(50, 100, 10)})));

104 
	`»£t
();

106 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(1, 100, 10)}), 
UCC_COLL_TYPE_BARRIER
);

107 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(1, 50, 100)}), 
UCC_COLL_TYPE_BARRIER
);

108 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

109 
UCC_COLL_TYPE_ALL
));

110 
	`EXPECT_EQ
(
UCC_OK
,

111 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

112 
	`RLIST
({
	`RANGE
(1, 50, 100), RANGE(50, 100, 10)})));

113 
	}
}

115 
	$UCC_TEST_F
(
‹¡_scÜe_upd©e
, 1
_ov”Ïps_mªy
)

117 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
);

118 
	`š™_scÜe
(
upd©e
,

119 
	`RLIST
({
	`RANGE
(10, 20, 10), RANGE(30, 40, 20), RANGE(60, 70, 30)}),

120 
UCC_COLL_TYPE_BARRIER
);

121 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

122 
UCC_COLL_TYPE_ALL
));

123 
	`EXPECT_EQ
(
UCC_OK
,

124 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

125 
	`RLIST
({
	`RANGE
(0, 10, 100), RANGE(10, 20, 10),

126 
	`RANGE
(20, 30, 100), RANGE(30, 40, 20),

127 
	`RANGE
(40, 60, 100), RANGE(60, 70, 30),

128 
	`RANGE
(70, 100, 100)})));

129 
	`»£t
();

131 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 10)}), 
UCC_COLL_TYPE_BARRIER
);

132 
	`š™_scÜe
(

133 
upd©e
,

134 
	`RLIST
({
	`RANGE
(10, 20, 100), RANGE(30, 40, 100), RANGE(60, 70, 5)}),

135 
UCC_COLL_TYPE_BARRIER
);

136 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

137 
UCC_COLL_TYPE_ALL
));

138 
	`EXPECT_EQ
(
UCC_OK
,

139 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

140 
	`RLIST
({
	`RANGE
(0, 10, 10), RANGE(10, 20, 100),

141 
	`RANGE
(20, 30, 10), RANGE(30, 40, 100),

142 
	`RANGE
(40, 60, 10), RANGE(60, 70, 5),

143 
	`RANGE
(70, 100, 10)})));

144 
	}
}

146 
	$UCC_TEST_F
(
‹¡_scÜe_upd©e
, 
§me_scÜe
)

148 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
);

149 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(100, 200, 100)}), 
UCC_COLL_TYPE_BARRIER
);

150 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

151 
UCC_COLL_TYPE_ALL
));

152 
	`EXPECT_EQ
(
UCC_OK
,

153 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

154 
	`RLIST
({
	`RANGE
(0, 100, 100)})));

155 
	}
}

157 
	$UCC_TEST_F
(
‹¡_scÜe_upd©e
, 
nÚ_ov”Ïp_2
)

159 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
, 0x1,

161 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(300, 400, 100)}), 
UCC_COLL_TYPE_BARRIER
,

163 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

164 
UCC_COLL_TYPE_ALL
));

165 
	`EXPECT_EQ
(
UCC_OK
,

166 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

167 
	`RLIST
({
	`RANGE
(0, 100, 100), RANGE(300, 400, 100)})));

168 
	}
}

170 
	$UCC_TEST_F
(
‹¡_scÜe_upd©e
, 
š™_»£t
)

172 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
, 0x1,

174 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
, 0x2,

176 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

177 
UCC_COLL_TYPE_ALL
));

178 
	`EXPECT_EQ
(
UCC_OK
,

179 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

180 
	`RLIST
({
	`RANGE
(0, 100, 100)})));

181 
	`EXPECT_EQ
(0x2, (
ušt64_t
)(
	`FIRST_RANGE
(
scÜe
, 
BARRIER
, 
HOST
)->
su³r
.
š™
));

183 
	`»£t
();

185 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(0, 100, 100)}), 
UCC_COLL_TYPE_BARRIER
, 0x1,

187 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(50, 150, 50)}), 
UCC_COLL_TYPE_BARRIER
, 0x2,

189 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

190 
UCC_COLL_TYPE_ALL
));

191 
	`EXPECT_EQ
(
UCC_OK
,

192 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

193 
	`RLIST
({
	`RANGE
(0, 50, 100), RANGE(50, 100, 50),

194 
	`RANGE
(100, 150, 50)})));

195 
	`EXPECT_EQ
(0x1, (
ušt64_t
)(
	`FIRST_RANGE
(
scÜe
, 
BARRIER
, 
HOST
)->
su³r
.
š™
));

197 
	`»£t
();

198 
	`š™_scÜe
(
scÜe
, 
	`RLIST
({
	`RANGE
(50, 150, 100)}), 
UCC_COLL_TYPE_BARRIER
, 0x1,

200 
	`š™_scÜe
(
upd©e
, 
	`RLIST
({
	`RANGE
(0, 100, 50)}), 
UCC_COLL_TYPE_BARRIER
, 0x2,

202 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_scÜe_upd©e
(
scÜe
, 
upd©e
, 0, 
NULL
, 0,

203 
UCC_COLL_TYPE_ALL
));

204 
	`EXPECT_EQ
(
UCC_OK
,

205 
	`check_¿nge
(
scÜe
, 
UCC_COLL_TYPE_BARRIER
, 
UCC_MEMORY_TYPE_HOST
,

206 
	`RLIST
({
	`RANGE
(0, 50, 50), RANGE(50, 100, 50),

207 
	`RANGE
(100, 150, 100)})));

208 
	`EXPECT_EQ
(0x2, (
ušt64_t
)(
	`FIRST_RANGE
(
scÜe
, 
BARRIER
, 
HOST
)->
su³r
.
š™
));

209 
	}
}

	@test/gtest/coll_score/test_update_score.cc

6 
	~"cŞl_£Ëù/cŞl_£Ëù.h
"

8 
	~<commÚ/‹¡.h
>

9 
	~<¡ršg
>

10 
	~<veùÜ
>

12 şas 
	c‹¡_scÜe_upd©e
 : 
public
 
ucc
::
‹¡
 {

	@test/gtest/common/gtest-all.cc

38 
	~"g‹¡.h
"

108 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_SPI_H_


109 
	#GTEST_INCLUDE_GTEST_GTEST_SPI_H_


	)

112 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4251 \

115 
Çme¥aû
 
	g‹¡šg
 {

126 şas 
	cGTEST_API_
 
	gScİedFakeTe¡P¬tResuÉR•Ü‹r


127 : 
public
 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
 {

128 
public
:

130 
	eIÁ”û±Mode
 {

131 
INTERCEPT_ONLY_CURRENT_THREAD
,

132 
	gINTERCEPT_ALL_THREADS


139 
ex¶ic™
 
ScİedFakeTe¡P¬tResuÉR•Ü‹r
(
Te¡P¬tResuÉA¼ay
* 
»suÉ
);

142 
ScİedFakeTe¡P¬tResuÉR•Ü‹r
(
IÁ”û±Mode
 
š‹rû±_mode
,

143 
Te¡P¬tResuÉA¼ay
* 
»suÉ
);

146 ~
ScİedFakeTe¡P¬tResuÉR•Ü‹r
(è
	gov”ride
;

153 
R•ÜtTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
è
	gov”ride
;

155 
	g´iv©e
:

156 
In™
();

158 cÚ¡ 
IÁ”û±Mode
 
	gš‹rû±_mode_
;

159 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
* 
	gŞd_»pÜ‹r_
;

160 
Te¡P¬tResuÉA¼ay
* cÚ¡ 
	g»suÉ_
;

162 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
ScİedFakeTe¡P¬tResuÉR•Ü‹r
);

165 
Çme¥aû
 
	gš‹º®
 {

172 şas 
	cGTEST_API_
 
	gSšgËFau»Check”
 {

173 
	gpublic
:

175 
SšgËFau»Check”
(cÚ¡ 
Te¡P¬tResuÉA¼ay
* 
»suÉs
,

176 
Te¡P¬tResuÉ
::
Ty³
 
ty³
, cÚ¡ 
¡d
::
¡ršg
& 
sub¡r
);

177 ~
SšgËFau»Check”
();

178 
	g´iv©e
:

179 cÚ¡ 
Te¡P¬tResuÉA¼ay
* cÚ¡ 
»suÉs_
;

180 cÚ¡ 
	gTe¡P¬tResuÉ
::
Ty³
 
ty³_
;

181 cÚ¡ 
	g¡d
::
¡ršg
 
sub¡r_
;

183 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
SšgËFau»Check”
);

190 
	$GTEST_DISABLE_MSC_WARNINGS_POP_
()

215 
	#EXPECT_FATAL_FAILURE
(
¡©em’t
, 
sub¡r
) \

217 şas 
	cGTe¡Ex³ùF©®Fau»H–³r
 {\

218 
public
:\

219 
	`Execu‹
(è{ 
¡©em’t
; }\

220 
	}
};\

221 ::
‹¡šg
::
Te¡P¬tResuÉA¼ay
 
g‹¡_çu»s
;\

222 ::
‹¡šg
::
š‹º®
::
SšgËFau»Check”
 
	`g‹¡_check”
(\

223 &
g‹¡_çu»s
, ::
‹¡šg
::
Te¡P¬tResuÉ
::
kF©®Fau»
, (
sub¡r
));\

225 ::
‹¡šg
::
ScİedFakeTe¡P¬tResuÉR•Ü‹r
 
	`g‹¡_»pÜ‹r
(\

226 ::
‹¡šg
::
ScİedFakeTe¡P¬tResuÉR•Ü‹r
:: \

227 
INTERCEPT_ONLY_CURRENT_THREAD
, &
g‹¡_çu»s
);\

228 
GTe¡Ex³ùF©®Fau»H–³r
::
	`Execu‹
();\

230 } ::
‹¡šg
::
š‹º®
::
	`AlwaysF®£
())

	)

232 
	#EXPECT_FATAL_FAILURE_ON_ALL_THREADS
(
¡©em’t
, 
sub¡r
) \

234 şas 
	cGTe¡Ex³ùF©®Fau»H–³r
 {\

235 
public
:\

236 
	`Execu‹
(è{ 
¡©em’t
; }\

238 ::
‹¡šg
::
Te¡P¬tResuÉA¼ay
 
g‹¡_çu»s
;\

239 ::
‹¡šg
::
š‹º®
::
SšgËFau»Check”
 
	`g‹¡_check”
(\

240 &
g‹¡_çu»s
, ::
‹¡šg
::
Te¡P¬tResuÉ
::
kF©®Fau»
, (
sub¡r
));\

242 ::
‹¡šg
::
ScİedFakeTe¡P¬tResuÉR•Ü‹r
 
	`g‹¡_»pÜ‹r
(\

243 ::
‹¡šg
::
ScİedFakeTe¡P¬tResuÉR•Ü‹r
:: \

244 
INTERCEPT_ALL_THREADS
, &
g‹¡_çu»s
);\

245 
GTe¡Ex³ùF©®Fau»H–³r
::
	`Execu‹
();\

247 } ::
‹¡šg
::
š‹º®
::
	`AlwaysF®£
())

	)

281 
	#EXPECT_NONFATAL_FAILURE
(
¡©em’t
, 
sub¡r
) \

283 ::
‹¡šg
::
Te¡P¬tResuÉA¼ay
 
g‹¡_çu»s
;\

284 ::
‹¡šg
::
š‹º®
::
SšgËFau»Check”
 
	`g‹¡_check”
(\

285 &
g‹¡_çu»s
, ::
‹¡šg
::
Te¡P¬tResuÉ
::
kNÚF©®Fau»
, \

286 (
sub¡r
));\

288 ::
‹¡šg
::
ScİedFakeTe¡P¬tResuÉR•Ü‹r
 
	`g‹¡_»pÜ‹r
(\

289 ::
‹¡šg
::
ScİedFakeTe¡P¬tResuÉR•Ü‹r
:: \

290 
INTERCEPT_ONLY_CURRENT_THREAD
, &
g‹¡_çu»s
);\

291 ià(::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()è{ 
¡©em’t
; }\

293 } ::
‹¡šg
::
š‹º®
::
	`AlwaysF®£
())

	)

295 
	#EXPECT_NONFATAL_FAILURE_ON_ALL_THREADS
(
¡©em’t
, 
sub¡r
) \

297 ::
‹¡šg
::
Te¡P¬tResuÉA¼ay
 
g‹¡_çu»s
;\

298 ::
‹¡šg
::
š‹º®
::
SšgËFau»Check”
 
	`g‹¡_check”
(\

299 &
g‹¡_çu»s
, ::
‹¡šg
::
Te¡P¬tResuÉ
::
kNÚF©®Fau»
, \

300 (
sub¡r
));\

302 ::
‹¡šg
::
ScİedFakeTe¡P¬tResuÉR•Ü‹r
 
	`g‹¡_»pÜ‹r
(\

303 ::
‹¡šg
::
ScİedFakeTe¡P¬tResuÉR•Ü‹r
::
INTERCEPT_ALL_THREADS
, \

304 &
g‹¡_çu»s
);\

305 ià(::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()è{ 
¡©em’t
; }\

307 } ::
‹¡šg
::
š‹º®
::
	`AlwaysF®£
())

	)

311 
	~<ùy³.h
>

312 
	~<m©h.h
>

313 
	~<¡d¬g.h
>

314 
	~<¡dio.h
>

315 
	~<¡dlib.h
>

316 
	~<time.h
>

317 
	~<wch¬.h
>

318 
	~<wùy³.h
>

320 
	~<®gÜ™hm
>

321 
	~<iomª
>

322 
	~<lim™s
>

323 
	~<li¡
>

324 
	~<m­
>

325 
	~<o¡»am
>

326 
	~<s¡»am
>

327 
	~<veùÜ
>

329 #ià
GTEST_OS_LINUX


331 
	#GTEST_HAS_GETTIMEOFDAY_
 1

	)

333 
	~<fú.h
>

334 
	~<lim™s.h
>

335 
	~<sched.h
>

337 
	~<¡ršgs.h
>

338 
	~<sys/mmª.h
>

339 
	~<sys/time.h
>

340 
	~<uni¡d.h
>

341 
	~<¡ršg
>

343 #–ià
GTEST_OS_ZOS


344 
	#GTEST_HAS_GETTIMEOFDAY_
 1

	)

345 
	~<sys/time.h
>

348 
	~<¡ršgs.h
>

350 #–ià
GTEST_OS_WINDOWS_MOBILE


352 
	~<wšdows.h
>

353 #undeà
mš


355 #–ià
GTEST_OS_WINDOWS


357 
	~<wšdows.h
>

358 #undeà
mš


360 
	~<ütdbg.h
>

361 
	~<debug­i.h
>

362 
	~<io.h
>

363 
	~<sys/timeb.h
>

364 
	~<sys/ty³s.h
>

365 
	~<sys/¡©.h
>

367 #ià
GTEST_OS_WINDOWS_MINGW


369 
	#GTEST_HAS_GETTIMEOFDAY_
 1

	)

370 
	~<sys/time.h
>

376 
	#GTEST_HAS_GETTIMEOFDAY_
 1

	)

380 
	~<sys/time.h
>

381 
	~<uni¡d.h
>

385 #ià
GTEST_HAS_EXCEPTIONS


386 
	~<¡dexû±
>

389 #ià
GTEST_CAN_STREAM_RESULTS_


390 
	~<¬·/š‘.h
>

391 
	~<Ãtdb.h
>

392 
	~<sys/sock‘.h
>

393 
	~<sys/ty³s.h
>

429 #iâdeà
GTEST_SRC_GTEST_INTERNAL_INL_H_


430 
	#GTEST_SRC_GTEST_INTERNAL_INL_H_


	)

432 #iâdeà
_WIN32_WCE


433 
	~<”ºo.h
>

435 
	~<¡ddef.h
>

436 
	~<¡dlib.h
>

437 
	~<¡ršg.h
>

439 
	~<®gÜ™hm
>

440 
	~<memÜy
>

441 
	~<¡ršg
>

442 
	~<veùÜ
>

445 #ià
GTEST_CAN_STREAM_RESULTS_


446 
	~<¬·/š‘.h
>

447 
	~<Ãtdb.h
>

450 #ià
GTEST_OS_WINDOWS


451 
	~<wšdows.h
>

455 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4251 \

458 
Çme¥aû
 
	g‹¡šg
 {

465 
GTEST_DECLARE_boŞ_
(
d—th_‹¡_u£_fÜk
);

467 
Çme¥aû
 
	gš‹º®
 {

471 
GTEST_API_
 cÚ¡ 
Ty³Id
 
kTe¡Ty³IdInGoogËTe¡
;

474 cÚ¡ 
	gkAlsoRunDi§bËdTe¡sFÏg
[] = "also_run_disabled_tests";

475 cÚ¡ 
	gkB»akOnFau»FÏg
[] = "break_on_failure";

476 cÚ¡ 
	gkC©chExû±iÚsFÏg
[] = "catch_exceptions";

477 cÚ¡ 
	gkCŞÜFÏg
[] = "color";

478 cÚ¡ 
	gkF‹rFÏg
[] = "filter";

479 cÚ¡ 
	gkLi¡Te¡sFÏg
[] = "list_tests";

480 cÚ¡ 
	gkOuutFÏg
[] = "output";

481 cÚ¡ 
	gkPrštTimeFÏg
[] = "print_time";

482 cÚ¡ 
	gkPrštUTF8FÏg
[] = "print_utf8";

483 cÚ¡ 
	gkRªdomS“dFÏg
[] = "random_seed";

484 cÚ¡ 
	gkR•—tFÏg
[] = "repeat";

485 cÚ¡ 
	gkShufæeFÏg
[] = "shuffle";

486 cÚ¡ 
	gkSckT¿ûD•thFÏg
[] = "stack_trace_depth";

487 cÚ¡ 
	gkSŒ—mResuÉToFÏg
[] = "stream_result_to";

488 cÚ¡ 
	gkThrowOnFau»FÏg
[] = "throw_on_failure";

489 cÚ¡ 
	gkFÏgfeFÏg
[] = "flagfile";

490 cÚ¡ 
	gkPrštSk³dFÏg
[] = "print_skipped";

493 cÚ¡ 
	gkMaxRªdomS“d
 = 99999;

497 
GTEST_API_
 
boŞ
 
g_h–p_æag
;

500 
GTEST_API_
 
TimeInMlis
 
G‘TimeInMlis
();

503 
GTEST_API_
 
boŞ
 
ShouldU£CŞÜ
(boŞ 
¡dout_is_‰y
);

506 
GTEST_API_
 
	g¡d
::
¡ršg
 
FÜm©TimeInMlisAsSecÚds
(
TimeInMlis
 
ms
);

512 
GTEST_API_
 
	g¡d
::
¡ršg
 
FÜm©EpochTimeInMlisAsIso8601
(
TimeInMlis
 
ms
);

518 
GTEST_API_
 
boŞ
 
P¬£IÁ32FÏg
(

519 cÚ¡ * 
¡r
, cÚ¡ * 
æag
, 
IÁ32
* 
v®ue
);

523 
šlše
 
G‘RªdomS“dFromFÏg
(
IÁ32
 
¿ndom_£ed_æag
) {

524 cÚ¡ 
	g¿w_£ed
 = (
¿ndom_£ed_æag
 == 0) ?

525 
¡©ic_ÿ¡
<>(
G‘TimeInMlis
()) :

526 
¡©ic_ÿ¡
<>(
¿ndom_£ed_æag
);

530 cÚ¡ 
	gnÜm®ized_£ed
 =

531 
¡©ic_ÿ¡
<>((
¿w_£ed
 - 1U) %

532 
¡©ic_ÿ¡
<>(
kMaxRªdomS“d
)) + 1;

533  
	gnÜm®ized_£ed
;

539 
šlše
 
G‘NextRªdomS“d
(
£ed
) {

540 
GTEST_CHECK_
(1 <ğ
£ed
 && s“d <ğ
kMaxRªdomS“d
)

541 << "Inv®id„ªdom s“d " << 
£ed
 << " - must be in [1, "

542 << 
kMaxRªdomS“d
 << "].";

543 cÚ¡ 
	gÃxt_£ed
 = 
£ed
 + 1;

544  (
	gÃxt_£ed
 > 
	gkMaxRªdomS“d
è? 1 : 
Ãxt_£ed
;

549 şas 
	cGTe¡FÏgSav”
 {

550 
	gpublic
:

552 
GTe¡FÏgSav”
() {

553 
®so_run_di§bËd_‹¡s_
 = 
GTEST_FLAG
(
®so_run_di§bËd_‹¡s
);

554 
	gb»ak_Ú_çu»_
 = 
GTEST_FLAG
(
b»ak_Ú_çu»
);

555 
	gÿtch_exû±iÚs_
 = 
GTEST_FLAG
(
ÿtch_exû±iÚs
);

556 
	gcŞÜ_
 = 
GTEST_FLAG
(
cŞÜ
);

557 
	gd—th_‹¡_¡yË_
 = 
GTEST_FLAG
(
d—th_‹¡_¡yË
);

558 
	gd—th_‹¡_u£_fÜk_
 = 
GTEST_FLAG
(
d—th_‹¡_u£_fÜk
);

559 
	gf‹r_
 = 
GTEST_FLAG
(
f‹r
);

560 
	gš‹º®_run_d—th_‹¡_
 = 
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
);

561 
	gli¡_‹¡s_
 = 
GTEST_FLAG
(
li¡_‹¡s
);

562 
	gouut_
 = 
GTEST_FLAG
(
ouut
);

563 
	g´št_time_
 = 
GTEST_FLAG
(
´št_time
);

564 
	g´št_utf8_
 = 
GTEST_FLAG
(
´št_utf8
);

565 
	g¿ndom_£ed_
 = 
GTEST_FLAG
(
¿ndom_£ed
);

566 
	g»³©_
 = 
GTEST_FLAG
(
»³©
);

567 
	gshufæe_
 = 
GTEST_FLAG
(
shufæe
);

568 
	g¡ack_Œaû_d•th_
 = 
GTEST_FLAG
(
¡ack_Œaû_d•th
);

569 
	g¡»am_»suÉ_to_
 = 
GTEST_FLAG
(
¡»am_»suÉ_to
);

570 
	gthrow_Ú_çu»_
 = 
GTEST_FLAG
(
throw_Ú_çu»
);

571 
	g´št_sk³d_
 = 
GTEST_FLAG
(
´št_sk³d
);

575 ~
GTe¡FÏgSav”
() {

576 
GTEST_FLAG
(
®so_run_di§bËd_‹¡s
èğ
®so_run_di§bËd_‹¡s_
;

577 
GTEST_FLAG
(
b»ak_Ú_çu»
èğ
b»ak_Ú_çu»_
;

578 
GTEST_FLAG
(
ÿtch_exû±iÚs
èğ
ÿtch_exû±iÚs_
;

579 
GTEST_FLAG
(
cŞÜ
èğ
cŞÜ_
;

580 
GTEST_FLAG
(
d—th_‹¡_¡yË
èğ
d—th_‹¡_¡yË_
;

581 
GTEST_FLAG
(
d—th_‹¡_u£_fÜk
èğ
d—th_‹¡_u£_fÜk_
;

582 
GTEST_FLAG
(
f‹r
èğ
f‹r_
;

583 
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
èğ
š‹º®_run_d—th_‹¡_
;

584 
GTEST_FLAG
(
li¡_‹¡s
èğ
li¡_‹¡s_
;

585 
GTEST_FLAG
(
ouut
èğ
ouut_
;

586 
GTEST_FLAG
(
´št_time
èğ
´št_time_
;

587 
GTEST_FLAG
(
´št_utf8
èğ
´št_utf8_
;

588 
GTEST_FLAG
(
¿ndom_£ed
èğ
¿ndom_£ed_
;

589 
GTEST_FLAG
(
»³©
èğ
»³©_
;

590 
GTEST_FLAG
(
shufæe
èğ
shufæe_
;

591 
GTEST_FLAG
(
¡ack_Œaû_d•th
èğ
¡ack_Œaû_d•th_
;

592 
GTEST_FLAG
(
¡»am_»suÉ_to
èğ
¡»am_»suÉ_to_
;

593 
GTEST_FLAG
(
throw_Ú_çu»
èğ
throw_Ú_çu»_
;

594 
GTEST_FLAG
(
´št_sk³d
èğ
´št_sk³d_
;

597 
	g´iv©e
:

599 
boŞ
 
®so_run_di§bËd_‹¡s_
;

600 
boŞ
 
	gb»ak_Ú_çu»_
;

601 
boŞ
 
	gÿtch_exû±iÚs_
;

602 
	g¡d
::
¡ršg
 
cŞÜ_
;

603 
	g¡d
::
¡ršg
 
d—th_‹¡_¡yË_
;

604 
boŞ
 
	gd—th_‹¡_u£_fÜk_
;

605 
	g¡d
::
¡ršg
 
f‹r_
;

606 
	g¡d
::
¡ršg
 
š‹º®_run_d—th_‹¡_
;

607 
boŞ
 
	gli¡_‹¡s_
;

608 
	g¡d
::
¡ršg
 
ouut_
;

609 
boŞ
 
	g´št_time_
;

610 
boŞ
 
	g´št_utf8_
;

611 
	gš‹º®
::
IÁ32
 
¿ndom_£ed_
;

612 
	gš‹º®
::
IÁ32
 
»³©_
;

613 
boŞ
 
	gshufæe_
;

614 
	gš‹º®
::
IÁ32
 
¡ack_Œaû_d•th_
;

615 
	g¡d
::
¡ršg
 
¡»am_»suÉ_to_
;

616 
boŞ
 
	gthrow_Ú_çu»_
;

617 
boŞ
 
	g´št_sk³d_
;

618 } 
	gGTEST_ATTRIBUTE_UNUSED_
;

626 
GTEST_API_
 
	g¡d
::
¡ršg
 
CodePoštToUtf8
(
UIÁ32
 
code_pošt
);

641 
GTEST_API_
 
	g¡d
::
¡ršg
 
WideSŒšgToUtf8
(cÚ¡ 
wch¬_t
* 
¡r
, 
num_ch¬s
);

647 
Wr™eToSh¬dStusFeIfN“ded
();

655 
GTEST_API_
 
boŞ
 
ShouldSh¬d
(cÚ¡ * 
tÙ®_sh¬ds_¡r
,

656 cÚ¡ * 
sh¬d_šdex_¡r
,

657 
boŞ
 
š_sub´oûss_fÜ_d—th_‹¡
);

662 
GTEST_API_
 
IÁ32
 
IÁ32FromEnvOrD›
(cÚ¡ * 
’v_v¬
, IÁ32 
deçuÉ_v®
);

668 
GTEST_API_
 
boŞ
 
ShouldRunTe¡OnSh¬d
(

669 
tÙ®_sh¬ds
, 
sh¬d_šdex
, 
‹¡_id
);

675 
	g‹m¶©e
 <
şass
 
	gCÚš”
, 
ty³Çme
 
	gP»diÿ‹
>

676 
šlše
 
CouÁIf
(cÚ¡ 
CÚš”
& 
c
, 
P»diÿ‹
 
´ediÿ‹
) {

679 
	gcouÁ
 = 0;

680 
ty³Çme
 
	gCÚš”
::
cÚ¡_™”©Ü
 
™
 = 
c
.
begš
(); 
	g™
 !ğc.
’d
(); ++it) {

681 ià(
´ediÿ‹
(*
™
))

682 ++
	gcouÁ
;

684  
	gcouÁ
;

688 
	g‹m¶©e
 <
şass
 
	gCÚš”
, 
ty³Çme
 
	gFunùÜ
>

689 
FÜEach
(cÚ¡ 
CÚš”
& 
c
, 
FunùÜ
 
funùÜ
) {

690 
	g¡d
::
fÜ_—ch
(
c
.
begš
(), c.
’d
(), 
funùÜ
);

695 
	g‹m¶©e
 <
ty³Çme
 
	gE
>

696 
šlše
 
E
 
G‘EËm’tOr
(cÚ¡ 
¡d
::
veùÜ
<E>& 
v
, 
i
, E 
deçuÉ_v®ue
) {

697  (
	gi
 < 0 || i >ğ
¡©ic_ÿ¡
<>(
v
.
size
())è? 
deçuÉ_v®ue


698 : 
v
[
¡©ic_ÿ¡
<
size_t
>(
i
)];

705 
	g‹m¶©e
 <
ty³Çme
 
	gE
>

706 
ShufæeRªge
(
š‹º®
::
Rªdom
* 
¿ndom
, 
begš
, 
’d
,

707 
¡d
::
veùÜ
<
E
>* 
v
) {

708 cÚ¡ 
size
 = 
¡©ic_ÿ¡
<>(
v
->size());

709 
GTEST_CHECK_
(0 <ğ
begš
 && begš <ğ
size
)

710 << "Inv®id shufæ¿ng¡¬ˆ" << 
begš
 << ": must be in„ange [0, "

711 << 
size
 << "].";

712 
GTEST_CHECK_
(
begš
 <ğ
’d
 &&ƒnd <ğ
size
)

713 << "Inv®id shufæ¿ngfšish " << 
’d
 << ": must be in„ange ["

714 << 
begš
 << ", " << 
size
 << "].";

718 
	g¿nge_width
 = 
’d
 - 
begš
;„ange_width >= 2;„ange_width--) {

719 cÚ¡ 
	gÏ¡_š_¿nge
 = 
begš
 + 
¿nge_width
 - 1;

720 cÚ¡ 
	g£Ëùed
 =

721 
begš
 +

722 
¡©ic_ÿ¡
<>(
¿ndom
->
G’”©e
(¡©ic_ÿ¡<
UIÁ32
>(
¿nge_width
)));

723 
	g¡d
::
sw­
((*
v
)[
¡©ic_ÿ¡
<
size_t
>(
£Ëùed
)],

724 (*
v
)[
¡©ic_ÿ¡
<
size_t
>(
Ï¡_š_¿nge
)]);

729 
	g‹m¶©e
 <
ty³Çme
 
	gE
>

730 
šlše
 
Shufæe
(
š‹º®
::
Rªdom
* 
¿ndom
, 
¡d
::
veùÜ
<
E
>* 
v
) {

731 
ShufæeRªge
(
¿ndom
, 0, 
¡©ic_ÿ¡
<>(
v
->
size
()), v);

736 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

737 
D–‘e
(
T
* 
x
) {

738 
d–‘e
 
	gx
;

744 şas 
	cTe¡Prİ”tyKeyIs
 {

745 
	gpublic
:

749 
ex¶ic™
 
Te¡Prİ”tyKeyIs
(cÚ¡ 
¡d
::
¡ršg
& 
key
è: 
key_
(key) {}

752 
boŞ
 
İ”©Ü
()(cÚ¡ 
Te¡Prİ”ty
& 
‹¡_´İ”ty
) const {

753  
‹¡_´İ”ty
.
key
(è=ğ
key_
;

756 
	g´iv©e
:

757 
¡d
::
¡ršg
 
key_
;

770 şas 
	cGTEST_API_
 
	gUn™Te¡O±iÚs
 {

771 
	gpublic
:

775 
¡d
::
¡ršg
 
G‘OuutFÜm©
();

780 
	g¡d
::
¡ršg
 
G‘AbsŞu‹P©hToOuutFe
();

789 
boŞ
 
P©‹ºM©chesSŒšg
(cÚ¡ *
·‰”n
, cÚ¡ *
¡r
);

793 
boŞ
 
F‹rM©chesTe¡
(cÚ¡ 
¡d
::
¡ršg
& 
‹¡_su™e_Çme
,

794 cÚ¡ 
¡d
::
¡ršg
& 
‹¡_Çme
);

796 #ià
GTEST_OS_WINDOWS


802 
GTe¡ShouldProûssSEH
(
DWORD
 
exû±iÚ_code
);

807 
boŞ
 
M©chesF‹r
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, cÚ¡ * 
f‹r
);

812 
GTEST_API_
 
FeP©h
 
G‘Cu¼’tExecubËName
();

815 şas 
	cOsSckT¿ûG‘‹rIÁ”çû
 {

816 
	gpublic
:

817 
OsSckT¿ûG‘‹rIÁ”çû
() {}

818 
vœtu®
 ~
OsSckT¿ûG‘‹rIÁ”çû
() {}

826 
vœtu®
 
¡d
::
¡ršg
 
Cu¼’tSckT¿û
(
max_d•th
, 
sk_couÁ
) = 0;

831 
vœtu®
 
UpÚL—všgGTe¡
() = 0;

835 cÚ¡ * cÚ¡ 
	gkElidedF¿mesM¬k”
;

837 
	g´iv©e
:

838 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
OsSckT¿ûG‘‹rIÁ”çû
);

842 şas 
	cOsSckT¿ûG‘‹r
 : 
public
 
OsSckT¿ûG‘‹rIÁ”çû
 {

843 
public
:

844 
OsSckT¿ûG‘‹r
() {}

846 
¡d
::
¡ršg
 
Cu¼’tSckT¿û
(
max_d•th
, 
sk_couÁ
è
	gov”ride
;

847 
UpÚL—všgGTe¡
(è
	gov”ride
;

849 
	g´iv©e
:

850 #ià
GTEST_HAS_ABSL


851 
Mu‹x
 
mu‹x_
;

857 * 
	gÿÎ”_äame_
 = 
nuÎ±r
;

860 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
OsSckT¿ûG‘‹r
);

864 
	sT¿ûInfo
 {

865 cÚ¡ * 
	gfe
;

866 
	glše
;

867 
	g¡d
::
¡ršg
 
mes§ge
;

872 şas 
	cDeçuÉGlob®Te¡P¬tResuÉR•Ü‹r


873 : 
public
 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
 {

874 
public
:

875 
ex¶ic™
 
DeçuÉGlob®Te¡P¬tResuÉR•Ü‹r
(
Un™Te¡Im¶
* 
un™_‹¡
);

878 
R•ÜtTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
è
	gov”ride
;

880 
	g´iv©e
:

881 
Un™Te¡Im¶
* cÚ¡ 
un™_‹¡_
;

883 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
DeçuÉGlob®Te¡P¬tResuÉR•Ü‹r
);

888 şas 
	cDeçuÉP”Th»adTe¡P¬tResuÉR•Ü‹r


889 : 
public
 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
 {

890 
public
:

891 
ex¶ic™
 
DeçuÉP”Th»adTe¡P¬tResuÉR•Ü‹r
(
Un™Te¡Im¶
* 
un™_‹¡
);

894 
R•ÜtTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
è
	gov”ride
;

896 
	g´iv©e
:

897 
Un™Te¡Im¶
* cÚ¡ 
un™_‹¡_
;

899 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
DeçuÉP”Th»adTe¡P¬tResuÉR•Ü‹r
);

906 şas 
	cGTEST_API_
 
	gUn™Te¡Im¶
 {

907 
	gpublic
:

908 
ex¶ic™
 
Un™Te¡Im¶
(
Un™Te¡
* 
·»Á
);

909 
	gvœtu®
 ~
Un™Te¡Im¶
();

919 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
* 
G‘Glob®Te¡P¬tResuÉR•Ü‹r
();

922 
S‘Glob®Te¡P¬tResuÉR•Ü‹r
(

923 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
* 
»pÜ‹r
);

926 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
* 
G‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
();

929 
S‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
(

930 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
* 
»pÜ‹r
);

933 
sucûssful_‹¡_su™e_couÁ
() const;

936 
çed_‹¡_su™e_couÁ
() const;

939 
tÙ®_‹¡_su™e_couÁ
() const;

943 
‹¡_su™e_to_run_couÁ
() const;

946 
sucûssful_‹¡_couÁ
() const;

949 
sk³d_‹¡_couÁ
() const;

952 
çed_‹¡_couÁ
() const;

955 
»pÜbË_di§bËd_‹¡_couÁ
() const;

958 
di§bËd_‹¡_couÁ
() const;

961 
»pÜbË_‹¡_couÁ
() const;

964 
tÙ®_‹¡_couÁ
() const;

967 
‹¡_to_run_couÁ
() const;

971 
TimeInMlis
 
¡¬t_time¡amp
(ècÚ¡ {  
	g¡¬t_time¡amp_
; }

974 
TimeInMlis
 
–­£d_time
(ècÚ¡ {  
	g–­£d_time_
; }

978 
boŞ
 
Pas£d
(ècÚ¡ {  !
Faed
(); }

982 
boŞ
 
Faed
() const {

983  
çed_‹¡_su™e_couÁ
(è> 0 || 
ad_hoc_‹¡_»suÉ
()->
Faed
();

988 cÚ¡ 
Te¡Su™e
* 
G‘Te¡Su™e
(
i
) const {

989 cÚ¡ 
	gšdex
 = 
G‘EËm’tOr
(
‹¡_su™e_šdiûs_
, 
i
, -1);

990  
	gšdex
 < 0 ? 
	gnuÎ±r
 : 
‹¡_su™es_
[
¡©ic_ÿ¡
<
size_t
>(
i
)];

994 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


995 cÚ¡ 
Te¡Ca£
* 
G‘Te¡Ca£
(
i
ècÚ¡ {  
G‘Te¡Su™e
(i); }

1000 
Te¡Su™e
* 
G‘MubËSu™eCa£
(
i
) {

1001 cÚ¡ 
	gšdex
 = 
G‘EËm’tOr
(
‹¡_su™e_šdiûs_
, 
i
, -1);

1002  
	gšdex
 < 0 ? 
	gnuÎ±r
 : 
‹¡_su™es_
[
¡©ic_ÿ¡
<
size_t
>(
šdex
)];

1006 
Te¡Ev’tLi¡’”s
* 
li¡’”s
(è{  &
	gli¡’”s_
; }

1010 
Te¡ResuÉ
* 
cu¼’t_‹¡_»suÉ
();

1013 cÚ¡ 
Te¡ResuÉ
* 
ad_hoc_‹¡_»suÉ
(ècÚ¡ {  &
	gad_hoc_‹¡_»suÉ_
; }

1020 
£t_os_¡ack_Œaû_g‘‹r
(
OsSckT¿ûG‘‹rIÁ”çû
* 
g‘‹r
);

1025 
OsSckT¿ûG‘‹rIÁ”çû
* 
os_¡ack_Œaû_g‘‹r
();

1037 
	g¡d
::
¡ršg
 
Cu¼’tOsSckT¿ûExû±Tİ
(
sk_couÁ
è
GTEST_NO_INLINE_
;

1049 
Te¡Su™e
* 
G‘Te¡Su™e
(cÚ¡ * 
‹¡_su™e_Çme
, cÚ¡ * 
ty³_·¿m
,

1050 
š‹º®
::
S‘UpTe¡Su™eFunc
 
£t_up_tc
,

1051 
š‹º®
::
T—rDownTe¡Su™eFunc
 
‹¬_down_tc
);

1054 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


1055 
Te¡Ca£
* 
G‘Te¡Ca£
(cÚ¡ * 
‹¡_ÿ£_Çme
, cÚ¡ * 
ty³_·¿m
,

1056 
š‹º®
::
S‘UpTe¡Su™eFunc
 
£t_up_tc
,

1057 
š‹º®
::
T—rDownTe¡Su™eFunc
 
‹¬_down_tc
) {

1058  
G‘Te¡Su™e
(
‹¡_ÿ£_Çme
, 
ty³_·¿m
, 
£t_up_tc
, 
‹¬_down_tc
);

1069 
AddTe¡Info
(
š‹º®
::
S‘UpTe¡Su™eFunc
 
£t_up_tc
,

1070 
š‹º®
::
T—rDownTe¡Su™eFunc
 
‹¬_down_tc
,

1071 
Te¡Info
* 
‹¡_šfo
) {

1079 ià(
	gÜigš®_wÜkšg_dœ_
.
IsEm±y
()) {

1080 
	gÜigš®_wÜkšg_dœ_
.
S‘
(
FeP©h
::
G‘Cu¼’tDœ
());

1081 
GTEST_CHECK_
(!
Üigš®_wÜkšg_dœ_
.
IsEm±y
())

1085 
G‘Te¡Su™e
(
‹¡_šfo
->
‹¡_su™e_Çme
(),e¡_šfo->
ty³_·¿m
(),

1086 
£t_up_tc
, 
‹¬_down_tc
)

1087 ->
AddTe¡Info
(
‹¡_šfo
);

1092 
	gš‹º®
::
P¬am‘”izedTe¡Su™eRegi¡ry
& 
·¿m‘”ized_‹¡_»gi¡ry
() {

1093  
·¿m‘”ized_‹¡_»gi¡ry_
;

1097 
£t_cu¼’t_‹¡_su™e
(
Te¡Su™e
* 
a_cu¼’t_‹¡_su™e
) {

1098 
	gcu¼’t_‹¡_su™e_
 = 
a_cu¼’t_‹¡_su™e
;

1104 
£t_cu¼’t_‹¡_šfo
(
Te¡Info
* 
a_cu¼’t_‹¡_šfo
) {

1105 
	gcu¼’t_‹¡_šfo_
 = 
a_cu¼’t_‹¡_šfo
;

1114 
Regi¡”P¬am‘”izedTe¡s
();

1120 
boŞ
 
RunAÎTe¡s
();

1123 
CË¬NÚAdHocTe¡ResuÉ
() {

1124 
FÜEach
(
‹¡_su™es_
, 
Te¡Su™e
::
CË¬Te¡Su™eResuÉ
);

1128 
CË¬AdHocTe¡ResuÉ
() {

1129 
	gad_hoc_‹¡_»suÉ_
.
CË¬
();

1136 
RecÜdPrİ”ty
(cÚ¡ 
Te¡Prİ”ty
& 
‹¡_´İ”ty
);

1138 
	eR—ùiÚToSh¬dšg
 {

1139 
	gHONOR_SHARDING_PROTOCOL
,

1140 
	gIGNORE_SHARDING_PROTOCOL


1149 
F‹rTe¡s
(
R—ùiÚToSh¬dšg
 
sh¬d_‹¡s
);

1152 
Li¡Te¡sM©chšgF‹r
();

1154 cÚ¡ 
Te¡Su™e
* 
cu¼’t_‹¡_su™e
(ècÚ¡ {  
	gcu¼’t_‹¡_su™e_
; }

1155 
Te¡Info
* 
cu¼’t_‹¡_šfo
(è{  
	gcu¼’t_‹¡_šfo_
; }

1156 cÚ¡ 
Te¡Info
* 
cu¼’t_‹¡_šfo
(ècÚ¡ {  
	gcu¼’t_‹¡_šfo_
; }

1160 
	g¡d
::
veùÜ
<
EnvœÚm’t
*>& 
’vœÚm’ts
(è{  
’vœÚm’ts_
; }

1163 
	g¡d
::
veùÜ
<
T¿ûInfo
>& 
g‹¡_Œaû_¡ack
() {

1164  *(
g‹¡_Œaû_¡ack_
.
poš‹r
());

1166 cÚ¡ 
	g¡d
::
veùÜ
<
T¿ûInfo
>& 
g‹¡_Œaû_¡ack
() const {

1167  
g‹¡_Œaû_¡ack_
.
g‘
();

1170 #ià
GTEST_HAS_DEATH_TEST


1171 
In™D—thTe¡Sub´oûssCÚŒŞInfo
() {

1172 
	gš‹º®_run_d—th_‹¡_æag_
.
»£t
(
P¬£IÁ”ÇlRunD—thTe¡FÏg
());

1178 cÚ¡ 
IÁ”ÇlRunD—thTe¡FÏg
* 
š‹º®_run_d—th_‹¡_æag
() const {

1179  
	gš‹º®_run_d—th_‹¡_æag_
.
g‘
();

1183 
	gš‹º®
::
D—thTe¡FaùÜy
* 
d—th_‹¡_çùÜy
() {

1184  
d—th_‹¡_çùÜy_
.
g‘
();

1187 
Suµ»ssTe¡Ev’tsIfInSub´oûss
();

1189 
ä›nd
 
şass
 
	gR•ÏûD—thTe¡FaùÜy
;

1194 
CÚfigu»XmlOuut
();

1196 #ià
GTEST_CAN_STREAM_RESULTS_


1199 
CÚfigu»SŒ—mšgOuut
();

1207 
Po¡FÏgP¬sšgIn™
();

1210 
¿ndom_£ed
(ècÚ¡ {  
	g¿ndom_£ed_
; }

1213 
	gš‹º®
::
Rªdom
* 
¿ndom
(è{  &
¿ndom_
; }

1217 
ShufæeTe¡s
();

1220 
UnshufæeTe¡s
();

1224 
boŞ
 
ÿtch_exû±iÚs
(ècÚ¡ {  
	gÿtch_exû±iÚs_
; }

1226 
	g´iv©e
:

1227 
ä›nd
 
şass
 ::
‹¡šg
::
Un™Te¡
;

1231 
£t_ÿtch_exû±iÚs
(
boŞ
 
v®ue
è{ 
	gÿtch_exû±iÚs_
 = value; }

1234 
Un™Te¡
* cÚ¡ 
	g·»Á_
;

1238 
	gš‹º®
::
FeP©h
 
Üigš®_wÜkšg_dœ_
;

1241 
DeçuÉGlob®Te¡P¬tResuÉR•Ü‹r
 
	gdeçuÉ_glob®_‹¡_·¹_»suÉ_»pÜ‹r_
;

1242 
DeçuÉP”Th»adTe¡P¬tResuÉR•Ü‹r


1243 
	gdeçuÉ_³r_th»ad_‹¡_·¹_»suÉ_»pÜ‹r_
;

1246 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
* 
	gglob®_‹¡_·¹_»suÉ_»pÙ”_
;

1249 
	gš‹º®
::
Mu‹x
 
glob®_‹¡_·¹_»suÉ_»pÜ‹r_mu‹x_
;

1252 
	gš‹º®
::
Th»adLoÿl
<
Te¡P¬tResuÉR•Ü‹rIÁ”çû
*>

1253 
³r_th»ad_‹¡_·¹_»suÉ_»pÜ‹r_
;

1257 
	g¡d
::
veùÜ
<
EnvœÚm’t
*> 
’vœÚm’ts_
;

1261 
	g¡d
::
veùÜ
<
Te¡Su™e
*> 
‹¡_su™es_
;

1267 
	g¡d
::
veùÜ
<> 
‹¡_su™e_šdiûs_
;

1271 
	gš‹º®
::
P¬am‘”izedTe¡Su™eRegi¡ry
 
·¿m‘”ized_‹¡_»gi¡ry_
;

1274 
boŞ
 
	g·¿m‘”ized_‹¡s_»gi¡”ed_
;

1277 
	gÏ¡_d—th_‹¡_su™e_
;

1283 
Te¡Su™e
* 
	gcu¼’t_‹¡_su™e_
;

1289 
Te¡Info
* 
	gcu¼’t_‹¡_šfo_
;

1299 
Te¡ResuÉ
 
	gad_hoc_‹¡_»suÉ_
;

1303 
Te¡Ev’tLi¡’”s
 
	gli¡’”s_
;

1309 
OsSckT¿ûG‘‹rIÁ”çû
* 
	gos_¡ack_Œaû_g‘‹r_
;

1312 
boŞ
 
	gpo¡_æag_·r£_š™_³rfÜmed_
;

1315 
	g¿ndom_£ed_
;

1318 
	gš‹º®
::
Rªdom
 
¿ndom_
;

1322 
TimeInMlis
 
	g¡¬t_time¡amp_
;

1325 
TimeInMlis
 
	g–­£d_time_
;

1327 #ià
GTEST_HAS_DEATH_TEST


1330 
	g¡d
::
unique_±r
<
IÁ”ÇlRunD—thTe¡FÏg
> 
š‹º®_run_d—th_‹¡_æag_
;

1331 
	g¡d
::
unique_±r
<
š‹º®
::
D—thTe¡FaùÜy
> 
d—th_‹¡_çùÜy_
;

1335 
	gš‹º®
::
Th»adLoÿl
<
¡d
::
veùÜ
<
T¿ûInfo
> > 
g‹¡_Œaû_¡ack_
;

1339 
boŞ
 
	gÿtch_exû±iÚs_
;

1341 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Un™Te¡Im¶
);

1346 
šlše
 
Un™Te¡Im¶
* 
G‘Un™Te¡Im¶
() {

1347  
	gUn™Te¡
::
G‘In¡ªû
()->
im¶
();

1350 #ià
GTEST_USES_SIMPLE_RE


1354 
GTEST_API_
 
boŞ
 
IsInS‘
(
ch
, cÚ¡ * 
¡r
);

1355 
GTEST_API_
 
boŞ
 
IsAsciiDig™
(
ch
);

1356 
GTEST_API_
 
boŞ
 
IsAsciiPunù
(
ch
);

1357 
GTEST_API_
 
boŞ
 
IsR•—t
(
ch
);

1358 
GTEST_API_
 
boŞ
 
IsAsciiWh™eS·û
(
ch
);

1359 
GTEST_API_
 
boŞ
 
IsAsciiWÜdCh¬
(
ch
);

1360 
GTEST_API_
 
boŞ
 
IsV®idEsÿ³
(
ch
);

1361 
GTEST_API_
 
boŞ
 
AtomM©chesCh¬
(boŞ 
esÿ³d
, 
·‰”n
, 
ch
);

1362 
GTEST_API_
 
boŞ
 
V®id©eRegex
(cÚ¡ * 
»gex
);

1363 
GTEST_API_
 
boŞ
 
M©chRegexAtH—d
(cÚ¡ * 
»gex
, cÚ¡ * 
¡r
);

1364 
GTEST_API_
 
boŞ
 
M©chR•‘™iÚAndRegexAtH—d
(

1365 
boŞ
 
esÿ³d
, 
ch
, 
»³©
, cÚ¡ * 
»gex
, cÚ¡ * 
¡r
);

1366 
GTEST_API_
 
boŞ
 
M©chRegexAnywh”e
(cÚ¡ * 
»gex
, cÚ¡ * 
¡r
);

1372 
GTEST_API_
 
P¬£GoogËTe¡FÏgsOÆy
(* 
¬gc
, ** 
¬gv
);

1373 
GTEST_API_
 
P¬£GoogËTe¡FÏgsOÆy
(* 
¬gc
, 
wch¬_t
** 
¬gv
);

1375 #ià
GTEST_HAS_DEATH_TEST


1379 
GTEST_API_
 
	g¡d
::
¡ršg
 
G‘La¡E¼noDesütiÚ
();

1385 
	g‹m¶©e
 <
ty³Çme
 
	gIÁeg”
>

1386 
boŞ
 
P¬£N©u¿lNumb”
(cÚ¡ ::
¡d
::
¡ršg
& 
¡r
, 
IÁeg”
* 
numb”
) {

1390 ià(
	g¡r
.
em±y
(è|| !
IsDig™
(
¡r
[0])) {

1391  
	gçl£
;

1393 
	g”ºo
 = 0;

1395 * 
	g’d
;

1399 #ià
GTEST_OS_WINDOWS
 && !
defšed
(
__GNUC__
)

1402 
	t__št64
 
	tBigge¡CÚv”tibË
;

1403 cÚ¡ 
Bigge¡CÚv”tibË
 
	g·r£d
 = 
_¡¹oui64
(
¡r
.
c_¡r
(), &
’d
, 10);

1407 
	tBigge¡CÚv”tibË
;

1408 cÚ¡ 
Bigge¡CÚv”tibË
 
	g·r£d
 = 
¡¹ouÎ
(
¡r
.
c_¡r
(), &
’d
, 10);

1412 cÚ¡ 
boŞ
 
	g·r£_sucûss
 = *
’d
 =ğ'\0' && 
”ºo
 == 0;

1414 
GTEST_CHECK_
((
IÁeg”
è<ğ(
·r£d
));

1416 cÚ¡ 
IÁeg”
 
	g»suÉ
 = 
¡©ic_ÿ¡
<IÁeg”>(
·r£d
);

1417 ià(
	g·r£_sucûss
 && 
	g¡©ic_ÿ¡
<
	gBigge¡CÚv”tibË
>(
	g»suÉ
è=ğ
·r£d
) {

1418 *
numb”
 = 
»suÉ
;

1419  
	gŒue
;

1421  
	gçl£
;

1431 şas 
	cTe¡ResuÉAcûssÜ
 {

1432 
	gpublic
:

1433 
RecÜdPrİ”ty
(
Te¡ResuÉ
* 
‹¡_»suÉ
,

1434 cÚ¡ 
¡d
::
¡ršg
& 
xml_–em’t
,

1435 cÚ¡ 
Te¡Prİ”ty
& 
´İ”ty
) {

1436 
	g‹¡_»suÉ
->
RecÜdPrİ”ty
(
xml_–em’t
, 
´İ”ty
);

1439 
CË¬Te¡P¬tResuÉs
(
Te¡ResuÉ
* 
‹¡_»suÉ
) {

1440 
	g‹¡_»suÉ
->
CË¬Te¡P¬tResuÉs
();

1443 cÚ¡ 
	g¡d
::
veùÜ
<
‹¡šg
::
Te¡P¬tResuÉ
>& 
‹¡_·¹_»suÉs
(

1444 cÚ¡ 
Te¡ResuÉ
& 
‹¡_»suÉ
) {

1445  
‹¡_»suÉ
.
‹¡_·¹_»suÉs
();

1449 #ià
GTEST_CAN_STREAM_RESULTS_


1452 şas 
	cSŒ—mšgLi¡’”
 : 
public
 
Em±yTe¡Ev’tLi¡’”
 {

1453 
public
:

1455 şas 
	cAb¡¿ùSock‘Wr™”
 {

1456 
public
:

1457 
vœtu®
 ~
Ab¡¿ùSock‘Wr™”
() {}

1460 
vœtu®
 
S’d
(cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
) = 0;

1463 
vœtu®
 
Clo£CÚÃùiÚ
() {}

1466 
S’dLn
(cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
è{ 
S’d
(message + "\n"); }

1470 şas 
	cSock‘Wr™”
 : 
public
 
Ab¡¿ùSock‘Wr™”
 {

1471 
public
:

1472 
Sock‘Wr™”
(cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, cÚ¡ std::¡ršg& 
pÜt
)

1473 : 
sockfd_
(-1), 
ho¡_Çme_
(
ho¡
), 
pÜt_num_
(
pÜt
) {

1474 
MakeCÚÃùiÚ
();

1477 ~
Sock‘Wr™”
(è
	gov”ride
 {

1478 ià(
	gsockfd_
 != -1)

1479 
Clo£CÚÃùiÚ
();

1483 
S’d
(cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
è
ov”ride
 {

1484 
GTEST_CHECK_
(
sockfd_
 != -1)

1487 cÚ¡‡utØ
	gËn
 = 
¡©ic_ÿ¡
<
size_t
>(
mes§ge
.
Ëngth
());

1488 ià(
wr™e
(
sockfd_
, 
mes§ge
.
c_¡r
(), 
Ën
è!ğ
¡©ic_ÿ¡
<
ssize_t
>(len)) {

1489 
GTEST_LOG_
(
WARNING
)

1491 << 
ho¡_Çme_
 << ":" << 
pÜt_num_
;

1495 
	g´iv©e
:

1497 
MakeCÚÃùiÚ
();

1500 
Clo£CÚÃùiÚ
(è
	gov”ride
 {

1501 
GTEST_CHECK_
(
sockfd_
 != -1)

1504 
şo£
(
sockfd_
);

1505 
	gsockfd_
 = -1;

1508 
	gsockfd_
;

1509 cÚ¡ 
	g¡d
::
¡ršg
 
ho¡_Çme_
;

1510 cÚ¡ 
	g¡d
::
¡ršg
 
pÜt_num_
;

1512 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Sock‘Wr™”
);

1516 
	g¡d
::
¡ršg
 
U¾Encode
(cÚ¡ * 
¡r
);

1518 
SŒ—mšgLi¡’”
(cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, cÚ¡ std::¡ršg& 
pÜt
)

1519 : 
sock‘_wr™”_
(
Ãw
 
Sock‘Wr™”
(
ho¡
, 
pÜt
)) {

1520 
S¹
();

1523 
ex¶ic™
 
SŒ—mšgLi¡’”
(
Ab¡¿ùSock‘Wr™”
* 
sock‘_wr™”
)

1524 : 
sock‘_wr™”_
(
sock‘_wr™”
è{ 
S¹
(); }

1526 
OnTe¡Prog¿mS¹
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {

1527 
S’dLn
("event=TestProgramStart");

1530 
OnTe¡Prog¿mEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
è
	gov”ride
 {

1533 
S’dLn
("ev’t=Te¡Prog¿mEnd&·s£d=" + 
FÜm©BoŞ
(
un™_‹¡
.
Pas£d
()));

1536 
	gsock‘_wr™”_
->
Clo£CÚÃùiÚ
();

1539 
OnTe¡I‹¿tiÚS¹
(cÚ¡ 
Un™Te¡
& ,

1540 
™”©iÚ
è
	gov”ride
 {

1541 
S’dLn
("event=TestIterationStart&iteration=" +

1542 
SŒ—mabËToSŒšg
(
™”©iÚ
));

1545 
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
,

1546 è
	gov”ride
 {

1547 
S’dLn
("event=TestIterationEnd&passed=" +

1548 
FÜm©BoŞ
(
un™_‹¡
.
Pas£d
()) + "&elapsed_time=" +

1549 
SŒ—mabËToSŒšg
(
un™_‹¡
.
–­£d_time
()) + "ms");

1554 
OnTe¡Ca£S¹
(cÚ¡ 
Te¡Ca£
& 
‹¡_ÿ£
è
	gov”ride
 {

1555 
S’dLn
(
¡d
::
¡ršg
("ev’t=Te¡Ca£S¹&Çme="è+ 
‹¡_ÿ£
.
Çme
());

1560 
OnTe¡Ca£End
(cÚ¡ 
Te¡Ca£
& 
‹¡_ÿ£
è
	gov”ride
 {

1561 
S’dLn
("ev’t=Te¡Ca£End&·s£d=" + 
FÜm©BoŞ
(
‹¡_ÿ£
.
Pas£d
()) +

1562 "&–­£d_time=" + 
SŒ—mabËToSŒšg
(
‹¡_ÿ£
.
–­£d_time
()) +

1566 
OnTe¡S¹
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
è
	gov”ride
 {

1567 
S’dLn
(
¡d
::
¡ršg
("ev’t=Te¡S¹&Çme="è+ 
‹¡_šfo
.
Çme
());

1570 
OnTe¡End
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
è
	gov”ride
 {

1571 
S’dLn
("event=TestEnd&passed=" +

1572 
FÜm©BoŞ
((
‹¡_šfo
.
»suÉ
())->
Pas£d
()) +

1574 
SŒ—mabËToSŒšg
((
‹¡_šfo
.
»suÉ
())->
–­£d_time
()) + "ms");

1577 
OnTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
‹¡_·¹_»suÉ
è
	gov”ride
 {

1578 cÚ¡ * 
	gfe_Çme
 = 
‹¡_·¹_»suÉ
.
fe_Çme
();

1579 ià(
	gfe_Çme
 =ğ
nuÎ±r
è
fe_Çme
 = "";

1580 
S’dLn
("ev’t=Te¡P¬tResuÉ&fe=" + 
U¾Encode
(
fe_Çme
) +

1581 "&lše=" + 
SŒ—mabËToSŒšg
(
‹¡_·¹_»suÉ
.
lše_numb”
()) +

1582 "&mes§ge=" + 
U¾Encode
(
‹¡_·¹_»suÉ
.
mes§ge
()));

1585 
	g´iv©e
:

1587 
S’dLn
(cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
è{ 
sock‘_wr™”_
->SendLn(message); }

1591 
S¹
(è{ 
S’dLn
("gtest_streaming_protocol_version=1.0"); }

1593 
	g¡d
::
¡ršg
 
FÜm©BoŞ
(
boŞ
 
v®ue
) {  value ? "1" : "0"; }

1595 cÚ¡ 
	g¡d
::
unique_±r
<
Ab¡¿ùSock‘Wr™”
> 
sock‘_wr™”_
;

1597 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
SŒ—mšgLi¡’”
);

1605 
	$GTEST_DISABLE_MSC_WARNINGS_POP_
()

1609 #ià
GTEST_OS_WINDOWS


1610 
	#v¢´štf
 
_v¢´štf


	)

1613 #ià
GTEST_OS_MAC


1614 #iâdeà
GTEST_OS_IOS


1615 
	~<üt_ex‹ºs.h
>

1619 #ià
GTEST_HAS_ABSL


1620 
	~"ab¦/debuggšg/çu»_sigÇl_hªdËr.h
"

1621 
	~"ab¦/debuggšg/¡ackŒaû.h
"

1622 
	~"ab¦/debuggšg/symbŞize.h
"

1623 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

1626 
Çme¥aû
 
‹¡šg
 {

1628 
usšg
 
š‹º®
::
CouÁIf
;

1629 
usšg
 
š‹º®
::
FÜEach
;

1630 
usšg
 
š‹º®
::
G‘EËm’tOr
;

1631 
usšg
 
š‹º®
::
Shufæe
;

1637 cÚ¡ 
kDi§bËTe¡F‹r
[] = "DISABLED_*:*/DISABLED_*";

1642 cÚ¡ 
kD—thTe¡Su™eF‹r
[] = "*DeathTest:*DeathTest/*";

1645 cÚ¡ 
kUniv”§lF‹r
[] = "*";

1648 cÚ¡ 
kDeçuÉOuutFÜm©
[] = "xml";

1650 cÚ¡ 
kDeçuÉOuutFe
[] = "test_detail";

1653 cÚ¡ 
kTe¡Sh¬dIndex
[] = "GTEST_SHARD_INDEX";

1655 cÚ¡ 
kTe¡TÙ®Sh¬ds
[] = "GTEST_TOTAL_SHARDS";

1657 cÚ¡ 
kTe¡Sh¬dStusFe
[] = "GTEST_SHARD_STATUS_FILE";

1659 
Çme¥aû
 
š‹º®
 {

1663 cÚ¡ 
kSckT¿ûM¬k”
[] = "\nStackrace:\n";

1667 
boŞ
 
g_h–p_æag
 = 
çl£
;

1670 
FILE
* 
	`O³nFeFÜWr™šg
(cÚ¡ 
¡d
::
¡ršg
& 
ouut_fe
) {

1671 
FILE
* 
feout
 = 
nuÎ±r
;

1672 
FeP©h
 
	`ouut_fe_·th
(
ouut_fe
);

1673 
FeP©h
 
	`ouut_dœ
(
ouut_fe_·th
.
	`RemoveFeName
());

1675 ià(
ouut_dœ
.
	`C»©eDœeùÜ›sRecursiv–y
()) {

1676 
feout
 = 
posix
::
	`FO³n
(
ouut_fe
.
	`c_¡r
(), "w");

1678 ià(
feout
 =ğ
nuÎ±r
) {

1679 
	`GTEST_LOG_
(
FATAL
è<< "UÇbËØİ’ f\"" << 
ouut_fe
 << "\"";

1681  
feout
;

1688 cÚ¡ * 
	`G‘DeçuÉF‹r
() {

1689 cÚ¡ * cÚ¡ 
‹¡bridge_‹¡_Úly
 =

1690 
š‹º®
::
posix
::
	`G‘Env
("TESTBRIDGE_TEST_ONLY");

1691 ià(
‹¡bridge_‹¡_Úly
 !ğ
nuÎ±r
) {

1692  
‹¡bridge_‹¡_Úly
;

1694  
kUniv”§lF‹r
;

1697 
	`GTEST_DEFINE_boŞ_
(

1698 
®so_run_di§bËd_‹¡s
,

1699 
š‹º®
::
	`BoŞFromGTe¡Env
("®so_run_di§bËd_‹¡s", 
çl£
),

1702 
	`GTEST_DEFINE_boŞ_
(

1703 
b»ak_Ú_çu»
, 
š‹º®
::
	`BoŞFromGTe¡Env
("b»ak_Ú_çu»", 
çl£
),

1707 
	`GTEST_DEFINE_boŞ_
(
ÿtch_exû±iÚs
,

1708 
š‹º®
::
	`BoŞFromGTe¡Env
("ÿtch_exû±iÚs", 
Œue
),

1709 "Truiàªd oÆy ià" 
GTEST_NAME_


1712 
	`GTEST_DEFINE_¡ršg_
(

1713 
cŞÜ
,

1714 
š‹º®
::
	`SŒšgFromGTe¡Env
("color", "auto"),

1720 
	`GTEST_DEFINE_¡ršg_
(

1721 
f‹r
,

1722 
š‹º®
::
	`SŒšgFromGTe¡Env
("f‹r", 
	`G‘DeçuÉF‹r
()),

1729 
	`GTEST_DEFINE_boŞ_
(

1730 
š¡®l_çu»_sigÇl_hªdËr
,

1731 
š‹º®
::
	`BoŞFromGTe¡Env
("š¡®l_çu»_sigÇl_hªdËr", 
çl£
),

1732 "IàŒuªd suµÜ‹d oÀthcu¼’ˆ¶©fÜm, " 
GTEST_NAME_
 " should "

1736 
	`GTEST_DEFINE_boŞ_
(
li¡_‹¡s
, 
çl£
,

1744 
	`GTEST_DEFINE_¡ršg_
(

1745 
ouut
,

1746 
š‹º®
::
	`SŒšgFromGTe¡Env
("output",

1747 
š‹º®
::
	`OuutFÏgAlsoCheckEnvV¬
().
	`c_¡r
()),

1757 
	`GTEST_DEFINE_boŞ_
(
´št_time
, 
š‹º®
::
	`BoŞFromGTe¡Env
("´št_time", 
Œue
),

1758 "Truiàªd oÆy ià" 
GTEST_NAME_


1761 
	`GTEST_DEFINE_boŞ_
(
´št_utf8
, 
š‹º®
::
	`BoŞFromGTe¡Env
("´št_utf8", 
Œue
),

1762 "Truiàªd oÆy ià" 
GTEST_NAME_


1765 
	`GTEST_DEFINE_št32_
(

1766 
¿ndom_£ed
,

1767 
š‹º®
::
	`IÁ32FromGTe¡Env
("random_seed", 0),

1771 
	`GTEST_DEFINE_št32_
(

1772 
»³©
,

1773 
š‹º®
::
	`IÁ32FromGTe¡Env
("repeat", 1),

1777 
	`GTEST_DEFINE_boŞ_
(
show_š‹º®_¡ack_äames
, 
çl£
,

1778 "Truiàªd oÆy ià" 
GTEST_NAME_


1782 
	`GTEST_DEFINE_boŞ_
(
shufæe
, 
š‹º®
::
	`BoŞFromGTe¡Env
("shufæe", 
çl£
),

1783 "Truiàªd oÆy ià" 
GTEST_NAME_


1786 
	`GTEST_DEFINE_št32_
(

1787 
¡ack_Œaû_d•th
,

1788 
š‹º®
::
	`IÁ32FromGTe¡Env
("¡ack_Œaû_d•th", 
kMaxSckT¿ûD•th
),

1792 
	`GTEST_DEFINE_¡ršg_
(

1793 
¡»am_»suÉ_to
,

1794 
š‹º®
::
	`SŒšgFromGTe¡Env
("stream_result_to", ""),

1799 
	`GTEST_DEFINE_boŞ_
(

1800 
throw_Ú_çu»
,

1801 
š‹º®
::
	`BoŞFromGTe¡Env
("throw_Ú_çu»", 
çl£
),

1806 
	`GTEST_DEFINE_boŞ_
(

1807 
´št_sk³d
,

1808 
š‹º®
::
	`BoŞFromGTe¡Env
("´št_sk³d", 
çl£
),

1812 #ià
GTEST_USE_OWN_FLAGFILE_FLAG_


1813 
	`GTEST_DEFINE_¡ršg_
(

1814 
æagfe
,

1815 
š‹º®
::
	`SŒšgFromGTe¡Env
("flagfile", ""),

1819 
Çme¥aû
 
š‹º®
 {

1824 
UIÁ32
 
Rªdom
::
	`G’”©e
(UIÁ32 
¿nge
) {

1827 
¡©e_
 = 
¡©ic_ÿ¡
<
UIÁ32
>(1103515245ULL*¡©e_ + 12345Uè% 
kMaxRªge
;

1829 
	`GTEST_CHECK_
(
¿nge
 > 0)

1831 
	`GTEST_CHECK_
(
¿nge
 <ğ
kMaxRªge
)

1832 << "G’”©iÚ oà¨numb” iÀ[0, " << 
¿nge
 << ") was„equested, "

1833 << "buˆthi ÿÀÚly g’”©numb” š [0, " << 
kMaxRªge
 << ").";

1838  
¡©e_
 % 
¿nge
;

1844 
boŞ
 
	`GTe¡IsIn™Ÿlized
(è{  
	`G‘Argvs
().
	`size
() > 0; }

1849 
	`SumOv”Te¡Su™eLi¡
(cÚ¡ 
¡d
::
veùÜ
<
Te¡Su™e
*>& 
ÿ£_li¡
,

1850 (
Te¡Su™e
::*
m‘hod
)() const) {

1851 
sum
 = 0;

1852 
size_t
 
i
 = 0; i < 
ÿ£_li¡
.
	`size
(); i++) {

1853 
sum
 +ğ(
ÿ£_li¡
[
i
]->*
m‘hod
)();

1855  
sum
;

1859 
boŞ
 
	`Te¡Su™ePas£d
(cÚ¡ 
Te¡Su™e
* 
‹¡_su™e
) {

1860  
‹¡_su™e
->
	`should_run
(è&&e¡_su™e->
	`Pas£d
();

1864 
boŞ
 
	`Te¡Su™eFaed
(cÚ¡ 
Te¡Su™e
* 
‹¡_su™e
) {

1865  
‹¡_su™e
->
	`should_run
(è&&e¡_su™e->
	`Faed
();

1870 
boŞ
 
	`ShouldRunTe¡Su™e
(cÚ¡ 
Te¡Su™e
* 
‹¡_su™e
) {

1871  
‹¡_su™e
->
	`should_run
();

1875 
As£¹H–³r
::
	`As£¹H–³r
(
Te¡P¬tResuÉ
::
Ty³
 
ty³
,

1876 cÚ¡ * 
fe
,

1877 
lše
,

1878 cÚ¡ * 
mes§ge
)

1879 : 
	`d©a_
(
Ãw
 
	`As£¹H–³rD©a
(
ty³
, 
fe
, 
lše
, 
mes§ge
)) {

1882 
As£¹H–³r
::~
	`As£¹H–³r
() {

1883 
d–‘e
 
d©a_
;

1887 
As£¹H–³r
::
İ”©Ü
=(cÚ¡ 
Mes§ge
& 
mes§ge
) const {

1888 
Un™Te¡
::
	`G‘In¡ªû
()->

1889 
	`AddTe¡P¬tResuÉ
(
d©a_
->
ty³
, d©a_->
fe
, d©a_->
lše
,

1890 
	`Aµ’dU£rMes§ge
(
d©a_
->
mes§ge
, message),

1891 
Un™Te¡
::
	`G‘In¡ªû
()->
	`im¶
()

1892 ->
	`Cu¼’tOsSckT¿ûExû±Tİ
(1)

1898 ::
¡d
::
veùÜ
<¡d::
¡ršg
> 
g_¬gvs
;

1900 ::
¡d
::
veùÜ
<¡d::
¡ršg
> 
	`G‘Argvs
() {

1901 #ià
	`defšed
(
GTEST_CUSTOM_GET_ARGVS_
)

1904 cÚ¡‡uto& 
cu¡om
 = 
	`GTEST_CUSTOM_GET_ARGVS_
();

1905  ::
¡d
::
veùÜ
<¡d::
¡ršg
>(
cu¡om
.
	`begš
(), cu¡om.
	`’d
());

1907  
g_¬gvs
;

1913 
FeP©h
 
	`G‘Cu¼’tExecubËName
() {

1914 
FeP©h
 
»suÉ
;

1916 #ià
GTEST_OS_WINDOWS
 || 
GTEST_OS_OS2


1917 
»suÉ
.
	`S‘
(
	`FeP©h
(
	`G‘Argvs
()[0]).
	`RemoveEx‹nsiÚ
("exe"));

1919 
»suÉ
.
	`S‘
(
	`FeP©h
(
	`G‘Argvs
()[0]));

1922  
»suÉ
.
	`RemoveDœeùÜyName
();

1928 
¡d
::
¡ršg
 
Un™Te¡O±iÚs
::
	`G‘OuutFÜm©
() {

1929 cÚ¡ * cÚ¡ 
g‹¡_ouut_æag
 = 
	`GTEST_FLAG
(
ouut
).
	`c_¡r
();

1930 cÚ¡ * cÚ¡ 
cŞÚ
 = 
	`¡rchr
(
g‹¡_ouut_æag
, ':');

1931  (
cŞÚ
 =ğ
nuÎ±r
)

1932 ? 
¡d
::
	`¡ršg
(
g‹¡_ouut_æag
)

1933 : 
¡d
::
	`¡ršg
(
g‹¡_ouut_æag
,

1934 
¡©ic_ÿ¡
<
size_t
>(
cŞÚ
 - 
g‹¡_ouut_æag
));

1939 
¡d
::
¡ršg
 
Un™Te¡O±iÚs
::
	`G‘AbsŞu‹P©hToOuutFe
() {

1940 cÚ¡ * cÚ¡ 
g‹¡_ouut_æag
 = 
	`GTEST_FLAG
(
ouut
).
	`c_¡r
();

1942 
¡d
::
¡ršg
 
fÜm©
 = 
	`G‘OuutFÜm©
();

1943 ià(
fÜm©
.
	`em±y
())

1944 
fÜm©
 = 
¡d
::
	`¡ršg
(
kDeçuÉOuutFÜm©
);

1946 cÚ¡ * cÚ¡ 
cŞÚ
 = 
	`¡rchr
(
g‹¡_ouut_æag
, ':');

1947 ià(
cŞÚ
 =ğ
nuÎ±r
)

1948  
š‹º®
::
FeP©h
::
	`MakeFeName
(

1949 
š‹º®
::
	`FeP©h
(

1950 
Un™Te¡
::
	`G‘In¡ªû
()->
	`Üigš®_wÜkšg_dœ
()),

1951 
š‹º®
::
	`FeP©h
(
kDeçuÉOuutFe
), 0,

1952 
fÜm©
.
	`c_¡r
()).
	`¡ršg
();

1954 
š‹º®
::
FeP©h
 
	`ouut_Çme
(
cŞÚ
 + 1);

1955 ià(!
ouut_Çme
.
	`IsAbsŞu‹P©h
())

1956 
ouut_Çme
 = 
š‹º®
::
FeP©h
::
	`CÚÿtP©hs
(

1957 
š‹º®
::
	`FeP©h
(
Un™Te¡
::
	`G‘In¡ªû
()->
	`Üigš®_wÜkšg_dœ
()),

1958 
š‹º®
::
	`FeP©h
(
cŞÚ
 + 1));

1960 ià(!
ouut_Çme
.
	`IsDœeùÜy
())

1961  
ouut_Çme
.
	`¡ršg
();

1963 
š‹º®
::
FeP©h
 
	`»suÉ
(š‹º®::FeP©h::
	`G’”©eUniqueFeName
(

1964 
ouut_Çme
, 
š‹º®
::
	`G‘Cu¼’tExecubËName
(),

1965 
	`G‘OuutFÜm©
().
	`c_¡r
()));

1966  
»suÉ
.
	`¡ršg
();

1974 
boŞ
 
Un™Te¡O±iÚs
::
	`P©‹ºM©chesSŒšg
(cÚ¡ *
·‰”n
,

1975 cÚ¡ *
¡r
) {

1976 *
·‰”n
) {

1979  *
¡r
 == '\0';

1981  *
¡r
 !ğ'\0' && 
	`P©‹ºM©chesSŒšg
(
·‰”n
 + 1, str + 1);

1983  (*
¡r
 !ğ'\0' && 
	`P©‹ºM©chesSŒšg
(
·‰”n
, str + 1)) ||

1984 
	`P©‹ºM©chesSŒšg
(
·‰”n
 + 1, 
¡r
);

1986  *
·‰”n
 =ğ*
¡r
 &&

1987 
	`P©‹ºM©chesSŒšg
(
·‰”n
 + 1, 
¡r
 + 1);

1991 
boŞ
 
Un™Te¡O±iÚs
::
	`M©chesF‹r
(

1992 cÚ¡ 
¡d
::
¡ršg
& 
Çme
, cÚ¡ * 
f‹r
) {

1993 cÚ¡ *
cur_·‰”n
 = 
f‹r
;

1995 ià(
	`P©‹ºM©chesSŒšg
(
cur_·‰”n
, 
Çme
.
	`c_¡r
())) {

1996  
Œue
;

2000 
cur_·‰”n
 = 
	`¡rchr
(cur_pattern, ':');

2003 ià(
cur_·‰”n
 =ğ
nuÎ±r
) {

2004  
çl£
;

2008 
cur_·‰”n
++;

2014 
boŞ
 
Un™Te¡O±iÚs
::
	`F‹rM©chesTe¡
(cÚ¡ 
¡d
::
¡ršg
& 
‹¡_su™e_Çme
,

2015 cÚ¡ 
¡d
::
¡ršg
& 
‹¡_Çme
) {

2016 cÚ¡ 
¡d
::
¡ršg
& 
fuÎ_Çme
 = 
‹¡_su™e_Çme
 + "." + 
‹¡_Çme
.
	`c_¡r
();

2020 cÚ¡ * cÚ¡ 
p
 = 
	`GTEST_FLAG
(
f‹r
).
	`c_¡r
();

2021 cÚ¡ * cÚ¡ 
dash
 = 
	`¡rchr
(
p
, '-');

2022 
¡d
::
¡ršg
 
pos™ive
;

2023 
¡d
::
¡ršg
 
Ãg©ive
;

2024 ià(
dash
 =ğ
nuÎ±r
) {

2025 
pos™ive
 = 
	`GTEST_FLAG
(
f‹r
).
	`c_¡r
();

2026 
Ãg©ive
 = "";

2028 
pos™ive
 = 
¡d
::
	`¡ršg
(
p
, 
dash
);

2029 
Ãg©ive
 = 
¡d
::
	`¡ršg
(
dash
 + 1);

2030 ià(
pos™ive
.
	`em±y
()) {

2032 
pos™ive
 = 
kUniv”§lF‹r
;

2038  (
	`M©chesF‹r
(
fuÎ_Çme
, 
pos™ive
.
	`c_¡r
()) &&

2039 !
	`M©chesF‹r
(
fuÎ_Çme
, 
Ãg©ive
.
	`c_¡r
()));

2042 #ià
GTEST_HAS_SEH


2046 
Un™Te¡O±iÚs
::
	`GTe¡ShouldProûssSEH
(
DWORD
 
exû±iÚ_code
) {

2055 cÚ¡ 
DWORD
 
kCxxExû±iÚCode
 = 0xe06d7363;

2057 
boŞ
 
should_hªdË
 = 
Œue
;

2059 ià(!
	`GTEST_FLAG
(
ÿtch_exû±iÚs
))

2060 
should_hªdË
 = 
çl£
;

2061 ià(
exû±iÚ_code
 =ğ
EXCEPTION_BREAKPOINT
)

2062 
should_hªdË
 = 
çl£
;

2063 ià(
exû±iÚ_code
 =ğ
kCxxExû±iÚCode
)

2064 
should_hªdË
 = 
çl£
;

2066  
should_hªdË
 ? 
EXCEPTION_EXECUTE_HANDLER
 : 
EXCEPTION_CONTINUE_SEARCH
;

2075 
ScİedFakeTe¡P¬tResuÉR•Ü‹r
::
	`ScİedFakeTe¡P¬tResuÉR•Ü‹r
(

2076 
Te¡P¬tResuÉA¼ay
* 
»suÉ
)

2077 : 
	`š‹rû±_mode_
(
INTERCEPT_ONLY_CURRENT_THREAD
),

2078 
	`»suÉ_
(
»suÉ
) {

2079 
	`In™
();

2085 
ScİedFakeTe¡P¬tResuÉR•Ü‹r
::
	`ScİedFakeTe¡P¬tResuÉR•Ü‹r
(

2086 
IÁ”û±Mode
 
š‹rû±_mode
, 
Te¡P¬tResuÉA¼ay
* 
»suÉ
)

2087 : 
	`š‹rû±_mode_
(
š‹rû±_mode
),

2088 
	`»suÉ_
(
»suÉ
) {

2089 
	`In™
();

2092 
ScİedFakeTe¡P¬tResuÉR•Ü‹r
::
	`In™
() {

2093 
š‹º®
::
Un™Te¡Im¶
* cÚ¡ 
im¶
 = iÁ”Çl::
	`G‘Un™Te¡Im¶
();

2094 ià(
š‹rû±_mode_
 =ğ
INTERCEPT_ALL_THREADS
) {

2095 
Şd_»pÜ‹r_
 = 
im¶
->
	`G‘Glob®Te¡P¬tResuÉR•Ü‹r
();

2096 
im¶
->
	`S‘Glob®Te¡P¬tResuÉR•Ü‹r
(
this
);

2098 
Şd_»pÜ‹r_
 = 
im¶
->
	`G‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
();

2099 
im¶
->
	`S‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
(
this
);

2105 
ScİedFakeTe¡P¬tResuÉR•Ü‹r
::~
	`ScİedFakeTe¡P¬tResuÉR•Ü‹r
() {

2106 
š‹º®
::
Un™Te¡Im¶
* cÚ¡ 
im¶
 = iÁ”Çl::
	`G‘Un™Te¡Im¶
();

2107 ià(
š‹rû±_mode_
 =ğ
INTERCEPT_ALL_THREADS
) {

2108 
im¶
->
	`S‘Glob®Te¡P¬tResuÉR•Ü‹r
(
Şd_»pÜ‹r_
);

2110 
im¶
->
	`S‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
(
Şd_»pÜ‹r_
);

2116 
ScİedFakeTe¡P¬tResuÉR•Ü‹r
::
	`R•ÜtTe¡P¬tResuÉ
(

2117 cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) {

2118 
»suÉ_
->
	`Aµ’d
(
»suÉ
);

2121 
Çme¥aû
 
š‹º®
 {

2132 
Ty³Id
 
	`G‘Te¡Ty³Id
() {

2133  
G‘Ty³Id
<
Te¡
>();

2138 cÚ¡ 
Ty³Id
 
kTe¡Ty³IdInGoogËTe¡
 = 
	`G‘Te¡Ty³Id
();

2143 
As£¹iÚResuÉ
 
	`HasOÃFau»
(const * ,

2146 cÚ¡ 
Te¡P¬tResuÉA¼ay
& 
»suÉs
,

2147 
Te¡P¬tResuÉ
::
Ty³
 
ty³
,

2148 cÚ¡ 
¡d
::
¡ršg
& 
sub¡r
) {

2149 cÚ¡ 
¡d
::
¡ršg
 
	`ex³ùed
(
ty³
 =ğ
Te¡P¬tResuÉ
::
kF©®Fau»
 ?

2152 
Mes§ge
 
msg
;

2153 ià(
»suÉs
.
	`size
() != 1) {

2154 
msg
 << "Ex³ùed: " << 
ex³ùed
 << "\n"

2155 << " Aùu®: " << 
»suÉs
.
	`size
() << " failures";

2156 
i
 = 0; i < 
»suÉs
.
	`size
(); i++) {

2157 
msg
 << "\n" << 
»suÉs
.
	`G‘Te¡P¬tResuÉ
(
i
);

2159  
	`As£¹iÚFau»
(è<< 
msg
;

2162 cÚ¡ 
Te¡P¬tResuÉ
& 
r
 = 
»suÉs
.
	`G‘Te¡P¬tResuÉ
(0);

2163 ià(
r
.
	`ty³
(è!ğ
ty³
) {

2164  
	`As£¹iÚFau»
(è<< "Ex³ùed: " << 
ex³ùed
 << "\n"

2166 << 
r
;

2169 ià(
	`¡r¡r
(
r
.
	`mes§ge
(), 
sub¡r
.
	`c_¡r
()è=ğ
nuÎ±r
) {

2170  
	`As£¹iÚFau»
(è<< "Ex³ùed: " << 
ex³ùed
 << " containing \""

2171 << 
sub¡r
 << "\"\n"

2173 << 
r
;

2176  
	`As£¹iÚSucûss
();

2182 
SšgËFau»Check”
::
	`SšgËFau»Check”
(cÚ¡ 
Te¡P¬tResuÉA¼ay
* 
»suÉs
,

2183 
Te¡P¬tResuÉ
::
Ty³
 
ty³
,

2184 cÚ¡ 
¡d
::
¡ršg
& 
sub¡r
)

2185 : 
	`»suÉs_
(
»suÉs
), 
	`ty³_
(
ty³
), 
	`sub¡r_
(
sub¡r
) {}

2191 
SšgËFau»Check”
::~
	`SšgËFau»Check”
() {

2192 
	`EXPECT_PRED_FORMAT3
(
HasOÃFau»
, *
»suÉs_
, 
ty³_
, 
sub¡r_
);

2195 
DeçuÉGlob®Te¡P¬tResuÉR•Ü‹r
::
	`DeçuÉGlob®Te¡P¬tResuÉR•Ü‹r
(

2196 
Un™Te¡Im¶
* 
un™_‹¡
è: 
	`un™_‹¡_
(unit_test) {}

2198 
DeçuÉGlob®Te¡P¬tResuÉR•Ü‹r
::
	`R•ÜtTe¡P¬tResuÉ
(

2199 cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) {

2200 
un™_‹¡_
->
	`cu¼’t_‹¡_»suÉ
()->
	`AddTe¡P¬tResuÉ
(
»suÉ
);

2201 
un™_‹¡_
->
	`li¡’”s
()->
	`»³©”
()->
	`OnTe¡P¬tResuÉ
(
»suÉ
);

2204 
DeçuÉP”Th»adTe¡P¬tResuÉR•Ü‹r
::
	`DeçuÉP”Th»adTe¡P¬tResuÉR•Ü‹r
(

2205 
Un™Te¡Im¶
* 
un™_‹¡
è: 
	`un™_‹¡_
(unit_test) {}

2207 
DeçuÉP”Th»adTe¡P¬tResuÉR•Ü‹r
::
	`R•ÜtTe¡P¬tResuÉ
(

2208 cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) {

2209 
un™_‹¡_
->
	`G‘Glob®Te¡P¬tResuÉR•Ü‹r
()->
	`R•ÜtTe¡P¬tResuÉ
(
»suÉ
);

2213 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
*

2214 
Un™Te¡Im¶
::
	`G‘Glob®Te¡P¬tResuÉR•Ü‹r
() {

2215 
š‹º®
::
Mu‹xLock
 
	`lock
(&
glob®_‹¡_·¹_»suÉ_»pÜ‹r_mu‹x_
);

2216  
glob®_‹¡_·¹_»suÉ_»pÙ”_
;

2220 
Un™Te¡Im¶
::
	`S‘Glob®Te¡P¬tResuÉR•Ü‹r
(

2221 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
* 
»pÜ‹r
) {

2222 
š‹º®
::
Mu‹xLock
 
	`lock
(&
glob®_‹¡_·¹_»suÉ_»pÜ‹r_mu‹x_
);

2223 
glob®_‹¡_·¹_»suÉ_»pÙ”_
 = 
»pÜ‹r
;

2227 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
*

2228 
Un™Te¡Im¶
::
	`G‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
() {

2229  
³r_th»ad_‹¡_·¹_»suÉ_»pÜ‹r_
.
	`g‘
();

2233 
Un™Te¡Im¶
::
	`S‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
(

2234 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
* 
»pÜ‹r
) {

2235 
³r_th»ad_‹¡_·¹_»suÉ_»pÜ‹r_
.
	`£t
(
»pÜ‹r
);

2239 
Un™Te¡Im¶
::
	`sucûssful_‹¡_su™e_couÁ
() const {

2240  
	`CouÁIf
(
‹¡_su™es_
, 
Te¡Su™ePas£d
);

2244 
Un™Te¡Im¶
::
	`çed_‹¡_su™e_couÁ
() const {

2245  
	`CouÁIf
(
‹¡_su™es_
, 
Te¡Su™eFaed
);

2249 
Un™Te¡Im¶
::
	`tÙ®_‹¡_su™e_couÁ
() const {

2250  
¡©ic_ÿ¡
<>(
‹¡_su™es_
.
	`size
());

2255 
Un™Te¡Im¶
::
	`‹¡_su™e_to_run_couÁ
() const {

2256  
	`CouÁIf
(
‹¡_su™es_
, 
ShouldRunTe¡Su™e
);

2260 
Un™Te¡Im¶
::
	`sucûssful_‹¡_couÁ
() const {

2261  
	`SumOv”Te¡Su™eLi¡
(
‹¡_su™es_
, &
Te¡Su™e
::
sucûssful_‹¡_couÁ
);

2265 
Un™Te¡Im¶
::
	`sk³d_‹¡_couÁ
() const {

2266  
	`SumOv”Te¡Su™eLi¡
(
‹¡_su™es_
, &
Te¡Su™e
::
sk³d_‹¡_couÁ
);

2270 
Un™Te¡Im¶
::
	`çed_‹¡_couÁ
() const {

2271  
	`SumOv”Te¡Su™eLi¡
(
‹¡_su™es_
, &
Te¡Su™e
::
çed_‹¡_couÁ
);

2275 
Un™Te¡Im¶
::
	`»pÜbË_di§bËd_‹¡_couÁ
() const {

2276  
	`SumOv”Te¡Su™eLi¡
(
‹¡_su™es_
,

2277 &
Te¡Su™e
::
»pÜbË_di§bËd_‹¡_couÁ
);

2281 
Un™Te¡Im¶
::
	`di§bËd_‹¡_couÁ
() const {

2282  
	`SumOv”Te¡Su™eLi¡
(
‹¡_su™es_
, &
Te¡Su™e
::
di§bËd_‹¡_couÁ
);

2286 
Un™Te¡Im¶
::
	`»pÜbË_‹¡_couÁ
() const {

2287  
	`SumOv”Te¡Su™eLi¡
(
‹¡_su™es_
, &
Te¡Su™e
::
»pÜbË_‹¡_couÁ
);

2291 
Un™Te¡Im¶
::
	`tÙ®_‹¡_couÁ
() const {

2292  
	`SumOv”Te¡Su™eLi¡
(
‹¡_su™es_
, &
Te¡Su™e
::
tÙ®_‹¡_couÁ
);

2296 
Un™Te¡Im¶
::
	`‹¡_to_run_couÁ
() const {

2297  
	`SumOv”Te¡Su™eLi¡
(
‹¡_su™es_
, &
Te¡Su™e
::
‹¡_to_run_couÁ
);

2310 
¡d
::
¡ršg
 
Un™Te¡Im¶
::
	`Cu¼’tOsSckT¿ûExû±Tİ
(
sk_couÁ
) {

2311  
	`os_¡ack_Œaû_g‘‹r
()->
	`Cu¼’tSckT¿û
(

2312 
¡©ic_ÿ¡
<>(
	`GTEST_FLAG
(
¡ack_Œaû_d•th
)),

2313 
sk_couÁ
 + 1

2320 
TimeInMlis
 
	`G‘TimeInMlis
() {

2321 #ià
GTEST_OS_WINDOWS_MOBILE
 || 
	`defšed
(
__BORLANDC__
)

2324 cÚ¡ 
TimeInMlis
 
kJavaEpochToWšFeTimeD–
 =

2325 
¡©ic_ÿ¡
<
TimeInMlis
>(116444736UL) * 100000UL;

2326 cÚ¡ 
DWORD
 
kT’thMiüosInMliSecÚd
 = 10000;

2328 
SYSTEMTIME
 
now_sy¡ime
;

2329 
FILETIME
 
now_f‘ime
;

2330 
ULARGE_INTEGER
 
now_št64
;

2331 
	`G‘Sy¡emTime
(&
now_sy¡ime
);

2332 ià(
	`Sy¡emTimeToFeTime
(&
now_sy¡ime
, &
now_f‘ime
)) {

2333 
now_št64
.
LowP¬t
 = 
now_f‘ime
.
dwLowD©eTime
;

2334 
now_št64
.
HighP¬t
 = 
now_f‘ime
.
dwHighD©eTime
;

2335 
now_št64
.
QuadP¬t
 = (now_št64.QuadP¬ˆ/ 
kT’thMiüosInMliSecÚd
) -

2336 
kJavaEpochToWšFeTimeD–
;

2337  
now_št64
.
QuadP¬t
;

2340 #–ià
GTEST_OS_WINDOWS
 && !
GTEST_HAS_GETTIMEOFDAY_


2341 
__timeb64
 
now
;

2345 
	`GTEST_DISABLE_MSC_DEPRECATED_PUSH_
()

2346 
	`_áime64
(&
now
);

2347 
	`GTEST_DISABLE_MSC_DEPRECATED_POP_
()

2349  
¡©ic_ÿ¡
<
TimeInMlis
>(
now
.
time
è* 1000 +‚ow.
ml™m
;

2350 #–ià
GTEST_HAS_GETTIMEOFDAY_


2351 
timev®
 
now
;

2352 
	`g‘timeofday
(&
now
, 
nuÎ±r
);

2353  
¡©ic_ÿ¡
<
TimeInMlis
>(
now
.
tv_£c
è* 1000 +‚ow.
tv_u£c
 / 1000;

2363 #ià
GTEST_OS_WINDOWS_MOBILE


2368 
LPCWSTR
 
SŒšg
::
	`AnsiToUtf16
(cÚ¡ * 
ªsi
) {

2369 ià(!
ªsi
è 
nuÎ±r
;

2370 cÚ¡ 
Ëngth
 = 
	`¡¾’
(
ªsi
);

2371 cÚ¡ 
unicode_Ëngth
 =

2372 
	`MuÉiBy‹ToWideCh¬
(
CP_ACP
, 0, 
ªsi
, 
Ëngth
, 
nuÎ±r
, 0);

2373 
WCHAR
* 
unicode
 = 
Ãw
 WCHAR[
unicode_Ëngth
 + 1];

2374 
	`MuÉiBy‹ToWideCh¬
(
CP_ACP
, 0, 
ªsi
, 
Ëngth
,

2375 
unicode
, 
unicode_Ëngth
);

2376 
unicode
[
unicode_Ëngth
] = 0;

2377  
unicode
;

2384 cÚ¡ * 
SŒšg
::
	`Utf16ToAnsi
(
LPCWSTR
 
utf16_¡r
) {

2385 ià(!
utf16_¡r
è 
nuÎ±r
;

2386 cÚ¡ 
ªsi_Ëngth
 = 
	`WideCh¬ToMuÉiBy‹
(
CP_ACP
, 0, 
utf16_¡r
, -1, 
nuÎ±r
,

2387 0, 
nuÎ±r
,‚ullptr);

2388 * 
ªsi
 = 
Ãw
 [
ªsi_Ëngth
 + 1];

2389 
	`WideCh¬ToMuÉiBy‹
(
CP_ACP
, 0, 
utf16_¡r
, -1, 
ªsi
, 
ªsi_Ëngth
, 
nuÎ±r
,

2390 
nuÎ±r
);

2391 
ªsi
[
ªsi_Ëngth
] = 0;

2392  
ªsi
;

2403 
boŞ
 
SŒšg
::
	`CSŒšgEqu®s
(cÚ¡ * 
lhs
, cÚ¡ * 
rhs
) {

2404 ià(
lhs
 =ğ
nuÎ±r
è 
rhs
 ==‚ullptr;

2406 ià(
rhs
 =ğ
nuÎ±r
è 
çl£
;

2408  
	`¡rcmp
(
lhs
, 
rhs
) == 0;

2411 #ià
GTEST_HAS_STD_WSTRING


2415 
	`SŒ—mWideCh¬sToMes§ge
(cÚ¡ 
wch¬_t
* 
w¡r
, 
size_t
 
Ëngth
,

2416 
Mes§ge
* 
msg
) {

2417 
size_t
 
i
 = 0; i !ğ
Ëngth
; ) {

2418 ià(
w¡r
[
i
] !ğ
L
'\0') {

2419 *
msg
 << 
	`WideSŒšgToUtf8
(
w¡r
 + 
i
, 
¡©ic_ÿ¡
<>(
Ëngth
 - i));

2420 
i
 !ğ
Ëngth
 && 
w¡r
[i] !ğ
L
'\0')

2421 
i
++;

2423 *
msg
 << '\0';

2424 
i
++;

2431 
	`S¶™SŒšg
(cÚ¡ ::
¡d
::
¡ršg
& 
¡r
, 
d–im™”
,

2432 ::
¡d
::
veùÜ
< ::¡d::
¡ršg
>* 
de¡
) {

2433 ::
¡d
::
veùÜ
< ::¡d::
¡ršg
> 
·r£d
;

2434 ::
¡d
::
¡ršg
::
size_ty³
 
pos
 = 0;

2435 ::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()) {

2436 cÚ¡ ::
¡d
::
¡ršg
::
size_ty³
 
cŞÚ
 = 
¡r
.
	`fšd
(
d–im™”
, 
pos
);

2437 ià(
cŞÚ
 =ğ::
¡d
::
¡ršg
::
Åos
) {

2438 
·r£d
.
	`push_back
(
¡r
.
	`sub¡r
(
pos
));

2441 
·r£d
.
	`push_back
(
¡r
.
	`sub¡r
(
pos
, 
cŞÚ
 -…os));

2442 
pos
 = 
cŞÚ
 + 1;

2445 
de¡
->
	`sw­
(
·r£d
);

2455 
Mes§ge
::
	`Mes§ge
(è: 
	`ss_
(
Ãw
 ::
¡d
::
¡ršg¡»am
) {

2458 *
ss_
 << 
¡d
::
	`£»cisiÚ
(¡d::
num”ic_lim™s
<>::
dig™s10
 + 2);

2463 
Mes§ge
& Mes§ge::
İ”©Ü
 <<(cÚ¡ 
wch¬_t
* 
wide_c_¡r
) {

2464  *
this
 << 
š‹º®
::
SŒšg
::
	`ShowWideCSŒšg
(
wide_c_¡r
);

2466 
Mes§ge
& Mes§ge::
İ”©Ü
 <<(
wch¬_t
* 
wide_c_¡r
) {

2467  *
this
 << 
š‹º®
::
SŒšg
::
	`ShowWideCSŒšg
(
wide_c_¡r
);

2470 #ià
GTEST_HAS_STD_WSTRING


2473 
Mes§ge
& Mes§ge::
İ”©Ü
 <<(cÚ¡ ::
¡d
::
w¡ršg
& 
w¡r
) {

2474 
š‹º®
::
	`SŒ—mWideCh¬sToMes§ge
(
w¡r
.
	`c_¡r
(), w¡r.
	`Ëngth
(), 
this
);

2475  *
this
;

2481 
¡d
::
¡ršg
 
Mes§ge
::
	`G‘SŒšg
() const {

2482  
š‹º®
::
	`SŒšgSŒ—mToSŒšg
(
ss_
.
	`g‘
());

2487 
As£¹iÚResuÉ
::
	`As£¹iÚResuÉ
(cÚ¡ As£¹iÚResuÉ& 
Ùh”
)

2488 : 
	`sucûss_
(
Ùh”
.
sucûss_
),

2489 
	`mes§ge_
(
Ùh”
.
mes§ge_
.
	`g‘
(è!ğ
nuÎ±r


2490 ? 
Ãw
 ::
¡d
::
	`¡ršg
(*
Ùh”
.
mes§ge_
)

2491 : 
¡©ic_ÿ¡
< ::
¡d
::
¡ršg
*>(
nuÎ±r
)) {}

2494 
As£¹iÚResuÉ
::
	`sw­
(As£¹iÚResuÉ& 
Ùh”
) {

2495 
usšg
 
¡d
::
sw­
;

2496 
	`sw­
(
sucûss_
, 
Ùh”
.success_);

2497 
	`sw­
(
mes§ge_
, 
Ùh”
.message_);

2501 
As£¹iÚResuÉ
 As£¹iÚResuÉ::
İ”©Ü
!() const {

2502 
As£¹iÚResuÉ
 
	`Ãg©iÚ
(!
sucûss_
);

2503 ià(
mes§ge_
.
	`g‘
(è!ğ
nuÎ±r
è
Ãg©iÚ
 << *message_;

2504  
Ãg©iÚ
;

2508 
As£¹iÚResuÉ
 
	`As£¹iÚSucûss
() {

2509  
	`As£¹iÚResuÉ
(
Œue
);

2513 
As£¹iÚResuÉ
 
	`As£¹iÚFau»
() {

2514  
	`As£¹iÚResuÉ
(
çl£
);

2519 
As£¹iÚResuÉ
 
	`As£¹iÚFau»
(cÚ¡ 
Mes§ge
& 
mes§ge
) {

2520  
	`As£¹iÚFau»
(è<< 
mes§ge
;

2523 
Çme¥aû
 
š‹º®
 {

2525 
Çme¥aû
 
ed™_di¡ªû
 {

2526 
¡d
::
veùÜ
<
Ed™Ty³
> 
	`C®cuÏ‹O±im®Ed™s
(cÚ¡ std::veùÜ<
size_t
>& 
Ëá
,

2527 cÚ¡ 
¡d
::
veùÜ
<
size_t
>& 
right
) {

2528 
¡d
::
veùÜ
<¡d::veùÜ<> > 
	`co¡s
(

2529 
Ëá
.
	`size
(è+ 1, 
¡d
::
veùÜ
<>(
right
.size() + 1));

2530 
¡d
::
veùÜ
<¡d::veùÜ<
Ed™Ty³
> > 
	`be¡_move
(

2531 
Ëá
.
	`size
(è+ 1, 
¡d
::
veùÜ
<
Ed™Ty³
>(
right
.size() + 1));

2534 
size_t
 
l_i
 = 0;†_˜< 
co¡s
.
	`size
(); ++l_i) {

2535 
co¡s
[
l_i
][0] = 
¡©ic_ÿ¡
<>(l_i);

2536 
be¡_move
[
l_i
][0] = 
kRemove
;

2539 
size_t
 
r_i
 = 1;„_˜< 
co¡s
[0].
	`size
(); ++r_i) {

2540 
co¡s
[0][
r_i
] = 
¡©ic_ÿ¡
<>(r_i);

2541 
be¡_move
[0][
r_i
] = 
kAdd
;

2544 
size_t
 
l_i
 = 0;†_˜< 
Ëá
.
	`size
(); ++l_i) {

2545 
size_t
 
r_i
 = 0;„_˜< 
right
.
	`size
(); ++r_i) {

2546 ià(
Ëá
[
l_i
] =ğ
right
[
r_i
]) {

2548 
co¡s
[
l_i
 + 1][
r_i
 + 1] = costs[l_i][r_i];

2549 
be¡_move
[
l_i
 + 1][
r_i
 + 1] = 
kM©ch
;

2553 cÚ¡ 
add
 = 
co¡s
[
l_i
 + 1][
r_i
];

2554 cÚ¡ 
»move
 = 
co¡s
[
l_i
][
r_i
 + 1];

2555 cÚ¡ 
»¶aû
 = 
co¡s
[
l_i
][
r_i
];

2556 ià(
add
 < 
»move
 &&‡dd < 
»¶aû
) {

2557 
co¡s
[
l_i
 + 1][
r_i
 + 1] = 
add
 + 1;

2558 
be¡_move
[
l_i
 + 1][
r_i
 + 1] = 
kAdd
;

2559 } ià(
»move
 < 
add
 &&„emov< 
»¶aû
) {

2560 
co¡s
[
l_i
 + 1][
r_i
 + 1] = 
»move
 + 1;

2561 
be¡_move
[
l_i
 + 1][
r_i
 + 1] = 
kRemove
;

2565 
co¡s
[
l_i
 + 1][
r_i
 + 1] = 
»¶aû
 + 1.00001;

2566 
be¡_move
[
l_i
 + 1][
r_i
 + 1] = 
kR•Ïû
;

2572 
¡d
::
veùÜ
<
Ed™Ty³
> 
be¡_·th
;

2573 
size_t
 
l_i
 = 
Ëá
.
	`size
(), 
r_i
 = 
right
.size();†_i > 0 ||„_i > 0;) {

2574 
Ed™Ty³
 
move
 = 
be¡_move
[
l_i
][
r_i
];

2575 
be¡_·th
.
	`push_back
(
move
);

2576 
l_i
 -ğ
move
 !ğ
kAdd
;

2577 
r_i
 -ğ
move
 !ğ
kRemove
;

2579 
¡d
::
	`»v”£
(
be¡_·th
.
	`begš
(), be¡_·th.
	`’d
());

2580  
be¡_·th
;

2583 
Çme¥aû
 {

2586 şas 
	cIÁ”ÇlSŒšgs
 {

2587 
public
:

2588 
size_t
 
	`G‘Id
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
) {

2589 
IdM­
::
™”©Ü
 
™
 = 
ids_
.
	`fšd
(
¡r
);

2590 ià(
™
 !ğ
ids_
.
	`’d
()è it->
£cÚd
;

2591 
size_t
 
id
 = 
ids_
.
	`size
();

2592  
ids_
[
¡r
] = 
id
;

2595 
´iv©e
:

2596 
¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, 
	tsize_t
> 
	tIdM­
;

2597 
IdM­
 
ids_
;

2602 
¡d
::
veùÜ
<
Ed™Ty³
> 
	`C®cuÏ‹O±im®Ed™s
(

2603 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
Ëá
,

2604 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
right
) {

2605 
¡d
::
veùÜ
<
size_t
> 
Ëá_ids
, 
right_ids
;

2607 
IÁ”ÇlSŒšgs
 
š‹º_bË
;

2608 
size_t
 
i
 = 0; i < 
Ëá
.
	`size
(); ++i) {

2609 
Ëá_ids
.
	`push_back
(
š‹º_bË
.
	`G‘Id
(
Ëá
[
i
]));

2611 
size_t
 
i
 = 0; i < 
right
.
	`size
(); ++i) {

2612 
right_ids
.
	`push_back
(
š‹º_bË
.
	`G‘Id
(
right
[
i
]));

2615  
	`C®cuÏ‹O±im®Ed™s
(
Ëá_ids
, 
right_ids
);

2618 
Çme¥aû
 {

2624 şas 
	cHunk
 {

2625 
public
:

2626 
	`Hunk
(
size_t
 
Ëá_¡¬t
, size_ˆ
right_¡¬t
)

2627 : 
	`Ëá_¡¬t_
(
Ëá_¡¬t
),

2628 
	`right_¡¬t_
(
right_¡¬t
),

2629 
	`adds_
(),

2630 
	`»moves_
(),

2631 
	`commÚ_
() {}

2633 
	`PushLše
(
ed™
, cÚ¡ * 
lše
) {

2634 
ed™
) {

2636 ++
commÚ_
;

2637 
	`FlushEd™s
();

2638 
hunk_
.
	`push_back
(
¡d
::
	`make_·œ
(' ', 
lše
));

2641 ++
»moves_
;

2642 
hunk_»moves_
.
	`push_back
(
¡d
::
	`make_·œ
('-', 
lše
));

2645 ++
adds_
;

2646 
hunk_adds_
.
	`push_back
(
¡d
::
	`make_·œ
('+', 
lše
));

2651 
	`PrštTo
(
¡d
::
o¡»am
* 
os
) {

2652 
	`PrštH—d”
(
os
);

2653 
	`FlushEd™s
();

2654 
¡d
::
li¡
<¡d::
·œ
<, cÚ¡ *> >::
cÚ¡_™”©Ü
 
™
 =

2655 
hunk_
.
	`begš
();

2656 
™
 !ğ
hunk_
.
	`’d
(); ++it) {

2657 *
os
 << 
™
->
fœ¡
 << it->
£cÚd
 << "\n";

2661 
boŞ
 
	`has_ed™s
(ècÚ¡ {  
adds_
 || 
»moves_
; }

2663 
´iv©e
:

2664 
	`FlushEd™s
() {

2665 
hunk_
.
	`¥liû
(hunk_.
	`’d
(), 
hunk_»moves_
);

2666 
hunk_
.
	`¥liû
(hunk_.
	`’d
(), 
hunk_adds_
);

2673 
	`PrštH—d”
(
¡d
::
o¡»am
* 
ss
) const {

2674 *
ss
 << "@@ ";

2675 ià(
»moves_
) {

2676 *
ss
 << "-" << 
Ëá_¡¬t_
 << "," << (
»moves_
 + 
commÚ_
);

2678 ià(
»moves_
 && 
adds_
) {

2679 *
ss
 << " ";

2681 ià(
adds_
) {

2682 *
ss
 << "+" << 
right_¡¬t_
 << "," << (
adds_
 + 
commÚ_
);

2684 *
ss
 << " @@\n";

2687 
size_t
 
Ëá_¡¬t_
, 
right_¡¬t_
;

2688 
size_t
 
adds_
, 
»moves_
, 
commÚ_
;

2689 
¡d
::
li¡
<¡d::
·œ
<, cÚ¡ *> > 
hunk_
, 
hunk_adds_
, 
hunk_»moves_
;

2701 
¡d
::
¡ršg
 
	`C»©eUnif›dDiff
(cÚ¡ std::
veùÜ
<¡d::¡ršg>& 
Ëá
,

2702 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
right
,

2703 
size_t
 
cÚ‹xt
) {

2704 cÚ¡ 
¡d
::
veùÜ
<
Ed™Ty³
> 
ed™s
 = 
	`C®cuÏ‹O±im®Ed™s
(
Ëá
, 
right
);

2706 
size_t
 
l_i
 = 0, 
r_i
 = 0, 
ed™_i
 = 0;

2707 
¡d
::
¡ršg¡»am
 
ss
;

2708 
ed™_i
 < 
ed™s
.
	`size
()) {

2710 
ed™_i
 < 
ed™s
.
	`size
(è&&ƒd™s[ed™_i] =ğ
kM©ch
) {

2711 ++
l_i
;

2712 ++
r_i
;

2713 ++
ed™_i
;

2717 cÚ¡ 
size_t
 
´efix_cÚ‹xt
 = 
¡d
::
	`mš
(
l_i
, 
cÚ‹xt
);

2718 
Hunk
 
	`hunk
(
l_i
 - 
´efix_cÚ‹xt
 + 1, 
r_i
 -…refix_context + 1);

2719 
size_t
 
i
 = 
´efix_cÚ‹xt
; i > 0; --i) {

2720 
hunk
.
	`PushLše
(' ', 
Ëá
[
l_i
 - 
i
].
	`c_¡r
());

2725 
size_t
 
n_suffix
 = 0;

2726 ; 
ed™_i
 < 
ed™s
.
	`size
(); ++edit_i) {

2727 ià(
n_suffix
 >ğ
cÚ‹xt
) {

2729 autØ
™
 = 
ed™s
.
	`begš
(è+ 
¡©ic_ÿ¡
<>(
ed™_i
);

2730 
™
 !ğ
ed™s
.
	`’d
(è&& *™ =ğ
kM©ch
) ++it;

2731 ià(
™
 =ğ
ed™s
.
	`’d
() ||

2732 
¡©ic_ÿ¡
<
size_t
>(
™
 - 
ed™s
.
	`begš
()è- 
ed™_i
 >ğ
cÚ‹xt
) {

2738 
Ed™Ty³
 
ed™
 = 
ed™s
[
ed™_i
];

2740 
n_suffix
 = 
ed™
 =ğ
kM©ch
 ?‚_suffix + 1 : 0;

2742 ià(
ed™
 =ğ
kM©ch
 ||ƒd™ =ğ
kRemove
 ||ƒd™ =ğ
kR•Ïû
) {

2743 
hunk
.
	`PushLše
(
ed™
 =ğ
kM©ch
 ? ' ' : '-', 
Ëá
[
l_i
].
	`c_¡r
());

2745 ià(
ed™
 =ğ
kAdd
 ||ƒd™ =ğ
kR•Ïû
) {

2746 
hunk
.
	`PushLše
('+', 
right
[
r_i
].
	`c_¡r
());

2750 
l_i
 +ğ
ed™
 !ğ
kAdd
;

2751 
r_i
 +ğ
ed™
 !ğ
kRemove
;

2754 ià(!
hunk
.
	`has_ed™s
()) {

2759 
hunk
.
	`PrštTo
(&
ss
);

2761  
ss
.
	`¡r
();

2766 
Çme¥aû
 {

2771 
¡d
::
veùÜ
<¡d::
¡ršg
> 
	`S¶™Esÿ³dSŒšg
(cÚ¡ std::¡ršg& 
¡r
) {

2772 
¡d
::
veùÜ
<¡d::
¡ršg
> 
lšes
;

2773 
size_t
 
¡¬t
 = 0, 
’d
 = 
¡r
.
	`size
();

2774 ià(
’d
 > 2 && 
¡r
[0] == '"' && str[end - 1] == '"') {

2775 ++
¡¬t
;

2776 --
’d
;

2778 
boŞ
 
esÿ³d
 = 
çl£
;

2779 
size_t
 
i
 = 
¡¬t
; i + 1 < 
’d
; ++i) {

2780 ià(
esÿ³d
) {

2781 
esÿ³d
 = 
çl£
;

2782 ià(
¡r
[
i
] == 'n') {

2783 
lšes
.
	`push_back
(
¡r
.
	`sub¡r
(
¡¬t
, 
i
 - start - 1));

2784 
¡¬t
 = 
i
 + 1;

2787 
esÿ³d
 = 
¡r
[
i
] == '\\';

2790 
lšes
.
	`push_back
(
¡r
.
	`sub¡r
(
¡¬t
, 
’d
 - start));

2791  
lšes
;

2811 
As£¹iÚResuÉ
 
	`EqFau»
(cÚ¡ * 
lhs_ex´essiÚ
,

2812 cÚ¡ * 
rhs_ex´essiÚ
,

2813 cÚ¡ 
¡d
::
¡ršg
& 
lhs_v®ue
,

2814 cÚ¡ 
¡d
::
¡ršg
& 
rhs_v®ue
,

2815 
boŞ
 
ignÜšg_ÿ£
) {

2816 
Mes§ge
 
msg
;

2817 
msg
 << "Expectedƒquality ofhese values:";

2818 
msg
 << "\À " << 
lhs_ex´essiÚ
;

2819 ià(
lhs_v®ue
 !ğ
lhs_ex´essiÚ
) {

2820 
msg
 << "\À Which is: " << 
lhs_v®ue
;

2822 
msg
 << "\À " << 
rhs_ex´essiÚ
;

2823 ià(
rhs_v®ue
 !ğ
rhs_ex´essiÚ
) {

2824 
msg
 << "\À Which is: " << 
rhs_v®ue
;

2827 ià(
ignÜšg_ÿ£
) {

2828 
msg
 << "\nIgnoring case";

2831 ià(!
lhs_v®ue
.
	`em±y
(è&& !
rhs_v®ue
.empty()) {

2832 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> 
lhs_lšes
 =

2833 
	`S¶™Esÿ³dSŒšg
(
lhs_v®ue
);

2834 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> 
rhs_lšes
 =

2835 
	`S¶™Esÿ³dSŒšg
(
rhs_v®ue
);

2836 ià(
lhs_lšes
.
	`size
(è> 1 || 
rhs_lšes
.size() > 1) {

2837 
msg
 << "\nWith diff:\n"

2838 << 
ed™_di¡ªû
::
	`C»©eUnif›dDiff
(
lhs_lšes
, 
rhs_lšes
);

2842  
	`As£¹iÚFau»
(è<< 
msg
;

2846 
¡d
::
¡ršg
 
	`G‘BoŞAs£¹iÚFau»Mes§ge
(

2847 cÚ¡ 
As£¹iÚResuÉ
& 
as£¹iÚ_»suÉ
,

2848 cÚ¡ * 
ex´essiÚ_‹xt
,

2849 cÚ¡ * 
aùu®_´ediÿ‹_v®ue
,

2850 cÚ¡ * 
ex³ùed_´ediÿ‹_v®ue
) {

2851 cÚ¡ * 
aùu®_mes§ge
 = 
as£¹iÚ_»suÉ
.
	`mes§ge
();

2852 
Mes§ge
 
msg
;

2853 
msg
 << "V®uof: " << 
ex´essiÚ_‹xt


2854 << "\À Aùu®: " << 
aùu®_´ediÿ‹_v®ue
;

2855 ià(
aùu®_mes§ge
[0] != '\0')

2856 
msg
 << " (" << 
aùu®_mes§ge
 << ")";

2857 
msg
 << "\nEx³ùed: " << 
ex³ùed_´ediÿ‹_v®ue
;

2858  
msg
.
	`G‘SŒšg
();

2862 
As£¹iÚResuÉ
 
	`DoubËN—rP»dFÜm©
(cÚ¡ * 
ex´1
,

2863 cÚ¡ * 
ex´2
,

2864 cÚ¡ * 
abs_”rÜ_ex´
,

2865 
v®1
,

2866 
v®2
,

2867 
abs_”rÜ
) {

2868 cÚ¡ 
diff
 = 
	`çbs
(
v®1
 - 
v®2
);

2869 ià(
diff
 <ğ
abs_”rÜ
è 
	`As£¹iÚSucûss
();

2871  
	`As£¹iÚFau»
()

2872 << "Thdifã»nû b‘w“À" << 
ex´1
 << "‡nd " << 
ex´2


2873 << " i " << 
diff
 << ", whichƒxûed " << 
abs_”rÜ_ex´
 << ", where\n"

2874 << 
ex´1
 << "ƒv®u©e tØ" << 
v®1
 << ",\n"

2875 << 
ex´2
 << "ƒv®u©e tØ" << 
v®2
 << ",‡nd\n"

2876 << 
abs_”rÜ_ex´
 << "ƒv®u©e tØ" << 
abs_”rÜ
 << ".";

2881 
‹m¶©e
 <
ty³Çme
 
RawTy³
>

2882 
As£¹iÚResuÉ
 
	`FlßtšgPoštLE
(cÚ¡ * 
ex´1
,

2883 cÚ¡ * 
ex´2
,

2884 
RawTy³
 
v®1
,

2885 
RawTy³
 
v®2
) {

2887 ià(
v®1
 < 
v®2
) {

2888  
	`As£¹iÚSucûss
();

2892 cÚ¡ 
FlßtšgPošt
<
RawTy³
> 
	`lhs
(
v®1
), 
	`rhs
(
v®2
);

2893 ià(
lhs
.
	`Almo¡Equ®s
(
rhs
)) {

2894  
	`As£¹iÚSucûss
();

2901 ::
¡d
::
¡ršg¡»am
 
v®1_ss
;

2902 
v®1_ss
 << 
¡d
::
	`£»cisiÚ
(¡d::
num”ic_lim™s
<
RawTy³
>::
dig™s10
 + 2)

2903 << 
v®1
;

2905 ::
¡d
::
¡ršg¡»am
 
v®2_ss
;

2906 
v®2_ss
 << 
¡d
::
	`£»cisiÚ
(¡d::
num”ic_lim™s
<
RawTy³
>::
dig™s10
 + 2)

2907 << 
v®2
;

2909  
	`As£¹iÚFau»
()

2910 << "Ex³ùed: (" << 
ex´1
 << "è<ğ(" << 
ex´2
 << ")\n"

2911 << " Aùu®: " << 
	`SŒšgSŒ—mToSŒšg
(&
v®1_ss
) << " vs "

2912 << 
	`SŒšgSŒ—mToSŒšg
(&
v®2_ss
);

2915 
	}
}

2919 
As£¹iÚResuÉ
 
	$FlßtLE
(cÚ¡ * 
ex´1
, cÚ¡ * 
ex´2
,

2920 
v®1
, 
v®2
) {

2921  
š‹º®
::
FlßtšgPoštLE
<>(
ex´1
, 
ex´2
, 
v®1
, 
v®2
);

2922 
	}
}

2926 
As£¹iÚResuÉ
 
	$DoubËLE
(cÚ¡ * 
ex´1
, cÚ¡ * 
ex´2
,

2927 
v®1
, 
v®2
) {

2928  
š‹º®
::
FlßtšgPoštLE
<>(
ex´1
, 
ex´2
, 
v®1
, 
v®2
);

2929 
	}
}

2931 
Çme¥aû
 
	gš‹º®
 {

2935 
As£¹iÚResuÉ
 
CmpH–³rEQ
(cÚ¡ * 
lhs_ex´essiÚ
,

2936 cÚ¡ * 
rhs_ex´essiÚ
,

2937 
Bigge¡IÁ
 
lhs
,

2938 
Bigge¡IÁ
 
rhs
) {

2939 ià(
	glhs
 =ğ
rhs
) {

2940  
As£¹iÚSucûss
();

2943  
EqFau»
(
lhs_ex´essiÚ
,

2944 
rhs_ex´essiÚ
,

2945 
FÜm©FÜCom·risÚFau»Mes§ge
(
lhs
, 
rhs
),

2946 
FÜm©FÜCom·risÚFau»Mes§ge
(
rhs
, 
lhs
),

2947 
çl£
);

2953 
	#GTEST_IMPL_CMP_HELPER_
(
İ_Çme
, 
İ
)\

2954 
As£¹iÚResuÉ
 
CmpH–³r
##
	`İ_Çme
(cÚ¡ * 
ex´1
, cÚ¡ * 
ex´2
, \

2955 
Bigge¡IÁ
 
v®1
, Bigge¡IÁ 
v®2
) {\

2956 ià(
v®1
 
İ
 
v®2
) {\

2957  
	`As£¹iÚSucûss
();\

2959  
	`As£¹iÚFau»
() \

2960 << "Ex³ùed: (" << 
ex´1
 << "è" #İ " (" << 
ex´2
\

2961 << "),‡ùu®: " << 
	`FÜm©FÜCom·risÚFau»Mes§ge
(
v®1
, 
v®2
)\

2962 << " v " << 
	`FÜm©FÜCom·risÚFau»Mes§ge
(
v®2
, 
v®1
);\

2964 }

	)

2968 
GTEST_IMPL_CMP_HELPER_
(
NE
, !=)

2971 
GTEST_IMPL_CMP_HELPER_
(
LE
, <=)

2974 
GTEST_IMPL_CMP_HELPER_
(
LT
, < )

2977 
GTEST_IMPL_CMP_HELPER_
(
GE
, >=)

2980 
GTEST_IMPL_CMP_HELPER_
(
GT
, > )

2982 #undeà
GTEST_IMPL_CMP_HELPER_


2985 
As£¹iÚResuÉ
 
CmpH–³rSTREQ
(cÚ¡ * 
lhs_ex´essiÚ
,

2986 cÚ¡ * 
rhs_ex´essiÚ
,

2987 cÚ¡ * 
lhs
,

2988 cÚ¡ * 
rhs
) {

2989 ià(
	gSŒšg
::
CSŒšgEqu®s
(
lhs
, 
rhs
)) {

2990  
As£¹iÚSucûss
();

2993  
EqFau»
(
lhs_ex´essiÚ
,

2994 
rhs_ex´essiÚ
,

2995 
PrštToSŒšg
(
lhs
),

2996 
PrštToSŒšg
(
rhs
),

2997 
çl£
);

3001 
As£¹iÚResuÉ
 
CmpH–³rSTRCASEEQ
(cÚ¡ * 
lhs_ex´essiÚ
,

3002 cÚ¡ * 
rhs_ex´essiÚ
,

3003 cÚ¡ * 
lhs
,

3004 cÚ¡ * 
rhs
) {

3005 ià(
	gSŒšg
::
Ca£In£ns™iveCSŒšgEqu®s
(
lhs
, 
rhs
)) {

3006  
As£¹iÚSucûss
();

3009  
EqFau»
(
lhs_ex´essiÚ
,

3010 
rhs_ex´essiÚ
,

3011 
PrštToSŒšg
(
lhs
),

3012 
PrštToSŒšg
(
rhs
),

3013 
Œue
);

3017 
As£¹iÚResuÉ
 
CmpH–³rSTRNE
(cÚ¡ * 
s1_ex´essiÚ
,

3018 cÚ¡ * 
s2_ex´essiÚ
,

3019 cÚ¡ * 
s1
,

3020 cÚ¡ * 
s2
) {

3021 ià(!
	gSŒšg
::
CSŒšgEqu®s
(
s1
, 
s2
)) {

3022  
As£¹iÚSucûss
();

3024  
As£¹iÚFau»
(è<< "Ex³ùed: (" << 
	gs1_ex´essiÚ
 << ") != ("

3025 << 
	gs2_ex´essiÚ
 << "),‡ctual: \""

3026 << 
	gs1
 << "\" v \"" << 
	gs2
 << "\"";

3031 
As£¹iÚResuÉ
 
CmpH–³rSTRCASENE
(cÚ¡ * 
s1_ex´essiÚ
,

3032 cÚ¡ * 
s2_ex´essiÚ
,

3033 cÚ¡ * 
s1
,

3034 cÚ¡ * 
s2
) {

3035 ià(!
	gSŒšg
::
Ca£In£ns™iveCSŒšgEqu®s
(
s1
, 
s2
)) {

3036  
As£¹iÚSucûss
();

3038  
As£¹iÚFau»
()

3039 << "Ex³ùed: (" << 
	gs1_ex´essiÚ
 << ") != ("

3040 << 
	gs2_ex´essiÚ
 << ") (ignoring case),‡ctual: \""

3041 << 
	gs1
 << "\" v \"" << 
	gs2
 << "\"";

3047 
	gÇme¥aû
 {

3055 
boŞ
 
IsSub¡ršgP»d
(cÚ¡ * 
ÃedË
, cÚ¡ * 
hay¡ack
) {

3056 ià(
	gÃedË
 =ğ
nuÎ±r
 || 
hay¡ack
 =ğnuÎ±rè 
ÃedË
 == haystack;

3058  
¡r¡r
(
hay¡ack
, 
ÃedË
è!ğ
nuÎ±r
;

3061 
boŞ
 
IsSub¡ršgP»d
(cÚ¡ 
wch¬_t
* 
ÃedË
, cÚ¡ wch¬_t* 
hay¡ack
) {

3062 ià(
	gÃedË
 =ğ
nuÎ±r
 || 
hay¡ack
 =ğnuÎ±rè 
ÃedË
 == haystack;

3064  
wcs¡r
(
hay¡ack
, 
ÃedË
è!ğ
nuÎ±r
;

3068 
	g‹m¶©e
 <
ty³Çme
 
	gSŒšgTy³
>

3069 
boŞ
 
IsSub¡ršgP»d
(cÚ¡ 
SŒšgTy³
& 
ÃedË
,

3070 cÚ¡ 
SŒšgTy³
& 
hay¡ack
) {

3071  
	ghay¡ack
.
fšd
(
ÃedË
è!ğ
SŒšgTy³
::
Åos
;

3078 
	g‹m¶©e
 <
ty³Çme
 
	gSŒšgTy³
>

3079 
As£¹iÚResuÉ
 
IsSub¡ršgIm¶
(

3080 
boŞ
 
ex³ùed_to_be_sub¡ršg
,

3081 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

3082 cÚ¡ 
SŒšgTy³
& 
ÃedË
, cÚ¡ SŒšgTy³& 
hay¡ack
) {

3083 ià(
IsSub¡ršgP»d
(
ÃedË
, 
hay¡ack
è=ğ
ex³ùed_to_be_sub¡ršg
)

3084  
As£¹iÚSucûss
();

3086 cÚ¡ 
boŞ
 
	gis_wide_¡ršg
 = (
ÃedË
[0]) > 1;

3087 cÚ¡ * cÚ¡ 
	gbegš_¡ršg_quÙe
 = 
is_wide_¡ršg
 ? "L\"" : "\"";

3088  
As£¹iÚFau»
()

3089 << "V®uof: " << 
	gÃedË_ex´
 << "\n"

3090 << " Aùu®: " << 
	gbegš_¡ršg_quÙe
 << 
	gÃedË
 << "\"\n"

3091 << "Ex³ùed: " << (
	gex³ùed_to_be_sub¡ršg
 ? "" : "not ")

3092 << "¨sub¡ršg oà" << 
hay¡ack_ex´
 << "\n"

3093 << "Which is: " << 
begš_¡ršg_quÙe
 << 
hay¡ack
 << "\"";

3102 
As£¹iÚResuÉ
 
	$IsSub¡ršg
(

3103 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

3104 cÚ¡ * 
ÃedË
, cÚ¡ * 
hay¡ack
) {

3105  
	`IsSub¡ršgIm¶
(
Œue
, 
ÃedË_ex´
, 
hay¡ack_ex´
, 
ÃedË
, 
hay¡ack
);

3106 
	}
}

3108 
As£¹iÚResuÉ
 
	$IsSub¡ršg
(

3109 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

3110 cÚ¡ 
wch¬_t
* 
ÃedË
, cÚ¡ wch¬_t* 
hay¡ack
) {

3111  
	`IsSub¡ršgIm¶
(
Œue
, 
ÃedË_ex´
, 
hay¡ack_ex´
, 
ÃedË
, 
hay¡ack
);

3112 
	}
}

3114 
As£¹iÚResuÉ
 
	$IsNÙSub¡ršg
(

3115 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

3116 cÚ¡ * 
ÃedË
, cÚ¡ * 
hay¡ack
) {

3117  
	`IsSub¡ršgIm¶
(
çl£
, 
ÃedË_ex´
, 
hay¡ack_ex´
, 
ÃedË
, 
hay¡ack
);

3118 
	}
}

3120 
As£¹iÚResuÉ
 
	$IsNÙSub¡ršg
(

3121 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

3122 cÚ¡ 
wch¬_t
* 
ÃedË
, cÚ¡ wch¬_t* 
hay¡ack
) {

3123  
	`IsSub¡ršgIm¶
(
çl£
, 
ÃedË_ex´
, 
hay¡ack_ex´
, 
ÃedË
, 
hay¡ack
);

3124 
	}
}

3126 
As£¹iÚResuÉ
 
	$IsSub¡ršg
(

3127 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

3128 cÚ¡ ::
¡d
::
¡ršg
& 
ÃedË
, cÚ¡ ::¡d::¡ršg& 
hay¡ack
) {

3129  
	`IsSub¡ršgIm¶
(
Œue
, 
ÃedË_ex´
, 
hay¡ack_ex´
, 
ÃedË
, 
hay¡ack
);

3130 
	}
}

3132 
As£¹iÚResuÉ
 
	$IsNÙSub¡ršg
(

3133 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

3134 cÚ¡ ::
¡d
::
¡ršg
& 
ÃedË
, cÚ¡ ::¡d::¡ršg& 
hay¡ack
) {

3135  
	`IsSub¡ršgIm¶
(
çl£
, 
ÃedË_ex´
, 
hay¡ack_ex´
, 
ÃedË
, 
hay¡ack
);

3136 
	}
}

3138 #ià
GTEST_HAS_STD_WSTRING


3139 
As£¹iÚResuÉ
 
	$IsSub¡ršg
(

3140 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

3141 cÚ¡ ::
¡d
::
w¡ršg
& 
ÃedË
, cÚ¡ ::¡d::w¡ršg& 
hay¡ack
) {

3142  
	`IsSub¡ršgIm¶
(
Œue
, 
ÃedË_ex´
, 
hay¡ack_ex´
, 
ÃedË
, 
hay¡ack
);

3143 
	}
}

3145 
As£¹iÚResuÉ
 
	$IsNÙSub¡ršg
(

3146 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

3147 cÚ¡ ::
¡d
::
w¡ršg
& 
ÃedË
, cÚ¡ ::¡d::w¡ršg& 
hay¡ack
) {

3148  
	`IsSub¡ršgIm¶
(
çl£
, 
ÃedË_ex´
, 
hay¡ack_ex´
, 
ÃedË
, 
hay¡ack
);

3149 
	}
}

3152 
Çme¥aû
 
	gš‹º®
 {

3154 #ià
GTEST_OS_WINDOWS


3156 
	gÇme¥aû
 {

3159 
As£¹iÚResuÉ
 
HRESULTFau»H–³r
(cÚ¡ * 
ex´
,

3160 cÚ¡ * 
ex³ùed
,

3161 
hr
) {

3162 #ià
GTEST_OS_WINDOWS_MOBILE
 || 
GTEST_OS_WINDOWS_TV_TITLE


3165 cÚ¡ 
	g”rÜ_‹xt
[] = "";

3172 cÚ¡ 
DWORD
 
	gkFÏgs
 = 
FORMAT_MESSAGE_FROM_SYSTEM
 |

3173 
FORMAT_MESSAGE_IGNORE_INSERTS
;

3174 cÚ¡ 
DWORD
 
	gkBufSize
 = 4096;

3176 
	g”rÜ_‹xt
[
kBufSize
] = { '\0' };

3177 
DWORD
 
	gmes§ge_Ëngth
 = ::
FÜm©Mes§geA
(
kFÏgs
,

3179 
¡©ic_ÿ¡
<
DWORD
>(
hr
),

3181 
”rÜ_‹xt
,

3182 
kBufSize
,

3183 
nuÎ±r
);

3185 ; 
	gmes§ge_Ëngth
 && 
IsS·û
(
”rÜ_‹xt
[
mes§ge_Ëngth
 - 1]);

3186 --
	gmes§ge_Ëngth
) {

3187 
	g”rÜ_‹xt
[
mes§ge_Ëngth
 - 1] = '\0';

3192 cÚ¡ 
	g¡d
::
¡ršg
 
”rÜ_hex
("0x" + 
SŒšg
::
FÜm©HexIÁ
(
hr
));

3193  ::
‹¡šg
::
As£¹iÚFau»
()

3194 << "Ex³ùed: " << 
ex´
 << " " << 
ex³ùed
 << ".\n"

3195 << " Aùu®: " << 
”rÜ_hex
 << " " << 
”rÜ_‹xt
 << "\n";

3200 
As£¹iÚResuÉ
 
IsHRESULTSucûss
(cÚ¡ * 
ex´
, 
hr
) {

3201 ià(
SUCCEEDED
(
hr
)) {

3202  
As£¹iÚSucûss
();

3204  
HRESULTFau»H–³r
(
ex´
, "sucûeds", 
hr
);

3207 
As£¹iÚResuÉ
 
IsHRESULTFau»
(cÚ¡ * 
ex´
, 
hr
) {

3208 ià(
FAILED
(
hr
)) {

3209  
As£¹iÚSucûss
();

3211  
HRESULTFau»H–³r
(
ex´
, "çs", 
hr
);

3229 cÚ¡ 
UIÁ32
 
	gkMaxCodePošt1
 = (
¡©ic_ÿ¡
<UInt32>(1) << 7) - 1;

3232 cÚ¡ 
UIÁ32
 
	gkMaxCodePošt2
 = (
¡©ic_ÿ¡
<UInt32>(1) << (5 + 6)) - 1;

3235 cÚ¡ 
UIÁ32
 
	gkMaxCodePošt3
 = (
¡©ic_ÿ¡
<UInt32>(1) << (4 + 2*6)) - 1;

3238 cÚ¡ 
UIÁ32
 
	gkMaxCodePošt4
 = (
¡©ic_ÿ¡
<UInt32>(1) << (3 + 3*6)) - 1;

3243 
šlše
 
UIÁ32
 
ChİLowB™s
(UIÁ32* 
b™s
, 
n
) {

3244 cÚ¡ 
UIÁ32
 
	glow_b™s
 = *
b™s
 & ((
¡©ic_ÿ¡
<UIÁ32>(1è<< 
n
) - 1);

3245 *
	gb™s
 >>ğ
n
;

3246  
	glow_b™s
;

3255 
	g¡d
::
¡ršg
 
CodePoštToUtf8
(
UIÁ32
 
code_pošt
) {

3256 ià(
code_pošt
 > 
kMaxCodePošt4
) {

3257  "(Inv®id Unicod0x" + 
SŒšg
::
FÜm©HexUIÁ32
(
code_pošt
) + ")";

3260 
	g¡r
[5];

3261 ià(
	gcode_pošt
 <ğ
kMaxCodePošt1
) {

3262 
¡r
[1] = '\0';

3263 
	g¡r
[0] = 
¡©ic_ÿ¡
<>(
code_pošt
);

3264 } ià(
	gcode_pošt
 <ğ
kMaxCodePošt2
) {

3265 
¡r
[2] = '\0';

3266 
	g¡r
[1] = 
¡©ic_ÿ¡
<>(0x80 | 
ChİLowB™s
(&
code_pošt
, 6));

3267 
	g¡r
[0] = 
¡©ic_ÿ¡
<>(0xC0 | 
code_pošt
);

3268 } ià(
	gcode_pošt
 <ğ
kMaxCodePošt3
) {

3269 
¡r
[3] = '\0';

3270 
	g¡r
[2] = 
¡©ic_ÿ¡
<>(0x80 | 
ChİLowB™s
(&
code_pošt
, 6));

3271 
	g¡r
[1] = 
¡©ic_ÿ¡
<>(0x80 | 
ChİLowB™s
(&
code_pošt
, 6));

3272 
	g¡r
[0] = 
¡©ic_ÿ¡
<>(0xE0 | 
code_pošt
);

3274 
	g¡r
[4] = '\0';

3275 
	g¡r
[3] = 
¡©ic_ÿ¡
<>(0x80 | 
ChİLowB™s
(&
code_pošt
, 6));

3276 
	g¡r
[2] = 
¡©ic_ÿ¡
<>(0x80 | 
ChİLowB™s
(&
code_pošt
, 6));

3277 
	g¡r
[1] = 
¡©ic_ÿ¡
<>(0x80 | 
ChİLowB™s
(&
code_pošt
, 6));

3278 
	g¡r
[0] = 
¡©ic_ÿ¡
<>(0xF0 | 
code_pošt
);

3280  
	g¡r
;

3290 
šlše
 
boŞ
 
IsUtf16Su¼og©ePaœ
(
wch¬_t
 
fœ¡
, wch¬_ˆ
£cÚd
) {

3291  (
	gwch¬_t
) == 2 &&

3292 (
fœ¡
 & 0xFC00è=ğ0xD800 && (
£cÚd
 & 0xFC00) == 0xDC00;

3296 
šlše
 
UIÁ32
 
C»©eCodePoštFromUtf16Su¼og©ePaœ
(
wch¬_t
 
fœ¡
,

3297 
wch¬_t
 
£cÚd
) {

3298 cÚ¡‡utØ
	gfœ¡_u
 = 
¡©ic_ÿ¡
<
UIÁ32
>(
fœ¡
);

3299 cÚ¡‡utØ
	g£cÚd_u
 = 
¡©ic_ÿ¡
<
UIÁ32
>(
£cÚd
);

3300 cÚ¡ 
UIÁ32
 
	gmask
 = (1 << 10) - 1;

3301  ((
	gwch¬_t
) == 2)

3302 ? (((
fœ¡_u
 & 
mask
è<< 10è| (
£cÚd_u
 & mask)) + 0x10000

3306 
fœ¡_u
;

3322 
	g¡d
::
¡ršg
 
WideSŒšgToUtf8
(cÚ¡ 
wch¬_t
* 
¡r
, 
num_ch¬s
) {

3323 ià(
	gnum_ch¬s
 == -1)

3324 
num_ch¬s
 = 
¡©ic_ÿ¡
<>(
wc¦’
(
¡r
));

3326 ::
¡d
::
¡ršg¡»am
 
¡»am
;

3327 
	gi
 = 0; i < 
	gnum_ch¬s
; ++i) {

3328 
UIÁ32
 
	gunicode_code_pošt
;

3330 ià(
	g¡r
[
i
] =ğ
L
'\0') {

3332 } ià(
	gi
 + 1 < 
	gnum_ch¬s
 && 
IsUtf16Su¼og©ePaœ
(
¡r
[
i
], str[i + 1])) {

3333 
	gunicode_code_pošt
 = 
C»©eCodePoštFromUtf16Su¼og©ePaœ
(
¡r
[
i
],

3334 
¡r
[
i
 + 1]);

3335 
	gi
++;

3337 
	gunicode_code_pošt
 = 
¡©ic_ÿ¡
<
UIÁ32
>(
¡r
[
i
]);

3340 
	g¡»am
 << 
CodePoštToUtf8
(
unicode_code_pošt
);

3342  
SŒšgSŒ—mToSŒšg
(&
¡»am
);

3347 
	g¡d
::
¡ršg
 
SŒšg
::
ShowWideCSŒšg
(cÚ¡ 
wch¬_t
 * 
wide_c_¡r
) {

3348 ià(
wide_c_¡r
 =ğ
nuÎ±r
)  "(null)";

3350  
	gš‹º®
::
WideSŒšgToUtf8
(
wide_c_¡r
, -1);

3359 
boŞ
 
	gSŒšg
::
WideCSŒšgEqu®s
(cÚ¡ 
wch¬_t
 * 
lhs
, cÚ¡ wch¬_ˆ* 
rhs
) {

3360 ià(
	glhs
 =ğ
nuÎ±r
è 
rhs
 ==‚ullptr;

3362 ià(
	grhs
 =ğ
nuÎ±r
è 
çl£
;

3364  
wcscmp
(
lhs
, 
rhs
) == 0;

3368 
As£¹iÚResuÉ
 
CmpH–³rSTREQ
(cÚ¡ * 
lhs_ex´essiÚ
,

3369 cÚ¡ * 
rhs_ex´essiÚ
,

3370 cÚ¡ 
wch¬_t
* 
lhs
,

3371 cÚ¡ 
wch¬_t
* 
rhs
) {

3372 ià(
	gSŒšg
::
WideCSŒšgEqu®s
(
lhs
, 
rhs
)) {

3373  
As£¹iÚSucûss
();

3376  
EqFau»
(
lhs_ex´essiÚ
,

3377 
rhs_ex´essiÚ
,

3378 
PrštToSŒšg
(
lhs
),

3379 
PrštToSŒšg
(
rhs
),

3380 
çl£
);

3384 
As£¹iÚResuÉ
 
CmpH–³rSTRNE
(cÚ¡ * 
s1_ex´essiÚ
,

3385 cÚ¡ * 
s2_ex´essiÚ
,

3386 cÚ¡ 
wch¬_t
* 
s1
,

3387 cÚ¡ 
wch¬_t
* 
s2
) {

3388 ià(!
	gSŒšg
::
WideCSŒšgEqu®s
(
s1
, 
s2
)) {

3389  
As£¹iÚSucûss
();

3392  
As£¹iÚFau»
(è<< "Ex³ùed: (" << 
	gs1_ex´essiÚ
 << ") != ("

3393 << 
	gs2_ex´essiÚ
 << "),‡ctual: "

3394 << 
PrštToSŒšg
(
s1
)

3395 << " v " << 
PrštToSŒšg
(
s2
);

3404 
boŞ
 
	gSŒšg
::
Ca£In£ns™iveCSŒšgEqu®s
(cÚ¡ * 
lhs
, cÚ¡ * 
rhs
) {

3405 ià(
	glhs
 =ğ
nuÎ±r
è 
rhs
 ==‚ullptr;

3406 ià(
	grhs
 =ğ
nuÎ±r
è 
çl£
;

3407  
	gposix
::
SŒCa£Cmp
(
lhs
, 
rhs
) == 0;

3422 
boŞ
 
	gSŒšg
::
Ca£In£ns™iveWideCSŒšgEqu®s
(cÚ¡ 
wch¬_t
* 
lhs
,

3423 cÚ¡ 
wch¬_t
* 
rhs
) {

3424 ià(
	glhs
 =ğ
nuÎ±r
è 
rhs
 ==‚ullptr;

3426 ià(
	grhs
 =ğ
nuÎ±r
è 
çl£
;

3428 #ià
GTEST_OS_WINDOWS


3429  
_wcsicmp
(
lhs
, 
rhs
) == 0;

3430 #–ià
GTEST_OS_LINUX
 && !
GTEST_OS_LINUX_ANDROID


3431  
wcsÿ£cmp
(
lhs
, 
rhs
) == 0;

3435 
wšt_t
 
	gËá
, 
	gright
;

3437 
	gËá
 = 
towlow”
(
¡©ic_ÿ¡
<
wšt_t
>(*
lhs
++));

3438 
	gright
 = 
towlow”
(
¡©ic_ÿ¡
<
wšt_t
>(*
rhs
++));

3439 } 
	gËá
 &&†eá =ğ
right
);

3440  
	gËá
 =ğ
right
;

3446 
boŞ
 
	gSŒšg
::
EndsW™hCa£In£ns™ive
(

3447 cÚ¡ 
¡d
::
¡ršg
& 
¡r
, cÚ¡ std::¡ršg& 
suffix
) {

3448 cÚ¡ 
size_t
 
¡r_Ën
 = 
¡r
.
Ëngth
();

3449 cÚ¡ 
size_t
 
	gsuffix_Ën
 = 
suffix
.
Ëngth
();

3450  (
	g¡r_Ën
 >ğ
suffix_Ën
) &&

3451 
Ca£In£ns™iveCSŒšgEqu®s
(
¡r
.
c_¡r
(è+ 
¡r_Ën
 - 
suffix_Ën
,

3452 
suffix
.
c_¡r
());

3456 
	g¡d
::
¡ršg
 
SŒšg
::
FÜm©IÁWidth2
(
v®ue
) {

3457 
¡d
::
¡ršg¡»am
 
ss
;

3458 
	gss
 << 
	g¡d
::
£tfl
('0'è<< 
¡d
::
£tw
(2è<< 
v®ue
;

3459  
	gss
.
¡r
();

3463 
	g¡d
::
¡ršg
 
SŒšg
::
FÜm©HexUIÁ32
(
UIÁ32
 
v®ue
) {

3464 
¡d
::
¡ršg¡»am
 
ss
;

3465 
	gss
 << 
	g¡d
::
hex
 << 
¡d
::
uµ”ÿ£
 << 
v®ue
;

3466  
	gss
.
¡r
();

3470 
	g¡d
::
¡ršg
 
SŒšg
::
FÜm©HexIÁ
(
v®ue
) {

3471  
FÜm©HexUIÁ32
(
¡©ic_ÿ¡
<
UIÁ32
>(
v®ue
));

3475 
	g¡d
::
¡ršg
 
SŒšg
::
FÜm©By‹
(
v®ue
) {

3476 
¡d
::
¡ršg¡»am
 
ss
;

3477 
	gss
 << 
	g¡d
::
£tfl
('0'è<< 
¡d
::
£tw
(2è<< std::
hex
 << std::
uµ”ÿ£


3478 << 
¡©ic_ÿ¡
<>(
v®ue
);

3479  
	gss
.
¡r
();

3484 
	g¡d
::
¡ršg
 
SŒšgSŒ—mToSŒšg
(::
¡d
::
¡ršg¡»am
* 
ss
) {

3485 cÚ¡ ::
¡d
::
¡ršg
& 
¡r
 = 
ss
->str();

3486 cÚ¡ * cÚ¡ 
	g¡¬t
 = 
¡r
.
c_¡r
();

3487 cÚ¡ * cÚ¡ 
	g’d
 = 
¡¬t
 + 
¡r
.
Ëngth
();

3489 
	g¡d
::
¡ršg
 
»suÉ
;

3490 
	g»suÉ
.
»£rve
(
¡©ic_ÿ¡
<
size_t
>(2 * (
’d
 - 
¡¬t
)));

3491 cÚ¡ * 
	gch
 = 
¡¬t
; ch !ğ
’d
; ++ch) {

3492 ià(*
	gch
 == '\0') {

3493 
»suÉ
 += "\\0";

3495 
	g»suÉ
 +ğ*
ch
;

3499  
	g»suÉ
;

3503 
	g¡d
::
¡ršg
 
Aµ’dU£rMes§ge
(cÚ¡ 
¡d
::¡ršg& 
g‹¡_msg
,

3504 cÚ¡ 
Mes§ge
& 
u£r_msg
) {

3506 cÚ¡ 
	g¡d
::
¡ršg
 
u£r_msg_¡ršg
 = 
u£r_msg
.
G‘SŒšg
();

3507 ià(
	gu£r_msg_¡ršg
.
em±y
()) {

3508  
	gg‹¡_msg
;

3511  
	gg‹¡_msg
 + "\n" + 
	gu£r_msg_¡ršg
;

3519 
	gTe¡ResuÉ
::
	$Te¡ResuÉ
()

3520 : 
	`d—th_‹¡_couÁ_
(0), 
	`¡¬t_time¡amp_
(0), 
	$–­£d_time_
(0è{
	}
}

3523 
	gTe¡ResuÉ
::~
	$Te¡ResuÉ
() {

3524 
	}
}

3529 cÚ¡ 
Te¡P¬tResuÉ
& 
Te¡ResuÉ
::
	$G‘Te¡P¬tResuÉ
(
i
) const {

3530 ià(
i
 < 0 || i >ğ
	`tÙ®_·¹_couÁ
())

3531 
š‹º®
::
posix
::
	`AbÜt
();

3532  
‹¡_·¹_»suÉs_
.
	`©
(
¡©ic_ÿ¡
<
size_t
>(
i
));

3533 
	}
}

3538 cÚ¡ 
	gTe¡Prİ”ty
& 
	gTe¡ResuÉ
::
	$G‘Te¡Prİ”ty
(
i
) const {

3539 ià(
i
 < 0 || i >ğ
	`‹¡_´İ”ty_couÁ
())

3540 
š‹º®
::
posix
::
	`AbÜt
();

3541  
‹¡_´İ”t›s_
.
	`©
(
¡©ic_ÿ¡
<
size_t
>(
i
));

3542 
	}
}

3545 
	gTe¡ResuÉ
::
	$CË¬Te¡P¬tResuÉs
() {

3546 
‹¡_·¹_»suÉs_
.
	`ş—r
();

3547 
	}
}

3550 
	gTe¡ResuÉ
::
	$AddTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
‹¡_·¹_»suÉ
) {

3551 
‹¡_·¹_»suÉs_
.
	`push_back
(
‹¡_·¹_»suÉ
);

3552 
	}
}

3557 
	gTe¡ResuÉ
::
	$RecÜdPrİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
xml_–em’t
,

3558 cÚ¡ 
Te¡Prİ”ty
& 
‹¡_´İ”ty
) {

3559 ià(!
	`V®id©eTe¡Prİ”ty
(
xml_–em’t
, 
‹¡_´İ”ty
)) {

3562 
š‹º®
::
Mu‹xLock
 
	`lock
(&
‹¡_´İ”™es_mu‹x_
);

3563 cÚ¡ 
¡d
::
veùÜ
<
Te¡Prİ”ty
>::
™”©Ü
 
´İ”ty_w™h_m©chšg_key
 =

3564 
¡d
::
	`fšd_if
(
‹¡_´İ”t›s_
.
	`begš
(),e¡_´İ”t›s_.
	`’d
(),

3565 
š‹º®
::
	`Te¡Prİ”tyKeyIs
(
‹¡_´İ”ty
.
	`key
()));

3566 ià(
´İ”ty_w™h_m©chšg_key
 =ğ
‹¡_´İ”t›s_
.
	`’d
()) {

3567 
‹¡_´İ”t›s_
.
	`push_back
(
‹¡_´İ”ty
);

3570 
´İ”ty_w™h_m©chšg_key
->
	`S‘V®ue
(
‹¡_´İ”ty
.
	`v®ue
());

3571 
	}
}

3575 cÚ¡ * cÚ¡ 
	gkRe£rvedTe¡Su™esA‰ribu‹s
[] = {

3588 cÚ¡ * cÚ¡ 
	gkRe£rvedTe¡Su™eA‰ribu‹s
[] = {

3592 cÚ¡ * cÚ¡ 
	gkRe£rvedTe¡Ca£A‰ribu‹s
[] = {

3598 cÚ¡ * cÚ¡ 
	gkRe£rvedOuutTe¡Ca£A‰ribu‹s
[] = {

3602 
	g‹m¶©e
 <
size_t
 
	gkSize
>

3603 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
A¼ayAsVeùÜ
(cÚ¡ * cÚ¡ (&
¬¿y
)[
kSize
]) {

3604  
¡d
::
veùÜ
<¡d::
¡ršg
>(
¬¿y
, 
	g¬¿y
 + 
	gkSize
);

3607 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
	$G‘Re£rvedA‰ribu‹sFÜEËm’t
(

3608 cÚ¡ 
¡d
::
¡ršg
& 
xml_–em’t
) {

3609 ià(
xml_–em’t
 == "testsuites") {

3610  
	`A¼ayAsVeùÜ
(
kRe£rvedTe¡Su™esA‰ribu‹s
);

3611 } ià(
xml_–em’t
 == "testsuite") {

3612  
	`A¼ayAsVeùÜ
(
kRe£rvedTe¡Su™eA‰ribu‹s
);

3613 } ià(
xml_–em’t
 == "testcase") {

3614  
	`A¼ayAsVeùÜ
(
kRe£rvedTe¡Ca£A‰ribu‹s
);

3616 
	`GTEST_CHECK_
(
çl£
è<< "UÄecognized xml_–em’ˆ´ovided: " << 
xml_–em’t
;

3619  
¡d
::
veùÜ
<¡d::
¡ršg
>();

3620 
	}
}

3623 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
	$G‘Re£rvedOuutA‰ribu‹sFÜEËm’t
(

3624 cÚ¡ 
¡d
::
¡ršg
& 
xml_–em’t
) {

3625 ià(
xml_–em’t
 == "testsuites") {

3626  
	`A¼ayAsVeùÜ
(
kRe£rvedTe¡Su™esA‰ribu‹s
);

3627 } ià(
xml_–em’t
 == "testsuite") {

3628  
	`A¼ayAsVeùÜ
(
kRe£rvedTe¡Su™eA‰ribu‹s
);

3629 } ià(
xml_–em’t
 == "testcase") {

3630  
	`A¼ayAsVeùÜ
(
kRe£rvedOuutTe¡Ca£A‰ribu‹s
);

3632 
	`GTEST_CHECK_
(
çl£
è<< "UÄecognized xml_–em’ˆ´ovided: " << 
xml_–em’t
;

3635  
¡d
::
veùÜ
<¡d::
¡ršg
>();

3636 
	}
}

3638 
	g¡d
::
¡ršg
 
FÜm©WÜdLi¡
(cÚ¡ 
¡d
::
veùÜ
<¡d::¡ršg>& 
wÜds
) {

3639 
Mes§ge
 
wÜd_li¡
;

3640 
size_t
 
	gi
 = 0; i < 
	gwÜds
.
size
(); ++i) {

3641 ià(
	gi
 > 0 && 
	gwÜds
.
size
() > 2) {

3642 
	gwÜd_li¡
 << ", ";

3644 ià(
	gi
 =ğ
wÜds
.
size
() - 1) {

3645 
wÜd_li¡
 << "and ";

3647 
	gwÜd_li¡
 << "'" << 
	gwÜds
[
i
] << "'";

3649  
	gwÜd_li¡
.
G‘SŒšg
();

3652 
boŞ
 
V®id©eTe¡Prİ”tyName
(

3653 cÚ¡ 
¡d
::
¡ršg
& 
´İ”ty_Çme
,

3654 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
»£rved_Çmes
) {

3655 ià(
¡d
::
fšd
(
»£rved_Çmes
.
begš
(),„e£rved_Çmes.
’d
(), 
´İ”ty_Çme
) !=

3656 
»£rved_Çmes
.
’d
()) {

3657 
ADD_FAILURE
(è<< "Re£rved key u£d iÀRecÜdPrİ”ty(): " << 
´İ”ty_Çme


3658 << " (" << 
FÜm©WÜdLi¡
(
»£rved_Çmes
)

3659 << "‡»„e£rved by " << 
GTEST_NAME_
 << ")";

3660  
	gçl£
;

3662  
	gŒue
;

3667 
boŞ
 
	gTe¡ResuÉ
::
	$V®id©eTe¡Prİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
xml_–em’t
,

3668 cÚ¡ 
Te¡Prİ”ty
& 
‹¡_´İ”ty
) {

3669  
	`V®id©eTe¡Prİ”tyName
(
‹¡_´İ”ty
.
	`key
(),

3670 
	`G‘Re£rvedA‰ribu‹sFÜEËm’t
(
xml_–em’t
));

3671 
	}
}

3674 
	gTe¡ResuÉ
::
	$CË¬
() {

3675 
‹¡_·¹_»suÉs_
.
	`ş—r
();

3676 
‹¡_´İ”t›s_
.
	`ş—r
();

3677 
d—th_‹¡_couÁ_
 = 0;

3678 
–­£d_time_
 = 0;

3679 
	}
}

3682 
boŞ
 
	$Te¡P¬tSk³d
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) {

3683  
»suÉ
.
	`sk³d
();

3684 
	}
}

3687 
boŞ
 
	gTe¡ResuÉ
::
	$Sk³d
() const {

3688  !
	`Faed
(è&& 
	`CouÁIf
(
‹¡_·¹_»suÉs_
, 
Te¡P¬tSk³d
) > 0;

3689 
	}
}

3692 
boŞ
 
	gTe¡ResuÉ
::
	$Faed
() const {

3693 
i
 = 0; i < 
	`tÙ®_·¹_couÁ
(); ++i) {

3694 ià(
	`G‘Te¡P¬tResuÉ
(
i
).
	`çed
())

3695  
Œue
;

3697  
çl£
;

3698 
	}
}

3701 
boŞ
 
	$Te¡P¬tF©®lyFaed
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) {

3702  
»suÉ
.
	`çÎy_çed
();

3703 
	}
}

3706 
boŞ
 
	gTe¡ResuÉ
::
	$HasF©®Fau»
() const {

3707  
	`CouÁIf
(
‹¡_·¹_»suÉs_
, 
Te¡P¬tF©®lyFaed
) > 0;

3708 
	}
}

3711 
boŞ
 
	$Te¡P¬tNÚçÎyFaed
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) {

3712  
»suÉ
.
	`nÚçÎy_çed
();

3713 
	}
}

3716 
boŞ
 
	gTe¡ResuÉ
::
	$HasNÚçlFau»
() const {

3717  
	`CouÁIf
(
‹¡_·¹_»suÉs_
, 
Te¡P¬tNÚçÎyFaed
) > 0;

3718 
	}
}

3722 
	gTe¡ResuÉ
::
	$tÙ®_·¹_couÁ
() const {

3723  
¡©ic_ÿ¡
<>(
‹¡_·¹_»suÉs_
.
	`size
());

3724 
	}
}

3727 
	gTe¡ResuÉ
::
	$‹¡_´İ”ty_couÁ
() const {

3728  
¡©ic_ÿ¡
<>(
‹¡_´İ”t›s_
.
	`size
());

3729 
	}
}

3736 
	gTe¡
::
	$Te¡
()

3737 : 
	$g‹¡_æag_§v”_
(
Ãw
 
GTEST_FLAG_SAVER_
) {

3738 
	}
}

3743 
Te¡
::~
	$Te¡
() {

3744 
	}
}

3749 
Te¡
::
	$S‘Up
() {

3750 
	}
}

3755 
Te¡
::
	$T—rDown
() {

3756 
	}
}

3759 
Te¡
::
	$RecÜdPrİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
key
, cÚ¡ std::¡ršg& 
v®ue
) {

3760 
Un™Te¡
::
	`G‘In¡ªû
()->
	`RecÜdPrİ”ty
(
key
, 
v®ue
);

3761 
	}
}

3764 
	gTe¡
::
	$RecÜdPrİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
key
, 
v®ue
) {

3765 
Mes§ge
 
v®ue_mes§ge
;

3766 
v®ue_mes§ge
 << 
v®ue
;

3767 
	`RecÜdPrİ”ty
(
key
, 
v®ue_mes§ge
.
	`G‘SŒšg
().
	`c_¡r
());

3768 
	}
}

3770 
Çme¥aû
 
	gš‹º®
 {

3772 
R•ÜtFau»InUnknownLoÿtiÚ
(
Te¡P¬tResuÉ
::
Ty³
 
»suÉ_ty³
,

3773 cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
) {

3776 
Un™Te¡
::
G‘In¡ªû
()->
AddTe¡P¬tResuÉ
(

3777 
»suÉ_ty³
,

3778 
nuÎ±r
,

3780 
mes§ge
,

3791 
boŞ
 
	gTe¡
::
	$HasSameFixtu»CÏss
() {

3792 
š‹º®
::
Un™Te¡Im¶
* cÚ¡ 
im¶
 = iÁ”Çl::
	`G‘Un™Te¡Im¶
();

3793 cÚ¡ 
Te¡Su™e
* cÚ¡ 
‹¡_su™e
 = 
im¶
->
	`cu¼’t_‹¡_su™e
();

3796 cÚ¡ 
Te¡Info
* cÚ¡ 
fœ¡_‹¡_šfo
 = 
‹¡_su™e
->
	`‹¡_šfo_li¡
()[0];

3797 cÚ¡ 
š‹º®
::
Ty³Id
 
fœ¡_fixtu»_id
 = 
fœ¡_‹¡_šfo
->
fixtu»_şass_id_
;

3798 cÚ¡ * cÚ¡ 
fœ¡_‹¡_Çme
 = 
fœ¡_‹¡_šfo
->
	`Çme
();

3801 cÚ¡ 
Te¡Info
* cÚ¡ 
this_‹¡_šfo
 = 
im¶
->
	`cu¼’t_‹¡_šfo
();

3802 cÚ¡ 
š‹º®
::
Ty³Id
 
this_fixtu»_id
 = 
this_‹¡_šfo
->
fixtu»_şass_id_
;

3803 cÚ¡ * cÚ¡ 
this_‹¡_Çme
 = 
this_‹¡_šfo
->
	`Çme
();

3805 ià(
this_fixtu»_id
 !ğ
fœ¡_fixtu»_id
) {

3807 cÚ¡ 
boŞ
 
fœ¡_is_TEST
 = 
fœ¡_fixtu»_id
 =ğ
š‹º®
::
	`G‘Te¡Ty³Id
();

3809 cÚ¡ 
boŞ
 
this_is_TEST
 = 
this_fixtu»_id
 =ğ
š‹º®
::
	`G‘Te¡Ty³Id
();

3811 ià(
fœ¡_is_TEST
 || 
this_is_TEST
) {

3818 cÚ¡ * cÚ¡ 
TEST_Çme
 =

3819 
fœ¡_is_TEST
 ? 
fœ¡_‹¡_Çme
 : 
this_‹¡_Çme
;

3820 cÚ¡ * cÚ¡ 
TEST_F_Çme
 =

3821 
fœ¡_is_TEST
 ? 
this_‹¡_Çme
 : 
fœ¡_‹¡_Çme
;

3823 
	`ADD_FAILURE
()

3826 << "Ëg®. IÀ‹¡ su™" << 
this_‹¡_šfo
->
	`‹¡_su™e_Çme
()

3828 << "‹¡ " << 
TEST_F_Çme
 << " is defined using TEST_F but\n"

3829 << "‹¡ " << 
TEST_Çme
 << " is defined using TEST. You…robably\n"

3835 
	`ADD_FAILURE
()

3838 << 
this_‹¡_šfo
->
	`‹¡_su™e_Çme
() << ",\n"

3839 << "you defšede¡ " << 
fœ¡_‹¡_Çme
 << "‡ndest "

3840 << 
this_‹¡_Çme
 << "\n"

3846  
çl£
;

3849  
Œue
;

3850 
	}
}

3852 #ià
GTEST_HAS_SEH


3858 
	g¡d
::
¡ršg
* 
	$FÜm©SehExû±iÚMes§ge
(
DWORD
 
exû±iÚ_code
,

3859 cÚ¡ * 
loÿtiÚ
) {

3860 
Mes§ge
 
mes§ge
;

3861 
mes§ge
 << "SEHƒxû±iÚ w™h cod0x" << 
¡d
::
	`£tba£
(16) <<

3862 
exû±iÚ_code
 << 
¡d
::
	`£tba£
(10è<< "hrowÀš " << 
loÿtiÚ
 << ".";

3864  
Ãw
 
¡d
::
	`¡ršg
(
mes§ge
.
	`G‘SŒšg
());

3865 
	}
}

3869 
Çme¥aû
 
	gš‹º®
 {

3871 #ià
GTEST_HAS_EXCEPTIONS


3874 
	g¡d
::
¡ršg
 
FÜm©CxxExû±iÚMes§ge
(cÚ¡ * 
desütiÚ
,

3875 cÚ¡ * 
loÿtiÚ
) {

3876 
Mes§ge
 
	gmes§ge
;

3877 ià(
	gdesütiÚ
 !ğ
nuÎ±r
) {

3878 
mes§ge
 << "C++ƒxû±iÚ w™h desütiÚ \"" << 
desütiÚ
 << "\"";

3880 
	gmes§ge
 << "Unknown C++ƒxception";

3882 
	gmes§ge
 << "hrowÀš " << 
	gloÿtiÚ
 << ".";

3884  
	gmes§ge
.
G‘SŒšg
();

3887 
	g¡d
::
¡ršg
 
PrštTe¡P¬tResuÉToSŒšg
(

3888 cÚ¡ 
Te¡P¬tResuÉ
& 
‹¡_·¹_»suÉ
);

3890 
	gGoogËTe¡Fau»Exû±iÚ
::
GoogËTe¡Fau»Exû±iÚ
(

3891 cÚ¡ 
Te¡P¬tResuÉ
& 
çu»
)

3892 : ::
¡d
::
ruÁime_”rÜ
(
PrštTe¡P¬tResuÉToSŒšg
(
çu»
).
c_¡r
()) {}

3904 
‹m¶©e
 <
şass
 
T
, 
ty³Çme
 
	gResuÉ
>

3905 
ResuÉ
 
HªdËSehExû±iÚsInM‘hodIfSuµÜ‹d
(

3906 
T
* 
objeù
, 
ResuÉ
 (T::*
m‘hod
)(), cÚ¡ * 
loÿtiÚ
) {

3907 #ià
GTEST_HAS_SEH


3908 
	g__Œy
 {

3909  (
	gobjeù
->*
	gm‘hod
)();

3910 } 
__exû±
 (
š‹º®
::
Un™Te¡O±iÚs
::
GTe¡ShouldProûssSEH
(

3911 
G‘Exû±iÚCode
())) {

3915 
¡d
::
¡ršg
* 
exû±iÚ_mes§ge
 = 
FÜm©SehExû±iÚMes§ge
(

3916 
G‘Exû±iÚCode
(), 
loÿtiÚ
);

3917 
	gš‹º®
::
R•ÜtFau»InUnknownLoÿtiÚ
(
Te¡P¬tResuÉ
::
kF©®Fau»
,

3918 *
exû±iÚ_mes§ge
);

3919 
d–‘e
 
	gexû±iÚ_mes§ge
;

3920  
	g¡©ic_ÿ¡
<
	gResuÉ
>(0);

3923 ()
	gloÿtiÚ
;

3924  (
	gobjeù
->*
	gm‘hod
)();

3931 
	g‹m¶©e
 <
şass
 
	gT
, 
ty³Çme
 
	gResuÉ
>

3932 
ResuÉ
 
HªdËExû±iÚsInM‘hodIfSuµÜ‹d
(

3933 
T
* 
objeù
, 
ResuÉ
 (T::*
m‘hod
)(), cÚ¡ * 
loÿtiÚ
) {

3957 ià(
	gš‹º®
::
G‘Un™Te¡Im¶
()->
ÿtch_exû±iÚs
()) {

3958 #ià
GTEST_HAS_EXCEPTIONS


3959 
Œy
 {

3960  
HªdËSehExû±iÚsInM‘hodIfSuµÜ‹d
(
objeù
, 
m‘hod
, 
loÿtiÚ
);

3961 } 
ÿtch
 (cÚ¡ 
As£¹iÚExû±iÚ
&) {

3963 } 
ÿtch
 (cÚ¡ 
š‹º®
::
GoogËTe¡Fau»Exû±iÚ
&) {

3967 
throw
;

3968 } 
ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

3969 
š‹º®
::
R•ÜtFau»InUnknownLoÿtiÚ
(

3970 
Te¡P¬tResuÉ
::
kF©®Fau»
,

3971 
FÜm©CxxExû±iÚMes§ge
(
e
.
wh©
(), 
loÿtiÚ
));

3972 } 
ÿtch
 (...) {

3973 
	gš‹º®
::
R•ÜtFau»InUnknownLoÿtiÚ
(

3974 
Te¡P¬tResuÉ
::
kF©®Fau»
,

3975 
FÜm©CxxExû±iÚMes§ge
(
nuÎ±r
, 
loÿtiÚ
));

3977  
	g¡©ic_ÿ¡
<
	gResuÉ
>(0);

3979  
HªdËSehExû±iÚsInM‘hodIfSuµÜ‹d
(
objeù
, 
m‘hod
, 
loÿtiÚ
);

3982  (
	gobjeù
->*
	gm‘hod
)();

3989 
	gTe¡
::
	$Run
() {

3990 ià(!
	`HasSameFixtu»CÏss
()) ;

3992 
š‹º®
::
Un™Te¡Im¶
* cÚ¡ 
im¶
 = iÁ”Çl::
	`G‘Un™Te¡Im¶
();

3993 
im¶
->
	`os_¡ack_Œaû_g‘‹r
()->
	`UpÚL—všgGTe¡
();

3994 
š‹º®
::
	`HªdËExû±iÚsInM‘hodIfSuµÜ‹d
(
this
, &
Te¡
::
S‘Up
, "SetUp()");

3997 ià(!
	`HasF©®Fau»
(è&& !
	`IsSk³d
()) {

3998 
im¶
->
	`os_¡ack_Œaû_g‘‹r
()->
	`UpÚL—všgGTe¡
();

3999 
š‹º®
::
	`HªdËExû±iÚsInM‘hodIfSuµÜ‹d
(

4000 
this
, &
Te¡
::
Te¡Body
, "theest body");

4006 
im¶
->
	`os_¡ack_Œaû_g‘‹r
()->
	`UpÚL—všgGTe¡
();

4007 
š‹º®
::
	`HªdËExû±iÚsInM‘hodIfSuµÜ‹d
(

4008 
this
, &
Te¡
::
T—rDown
, "TearDown()");

4009 
	}
}

4012 
boŞ
 
	gTe¡
::
	$HasF©®Fau»
() {

4013  
š‹º®
::
	`G‘Un™Te¡Im¶
()->
	`cu¼’t_‹¡_»suÉ
()->
	`HasF©®Fau»
();

4014 
	}
}

4017 
boŞ
 
	gTe¡
::
	$HasNÚçlFau»
() {

4018  
š‹º®
::
	`G‘Un™Te¡Im¶
()->
	`cu¼’t_‹¡_»suÉ
()->

4019 
	`HasNÚçlFau»
();

4020 
	}
}

4023 
boŞ
 
	gTe¡
::
	$IsSk³d
() {

4024  
š‹º®
::
	`G‘Un™Te¡Im¶
()->
	`cu¼’t_‹¡_»suÉ
()->
	`Sk³d
();

4025 
	}
}

4031 
	gTe¡Info
::
	$Te¡Info
(cÚ¡ 
¡d
::
¡ršg
& 
a_‹¡_su™e_Çme
,

4032 cÚ¡ 
¡d
::
¡ršg
& 
a_Çme
, cÚ¡ * 
a_ty³_·¿m
,

4033 cÚ¡ * 
a_v®ue_·¿m
,

4034 
š‹º®
::
CodeLoÿtiÚ
 
a_code_loÿtiÚ
,

4035 
š‹º®
::
Ty³Id
 
fixtu»_şass_id
,

4036 
š‹º®
::
Te¡FaùÜyBa£
* 
çùÜy
)

4037 : 
	`‹¡_su™e_Çme_
(
a_‹¡_su™e_Çme
),

4038 
	`Çme_
(
a_Çme
),

4039 
	`ty³_·¿m_
(
a_ty³_·¿m
 ? 
Ãw
 
¡d
::
	$¡ršg
(
a_ty³_·¿m
è: 
nuÎ±r
),

4040 
	`v®ue_·¿m_
(
a_v®ue_·¿m
 ? 
Ãw
 
¡d
::
	$¡ršg
(
a_v®ue_·¿m
è: 
nuÎ±r
),

4041 
	`loÿtiÚ_
(
a_code_loÿtiÚ
),

4042 
	`fixtu»_şass_id_
(
fixtu»_şass_id
),

4043 
	`should_run_
(
çl£
),

4044 
	`is_di§bËd_
(
çl£
),

4045 
	`m©ches_f‹r_
(
çl£
),

4046 
	`çùÜy_
(
çùÜy
),

4047 
	$»suÉ_
(è{
	}
}

4050 
	gTe¡Info
::~
	$Te¡Info
(è{ 
d–‘e
 
çùÜy_
; 
	}
}

4052 
Çme¥aû
 
	gš‹º®
 {

4072 
Te¡Info
* 
MakeAndRegi¡”Te¡Info
(

4073 cÚ¡ * 
‹¡_su™e_Çme
, cÚ¡ * 
Çme
, cÚ¡ * 
ty³_·¿m
,

4074 cÚ¡ * 
v®ue_·¿m
, 
CodeLoÿtiÚ
 
code_loÿtiÚ
,

4075 
Ty³Id
 
fixtu»_şass_id
, 
S‘UpTe¡Su™eFunc
 
£t_up_tc
,

4076 
T—rDownTe¡Su™eFunc
 
‹¬_down_tc
, 
Te¡FaùÜyBa£
* 
çùÜy
) {

4077 
Te¡Info
* cÚ¡ 
	g‹¡_šfo
 =

4078 
Ãw
 
Te¡Info
(
‹¡_su™e_Çme
, 
Çme
, 
ty³_·¿m
, 
v®ue_·¿m
,

4079 
code_loÿtiÚ
, 
fixtu»_şass_id
, 
çùÜy
);

4080 
G‘Un™Te¡Im¶
()->
AddTe¡Info
(
£t_up_tc
, 
‹¬_down_tc
, 
‹¡_šfo
);

4081  
	g‹¡_šfo
;

4084 
R•ÜtInv®idTe¡Su™eTy³
(cÚ¡ * 
‹¡_su™e_Çme
,

4085 
CodeLoÿtiÚ
 
code_loÿtiÚ
) {

4086 
Mes§ge
 
	g”rÜs
;

4087 
	g”rÜs


4088 << "A‰em±ed„edefš™iÚ oà‹¡ su™" << 
	g‹¡_su™e_Çme
 << ".\n"

4090 << "şass. Howev”, iÀ‹¡ su™" << 
	g‹¡_su™e_Çme
 << ", youried\n"

4097 
GTEST_LOG_
(
ERROR
è<< 
FÜm©FeLoÿtiÚ
(
code_loÿtiÚ
.
fe
.
c_¡r
(),

4098 
code_loÿtiÚ
.
lše
)

4099 << " " << 
	g”rÜs
.
G‘SŒšg
();

4103 
	gÇme¥aû
 {

4113 şas 
	cTe¡NameIs
 {

4114 
	gpublic
:

4118 
ex¶ic™
 
Te¡NameIs
(cÚ¡ * 
Çme
)

4119 : 
Çme_
(
Çme
) {}

4122 
boŞ
 
İ”©Ü
()(cÚ¡ 
Te¡Info
 * 
‹¡_šfo
) const {

4123  
‹¡_šfo
 &&e¡_šfo->
Çme
(è=ğ
Çme_
;

4126 
	g´iv©e
:

4127 
¡d
::
¡ršg
 
Çme_
;

4132 
Çme¥aû
 
	gš‹º®
 {

4137 
	gUn™Te¡Im¶
::
Regi¡”P¬am‘”izedTe¡s
() {

4138 ià(!
·¿m‘”ized_‹¡s_»gi¡”ed_
) {

4139 
·¿m‘”ized_‹¡_»gi¡ry_
.
Regi¡”Te¡s
();

4140 
	g·¿m‘”ized_‹¡s_»gi¡”ed_
 = 
Œue
;

4148 
	gTe¡Info
::
	$Run
() {

4149 ià(!
should_run_
) ;

4152 
š‹º®
::
Un™Te¡Im¶
* cÚ¡ 
im¶
 = iÁ”Çl::
	`G‘Un™Te¡Im¶
();

4153 
im¶
->
	`£t_cu¼’t_‹¡_šfo
(
this
);

4155 
Te¡Ev’tLi¡’”
* 
»³©”
 = 
Un™Te¡
::
	`G‘In¡ªû
()->
	`li¡’”s
().
	`»³©”
();

4158 
»³©”
->
	`OnTe¡S¹
(*
this
);

4160 cÚ¡ 
TimeInMlis
 
¡¬t
 = 
š‹º®
::
	`G‘TimeInMlis
();

4162 
im¶
->
	`os_¡ack_Œaû_g‘‹r
()->
	`UpÚL—všgGTe¡
();

4165 
Te¡
* cÚ¡ 
‹¡
 = 
š‹º®
::
	`HªdËExû±iÚsInM‘hodIfSuµÜ‹d
(

4166 
çùÜy_
, &
š‹º®
::
Te¡FaùÜyBa£
::
C»©eTe¡
,

4172 ià(!
Te¡
::
	`HasF©®Fau»
(è&& !Te¡::
	`IsSk³d
()) {

4175 
‹¡
->
	`Run
();

4178 ià(
‹¡
 !ğ
nuÎ±r
) {

4180 
im¶
->
	`os_¡ack_Œaû_g‘‹r
()->
	`UpÚL—všgGTe¡
();

4181 
š‹º®
::
	`HªdËExû±iÚsInM‘hodIfSuµÜ‹d
(

4182 
‹¡
, &
Te¡
::
D–‘eS–f_
, "theest fixture's destructor");

4185 
»suÉ_
.
	`£t_¡¬t_time¡amp
(
¡¬t
);

4186 
»suÉ_
.
	`£t_–­£d_time
(
š‹º®
::
	`G‘TimeInMlis
(è- 
¡¬t
);

4189 
»³©”
->
	`OnTe¡End
(*
this
);

4193 
im¶
->
	`£t_cu¼’t_‹¡_šfo
(
nuÎ±r
);

4194 
	}
}

4199 
	gTe¡Su™e
::
	$sucûssful_‹¡_couÁ
() const {

4200  
	`CouÁIf
(
‹¡_šfo_li¡_
, 
Te¡Pas£d
);

4201 
	}
}

4204 
	gTe¡Su™e
::
	$sk³d_‹¡_couÁ
() const {

4205  
	`CouÁIf
(
‹¡_šfo_li¡_
, 
Te¡Sk³d
);

4206 
	}
}

4209 
	gTe¡Su™e
::
	$çed_‹¡_couÁ
() const {

4210  
	`CouÁIf
(
‹¡_šfo_li¡_
, 
Te¡Faed
);

4211 
	}
}

4214 
	gTe¡Su™e
::
	$»pÜbË_di§bËd_‹¡_couÁ
() const {

4215  
	`CouÁIf
(
‹¡_šfo_li¡_
, 
Te¡R•ÜbËDi§bËd
);

4216 
	}
}

4219 
	gTe¡Su™e
::
	$di§bËd_‹¡_couÁ
() const {

4220  
	`CouÁIf
(
‹¡_šfo_li¡_
, 
Te¡Di§bËd
);

4221 
	}
}

4224 
	gTe¡Su™e
::
	$»pÜbË_‹¡_couÁ
() const {

4225  
	`CouÁIf
(
‹¡_šfo_li¡_
, 
Te¡R•ÜbË
);

4226 
	}
}

4229 
	gTe¡Su™e
::
	$‹¡_to_run_couÁ
() const {

4230  
	`CouÁIf
(
‹¡_šfo_li¡_
, 
ShouldRunTe¡
);

4231 
	}
}

4234 
	gTe¡Su™e
::
	$tÙ®_‹¡_couÁ
() const {

4235  
¡©ic_ÿ¡
<>(
‹¡_šfo_li¡_
.
	`size
());

4236 
	}
}

4247 
	gTe¡Su™e
::
	$Te¡Su™e
(cÚ¡ * 
a_Çme
, cÚ¡ * 
a_ty³_·¿m
,

4248 
š‹º®
::
S‘UpTe¡Su™eFunc
 
£t_up_tc
,

4249 
š‹º®
::
T—rDownTe¡Su™eFunc
 
‹¬_down_tc
)

4250 : 
	`Çme_
(
a_Çme
),

4251 
	`ty³_·¿m_
(
a_ty³_·¿m
 ? 
Ãw
 
¡d
::
	$¡ršg
(
a_ty³_·¿m
è: 
nuÎ±r
),

4252 
	`£t_up_tc_
(
£t_up_tc
),

4253 
	`‹¬_down_tc_
(
‹¬_down_tc
),

4254 
	`should_run_
(
çl£
),

4255 
	`¡¬t_time¡amp_
(0),

4256 
	$–­£d_time_
(0è{
	}
}

4259 
	gTe¡Su™e
::~
	$Te¡Su™e
() {

4261 
	`FÜEach
(
‹¡_šfo_li¡_
, 
š‹º®
::
D–‘e
<
Te¡Info
>);

4262 
	}
}

4266 cÚ¡ 
Te¡Info
* 
	gTe¡Su™e
::
	$G‘Te¡Info
(
i
) const {

4267 cÚ¡ 
šdex
 = 
	`G‘EËm’tOr
(
‹¡_šdiûs_
, 
i
, -1);

4268  
šdex
 < 0 ? 
nuÎ±r
 : 
‹¡_šfo_li¡_
[
¡©ic_ÿ¡
<
size_t
>(index)];

4269 
	}
}

4273 
Te¡Info
* 
	gTe¡Su™e
::
	$G‘MubËTe¡Info
(
i
) {

4274 cÚ¡ 
šdex
 = 
	`G‘EËm’tOr
(
‹¡_šdiûs_
, 
i
, -1);

4275  
šdex
 < 0 ? 
nuÎ±r
 : 
‹¡_šfo_li¡_
[
¡©ic_ÿ¡
<
size_t
>(index)];

4276 
	}
}

4280 
	gTe¡Su™e
::
	$AddTe¡Info
(
Te¡Info
* 
‹¡_šfo
) {

4281 
‹¡_šfo_li¡_
.
	`push_back
(
‹¡_šfo
);

4282 
‹¡_šdiûs_
.
	`push_back
(
¡©ic_ÿ¡
<>Ñe¡_šdiûs_.
	`size
()));

4283 
	}
}

4286 
	gTe¡Su™e
::
	$Run
() {

4287 ià(!
should_run_
) ;

4289 
š‹º®
::
Un™Te¡Im¶
* cÚ¡ 
im¶
 = iÁ”Çl::
	`G‘Un™Te¡Im¶
();

4290 
im¶
->
	`£t_cu¼’t_‹¡_su™e
(
this
);

4292 
Te¡Ev’tLi¡’”
* 
»³©”
 = 
Un™Te¡
::
	`G‘In¡ªû
()->
	`li¡’”s
().
	`»³©”
();

4295 
»³©”
->
	`OnTe¡Su™eS¹
(*
this
);

4297 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI


4298 
»³©”
->
	`OnTe¡Ca£S¹
(*
this
);

4301 
im¶
->
	`os_¡ack_Œaû_g‘‹r
()->
	`UpÚL—všgGTe¡
();

4302 
š‹º®
::
	`HªdËExû±iÚsInM‘hodIfSuµÜ‹d
(

4303 
this
, &
Te¡Su™e
::
RunS‘UpTe¡Su™e
, "SetUpTestSuite()");

4305 
¡¬t_time¡amp_
 = 
š‹º®
::
	`G‘TimeInMlis
();

4306 
i
 = 0; i < 
	`tÙ®_‹¡_couÁ
(); i++) {

4307 
	`G‘MubËTe¡Info
(
i
)->
	`Run
();

4309 
–­£d_time_
 = 
š‹º®
::
	`G‘TimeInMlis
(è- 
¡¬t_time¡amp_
;

4311 
im¶
->
	`os_¡ack_Œaû_g‘‹r
()->
	`UpÚL—všgGTe¡
();

4312 
š‹º®
::
	`HªdËExû±iÚsInM‘hodIfSuµÜ‹d
(

4313 
this
, &
Te¡Su™e
::
RunT—rDownTe¡Su™e
, "TearDownTestSuite()");

4316 
»³©”
->
	`OnTe¡Su™eEnd
(*
this
);

4318 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI


4319 
»³©”
->
	`OnTe¡Ca£End
(*
this
);

4322 
im¶
->
	`£t_cu¼’t_‹¡_su™e
(
nuÎ±r
);

4323 
	}
}

4326 
	gTe¡Su™e
::
	$CË¬ResuÉ
() {

4327 
ad_hoc_‹¡_»suÉ_
.
	`CË¬
();

4328 
	`FÜEach
(
‹¡_šfo_li¡_
, 
Te¡Info
::
CË¬Te¡ResuÉ
);

4329 
	}
}

4332 
	gTe¡Su™e
::
	$ShufæeTe¡s
(
š‹º®
::
Rªdom
* 
¿ndom
) {

4333 
	`Shufæe
(
¿ndom
, &
‹¡_šdiûs_
);

4334 
	}
}

4337 
	gTe¡Su™e
::
	$UnshufæeTe¡s
() {

4338 
size_t
 
i
 = 0; i < 
‹¡_šdiûs_
.
	`size
(); i++) {

4339 
‹¡_šdiûs_
[
i
] = 
¡©ic_ÿ¡
<>(i);

4341 
	}
}

4348 
	g¡d
::
¡ršg
 
	$FÜm©CouÁabËNoun
(
couÁ
,

4349 cÚ¡ * 
sšguÏr_fÜm
,

4350 cÚ¡ * 
¶u¿l_fÜm
) {

4351  
š‹º®
::
	`SŒ—mabËToSŒšg
(
couÁ
) + " " +

4352 (
couÁ
 =ğ1 ? 
sšguÏr_fÜm
 : 
¶u¿l_fÜm
);

4353 
	}
}

4356 
	g¡d
::
¡ršg
 
	$FÜm©Te¡CouÁ
(
‹¡_couÁ
) {

4357  
	`FÜm©CouÁabËNoun
(
‹¡_couÁ
, "test", "tests");

4358 
	}
}

4361 
	g¡d
::
¡ršg
 
	$FÜm©Te¡Su™eCouÁ
(
‹¡_su™e_couÁ
) {

4362  
	`FÜm©CouÁabËNoun
(
‹¡_su™e_couÁ
, "test suite", "test suites");

4363 
	}
}

4369 cÚ¡ * 
	$Te¡P¬tResuÉTy³ToSŒšg
(
Te¡P¬tResuÉ
::
Ty³
 
ty³
) {

4370 
ty³
) {

4371 
Te¡P¬tResuÉ
::
kSk
:

4373 
Te¡P¬tResuÉ
::
kSucûss
:

4376 
Te¡P¬tResuÉ
::
kNÚF©®Fau»
:

4377 
Te¡P¬tResuÉ
::
kF©®Fau»
:

4378 #ifdeà
_MSC_VER


4386 
	}
}

4388 
Çme¥aû
 
	gš‹º®
 {

4391 
	g¡d
::
¡ršg
 
PrštTe¡P¬tResuÉToSŒšg
(

4392 cÚ¡ 
Te¡P¬tResuÉ
& 
‹¡_·¹_»suÉ
) {

4393  (
Mes§ge
()

4394 << 
š‹º®
::
FÜm©FeLoÿtiÚ
(
‹¡_·¹_»suÉ
.
fe_Çme
(),

4395 
‹¡_·¹_»suÉ
.
lše_numb”
())

4396 << " " << 
Te¡P¬tResuÉTy³ToSŒšg
(
‹¡_·¹_»suÉ
.
ty³
())

4397 << 
	g‹¡_·¹_»suÉ
.
mes§ge
()).
G‘SŒšg
();

4401 
PrštTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
‹¡_·¹_»suÉ
) {

4402 cÚ¡ 
	g¡d
::
¡ršg
& 
»suÉ
 =

4403 
PrštTe¡P¬tResuÉToSŒšg
(
‹¡_·¹_»suÉ
);

4404 
´štf
("%s\n", 
»suÉ
.
c_¡r
());

4405 
fæush
(
¡dout
);

4410 #ià
GTEST_OS_WINDOWS
 && !
GTEST_OS_WINDOWS_MOBILE


4414 ::
OuutDebugSŒšgA
(
»suÉ
.
c_¡r
());

4415 ::
OuutDebugSŒšgA
("\n");

4420 #ià
GTEST_OS_WINDOWS
 && !
GTEST_OS_WINDOWS_MOBILE
 && \

4421 !
	gGTEST_OS_WINDOWS_PHONE
 && !
	gGTEST_OS_WINDOWS_RT
 && !
GTEST_OS_WINDOWS_MINGW


4424 
WORD
 
G‘CŞÜA‰ribu‹
(
GTe¡CŞÜ
 
cŞÜ
) {

4425 
	gcŞÜ
) {

4426 
	gCOLOR_RED
:  
FOREGROUND_RED
;

4427 
	gCOLOR_GREEN
:  
FOREGROUND_GREEN
;

4428 
	gCOLOR_YELLOW
:  
FOREGROUND_RED
 | 
FOREGROUND_GREEN
;

4433 
G‘B™Off£t
(
WORD
 
cŞÜ_mask
) {

4434 ià(
	gcŞÜ_mask
 == 0)  0;

4436 
	gb™Off£t
 = 0;

4437 (
	gcŞÜ_mask
 & 1) == 0) {

4438 
cŞÜ_mask
 >>= 1;

4439 ++
	gb™Off£t
;

4441  
	gb™Off£t
;

4444 
WORD
 
G‘NewCŞÜ
(
GTe¡CŞÜ
 
cŞÜ
, WORD 
Şd_cŞÜ_©Œs
) {

4446 cÚ¡ 
WORD
 
	gbackground_mask
 = 
BACKGROUND_BLUE
 | 
BACKGROUND_GREEN
 |

4447 
BACKGROUND_RED
 | 
BACKGROUND_INTENSITY
;

4448 cÚ¡ 
WORD
 
	gfÜeground_mask
 = 
FOREGROUND_BLUE
 | 
FOREGROUND_GREEN
 |

4449 
FOREGROUND_RED
 | 
FOREGROUND_INTENSITY
;

4450 cÚ¡ 
WORD
 
	gexi¡šg_bg
 = 
Şd_cŞÜ_©Œs
 & 
background_mask
;

4452 
WORD
 
	gÃw_cŞÜ
 =

4453 
G‘CŞÜA‰ribu‹
(
cŞÜ
è| 
exi¡šg_bg
 | 
FOREGROUND_INTENSITY
;

4454 cÚ¡ 
	gbg_b™Off£t
 = 
G‘B™Off£t
(
background_mask
);

4455 cÚ¡ 
	gfg_b™Off£t
 = 
G‘B™Off£t
(
fÜeground_mask
);

4457 ià(((
	gÃw_cŞÜ
 & 
	gbackground_mask
è>> 
	gbg_b™Off£t
) ==

4458 ((
Ãw_cŞÜ
 & 
fÜeground_mask
è>> 
fg_b™Off£t
)) {

4459 
Ãw_cŞÜ
 ^ğ
FOREGROUND_INTENSITY
;

4461  
	gÃw_cŞÜ
;

4468 cÚ¡ * 
G‘AnsiCŞÜCode
(
GTe¡CŞÜ
 
cŞÜ
) {

4469 
	gcŞÜ
) {

4470 
	gCOLOR_RED
:  "1";

4471 
	gCOLOR_GREEN
:  "2";

4472 
	gCOLOR_YELLOW
:  "3";

4474  
nuÎ±r
;

4481 
boŞ
 
ShouldU£CŞÜ
(boŞ 
¡dout_is_‰y
) {

4482 cÚ¡ * cÚ¡ 
	gg‹¡_cŞÜ
 = 
GTEST_FLAG
(
cŞÜ
).
c_¡r
();

4484 ià(
	gSŒšg
::
Ca£In£ns™iveCSŒšgEqu®s
(
g‹¡_cŞÜ
, "auto")) {

4485 #ià
GTEST_OS_WINDOWS
 && !
GTEST_OS_WINDOWS_MINGW


4488  
	g¡dout_is_‰y
;

4491 cÚ¡ * cÚ¡ 
	g‹rm
 = 
posix
::
G‘Env
("TERM");

4492 cÚ¡ 
boŞ
 
	g‹rm_suµÜts_cŞÜ
 =

4493 
SŒšg
::
CSŒšgEqu®s
(
‹rm
, "xterm") ||

4494 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "xterm-color") ||

4495 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "xterm-256color") ||

4496 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "screen") ||

4497 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "screen-256color") ||

4498 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "tmux") ||

4499 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "tmux-256color") ||

4500 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "rxvt-unicode") ||

4501 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "rxvt-unicode-256color") ||

4502 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "linux") ||

4503 
	gSŒšg
::
CSŒšgEqu®s
(
‹rm
, "cygwin");

4504  
	g¡dout_is_‰y
 && 
	g‹rm_suµÜts_cŞÜ
;

4508  
	gSŒšg
::
Ca£In£ns™iveCSŒšgEqu®s
(
g‹¡_cŞÜ
, "yes") ||

4509 
	gSŒšg
::
Ca£In£ns™iveCSŒšgEqu®s
(
g‹¡_cŞÜ
, "true") ||

4510 
	gSŒšg
::
Ca£In£ns™iveCSŒšgEqu®s
(
g‹¡_cŞÜ
, "t") ||

4511 
	gSŒšg
::
CSŒšgEqu®s
(
g‹¡_cŞÜ
, "1");

4521 
CŞÜedPrštf
(
GTe¡CŞÜ
 
cŞÜ
, cÚ¡ * 
fmt
, ...) {

4522 
va_li¡
 
	g¬gs
;

4523 
va_¡¬t
(
¬gs
, 
fmt
);

4525 #ià
GTEST_OS_WINDOWS_MOBILE
 || 
GTEST_OS_ZOS
 || 
GTEST_OS_IOS
 || \

4526 
	gGTEST_OS_WINDOWS_PHONE
 || 
	gGTEST_OS_WINDOWS_RT
 || 
defšed
(
ESP_PLATFORM
)

4527 cÚ¡ 
boŞ
 
	gu£_cŞÜ
 = 
AlwaysF®£
();

4529 cÚ¡ 
boŞ
 
	gš_cŞÜ_mode
 =

4530 
ShouldU£CŞÜ
(
posix
::
IsATTY
Õosix::
FeNo
(
¡dout
)) != 0);

4531 cÚ¡ 
boŞ
 
	gu£_cŞÜ
 = 
š_cŞÜ_mode
 && (
cŞÜ
 !ğ
COLOR_DEFAULT
);

4534 ià(!
	gu£_cŞÜ
) {

4535 
v´štf
(
fmt
, 
¬gs
);

4536 
va_’d
(
¬gs
);

4540 #ià
GTEST_OS_WINDOWS
 && !
GTEST_OS_WINDOWS_MOBILE
 && \

4541 !
	gGTEST_OS_WINDOWS_PHONE
 && !
	gGTEST_OS_WINDOWS_RT
 && !
GTEST_OS_WINDOWS_MINGW


4542 cÚ¡ 
HANDLE
 
	g¡dout_hªdË
 = 
G‘StdHªdË
(
STD_OUTPUT_HANDLE
);

4545 
CONSOLE_SCREEN_BUFFER_INFO
 
	gbufãr_šfo
;

4546 
G‘CÚsŞeSü“nBufãrInfo
(
¡dout_hªdË
, &
bufãr_šfo
);

4547 cÚ¡ 
WORD
 
	gŞd_cŞÜ_©Œs
 = 
bufãr_šfo
.
wA‰ribu‹s
;

4548 cÚ¡ 
WORD
 
	gÃw_cŞÜ
 = 
G‘NewCŞÜ
(
cŞÜ
, 
Şd_cŞÜ_©Œs
);

4553 
fæush
(
¡dout
);

4554 
S‘CÚsŞeTextA‰ribu‹
(
¡dout_hªdË
, 
Ãw_cŞÜ
);

4556 
v´štf
(
fmt
, 
¬gs
);

4558 
fæush
(
¡dout
);

4560 
S‘CÚsŞeTextA‰ribu‹
(
¡dout_hªdË
, 
Şd_cŞÜ_©Œs
);

4562 
´štf
("\033[0;3%sm", 
G‘AnsiCŞÜCode
(
cŞÜ
));

4563 
v´štf
(
fmt
, 
¬gs
);

4564 
´štf
("\033[m");

4566 
va_’d
(
¬gs
);

4571 cÚ¡ 
	gkTy³P¬amLab–
[] = "TypeParam";

4572 cÚ¡ 
	gkV®ueP¬amLab–
[] = "GetParam()";

4574 
PrštFuÎTe¡Comm’tIfP»£Á
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
) {

4575 cÚ¡ * cÚ¡ 
	gty³_·¿m
 = 
‹¡_šfo
.
ty³_·¿m
();

4576 cÚ¡ * cÚ¡ 
	gv®ue_·¿m
 = 
‹¡_šfo
.
v®ue_·¿m
();

4578 ià(
	gty³_·¿m
 !ğ
nuÎ±r
 || 
v®ue_·¿m
 !=‚ullptr) {

4579 
´štf
(", where ");

4580 ià(
	gty³_·¿m
 !ğ
nuÎ±r
) {

4581 
´štf
("% ğ%s", 
kTy³P¬amLab–
, 
ty³_·¿m
);

4582 ià(
	gv®ue_·¿m
 !ğ
nuÎ±r
è
´štf
("‡nd ");

4584 ià(
	gv®ue_·¿m
 !ğ
nuÎ±r
) {

4585 
´štf
("% ğ%s", 
kV®ueP¬amLab–
, 
v®ue_·¿m
);

4593 şas 
	cP»‰yUn™Te¡ResuÉPrš‹r
 : 
public
 
Te¡Ev’tLi¡’”
 {

4594 
public
:

4595 
P»‰yUn™Te¡ResuÉPrš‹r
() {}

4596 
PrštTe¡Name
(cÚ¡ * 
‹¡_su™e
, cÚ¡ * 
‹¡
) {

4597 
´štf
("%s.%s", 
‹¡_su™e
, 
‹¡
);

4601 
OnTe¡Prog¿mS¹
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {}

4602 
OnTe¡I‹¿tiÚS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
, 
™”©iÚ
è
	gov”ride
;

4603 
OnEnvœÚm’tsS‘UpS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
è
	gov”ride
;

4604 
OnEnvœÚm’tsS‘UpEnd
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {}

4605 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


4606 
OnTe¡Ca£S¹
(cÚ¡ 
Te¡Ca£
& 
‹¡_ÿ£
è
	gov”ride
;

4608 
OnTe¡Su™eS¹
(cÚ¡ 
Te¡Su™e
& 
‹¡_su™e
è
	gov”ride
;

4611 
OnTe¡S¹
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
è
	gov”ride
;

4613 
OnTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
è
	gov”ride
;

4614 
OnTe¡End
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
è
	gov”ride
;

4615 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


4616 
OnTe¡Ca£End
(cÚ¡ 
Te¡Ca£
& 
‹¡_ÿ£
è
	gov”ride
;

4618 
OnTe¡Su™eEnd
(cÚ¡ 
Te¡Su™e
& 
‹¡_su™e
è
	gov”ride
;

4621 
OnEnvœÚm’tsT—rDownS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
è
	gov”ride
;

4622 
OnEnvœÚm’tsT—rDownEnd
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {}

4623 
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
, 
™”©iÚ
è
	gov”ride
;

4624 
OnTe¡Prog¿mEnd
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {}

4626 
	g´iv©e
:

4627 
PrštFaedTe¡s
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
);

4628 
PrštSk³dTe¡s
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
);

4632 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnTe¡I‹¿tiÚS¹
(

4633 cÚ¡ 
Un™Te¡
& 
un™_‹¡
, 
™”©iÚ
) {

4634 ià(
GTEST_FLAG
(
»³©
) != 1)

4635 
´štf
("\nR•—tšg‡Îe¡ (™”©iÚ %dè. . .\n\n", 
™”©iÚ
 + 1);

4637 cÚ¡ * cÚ¡ 
	gf‹r
 = 
GTEST_FLAG
(
f‹r
).
c_¡r
();

4641 ià(!
	gSŒšg
::
CSŒšgEqu®s
(
f‹r
, 
kUniv”§lF‹r
)) {

4642 
CŞÜedPrštf
(
COLOR_YELLOW
,

4643 "NÙe: % f‹¸ğ%s\n", 
GTEST_NAME_
, 
f‹r
);

4646 ià(
	gš‹º®
::
ShouldSh¬d
(
kTe¡TÙ®Sh¬ds
, 
kTe¡Sh¬dIndex
, 
çl£
)) {

4647 cÚ¡ 
IÁ32
 
	gsh¬d_šdex
 = 
IÁ32FromEnvOrD›
(
kTe¡Sh¬dIndex
, -1);

4648 
CŞÜedPrštf
(
COLOR_YELLOW
,

4650 
¡©ic_ÿ¡
<>(
sh¬d_šdex
) + 1,

4651 
š‹º®
::
posix
::
G‘Env
(
kTe¡TÙ®Sh¬ds
));

4654 ià(
GTEST_FLAG
(
shufæe
)) {

4655 
CŞÜedPrštf
(
COLOR_YELLOW
,

4657 
un™_‹¡
.
¿ndom_£ed
());

4660 
CŞÜedPrštf
(
COLOR_GREEN
, "[==========] ");

4661 
´štf
("Running %s from %s.\n",

4662 
FÜm©Te¡CouÁ
(
un™_‹¡
.
‹¡_to_run_couÁ
()).
c_¡r
(),

4663 
FÜm©Te¡Su™eCouÁ
(
un™_‹¡
.
‹¡_su™e_to_run_couÁ
()).
c_¡r
());

4664 
fæush
(
¡dout
);

4667 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnEnvœÚm’tsS‘UpS¹
(

4668 cÚ¡ 
Un™Te¡
& ) {

4669 
CŞÜedPrštf
(
COLOR_GREEN
, "[----------] ");

4670 
´štf
("Globalestƒnvironment set-up.\n");

4671 
fæush
(
¡dout
);

4674 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


4675 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnTe¡Ca£S¹
(cÚ¡ 
Te¡Ca£
& 
‹¡_ÿ£
) {

4676 cÚ¡ 
¡d
::
¡ršg
 
couÁs
 =

4677 
FÜm©CouÁabËNoun
(
‹¡_ÿ£
.
‹¡_to_run_couÁ
(), "test", "tests");

4678 
CŞÜedPrštf
(
COLOR_GREEN
, "[----------] ");

4679 
´štf
("% äom %s", 
couÁs
.
c_¡r
(), 
‹¡_ÿ£
.
Çme
());

4680 ià(
	g‹¡_ÿ£
.
ty³_·¿m
(è=ğ
nuÎ±r
) {

4681 
´štf
("\n");

4683 
´štf
(", wh”% ğ%s\n", 
kTy³P¬amLab–
, 
‹¡_ÿ£
.
ty³_·¿m
());

4685 
fæush
(
¡dout
);

4688 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnTe¡Su™eS¹
(

4689 cÚ¡ 
Te¡Su™e
& 
‹¡_su™e
) {

4690 cÚ¡ 
¡d
::
¡ršg
 
couÁs
 =

4691 
FÜm©CouÁabËNoun
(
‹¡_su™e
.
‹¡_to_run_couÁ
(), "test", "tests");

4692 
CŞÜedPrštf
(
COLOR_GREEN
, "[----------] ");

4693 
´štf
("% äom %s", 
couÁs
.
c_¡r
(), 
‹¡_su™e
.
Çme
());

4694 ià(
	g‹¡_su™e
.
ty³_·¿m
(è=ğ
nuÎ±r
) {

4695 
´štf
("\n");

4697 
´štf
(", wh”% ğ%s\n", 
kTy³P¬amLab–
, 
‹¡_su™e
.
ty³_·¿m
());

4699 
fæush
(
¡dout
);

4703 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnTe¡S¹
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
) {

4704 
CŞÜedPrštf
(
COLOR_GREEN
, "[ RUN ] ");

4705 
PrštTe¡Name
(
‹¡_šfo
.
‹¡_su™e_Çme
(),e¡_šfo.
Çme
());

4706 
´štf
("\n");

4707 
fæush
(
¡dout
);

4711 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnTe¡P¬tResuÉ
(

4712 cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) {

4713 
»suÉ
.
ty³
()) {

4716 
Te¡P¬tResuÉ
::
kSucûss
:

4721 
PrštTe¡P¬tResuÉ
(
»suÉ
);

4722 
fæush
(
¡dout
);

4726 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnTe¡End
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
) {

4727 ià(
‹¡_šfo
.
»suÉ
()->
Pas£d
()) {

4728 
CŞÜedPrštf
(
COLOR_GREEN
, "[ OK ] ");

4729 } ià(
	g‹¡_šfo
.
»suÉ
()->
Sk³d
()) {

4730 
CŞÜedPrštf
(
COLOR_GREEN
, "[ SKIPPED ] ");

4732 
CŞÜedPrštf
(
COLOR_RED
, "[ FAILED ] ");

4734 
PrštTe¡Name
(
‹¡_šfo
.
‹¡_su™e_Çme
(),e¡_šfo.
Çme
());

4735 ià(
	g‹¡_šfo
.
»suÉ
()->
Faed
())

4736 
PrštFuÎTe¡Comm’tIfP»£Á
(
‹¡_šfo
);

4738 ià(
GTEST_FLAG
(
´št_time
)) {

4739 
´štf
(" (% ms)\n", 
š‹º®
::
SŒ—mabËToSŒšg
(

4740 
‹¡_šfo
.
»suÉ
()->
–­£d_time
()).
c_¡r
());

4742 
´štf
("\n");

4744 
fæush
(
¡dout
);

4747 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


4748 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnTe¡Ca£End
(cÚ¡ 
Te¡Ca£
& 
‹¡_ÿ£
) {

4749 ià(!
GTEST_FLAG
(
´št_time
)) ;

4751 cÚ¡ 
	g¡d
::
¡ršg
 
couÁs
 =

4752 
FÜm©CouÁabËNoun
(
‹¡_ÿ£
.
‹¡_to_run_couÁ
(), "test", "tests");

4753 
CŞÜedPrštf
(
COLOR_GREEN
, "[----------] ");

4754 
´štf
("% äom % (% m tÙ®)\n\n", 
couÁs
.
c_¡r
(), 
‹¡_ÿ£
.
Çme
(),

4755 
š‹º®
::
SŒ—mabËToSŒšg
(
‹¡_ÿ£
.
–­£d_time
()).
c_¡r
());

4756 
fæush
(
¡dout
);

4759 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnTe¡Su™eEnd
(cÚ¡ 
Te¡Su™e
& 
‹¡_su™e
) {

4760 ià(!
GTEST_FLAG
(
´št_time
)) ;

4762 cÚ¡ 
	g¡d
::
¡ršg
 
couÁs
 =

4763 
FÜm©CouÁabËNoun
(
‹¡_su™e
.
‹¡_to_run_couÁ
(), "test", "tests");

4764 
CŞÜedPrštf
(
COLOR_GREEN
, "[----------] ");

4765 
´štf
("% äom % (% m tÙ®)\n\n", 
couÁs
.
c_¡r
(), 
‹¡_su™e
.
Çme
(),

4766 
š‹º®
::
SŒ—mabËToSŒšg
(
‹¡_su™e
.
–­£d_time
()).
c_¡r
());

4767 
fæush
(
¡dout
);

4771 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnEnvœÚm’tsT—rDownS¹
(

4772 cÚ¡ 
Un™Te¡
& ) {

4773 
CŞÜedPrštf
(
COLOR_GREEN
, "[----------] ");

4774 
´štf
("Globalestƒnvironmentear-down\n");

4775 
fæush
(
¡dout
);

4779 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
PrštFaedTe¡s
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
) {

4780 cÚ¡ 
çed_‹¡_couÁ
 = 
un™_‹¡
.failed_test_count();

4781 ià(
	gçed_‹¡_couÁ
 == 0) {

4785 
	gi
 = 0; i < 
	gun™_‹¡
.
tÙ®_‹¡_su™e_couÁ
(); ++i) {

4786 cÚ¡ 
	gTe¡Su™e
& 
	g‹¡_su™e
 = *
un™_‹¡
.
G‘Te¡Su™e
(
i
);

4787 ià(!
	g‹¡_su™e
.
should_run
(è|| (‹¡_su™e.
çed_‹¡_couÁ
() == 0)) {

4790 
	gj
 = 0; j < 
	g‹¡_su™e
.
tÙ®_‹¡_couÁ
(); ++j) {

4791 cÚ¡ 
	gTe¡Info
& 
	g‹¡_šfo
 = *
‹¡_su™e
.
G‘Te¡Info
(
j
);

4792 ià(!
	g‹¡_šfo
.
should_run
(è|| !‹¡_šfo.
»suÉ
()->
Faed
()) {

4795 
CŞÜedPrštf
(
COLOR_RED
, "[ FAILED ] ");

4796 
´štf
("%s.%s", 
‹¡_su™e
.
Çme
(), 
‹¡_šfo
.name());

4797 
PrštFuÎTe¡Comm’tIfP»£Á
(
‹¡_šfo
);

4798 
´štf
("\n");

4804 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
PrštSk³dTe¡s
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
) {

4805 cÚ¡ 
sk³d_‹¡_couÁ
 = 
un™_‹¡
.skipped_test_count();

4806 ià(
	gsk³d_‹¡_couÁ
 == 0) {

4810 
	gi
 = 0; i < 
	gun™_‹¡
.
tÙ®_‹¡_su™e_couÁ
(); ++i) {

4811 cÚ¡ 
	gTe¡Su™e
& 
	g‹¡_su™e
 = *
un™_‹¡
.
G‘Te¡Su™e
(
i
);

4812 ià(!
	g‹¡_su™e
.
should_run
(è|| (‹¡_su™e.
sk³d_‹¡_couÁ
() == 0)) {

4815 
	gj
 = 0; j < 
	g‹¡_su™e
.
tÙ®_‹¡_couÁ
(); ++j) {

4816 cÚ¡ 
	gTe¡Info
& 
	g‹¡_šfo
 = *
‹¡_su™e
.
G‘Te¡Info
(
j
);

4817 ià(!
	g‹¡_šfo
.
should_run
(è|| !‹¡_šfo.
»suÉ
()->
Sk³d
()) {

4820 
CŞÜedPrštf
(
COLOR_GREEN
, "[ SKIPPED ] ");

4821 
´štf
("%s.%s", 
‹¡_su™e
.
Çme
(), 
‹¡_šfo
.name());

4822 
´štf
("\n");

4827 
	gP»‰yUn™Te¡ResuÉPrš‹r
::
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
,

4829 
CŞÜedPrštf
(
COLOR_GREEN
, "[==========] ");

4830 
´štf
("%s from %s„an.",

4831 
FÜm©Te¡CouÁ
(
un™_‹¡
.
‹¡_to_run_couÁ
()).
c_¡r
(),

4832 
FÜm©Te¡Su™eCouÁ
(
un™_‹¡
.
‹¡_su™e_to_run_couÁ
()).
c_¡r
());

4833 ià(
GTEST_FLAG
(
´št_time
)) {

4834 
´štf
(" (%s msotal)",

4835 
š‹º®
::
SŒ—mabËToSŒšg
(
un™_‹¡
.
–­£d_time
()).
c_¡r
());

4837 
´štf
("\n");

4838 
CŞÜedPrštf
(
COLOR_GREEN
, "[ PASSED ] ");

4839 
´štf
("%s.\n", 
FÜm©Te¡CouÁ
(
un™_‹¡
.
sucûssful_‹¡_couÁ
()).
c_¡r
());

4841 cÚ¡ 
	gsk³d_‹¡_couÁ
 = 
un™_‹¡
.
sk³d_‹¡_couÁ
();

4842 ià(
	gsk³d_‹¡_couÁ
 > 0) {

4843 
CŞÜedPrštf
(
COLOR_GREEN
, "[ SKIPPED ] ");

4844 ià(
GTEST_FLAG
(
´št_sk³d
)) {

4845 
´štf
("%s,†i¡ed b–ow:\n", 
FÜm©Te¡CouÁ
(
sk³d_‹¡_couÁ
).
c_¡r
());

4846 
PrštSk³dTe¡s
(
un™_‹¡
);

4848 
´štf
("%s.\n", 
FÜm©Te¡CouÁ
(
sk³d_‹¡_couÁ
).
c_¡r
());

4852 
	gnum_çu»s
 = 
un™_‹¡
.
çed_‹¡_couÁ
();

4853 ià(!
	gun™_‹¡
.
Pas£d
()) {

4854 cÚ¡ 
	gçed_‹¡_couÁ
 = 
un™_‹¡
.
çed_‹¡_couÁ
();

4855 
CŞÜedPrštf
(
COLOR_RED
, "[ FAILED ] ");

4856 
´štf
("%s,†i¡ed b–ow:\n", 
FÜm©Te¡CouÁ
(
çed_‹¡_couÁ
).
c_¡r
());

4857 
PrštFaedTe¡s
(
un™_‹¡
);

4858 
´štf
("\n%2d FAILED %s\n", 
num_çu»s
,

4859 
num_çu»s
 == 1 ? "TEST" : "TESTS");

4862 
	gnum_di§bËd
 = 
un™_‹¡
.
»pÜbË_di§bËd_‹¡_couÁ
();

4863 ià(
	gnum_di§bËd
 && !
GTEST_FLAG
(
®so_run_di§bËd_‹¡s
)) {

4864 ià(!
	gnum_çu»s
) {

4865 
´štf
("\n");

4867 
CŞÜedPrštf
(
COLOR_YELLOW
,

4869 
num_di§bËd
,

4870 
num_di§bËd
 == 1 ? "TEST" : "TESTS");

4873 
fæush
(
¡dout
);

4881 şas 
	cTe¡Ev’tR•—‹r
 : 
public
 
Te¡Ev’tLi¡’”
 {

4882 
public
:

4883 
Te¡Ev’tR•—‹r
(è: 
fÜw¬dšg_’abËd_
(
Œue
) {}

4884 ~
Te¡Ev’tR•—‹r
(è
ov”ride
;

4885 
Aµ’d
(
Te¡Ev’tLi¡’”
 *
li¡’”
);

4886 
Te¡Ev’tLi¡’”
* 
R–—£
(Te¡Ev’tLi¡’”* 
li¡’”
);

4890 
boŞ
 
fÜw¬dšg_’abËd
(ècÚ¡ {  
	gfÜw¬dšg_’abËd_
; }

4891 
£t_fÜw¬dšg_’abËd
(
boŞ
 
’abË
è{ 
	gfÜw¬dšg_’abËd_
 =ƒnable; }

4893 
OnTe¡Prog¿mS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
è
	gov”ride
;

4894 
OnTe¡I‹¿tiÚS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
, 
™”©iÚ
è
	gov”ride
;

4895 
OnEnvœÚm’tsS‘UpS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
è
	gov”ride
;

4896 
OnEnvœÚm’tsS‘UpEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
è
	gov”ride
;

4898 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


4899 
OnTe¡Ca£S¹
(cÚ¡ 
Te¡Su™e
& 
·¿m‘”
è
	gov”ride
;

4901 
OnTe¡Su™eS¹
(cÚ¡ 
Te¡Su™e
& 
·¿m‘”
è
	gov”ride
;

4902 
OnTe¡S¹
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
è
	gov”ride
;

4903 
OnTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
è
	gov”ride
;

4904 
OnTe¡End
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
è
	gov”ride
;

4906 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


4907 
OnTe¡Ca£End
(cÚ¡ 
Te¡Ca£
& 
·¿m‘”
è
	gov”ride
;

4909 
OnTe¡Su™eEnd
(cÚ¡ 
Te¡Su™e
& 
·¿m‘”
è
	gov”ride
;

4910 
OnEnvœÚm’tsT—rDownS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
è
	gov”ride
;

4911 
OnEnvœÚm’tsT—rDownEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
è
	gov”ride
;

4912 
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
, 
™”©iÚ
è
	gov”ride
;

4913 
OnTe¡Prog¿mEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
è
	gov”ride
;

4915 
	g´iv©e
:

4918 
boŞ
 
fÜw¬dšg_’abËd_
;

4920 
	g¡d
::
veùÜ
<
Te¡Ev’tLi¡’”
*> 
li¡’”s_
;

4922 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Te¡Ev’tR•—‹r
);

4925 
	gTe¡Ev’tR•—‹r
::~
Te¡Ev’tR•—‹r
() {

4926 
FÜEach
(
li¡’”s_
, 
D–‘e
<
Te¡Ev’tLi¡’”
>);

4929 
	gTe¡Ev’tR•—‹r
::
Aµ’d
(
Te¡Ev’tLi¡’”
 *
li¡’”
) {

4930 
li¡’”s_
.
push_back
(
li¡’”
);

4933 
Te¡Ev’tLi¡’”
* 
	gTe¡Ev’tR•—‹r
::
R–—£
(Te¡Ev’tLi¡’” *
li¡’”
) {

4934 
size_t
 
i
 = 0; 
	gi
 < 
	gli¡’”s_
.
size
(); ++i) {

4935 ià(
	gli¡’”s_
[
i
] =ğ
li¡’”
) {

4936 
li¡’”s_
.
”a£
Öi¡’”s_.
begš
(è+ 
¡©ic_ÿ¡
<>(
i
));

4937  
	gli¡’”
;

4941  
	gnuÎ±r
;

4946 
	#GTEST_REPEATER_METHOD_
(
Name
, 
Ty³
) \

4947 
Te¡Ev’tR•—‹r
::
	`Name
(cÚ¡ 
Ty³
& 
·¿m‘”
) { \

4948 ià(
fÜw¬dšg_’abËd_
) { \

4949 
size_t
 
i
 = 0; i < 
li¡’”s_
.
	`size
(); i++) { \

4950 
li¡’”s_
[
i
]->
	`Name
(
·¿m‘”
); \

4953 }

	)

4956 
	#GTEST_REVERSE_REPEATER_METHOD_
(
Name
, 
Ty³
) \

4957 
Te¡Ev’tR•—‹r
::
	`Name
(cÚ¡ 
Ty³
& 
·¿m‘”
) { \

4958 ià(
fÜw¬dšg_’abËd_
) { \

4959 
size_t
 
i
 = 
li¡’”s_
.
	`size
(); i != 0; i--) { \

4960 
li¡’”s_
[
i
 - 1]->
	`Name
(
·¿m‘”
); \

4963 }

	)

4965 
GTEST_REPEATER_METHOD_
(
OnTe¡Prog¿mS¹
, 
Un™Te¡
)

4966 
GTEST_REPEATER_METHOD_
(
OnEnvœÚm’tsS‘UpS¹
, 
Un™Te¡
)

4968 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


4969 
GTEST_REPEATER_METHOD_
(
OnTe¡Ca£S¹
, 
Te¡Su™e
)

4971 
GTEST_REPEATER_METHOD_
(
OnTe¡Su™eS¹
, 
Te¡Su™e
)

4972 
GTEST_REPEATER_METHOD_
(
OnTe¡S¹
, 
Te¡Info
)

4973 
GTEST_REPEATER_METHOD_
(
OnTe¡P¬tResuÉ
, 
Te¡P¬tResuÉ
)

4974 
GTEST_REPEATER_METHOD_
(
OnEnvœÚm’tsT—rDownS¹
, 
Un™Te¡
)

4975 
GTEST_REVERSE_REPEATER_METHOD_
(
OnEnvœÚm’tsS‘UpEnd
, 
Un™Te¡
)

4976 
GTEST_REVERSE_REPEATER_METHOD_
(
OnEnvœÚm’tsT—rDownEnd
, 
Un™Te¡
)

4977 
GTEST_REVERSE_REPEATER_METHOD_
(
OnTe¡End
, 
Te¡Info
)

4979 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


4980 
GTEST_REVERSE_REPEATER_METHOD_
(
OnTe¡Ca£End
, 
Te¡Su™e
)

4982 
GTEST_REVERSE_REPEATER_METHOD_
(
OnTe¡Su™eEnd
, 
Te¡Su™e
)

4983 
GTEST_REVERSE_REPEATER_METHOD_
(
OnTe¡Prog¿mEnd
, 
Un™Te¡
)

4985 #undeà
GTEST_REPEATER_METHOD_


4986 #undeà
GTEST_REVERSE_REPEATER_METHOD_


4988 
	gTe¡Ev’tR•—‹r
::
OnTe¡I‹¿tiÚS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
,

4989 
™”©iÚ
) {

4990 ià(
	gfÜw¬dšg_’abËd_
) {

4991 
size_t
 
	gi
 = 0; i < 
	gli¡’”s_
.
size
(); i++) {

4992 
	gli¡’”s_
[
i
]->
OnTe¡I‹¿tiÚS¹
(
un™_‹¡
, 
™”©iÚ
);

4997 
	gTe¡Ev’tR•—‹r
::
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
,

4998 
™”©iÚ
) {

4999 ià(
	gfÜw¬dšg_’abËd_
) {

5000 
size_t
 
	gi
 = 
li¡’”s_
.
size
(); i > 0; i--) {

5001 
	gli¡’”s_
[
i
 - 1]->
OnTe¡I‹¿tiÚEnd
(
un™_‹¡
, 
™”©iÚ
);

5009 şas 
	cXmlUn™Te¡ResuÉPrš‹r
 : 
public
 
Em±yTe¡Ev’tLi¡’”
 {

5010 
public
:

5011 
ex¶ic™
 
XmlUn™Te¡ResuÉPrš‹r
(cÚ¡ * 
ouut_fe
);

5013 
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
, 
™”©iÚ
è
	gov”ride
;

5014 
Li¡Te¡sM©chšgF‹r
(cÚ¡ 
¡d
::
veùÜ
<
Te¡Su™e
*>& 
‹¡_su™es
);

5017 
PrštXmlTe¡sLi¡
(
¡d
::
o¡»am
* 
¡»am
,

5018 cÚ¡ 
¡d
::
veùÜ
<
Te¡Su™e
*>& 
‹¡_su™es
);

5020 
	g´iv©e
:

5023 
boŞ
 
IsNÜm®izabËWh™e¥aû
(
c
) {

5024  
c
 == 0x9 || c == 0xA || c == 0xD;

5028 
boŞ
 
IsV®idXmlCh¬aù”
(
c
) {

5029  
IsNÜm®izabËWh™e¥aû
(
c
è|| 
	gc
 >= 0x20;

5036 
	g¡d
::
¡ršg
 
Esÿ³Xml
(cÚ¡ 
¡d
::¡ršg& 
¡r
, 
boŞ
 
is_©Œibu‹
);

5039 
	g¡d
::
¡ršg
 
RemoveInv®idXmlCh¬aù”s
(cÚ¡ 
¡d
::¡ršg& 
¡r
);

5042 
	g¡d
::
¡ršg
 
Esÿ³XmlA‰ribu‹
(cÚ¡ 
¡d
::¡ršg& 
¡r
) {

5043  
Esÿ³Xml
(
¡r
, 
Œue
);

5047 
	g¡d
::
¡ršg
 
Esÿ³XmlText
(cÚ¡ * 
¡r
) {

5048  
Esÿ³Xml
(
¡r
, 
çl£
);

5053 
OuutXmlA‰ribu‹
(
¡d
::
o¡»am
* 
¡»am
,

5054 cÚ¡ 
¡d
::
¡ršg
& 
–em’t_Çme
,

5055 cÚ¡ 
¡d
::
¡ršg
& 
Çme
,

5056 cÚ¡ 
¡d
::
¡ršg
& 
v®ue
);

5059 
OuutXmlCD©aSeùiÚ
(::
¡d
::
o¡»am
* 
¡»am
, cÚ¡ * 
d©a
);

5062 
OuutXmlTe¡Info
(::
¡d
::
o¡»am
* 
¡»am
,

5063 cÚ¡ * 
‹¡_su™e_Çme
,

5064 cÚ¡ 
Te¡Info
& 
‹¡_šfo
);

5067 
PrštXmlTe¡Su™e
(::
¡d
::
o¡»am
* 
¡»am
,

5068 cÚ¡ 
Te¡Su™e
& 
‹¡_su™e
);

5071 
PrštXmlUn™Te¡
(::
¡d
::
o¡»am
* 
¡»am
,

5072 cÚ¡ 
Un™Te¡
& 
un™_‹¡
);

5078 
	g¡d
::
¡ršg
 
Te¡Prİ”t›sAsXmlA‰ribu‹s
(cÚ¡ 
Te¡ResuÉ
& 
»suÉ
);

5082 
OuutXmlTe¡Prİ”t›s
(
¡d
::
o¡»am
* 
¡»am
,

5083 cÚ¡ 
Te¡ResuÉ
& 
»suÉ
);

5086 cÚ¡ 
	g¡d
::
¡ršg
 
ouut_fe_
;

5088 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
XmlUn™Te¡ResuÉPrš‹r
);

5092 
	gXmlUn™Te¡ResuÉPrš‹r
::
XmlUn™Te¡ResuÉPrš‹r
(cÚ¡ * 
ouut_fe
)

5093 : 
ouut_fe_
(
ouut_fe
) {

5094 ià(
ouut_fe_
.
em±y
()) {

5095 
GTEST_LOG_
(
FATAL
) << "XML output file may‚ot be‚ull";

5100 
	gXmlUn™Te¡ResuÉPrš‹r
::
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
,

5102 
FILE
* 
	gxmlout
 = 
O³nFeFÜWr™šg
(
ouut_fe_
);

5103 
	g¡d
::
¡ršg¡»am
 
¡»am
;

5104 
PrštXmlUn™Te¡
(&
¡»am
, 
un™_‹¡
);

5105 
årštf
(
xmlout
, "%s", 
SŒšgSŒ—mToSŒšg
(&
¡»am
).
c_¡r
());

5106 
fşo£
(
xmlout
);

5109 
	gXmlUn™Te¡ResuÉPrš‹r
::
Li¡Te¡sM©chšgF‹r
(

5110 cÚ¡ 
¡d
::
veùÜ
<
Te¡Su™e
*>& 
‹¡_su™es
) {

5111 
FILE
* 
xmlout
 = 
O³nFeFÜWr™šg
(
ouut_fe_
);

5112 
	g¡d
::
¡ršg¡»am
 
¡»am
;

5113 
PrštXmlTe¡sLi¡
(&
¡»am
, 
‹¡_su™es
);

5114 
årštf
(
xmlout
, "%s", 
SŒšgSŒ—mToSŒšg
(&
¡»am
).
c_¡r
());

5115 
fşo£
(
xmlout
);

5128 
	g¡d
::
¡ršg
 
XmlUn™Te¡ResuÉPrš‹r
::
Esÿ³Xml
(

5129 cÚ¡ 
¡d
::
¡ršg
& 
¡r
, 
boŞ
 
is_©Œibu‹
) {

5130 
Mes§ge
 
	gm
;

5132 
size_t
 
	gi
 = 0; i < 
	g¡r
.
size
(); ++i) {

5133 cÚ¡ 
	gch
 = 
¡r
[
i
];

5134 
	gch
) {

5136 
m
 << "&lt;";

5139 
m
 << "&gt;";

5142 
m
 << "&amp;";

5145 ià(
is_©Œibu‹
)

5146 
m
 << "&apos;";

5148 
	gm
 << '\'';

5151 ià(
is_©Œibu‹
)

5152 
m
 << "&quot;";

5154 
	gm
 << '"';

5157 ià(
IsV®idXmlCh¬aù”
(
ch
)) {

5158 ià(
is_©Œibu‹
 && 
IsNÜm®izabËWh™e¥aû
(
ch
))

5159 
m
 << "&#x" << 
SŒšg
::
FÜm©By‹
(
¡©ic_ÿ¡
<>(
ch
))

5162 
	gm
 << 
	gch
;

5168  
	gm
.
G‘SŒšg
();

5174 
	g¡d
::
¡ršg
 
XmlUn™Te¡ResuÉPrš‹r
::
RemoveInv®idXmlCh¬aù”s
(

5175 cÚ¡ 
¡d
::
¡ršg
& 
¡r
) {

5176 
¡d
::
¡ršg
 
ouut
;

5177 
	gouut
.
»£rve
(
¡r
.
size
());

5178 
	g¡d
::
¡ršg
::
cÚ¡_™”©Ü
 
™
 = 
¡r
.
begš
(); 
	g™
 !ğ¡r.
’d
(); ++it)

5179 ià(
IsV®idXmlCh¬aù”
(*
™
))

5180 
	gouut
.
push_back
(*
™
);

5182  
	gouut
;

5203 
	g¡d
::
¡ršg
 
FÜm©TimeInMlisAsSecÚds
(
TimeInMlis
 
ms
) {

5204 ::
¡d
::
¡ršg¡»am
 
ss
;

5205 
	gss
 << (
	g¡©ic_ÿ¡
<>(
	gms
) * 1e-3);

5206  
	gss
.
¡r
();

5209 
boŞ
 
PÜbËLoÿÉime
(
time_t
 
£cÚds
, 
tm
* 
out
) {

5210 #ià
defšed
(
_MSC_VER
)

5211  
loÿÉime_s
(
out
, &
£cÚds
) == 0;

5212 #–ià
defšed
(
__MINGW32__
è|| defšed(
__MINGW64__
)

5215 
tm
* 
	gtm_±r
 = 
loÿÉime
(&
£cÚds
);

5216 ià(
	gtm_±r
 =ğ
nuÎ±r
è 
çl£
;

5217 *
	gout
 = *
tm_±r
;

5218  
	gŒue
;

5220  
loÿÉime_r
(&
£cÚds
, 
out
è!ğ
nuÎ±r
;

5226 
	g¡d
::
¡ršg
 
FÜm©EpochTimeInMlisAsIso8601
(
TimeInMlis
 
ms
) {

5227 
tm
 
time_¡ruù
;

5228 ià(!
PÜbËLoÿÉime
(
¡©ic_ÿ¡
<
time_t
>(
ms
 / 1000), &
time_¡ruù
))

5231  
SŒ—mabËToSŒšg
(
time_¡ruù
.
tm_y—r
 + 1900) + "-" +

5232 
	gSŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_mÚ
 + 1) + "-" +

5233 
SŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_mday
) + "T" +

5234 
SŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_hour
) + ":" +

5235 
SŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_mš
) + ":" +

5236 
SŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_£c
);

5240 
	gXmlUn™Te¡ResuÉPrš‹r
::
OuutXmlCD©aSeùiÚ
(::
¡d
::
o¡»am
* 
¡»am
,

5241 cÚ¡ * 
d©a
) {

5242 cÚ¡ * 
	g£gm’t
 = 
d©a
;

5243 *
	g¡»am
 << "<![CDATA[";

5245 cÚ¡ * cÚ¡ 
	gÃxt_£gm’t
 = 
¡r¡r
(
£gm’t
, "]]>");

5246 ià(
	gÃxt_£gm’t
 !ğ
nuÎ±r
) {

5247 
¡»am
->
wr™e
(

5248 
£gm’t
, 
¡©ic_ÿ¡
<
¡d
::
¡»amsize
>(
Ãxt_£gm’t
 - segment));

5249 *
	g¡»am
 << "]]>]]&gt;<![CDATA[";

5250 
	g£gm’t
 = 
Ãxt_£gm’t
 + 
¡¾’
("]]>");

5252 *
	g¡»am
 << 
	g£gm’t
;

5256 *
	g¡»am
 << "]]>";

5259 
	gXmlUn™Te¡ResuÉPrš‹r
::
OuutXmlA‰ribu‹
(

5260 
¡d
::
o¡»am
* 
¡»am
,

5261 cÚ¡ 
¡d
::
¡ršg
& 
–em’t_Çme
,

5262 cÚ¡ 
¡d
::
¡ršg
& 
Çme
,

5263 cÚ¡ 
¡d
::
¡ršg
& 
v®ue
) {

5264 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
®lowed_Çmes
 =

5265 
G‘Re£rvedOuutA‰ribu‹sFÜEËm’t
(
–em’t_Çme
);

5267 
GTEST_CHECK_
(
¡d
::
fšd
(
®lowed_Çmes
.
begš
(),‡Îowed_Çmes.
’d
(), 
Çme
) !=

5268 
®lowed_Çmes
.
’d
())

5269 << "A‰ribu‹ " << 
Çme
 << " i nÙ‡Îowed fÜƒËm’ˆ<" << 
–em’t_Çme


5272 *
	g¡»am
 << " " << 
	gÇme
 << "=\"" << 
Esÿ³XmlA‰ribu‹
(
v®ue
) << "\"";

5276 
	gXmlUn™Te¡ResuÉPrš‹r
::
OuutXmlTe¡Info
(::
¡d
::
o¡»am
* 
¡»am
,

5277 cÚ¡ * 
‹¡_su™e_Çme
,

5278 cÚ¡ 
Te¡Info
& 
‹¡_šfo
) {

5279 cÚ¡ 
	gTe¡ResuÉ
& 
	g»suÉ
 = *
‹¡_šfo
.
»suÉ
();

5280 cÚ¡ 
	g¡d
::
¡ršg
 
kTe¡su™e
 = "testcase";

5282 ià(
	g‹¡_šfo
.
is_š_ªÙh”_sh¬d
()) {

5286 *
	g¡»am
 << " <testcase";

5287 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "Çme", 
‹¡_šfo
.
Çme
());

5289 ià(
	g‹¡_šfo
.
v®ue_·¿m
(è!ğ
nuÎ±r
) {

5290 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "value_param",

5291 
‹¡_šfo
.
v®ue_·¿m
());

5293 ià(
	g‹¡_šfo
.
ty³_·¿m
(è!ğ
nuÎ±r
) {

5294 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "type_param",

5295 
‹¡_šfo
.
ty³_·¿m
());

5297 ià(
GTEST_FLAG
(
li¡_‹¡s
)) {

5298 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "fe", 
‹¡_šfo
.
fe
());

5299 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "line",

5300 
SŒ—mabËToSŒšg
(
‹¡_šfo
.
lše
()));

5301 *
	g¡»am
 << " />\n";

5305 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "status",

5306 
‹¡_šfo
.
should_run
() ? "run" : "notrun");

5307 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "result",

5308 
‹¡_šfo
.
should_run
()

5309 ? (
»suÉ
.
Sk³d
() ? "skipped" : "completed")

5311 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "time",

5312 
FÜm©TimeInMlisAsSecÚds
(
»suÉ
.
–­£d_time
()));

5313 
OuutXmlA‰ribu‹
(

5314 
¡»am
, 
kTe¡su™e
, "timestamp",

5315 
FÜm©EpochTimeInMlisAsIso8601
(
»suÉ
.
¡¬t_time¡amp
()));

5316 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "şas¢ame", 
‹¡_su™e_Çme
);

5318 
	gçu»s
 = 0;

5319 
	gi
 = 0; i < 
	g»suÉ
.
tÙ®_·¹_couÁ
(); ++i) {

5320 cÚ¡ 
	gTe¡P¬tResuÉ
& 
	g·¹
 = 
»suÉ
.
G‘Te¡P¬tResuÉ
(
i
);

5321 ià(
	g·¹
.
çed
()) {

5322 ià(++
	gçu»s
 == 1) {

5323 *
¡»am
 << ">\n";

5325 cÚ¡ 
	g¡d
::
¡ršg
 
loÿtiÚ
 =

5326 
š‹º®
::
FÜm©Comp”Ind•’d’tFeLoÿtiÚ
(
·¹
.
fe_Çme
(),

5327 
·¹
.
lše_numb”
());

5328 cÚ¡ 
	g¡d
::
¡ršg
 
summ¬y
 = 
loÿtiÚ
 + "\n" + 
·¹
.summary();

5329 *
	g¡»am
 << " <failure message=\""

5330 << 
Esÿ³XmlA‰ribu‹
(
summ¬y
.
c_¡r
())

5332 cÚ¡ 
	g¡d
::
¡ršg
 
d‘a
 = 
loÿtiÚ
 + "\n" + 
·¹
.
mes§ge
();

5333 
OuutXmlCD©aSeùiÚ
(
¡»am
, 
RemoveInv®idXmlCh¬aù”s
(
d‘a
).
c_¡r
());

5334 *
	g¡»am
 << "</failure>\n";

5338 ià(
	gçu»s
 =ğ0 && 
»suÉ
.
‹¡_´İ”ty_couÁ
() == 0) {

5339 *
¡»am
 << " />\n";

5341 ià(
	gçu»s
 == 0) {

5342 *
¡»am
 << ">\n";

5344 
OuutXmlTe¡Prİ”t›s
(
¡»am
, 
»suÉ
);

5345 *
	g¡»am
 << " </testcase>\n";

5350 
	gXmlUn™Te¡ResuÉPrš‹r
::
PrštXmlTe¡Su™e
(
¡d
::
o¡»am
* 
¡»am
,

5351 cÚ¡ 
Te¡Su™e
& 
‹¡_su™e
) {

5352 cÚ¡ 
	g¡d
::
¡ršg
 
kTe¡su™e
 = "testsuite";

5353 *
	g¡»am
 << " <" << 
	gkTe¡su™e
;

5354 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "Çme", 
‹¡_su™e
.
Çme
());

5355 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "tests",

5356 
SŒ—mabËToSŒšg
(
‹¡_su™e
.
»pÜbË_‹¡_couÁ
()));

5357 ià(!
GTEST_FLAG
(
li¡_‹¡s
)) {

5358 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "failures",

5359 
SŒ—mabËToSŒšg
(
‹¡_su™e
.
çed_‹¡_couÁ
()));

5360 
OuutXmlA‰ribu‹
(

5361 
¡»am
, 
kTe¡su™e
, "disabled",

5362 
SŒ—mabËToSŒšg
(
‹¡_su™e
.
»pÜbË_di§bËd_‹¡_couÁ
()));

5363 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "errors", "0");

5364 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™e
, "time",

5365 
FÜm©TimeInMlisAsSecÚds
(
‹¡_su™e
.
–­£d_time
()));

5366 
OuutXmlA‰ribu‹
(

5367 
¡»am
, 
kTe¡su™e
, "timestamp",

5368 
FÜm©EpochTimeInMlisAsIso8601
(
‹¡_su™e
.
¡¬t_time¡amp
()));

5369 *
	g¡»am
 << 
Te¡Prİ”t›sAsXmlA‰ribu‹s
(
‹¡_su™e
.
ad_hoc_‹¡_»suÉ
());

5371 *
	g¡»am
 << ">\n";

5372 
	gi
 = 0; i < 
	g‹¡_su™e
.
tÙ®_‹¡_couÁ
(); ++i) {

5373 ià(
	g‹¡_su™e
.
G‘Te¡Info
(
i
)->
is_»pÜbË
())

5374 
OuutXmlTe¡Info
(
¡»am
, 
‹¡_su™e
.
Çme
(), *‹¡_su™e.
G‘Te¡Info
(
i
));

5376 *
	g¡»am
 << " </" << 
	gkTe¡su™e
 << ">\n";

5380 
	gXmlUn™Te¡ResuÉPrš‹r
::
PrštXmlUn™Te¡
(
¡d
::
o¡»am
* 
¡»am
,

5381 cÚ¡ 
Un™Te¡
& 
un™_‹¡
) {

5382 cÚ¡ 
	g¡d
::
¡ršg
 
kTe¡su™es
 = "testsuites";

5384 *
	g¡»am
 << "<?xml version=\"1.0\"ƒncoding=\"UTF-8\"?>\n";

5385 *
	g¡»am
 << "<" << 
	gkTe¡su™es
;

5387 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™es
, "tests",

5388 
SŒ—mabËToSŒšg
(
un™_‹¡
.
»pÜbË_‹¡_couÁ
()));

5389 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™es
, "failures",

5390 
SŒ—mabËToSŒšg
(
un™_‹¡
.
çed_‹¡_couÁ
()));

5391 
OuutXmlA‰ribu‹
(

5392 
¡»am
, 
kTe¡su™es
, "disabled",

5393 
SŒ—mabËToSŒšg
(
un™_‹¡
.
»pÜbË_di§bËd_‹¡_couÁ
()));

5394 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™es
, "errors", "0");

5395 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™es
, "time",

5396 
FÜm©TimeInMlisAsSecÚds
(
un™_‹¡
.
–­£d_time
()));

5397 
OuutXmlA‰ribu‹
(

5398 
¡»am
, 
kTe¡su™es
, "timestamp",

5399 
FÜm©EpochTimeInMlisAsIso8601
(
un™_‹¡
.
¡¬t_time¡amp
()));

5401 ià(
GTEST_FLAG
(
shufæe
)) {

5402 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™es
, "random_seed",

5403 
SŒ—mabËToSŒšg
(
un™_‹¡
.
¿ndom_£ed
()));

5405 *
	g¡»am
 << 
Te¡Prİ”t›sAsXmlA‰ribu‹s
(
un™_‹¡
.
ad_hoc_‹¡_»suÉ
());

5407 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™es
, "name", "AllTests");

5408 *
	g¡»am
 << ">\n";

5410 
	gi
 = 0; i < 
	gun™_‹¡
.
tÙ®_‹¡_su™e_couÁ
(); ++i) {

5411 ià(
	gun™_‹¡
.
G‘Te¡Su™e
(
i
)->
»pÜbË_‹¡_couÁ
() > 0)

5412 
PrštXmlTe¡Su™e
(
¡»am
, *
un™_‹¡
.
G‘Te¡Su™e
(
i
));

5414 *
	g¡»am
 << "</" << 
	gkTe¡su™es
 << ">\n";

5417 
	gXmlUn™Te¡ResuÉPrš‹r
::
PrštXmlTe¡sLi¡
(

5418 
¡d
::
o¡»am
* 
¡»am
, cÚ¡ std::
veùÜ
<
Te¡Su™e
*>& 
‹¡_su™es
) {

5419 cÚ¡ 
¡d
::
¡ršg
 
kTe¡su™es
 = "testsuites";

5421 *
	g¡»am
 << "<?xml version=\"1.0\"ƒncoding=\"UTF-8\"?>\n";

5422 *
	g¡»am
 << "<" << 
	gkTe¡su™es
;

5424 
	gtÙ®_‹¡s
 = 0;

5425 autØ
	g‹¡_su™e
 : 
‹¡_su™es
) {

5426 
tÙ®_‹¡s
 +ğ
‹¡_su™e
->
tÙ®_‹¡_couÁ
();

5428 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™es
, "tests",

5429 
SŒ—mabËToSŒšg
(
tÙ®_‹¡s
));

5430 
OuutXmlA‰ribu‹
(
¡»am
, 
kTe¡su™es
, "name", "AllTests");

5431 *
	g¡»am
 << ">\n";

5433 autØ
	g‹¡_su™e
 : 
‹¡_su™es
) {

5434 
PrštXmlTe¡Su™e
(
¡»am
, *
‹¡_su™e
);

5436 *
	g¡»am
 << "</" << 
	gkTe¡su™es
 << ">\n";

5441 
	g¡d
::
¡ršg
 
XmlUn™Te¡ResuÉPrš‹r
::
Te¡Prİ”t›sAsXmlA‰ribu‹s
(

5442 cÚ¡ 
Te¡ResuÉ
& 
»suÉ
) {

5443 
Mes§ge
 
©Œibu‹s
;

5444 
	gi
 = 0; i < 
	g»suÉ
.
‹¡_´İ”ty_couÁ
(); ++i) {

5445 cÚ¡ 
	gTe¡Prİ”ty
& 
	g´İ”ty
 = 
»suÉ
.
G‘Te¡Prİ”ty
(
i
);

5446 
	g©Œibu‹s
 << " " << 
	g´İ”ty
.
key
() << "="

5447 << "\"" << 
Esÿ³XmlA‰ribu‹
(
´İ”ty
.
v®ue
()) << "\"";

5449  
	g©Œibu‹s
.
G‘SŒšg
();

5452 
	gXmlUn™Te¡ResuÉPrš‹r
::
OuutXmlTe¡Prİ”t›s
(

5453 
¡d
::
o¡»am
* 
¡»am
, cÚ¡ 
Te¡ResuÉ
& 
»suÉ
) {

5454 cÚ¡ 
	g¡d
::
¡ršg
 
kPrİ”t›s
 = "properties";

5455 cÚ¡ 
	g¡d
::
¡ršg
 
kPrİ”ty
 = "property";

5457 ià(
	g»suÉ
.
‹¡_´İ”ty_couÁ
() <= 0) {

5461 *
	g¡»am
 << "<" << 
	gkPrİ”t›s
 << ">\n";

5462 
	gi
 = 0; i < 
	g»suÉ
.
‹¡_´İ”ty_couÁ
(); ++i) {

5463 cÚ¡ 
	gTe¡Prİ”ty
& 
	g´İ”ty
 = 
»suÉ
.
G‘Te¡Prİ”ty
(
i
);

5464 *
	g¡»am
 << "<" << 
	gkPrİ”ty
;

5465 *
	g¡»am
 << "‚ame=\"" << 
Esÿ³XmlA‰ribu‹
(
´İ”ty
.
key
()) << "\"";

5466 *
	g¡»am
 << " v®ue=\"" << 
Esÿ³XmlA‰ribu‹
(
´İ”ty
.
v®ue
()) << "\"";

5467 *
	g¡»am
 << "/>\n";

5469 *
	g¡»am
 << "</" << 
	gkPrİ”t›s
 << ">\n";

5475 şas 
	cJsÚUn™Te¡ResuÉPrš‹r
 : 
public
 
Em±yTe¡Ev’tLi¡’”
 {

5476 
public
:

5477 
ex¶ic™
 
JsÚUn™Te¡ResuÉPrš‹r
(cÚ¡ * 
ouut_fe
);

5479 
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
, 
™”©iÚ
è
	gov”ride
;

5482 
PrštJsÚTe¡Li¡
(::
¡d
::
o¡»am
* 
¡»am
,

5483 cÚ¡ 
¡d
::
veùÜ
<
Te¡Su™e
*>& 
‹¡_su™es
);

5485 
	g´iv©e
:

5487 
¡d
::
¡ršg
 
Esÿ³JsÚ
(cÚ¡ std::¡ršg& 
¡r
);

5491 
OuutJsÚKey
(
¡d
::
o¡»am
* 
¡»am
,

5492 cÚ¡ 
¡d
::
¡ršg
& 
–em’t_Çme
,

5493 cÚ¡ 
¡d
::
¡ršg
& 
Çme
,

5494 cÚ¡ 
¡d
::
¡ršg
& 
v®ue
,

5495 cÚ¡ 
¡d
::
¡ršg
& 
šd’t
,

5496 
boŞ
 
comma
 = 
Œue
);

5497 
OuutJsÚKey
(
¡d
::
o¡»am
* 
¡»am
,

5498 cÚ¡ 
¡d
::
¡ršg
& 
–em’t_Çme
,

5499 cÚ¡ 
¡d
::
¡ršg
& 
Çme
,

5500 
v®ue
,

5501 cÚ¡ 
¡d
::
¡ršg
& 
šd’t
,

5502 
boŞ
 
comma
 = 
Œue
);

5505 
OuutJsÚTe¡Info
(::
¡d
::
o¡»am
* 
¡»am
,

5506 cÚ¡ * 
‹¡_su™e_Çme
,

5507 cÚ¡ 
Te¡Info
& 
‹¡_šfo
);

5510 
PrštJsÚTe¡Su™e
(::
¡d
::
o¡»am
* 
¡»am
,

5511 cÚ¡ 
Te¡Su™e
& 
‹¡_su™e
);

5514 
PrštJsÚUn™Te¡
(::
¡d
::
o¡»am
* 
¡»am
,

5515 cÚ¡ 
Un™Te¡
& 
un™_‹¡
);

5519 
	g¡d
::
¡ršg
 
Te¡Prİ”t›sAsJsÚ
(cÚ¡ 
Te¡ResuÉ
& 
»suÉ
,

5520 cÚ¡ 
¡d
::
¡ršg
& 
šd’t
);

5523 cÚ¡ 
	g¡d
::
¡ršg
 
ouut_fe_
;

5525 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
JsÚUn™Te¡ResuÉPrš‹r
);

5529 
	gJsÚUn™Te¡ResuÉPrš‹r
::
JsÚUn™Te¡ResuÉPrš‹r
(cÚ¡ * 
ouut_fe
)

5530 : 
ouut_fe_
(
ouut_fe
) {

5531 ià(
ouut_fe_
.
em±y
()) {

5532 
GTEST_LOG_
(
FATAL
) << "JSON output file may‚ot be‚ull";

5536 
	gJsÚUn™Te¡ResuÉPrš‹r
::
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
,

5538 
FILE
* 
	gjsÚout
 = 
O³nFeFÜWr™šg
(
ouut_fe_
);

5539 
	g¡d
::
¡ršg¡»am
 
¡»am
;

5540 
PrštJsÚUn™Te¡
(&
¡»am
, 
un™_‹¡
);

5541 
årštf
(
jsÚout
, "%s", 
SŒšgSŒ—mToSŒšg
(&
¡»am
).
c_¡r
());

5542 
fşo£
(
jsÚout
);

5546 
	g¡d
::
¡ršg
 
JsÚUn™Te¡ResuÉPrš‹r
::
Esÿ³JsÚ
(cÚ¡ 
¡d
::¡ršg& 
¡r
) {

5547 
Mes§ge
 
m
;

5549 
size_t
 
	gi
 = 0; i < 
	g¡r
.
size
(); ++i) {

5550 cÚ¡ 
	gch
 = 
¡r
[
i
];

5551 
	gch
) {

5555 
m
 << '\\' << 
ch
;

5558 
m
 << "\\b";

5561 
m
 << "\\t";

5564 
m
 << "\\n";

5567 
m
 << "\\f";

5570 
m
 << "\\r";

5573 ià(
ch
 < ' ') {

5574 
m
 << "\\u00" << 
SŒšg
::
FÜm©By‹
(
¡©ic_ÿ¡
<>(
ch
));

5576 
	gm
 << 
	gch
;

5582  
	gm
.
G‘SŒšg
();

5589 
	g¡d
::
¡ršg
 
FÜm©TimeInMlisAsDu¿tiÚ
(
TimeInMlis
 
ms
) {

5590 ::
¡d
::
¡ršg¡»am
 
ss
;

5591 
	gss
 << (
	g¡©ic_ÿ¡
<>(
	gms
) * 1e-3) << "s";

5592  
	gss
.
¡r
();

5597 
	g¡d
::
¡ršg
 
FÜm©EpochTimeInMlisAsRFC3339
(
TimeInMlis
 
ms
) {

5598 
tm
 
time_¡ruù
;

5599 ià(!
PÜbËLoÿÉime
(
¡©ic_ÿ¡
<
time_t
>(
ms
 / 1000), &
time_¡ruù
))

5602  
SŒ—mabËToSŒšg
(
time_¡ruù
.
tm_y—r
 + 1900) + "-" +

5603 
	gSŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_mÚ
 + 1) + "-" +

5604 
SŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_mday
) + "T" +

5605 
SŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_hour
) + ":" +

5606 
SŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_mš
) + ":" +

5607 
SŒšg
::
FÜm©IÁWidth2
(
time_¡ruù
.
tm_£c
) + "Z";

5610 
šlše
 
	g¡d
::
¡ršg
 
Ind’t
(
size_t
 
width
) {

5611  
¡d
::
¡ršg
(
width
, ' ');

5614 
	gJsÚUn™Te¡ResuÉPrš‹r
::
OuutJsÚKey
(

5615 
¡d
::
o¡»am
* 
¡»am
,

5616 cÚ¡ 
¡d
::
¡ršg
& 
–em’t_Çme
,

5617 cÚ¡ 
¡d
::
¡ršg
& 
Çme
,

5618 cÚ¡ 
¡d
::
¡ršg
& 
v®ue
,

5619 cÚ¡ 
¡d
::
¡ršg
& 
šd’t
,

5620 
boŞ
 
comma
) {

5621 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>& 
®lowed_Çmes
 =

5622 
G‘Re£rvedOuutA‰ribu‹sFÜEËm’t
(
–em’t_Çme
);

5624 
GTEST_CHECK_
(
¡d
::
fšd
(
®lowed_Çmes
.
begš
(),‡Îowed_Çmes.
’d
(), 
Çme
) !=

5625 
®lowed_Çmes
.
’d
())

5626 << "Key \"" << 
Çme
 << "\" i nÙ‡Îowed fÜ v®u\"" << 
–em’t_Çme


5629 *
	g¡»am
 << 
	gšd’t
 << "\"" << 
	gÇme
 << "\": \"" << 
Esÿ³JsÚ
(
v®ue
) << "\"";

5630 ià(
	gcomma
)

5631 *
	g¡»am
 << ",\n";

5634 
	gJsÚUn™Te¡ResuÉPrš‹r
::
OuutJsÚKey
(

5635 
¡d
::
o¡»am
* 
¡»am
,

5636 cÚ¡ 
¡d
::
¡ršg
& 
–em’t_Çme
,

5637 cÚ¡ 
¡d
::
¡ršg
& 
Çme
,

5638 
v®ue
,

5639 cÚ¡ 
¡d
::
¡ršg
& 
šd’t
,

5640 
boŞ
 
comma
) {

5641 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>& 
®lowed_Çmes
 =

5642 
G‘Re£rvedOuutA‰ribu‹sFÜEËm’t
(
–em’t_Çme
);

5644 
GTEST_CHECK_
(
¡d
::
fšd
(
®lowed_Çmes
.
begš
(),‡Îowed_Çmes.
’d
(), 
Çme
) !=

5645 
®lowed_Çmes
.
’d
())

5646 << "Key \"" << 
Çme
 << "\" i nÙ‡Îowed fÜ v®u\"" << 
–em’t_Çme


5649 *
	g¡»am
 << 
	gšd’t
 << "\"" << 
	gÇme
 << "\": " << 
SŒ—mabËToSŒšg
(
v®ue
);

5650 ià(
	gcomma
)

5651 *
	g¡»am
 << ",\n";

5655 
	gJsÚUn™Te¡ResuÉPrš‹r
::
OuutJsÚTe¡Info
(::
¡d
::
o¡»am
* 
¡»am
,

5656 cÚ¡ * 
‹¡_su™e_Çme
,

5657 cÚ¡ 
Te¡Info
& 
‹¡_šfo
) {

5658 cÚ¡ 
	gTe¡ResuÉ
& 
	g»suÉ
 = *
‹¡_šfo
.
»suÉ
();

5659 cÚ¡ 
	g¡d
::
¡ršg
 
kTe¡su™e
 = "testcase";

5660 cÚ¡ 
	g¡d
::
¡ršg
 
kInd’t
 = 
Ind’t
(10);

5662 *
	g¡»am
 << 
Ind’t
(8) << "{\n";

5663 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "Çme", 
‹¡_šfo
.
Çme
(), 
kInd’t
);

5665 ià(
	g‹¡_šfo
.
v®ue_·¿m
(è!ğ
nuÎ±r
) {

5666 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "v®ue_·¿m", 
‹¡_šfo
.
v®ue_·¿m
(),

5667 
kInd’t
);

5669 ià(
	g‹¡_šfo
.
ty³_·¿m
(è!ğ
nuÎ±r
) {

5670 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "ty³_·¿m", 
‹¡_šfo
.
ty³_·¿m
(),

5671 
kInd’t
);

5673 ià(
GTEST_FLAG
(
li¡_‹¡s
)) {

5674 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "fe", 
‹¡_šfo
.
fe
(), 
kInd’t
);

5675 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "lše", 
‹¡_šfo
.
lše
(), 
kInd’t
, 
çl£
);

5676 *
	g¡»am
 << "\n" << 
Ind’t
(8) << "}";

5680 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "status",

5681 
‹¡_šfo
.
should_run
(è? "RUN" : "NOTRUN", 
kInd’t
);

5682 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "result",

5683 
‹¡_šfo
.
should_run
()

5684 ? (
»suÉ
.
Sk³d
() ? "SKIPPED" : "COMPLETED")

5686 
kInd’t
);

5687 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "timestamp",

5688 
FÜm©EpochTimeInMlisAsRFC3339
(
»suÉ
.
¡¬t_time¡amp
()),

5689 
kInd’t
);

5690 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "time",

5691 
FÜm©TimeInMlisAsDu¿tiÚ
(
»suÉ
.
–­£d_time
()), 
kInd’t
);

5692 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "şas¢ame", 
‹¡_su™e_Çme
, 
kInd’t
,

5693 
çl£
);

5694 *
	g¡»am
 << 
Te¡Prİ”t›sAsJsÚ
(
»suÉ
, 
kInd’t
);

5696 
	gçu»s
 = 0;

5697 
	gi
 = 0; i < 
	g»suÉ
.
tÙ®_·¹_couÁ
(); ++i) {

5698 cÚ¡ 
	gTe¡P¬tResuÉ
& 
	g·¹
 = 
»suÉ
.
G‘Te¡P¬tResuÉ
(
i
);

5699 ià(
	g·¹
.
çed
()) {

5700 *
	g¡»am
 << ",\n";

5701 ià(++
	gçu»s
 == 1) {

5702 *
¡»am
 << 
kInd’t
 << "\"" << "failures" << "\": [\n";

5704 cÚ¡ 
	g¡d
::
¡ršg
 
loÿtiÚ
 =

5705 
š‹º®
::
FÜm©Comp”Ind•’d’tFeLoÿtiÚ
(
·¹
.
fe_Çme
(),

5706 
·¹
.
lše_numb”
());

5707 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge
 = 
Esÿ³JsÚ
(
loÿtiÚ
 + "\n" + 
·¹
.message());

5708 *
	g¡»am
 << 
	gkInd’t
 << " {\n"

5709 << 
	gkInd’t
 << " \"çu»\": \"" << 
	gmes§ge
 << "\",\n"

5710 << 
	gkInd’t
 << " \"type\": \"\"\n"

5711 << 
	gkInd’t
 << " }";

5715 ià(
	gçu»s
 > 0)

5716 *
	g¡»am
 << "\n" << 
	gkInd’t
 << "]";

5717 *
	g¡»am
 << "\n" << 
Ind’t
(8) << "}";

5721 
	gJsÚUn™Te¡ResuÉPrš‹r
::
PrštJsÚTe¡Su™e
(

5722 
¡d
::
o¡»am
* 
¡»am
, cÚ¡ 
Te¡Su™e
& 
‹¡_su™e
) {

5723 cÚ¡ 
	g¡d
::
¡ršg
 
kTe¡su™e
 = "testsuite";

5724 cÚ¡ 
	g¡d
::
¡ršg
 
kInd’t
 = 
Ind’t
(6);

5726 *
	g¡»am
 << 
Ind’t
(4) << "{\n";

5727 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "Çme", 
‹¡_su™e
.
Çme
(), 
kInd’t
);

5728 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "‹¡s", 
‹¡_su™e
.
»pÜbË_‹¡_couÁ
(),

5729 
kInd’t
);

5730 ià(!
GTEST_FLAG
(
li¡_‹¡s
)) {

5731 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "failures",

5732 
‹¡_su™e
.
çed_‹¡_couÁ
(), 
kInd’t
);

5733 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "disabled",

5734 
‹¡_su™e
.
»pÜbË_di§bËd_‹¡_couÁ
(), 
kInd’t
);

5735 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "”rÜs", 0, 
kInd’t
);

5736 
OuutJsÚKey
(

5737 
¡»am
, 
kTe¡su™e
, "timestamp",

5738 
FÜm©EpochTimeInMlisAsRFC3339
(
‹¡_su™e
.
¡¬t_time¡amp
()),

5739 
kInd’t
);

5740 
OuutJsÚKey
(
¡»am
, 
kTe¡su™e
, "time",

5741 
FÜm©TimeInMlisAsDu¿tiÚ
(
‹¡_su™e
.
–­£d_time
()),

5742 
kInd’t
, 
çl£
);

5743 *
	g¡»am
 << 
Te¡Prİ”t›sAsJsÚ
(
‹¡_su™e
.
ad_hoc_‹¡_»suÉ
(), 
kInd’t
)

5747 *
	g¡»am
 << 
	gkInd’t
 << "\"" << 
	gkTe¡su™e
 << "\": [\n";

5749 
boŞ
 
	gcomma
 = 
çl£
;

5750 
	gi
 = 0; i < 
	g‹¡_su™e
.
tÙ®_‹¡_couÁ
(); ++i) {

5751 ià(
	g‹¡_su™e
.
G‘Te¡Info
(
i
)->
is_»pÜbË
()) {

5752 ià(
	gcomma
) {

5753 *
	g¡»am
 << ",\n";

5755 
	gcomma
 = 
Œue
;

5757 
OuutJsÚTe¡Info
(
¡»am
, 
‹¡_su™e
.
Çme
(), *‹¡_su™e.
G‘Te¡Info
(
i
));

5760 *
	g¡»am
 << "\n" << 
	gkInd’t
 << "]\n" << 
Ind’t
(4) << "}";

5764 
	gJsÚUn™Te¡ResuÉPrš‹r
::
PrštJsÚUn™Te¡
(
¡d
::
o¡»am
* 
¡»am
,

5765 cÚ¡ 
Un™Te¡
& 
un™_‹¡
) {

5766 cÚ¡ 
	g¡d
::
¡ršg
 
kTe¡su™es
 = "testsuites";

5767 cÚ¡ 
	g¡d
::
¡ršg
 
kInd’t
 = 
Ind’t
(2);

5768 *
	g¡»am
 << "{\n";

5770 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "‹¡s", 
un™_‹¡
.
»pÜbË_‹¡_couÁ
(),

5771 
kInd’t
);

5772 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "çu»s", 
un™_‹¡
.
çed_‹¡_couÁ
(),

5773 
kInd’t
);

5774 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "disabled",

5775 
un™_‹¡
.
»pÜbË_di§bËd_‹¡_couÁ
(), 
kInd’t
);

5776 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "”rÜs", 0, 
kInd’t
);

5777 ià(
GTEST_FLAG
(
shufæe
)) {

5778 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "¿ndom_£ed", 
un™_‹¡
.
¿ndom_£ed
(),

5779 
kInd’t
);

5781 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "timestamp",

5782 
FÜm©EpochTimeInMlisAsRFC3339
(
un™_‹¡
.
¡¬t_time¡amp
()),

5783 
kInd’t
);

5784 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "time",

5785 
FÜm©TimeInMlisAsDu¿tiÚ
(
un™_‹¡
.
–­£d_time
()), 
kInd’t
,

5786 
çl£
);

5788 *
	g¡»am
 << 
Te¡Prİ”t›sAsJsÚ
(
un™_‹¡
.
ad_hoc_‹¡_»suÉ
(), 
kInd’t
)

5791 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "Çme", "AÎTe¡s", 
kInd’t
);

5792 *
	g¡»am
 << 
	gkInd’t
 << "\"" << 
	gkTe¡su™es
 << "\": [\n";

5794 
boŞ
 
	gcomma
 = 
çl£
;

5795 
	gi
 = 0; i < 
	gun™_‹¡
.
tÙ®_‹¡_su™e_couÁ
(); ++i) {

5796 ià(
	gun™_‹¡
.
G‘Te¡Su™e
(
i
)->
»pÜbË_‹¡_couÁ
() > 0) {

5797 ià(
	gcomma
) {

5798 *
	g¡»am
 << ",\n";

5800 
	gcomma
 = 
Œue
;

5802 
PrštJsÚTe¡Su™e
(
¡»am
, *
un™_‹¡
.
G‘Te¡Su™e
(
i
));

5806 *
	g¡»am
 << "\n" << 
	gkInd’t
 << "]\n" << "}\n";

5809 
	gJsÚUn™Te¡ResuÉPrš‹r
::
PrštJsÚTe¡Li¡
(

5810 
¡d
::
o¡»am
* 
¡»am
, cÚ¡ std::
veùÜ
<
Te¡Su™e
*>& 
‹¡_su™es
) {

5811 cÚ¡ 
¡d
::
¡ršg
 
kTe¡su™es
 = "testsuites";

5812 cÚ¡ 
	g¡d
::
¡ršg
 
kInd’t
 = 
Ind’t
(2);

5813 *
	g¡»am
 << "{\n";

5814 
	gtÙ®_‹¡s
 = 0;

5815 autØ
	g‹¡_su™e
 : 
‹¡_su™es
) {

5816 
tÙ®_‹¡s
 +ğ
‹¡_su™e
->
tÙ®_‹¡_couÁ
();

5818 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "‹¡s", 
tÙ®_‹¡s
, 
kInd’t
);

5820 
OuutJsÚKey
(
¡»am
, 
kTe¡su™es
, "Çme", "AÎTe¡s", 
kInd’t
);

5821 *
	g¡»am
 << 
	gkInd’t
 << "\"" << 
	gkTe¡su™es
 << "\": [\n";

5823 
size_t
 
	gi
 = 0; i < 
	g‹¡_su™es
.
size
(); ++i) {

5824 ià(
	gi
 != 0) {

5825 *
¡»am
 << ",\n";

5827 
PrštJsÚTe¡Su™e
(
¡»am
, *
‹¡_su™es
[
i
]);

5830 *
	g¡»am
 << "\n"

5831 << 
	gkInd’t
 << "]\n"

5836 
	g¡d
::
¡ršg
 
JsÚUn™Te¡ResuÉPrš‹r
::
Te¡Prİ”t›sAsJsÚ
(

5837 cÚ¡ 
Te¡ResuÉ
& 
»suÉ
, cÚ¡ 
¡d
::
¡ršg
& 
šd’t
) {

5838 
Mes§ge
 
©Œibu‹s
;

5839 
	gi
 = 0; i < 
	g»suÉ
.
‹¡_´İ”ty_couÁ
(); ++i) {

5840 cÚ¡ 
	gTe¡Prİ”ty
& 
	g´İ”ty
 = 
»suÉ
.
G‘Te¡Prİ”ty
(
i
);

5841 
	g©Œibu‹s
 << ",\n" << 
	gšd’t
 << "\"" << 
	g´İ”ty
.
key
() << "\": "

5842 << "\"" << 
Esÿ³JsÚ
(
´İ”ty
.
v®ue
()) << "\"";

5844  
	g©Œibu‹s
.
G‘SŒšg
();

5849 #ià
GTEST_CAN_STREAM_RESULTS_


5856 
	g¡d
::
¡ršg
 
SŒ—mšgLi¡’”
::
U¾Encode
(cÚ¡ * 
¡r
) {

5857 
¡d
::
¡ršg
 
»suÉ
;

5858 
	g»suÉ
.
»£rve
(
¡¾’
(
¡r
) + 1);

5859 
	gch
 = *
¡r
; ch != '\0'; ch = *++str) {

5860 
ch
) {

5865 
»suÉ
.
­³nd
("%" + 
SŒšg
::
FÜm©By‹
(
¡©ic_ÿ¡
<>(
ch
)));

5868 
»suÉ
.
push_back
(
ch
);

5872  
	g»suÉ
;

5875 
	gSŒ—mšgLi¡’”
::
Sock‘Wr™”
::
MakeCÚÃùiÚ
() {

5876 
GTEST_CHECK_
(
sockfd_
 == -1)

5879 
addršfo
 
	ghšts
;

5880 
mem£t
(&
hšts
, 0, (hints));

5881 
	ghšts
.
	gai_çmy
 = 
AF_UNSPEC
;

5882 
	ghšts
.
	gai_sockty³
 = 
SOCK_STREAM
;

5883 
addršfo
* 
	g£rvšfo
 = 
nuÎ±r
;

5887 cÚ¡ 
	g”rÜ_num
 = 
g‘addršfo
(

5888 
ho¡_Çme_
.
c_¡r
(), 
pÜt_num_
.c_¡r(), &
hšts
, &
£rvšfo
);

5889 ià(
	g”rÜ_num
 != 0) {

5890 
GTEST_LOG_
(
WARNING
) << "stream_result_to: getaddrinfo() failed: "

5891 << 
gai_¡»¼Ü
(
”rÜ_num
);

5895 
addršfo
* 
	gcur_addr
 = 
£rvšfo
; 
	gsockfd_
 =ğ-1 && 
cur_addr
 !ğ
nuÎ±r
;

5896 
	gcur_addr
 = 
cur_addr
->
ai_Ãxt
) {

5897 
sockfd_
 = 
sock‘
(

5898 
cur_addr
->
ai_çmy
, cur_addr->
ai_sockty³
, cur_addr->
ai_´ÙocŞ
);

5899 ià(
	gsockfd_
 != -1) {

5901 ià(
cÚÃù
(
sockfd_
, 
cur_addr
->
ai_addr
, cur_addr->
ai_add¾’
) == -1) {

5902 
şo£
(
sockfd_
);

5903 
	gsockfd_
 = -1;

5908 
ä“addršfo
(
£rvšfo
);

5910 ià(
	gsockfd_
 == -1) {

5911 
GTEST_LOG_
(
WARNING
) << "stream_result_to: failedo connecto "

5912 << 
ho¡_Çme_
 << ":" << 
pÜt_num_
;

5921 cÚ¡ * cÚ¡ 
	gOsSckT¿ûG‘‹rIÁ”çû
::
kElidedF¿mesM¬k”
 =

5922 "... " 
GTEST_NAME_
 " internal frames ...";

5924 
	g¡d
::
¡ršg
 
OsSckT¿ûG‘‹r
::
Cu¼’tSckT¿û
(
max_d•th
, 
sk_couÁ
)

5925 
GTEST_LOCK_EXCLUDED_
(
mu‹x_
) {

5926 #ià
GTEST_HAS_ABSL


5927 
	g¡d
::
¡ršg
 
»suÉ
;

5929 ià(
	gmax_d•th
 <= 0) {

5930  
»suÉ
;

5933 
	gmax_d•th
 = 
¡d
::
mš
(
max_d•th
, 
kMaxSckT¿ûD•th
);

5935 
	g¡d
::
veùÜ
<*> 
¿w_¡ack
(
max_d•th
);

5937 cÚ¡ 
	g¿w_¡ack_size
 =

5938 
ab¦
::
G‘SckT¿û
(&
¿w_¡ack
[0], 
max_d•th
, 
sk_couÁ
 + 1);

5940 * 
	gÿÎ”_äame
 = 
nuÎ±r
;

5942 
Mu‹xLock
 
lock
(&
mu‹x_
);

5943 
	gÿÎ”_äame
 = 
ÿÎ”_äame_
;

5946 
	gi
 = 0; i < 
	g¿w_¡ack_size
; ++i) {

5947 ià(
	g¿w_¡ack
[
i
] =ğ
ÿÎ”_äame
 &&

5948 !
GTEST_FLAG
(
show_š‹º®_¡ack_äames
)) {

5950 
ab¦
::
SŒAµ’d
(&
»suÉ
, 
kElidedF¿mesM¬k”
, "\n");

5954 
	gtmp
[1024];

5955 cÚ¡ * 
	gsymbŞ
 = "(unknown)";

5956 ià(
	gab¦
::
SymbŞize
(
¿w_¡ack
[
i
], 
tmp
, (tmp))) {

5957 
	gsymbŞ
 = 
tmp
;

5960 
	glše
[1024];

5961 
¢´štf
(
lše
, Öše), " %p: %s\n", 
¿w_¡ack
[
i
], 
symbŞ
);

5962 
	g»suÉ
 +ğ
lše
;

5965  
	g»suÉ
;

5968 
	g¡©ic_ÿ¡
<>(
	gmax_d•th
);

5969 
	g¡©ic_ÿ¡
<>(
	gsk_couÁ
);

5974 
	gOsSckT¿ûG‘‹r
::
UpÚL—všgGTe¡
(è
GTEST_LOCK_EXCLUDED_
(
mu‹x_
) {

5975 #ià
GTEST_HAS_ABSL


5976 * 
ÿÎ”_äame
 = 
nuÎ±r
;

5977 ià(
	gab¦
::
G‘SckT¿û
(&
ÿÎ”_äame
, 1, 3) <= 0) {

5978 
ÿÎ”_äame
 = 
nuÎ±r
;

5981 
Mu‹xLock
 
lock
(&
mu‹x_
);

5982 
	gÿÎ”_äame_
 = 
ÿÎ”_äame
;

5988 şas 
	cScİedP»m©u»Ex™Fe
 {

5989 
	gpublic
:

5990 
ex¶ic™
 
ScİedP»m©u»Ex™Fe
(cÚ¡ * 
´em©u»_ex™_f•©h
)

5991 : 
´em©u»_ex™_f•©h_
(
´em©u»_ex™_f•©h
 ?

5992 
´em©u»_ex™_f•©h
 : "") {

5994 ià(!
´em©u»_ex™_f•©h_
.
em±y
()) {

5998 
FILE
* 
pfe
 = 
posix
::
FO³n
(
´em©u»_ex™_f•©h
, "w");

5999 
fwr™e
("0", 1, 1, 
pfe
);

6000 
fşo£
(
pfe
);

6004 ~
ScİedP»m©u»Ex™Fe
() {

6005 ià(!
	g´em©u»_ex™_f•©h_
.
em±y
()) {

6006 
	g»tv®
 = 
»move
(
´em©u»_ex™_f•©h_
.
c_¡r
());

6007 ià(
	g»tv®
) {

6008 
GTEST_LOG_
(
ERROR
) << "Failedo„emove…rematureƒxit filepath \""

6009 << 
	g´em©u»_ex™_f•©h_
 << "\" withƒrror "

6010 << 
	g»tv®
;

6015 
	g´iv©e
:

6016 cÚ¡ 
¡d
::
¡ršg
 
´em©u»_ex™_f•©h_
;

6018 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
ScİedP»m©u»Ex™Fe
);

6025 
	gTe¡Ev’tLi¡’”s
::
	$Te¡Ev’tLi¡’”s
()

6026 : 
	`»³©”_
(
Ãw
 
š‹º®
::
	`Te¡Ev’tR•—‹r
()),

6027 
	`deçuÉ_»suÉ_´š‹r_
(
nuÎ±r
),

6028 
	$deçuÉ_xml_g’”©Ü_
(
nuÎ±r
è{
	}
}

6030 
	gTe¡Ev’tLi¡’”s
::~
	$Te¡Ev’tLi¡’”s
(è{ 
d–‘e
 
»³©”_
; 
	}
}

6036 
	gTe¡Ev’tLi¡’”s
::
	$Aµ’d
(
Te¡Ev’tLi¡’”
* 
li¡’”
) {

6037 
»³©”_
->
	`Aµ’d
(
li¡’”
);

6038 
	}
}

6043 
Te¡Ev’tLi¡’”
* 
	gTe¡Ev’tLi¡’”s
::
	$R–—£
(
Te¡Ev’tLi¡’”
* 
li¡’”
) {

6044 ià(
li¡’”
 =ğ
deçuÉ_»suÉ_´š‹r_
)

6045 
deçuÉ_»suÉ_´š‹r_
 = 
nuÎ±r
;

6046 ià(
li¡’”
 =ğ
deçuÉ_xml_g’”©Ü_
)

6047 
deçuÉ_xml_g’”©Ü_
 = 
nuÎ±r
;

6048  
»³©”_
->
	`R–—£
(
li¡’”
);

6049 
	}
}

6053 
Te¡Ev’tLi¡’”
* 
	gTe¡Ev’tLi¡’”s
::
	$»³©”
(è{  
»³©”_
; 
	}
}

6060 
	gTe¡Ev’tLi¡’”s
::
	$S‘DeçuÉResuÉPrš‹r
(
Te¡Ev’tLi¡’”
* 
li¡’”
) {

6061 ià(
deçuÉ_»suÉ_´š‹r_
 !ğ
li¡’”
) {

6064 
d–‘e
 
	`R–—£
(
deçuÉ_»suÉ_´š‹r_
);

6065 
deçuÉ_»suÉ_´š‹r_
 = 
li¡’”
;

6066 ià(
li¡’”
 !ğ
nuÎ±r
è
	`Aµ’d
(listener);

6068 
	}
}

6075 
	gTe¡Ev’tLi¡’”s
::
	$S‘DeçuÉXmlG’”©Ü
(
Te¡Ev’tLi¡’”
* 
li¡’”
) {

6076 ià(
deçuÉ_xml_g’”©Ü_
 !ğ
li¡’”
) {

6079 
d–‘e
 
	`R–—£
(
deçuÉ_xml_g’”©Ü_
);

6080 
deçuÉ_xml_g’”©Ü_
 = 
li¡’”
;

6081 ià(
li¡’”
 !ğ
nuÎ±r
è
	`Aµ’d
(listener);

6083 
	}
}

6087 
boŞ
 
	gTe¡Ev’tLi¡’”s
::
	$Ev’tFÜw¬dšgEÇbËd
() const {

6088  
»³©”_
->
	`fÜw¬dšg_’abËd
();

6089 
	}
}

6091 
	gTe¡Ev’tLi¡’”s
::
	$Suµ»ssEv’tFÜw¬dšg
() {

6092 
»³©”_
->
	`£t_fÜw¬dšg_’abËd
(
çl£
);

6093 
	}
}

6104 
Un™Te¡
* 
	gUn™Te¡
::
	$G‘In¡ªû
() {

6109 #ià
	`defšed
(
__BORLANDC__
)

6110 
Un™Te¡
* cÚ¡ 
š¡ªû
 = 
Ãw
 UnitTest;

6111  
š¡ªû
;

6113 
Un™Te¡
 
š¡ªû
;

6114  &
š¡ªû
;

6116 
	}
}

6119 
	gUn™Te¡
::
	$sucûssful_‹¡_su™e_couÁ
() const {

6120  
	`im¶
()->
	`sucûssful_‹¡_su™e_couÁ
();

6121 
	}
}

6124 
	gUn™Te¡
::
	$çed_‹¡_su™e_couÁ
() const {

6125  
	`im¶
()->
	`çed_‹¡_su™e_couÁ
();

6126 
	}
}

6129 
	gUn™Te¡
::
	$tÙ®_‹¡_su™e_couÁ
() const {

6130  
	`im¶
()->
	`tÙ®_‹¡_su™e_couÁ
();

6131 
	}
}

6135 
	gUn™Te¡
::
	$‹¡_su™e_to_run_couÁ
() const {

6136  
	`im¶
()->
	`‹¡_su™e_to_run_couÁ
();

6137 
	}
}

6140 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


6141 
	gUn™Te¡
::
	$sucûssful_‹¡_ÿ£_couÁ
() const {

6142  
	`im¶
()->
	`sucûssful_‹¡_su™e_couÁ
();

6143 
	}
}

6144 
	gUn™Te¡
::
	$çed_‹¡_ÿ£_couÁ
() const {

6145  
	`im¶
()->
	`çed_‹¡_su™e_couÁ
();

6146 
	}
}

6147 
	gUn™Te¡
::
	$tÙ®_‹¡_ÿ£_couÁ
() const {

6148  
	`im¶
()->
	`tÙ®_‹¡_su™e_couÁ
();

6149 
	}
}

6150 
	gUn™Te¡
::
	$‹¡_ÿ£_to_run_couÁ
() const {

6151  
	`im¶
()->
	`‹¡_su™e_to_run_couÁ
();

6152 
	}
}

6156 
	gUn™Te¡
::
	$sucûssful_‹¡_couÁ
() const {

6157  
	`im¶
()->
	`sucûssful_‹¡_couÁ
();

6158 
	}
}

6161 
	gUn™Te¡
::
	$sk³d_‹¡_couÁ
() const {

6162  
	`im¶
()->
	`sk³d_‹¡_couÁ
();

6163 
	}
}

6166 
	gUn™Te¡
::
	$çed_‹¡_couÁ
(ècÚ¡ {  
	`im¶
()->
	`çed_‹¡_couÁ
(); 
	}
}

6169 
	gUn™Te¡
::
	$»pÜbË_di§bËd_‹¡_couÁ
() const {

6170  
	`im¶
()->
	`»pÜbË_di§bËd_‹¡_couÁ
();

6171 
	}
}

6174 
	gUn™Te¡
::
	$di§bËd_‹¡_couÁ
() const {

6175  
	`im¶
()->
	`di§bËd_‹¡_couÁ
();

6176 
	}
}

6179 
	gUn™Te¡
::
	$»pÜbË_‹¡_couÁ
() const {

6180  
	`im¶
()->
	`»pÜbË_‹¡_couÁ
();

6181 
	}
}

6184 
	gUn™Te¡
::
	$tÙ®_‹¡_couÁ
(ècÚ¡ {  
	`im¶
()->
	`tÙ®_‹¡_couÁ
(); 
	}
}

6187 
	gUn™Te¡
::
	$‹¡_to_run_couÁ
(ècÚ¡ {  
	`im¶
()->
	`‹¡_to_run_couÁ
(); 
	}
}

6191 
	gš‹º®
::
TimeInMlis
 
Un™Te¡
::
	$¡¬t_time¡amp
() const {

6192  
	`im¶
()->
	`¡¬t_time¡amp
();

6193 
	}
}

6196 
	gš‹º®
::
TimeInMlis
 
Un™Te¡
::
	$–­£d_time
() const {

6197  
	`im¶
()->
	`–­£d_time
();

6198 
	}
}

6202 
boŞ
 
	gUn™Te¡
::
	$Pas£d
(ècÚ¡ {  
	`im¶
()->
	`Pas£d
(); 
	}
}

6206 
boŞ
 
	gUn™Te¡
::
	$Faed
(ècÚ¡ {  
	`im¶
()->
	`Faed
(); 
	}
}

6210 cÚ¡ 
Te¡Su™e
* 
	gUn™Te¡
::
	$G‘Te¡Su™e
(
i
) const {

6211  
	`im¶
()->
	`G‘Te¡Su™e
(
i
);

6212 
	}
}

6215 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


6216 cÚ¡ 
Te¡Ca£
* 
	gUn™Te¡
::
	$G‘Te¡Ca£
(
i
) const {

6217  
	`im¶
()->
	`G‘Te¡Ca£
(
i
);

6218 
	}
}

6223 cÚ¡ 
	gTe¡ResuÉ
& 
	gUn™Te¡
::
	$ad_hoc_‹¡_»suÉ
() const {

6224  *
	`im¶
()->
	`ad_hoc_‹¡_»suÉ
();

6225 
	}
}

6229 
Te¡Su™e
* 
	gUn™Te¡
::
	$G‘MubËTe¡Su™e
(
i
) {

6230  
	`im¶
()->
	`G‘MubËSu™eCa£
(
i
);

6231 
	}
}

6235 
	gTe¡Ev’tLi¡’”s
& 
	gUn™Te¡
::
	$li¡’”s
() {

6236  *
	`im¶
()->
	`li¡’”s
();

6237 
	}
}

6249 
EnvœÚm’t
* 
	gUn™Te¡
::
	$AddEnvœÚm’t
(
EnvœÚm’t
* 
’v
) {

6250 ià(
’v
 =ğ
nuÎ±r
) {

6251  
nuÎ±r
;

6254 
im¶_
->
	`’vœÚm’ts
().
	`push_back
(
’v
);

6255  
’v
;

6256 
	}
}

6262 
	gUn™Te¡
::
	$AddTe¡P¬tResuÉ
(

6263 
Te¡P¬tResuÉ
::
Ty³
 
»suÉ_ty³
,

6264 cÚ¡ * 
fe_Çme
,

6265 
lše_numb”
,

6266 cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
,

6267 cÚ¡ 
¡d
::
¡ršg
& 
os_¡ack_Œaû
è
	$GTEST_LOCK_EXCLUDED_
(
mu‹x_
) {

6268 
Mes§ge
 
msg
;

6269 
msg
 << 
mes§ge
;

6271 
š‹º®
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

6272 ià(
im¶_
->
	`g‹¡_Œaû_¡ack
().
	`size
() > 0) {

6273 
msg
 << "\n" << 
GTEST_NAME_
 << "race:";

6275 
size_t
 
i
 = 
im¶_
->
	`g‹¡_Œaû_¡ack
().
	`size
(); i > 0; --i) {

6276 cÚ¡ 
š‹º®
::
T¿ûInfo
& 
Œaû
 = 
im¶_
->
	`g‹¡_Œaû_¡ack
()[
i
 - 1];

6277 
msg
 << "\n" << 
š‹º®
::
	`FÜm©FeLoÿtiÚ
(
Œaû
.
fe
,¿û.
lše
)

6278 << " " << 
Œaû
.
mes§ge
;

6282 ià(
os_¡ack_Œaû
.
	`c_¡r
(è!ğ
nuÎ±r
 && !os_¡ack_Œaû.
	`em±y
()) {

6283 
msg
 << 
š‹º®
::
kSckT¿ûM¬k”
 << 
os_¡ack_Œaû
;

6286 cÚ¡ 
Te¡P¬tResuÉ
 
»suÉ
 = 
	`Te¡P¬tResuÉ
(

6287 
»suÉ_ty³
, 
fe_Çme
, 
lše_numb”
, 
msg
.
	`G‘SŒšg
().
	`c_¡r
());

6288 
im¶_
->
	`G‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
()->

6289 
	`R•ÜtTe¡P¬tResuÉ
(
»suÉ
);

6291 ià(
»suÉ_ty³
 !ğ
Te¡P¬tResuÉ
::
kSucûss
 &&

6292 
»suÉ_ty³
 !ğ
Te¡P¬tResuÉ
::
kSk
) {

6298 ià(
	`GTEST_FLAG
(
b»ak_Ú_çu»
)) {

6299 #ià
GTEST_OS_WINDOWS
 && !
GTEST_OS_WINDOWS_PHONE
 && !
GTEST_OS_WINDOWS_RT


6303 
	`DebugB»ak
();

6304 #–ià(!
	`defšed
(
__Çtive_ş›Á__
)) && \

6305 ((
	`defšed
(
__şªg__
è|| defšed(
__GNUC__
)) && \

6306 (
	`defšed
(
__x86_64__
è|| defšed(
__i386__
)))

6308 
	`asm
("int3");

6313 *
¡©ic_ÿ¡
<vŞ©*>(
nuÎ±r
) = 1;

6315 } ià(
	`GTEST_FLAG
(
throw_Ú_çu»
)) {

6316 #ià
GTEST_HAS_EXCEPTIONS


6317 
throw
 
š‹º®
::
	`GoogËTe¡Fau»Exû±iÚ
(
»suÉ
);

6321 
	`ex™
(1);

6325 
	}
}

6332 
	gUn™Te¡
::
	$RecÜdPrİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
key
,

6333 cÚ¡ 
¡d
::
¡ršg
& 
v®ue
) {

6334 
im¶_
->
	`RecÜdPrİ”ty
(
	`Te¡Prİ”ty
(
key
, 
v®ue
));

6335 
	}
}

6342 
	gUn™Te¡
::
	$Run
() {

6343 cÚ¡ 
boŞ
 
š_d—th_‹¡_chd_´oûss
 =

6344 
š‹º®
::
	`GTEST_FLAG
(
š‹º®_run_d—th_‹¡
).
	`Ëngth
() > 0;

6367 cÚ¡ 
š‹º®
::
ScİedP»m©u»Ex™Fe
 
	`´em©u»_ex™_fe
(

6368 
š_d—th_‹¡_chd_´oûss


6369 ? 
nuÎ±r


6370 : 
š‹º®
::
posix
::
	`G‘Env
("TEST_PREMATURE_EXIT_FILE"));

6374 
	`im¶
()->
	`£t_ÿtch_exû±iÚs
(
	`GTEST_FLAG
(
ÿtch_exû±iÚs
));

6376 #ià
GTEST_OS_WINDOWS


6381 ià(
	`im¶
()->
	`ÿtch_exû±iÚs
(è|| 
š_d—th_‹¡_chd_´oûss
) {

6382 #ià!
GTEST_OS_WINDOWS_MOBILE
 && !
GTEST_OS_WINDOWS_PHONE
 && !
GTEST_OS_WINDOWS_RT


6384 
	`S‘E¼ÜMode
(
SEM_FAILCRITICALERRORS
 | 
SEM_NOALIGNMENTFAULTEXCEPT
 |

6385 
SEM_NOGPFAULTERRORBOX
 | 
SEM_NOOPENFILEERRORBOX
);

6388 #ià(
	`defšed
(
_MSC_VER
è|| 
GTEST_OS_WINDOWS_MINGW
è&& !
GTEST_OS_WINDOWS_MOBILE


6392 
	`_£t_”rÜ_mode
(
_OUT_TO_STDERR
);

6395 #ià
	`defšed
(
_MSC_VER
è&& !
GTEST_OS_WINDOWS_MOBILE


6401 ià(!
	`GTEST_FLAG
(
b»ak_Ú_çu»
))

6402 
	`_£t_abÜt_behaviÜ
(

6404 
_WRITE_ABORT_MSG
 | 
_CALL_REPORTFAULT
);

6411 ià(!
	`IsDebugg”P»£Á
()) {

6412 ()
	`_C¹S‘R•ÜtMode
(
_CRT_ASSERT
,

6413 
_CRTDBG_MODE_FILE
 | 
_CRTDBG_MODE_DEBUG
);

6414 ()
	`_C¹S‘R•ÜtFe
(
_CRT_ASSERT
, 
_CRTDBG_FILE_STDERR
);

6419  
š‹º®
::
	`HªdËExû±iÚsInM‘hodIfSuµÜ‹d
(

6420 
	`im¶
(),

6421 &
š‹º®
::
Un™Te¡Im¶
::
RunAÎTe¡s
,

6423 
	}
}

6427 cÚ¡ * 
	gUn™Te¡
::
	$Üigš®_wÜkšg_dœ
() const {

6428  
im¶_
->
Üigš®_wÜkšg_dœ_
.
	`c_¡r
();

6429 
	}
}

6433 cÚ¡ 
Te¡Su™e
* 
	gUn™Te¡
::
	$cu¼’t_‹¡_su™e
() const

6434 
	$GTEST_LOCK_EXCLUDED_
(
mu‹x_
) {

6435 
š‹º®
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

6436  
im¶_
->
	`cu¼’t_‹¡_su™e
();

6437 
	}
}

6440 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


6441 cÚ¡ 
Te¡Ca£
* 
	gUn™Te¡
::
	$cu¼’t_‹¡_ÿ£
() const

6442 
	$GTEST_LOCK_EXCLUDED_
(
mu‹x_
) {

6443 
š‹º®
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

6444  
im¶_
->
	`cu¼’t_‹¡_su™e
();

6445 
	}
}

6450 cÚ¡ 
Te¡Info
* 
	gUn™Te¡
::
	$cu¼’t_‹¡_šfo
() const

6451 
	$GTEST_LOCK_EXCLUDED_
(
mu‹x_
) {

6452 
š‹º®
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

6453  
im¶_
->
	`cu¼’t_‹¡_šfo
();

6454 
	}
}

6457 
	gUn™Te¡
::
	$¿ndom_£ed
(ècÚ¡ {  
im¶_
->
	`¿ndom_£ed
(); 
	}
}

6461 
	gš‹º®
::
P¬am‘”izedTe¡Su™eRegi¡ry
&

6462 
Un™Te¡
::
	$·¿m‘”ized_‹¡_»gi¡ry
(è
	$GTEST_LOCK_EXCLUDED_
(
mu‹x_
) {

6463  
im¶_
->
	`·¿m‘”ized_‹¡_»gi¡ry
();

6464 
	}
}

6467 
	gUn™Te¡
::
	$Un™Te¡
() {

6468 
im¶_
 = 
Ãw
 
š‹º®
::
	`Un™Te¡Im¶
(
this
);

6469 
	}
}

6472 
	gUn™Te¡
::~
	$Un™Te¡
() {

6473 
d–‘e
 
im¶_
;

6474 
	}
}

6478 
	gUn™Te¡
::
	$PushGTe¡T¿û
(cÚ¡ 
š‹º®
::
T¿ûInfo
& 
Œaû
)

6479 
	$GTEST_LOCK_EXCLUDED_
(
mu‹x_
) {

6480 
š‹º®
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

6481 
im¶_
->
	`g‹¡_Œaû_¡ack
().
	`push_back
(
Œaû
);

6482 
	}
}

6485 
	gUn™Te¡
::
	$PİGTe¡T¿û
()

6486 
	$GTEST_LOCK_EXCLUDED_
(
mu‹x_
) {

6487 
š‹º®
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

6488 
im¶_
->
	`g‹¡_Œaû_¡ack
().
	`pİ_back
();

6489 
	}
}

6491 
Çme¥aû
 
	gš‹º®
 {

6493 
	gUn™Te¡Im¶
::
Un™Te¡Im¶
(
Un™Te¡
* 
·»Á
)

6494 : 
·»Á_
(
·»Á
),

6495 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4355 )

6496 
deçuÉ_glob®_‹¡_·¹_»suÉ_»pÜ‹r_
(
this
),

6497 
deçuÉ_³r_th»ad_‹¡_·¹_»suÉ_»pÜ‹r_
(
this
),

6498 
GTEST_DISABLE_MSC_WARNINGS_POP_
(è
glob®_‹¡_·¹_»suÉ_»pÙ”_
(

6499 &
deçuÉ_glob®_‹¡_·¹_»suÉ_»pÜ‹r_
),

6500 
³r_th»ad_‹¡_·¹_»suÉ_»pÜ‹r_
(

6501 &
deçuÉ_³r_th»ad_‹¡_·¹_»suÉ_»pÜ‹r_
),

6502 
·¿m‘”ized_‹¡_»gi¡ry_
(),

6503 
·¿m‘”ized_‹¡s_»gi¡”ed_
(
çl£
),

6504 
Ï¡_d—th_‹¡_su™e_
(-1),

6505 
cu¼’t_‹¡_su™e_
(
nuÎ±r
),

6506 
cu¼’t_‹¡_šfo_
(
nuÎ±r
),

6507 
ad_hoc_‹¡_»suÉ_
(),

6508 
os_¡ack_Œaû_g‘‹r_
(
nuÎ±r
),

6509 
po¡_æag_·r£_š™_³rfÜmed_
(
çl£
),

6510 
¿ndom_£ed_
(0),

6511 
¿ndom_
(0),

6512 
¡¬t_time¡amp_
(0),

6513 
–­£d_time_
(0),

6514 #ià
GTEST_HAS_DEATH_TEST


6515 
d—th_‹¡_çùÜy_
(
Ãw
 
DeçuÉD—thTe¡FaùÜy
),

6518 
ÿtch_exû±iÚs_
(
çl£
) {

6519 
li¡’”s
()->
S‘DeçuÉResuÉPrš‹r
(
Ãw
 
P»‰yUn™Te¡ResuÉPrš‹r
);

6522 
	gUn™Te¡Im¶
::~
Un™Te¡Im¶
() {

6524 
FÜEach
(
‹¡_su™es_
, 
š‹º®
::
D–‘e
<
Te¡Su™e
>);

6527 
FÜEach
(
’vœÚm’ts_
, 
š‹º®
::
D–‘e
<
EnvœÚm’t
>);

6529 
d–‘e
 
	gos_¡ack_Œaû_g‘‹r_
;

6537 
	gUn™Te¡Im¶
::
RecÜdPrİ”ty
(cÚ¡ 
Te¡Prİ”ty
& 
‹¡_´İ”ty
) {

6538 
¡d
::
¡ršg
 
xml_–em’t
;

6539 
Te¡ResuÉ
* 
	g‹¡_»suÉ
;

6541 ià(
	gcu¼’t_‹¡_šfo_
 !ğ
nuÎ±r
) {

6542 
xml_–em’t
 = "testcase";

6543 
	g‹¡_»suÉ
 = &(
cu¼’t_‹¡_šfo_
->
»suÉ_
);

6544 } ià(
	gcu¼’t_‹¡_su™e_
 !ğ
nuÎ±r
) {

6545 
xml_–em’t
 = "testsuite";

6546 
	g‹¡_»suÉ
 = &(
cu¼’t_‹¡_su™e_
->
ad_hoc_‹¡_»suÉ_
);

6548 
	gxml_–em’t
 = "testsuites";

6549 
	g‹¡_»suÉ
 = &
ad_hoc_‹¡_»suÉ_
;

6551 
	g‹¡_»suÉ
->
RecÜdPrİ”ty
(
xml_–em’t
, 
‹¡_´İ”ty
);

6554 #ià
GTEST_HAS_DEATH_TEST


6557 
	gUn™Te¡Im¶
::
Suµ»ssTe¡Ev’tsIfInSub´oûss
() {

6558 ià(
š‹º®_run_d—th_‹¡_æag_
.
g‘
(è!ğ
nuÎ±r
)

6559 
li¡’”s
()->
Suµ»ssEv’tFÜw¬dšg
();

6565 
	gUn™Te¡Im¶
::
CÚfigu»XmlOuut
() {

6566 cÚ¡ 
¡d
::
¡ršg
& 
ouut_fÜm©
 = 
Un™Te¡O±iÚs
::
G‘OuutFÜm©
();

6567 ià(
	gouut_fÜm©
 == "xml") {

6568 
li¡’”s
()->
S‘DeçuÉXmlG’”©Ü
(
Ãw
 
XmlUn™Te¡ResuÉPrš‹r
(

6569 
Un™Te¡O±iÚs
::
G‘AbsŞu‹P©hToOuutFe
().
c_¡r
()));

6570 } ià(
	gouut_fÜm©
 == "json") {

6571 
li¡’”s
()->
S‘DeçuÉXmlG’”©Ü
(
Ãw
 
JsÚUn™Te¡ResuÉPrš‹r
(

6572 
Un™Te¡O±iÚs
::
G‘AbsŞu‹P©hToOuutFe
().
c_¡r
()));

6573 } ià(
	gouut_fÜm©
 != "") {

6574 
GTEST_LOG_
(
WARNING
) << "WARNING: unrecognized output format \""

6575 << 
ouut_fÜm©
 << "\" ignored.";

6579 #ià
GTEST_CAN_STREAM_RESULTS_


6582 
	gUn™Te¡Im¶
::
CÚfigu»SŒ—mšgOuut
() {

6583 cÚ¡ 
¡d
::
¡ršg
& 
rg‘
 = 
GTEST_FLAG
(
¡»am_»suÉ_to
);

6584 ià(!
	grg‘
.
em±y
()) {

6585 cÚ¡ 
size_t
 
	gpos
 = 
rg‘
.
fšd
(':');

6586 ià(
	gpos
 !ğ
¡d
::
¡ršg
::
Åos
) {

6587 
li¡’”s
()->
Aµ’d
(
Ãw
 
SŒ—mšgLi¡’”
(
rg‘
.
sub¡r
(0, 
pos
),

6588 
rg‘
.
sub¡r
(
pos
+1)));

6590 
GTEST_LOG_
(
WARNING
è<< "uÄecognized sŒ—mšg¬g‘ \"" << 
	grg‘


6602 
	gUn™Te¡Im¶
::
Po¡FÏgP¬sšgIn™
() {

6604 ià(!
po¡_æag_·r£_š™_³rfÜmed_
) {

6605 
po¡_æag_·r£_š™_³rfÜmed_
 = 
Œue
;

6607 #ià
defšed
(
GTEST_CUSTOM_TEST_EVENT_LISTENER_
)

6609 
li¡’”s
()->
Aµ’d
(
Ãw
 
GTEST_CUSTOM_TEST_EVENT_LISTENER_
());

6612 #ià
GTEST_HAS_DEATH_TEST


6613 
In™D—thTe¡Sub´oûssCÚŒŞInfo
();

6614 
Suµ»ssTe¡Ev’tsIfInSub´oûss
();

6620 
Regi¡”P¬am‘”izedTe¡s
();

6624 
CÚfigu»XmlOuut
();

6626 #ià
GTEST_CAN_STREAM_RESULTS_


6628 
CÚfigu»SŒ—mšgOuut
();

6631 #ià
GTEST_HAS_ABSL


6632 ià(
GTEST_FLAG
(
š¡®l_çu»_sigÇl_hªdËr
)) {

6633 
	gab¦
::
Fau»SigÇlHªdËrO±iÚs
 
İtiÚs
;

6634 
	gab¦
::
In¡®lFau»SigÇlHªdËr
(
İtiÚs
);

6648 şas 
	cTe¡Su™eNameIs
 {

6649 
	gpublic
:

6651 
ex¶ic™
 
Te¡Su™eNameIs
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
è: 
Çme_
(name) {}

6654 
boŞ
 
İ”©Ü
()(cÚ¡ 
Te¡Su™e
* 
‹¡_su™e
) const {

6655  
‹¡_su™e
 !ğ
nuÎ±r
 &&

6656 
¡rcmp
(
‹¡_su™e
->
Çme
(), 
Çme_
.
c_¡r
()) == 0;

6659 
	g´iv©e
:

6660 
¡d
::
¡ršg
 
Çme_
;

6675 
Te¡Su™e
* 
	gUn™Te¡Im¶
::
G‘Te¡Su™e
(

6676 cÚ¡ * 
‹¡_su™e_Çme
, cÚ¡ * 
ty³_·¿m
,

6677 
š‹º®
::
S‘UpTe¡Su™eFunc
 
£t_up_tc
,

6678 
š‹º®
::
T—rDownTe¡Su™eFunc
 
‹¬_down_tc
) {

6680 cÚ¡‡utØ
‹¡_su™e
 =

6681 
¡d
::
fšd_if
(
‹¡_su™es_
.
rbegš
(),e¡_su™es_.
»nd
(),

6682 
Te¡Su™eNameIs
(
‹¡_su™e_Çme
));

6684 ià(
	g‹¡_su™e
 !ğ
‹¡_su™es_
.
»nd
()è *
‹¡_su™e
;

6687 auto* cÚ¡ 
	gÃw_‹¡_su™e
 =

6688 
Ãw
 
Te¡Su™e
(
‹¡_su™e_Çme
, 
ty³_·¿m
, 
£t_up_tc
, 
‹¬_down_tc
);

6691 ià(
	gš‹º®
::
Un™Te¡O±iÚs
::
M©chesF‹r
(
‹¡_su™e_Çme
,

6692 
kD—thTe¡Su™eF‹r
)) {

6697 ++
	gÏ¡_d—th_‹¡_su™e_
;

6698 
	g‹¡_su™es_
.
š£¹
(
‹¡_su™es_
.
begš
(è+ 
Ï¡_d—th_‹¡_su™e_
,

6699 
Ãw_‹¡_su™e
);

6702 
	g‹¡_su™es_
.
push_back
(
Ãw_‹¡_su™e
);

6705 
	g‹¡_su™e_šdiûs_
.
push_back
(
¡©ic_ÿ¡
<>(
‹¡_su™e_šdiûs_
.
size
()));

6706  
	gÃw_‹¡_su™e
;

6711 
S‘UpEnvœÚm’t
(
EnvœÚm’t
* 
’v
è{ 
	g’v
->
S‘Up
(); }

6712 
T—rDownEnvœÚm’t
(
EnvœÚm’t
* 
’v
è{ 
	g’v
->
T—rDown
(); }

6723 
boŞ
 
	gUn™Te¡Im¶
::
RunAÎTe¡s
() {

6726 cÚ¡ 
boŞ
 
g‹¡_is_š™Ÿlized_befÜe_run_®l_‹¡s
 = 
GTe¡IsIn™Ÿlized
();

6729 ià(
	gg_h–p_æag
)

6730  
	gŒue
;

6734 
Po¡FÏgP¬sšgIn™
();

6739 
	gš‹º®
::
Wr™eToSh¬dStusFeIfN“ded
();

6743 
boŞ
 
	gš_sub´oûss_fÜ_d—th_‹¡
 = 
çl£
;

6745 #ià
GTEST_HAS_DEATH_TEST


6746 
	gš_sub´oûss_fÜ_d—th_‹¡
 =

6747 (
š‹º®_run_d—th_‹¡_æag_
.
g‘
(è!ğ
nuÎ±r
);

6748 #ià
defšed
(
GTEST_EXTRA_DEATH_TEST_CHILD_SETUP_
)

6749 ià(
	gš_sub´oûss_fÜ_d—th_‹¡
) {

6750 
GTEST_EXTRA_DEATH_TEST_CHILD_SETUP_
();

6755 cÚ¡ 
boŞ
 
	gshould_sh¬d
 = 
ShouldSh¬d
(
kTe¡TÙ®Sh¬ds
, 
kTe¡Sh¬dIndex
,

6756 
š_sub´oûss_fÜ_d—th_‹¡
);

6760 cÚ¡ 
boŞ
 
	ghas_‹¡s_to_run
 = 
F‹rTe¡s
(
should_sh¬d


6761 ? 
HONOR_SHARDING_PROTOCOL


6762 : 
IGNORE_SHARDING_PROTOCOL
) > 0;

6765 ià(
GTEST_FLAG
(
li¡_‹¡s
)) {

6767 
Li¡Te¡sM©chšgF‹r
();

6768  
	gŒue
;

6771 
	g¿ndom_£ed_
 = 
GTEST_FLAG
(
shufæe
) ?

6772 
G‘RªdomS“dFromFÏg
(
GTEST_FLAG
(
¿ndom_£ed
)) : 0;

6775 
boŞ
 
	gçed
 = 
çl£
;

6777 
Te¡Ev’tLi¡’”
* 
	g»³©”
 = 
li¡’”s
()->
»³©”
();

6779 
	g¡¬t_time¡amp_
 = 
G‘TimeInMlis
();

6780 
	g»³©”
->
OnTe¡Prog¿mS¹
(*
·»Á_
);

6784 cÚ¡ 
	g»³©
 = 
š_sub´oûss_fÜ_d—th_‹¡
 ? 1 : 
GTEST_FLAG
(
»³©
);

6786 cÚ¡ 
boŞ
 
	gg‹¡_»³©_fÜev”
 = 
»³©
 < 0;

6787 
	gi
 = 0; 
	gg‹¡_»³©_fÜev”
 || i !ğ
»³©
; i++) {

6790 
CË¬NÚAdHocTe¡ResuÉ
();

6792 cÚ¡ 
TimeInMlis
 
	g¡¬t
 = 
G‘TimeInMlis
();

6795 ià(
	ghas_‹¡s_to_run
 && 
GTEST_FLAG
(
shufæe
)) {

6796 
¿ndom
()->
Re£ed
(
¡©ic_ÿ¡
<
UIÁ32
>(
¿ndom_£ed_
));

6800 
ShufæeTe¡s
();

6804 
	g»³©”
->
OnTe¡I‹¿tiÚS¹
(*
·»Á_
, 
i
);

6807 ià(
	ghas_‹¡s_to_run
) {

6809 
	g»³©”
->
OnEnvœÚm’tsS‘UpS¹
(*
·»Á_
);

6810 
FÜEach
(
’vœÚm’ts_
, 
S‘UpEnvœÚm’t
);

6811 
	g»³©”
->
OnEnvœÚm’tsS‘UpEnd
(*
·»Á_
);

6815 ià(
	gTe¡
::
IsSk³d
()) {

6818 
Te¡ResuÉ
& 
‹¡_»suÉ
 =

6819 *
š‹º®
::
G‘Un™Te¡Im¶
()->
cu¼’t_‹¡_»suÉ
();

6820 
	gj
 = 0; j < 
	g‹¡_»suÉ
.
tÙ®_·¹_couÁ
(); ++j) {

6821 cÚ¡ 
	gTe¡P¬tResuÉ
& 
	g‹¡_·¹_»suÉ
 =

6822 
‹¡_»suÉ
.
G‘Te¡P¬tResuÉ
(
j
);

6823 ià(
	g‹¡_·¹_»suÉ
.
ty³
(è=ğ
Te¡P¬tResuÉ
::
kSk
) {

6824 cÚ¡ 
¡d
::
¡ršg
& 
»suÉ
 = 
‹¡_·¹_»suÉ
.
mes§ge
();

6825 
´štf
("%s\n", 
»suÉ
.
c_¡r
());

6828 
fæush
(
¡dout
);

6829 } ià(!
	gTe¡
::
HasF©®Fau»
()) {

6830 
‹¡_šdex
 = 0; 
	g‹¡_šdex
 < 
tÙ®_‹¡_su™e_couÁ
();

6831 
	g‹¡_šdex
++) {

6832 
G‘MubËSu™eCa£
(
‹¡_šdex
)->
Run
();

6837 
	g»³©”
->
OnEnvœÚm’tsT—rDownS¹
(*
·»Á_
);

6838 
	g¡d
::
fÜ_—ch
(
’vœÚm’ts_
.
rbegš
(),ƒnvœÚm’ts_.
»nd
(),

6839 
T—rDownEnvœÚm’t
);

6840 
	g»³©”
->
OnEnvœÚm’tsT—rDownEnd
(*
·»Á_
);

6843 
	g–­£d_time_
 = 
G‘TimeInMlis
(è- 
¡¬t
;

6846 
	g»³©”
->
OnTe¡I‹¿tiÚEnd
(*
·»Á_
, 
i
);

6849 ià(!
Pas£d
()) {

6850 
	gçed
 = 
Œue
;

6859 
UnshufæeTe¡s
();

6861 ià(
GTEST_FLAG
(
shufæe
)) {

6863 
	g¿ndom_£ed_
 = 
G‘NextRªdomS“d
(
¿ndom_£ed_
);

6867 
	g»³©”
->
OnTe¡Prog¿mEnd
(*
·»Á_
);

6869 ià(!
	gg‹¡_is_š™Ÿlized_befÜe_run_®l_‹¡s
) {

6870 
CŞÜedPrštf
(

6871 
COLOR_RED
,

6873 "Thi ‹¡…rog¿m did NOT c®È" 
GTEST_INIT_GOOGLE_TEST_NAME_


6874 "(èbefÜÿÎšg RUN_ALL_TESTS(). Thi i INVALID. SoÚ " 
GTEST_NAME_


6877 #ià
GTEST_FOR_GOOGLE_


6878 
CŞÜedPrštf
(
COLOR_RED
,

6883  !
	gçed
;

6890 
Wr™eToSh¬dStusFeIfN“ded
() {

6891 cÚ¡ * cÚ¡ 
	g‹¡_sh¬d_fe
 = 
posix
::
G‘Env
(
kTe¡Sh¬dStusFe
);

6892 ià(
	g‹¡_sh¬d_fe
 !ğ
nuÎ±r
) {

6893 
FILE
* cÚ¡ 
fe
 = 
posix
::
FO³n
(
‹¡_sh¬d_fe
, "w");

6894 ià(
	gfe
 =ğ
nuÎ±r
) {

6895 
CŞÜedPrštf
(
COLOR_RED
,

6898 
‹¡_sh¬d_fe
, 
kTe¡Sh¬dStusFe
);

6899 
fæush
(
¡dout
);

6900 
ex™
(
EXIT_FAILURE
);

6902 
fşo£
(
fe
);

6912 
boŞ
 
ShouldSh¬d
(cÚ¡ * 
tÙ®_sh¬ds_’v
,

6913 cÚ¡ * 
sh¬d_šdex_’v
,

6914 
boŞ
 
š_sub´oûss_fÜ_d—th_‹¡
) {

6915 ià(
	gš_sub´oûss_fÜ_d—th_‹¡
) {

6916  
	gçl£
;

6919 cÚ¡ 
IÁ32
 
	gtÙ®_sh¬ds
 = 
IÁ32FromEnvOrD›
(
tÙ®_sh¬ds_’v
, -1);

6920 cÚ¡ 
IÁ32
 
	gsh¬d_šdex
 = 
IÁ32FromEnvOrD›
(
sh¬d_šdex_’v
, -1);

6922 ià(
	gtÙ®_sh¬ds
 =ğ-1 && 
sh¬d_šdex
 == -1) {

6923  
çl£
;

6924 } ià(
	gtÙ®_sh¬ds
 =ğ-1 && 
sh¬d_šdex
 != -1) {

6925 cÚ¡ 
Mes§ge
 
msg
 = Message()

6927 << 
kTe¡Sh¬dIndex
 << " = " << 
sh¬d_šdex


6928 << ", buˆhavËá " << 
kTe¡TÙ®Sh¬ds
 << " unset.\n";

6929 
CŞÜedPrštf
(
COLOR_RED
, "%s", 
msg
.
G‘SŒšg
().
c_¡r
());

6930 
fæush
(
¡dout
);

6931 
ex™
(
EXIT_FAILURE
);

6932 } ià(
	gtÙ®_sh¬ds
 !ğ-1 && 
sh¬d_šdex
 == -1) {

6933 cÚ¡ 
Mes§ge
 
msg
 = Message()

6935 << 
kTe¡TÙ®Sh¬ds
 << " = " << 
tÙ®_sh¬ds


6936 << ", buˆhavËá " << 
kTe¡Sh¬dIndex
 << " unset.\n";

6937 
CŞÜedPrštf
(
COLOR_RED
, "%s", 
msg
.
G‘SŒšg
().
c_¡r
());

6938 
fæush
(
¡dout
);

6939 
ex™
(
EXIT_FAILURE
);

6940 } ià(
	gsh¬d_šdex
 < 0 || sh¬d_šdex >ğ
tÙ®_sh¬ds
) {

6941 cÚ¡ 
Mes§ge
 
msg
 = Message()

6943 << 
kTe¡Sh¬dIndex
 << " < " << 
kTe¡TÙ®Sh¬ds


6944 << ", buˆyou hav" << 
kTe¡Sh¬dIndex
 << "=" << 
sh¬d_šdex


6945 << ", " << 
kTe¡TÙ®Sh¬ds
 << "=" << 
tÙ®_sh¬ds
 << ".\n";

6946 
CŞÜedPrštf
(
COLOR_RED
, "%s", 
msg
.
G‘SŒšg
().
c_¡r
());

6947 
fæush
(
¡dout
);

6948 
ex™
(
EXIT_FAILURE
);

6951  
	gtÙ®_sh¬ds
 > 1;

6957 
IÁ32
 
IÁ32FromEnvOrD›
(cÚ¡ * 
v¬
, IÁ32 
deçuÉ_v®
) {

6958 cÚ¡ * 
	g¡r_v®
 = 
posix
::
G‘Env
(
v¬
);

6959 ià(
	g¡r_v®
 =ğ
nuÎ±r
) {

6960  
deçuÉ_v®
;

6963 
IÁ32
 
	g»suÉ
;

6964 ià(!
P¬£IÁ32
(
Mes§ge
(è<< "Thv®uoà’vœÚm’ˆv¬ŸbË " << 
v¬
,

6965 
¡r_v®
, &
»suÉ
)) {

6966 
ex™
(
EXIT_FAILURE
);

6968  
	g»suÉ
;

6975 
boŞ
 
ShouldRunTe¡OnSh¬d
(
tÙ®_sh¬ds
, 
sh¬d_šdex
, 
‹¡_id
) {

6976  (
	g‹¡_id
 % 
	gtÙ®_sh¬ds
è=ğ
sh¬d_šdex
;

6986 
	gUn™Te¡Im¶
::
F‹rTe¡s
(
R—ùiÚToSh¬dšg
 
sh¬d_‹¡s
) {

6987 cÚ¡ 
IÁ32
 
tÙ®_sh¬ds
 = 
sh¬d_‹¡s
 =ğ
HONOR_SHARDING_PROTOCOL
 ?

6988 
IÁ32FromEnvOrD›
(
kTe¡TÙ®Sh¬ds
, -1) : -1;

6989 cÚ¡ 
IÁ32
 
	gsh¬d_šdex
 = 
sh¬d_‹¡s
 =ğ
HONOR_SHARDING_PROTOCOL
 ?

6990 
IÁ32FromEnvOrD›
(
kTe¡Sh¬dIndex
, -1) : -1;

6996 
	gnum_ruÂabË_‹¡s
 = 0;

6997 
	gnum_£Ëùed_‹¡s
 = 0;

6998 auto* 
	g‹¡_su™e
 : 
‹¡_su™es_
) {

6999 cÚ¡ 
¡d
::
¡ršg
& 
‹¡_su™e_Çme
 = 
‹¡_su™e
->
Çme
();

7000 
	g‹¡_su™e
->
£t_should_run
(
çl£
);

7002 
size_t
 
	gj
 = 0; j < 
	g‹¡_su™e
->
‹¡_šfo_li¡
().
size
(); j++) {

7003 
Te¡Info
* cÚ¡ 
	g‹¡_šfo
 = 
‹¡_su™e
->
‹¡_šfo_li¡
()[
j
];

7004 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_Çme
(
‹¡_šfo
->
Çme
());

7007 cÚ¡ 
boŞ
 
	gis_di§bËd
 = 
š‹º®
::
Un™Te¡O±iÚs
::
M©chesF‹r
(

7008 
‹¡_su™e_Çme
, 
kDi§bËTe¡F‹r
) ||

7009 
	gš‹º®
::
Un™Te¡O±iÚs
::
M©chesF‹r
(

7010 
‹¡_Çme
, 
kDi§bËTe¡F‹r
);

7011 
	g‹¡_šfo
->
	gis_di§bËd_
 = 
is_di§bËd
;

7013 cÚ¡ 
boŞ
 
	gm©ches_f‹r
 = 
š‹º®
::
Un™Te¡O±iÚs
::
F‹rM©chesTe¡
(

7014 
‹¡_su™e_Çme
, 
‹¡_Çme
);

7015 
	g‹¡_šfo
->
	gm©ches_f‹r_
 = 
m©ches_f‹r
;

7017 cÚ¡ 
boŞ
 
	gis_ruÂabË
 =

7018 (
GTEST_FLAG
(
®so_run_di§bËd_‹¡s
è|| !
is_di§bËd
) &&

7019 
m©ches_f‹r
;

7021 cÚ¡ 
boŞ
 
	gis_š_ªÙh”_sh¬d
 =

7022 
sh¬d_‹¡s
 !ğ
IGNORE_SHARDING_PROTOCOL
 &&

7023 !
ShouldRunTe¡OnSh¬d
(
tÙ®_sh¬ds
, 
sh¬d_šdex
, 
num_ruÂabË_‹¡s
);

7024 
	g‹¡_šfo
->
	gis_š_ªÙh”_sh¬d_
 = 
is_š_ªÙh”_sh¬d
;

7025 cÚ¡ 
boŞ
 
	gis_£Ëùed
 = 
is_ruÂabË
 && !
is_š_ªÙh”_sh¬d
;

7027 
	gnum_ruÂabË_‹¡s
 +ğ
is_ruÂabË
;

7028 
	gnum_£Ëùed_‹¡s
 +ğ
is_£Ëùed
;

7030 
	g‹¡_šfo
->
	gshould_run_
 = 
is_£Ëùed
;

7031 
	g‹¡_su™e
->
£t_should_run
(
‹¡_su™e
->
should_run
(è|| 
is_£Ëùed
);

7034  
	gnum_£Ëùed_‹¡s
;

7041 
PrštOnOÃLše
(cÚ¡ * 
¡r
, 
max_Ëngth
) {

7042 ià(
	g¡r
 !ğ
nuÎ±r
) {

7043 
i
 = 0; *
	g¡r
 != '\0'; ++str) {

7044 ià(
	gi
 >ğ
max_Ëngth
) {

7045 
´štf
("...");

7048 ià(*
	g¡r
 == '\n') {

7049 
´štf
("\\n");

7050 
	gi
 += 2;

7052 
´štf
("%c", *
¡r
);

7053 ++
	gi
;

7060 
	gUn™Te¡Im¶
::
Li¡Te¡sM©chšgF‹r
() {

7062 cÚ¡ 
kMaxP¬amL’gth
 = 250;

7064 auto* 
	g‹¡_su™e
 : 
‹¡_su™es_
) {

7065 
boŞ
 
´š‹d_‹¡_su™e_Çme
 = 
çl£
;

7067 
size_t
 
	gj
 = 0; j < 
	g‹¡_su™e
->
‹¡_šfo_li¡
().
size
(); j++) {

7068 cÚ¡ 
Te¡Info
* cÚ¡ 
	g‹¡_šfo
 = 
‹¡_su™e
->
‹¡_šfo_li¡
()[
j
];

7069 ià(
	g‹¡_šfo
->
	gm©ches_f‹r_
) {

7070 ià(!
	g´š‹d_‹¡_su™e_Çme
) {

7071 
	g´š‹d_‹¡_su™e_Çme
 = 
Œue
;

7072 
´štf
("%s.", 
‹¡_su™e
->
Çme
());

7073 ià(
	g‹¡_su™e
->
ty³_·¿m
(è!ğ
nuÎ±r
) {

7074 
´štf
(" # % ğ", 
kTy³P¬amLab–
);

7077 
PrštOnOÃLše
(
‹¡_su™e
->
ty³_·¿m
(), 
kMaxP¬amL’gth
);

7079 
´štf
("\n");

7081 
´štf
(" %s", 
‹¡_šfo
->
Çme
());

7082 ià(
	g‹¡_šfo
->
v®ue_·¿m
(è!ğ
nuÎ±r
) {

7083 
´štf
(" # % ğ", 
kV®ueP¬amLab–
);

7086 
PrštOnOÃLše
(
‹¡_šfo
->
v®ue_·¿m
(), 
kMaxP¬amL’gth
);

7088 
´štf
("\n");

7092 
fæush
(
¡dout
);

7093 cÚ¡ 
	g¡d
::
¡ršg
& 
ouut_fÜm©
 = 
Un™Te¡O±iÚs
::
G‘OuutFÜm©
();

7094 ià(
	gouut_fÜm©
 =ğ"xml" || 
ouut_fÜm©
 == "json") {

7095 
FILE
* 
feout
 = 
O³nFeFÜWr™šg
(

7096 
Un™Te¡O±iÚs
::
G‘AbsŞu‹P©hToOuutFe
().
c_¡r
());

7097 
	g¡d
::
¡ršg¡»am
 
¡»am
;

7098 ià(
	gouut_fÜm©
 == "xml") {

7099 
XmlUn™Te¡ResuÉPrš‹r
(

7100 
Un™Te¡O±iÚs
::
G‘AbsŞu‹P©hToOuutFe
().
c_¡r
())

7101 .
PrštXmlTe¡sLi¡
(&
¡»am
, 
‹¡_su™es_
);

7102 } ià(
	gouut_fÜm©
 == "json") {

7103 
JsÚUn™Te¡ResuÉPrš‹r
(

7104 
Un™Te¡O±iÚs
::
G‘AbsŞu‹P©hToOuutFe
().
c_¡r
())

7105 .
PrštJsÚTe¡Li¡
(&
¡»am
, 
‹¡_su™es_
);

7107 
årštf
(
feout
, "%s", 
SŒšgSŒ—mToSŒšg
(&
¡»am
).
c_¡r
());

7108 
fşo£
(
feout
);

7117 
	gUn™Te¡Im¶
::
£t_os_¡ack_Œaû_g‘‹r
(

7118 
OsSckT¿ûG‘‹rIÁ”çû
* 
g‘‹r
) {

7119 ià(
os_¡ack_Œaû_g‘‹r_
 !ğ
g‘‹r
) {

7120 
d–‘e
 
os_¡ack_Œaû_g‘‹r_
;

7121 
	gos_¡ack_Œaû_g‘‹r_
 = 
g‘‹r
;

7128 
OsSckT¿ûG‘‹rIÁ”çû
* 
	gUn™Te¡Im¶
::
os_¡ack_Œaû_g‘‹r
() {

7129 ià(
os_¡ack_Œaû_g‘‹r_
 =ğ
nuÎ±r
) {

7130 #ifdeà
GTEST_OS_STACK_TRACE_GETTER_


7131 
os_¡ack_Œaû_g‘‹r_
 = 
Ãw
 
GTEST_OS_STACK_TRACE_GETTER_
;

7133 
	gos_¡ack_Œaû_g‘‹r_
 = 
Ãw
 
OsSckT¿ûG‘‹r
;

7137  
	gos_¡ack_Œaû_g‘‹r_
;

7141 
Te¡ResuÉ
* 
	gUn™Te¡Im¶
::
cu¼’t_‹¡_»suÉ
() {

7142 ià(
cu¼’t_‹¡_šfo_
 !ğ
nuÎ±r
) {

7143  &
cu¼’t_‹¡_šfo_
->
»suÉ_
;

7145 ià(
	gcu¼’t_‹¡_su™e_
 !ğ
nuÎ±r
) {

7146  &
cu¼’t_‹¡_su™e_
->
ad_hoc_‹¡_»suÉ_
;

7148  &
	gad_hoc_‹¡_»suÉ_
;

7153 
	gUn™Te¡Im¶
::
ShufæeTe¡s
() {

7155 
ShufæeRªge
(
¿ndom
(), 0, 
Ï¡_d—th_‹¡_su™e_
 + 1, &
‹¡_su™e_šdiûs_
);

7158 
ShufæeRªge
(
¿ndom
(), 
Ï¡_d—th_‹¡_su™e_
 + 1,

7159 
¡©ic_ÿ¡
<>(
‹¡_su™es_
.
size
()), &
‹¡_su™e_šdiûs_
);

7162 auto& 
	g‹¡_su™e
 : 
‹¡_su™es_
) {

7163 
‹¡_su™e
->
ShufæeTe¡s
(
¿ndom
());

7168 
	gUn™Te¡Im¶
::
UnshufæeTe¡s
() {

7169 
size_t
 
i
 = 0; 
	gi
 < 
	g‹¡_su™es_
.
size
(); i++) {

7171 
	g‹¡_su™es_
[
i
]->
UnshufæeTe¡s
();

7173 
	g‹¡_su™e_šdiûs_
[
i
] = 
¡©ic_ÿ¡
<>(i);

7187 
	g¡d
::
¡ršg
 
G‘Cu¼’tOsSckT¿ûExû±Tİ
(
Un™Te¡
* ,

7188 
sk_couÁ
) {

7191  
G‘Un™Te¡Im¶
()->
Cu¼’tOsSckT¿ûExû±Tİ
(
sk_couÁ
 + 1);

7196 
	gÇme¥aû
 {

7197 şas 
	cCÏssUniqueToAlwaysTrue
 {};

7200 
boŞ
 
IsTrue
(boŞ 
cÚd™iÚ
è{  
	gcÚd™iÚ
; }

7202 
boŞ
 
AlwaysTrue
() {

7203 #ià
GTEST_HAS_EXCEPTIONS


7206 ià(
IsTrue
(
çl£
))

7207 
throw
 
CÏssUniqueToAlwaysTrue
();

7209  
	gŒue
;

7215 
boŞ
 
SkP»fix
(cÚ¡ * 
´efix
, cÚ¡ ** 
p¡r
) {

7216 cÚ¡ 
size_t
 
	g´efix_Ën
 = 
¡¾’
(
´efix
);

7217 ià(
¡ºcmp
(*
p¡r
, 
´efix
, 
´efix_Ën
) == 0) {

7218 *
p¡r
 +ğ
´efix_Ën
;

7219  
	gŒue
;

7221  
	gçl£
;

7229 cÚ¡ * 
P¬£FÏgV®ue
(cÚ¡ * 
¡r
, cÚ¡ * 
æag
,

7230 
boŞ
 
def_İtiÚ®
) {

7232 ià(
	g¡r
 =ğ
nuÎ±r
 || 
æag
 ==‚ullptr) ‚ullptr;

7235 cÚ¡ 
	g¡d
::
¡ršg
 
æag_¡r
 = 
¡d
::¡ršg("--"è+ 
GTEST_FLAG_PREFIX_
 + 
æag
;

7236 cÚ¡ 
size_t
 
	gæag_Ën
 = 
æag_¡r
.
Ëngth
();

7237 ià(
¡ºcmp
(
¡r
, 
æag_¡r
.
c_¡r
(), 
æag_Ën
è!ğ0è 
nuÎ±r
;

7240 cÚ¡ * 
	gæag_’d
 = 
¡r
 + 
æag_Ën
;

7243 ià(
	gdef_İtiÚ®
 && (
	gæag_’d
[0] == '\0')) {

7244  
æag_’d
;

7250 ià(
	gæag_’d
[0] !ğ'='è 
nuÎ±r
;

7253  
	gæag_’d
 + 1;

7266 
boŞ
 
P¬£BoŞFÏg
(cÚ¡ * 
¡r
, cÚ¡ * 
æag
, boŞ* 
v®ue
) {

7268 cÚ¡ * cÚ¡ 
	gv®ue_¡r
 = 
P¬£FÏgV®ue
(
¡r
, 
æag
, 
Œue
);

7271 ià(
	gv®ue_¡r
 =ğ
nuÎ±r
è 
çl£
;

7274 *
	gv®ue
 = !(*
v®ue_¡r
 == '0' || *value_str == 'f' || *value_str == 'F');

7275  
	gŒue
;

7283 
boŞ
 
P¬£IÁ32FÏg
(cÚ¡ * 
¡r
, cÚ¡ * 
æag
, 
IÁ32
* 
v®ue
) {

7285 cÚ¡ * cÚ¡ 
	gv®ue_¡r
 = 
P¬£FÏgV®ue
(
¡r
, 
æag
, 
çl£
);

7288 ià(
	gv®ue_¡r
 =ğ
nuÎ±r
è 
çl£
;

7291  
P¬£IÁ32
(
Mes§ge
(è<< "Thv®uoàæag --" << 
æag
,

7292 
v®ue_¡r
, 
v®ue
);

7300 
	g‹m¶©e
 <
ty³Çme
 
	gSŒšg
>

7301 
boŞ
 
P¬£SŒšgFÏg
(cÚ¡ * 
¡r
, cÚ¡ * 
æag
, 
SŒšg
* 
v®ue
) {

7303 cÚ¡ * cÚ¡ 
	gv®ue_¡r
 = 
P¬£FÏgV®ue
(
¡r
, 
æag
, 
çl£
);

7306 ià(
	gv®ue_¡r
 =ğ
nuÎ±r
è 
çl£
;

7309 *
	gv®ue
 = 
v®ue_¡r
;

7310  
	gŒue
;

7319 
boŞ
 
HasGoogËTe¡FÏgP»fix
(cÚ¡ * 
¡r
) {

7320  (
SkP»fix
("--", &
¡r
) ||

7321 
SkP»fix
("-", &
¡r
) ||

7322 
SkP»fix
("/", &
¡r
)) &&

7323 !
SkP»fix
(
GTEST_FLAG_PREFIX_
 "š‹º®_", &
¡r
) &&

7324 (
SkP»fix
(
GTEST_FLAG_PREFIX_
, &
¡r
) ||

7325 
SkP»fix
(
GTEST_FLAG_PREFIX_DASH_
, &
¡r
));

7337 
PrštCŞÜEncoded
(cÚ¡ * 
¡r
) {

7338 
GTe¡CŞÜ
 
	gcŞÜ
 = 
COLOR_DEFAULT
;

7345 cÚ¡ * 
	gp
 = 
¡rchr
(
¡r
, '@');

7346 ià(
	gp
 =ğ
nuÎ±r
) {

7347 
CŞÜedPrštf
(
cŞÜ
, "%s", 
¡r
);

7351 
CŞÜedPrštf
(
cŞÜ
, "%s", 
¡d
::
¡ršg
(
¡r
, 
p
).
c_¡r
());

7353 cÚ¡ 
	gch
 = 
p
[1];

7354 
	g¡r
 = 
p
 + 2;

7355 ià(
	gch
 == '@') {

7356 
CŞÜedPrštf
(
cŞÜ
, "@");

7357 } ià(
	gch
 == 'D') {

7358 
cŞÜ
 = 
COLOR_DEFAULT
;

7359 } ià(
	gch
 == 'R') {

7360 
cŞÜ
 = 
COLOR_RED
;

7361 } ià(
	gch
 == 'G') {

7362 
cŞÜ
 = 
COLOR_GREEN
;

7363 } ià(
	gch
 == 'Y') {

7364 
cŞÜ
 = 
COLOR_YELLOW
;

7366 --
	g¡r
;

7371 cÚ¡ 
	gkCŞÜEncodedH–pMes§ge
[] =

7372 "Thi ´og¿m cÚš ‹¡ wr™‹Àusšg " 
GTEST_NAME_
 ". You can usehe\n"

7376 " @G--" 
GTEST_FLAG_PREFIX_
 "list_tests@D\n"

7379 " @G--" 
GTEST_FLAG_PREFIX_
 "filter=@YPOSTIVE_PATTERNS"

7384 " @G--" 
GTEST_FLAG_PREFIX_
 "also_run_disabled_tests@D\n"

7388 " @G--" 
GTEST_FLAG_PREFIX_
 "repeat=@Y[COUNT]@D\n"

7390 " @G--" 
GTEST_FLAG_PREFIX_
 "shuffle@D\n"

7392 " @G--" 
GTEST_FLAG_PREFIX_
 "random_seed=@Y[NUMBER]@D\n"

7397 " @G--" 
GTEST_FLAG_PREFIX_
 "color=@Y(@Gyes@Y|@Gno@Y|@Gauto@Y)@D\n"

7399 " -@G-" 
GTEST_FLAG_PREFIX_
 "print_time=0@D\n"

7401 " @G--" 
GTEST_FLAG_PREFIX_
 "output=@Y(@Gjson@Y|@Gxml@Y)[@G:@YDIRECTORY_PATH@G"

7402 
GTEST_PATH_SEP_
 "@Y|@G:@YFILE_PATH]@D\n"

7405 #ià
GTEST_CAN_STREAM_RESULTS_


7406 " @G--" 
GTEST_FLAG_PREFIX_
 "stream_result_to=@YHOST@G:@YPORT@D\n"

7409 " @G--" 
GTEST_FLAG_PREFIX_
 "print_skipped@D\n"

7413 #ià
GTEST_HAS_DEATH_TEST
 && !
GTEST_OS_WINDOWS


7414 " @G--" 
GTEST_FLAG_PREFIX_
 "death_test_style=@Y(@Gfast@Y|@Gthreadsafe@Y)@D\n"

7417 " @G--" 
GTEST_FLAG_PREFIX_
 "break_on_failure@D\n"

7419 " @G--" 
GTEST_FLAG_PREFIX_
 "throw_on_failure@D\n"

7422 " @G--" 
GTEST_FLAG_PREFIX_
 "catch_exceptions=0@D\n"

7426 "Exû± fÜ @G--" 
GTEST_FLAG_PREFIX_
 "list_tests@D, you can‡lternatively set "

7429 "di§bË cŞÜedexˆouut, you cªƒ™h” s³cify @G--" 
GTEST_FLAG_PREFIX_


7431 "th@G" 
GTEST_FLAG_PREFIX_UPPER_
 "COLOR@Dƒnvironment variableo @Gno@D.\n"

7433 "FÜ mÜšfÜm©iÚ,…Ëa£„—dh" 
GTEST_NAME_
 " documentation‡t\n"

7434 "@G" 
GTEST_PROJECT_URL_
 "@D. Iàyou fšd‡ bug iÀ" 
GTEST_NAME_
 "\n"

7436 "@G<" 
GTEST_DEV_EMAIL_
 ">@D.\n";

7438 
boŞ
 
P¬£GoogËTe¡FÏg
(cÚ¡ * cÚ¡ 
¬g
) {

7439  
P¬£BoŞFÏg
(
¬g
, 
kAlsoRunDi§bËdTe¡sFÏg
,

7440 &
GTEST_FLAG
(
®so_run_di§bËd_‹¡s
)) ||

7441 
P¬£BoŞFÏg
(
¬g
, 
kB»akOnFau»FÏg
,

7442 &
GTEST_FLAG
(
b»ak_Ú_çu»
)) ||

7443 
P¬£BoŞFÏg
(
¬g
, 
kC©chExû±iÚsFÏg
,

7444 &
GTEST_FLAG
(
ÿtch_exû±iÚs
)) ||

7445 
P¬£SŒšgFÏg
(
¬g
, 
kCŞÜFÏg
, &
GTEST_FLAG
(
cŞÜ
)) ||

7446 
P¬£SŒšgFÏg
(
¬g
, 
kD—thTe¡StyËFÏg
,

7447 &
GTEST_FLAG
(
d—th_‹¡_¡yË
)) ||

7448 
P¬£BoŞFÏg
(
¬g
, 
kD—thTe¡U£FÜk
,

7449 &
GTEST_FLAG
(
d—th_‹¡_u£_fÜk
)) ||

7450 
P¬£SŒšgFÏg
(
¬g
, 
kF‹rFÏg
, &
GTEST_FLAG
(
f‹r
)) ||

7451 
P¬£SŒšgFÏg
(
¬g
, 
kIÁ”ÇlRunD—thTe¡FÏg
,

7452 &
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
)) ||

7453 
P¬£BoŞFÏg
(
¬g
, 
kLi¡Te¡sFÏg
, &
GTEST_FLAG
(
li¡_‹¡s
)) ||

7454 
P¬£SŒšgFÏg
(
¬g
, 
kOuutFÏg
, &
GTEST_FLAG
(
ouut
)) ||

7455 
P¬£BoŞFÏg
(
¬g
, 
kPrštTimeFÏg
, &
GTEST_FLAG
(
´št_time
)) ||

7456 
P¬£BoŞFÏg
(
¬g
, 
kPrštUTF8FÏg
, &
GTEST_FLAG
(
´št_utf8
)) ||

7457 
P¬£IÁ32FÏg
(
¬g
, 
kRªdomS“dFÏg
, &
GTEST_FLAG
(
¿ndom_£ed
)) ||

7458 
P¬£IÁ32FÏg
(
¬g
, 
kR•—tFÏg
, &
GTEST_FLAG
(
»³©
)) ||

7459 
P¬£BoŞFÏg
(
¬g
, 
kShufæeFÏg
, &
GTEST_FLAG
(
shufæe
)) ||

7460 
P¬£IÁ32FÏg
(
¬g
, 
kSckT¿ûD•thFÏg
,

7461 &
GTEST_FLAG
(
¡ack_Œaû_d•th
)) ||

7462 
P¬£SŒšgFÏg
(
¬g
, 
kSŒ—mResuÉToFÏg
,

7463 &
GTEST_FLAG
(
¡»am_»suÉ_to
)) ||

7464 
P¬£BoŞFÏg
(
¬g
, 
kThrowOnFau»FÏg
,

7465 &
GTEST_FLAG
(
throw_Ú_çu»
)) ||

7466 
P¬£BoŞFÏg
(
¬g
, 
kPrštSk³dFÏg
,

7467 &
GTEST_FLAG
(
´št_sk³d
));

7470 #ià
GTEST_USE_OWN_FLAGFILE_FLAG_


7471 
LßdFÏgsFromFe
(cÚ¡ 
¡d
::
¡ršg
& 
·th
) {

7472 
FILE
* 
æagfe
 = 
posix
::
FO³n
(
·th
.
c_¡r
(), "r");

7473 ià(!
	gæagfe
) {

7474 
GTEST_LOG_
(
FATAL
è<< "UÇbËØİ’ f\"" << 
GTEST_FLAG
(
æagfe
)

7477 
	g¡d
::
¡ršg
 
cÚ‹Ás
(
R—dEÁœeFe
(
æagfe
));

7478 
	gposix
::
FClo£
(
æagfe
);

7479 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
lšes
;

7480 
S¶™SŒšg
(
cÚ‹Ás
, '\n', &
lšes
);

7481 
size_t
 
	gi
 = 0; i < 
	glšes
.
size
(); ++i) {

7482 ià(
	glšes
[
i
].
em±y
())

7484 ià(!
P¬£GoogËTe¡FÏg
(
lšes
[
i
].
c_¡r
()))

7485 
	gg_h–p_æag
 = 
Œue
;

7493 
	g‹m¶©e
 <
ty³Çme
 
	gCh¬Ty³
>

7494 
P¬£GoogËTe¡FÏgsOÆyIm¶
(* 
¬gc
, 
Ch¬Ty³
** 
¬gv
) {

7495 
	gi
 = 1; i < *
	g¬gc
; i++) {

7496 cÚ¡ 
	g¡d
::
¡ršg
 
¬g_¡ršg
 = 
SŒ—mabËToSŒšg
(
¬gv
[
i
]);

7497 cÚ¡ * cÚ¡ 
	g¬g
 = 
¬g_¡ršg
.
c_¡r
();

7499 
usšg
 
	gš‹º®
::
P¬£BoŞFÏg
;

7500 
usšg
 
	gš‹º®
::
P¬£IÁ32FÏg
;

7501 
usšg
 
	gš‹º®
::
P¬£SŒšgFÏg
;

7503 
boŞ
 
	g»move_æag
 = 
çl£
;

7504 ià(
P¬£GoogËTe¡FÏg
(
¬g
)) {

7505 
	g»move_æag
 = 
Œue
;

7506 #ià
GTEST_USE_OWN_FLAGFILE_FLAG_


7507 } ià(
P¬£SŒšgFÏg
(
¬g
, 
kFÏgfeFÏg
, &
GTEST_FLAG
(
æagfe
))) {

7508 
LßdFÏgsFromFe
(
GTEST_FLAG
(
æagfe
));

7509 
	g»move_æag
 = 
Œue
;

7511 } ià(
	g¬g_¡ršg
 =ğ"--h–p" || 
¬g_¡ršg
 == "-h" ||

7512 
¬g_¡ršg
 == "-?" ||‡rg_string == "/?" ||

7513 
HasGoogËTe¡FÏgP»fix
(
¬g
)) {

7516 
g_h–p_æag
 = 
Œue
;

7519 ià(
	g»move_æag
) {

7524 
	gj
 = 
i
; j !ğ*
¬gc
; j++) {

7525 
	g¬gv
[
j
] = 
¬gv
[j + 1];

7529 (*
	g¬gc
)--;

7533 
	gi
--;

7537 ià(
	gg_h–p_æag
) {

7541 
PrštCŞÜEncoded
(
kCŞÜEncodedH–pMes§ge
);

7547 
P¬£GoogËTe¡FÏgsOÆy
(* 
¬gc
, ** 
¬gv
) {

7548 
P¬£GoogËTe¡FÏgsOÆyIm¶
(
¬gc
, 
¬gv
);

7553 #ià
GTEST_OS_MAC


7554 #iâdeà
GTEST_OS_IOS


7555 ià(*
_NSG‘Argv
(è=ğ
¬gv
) {

7556 *
_NSG‘Argc
(èğ*
¬gc
;

7561 
P¬£GoogËTe¡FÏgsOÆy
(* 
¬gc
, 
wch¬_t
** 
¬gv
) {

7562 
P¬£GoogËTe¡FÏgsOÆyIm¶
(
¬gc
, 
¬gv
);

7569 
	g‹m¶©e
 <
ty³Çme
 
	gCh¬Ty³
>

7570 
In™GoogËTe¡Im¶
(* 
¬gc
, 
Ch¬Ty³
** 
¬gv
) {

7572 ià(
GTe¡IsIn™Ÿlized
()) ;

7574 ià(*
	g¬gc
 <= 0) ;

7576 
	gg_¬gvs
.
ş—r
();

7577 
	gi
 = 0; i !ğ*
¬gc
; i++) {

7578 
	gg_¬gvs
.
push_back
(
SŒ—mabËToSŒšg
(
¬gv
[
i
]));

7581 #ià
GTEST_HAS_ABSL


7582 
	gab¦
::
In™ŸlizeSymbŞiz”
(
g_¬gvs
[0].
c_¡r
());

7585 
P¬£GoogËTe¡FÏgsOÆy
(
¬gc
, 
¬gv
);

7586 
G‘Un™Te¡Im¶
()->
Po¡FÏgP¬sšgIn™
();

7600 
	$In™GoogËTe¡
(* 
¬gc
, ** 
¬gv
) {

7601 #ià
	`defšed
(
GTEST_CUSTOM_INIT_GOOGLE_TEST_FUNCTION_
)

7602 
	`GTEST_CUSTOM_INIT_GOOGLE_TEST_FUNCTION_
(
¬gc
, 
¬gv
);

7604 
š‹º®
::
	`In™GoogËTe¡Im¶
(
¬gc
, 
¬gv
);

7606 
	}
}

7610 
	$In™GoogËTe¡
(* 
¬gc
, 
wch¬_t
** 
¬gv
) {

7611 #ià
	`defšed
(
GTEST_CUSTOM_INIT_GOOGLE_TEST_FUNCTION_
)

7612 
	`GTEST_CUSTOM_INIT_GOOGLE_TEST_FUNCTION_
(
¬gc
, 
¬gv
);

7614 
š‹º®
::
	`In™GoogËTe¡Im¶
(
¬gc
, 
¬gv
);

7616 
	}
}

7620 
	$In™GoogËTe¡
() {

7622 
¬gc
 = 1;

7623 cÚ¡‡utØ
¬g0
 = "dummy";

7624 * 
¬gv0
 = 
cÚ¡_ÿ¡
<*>(
¬g0
);

7625 ** 
¬gv
 = &
¬gv0
;

7627 #ià
	`defšed
(
GTEST_CUSTOM_INIT_GOOGLE_TEST_FUNCTION_
)

7628 
	`GTEST_CUSTOM_INIT_GOOGLE_TEST_FUNCTION_
(&
¬gc
, 
¬gv
);

7630 
š‹º®
::
	`In™GoogËTe¡Im¶
(&
¬gc
, 
¬gv
);

7632 
	}
}

7634 
	g¡d
::
¡ršg
 
	$TempDœ
() {

7635 #ià
	`defšed
(
GTEST_CUSTOM_TEMPDIR_FUNCTION_
)

7636  
	`GTEST_CUSTOM_TEMPDIR_FUNCTION_
();

7639 #ià
GTEST_OS_WINDOWS_MOBILE


7641 #–ià
GTEST_OS_WINDOWS


7642 cÚ¡ * 
‹mp_dœ
 = 
š‹º®
::
posix
::
	`G‘Env
("TEMP");

7643 ià(
‹mp_dœ
 =ğ
nuÎ±r
 ||emp_dir[0] == '\0')

7645 ià(
‹mp_dœ
[
	`¡¾’
(temp_dir) - 1] == '\\')

7646  
‹mp_dœ
;

7648  
¡d
::
	`¡ršg
(
‹mp_dœ
) + "\\";

7649 #–ià
GTEST_OS_LINUX_ANDROID


7654 
	}
}

7660 
	gScİedT¿û
::
	$PushT¿û
(cÚ¡ * 
fe
, 
lše
, 
¡d
::
¡ršg
 
mes§ge
) {

7661 
š‹º®
::
T¿ûInfo
 
Œaû
;

7662 
Œaû
.
fe
 = file;

7663 
Œaû
.
lše
 =†ine;

7664 
Œaû
.
mes§ge
.
	`sw­
(message);

7666 
Un™Te¡
::
	`G‘In¡ªû
()->
	`PushGTe¡T¿û
(
Œaû
);

7667 
	}
}

7670 
	gScİedT¿û
::~
	$ScİedT¿û
()

7671 
	$GTEST_LOCK_EXCLUDED_
(&
Un™Te¡
::
mu‹x_
) {

7672 
Un™Te¡
::
	`G‘In¡ªû
()->
	`PİGTe¡T¿û
();

7673 
	}
}

7709 
	~<ut™y
>

7712 #ià
GTEST_HAS_DEATH_TEST


7714 #ià
GTEST_OS_MAC


7715 
	~<üt_ex‹ºs.h
>

7718 
	~<”ºo.h
>

7719 
	~<fú.h
>

7720 
	~<lim™s.h
>

7722 #ià
GTEST_OS_LINUX


7723 
	~<sigÇl.h
>

7726 
	~<¡d¬g.h
>

7728 #ià
GTEST_OS_WINDOWS


7729 
	~<wšdows.h
>

7731 
	~<sys/mmª.h
>

7732 
	~<sys/wa™.h
>

7735 #ià
GTEST_OS_QNX


7736 
	~<¥awn.h
>

7739 #ià
GTEST_OS_FUCHSIA


7740 
	~<lib/fdio/fd.h
>

7741 
	~<lib/fdio/io.h
>

7742 
	~<lib/fdio/¥awn.h
>

7743 
	~<lib/zx/chªÃl.h
>

7744 
	~<lib/zx/pÜt.h
>

7745 
	~<lib/zx/´oûss.h
>

7746 
	~<lib/zx/sock‘.h
>

7747 
	~<zœcÚ/´oûs§rgs.h
>

7748 
	~<zœcÚ/sysÿÎs.h
>

7749 
	~<zœcÚ/sysÿÎs/pŞicy.h
>

7750 
	~<zœcÚ/sysÿÎs/pÜt.h
>

7756 
Çme¥aû
 
	g‹¡šg
 {

7765 cÚ¡ 
	gkDeçuÉD—thTe¡StyË
[] = 
GTEST_DEFAULT_DEATH_TEST_STYLE
;

7767 
GTEST_DEFINE_¡ršg_
(

7768 
d—th_‹¡_¡yË
,

7769 
š‹º®
::
SŒšgFromGTe¡Env
("d—th_‹¡_¡yË", 
kDeçuÉD—thTe¡StyË
),

7776 
GTEST_DEFINE_boŞ_
(

7777 
d—th_‹¡_u£_fÜk
,

7778 
š‹º®
::
BoŞFromGTe¡Env
("d—th_‹¡_u£_fÜk", 
çl£
),

7788 
Çme¥aû
 
	gš‹º®
 {

7789 
GTEST_DEFINE_¡ršg_
(

7790 
š‹º®_run_d—th_‹¡
, "",

7799 #ià
GTEST_HAS_DEATH_TEST


7801 
Çme¥aû
 
	gš‹º®
 {

7805 #ià!
GTEST_OS_WINDOWS
 && !
GTEST_OS_FUCHSIA


7806 
boŞ
 
	gg_š_ç¡_d—th_‹¡_chd
 = 
çl£
;

7814 
boŞ
 
InD—thTe¡Chd
() {

7815 #ià
GTEST_OS_WINDOWS
 || 
GTEST_OS_FUCHSIA


7819  !
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
).
em±y
();

7823 ià(
GTEST_FLAG
(
d—th_‹¡_¡yË
) == "threadsafe")

7824  !
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
).
em±y
();

7826  
	gg_š_ç¡_d—th_‹¡_chd
;

7833 
	gEx™edW™hCode
::
Ex™edW™hCode
(
ex™_code
è: 
ex™_code_
(exit_code) {

7837 
boŞ
 
Ex™edW™hCode
::
İ”©Ü
()(
ex™_¡©us
) const {

7838 #ià
GTEST_OS_WINDOWS
 || 
GTEST_OS_FUCHSIA


7840  
ex™_¡©us
 =ğ
ex™_code_
;

7844  
WIFEXITED
(
ex™_¡©us
è&& 
WEXITSTATUS
Óx™_¡©usè=ğ
ex™_code_
;

7849 #ià!
GTEST_OS_WINDOWS
 && !
GTEST_OS_FUCHSIA


7851 
	gKËdBySigÇl
::
KËdBySigÇl
(
signum
è: 
signum_
(signum) {

7855 
boŞ
 
KËdBySigÇl
::
İ”©Ü
()(
ex™_¡©us
) const {

7856 #ià
defšed
(
GTEST_KILLED_BY_SIGNAL_OVERRIDE_
)

7858 
boŞ
 
»suÉ
;

7859 ià(
GTEST_KILLED_BY_SIGNAL_OVERRIDE_
(
signum_
, 
ex™_¡©us
, &
»suÉ
)) {

7860  
	g»suÉ
;

7864  
WIFSIGNALED
(
ex™_¡©us
è&& 
WTERMSIG
Óx™_¡©usè=ğ
signum_
;

7868 
Çme¥aû
 
	gš‹º®
 {

7874 
	g¡d
::
¡ršg
 
Ex™Summ¬y
(
ex™_code
) {

7875 
Mes§ge
 
m
;

7877 #ià
GTEST_OS_WINDOWS
 || 
GTEST_OS_FUCHSIA


7879 
	gm
 << "Ex™ed w™hƒx™ stu " << 
	gex™_code
;

7883 ià(
WIFEXITED
(
ex™_code
)) {

7884 
	gm
 << "Ex™ed w™hƒx™ stu " << 
WEXITSTATUS
(
ex™_code
);

7885 } ià(
WIFSIGNALED
(
ex™_code
)) {

7886 
	gm
 << "T”mš©ed by sigÇÈ" << 
WTERMSIG
(
ex™_code
);

7888 #ifdeà
WCOREDUMP


7889 ià(
WCOREDUMP
(
ex™_code
)) {

7890 
	gm
 << " (core dumped)";

7895  
	gm
.
G‘SŒšg
();

7900 
boŞ
 
Ex™edUnsucûssfuÎy
(
ex™_¡©us
) {

7901  !
Ex™edW™hCode
(0)(
	gex™_¡©us
);

7904 #ià!
GTEST_OS_WINDOWS
 && !
GTEST_OS_FUCHSIA


7909 
	g¡d
::
¡ršg
 
D—thTe¡Th»adW¬nšg
(
size_t
 
th»ad_couÁ
) {

7910 
Mes§ge
 
msg
;

7911 
	gmsg
 << "Deathests use fork(), which is unsafe…articularly"

7912 << " iÀ¨th»aded cÚ‹xt. FÜhi ‹¡, " << 
	gGTEST_NAME_
 << " ";

7913 ià(
	gth»ad_couÁ
 == 0) {

7914 
msg
 << "couldn't detecthe‚umber ofhreads.";

7916 
	gmsg
 << "d‘eùed " << 
	gth»ad_couÁ
 << "hreads.";

7918 
	gmsg
 << " See "

7923  
	gmsg
.
G‘SŒšg
();

7928 cÚ¡ 
	gkD—thTe¡Lived
 = 'L';

7929 cÚ¡ 
	gkD—thTe¡R‘uºed
 = 'R';

7930 cÚ¡ 
	gkD—thTe¡Th»w
 = 'T';

7931 cÚ¡ 
	gkD—thTe¡IÁ”ÇlE¼Ü
 = 'I';

7933 #ià
GTEST_OS_FUCHSIA


7936 cÚ¡ 
	gkFuchsŸR—dPeFd
 = 3;

7947 
	eD—thTe¡Outcome
 { 
	gIN_PROGRESS
, 
	gDIED
, 
	gLIVED
, 
	gRETURNED
, 
	gTHREW
 };

7954 
D—thTe¡AbÜt
(cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
) {

7958 cÚ¡ 
IÁ”ÇlRunD—thTe¡FÏg
* cÚ¡ 
æag
 =

7959 
G‘Un™Te¡Im¶
()->
š‹º®_run_d—th_‹¡_æag
();

7960 ià(
	gæag
 !ğ
nuÎ±r
) {

7961 
FILE
* 
·»Á
 = 
posix
::
FDO³n
(
æag
->
wr™e_fd
(), "w");

7962 
åutc
(
kD—thTe¡IÁ”ÇlE¼Ü
, 
·»Á
);

7963 
årštf
(
·»Á
, "%s", 
mes§ge
.
c_¡r
());

7964 
fæush
(
·»Á
);

7965 
_ex™
(1);

7967 
årštf
(
¡d”r
, "%s", 
mes§ge
.
c_¡r
());

7968 
fæush
(
¡d”r
);

7969 
	gposix
::
AbÜt
();

7975 
	#GTEST_DEATH_TEST_CHECK_
(
ex´essiÚ
) \

7977 ià(!::
‹¡šg
::
š‹º®
::
	`IsTrue
(
ex´essiÚ
)) { \

7978 
	`D—thTe¡AbÜt
( \

7979 ::
¡d
::
	`¡ršg
("CHECK faed: F"è+ 
__FILE__
 + ",†ine " \

7980 + ::
‹¡šg
::
š‹º®
::
	`SŒ—mabËToSŒšg
(
__LINE__
) + ": " \

7983 } ::
‹¡šg
::
š‹º®
::
	`AlwaysF®£
())

	)

7992 
	#GTEST_DEATH_TEST_CHECK_SYSCALL_
(
ex´essiÚ
) \

7994 
g‹¡_»tv®
; \

7996 
g‹¡_»tv®
 = (
ex´essiÚ
); \

7997 } 
g‹¡_»tv®
 =ğ-1 && 
”ºo
 =ğ
EINTR
); \

7998 ià(
g‹¡_»tv®
 == -1) { \

7999 
	`D—thTe¡AbÜt
( \

8000 ::
¡d
::
	`¡ršg
("CHECK faed: F"è+ 
__FILE__
 + ",†ine " \

8001 + ::
‹¡šg
::
š‹º®
::
	`SŒ—mabËToSŒšg
(
__LINE__
) + ": " \

8004 } ::
‹¡šg
::
š‹º®
::
	`AlwaysF®£
())

	)

8007 
	g¡d
::
¡ršg
 
G‘La¡E¼noDesütiÚ
() {

8008  
”ºo
 =ğ0 ? "" : 
posix
::
SŒE¼Ü
(errno);

8015 
FaFromIÁ”ÇlE¼Ü
(
fd
) {

8016 
Mes§ge
 
	g”rÜ
;

8017 
	gbufãr
[256];

8018 
	gnum_»ad
;

8021 (
	gnum_»ad
 = 
posix
::
R—d
(
fd
, 
bufãr
, 255)) > 0) {

8022 
	gbufãr
[
num_»ad
] = '\0';

8023 
	g”rÜ
 << 
	gbufãr
;

8025 } 
	gnum_»ad
 =ğ-1 && 
”ºo
 =ğ
EINTR
);

8027 ià(
	gnum_»ad
 == 0) {

8028 
GTEST_LOG_
(
FATAL
è<< 
”rÜ
.
G‘SŒšg
();

8030 cÚ¡ 
	gÏ¡_”rÜ
 = 
”ºo
;

8031 
GTEST_LOG_
(
FATAL
) << "Error while„eading deathest internal: "

8032 << 
G‘La¡E¼noDesütiÚ
(è<< " [" << 
	gÏ¡_”rÜ
 << "]";

8038 
	gD—thTe¡
::
D—thTe¡
() {

8039 
Te¡Info
* cÚ¡ 
šfo
 = 
G‘Un™Te¡Im¶
()->
cu¼’t_‹¡_šfo
();

8040 ià(
	gšfo
 =ğ
nuÎ±r
) {

8041 
D—thTe¡AbÜt
("Cannot„un‡ deathest outside of‡ TEST or "

8048 
boŞ
 
	gD—thTe¡
::
C»©e
(cÚ¡ * 
¡©em’t
,

8049 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
, cÚ¡ * 
fe
,

8050 
lše
, 
D—thTe¡
** 
‹¡
) {

8051  
G‘Un™Te¡Im¶
()->
d—th_‹¡_çùÜy
()->
C»©e
(

8052 
¡©em’t
, 
¡d
::
move
(
m©ch”
), 
fe
, 
lše
, 
‹¡
);

8055 cÚ¡ * 
	gD—thTe¡
::
La¡Mes§ge
() {

8056  
Ï¡_d—th_‹¡_mes§ge_
.
c_¡r
();

8059 
	gD—thTe¡
::
£t_Ï¡_d—th_‹¡_mes§ge
(cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
) {

8060 
Ï¡_d—th_‹¡_mes§ge_
 = 
mes§ge
;

8063 
	g¡d
::
¡ršg
 
D—thTe¡
::
Ï¡_d—th_‹¡_mes§ge_
;

8066 şas 
	cD—thTe¡Im¶
 : 
public
 
D—thTe¡
 {

8067 
´Ùeùed
:

8068 
D—thTe¡Im¶
(cÚ¡ * 
a_¡©em’t
, 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
)

8069 : 
¡©em’t_
(
a_¡©em’t
),

8070 
m©ch”_
(
¡d
::
move
(
m©ch”
)),

8071 
¥awÃd_
(
çl£
),

8072 
¡©us_
(-1),

8073 
outcome_
(
IN_PROGRESS
),

8074 
»ad_fd_
(-1),

8075 
wr™e_fd_
(-1) {}

8078 ~
D—thTe¡Im¶
(è
	gov”ride
 { 
GTEST_DEATH_TEST_CHECK_
(
»ad_fd_
 == -1); }

8080 
AbÜt
(
AbÜtR—sÚ
 
»asÚ
è
	gov”ride
;

8081 
boŞ
 
Pas£d
(boŞ 
¡©us_ok
è
	gov”ride
;

8083 cÚ¡ * 
¡©em’t
(ècÚ¡ {  
	g¡©em’t_
; }

8084 
boŞ
 
¥awÃd
(ècÚ¡ {  
	g¥awÃd_
; }

8085 
£t_¥awÃd
(
boŞ
 
is_¥awÃd
è{ 
	g¥awÃd_
 = is_spawned; }

8086 
¡©us
(ècÚ¡ {  
	g¡©us_
; }

8087 
£t_¡©us
(
a_¡©us
è{ 
	g¡©us_
 =‡_status; }

8088 
D—thTe¡Outcome
 
outcome
(ècÚ¡ {  
	goutcome_
; }

8089 
£t_outcome
(
D—thTe¡Outcome
 
ª_outcome
è{ 
	goutcome_
 =‡n_outcome; }

8090 
»ad_fd
(ècÚ¡ {  
	g»ad_fd_
; }

8091 
£t_»ad_fd
(
fd
è{ 
	g»ad_fd_
 = fd; }

8092 
wr™e_fd
(ècÚ¡ {  
	gwr™e_fd_
; }

8093 
£t_wr™e_fd
(
fd
è{ 
	gwr™e_fd_
 = fd; }

8099 
R—dAndIÁ”´‘StusBy‹
();

8102 
vœtu®
 
	g¡d
::
¡ršg
 
G‘E¼ÜLogs
();

8104 
	g´iv©e
:

8107 cÚ¡ * cÚ¡ 
¡©em’t_
;

8109 
	gM©ch”
<cÚ¡ 
	g¡d
::
¡ršg
&> 
m©ch”_
;

8111 
boŞ
 
	g¥awÃd_
;

8113 
	g¡©us_
;

8115 
D—thTe¡Outcome
 
	goutcome_
;

8119 
	g»ad_fd_
;

8123 
	gwr™e_fd_
;

8130 
	gD—thTe¡Im¶
::
R—dAndIÁ”´‘StusBy‹
() {

8131 
æag
;

8132 
	gby‹s_»ad
;

8139 
	gby‹s_»ad
 = 
posix
::
R—d
(
»ad_fd
(), &
æag
, 1);

8140 } 
	gby‹s_»ad
 =ğ-1 && 
”ºo
 =ğ
EINTR
);

8142 ià(
	gby‹s_»ad
 == 0) {

8143 
£t_outcome
(
DIED
);

8144 } ià(
	gby‹s_»ad
 == 1) {

8145 
æag
) {

8146 
kD—thTe¡R‘uºed
:

8147 
£t_outcome
(
RETURNED
);

8149 
	gkD—thTe¡Th»w
:

8150 
£t_outcome
(
THREW
);

8152 
	gkD—thTe¡Lived
:

8153 
£t_outcome
(
LIVED
);

8155 
	gkD—thTe¡IÁ”ÇlE¼Ü
:

8156 
FaFromIÁ”ÇlE¼Ü
(
»ad_fd
());

8159 
GTEST_LOG_
(
FATAL
) << "Deathest child…rocess„eported "

8161 << 
¡©ic_ÿ¡
<>(
æag
) << ")";

8164 
GTEST_LOG_
(
FATAL
) << "Read from deathest child…rocess failed: "

8165 << 
G‘La¡E¼noDesütiÚ
();

8167 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
posix
::
Clo£
(
»ad_fd
()));

8168 
£t_»ad_fd
(-1);

8171 
	g¡d
::
¡ršg
 
D—thTe¡Im¶
::
G‘E¼ÜLogs
() {

8172  
G‘C­tu»dStd”r
();

8179 
	gD—thTe¡Im¶
::
AbÜt
(
AbÜtR—sÚ
 
»asÚ
) {

8183 cÚ¡ 
¡©us_ch
 =

8184 
»asÚ
 =ğ
TEST_DID_NOT_DIE
 ? 
kD—thTe¡Lived
 :

8185 
»asÚ
 =ğ
TEST_THREW_EXCEPTION
 ? 
kD—thTe¡Th»w
 : 
kD—thTe¡R‘uºed
;

8187 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
posix
::
Wr™e
(
wr™e_fd
(), &
¡©us_ch
, 1));

8196 
_ex™
(1);

8202 ::
¡d
::
¡ršg
 
FÜm©D—thTe¡Ouut
(cÚ¡ ::¡d::¡ršg& 
ouut
) {

8203 ::
¡d
::
¡ršg
 
»t
;

8204 
size_t
 
	g©
 = 0; ; ) {

8205 cÚ¡ 
size_t
 
	glše_’d
 = 
ouut
.
fšd
('\n', 
©
);

8206 
	g»t
 += "[ DEATH ] ";

8207 ià(
	glše_’d
 =ğ::
¡d
::
¡ršg
::
Åos
) {

8208 
»t
 +ğ
ouut
.
sub¡r
(
©
);

8211 
	g»t
 +ğ
ouut
.
sub¡r
(
©
, 
lše_’d
 + 1 -‡t);

8212 
	g©
 = 
lše_’d
 + 1;

8214  
	g»t
;

8238 
boŞ
 
	gD—thTe¡Im¶
::
Pas£d
(boŞ 
¡©us_ok
) {

8239 ià(!
¥awÃd
())

8240  
çl£
;

8242 cÚ¡ 
	g¡d
::
¡ršg
 
”rÜ_mes§ge
 = 
G‘E¼ÜLogs
();

8244 
boŞ
 
	gsucûss
 = 
çl£
;

8245 
Mes§ge
 
	gbufãr
;

8247 
	gbufãr
 << "D—the¡: " << 
¡©em’t
() << "\n";

8248 
outcome
()) {

8249 
	gLIVED
:

8250 
bufãr
 << " Result: failedo die.\n"

8251 << " E¼Ü msg:\n" << 
FÜm©D—thTe¡Ouut
(
”rÜ_mes§ge
);

8253 
	gTHREW
:

8254 
bufãr
 << " Result:hrew‡nƒxception.\n"

8255 << " E¼Ü msg:\n" << 
FÜm©D—thTe¡Ouut
(
”rÜ_mes§ge
);

8257 
	gRETURNED
:

8258 
bufãr
 << " Result: illegal„eturn inest statement.\n"

8259 << " E¼Ü msg:\n" << 
FÜm©D—thTe¡Ouut
(
”rÜ_mes§ge
);

8261 
	gDIED
:

8262 ià(
¡©us_ok
) {

8263 ià(
m©ch”_
.
M©ches
(
”rÜ_mes§ge
)) {

8264 
sucûss
 = 
Œue
;

8266 
	g¡d
::
o¡ršg¡»am
 
¡»am
;

8267 
	gm©ch”_
.
DesüibeTo
(&
¡»am
);

8268 
	gbufãr
 << " Result: died but‚ot withƒxpectedƒrror.\n"

8269 << " Ex³ùed: " << 
	g¡»am
.
¡r
() << "\n"

8271 << 
FÜm©D—thTe¡Ouut
(
”rÜ_mes§ge
);

8274 
	gbufãr
 << " Result: died but‚ot withƒxpectedƒxit code:\n"

8275 << " " << 
Ex™Summ¬y
(
¡©us
()) << "\n"

8276 << "Aùu® msg:\n" << 
FÜm©D—thTe¡Ouut
(
”rÜ_mes§ge
);

8279 
	gIN_PROGRESS
:

8281 
GTEST_LOG_
(
FATAL
)

8285 
	gD—thTe¡
::
£t_Ï¡_d—th_‹¡_mes§ge
(
bufãr
.
G‘SŒšg
());

8286  
	gsucûss
;

8289 #ià
GTEST_OS_WINDOWS


8318 şas 
	cWšdowsD—thTe¡
 : 
public
 
D—thTe¡Im¶
 {

8319 
public
:

8320 
WšdowsD—thTe¡
(cÚ¡ * 
a_¡©em’t
, 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
,

8321 cÚ¡ * 
fe
, 
lše
)

8322 : 
D—thTe¡Im¶
(
a_¡©em’t
, 
¡d
::
move
(
m©ch”
)),

8323 
fe_
(
fe
),

8324 
lše_
(
lše
) {}

8327 
vœtu®
 
Wa™
();

8328 
vœtu®
 
Te¡RŞe
 
AssumeRŞe
();

8330 
	g´iv©e
:

8332 cÚ¡ * cÚ¡ 
fe_
;

8334 cÚ¡ 
	glše_
;

8336 
AutoHªdË
 
	gwr™e_hªdË_
;

8338 
AutoHªdË
 
	gchd_hªdË_
;

8343 
AutoHªdË
 
	gev’t_hªdË_
;

8349 
	gWšdowsD—thTe¡
::
Wa™
() {

8350 ià(!
¥awÃd
())

8355 cÚ¡ 
HANDLE
 
	gwa™_hªdËs
[2] = { 
chd_hªdË_
.
G‘
(), 
ev’t_hªdË_
.Get() };

8356 ::
Wa™FÜMuÉËObjeùs
(2,

8357 
wa™_hªdËs
,

8358 
FALSE
,

8359 
INFINITE
)) {

8360 
	gWAIT_OBJECT_0
:

8361 
WAIT_OBJECT_0
 + 1:

8364 
GTEST_DEATH_TEST_CHECK_
(
çl£
);

8369 
	gwr™e_hªdË_
.
Re£t
();

8370 
	gev’t_hªdË_
.
Re£t
();

8372 
R—dAndIÁ”´‘StusBy‹
();

8378 
GTEST_DEATH_TEST_CHECK_
(

8379 
WAIT_OBJECT_0
 =ğ::
Wa™FÜSšgËObjeù
(
chd_hªdË_
.
G‘
(),

8380 
INFINITE
));

8381 
DWORD
 
	g¡©us_code
;

8382 
GTEST_DEATH_TEST_CHECK_
(

8383 ::
G‘Ex™CodeProûss
(
chd_hªdË_
.
G‘
(), &
¡©us_code
è!ğ
FALSE
);

8384 
	gchd_hªdË_
.
Re£t
();

8385 
£t_¡©us
(
¡©ic_ÿ¡
<>(
¡©us_code
));

8386  
¡©us
();

8394 
	gD—thTe¡
::
Te¡RŞe
 
WšdowsD—thTe¡
::
AssumeRŞe
() {

8395 cÚ¡ 
Un™Te¡Im¶
* cÚ¡ 
im¶
 = 
G‘Un™Te¡Im¶
();

8396 cÚ¡ 
IÁ”ÇlRunD—thTe¡FÏg
* cÚ¡ 
	gæag
 =

8397 
im¶
->
š‹º®_run_d—th_‹¡_æag
();

8398 cÚ¡ 
Te¡Info
* cÚ¡ 
	gšfo
 = 
im¶
->
cu¼’t_‹¡_šfo
();

8399 cÚ¡ 
	gd—th_‹¡_šdex
 = 
šfo
->
»suÉ
()->
d—th_‹¡_couÁ
();

8401 ià(
	gæag
 !ğ
nuÎ±r
) {

8404 
£t_wr™e_fd
(
æag
->
wr™e_fd
());

8405  
	gEXECUTE_TEST
;

8410 
SECURITY_ATTRIBUTES
 
	ghªdËs_¬e_šh”™abË
 = {(SECURITY_ATTRIBUTES),

8411 
nuÎ±r
, 
TRUE
};

8412 
HANDLE
 
	g»ad_hªdË
, 
	gwr™e_hªdË
;

8413 
GTEST_DEATH_TEST_CHECK_
(

8414 ::
C»©ePe
(&
»ad_hªdË
, &
wr™e_hªdË
, &
hªdËs_¬e_šh”™abË
,

8416 !ğ
FALSE
);

8417 
£t_»ad_fd
(::
_İ’_osfhªdË
(
»š‹½»t_ÿ¡
<
šŒ_t
>(
»ad_hªdË
),

8418 
O_RDONLY
));

8419 
	gwr™e_hªdË_
.
Re£t
(
wr™e_hªdË
);

8420 
	gev’t_hªdË_
.
Re£t
(::
C»©eEv’t
(

8421 &
hªdËs_¬e_šh”™abË
,

8422 
TRUE
,

8423 
FALSE
,

8424 
nuÎ±r
));

8425 
GTEST_DEATH_TEST_CHECK_
(
ev’t_hªdË_
.
G‘
(è!ğ
nuÎ±r
);

8426 cÚ¡ 
	g¡d
::
¡ršg
 
f‹r_æag
 = 
¡d
::¡ršg("--"è+ 
GTEST_FLAG_PREFIX_
 +

8427 
kF‹rFÏg
 + "=" + 
šfo
->
‹¡_su™e_Çme
() +

8428 "." + 
šfo
->
Çme
();

8429 cÚ¡ 
	g¡d
::
¡ršg
 
š‹º®_æag
 =

8430 
¡d
::
¡ršg
("--"è+ 
GTEST_FLAG_PREFIX_
 + 
kIÁ”ÇlRunD—thTe¡FÏg
 +

8431 "=" + 
fe_
 + "|" + 
SŒ—mabËToSŒšg
(
lše_
) + "|" +

8432 
SŒ—mabËToSŒšg
(
d—th_‹¡_šdex
) + "|" +

8433 
SŒ—mabËToSŒšg
(
¡©ic_ÿ¡
<>(::
G‘Cu¼’tProûssId
())) +

8437 "|" + 
SŒ—mabËToSŒšg
(
»š‹½»t_ÿ¡
<
size_t
>(
wr™e_hªdË
)) +

8438 "|" + 
SŒ—mabËToSŒšg
(
»š‹½»t_ÿ¡
<
size_t
>(
ev’t_hªdË_
.
G‘
()));

8440 
	gexecubË_·th
[
_MAX_PATH
 + 1];

8441 
GTEST_DEATH_TEST_CHECK_
(
_MAX_PATH
 + 1 !ğ::
G‘ModuËFeNameA
(
nuÎ±r
,

8442 
execubË_·th
,

8443 
_MAX_PATH
));

8445 
	g¡d
::
¡ršg
 
commªd_lše
 =

8446 
¡d
::
¡ršg
(::
G‘CommªdLšeA
()è+ " " + 
f‹r_æag
 + " \"" +

8447 
š‹º®_æag
 + "\"";

8449 
	gD—thTe¡
::
£t_Ï¡_d—th_‹¡_mes§ge
("");

8451 
C­tu»Std”r
();

8453 
FlushInfoLog
();

8456 
STARTUPINFOA
 
	g¡¬tup_šfo
;

8457 
mem£t
(&
¡¬tup_šfo
, 0, (
STARTUPINFO
));

8458 
	g¡¬tup_šfo
.
	gdwFÏgs
 = 
STARTF_USESTDHANDLES
;

8459 
	g¡¬tup_šfo
.
	ghStdIÅut
 = ::
G‘StdHªdË
(
STD_INPUT_HANDLE
);

8460 
	g¡¬tup_šfo
.
	ghStdOuut
 = ::
G‘StdHªdË
(
STD_OUTPUT_HANDLE
);

8461 
	g¡¬tup_šfo
.
	ghStdE¼Ü
 = ::
G‘StdHªdË
(
STD_ERROR_HANDLE
);

8463 
PROCESS_INFORMATION
 
	g´oûss_šfo
;

8464 
GTEST_DEATH_TEST_CHECK_
(

8465 ::
C»©eProûssA
(

8466 
execubË_·th
, 
cÚ¡_ÿ¡
<*>(
commªd_lše
.
c_¡r
()),

8467 
nuÎ±r
,

8468 
nuÎ±r
,

8469 
TRUE
,

8471 
nuÎ±r
,

8472 
Un™Te¡
::
G‘In¡ªû
()->
Üigš®_wÜkšg_dœ
(), &
¡¬tup_šfo
,

8473 &
´oûss_šfo
è!ğ
FALSE
);

8474 
	gchd_hªdË_
.
Re£t
(
´oûss_šfo
.
hProûss
);

8475 ::
Clo£HªdË
(
´oûss_šfo
.
hTh»ad
);

8476 
£t_¥awÃd
(
Œue
);

8477  
	gOVERSEE_TEST
;

8480 #–ià
GTEST_OS_FUCHSIA


8482 şas 
	cFuchsŸD—thTe¡
 : 
public
 
D—thTe¡Im¶
 {

8483 
public
:

8484 
FuchsŸD—thTe¡
(cÚ¡ * 
a_¡©em’t
, 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
,

8485 cÚ¡ * 
fe
, 
lše
)

8486 : 
D—thTe¡Im¶
(
a_¡©em’t
, 
¡d
::
move
(
m©ch”
)),

8487 
fe_
(
fe
),

8488 
lše_
(
lše
) {}

8491 
Wa™
(è
	gov”ride
;

8492 
Te¡RŞe
 
AssumeRŞe
(è
	gov”ride
;

8493 
	g¡d
::
¡ršg
 
G‘E¼ÜLogs
(è
ov”ride
;

8495 
	g´iv©e
:

8497 cÚ¡ * cÚ¡ 
fe_
;

8499 cÚ¡ 
	glše_
;

8501 
	g¡d
::
¡ršg
 
ÿ±u»d_¡d”r_
;

8503 
	gzx
::
´oûss
 
chd_´oûss_
;

8504 
	gzx
::
chªÃl
 
exû±iÚ_chªÃl_
;

8505 
	gzx
::
sock‘
 
¡d”r_sock‘_
;

8509 şas 
	cArgum’ts
 {

8510 
	gpublic
:

8511 
Argum’ts
(è{ 
¬gs_
.
push_back
(
nuÎ±r
); }

8513 ~
Argum’ts
() {

8514 
	g¡d
::
veùÜ
<*>::
™”©Ü
 
i
 = 
¬gs_
.
begš
(); 
	gi
 !ğ¬gs_.
’d
();

8515 ++
	gi
) {

8516 
ä“
(*
i
);

8519 
AddArgum’t
(cÚ¡ * 
¬gum’t
) {

8520 
	g¬gs_
.
š£¹
(
¬gs_
.
’d
(è- 1, 
posix
::
SŒDup
(
¬gum’t
));

8523 
	g‹m¶©e
 <
ty³Çme
 
	gSŒ
>

8524 
AddArgum’ts
(cÚ¡ ::
¡d
::
veùÜ
<
SŒ
>& 
¬gum’ts
) {

8525 
ty³Çme
 ::
¡d
::
veùÜ
<
SŒ
>::
cÚ¡_™”©Ü
 
i
 = 
¬gum’ts
.
begš
();

8526 
	gi
 !ğ
¬gum’ts
.
’d
();

8527 ++
	gi
) {

8528 
	g¬gs_
.
š£¹
(
¬gs_
.
’d
(è- 1, 
posix
::
SŒDup
(
i
->
c_¡r
()));

8531 * cÚ¡* 
Argv
() {

8532  &
	g¬gs_
[0];

8535 
size
() {

8536  
	g¬gs_
.
size
() - 1;

8539 
	g´iv©e
:

8540 
¡d
::
veùÜ
<*> 
¬gs_
;

8546 
	gFuchsŸD—thTe¡
::
Wa™
() {

8547 cÚ¡ 
kProûssKey
 = 0;

8548 cÚ¡ 
	gkSock‘Key
 = 1;

8549 cÚ¡ 
	gkExû±iÚKey
 = 2;

8551 ià(!
¥awÃd
())

8555 
zx_¡©us_t
 
	g¡©us_zx
;

8556 
	gzx
::
pÜt
…ort;

8557 
	g¡©us_zx
 = 
zx
::
pÜt
::
ü—‹
(0, &port);

8558 
GTEST_DEATH_TEST_CHECK_
(
¡©us_zx
 =ğ
ZX_OK
);

8561 
	g¡©us_zx
 = 
chd_´oûss_
.
wa™_async
(

8562 
pÜt
, 
kProûssKey
, 
ZX_PROCESS_TERMINATED
, 
ZX_WAIT_ASYNC_ONCE
);

8563 
GTEST_DEATH_TEST_CHECK_
(
¡©us_zx
 =ğ
ZX_OK
);

8566 
	g¡©us_zx
 = 
¡d”r_sock‘_
.
wa™_async
(

8567 
pÜt
, 
kSock‘Key
, 
ZX_SOCKET_READABLE
 | 
ZX_SOCKET_PEER_CLOSED
,

8568 
ZX_WAIT_ASYNC_ONCE
);

8569 
GTEST_DEATH_TEST_CHECK_
(
¡©us_zx
 =ğ
ZX_OK
);

8572 
	g¡©us_zx
 = 
exû±iÚ_chªÃl_
.
wa™_async
(

8573 
pÜt
, 
kExû±iÚKey
, 
ZX_CHANNEL_READABLE
, 
ZX_WAIT_ASYNC_ONCE
);

8574 
GTEST_DEATH_TEST_CHECK_
(
¡©us_zx
 =ğ
ZX_OK
);

8576 
boŞ
 
	g´oûss_‹rmš©ed
 = 
çl£
;

8577 
boŞ
 
	gsock‘_şo£d
 = 
çl£
;

8579 
zx_pÜt_·ck‘_t
 
	g·ck‘
 = {};

8580 
	g¡©us_zx
 = 
pÜt
.
wa™
(
zx
::
time
::
šfš™e
(), &
·ck‘
);

8581 
GTEST_DEATH_TEST_CHECK_
(
¡©us_zx
 =ğ
ZX_OK
);

8583 ià(
	g·ck‘
.
	gkey
 =ğ
kExû±iÚKey
) {

8587 
¡©us_zx
 = 
chd_´oûss_
.
kl
();

8588 
GTEST_DEATH_TEST_CHECK_
(
¡©us_zx
 =ğ
ZX_OK
);

8589 } ià(
	g·ck‘
.
	gkey
 =ğ
kProûssKey
) {

8591 
GTEST_DEATH_TEST_CHECK_
(
ZX_PKT_IS_SIGNAL_ONE
(
·ck‘
.
ty³
));

8592 
GTEST_DEATH_TEST_CHECK_
(
·ck‘
.
sigÇl
.
ob£rved
 & 
ZX_PROCESS_TERMINATED
);

8593 
	g´oûss_‹rmš©ed
 = 
Œue
;

8594 } ià(
	g·ck‘
.
	gkey
 =ğ
kSock‘Key
) {

8595 
GTEST_DEATH_TEST_CHECK_
(
ZX_PKT_IS_SIGNAL_ONE
(
·ck‘
.
ty³
));

8596 ià(
	g·ck‘
.
	gsigÇl
.
	gob£rved
 & 
	gZX_SOCKET_READABLE
) {

8598 
cÚ¡ex´
 
size_t
 
	gkBufãrSize
 = 1024;

8600 
size_t
 
	gŞd_Ëngth
 = 
ÿ±u»d_¡d”r_
.
Ëngth
();

8601 
size_t
 
	gby‹s_»ad
 = 0;

8602 
	gÿ±u»d_¡d”r_
.
»size
(
Şd_Ëngth
 + 
kBufãrSize
);

8603 
	g¡©us_zx
 = 
¡d”r_sock‘_
.
»ad
(

8604 0, &
ÿ±u»d_¡d”r_
.
äÚt
(è+ 
Şd_Ëngth
, 
kBufãrSize
,

8605 &
by‹s_»ad
);

8606 
	gÿ±u»d_¡d”r_
.
»size
(
Şd_Ëngth
 + 
by‹s_»ad
);

8607 } 
	g¡©us_zx
 =ğ
ZX_OK
);

8608 ià(
	g¡©us_zx
 =ğ
ZX_ERR_PEER_CLOSED
) {

8609 
sock‘_şo£d
 = 
Œue
;

8611 
GTEST_DEATH_TEST_CHECK_
(
¡©us_zx
 =ğ
ZX_ERR_SHOULD_WAIT
);

8612 
	g¡©us_zx
 = 
¡d”r_sock‘_
.
wa™_async
(

8613 
pÜt
, 
kSock‘Key
, 
ZX_SOCKET_READABLE
 | 
ZX_SOCKET_PEER_CLOSED
,

8614 
ZX_WAIT_ASYNC_ONCE
);

8615 
GTEST_DEATH_TEST_CHECK_
(
¡©us_zx
 =ğ
ZX_OK
);

8618 
GTEST_DEATH_TEST_CHECK_
(
·ck‘
.
sigÇl
.
ob£rved
 & 
ZX_SOCKET_PEER_CLOSED
);

8619 
	gsock‘_şo£d
 = 
Œue
;

8622 } !
	g´oûss_‹rmš©ed
 && !
	gsock‘_şo£d
);

8624 
R—dAndIÁ”´‘StusBy‹
();

8626 
zx_šfo_´oûss_t
 
	gbufãr
;

8627 
	g¡©us_zx
 = 
chd_´oûss_
.
g‘_šfo
(

8628 
ZX_INFO_PROCESS
, &
bufãr
, (bufãr), 
nuÎ±r
,‚ullptr);

8629 
GTEST_DEATH_TEST_CHECK_
(
¡©us_zx
 =ğ
ZX_OK
);

8631 
GTEST_DEATH_TEST_CHECK_
(
bufãr
.
ex™ed
);

8632 
£t_¡©us
(
bufãr
.
»tuº_code
);

8633  
¡©us
();

8641 
	gD—thTe¡
::
Te¡RŞe
 
FuchsŸD—thTe¡
::
AssumeRŞe
() {

8642 cÚ¡ 
Un™Te¡Im¶
* cÚ¡ 
im¶
 = 
G‘Un™Te¡Im¶
();

8643 cÚ¡ 
IÁ”ÇlRunD—thTe¡FÏg
* cÚ¡ 
	gæag
 =

8644 
im¶
->
š‹º®_run_d—th_‹¡_æag
();

8645 cÚ¡ 
Te¡Info
* cÚ¡ 
	gšfo
 = 
im¶
->
cu¼’t_‹¡_šfo
();

8646 cÚ¡ 
	gd—th_‹¡_šdex
 = 
šfo
->
»suÉ
()->
d—th_‹¡_couÁ
();

8648 ià(
	gæag
 !ğ
nuÎ±r
) {

8651 
£t_wr™e_fd
(
kFuchsŸR—dPeFd
);

8652  
	gEXECUTE_TEST
;

8656 
FlushInfoLog
();

8659 cÚ¡ 
	g¡d
::
¡ršg
 
f‹r_æag
 = 
¡d
::¡ršg("--"è+ 
GTEST_FLAG_PREFIX_
 +

8660 
kF‹rFÏg
 + "=" + 
šfo
->
‹¡_su™e_Çme
() +

8661 "." + 
šfo
->
Çme
();

8662 cÚ¡ 
	g¡d
::
¡ršg
 
š‹º®_æag
 =

8663 
¡d
::
¡ršg
("--"è+ 
GTEST_FLAG_PREFIX_
 + 
kIÁ”ÇlRunD—thTe¡FÏg
 + "="

8664 + 
fe_
 + "|"

8665 + 
SŒ—mabËToSŒšg
(
lše_
) + "|"

8666 + 
SŒ—mabËToSŒšg
(
d—th_‹¡_šdex
);

8667 
Argum’ts
 
	g¬gs
;

8668 
	g¬gs
.
AddArgum’ts
(
G‘InjeùabËArgvs
());

8669 
	g¬gs
.
AddArgum’t
(
f‹r_æag
.
c_¡r
());

8670 
	g¬gs
.
AddArgum’t
(
š‹º®_æag
.
c_¡r
());

8673 
zx_¡©us_t
 
	g¡©us
;

8674 
zx_hªdË_t
 
	gchd_pe_hªdË
;

8675 
	gchd_pe_fd
;

8676 
	g¡©us
 = 
fdio_pe_h®f
(&
chd_pe_fd
, &
chd_pe_hªdË
);

8677 
GTEST_DEATH_TEST_CHECK_
(
¡©us
 =ğ
ZX_OK
);

8678 
£t_»ad_fd
(
chd_pe_fd
);

8681 
fdio_¥awn_aùiÚ_t
 
	g¥awn_aùiÚs
[2] = {};

8682 
fdio_¥awn_aùiÚ_t
* 
	gadd_hªdË_aùiÚ
 = &
¥awn_aùiÚs
[0];

8683 
	gadd_hªdË_aùiÚ
->
	gaùiÚ
 = 
FDIO_SPAWN_ACTION_ADD_HANDLE
;

8684 
	gadd_hªdË_aùiÚ
->
	gh
.
	gid
 = 
PA_HND
(
PA_FD
, 
kFuchsŸR—dPeFd
);

8685 
	gadd_hªdË_aùiÚ
->
	gh
.
	ghªdË
 = 
chd_pe_hªdË
;

8688 
	gzx
::
sock‘
 
¡d”r_´oduûr_sock‘
;

8689 
	g¡©us
 =

8690 
zx
::
sock‘
::
ü—‹
(0, &
¡d”r_´oduûr_sock‘
, &
¡d”r_sock‘_
);

8691 
GTEST_DEATH_TEST_CHECK_
(
¡©us
 >= 0);

8692 
	g¡d”r_´oduûr_fd
 = -1;

8693 
	g¡©us
 =

8694 
fdio_fd_ü—‹
(
¡d”r_´oduûr_sock‘
.
»Ëa£
(), &
¡d”r_´oduûr_fd
);

8695 
GTEST_DEATH_TEST_CHECK_
(
¡©us
 >= 0);

8698 
GTEST_DEATH_TEST_CHECK_
(
fú
(
¡d”r_´oduûr_fd
, 
F_SETFL
, 0) == 0);

8700 
fdio_¥awn_aùiÚ_t
* 
	gadd_¡d”r_aùiÚ
 = &
¥awn_aùiÚs
[1];

8701 
	gadd_¡d”r_aùiÚ
->
	gaùiÚ
 = 
FDIO_SPAWN_ACTION_CLONE_FD
;

8702 
	gadd_¡d”r_aùiÚ
->
	gfd
.
	gloÿl_fd
 = 
¡d”r_´oduûr_fd
;

8703 
	gadd_¡d”r_aùiÚ
->
	gfd
.
	grg‘_fd
 = 
STDERR_FILENO
;

8706 
zx_hªdË_t
 
	gchd_job
 = 
ZX_HANDLE_INVALID
;

8707 
	g¡©us
 = 
zx_job_ü—‹
(
zx_job_deçuÉ
(), 0, & 
chd_job
);

8708 
GTEST_DEATH_TEST_CHECK_
(
¡©us
 =ğ
ZX_OK
);

8709 
zx_pŞicy_basic_t
 
	gpŞicy
;

8710 
	gpŞicy
.
	gcÚd™iÚ
 = 
ZX_POL_NEW_ANY
;

8711 
	gpŞicy
.pŞicy = 
ZX_POL_ACTION_ALLOW
;

8712 
	g¡©us
 = 
zx_job_£t_pŞicy
(

8713 
chd_job
, 
ZX_JOB_POL_RELATIVE
, 
ZX_JOB_POL_BASIC
, &
pŞicy
, 1);

8714 
GTEST_DEATH_TEST_CHECK_
(
¡©us
 =ğ
ZX_OK
);

8718 
	g¡©us
 =

8719 
zx_sk_ü—‹_exû±iÚ_chªÃl
(

8720 
chd_job
, 0, 
exû±iÚ_chªÃl_
.
»£t_ªd_g‘_add»ss
());

8721 
GTEST_DEATH_TEST_CHECK_
(
¡©us
 =ğ
ZX_OK
);

8724 
	g¡©us
 = 
fdio_¥awn_‘c
(

8725 
chd_job
, 
FDIO_SPAWN_CLONE_ALL
, 
¬gs
.
Argv
()[0],‡rgs.Argv(), 
nuÎ±r
,

8726 2, 
¥awn_aùiÚs
, 
chd_´oûss_
.
»£t_ªd_g‘_add»ss
(), 
nuÎ±r
);

8727 
GTEST_DEATH_TEST_CHECK_
(
¡©us
 =ğ
ZX_OK
);

8729 
£t_¥awÃd
(
Œue
);

8730  
	gOVERSEE_TEST
;

8733 
	g¡d
::
¡ršg
 
FuchsŸD—thTe¡
::
G‘E¼ÜLogs
() {

8734  
ÿ±u»d_¡d”r_
;

8742 şas 
	cFÜkšgD—thTe¡
 : 
public
 
D—thTe¡Im¶
 {

8743 
public
:

8744 
FÜkšgD—thTe¡
(cÚ¡ * 
¡©em’t
, 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
);

8747 
Wa™
(è
	gov”ride
;

8749 
	g´Ùeùed
:

8750 
£t_chd_pid
(
pid_t
 
chd_pid
è{ 
chd_pid_
 = child_pid; }

8752 
	g´iv©e
:

8754 
pid_t
 
chd_pid_
;

8758 
	gFÜkšgD—thTe¡
::
FÜkšgD—thTe¡
(cÚ¡ * 
a_¡©em’t
,

8759 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
)

8760 : 
D—thTe¡Im¶
(
a_¡©em’t
, 
¡d
::
move
(
m©ch”
)), 
chd_pid_
(-1) {}

8765 
	gFÜkšgD—thTe¡
::
Wa™
() {

8766 ià(!
¥awÃd
())

8769 
R—dAndIÁ”´‘StusBy‹
();

8771 
	g¡©us_v®ue
;

8772 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
wa™pid
(
chd_pid_
, &
¡©us_v®ue
, 0));

8773 
£t_¡©us
(
¡©us_v®ue
);

8774  
	g¡©us_v®ue
;

8779 şas 
	cNoExecD—thTe¡
 : 
public
 
FÜkšgD—thTe¡
 {

8780 
public
:

8781 
NoExecD—thTe¡
(cÚ¡ * 
a_¡©em’t
, 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
)

8782 : 
FÜkšgD—thTe¡
(
a_¡©em’t
, 
¡d
::
move
(
m©ch”
)) {}

8783 
Te¡RŞe
 
AssumeRŞe
(è
ov”ride
;

8788 
	gD—thTe¡
::
Te¡RŞe
 
NoExecD—thTe¡
::
AssumeRŞe
() {

8789 cÚ¡ 
size_t
 
th»ad_couÁ
 = 
G‘Th»adCouÁ
();

8790 ià(
	gth»ad_couÁ
 != 1) {

8791 
GTEST_LOG_
(
WARNING
è<< 
D—thTe¡Th»adW¬nšg
(
th»ad_couÁ
);

8794 
	gpe_fd
[2];

8795 
GTEST_DEATH_TEST_CHECK_
(
pe
(
pe_fd
) != -1);

8797 
	gD—thTe¡
::
£t_Ï¡_d—th_‹¡_mes§ge
("");

8798 
C­tu»Std”r
();

8806 
FlushInfoLog
();

8808 cÚ¡ 
pid_t
 
	gchd_pid
 = 
fÜk
();

8809 
GTEST_DEATH_TEST_CHECK_
(
chd_pid
 != -1);

8810 
£t_chd_pid
(
chd_pid
);

8811 ià(
	gchd_pid
 == 0) {

8812 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
şo£
(
pe_fd
[0]));

8813 
£t_wr™e_fd
(
pe_fd
[1]);

8817 
LogToStd”r
();

8820 
G‘Un™Te¡Im¶
()->
li¡’”s
()->
Suµ»ssEv’tFÜw¬dšg
();

8821 
	gg_š_ç¡_d—th_‹¡_chd
 = 
Œue
;

8822  
	gEXECUTE_TEST
;

8824 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
şo£
(
pe_fd
[1]));

8825 
£t_»ad_fd
(
pe_fd
[0]);

8826 
£t_¥awÃd
(
Œue
);

8827  
	gOVERSEE_TEST
;

8834 şas 
	cExecD—thTe¡
 : 
public
 
FÜkšgD—thTe¡
 {

8835 
public
:

8836 
ExecD—thTe¡
(cÚ¡ * 
a_¡©em’t
, 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
,

8837 cÚ¡ * 
fe
, 
lše
)

8838 : 
FÜkšgD—thTe¡
(
a_¡©em’t
, 
¡d
::
move
(
m©ch”
)),

8839 
fe_
(
fe
),

8840 
lše_
(
lše
) {}

8841 
Te¡RŞe
 
AssumeRŞe
(è
	gov”ride
;

8843 
	g´iv©e
:

8844 ::
¡d
::
veùÜ
<¡d::
¡ršg
> 
G‘ArgvsFÜD—thTe¡ChdProûss
() {

8845 ::
¡d
::
veùÜ
<¡d::
¡ršg
> 
¬gs
 = 
G‘InjeùabËArgvs
();

8846 #ià
defšed
(
GTEST_EXTRA_DEATH_TEST_COMMAND_LINE_ARGS_
)

8847 ::
¡d
::
veùÜ
<¡d::
¡ršg
> 
exŒa_¬gs
 =

8848 
GTEST_EXTRA_DEATH_TEST_COMMAND_LINE_ARGS_
();

8849 
	g¬gs
.
š£¹
(
¬gs
.
’d
(), 
exŒa_¬gs
.
begš
(),ƒxtra_args.end());

8851  
	g¬gs
;

8854 cÚ¡ * cÚ¡ 
	gfe_
;

8856 cÚ¡ 
	glše_
;

8860 şas 
	cArgum’ts
 {

8861 
	gpublic
:

8862 
Argum’ts
(è{ 
¬gs_
.
push_back
(
nuÎ±r
); }

8864 ~
Argum’ts
() {

8865 
	g¡d
::
veùÜ
<*>::
™”©Ü
 
i
 = 
¬gs_
.
begš
(); 
	gi
 !ğ¬gs_.
’d
();

8866 ++
	gi
) {

8867 
ä“
(*
i
);

8870 
AddArgum’t
(cÚ¡ * 
¬gum’t
) {

8871 
	g¬gs_
.
š£¹
(
¬gs_
.
’d
(è- 1, 
posix
::
SŒDup
(
¬gum’t
));

8874 
	g‹m¶©e
 <
ty³Çme
 
	gSŒ
>

8875 
AddArgum’ts
(cÚ¡ ::
¡d
::
veùÜ
<
SŒ
>& 
¬gum’ts
) {

8876 
ty³Çme
 ::
¡d
::
veùÜ
<
SŒ
>::
cÚ¡_™”©Ü
 
i
 = 
¬gum’ts
.
begš
();

8877 
	gi
 !ğ
¬gum’ts
.
’d
();

8878 ++
	gi
) {

8879 
	g¬gs_
.
š£¹
(
¬gs_
.
’d
(è- 1, 
posix
::
SŒDup
(
i
->
c_¡r
()));

8882 * cÚ¡* 
Argv
() {

8883  &
	g¬gs_
[0];

8886 
	g´iv©e
:

8887 
¡d
::
veùÜ
<*> 
¬gs_
;

8892 
	sExecD—thTe¡Args
 {

8893 * cÚ¡* 
	g¬gv
;

8894 
	gşo£_fd
;

8897 #ià
GTEST_OS_MAC


8898 
šlše
 ** 
G‘EnvœÚ
() {

8902  *
_NSG‘EnvœÚ
();

8907 "C" ** 
’vœÚ
;

8908 
šlše
 ** 
G‘EnvœÚ
(è{  
	g’vœÚ
; }

8911 #ià!
GTEST_OS_QNX


8915 
ExecD—thTe¡ChdMaš
(* 
chd_¬g
) {

8916 
ExecD—thTe¡Args
* cÚ¡ 
	g¬gs
 = 
¡©ic_ÿ¡
<ExecD—thTe¡Args*>(
chd_¬g
);

8917 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
şo£
(
¬gs
->
şo£_fd
));

8922 cÚ¡ * cÚ¡ 
	gÜigš®_dœ
 =

8923 
Un™Te¡
::
G‘In¡ªû
()->
Üigš®_wÜkšg_dœ
();

8925 ià(
chdœ
(
Üigš®_dœ
) != 0) {

8926 
D—thTe¡AbÜt
(
¡d
::
¡ršg
("chdœ(\""è+ 
Üigš®_dœ
 + "\") failed: " +

8927 
G‘La¡E¼noDesütiÚ
());

8928  
	gEXIT_FAILURE
;

8936 
execve
(
¬gs
->
¬gv
[0],‡rgs->¬gv, 
G‘EnvœÚ
());

8937 
D—thTe¡AbÜt
(
¡d
::
¡ršg
("execve("è+ 
¬gs
->
¬gv
[0] + ", ...) in " +

8938 
Üigš®_dœ
 + " failed: " +

8939 
G‘La¡E¼noDesütiÚ
());

8940  
	gEXIT_FAILURE
;

8944 #ià
GTEST_HAS_CLONE


8954 
SckLow”ThªAdd»ss
(cÚ¡ * 
±r
,

8955 
boŞ
* 
»suÉ
è
	gGTEST_NO_INLINE_
;

8958 
GTEST_ATTRIBUTE_NO_SANITIZE_HWADDRESS_


8959 
SckLow”ThªAdd»ss
(cÚ¡ * 
±r
, 
boŞ
* 
»suÉ
) {

8960 
	gdummy
;

8961 *
	g»suÉ
 = (&
dummy
 < 
±r
);

8965 
GTEST_ATTRIBUTE_NO_SANITIZE_ADDRESS_


8966 
GTEST_ATTRIBUTE_NO_SANITIZE_HWADDRESS_


8967 
boŞ
 
SckGrowsDown
() {

8968 
	gdummy
 = 0;

8969 
boŞ
 
	g»suÉ
 = 0;

8970 
SckLow”ThªAdd»ss
(&
dummy
, &
»suÉ
);

8971  
	g»suÉ
;

8982 
pid_t
 
ExecD—thTe¡S·wnChd
(* cÚ¡* 
¬gv
, 
şo£_fd
) {

8983 
ExecD—thTe¡Args
 
	g¬gs
 = { 
¬gv
, 
şo£_fd
 };

8984 
pid_t
 
	gchd_pid
 = -1;

8986 #ià
GTEST_OS_QNX


8989 cÚ¡ 
	gcwd_fd
 = 
İ’
(".", 
O_RDONLY
);

8990 
GTEST_DEATH_TEST_CHECK_
(
cwd_fd
 != -1);

8991 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
fú
(
cwd_fd
, 
F_SETFD
, 
FD_CLOEXEC
));

8995 cÚ¡ * cÚ¡ 
	gÜigš®_dœ
 =

8996 
Un™Te¡
::
G‘In¡ªû
()->
Üigš®_wÜkšg_dœ
();

8998 ià(
chdœ
(
Üigš®_dœ
) != 0) {

8999 
D—thTe¡AbÜt
(
¡d
::
¡ršg
("chdœ(\""è+ 
Üigš®_dœ
 + "\") failed: " +

9000 
G‘La¡E¼noDesütiÚ
());

9001  
	gEXIT_FAILURE
;

9004 
	gfd_æags
;

9006 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
fd_æags
 = 
fú
(
şo£_fd
, 
F_GETFD
));

9007 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
fú
(
şo£_fd
, 
F_SETFD
,

9008 
fd_æags
 | 
FD_CLOEXEC
));

9009 
šh”™ªû
 
	gšh”™
 = {0};

9011 
	gchd_pid
 =

9012 
¥awn
(
¬gs
.
¬gv
[0], 0, 
nuÎ±r
, &
šh”™
,‡rgs.¬gv, 
G‘EnvœÚ
());

9014 
GTEST_DEATH_TEST_CHECK_
(
fchdœ
(
cwd_fd
) != -1);

9015 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
şo£
(
cwd_fd
));

9018 #ià
GTEST_OS_LINUX


9022 
sigaùiÚ
 
	g§ved_sig´of_aùiÚ
;

9023 
sigaùiÚ
 
	gignÜe_sig´of_aùiÚ
;

9024 
mem£t
(&
ignÜe_sig´of_aùiÚ
, 0, (ignore_sigprof_action));

9025 
sigem±y£t
(&
ignÜe_sig´of_aùiÚ
.
§_mask
);

9026 
	gignÜe_sig´of_aùiÚ
.
	g§_hªdËr
 = 
SIG_IGN
;

9027 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
sigaùiÚ
(

9028 
SIGPROF
, &
ignÜe_sig´of_aùiÚ
, &
§ved_sig´of_aùiÚ
));

9031 #ià
GTEST_HAS_CLONE


9032 cÚ¡ 
boŞ
 
	gu£_fÜk
 = 
GTEST_FLAG
(
d—th_‹¡_u£_fÜk
);

9034 ià(!
	gu£_fÜk
) {

9035 cÚ¡ 
boŞ
 
	g¡ack_grows_down
 = 
SckGrowsDown
();

9036 cÚ¡‡utØ
	g¡ack_size
 = 
¡©ic_ÿ¡
<
size_t
>(
g‘·gesize
());

9038 * cÚ¡ 
	g¡ack
 = 
mm­
(
nuÎ±r
, 
¡ack_size
, 
PROT_READ
 | 
PROT_WRITE
,

9039 
MAP_ANON
 | 
MAP_PRIVATE
, -1, 0);

9040 
GTEST_DEATH_TEST_CHECK_
(
¡ack
 !ğ
MAP_FAILED
);

9048 cÚ¡ 
size_t
 
	gkMaxSckAlignm’t
 = 64;

9049 * cÚ¡ 
	g¡ack_tİ
 =

9050 
¡©ic_ÿ¡
<*>(
¡ack
) +

9051 (
¡ack_grows_down
 ? 
¡ack_size
 - 
kMaxSckAlignm’t
 : 0);

9052 
GTEST_DEATH_TEST_CHECK_
(

9053 
¡©ic_ÿ¡
<
size_t
>(
¡ack_size
è> 
kMaxSckAlignm’t
 &&

9054 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
¡ack_tİ
è% 
kMaxSckAlignm’t
 == 0);

9056 
	gchd_pid
 = 
şÚe
(&
ExecD—thTe¡ChdMaš
, 
¡ack_tİ
, 
SIGCHLD
, &
¬gs
);

9058 
GTEST_DEATH_TEST_CHECK_
(
munm­
(
¡ack
, 
¡ack_size
) != -1);

9061 cÚ¡ 
boŞ
 
	gu£_fÜk
 = 
Œue
;

9064 ià(
	gu£_fÜk
 && (
	gchd_pid
 = 
fÜk
()) == 0) {

9065 
ExecD—thTe¡ChdMaš
(&
¬gs
);

9066 
_ex™
(0);

9069 #ià
GTEST_OS_LINUX


9070 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(

9071 
sigaùiÚ
(
SIGPROF
, &
§ved_sig´of_aùiÚ
, 
nuÎ±r
));

9074 
GTEST_DEATH_TEST_CHECK_
(
chd_pid
 != -1);

9075  
	gchd_pid
;

9082 
	gD—thTe¡
::
Te¡RŞe
 
ExecD—thTe¡
::
AssumeRŞe
() {

9083 cÚ¡ 
Un™Te¡Im¶
* cÚ¡ 
im¶
 = 
G‘Un™Te¡Im¶
();

9084 cÚ¡ 
IÁ”ÇlRunD—thTe¡FÏg
* cÚ¡ 
	gæag
 =

9085 
im¶
->
š‹º®_run_d—th_‹¡_æag
();

9086 cÚ¡ 
Te¡Info
* cÚ¡ 
	gšfo
 = 
im¶
->
cu¼’t_‹¡_šfo
();

9087 cÚ¡ 
	gd—th_‹¡_šdex
 = 
šfo
->
»suÉ
()->
d—th_‹¡_couÁ
();

9089 ià(
	gæag
 !ğ
nuÎ±r
) {

9090 
£t_wr™e_fd
(
æag
->
wr™e_fd
());

9091  
	gEXECUTE_TEST
;

9094 
	gpe_fd
[2];

9095 
GTEST_DEATH_TEST_CHECK_
(
pe
(
pe_fd
) != -1);

9098 
GTEST_DEATH_TEST_CHECK_
(
fú
(
pe_fd
[1], 
F_SETFD
, 0) != -1);

9100 cÚ¡ 
	g¡d
::
¡ršg
 
f‹r_æag
 = 
¡d
::¡ršg("--"è+ 
GTEST_FLAG_PREFIX_
 +

9101 
kF‹rFÏg
 + "=" + 
šfo
->
‹¡_su™e_Çme
() +

9102 "." + 
šfo
->
Çme
();

9103 cÚ¡ 
	g¡d
::
¡ršg
 
š‹º®_æag
 =

9104 
¡d
::
¡ršg
("--"è+ 
GTEST_FLAG_PREFIX_
 + 
kIÁ”ÇlRunD—thTe¡FÏg
 + "="

9105 + 
fe_
 + "|" + 
SŒ—mabËToSŒšg
(
lše_
) + "|"

9106 + 
SŒ—mabËToSŒšg
(
d—th_‹¡_šdex
) + "|"

9107 + 
SŒ—mabËToSŒšg
(
pe_fd
[1]);

9108 
Argum’ts
 
	g¬gs
;

9109 
	g¬gs
.
AddArgum’ts
(
G‘ArgvsFÜD—thTe¡ChdProûss
());

9110 
	g¬gs
.
AddArgum’t
(
f‹r_æag
.
c_¡r
());

9111 
	g¬gs
.
AddArgum’t
(
š‹º®_æag
.
c_¡r
());

9113 
	gD—thTe¡
::
£t_Ï¡_d—th_‹¡_mes§ge
("");

9115 
C­tu»Std”r
();

9118 
FlushInfoLog
();

9120 cÚ¡ 
pid_t
 
	gchd_pid
 = 
ExecD—thTe¡S·wnChd
(
¬gs
.
Argv
(), 
pe_fd
[0]);

9121 
GTEST_DEATH_TEST_CHECK_SYSCALL_
(
şo£
(
pe_fd
[1]));

9122 
£t_chd_pid
(
chd_pid
);

9123 
£t_»ad_fd
(
pe_fd
[0]);

9124 
£t_¥awÃd
(
Œue
);

9125  
	gOVERSEE_TEST
;

9135 
boŞ
 
	gDeçuÉD—thTe¡FaùÜy
::
C»©e
(cÚ¡ * 
¡©em’t
,

9136 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
,

9137 cÚ¡ * 
fe
, 
lše
,

9138 
D—thTe¡
** 
‹¡
) {

9139 
Un™Te¡Im¶
* cÚ¡ 
	gim¶
 = 
G‘Un™Te¡Im¶
();

9140 cÚ¡ 
IÁ”ÇlRunD—thTe¡FÏg
* cÚ¡ 
	gæag
 =

9141 
im¶
->
š‹º®_run_d—th_‹¡_æag
();

9142 cÚ¡ 
	gd—th_‹¡_šdex
 = 
im¶
->
cu¼’t_‹¡_šfo
()

9143 ->
šüem’t_d—th_‹¡_couÁ
();

9145 ià(
	gæag
 !ğ
nuÎ±r
) {

9146 ià(
d—th_‹¡_šdex
 > 
æag
->
šdex
()) {

9147 
D—thTe¡
::
£t_Ï¡_d—th_‹¡_mes§ge
(

9148 "D—the¡ couÁ (" + 
SŒ—mabËToSŒšg
(
d—th_‹¡_šdex
)

9150 + 
SŒ—mabËToSŒšg
(
æag
->
šdex
()) + ")");

9151  
	gçl£
;

9154 ià(!(
	gæag
->
fe
(è=ğf&& 
æag
->
lše
() ==†ine &&

9155 
æag
->
šdex
(è=ğ
d—th_‹¡_šdex
)) {

9156 *
‹¡
 = 
nuÎ±r
;

9157  
	gŒue
;

9161 #ià
GTEST_OS_WINDOWS


9163 ià(
GTEST_FLAG
(
d—th_‹¡_¡yË
) == "threadsafe" ||

9164 
GTEST_FLAG
(
d—th_‹¡_¡yË
) == "fast") {

9165 *
‹¡
 = 
Ãw
 
WšdowsD—thTe¡
(
¡©em’t
, 
¡d
::
move
(
m©ch”
), 
fe
, 
lše
);

9168 #–ià
GTEST_OS_FUCHSIA


9170 ià(
GTEST_FLAG
(
d—th_‹¡_¡yË
) == "threadsafe" ||

9171 
GTEST_FLAG
(
d—th_‹¡_¡yË
) == "fast") {

9172 *
‹¡
 = 
Ãw
 
FuchsŸD—thTe¡
(
¡©em’t
, 
¡d
::
move
(
m©ch”
), 
fe
, 
lše
);

9177 ià(
GTEST_FLAG
(
d—th_‹¡_¡yË
) == "threadsafe") {

9178 *
‹¡
 = 
Ãw
 
ExecD—thTe¡
(
¡©em’t
, 
¡d
::
move
(
m©ch”
), 
fe
, 
lše
);

9179 } ià(
GTEST_FLAG
(
d—th_‹¡_¡yË
) == "fast") {

9180 *
‹¡
 = 
Ãw
 
NoExecD—thTe¡
(
¡©em’t
, 
¡d
::
move
(
m©ch”
));

9186 
	gD—thTe¡
::
£t_Ï¡_d—th_‹¡_mes§ge
(

9187 "UnknowÀd—the¡ styË \"" + 
GTEST_FLAG
(
d—th_‹¡_¡yË
)

9189  
	gçl£
;

9192  
	gŒue
;

9195 #ià
GTEST_OS_WINDOWS


9199 
G‘StusFeDesütÜ
(
·»Á_´oûss_id
,

9200 
size_t
 
wr™e_hªdË_as_size_t
,

9201 
size_t
 
ev’t_hªdË_as_size_t
) {

9202 
AutoHªdË
 
·»Á_´oûss_hªdË
(::
O³nProûss
(
PROCESS_DUP_HANDLE
,

9203 
FALSE
,

9204 
·»Á_´oûss_id
));

9205 ià(
	g·»Á_´oûss_hªdË
.
G‘
(è=ğ
INVALID_HANDLE_VALUE
) {

9206 
D—thTe¡AbÜt
("Unableo open…arent…rocess " +

9207 
SŒ—mabËToSŒšg
(
·»Á_´oûss_id
));

9210 
GTEST_CHECK_
((
HANDLE
è<ğ(
size_t
));

9212 cÚ¡ 
HANDLE
 
	gwr™e_hªdË
 =

9213 
»š‹½»t_ÿ¡
<
HANDLE
>(
wr™e_hªdË_as_size_t
);

9214 
HANDLE
 
	gdup_wr™e_hªdË
;

9219 ià(!::
Du¶iÿ‹HªdË
(
·»Á_´oûss_hªdË
.
G‘
(), 
wr™e_hªdË
,

9220 ::
G‘Cu¼’tProûss
(), &
dup_wr™e_hªdË
,

9223 
FALSE
,

9224 
DUPLICATE_SAME_ACCESS
)) {

9225 
D—thTe¡AbÜt
("Unableo duplicatehe…ipe handle " +

9226 
SŒ—mabËToSŒšg
(
wr™e_hªdË_as_size_t
) +

9228 
SŒ—mabËToSŒšg
(
·»Á_´oûss_id
));

9231 cÚ¡ 
HANDLE
 
	gev’t_hªdË
 = 
»š‹½»t_ÿ¡
<HANDLE>(
ev’t_hªdË_as_size_t
);

9232 
HANDLE
 
	gdup_ev’t_hªdË
;

9234 ià(!::
Du¶iÿ‹HªdË
(
·»Á_´oûss_hªdË
.
G‘
(), 
ev’t_hªdË
,

9235 ::
G‘Cu¼’tProûss
(), &
dup_ev’t_hªdË
,

9237 
FALSE
,

9238 
DUPLICATE_SAME_ACCESS
)) {

9239 
D—thTe¡AbÜt
("Unableo duplicateheƒvent handle " +

9240 
SŒ—mabËToSŒšg
(
ev’t_hªdË_as_size_t
) +

9242 
SŒ—mabËToSŒšg
(
·»Á_´oûss_id
));

9245 cÚ¡ 
	gwr™e_fd
 =

9246 ::
_İ’_osfhªdË
(
»š‹½»t_ÿ¡
<
šŒ_t
>(
dup_wr™e_hªdË
), 
O_APPEND
);

9247 ià(
	gwr™e_fd
 == -1) {

9248 
D—thTe¡AbÜt
("Unableo convert…ipe handle " +

9249 
SŒ—mabËToSŒšg
(
wr™e_hªdË_as_size_t
) +

9255 ::
S‘Ev’t
(
dup_ev’t_hªdË
);

9257  
	gwr™e_fd
;

9264 
IÁ”ÇlRunD—thTe¡FÏg
* 
P¬£IÁ”ÇlRunD—thTe¡FÏg
() {

9265 ià(
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
è=ğ""è 
nuÎ±r
;

9269 
	glše
 = -1;

9270 
	gšdex
 = -1;

9271 ::
¡d
::
veùÜ
< ::¡d::
¡ršg
> 
f›lds
;

9272 
S¶™SŒšg
(
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
).
c_¡r
(), '|', &
f›lds
);

9273 
	gwr™e_fd
 = -1;

9275 #ià
GTEST_OS_WINDOWS


9277 
	g·»Á_´oûss_id
 = 0;

9278 
size_t
 
	gwr™e_hªdË_as_size_t
 = 0;

9279 
size_t
 
	gev’t_hªdË_as_size_t
 = 0;

9281 ià(
	gf›lds
.
size
() != 6

9282 || !
P¬£N©u¿lNumb”
(
f›lds
[1], &
lše
)

9283 || !
P¬£N©u¿lNumb”
(
f›lds
[2], &
šdex
)

9284 || !
P¬£N©u¿lNumb”
(
f›lds
[3], &
·»Á_´oûss_id
)

9285 || !
P¬£N©u¿lNumb”
(
f›lds
[4], &
wr™e_hªdË_as_size_t
)

9286 || !
P¬£N©u¿lNumb”
(
f›lds
[5], &
ev’t_hªdË_as_size_t
)) {

9287 
D—thTe¡AbÜt
("Bad --gtest_internal_run_death_test flag: " +

9288 
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
));

9290 
	gwr™e_fd
 = 
G‘StusFeDesütÜ
(
·»Á_´oûss_id
,

9291 
wr™e_hªdË_as_size_t
,

9292 
ev’t_hªdË_as_size_t
);

9294 #–ià
GTEST_OS_FUCHSIA


9296 ià(
	gf›lds
.
size
() != 3

9297 || !
P¬£N©u¿lNumb”
(
f›lds
[1], &
lše
)

9298 || !
P¬£N©u¿lNumb”
(
f›lds
[2], &
šdex
)) {

9299 
D—thTe¡AbÜt
("Bad --gtest_internal_run_death_test flag: "

9300 + 
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
));

9305 ià(
	gf›lds
.
size
() != 4

9306 || !
P¬£N©u¿lNumb”
(
f›lds
[1], &
lše
)

9307 || !
P¬£N©u¿lNumb”
(
f›lds
[2], &
šdex
)

9308 || !
P¬£N©u¿lNumb”
(
f›lds
[3], &
wr™e_fd
)) {

9309 
D—thTe¡AbÜt
("Bad --gtest_internal_run_death_test flag: "

9310 + 
GTEST_FLAG
(
š‹º®_run_d—th_‹¡
));

9315  
Ãw
 
IÁ”ÇlRunD—thTe¡FÏg
(
f›lds
[0], 
lše
, 
šdex
, 
wr™e_fd
);

9353 
	~<¡dlib.h
>

9355 #ià
GTEST_OS_WINDOWS_MOBILE


9356 
	~<wšdows.h
>

9357 #–ià
GTEST_OS_WINDOWS


9358 
	~<dœeù.h
>

9359 
	~<io.h
>

9361 
	~<lim™s.h
>

9362 
	~<şim™s
>

9366 #ià
GTEST_OS_WINDOWS


9367 
	#GTEST_PATH_MAX_
 
_MAX_PATH


	)

9368 #–ià
defšed
(
PATH_MAX
)

9369 
	#GTEST_PATH_MAX_
 
PATH_MAX


	)

9370 #–ià
defšed
(
_XOPEN_PATH_MAX
)

9371 
	#GTEST_PATH_MAX_
 
_XOPEN_PATH_MAX


	)

9373 
	#GTEST_PATH_MAX_
 
_POSIX_PATH_MAX


	)

9376 
Çme¥aû
 
	g‹¡šg
 {

9377 
Çme¥aû
 
	gš‹º®
 {

9379 #ià
GTEST_OS_WINDOWS


9384 cÚ¡ 
	gkP©hS•¬©Ü
 = '\\';

9385 cÚ¡ 
	gkAÉ”Ç‹P©hS•¬©Ü
 = '/';

9386 cÚ¡ 
	gkAÉ”Ç‹P©hS•¬©ÜSŒšg
[] = "/";

9387 #ià
GTEST_OS_WINDOWS_MOBILE


9391 cÚ¡ 
	gkCu¼’tDœeùÜySŒšg
[] = "\\";

9393 cÚ¡ 
DWORD
 
	gkInv®idFeA‰ribu‹s
 = 0xffffffff;

9395 cÚ¡ 
	gkCu¼’tDœeùÜySŒšg
[] = ".\\";

9398 cÚ¡ 
	gkP©hS•¬©Ü
 = '/';

9399 cÚ¡ 
	gkCu¼’tDœeùÜySŒšg
[] = "./";

9403 
boŞ
 
IsP©hS•¬©Ü
(
c
) {

9404 #ià
GTEST_HAS_ALT_PATH_SEP_


9405  (
	gc
 =ğ
kP©hS•¬©Ü
è|| (
c
 =ğ
kAÉ”Ç‹P©hS•¬©Ü
);

9407  
	gc
 =ğ
kP©hS•¬©Ü
;

9412 
FeP©h
 
	gFeP©h
::
G‘Cu¼’tDœ
() {

9413 #ià
GTEST_OS_WINDOWS_MOBILE
 || 
GTEST_OS_WINDOWS_PHONE
 || \

9414 
GTEST_OS_WINDOWS_RT
 || 
ARDUINO
 || 
defšed
(
ESP_PLATFORM
)

9417  
FeP©h
(
kCu¼’tDœeùÜySŒšg
);

9418 #–ià
GTEST_OS_WINDOWS


9419 
	gcwd
[
GTEST_PATH_MAX_
 + 1] = { '\0' };

9420  
FeP©h
(
_g‘cwd
(
cwd
, (cwd)è=ğ
nuÎ±r
 ? "" : cwd);

9422 
	gcwd
[
GTEST_PATH_MAX_
 + 1] = { '\0' };

9423 * 
	g»suÉ
 = 
g‘cwd
(
cwd
, (cwd));

9424 #ià
GTEST_OS_NACL


9428  
FeP©h
(
»suÉ
 =ğ
nuÎ±r
 ? 
kCu¼’tDœeùÜySŒšg
 : 
cwd
);

9430  
FeP©h
(
»suÉ
 =ğ
nuÎ±r
 ? "" : 
cwd
);

9438 
FeP©h
 
	gFeP©h
::
RemoveEx‹nsiÚ
(cÚ¡ * 
ex‹nsiÚ
) const {

9439 cÚ¡ 
¡d
::
¡ršg
 
dÙ_ex‹nsiÚ
 = std::¡ršg("."è+ 
ex‹nsiÚ
;

9440 ià(
	gSŒšg
::
EndsW™hCa£In£ns™ive
(
·thÇme_
, 
dÙ_ex‹nsiÚ
)) {

9441  
FeP©h
(
·thÇme_
.
sub¡r
(

9442 0, 
·thÇme_
.
Ëngth
(è- 
dÙ_ex‹nsiÚ
.length()));

9444  *
	gthis
;

9450 cÚ¡ * 
	gFeP©h
::
FšdLa¡P©hS•¬©Ü
() const {

9451 cÚ¡ * cÚ¡ 
Ï¡_£p
 = 
¡¼chr
(
c_¡r
(), 
kP©hS•¬©Ü
);

9452 #ià
GTEST_HAS_ALT_PATH_SEP_


9453 cÚ¡ * cÚ¡ 
	gÏ¡_®t_£p
 = 
¡¼chr
(
c_¡r
(), 
kAÉ”Ç‹P©hS•¬©Ü
);

9455 ià(
	gÏ¡_®t_£p
 !ğ
nuÎ±r
 &&

9456 (
Ï¡_£p
 =ğ
nuÎ±r
 || 
Ï¡_®t_£p
 >†ast_sep)) {

9457  
Ï¡_®t_£p
;

9460  
	gÏ¡_£p
;

9469 
FeP©h
 
	gFeP©h
::
RemoveDœeùÜyName
() const {

9470 cÚ¡ * cÚ¡ 
Ï¡_£p
 = 
FšdLa¡P©hS•¬©Ü
();

9471  
	gÏ¡_£p
 ? 
FeP©h
(
Ï¡_£p
 + 1è: *
this
;

9480 
FeP©h
 
	gFeP©h
::
RemoveFeName
() const {

9481 cÚ¡ * cÚ¡ 
Ï¡_£p
 = 
FšdLa¡P©hS•¬©Ü
();

9482 
	g¡d
::
¡ršg
 
dœ
;

9483 ià(
	gÏ¡_£p
) {

9484 
	gdœ
 = 
¡d
::
¡ršg
(
c_¡r
(), 
¡©ic_ÿ¡
<
size_t
>(
Ï¡_£p
 + 1 - c_str()));

9486 
	gdœ
 = 
kCu¼’tDœeùÜySŒšg
;

9488  
FeP©h
(
dœ
);

9497 
FeP©h
 
	gFeP©h
::
MakeFeName
(cÚ¡ FeP©h& 
dœeùÜy
,

9498 cÚ¡ 
FeP©h
& 
ba£_Çme
,

9499 
numb”
,

9500 cÚ¡ * 
ex‹nsiÚ
) {

9501 
	g¡d
::
¡ršg
 
fe
;

9502 ià(
	gnumb”
 == 0) {

9503 
fe
 = 
ba£_Çme
.
¡ršg
(è+ "." + 
ex‹nsiÚ
;

9505 
	gfe
 = 
ba£_Çme
.
¡ršg
(è+ "_" + 
SŒ—mabËToSŒšg
(
numb”
)

9506 + "." + 
ex‹nsiÚ
;

9508  
CÚÿtP©hs
(
dœeùÜy
, 
FeP©h
(
fe
));

9513 
FeP©h
 
	gFeP©h
::
CÚÿtP©hs
(cÚ¡ FeP©h& 
dœeùÜy
,

9514 cÚ¡ 
FeP©h
& 
»Ïtive_·th
) {

9515 ià(
	gdœeùÜy
.
IsEm±y
())

9516  
	g»Ïtive_·th
;

9517 cÚ¡ 
FeP©h
 
dœ
(
dœeùÜy
.
RemoveT¿šgP©hS•¬©Ü
());

9518  
FeP©h
(
dœ
.
¡ršg
(è+ 
kP©hS•¬©Ü
 + 
»Ïtive_·th
.string());

9523 
boŞ
 
	gFeP©h
::
FeOrDœeùÜyExi¡s
() const {

9524 #ià
GTEST_OS_WINDOWS_MOBILE


9525 
LPCWSTR
 
unicode
 = 
SŒšg
::
AnsiToUtf16
(
·thÇme_
.
c_¡r
());

9526 cÚ¡ 
DWORD
 
	g©Œibu‹s
 = 
G‘FeA‰ribu‹s
(
unicode
);

9527 
	gd–‘e
 [] 
	gunicode
;

9528  
	g©Œibu‹s
 !ğ
kInv®idFeA‰ribu‹s
;

9530 
	gposix
::
StSŒuù
 
fe_¡©
;

9531  
	gposix
::
St
(
·thÇme_
.
c_¡r
(), &
fe_¡©
) == 0;

9537 
boŞ
 
	gFeP©h
::
DœeùÜyExi¡s
() const {

9538 
boŞ
 
»suÉ
 = 
çl£
;

9539 #ià
GTEST_OS_WINDOWS


9542 cÚ¡ 
	gFeP©h
& 
·th
(
IsRoÙDœeùÜy
(è? *
this
 :

9543 
RemoveT¿šgP©hS•¬©Ü
());

9545 cÚ¡ 
	gFeP©h
& 
·th
(*
this
);

9548 #ià
GTEST_OS_WINDOWS_MOBILE


9549 
LPCWSTR
 
	gunicode
 = 
SŒšg
::
AnsiToUtf16
(
·th
.
c_¡r
());

9550 cÚ¡ 
DWORD
 
	g©Œibu‹s
 = 
G‘FeA‰ribu‹s
(
unicode
);

9551 
	gd–‘e
 [] 
	gunicode
;

9552 ià((
	g©Œibu‹s
 !ğ
kInv®idFeA‰ribu‹s
) &&

9553 (
©Œibu‹s
 & 
FILE_ATTRIBUTE_DIRECTORY
)) {

9554 
»suÉ
 = 
Œue
;

9557 
	gposix
::
StSŒuù
 
fe_¡©
;

9558 
	g»suÉ
 = 
posix
::
St
(
·th
.
c_¡r
(), &
fe_¡©
) == 0 &&

9559 
posix
::
IsDœ
(
fe_¡©
);

9562  
	g»suÉ
;

9567 
boŞ
 
	gFeP©h
::
IsRoÙDœeùÜy
() const {

9568 #ià
GTEST_OS_WINDOWS


9569  
·thÇme_
.
Ëngth
(è=ğ3 && 
IsAbsŞu‹P©h
();

9571  
	g·thÇme_
.
Ëngth
(è=ğ1 && 
IsP©hS•¬©Ü
(
·thÇme_
.
c_¡r
()[0]);

9576 
boŞ
 
	gFeP©h
::
IsAbsŞu‹P©h
() const {

9577 cÚ¡ * cÚ¡ 
Çme
 = 
·thÇme_
.
c_¡r
();

9578 #ià
GTEST_OS_WINDOWS


9579  
	g·thÇme_
.
Ëngth
() >= 3 &&

9580 ((
Çme
[0] >= 'a' &&‚ame[0] <= 'z') ||

9581 (
Çme
[0] >= 'A' &&‚ame[0] <= 'Z')) &&

9582 
Çme
[1] == ':' &&

9583 
IsP©hS•¬©Ü
(
Çme
[2]);

9585  
IsP©hS•¬©Ü
(
Çme
[0]);

9597 
FeP©h
 
	gFeP©h
::
G’”©eUniqueFeName
(cÚ¡ FeP©h& 
dœeùÜy
,

9598 cÚ¡ 
FeP©h
& 
ba£_Çme
,

9599 cÚ¡ * 
ex‹nsiÚ
) {

9600 
FeP©h
 
	gfuÎ_·thÇme
;

9601 
	gnumb”
 = 0;

9603 
	gfuÎ_·thÇme
.
S‘
(
MakeFeName
(
dœeùÜy
, 
ba£_Çme
, 
numb”
++, 
ex‹nsiÚ
));

9604 } 
	gfuÎ_·thÇme
.
FeOrDœeùÜyExi¡s
());

9605  
	gfuÎ_·thÇme
;

9611 
boŞ
 
	gFeP©h
::
IsDœeùÜy
() const {

9612  !
·thÇme_
.
em±y
() &&

9613 
IsP©hS•¬©Ü
(
·thÇme_
.
c_¡r
()[·thÇme_.
Ëngth
() - 1]);

9619 
boŞ
 
	gFeP©h
::
C»©eDœeùÜ›sRecursiv–y
() const {

9620 ià(!
this
->
IsDœeùÜy
()) {

9621  
çl£
;

9624 ià(
	g·thÇme_
.
Ëngth
(è=ğ0 || 
this
->
DœeùÜyExi¡s
()) {

9625  
Œue
;

9628 cÚ¡ 
FeP©h
 
·»Á
(
this
->
RemoveT¿šgP©hS•¬©Ü
().
RemoveFeName
());

9629  
	g·»Á
.
C»©eDœeùÜ›sRecursiv–y
(è&& 
	gthis
->
C»©eFŞd”
();

9636 
boŞ
 
	gFeP©h
::
C»©eFŞd”
() const {

9637 #ià
GTEST_OS_WINDOWS_MOBILE


9638 
FeP©h
 
»moved_£p
(
this
->
RemoveT¿šgP©hS•¬©Ü
());

9639 
LPCWSTR
 
	gunicode
 = 
SŒšg
::
AnsiToUtf16
(
»moved_£p
.
c_¡r
());

9640 
	g»suÉ
 = 
C»©eDœeùÜy
(
unicode
, 
nuÎ±r
) ? 0 : -1;

9641 
	gd–‘e
 [] 
	gunicode
;

9642 #–ià
GTEST_OS_WINDOWS


9643 
	g»suÉ
 = 
_mkdœ
(
·thÇme_
.
c_¡r
());

9645 
	g»suÉ
 = 
mkdœ
(
·thÇme_
.
c_¡r
(), 0777);

9648 ià(
	g»suÉ
 == -1) {

9649  
this
->
DœeùÜyExi¡s
();

9651  
	gŒue
;

9657 
FeP©h
 
	gFeP©h
::
RemoveT¿šgP©hS•¬©Ü
() const {

9658  
IsDœeùÜy
()

9659 ? 
FeP©h
(
·thÇme_
.
sub¡r
(0,…©hÇme_.
Ëngth
() - 1))

9660 : *
this
;

9666 
	gFeP©h
::
NÜm®ize
() {

9667 ià(
·thÇme_
.
c_¡r
(è=ğ
nuÎ±r
) {

9668 
·thÇme_
 = "";

9671 cÚ¡ * 
	g¤c
 = 
·thÇme_
.
c_¡r
();

9672 * cÚ¡ 
	gde¡
 = 
Ãw
 [
·thÇme_
.
Ëngth
() + 1];

9673 * 
	gde¡_±r
 = 
de¡
;

9674 
mem£t
(
de¡_±r
, 0, 
·thÇme_
.
Ëngth
() + 1);

9676 *
	g¤c
 != '\0') {

9677 *
de¡_±r
 = *
¤c
;

9678 ià(!
IsP©hS•¬©Ü
(*
¤c
)) {

9679 
	g¤c
++;

9681 #ià
GTEST_HAS_ALT_PATH_SEP_


9682 ià(*
	gde¡_±r
 =ğ
kAÉ”Ç‹P©hS•¬©Ü
) {

9683 *
de¡_±r
 = 
kP©hS•¬©Ü
;

9686 
IsP©hS•¬©Ü
(*
¤c
))

9687 
	g¤c
++;

9689 
	gde¡_±r
++;

9691 *
	gde¡_±r
 = '\0';

9692 
	g·thÇme_
 = 
de¡
;

9693 
	gd–‘e
[] 
	gde¡
;

9733 
	~<¡ršg
>

9735 
Çme¥aû
 
	g‹¡šg
 {

9739 
	gM©ch”
<cÚ¡ 
	g¡d
::
¡ršg
&>::
M©ch”
(cÚ¡ 
¡d
::¡ršg& 
s
è{ *
this
 = 
Eq
(s); }

9743 
	gM©ch”
<cÚ¡ 
	g¡d
::
¡ršg
&>::
M©ch”
(cÚ¡ * 
s
) {

9744 *
this
 = 
Eq
(
¡d
::
¡ršg
(
s
));

9749 
	gM©ch”
<
	g¡d
::
¡ršg
>::
M©ch”
(cÚ¡ 
¡d
::¡ršg& 
s
è{ *
this
 = 
Eq
(s); }

9753 
	gM©ch”
<
	g¡d
::
¡ršg
>::
M©ch”
(cÚ¡ * 
s
è{ *
this
 = 
Eq
(
¡d
::string(s)); }

9755 #ià
GTEST_HAS_ABSL


9758 
	gM©ch”
<cÚ¡ 
	gab¦
::
¡ršg_v›w
&>::
M©ch”
(cÚ¡ 
¡d
::
¡ršg
& 
s
) {

9759 *
this
 = 
Eq
(
s
);

9764 
	gM©ch”
<cÚ¡ 
	gab¦
::
¡ršg_v›w
&>::
M©ch”
(cÚ¡ * 
s
) {

9765 *
this
 = 
Eq
(
¡d
::
¡ršg
(
s
));

9770 
	gM©ch”
<cÚ¡ 
	gab¦
::
¡ršg_v›w
&>::
M©ch”
(
ab¦
::¡ršg_v›w 
s
) {

9771 *
this
 = 
Eq
(
¡d
::
¡ršg
(
s
));

9776 
	gM©ch”
<
	gab¦
::
¡ršg_v›w
>::
M©ch”
(cÚ¡ 
¡d
::
¡ršg
& 
s
è{ *
this
 = 
Eq
(s); }

9780 
	gM©ch”
<
	gab¦
::
¡ršg_v›w
>::
M©ch”
(cÚ¡ * 
s
) {

9781 *
this
 = 
Eq
(
¡d
::
¡ršg
(
s
));

9786 
	gM©ch”
<
	gab¦
::
¡ršg_v›w
>::
M©ch”
(
ab¦
::¡ršg_v›w 
s
) {

9787 *
this
 = 
Eq
(
¡d
::
¡ršg
(
s
));

9823 
	~<lim™s.h
>

9824 
	~<¡dio.h
>

9825 
	~<¡dlib.h
>

9826 
	~<¡ršg.h
>

9827 
	~<f¡»am
>

9828 
	~<memÜy
>

9830 #ià
GTEST_OS_WINDOWS


9831 
	~<wšdows.h
>

9832 
	~<io.h
>

9833 
	~<sys/¡©.h
>

9834 
	~<m­
>

9835 #ifdeà
_MSC_VER


9836 
	~<ütdbg.h
>

9839 
	~<uni¡d.h
>

9842 #ià
GTEST_OS_MAC


9843 
	~<mach/mach_š™.h
>

9844 
	~<mach/sk.h
>

9845 
	~<mach/vm_m­.h
>

9848 #ià
GTEST_OS_DRAGONFLY
 || 
GTEST_OS_FREEBSD
 || 
GTEST_OS_GNU_KFREEBSD
 || \

9849 
	gGTEST_OS_NETBSD
 || 
	gGTEST_OS_OPENBSD


9850 
	~<sys/sysùl.h
>

9851 #ià
GTEST_OS_DRAGONFLY
 || 
GTEST_OS_FREEBSD
 || 
GTEST_OS_GNU_KFREEBSD


9852 
	~<sys/u£r.h
>

9856 #ià
GTEST_OS_QNX


9857 
	~<devùl.h
>

9858 
	~<fú.h
>

9859 
	~<sys/´ocfs.h
>

9862 #ià
GTEST_OS_AIX


9863 
	~<´ocšfo.h
>

9864 
	~<sys/ty³s.h
>

9867 #ià
GTEST_OS_FUCHSIA


9868 
	~<zœcÚ/´oûss.h
>

9869 
	~<zœcÚ/sysÿÎs.h
>

9873 
Çme¥aû
 
	g‹¡šg
 {

9874 
Çme¥aû
 
	gš‹º®
 {

9876 #ià
defšed
(
_MSC_VER
è|| defšed(
__BORLANDC__
)

9878 cÚ¡ 
	gkStdOutF’o
 = 1;

9879 cÚ¡ 
	gkStdE¼F’o
 = 2;

9881 cÚ¡ 
	gkStdOutF’o
 = 
STDOUT_FILENO
;

9882 cÚ¡ 
	gkStdE¼F’o
 = 
STDERR_FILENO
;

9885 #ià
GTEST_OS_LINUX


9887 
	gÇme¥aû
 {

9888 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9889 
T
 
R—dProcFeF›ld
(cÚ¡ 
¡d
::
¡ršg
& 
f’ame
, 
f›ld
) {

9890 
	g¡d
::
¡ršg
 
dummy
;

9891 
	g¡d
::
if¡»am
 
fe
(
f’ame
.
c_¡r
());

9892 
	gf›ld
-- > 0) {

9893 
	gfe
 >> 
	gdummy
;

9895 
T
 
	gouut
 = 0;

9896 
	gfe
 >> 
	gouut
;

9897  
	gouut
;

9902 
size_t
 
G‘Th»adCouÁ
() {

9903 cÚ¡ 
	g¡d
::
¡ršg
 
f’ame
 =

9904 (
Mes§ge
(è<< "/´oc/" << 
g‘pid
(è<< "/¡©").
G‘SŒšg
();

9905  
	gR—dProcFeF›ld
<
	gsize_t
>(
	gf’ame
, 19);

9908 #–ià
GTEST_OS_MAC


9910 
size_t
 
G‘Th»adCouÁ
() {

9911 cÚ¡ 
sk_t
 
	gsk
 = 
mach_sk_£lf
();

9912 
mach_msg_ty³_numb”_t
 
	gth»ad_couÁ
;

9913 
th»ad_aù_¬¿y_t
 
	gth»ad_li¡
;

9914 cÚ¡ 
k”n_»tuº_t
 
	g¡©us
 = 
sk_th»ads
(
sk
, &
th»ad_li¡
, &
th»ad_couÁ
);

9915 ià(
	g¡©us
 =ğ
KERN_SUCCESS
) {

9918 
vm_d—Îoÿ‹
(
sk
,

9919 
»š‹½»t_ÿ¡
<
vm_add»ss_t
>(
th»ad_li¡
),

9920 (
th»ad_t
è* 
th»ad_couÁ
);

9921  
	g¡©ic_ÿ¡
<
	gsize_t
>(
	gth»ad_couÁ
);

9927 #–ià
GTEST_OS_DRAGONFLY
 || 
GTEST_OS_FREEBSD
 || 
GTEST_OS_GNU_KFREEBSD
 || \

9928 
	gGTEST_OS_NETBSD


9930 #ià
GTEST_OS_NETBSD


9931 #undeà
KERN_PROC


9932 
	#KERN_PROC
 
KERN_PROC2


	)

9933 
	#kšfo_´oc
 
kšfo_´oc2


	)

9936 #ià
GTEST_OS_DRAGONFLY


9937 
	#KP_NLWP
(
kp
è(kp.
kp_Áh»ads
)

	)

9938 #–ià
GTEST_OS_FREEBSD
 || 
GTEST_OS_GNU_KFREEBSD


9939 
	#KP_NLWP
(
kp
è(kp.
ki_numth»ads
)

	)

9940 #–ià
GTEST_OS_NETBSD


9941 
	#KP_NLWP
(
kp
è(kp.
p_Æwps
)

	)

9946 
size_t
 
G‘Th»adCouÁ
() {

9947 
	gmib
[] = {

9948 
CTL_KERN
,

9949 
KERN_PROC
,

9950 
KERN_PROC_PID
,

9951 
g‘pid
(),

9952 #ià
GTEST_OS_NETBSD


9953 (
kšfo_´oc
),

9957 
u_št
 
	gmibËn
 = (
mib
) / (mib[0]);

9958 
kšfo_´oc
 
	gšfo
;

9959 
size_t
 
	gsize
 = (
šfo
);

9960 ià(
sysùl
(
mib
, 
mibËn
, &
šfo
, &
size
, 
NULL
, 0)) {

9963  
	g¡©ic_ÿ¡
<
	gsize_t
>(
KP_NLWP
(
šfo
));

9965 #–ià
GTEST_OS_OPENBSD


9969 
size_t
 
G‘Th»adCouÁ
() {

9970 
	gmib
[] = {

9971 
CTL_KERN
,

9972 
KERN_PROC
,

9973 
KERN_PROC_PID
 | 
KERN_PROC_SHOW_THREADS
,

9974 
g‘pid
(),

9975 (
kšfo_´oc
),

9978 
u_št
 
	gmibËn
 = (
mib
) / (mib[0]);

9981 
size_t
 
	gsize
;

9982 ià(
sysùl
(
mib
, 
mibËn
, 
NULL
, &
size
, NULL, 0)) {

9985 
	gmib
[5] = 
size
 / 
mib
[4];

9988 
kšfo_´oc
 
	gšfo
[
mib
[5]];

9989 ià(
sysùl
(
mib
, 
mibËn
, &
šfo
, &
size
, 
NULL
, 0)) {

9994 
	gÁh»ads
 = 0;

9995 
	gi
 = 0; i < 
	gsize
 / 
	gmib
[4]; i++) {

9996 ià(
	gšfo
[
i
].
	gp_tid
 != -1)

9997 
Áh»ads
++;

9999  
	gÁh»ads
;

10002 #–ià
GTEST_OS_QNX


10006 
size_t
 
G‘Th»adCouÁ
() {

10007 cÚ¡ 
	gfd
 = 
İ’
("/´oc/£lf/as", 
O_RDONLY
);

10008 ià(
	gfd
 < 0) {

10011 
´ocfs_šfo
 
	g´oûss_šfo
;

10012 cÚ¡ 
	g¡©us
 =

10013 
devùl
(
fd
, 
DCMD_PROC_INFO
, &
´oûss_šfo
, Õroûss_šfo), 
nuÎ±r
);

10014 
şo£
(
fd
);

10015 ià(
	g¡©us
 =ğ
EOK
) {

10016  
¡©ic_ÿ¡
<
size_t
>(
´oûss_šfo
.
num_th»ads
);

10022 #–ià
GTEST_OS_AIX


10024 
size_t
 
G‘Th»adCouÁ
() {

10025 
´oûÁry64
 
	g’Œy
;

10026 
pid_t
 
	gpid
 = 
g‘pid
();

10027 
	g¡©us
 = 
g‘´ocs64
(&
’Œy
, ÓÁry), 
nuÎ±r
, 0, &
pid
, 1);

10028 ià(
	g¡©us
 == 1) {

10029  
’Œy
.
pi_thcouÁ
;

10035 #–ià
GTEST_OS_FUCHSIA


10037 
size_t
 
G‘Th»adCouÁ
() {

10038 
	gdummy_bufãr
;

10039 
size_t
 
	gava
;

10040 
zx_¡©us_t
 
	g¡©us
 = 
zx_objeù_g‘_šfo
(

10041 
zx_´oûss_£lf
(),

10042 
ZX_INFO_PROCESS_THREADS
,

10043 &
dummy_bufãr
,

10045 
nuÎ±r
,

10046 &
ava
);

10047 ià(
	g¡©us
 =ğ
ZX_OK
) {

10048  
ava
;

10056 
size_t
 
G‘Th»adCouÁ
() {

10064 #ià
GTEST_IS_THREADSAFE
 && 
GTEST_OS_WINDOWS


10066 
SË•Mli£cÚds
(
n
) {

10067 ::
SË•
(
¡©ic_ÿ¡
<
DWORD
>(
n
));

10070 
	gAutoHªdË
::
AutoHªdË
()

10071 : 
hªdË_
(
INVALID_HANDLE_VALUE
) {}

10073 
AutoHªdË
::AutoHªdË(
HªdË
 
hªdË
)

10074 : 
hªdË_
(
hªdË
) {}

10076 
AutoHªdË
::~AutoHandle() {

10077 
Re£t
();

10080 
	gAutoHªdË
::
HªdË
 
AutoHªdË
::
G‘
() const {

10081  
hªdË_
;

10084 
	gAutoHªdË
::
Re£t
() {

10085 
Re£t
(
INVALID_HANDLE_VALUE
);

10088 
	gAutoHªdË
::
Re£t
(
HANDLE
 
hªdË
) {

10090 ià(
hªdË_
 !ğ
hªdË
) {

10091 ià(
IsClo£abË
()) {

10092 ::
Clo£HªdË
(
hªdË_
);

10094 
	ghªdË_
 = 
hªdË
;

10096 
GTEST_CHECK_
(!
IsClo£abË
())

10102 
boŞ
 
	gAutoHªdË
::
IsClo£abË
() const {

10105  
hªdË_
 !ğ
nuÎ±r
 && hªdË_ !ğ
INVALID_HANDLE_VALUE
;

10108 
	gNÙifiÿtiÚ
::
NÙifiÿtiÚ
()

10109 : 
ev’t_
(::
C»©eEv’t
(
nuÎ±r
,

10110 
TRUE
,

10111 
FALSE
,

10112 
nuÎ±r
)) {

10113 
GTEST_CHECK_
(
ev’t_
.
G‘
(è!ğ
nuÎ±r
);

10116 
	gNÙifiÿtiÚ
::
NÙify
() {

10117 
GTEST_CHECK_
(::
S‘Ev’t
(
ev’t_
.
G‘
()è!ğ
FALSE
);

10120 
	gNÙifiÿtiÚ
::
Wa™FÜNÙifiÿtiÚ
() {

10121 
GTEST_CHECK_
(

10122 ::
Wa™FÜSšgËObjeù
(
ev’t_
.
G‘
(), 
INFINITE
è=ğ
WAIT_OBJECT_0
);

10125 
	gMu‹x
::
Mu‹x
()

10126 : 
owÃr_th»ad_id_
(0),

10127 
ty³_
(
kDyÇmic
),

10128 
ü™iÿl_£ùiÚ_š™_pha£_
(0),

10129 
ü™iÿl_£ùiÚ_
(
Ãw
 
CRITICAL_SECTION
) {

10130 ::
In™ŸlizeCr™iÿlSeùiÚ
(
ü™iÿl_£ùiÚ_
);

10133 
	gMu‹x
::~
Mu‹x
() {

10136 ià(
ty³_
 =ğ
kDyÇmic
) {

10137 ::
D–‘eCr™iÿlSeùiÚ
(
ü™iÿl_£ùiÚ_
);

10138 
d–‘e
 
	gü™iÿl_£ùiÚ_
;

10139 
	gü™iÿl_£ùiÚ_
 = 
nuÎ±r
;

10143 
	gMu‹x
::
Lock
() {

10144 
Th»adSaãLazyIn™
();

10145 ::
EÁ”Cr™iÿlSeùiÚ
(
ü™iÿl_£ùiÚ_
);

10146 
	gowÃr_th»ad_id_
 = ::
G‘Cu¼’tTh»adId
();

10149 
	gMu‹x
::
UÆock
() {

10150 
Th»adSaãLazyIn™
();

10154 
	gowÃr_th»ad_id_
 = 0;

10155 ::
L—veCr™iÿlSeùiÚ
(
ü™iÿl_£ùiÚ_
);

10160 
	gMu‹x
::
As£¹H–d
() {

10161 
Th»adSaãLazyIn™
();

10162 
GTEST_CHECK_
(
owÃr_th»ad_id_
 =ğ::
G‘Cu¼’tTh»adId
())

10163 << "Thcu¼’ˆth»ad i nÙ hŞdšghmu‹x @" << 
this
;

10166 
	gÇme¥aû
 {

10168 #ifdeà
_MSC_VER


10177 şas 
	cMemÜyIsNÙD—Îoÿ‹d


10179 
	gpublic
:

10180 
MemÜyIsNÙD—Îoÿ‹d
(è: 
Şd_ütdbg_æag_
(0) {

10181 
Şd_ütdbg_æag_
 = 
_C¹S‘DbgFÏg
(
_CRTDBG_REPORT_FLAG
);

10184 
_C¹S‘DbgFÏg
(
Şd_ütdbg_æag_
 & ~
_CRTDBG_ALLOC_MEM_DF
);

10187 ~
MemÜyIsNÙD—Îoÿ‹d
() {

10189 
_C¹S‘DbgFÏg
(
Şd_ütdbg_æag_
);

10192 
	g´iv©e
:

10193 
Şd_ütdbg_æag_
;

10195 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
MemÜyIsNÙD—Îoÿ‹d
);

10202 
	gMu‹x
::
Th»adSaãLazyIn™
() {

10204 ià(
ty³_
 =ğ
kStic
) {

10206 ::
IÁ”lockedCom·»Exchªge
(&
ü™iÿl_£ùiÚ_š™_pha£_
, 1L, 0L)) {

10210 
owÃr_th»ad_id_
 = 0;

10213 #ifdeà
_MSC_VER


10214 
MemÜyIsNÙD—Îoÿ‹d
 
	gmemÜy_is_nÙ_d—Îoÿ‹d
;

10216 
	gü™iÿl_£ùiÚ_
 = 
Ãw
 
CRITICAL_SECTION
;

10218 ::
In™ŸlizeCr™iÿlSeùiÚ
(
ü™iÿl_£ùiÚ_
);

10221 
GTEST_CHECK_
(::
IÁ”lockedCom·»Exchªge
(

10222 &
ü™iÿl_£ùiÚ_š™_pha£_
, 2L, 1L) ==

10228 ::
IÁ”lockedCom·»Exchªge
(&
ü™iÿl_£ùiÚ_š™_pha£_
,

10233 ::
SË•
(0);

10241 
GTEST_CHECK_
(
çl£
)

10248 
	gÇme¥aû
 {

10250 şas 
	cTh»adW™hP¬amSuµÜt
 : 
public
 
Th»adW™hP¬amBa£
 {

10251 
public
:

10252 
HANDLE
 
C»©eTh»ad
(
RuÂabË
* 
ruÂabË
,

10253 
NÙifiÿtiÚ
* 
th»ad_ÿn_¡¬t
) {

10254 
Th»adMašP¬am
* 
	g·¿m
 = 
Ãw
 Th»adMašP¬am(
ruÂabË
, 
th»ad_ÿn_¡¬t
);

10255 
DWORD
 
	gth»ad_id
;

10256 
HANDLE
 
	gth»ad_hªdË
 = ::
C»©eTh»ad
(

10257 
nuÎ±r
,

10259 &
Th»adW™hP¬amSuµÜt
::
Th»adMaš
,

10260 
·¿m
,

10262 &
th»ad_id
);

10263 
GTEST_CHECK_
(
th»ad_hªdË
 !ğ
nuÎ±r
)

10264 << "C»©eTh»ad faed w™hƒ¼Ü " << ::
G‘La¡E¼Ü
() << ".";

10265 ià(
	gth»ad_hªdË
 =ğ
nuÎ±r
) {

10266 
d–‘e
 
·¿m
;

10268  
	gth»ad_hªdË
;

10271 
	g´iv©e
:

10272 
	sTh»adMašP¬am
 {

10273 
Th»adMašP¬am
(
RuÂabË
* 
ruÂabË
, 
NÙifiÿtiÚ
* 
th»ad_ÿn_¡¬t
)

10274 : 
ruÂabË_
(
ruÂabË
),

10275 
th»ad_ÿn_¡¬t_
(
th»ad_ÿn_¡¬t
) {

10277 
	g¡d
::
unique_±r
<
RuÂabË
> 
ruÂabË_
;

10279 
NÙifiÿtiÚ
* 
	gth»ad_ÿn_¡¬t_
;

10282 
DWORD
 
WINAPI
 
Th»adMaš
(* 
±r
) {

10284 
	g¡d
::
unique_±r
<
Th»adMašP¬am
> 
·¿m
(
¡©ic_ÿ¡
<Th»adMašP¬am*>(
±r
));

10285 ià(
	g·¿m
->
	gth»ad_ÿn_¡¬t_
 !ğ
nuÎ±r
)

10286 
·¿m
->
th»ad_ÿn_¡¬t_
->
Wa™FÜNÙifiÿtiÚ
();

10287 
	g·¿m
->
	gruÂabË_
->
Run
();

10292 
Th»adW™hP¬amSuµÜt
();

10294 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Th»adW™hP¬amSuµÜt
);

10299 
	gTh»adW™hP¬amBa£
::
Th»adW™hP¬amBa£
(
RuÂabË
 *
ruÂabË
,

10300 
NÙifiÿtiÚ
* 
th»ad_ÿn_¡¬t
)

10301 : 
th»ad_
(
Th»adW™hP¬amSuµÜt
::
C»©eTh»ad
(
ruÂabË
,

10302 
th»ad_ÿn_¡¬t
)) {

10305 
	gTh»adW™hP¬amBa£
::~
Th»adW™hP¬amBa£
() {

10306 
Još
();

10309 
	gTh»adW™hP¬amBa£
::
Još
() {

10310 
GTEST_CHECK_
(::
Wa™FÜSšgËObjeù
(
th»ad_
.
G‘
(), 
INFINITE
è=ğ
WAIT_OBJECT_0
)

10311 << "FaedØjošhth»ad w™hƒ¼Ü " << ::
G‘La¡E¼Ü
() << ".";

10318 şas 
	cTh»adLoÿlRegi¡ryIm¶
 {

10319 
	gpublic
:

10322 
Th»adLoÿlV®ueHŞd”Ba£
* 
G‘V®ueOnCu¼’tTh»ad
(

10323 cÚ¡ 
Th»adLoÿlBa£
* 
th»ad_loÿl_š¡ªû
) {

10324 
DWORD
 
cu¼’t_th»ad
 = ::
G‘Cu¼’tTh»adId
();

10325 
Mu‹xLock
 
lock
(&
mu‹x_
);

10326 
Th»adIdToTh»adLoÿls
* cÚ¡ 
	gth»ad_to_th»ad_loÿls
 =

10327 
G‘Th»adLoÿlsM­Locked
();

10328 
	gTh»adIdToTh»adLoÿls
::
™”©Ü
 
th»ad_loÿl_pos
 =

10329 
th»ad_to_th»ad_loÿls
->
fšd
(
cu¼’t_th»ad
);

10330 ià(
	gth»ad_loÿl_pos
 =ğ
th»ad_to_th»ad_loÿls
->
’d
()) {

10331 
th»ad_loÿl_pos
 = 
th»ad_to_th»ad_loÿls
->
š£¹
(

10332 
¡d
::
make_·œ
(
cu¼’t_th»ad
, 
Th»adLoÿlV®ues
())).
	gfœ¡
;

10333 
S¹W©ch”Th»adFÜ
(
cu¼’t_th»ad
);

10335 
	gTh»adLoÿlV®ues
& 
	gth»ad_loÿl_v®ues
 = 
th»ad_loÿl_pos
->
£cÚd
;

10336 
	gTh»adLoÿlV®ues
::
™”©Ü
 
v®ue_pos
 =

10337 
th»ad_loÿl_v®ues
.
fšd
(
th»ad_loÿl_š¡ªû
);

10338 ià(
	gv®ue_pos
 =ğ
th»ad_loÿl_v®ues
.
’d
()) {

10339 
v®ue_pos
 =

10340 
th»ad_loÿl_v®ues


10341 .
š£¹
(
¡d
::
make_·œ
(

10342 
th»ad_loÿl_š¡ªû
,

10343 
¡d
::
sh¬ed_±r
<
Th»adLoÿlV®ueHŞd”Ba£
>(

10344 
th»ad_loÿl_š¡ªû
->
NewV®ueFÜCu¼’tTh»ad
())))

10345 .
fœ¡
;

10347  
	gv®ue_pos
->
	g£cÚd
.
g‘
();

10350 
OnTh»adLoÿlDe¡royed
(

10351 cÚ¡ 
Th»adLoÿlBa£
* 
th»ad_loÿl_š¡ªû
) {

10352 
	g¡d
::
veùÜ
<
¡d
::
sh¬ed_±r
<
Th»adLoÿlV®ueHŞd”Ba£
> > 
v®ue_hŞd”s
;

10356 
Mu‹xLock
 
lock
(&
mu‹x_
);

10357 
Th»adIdToTh»adLoÿls
* cÚ¡ 
	gth»ad_to_th»ad_loÿls
 =

10358 
G‘Th»adLoÿlsM­Locked
();

10359 
	gTh»adIdToTh»adLoÿls
::
™”©Ü
 
™
 =

10360 
th»ad_to_th»ad_loÿls
->
begš
();

10361 
	g™
 !ğ
th»ad_to_th»ad_loÿls
->
’d
();

10362 ++
	g™
) {

10363 
	gTh»adLoÿlV®ues
& 
	gth»ad_loÿl_v®ues
 = 
™
->
£cÚd
;

10364 
	gTh»adLoÿlV®ues
::
™”©Ü
 
v®ue_pos
 =

10365 
th»ad_loÿl_v®ues
.
fšd
(
th»ad_loÿl_š¡ªû
);

10366 ià(
	gv®ue_pos
 !ğ
th»ad_loÿl_v®ues
.
’d
()) {

10367 
v®ue_hŞd”s
.
push_back
(
v®ue_pos
->
£cÚd
);

10368 
	gth»ad_loÿl_v®ues
.
”a£
(
v®ue_pos
);

10378 
OnTh»adEx™
(
DWORD
 
th»ad_id
) {

10379 
GTEST_CHECK_
(
th»ad_id
 !ğ0è<< ::
G‘La¡E¼Ü
();

10380 
	g¡d
::
veùÜ
<
¡d
::
sh¬ed_±r
<
Th»adLoÿlV®ueHŞd”Ba£
> > 
v®ue_hŞd”s
;

10384 
Mu‹xLock
 
lock
(&
mu‹x_
);

10385 
Th»adIdToTh»adLoÿls
* cÚ¡ 
	gth»ad_to_th»ad_loÿls
 =

10386 
G‘Th»adLoÿlsM­Locked
();

10387 
	gTh»adIdToTh»adLoÿls
::
™”©Ü
 
th»ad_loÿl_pos
 =

10388 
th»ad_to_th»ad_loÿls
->
fšd
(
th»ad_id
);

10389 ià(
	gth»ad_loÿl_pos
 !ğ
th»ad_to_th»ad_loÿls
->
’d
()) {

10390 
Th»adLoÿlV®ues
& 
th»ad_loÿl_v®ues
 = 
th»ad_loÿl_pos
->
£cÚd
;

10391 
	gTh»adLoÿlV®ues
::
™”©Ü
 
v®ue_pos
 =

10392 
th»ad_loÿl_v®ues
.
begš
();

10393 
	gv®ue_pos
 !ğ
th»ad_loÿl_v®ues
.
’d
();

10394 ++
	gv®ue_pos
) {

10395 
	gv®ue_hŞd”s
.
push_back
(
v®ue_pos
->
£cÚd
);

10397 
	gth»ad_to_th»ad_loÿls
->
”a£
(
th»ad_loÿl_pos
);

10404 
	g´iv©e
:

10406 
¡d
::
	tm­
<cÚ¡ 
	tTh»adLoÿlBa£
*,

10407 
	t¡d
::
	tsh¬ed_±r
<
	tTh»adLoÿlV®ueHŞd”Ba£
> >

10408 
	tTh»adLoÿlV®ues
;

10411 
	g¡d
::
	tm­
<
	tDWORD
, 
	tTh»adLoÿlV®ues
> 
	tTh»adIdToTh»adLoÿls
;

10415 
	g¡d
::
	t·œ
<
	tDWORD
, 
	tHANDLE
> 
	tTh»adIdAndHªdË
;

10417 
S¹W©ch”Th»adFÜ
(
DWORD
 
th»ad_id
) {

10420 
HANDLE
 
	gth»ad
 = ::
O³nTh»ad
(
SYNCHRONIZE
 | 
THREAD_QUERY_INFORMATION
,

10421 
FALSE
,

10422 
th»ad_id
);

10423 
GTEST_CHECK_
(
th»ad
 !ğ
nuÎ±r
);

10426 
DWORD
 
	gw©ch”_th»ad_id
;

10427 
HANDLE
 
	gw©ch”_th»ad
 = ::
C»©eTh»ad
(

10428 
nuÎ±r
,

10430 &
Th»adLoÿlRegi¡ryIm¶
::
W©ch”Th»adFunc
,

10431 
»š‹½»t_ÿ¡
<
LPVOID
>(
Ãw
 
Th»adIdAndHªdË
(
th»ad_id
, 
th»ad
)),

10432 
CREATE_SUSPENDED
, &
w©ch”_th»ad_id
);

10433 
GTEST_CHECK_
(
w©ch”_th»ad
 !ğ
nuÎ±r
);

10436 ::
S‘Th»adPriÜ™y
(
w©ch”_th»ad
,

10437 ::
G‘Th»adPriÜ™y
(::
G‘Cu¼’tTh»ad
()));

10438 ::
ResumeTh»ad
(
w©ch”_th»ad
);

10439 ::
Clo£HªdË
(
w©ch”_th»ad
);

10444 
DWORD
 
WINAPI
 
W©ch”Th»adFunc
(
LPVOID
 
·¿m
) {

10445 cÚ¡ 
Th»adIdAndHªdË
* 
	gh
 =

10446 
»š‹½»t_ÿ¡
<cÚ¡ 
Th»adIdAndHªdË
*>(
·¿m
);

10447 
GTEST_CHECK_
(

10448 ::
Wa™FÜSšgËObjeù
(
h
->
£cÚd
, 
INFINITE
è=ğ
WAIT_OBJECT_0
);

10449 
OnTh»adEx™
(
h
->
fœ¡
);

10450 ::
Clo£HªdË
(
h
->
£cÚd
);

10451 
d–‘e
 
	gh
;

10456 
Th»adIdToTh»adLoÿls
* 
G‘Th»adLoÿlsM­Locked
() {

10457 
	gmu‹x_
.
As£¹H–d
();

10458 #ifdeà
_MSC_VER


10459 
MemÜyIsNÙD—Îoÿ‹d
 
	gmemÜy_is_nÙ_d—Îoÿ‹d
;

10461 
Th»adIdToTh»adLoÿls
* 
	gm­
 = 
Ãw
 ThreadIdToThreadLocals();

10462  
	gm­
;

10466 
Mu‹x
 
	gmu‹x_
;

10468 
Mu‹x
 
	gth»ad_m­_mu‹x_
;

10471 
Mu‹x
 
	gTh»adLoÿlRegi¡ryIm¶
::
mu‹x_
(Mu‹x::
kSticMu‹x
);

10472 
Mu‹x
 
	gTh»adLoÿlRegi¡ryIm¶
::
th»ad_m­_mu‹x_
(Mu‹x::
kSticMu‹x
);

10474 
Th»adLoÿlV®ueHŞd”Ba£
* 
	gTh»adLoÿlRegi¡ry
::
G‘V®ueOnCu¼’tTh»ad
(

10475 cÚ¡ 
Th»adLoÿlBa£
* 
th»ad_loÿl_š¡ªû
) {

10476  
Th»adLoÿlRegi¡ryIm¶
::
G‘V®ueOnCu¼’tTh»ad
(

10477 
th»ad_loÿl_š¡ªû
);

10480 
	gTh»adLoÿlRegi¡ry
::
OnTh»adLoÿlDe¡royed
(

10481 cÚ¡ 
Th»adLoÿlBa£
* 
th»ad_loÿl_š¡ªû
) {

10482 
Th»adLoÿlRegi¡ryIm¶
::
OnTh»adLoÿlDe¡royed
(
th»ad_loÿl_š¡ªû
);

10487 #ià
GTEST_USES_POSIX_RE


10491 
	gRE
::~
RE
() {

10492 ià(
is_v®id_
) {

10497 
»gä“
(&
·¹Ÿl_»gex_
);

10498 
»gä“
(&
fuÎ_»gex_
);

10500 
ä“
(
cÚ¡_ÿ¡
<*>(
·‰”n_
));

10504 
boŞ
 
	gRE
::
FuÎM©ch
(cÚ¡ * 
¡r
, cÚ¡ 
RE
& 
»
) {

10505 ià(!
	g»
.
	gis_v®id_
è 
	gçl£
;

10507 
»gm©ch_t
 
	gm©ch
;

10508  
»gexec
(&
»
.
fuÎ_»gex_
, 
¡r
, 1, &
m©ch
, 0) == 0;

10513 
boŞ
 
	gRE
::
P¬tŸlM©ch
(cÚ¡ * 
¡r
, cÚ¡ 
RE
& 
»
) {

10514 ià(!
	g»
.
	gis_v®id_
è 
	gçl£
;

10516 
»gm©ch_t
 
	gm©ch
;

10517  
»gexec
(&
»
.
·¹Ÿl_»gex_
, 
¡r
, 1, &
m©ch
, 0) == 0;

10521 
	gRE
::
In™
(cÚ¡ * 
»gex
) {

10522 
·‰”n_
 = 
posix
::
SŒDup
(
»gex
);

10526 cÚ¡ 
size_t
 
	gfuÎ_»gex_Ën
 = 
¡¾’
(
»gex
) + 10;

10527 * cÚ¡ 
	gfuÎ_·‰”n
 = 
Ãw
 [
fuÎ_»gex_Ën
];

10529 
¢´štf
(
fuÎ_·‰”n
, 
fuÎ_»gex_Ën
, "^(%s)$", 
»gex
);

10530 
	gis_v®id_
 = 
»gcomp
(&
fuÎ_»gex_
, 
fuÎ_·‰”n
, 
REG_EXTENDED
) == 0;

10539 ià(
	gis_v®id_
) {

10540 cÚ¡ * cÚ¡ 
	g·¹Ÿl_»gex
 = (*
»gex
 == '\0') ? "()" :„egex;

10541 
	gis_v®id_
 = 
»gcomp
(&
·¹Ÿl_»gex_
, 
·¹Ÿl_»gex
, 
REG_EXTENDED
) == 0;

10543 
EXPECT_TRUE
(
is_v®id_
)

10544 << "ReguÏ¸ex´essiÚ \"" << 
	g»gex


10547 
	gd–‘e
[] 
	gfuÎ_·‰”n
;

10550 #–ià
GTEST_USES_SIMPLE_RE


10554 
boŞ
 
IsInS‘
(
ch
, cÚ¡ * 
¡r
) {

10555  
	gch
 !ğ'\0' && 
¡rchr
(
¡r
, 
ch
è!ğ
nuÎ±r
;

10561 
boŞ
 
IsAsciiDig™
(
ch
) {  '0' <= ch && ch <= '9'; }

10562 
boŞ
 
IsAsciiPunù
(
ch
) {

10563  
IsInS‘
(
ch
, "^-!\"#$%&'()*+,./:;<=>?@[\\]_`{|}~");

10565 
boŞ
 
IsR•—t
(
ch
è{  
IsInS‘
(ch, "?*+"); }

10566 
boŞ
 
IsAsciiWh™eS·û
(
ch
è{  
IsInS‘
(ch, " \f\n\r\t\v"); }

10567 
boŞ
 
IsAsciiWÜdCh¬
(
ch
) {

10568  ('a' <ğ
ch
 && ch <= 'z') || ('A' <= ch && ch <= 'Z') ||

10569 ('0' <ğ
ch
 && ch <= '9') || ch == '_';

10573 
boŞ
 
IsV®idEsÿ³
(
c
) {

10574  (
IsAsciiPunù
(
c
è|| 
IsInS‘
(c, "dDfnrsStvwW"));

10579 
boŞ
 
AtomM©chesCh¬
(boŞ 
esÿ³d
, 
·‰”n_ch¬
, 
ch
) {

10580 ià(
	gesÿ³d
) {

10581 
	g·‰”n_ch¬
) {

10582 'd':  
IsAsciiDig™
(
ch
);

10583 'D':  !
IsAsciiDig™
(
ch
);

10584 'f':  
ch
 == '\f';

10585 'n':  
ch
 == '\n';

10586 'r':  
ch
 == '\r';

10587 's':  
IsAsciiWh™eS·û
(
ch
);

10588 'S':  !
IsAsciiWh™eS·û
(
ch
);

10589 't':  
ch
 == '\t';

10590 'v':  
ch
 == '\v';

10591 'w':  
IsAsciiWÜdCh¬
(
ch
);

10592 'W':  !
IsAsciiWÜdCh¬
(
ch
);

10594  
IsAsciiPunù
(
·‰”n_ch¬
è&& 
	g·‰”n_ch¬
 =ğ
ch
;

10597  (
	g·‰”n_ch¬
 =ğ'.' && 
ch
 !ğ'\n'è|| 
·‰”n_ch¬
 == ch;

10601 
	g¡d
::
¡ršg
 
FÜm©RegexSyÁaxE¼Ü
(cÚ¡ * 
»gex
, 
šdex
) {

10602  (
Mes§ge
(è<< "SyÁaxƒ¼Ü‡ˆšdex " << 
	gšdex


10603 << " iÀsim¶»guÏ¸ex´essiÚ \"" << 
	g»gex
 << "\": ").
G‘SŒšg
();

10608 
boŞ
 
V®id©eRegex
(cÚ¡ * 
»gex
) {

10609 ià(
	g»gex
 =ğ
nuÎ±r
) {

10610 
ADD_FAILURE
() << "NULL is‚ot‡ valid simple„egularƒxpression.";

10611  
	gçl£
;

10614 
boŞ
 
	gis_v®id
 = 
Œue
;

10617 
boŞ
 
	g´ev_»³©abË
 = 
çl£
;

10618 
	gi
 = 0; 
	g»gex
[
i
]; i++) {

10619 ià(
	g»gex
[
i
] == '\\') {

10620 
i
++;

10621 ià(
	g»gex
[
i
] == '\0') {

10622 
ADD_FAILURE
(è<< 
FÜm©RegexSyÁaxE¼Ü
(
»gex
, 
i
 - 1)

10624  
	gçl£
;

10627 ià(!
IsV®idEsÿ³
(
»gex
[
i
])) {

10628 
ADD_FAILURE
(è<< 
FÜm©RegexSyÁaxE¼Ü
(
»gex
, 
i
 - 1)

10629 << "šv®idƒsÿ³ sequ’û \"\\" << 
	g»gex
[
i
] << "\".";

10630 
	gis_v®id
 = 
çl£
;

10632 
	g´ev_»³©abË
 = 
Œue
;

10634 cÚ¡ 
	gch
 = 
»gex
[
i
];

10636 ià(
	gch
 =ğ'^' && 
i
 > 0) {

10637 
ADD_FAILURE
(è<< 
FÜm©RegexSyÁaxE¼Ü
(
»gex
, 
i
)

10639 
	gis_v®id
 = 
çl£
;

10640 } ià(
	gch
 =ğ'$' && 
»gex
[
i
 + 1] != '\0') {

10641 
ADD_FAILURE
(è<< 
FÜm©RegexSyÁaxE¼Ü
(
»gex
, 
i
)

10643 
	gis_v®id
 = 
çl£
;

10644 } ià(
IsInS‘
(
ch
, "()[]{}|")) {

10645 
ADD_FAILURE
(è<< 
FÜm©RegexSyÁaxE¼Ü
(
»gex
, 
i
)

10646 << "'" << 
	gch
 << "' is unsupported.";

10647 
	gis_v®id
 = 
çl£
;

10648 } ià(
IsR•—t
(
ch
è&& !
	g´ev_»³©abË
) {

10649 
ADD_FAILURE
(è<< 
FÜm©RegexSyÁaxE¼Ü
(
»gex
, 
i
)

10650 << "'" << 
	gch
 << "' can only follow‡„epeatableoken.";

10651 
	gis_v®id
 = 
çl£
;

10654 
	g´ev_»³©abË
 = !
IsInS‘
(
ch
, "^$?*+");

10658  
	gis_v®id
;

10668 
boŞ
 
M©chR•‘™iÚAndRegexAtH—d
(

10669 
boŞ
 
esÿ³d
, 
c
, 
»³©
, cÚ¡ * 
»gex
,

10670 cÚ¡ * 
¡r
) {

10671 cÚ¡ 
size_t
 
	gmš_couÁ
 = (
»³©
 == '+') ? 1 : 0;

10672 cÚ¡ 
size_t
 
	gmax_couÁ
 = (
»³©
 == '?') ? 1 :

10673 
¡©ic_ÿ¡
<
size_t
>(-1) - 1;

10677 
size_t
 
	gi
 = 0; i <ğ
max_couÁ
; ++i) {

10679 ià(
	gi
 >ğ
mš_couÁ
 && 
M©chRegexAtH—d
(
»gex
, 
¡r
 + 
i
)) {

10684  
	gŒue
;

10686 ià(
	g¡r
[
i
] =ğ'\0' || !
AtomM©chesCh¬
(
esÿ³d
, 
c
, 
¡r
[i]))

10687  
	gçl£
;

10689  
	gçl£
;

10695 
boŞ
 
M©chRegexAtH—d
(cÚ¡ * 
»gex
, cÚ¡ * 
¡r
) {

10696 ià(*
	g»gex
 == '\0')

10697  
Œue
;

10701 ià(*
	g»gex
 == '$')

10702  *
¡r
 == '\0';

10705 cÚ¡ 
boŞ
 
	gesÿ³d
 = *
»gex
 == '\\';

10706 ià(
	gesÿ³d
)

10707 ++
	g»gex
;

10708 ià(
IsR•—t
(
»gex
[1])) {

10712  
M©chR•‘™iÚAndRegexAtH—d
(

10713 
esÿ³d
, 
»gex
[0],„egex[1],„egex + 2, 
¡r
);

10718  (*
	g¡r
 !ğ'\0'è&& 
AtomM©chesCh¬
(
esÿ³d
, *
»gex
, *
¡r
) &&

10719 
M©chRegexAtH—d
(
»gex
 + 1, 
¡r
 + 1);

10731 
boŞ
 
M©chRegexAnywh”e
(cÚ¡ * 
»gex
, cÚ¡ * 
¡r
) {

10732 ià(
	g»gex
 =ğ
nuÎ±r
 || 
¡r
 =ğnuÎ±rè 
çl£
;

10734 ià(*
	g»gex
 == '^')

10735  
M©chRegexAtH—d
(
»gex
 + 1, 
¡r
);

10739 ià(
M©chRegexAtH—d
(
»gex
, 
¡r
))

10740  
	gŒue
;

10741 } *
	g¡r
++ != '\0');

10742  
	gçl£
;

10747 
	gRE
::~
RE
() {

10748 
ä“
(
cÚ¡_ÿ¡
<*>(
·‰”n_
));

10749 
ä“
(
cÚ¡_ÿ¡
<*>(
fuÎ_·‰”n_
));

10753 
boŞ
 
	gRE
::
FuÎM©ch
(cÚ¡ * 
¡r
, cÚ¡ 
RE
& 
»
) {

10754  
	g»
.
	gis_v®id_
 && 
M©chRegexAnywh”e
(
»
.
fuÎ_·‰”n_
, 
¡r
);

10759 
boŞ
 
	gRE
::
P¬tŸlM©ch
(cÚ¡ * 
¡r
, cÚ¡ 
RE
& 
»
) {

10760  
	g»
.
	gis_v®id_
 && 
M©chRegexAnywh”e
(
»
.
·‰”n_
, 
¡r
);

10764 
	gRE
::
In™
(cÚ¡ * 
»gex
) {

10765 
·‰”n_
 = 
fuÎ_·‰”n_
 = 
nuÎ±r
;

10766 ià(
	g»gex
 !ğ
nuÎ±r
) {

10767 
·‰”n_
 = 
posix
::
SŒDup
(
»gex
);

10770 
	gis_v®id_
 = 
V®id©eRegex
(
»gex
);

10771 ià(!
	gis_v®id_
) {

10776 cÚ¡ 
size_t
 
	gËn
 = 
¡¾’
(
»gex
);

10780 * 
	gbufãr
 = 
¡©ic_ÿ¡
<*>(
m®loc
(
Ën
 + 3));

10781 
	gfuÎ_·‰”n_
 = 
bufãr
;

10783 ià(*
	g»gex
 != '^')

10784 *
bufãr
++ = '^';

10788 
memıy
(
bufãr
, 
»gex
, 
Ën
);

10789 
	gbufãr
 +ğ
Ën
;

10791 ià(
	gËn
 =ğ0 || 
»gex
[
Ën
 - 1] != '$')

10792 *
bufãr
++ = '$';

10794 *
	gbufãr
 = '\0';

10799 cÚ¡ 
	gkUnknownFe
[] = "unknown file";

10803 
	gGTEST_API_
 ::
¡d
::
¡ršg
 
FÜm©FeLoÿtiÚ
(cÚ¡ * 
fe
, 
lše
) {

10804 cÚ¡ 
	g¡d
::
¡ršg
 
fe_Çme
(
fe
 =ğ
nuÎ±r
 ? 
kUnknownFe
 : file);

10806 ià(
	glše
 < 0) {

10807  
	gfe_Çme
 + ":";

10809 #ifdeà
_MSC_VER


10810  
	gfe_Çme
 + "(" + 
SŒ—mabËToSŒšg
(
lše
) + "):";

10812  
	gfe_Çme
 + ":" + 
SŒ—mabËToSŒšg
(
lše
) + ":";

10821 
	gGTEST_API_
 ::
¡d
::
¡ršg
 
FÜm©Comp”Ind•’d’tFeLoÿtiÚ
(

10822 cÚ¡ * 
fe
, 
lše
) {

10823 cÚ¡ 
	g¡d
::
¡ršg
 
fe_Çme
(
fe
 =ğ
nuÎ±r
 ? 
kUnknownFe
 : file);

10825 ià(
	glše
 < 0)

10826  
	gfe_Çme
;

10828  
	gfe_Çme
 + ":" + 
SŒ—mabËToSŒšg
(
lše
);

10831 
	gGTe¡Log
::
GTe¡Log
(
GTe¡LogSev”™y
 
£v”™y
, cÚ¡ * 
fe
, 
lše
)

10832 : 
£v”™y_
(
£v”™y
) {

10833 cÚ¡ * cÚ¡ 
m¬k”
 =

10834 
£v”™y
 =ğ
GTEST_INFO
 ? "[ INFO ]" :

10835 
£v”™y
 =ğ
GTEST_WARNING
 ? "[WARNING]" :

10836 
£v”™y
 =ğ
GTEST_ERROR
 ? "[ ERROR ]" : "[ FATAL ]";

10837 
G‘SŒ—m
(è<< ::
¡d
::
’dl
 << 
m¬k”
 << " "

10838 << 
FÜm©FeLoÿtiÚ
(
fe
, 
lše
).
c_¡r
() << ": ";

10842 
	gGTe¡Log
::~
GTe¡Log
() {

10843 
G‘SŒ—m
(è<< ::
¡d
::
’dl
;

10844 ià(
	g£v”™y_
 =ğ
GTEST_FATAL
) {

10845 
fæush
(
¡d”r
);

10846 
	gposix
::
AbÜt
();

10852 
GTEST_DISABLE_MSC_DEPRECATED_PUSH_
()

10854 #ià
GTEST_HAS_STREAM_REDIRECTION


10857 şas 
	cC­tu»dSŒ—m
 {

10858 
	gpublic
:

10860 
ex¶ic™
 
C­tu»dSŒ—m
(
fd
è: 
fd_
(fd), 
unÿ±u»d_fd_
(
dup
(fd)) {

10861 #ià
GTEST_OS_WINDOWS


10862 
	g‹mp_dœ_·th
[
MAX_PATH
 + 1] = { '\0' };

10863 
	g‹mp_fe_·th
[
MAX_PATH
 + 1] = { '\0' };

10865 ::
G‘TempP©hA
((
‹mp_dœ_·th
),emp_dir_path);

10866 cÚ¡ 
UINT
 
	gsucûss
 = ::
G‘TempFeNameA
(
‹mp_dœ_·th
,

10869 
‹mp_fe_·th
);

10870 
GTEST_CHECK_
(
sucûss
 != 0)

10871 << "UÇbËØü—‹‡empÜ¬y fš " << 
‹mp_dœ_·th
;

10872 cÚ¡ 
	gÿ±u»d_fd
 = 
ü—t
(
‹mp_fe_·th
, 
_S_IREAD
 | 
_S_IWRITE
);

10873 
GTEST_CHECK_
(
ÿ±u»d_fd
 != -1) << "Unableo openemporary file "

10874 << 
‹mp_fe_·th
;

10875 
	gf’ame_
 = 
‹mp_fe_·th
;

10881 #ià
GTEST_OS_LINUX_ANDROID


10893 
	gÇme_‹m¶©e
[] = "/data/local/tmp/gtest_captured_stream.XXXXXX";

10895 
	gÇme_‹m¶©e
[] = "/tmp/captured_stream.XXXXXX";

10897 cÚ¡ 
	gÿ±u»d_fd
 = 
mk¡emp
(
Çme_‹m¶©e
);

10898 ià(
	gÿ±u»d_fd
 == -1) {

10899 
GTEST_LOG_
(
WARNING
)

10900 << "FaedØü—‹m°f" << 
Çme_‹m¶©e


10903 
	gf’ame_
 = 
Çme_‹m¶©e
;

10905 
fæush
(
nuÎ±r
);

10906 
dup2
(
ÿ±u»d_fd
, 
fd_
);

10907 
şo£
(
ÿ±u»d_fd
);

10910 ~
C­tu»dSŒ—m
() {

10911 
»move
(
f’ame_
.
c_¡r
());

10914 
	g¡d
::
¡ršg
 
G‘C­tu»dSŒšg
() {

10915 ià(
unÿ±u»d_fd_
 != -1) {

10917 
fæush
(
nuÎ±r
);

10918 
dup2
(
unÿ±u»d_fd_
, 
fd_
);

10919 
şo£
(
unÿ±u»d_fd_
);

10920 
	gunÿ±u»d_fd_
 = -1;

10923 
FILE
* cÚ¡ 
	gfe
 = 
posix
::
FO³n
(
f’ame_
.
c_¡r
(), "r");

10924 ià(
	gfe
 =ğ
nuÎ±r
) {

10925 
GTEST_LOG_
(
FATAL
è<< "FaedØİ’m°f" << 
f’ame_


10928 cÚ¡ 
	g¡d
::
¡ršg
 
cÚ‹Á
 = 
R—dEÁœeFe
(
fe
);

10929 
	gposix
::
FClo£
(
fe
);

10930  
	gcÚ‹Á
;

10933 
	g´iv©e
:

10934 cÚ¡ 
fd_
;

10935 
	gunÿ±u»d_fd_
;

10937 ::
¡d
::
¡ršg
 
f’ame_
;

10939 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
C­tu»dSŒ—m
);

10942 
GTEST_DISABLE_MSC_DEPRECATED_POP_
()

10944 
C­tu»dSŒ—m
* 
	gg_ÿ±u»d_¡d”r
 = 
nuÎ±r
;

10945 
C­tu»dSŒ—m
* 
	gg_ÿ±u»d_¡dout
 = 
nuÎ±r
;

10948 
C­tu»SŒ—m
(
fd
, cÚ¡ * 
¡»am_Çme
,

10949 
C­tu»dSŒ—m
** 
¡»am
) {

10950 ià(*
	g¡»am
 !ğ
nuÎ±r
) {

10951 
GTEST_LOG_
(
FATAL
è<< "OÆy oÃ " << 
¡»am_Çme


10954 *
	g¡»am
 = 
Ãw
 
C­tu»dSŒ—m
(
fd
);

10958 
	g¡d
::
¡ršg
 
G‘C­tu»dSŒ—m
(
C­tu»dSŒ—m
** 
ÿ±u»d_¡»am
) {

10959 cÚ¡ 
¡d
::
¡ršg
 
cÚ‹Á
 = (*
ÿ±u»d_¡»am
)->
G‘C­tu»dSŒšg
();

10961 
d–‘e
 *
	gÿ±u»d_¡»am
;

10962 *
	gÿ±u»d_¡»am
 = 
nuÎ±r
;

10964  
	gcÚ‹Á
;

10968 
C­tu»Stdout
() {

10969 
C­tu»SŒ—m
(
kStdOutF’o
, "¡dout", &
g_ÿ±u»d_¡dout
);

10973 
C­tu»Std”r
() {

10974 
C­tu»SŒ—m
(
kStdE¼F’o
, "¡d”r", &
g_ÿ±u»d_¡d”r
);

10978 
	g¡d
::
¡ršg
 
G‘C­tu»dStdout
() {

10979  
G‘C­tu»dSŒ—m
(&
g_ÿ±u»d_¡dout
);

10983 
	g¡d
::
¡ršg
 
G‘C­tu»dStd”r
() {

10984  
G‘C­tu»dSŒ—m
(&
g_ÿ±u»d_¡d”r
);

10993 
size_t
 
G‘FeSize
(
FILE
* 
fe
) {

10994 
f£ek
(
fe
, 0, 
SEEK_END
);

10995  
	g¡©ic_ÿ¡
<
	gsize_t
>(
á–l
(
fe
));

10998 
	g¡d
::
¡ršg
 
R—dEÁœeFe
(
FILE
* 
fe
) {

10999 cÚ¡ 
size_t
 
fe_size
 = 
G‘FeSize
(
fe
);

11000 * cÚ¡ 
	gbufãr
 = 
Ãw
 [
fe_size
];

11002 
size_t
 
	gby‹s_Ï¡_»ad
 = 0;

11003 
size_t
 
	gby‹s_»ad
 = 0;

11005 
f£ek
(
fe
, 0, 
SEEK_SET
);

11010 
	gby‹s_Ï¡_»ad
 = 
ä—d
(
bufãr
+
by‹s_»ad
, 1, 
fe_size
-by‹s_»ad, 
fe
);

11011 
	gby‹s_»ad
 +ğ
by‹s_Ï¡_»ad
;

11012 } 
	gby‹s_Ï¡_»ad
 > 0 && 
	gby‹s_»ad
 < 
	gfe_size
);

11014 cÚ¡ 
	g¡d
::
¡ršg
 
cÚ‹Á
(
bufãr
, 
by‹s_»ad
);

11015 
	gd–‘e
[] 
	gbufãr
;

11017  
	gcÚ‹Á
;

11020 #ià
GTEST_HAS_DEATH_TEST


11021 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>* 
g_šjeùed_‹¡_¬gvs
 =

11022 
nuÎ±r
;

11024 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
G‘InjeùabËArgvs
() {

11025 ià(
g_šjeùed_‹¡_¬gvs
 !ğ
nuÎ±r
) {

11026  *
g_šjeùed_‹¡_¬gvs
;

11028  
G‘Argvs
();

11031 
S‘InjeùabËArgvs
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>* 
Ãw_¬gvs
) {

11032 ià(
g_šjeùed_‹¡_¬gvs
 !ğ
Ãw_¬gvs
è
d–‘e
 g_injected_test_argvs;

11033 
	gg_šjeùed_‹¡_¬gvs
 = 
Ãw_¬gvs
;

11036 
S‘InjeùabËArgvs
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
Ãw_¬gvs
) {

11037 
S‘InjeùabËArgvs
(

11038 
Ãw
 
¡d
::
veùÜ
<¡d::
¡ršg
>(
Ãw_¬gvs
.
begš
(),‚ew_¬gvs.
’d
()));

11041 
CË¬InjeùabËArgvs
() {

11042 
d–‘e
 
	gg_šjeùed_‹¡_¬gvs
;

11043 
	gg_šjeùed_‹¡_¬gvs
 = 
nuÎ±r
;

11047 #ià
GTEST_OS_WINDOWS_MOBILE


11048 
Çme¥aû
 
	gposix
 {

11049 
AbÜt
() {

11050 
DebugB»ak
();

11051 
T”mš©eProûss
(
G‘Cu¼’tProûss
(), 1);

11059 
	g¡d
::
¡ršg
 
FÏgToEnvV¬
(cÚ¡ * 
æag
) {

11060 cÚ¡ 
¡d
::
¡ršg
 
fuÎ_æag
 =

11061 (
Mes§ge
(è<< 
GTEST_FLAG_PREFIX_
 << 
æag
).
G‘SŒšg
();

11063 
Mes§ge
 
	g’v_v¬
;

11064 
size_t
 
	gi
 = 0; i !ğ
fuÎ_æag
.
Ëngth
(); i++) {

11065 
	g’v_v¬
 << 
ToUµ”
(
fuÎ_æag
.
c_¡r
()[
i
]);

11068  
	g’v_v¬
.
G‘SŒšg
();

11074 
boŞ
 
P¬£IÁ32
(cÚ¡ 
Mes§ge
& 
¤c_‹xt
, cÚ¡ * 
¡r
, 
IÁ32
* 
v®ue
) {

11076 * 
	g’d
 = 
nuÎ±r
;

11077 cÚ¡ 
	glÚg_v®ue
 = 
¡¹Ş
(
¡r
, &
’d
, 10);

11080 ià(*
	g’d
 != '\0') {

11082 
Mes§ge
 
msg
;

11083 
	gmsg
 << "WARNING: " << 
	g¤c_‹xt


11085 << " ha v®u\"" << 
	g¡r
 << "\".\n";

11086 
´štf
("%s", 
msg
.
G‘SŒšg
().
c_¡r
());

11087 
fæush
(
¡dout
);

11088  
	gçl£
;

11092 cÚ¡ 
IÁ32
 
	g»suÉ
 = 
¡©ic_ÿ¡
<IÁ32>(
lÚg_v®ue
);

11093 ià(
	glÚg_v®ue
 =ğ
LONG_MAX
 || 
lÚg_v®ue
 =ğ
LONG_MIN
 ||

11096 
»suÉ
 !ğ
lÚg_v®ue


11099 
Mes§ge
 
msg
;

11100 
	gmsg
 << "WARNING: " << 
	g¤c_‹xt


11102 << " ha v®u" << 
	g¡r
 << ", which overflows.\n";

11103 
´štf
("%s", 
msg
.
G‘SŒšg
().
c_¡r
());

11104 
fæush
(
¡dout
);

11105  
	gçl£
;

11108 *
	gv®ue
 = 
»suÉ
;

11109  
	gŒue
;

11116 
boŞ
 
BoŞFromGTe¡Env
(cÚ¡ * 
æag
, boŞ 
deçuÉ_v®ue
) {

11117 #ià
defšed
(
GTEST_GET_BOOL_FROM_ENV_
)

11118  
GTEST_GET_BOOL_FROM_ENV_
(
æag
, 
deçuÉ_v®ue
);

11120 cÚ¡ 
	g¡d
::
¡ršg
 
’v_v¬
 = 
FÏgToEnvV¬
(
æag
);

11121 cÚ¡ * cÚ¡ 
	g¡ršg_v®ue
 = 
posix
::
G‘Env
(
’v_v¬
.
c_¡r
());

11122  
	g¡ršg_v®ue
 =ğ
nuÎ±r
 ? 
deçuÉ_v®ue


11123 : 
¡rcmp
(
¡ršg_v®ue
, "0") != 0;

11130 
IÁ32
 
IÁ32FromGTe¡Env
(cÚ¡ * 
æag
, IÁ32 
deçuÉ_v®ue
) {

11131 #ià
defšed
(
GTEST_GET_INT32_FROM_ENV_
)

11132  
GTEST_GET_INT32_FROM_ENV_
(
æag
, 
deçuÉ_v®ue
);

11134 cÚ¡ 
	g¡d
::
¡ršg
 
’v_v¬
 = 
FÏgToEnvV¬
(
æag
);

11135 cÚ¡ * cÚ¡ 
	g¡ršg_v®ue
 = 
posix
::
G‘Env
(
’v_v¬
.
c_¡r
());

11136 ià(
	g¡ršg_v®ue
 =ğ
nuÎ±r
) {

11138  
deçuÉ_v®ue
;

11141 
IÁ32
 
	g»suÉ
 = 
deçuÉ_v®ue
;

11142 ià(!
P¬£IÁ32
(
Mes§ge
(è<< "EnvœÚm’ˆv¬ŸbË " << 
’v_v¬
,

11143 
¡ršg_v®ue
, &
»suÉ
)) {

11144 
´štf
("The default value %s is used.\n",

11145 (
Mes§ge
(è<< 
deçuÉ_v®ue
).
G‘SŒšg
().
c_¡r
());

11146 
fæush
(
¡dout
);

11147  
	gdeçuÉ_v®ue
;

11150  
	g»suÉ
;

11162 
	g¡d
::
¡ršg
 
OuutFÏgAlsoCheckEnvV¬
(){

11163 
¡d
::
¡ršg
 
deçuÉ_v®ue_fÜ_ouut_æag
 = "";

11164 cÚ¡ * 
	gxml_ouut_fe_’v
 = 
posix
::
G‘Env
("XML_OUTPUT_FILE");

11165 ià(
	gnuÎ±r
 !ğ
xml_ouut_fe_’v
) {

11166 
deçuÉ_v®ue_fÜ_ouut_æag
 = 
¡d
::
¡ršg
("xml:"è+ 
xml_ouut_fe_’v
;

11168  
	gdeçuÉ_v®ue_fÜ_ouut_æag
;

11173 cÚ¡ * 
SŒšgFromGTe¡Env
(cÚ¡ * 
æag
, cÚ¡ * 
deçuÉ_v®ue
) {

11174 #ià
defšed
(
GTEST_GET_STRING_FROM_ENV_
)

11175  
GTEST_GET_STRING_FROM_ENV_
(
æag
, 
deçuÉ_v®ue
);

11177 cÚ¡ 
	g¡d
::
¡ršg
 
’v_v¬
 = 
FÏgToEnvV¬
(
æag
);

11178 cÚ¡ * cÚ¡ 
	gv®ue
 = 
posix
::
G‘Env
(
’v_v¬
.
c_¡r
());

11179  
	gv®ue
 =ğ
nuÎ±r
 ? 
deçuÉ_v®ue
 : 
v®ue
;

11228 
	~<¡dio.h
>

11229 
	~<cùy³
>

11230 
	~<cwch¬
>

11231 
	~<o¡»am
>

11232 
	~<¡ršg
>

11234 
Çme¥aû
 
	g‹¡šg
 {

11236 
	gÇme¥aû
 {

11238 
	gusšg
 ::
¡d
::
o¡»am
;

11241 
GTEST_ATTRIBUTE_NO_SANITIZE_MEMORY_


11242 
GTEST_ATTRIBUTE_NO_SANITIZE_ADDRESS_


11243 
GTEST_ATTRIBUTE_NO_SANITIZE_HWADDRESS_


11244 
GTEST_ATTRIBUTE_NO_SANITIZE_THREAD_


11245 
PrštBy‹Segm’tInObjeùTo
(cÚ¡ * 
obj_by‹s
, 
size_t
 
¡¬t
,

11246 
size_t
 
couÁ
, 
o¡»am
* 
os
) {

11247 
	g‹xt
[5] = "";

11248 
size_t
 
	gi
 = 0; i !ğ
couÁ
; i++) {

11249 cÚ¡ 
size_t
 
	gj
 = 
¡¬t
 + 
i
;

11250 ià(
	gi
 != 0) {

11253 ià((
j
 % 2) == 0)

11254 *
os
 << ' ';

11256 *
	gos
 << '-';

11258 
GTEST_SNPRINTF_
(
‹xt
, Ñext), "%02X", 
obj_by‹s
[
j
]);

11259 *
	gos
 << 
	g‹xt
;

11264 
PrštBy‹sInObjeùToIm¶
(cÚ¡ * 
obj_by‹s
, 
size_t
 
couÁ
,

11265 
o¡»am
* 
os
) {

11267 *
	gos
 << 
	gcouÁ
 << "-byte object <";

11269 cÚ¡ 
size_t
 
	gkTh»shŞd
 = 132;

11270 cÚ¡ 
size_t
 
	gkChunkSize
 = 64;

11274 ià(
	gcouÁ
 < 
	gkTh»shŞd
) {

11275 
PrštBy‹Segm’tInObjeùTo
(
obj_by‹s
, 0, 
couÁ
, 
os
);

11277 
PrštBy‹Segm’tInObjeùTo
(
obj_by‹s
, 0, 
kChunkSize
, 
os
);

11278 *
	gos
 << " ... ";

11280 cÚ¡ 
size_t
 
	g»sume_pos
 = (
couÁ
 - 
kChunkSize
 + 1)/2*2;

11281 
PrštBy‹Segm’tInObjeùTo
(
obj_by‹s
, 
»sume_pos
, 
couÁ
 -„esume_pos, 
os
);

11283 *
	gos
 << ">";

11288 
Çme¥aû
 
	gš‹º®2
 {

11295 
PrštBy‹sInObjeùTo
(cÚ¡ * 
obj_by‹s
, 
size_t
 
couÁ
,

11296 
o¡»am
* 
os
) {

11297 
PrštBy‹sInObjeùToIm¶
(
obj_by‹s
, 
couÁ
, 
os
);

11302 
Çme¥aû
 
	gš‹º®
 {

11309 
	eCh¬FÜm©
 {

11310 
	gkAsIs
,

11311 
	gkHexEsÿ³
,

11312 
	gkS³cŸlEsÿ³


11318 
šlše
 
boŞ
 
IsPršbËAscii
(
wch¬_t
 
c
) {

11319  0x20 <ğ
c
 && c <= 0x7E;

11326 
	g‹m¶©e
 <
ty³Çme
 
	gUnsigÃdCh¬
,y³Çm
	gCh¬
>

11327 
Ch¬FÜm©
 
PrštAsCh¬L™”®To
(
Ch¬
 
c
, 
o¡»am
* 
os
) {

11328 
wch¬_t
 
	gw_c
 = 
¡©ic_ÿ¡
<wch¬_t>(
c
);

11329 
	gw_c
) {

11330 
	gL
'\0':

11331 *
os
 << "\\0";

11333 
	gL
'\'':

11334 *
os
 << "\\'";

11336 
	gL
'\\':

11337 *
os
 << "\\\\";

11339 
	gL
'\a':

11340 *
os
 << "\\a";

11342 
	gL
'\b':

11343 *
os
 << "\\b";

11345 
	gL
'\f':

11346 *
os
 << "\\f";

11348 
	gL
'\n':

11349 *
os
 << "\\n";

11351 
	gL
'\r':

11352 *
os
 << "\\r";

11354 
	gL
'\t':

11355 *
os
 << "\\t";

11357 
	gL
'\v':

11358 *
os
 << "\\v";

11361 ià(
IsPršbËAscii
(
w_c
)) {

11362 *
os
 << 
¡©ic_ÿ¡
<>(
c
);

11363  
	gkAsIs
;

11365 
	go¡»am
::
fmtæags
 
æags
 = 
os
->flags();

11366 *
	gos
 << "\\x" << 
	g¡d
::
hex
 << 
¡d
::
uµ”ÿ£


11367 << 
¡©ic_ÿ¡
<>(¡©ic_ÿ¡<
UnsigÃdCh¬
>(
c
));

11368 
	gos
->
æags
(flags);

11369  
	gkHexEsÿ³
;

11372  
	gkS³cŸlEsÿ³
;

11377 
Ch¬FÜm©
 
PrštAsSŒšgL™”®To
(
wch¬_t
 
c
, 
o¡»am
* 
os
) {

11378 
	gc
) {

11379 
	gL
'\'':

11380 *
os
 << "'";

11381  
	gkAsIs
;

11382 
	gL
'"':

11383 *
os
 << "\\\"";

11384  
	gkS³cŸlEsÿ³
;

11386  
PrštAsCh¬L™”®To
<
wch¬_t
>(
c
, 
	gos
);

11392 
Ch¬FÜm©
 
PrštAsSŒšgL™”®To
(
c
, 
o¡»am
* 
os
) {

11393  
PrštAsSŒšgL™”®To
(

11394 
¡©ic_ÿ¡
<
wch¬_t
>(¡©ic_ÿ¡<>(
c
)), 
os
);

11401 
	g‹m¶©e
 <
ty³Çme
 
	gUnsigÃdCh¬
,y³Çm
	gCh¬
>

11402 
PrštCh¬AndCodeTo
(
Ch¬
 
c
, 
o¡»am
* 
os
) {

11404 *
	gos
 << (((
	gc
) > 1) ? "L'" : "'");

11405 cÚ¡ 
Ch¬FÜm©
 
	gfÜm©
 = 
PrštAsCh¬L™”®To
<
UnsigÃdCh¬
>(
c
, 
	gos
);

11406 *
	gos
 << "'";

11411 ià(
	gc
 == 0)

11413 *
	gos
 << " (" << 
	g¡©ic_ÿ¡
<>(
	gc
);

11418 ià(
	gfÜm©
 =ğ
kHexEsÿ³
 || (1 <ğ
c
 && c <= 9)) {

11421 *
os
 << ", 0x" << 
SŒšg
::
FÜm©HexIÁ
(
¡©ic_ÿ¡
<>(
c
));

11423 *
	gos
 << ")";

11426 
PrštTo
(
c
, ::
¡d
::
o¡»am
* 
os
) {

11427 
PrštCh¬AndCodeTo
<>(
c
, 
	gos
);

11429 
PrštTo
(sigÃd 
c
, ::
¡d
::
o¡»am
* 
os
) {

11430 
PrštCh¬AndCodeTo
<>(
c
, 
	gos
);

11435 
PrštTo
(
wch¬_t
 
wc
, 
o¡»am
* 
os
) {

11436 
	gPrštCh¬AndCodeTo
<
	gwch¬_t
>(
	gwc
, 
	gos
);

11443 
	g‹m¶©e
 <
ty³Çme
 
	gCh¬Ty³
>

11444 
GTEST_ATTRIBUTE_NO_SANITIZE_MEMORY_


11445 
GTEST_ATTRIBUTE_NO_SANITIZE_ADDRESS_


11446 
GTEST_ATTRIBUTE_NO_SANITIZE_HWADDRESS_


11447 
GTEST_ATTRIBUTE_NO_SANITIZE_THREAD_


11448 
Ch¬FÜm©
 
PrštCh¬sAsSŒšgTo
(

11449 cÚ¡ 
Ch¬Ty³
* 
begš
, 
size_t
 
Ën
, 
o¡»am
* 
os
) {

11450 cÚ¡ * cÚ¡ 
	gkQuÙeBegš
 = (
Ch¬Ty³
) == 1 ? "\"" : "L\"";

11451 *
	gos
 << 
	gkQuÙeBegš
;

11452 
boŞ
 
	gis_´evious_hex
 = 
çl£
;

11453 
Ch¬FÜm©
 
	g´št_fÜm©
 = 
kAsIs
;

11454 
size_t
 
	gšdex
 = 0; index < 
	gËn
; ++index) {

11455 cÚ¡ 
Ch¬Ty³
 
	gcur
 = 
begš
[
šdex
];

11456 ià(
	gis_´evious_hex
 && 
IsXDig™
(
cur
)) {

11460 *
	gos
 << "\" " << 
	gkQuÙeBegš
;

11462 
	gis_´evious_hex
 = 
PrštAsSŒšgL™”®To
(
cur
, 
os
è=ğ
kHexEsÿ³
;

11464 ià(
	gis_´evious_hex
) {

11465 
	g´št_fÜm©
 = 
kHexEsÿ³
;

11468 *
	gos
 << "\"";

11469  
	g´št_fÜm©
;

11474 
	g‹m¶©e
 <
ty³Çme
 
	gCh¬Ty³
>

11475 
GTEST_ATTRIBUTE_NO_SANITIZE_MEMORY_


11476 
GTEST_ATTRIBUTE_NO_SANITIZE_ADDRESS_


11477 
GTEST_ATTRIBUTE_NO_SANITIZE_HWADDRESS_


11478 
GTEST_ATTRIBUTE_NO_SANITIZE_THREAD_


11479 
Univ”§lPrštCh¬A¼ay
(

11480 cÚ¡ 
Ch¬Ty³
* 
begš
, 
size_t
 
Ën
, 
o¡»am
* 
os
) {

11488 ià(
	gËn
 > 0 && 
	gbegš
[
Ën
 - 1] == '\0') {

11489 
PrštCh¬sAsSŒšgTo
(
begš
, 
Ën
 - 1, 
os
);

11497 
PrštCh¬sAsSŒšgTo
(
begš
, 
Ën
, 
os
);

11498 *
	gos
 << " (noerminating NUL)";

11502 
Univ”§lPrštA¼ay
(cÚ¡ * 
begš
, 
size_t
 
Ën
, 
o¡»am
* 
os
) {

11503 
Univ”§lPrštCh¬A¼ay
(
begš
, 
Ën
, 
os
);

11508 
Univ”§lPrštA¼ay
(cÚ¡ 
wch¬_t
* 
begš
, 
size_t
 
Ën
, 
o¡»am
* 
os
) {

11509 
Univ”§lPrštCh¬A¼ay
(
begš
, 
Ën
, 
os
);

11513 
PrštTo
(cÚ¡ * 
s
, 
o¡»am
* 
os
) {

11514 ià(
	gs
 =ğ
nuÎ±r
) {

11515 *
os
 << "NULL";

11517 *
	gos
 << 
	gIm¶ic™Ca¡_
<cÚ¡ *>(
	gs
) << "…ointingo ";

11518 
PrštCh¬sAsSŒšgTo
(
s
, 
¡¾’
(s), 
os
);

11528 #ià!
defšed
(
_MSC_VER
è|| defšed(
_NATIVE_WCHAR_T_DEFINED
)

11530 
PrštTo
(cÚ¡ 
wch¬_t
* 
s
, 
o¡»am
* 
os
) {

11531 ià(
	gs
 =ğ
nuÎ±r
) {

11532 *
os
 << "NULL";

11534 *
	gos
 << 
	gIm¶ic™Ca¡_
<cÚ¡ *>(
	gs
) << "…ointingo ";

11535 
PrštCh¬sAsSŒšgTo
(
s
, 
wc¦’
(s), 
os
);

11540 
	gÇme¥aû
 {

11542 
boŞ
 
CÚšsUÅršbËCÚŒŞCodes
(cÚ¡ * 
¡r
, 
size_t
 
Ëngth
) {

11543 cÚ¡ *
	gs
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
¡r
);

11545 
size_t
 
	gi
 = 0; i < 
	gËngth
; i++) {

11546 
	gch
 = *
s
++;

11547 ià(
	g¡d
::
isúŒl
(
ch
)) {

11548 
ch
) {

11554  
Œue
;

11558  
	gçl£
;

11561 
boŞ
 
IsUTF8T¿By‹
(
t
) {  0x80 <= &&<= 0xbf; }

11563 
boŞ
 
IsV®idUTF8
(cÚ¡ * 
¡r
, 
size_t
 
Ëngth
) {

11564 cÚ¡ *
	gs
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
¡r
);

11566 
size_t
 
	gi
 = 0; i < 
	gËngth
;) {

11567 
	gËad
 = 
s
[
i
++];

11569 ià(
	gËad
 <= 0x7f) {

11572 ià(
	gËad
 < 0xc2) {

11573  
	gçl£
;

11574 } ià(
	gËad
 <ğ0xdà&& (
i
 + 1è<ğ
Ëngth
 && 
IsUTF8T¿By‹
(
s
[i])) {

11575 ++
i
;

11576 } ià(0xe0 <ğ
Ëad
 &&†—d <ğ0xeà&& (
i
 + 2è<ğ
Ëngth
 &&

11577 
IsUTF8T¿By‹
(
s
[
i
]) &&

11578 
IsUTF8T¿By‹
(
s
[
i
 + 1]) &&

11580 (
Ëad
 !ğ0xe0 || 
s
[
i
] >= 0xa0) &&

11581 (
Ëad
 !ğ0xed || 
s
[
i
] < 0xa0)) {

11582 
i
 += 2;

11583 } ià(0xf0 <ğ
Ëad
 &&†—d <ğ0xf4 && (
i
 + 3è<ğ
Ëngth
 &&

11584 
IsUTF8T¿By‹
(
s
[
i
]) &&

11585 
IsUTF8T¿By‹
(
s
[
i
 + 1]) &&

11586 
IsUTF8T¿By‹
(
s
[
i
 + 2]) &&

11588 (
Ëad
 !ğ0xf0 || 
s
[
i
] >= 0x90) &&

11589 (
Ëad
 !ğ0xf4 || 
s
[
i
] < 0x90)) {

11590 
i
 += 3;

11592  
	gçl£
;

11595  
	gŒue
;

11598 
CÚd™iÚ®PrštAsText
(cÚ¡ * 
¡r
, 
size_t
 
Ëngth
, 
o¡»am
* 
os
) {

11599 ià(!
CÚšsUÅršbËCÚŒŞCodes
(
¡r
, 
Ëngth
) &&

11600 
IsV®idUTF8
(
¡r
, 
Ëngth
)) {

11601 *
	gos
 << "\À A Text: \"" << 
	g¡r
 << "\"";

11607 
PrštSŒšgTo
(cÚ¡ ::
¡d
::
¡ršg
& 
s
, 
o¡»am
* 
os
) {

11608 ià(
PrštCh¬sAsSŒšgTo
(
s
.
d©a
(), s.
size
(), 
os
è=ğ
kHexEsÿ³
) {

11609 ià(
GTEST_FLAG
(
´št_utf8
)) {

11610 
CÚd™iÚ®PrštAsText
(
s
.
d©a
(), s.
size
(), 
os
);

11615 #ià
GTEST_HAS_STD_WSTRING


11616 
PrštWideSŒšgTo
(cÚ¡ ::
¡d
::
w¡ršg
& 
s
, 
o¡»am
* 
os
) {

11617 
PrštCh¬sAsSŒšgTo
(
s
.
d©a
(), s.
size
(), 
os
);

11657 
Çme¥aû
 
	g‹¡šg
 {

11659 
usšg
 
	gš‹º®
::
G‘Un™Te¡Im¶
;

11663 
	g¡d
::
¡ršg
 
Te¡P¬tResuÉ
::
ExŒaùSumm¬y
(cÚ¡ * 
mes§ge
) {

11664 cÚ¡ * cÚ¡ 
¡ack_Œaû
 = 
¡r¡r
(
mes§ge
, 
š‹º®
::
kSckT¿ûM¬k”
);

11665  
	g¡ack_Œaû
 =ğ
nuÎ±r
 ? 
mes§ge
 : 
¡d
::
¡ršg
(mes§ge, 
¡ack_Œaû
);

11669 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gTe¡P¬tResuÉ
& 
	g»suÉ
) {

11670  
	gos
 << 
	g»suÉ
.
fe_Çme
(è<< ":" <<„esuÉ.
lše_numb”
() << ": "

11671 << (
	g»suÉ
.
ty³
(è=ğ
Te¡P¬tResuÉ
::
kSucûss


11673 : 
»suÉ
.
ty³
(è=ğ
Te¡P¬tResuÉ
::
kSk


11675 : 
»suÉ
.
ty³
(è=ğ
Te¡P¬tResuÉ
::
kF©®Fau»


11679 << 
»suÉ
.
mes§ge
(è<< 
¡d
::
’dl
;

11683 
	gTe¡P¬tResuÉA¼ay
::
Aµ’d
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) {

11684 
¬¿y_
.
push_back
(
»suÉ
);

11688 cÚ¡ 
	gTe¡P¬tResuÉ
& 
	gTe¡P¬tResuÉA¼ay
::
G‘Te¡P¬tResuÉ
(
šdex
) const {

11689 ià(
šdex
 < 0 || index >ğ
size
()) {

11690 
´štf
("\nInv®id index (%dèštØTe¡P¬tResuÉA¼ay.\n", 
šdex
);

11691 
	gš‹º®
::
posix
::
AbÜt
();

11694  
	g¬¿y_
[
¡©ic_ÿ¡
<
size_t
>(
šdex
)];

11698 
	gTe¡P¬tResuÉA¼ay
::
size
() const {

11699  
¡©ic_ÿ¡
<>(
¬¿y_
.
size
());

11702 
Çme¥aû
 
	gš‹º®
 {

11704 
	gHasNewF©®Fau»H–³r
::
HasNewF©®Fau»H–³r
()

11705 : 
has_Ãw_çl_çu»_
(
çl£
),

11706 
Üigš®_»pÜ‹r_
(
G‘Un™Te¡Im¶
()->

11707 
G‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
()) {

11708 
G‘Un™Te¡Im¶
()->
S‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
(
this
);

11711 
	gHasNewF©®Fau»H–³r
::~
HasNewF©®Fau»H–³r
() {

11712 
G‘Un™Te¡Im¶
()->
S‘Te¡P¬tResuÉR•Ü‹rFÜCu¼’tTh»ad
(

11713 
Üigš®_»pÜ‹r_
);

11716 
	gHasNewF©®Fau»H–³r
::
R•ÜtTe¡P¬tResuÉ
(

11717 cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) {

11718 ià(
»suÉ
.
çÎy_çed
())

11719 
has_Ãw_çl_çu»_
 = 
Œue
;

11720 
	gÜigš®_»pÜ‹r_
->
R•ÜtTe¡P¬tResuÉ
(
»suÉ
);

11758 
Çme¥aû
 
	g‹¡šg
 {

11759 
Çme¥aû
 
	gš‹º®
 {

11761 #ià
GTEST_HAS_TYPED_TEST_P


11765 cÚ¡ * 
SkS·ûs
(cÚ¡ * 
¡r
) {

11766 
IsS·û
(*
¡r
))

11767 
	g¡r
++;

11768  
	g¡r
;

11771 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
S¶™IÁoTe¡Names
(cÚ¡ * 
¤c
) {

11772 
¡d
::
veùÜ
<¡d::
¡ršg
> 
Çme_vec
;

11773 
	g¤c
 = 
SkS·ûs
(
¤c
);

11774 ; 
	g¤c
 !ğ
nuÎ±r
; srøğ
SkComma
(
¤c
)) {

11775 
Çme_vec
.
push_back
(
SŒT¿šgS·ûs
(
G‘P»fixUÁComma
(
¤c
)));

11777  
	gÇme_vec
;

11783 cÚ¡ * 
	gTy³dTe¡Su™ePS‹
::
V”ifyRegi¡”edTe¡Names
(

11784 cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
»gi¡”ed_‹¡s
) {

11785 
	gRegi¡”edTe¡sM­
::
	tcÚ¡_™”©Ü
 
	tRegi¡”edTe¡I‹r
;

11786 
	g»gi¡”ed_
 = 
Œue
;

11788 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çme_vec
 = 
S¶™IÁoTe¡Names
(
»gi¡”ed_‹¡s
);

11790 
Mes§ge
 
	g”rÜs
;

11792 
	g¡d
::
£t
<
¡d
::
¡ršg
> 
‹¡s
;

11793 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>::
cÚ¡_™”©Ü
 
Çme_™
 = 
Çme_vec
.
begš
();

11794 
	gÇme_™
 !ğ
Çme_vec
.
’d
(); ++name_it) {

11795 cÚ¡ 
	g¡d
::
¡ršg
& 
Çme
 = *
Çme_™
;

11796 ià(
	g‹¡s
.
couÁ
(
Çme
) != 0) {

11797 
”rÜs
 << "Te¡ " << 
Çme
 << " is†isted morehan once.\n";

11801 
boŞ
 
	gfound
 = 
çl£
;

11802 
Regi¡”edTe¡I‹r
 
	g™
 = 
»gi¡”ed_‹¡s_
.
begš
();

11803 
	g™
 !ğ
»gi¡”ed_‹¡s_
.
’d
();

11804 ++
	g™
) {

11805 ià(
	gÇme
 =ğ
™
->
fœ¡
) {

11806 
found
 = 
Œue
;

11811 ià(
	gfound
) {

11812 
	g‹¡s
.
š£¹
(
Çme
);

11814 
	g”rÜs
 << "NØ‹¡‚amed " << 
	gÇme


11819 
Regi¡”edTe¡I‹r
 
	g™
 = 
»gi¡”ed_‹¡s_
.
begš
();

11820 
	g™
 !ğ
»gi¡”ed_‹¡s_
.
’d
();

11821 ++
	g™
) {

11822 ià(
	g‹¡s
.
couÁ
(
™
->
fœ¡
) == 0) {

11823 
”rÜs
 << "You fÜgÙØli¡e¡ " << 
™
->
fœ¡
 << ".\n";

11827 cÚ¡ 
	g¡d
::
¡ršg
& 
”rÜs_¡r
 = 
”rÜs
.
G‘SŒšg
();

11828 ià(
	g”rÜs_¡r
 != "") {

11829 
årštf
(
¡d”r
, "% %s", 
FÜm©FeLoÿtiÚ
(
fe
, 
lše
).
c_¡r
(),

11830 
”rÜs_¡r
.
c_¡r
());

11831 
fæush
(
¡d”r
);

11832 
	gposix
::
AbÜt
();

11835  
	g»gi¡”ed_‹¡s
;

	@test/gtest/common/gtest.h

52 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_H_


53 
	#GTEST_INCLUDE_GTEST_GTEST_H_


	)

55 
	~<c¡ddef
>

56 
	~<lim™s
>

57 
	~<memÜy
>

58 
	~<o¡»am
>

59 
	~<ty³_Œa™s
>

60 
	~<veùÜ
>

98 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_GTEST_INTERNAL_H_


99 
	#GTEST_INCLUDE_GTEST_INTERNAL_GTEST_INTERNAL_H_


	)

143 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_GTEST_PORT_H_


144 
	#GTEST_INCLUDE_GTEST_INTERNAL_GTEST_PORT_H_


	)

346 
	~<ùy³.h
>

347 
	~<¡ddef.h
>

348 
	~<¡dio.h
>

349 
	~<¡dlib.h
>

350 
	~<¡ršg.h
>

351 
	~<memÜy
>

352 
	~<ty³_Œa™s
>

354 #iâdeà
_WIN32_WCE


355 
	~<sys/ty³s.h
>

356 
	~<sys/¡©.h
>

359 #ià
defšed
 
__APPLE__


360 
	~<Avaab™yMaüos.h
>

361 
	~<T¬g‘CÚd™iÚ®s.h
>

364 
	~<®gÜ™hm
>

365 
	~<io¡»am
>

366 
	~<s¡»am
>

367 
	~<¡ršg
>

368 
	~<tu¶e
>

369 
	~<ut™y
>

370 
	~<veùÜ
>

406 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_GTEST_PORT_ARCH_H_


407 
	#GTEST_INCLUDE_GTEST_INTERNAL_GTEST_PORT_ARCH_H_


	)

410 #ifdeà
__CYGWIN__


411 
	#GTEST_OS_CYGWIN
 1

	)

412 #–ià
defšed
(
__MINGW__
è|| defšed(
__MINGW32__
è|| defšed(
__MINGW64__
)

413 
	#GTEST_OS_WINDOWS_MINGW
 1

	)

414 
	#GTEST_OS_WINDOWS
 1

	)

415 #–ià
defšed
 
_WIN32


416 
	#GTEST_OS_WINDOWS
 1

	)

417 #ifdeà
_WIN32_WCE


418 
	#GTEST_OS_WINDOWS_MOBILE
 1

	)

419 #–ià
defšed
(
WINAPI_FAMILY
)

420 
	~<wš­içmy.h
>

421 #ià
WINAPI_FAMILY_PARTITION
(
WINAPI_PARTITION_DESKTOP
)

422 
	#GTEST_OS_WINDOWS_DESKTOP
 1

	)

423 #–ià
WINAPI_FAMILY_PARTITION
(
WINAPI_PARTITION_PHONE_APP
)

424 
	#GTEST_OS_WINDOWS_PHONE
 1

	)

425 #–ià
WINAPI_FAMILY_PARTITION
(
WINAPI_PARTITION_APP
)

426 
	#GTEST_OS_WINDOWS_RT
 1

	)

427 #–ià
WINAPI_FAMILY_PARTITION
(
WINAPI_PARTITION_TV_TITLE
)

428 
	#GTEST_OS_WINDOWS_PHONE
 1

	)

429 
	#GTEST_OS_WINDOWS_TV_TITLE
 1

	)

433 
	#GTEST_OS_WINDOWS_DESKTOP
 1

	)

436 
	#GTEST_OS_WINDOWS_DESKTOP
 1

	)

438 #–ià
defšed
 
__OS2__


439 
	#GTEST_OS_OS2
 1

	)

440 #–ià
defšed
 
__APPLE__


441 
	#GTEST_OS_MAC
 1

	)

442 #ià
TARGET_OS_IPHONE


443 
	#GTEST_OS_IOS
 1

	)

445 #–ià
defšed
 
__D¿gÚFly__


446 
	#GTEST_OS_DRAGONFLY
 1

	)

447 #–ià
defšed
 
__F»eBSD__


448 
	#GTEST_OS_FREEBSD
 1

	)

449 #–ià
defšed
 
__FuchsŸ__


450 
	#GTEST_OS_FUCHSIA
 1

	)

451 #–ià
defšed
(
__GLIBC__
è&& defšed(
__F»eBSD_k”Ãl__
)

452 
	#GTEST_OS_GNU_KFREEBSD
 1

	)

453 #–ià
defšed
 
__lšux__


454 
	#GTEST_OS_LINUX
 1

	)

455 #ià
defšed
 
__ANDROID__


456 
	#GTEST_OS_LINUX_ANDROID
 1

	)

458 #–ià
defšed
 
__MVS__


459 
	#GTEST_OS_ZOS
 1

	)

460 #–ià
defšed
(
__sun
è&& defšed(
__SVR4
)

461 
	#GTEST_OS_SOLARIS
 1

	)

462 #–ià
defšed
(
_AIX
)

463 
	#GTEST_OS_AIX
 1

	)

464 #–ià
defšed
(
__hpux
)

465 
	#GTEST_OS_HPUX
 1

	)

466 #–ià
defšed
 
__Çtive_ş›Á__


467 
	#GTEST_OS_NACL
 1

	)

468 #–ià
defšed
 
__N‘BSD__


469 
	#GTEST_OS_NETBSD
 1

	)

470 #–ià
defšed
 
__O³nBSD__


471 
	#GTEST_OS_OPENBSD
 1

	)

472 #–ià
defšed
 
__QNX__


473 
	#GTEST_OS_QNX
 1

	)

474 #–ià
defšed
(
__HAIKU__
)

475 
	#GTEST_OS_HAIKU
 1

	)

512 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_CUSTOM_GTEST_PORT_H_


513 
	#GTEST_INCLUDE_GTEST_INTERNAL_CUSTOM_GTEST_PORT_H_


	)

517 #ià!
defšed
(
GTEST_DEV_EMAIL_
)

518 
	#GTEST_DEV_EMAIL_
 "googË‹¡äamewÜk@@googËgroups.com"

	)

519 
	#GTEST_FLAG_PREFIX_
 "g‹¡_"

	)

520 
	#GTEST_FLAG_PREFIX_DASH_
 "g‹¡-"

	)

521 
	#GTEST_FLAG_PREFIX_UPPER_
 "GTEST_"

	)

522 
	#GTEST_NAME_
 "GoogË Te¡"

	)

523 
	#GTEST_PROJECT_URL_
 "h‰ps://g™hub.com/googË/googË‹¡/"

	)

526 #ià!
defšed
(
GTEST_INIT_GOOGLE_TEST_NAME_
)

527 
	#GTEST_INIT_GOOGLE_TEST_NAME_
 "‹¡šg::In™GoogËTe¡"

	)

531 #ifdeà
__GNUC__


533 
	#GTEST_GCC_VER_
 \

534 (
__GNUC__
*10000 + 
__GNUC_MINOR__
*100 + 
__GNUC_PATCHLEVEL__
)

	)

542 #ià
defšed
(
_MSC_VER
)

543 
	#GTEST_DISABLE_MSC_WARNINGS_PUSH_
(
w¬nšgs
) \

544 
	`__´agma
(
	`w¬nšg
(
push
)) \

545 
	`__´agma
(
	`w¬nšg
(
di§bË
: 
w¬nšgs
))

	)

546 
	#GTEST_DISABLE_MSC_WARNINGS_POP_
() \

547 
	`__´agma
(
	`w¬nšg
(
pİ
))

	)

550 
	#GTEST_DISABLE_MSC_WARNINGS_PUSH_
(
w¬nšgs
)

	)

551 
	#GTEST_DISABLE_MSC_WARNINGS_POP_
()

	)

556 #ifdeà
__şªg__


557 
	#GTEST_DISABLE_MSC_DEPRECATED_PUSH_
() \

558 
	`_P¿gma
("clang diagnostic…ush") \

559 
	`_P¿gma
("clang diagnostic ignored \"-Wdeprecated-declarations\"") \

560 
	`_P¿gma
("şªg dŸgno¡iøignÜed \"-Wd•»ÿ‹d-im¶em’tiÚs\"")

	)

561 
	#GTEST_DISABLE_MSC_DEPRECATED_POP_
() \

562 
	`_P¿gma
("şªg dŸgno¡iøpİ")

	)

564 
	#GTEST_DISABLE_MSC_DEPRECATED_PUSH_
() \

565 
	`GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4996)

	)

566 
	#GTEST_DISABLE_MSC_DEPRECATED_POP_
() \

567 
	`GTEST_DISABLE_MSC_WARNINGS_POP_
()

	)

573 #ià
GTEST_OS_WINDOWS


574 #ià!
GTEST_OS_WINDOWS_MOBILE


575 
	~<dœeù.h
>

576 
	~<io.h
>

579 #ià
GTEST_OS_WINDOWS_MINGW
 && !
defšed
(
__MINGW64_VERSION_MAJOR
)

582 
_CRITICAL_SECTION
 
	tGTEST_CRITICAL_SECTION
;

587 
_RTL_CRITICAL_SECTION
 
	tGTEST_CRITICAL_SECTION
;

593 
	~<uni¡d.h
>

594 
	~<¡ršgs.h
>

597 #ià
GTEST_OS_LINUX_ANDROID


599 
	~<ªdroid/­i-Ëv–.h
>

604 #iâdeà
GTEST_HAS_POSIX_RE


605 #ià
GTEST_OS_LINUX_ANDROID


607 
	#GTEST_HAS_POSIX_RE
 (
__ANDROID_API__
 >ğ9)

	)

609 
	#GTEST_HAS_POSIX_RE
 (!
GTEST_OS_WINDOWS
)

	)

613 #ià
GTEST_USES_PCRE


616 #–ià
GTEST_HAS_POSIX_RE


622 
	~<»gex.h
>

624 
	#GTEST_USES_POSIX_RE
 1

	)

626 #–ià
GTEST_OS_WINDOWS


630 
	#GTEST_USES_SIMPLE_RE
 1

	)

636 
	#GTEST_USES_SIMPLE_RE
 1

	)

640 #iâdeà
GTEST_HAS_EXCEPTIONS


643 #ià
defšed
(
_MSC_VER
è&& defšed(
_CPPUNWIND
)

645 
	#GTEST_HAS_EXCEPTIONS
 1

	)

646 #–ià
defšed
(
__BORLANDC__
)

650 #iâdeà
_HAS_EXCEPTIONS


651 
	#_HAS_EXCEPTIONS
 1

	)

653 
	#GTEST_HAS_EXCEPTIONS
 
_HAS_EXCEPTIONS


	)

654 #–ià
defšed
(
__şªg__
)

663 
	#GTEST_HAS_EXCEPTIONS
 (
__EXCEPTIONS
 && 
	`__has_ã©u»
(
cxx_exû±iÚs
))

	)

664 #–ià
defšed
(
__GNUC__
è&& 
__EXCEPTIONS


666 
	#GTEST_HAS_EXCEPTIONS
 1

	)

667 #–ià
defšed
(
__SUNPRO_CC
)

671 
	#GTEST_HAS_EXCEPTIONS
 1

	)

672 #–ià
defšed
(
__IBMCPP__
è&& 
__EXCEPTIONS


674 
	#GTEST_HAS_EXCEPTIONS
 1

	)

675 #–ià
defšed
(
__HP_aCC
)

678 
	#GTEST_HAS_EXCEPTIONS
 1

	)

682 
	#GTEST_HAS_EXCEPTIONS
 0

	)

686 #ià!
defšed
(
GTEST_HAS_STD_STRING
)

689 
	#GTEST_HAS_STD_STRING
 1

	)

690 #–ià!
GTEST_HAS_STD_STRING


695 #iâdeà
GTEST_HAS_STD_WSTRING


701 
	#GTEST_HAS_STD_WSTRING
 \

702 (!(
GTEST_OS_LINUX_ANDROID
 || 
GTEST_OS_CYGWIN
 || 
GTEST_OS_SOLARIS
 || \

703 
GTEST_OS_HAIKU
))

	)

708 #iâdeà
GTEST_HAS_RTTI


712 #ifdeà
_MSC_VER


714 #ifdeà
_CPPRTTI


715 
	#GTEST_HAS_RTTI
 1

	)

717 
	#GTEST_HAS_RTTI
 0

	)

722 #–ià
defšed
(
__GNUC__
)

724 #ifdeà
__GXX_RTTI


729 #ià
GTEST_OS_LINUX_ANDROID
 && 
defšed
(
_STLPORT_MAJOR
) && \

730 !
	$defšed
(
__EXCEPTIONS
)

731 
	#GTEST_HAS_RTTI
 0

	)

733 
	#GTEST_HAS_RTTI
 1

	)

736 
	#GTEST_HAS_RTTI
 0

	)

742 #–ià
	`defšed
(
__şªg__
)

744 
	#GTEST_HAS_RTTI
 
	`__has_ã©u»
(
cxx_¹ti
)

	)

748 #–ià
	`defšed
(
__IBMCPP__
) && (__IBMCPP__ >= 900)

750 #ifdeà
__RTTI_ALL__


751 
	#GTEST_HAS_RTTI
 1

	)

753 
	#GTEST_HAS_RTTI
 0

	)

759 
	#GTEST_HAS_RTTI
 1

	)

767 #ià
GTEST_HAS_RTTI


768 
	~<ty³šfo
>

772 #iâdeà
GTEST_HAS_PTHREAD


778 
	#GTEST_HAS_PTHREAD
 \

779 (
GTEST_OS_LINUX
 || 
GTEST_OS_MAC
 || 
GTEST_OS_HPUX
 || 
GTEST_OS_QNX
 || \

780 
GTEST_OS_FREEBSD
 || 
GTEST_OS_NACL
 || 
GTEST_OS_NETBSD
 || 
GTEST_OS_FUCHSIA
 || \

781 
GTEST_OS_DRAGONFLY
 || 
GTEST_OS_GNU_KFREEBSD
 || 
GTEST_OS_OPENBSD
 || \

782 
GTEST_OS_HAIKU
)

	)

785 #ià
GTEST_HAS_PTHREAD


788 
	~<±h»ad.h
>

791 
	~<time.h
>

798 #iâdeà
GTEST_HAS_CLONE


801 #ià
GTEST_OS_LINUX
 && !
	`defšed
(
__Ÿ64__
)

802 #ià
GTEST_OS_LINUX_ANDROID


805 #ià
	`defšed
(
__LP64__
) || \

806 (
	`defšed
(
__¬m__
è&& 
__ANDROID_API__
 >= 9) || \

807 (
	`defšed
(
__ms__
è&& 
__ANDROID_API__
 >= 12) || \

808 (
	`defšed
(
__i386__
è&& 
__ANDROID_API__
 >= 17)

809 
	#GTEST_HAS_CLONE
 1

	)

811 
	#GTEST_HAS_CLONE
 0

	)

814 
	#GTEST_HAS_CLONE
 1

	)

817 
	#GTEST_HAS_CLONE
 0

	)

824 #iâdeà
GTEST_HAS_STREAM_REDIRECTION


827 #ià
GTEST_OS_WINDOWS_MOBILE
 || 
GTEST_OS_WINDOWS_PHONE
 || 
GTEST_OS_WINDOWS_RT


828 
	#GTEST_HAS_STREAM_REDIRECTION
 0

	)

830 
	#GTEST_HAS_STREAM_REDIRECTION
 1

	)

836 #ià(
GTEST_OS_LINUX
 || 
GTEST_OS_CYGWIN
 || 
GTEST_OS_SOLARIS
 || \

837 (
GTEST_OS_MAC
 && !
GTEST_OS_IOS
) || \

838 (
GTEST_OS_WINDOWS_DESKTOP
 && 
_MSC_VER
è|| 
GTEST_OS_WINDOWS_MINGW
 || \

839 
GTEST_OS_AIX
 || 
GTEST_OS_HPUX
 || 
GTEST_OS_OPENBSD
 || 
GTEST_OS_QNX
 || \

840 
GTEST_OS_FREEBSD
 || 
GTEST_OS_NETBSD
 || 
GTEST_OS_FUCHSIA
 || \

841 
GTEST_OS_DRAGONFLY
 || 
GTEST_OS_GNU_KFREEBSD
 || 
GTEST_OS_HAIKU
)

842 
	#GTEST_HAS_DEATH_TEST
 1

	)

849 #ià
	`defšed
(
__GNUC__
è|| defšed(
_MSC_VER
è|| defšed(
__SUNPRO_CC
) || \

850 
	`defšed
(
__IBMCPP__
è|| 
	$defšed
(
__HP_aCC
)

851 
	#GTEST_HAS_TYPED_TEST
 1

	)

852 
	#GTEST_HAS_TYPED_TEST_P
 1

	)

856 
	#GTEST_WIDE_STRING_USES_UTF16_
 \

857 (
GTEST_OS_WINDOWS
 || 
GTEST_OS_CYGWIN
 || 
GTEST_OS_AIX
 || 
GTEST_OS_OS2
)

	)

860 #ià
GTEST_OS_LINUX
 || 
GTEST_OS_GNU_KFREEBSD
 || 
GTEST_OS_DRAGONFLY
 || \

861 
GTEST_OS_FREEBSD
 || 
GTEST_OS_NETBSD
 || 
GTEST_OS_OPENBSD


862 
	#GTEST_CAN_STREAM_RESULTS_
 1

	)

875 #ifdeà
__INTEL_COMPILER


876 
	#GTEST_AMBIGUOUS_ELSE_BLOCKER_


	)

878 
	#GTEST_AMBIGUOUS_ELSE_BLOCKER_
 0) 0: :

880 

	)

892 #ià
	`defšed
(
__GNUC__
è&& !defšed(
COMPILER_ICC
)

893 
	#GTEST_ATTRIBUTE_UNUSED_
 
	`__©Œibu‹__
 ((
unu£d
))

	)

894 #–ià
	`defšed
(
__şªg__
)

895 #ià
	`__has_©Œibu‹
(
unu£d
)

896 
	#GTEST_ATTRIBUTE_UNUSED_
 
	`__©Œibu‹__
 ((
unu£d
))

	)

899 #iâdeà
GTEST_ATTRIBUTE_UNUSED_


900 
	#GTEST_ATTRIBUTE_UNUSED_


	)

904 #ià(
	`defšed
(
__GNUC__
è|| defšed(
__şªg__
)è&& !defšed(
COMPILER_ICC
)

905 #ià
	`defšed
(
__MINGW_PRINTF_FORMAT
)

909 
	#GTEST_ATTRIBUTE_PRINTF_
(
¡ršg_šdex
, 
fœ¡_to_check
) \

910 
	`__©Œibu‹__
((
	`__fÜm©__
(
__MINGW_PRINTF_FORMAT
, 
¡ršg_šdex
, \

911 
fœ¡_to_check
)))

	)

913 
	#GTEST_ATTRIBUTE_PRINTF_
(
¡ršg_šdex
, 
fœ¡_to_check
) \

914 
	`__©Œibu‹__
((
	`__fÜm©__
(
__´štf__
, 
¡ršg_šdex
, 
fœ¡_to_check
)))

	)

917 
	#GTEST_ATTRIBUTE_PRINTF_
(
¡ršg_šdex
, 
fœ¡_to_check
)

	)

923 
	#GTEST_DISALLOW_ASSIGN_
(
ty³
) \

924 
İ”©Ü
=(
ty³
 cÚ¡ &èğ
d–‘e


	)

928 
	#GTEST_DISALLOW_COPY_AND_ASSIGN_
(
ty³
) \

929 
	`ty³
(
ty³
 cÚ¡ &èğ
d–‘e
; \

930 
	`GTEST_DISALLOW_ASSIGN_
(
ty³
)

	)

937 #ià
	`defšed
(
__GNUC__
è&& !defšed(
COMPILER_ICC
)

938 
	#GTEST_MUST_USE_RESULT_
 
	`__©Œibu‹__
 ((
w¬n_unu£d_»suÉ
))

	)

940 
	#GTEST_MUST_USE_RESULT_


	)

951 
	#GTEST_INTENTIONAL_CONST_COND_PUSH_
() \

952 
	`GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4127)

	)

953 
	#GTEST_INTENTIONAL_CONST_COND_POP_
() \

954 
	`GTEST_DISABLE_MSC_WARNINGS_POP_
()

	)

959 #iâdeà
GTEST_HAS_SEH


962 #ià
	`defšed
(
_MSC_VER
è|| defšed(
__BORLANDC__
)

964 
	#GTEST_HAS_SEH
 1

	)

967 
	#GTEST_HAS_SEH
 0

	)

972 #iâdeà
GTEST_IS_THREADSAFE


974 
	#GTEST_IS_THREADSAFE
 \

975 (
GTEST_HAS_MUTEX_AND_THREAD_LOCAL_
 || \

976 (
GTEST_OS_WINDOWS
 && !
GTEST_OS_WINDOWS_PHONE
 && !
GTEST_OS_WINDOWS_RT
) || \

977 
GTEST_HAS_PTHREAD
)

	)

984 #iâdeà
GTEST_API_


986 #ifdeà
_MSC_VER


987 #ià
GTEST_LINKED_AS_SHARED_LIBRARY


988 
	#GTEST_API_
 
	`__deş¥ec
(
dÎimpÜt
)

	)

989 #–ià
GTEST_CREATE_SHARED_LIBRARY


990 
	#GTEST_API_
 
	`__deş¥ec
(
dÎexpÜt
)

	)

992 #–ià
__GNUC__
 >ğ4 || 
	`defšed
(
__şªg__
)

993 
	#GTEST_API_
 
	`__©Œibu‹__
((
	`visib™y
 ("deçuÉ")))

	)

998 #iâdeà
GTEST_API_


999 
	#GTEST_API_


	)

1002 #iâdeà
GTEST_DEFAULT_DEATH_TEST_STYLE


1003 
	#GTEST_DEFAULT_DEATH_TEST_STYLE
 "ç¡"

	)

1006 #ifdeà
__GNUC__


1008 
	#GTEST_NO_INLINE_
 
	`__©Œibu‹__
((
nošlše
))

	)

1010 
	#GTEST_NO_INLINE_


	)

1014 #ià!
	`defšed
(
GTEST_HAS_CXXABI_H_
)

1015 #ià
	`defšed
(
__GLIBCXX__
è|| (defšed(
_LIBCPP_VERSION
è&& !defšed(
_MSC_VER
))

1016 
	#GTEST_HAS_CXXABI_H_
 1

	)

1018 
	#GTEST_HAS_CXXABI_H_
 0

	)

1024 #ià
	`defšed
(
__şªg__
)

1025 #ià
	`__has_ã©u»
(
memÜy_§n™iz”
)

1026 
	#GTEST_ATTRIBUTE_NO_SANITIZE_MEMORY_
 \

1027 
	`__©Œibu‹__
((
no_§n™ize_memÜy
))

	)

1029 
	#GTEST_ATTRIBUTE_NO_SANITIZE_MEMORY_


	)

1032 
	#GTEST_ATTRIBUTE_NO_SANITIZE_MEMORY_


	)

1036 #ià
	`defšed
(
__şªg__
)

1037 #ià
	`__has_ã©u»
(
add»ss_§n™iz”
)

1038 
	#GTEST_ATTRIBUTE_NO_SANITIZE_ADDRESS_
 \

1039 
	`__©Œibu‹__
((
no_§n™ize_add»ss
))

	)

1041 
	#GTEST_ATTRIBUTE_NO_SANITIZE_ADDRESS_


	)

1044 
	#GTEST_ATTRIBUTE_NO_SANITIZE_ADDRESS_


	)

1048 #ià
	`defšed
(
__şªg__
)

1049 #ià
	`__has_ã©u»
(
hwadd»ss_§n™iz”
)

1050 
	#GTEST_ATTRIBUTE_NO_SANITIZE_HWADDRESS_
 \

1051 
	`__©Œibu‹__
((
	`no_§n™ize
("hwadd»ss")))

	)

1053 
	#GTEST_ATTRIBUTE_NO_SANITIZE_HWADDRESS_


	)

1056 
	#GTEST_ATTRIBUTE_NO_SANITIZE_HWADDRESS_


	)

1060 #ià
	`defšed
(
__şªg__
)

1061 #ià
	`__has_ã©u»
(
th»ad_§n™iz”
)

1062 
	#GTEST_ATTRIBUTE_NO_SANITIZE_THREAD_
 \

1063 
	`__©Œibu‹__
((
no_§n™ize_th»ad
))

	)

1065 
	#GTEST_ATTRIBUTE_NO_SANITIZE_THREAD_


	)

1068 
	#GTEST_ATTRIBUTE_NO_SANITIZE_THREAD_


	)

1071 
Çme¥aû
 
‹¡šg
 {

1073 
şass
 
Mes§ge
;

1077 
usšg
 
¡d
::
g‘
;

1078 
usšg
 
¡d
::
make_tu¶e
;

1079 
usšg
 
¡d
::
tu¶e
;

1080 
usšg
 
¡d
::
tu¶e_–em’t
;

1081 
usšg
 
¡d
::
tu¶e_size
;

1083 
Çme¥aû
 
š‹º®
 {

1088 
şass
 
Seü‘
;

1099 
	#GTEST_COMPILE_ASSERT_
(
ex´
, 
msg
è
	`¡©ic_as£¹
Óx´, #msg)

	)

1102 
	#GTEST_ARRAY_SIZE_
(
¬¿y
è(×¼ayè/ ×¼ay[0]))

	)

1106 
GTEST_API_
 
boŞ
 
	`IsTrue
(boŞ 
cÚd™iÚ
);

1110 #ià
GTEST_USES_PCRE


1112 #–ià
GTEST_USES_POSIX_RE
 || 
GTEST_USES_SIMPLE_RE


1116 şas 
	cGTEST_API_
 
RE
 {

1117 
public
:

1120 
	`RE
(cÚ¡ 
RE
& 
Ùh”
è{ 
	`In™
(Ùh”.
	`·‰”n
()); }

1123 
	`RE
(cÚ¡ ::
¡d
::
¡ršg
& 
»gex
è{ 
	`In™
Ôegex.
	`c_¡r
()); }

1125 
	`RE
(cÚ¡ * 
»gex
è{ 
	`In™
(regex); }

1126 ~
	`RE
();

1129 cÚ¡ * 
	`·‰”n
(ècÚ¡ {  
·‰”n_
; }

1135 
boŞ
 
	`FuÎM©ch
(cÚ¡ ::
¡d
::
¡ršg
& 
¡r
, cÚ¡ 
RE
& 
»
) {

1136  
	`FuÎM©ch
(
¡r
.
	`c_¡r
(), 
»
);

1138 
boŞ
 
	`P¬tŸlM©ch
(cÚ¡ ::
¡d
::
¡ršg
& 
¡r
, cÚ¡ 
RE
& 
»
) {

1139  
	`P¬tŸlM©ch
(
¡r
.
	`c_¡r
(), 
»
);

1142 
boŞ
 
	`FuÎM©ch
(cÚ¡ * 
¡r
, cÚ¡ 
RE
& 
»
);

1143 
boŞ
 
	`P¬tŸlM©ch
(cÚ¡ * 
¡r
, cÚ¡ 
RE
& 
»
);

1145 
´iv©e
:

1146 
	`In™
(cÚ¡ * 
»gex
);

1147 cÚ¡ * 
·‰”n_
;

1148 
boŞ
 
is_v®id_
;

1150 #ià
GTEST_USES_POSIX_RE


1152 
»gex_t
 
fuÎ_»gex_
;

1153 
»gex_t
 
·¹Ÿl_»gex_
;

1157 cÚ¡ * 
fuÎ_·‰”n_
;

1161 
	`GTEST_DISALLOW_ASSIGN_
(
RE
);

1168 
GTEST_API_
 ::
¡d
::
¡ršg
 
	`FÜm©FeLoÿtiÚ
(cÚ¡ * 
fe
, 
lše
);

1173 
GTEST_API_
 ::
¡d
::
¡ršg
 
	`FÜm©Comp”Ind•’d’tFeLoÿtiÚ
(cÚ¡ * 
fe
,

1174 
lše
);

1182 
	eGTe¡LogSev”™y
 {

1183 
GTEST_INFO
,

1184 
GTEST_WARNING
,

1185 
GTEST_ERROR
,

1186 
GTEST_FATAL


1192 şas 
	cGTEST_API_
 
GTe¡Log
 {

1193 
public
:

1194 
	`GTe¡Log
(
GTe¡LogSev”™y
 
£v”™y
, cÚ¡ * 
fe
, 
lše
);

1197 ~
	`GTe¡Log
();

1199 ::
¡d
::
o¡»am
& 
	`G‘SŒ—m
(è{  ::¡d::
û¼
; }

1201 
´iv©e
:

1202 cÚ¡ 
GTe¡LogSev”™y
 
£v”™y_
;

1204 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
GTe¡Log
);

1207 #ià!
	`defšed
(
GTEST_LOG_
)

1209 
	#GTEST_LOG_
(
£v”™y
) \

1210 ::
‹¡šg
::
š‹º®
::
	`GTe¡Log
(::‹¡šg::š‹º®::
GTEST_
##
£v”™y
, \

1211 
__FILE__
, 
__LINE__
).
	`G‘SŒ—m
()

	)

1213 
šlše
 
	`LogToStd”r
() {}

1214 
šlše
 
	`FlushInfoLog
(è{ 
	`fæush
(
nuÎ±r
); }

1218 #ià!
	`defšed
(
GTEST_CHECK_
)

1233 
	#GTEST_CHECK_
(
cÚd™iÚ
) \

1234 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

1235 ià(::
‹¡šg
::
š‹º®
::
	`IsTrue
(
cÚd™iÚ
)) \

1238 
	`GTEST_LOG_
(
FATAL
è<< "CÚd™iÚ " #cÚd™iÚ " faed. "

	)

1246 
	#GTEST_CHECK_POSIX_SUCCESS_
(
posix_ÿÎ
) \

1247 ià(cÚ¡ 
g‹¡_”rÜ
 = (
posix_ÿÎ
)) \

1248 
	`GTEST_LOG_
(
FATAL
) << #posix_call << "failed withƒrror " \

1249 << 
g‹¡_”rÜ


	)

1262 
‹m¶©e
 <
ty³Çme
 
T
>

1263 
	sCÚ¡Ref
 { cÚ¡ 
	tT
& 
	tty³
; };

1264 
‹m¶©e
 <
ty³Çme
 
T
>

1265 
CÚ¡Ref
<
T
&> { T& 
	tty³
; };

1268 
	#GTEST_REFERENCE_TO_CONST_
(
T
) \

1269 
ty³Çme
 ::
‹¡šg
::
š‹º®
::
CÚ¡Ref
<
T
>::
ty³


	)

1291 
‹m¶©e
<
ty³Çme
 
To
>

1292 
šlše
 
To
 
	`Im¶ic™Ca¡_
(TØ
x
) {  x; }

1315 
‹m¶©e
<
ty³Çme
 
To
,y³Çm
From
>

1316 
šlše
 
To
 
	`DownCa¡_
(
From
* 
f
) {

1321 
	`GTEST_INTENTIONAL_CONST_COND_PUSH_
()

1322 ià(
çl£
) {

1323 
	`GTEST_INTENTIONAL_CONST_COND_POP_
()

1324 cÚ¡ 
To
 
to
 = 
nuÎ±r
;

1325 ::
‹¡šg
::
š‹º®
::
Im¶ic™Ca¡_
<
From
*>(
to
);

1328 #ià
GTEST_HAS_RTTI


1330 
	`GTEST_CHECK_
(
f
 =ğ
nuÎ±r
 || 
dyÇmic_ÿ¡
<
To
>(f) !=‚ullptr);

1332  
¡©ic_ÿ¡
<
To
>(
f
);

1340 
‹m¶©e
 <
şass
 
D”ived
, cÏs 
Ba£
>

1341 
D”ived
* 
	`CheckedDownÿ¡ToAùu®Ty³
(
Ba£
* 
ba£
) {

1342 #ià
GTEST_HAS_RTTI


1343 
	`GTEST_CHECK_
(
	`ty³id
(*
ba£
è=ğty³id(
D”ived
));

1346 #ià
GTEST_HAS_DOWNCAST_


1347  ::
down_ÿ¡
<
D”ived
*>(
ba£
);

1348 #–ià
GTEST_HAS_RTTI


1349  
dyÇmic_ÿ¡
<
D”ived
*>(
ba£
);

1351  
¡©ic_ÿ¡
<
D”ived
*>(
ba£
);

1355 #ià
GTEST_HAS_STREAM_REDIRECTION


1363 
GTEST_API_
 
	`C­tu»Stdout
();

1364 
GTEST_API_
 
¡d
::
¡ršg
 
	`G‘C­tu»dStdout
();

1365 
GTEST_API_
 
	`C­tu»Std”r
();

1366 
GTEST_API_
 
¡d
::
¡ršg
 
	`G‘C­tu»dStd”r
();

1370 
GTEST_API_
 
size_t
 
	`G‘FeSize
(
FILE
* 
fe
);

1373 
GTEST_API_
 
¡d
::
¡ršg
 
	`R—dEÁœeFe
(
FILE
* 
fe
);

1376 
GTEST_API_
 
¡d
::
veùÜ
<¡d::
¡ršg
> 
	`G‘Argvs
();

1378 #ià
GTEST_HAS_DEATH_TEST


1380 
¡d
::
veùÜ
<¡d::
¡ršg
> 
	`G‘InjeùabËArgvs
();

1382 
	`S‘InjeùabËArgvs
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>* 
Ãw_¬gvs
);

1383 
	`S‘InjeùabËArgvs
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
Ãw_¬gvs
);

1384 
	`CË¬InjeùabËArgvs
();

1389 #ià
GTEST_IS_THREADSAFE


1390 #ià
GTEST_HAS_PTHREAD


1394 
šlše
 
	`SË•Mli£cÚds
(
n
) {

1395 cÚ¡ 
time¥ec
 
time
 = {

1397 
n
 * 1000L * 1000L,

1399 
	`Çno¦“p
(&
time
, 
nuÎ±r
);

1403 #ià
GTEST_HAS_NOTIFICATION_


1407 #–ià
GTEST_HAS_PTHREAD


1414 şas 
	cNÙifiÿtiÚ
 {

1415 
public
:

1416 
	`NÙifiÿtiÚ
(è: 
	`nÙif›d_
(
çl£
) {

1417 
	`GTEST_CHECK_POSIX_SUCCESS_
(
	`±h»ad_mu‹x_š™
(&
mu‹x_
, 
nuÎ±r
));

1419 ~
	`NÙifiÿtiÚ
() {

1420 
	`±h»ad_mu‹x_de¡roy
(&
mu‹x_
);

1425 
	`NÙify
() {

1426 
	`±h»ad_mu‹x_lock
(&
mu‹x_
);

1427 
nÙif›d_
 = 
Œue
;

1428 
	`±h»ad_mu‹x_uÆock
(&
mu‹x_
);

1433 
	`Wa™FÜNÙifiÿtiÚ
() {

1435 
	`±h»ad_mu‹x_lock
(&
mu‹x_
);

1436 cÚ¡ 
boŞ
 
nÙif›d
 = 
nÙif›d_
;

1437 
	`±h»ad_mu‹x_uÆock
(&
mu‹x_
);

1438 ià(
nÙif›d
)

1440 
	`SË•Mli£cÚds
(10);

1444 
´iv©e
:

1445 
±h»ad_mu‹x_t
 
mu‹x_
;

1446 
boŞ
 
nÙif›d_
;

1448 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
NÙifiÿtiÚ
);

1451 #–ià
GTEST_OS_WINDOWS
 && !
GTEST_OS_WINDOWS_PHONE
 && !
GTEST_OS_WINDOWS_RT


1453 
GTEST_API_
 
	`SË•Mli£cÚds
(
n
);

1457 şas 
	cGTEST_API_
 
AutoHªdË
 {

1458 
public
:

1464 * 
	tHªdË
;

1465 
	`AutoHªdË
();

1466 
ex¶ic™
 
	`AutoHªdË
(
HªdË
 
hªdË
);

1468 ~
	`AutoHªdË
();

1470 
HªdË
 
	`G‘
() const;

1471 
	`Re£t
();

1472 
	`Re£t
(
HªdË
 
hªdË
);

1474 
´iv©e
:

1477 
boŞ
 
	`IsClo£abË
() const;

1479 
HªdË
 
hªdË_
;

1481 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
AutoHªdË
);

1490 şas 
	cGTEST_API_
 
NÙifiÿtiÚ
 {

1491 
public
:

1492 
	`NÙifiÿtiÚ
();

1493 
	`NÙify
();

1494 
	`Wa™FÜNÙifiÿtiÚ
();

1496 
´iv©e
:

1497 
AutoHªdË
 
ev’t_
;

1499 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
NÙifiÿtiÚ
);

1506 #ià
GTEST_HAS_PTHREAD
 && !
GTEST_OS_WINDOWS_MINGW


1513 şas 
	cTh»adW™hP¬amBa£
 {

1514 
public
:

1515 
vœtu®
 ~
	`Th»adW™hP¬amBa£
() {}

1516 
vœtu®
 
	`Run
() = 0;

1525 "C" 
šlše
 * 
	`Th»adFuncW™hCLškage
(* 
th»ad
) {

1526 
¡©ic_ÿ¡
<
Th»adW™hP¬amBa£
*>(
th»ad
)->
	`Run
();

1527  
nuÎ±r
;

1542 
‹m¶©e
 <
ty³Çme
 
T
>

1543 şas 
	cTh»adW™hP¬am
 : 
public
 
Th»adW™hP¬amBa£
 {

1544 
public
:

1545 
	tU£rTh»adFunc
(
	tT
);

1547 
	`Th»adW™hP¬am
(
U£rTh»adFunc
* 
func
, 
T
 
·¿m
, 
NÙifiÿtiÚ
* 
th»ad_ÿn_¡¬t
)

1548 : 
	`func_
(
func
),

1549 
	`·¿m_
(
·¿m
),

1550 
	`th»ad_ÿn_¡¬t_
(
th»ad_ÿn_¡¬t
),

1551 
	`fšished_
(
çl£
) {

1552 
Th»adW™hP¬amBa£
* cÚ¡ 
ba£
 = 
this
;

1555 
	`GTEST_CHECK_POSIX_SUCCESS_
(

1556 
	`±h»ad_ü—‹
(&
th»ad_
, 
nuÎ±r
, &
Th»adFuncW™hCLškage
, 
ba£
));

1558 ~
	`Th»adW™hP¬am
(è
ov”ride
 { 
	`Još
(); }

1560 
	`Još
() {

1561 ià(!
fšished_
) {

1562 
	`GTEST_CHECK_POSIX_SUCCESS_
(
	`±h»ad_još
(
th»ad_
, 
nuÎ±r
));

1563 
fšished_
 = 
Œue
;

1567 
	`Run
(è
ov”ride
 {

1568 ià(
th»ad_ÿn_¡¬t_
 !ğ
nuÎ±r
èth»ad_ÿn_¡¬t_->
	`Wa™FÜNÙifiÿtiÚ
();

1569 
	`func_
(
·¿m_
);

1572 
´iv©e
:

1573 
U£rTh»adFunc
* cÚ¡ 
func_
;

1574 cÚ¡ 
T
 
·¿m_
;

1577 
NÙifiÿtiÚ
* cÚ¡ 
th»ad_ÿn_¡¬t_
;

1578 
boŞ
 
fšished_
;

1580 
±h»ad_t
 
th»ad_
;

1582 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Th»adW™hP¬am
);

1587 #ià
GTEST_HAS_MUTEX_AND_THREAD_LOCAL_


1591 #–ià
GTEST_OS_WINDOWS
 && !
GTEST_OS_WINDOWS_PHONE
 && !
GTEST_OS_WINDOWS_RT


1607 şas 
	cGTEST_API_
 
Mu‹x
 {

1608 
public
:

1609 
	eMu‹xTy³
 { 
kStic
 = 0, 
kDyÇmic
 = 1 };

1613 
	eSticCÚ¡ruùÜS–eùÜ
 { 
kSticMu‹x
 = 0 };

1618 
ex¶ic™
 
	`Mu‹x
(
SticCÚ¡ruùÜS–eùÜ
 ) {}

1620 
	`Mu‹x
();

1621 ~
	`Mu‹x
();

1623 
	`Lock
();

1625 
	`UÆock
();

1629 
	`As£¹H–d
();

1631 
´iv©e
:

1633 
	`Th»adSaãLazyIn™
();

1637 
owÃr_th»ad_id_
;

1641 
Mu‹xTy³
 
ty³_
;

1642 
ü™iÿl_£ùiÚ_š™_pha£_
;

1643 
GTEST_CRITICAL_SECTION
* 
ü™iÿl_£ùiÚ_
;

1645 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Mu‹x
);

1648 
	#GTEST_DECLARE_STATIC_MUTEX_
(
mu‹x
) \

1649 ::
‹¡šg
::
š‹º®
::
Mu‹x
 
mu‹x


	)

1651 
	#GTEST_DEFINE_STATIC_MUTEX_
(
mu‹x
) \

1652 ::
‹¡šg
::
š‹º®
::
Mu‹x
 
	`mu‹x
(::‹¡šg::š‹º®::Mu‹x::
kSticMu‹x
)

	)

1659 şas 
	cGTe¡Mu‹xLock
 {

1660 
public
:

1661 
ex¶ic™
 
	`GTe¡Mu‹xLock
(
Mu‹x
* 
mu‹x
)

1662 : 
	`mu‹x_
(
mu‹x
è{ 
mu‹x_
->
	`Lock
(); }

1664 ~
	`GTe¡Mu‹xLock
(è{ 
mu‹x_
->
	`UÆock
(); }

1666 
´iv©e
:

1667 
Mu‹x
* cÚ¡ 
mu‹x_
;

1669 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
GTe¡Mu‹xLock
);

1672 
GTe¡Mu‹xLock
 
	tMu‹xLock
;

1676 şas 
	cTh»adLoÿlV®ueHŞd”Ba£
 {

1677 
public
:

1678 
vœtu®
 ~
	`Th»adLoÿlV®ueHŞd”Ba£
() {}

1683 şas 
	cTh»adLoÿlBa£
 {

1684 
public
:

1689 
vœtu®
 
Th»adLoÿlV®ueHŞd”Ba£
* 
	`NewV®ueFÜCu¼’tTh»ad
() const = 0;

1691 
´Ùeùed
:

1692 
	`Th»adLoÿlBa£
() {}

1693 
vœtu®
 ~
	`Th»adLoÿlBa£
() {}

1695 
´iv©e
:

1696 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Th»adLoÿlBa£
);

1702 şas 
	cGTEST_API_
 
Th»adLoÿlRegi¡ry
 {

1703 
public
:

1706 
Th»adLoÿlV®ueHŞd”Ba£
* 
	`G‘V®ueOnCu¼’tTh»ad
(

1707 cÚ¡ 
Th»adLoÿlBa£
* 
th»ad_loÿl_š¡ªû
);

1710 
	`OnTh»adLoÿlDe¡royed
(

1711 cÚ¡ 
Th»adLoÿlBa£
* 
th»ad_loÿl_š¡ªû
);

1714 şas 
	cGTEST_API_
 
Th»adW™hP¬amBa£
 {

1715 
public
:

1716 
	`Još
();

1718 
´Ùeùed
:

1719 şas 
	cRuÂabË
 {

1720 
public
:

1721 
vœtu®
 ~
	`RuÂabË
() {}

1722 
vœtu®
 
	`Run
() = 0;

1725 
	`Th»adW™hP¬amBa£
(
RuÂabË
 *
ruÂabË
, 
NÙifiÿtiÚ
* 
th»ad_ÿn_¡¬t
);

1726 
vœtu®
 ~
	`Th»adW™hP¬amBa£
();

1728 
´iv©e
:

1729 
AutoHªdË
 
th»ad_
;

1733 
‹m¶©e
 <
ty³Çme
 
T
>

1734 şas 
	cTh»adW™hP¬am
 : 
public
 
Th»adW™hP¬amBa£
 {

1735 
public
:

1736 
	tU£rTh»adFunc
(
	tT
);

1738 
	`Th»adW™hP¬am
(
U£rTh»adFunc
* 
func
, 
T
 
·¿m
, 
NÙifiÿtiÚ
* 
th»ad_ÿn_¡¬t
)

1739 : 
	`Th»adW™hP¬amBa£
(
Ãw
 
	`RuÂabËIm¶
(
func
, 
·¿m
), 
th»ad_ÿn_¡¬t
) {

1741 
vœtu®
 ~
	`Th»adW™hP¬am
() {}

1743 
´iv©e
:

1744 şas 
	cRuÂabËIm¶
 : 
public
 
RuÂabË
 {

1745 
public
:

1746 
	`RuÂabËIm¶
(
U£rTh»adFunc
* 
func
, 
T
 
·¿m
)

1747 : 
	`func_
(
func
),

1748 
	`·¿m_
(
·¿m
) {

1750 
vœtu®
 ~
	`RuÂabËIm¶
() {}

1751 
vœtu®
 
	`Run
() {

1752 
	`func_
(
·¿m_
);

1755 
´iv©e
:

1756 
U£rTh»adFunc
* cÚ¡ 
func_
;

1757 cÚ¡ 
T
 
·¿m_
;

1759 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
RuÂabËIm¶
);

1762 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Th»adW™hP¬am
);

1792 
‹m¶©e
 <
ty³Çme
 
T
>

1793 şas 
	cTh»adLoÿl
 : 
public
 
Th»adLoÿlBa£
 {

1794 
public
:

1795 
	`Th»adLoÿl
(è: 
	`deçuÉ_çùÜy_
(
Ãw
 
	`DeçuÉV®ueHŞd”FaùÜy
()) {}

1796 
ex¶ic™
 
	`Th»adLoÿl
(cÚ¡ 
T
& 
v®ue
)

1797 : 
	`deçuÉ_çùÜy_
(
Ãw
 
	`In¡ªûV®ueHŞd”FaùÜy
(
v®ue
)) {}

1799 ~
	`Th»adLoÿl
(è{ 
Th»adLoÿlRegi¡ry
::
	`OnTh»adLoÿlDe¡royed
(
this
); }

1801 
T
* 
	`poš‹r
(è{  
	`G‘OrC»©eV®ue
(); }

1802 cÚ¡ 
T
* 
	`poš‹r
(ècÚ¡ {  
	`G‘OrC»©eV®ue
(); }

1803 cÚ¡ 
T
& 
	`g‘
(ècÚ¡ {  *
	`poš‹r
(); }

1804 
	`£t
(cÚ¡ 
T
& 
v®ue
è{ *
	`poš‹r
() = value; }

1806 
´iv©e
:

1809 şas 
	cV®ueHŞd”
 : 
public
 
Th»adLoÿlV®ueHŞd”Ba£
 {

1810 
public
:

1811 
	`V®ueHŞd”
(è: 
	`v®ue_
() {}

1812 
ex¶ic™
 
	`V®ueHŞd”
(cÚ¡ 
T
& 
v®ue
è: 
	`v®ue_
(value) {}

1814 
T
* 
	`poš‹r
(è{  &
v®ue_
; }

1816 
´iv©e
:

1817 
T
 
v®ue_
;

1818 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
V®ueHŞd”
);

1822 
T
* 
	`G‘OrC»©eV®ue
() const {

1823  
¡©ic_ÿ¡
<
V®ueHŞd”
*>(

1824 
Th»adLoÿlRegi¡ry
::
	`G‘V®ueOnCu¼’tTh»ad
(
this
))->
	`poš‹r
();

1827 
vœtu®
 
Th»adLoÿlV®ueHŞd”Ba£
* 
	`NewV®ueFÜCu¼’tTh»ad
() const {

1828  
deçuÉ_çùÜy_
->
	`MakeNewHŞd”
();

1831 şas 
	cV®ueHŞd”FaùÜy
 {

1832 
public
:

1833 
	`V®ueHŞd”FaùÜy
() {}

1834 
vœtu®
 ~
	`V®ueHŞd”FaùÜy
() {}

1835 
vœtu®
 
V®ueHŞd”
* 
	`MakeNewHŞd”
() const = 0;

1837 
´iv©e
:

1838 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
V®ueHŞd”FaùÜy
);

1841 şas 
	cDeçuÉV®ueHŞd”FaùÜy
 : 
public
 
V®ueHŞd”FaùÜy
 {

1842 
public
:

1843 
	`DeçuÉV®ueHŞd”FaùÜy
() {}

1844 
vœtu®
 
V®ueHŞd”
* 
	`MakeNewHŞd”
(ècÚ¡ {  
Ãw
 
	`V®ueHŞd”
(); }

1846 
´iv©e
:

1847 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
DeçuÉV®ueHŞd”FaùÜy
);

1850 şas 
	cIn¡ªûV®ueHŞd”FaùÜy
 : 
public
 
V®ueHŞd”FaùÜy
 {

1851 
public
:

1852 
ex¶ic™
 
	`In¡ªûV®ueHŞd”FaùÜy
(cÚ¡ 
T
& 
v®ue
è: 
	`v®ue_
(value) {}

1853 
vœtu®
 
V®ueHŞd”
* 
	`MakeNewHŞd”
() const {

1854  
Ãw
 
	`V®ueHŞd”
(
v®ue_
);

1857 
´iv©e
:

1858 cÚ¡ 
T
 
v®ue_
;

1860 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
In¡ªûV®ueHŞd”FaùÜy
);

1863 
¡d
::
unique_±r
<
V®ueHŞd”FaùÜy
> 
deçuÉ_çùÜy_
;

1865 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Th»adLoÿl
);

1868 #–ià
GTEST_HAS_PTHREAD


1871 şas 
	cMu‹xBa£
 {

1872 
public
:

1874 
	`Lock
() {

1875 
	`GTEST_CHECK_POSIX_SUCCESS_
(
	`±h»ad_mu‹x_lock
(&
mu‹x_
));

1876 
owÃr_
 = 
	`±h»ad_£lf
();

1877 
has_owÃr_
 = 
Œue
;

1881 
	`UÆock
() {

1886 
has_owÃr_
 = 
çl£
;

1887 
	`GTEST_CHECK_POSIX_SUCCESS_
(
	`±h»ad_mu‹x_uÆock
(&
mu‹x_
));

1892 
	`As£¹H–d
() const {

1893 
	`GTEST_CHECK_
(
has_owÃr_
 && 
	`±h»ad_equ®
(
owÃr_
, 
	`±h»ad_£lf
()))

1894 << "Thcu¼’ˆth»ad i nÙ hŞdšghmu‹x @" << 
this
;

1902 
public
:

1903 
±h»ad_mu‹x_t
 
mu‹x_
;

1910 
boŞ
 
has_owÃr_
;

1911 
±h»ad_t
 
owÃr_
;

1915 
	#GTEST_DECLARE_STATIC_MUTEX_
(
mu‹x
) \

1916 ::
‹¡šg
::
š‹º®
::
Mu‹xBa£
 
mu‹x


	)

1924 
	#GTEST_DEFINE_STATIC_MUTEX_
(
mu‹x
) \

1925 ::
‹¡šg
::
š‹º®
::
Mu‹xBa£
 
mu‹x
 = {
PTHREAD_MUTEX_INITIALIZER
, 
çl£
, 0}

	)

1929 şas 
	cMu‹x
 : 
public
 
Mu‹xBa£
 {

1930 
public
:

1931 
	`Mu‹x
() {

1932 
	`GTEST_CHECK_POSIX_SUCCESS_
(
	`±h»ad_mu‹x_š™
(&
mu‹x_
, 
nuÎ±r
));

1933 
has_owÃr_
 = 
çl£
;

1935 ~
	`Mu‹x
() {

1936 
	`GTEST_CHECK_POSIX_SUCCESS_
(
	`±h»ad_mu‹x_de¡roy
(&
mu‹x_
));

1939 
´iv©e
:

1940 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Mu‹x
);

1948 şas 
	cGTe¡Mu‹xLock
 {

1949 
public
:

1950 
ex¶ic™
 
	`GTe¡Mu‹xLock
(
Mu‹xBa£
* 
mu‹x
)

1951 : 
	`mu‹x_
(
mu‹x
è{ 
mu‹x_
->
	`Lock
(); }

1953 ~
	`GTe¡Mu‹xLock
(è{ 
mu‹x_
->
	`UÆock
(); }

1955 
´iv©e
:

1956 
Mu‹xBa£
* cÚ¡ 
mu‹x_
;

1958 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
GTe¡Mu‹xLock
);

1961 
GTe¡Mu‹xLock
 
	tMu‹xLock
;

1969 şas 
	cTh»adLoÿlV®ueHŞd”Ba£
 {

1970 
public
:

1971 
vœtu®
 ~
	`Th»adLoÿlV®ueHŞd”Ba£
() {}

1976 "C" 
šlše
 
	`D–‘eTh»adLoÿlV®ue
(* 
v®ue_hŞd”
) {

1977 
d–‘e
 
¡©ic_ÿ¡
<
Th»adLoÿlV®ueHŞd”Ba£
*>(
v®ue_hŞd”
);

1981 
‹m¶©e
 <
ty³Çme
 
T
>

1982 şas 
	cGTEST_API_
 
Th»adLoÿl
 {

1983 
public
:

1984 
	`Th»adLoÿl
()

1985 : 
	`key_
(
	`C»©eKey
()), 
	`deçuÉ_çùÜy_
(
Ãw
 
	`DeçuÉV®ueHŞd”FaùÜy
()) {}

1986 
ex¶ic™
 
	`Th»adLoÿl
(cÚ¡ 
T
& 
v®ue
)

1987 : 
	`key_
(
	`C»©eKey
()),

1988 
	`deçuÉ_çùÜy_
(
Ãw
 
	`In¡ªûV®ueHŞd”FaùÜy
(
v®ue
)) {}

1990 ~
	`Th»adLoÿl
() {

1992 
	`D–‘eTh»adLoÿlV®ue
(
	`±h»ad_g‘¥ecific
(
key_
));

1996 
	`GTEST_CHECK_POSIX_SUCCESS_
(
	`±h»ad_key_d–‘e
(
key_
));

1999 
T
* 
	`poš‹r
(è{  
	`G‘OrC»©eV®ue
(); }

2000 cÚ¡ 
T
* 
	`poš‹r
(ècÚ¡ {  
	`G‘OrC»©eV®ue
(); }

2001 cÚ¡ 
T
& 
	`g‘
(ècÚ¡ {  *
	`poš‹r
(); }

2002 
	`£t
(cÚ¡ 
T
& 
v®ue
è{ *
	`poš‹r
() = value; }

2004 
´iv©e
:

2006 şas 
	cV®ueHŞd”
 : 
public
 
Th»adLoÿlV®ueHŞd”Ba£
 {

2007 
public
:

2008 
	`V®ueHŞd”
(è: 
	`v®ue_
() {}

2009 
ex¶ic™
 
	`V®ueHŞd”
(cÚ¡ 
T
& 
v®ue
è: 
	`v®ue_
(value) {}

2011 
T
* 
	`poš‹r
(è{  &
v®ue_
; }

2013 
´iv©e
:

2014 
T
 
v®ue_
;

2015 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
V®ueHŞd”
);

2018 
±h»ad_key_t
 
	`C»©eKey
() {

2019 
±h»ad_key_t
 
key
;

2022 
	`GTEST_CHECK_POSIX_SUCCESS_
(

2023 
	`±h»ad_key_ü—‹
(&
key
, &
D–‘eTh»adLoÿlV®ue
));

2024  
key
;

2027 
T
* 
	`G‘OrC»©eV®ue
() const {

2028 
Th»adLoÿlV®ueHŞd”Ba£
* cÚ¡ 
hŞd”
 =

2029 
¡©ic_ÿ¡
<
Th»adLoÿlV®ueHŞd”Ba£
*>(
	`±h»ad_g‘¥ecific
(
key_
));

2030 ià(
hŞd”
 !ğ
nuÎ±r
) {

2031  
CheckedDownÿ¡ToAùu®Ty³
<
V®ueHŞd”
>(
hŞd”
)->
	`poš‹r
();

2034 
V®ueHŞd”
* cÚ¡ 
Ãw_hŞd”
 = 
deçuÉ_çùÜy_
->
	`MakeNewHŞd”
();

2035 
Th»adLoÿlV®ueHŞd”Ba£
* cÚ¡ 
hŞd”_ba£
 = 
Ãw_hŞd”
;

2036 
	`GTEST_CHECK_POSIX_SUCCESS_
(
	`±h»ad_£t¥ecific
(
key_
, 
hŞd”_ba£
));

2037  
Ãw_hŞd”
->
	`poš‹r
();

2040 şas 
	cV®ueHŞd”FaùÜy
 {

2041 
public
:

2042 
	`V®ueHŞd”FaùÜy
() {}

2043 
vœtu®
 ~
	`V®ueHŞd”FaùÜy
() {}

2044 
vœtu®
 
V®ueHŞd”
* 
	`MakeNewHŞd”
() const = 0;

2046 
´iv©e
:

2047 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
V®ueHŞd”FaùÜy
);

2050 şas 
	cDeçuÉV®ueHŞd”FaùÜy
 : 
public
 
V®ueHŞd”FaùÜy
 {

2051 
public
:

2052 
	`DeçuÉV®ueHŞd”FaùÜy
() {}

2053 
vœtu®
 
V®ueHŞd”
* 
	`MakeNewHŞd”
(ècÚ¡ {  
Ãw
 
	`V®ueHŞd”
(); }

2055 
´iv©e
:

2056 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
DeçuÉV®ueHŞd”FaùÜy
);

2059 şas 
	cIn¡ªûV®ueHŞd”FaùÜy
 : 
public
 
V®ueHŞd”FaùÜy
 {

2060 
public
:

2061 
ex¶ic™
 
	`In¡ªûV®ueHŞd”FaùÜy
(cÚ¡ 
T
& 
v®ue
è: 
	`v®ue_
(value) {}

2062 
vœtu®
 
V®ueHŞd”
* 
	`MakeNewHŞd”
() const {

2063  
Ãw
 
	`V®ueHŞd”
(
v®ue_
);

2066 
´iv©e
:

2067 cÚ¡ 
T
 
v®ue_
;

2069 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
In¡ªûV®ueHŞd”FaùÜy
);

2073 cÚ¡ 
±h»ad_key_t
 
key_
;

2074 
¡d
::
unique_±r
<
V®ueHŞd”FaùÜy
> 
deçuÉ_çùÜy_
;

2076 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Th»adLoÿl
);

2088 şas 
	cMu‹x
 {

2089 
public
:

2090 
	`Mu‹x
() {}

2091 
	`Lock
() {}

2092 
	`UÆock
() {}

2093 
	`As£¹H–d
() const {}

2096 
	#GTEST_DECLARE_STATIC_MUTEX_
(
mu‹x
) \

2097 ::
‹¡šg
::
š‹º®
::
Mu‹x
 
mu‹x


	)

2099 
	#GTEST_DEFINE_STATIC_MUTEX_
(
mu‹x
è::
‹¡šg
::
š‹º®
::
Mu‹x
 
	)
mutex

2106 şas 
	cGTe¡Mu‹xLock
 {

2107 
public
:

2108 
ex¶ic™
 
	`GTe¡Mu‹xLock
(
Mu‹x
*) {}

2111 
GTe¡Mu‹xLock
 
	tMu‹xLock
;

2113 
‹m¶©e
 <
ty³Çme
 
T
>

2114 şas 
	cGTEST_API_
 
Th»adLoÿl
 {

2115 
public
:

2116 
	`Th»adLoÿl
(è: 
	`v®ue_
() {}

2117 
ex¶ic™
 
	`Th»adLoÿl
(cÚ¡ 
T
& 
v®ue
è: 
	`v®ue_
(value) {}

2118 
T
* 
	`poš‹r
(è{  &
v®ue_
; }

2119 cÚ¡ 
T
* 
	`poš‹r
(ècÚ¡ {  &
v®ue_
; }

2120 cÚ¡ 
T
& 
	`g‘
(ècÚ¡ {  
v®ue_
; }

2121 
	`£t
(cÚ¡ 
T
& 
v®ue
è{ 
v®ue_
 = value; }

2122 
´iv©e
:

2123 
T
 
v®ue_
;

2130 
GTEST_API_
 
size_t
 
	`G‘Th»adCouÁ
();

2132 
‹m¶©e
 <
boŞ
 
B
>

2133 
usšg
 
boŞ_cÚ¡ªt
 = 
¡d
::
š‹g¿l_cÚ¡ªt
<
boŞ
, 
B
>;

2135 #ià
GTEST_OS_WINDOWS


2136 
	#GTEST_PATH_SEP_
 "\\"

	)

2137 
	#GTEST_HAS_ALT_PATH_SEP_
 1

	)

2139 
__št64
 
	tBigge¡IÁ
;

2141 
	#GTEST_PATH_SEP_
 "/"

	)

2142 
	#GTEST_HAS_ALT_PATH_SEP_
 0

	)

2143 
	tBigge¡IÁ
;

2153 
šlše
 
boŞ
 
	`IsAÍha
(
ch
) {

2154  
	`i§Íha
(
¡©ic_ÿ¡
<>(
ch
)) != 0;

2156 
šlše
 
boŞ
 
	`IsAlNum
(
ch
) {

2157  
	`i§Êum
(
¡©ic_ÿ¡
<>(
ch
)) != 0;

2159 
šlše
 
boŞ
 
	`IsDig™
(
ch
) {

2160  
	`isdig™
(
¡©ic_ÿ¡
<>(
ch
)) != 0;

2162 
šlše
 
boŞ
 
	`IsLow”
(
ch
) {

2163  
	`i¦ow”
(
¡©ic_ÿ¡
<>(
ch
)) != 0;

2165 
šlše
 
boŞ
 
	`IsS·û
(
ch
) {

2166  
	`is¥aû
(
¡©ic_ÿ¡
<>(
ch
)) != 0;

2168 
šlše
 
boŞ
 
	`IsUµ”
(
ch
) {

2169  
	`isuµ”
(
¡©ic_ÿ¡
<>(
ch
)) != 0;

2171 
šlše
 
boŞ
 
	`IsXDig™
(
ch
) {

2172  
	`isxdig™
(
¡©ic_ÿ¡
<>(
ch
)) != 0;

2174 
šlše
 
boŞ
 
	`IsXDig™
(
wch¬_t
 
ch
) {

2175 cÚ¡ 
low_by‹
 = 
¡©ic_ÿ¡
<>(
ch
);

2176  
ch
 =ğ
low_by‹
 && 
	`isxdig™
(low_byte) != 0;

2179 
šlše
 
	`ToLow”
(
ch
) {

2180  
¡©ic_ÿ¡
<>(
	`tŞow”
(¡©ic_ÿ¡<>(
ch
)));

2182 
šlše
 
	`ToUµ”
(
ch
) {

2183  
¡©ic_ÿ¡
<>(
	`touµ”
(¡©ic_ÿ¡<>(
ch
)));

2186 
šlše
 
¡d
::
¡ršg
 
	`SŒT¿šgS·ûs
(¡d::¡ršg 
¡r
) {

2187 
¡d
::
¡ršg
::
™”©Ü
 
™
 = 
¡r
.
	`’d
();

2188 
™
 !ğ
¡r
.
	`begš
(è&& 
	`IsS·û
(*--it))

2189 
™
 = 
¡r
.
	`”a£
(it);

2190  
¡r
;

2199 
Çme¥aû
 
posix
 {

2203 #ià
GTEST_OS_WINDOWS


2205 
_¡©
 
	tStSŒuù
;

2207 #ifdeà
__BORLANDC__


2208 
šlše
 
	`IsATTY
(
fd
è{  
	`i§‰y
(fd); }

2209 
šlše
 
	`SŒCa£Cmp
(cÚ¡ * 
s1
, cÚ¡ * 
s2
) {

2210  
	`¡ricmp
(
s1
, 
s2
);

2212 
šlše
 * 
	`SŒDup
(cÚ¡ * 
¤c
è{  
	`¡rdup
(src); }

2214 #ià
GTEST_OS_WINDOWS_MOBILE


2215 
šlše
 
	`IsATTY
() {  0; }

2217 
šlše
 
	`IsATTY
(
fd
è{  
	`_i§‰y
(fd); }

2219 
šlše
 
	`SŒCa£Cmp
(cÚ¡ * 
s1
, cÚ¡ * 
s2
) {

2220  
	`_¡ricmp
(
s1
, 
s2
);

2222 
šlše
 * 
	`SŒDup
(cÚ¡ * 
¤c
è{  
	`_¡rdup
(src); }

2225 #ià
GTEST_OS_WINDOWS_MOBILE


2226 
šlše
 
	`FeNo
(
FILE
* 
fe
è{  
»š‹½»t_ÿ¡
<>(
	`_f’o
(file)); }

2230 
šlše
 
	`FeNo
(
FILE
* 
fe
è{  
	`_f’o
(file); }

2231 
šlše
 
	`St
(cÚ¡ * 
·th
, 
StSŒuù
* 
buf
è{  
	`_¡©
(path, buf); }

2232 
šlše
 
	`RmDœ
(cÚ¡ * 
dœ
è{  
	`_rmdœ
(dir); }

2233 
šlše
 
boŞ
 
	`IsDœ
(cÚ¡ 
StSŒuù
& 
¡
) {

2234  (
_S_IFDIR
 & 
¡
.
¡_mode
) != 0;

2240 
¡©
 
	tStSŒuù
;

2242 
šlše
 
	`FeNo
(
FILE
* 
fe
è{  
	`f’o
(file); }

2243 
šlše
 
	`IsATTY
(
fd
è{  
	`i§‰y
(fd); }

2244 
šlše
 
	`St
(cÚ¡ * 
·th
, 
StSŒuù
* 
buf
è{  
	`¡©
(path, buf); }

2245 
šlše
 
	`SŒCa£Cmp
(cÚ¡ * 
s1
, cÚ¡ * 
s2
) {

2246  
	`¡rÿ£cmp
(
s1
, 
s2
);

2248 
šlše
 * 
	`SŒDup
(cÚ¡ * 
¤c
è{  
	`¡rdup
(src); }

2249 
šlše
 
	`RmDœ
(cÚ¡ * 
dœ
è{  
	`rmdœ
(dir); }

2250 
šlše
 
boŞ
 
	`IsDœ
(cÚ¡ 
StSŒuù
& 
¡
è{  
	`S_ISDIR
(¡.
¡_mode
); }

2256 
	`GTEST_DISABLE_MSC_DEPRECATED_PUSH_
()

2258 
šlše
 cÚ¡ * 
	`SŒNCpy
(* 
de¡
, cÚ¡ * 
¤c
, 
size_t
 
n
) {

2259  
	`¡ºıy
(
de¡
, 
¤c
, 
n
);

2266 #ià!
GTEST_OS_WINDOWS_MOBILE
 && !
GTEST_OS_WINDOWS_PHONE
 && !
GTEST_OS_WINDOWS_RT


2267 
šlše
 
	`ChDœ
(cÚ¡ * 
dœ
è{  
	`chdœ
(dir); }

2269 
šlše
 
FILE
* 
	`FO³n
(cÚ¡ * 
·th
, cÚ¡ * 
mode
) {

2270  
	`fİ’
(
·th
, 
mode
);

2272 #ià!
GTEST_OS_WINDOWS_MOBILE


2273 
šlše
 
FILE
 *
	`FReİ’
(cÚ¡ * 
·th
, cÚ¡ * 
mode
, FILE* 
¡»am
) {

2274  
	`äeİ’
(
·th
, 
mode
, 
¡»am
);

2276 
šlše
 
FILE
* 
	`FDO³n
(
fd
, cÚ¡ * 
mode
è{  
	`fdİ’
(fd, mode); }

2278 
šlše
 
	`FClo£
(
FILE
* 
å
è{  
	`fşo£
(fp); }

2279 #ià!
GTEST_OS_WINDOWS_MOBILE


2280 
šlše
 
	`R—d
(
fd
, * 
buf
, 
couÁ
) {

2281  
¡©ic_ÿ¡
<>(
	`»ad
(
fd
, 
buf
, 
couÁ
));

2283 
šlše
 
	`Wr™e
(
fd
, cÚ¡ * 
buf
, 
couÁ
) {

2284  
¡©ic_ÿ¡
<>(
	`wr™e
(
fd
, 
buf
, 
couÁ
));

2286 
šlše
 
	`Clo£
(
fd
è{  
	`şo£
(fd); }

2287 
šlše
 cÚ¡ * 
	`SŒE¼Ü
(
”ºum
è{  
	`¡»¼Ü
(errnum); }

2289 
šlše
 cÚ¡ * 
	`G‘Env
(cÚ¡ * 
Çme
) {

2290 #ià
GTEST_OS_WINDOWS_MOBILE
 || 
GTEST_OS_WINDOWS_PHONE
 || 
GTEST_OS_WINDOWS_RT


2292 
¡©ic_ÿ¡
<>(
Çme
);

2293  
nuÎ±r
;

2294 #–ià
	`defšed
(
__BORLANDC__
è|| defšed(
__SunOS_5_8
è|| defšed(
__SunOS_5_9
)

2297 cÚ¡ * cÚ¡ 
’v
 = 
	`g‘’v
(
Çme
);

2298  (
’v
 !ğ
nuÎ±r
 &&ƒnv[0] != '\0') ?ƒnv :‚ullptr;

2300  
	`g‘’v
(
Çme
);

2304 
	`GTEST_DISABLE_MSC_DEPRECATED_POP_
()

2306 #ià
GTEST_OS_WINDOWS_MOBILE


2310 [[
nÜ‘uº
]] 
	`AbÜt
();

2312 [[
nÜ‘uº
]] 
šlše
 
	`AbÜt
(è{ 
	`abÜt
(); }

2322 #ià
_MSC_VER
 && !
GTEST_OS_WINDOWS_MOBILE


2324 
	#GTEST_SNPRINTF_
(
bufãr
, 
size
, 
fÜm©
, ...) \

2325 
	`_¢´štf_s
(
bufãr
, 
size
, size, 
fÜm©
, 
__VA_ARGS__
)

	)

2326 #–ià
	`defšed
(
_MSC_VER
)

2328 
	#GTEST_SNPRINTF_
 
_¢´štf


	)

2330 
	#GTEST_SNPRINTF_
 
¢´štf


	)

2340 cÚ¡ 
Bigge¡IÁ
 
kMaxBigge¡IÁ
 =

2341 ~(
¡©ic_ÿ¡
<
Bigge¡IÁ
>(1) << (8*(BiggestInt) - 1));

2361 
‹m¶©e
 <
size_t
 
size
>

2362 şas 
	cTy³W™hSize
 {

2363 
public
:

2366 
	tUIÁ
;

2370 
‹m¶©e
 <>

2371 
şass
 
Ty³W™hSize
<4> {

2372 
public
:

2377 
	tIÁ
;

2378 
	tUIÁ
;

2382 
‹m¶©e
 <>

2383 
şass
 
Ty³W™hSize
<8> {

2384 
public
:

2385 #ià
GTEST_OS_WINDOWS


2386 
__št64
 
	tIÁ
;

2387 
	t__št64
 
	tUIÁ
;

2389 
	tIÁ
;

2390 
	tUIÁ
;

2395 
Ty³W™hSize
<4>::
	tIÁ
 
	tIÁ32
;

2396 
Ty³W™hSize
<4>::
	tUIÁ
 
	tUIÁ32
;

2397 
Ty³W™hSize
<8>::
	tIÁ
 
	tIÁ64
;

2398 
Ty³W™hSize
<8>::
	tUIÁ
 
	tUIÁ64
;

2399 
Ty³W™hSize
<8>::
	tIÁ
 
	tTimeInMlis
;

2404 #ià!
	`defšed
(
GTEST_FLAG
)

2405 
	#GTEST_FLAG
(
Çme
è
FLAGS_g‹¡_
##
	)
name

2408 #ià!
	`defšed
(
GTEST_USE_OWN_FLAGFILE_FLAG_
)

2409 
	#GTEST_USE_OWN_FLAGFILE_FLAG_
 1

	)

2412 #ià!
	`defšed
(
GTEST_DECLARE_boŞ_
)

2413 
	#GTEST_FLAG_SAVER_
 ::
‹¡šg
::
š‹º®
::
GTe¡FÏgSav”


	)

2416 
	#GTEST_DECLARE_boŞ_
(
Çme
è
GTEST_API_
 
boŞ
 
	`GTEST_FLAG
Òame)

	)

2417 
	#GTEST_DECLARE_št32_
(
Çme
) \

2418 
GTEST_API_
 ::
‹¡šg
::
š‹º®
::
IÁ32
 
	`GTEST_FLAG
(
Çme
)

	)

2419 
	#GTEST_DECLARE_¡ršg_
(
Çme
) \

2420 
GTEST_API_
 ::
¡d
::
¡ršg
 
	`GTEST_FLAG
(
Çme
)

	)

2423 
	#GTEST_DEFINE_boŞ_
(
Çme
, 
deçuÉ_v®
, 
doc
) \

2424 
GTEST_API_
 
boŞ
 
	`GTEST_FLAG
(
Çme
èğ(
deçuÉ_v®
)

	)

2425 
	#GTEST_DEFINE_št32_
(
Çme
, 
deçuÉ_v®
, 
doc
) \

2426 
GTEST_API_
 ::
‹¡šg
::
š‹º®
::
IÁ32
 
	`GTEST_FLAG
(
Çme
èğ(
deçuÉ_v®
)

	)

2427 
	#GTEST_DEFINE_¡ršg_
(
Çme
, 
deçuÉ_v®
, 
doc
) \

2428 
GTEST_API_
 ::
¡d
::
¡ršg
 
	`GTEST_FLAG
(
Çme
èğ(
deçuÉ_v®
)

	)

2433 #ià!
	`defšed
(
GTEST_EXCLUSIVE_LOCK_REQUIRED_
)

2434 
	#GTEST_EXCLUSIVE_LOCK_REQUIRED_
(
locks
)

	)

2435 
	#GTEST_LOCK_EXCLUDED_
(
locks
)

	)

2441 
boŞ
 
	`P¬£IÁ32
(cÚ¡ 
Mes§ge
& 
¤c_‹xt
, cÚ¡ * 
¡r
, 
IÁ32
* 
v®ue
);

2445 
boŞ
 
	`BoŞFromGTe¡Env
(cÚ¡ * 
æag
, boŞ 
deçuÉ_v®
);

2446 
GTEST_API_
 
IÁ32
 
	`IÁ32FromGTe¡Env
(cÚ¡ * 
æag
, IÁ32 
deçuÉ_v®
);

2447 
¡d
::
¡ršg
 
	`OuutFÏgAlsoCheckEnvV¬
();

2448 cÚ¡ * 
	`SŒšgFromGTe¡Env
(cÚ¡ * 
æag
, cÚ¡ * 
deçuÉ_v®
);

2450 
	}
}

2453 #ià!
defšed
(
GTEST_INTERNAL_DEPRECATED
)

2463 #ià
defšed
(
_MSC_VER
)

2464 
	#GTEST_INTERNAL_DEPRECATED
(
mes§ge
è
	`__deş¥ec
(
	`d•»ÿ‹d
(mes§ge))

	)

2465 #–ià
defšed
(
__GNUC__
)

2466 
	#GTEST_INTERNAL_DEPRECATED
(
mes§ge
è
	`__©Œibu‹__
((
	`d•»ÿ‹d
(mes§ge)))

	)

2468 
	#GTEST_INTERNAL_DEPRECATED
(
mes§ge
)

	)

2475 #ià
GTEST_OS_LINUX


2476 
	~<¡dlib.h
>

2477 
	~<sys/ty³s.h
>

2478 
	~<sys/wa™.h
>

2479 
	~<uni¡d.h
>

2482 #ià
GTEST_HAS_EXCEPTIONS


2483 
	~<¡dexû±
>

2486 
	~<ùy³.h
>

2487 
	~<æßt.h
>

2488 
	~<¡ršg.h
>

2489 
	~<iomª
>

2490 
	~<lim™s
>

2491 
	~<m­
>

2492 
	~<£t
>

2493 
	~<¡ršg
>

2494 
	~<ty³_Œa™s
>

2495 
	~<veùÜ
>

2543 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_MESSAGE_H_


2544 
	#GTEST_INCLUDE_GTEST_GTEST_MESSAGE_H_


	)

2546 
	~<lim™s
>

2547 
	~<memÜy
>

2550 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4251 \

2555 
	gİ”©Ü
<<(cÚ¡ 
	g‹¡šg
::
š‹º®
::
Seü‘
&, );

2557 
Çme¥aû
 
	g‹¡šg
 {

2585 şas 
	cGTEST_API_
 
	gMes§ge
 {

2586 
	g´iv©e
:

2589 
¡d
::
	to¡»am
& (*
	tBasicN¬rowIoMª
)(
	t¡d
::ostream&);

2591 
	gpublic
:

2593 
Mes§ge
();

2596 
Mes§ge
(cÚ¡ Mes§ge& 
msg
è: 
ss_
(
Ãw
 ::
¡d
::
¡ršg¡»am
) {

2597 *
ss_
 << 
msg
.
G‘SŒšg
();

2601 
ex¶ic™
 
Mes§ge
(cÚ¡ * 
¡r
è: 
ss_
(
Ãw
 ::
¡d
::
¡ršg¡»am
) {

2602 *
ss_
 << 
¡r
;

2606 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

2607 
šlše
 
	gMes§ge
& 
	gİ”©Ü
 <<(cÚ¡ 
	gT
& 
	gv®
) {

2622 
	gusšg
 ::
İ”©Ü
 <<;

2623 *
	gss_
 << 
	gv®
;

2624  *
	gthis
;

2640 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

2641 
šlše
 
	gMes§ge
& 
	gİ”©Ü
 <<(
T
* cÚ¡& 
	gpoš‹r
) {

2642 ià(
	gpoš‹r
 =ğ
nuÎ±r
) {

2643 *
ss_
 << "(null)";

2645 *
	gss_
 << 
	gpoš‹r
;

2647  *
	gthis
;

2656 
	gMes§ge
& 
	gİ”©Ü
 <<(
BasicN¬rowIoMª
 
	gv®
) {

2657 *
	gss_
 << 
	gv®
;

2658  *
	gthis
;

2662 
	gMes§ge
& 
	gİ”©Ü
 <<(
boŞ
 
	gb
) {

2663  *
	gthis
 << (
	gb
 ? "true" : "false");

2668 
	gMes§ge
& 
	gİ”©Ü
 <<(cÚ¡ 
wch¬_t
* 
	gwide_c_¡r
);

2669 
	gMes§ge
& 
	gİ”©Ü
 <<(
wch¬_t
* 
	gwide_c_¡r
);

2671 #ià
GTEST_HAS_STD_WSTRING


2674 
	gMes§ge
& 
	gİ”©Ü
 <<(cÚ¡ ::
¡d
::
w¡ršg
& 
w¡r
);

2681 
	g¡d
::
¡ršg
 
G‘SŒšg
() const;

2683 
	g´iv©e
:

2685 cÚ¡ 
¡d
::
unique_±r
< ::¡d::
¡ršg¡»am
> 
ss_
;

2689 
	gİ”©Ü
=(cÚ¡ 
Mes§ge
&);

2693 
šlše
 
	g¡d
::
o¡»am
& 
İ”©Ü
 <<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gMes§ge
& 
	gsb
) {

2694  
	gos
 << 
	gsb
.
G‘SŒšg
();

2697 
Çme¥aû
 
	gš‹º®
 {

2703 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

2704 
	g¡d
::
¡ršg
 
SŒ—mabËToSŒšg
(cÚ¡ 
T
& 
¡»amabË
) {

2705  (
Mes§ge
(è<< 
¡»amabË
).
G‘SŒšg
();

2711 
	$GTEST_DISABLE_MSC_WARNINGS_POP_
()

2753 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_GTEST_FILEPATH_H_


2754 
	#GTEST_INCLUDE_GTEST_INTERNAL_GTEST_FILEPATH_H_


	)

2796 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_GTEST_STRING_H_


2797 
	#GTEST_INCLUDE_GTEST_INTERNAL_GTEST_STRING_H_


	)

2799 #ifdeà
__BORLANDC__


2801 
	~<mem.h
>

2804 
	~<¡ršg.h
>

2805 
	~<¡ršg
>

2808 
Çme¥aû
 
‹¡šg
 {

2809 
Çme¥aû
 
š‹º®
 {

2812 şas 
	cGTEST_API_
 
SŒšg
 {

2813 
public
:

2823 cÚ¡ * 
	`ClÚeCSŒšg
(cÚ¡ * 
c_¡r
);

2825 #ià
GTEST_OS_WINDOWS_MOBILE


2838 
LPCWSTR
 
	`AnsiToUtf16
(cÚ¡ * 
c_¡r
);

2848 cÚ¡ * 
	`Utf16ToAnsi
(
LPCWSTR
 
utf16_¡r
);

2857 
boŞ
 
	`CSŒšgEqu®s
(cÚ¡ * 
lhs
, cÚ¡ * 
rhs
);

2863 
¡d
::
¡ršg
 
	`ShowWideCSŒšg
(cÚ¡ 
wch¬_t
* 
wide_c_¡r
);

2871 
boŞ
 
	`WideCSŒšgEqu®s
(cÚ¡ 
wch¬_t
* 
lhs
, cÚ¡ wch¬_t* 
rhs
);

2879 
boŞ
 
	`Ca£In£ns™iveCSŒšgEqu®s
(cÚ¡ * 
lhs
,

2880 cÚ¡ * 
rhs
);

2894 
boŞ
 
	`Ca£In£ns™iveWideCSŒšgEqu®s
(cÚ¡ 
wch¬_t
* 
lhs
,

2895 cÚ¡ 
wch¬_t
* 
rhs
);

2899 
boŞ
 
	`EndsW™hCa£In£ns™ive
(

2900 cÚ¡ 
¡d
::
¡ršg
& 
¡r
, cÚ¡ std::¡ršg& 
suffix
);

2903 
¡d
::
¡ršg
 
	`FÜm©IÁWidth2
(
v®ue
);

2906 
¡d
::
¡ršg
 
	`FÜm©HexIÁ
(
v®ue
);

2909 
¡d
::
¡ršg
 
	`FÜm©HexUIÁ32
(
UIÁ32
 
v®ue
);

2912 
¡d
::
¡ršg
 
	`FÜm©By‹
(
v®ue
);

2914 
´iv©e
:

2915 
	`SŒšg
();

2920 
GTEST_API_
 
¡d
::
¡ršg
 
	`SŒšgSŒ—mToSŒšg
(::¡d::
¡ršg¡»am
* 
¡»am
);

2922 
	}
}

2927 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4251 \

2930 
Çme¥aû
 
	g‹¡šg
 {

2931 
Çme¥aû
 
	gš‹º®
 {

2944 şas 
	cGTEST_API_
 
	gFeP©h
 {

2945 
	gpublic
:

2946 
FeP©h
(è: 
·thÇme_
("") { }

2947 
FeP©h
(cÚ¡ FeP©h& 
rhs
è: 
·thÇme_
(rhs.pathname_) { }

2949 
ex¶ic™
 
FeP©h
(cÚ¡ 
¡d
::
¡ršg
& 
·thÇme
è: 
·thÇme_
(pathname) {

2950 
NÜm®ize
();

2953 
	gFeP©h
& 
	gİ”©Ü
=(cÚ¡ 
FeP©h
& 
rhs
) {

2954 
S‘
(
rhs
);

2955  *
	gthis
;

2958 
S‘
(cÚ¡ 
FeP©h
& 
rhs
) {

2959 
	g·thÇme_
 = 
rhs
.
·thÇme_
;

2962 cÚ¡ 
	g¡d
::
¡ršg
& sŒšg(ècÚ¡ {  
·thÇme_
; }

2963 cÚ¡ * 
c_¡r
(ècÚ¡ {  
	g·thÇme_
.c_str(); }

2966 
FeP©h
 
G‘Cu¼’tDœ
();

2972 
FeP©h
 
MakeFeName
(cÚ¡ FeP©h& 
dœeùÜy
,

2973 cÚ¡ 
FeP©h
& 
ba£_Çme
,

2974 
numb”
,

2975 cÚ¡ * 
ex‹nsiÚ
);

2980 
FeP©h
 
CÚÿtP©hs
(cÚ¡ FeP©h& 
dœeùÜy
,

2981 cÚ¡ 
FeP©h
& 
»Ïtive_·th
);

2991 
FeP©h
 
G’”©eUniqueFeName
(cÚ¡ FeP©h& 
dœeùÜy
,

2992 cÚ¡ 
FeP©h
& 
ba£_Çme
,

2993 cÚ¡ * 
ex‹nsiÚ
);

2996 
boŞ
 
IsEm±y
(ècÚ¡ {  
	g·thÇme_
.
em±y
(); }

3001 
FeP©h
 
RemoveT¿šgP©hS•¬©Ü
() const;

3009 
FeP©h
 
RemoveDœeùÜyName
() const;

3017 
FeP©h
 
RemoveFeName
() const;

3023 
FeP©h
 
RemoveEx‹nsiÚ
(cÚ¡ * 
ex‹nsiÚ
) const;

3029 
boŞ
 
C»©eDœeùÜ›sRecursiv–y
() const;

3035 
boŞ
 
C»©eFŞd”
() const;

3039 
boŞ
 
FeOrDœeùÜyExi¡s
() const;

3043 
boŞ
 
DœeùÜyExi¡s
() const;

3048 
boŞ
 
IsDœeùÜy
() const;

3052 
boŞ
 
IsRoÙDœeùÜy
() const;

3055 
boŞ
 
IsAbsŞu‹P©h
() const;

3057 
	g´iv©e
:

3078 
NÜm®ize
();

3083 cÚ¡ * 
FšdLa¡P©hS•¬©Ü
() const;

3085 
	g¡d
::
¡ršg
 
·thÇme_
;

3091 
	$GTEST_DISABLE_MSC_WARNINGS_POP_
()

3137 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_GTEST_TYPE_UTIL_H_


3138 
	#GTEST_INCLUDE_GTEST_INTERNAL_GTEST_TYPE_UTIL_H_


	)

3143 #ià
GTEST_HAS_CXXABI_H_


3144 
	~<cxxabi.h
>

3145 #–ià
	`defšed
(
__HP_aCC
)

3146 
	~<acxx_demªgË.h
>

3149 
Çme¥aû
 
‹¡šg
 {

3150 
Çme¥aû
 
š‹º®
 {

3156 
šlše
 
¡d
::
¡ršg
 
	`CªÚiÿlizeFÜStdLibV”siÚšg
(¡d::¡ršg 
s
) {

3157 cÚ¡ 
´efix
[] = "std::__";

3158 ià(
s
.
	`com·»
(0, 
	`¡¾’
(
´efix
),…refix) == 0) {

3159 
¡d
::
¡ršg
::
size_ty³
 
’d
 = 
s
.
	`fšd
("::", 
	`¡¾’
(
´efix
));

3160 ià(
’d
 !ğ
s
.
Åos
) {

3162 
s
.
	`”a£
(
	`¡¾’
("¡d"), 
’d
 - strlen("std"));

3165  
s
;

3171 
‹m¶©e
 <
ty³Çme
 
T
>

3172 
¡d
::
¡ršg
 
	`G‘Ty³Name
() {

3173 #ià
GTEST_HAS_RTTI


3175 cÚ¡ * cÚ¡ 
Çme
 = 
	`ty³id
(
T
).
	`Çme
();

3176 #ià
GTEST_HAS_CXXABI_H_
 || 
	`defšed
(
__HP_aCC
)

3177 
¡©us
 = 0;

3180 #ià
GTEST_HAS_CXXABI_H_


3181 
usšg
 
abi
::
__cxa_demªgË
;

3183 * cÚ¡ 
»adabË_Çme
 = 
	`__cxa_demªgË
(
Çme
, 
nuÎ±r
,‚uÎ±r, &
¡©us
);

3184 cÚ¡ 
¡d
::
¡ršg
 
	`Çme_¡r
(
¡©us
 =ğ0 ? 
»adabË_Çme
 : 
Çme
);

3185 
	`ä“
(
»adabË_Çme
);

3186  
	`CªÚiÿlizeFÜStdLibV”siÚšg
(
Çme_¡r
);

3188  
Çme
;

3198 #ià
GTEST_HAS_TYPED_TEST
 || 
GTEST_HAS_TYPED_TEST_P


3204 
	sNÚe
 {};

3214 
	sTy³s0
 {};

3218 
‹m¶©e
 <
ty³Çme
 
T1
>

3219 
	sTy³s1
 {

3220 
T1
 
	tH—d
;

3221 
Ty³s0
 
	tTa
;

3223 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
>

3224 
	sTy³s2
 {

3225 
T1
 
	tH—d
;

3226 
Ty³s1
<
	tT2
> 
	tTa
;

3229 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
>

3230 
	sTy³s3
 {

3231 
T1
 
	tH—d
;

3232 
Ty³s2
<
	tT2
, 
	tT3
> 
	tTa
;

3235 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
>

3236 
	sTy³s4
 {

3237 
T1
 
	tH—d
;

3238 
Ty³s3
<
	tT2
, 
	tT3
, 
	tT4
> 
	tTa
;

3241 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
>

3242 
	sTy³s5
 {

3243 
T1
 
	tH—d
;

3244 
Ty³s4
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
> 
	tTa
;

3247 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3248 
ty³Çme
 
T6
>

3249 
	sTy³s6
 {

3250 
T1
 
	tH—d
;

3251 
Ty³s5
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
> 
	tTa
;

3254 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3255 
ty³Çme
 
T6
,y³Çm
T7
>

3256 
	sTy³s7
 {

3257 
T1
 
	tH—d
;

3258 
Ty³s6
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
> 
	tTa
;

3261 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3262 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
>

3263 
	sTy³s8
 {

3264 
T1
 
	tH—d
;

3265 
Ty³s7
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
> 
	tTa
;

3268 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3269 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
>

3270 
	sTy³s9
 {

3271 
T1
 
	tH—d
;

3272 
Ty³s8
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
> 
	tTa
;

3275 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3276 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
>

3277 
	sTy³s10
 {

3278 
T1
 
	tH—d
;

3279 
Ty³s9
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
> 
	tTa
;

3282 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3283 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3284 
ty³Çme
 
T11
>

3285 
	sTy³s11
 {

3286 
T1
 
	tH—d
;

3287 
Ty³s10
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
> 
	tTa
;

3290 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3291 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3292 
ty³Çme
 
T11
,y³Çm
T12
>

3293 
	sTy³s12
 {

3294 
T1
 
	tH—d
;

3295 
Ty³s11
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
> 
	tTa
;

3298 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3299 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3300 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
>

3301 
	sTy³s13
 {

3302 
T1
 
	tH—d
;

3303 
Ty³s12
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
> 
	tTa
;

3306 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3307 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3308 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
>

3309 
	sTy³s14
 {

3310 
T1
 
	tH—d
;

3311 
Ty³s13
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
> 
	tTa
;

3314 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3315 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3316 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
>

3317 
	sTy³s15
 {

3318 
T1
 
	tH—d
;

3319 
Ty³s14
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

3320 
	tT15
> 
	tTa
;

3323 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3324 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3325 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3326 
ty³Çme
 
T16
>

3327 
	sTy³s16
 {

3328 
T1
 
	tH—d
;

3329 
Ty³s15
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3330 
	tT16
> 
	tTa
;

3333 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3334 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3335 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3336 
ty³Çme
 
T16
,y³Çm
T17
>

3337 
	sTy³s17
 {

3338 
T1
 
	tH—d
;

3339 
Ty³s16
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3340 
	tT16
, 
	tT17
> 
	tTa
;

3343 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3344 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3345 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3346 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
>

3347 
	sTy³s18
 {

3348 
T1
 
	tH—d
;

3349 
Ty³s17
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3350 
	tT16
, 
	tT17
, 
	tT18
> 
	tTa
;

3353 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3354 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3355 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3356 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
>

3357 
	sTy³s19
 {

3358 
T1
 
	tH—d
;

3359 
Ty³s18
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3360 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
> 
	tTa
;

3363 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3364 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3365 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3366 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
>

3367 
	sTy³s20
 {

3368 
T1
 
	tH—d
;

3369 
Ty³s19
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3370 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
> 
	tTa
;

3373 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3374 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3375 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3376 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3377 
ty³Çme
 
T21
>

3378 
	sTy³s21
 {

3379 
T1
 
	tH—d
;

3380 
Ty³s20
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3381 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
> 
	tTa
;

3384 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3385 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3386 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3387 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3388 
ty³Çme
 
T21
,y³Çm
T22
>

3389 
	sTy³s22
 {

3390 
T1
 
	tH—d
;

3391 
Ty³s21
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3392 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
> 
	tTa
;

3395 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3396 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3397 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3398 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3399 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
>

3400 
	sTy³s23
 {

3401 
T1
 
	tH—d
;

3402 
Ty³s22
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3403 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
> 
	tTa
;

3406 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3407 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3408 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3409 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3410 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
>

3411 
	sTy³s24
 {

3412 
T1
 
	tH—d
;

3413 
Ty³s23
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3414 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
> 
	tTa
;

3417 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3418 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3419 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3420 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3421 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
>

3422 
	sTy³s25
 {

3423 
T1
 
	tH—d
;

3424 
Ty³s24
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3425 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
> 
	tTa
;

3428 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3429 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3430 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3431 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3432 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3433 
ty³Çme
 
T26
>

3434 
	sTy³s26
 {

3435 
T1
 
	tH—d
;

3436 
Ty³s25
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3437 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
> 
	tTa
;

3440 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3441 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3442 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3443 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3444 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3445 
ty³Çme
 
T26
,y³Çm
T27
>

3446 
	sTy³s27
 {

3447 
T1
 
	tH—d
;

3448 
Ty³s26
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3449 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
> 
	tTa
;

3452 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3453 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3454 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3455 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3456 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3457 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
>

3458 
	sTy³s28
 {

3459 
T1
 
	tH—d
;

3460 
Ty³s27
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3461 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
> 
	tTa
;

3464 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3465 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3466 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3467 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3468 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3469 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
>

3470 
	sTy³s29
 {

3471 
T1
 
	tH—d
;

3472 
Ty³s28
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3473 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

3474 
	tT29
> 
	tTa
;

3477 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3478 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3479 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3480 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3481 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3482 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
>

3483 
	sTy³s30
 {

3484 
T1
 
	tH—d
;

3485 
Ty³s29
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3486 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3487 
	tT30
> 
	tTa
;

3490 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3491 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3492 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3493 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3494 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3495 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3496 
ty³Çme
 
T31
>

3497 
	sTy³s31
 {

3498 
T1
 
	tH—d
;

3499 
Ty³s30
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3500 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3501 
	tT30
, 
	tT31
> 
	tTa
;

3504 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3505 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3506 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3507 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3508 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3509 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3510 
ty³Çme
 
T31
,y³Çm
T32
>

3511 
	sTy³s32
 {

3512 
T1
 
	tH—d
;

3513 
Ty³s31
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3514 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3515 
	tT30
, 
	tT31
, 
	tT32
> 
	tTa
;

3518 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3519 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3520 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3521 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3522 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3523 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3524 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
>

3525 
	sTy³s33
 {

3526 
T1
 
	tH—d
;

3527 
Ty³s32
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3528 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3529 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
> 
	tTa
;

3532 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3533 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3534 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3535 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3536 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3537 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3538 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
>

3539 
	sTy³s34
 {

3540 
T1
 
	tH—d
;

3541 
Ty³s33
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3542 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3543 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
> 
	tTa
;

3546 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3547 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3548 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3549 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3550 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3551 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3552 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
>

3553 
	sTy³s35
 {

3554 
T1
 
	tH—d
;

3555 
Ty³s34
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3556 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3557 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
> 
	tTa
;

3560 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3561 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3562 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3563 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3564 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3565 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3566 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3567 
ty³Çme
 
T36
>

3568 
	sTy³s36
 {

3569 
T1
 
	tH—d
;

3570 
Ty³s35
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3571 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3572 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
> 
	tTa
;

3575 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3576 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3577 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3578 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3579 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3580 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3581 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3582 
ty³Çme
 
T36
,y³Çm
T37
>

3583 
	sTy³s37
 {

3584 
T1
 
	tH—d
;

3585 
Ty³s36
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3586 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3587 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
> 
	tTa
;

3590 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3591 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3592 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3593 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3594 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3595 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3596 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3597 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
>

3598 
	sTy³s38
 {

3599 
T1
 
	tH—d
;

3600 
Ty³s37
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3601 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3602 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
> 
	tTa
;

3605 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3606 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3607 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3608 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3609 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3610 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3611 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3612 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
>

3613 
	sTy³s39
 {

3614 
T1
 
	tH—d
;

3615 
Ty³s38
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3616 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3617 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
> 
	tTa
;

3620 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3621 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3622 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3623 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3624 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3625 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3626 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3627 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
>

3628 
	sTy³s40
 {

3629 
T1
 
	tH—d
;

3630 
Ty³s39
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3631 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3632 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
> 
	tTa
;

3635 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3636 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3637 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3638 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3639 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3640 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3641 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3642 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3643 
ty³Çme
 
T41
>

3644 
	sTy³s41
 {

3645 
T1
 
	tH—d
;

3646 
Ty³s40
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3647 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3648 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
> 
	tTa
;

3651 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3652 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3653 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3654 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3655 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3656 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3657 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3658 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3659 
ty³Çme
 
T41
,y³Çm
T42
>

3660 
	sTy³s42
 {

3661 
T1
 
	tH—d
;

3662 
Ty³s41
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3663 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3664 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
> 
	tTa
;

3667 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3668 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3669 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3670 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3671 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3672 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3673 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3674 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3675 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
>

3676 
	sTy³s43
 {

3677 
T1
 
	tH—d
;

3678 
Ty³s42
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3679 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3680 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
,

3681 
	tT43
> 
	tTa
;

3684 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3685 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3686 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3687 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3688 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3689 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3690 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3691 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3692 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
>

3693 
	sTy³s44
 {

3694 
T1
 
	tH—d
;

3695 
Ty³s43
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3696 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3697 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
, 
	tT43
,

3698 
	tT44
> 
	tTa
;

3701 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3702 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3703 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3704 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3705 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3706 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3707 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3708 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3709 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
>

3710 
	sTy³s45
 {

3711 
T1
 
	tH—d
;

3712 
Ty³s44
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3713 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3714 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
, 
	tT43
,

3715 
	tT44
, 
	tT45
> 
	tTa
;

3718 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3719 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3720 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3721 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3722 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3723 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3724 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3725 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3726 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

3727 
ty³Çme
 
T46
>

3728 
	sTy³s46
 {

3729 
T1
 
	tH—d
;

3730 
Ty³s45
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3731 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3732 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
, 
	tT43
,

3733 
	tT44
, 
	tT45
, 
	tT46
> 
	tTa
;

3736 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3737 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3738 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3739 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3740 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3741 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3742 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3743 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3744 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

3745 
ty³Çme
 
T46
,y³Çm
T47
>

3746 
	sTy³s47
 {

3747 
T1
 
	tH—d
;

3748 
Ty³s46
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3749 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3750 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
, 
	tT43
,

3751 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
> 
	tTa
;

3754 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3755 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3756 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3757 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3758 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3759 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3760 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3761 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3762 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

3763 
ty³Çme
 
T46
,y³Çm
T47
,y³Çm
T48
>

3764 
	sTy³s48
 {

3765 
T1
 
	tH—d
;

3766 
Ty³s47
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3767 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3768 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
, 
	tT43
,

3769 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
> 
	tTa
;

3772 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3773 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3774 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3775 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3776 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3777 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3778 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3779 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3780 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

3781 
ty³Çme
 
T46
,y³Çm
T47
,y³Çm
T48
,y³Çm
T49
>

3782 
	sTy³s49
 {

3783 
T1
 
	tH—d
;

3784 
Ty³s48
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3785 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3786 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
, 
	tT43
,

3787 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
, 
	tT49
> 
	tTa
;

3790 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3791 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

3792 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

3793 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

3794 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

3795 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

3796 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

3797 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

3798 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

3799 
ty³Çme
 
T46
,y³Çm
T47
,y³Çm
T48
,y³Çm
T49
,y³Çm
T50
>

3800 
	sTy³s50
 {

3801 
T1
 
	tH—d
;

3802 
Ty³s49
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
, 
	tT15
,

3803 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
, 
	tT29
,

3804 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
, 
	tT43
,

3805 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
, 
	tT49
, 
	tT50
> 
	tTa
;

3824 
‹m¶©e
 <
ty³Çme
 
T1
 = 
š‹º®
::
NÚe
,y³Çm
T2
 = internal::None,

3825 
ty³Çme
 
T3
 = 
š‹º®
::
NÚe
,y³Çm
T4
 = internal::None,

3826 
ty³Çme
 
T5
 = 
š‹º®
::
NÚe
,y³Çm
T6
 = internal::None,

3827 
ty³Çme
 
T7
 = 
š‹º®
::
NÚe
,y³Çm
T8
 = internal::None,

3828 
ty³Çme
 
T9
 = 
š‹º®
::
NÚe
,y³Çm
T10
 = internal::None,

3829 
ty³Çme
 
T11
 = 
š‹º®
::
NÚe
,y³Çm
T12
 = internal::None,

3830 
ty³Çme
 
T13
 = 
š‹º®
::
NÚe
,y³Çm
T14
 = internal::None,

3831 
ty³Çme
 
T15
 = 
š‹º®
::
NÚe
,y³Çm
T16
 = internal::None,

3832 
ty³Çme
 
T17
 = 
š‹º®
::
NÚe
,y³Çm
T18
 = internal::None,

3833 
ty³Çme
 
T19
 = 
š‹º®
::
NÚe
,y³Çm
T20
 = internal::None,

3834 
ty³Çme
 
T21
 = 
š‹º®
::
NÚe
,y³Çm
T22
 = internal::None,

3835 
ty³Çme
 
T23
 = 
š‹º®
::
NÚe
,y³Çm
T24
 = internal::None,

3836 
ty³Çme
 
T25
 = 
š‹º®
::
NÚe
,y³Çm
T26
 = internal::None,

3837 
ty³Çme
 
T27
 = 
š‹º®
::
NÚe
,y³Çm
T28
 = internal::None,

3838 
ty³Çme
 
T29
 = 
š‹º®
::
NÚe
,y³Çm
T30
 = internal::None,

3839 
ty³Çme
 
T31
 = 
š‹º®
::
NÚe
,y³Çm
T32
 = internal::None,

3840 
ty³Çme
 
T33
 = 
š‹º®
::
NÚe
,y³Çm
T34
 = internal::None,

3841 
ty³Çme
 
T35
 = 
š‹º®
::
NÚe
,y³Çm
T36
 = internal::None,

3842 
ty³Çme
 
T37
 = 
š‹º®
::
NÚe
,y³Çm
T38
 = internal::None,

3843 
ty³Çme
 
T39
 = 
š‹º®
::
NÚe
,y³Çm
T40
 = internal::None,

3844 
ty³Çme
 
T41
 = 
š‹º®
::
NÚe
,y³Çm
T42
 = internal::None,

3845 
ty³Çme
 
T43
 = 
š‹º®
::
NÚe
,y³Çm
T44
 = internal::None,

3846 
ty³Çme
 
T45
 = 
š‹º®
::
NÚe
,y³Çm
T46
 = internal::None,

3847 
ty³Çme
 
T47
 = 
š‹º®
::
NÚe
,y³Çm
T48
 = internal::None,

3848 
ty³Çme
 
T49
 = 
š‹º®
::
NÚe
,y³Çm
T50
 = internal::None>

3849 
	sTy³s
 {

3850 
š‹º®
::
	tTy³s50
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

3851 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

3852 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

3853 
	tT41
, 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
, 
	tT49
, 
	tT50
> 
	tty³
;

3856 
‹m¶©e
 <>

3857 
Ty³s
<
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3858 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3859 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3860 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3861 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3862 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3863 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3864 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3865 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3866 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3867 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3868 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3869 
š‹º®
::
NÚe
, internal::None> {

3870 
š‹º®
::
	tTy³s0
 
	tty³
;

3872 
‹m¶©e
 <
ty³Çme
 
T1
>

3873 
Ty³s
<
T1
, 
š‹º®
::
NÚe
, internal::None, internal::None,

3874 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3875 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3876 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3877 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3878 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3879 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3880 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3881 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3882 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3883 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3884 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3885 
š‹º®
::
NÚe
, internal::None> {

3886 
š‹º®
::
	tTy³s1
<
	tT1
> 
	tty³
;

3888 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
>

3889 
Ty³s
<
T1
, 
T2
, 
š‹º®
::
NÚe
, internal::None, internal::None,

3890 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3891 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3892 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3893 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3894 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3895 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3896 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3897 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3898 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3899 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3900 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3901 
š‹º®
::
NÚe
> {

3902 
š‹º®
::
	tTy³s2
<
	tT1
, 
	tT2
> 
	tty³
;

3904 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
>

3905 
Ty³s
<
T1
, 
T2
, 
T3
, 
š‹º®
::
NÚe
, internal::None, internal::None,

3906 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3907 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3908 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3909 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3910 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3911 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3912 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3913 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3914 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3915 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3916 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

3917 
š‹º®
::
	tTy³s3
<
	tT1
, 
	tT2
, 
	tT3
> 
	tty³
;

3919 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
>

3920 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
š‹º®
::
NÚe
, internal::None, internal::None,

3921 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3922 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3923 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3924 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3925 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3926 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3927 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3928 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3929 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3930 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3931 
š‹º®
::
NÚe
, internal::None, internal::None> {

3932 
š‹º®
::
	tTy³s4
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
> 
	tty³
;

3934 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
>

3935 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
š‹º®
::
NÚe
, internal::None,

3936 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3937 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3938 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3939 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3940 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3941 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3942 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3943 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3944 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3945 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3946 
š‹º®
::
NÚe
, internal::None, internal::None> {

3947 
š‹º®
::
	tTy³s5
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
> 
	tty³
;

3949 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3950 
ty³Çme
 
T6
>

3951 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
š‹º®
::
NÚe
, internal::None,

3952 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3953 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3954 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3955 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3956 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3957 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3958 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3959 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3960 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3961 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3962 
š‹º®
::
NÚe
, internal::None> {

3963 
š‹º®
::
	tTy³s6
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
> 
	tty³
;

3965 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3966 
ty³Çme
 
T6
,y³Çm
T7
>

3967 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
š‹º®
::
NÚe
, internal::None,

3968 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3969 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3970 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3971 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3972 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3973 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3974 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3975 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3976 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3977 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3978 
š‹º®
::
NÚe
> {

3979 
š‹º®
::
	tTy³s7
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
> 
	tty³
;

3981 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3982 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
>

3983 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
š‹º®
::
NÚe
, internal::None,

3984 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3985 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3986 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3987 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3988 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3989 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3990 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3991 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3992 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

3993 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

3994 
š‹º®
::
	tTy³s8
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
> 
	tty³
;

3996 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

3997 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
>

3998 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
š‹º®
::
NÚe
,

3999 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4000 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4001 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4002 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4003 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4004 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4005 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4006 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4007 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4008 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

4009 
š‹º®
::
	tTy³s9
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
> 
	tty³
;

4011 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4012 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
>

4013 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
š‹º®
::
NÚe
,

4014 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4015 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4016 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4017 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4018 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4019 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4020 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4021 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4022 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4023 
š‹º®
::
NÚe
, internal::None, internal::None> {

4024 
š‹º®
::
	tTy³s10
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
> 
	tty³
;

4026 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4027 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4028 
ty³Çme
 
T11
>

4029 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
š‹º®
::
NÚe
,

4030 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4031 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4032 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4033 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4034 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4035 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4036 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4037 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4038 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4039 
š‹º®
::
NÚe
, internal::None> {

4040 
š‹º®
::
	tTy³s11
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
> 
	tty³
;

4042 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4043 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4044 
ty³Çme
 
T11
,y³Çm
T12
>

4045 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
š‹º®
::
NÚe
,

4046 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4047 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4048 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4049 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4050 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4051 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4052 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4053 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4054 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4055 
š‹º®
::
NÚe
> {

4056 
š‹º®
::
	tTy³s12
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
,

4057 
	tT12
> 
	tty³
;

4059 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4060 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4061 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
>

4062 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
,

4063 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4064 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4065 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4066 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4067 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4068 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4069 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4070 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4071 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4072 
š‹º®
::
NÚe
> {

4073 
š‹º®
::
	tTy³s13
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4074 
	tT13
> 
	tty³
;

4076 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4077 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4078 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
>

4079 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

4080 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4081 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4082 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4083 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4084 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4085 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4086 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4087 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4088 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

4089 
š‹º®
::
	tTy³s14
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4090 
	tT13
, 
	tT14
> 
	tty³
;

4092 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4093 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4094 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
>

4095 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4096 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4097 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4098 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4099 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4100 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4101 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4102 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4103 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4104 
š‹º®
::
NÚe
, internal::None, internal::None> {

4105 
š‹º®
::
	tTy³s15
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4106 
	tT13
, 
	tT14
, 
	tT15
> 
	tty³
;

4108 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4109 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4110 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4111 
ty³Çme
 
T16
>

4112 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4113 
T16
, 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4114 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4115 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4116 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4117 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4118 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4119 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4120 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4121 
š‹º®
::
NÚe
, internal::None> {

4122 
š‹º®
::
	tTy³s16
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4123 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
> 
	tty³
;

4125 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4126 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4127 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4128 
ty³Çme
 
T16
,y³Çm
T17
>

4129 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4130 
T16
, 
T17
, 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4131 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4132 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4133 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4134 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4135 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4136 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4137 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4138 
š‹º®
::
NÚe
> {

4139 
š‹º®
::
	tTy³s17
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4140 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
> 
	tty³
;

4142 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4143 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4144 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4145 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
>

4146 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4147 
T16
, 
T17
, 
T18
, 
š‹º®
::
NÚe
, internal::None, internal::None,

4148 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4149 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4150 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4151 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4152 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4153 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4154 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4155 
š‹º®
::
NÚe
> {

4156 
š‹º®
::
	tTy³s18
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4157 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
> 
	tty³
;

4159 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4160 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4161 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4162 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
>

4163 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4164 
T16
, 
T17
, 
T18
, 
T19
, 
š‹º®
::
NÚe
, internal::None, internal::None,

4165 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4166 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4167 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4168 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4169 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4170 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4171 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

4172 
š‹º®
::
	tTy³s19
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4173 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
> 
	tty³
;

4175 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4176 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4177 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4178 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
>

4179 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4180 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
š‹º®
::
NÚe
, internal::None, internal::None,

4181 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4182 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4183 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4184 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4185 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4186 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4187 
š‹º®
::
NÚe
, internal::None, internal::None> {

4188 
š‹º®
::
	tTy³s20
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4189 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
> 
	tty³
;

4191 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4192 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4193 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4194 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4195 
ty³Çme
 
T21
>

4196 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4197 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
š‹º®
::
NÚe
, internal::None,

4198 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4199 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4200 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4201 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4202 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4203 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4204 
š‹º®
::
NÚe
, internal::None, internal::None> {

4205 
š‹º®
::
	tTy³s21
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4206 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
> 
	tty³
;

4208 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4209 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4210 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4211 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4212 
ty³Çme
 
T21
,y³Çm
T22
>

4213 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4214 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
š‹º®
::
NÚe
, internal::None,

4215 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4216 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4217 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4218 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4219 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4220 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4221 
š‹º®
::
NÚe
, internal::None> {

4222 
š‹º®
::
	tTy³s22
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4223 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
> 
	tty³
;

4225 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4226 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4227 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4228 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4229 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
>

4230 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4231 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
š‹º®
::
NÚe
, internal::None,

4232 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4233 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4234 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4235 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4236 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4237 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4238 
š‹º®
::
NÚe
> {

4239 
š‹º®
::
	tTy³s23
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4240 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
> 
	tty³
;

4242 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4243 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4244 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4245 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4246 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
>

4247 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4248 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
š‹º®
::
NÚe
,

4249 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4250 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4251 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4252 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4253 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4254 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4255 
š‹º®
::
NÚe
> {

4256 
š‹º®
::
	tTy³s24
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4257 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
> 
	tty³
;

4259 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4260 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4261 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4262 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4263 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
>

4264 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4265 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
š‹º®
::
NÚe
,

4266 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4267 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4268 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4269 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4270 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4271 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

4272 
š‹º®
::
	tTy³s25
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4273 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
> 
	tty³
;

4275 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4276 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4277 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4278 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4279 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4280 
ty³Çme
 
T26
>

4281 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4282 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
š‹º®
::
NÚe
,

4283 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4284 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4285 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4286 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4287 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4288 
š‹º®
::
NÚe
, internal::None, internal::None> {

4289 
š‹º®
::
	tTy³s26
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4290 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
,

4291 
	tT26
> 
	tty³
;

4293 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4294 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4295 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4296 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4297 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4298 
ty³Çme
 
T26
,y³Çm
T27
>

4299 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4300 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
š‹º®
::
NÚe
,

4301 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4302 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4303 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4304 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4305 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4306 
š‹º®
::
NÚe
, internal::None> {

4307 
š‹º®
::
	tTy³s27
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4308 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4309 
	tT27
> 
	tty³
;

4311 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4312 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4313 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4314 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4315 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4316 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
>

4317 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4318 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
,

4319 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4320 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4321 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4322 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4323 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4324 
š‹º®
::
NÚe
, internal::None> {

4325 
š‹º®
::
	tTy³s28
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4326 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4327 
	tT27
, 
	tT28
> 
	tty³
;

4329 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4330 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4331 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4332 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4333 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4334 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
>

4335 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4336 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

4337 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4338 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4339 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4340 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4341 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4342 
š‹º®
::
NÚe
> {

4343 
š‹º®
::
	tTy³s29
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4344 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4345 
	tT27
, 
	tT28
, 
	tT29
> 
	tty³
;

4347 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4348 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4349 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4350 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4351 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4352 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
>

4353 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4354 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4355 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4356 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4357 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4358 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4359 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

4360 
š‹º®
::
	tTy³s30
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4361 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4362 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
> 
	tty³
;

4364 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4365 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4366 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4367 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4368 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4369 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4370 
ty³Çme
 
T31
>

4371 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4372 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4373 
T31
, 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4374 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4375 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4376 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4377 
š‹º®
::
NÚe
, internal::None, internal::None> {

4378 
š‹º®
::
	tTy³s31
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4379 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4380 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
> 
	tty³
;

4382 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4383 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4384 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4385 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4386 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4387 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4388 
ty³Çme
 
T31
,y³Çm
T32
>

4389 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4390 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4391 
T31
, 
T32
, 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4392 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4393 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4394 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4395 
š‹º®
::
NÚe
, internal::None> {

4396 
š‹º®
::
	tTy³s32
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4397 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4398 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
> 
	tty³
;

4400 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4401 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4402 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4403 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4404 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4405 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4406 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
>

4407 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4408 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4409 
T31
, 
T32
, 
T33
, 
š‹º®
::
NÚe
, internal::None, internal::None,

4410 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4411 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4412 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4413 
š‹º®
::
NÚe
, internal::None> {

4414 
š‹º®
::
	tTy³s33
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4415 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4416 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
> 
	tty³
;

4418 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4419 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4420 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4421 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4422 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4423 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4424 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
>

4425 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4426 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4427 
T31
, 
T32
, 
T33
, 
T34
, 
š‹º®
::
NÚe
, internal::None, internal::None,

4428 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4429 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4430 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4431 
š‹º®
::
NÚe
> {

4432 
š‹º®
::
	tTy³s34
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4433 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4434 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
> 
	tty³
;

4436 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4437 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4438 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4439 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4440 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4441 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4442 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
>

4443 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4444 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4445 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
š‹º®
::
NÚe
, internal::None, internal::None,

4446 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4447 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4448 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

4449 
š‹º®
::
	tTy³s35
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4450 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4451 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
> 
	tty³
;

4453 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4454 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4455 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4456 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4457 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4458 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4459 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4460 
ty³Çme
 
T36
>

4461 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4462 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4463 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
š‹º®
::
NÚe
, internal::None,

4464 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4465 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4466 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

4467 
š‹º®
::
	tTy³s36
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4468 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4469 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
> 
	tty³
;

4471 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4472 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4473 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4474 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4475 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4476 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4477 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4478 
ty³Çme
 
T36
,y³Çm
T37
>

4479 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4480 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4481 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
š‹º®
::
NÚe
, internal::None,

4482 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4483 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4484 
š‹º®
::
NÚe
, internal::None, internal::None> {

4485 
š‹º®
::
	tTy³s37
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4486 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4487 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
> 
	tty³
;

4489 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4490 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4491 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4492 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4493 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4494 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4495 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4496 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
>

4497 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4498 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4499 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
š‹º®
::
NÚe
, internal::None,

4500 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4501 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4502 
š‹º®
::
NÚe
, internal::None> {

4503 
š‹º®
::
	tTy³s38
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4504 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4505 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
> 
	tty³
;

4507 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4508 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4509 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4510 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4511 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4512 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4513 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4514 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
>

4515 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4516 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4517 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
š‹º®
::
NÚe
,

4518 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4519 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4520 
š‹º®
::
NÚe
, internal::None> {

4521 
š‹º®
::
	tTy³s39
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4522 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4523 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
> 
	tty³
;

4525 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4526 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4527 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4528 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4529 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4530 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4531 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4532 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
>

4533 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4534 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4535 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
š‹º®
::
NÚe
,

4536 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4537 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4538 
š‹º®
::
NÚe
> {

4539 
š‹º®
::
	tTy³s40
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4540 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4541 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
,

4542 
	tT40
> 
	tty³
;

4544 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4545 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4546 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4547 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4548 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4549 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4550 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4551 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

4552 
ty³Çme
 
T41
>

4553 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4554 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4555 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
š‹º®
::
NÚe
,

4556 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4557 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

4558 
š‹º®
::
	tTy³s41
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4559 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4560 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

4561 
	tT41
> 
	tty³
;

4563 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4564 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4565 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4566 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4567 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4568 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4569 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4570 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

4571 
ty³Çme
 
T41
,y³Çm
T42
>

4572 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4573 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4574 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
š‹º®
::
NÚe
,

4575 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4576 
š‹º®
::
NÚe
, internal::None, internal::None> {

4577 
š‹º®
::
	tTy³s42
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4578 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4579 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

4580 
	tT41
, 
	tT42
> 
	tty³
;

4582 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4583 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4584 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4585 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4586 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4587 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4588 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4589 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

4590 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
>

4591 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4592 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4593 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
,

4594 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4595 
š‹º®
::
NÚe
, internal::None, internal::None> {

4596 
š‹º®
::
	tTy³s43
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4597 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4598 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

4599 
	tT41
, 
	tT42
, 
	tT43
> 
	tty³
;

4601 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4602 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4603 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4604 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4605 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4606 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4607 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4608 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

4609 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
>

4610 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4611 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4612 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
,

4613 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4614 
š‹º®
::
NÚe
, internal::None> {

4615 
š‹º®
::
	tTy³s44
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4616 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4617 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

4618 
	tT41
, 
	tT42
, 
	tT43
, 
	tT44
> 
	tty³
;

4620 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4621 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4622 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4623 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4624 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4625 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4626 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4627 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

4628 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
>

4629 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4630 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4631 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
, 
T45
,

4632 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None,

4633 
š‹º®
::
NÚe
> {

4634 
š‹º®
::
	tTy³s45
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4635 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4636 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

4637 
	tT41
, 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
> 
	tty³
;

4639 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4640 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4641 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4642 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4643 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4644 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4645 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4646 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

4647 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

4648 
ty³Çme
 
T46
>

4649 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4650 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4651 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
, 
T45
,

4652 
T46
, 
š‹º®
::
NÚe
, internal::None, internal::None, internal::None> {

4653 
š‹º®
::
	tTy³s46
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4654 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4655 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

4656 
	tT41
, 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
> 
	tty³
;

4658 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4659 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4660 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4661 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4662 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4663 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4664 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4665 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

4666 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

4667 
ty³Çme
 
T46
,y³Çm
T47
>

4668 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4669 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4670 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
, 
T45
,

4671 
T46
, 
T47
, 
š‹º®
::
NÚe
, internal::None, internal::None> {

4672 
š‹º®
::
	tTy³s47
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4673 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4674 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

4675 
	tT41
, 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
> 
	tty³
;

4677 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4678 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4679 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4680 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4681 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4682 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4683 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4684 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

4685 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

4686 
ty³Çme
 
T46
,y³Çm
T47
,y³Çm
T48
>

4687 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4688 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4689 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
, 
T45
,

4690 
T46
, 
T47
, 
T48
, 
š‹º®
::
NÚe
, internal::None> {

4691 
š‹º®
::
	tTy³s48
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4692 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4693 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

4694 
	tT41
, 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
> 
	tty³
;

4696 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

4697 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

4698 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

4699 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

4700 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

4701 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

4702 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

4703 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

4704 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

4705 
ty³Çme
 
T46
,y³Çm
T47
,y³Çm
T48
,y³Çm
T49
>

4706 
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
, 
T15
,

4707 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
, 
T30
,

4708 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
, 
T45
,

4709 
T46
, 
T47
, 
T48
, 
T49
, 
š‹º®
::
NÚe
> {

4710 
š‹º®
::
	tTy³s49
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

4711 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

4712 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

4713 
	tT41
, 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
, 
	tT49
> 
	tty³
;

4716 
Çme¥aû
 
š‹º®
 {

4718 
	#GTEST_TEMPLATE_
 
‹m¶©e
 <
ty³Çme
 
T
> 
şass


	)

4728 
‹m¶©e
 <
GTEST_TEMPLATE_
 
Tm¶
>

4729 
	sTem¶©eS–
 {

4730 
‹m¶©e
 <
ty³Çme
 
T
>

4731 
	sBšd
 {

4732 
Tm¶
<
	tT
> 
	tty³
;

4736 
	#GTEST_BIND_
(
Tm¶S–
, 
T
) \

4737 
Tm¶S–
::
‹m¶©e
 
Bšd
<
T
>::
ty³


	)

4743 
‹m¶©e
 <
ty³Çme
 
T
>

4744 
	sNÚeT
 {};

4754 
	sTem¶©es0
 {};

4758 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
>

4759 
	sTem¶©es1
 {

4760 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4761 
Tem¶©es0
 
	tTa
;

4763 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
>

4764 
	sTem¶©es2
 {

4765 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4766 
Tem¶©es1
<
	tT2
> 
	tTa
;

4769 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
>

4770 
	sTem¶©es3
 {

4771 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4772 
Tem¶©es2
<
	tT2
, 
	tT3
> 
	tTa
;

4775 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4776 
GTEST_TEMPLATE_
 
T4
>

4777 
	sTem¶©es4
 {

4778 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4779 
Tem¶©es3
<
	tT2
, 
	tT3
, 
	tT4
> 
	tTa
;

4782 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4783 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
>

4784 
	sTem¶©es5
 {

4785 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4786 
Tem¶©es4
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
> 
	tTa
;

4789 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4790 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
>

4791 
	sTem¶©es6
 {

4792 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4793 
Tem¶©es5
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
> 
	tTa
;

4796 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4797 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4798 
GTEST_TEMPLATE_
 
T7
>

4799 
	sTem¶©es7
 {

4800 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4801 
Tem¶©es6
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
> 
	tTa
;

4804 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4805 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4806 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
>

4807 
	sTem¶©es8
 {

4808 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4809 
Tem¶©es7
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
> 
	tTa
;

4812 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4813 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4814 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
>

4815 
	sTem¶©es9
 {

4816 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4817 
Tem¶©es8
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
> 
	tTa
;

4820 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4821 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4822 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4823 
GTEST_TEMPLATE_
 
T10
>

4824 
	sTem¶©es10
 {

4825 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4826 
Tem¶©es9
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
> 
	tTa
;

4829 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4830 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4831 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4832 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
>

4833 
	sTem¶©es11
 {

4834 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4835 
Tem¶©es10
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
> 
	tTa
;

4838 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4839 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4840 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4841 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
>

4842 
	sTem¶©es12
 {

4843 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4844 
Tem¶©es11
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
> 
	tTa
;

4847 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4848 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4849 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4850 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4851 
GTEST_TEMPLATE_
 
T13
>

4852 
	sTem¶©es13
 {

4853 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4854 
Tem¶©es12
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
> 
	tTa
;

4857 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4858 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4859 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4860 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4861 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
>

4862 
	sTem¶©es14
 {

4863 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4864 
Tem¶©es13
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

4865 
	tT14
> 
	tTa
;

4868 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4869 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4870 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4871 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4872 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
>

4873 
	sTem¶©es15
 {

4874 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4875 
Tem¶©es14
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4876 
	tT15
> 
	tTa
;

4879 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4880 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4881 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4882 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4883 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

4884 
GTEST_TEMPLATE_
 
T16
>

4885 
	sTem¶©es16
 {

4886 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4887 
Tem¶©es15
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4888 
	tT15
, 
	tT16
> 
	tTa
;

4891 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4892 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4893 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4894 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4895 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

4896 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
>

4897 
	sTem¶©es17
 {

4898 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4899 
Tem¶©es16
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4900 
	tT15
, 
	tT16
, 
	tT17
> 
	tTa
;

4903 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4904 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4905 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4906 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4907 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

4908 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
>

4909 
	sTem¶©es18
 {

4910 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4911 
Tem¶©es17
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4912 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
> 
	tTa
;

4915 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4916 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4917 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4918 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4919 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

4920 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

4921 
GTEST_TEMPLATE_
 
T19
>

4922 
	sTem¶©es19
 {

4923 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4924 
Tem¶©es18
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4925 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
> 
	tTa
;

4928 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4929 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4930 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4931 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4932 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

4933 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

4934 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
>

4935 
	sTem¶©es20
 {

4936 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4937 
Tem¶©es19
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4938 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
> 
	tTa
;

4941 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4942 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4943 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4944 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4945 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

4946 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

4947 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
>

4948 
	sTem¶©es21
 {

4949 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4950 
Tem¶©es20
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4951 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
> 
	tTa
;

4954 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4955 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4956 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4957 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4958 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

4959 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

4960 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

4961 
GTEST_TEMPLATE_
 
T22
>

4962 
	sTem¶©es22
 {

4963 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4964 
Tem¶©es21
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4965 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
> 
	tTa
;

4968 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4969 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4970 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4971 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4972 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

4973 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

4974 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

4975 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
>

4976 
	sTem¶©es23
 {

4977 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4978 
Tem¶©es22
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4979 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
> 
	tTa
;

4982 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4983 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4984 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4985 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

4986 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

4987 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

4988 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

4989 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
>

4990 
	sTem¶©es24
 {

4991 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

4992 
Tem¶©es23
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

4993 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
> 
	tTa
;

4996 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

4997 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

4998 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

4999 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5000 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5001 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5002 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5003 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5004 
GTEST_TEMPLATE_
 
T25
>

5005 
	sTem¶©es25
 {

5006 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5007 
Tem¶©es24
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5008 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
> 
	tTa
;

5011 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5012 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5013 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5014 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5015 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5016 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5017 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5018 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5019 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
>

5020 
	sTem¶©es26
 {

5021 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5022 
Tem¶©es25
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5023 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
> 
	tTa
;

5026 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5027 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5028 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5029 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5030 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5031 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5032 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5033 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5034 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
>

5035 
	sTem¶©es27
 {

5036 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5037 
Tem¶©es26
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5038 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
> 
	tTa
;

5041 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5042 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5043 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5044 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5045 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5046 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5047 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5048 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5049 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5050 
GTEST_TEMPLATE_
 
T28
>

5051 
	sTem¶©es28
 {

5052 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5053 
Tem¶©es27
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5054 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

5055 
	tT28
> 
	tTa
;

5058 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5059 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5060 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5061 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5062 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5063 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5064 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5065 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5066 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5067 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
>

5068 
	sTem¶©es29
 {

5069 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5070 
Tem¶©es28
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5071 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5072 
	tT29
> 
	tTa
;

5075 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5076 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5077 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5078 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5079 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5080 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5081 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5082 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5083 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5084 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
>

5085 
	sTem¶©es30
 {

5086 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5087 
Tem¶©es29
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5088 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5089 
	tT29
, 
	tT30
> 
	tTa
;

5092 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5093 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5094 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5095 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5096 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5097 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5098 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5099 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5100 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5101 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5102 
GTEST_TEMPLATE_
 
T31
>

5103 
	sTem¶©es31
 {

5104 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5105 
Tem¶©es30
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5106 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5107 
	tT29
, 
	tT30
, 
	tT31
> 
	tTa
;

5110 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5111 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5112 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5113 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5114 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5115 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5116 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5117 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5118 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5119 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5120 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
>

5121 
	sTem¶©es32
 {

5122 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5123 
Tem¶©es31
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5124 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5125 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
> 
	tTa
;

5128 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5129 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5130 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5131 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5132 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5133 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5134 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5135 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5136 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5137 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5138 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
>

5139 
	sTem¶©es33
 {

5140 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5141 
Tem¶©es32
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5142 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5143 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
> 
	tTa
;

5146 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5147 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5148 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5149 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5150 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5151 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5152 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5153 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5154 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5155 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5156 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5157 
GTEST_TEMPLATE_
 
T34
>

5158 
	sTem¶©es34
 {

5159 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5160 
Tem¶©es33
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5161 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5162 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
> 
	tTa
;

5165 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5166 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5167 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5168 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5169 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5170 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5171 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5172 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5173 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5174 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5175 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5176 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
>

5177 
	sTem¶©es35
 {

5178 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5179 
Tem¶©es34
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5180 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5181 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
> 
	tTa
;

5184 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5185 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5186 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5187 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5188 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5189 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5190 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5191 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5192 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5193 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5194 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5195 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
>

5196 
	sTem¶©es36
 {

5197 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5198 
Tem¶©es35
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5199 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5200 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
> 
	tTa
;

5203 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5204 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5205 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5206 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5207 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5208 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5209 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5210 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5211 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5212 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5213 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5214 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5215 
GTEST_TEMPLATE_
 
T37
>

5216 
	sTem¶©es37
 {

5217 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5218 
Tem¶©es36
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5219 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5220 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
> 
	tTa
;

5223 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5224 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5225 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5226 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5227 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5228 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5229 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5230 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5231 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5232 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5233 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5234 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5235 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
>

5236 
	sTem¶©es38
 {

5237 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5238 
Tem¶©es37
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5239 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5240 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
> 
	tTa
;

5243 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5244 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5245 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5246 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5247 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5248 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5249 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5250 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5251 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5252 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5253 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5254 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5255 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
>

5256 
	sTem¶©es39
 {

5257 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5258 
Tem¶©es38
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5259 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5260 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
> 
	tTa
;

5263 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5264 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5265 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5266 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5267 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5268 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5269 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5270 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5271 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5272 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5273 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5274 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5275 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5276 
GTEST_TEMPLATE_
 
T40
>

5277 
	sTem¶©es40
 {

5278 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5279 
Tem¶©es39
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5280 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5281 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
> 
	tTa
;

5284 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5285 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5286 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5287 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5288 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5289 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5290 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5291 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5292 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5293 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5294 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5295 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5296 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5297 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
>

5298 
	sTem¶©es41
 {

5299 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5300 
Tem¶©es40
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5301 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5302 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
> 
	tTa
;

5305 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5306 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5307 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5308 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5309 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5310 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5311 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5312 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5313 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5314 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5315 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5316 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5317 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5318 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
>

5319 
	sTem¶©es42
 {

5320 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5321 
Tem¶©es41
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5322 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5323 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

5324 
	tT42
> 
	tTa
;

5327 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5328 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5329 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5330 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5331 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5332 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5333 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5334 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5335 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5336 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5337 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5338 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5339 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5340 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

5341 
GTEST_TEMPLATE_
 
T43
>

5342 
	sTem¶©es43
 {

5343 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5344 
Tem¶©es42
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5345 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5346 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
,

5347 
	tT43
> 
	tTa
;

5350 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5351 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5352 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5353 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5354 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5355 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5356 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5357 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5358 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5359 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5360 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5361 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5362 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5363 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

5364 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
>

5365 
	sTem¶©es44
 {

5366 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5367 
Tem¶©es43
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5368 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5369 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
,

5370 
	tT43
, 
	tT44
> 
	tTa
;

5373 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5374 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5375 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5376 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5377 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5378 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5379 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5380 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5381 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5382 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5383 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5384 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5385 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5386 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

5387 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
>

5388 
	sTem¶©es45
 {

5389 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5390 
Tem¶©es44
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5391 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5392 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
,

5393 
	tT43
, 
	tT44
, 
	tT45
> 
	tTa
;

5396 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5397 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5398 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5399 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5400 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5401 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5402 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5403 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5404 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5405 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5406 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5407 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5408 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5409 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

5410 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
,

5411 
GTEST_TEMPLATE_
 
T46
>

5412 
	sTem¶©es46
 {

5413 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5414 
Tem¶©es45
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5415 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5416 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
,

5417 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
> 
	tTa
;

5420 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5421 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5422 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5423 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5424 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5425 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5426 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5427 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5428 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5429 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5430 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5431 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5432 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5433 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

5434 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
,

5435 
GTEST_TEMPLATE_
 
T46
, GTEST_TEMPLATE_ 
T47
>

5436 
	sTem¶©es47
 {

5437 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5438 
Tem¶©es46
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5439 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5440 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
,

5441 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
> 
	tTa
;

5444 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5445 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5446 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5447 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5448 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5449 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5450 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5451 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5452 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5453 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5454 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5455 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5456 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5457 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

5458 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
,

5459 
GTEST_TEMPLATE_
 
T46
, GTEST_TEMPLATE_ 
T47
, GTEST_TEMPLATE_ 
T48
>

5460 
	sTem¶©es48
 {

5461 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5462 
Tem¶©es47
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5463 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5464 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
,

5465 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
> 
	tTa
;

5468 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5469 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5470 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5471 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5472 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5473 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5474 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5475 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5476 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5477 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5478 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5479 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5480 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5481 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

5482 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
,

5483 
GTEST_TEMPLATE_
 
T46
, GTEST_TEMPLATE_ 
T47
, GTEST_TEMPLATE_ 
T48
,

5484 
GTEST_TEMPLATE_
 
T49
>

5485 
	sTem¶©es49
 {

5486 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5487 
Tem¶©es48
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5488 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5489 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
,

5490 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
, 
	tT49
> 
	tTa
;

5493 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5494 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5495 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5496 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5497 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5498 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5499 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5500 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5501 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5502 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5503 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

5504 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

5505 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

5506 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

5507 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
,

5508 
GTEST_TEMPLATE_
 
T46
, GTEST_TEMPLATE_ 
T47
, GTEST_TEMPLATE_ 
T48
,

5509 
GTEST_TEMPLATE_
 
T49
, GTEST_TEMPLATE_ 
T50
>

5510 
	sTem¶©es50
 {

5511 
Tem¶©eS–
<
	tT1
> 
	tH—d
;

5512 
Tem¶©es49
<
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
, 
	tT14
,

5513 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
, 
	tT28
,

5514 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
, 
	tT42
,

5515 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
, 
	tT49
, 
	tT50
> 
	tTa
;

5532 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
 = 
NÚeT
, GTEST_TEMPLATE_ 
T2
 = NoneT,

5533 
GTEST_TEMPLATE_
 
T3
 = 
NÚeT
, GTEST_TEMPLATE_ 
T4
 = NoneT,

5534 
GTEST_TEMPLATE_
 
T5
 = 
NÚeT
, GTEST_TEMPLATE_ 
T6
 = NoneT,

5535 
GTEST_TEMPLATE_
 
T7
 = 
NÚeT
, GTEST_TEMPLATE_ 
T8
 = NoneT,

5536 
GTEST_TEMPLATE_
 
T9
 = 
NÚeT
, GTEST_TEMPLATE_ 
T10
 = NoneT,

5537 
GTEST_TEMPLATE_
 
T11
 = 
NÚeT
, GTEST_TEMPLATE_ 
T12
 = NoneT,

5538 
GTEST_TEMPLATE_
 
T13
 = 
NÚeT
, GTEST_TEMPLATE_ 
T14
 = NoneT,

5539 
GTEST_TEMPLATE_
 
T15
 = 
NÚeT
, GTEST_TEMPLATE_ 
T16
 = NoneT,

5540 
GTEST_TEMPLATE_
 
T17
 = 
NÚeT
, GTEST_TEMPLATE_ 
T18
 = NoneT,

5541 
GTEST_TEMPLATE_
 
T19
 = 
NÚeT
, GTEST_TEMPLATE_ 
T20
 = NoneT,

5542 
GTEST_TEMPLATE_
 
T21
 = 
NÚeT
, GTEST_TEMPLATE_ 
T22
 = NoneT,

5543 
GTEST_TEMPLATE_
 
T23
 = 
NÚeT
, GTEST_TEMPLATE_ 
T24
 = NoneT,

5544 
GTEST_TEMPLATE_
 
T25
 = 
NÚeT
, GTEST_TEMPLATE_ 
T26
 = NoneT,

5545 
GTEST_TEMPLATE_
 
T27
 = 
NÚeT
, GTEST_TEMPLATE_ 
T28
 = NoneT,

5546 
GTEST_TEMPLATE_
 
T29
 = 
NÚeT
, GTEST_TEMPLATE_ 
T30
 = NoneT,

5547 
GTEST_TEMPLATE_
 
T31
 = 
NÚeT
, GTEST_TEMPLATE_ 
T32
 = NoneT,

5548 
GTEST_TEMPLATE_
 
T33
 = 
NÚeT
, GTEST_TEMPLATE_ 
T34
 = NoneT,

5549 
GTEST_TEMPLATE_
 
T35
 = 
NÚeT
, GTEST_TEMPLATE_ 
T36
 = NoneT,

5550 
GTEST_TEMPLATE_
 
T37
 = 
NÚeT
, GTEST_TEMPLATE_ 
T38
 = NoneT,

5551 
GTEST_TEMPLATE_
 
T39
 = 
NÚeT
, GTEST_TEMPLATE_ 
T40
 = NoneT,

5552 
GTEST_TEMPLATE_
 
T41
 = 
NÚeT
, GTEST_TEMPLATE_ 
T42
 = NoneT,

5553 
GTEST_TEMPLATE_
 
T43
 = 
NÚeT
, GTEST_TEMPLATE_ 
T44
 = NoneT,

5554 
GTEST_TEMPLATE_
 
T45
 = 
NÚeT
, GTEST_TEMPLATE_ 
T46
 = NoneT,

5555 
GTEST_TEMPLATE_
 
T47
 = 
NÚeT
, GTEST_TEMPLATE_ 
T48
 = NoneT,

5556 
GTEST_TEMPLATE_
 
T49
 = 
NÚeT
, GTEST_TEMPLATE_ 
T50
 = NoneT>

5557 
	sTem¶©es
 {

5558 
Tem¶©es50
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5559 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

5560 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

5561 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
, 
	tT49
, 
	tT50
> 
	tty³
;

5564 
‹m¶©e
 <>

5565 
Tem¶©es
<
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5566 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5567 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5568 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5569 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5570 
NÚeT
> {

5571 
Tem¶©es0
 
	tty³
;

5573 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
>

5574 
Tem¶©es
<
T1
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5575 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5576 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5577 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5578 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5579 
NÚeT
> {

5580 
Tem¶©es1
<
	tT1
> 
	tty³
;

5582 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
>

5583 
Tem¶©es
<
T1
, 
T2
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5584 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5585 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5586 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5587 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5588 
NÚeT
> {

5589 
Tem¶©es2
<
	tT1
, 
	tT2
> 
	tty³
;

5591 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
>

5592 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5593 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5594 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5595 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5596 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5597 
Tem¶©es3
<
	tT1
, 
	tT2
, 
	tT3
> 
	tty³
;

5599 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5600 
GTEST_TEMPLATE_
 
T4
>

5601 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT,

5602 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5603 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5604 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5605 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5606 
Tem¶©es4
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
> 
	tty³
;

5608 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5609 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
>

5610 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT,

5611 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5612 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5613 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5614 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5615 
Tem¶©es5
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
> 
	tty³
;

5617 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5618 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
>

5619 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT,

5620 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5621 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5622 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5623 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5624 
Tem¶©es6
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
> 
	tty³
;

5626 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5627 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5628 
GTEST_TEMPLATE_
 
T7
>

5629 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT,

5630 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5631 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5632 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5633 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5634 
Tem¶©es7
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
> 
	tty³
;

5636 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5637 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5638 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
>

5639 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
NÚeT
, NoneT, NoneT, NoneT,

5640 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5641 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5642 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5643 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5644 
Tem¶©es8
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
> 
	tty³
;

5646 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5647 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5648 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
>

5649 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
NÚeT
, NoneT, NoneT,

5650 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5651 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5652 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5653 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5654 
Tem¶©es9
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
> 
	tty³
;

5656 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5657 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5658 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5659 
GTEST_TEMPLATE_
 
T10
>

5660 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
NÚeT
, NoneT, NoneT,

5661 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5662 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5663 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5664 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5665 
Tem¶©es10
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
> 
	tty³
;

5667 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5668 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5669 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5670 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
>

5671 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
NÚeT
, NoneT,

5672 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5673 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5674 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5675 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5676 
Tem¶©es11
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
> 
	tty³
;

5678 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5679 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5680 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5681 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
>

5682 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
NÚeT
,

5683 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5684 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5685 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5686 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5687 
Tem¶©es12
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
> 
	tty³
;

5689 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5690 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5691 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5692 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5693 
GTEST_TEMPLATE_
 
T13
>

5694 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
NÚeT
,

5695 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5696 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5697 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5698 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT> {

5699 
Tem¶©es13
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

5700 
	tT13
> 
	tty³
;

5702 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5703 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5704 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5705 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5706 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
>

5707 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5708 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5709 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5710 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5711 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT> {

5712 
Tem¶©es14
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5713 
	tT14
> 
	tty³
;

5715 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5716 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5717 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5718 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5719 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
>

5720 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5721 
T15
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5722 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5723 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5724 
NÚeT
, NoneT, NoneT, NoneT, NoneT> {

5725 
Tem¶©es15
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5726 
	tT14
, 
	tT15
> 
	tty³
;

5728 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5729 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5730 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5731 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5732 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5733 
GTEST_TEMPLATE_
 
T16
>

5734 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5735 
T15
, 
T16
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5736 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5737 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5738 
NÚeT
, NoneT, NoneT, NoneT, NoneT> {

5739 
Tem¶©es16
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5740 
	tT14
, 
	tT15
, 
	tT16
> 
	tty³
;

5742 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5743 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5744 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5745 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5746 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5747 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
>

5748 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5749 
T15
, 
T16
, 
T17
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5750 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5751 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5752 
NÚeT
, NoneT, NoneT, NoneT, NoneT> {

5753 
Tem¶©es17
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5754 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
> 
	tty³
;

5756 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5757 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5758 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5759 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5760 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5761 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
>

5762 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5763 
T15
, 
T16
, 
T17
, 
T18
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5764 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5765 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5766 
NÚeT
, NoneT, NoneT, NoneT> {

5767 
Tem¶©es18
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5768 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
> 
	tty³
;

5770 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5771 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5772 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5773 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5774 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5775 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5776 
GTEST_TEMPLATE_
 
T19
>

5777 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5778 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5779 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5780 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5781 
NÚeT
, NoneT, NoneT, NoneT> {

5782 
Tem¶©es19
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5783 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
> 
	tty³
;

5785 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5786 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5787 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5788 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5789 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5790 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5791 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
>

5792 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5793 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT,

5794 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5795 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5796 
NÚeT
, NoneT, NoneT, NoneT> {

5797 
Tem¶©es20
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5798 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
> 
	tty³
;

5800 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5801 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5802 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5803 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5804 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5805 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5806 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
>

5807 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5808 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT,

5809 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5810 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5811 
NÚeT
, NoneT, NoneT, NoneT> {

5812 
Tem¶©es21
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5813 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
> 
	tty³
;

5815 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5816 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5817 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5818 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5819 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5820 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5821 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5822 
GTEST_TEMPLATE_
 
T22
>

5823 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5824 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT,

5825 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5826 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5827 
NÚeT
, NoneT, NoneT> {

5828 
Tem¶©es22
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5829 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
> 
	tty³
;

5831 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5832 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5833 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5834 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5835 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5836 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5837 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5838 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
>

5839 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5840 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
NÚeT
, NoneT, NoneT, NoneT,

5841 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5842 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5843 
NÚeT
, NoneT, NoneT> {

5844 
Tem¶©es23
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5845 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
> 
	tty³
;

5847 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5848 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5849 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5850 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5851 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5852 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5853 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5854 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
>

5855 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5856 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
NÚeT
, NoneT, NoneT,

5857 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5858 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5859 
NÚeT
, NoneT, NoneT> {

5860 
Tem¶©es24
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5861 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
> 
	tty³
;

5863 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5864 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5865 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5866 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5867 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5868 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5869 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5870 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5871 
GTEST_TEMPLATE_
 
T25
>

5872 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5873 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
NÚeT
, NoneT, NoneT,

5874 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5875 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5876 
NÚeT
, NoneT> {

5877 
Tem¶©es25
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5878 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
> 
	tty³
;

5880 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5881 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5882 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5883 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5884 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5885 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5886 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5887 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5888 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
>

5889 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5890 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
NÚeT
, NoneT,

5891 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5892 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5893 
NÚeT
, NoneT> {

5894 
Tem¶©es26
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5895 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
> 
	tty³
;

5897 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5898 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5899 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5900 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5901 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5902 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5903 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5904 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5905 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
>

5906 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5907 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
NÚeT
,

5908 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5909 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5910 
NÚeT
, NoneT> {

5911 
Tem¶©es27
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5912 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

5913 
	tT27
> 
	tty³
;

5915 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5916 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5917 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5918 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5919 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5920 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5921 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5922 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5923 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5924 
GTEST_TEMPLATE_
 
T28
>

5925 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5926 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
,

5927 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5928 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5929 
NÚeT
, NoneT> {

5930 
Tem¶©es28
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5931 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

5932 
	tT28
> 
	tty³
;

5934 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5935 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5936 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5937 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5938 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5939 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5940 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5941 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5942 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5943 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
>

5944 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5945 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

5946 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5947 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5948 
NÚeT
> {

5949 
Tem¶©es29
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5950 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

5951 
	tT28
, 
	tT29
> 
	tty³
;

5953 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5954 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5955 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5956 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5957 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5958 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5959 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5960 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5961 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5962 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
>

5963 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5964 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

5965 
T30
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5966 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5967 
Tem¶©es30
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5968 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

5969 
	tT28
, 
	tT29
, 
	tT30
> 
	tty³
;

5971 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5972 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5973 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5974 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5975 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5976 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5977 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5978 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5979 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5980 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

5981 
GTEST_TEMPLATE_
 
T31
>

5982 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

5983 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

5984 
T30
, 
T31
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

5985 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

5986 
Tem¶©es31
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

5987 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

5988 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
> 
	tty³
;

5990 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

5991 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

5992 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

5993 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

5994 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

5995 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

5996 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

5997 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

5998 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

5999 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6000 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
>

6001 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6002 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6003 
T30
, 
T31
, 
T32
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

6004 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6005 
Tem¶©es32
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6006 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6007 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
> 
	tty³
;

6009 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6010 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6011 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6012 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6013 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6014 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6015 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6016 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6017 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6018 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6019 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
>

6020 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6021 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6022 
T30
, 
T31
, 
T32
, 
T33
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

6023 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6024 
Tem¶©es33
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6025 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6026 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
> 
	tty³
;

6028 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6029 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6030 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6031 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6032 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6033 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6034 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6035 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6036 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6037 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6038 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6039 
GTEST_TEMPLATE_
 
T34
>

6040 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6041 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6042 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT,

6043 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6044 
Tem¶©es34
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6045 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6046 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
> 
	tty³
;

6048 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6049 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6050 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6051 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6052 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6053 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6054 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6055 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6056 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6057 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6058 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6059 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
>

6060 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6061 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6062 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT,

6063 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6064 
Tem¶©es35
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6065 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6066 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
> 
	tty³
;

6068 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6069 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6070 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6071 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6072 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6073 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6074 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6075 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6076 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6077 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6078 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6079 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
>

6080 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6081 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6082 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT,

6083 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6084 
Tem¶©es36
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6085 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6086 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
> 
	tty³
;

6088 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6089 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6090 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6091 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6092 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6093 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6094 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6095 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6096 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6097 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6098 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6099 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6100 
GTEST_TEMPLATE_
 
T37
>

6101 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6102 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6103 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT,

6104 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6105 
Tem¶©es37
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6106 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6107 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
> 
	tty³
;

6109 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6110 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6111 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6112 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6113 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6114 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6115 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6116 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6117 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6118 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6119 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6120 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6121 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
>

6122 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6123 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6124 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
NÚeT
, NoneT, NoneT, NoneT,

6125 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6126 
Tem¶©es38
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6127 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6128 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
> 
	tty³
;

6130 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6131 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6132 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6133 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6134 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6135 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6136 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6137 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6138 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6139 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6140 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6141 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6142 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
>

6143 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6144 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6145 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
NÚeT
, NoneT, NoneT,

6146 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6147 
Tem¶©es39
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6148 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6149 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
> 
	tty³
;

6151 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6152 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6153 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6154 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6155 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6156 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6157 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6158 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6159 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6160 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6161 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6162 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6163 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6164 
GTEST_TEMPLATE_
 
T40
>

6165 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6166 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6167 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
NÚeT
, NoneT, NoneT,

6168 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6169 
Tem¶©es40
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6170 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6171 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
> 
	tty³
;

6173 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6174 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6175 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6176 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6177 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6178 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6179 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6180 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6181 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6182 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6183 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6184 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6185 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6186 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
>

6187 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6188 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6189 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
NÚeT
, NoneT,

6190 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6191 
Tem¶©es41
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6192 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6193 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

6194 
	tT41
> 
	tty³
;

6196 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6197 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6198 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6199 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6200 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6201 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6202 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6203 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6204 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6205 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6206 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6207 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6208 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6209 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
>

6210 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6211 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6212 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
NÚeT
,

6213 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6214 
Tem¶©es42
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6215 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6216 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

6217 
	tT42
> 
	tty³
;

6219 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6220 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6221 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6222 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6223 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6224 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6225 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6226 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6227 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6228 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6229 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6230 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6231 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6232 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

6233 
GTEST_TEMPLATE_
 
T43
>

6234 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6235 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6236 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
,

6237 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT, NoneT> {

6238 
Tem¶©es43
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6239 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6240 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

6241 
	tT42
, 
	tT43
> 
	tty³
;

6243 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6244 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6245 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6246 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6247 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6248 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6249 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6250 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6251 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6252 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6253 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6254 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6255 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6256 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

6257 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
>

6258 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6259 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6260 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
,

6261 
NÚeT
, NoneT, NoneT, NoneT, NoneT, NoneT> {

6262 
Tem¶©es44
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6263 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6264 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

6265 
	tT42
, 
	tT43
, 
	tT44
> 
	tty³
;

6267 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6268 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6269 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6270 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6271 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6272 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6273 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6274 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6275 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6276 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6277 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6278 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6279 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6280 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

6281 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
>

6282 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6283 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6284 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
,

6285 
T45
, 
NÚeT
, NoneT, NoneT, NoneT, NoneT> {

6286 
Tem¶©es45
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6287 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6288 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

6289 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
> 
	tty³
;

6291 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6292 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6293 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6294 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6295 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6296 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6297 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6298 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6299 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6300 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6301 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6302 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6303 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6304 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

6305 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
,

6306 
GTEST_TEMPLATE_
 
T46
>

6307 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6308 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6309 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
,

6310 
T45
, 
T46
, 
NÚeT
, NoneT, NoneT, NoneT> {

6311 
Tem¶©es46
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6312 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6313 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

6314 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
> 
	tty³
;

6316 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6317 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6318 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6319 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6320 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6321 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6322 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6323 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6324 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6325 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6326 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6327 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6328 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6329 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

6330 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
,

6331 
GTEST_TEMPLATE_
 
T46
, GTEST_TEMPLATE_ 
T47
>

6332 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6333 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6334 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
,

6335 
T45
, 
T46
, 
T47
, 
NÚeT
, NoneT, NoneT> {

6336 
Tem¶©es47
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6337 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6338 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

6339 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
> 
	tty³
;

6341 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6342 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6343 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6344 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6345 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6346 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6347 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6348 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6349 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6350 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6351 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6352 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6353 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6354 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

6355 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
,

6356 
GTEST_TEMPLATE_
 
T46
, GTEST_TEMPLATE_ 
T47
, GTEST_TEMPLATE_ 
T48
>

6357 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6358 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6359 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
,

6360 
T45
, 
T46
, 
T47
, 
T48
, 
NÚeT
, NoneT> {

6361 
Tem¶©es48
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6362 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6363 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

6364 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
> 
	tty³
;

6366 
‹m¶©e
 <
GTEST_TEMPLATE_
 
T1
, GTEST_TEMPLATE_ 
T2
, GTEST_TEMPLATE_ 
T3
,

6367 
GTEST_TEMPLATE_
 
T4
, GTEST_TEMPLATE_ 
T5
, GTEST_TEMPLATE_ 
T6
,

6368 
GTEST_TEMPLATE_
 
T7
, GTEST_TEMPLATE_ 
T8
, GTEST_TEMPLATE_ 
T9
,

6369 
GTEST_TEMPLATE_
 
T10
, GTEST_TEMPLATE_ 
T11
, GTEST_TEMPLATE_ 
T12
,

6370 
GTEST_TEMPLATE_
 
T13
, GTEST_TEMPLATE_ 
T14
, GTEST_TEMPLATE_ 
T15
,

6371 
GTEST_TEMPLATE_
 
T16
, GTEST_TEMPLATE_ 
T17
, GTEST_TEMPLATE_ 
T18
,

6372 
GTEST_TEMPLATE_
 
T19
, GTEST_TEMPLATE_ 
T20
, GTEST_TEMPLATE_ 
T21
,

6373 
GTEST_TEMPLATE_
 
T22
, GTEST_TEMPLATE_ 
T23
, GTEST_TEMPLATE_ 
T24
,

6374 
GTEST_TEMPLATE_
 
T25
, GTEST_TEMPLATE_ 
T26
, GTEST_TEMPLATE_ 
T27
,

6375 
GTEST_TEMPLATE_
 
T28
, GTEST_TEMPLATE_ 
T29
, GTEST_TEMPLATE_ 
T30
,

6376 
GTEST_TEMPLATE_
 
T31
, GTEST_TEMPLATE_ 
T32
, GTEST_TEMPLATE_ 
T33
,

6377 
GTEST_TEMPLATE_
 
T34
, GTEST_TEMPLATE_ 
T35
, GTEST_TEMPLATE_ 
T36
,

6378 
GTEST_TEMPLATE_
 
T37
, GTEST_TEMPLATE_ 
T38
, GTEST_TEMPLATE_ 
T39
,

6379 
GTEST_TEMPLATE_
 
T40
, GTEST_TEMPLATE_ 
T41
, GTEST_TEMPLATE_ 
T42
,

6380 
GTEST_TEMPLATE_
 
T43
, GTEST_TEMPLATE_ 
T44
, GTEST_TEMPLATE_ 
T45
,

6381 
GTEST_TEMPLATE_
 
T46
, GTEST_TEMPLATE_ 
T47
, GTEST_TEMPLATE_ 
T48
,

6382 
GTEST_TEMPLATE_
 
T49
>

6383 
Tem¶©es
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
, 
T14
,

6384 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
, 
T29
,

6385 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
, 
T44
,

6386 
T45
, 
T46
, 
T47
, 
T48
, 
T49
, 
NÚeT
> {

6387 
Tem¶©es49
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
, 
	tT13
,

6388 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
, 
	tT27
,

6389 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
, 
	tT41
,

6390 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
, 
	tT49
> 
	tty³
;

6397 
‹m¶©e
 <
ty³Çme
 
T
>

6398 
	sTy³Li¡
 {

6399 
Ty³s1
<
	tT
> 
	tty³
;

6402 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
,y³Çm
T3
,y³Çm
T4
,y³Çm
T5
,

6403 
ty³Çme
 
T6
,y³Çm
T7
,y³Çm
T8
,y³Çm
T9
,y³Çm
T10
,

6404 
ty³Çme
 
T11
,y³Çm
T12
,y³Çm
T13
,y³Çm
T14
,y³Çm
T15
,

6405 
ty³Çme
 
T16
,y³Çm
T17
,y³Çm
T18
,y³Çm
T19
,y³Çm
T20
,

6406 
ty³Çme
 
T21
,y³Çm
T22
,y³Çm
T23
,y³Çm
T24
,y³Çm
T25
,

6407 
ty³Çme
 
T26
,y³Çm
T27
,y³Çm
T28
,y³Çm
T29
,y³Çm
T30
,

6408 
ty³Çme
 
T31
,y³Çm
T32
,y³Çm
T33
,y³Çm
T34
,y³Çm
T35
,

6409 
ty³Çme
 
T36
,y³Çm
T37
,y³Çm
T38
,y³Çm
T39
,y³Çm
T40
,

6410 
ty³Çme
 
T41
,y³Çm
T42
,y³Çm
T43
,y³Çm
T44
,y³Çm
T45
,

6411 
ty³Çme
 
T46
,y³Çm
T47
,y³Çm
T48
,y³Çm
T49
,y³Çm
T50
>

6412 
Ty³Li¡
<
Ty³s
<
T1
, 
T2
, 
T3
, 
T4
, 
T5
, 
T6
, 
T7
, 
T8
, 
T9
, 
T10
, 
T11
, 
T12
, 
T13
,

6413 
T14
, 
T15
, 
T16
, 
T17
, 
T18
, 
T19
, 
T20
, 
T21
, 
T22
, 
T23
, 
T24
, 
T25
, 
T26
, 
T27
, 
T28
,

6414 
T29
, 
T30
, 
T31
, 
T32
, 
T33
, 
T34
, 
T35
, 
T36
, 
T37
, 
T38
, 
T39
, 
T40
, 
T41
, 
T42
, 
T43
,

6415 
T44
, 
T45
, 
T46
, 
T47
, 
T48
, 
T49
, 
T50
> > {

6416 
ty³Çme
 
	tTy³s
<
	tT1
, 
	tT2
, 
	tT3
, 
	tT4
, 
	tT5
, 
	tT6
, 
	tT7
, 
	tT8
, 
	tT9
, 
	tT10
, 
	tT11
, 
	tT12
,

6417 
	tT13
, 
	tT14
, 
	tT15
, 
	tT16
, 
	tT17
, 
	tT18
, 
	tT19
, 
	tT20
, 
	tT21
, 
	tT22
, 
	tT23
, 
	tT24
, 
	tT25
, 
	tT26
,

6418 
	tT27
, 
	tT28
, 
	tT29
, 
	tT30
, 
	tT31
, 
	tT32
, 
	tT33
, 
	tT34
, 
	tT35
, 
	tT36
, 
	tT37
, 
	tT38
, 
	tT39
, 
	tT40
,

6419 
	tT41
, 
	tT42
, 
	tT43
, 
	tT44
, 
	tT45
, 
	tT46
, 
	tT47
, 
	tT48
, 
	tT49
, 
	tT50
>::
	tty³
ype;

6425 
	}
}

6437 
	#GTEST_CONCAT_TOKEN_
(
foo
, 
b¬
è
	`GTEST_CONCAT_TOKEN_IMPL_
(foo, b¬)

	)

6438 
	#GTEST_CONCAT_TOKEN_IMPL_
(
foo
, 
b¬
èfoØ## 
	)
bar

6441 
	#GTEST_STRINGIFY_
(
Çme
è#Çme

	)

6443 
Çme¥aû
 
	g´Ùo2
 { 
şass
 
	gMes§ge
; }

6445 
Çme¥aû
 
	g‹¡šg
 {

6449 
şass
 
	gAs£¹iÚResuÉ
;

6450 
şass
 
	gMes§ge
;

6451 
şass
 
	gTe¡
;

6452 
şass
 
	gTe¡Info
;

6453 
şass
 
	gTe¡P¬tResuÉ
;

6454 
şass
 
	gUn™Te¡
;

6456 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

6457 ::
¡d
::
¡ršg
 
PrštToSŒšg
(cÚ¡ 
T
& 
v®ue
);

6459 
Çme¥aû
 
	gš‹º®
 {

6461 
	gT¿ûInfo
;

6462 
şass
 
	gTe¡InfoIm¶
;

6463 
şass
 
	gUn™Te¡Im¶
;

6467 
GTEST_API_
 cÚ¡ 
kSckT¿ûM¬k”
[];

6470 şas 
	cIgnÜedV®ue
 {

6471 
	sSšk
 {};

6472 
	gpublic
:

6480 
‹m¶©e
 <
ty³Çme
 
T
,

6481 
ty³Çme
 
	g¡d
::
’abË_if
<!
¡d
::
is_cÚv”tibË
<
T
, 
	gSšk
>::
v®ue
,

6482 >::
ty³
 = 0>

6483 
IgnÜedV®ue
(cÚ¡ 
T
& ) {}

6487 
GTEST_API_
 
	g¡d
::
¡ršg
 
Aµ’dU£rMes§ge
(

6488 cÚ¡ 
¡d
::
¡ršg
& 
g‹¡_msg
, cÚ¡ 
Mes§ge
& 
u£r_msg
);

6490 #ià
GTEST_HAS_EXCEPTIONS


6492 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4275 \

6501 şas 
	cGTEST_API_
 
	gGoogËTe¡Fau»Exû±iÚ
 : 
public
 ::
¡d
::
ruÁime_”rÜ
 {

6502 
public
:

6503 
ex¶ic™
 
GoogËTe¡Fau»Exû±iÚ
(cÚ¡ 
Te¡P¬tResuÉ
& 
çu»
);

6506 
GTEST_DISABLE_MSC_WARNINGS_POP_
()

6510 
Çme¥aû
 
	ged™_di¡ªû
 {

6516 
	eEd™Ty³
 { 
	gkM©ch
, 
	gkAdd
, 
	gkRemove
, 
	gkR•Ïû
 };

6517 
GTEST_API_
 
	g¡d
::
veùÜ
<
Ed™Ty³
> 
C®cuÏ‹O±im®Ed™s
(

6518 cÚ¡ 
¡d
::
veùÜ
<
size_t
>& 
Ëá
, cÚ¡ std::veùÜ<size_t>& 
right
);

6521 
GTEST_API_
 
	g¡d
::
veùÜ
<
Ed™Ty³
> 
C®cuÏ‹O±im®Ed™s
(

6522 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
Ëá
,

6523 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
right
);

6526 
GTEST_API_
 
	g¡d
::
¡ršg
 
C»©eUnif›dDiff
(cÚ¡ 
¡d
::
veùÜ
<¡d::¡ršg>& 
Ëá
,

6527 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
right
,

6528 
size_t
 
cÚ‹xt
 = 2);

6536 
GTEST_API_
 
	g¡d
::
¡ršg
 
DiffSŒšgs
(cÚ¡ 
¡d
::¡ršg& 
Ëá
,

6537 cÚ¡ 
¡d
::
¡ršg
& 
right
,

6538 
size_t
* 
tÙ®_lše_couÁ
);

6555 
GTEST_API_
 
As£¹iÚResuÉ
 
EqFau»
(cÚ¡ * 
ex³ùed_ex´essiÚ
,

6556 cÚ¡ * 
aùu®_ex´essiÚ
,

6557 cÚ¡ 
¡d
::
¡ršg
& 
ex³ùed_v®ue
,

6558 cÚ¡ 
¡d
::
¡ršg
& 
aùu®_v®ue
,

6559 
boŞ
 
ignÜšg_ÿ£
);

6562 
GTEST_API_
 
	g¡d
::
¡ršg
 
G‘BoŞAs£¹iÚFau»Mes§ge
(

6563 cÚ¡ 
As£¹iÚResuÉ
& 
as£¹iÚ_»suÉ
,

6564 cÚ¡ * 
ex´essiÚ_‹xt
,

6565 cÚ¡ * 
aùu®_´ediÿ‹_v®ue
,

6566 cÚ¡ * 
ex³ùed_´ediÿ‹_v®ue
);

6597 
	g‹m¶©e
 <
ty³Çme
 
	gRawTy³
>

6598 şas 
	cFlßtšgPošt
 {

6599 
	gpublic
:

6602 
ty³Çme
 
	tTy³W™hSize
<(
	tRawTy³
)>::
	tUIÁ
 
	tB™s
;

6607 cÚ¡ 
size_t
 
	gkB™CouÁ
 = 8*(
RawTy³
);

6610 cÚ¡ 
size_t
 
	gkF¿ùiÚB™CouÁ
 =

6611 
¡d
::
num”ic_lim™s
<
RawTy³
>::
dig™s
 - 1;

6614 cÚ¡ 
size_t
 
	gkExpÚ’tB™CouÁ
 = 
kB™CouÁ
 - 1 - 
kF¿ùiÚB™CouÁ
;

6617 cÚ¡ 
B™s
 
	gkSignB™Mask
 = 
¡©ic_ÿ¡
<B™s>(1è<< (
kB™CouÁ
 - 1);

6620 cÚ¡ 
B™s
 
	gkF¿ùiÚB™Mask
 =

6621 ~
¡©ic_ÿ¡
<
B™s
>(0è>> (
kExpÚ’tB™CouÁ
 + 1);

6624 cÚ¡ 
B™s
 
	gkExpÚ’tB™Mask
 = ~(
kSignB™Mask
 | 
kF¿ùiÚB™Mask
);

6638 cÚ¡ 
size_t
 
	gkMaxUÍs
 = 4;

6646 
ex¶ic™
 
FlßtšgPošt
(cÚ¡ 
RawTy³
& 
x
è{ 
	gu_
.
	gv®ue_
 = x; }

6653 
RawTy³
 
Reš‹½»tB™s
(cÚ¡ 
B™s
 
b™s
) {

6654 
FlßtšgPošt
 
å
(0);

6655 
	gå
.
	gu_
.
	gb™s_
 = 
b™s
;

6656  
	gå
.
	gu_
.
	gv®ue_
;

6660 
RawTy³
 
Infš™y
() {

6661  
Reš‹½»tB™s
(
kExpÚ’tB™Mask
);

6665 
RawTy³
 
Max
();

6670 cÚ¡ 
	gB™s
 &
b™s
(ècÚ¡ {  
	gu_
.
	gb™s_
; }

6673 
B™s
 
expÚ’t_b™s
(ècÚ¡ {  
	gkExpÚ’tB™Mask
 & 
	gu_
.
	gb™s_
; }

6676 
B™s
 
äaùiÚ_b™s
(ècÚ¡ {  
	gkF¿ùiÚB™Mask
 & 
	gu_
.
	gb™s_
; }

6679 
B™s
 
sign_b™
(ècÚ¡ {  
	gkSignB™Mask
 & 
	gu_
.
	gb™s_
; }

6682 
boŞ
 
is_Çn
() const {

6685  (
expÚ’t_b™s
(è=ğ
kExpÚ’tB™Mask
è&& (
äaùiÚ_b™s
() != 0);

6694 
boŞ
 
Almo¡Equ®s
(cÚ¡ 
FlßtšgPošt
& 
rhs
) const {

6697 ià(
is_Çn
(è|| 
	grhs
.is_Çn()è 
	gçl£
;

6699  
Di¡ªûB‘w“nSignAndMagn™udeNumb”s
(
u_
.
b™s_
, 
rhs
.u_.bits_)

6700 <ğ
kMaxUÍs
;

6703 
	g´iv©e
:

6705 
	uFlßtšgPoštUniÚ
 {

6706 
RawTy³
 
v®ue_
;

6707 
B™s
 
	gb™s_
;

6725 
B™s
 
SignAndMagn™udeToBŸ£d
(cÚ¡ B™ &
§m
) {

6726 ià(
	gkSignB™Mask
 & 
	g§m
) {

6728  ~
	g§m
 + 1;

6731  
	gkSignB™Mask
 | 
	g§m
;

6737 
B™s
 
Di¡ªûB‘w“nSignAndMagn™udeNumb”s
(cÚ¡ B™ &
§m1
,

6738 cÚ¡ 
B™s
 &
§m2
) {

6739 cÚ¡ 
B™s
 
	gbŸ£d1
 = 
SignAndMagn™udeToBŸ£d
(
§m1
);

6740 cÚ¡ 
B™s
 
	gbŸ£d2
 = 
SignAndMagn™udeToBŸ£d
(
§m2
);

6741  (
	gbŸ£d1
 >ğ
bŸ£d2
è? (
bŸ£d1
 - biased2) : (biased2 - biased1);

6744 
FlßtšgPoštUniÚ
 
	gu_
;

6749 
	g‹m¶©e
 <>

6750 
šlše
 
	gFlßtšgPošt
<>::
Max
(è{  
FLT_MAX
; }

6751 
	g‹m¶©e
 <>

6752 
šlše
 
	gFlßtšgPošt
<>::
Max
(è{  
DBL_MAX
; }

6756 
	gFlßtšgPošt
<> 
	tFlßt
;

6757 
	gFlßtšgPošt
<> 
	tDoubË
;

6765 cÚ¡ * 
	tTy³Id
;

6767 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

6768 şas 
	cTy³IdH–³r
 {

6769 
	gpublic
:

6773 
boŞ
 
dummy_
;

6776 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

6777 
boŞ
 
	gTy³IdH–³r
<
	gT
>::
dummy_
 = 
çl£
;

6782 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

6783 
Ty³Id
 
G‘Ty³Id
() {

6788  &(
	gTy³IdH–³r
<
	gT
>::
dummy_
);

6796 
GTEST_API_
 
Ty³Id
 
G‘Te¡Ty³Id
();

6800 şas 
	cTe¡FaùÜyBa£
 {

6801 
	gpublic
:

6802 
vœtu®
 ~
Te¡FaùÜyBa£
() {}

6806 
vœtu®
 
Te¡
* 
C»©eTe¡
() = 0;

6808 
	g´Ùeùed
:

6809 
Te¡FaùÜyBa£
() {}

6811 
´iv©e
:

6812 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Te¡FaùÜyBa£
);

6817 
	g‹m¶©e
 <
şass
 
	gTe¡CÏss
>

6818 şas 
	cTe¡FaùÜyIm¶
 : 
public
 
Te¡FaùÜyBa£
 {

6819 
public
:

6820 
Te¡
* 
C»©eTe¡
(è
ov”ride
 {  
Ãw
 
Te¡CÏss
; }

6823 #ià
GTEST_OS_WINDOWS


6829 
GTEST_API_
 
As£¹iÚResuÉ
 
IsHRESULTSucûss
(cÚ¡ * 
ex´
,

6830 
hr
);

6831 
GTEST_API_
 
As£¹iÚResuÉ
 
IsHRESULTFau»
(cÚ¡ * 
ex´
,

6832 
hr
);

6837 
usšg
 
	gS‘UpTe¡Su™eFunc
 = (*)();

6838 
usšg
 
	gT—rDownTe¡Su™eFunc
 = (*)();

6840 
	sCodeLoÿtiÚ
 {

6841 
CodeLoÿtiÚ
(cÚ¡ 
¡d
::
¡ršg
& 
a_fe
, 
a_lše
)

6842 : 
fe
(
a_fe
), 
lše
(
a_lše
) {}

6844 
	g¡d
::
¡ršg
 
fe
;

6845 
	glše
;

6852 
usšg
 
	gS‘UpT—rDownSu™eFuncTy³
 = (*)();

6854 
šlše
 
S‘UpT—rDownSu™eFuncTy³
 
G‘NÙDeçuÉOrNuÎ
(

6855 
S‘UpT—rDownSu™eFuncTy³
 
a
, S‘UpT—rDownSu™eFuncTy³ 
def
) {

6856  
	ga
 =ğ
def
 ? 
nuÎ±r
 : 
a
;

6859 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

6863 
	gSu™eApiResŞv”
 : 
T
 {

6866 
usšg
 
Te¡
 =

6867 
ty³Çme
 
¡d
::
cÚd™iÚ®
<(
T
è!ğ0, ::
‹¡šg
::
Te¡
, >::
ty³
;

6869 
S‘UpT—rDownSu™eFuncTy³
 
G‘S‘UpCa£OrSu™e
(cÚ¡ * 
f’ame
,

6870 
lše_num
) {

6871 
S‘UpT—rDownSu™eFuncTy³
 
	g‹¡_ÿ£_å
 =

6872 
G‘NÙDeçuÉOrNuÎ
(&
T
::
S‘UpTe¡Ca£
, &
Te¡
::SetUpTestCase);

6873 
S‘UpT—rDownSu™eFuncTy³
 
	g‹¡_su™e_å
 =

6874 
G‘NÙDeçuÉOrNuÎ
(&
T
::
S‘UpTe¡Su™e
, &
Te¡
::SetUpTestSuite);

6876 
GTEST_CHECK_
(!
‹¡_ÿ£_å
 || !
‹¡_su™e_å
)

6879 << 
	gf’ame
 << ":" << 
	glše_num
;

6881  
	g‹¡_ÿ£_å
 !ğ
nuÎ±r
 ? 
‹¡_ÿ£_å
 : 
‹¡_su™e_å
;

6884 
S‘UpT—rDownSu™eFuncTy³
 
G‘T—rDownCa£OrSu™e
(cÚ¡ * 
f’ame
,

6885 
lše_num
) {

6886 
S‘UpT—rDownSu™eFuncTy³
 
	g‹¡_ÿ£_å
 =

6887 
G‘NÙDeçuÉOrNuÎ
(&
T
::
T—rDownTe¡Ca£
, &
Te¡
::TearDownTestCase);

6888 
S‘UpT—rDownSu™eFuncTy³
 
	g‹¡_su™e_å
 =

6889 
G‘NÙDeçuÉOrNuÎ
(&
T
::
T—rDownTe¡Su™e
, &
Te¡
::TearDownTestSuite);

6891 
GTEST_CHECK_
(!
‹¡_ÿ£_å
 || !
‹¡_su™e_å
)

6894 << 
	gf’ame
 << ":" << 
	glše_num
;

6896  
	g‹¡_ÿ£_å
 !ğ
nuÎ±r
 ? 
‹¡_ÿ£_å
 : 
‹¡_su™e_å
;

6918 
GTEST_API_
 
Te¡Info
* 
MakeAndRegi¡”Te¡Info
(

6919 cÚ¡ * 
‹¡_su™e_Çme
, cÚ¡ * 
Çme
, cÚ¡ * 
ty³_·¿m
,

6920 cÚ¡ * 
v®ue_·¿m
, 
CodeLoÿtiÚ
 
code_loÿtiÚ
,

6921 
Ty³Id
 
fixtu»_şass_id
, 
S‘UpTe¡Su™eFunc
 
£t_up_tc
,

6922 
T—rDownTe¡Su™eFunc
 
‹¬_down_tc
, 
Te¡FaùÜyBa£
* 
çùÜy
);

6927 
GTEST_API_
 
boŞ
 
SkP»fix
(cÚ¡ * 
´efix
, cÚ¡ ** 
p¡r
);

6929 #ià
GTEST_HAS_TYPED_TEST
 || 
GTEST_HAS_TYPED_TEST_P


6931 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4251 \

6935 şas 
	cGTEST_API_
 
	gTy³dTe¡Su™ePS‹
 {

6936 
	gpublic
:

6937 
Ty³dTe¡Su™ePS‹
(è: 
»gi¡”ed_
(
çl£
) {}

6942 
boŞ
 
AddTe¡Name
(cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
ÿ£_Çme
,

6943 cÚ¡ * 
‹¡_Çme
) {

6944 ià(
	g»gi¡”ed_
) {

6945 
årštf
(
¡d”r
,

6948 
FÜm©FeLoÿtiÚ
(
fe
, 
lše
).
c_¡r
(), 
‹¡_Çme
, 
ÿ£_Çme
);

6949 
fæush
(
¡d”r
);

6950 
	gposix
::
AbÜt
();

6952 
	g»gi¡”ed_‹¡s_
.
š£¹
(

6953 ::
¡d
::
make_·œ
(
‹¡_Çme
, 
CodeLoÿtiÚ
(
fe
, 
lše
)));

6954  
	gŒue
;

6957 
boŞ
 
Te¡Exi¡s
(cÚ¡ 
¡d
::
¡ršg
& 
‹¡_Çme
) const {

6958  
»gi¡”ed_‹¡s_
.
couÁ
(
‹¡_Çme
) > 0;

6961 cÚ¡ 
	gCodeLoÿtiÚ
& 
G‘CodeLoÿtiÚ
(cÚ¡ 
¡d
::
¡ršg
& 
‹¡_Çme
) const {

6962 
Regi¡”edTe¡sM­
::
cÚ¡_™”©Ü
 
™
 = 
»gi¡”ed_‹¡s_
.
fšd
(
‹¡_Çme
);

6963 
GTEST_CHECK_
(
™
 !ğ
»gi¡”ed_‹¡s_
.
’d
());

6964  
	g™
->
	g£cÚd
;

6970 cÚ¡ * 
V”ifyRegi¡”edTe¡Names
(

6971 cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
»gi¡”ed_‹¡s
);

6973 
	g´iv©e
:

6974 ::
¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, 
	tCodeLoÿtiÚ
> 
	tRegi¡”edTe¡sM­
;

6976 
boŞ
 
	g»gi¡”ed_
;

6977 
Regi¡”edTe¡sM­
 
	g»gi¡”ed_‹¡s_
;

6981 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


6982 
usšg
 
	gTy³dTe¡Ca£PS‹
 = 
Ty³dTe¡Su™ePS‹
;

6985 
GTEST_DISABLE_MSC_WARNINGS_POP_
()

6989 
šlše
 cÚ¡ * 
SkComma
(cÚ¡ * 
¡r
) {

6990 cÚ¡ * 
	gcomma
 = 
¡rchr
(
¡r
, ',');

6991 ià(
	gcomma
 =ğ
nuÎ±r
) {

6992  
nuÎ±r
;

6994 
IsS·û
(*(++
comma
))) {}

6995  
	gcomma
;

7000 
šlše
 
	g¡d
::
¡ršg
 
G‘P»fixUÁComma
(cÚ¡ * 
¡r
) {

7001 cÚ¡ * 
comma
 = 
¡rchr
(
¡r
, ',');

7002  
	gcomma
 =ğ
nuÎ±r
 ? 
¡r
 : 
¡d
::
¡ršg
(¡r, 
comma
);

7007 
S¶™SŒšg
(cÚ¡ ::
¡d
::
¡ršg
& 
¡r
, 
d–im™”
,

7008 ::
¡d
::
veùÜ
< ::¡d::
¡ršg
>* 
de¡
);

7012 
	sDeçuÉNameG’”©Ü
 {

7013 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

7014 
	g¡d
::
¡ršg
 
G‘Name
(
i
) {

7015  
SŒ—mabËToSŒšg
(
i
);

7019 
	g‹m¶©e
 <
ty³Çme
 
	gProvided
 = 
DeçuÉNameG’”©Ü
>

7020 
	sNameG’”©ÜS–eùÜ
 {

7021 
Provided
 
	tty³
;

7024 
	g‹m¶©e
 <
ty³Çme
 
	gNameG’”©Ü
>

7025 
G’”©eNamesRecursiv–y
(
Ty³s0
, 
¡d
::
veùÜ
<¡d::
¡ršg
>*, ) {}

7027 
	g‹m¶©e
 <
ty³Çme
 
	gNameG’”©Ü
,y³Çm
	gTy³s
>

7028 
G’”©eNamesRecursiv–y
(
Ty³s
, 
¡d
::
veùÜ
<¡d::
¡ršg
>* 
»suÉ
, 
i
) {

7029 
	g»suÉ
->
push_back
(
NameG’”©Ü
::
‹m¶©e
 
G‘Name
<
ty³Çme
 
Ty³s
::
H—d
>(
i
));

7030 
	gG’”©eNamesRecursiv–y
<
	gNameG’”©Ü
>(
ty³Çme
 
	gTy³s
::
Ta
(), 
	g»suÉ
,

7031 
	gi
 + 1);

7034 
	g‹m¶©e
 <
ty³Çme
 
	gNameG’”©Ü
,y³Çm
	gTy³s
>

7035 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
G’”©eNames
() {

7036 
¡d
::
veùÜ
<¡d::
¡ršg
> 
»suÉ
;

7037 
	gG’”©eNamesRecursiv–y
<
	gNameG’”©Ü
>(
Ty³s
(), &
	g»suÉ
, 0);

7038  
	g»suÉ
;

7048 
	g‹m¶©e
 <
GTEST_TEMPLATE_
 
	gFixtu»
, 
şass
 
	gTe¡S–
, 
ty³Çme
 
	gTy³s
>

7049 şas 
	cTy³P¬am‘”izedTe¡
 {

7050 
	gpublic
:

7055 
boŞ
 
Regi¡”
(cÚ¡ * 
´efix
, cÚ¡ 
CodeLoÿtiÚ
& 
code_loÿtiÚ
,

7056 cÚ¡ * 
ÿ£_Çme
, cÚ¡ * 
‹¡_Çmes
, 
šdex
,

7057 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
ty³_Çmes
 =

7058 
G’”©eNames
<
DeçuÉNameG’”©Ü
, 
Ty³s
>()) {

7059 
ty³Çme
 
	tTy³s
::
	tH—d
 
	tTy³
;

7060 
	gFixtu»
<
	tTy³
> 
	tFixtu»CÏss
;

7061 
ty³Çme
 
	tGTEST_BIND_
(
	tTe¡S–
, 
	tTy³
è
	tTe¡CÏss
;

7065 
MakeAndRegi¡”Te¡Info
(

7066 (
¡d
::
¡ršg
(
´efix
è+ (´efix[0] =ğ'\0' ? "" : "/"è+ 
ÿ£_Çme
 +

7067 "/" + 
ty³_Çmes
[
¡©ic_ÿ¡
<
size_t
>(
šdex
)])

7068 .
c_¡r
(),

7069 
SŒT¿šgS·ûs
(
G‘P»fixUÁComma
(
‹¡_Çmes
)).
c_¡r
(),

7070 
G‘Ty³Name
<
Ty³
>().
c_¡r
(),

7071 
nuÎ±r
,

7072 
code_loÿtiÚ
, 
G‘Ty³Id
<
Fixtu»CÏss
>(),

7073 
Su™eApiResŞv”
<
Te¡CÏss
>::
G‘S‘UpCa£OrSu™e
(

7074 
code_loÿtiÚ
.
fe
.
c_¡r
(), code_loÿtiÚ.
lše
),

7075 
Su™eApiResŞv”
<
Te¡CÏss
>::
G‘T—rDownCa£OrSu™e
(

7076 
code_loÿtiÚ
.
fe
.
c_¡r
(), code_loÿtiÚ.
lše
),

7077 
Ãw
 
Te¡FaùÜyIm¶
<
Te¡CÏss
>);

7080  
	gTy³P¬am‘”izedTe¡
<
	gFixtu»
, 
	gTe¡S–
,

7081 
ty³Çme
 
	gTy³s
::
Ta
>::
Regi¡”
(
´efix
,

7082 
code_loÿtiÚ
,

7083 
ÿ£_Çme
,

7084 
‹¡_Çmes
,

7085 
šdex
 + 1,

7086 
ty³_Çmes
);

7091 
	g‹m¶©e
 <
GTEST_TEMPLATE_
 
	gFixtu»
, 
şass
 
	gTe¡S–
>

7092 
şass
 
	gTy³P¬am‘”izedTe¡
<
	gFixtu»
, 
	gTe¡S–
, 
	gTy³s0
> {

7093 
	gpublic
:

7094 
boŞ
 
Regi¡”
(cÚ¡ * , cÚ¡ 
CodeLoÿtiÚ
&,

7097 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& =

7098 
¡d
::
veùÜ
<¡d::
¡ršg
>() ) {

7099  
Œue
;

7107 
	g‹m¶©e
 <
GTEST_TEMPLATE_
 
	gFixtu»
, 
ty³Çme
 
	gTe¡s
,y³Çm
	gTy³s
>

7108 şas 
	cTy³P¬am‘”izedTe¡Su™e
 {

7109 
	gpublic
:

7110 
boŞ
 
Regi¡”
(cÚ¡ * 
´efix
, 
CodeLoÿtiÚ
 
code_loÿtiÚ
,

7111 cÚ¡ 
Ty³dTe¡Su™ePS‹
* 
¡©e
, cÚ¡ * 
ÿ£_Çme
,

7112 cÚ¡ * 
‹¡_Çmes
,

7113 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
ty³_Çmes
 =

7114 
G’”©eNames
<
DeçuÉNameG’”©Ü
, 
Ty³s
>()) {

7115 
	g¡d
::
¡ršg
 
‹¡_Çme
 = 
SŒT¿šgS·ûs
(

7116 
G‘P»fixUÁComma
(
‹¡_Çmes
));

7117 ià(!
	g¡©e
->
Te¡Exi¡s
(
‹¡_Çme
)) {

7118 
årštf
(
¡d”r
, "Failedo get code†ocation forest %s.%s‡t %s.",

7119 
ÿ£_Çme
, 
‹¡_Çme
.
c_¡r
(),

7120 
FÜm©FeLoÿtiÚ
(
code_loÿtiÚ
.
fe
.
c_¡r
(),

7121 
code_loÿtiÚ
.
lše
).
c_¡r
());

7122 
fæush
(
¡d”r
);

7123 
	gposix
::
AbÜt
();

7125 cÚ¡ 
	gCodeLoÿtiÚ
& 
	g‹¡_loÿtiÚ
 = 
¡©e
->
G‘CodeLoÿtiÚ
(
‹¡_Çme
);

7127 
ty³Çme
 
	tTe¡s
::
	tH—d
 Head;

7130 
	gTy³P¬am‘”izedTe¡
<
	gFixtu»
, 
	gH—d
, 
	gTy³s
>::
Regi¡”
(

7131 
´efix
, 
‹¡_loÿtiÚ
, 
ÿ£_Çme
, 
‹¡_Çmes
, 0, 
ty³_Çmes
);

7134  
	gTy³P¬am‘”izedTe¡Su™e
<
	gFixtu»
, 
ty³Çme
 
	gTe¡s
::
Ta
,

7135 
	gTy³s
>::
Regi¡”
(
´efix
, 
code_loÿtiÚ
,

7136 
¡©e
, 
ÿ£_Çme
,

7137 
SkComma
(
‹¡_Çmes
),

7138 
ty³_Çmes
);

7143 
	g‹m¶©e
 <
GTEST_TEMPLATE_
 
	gFixtu»
, 
ty³Çme
 
	gTy³s
>

7144 
şass
 
	gTy³P¬am‘”izedTe¡Su™e
<
	gFixtu»
, 
	gTem¶©es0
, 
	gTy³s
> {

7145 
	gpublic
:

7146 
boŞ
 
Regi¡”
(cÚ¡ * , cÚ¡ 
CodeLoÿtiÚ
&,

7147 cÚ¡ 
Ty³dTe¡Su™ePS‹
* ,

7149 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& =

7150 
¡d
::
veùÜ
<¡d::
¡ršg
>() ) {

7151  
Œue
;

7167 
GTEST_API_
 
	g¡d
::
¡ršg
 
G‘Cu¼’tOsSckT¿ûExû±Tİ
(

7168 
Un™Te¡
* 
un™_‹¡
, 
sk_couÁ
);

7174 
GTEST_API_
 
boŞ
 
AlwaysTrue
();

7177 
šlše
 
boŞ
 
AlwaysF®£
(è{  !
AlwaysTrue
(); }

7182 
GTEST_API_
 
	gCÚ¡Ch¬PŒ
 {

7183 
CÚ¡Ch¬PŒ
(cÚ¡ * 
¡r
è: 
v®ue
(str) {}

7184 
İ”©Ü
 
boŞ
(ècÚ¡ {  
Œue
; }

7185 cÚ¡ * 
	gv®ue
;

7193 şas 
	cGTEST_API_
 
	gRªdom
 {

7194 
	gpublic
:

7195 cÚ¡ 
UIÁ32
 
kMaxRªge
 = 1u << 31;

7197 
ex¶ic™
 
Rªdom
(
UIÁ32
 
£ed
è: 
¡©e_
(seed) {}

7199 
Re£ed
(
UIÁ32
 
£ed
è{ 
¡©e_
 = seed; }

7203 
UIÁ32
 
G’”©e
(UIÁ32 
¿nge
);

7205 
	g´iv©e
:

7206 
UIÁ32
 
¡©e_
;

7207 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Rªdom
);

7211 
	#GTEST_REMOVE_REFERENCE_AND_CONST_
(
T
) \

7212 
ty³Çme
 
¡d
::
»move_cÚ¡
<ty³Çm¡d::
»move_»ã»nû
<
T
>::
ty³
>::
	)
type

7216 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

7217 
	gIsAPrÙocŞMes§ge


7218 : 
public
 
boŞ_cÚ¡ªt
<

7219 
¡d
::
is_cÚv”tibË
<cÚ¡ 
T
*, cÚ¡ ::
´Ùo2
::
Mes§ge
*>::
v®ue
> {};

7245 
	tIsCÚš”
;

7246 
	g‹m¶©e
 <
şass
 
	gC
,

7247 
şass
 
	gI‹¿tÜ
 = 
deşty³
(::
¡d
::
deşv®
<cÚ¡ 
C
&>().
begš
()),

7248 
	gşass
 = 
deşty³
(::
¡d
::
deşv®
<cÚ¡ 
C
&>().
’d
()),

7249 
	gşass
 = 
deşty³
(++::
¡d
::
deşv®
<
I‹¿tÜ
&>()),

7250 
	gşass
 = 
deşty³
(*::
¡d
::
deşv®
<
I‹¿tÜ
>()),

7251 
	gşass
 = 
ty³Çme
 
C
::
cÚ¡_™”©Ü
>

7252 
IsCÚš”
 
IsCÚš”Te¡
() {

7256 
	tIsNÙCÚš”
;

7257 
	g‹m¶©e
 <
şass
 
	gC
>

7258 
IsNÙCÚš”
 
IsCÚš”Te¡
() {  '\0'; }

7264 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

7265 
	sIsHashTabË
 {

7266 
	g´iv©e
:

7267 
‹m¶©e
 <
ty³Çme
 
U
>

7268 
‹¡
(
ty³Çme
 
U
::
hash”
*,y³ÇmU::
»v”£_™”©Ü
*);

7269 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

7270 
‹¡
(
ty³Çme
 
U
::
hash”
*, ...);

7271 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

7272 
‹¡
(...);

7274 
	gpublic
:

7275 cÚ¡ 
boŞ
 
v®ue
 = (
‹¡
<
T
>(
nuÎ±r
, 
	gnuÎ±r
)) == ();

7278 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

7279 cÚ¡ 
boŞ
 
	gIsHashTabË
<
	gT
>::
v®ue
;

7281 
	g‹m¶©e
 <
ty³Çme
 
	gC
,

7282 
	gboŞ
 = (
IsCÚš”Te¡
<
C
>(0)è=ğ(
IsCÚš”
)>

7283 
IsRecursiveCÚš”Im¶
;

7285 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

7286 
	gIsRecursiveCÚš”Im¶
<
	gC
, 
	gçl£
> : 
public
 
¡d
::
çl£_ty³
 {};

7292 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

7293 
	gIsRecursiveCÚš”Im¶
<
	gC
, 
	gŒue
> {

7294 
usšg
 
	gv®ue_ty³
 = 
deşty³
(*
¡d
::
deşv®
<
ty³Çme
 
C
::
cÚ¡_™”©Ü
>());

7295 
usšg
 
	gty³
 =

7296 
¡d
::
is_§me
<
ty³Çme
 std::
»move_cÚ¡
<

7297 
ty³Çme
 
¡d
::
»move_»ã»nû
<
v®ue_ty³
>::
ty³
>::type,

7298 
	gC
>;

7307 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

7308 
	gIsRecursiveCÚš”
 : 
public
 
IsRecursiveCÚš”Im¶
<
C
>::
ty³
 {};

7316 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

7317 
boŞ
 
A¼ayEq
(cÚ¡ 
T
* 
lhs
, 
size_t
 
size
, cÚ¡ 
U
* 
rhs
);

7320 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

7321 
šlše
 
boŞ
 
A¼ayEq
(cÚ¡ 
T
& 
lhs
, cÚ¡ 
U
& 
rhs
è{  
	glhs
 ==„hs; }

7324 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
, 
size_t
 
	gN
>

7325 
šlše
 
boŞ
 
A¼ayEq
(cÚ¡ 
T
(&
lhs
)[
N
], cÚ¡ 
U
(&
rhs
)[N]) {

7326  
	gš‹º®
::
A¼ayEq
(
lhs
, 
N
, 
rhs
);

7332 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

7333 
boŞ
 
A¼ayEq
(cÚ¡ 
T
* 
lhs
, 
size_t
 
size
, cÚ¡ 
U
* 
rhs
) {

7334 
size_t
 
	gi
 = 0; i !ğ
size
; i++) {

7335 ià(!
	gš‹º®
::
A¼ayEq
(
lhs
[
i
], 
rhs
[i]))

7336  
	gçl£
;

7338  
	gŒue
;

7343 
	g‹m¶©e
 <
ty³Çme
 
	gI‹r
,y³Çm
	gEËm’t
>

7344 
I‹r
 
A¼ayAw¬eFšd
(I‹¸
begš
, I‹¸
’d
, cÚ¡ 
EËm’t
& 
–em
) {

7345 
I‹r
 
	g™
 = 
begš
; iˆ!ğ
’d
; ++it) {

7346 ià(
	gš‹º®
::
A¼ayEq
(*
™
, 
–em
))

7347  
	g™
;

7349  
	g’d
;

7356 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

7357 
CİyA¼ay
(cÚ¡ 
T
* 
äom
, 
size_t
 
size
, 
U
* 
to
);

7360 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

7361 
šlše
 
CİyA¼ay
(cÚ¡ 
T
& 
äom
, 
U
* 
to
è{ *
	gto
 = from; }

7364 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
, 
size_t
 
	gN
>

7365 
šlše
 
CİyA¼ay
(cÚ¡ 
T
(&
äom
)[
N
], 
U
(*
to
)[N]) {

7366 
	gš‹º®
::
CİyA¼ay
(
äom
, 
N
, *
to
);

7372 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

7373 
CİyA¼ay
(cÚ¡ 
T
* 
äom
, 
size_t
 
size
, 
U
* 
to
) {

7374 
size_t
 
	gi
 = 0; i !ğ
size
; i++) {

7375 
	gš‹º®
::
CİyA¼ay
(
äom
[
i
], 
to
 + i);

7383 
	sR–©iÚToSourûReã»nû
 {};

7384 
	sR–©iÚToSourûCİy
 {};

7394 
	g‹m¶©e
 <
ty³Çme
 
	gEËm’t
>

7395 şas 
	cN©iveA¼ay
 {

7396 
	gpublic
:

7398 
EËm’t
 
	tv®ue_ty³
;

7399 
EËm’t
* 
	t™”©Ü
;

7400 cÚ¡ 
	tEËm’t
* 
	tcÚ¡_™”©Ü
;

7403 
N©iveA¼ay
(cÚ¡ 
EËm’t
* 
¬¿y
, 
size_t
 
couÁ
, 
R–©iÚToSourûReã»nû
) {

7404 
In™Ref
(
¬¿y
, 
couÁ
);

7408 
N©iveA¼ay
(cÚ¡ 
EËm’t
* 
¬¿y
, 
size_t
 
couÁ
, 
R–©iÚToSourûCİy
) {

7409 
In™Cİy
(
¬¿y
, 
couÁ
);

7413 
N©iveA¼ay
(cÚ¡ N©iveA¼ay& 
rhs
) {

7414 (
	gthis
->*
	grhs
.
	gşÚe_
)Ôhs.
	g¬¿y_
,„hs.
	gsize_
);

7417 ~
N©iveA¼ay
() {

7418 ià(
	gşÚe_
 !ğ&
N©iveA¼ay
::
In™Ref
)

7419 
d–‘e
[] 
¬¿y_
;

7423 
size_t
 
size
(ècÚ¡ {  
	gsize_
; }

7424 
cÚ¡_™”©Ü
 
begš
(ècÚ¡ {  
	g¬¿y_
; }

7425 
cÚ¡_™”©Ü
 
’d
(ècÚ¡ {  
	g¬¿y_
 + 
	gsize_
; }

7426 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
N©iveA¼ay
& 
rhs
) const {

7427  
size
(è=ğ
rhs
.size() &&

7428 
A¼ayEq
(
begš
(), 
size
(), 
rhs
.begin());

7431 
	g´iv©e
:

7432 
¡©ic_as£¹
(!
¡d
::
is_cÚ¡
<
EËm’t
>::
v®ue
, "Type must‚ot be const");

7433 
¡©ic_as£¹
(!
¡d
::
is_»ã»nû
<
EËm’t
>::
v®ue
,

7437 
In™Cİy
(cÚ¡ 
EËm’t
* 
¬¿y
, 
size_t
 
a_size
) {

7438 
EËm’t
* cÚ¡ 
	gcİy
 = 
Ãw
 EËm’t[
a_size
];

7439 
CİyA¼ay
(
¬¿y
, 
a_size
, 
cİy
);

7440 
	g¬¿y_
 = 
cİy
;

7441 
	gsize_
 = 
a_size
;

7442 
	gşÚe_
 = &
N©iveA¼ay
::
In™Cİy
;

7446 
In™Ref
(cÚ¡ 
EËm’t
* 
¬¿y
, 
size_t
 
a_size
) {

7447 
	g¬¿y_
 = 
¬¿y
;

7448 
	gsize_
 = 
a_size
;

7449 
	gşÚe_
 = &
N©iveA¼ay
::
In™Ref
;

7452 cÚ¡ 
EËm’t
* 
	g¬¿y_
;

7453 
size_t
 
	gsize_
;

7454 (
	gN©iveA¼ay
::*
şÚe_
)(cÚ¡ 
EËm’t
*, 
	gsize_t
);

7456 
GTEST_DISALLOW_ASSIGN_
(
N©iveA¼ay
);

7460 
	g‹m¶©e
 <
	gsize_t
... 
	gIs
>

7461 
	sIndexSequ’û
 {

7462 
usšg
 
	gty³
 = 
IndexSequ’û
;

7466 
	g‹m¶©e
 <
boŞ
 
	g¶us_Úe
, 
ty³Çme
 
	gT
, 
size_t
 
	gsizeofT
>

7467 
	gDoubËSequ’û
;

7468 
	g‹m¶©e
 <
	gsize_t
... 
	gI
, 
size_t
 
	gsizeofT
>

7469 
	gDoubËSequ’û
<
	gŒue
, 
	gIndexSequ’û
<
	gI
...>, 
	gsizeofT
> {

7470 
usšg
 
	gty³
 = 
IndexSequ’û
<
I
..., (
	gsizeofT
 + 
	gI
)..., 2 * sizeofT>;

7472 
	g‹m¶©e
 <
	gsize_t
... 
	gI
, 
size_t
 
	gsizeofT
>

7473 
	gDoubËSequ’û
<
	gçl£
, 
	gIndexSequ’û
<
	gI
...>, 
	gsizeofT
> {

7474 
usšg
 
	gty³
 = 
IndexSequ’û
<
I
..., (
	gsizeofT
 + 
	gI
)...>;

7479 
	g‹m¶©e
 <
size_t
 
	gN
>

7480 
	gMakeIndexSequ’û


7481 : 
DoubËSequ’û
<
N
 % 2 =ğ1, 
ty³Çme
 
	gMakeIndexSequ’û
<
	gN
 / 2>::
ty³
,

7482 
	gN
 / 2>::
ty³
 {};

7484 
	g‹m¶©e
 <>

7485 
	gMakeIndexSequ’û
<0> : 
IndexSequ’û
<> {};

7490 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gsize_t
, size_t>

7491 
	sEËmFromLi¡Im¶
 {};

7493 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gI
>

7494 
	gEËmFromLi¡Im¶
<
	gT
, 
	gI
, I> {

7495 
usšg
 
	gty³
 = 
T
;

7500 
	g‹m¶©e
 <
size_t
 
	gN
, 
ty³Çme
 
	gI
, 
	gty³Çme
... 
	gT
>

7501 
	gEËmFromLi¡
;

7503 
	g‹m¶©e
 <
size_t
 
	gN
, 
	gsize_t
... 
	gI
, 
	gty³Çme
... 
	gT
>

7504 
	gEËmFromLi¡
<
	gN
, 
	gIndexSequ’û
<
	gI
...>, 
	gT
...>

7505 : 
EËmFromLi¡Im¶
<
T
, 
	gN
, 
	gI
>... {};

7507 
	g‹m¶©e
 <
	gty³Çme
... 
	gT
>

7508 
şass
 
	gFÏtTu¶e
;

7510 
	g‹m¶©e
 <
ty³Çme
 
	gD”ived
, 
size_t
 
	gI
>

7511 
	gFÏtTu¶eEËmBa£
;

7513 
	g‹m¶©e
 <
	gty³Çme
... 
	gT
, 
size_t
 
	gI
>

7514 
	gFÏtTu¶eEËmBa£
<
	gFÏtTu¶e
<
	gT
...>, 
	gI
> {

7515 
usšg
 
	gv®ue_ty³
 =

7516 
ty³Çme
 
EËmFromLi¡
<
I
,y³Çm
	gMakeIndexSequ’û
<...(
	gT
)>::
ty³
,

7517 
	gT
...>::
ty³
;

7518 
FÏtTu¶eEËmBa£
() = ;

7519 
ex¶ic™
 
FÏtTu¶eEËmBa£
(
v®ue_ty³
 
t
è: 
v®ue
(
¡d
::
move
(t)) {}

7520 
v®ue_ty³
 
v®ue
;

7523 
	g‹m¶©e
 <
ty³Çme
 
	gD”ived
,y³Çm
	gIdx
>

7524 
	gFÏtTu¶eBa£
;

7526 
	g‹m¶©e
 <
	gsize_t
... 
	gIdx
, 
	gty³Çme
... 
	gT
>

7527 
	gFÏtTu¶eBa£
<
	gFÏtTu¶e
<
	gT
...>, 
	gIndexSequ’û
<
	gIdx
...>>

7528 : 
FÏtTu¶eEËmBa£
<
FÏtTu¶e
<
T
...>, 
	gIdx
>... {

7529 
usšg
 
	gIndiûs
 = 
IndexSequ’û
<
Idx
...>;

7530 
FÏtTu¶eBa£
() = ;

7531 
ex¶ic™
 
FÏtTu¶eBa£
(
T
... 
t
)

7532 : 
FÏtTu¶eEËmBa£
<
FÏtTu¶e
<
T
...>, 
	gIdx
>(
	g¡d
::
move
(
t
))... {}

7544 
	g‹m¶©e
 <
	gty³Çme
... 
	gT
>

7545 
şass
 
	gFÏtTu¶e


7546 : 
´iv©e
 
FÏtTu¶eBa£
<
FÏtTu¶e
<
T
...>,

7547 
ty³Çme
 
	gMakeIndexSequ’û
<...(
	gT
)>::
ty³
> {

7548 
usšg
 
Indiûs
 = 
ty³Çme
 
FÏtTu¶e
::
FÏtTu¶eBa£
::Indices;

7550 
	gpublic
:

7551 
FÏtTu¶e
() = ;

7552 
ex¶ic™
 
FÏtTu¶e
(
T
... 
t
è: FÏtTu¶e::
FÏtTu¶eBa£
(
¡d
::
move
(t)...) {}

7554 
‹m¶©e
 <
size_t
 
I
>

7555 cÚ¡ 
ty³Çme
 
EËmFromLi¡
<
I
, 
	gIndiûs
, 
	gT
...>::
ty³
& 
G‘
() const {

7556  
¡©ic_ÿ¡
<cÚ¡ 
FÏtTu¶eEËmBa£
<
FÏtTu¶e
, 
	gI
>*>(
	gthis
)->
	gv®ue
;

7559 
	g‹m¶©e
 <
size_t
 
	gI
>

7560 
ty³Çme
 
	gEËmFromLi¡
<
	gI
, 
	gIndiûs
, 
	gT
...>::
ty³
& 
G‘
() {

7561  
¡©ic_ÿ¡
<
FÏtTu¶eEËmBa£
<
FÏtTu¶e
, 
	gI
>*>(
	gthis
)->
	gv®ue
;

7567 
GTEST_INTERNAL_DEPRECATED
(

7570 
cÚ¡ex´
 
boŞ
 
In¡ªtŸ‹Te¡Ca£_P_IsD•»ÿ‹d
(è{  
	gŒue
; }

7572 
GTEST_INTERNAL_DEPRECATED
(

7575 
cÚ¡ex´
 
boŞ
 
Ty³dTe¡Ca£_P_IsD•»ÿ‹d
(è{  
	gŒue
; }

7577 
GTEST_INTERNAL_DEPRECATED
(

7580 
cÚ¡ex´
 
boŞ
 
Ty³dTe¡Ca£IsD•»ÿ‹d
(è{  
	gŒue
; }

7582 
GTEST_INTERNAL_DEPRECATED
(

7585 
cÚ¡ex´
 
boŞ
 
Regi¡”Ty³dTe¡Ca£_P_IsD•»ÿ‹d
(è{  
	gŒue
; }

7587 
GTEST_INTERNAL_DEPRECATED
(

7590 
cÚ¡ex´
 
boŞ
 
In¡ªtŸ‹Ty³dTe¡Ca£_P_IsD•»ÿ‹d
(è{  
	gŒue
; }

7595 
	#GTEST_MESSAGE_AT_
(
fe
, 
lše
, 
mes§ge
, 
»suÉ_ty³
) \

7596 ::
‹¡šg
::
š‹º®
::
	`As£¹H–³r
(
»suÉ_ty³
, 
fe
, 
lše
, 
mes§ge
) \

7597 ğ::
‹¡šg
::
	`Mes§ge
()

	)

7599 
	#GTEST_MESSAGE_
(
mes§ge
, 
»suÉ_ty³
) \

7600 
	`GTEST_MESSAGE_AT_
(
__FILE__
, 
__LINE__
, 
mes§ge
, 
»suÉ_ty³
)

	)

7602 
	#GTEST_FATAL_FAILURE_
(
mes§ge
) \

7603  
	`GTEST_MESSAGE_
(
mes§ge
, ::
‹¡šg
::
Te¡P¬tResuÉ
::
kF©®Fau»
)

	)

7605 
	#GTEST_NONFATAL_FAILURE_
(
mes§ge
) \

7606 
	`GTEST_MESSAGE_
(
mes§ge
, ::
‹¡šg
::
Te¡P¬tResuÉ
::
kNÚF©®Fau»
)

	)

7608 
	#GTEST_SUCCESS_
(
mes§ge
) \

7609 
	`GTEST_MESSAGE_
(
mes§ge
, ::
‹¡šg
::
Te¡P¬tResuÉ
::
kSucûss
)

	)

7611 
	#GTEST_SKIP_
(
mes§ge
) \

7612  
	`GTEST_MESSAGE_
(
mes§ge
, ::
‹¡šg
::
Te¡P¬tResuÉ
::
kSk
)

	)

7617 
	#GTEST_SUPPRESS_UNREACHABLE_CODE_WARNING_BELOW_
(
¡©em’t
) \

7618 ià(::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()è{ 
¡©em’t
; }

	)

7620 
	#GTEST_TEST_THROW_
(
¡©em’t
, 
ex³ùed_exû±iÚ
, 
ç
) \

7621 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

7622 ià(::
‹¡šg
::
š‹º®
::
CÚ¡Ch¬PŒ
 
g‹¡_msg
 = "") { \

7623 
boŞ
 
g‹¡_ÿught_ex³ùed
 = 
çl£
; \

7624 
Œy
 { \

7625 
	`GTEST_SUPPRESS_UNREACHABLE_CODE_WARNING_BELOW_
(
¡©em’t
); \

7627 
	`ÿtch
 (
ex³ùed_exû±iÚ
 const&) { \

7628 
g‹¡_ÿught_ex³ùed
 = 
Œue
; \

7630 
	`ÿtch
 (...) { \

7631 
g‹¡_msg
.
v®ue
 = \

7634 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_‹¡throw_
, 
__LINE__
); \

7636 ià(!
g‹¡_ÿught_ex³ùed
) { \

7637 
g‹¡_msg
.
v®ue
 = \

7640 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_‹¡throw_
, 
__LINE__
); \

7643 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_‹¡throw_
, 
__LINE__
): \

7644 
	`ç
(
g‹¡_msg
.
v®ue
)

	)

7646 
	#GTEST_TEST_NO_THROW_
(
¡©em’t
, 
ç
) \

7647 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

7648 ià(::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()) { \

7649 
Œy
 { \

7650 
	`GTEST_SUPPRESS_UNREACHABLE_CODE_WARNING_BELOW_
(
¡©em’t
); \

7652 
	`ÿtch
 (...) { \

7653 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_‹¡nÙhrow_
, 
__LINE__
); \

7656 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_‹¡nÙhrow_
, 
__LINE__
): \

7657 
	`ç
("Expected: " #statement " doesn'throw‡nƒxception.\n" \

7658 " Aùu®: iˆthrows.")

	)

7660 
	#GTEST_TEST_ANY_THROW_
(
¡©em’t
, 
ç
) \

7661 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

7662 ià(::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()) { \

7663 
boŞ
 
g‹¡_ÿught_ªy
 = 
çl£
; \

7664 
Œy
 { \

7665 
	`GTEST_SUPPRESS_UNREACHABLE_CODE_WARNING_BELOW_
(
¡©em’t
); \

7667 
	`ÿtch
 (...) { \

7668 
g‹¡_ÿught_ªy
 = 
Œue
; \

7670 ià(!
g‹¡_ÿught_ªy
) { \

7671 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_‹¡ªythrow_
, 
__LINE__
); \

7674 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_‹¡ªythrow_
, 
__LINE__
): \

7675 
	`ç
("Expected: " #statement "hrows‡nƒxception.\n" \

7676 " Aùu®: iˆdÛ¢'t.")

	)

7682 
	#GTEST_TEST_BOOLEAN_
(
ex´essiÚ
, 
‹xt
, 
aùu®
, 
ex³ùed
, 
ç
) \

7683 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

7684 ià(cÚ¡ ::
‹¡šg
::
As£¹iÚResuÉ
 
g‹¡_¬_
 = \

7685 ::
‹¡šg
::
	`As£¹iÚResuÉ
(
ex´essiÚ
)) \

7688 
	`ç
(::
‹¡šg
::
š‹º®
::
	`G‘BoŞAs£¹iÚFau»Mes§ge
(\

7689 
g‹¡_¬_
, 
‹xt
, #aùu®, #ex³ùed).
	`c_¡r
())

	)

7691 
	#GTEST_TEST_NO_FATAL_FAILURE_
(
¡©em’t
, 
ç
) \

7692 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

7693 ià(::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()) { \

7694 ::
‹¡šg
::
š‹º®
::
HasNewF©®Fau»H–³r
 
g‹¡_çl_çu»_check”
; \

7695 
	`GTEST_SUPPRESS_UNREACHABLE_CODE_WARNING_BELOW_
(
¡©em’t
); \

7696 ià(
g‹¡_çl_çu»_check”
.
	`has_Ãw_çl_çu»
()) { \

7697 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_‹¡noçl_
, 
__LINE__
); \

7700 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_‹¡noçl_
, 
__LINE__
): \

7701 
	`ç
("Expected: " #statement " doesn't generate‚ew fatal " \

7703 " Aùu®: iˆdÛs.")

	)

7706 
	#GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, 
‹¡_Çme
) \

7707 
‹¡_su™e_Çme
##
_
##
‹¡_Çme
##
_Te¡


	)

7710 
	#GTEST_TEST_
(
‹¡_su™e_Çme
, 
‹¡_Çme
, 
·»Á_şass
, 
·»Á_id
) \

7711 
	`¡©ic_as£¹
((
	`GTEST_STRINGIFY_
(
‹¡_su™e_Çme
)) > 1, \

7713 
	`¡©ic_as£¹
((
	`GTEST_STRINGIFY_
(
‹¡_Çme
)) > 1, \

7715 
şass
 
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, 
‹¡_Çme
) \

7716 : 
public
 
·»Á_şass
 { \

7717 
public
: \

7718 
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, 
‹¡_Çme
)() {} \

7720 
´iv©e
: \

7721 
vœtu®
 
	`Te¡Body
(); \

7722 ::
‹¡šg
::
Te¡Info
* cÚ¡ 
‹¡_šfo_
 
GTEST_ATTRIBUTE_UNUSED_
; \

7723 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, \

7724 
‹¡_Çme
)); \

7727 ::
‹¡šg
::
Te¡Info
* cÚ¡ 
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, \

7728 
‹¡_Çme
)::
‹¡_šfo_
 = \

7729 ::
‹¡šg
::
š‹º®
::
	`MakeAndRegi¡”Te¡Info
( \

7730 #‹¡_su™e_Çme, #‹¡_Çme, 
nuÎ±r
,‚ullptr, \

7731 ::
‹¡šg
::
š‹º®
::
	`CodeLoÿtiÚ
(
__FILE__
, 
__LINE__
), (
·»Á_id
), \

7732 ::
‹¡šg
::
š‹º®
::
Su™eApiResŞv”
< \

7733 
·»Á_şass
>::
	`G‘S‘UpCa£OrSu™e
(
__FILE__
, 
__LINE__
), \

7734 ::
‹¡šg
::
š‹º®
::
Su™eApiResŞv”
< \

7735 
·»Á_şass
>::
	`G‘T—rDownCa£OrSu™e
(
__FILE__
, 
__LINE__
), \

7736 
Ãw
 ::
‹¡šg
::
š‹º®
::
Te¡FaùÜyIm¶
<
	`GTEST_TEST_CLASS_NAME_
( \

7737 
‹¡_su™e_Çme
, 
‹¡_Çme
)>); \

7738 
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, 
‹¡_Çme
)::
	`Te¡Body
()

	)

7778 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_DEATH_TEST_H_


7779 
	#GTEST_INCLUDE_GTEST_GTEST_DEATH_TEST_H_


	)

7816 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_GTEST_DEATH_TEST_INTERNAL_H_


7817 
	#GTEST_INCLUDE_GTEST_INTERNAL_GTEST_DEATH_TEST_INTERNAL_H_


	)

7857 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_MATCHERS_H_


7858 
	#GTEST_INCLUDE_GTEST_GTEST_MATCHERS_H_


	)

7860 
	~<memÜy
>

7861 
	~<o¡»am
>

7862 
	~<¡ršg
>

7863 
	~<ty³_Œa™s
>

7964 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_PRINTERS_H_


7965 
	#GTEST_INCLUDE_GTEST_GTEST_PRINTERS_H_


	)

7967 
	~<funùiÚ®
>

7968 
	~<o¡»am
>

7969 
	~<s¡»am
>

7970 
	~<¡ršg
>

7971 
	~<tu¶e
>

7972 
	~<ty³_Œa™s
>

7973 
	~<ut™y
>

7974 
	~<veùÜ
>

7976 #ià
GTEST_HAS_ABSL


7977 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

7978 
	~"ab¦/ty³s/İtiÚ®.h
"

7979 
	~"ab¦/ty³s/v¬ŸÁ.h
"

7982 
Çme¥aû
 
	g‹¡šg
 {

7986 
Çme¥aû
 
	gš‹º®2
 {

7990 
GTEST_API_
 
PrštBy‹sInObjeùTo
(cÚ¡ * 
obj_by‹s
,

7991 
size_t
 
couÁ
,

7992 ::
¡d
::
o¡»am
* 
os
);

7996 
	eTy³Kšd
 {

7997 
	gkPrÙobuf
,

7998 
	gkCÚv”tibËToIÁeg”
,

8000 #ià
GTEST_HAS_ABSL


8001 
	gkCÚv”tibËToSŒšgV›w
,

8004 
	gkOth”Ty³


8011 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
Ty³Kšd
 
	gkTy³Kšd
>

8012 şas 
	cTy³W™houtFÜm©‹r
 {

8013 
	gpublic
:

8015 
PrštV®ue
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8016 
PrštBy‹sInObjeùTo
(

8017 
¡©ic_ÿ¡
<const *>(

8018 
»š‹½»t_ÿ¡
<cÚ¡ *>(
¡d
::
add»ssof
(
v®ue
))),

8019 (
v®ue
), 
os
);

8026 cÚ¡ 
size_t
 
	gkPrÙobufOÃLš”MaxL’gth
 = 50;

8028 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8029 
şass
 
	gTy³W™houtFÜm©‹r
<
	gT
, 
	gkPrÙobuf
> {

8030 
	gpublic
:

8031 
PrštV®ue
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8032 
¡d
::
¡ršg
 
´‘ty_¡r
 = 
v®ue
.
ShÜtDebugSŒšg
();

8033 ià(
	g´‘ty_¡r
.
Ëngth
(è> 
	gkPrÙobufOÃLš”MaxL’gth
) {

8034 
	g´‘ty_¡r
 = "\n" + 
v®ue
.
DebugSŒšg
();

8036 *
	gos
 << ("<" + 
	g´‘ty_¡r
 + ">");

8040 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8041 
şass
 
	gTy³W™houtFÜm©‹r
<
	gT
, 
	gkCÚv”tibËToIÁeg”
> {

8042 
	gpublic
:

8050 
PrštV®ue
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8051 cÚ¡ 
š‹º®
::
Bigge¡IÁ
 
kBigIÁ
 = 
v®ue
;

8052 *
	gos
 << 
	gkBigIÁ
;

8056 #ià
GTEST_HAS_ABSL


8057 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8058 
şass
 
	gTy³W™houtFÜm©‹r
<
	gT
, 
	gkCÚv”tibËToSŒšgV›w
> {

8059 
	gpublic
:

8065 
PrštV®ue
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
);

8093 
	g‹m¶©e
 <
ty³Çme
 
	gCh¬
,y³Çm
	gCh¬T¿™s
,y³Çm
	gT
>

8094 ::
¡d
::
basic_o¡»am
<
Ch¬
, 
	gCh¬T¿™s
>& 
	gİ”©Ü
<<(

8095 ::
¡d
::
basic_o¡»am
<
Ch¬
, 
	gCh¬T¿™s
>& 
	gos
, cÚ¡ 
	gT
& 
	gx
) {

8096 
	gTy³W™houtFÜm©‹r
<
	gT
, (
	gš‹º®
::
IsAPrÙocŞMes§ge
<
T
>::
v®ue


8097 ? 
kPrÙobuf


8098 : 
¡d
::
is_cÚv”tibË
<

8099 cÚ¡ 
T
&, 
	gš‹º®
::
Bigge¡IÁ
>::
v®ue


8100 ? 
kCÚv”tibËToIÁeg”


8102 #ià
GTEST_HAS_ABSL


8103 
¡d
::
is_cÚv”tibË
<

8104 cÚ¡ 
T
&, 
	gab¦
::
¡ršg_v›w
>::
v®ue


8105 ? 
kCÚv”tibËToSŒšgV›w


8108 
kOth”Ty³
)>::
PrštV®ue
(
x
, &
os
);

8109  
	gos
;

8117 
Çme¥aû
 
	g‹¡šg_š‹º®
 {

8121 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8122 
DeçuÉPrštNÚCÚš”To
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8134 
usšg
 
Çme¥aû
 ::
‹¡šg
::
š‹º®2
;

8149 *
	gos
 << 
	gv®ue
;

8154 
Çme¥aû
 
	g‹¡šg
 {

8155 
Çme¥aû
 
	gš‹º®
 {

8172 
	g‹m¶©e
 <
ty³Çme
 
	gToPršt
,y³Çm
	gOth”O³¿nd
>

8173 şas 
	cFÜm©FÜCom·risÚ
 {

8174 
	gpublic
:

8175 ::
¡d
::
¡ršg
 
FÜm©
(cÚ¡ 
ToPršt
& 
v®ue
) {

8176  ::
‹¡šg
::
PrštToSŒšg
(
v®ue
);

8181 
	g‹m¶©e
 <
ty³Çme
 
	gToPršt
, 
size_t
 
	gN
,y³Çm
	gOth”O³¿nd
>

8182 
şass
 
	gFÜm©FÜCom·risÚ
<
	gToPršt
[
N
], 
	gOth”O³¿nd
> {

8183 
	gpublic
:

8184 ::
¡d
::
¡ršg
 
FÜm©
(cÚ¡ 
ToPršt
* 
v®ue
) {

8185  
FÜm©FÜCom·risÚ
<cÚ¡ 
ToPršt
*, 
	gOth”O³¿nd
>::
FÜm©
(
v®ue
);

8192 
	#GTEST_IMPL_FORMAT_C_STRING_AS_POINTER_
(
Ch¬Ty³
) \

8193 
‹m¶©e
 <
ty³Çme
 
Oth”O³¿nd
> \

8194 
şass
 
FÜm©FÜCom·risÚ
<
Ch¬Ty³
*, 
Oth”O³¿nd
> { \

8195 
public
: \

8196 ::
¡d
::
¡ršg
 
	`FÜm©
(
Ch¬Ty³
* 
v®ue
) { \

8197  ::
‹¡šg
::
	`PrštToSŒšg
(
¡©ic_ÿ¡
<cÚ¡ *>(
v®ue
)); \

8199 }

	)

8201 
GTEST_IMPL_FORMAT_C_STRING_AS_POINTER_
();

8202 
GTEST_IMPL_FORMAT_C_STRING_AS_POINTER_
(const );

8203 
GTEST_IMPL_FORMAT_C_STRING_AS_POINTER_
(
wch¬_t
);

8204 
GTEST_IMPL_FORMAT_C_STRING_AS_POINTER_
(cÚ¡ 
wch¬_t
);

8206 #undeà
GTEST_IMPL_FORMAT_C_STRING_AS_POINTER_


8211 
	#GTEST_IMPL_FORMAT_C_STRING_AS_STRING_
(
Ch¬Ty³
, 
Oth”SŒšgTy³
) \

8212 
‹m¶©e
 <> \

8213 
şass
 
FÜm©FÜCom·risÚ
<
Ch¬Ty³
*, 
Oth”SŒšgTy³
> { \

8214 
public
: \

8215 ::
¡d
::
¡ršg
 
	`FÜm©
(
Ch¬Ty³
* 
v®ue
) { \

8216  ::
‹¡šg
::
	`PrštToSŒšg
(
v®ue
); \

8218 }

	)

8220 
GTEST_IMPL_FORMAT_C_STRING_AS_STRING_
(, ::
¡d
::
¡ršg
);

8221 
GTEST_IMPL_FORMAT_C_STRING_AS_STRING_
(cÚ¡ , ::
¡d
::
¡ršg
);

8223 #ià
GTEST_HAS_STD_WSTRING


8224 
GTEST_IMPL_FORMAT_C_STRING_AS_STRING_
(
wch¬_t
, ::
¡d
::
w¡ršg
);

8225 
GTEST_IMPL_FORMAT_C_STRING_AS_STRING_
(cÚ¡ 
wch¬_t
, ::
¡d
::
w¡ršg
);

8228 #undeà
GTEST_IMPL_FORMAT_C_STRING_AS_STRING_


8238 
	g‹m¶©e
 <
ty³Çme
 
	gT1
,y³Çm
	gT2
>

8239 
	g¡d
::
¡ršg
 
FÜm©FÜCom·risÚFau»Mes§ge
(

8240 cÚ¡ 
T1
& 
v®ue
, cÚ¡ 
T2
& ) {

8241  
	gFÜm©FÜCom·risÚ
<
	gT1
, 
	gT2
>::
FÜm©
(
v®ue
);

8251 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8252 
şass
 
	gUniv”§lPrš‹r
;

8254 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8255 
Univ”§lPršt
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
);

8257 
	eDeçuÉPrš‹rTy³
 {

8258 
	gkPrštCÚš”
,

8259 
	gkPrštPoš‹r
,

8260 
	gkPrštFunùiÚPoš‹r
,

8261 
	gkPrštOth”
,

8263 
	g‹m¶©e
 <
DeçuÉPrš‹rTy³
 
	gty³
> 
	sW¿pPrš‹rTy³
 {};

8267 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

8268 
DeçuÉPrštTo
(
W¿pPrš‹rTy³
<
kPrštCÚš”
> ,

8269 cÚ¡ 
C
& 
cÚš”
, ::
¡d
::
o¡»am
* 
os
) {

8270 cÚ¡ 
size_t
 
kMaxCouÁ
 = 32;

8271 *
	gos
 << '{';

8272 
size_t
 
	gcouÁ
 = 0;

8273 
ty³Çme
 
	gC
::
cÚ¡_™”©Ü
 
™
 = 
cÚš”
.
begš
();

8274 
	g™
 !ğ
cÚš”
.
’d
(); ++™, ++
	gcouÁ
) {

8275 ià(
	gcouÁ
 > 0) {

8276 *
	gos
 << ',';

8277 ià(
	gcouÁ
 =ğ
kMaxCouÁ
) {

8278 *
os
 << " ...";

8282 *
	gos
 << ' ';

8285 
	gš‹º®
::
Univ”§lPršt
(*
™
, 
os
);

8288 ià(
	gcouÁ
 > 0) {

8289 *
	gos
 << ' ';

8291 *
	gos
 << '}';

8300 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8301 
DeçuÉPrštTo
(
W¿pPrš‹rTy³
<
kPrštPoš‹r
> ,

8302 
T
* 
p
, ::
¡d
::
o¡»am
* 
os
) {

8303 ià(
p
 =ğ
nuÎ±r
) {

8304 *
os
 << "NULL";

8309 *
	gos
 << 
	gp
;

8312 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8313 
DeçuÉPrštTo
(
W¿pPrš‹rTy³
<
kPrštFunùiÚPoš‹r
> ,

8314 
T
* 
p
, ::
¡d
::
o¡»am
* 
os
) {

8315 ià(
p
 =ğ
nuÎ±r
) {

8316 *
os
 << "NULL";

8321 *
	gos
 << 
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	gp
);

8327 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8328 
DeçuÉPrštTo
(
W¿pPrš‹rTy³
<
kPrštOth”
> ,

8329 cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8330 ::
‹¡šg_š‹º®
::
DeçuÉPrštNÚCÚš”To
(
v®ue
, 
os
);

8344 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8345 
PrštTo
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8365 
DeçuÉPrštTo
(

8366 
W¿pPrš‹rTy³
 <

8367 ((
IsCÚš”Te¡
<
T
>(0)è=ğ(
IsCÚš”
)) &&

8368 !
IsRecursiveCÚš”
<
T
>::
v®ue


8369 ? 
kPrštCÚš”


8370 : !
¡d
::
is_poš‹r
<
T
>::
v®ue


8371 ? 
kPrštOth”


8372 : 
¡d
::
is_funùiÚ
<
ty³Çme
 std::
»move_poš‹r
<
T
>::
ty³
>::
v®ue


8373 ? 
kPrštFunùiÚPoš‹r


8374 : 
kPrštPoš‹r
 > (),

8375 
v®ue
, 
os
);

8383 
GTEST_API_
 
PrštTo
(
c
, ::
¡d
::
o¡»am
* 
os
);

8384 
GTEST_API_
 
PrštTo
(sigÃd 
c
, ::
¡d
::
o¡»am
* 
os
);

8385 
šlše
 
PrštTo
(
c
, ::
¡d
::
o¡»am
* 
os
) {

8389 
PrštTo
(
¡©ic_ÿ¡
<>(
c
), 
os
);

8393 
šlše
 
PrštTo
(
boŞ
 
x
, ::
¡d
::
o¡»am
* 
os
) {

8394 *
os
 << (
x
 ? "true" : "false");

8404 
GTEST_API_
 
PrštTo
(
wch¬_t
 
wc
, ::
¡d
::
o¡»am
* 
os
);

8407 
GTEST_API_
 
PrštTo
(cÚ¡ * 
s
, ::
¡d
::
o¡»am
* 
os
);

8408 
šlše
 
PrštTo
(* 
s
, ::
¡d
::
o¡»am
* 
os
) {

8409 
PrštTo
(
Im¶ic™Ca¡_
<cÚ¡ *>(
s
), 
os
);

8414 
šlše
 
PrštTo
(cÚ¡ sigÃd * 
s
, ::
¡d
::
o¡»am
* 
os
) {

8415 
PrštTo
(
Im¶ic™Ca¡_
<cÚ¡ *>(
s
), 
os
);

8417 
šlše
 
PrštTo
(sigÃd * 
s
, ::
¡d
::
o¡»am
* 
os
) {

8418 
PrštTo
(
Im¶ic™Ca¡_
<cÚ¡ *>(
s
), 
os
);

8420 
šlše
 
PrštTo
(cÚ¡ * 
s
, ::
¡d
::
o¡»am
* 
os
) {

8421 
PrštTo
(
Im¶ic™Ca¡_
<cÚ¡ *>(
s
), 
os
);

8423 
šlše
 
PrštTo
(* 
s
, ::
¡d
::
o¡»am
* 
os
) {

8424 
PrštTo
(
Im¶ic™Ca¡_
<cÚ¡ *>(
s
), 
os
);

8432 #ià!
defšed
(
_MSC_VER
è|| defšed(
_NATIVE_WCHAR_T_DEFINED
)

8434 
GTEST_API_
 
PrštTo
(cÚ¡ 
wch¬_t
* 
s
, ::
¡d
::
o¡»am
* 
os
);

8435 
šlše
 
PrštTo
(
wch¬_t
* 
s
, ::
¡d
::
o¡»am
* 
os
) {

8436 
PrštTo
(
Im¶ic™Ca¡_
<cÚ¡ 
wch¬_t
*>(
s
), 
os
);

8445 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8446 
PrštRawA¼ayTo
(cÚ¡ 
T
 
a
[], 
size_t
 
couÁ
, ::
¡d
::
o¡»am
* 
os
) {

8447 
Univ”§lPršt
(
a
[0], 
os
);

8448 
size_t
 
	gi
 = 1; i !ğ
couÁ
; i++) {

8449 *
	gos
 << ", ";

8450 
Univ”§lPršt
(
a
[
i
], 
os
);

8455 
GTEST_API_
 
PrštSŒšgTo
(cÚ¡ ::
¡d
::
¡ršg
&
s
, ::¡d::
o¡»am
* 
os
);

8456 
šlše
 
PrštTo
(cÚ¡ ::
¡d
::
¡ršg
& 
s
, ::¡d::
o¡»am
* 
os
) {

8457 
PrštSŒšgTo
(
s
, 
os
);

8461 #ià
GTEST_HAS_STD_WSTRING


8462 
GTEST_API_
 
PrštWideSŒšgTo
(cÚ¡ ::
¡d
::
w¡ršg
&
s
, ::¡d::
o¡»am
* 
os
);

8463 
šlše
 
PrštTo
(cÚ¡ ::
¡d
::
w¡ršg
& 
s
, ::¡d::
o¡»am
* 
os
) {

8464 
PrštWideSŒšgTo
(
s
, 
os
);

8468 #ià
GTEST_HAS_ABSL


8470 
šlše
 
PrštTo
(
ab¦
::
¡ršg_v›w
 
¥
, ::
¡d
::
o¡»am
* 
os
) {

8471 
PrštTo
(::
¡d
::
¡ršg
(
¥
), 
os
);

8475 
šlše
 
PrštTo
(
¡d
::
nuÎ±r_t
, ::¡d::
o¡»am
* 
os
) { *os << "(nullptr)"; }

8477 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8478 
PrštTo
(
¡d
::
»ã»nû_w¿µ”
<
T
> 
»f
, ::¡d::
o¡»am
* 
os
) {

8479 
Univ”§lPrš‹r
<
T
&>::
Pršt
(
»f
.
g‘
(), 
os
);

8484 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8485 
PrštTu¶eTo
(cÚ¡ 
T
&, 
¡d
::
š‹g¿l_cÚ¡ªt
<
size_t
, 0>,

8486 ::
¡d
::
o¡»am
*) {}

8488 
‹m¶©e
 <
ty³Çme
 
T
, 
size_t
 
	gI
>

8489 
PrštTu¶eTo
(cÚ¡ 
T
& 
t
, 
¡d
::
š‹g¿l_cÚ¡ªt
<
size_t
, 
I
>,

8490 ::
¡d
::
o¡»am
* 
os
) {

8491 
PrštTu¶eTo
(
t
, 
¡d
::
š‹g¿l_cÚ¡ªt
<
size_t
, 
I
 - 1>(), 
os
);

8492 
GTEST_INTENTIONAL_CONST_COND_PUSH_
()

8493 ià(
	gI
 > 1) {

8494 
GTEST_INTENTIONAL_CONST_COND_POP_
()

8495 *
	gos
 << ", ";

8497 
	gUniv”§lPrš‹r
<
ty³Çme
 
	g¡d
::
tu¶e_–em’t
<
I
 - 1, 
	gT
>::
ty³
>::
Pršt
(

8498 
¡d
::
g‘
<
I
 - 1>(
t
), 
os
);

8501 
	g‹m¶©e
 <
	gty³Çme
... 
	gTy³s
>

8502 
PrštTo
(cÚ¡ ::
¡d
::
tu¶e
<
Ty³s
...>& 
t
, ::¡d::
o¡»am
* 
os
) {

8503 *
os
 << "(";

8504 
PrštTu¶eTo
(
t
, 
¡d
::
š‹g¿l_cÚ¡ªt
<
size_t
, ...(
Ty³s
)>(), 
os
);

8505 *
	gos
 << ")";

8509 
	g‹m¶©e
 <
ty³Çme
 
	gT1
,y³Çm
	gT2
>

8510 
PrštTo
(cÚ¡ ::
¡d
::
·œ
<
T1
, 
T2
>& 
v®ue
, ::¡d::
o¡»am
* 
os
) {

8511 *
os
 << '(';

8514 
	gUniv”§lPrš‹r
<
	gT1
>::
Pršt
(
v®ue
.
fœ¡
, 
os
);

8515 *
	gos
 << ", ";

8516 
	gUniv”§lPrš‹r
<
	gT2
>::
Pršt
(
v®ue
.
£cÚd
, 
os
);

8517 *
	gos
 << ')';

8522 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8523 şas 
	cUniv”§lPrš‹r
 {

8524 
	gpublic
:

8527 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4180)

8532 
Pršt
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8541 
PrštTo
(
v®ue
, 
os
);

8544 
GTEST_DISABLE_MSC_WARNINGS_POP_
()

8547 #ià
GTEST_HAS_ABSL


8551 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8552 
şass
 
	gUniv”§lPrš‹r
<::
ab¦
::
İtiÚ®
<
T
>> {

8553 
public
:

8554 
Pršt
(cÚ¡ ::
ab¦
::
İtiÚ®
<
T
>& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8555 *
os
 << '(';

8556 ià(!
	gv®ue
) {

8557 *
	gos
 << "nullopt";

8559 
Univ”§lPršt
(*
v®ue
, 
os
);

8561 *
	gos
 << ')';

8567 
	g‹m¶©e
 <
	gty³Çme
... 
	gT
>

8568 
şass
 
	gUniv”§lPrš‹r
<::
ab¦
::
v¬ŸÁ
<
T
...>> {

8569 
public
:

8570 
Pršt
(cÚ¡ ::
ab¦
::
v¬ŸÁ
<
T
...>& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8571 *
os
 << '(';

8572 
	gab¦
::
vis™
(
Vis™Ü
{
os
}, 
v®ue
);

8573 *
	gos
 << ')';

8576 
	g´iv©e
:

8577 
	sVis™Ü
 {

8578 
‹m¶©e
 <
ty³Çme
 
U
>

8579 
İ”©Ü
()(cÚ¡ 
U
& 
u
) const {

8580 *
os
 << "'" << 
G‘Ty³Name
<
U
>() << "' with value ";

8581 
Univ”§lPršt
(
u
, 
os
);

8583 ::
¡d
::
o¡»am
* 
os
;

8591 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8592 
Univ”§lPrštA¼ay
(cÚ¡ 
T
* 
begš
, 
size_t
 
Ën
, ::
¡d
::
o¡»am
* 
os
) {

8593 ià(
Ën
 == 0) {

8594 *
os
 << "{}";

8596 *
	gos
 << "{ ";

8597 cÚ¡ 
size_t
 
	gkTh»shŞd
 = 18;

8598 cÚ¡ 
size_t
 
	gkChunkSize
 = 8;

8602 ià(
	gËn
 <ğ
kTh»shŞd
) {

8603 
PrštRawA¼ayTo
(
begš
, 
Ën
, 
os
);

8605 
PrštRawA¼ayTo
(
begš
, 
kChunkSize
, 
os
);

8606 *
	gos
 << ", ..., ";

8607 
PrštRawA¼ayTo
(
begš
 + 
Ën
 - 
kChunkSize
, kChunkSize, 
os
);

8609 *
	gos
 << " }";

8613 
GTEST_API_
 
Univ”§lPrštA¼ay
(

8614 cÚ¡ * 
begš
, 
size_t
 
Ën
, ::
¡d
::
o¡»am
* 
os
);

8617 
GTEST_API_
 
Univ”§lPrštA¼ay
(

8618 cÚ¡ 
wch¬_t
* 
begš
, 
size_t
 
Ën
, ::
¡d
::
o¡»am
* 
os
);

8621 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gN
>

8622 
şass
 
	gUniv”§lPrš‹r
<
	gT
[
N
]> {

8623 
	gpublic
:

8626 
Pršt
(cÚ¡ 
T
 (&
a
)[
N
], ::
¡d
::
o¡»am
* 
os
) {

8627 
Univ”§lPrštA¼ay
(
a
, 
N
, 
os
);

8632 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8633 
şass
 
	gUniv”§lPrš‹r
<
	gT
&> {

8634 
	gpublic
:

8637 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4180)

8639 
Pršt
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8642 *
os
 << "@" << 
»š‹½»t_ÿ¡
<cÚ¡ *>(&
v®ue
) << " ";

8645 
Univ”§lPršt
(
v®ue
, 
os
);

8648 
GTEST_DISABLE_MSC_WARNINGS_POP_
()

8655 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8656 şas 
	cUniv”§lT”£Prš‹r
 {

8657 
	gpublic
:

8658 
Pršt
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8659 
Univ”§lPršt
(
v®ue
, 
os
);

8662 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8663 
şass
 
	gUniv”§lT”£Prš‹r
<
	gT
&> {

8664 
	gpublic
:

8665 
Pršt
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8666 
Univ”§lPršt
(
v®ue
, 
os
);

8669 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gN
>

8670 
şass
 
	gUniv”§lT”£Prš‹r
<
	gT
[
N
]> {

8671 
	gpublic
:

8672 
Pršt
(cÚ¡ 
T
 (&
v®ue
)[
N
], ::
¡d
::
o¡»am
* 
os
) {

8673 
Univ”§lPrš‹r
<
T
[
N
]>::
Pršt
(
v®ue
, 
os
);

8676 
	g‹m¶©e
 <>

8677 
şass
 
	gUniv”§lT”£Prš‹r
<const *> {

8678 
	gpublic
:

8679 
Pršt
(cÚ¡ * 
¡r
, ::
¡d
::
o¡»am
* 
os
) {

8680 ià(
¡r
 =ğ
nuÎ±r
) {

8681 *
os
 << "NULL";

8683 
Univ”§lPršt
(
¡d
::
¡ršg
(
¡r
), 
os
);

8687 
	g‹m¶©e
 <>

8688 
şass
 
	gUniv”§lT”£Prš‹r
<*> {

8689 
	gpublic
:

8690 
Pršt
(* 
¡r
, ::
¡d
::
o¡»am
* 
os
) {

8691 
Univ”§lT”£Prš‹r
<cÚ¡ *>::
Pršt
(
¡r
, 
os
);

8695 #ià
GTEST_HAS_STD_WSTRING


8696 
	g‹m¶©e
 <>

8697 
şass
 
	gUniv”§lT”£Prš‹r
<cÚ¡ 
	gwch¬_t
*> {

8698 
	gpublic
:

8699 
Pršt
(cÚ¡ 
wch¬_t
* 
¡r
, ::
¡d
::
o¡»am
* 
os
) {

8700 ià(
¡r
 =ğ
nuÎ±r
) {

8701 *
os
 << "NULL";

8703 
Univ”§lPršt
(::
¡d
::
w¡ršg
(
¡r
), 
os
);

8709 
	g‹m¶©e
 <>

8710 
şass
 
	gUniv”§lT”£Prš‹r
<
	gwch¬_t
*> {

8711 
	gpublic
:

8712 
Pršt
(
wch¬_t
* 
¡r
, ::
¡d
::
o¡»am
* 
os
) {

8713 
Univ”§lT”£Prš‹r
<cÚ¡ 
wch¬_t
*>::
Pršt
(
¡r
, 
os
);

8717 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8718 
Univ”§lT”£Pršt
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8719 
Univ”§lT”£Prš‹r
<
T
>::
Pršt
(
v®ue
, 
os
);

8726 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8727 
Univ”§lPršt
(cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8730 
T
 
	tT1
;

8731 
	gUniv”§lPrš‹r
<
	gT1
>::
Pršt
(
v®ue
, 
os
);

8734 ::
¡d
::
	tveùÜ
< ::
	t¡d
::
	t¡ršg
> 
	tSŒšgs
;

8738 
	g‹m¶©e
 <
ty³Çme
 
	gTu¶e
>

8739 
T”£PrštP»fixToSŒšgs
(cÚ¡ 
Tu¶e
&, 
¡d
::
š‹g¿l_cÚ¡ªt
<
size_t
, 0>,

8740 
SŒšgs
*) {}

8741 
	g‹m¶©e
 <
ty³Çme
 
	gTu¶e
, 
size_t
 
	gI
>

8742 
T”£PrštP»fixToSŒšgs
(cÚ¡ 
Tu¶e
& 
t
,

8743 
¡d
::
š‹g¿l_cÚ¡ªt
<
size_t
, 
I
>,

8744 
SŒšgs
* 
¡ršgs
) {

8745 
T”£PrštP»fixToSŒšgs
(
t
, 
¡d
::
š‹g¿l_cÚ¡ªt
<
size_t
, 
I
 - 1>(),

8746 
¡ršgs
);

8747 ::
¡d
::
¡ršg¡»am
 
ss
;

8748 
Univ”§lT”£Pršt
(
¡d
::
g‘
<
I
 - 1>(
t
), &
ss
);

8749 
	g¡ršgs
->
push_back
(
ss
.
¡r
());

8755 
	g‹m¶©e
 <
ty³Çme
 
	gTu¶e
>

8756 
SŒšgs
 
Univ”§lT”£PrštTu¶eF›ldsToSŒšgs
(cÚ¡ 
Tu¶e
& 
v®ue
) {

8757 
SŒšgs
 
	g»suÉ
;

8758 
T”£PrštP»fixToSŒšgs
(

8759 
v®ue
, 
¡d
::
š‹g¿l_cÚ¡ªt
<
size_t
, std::
tu¶e_size
<
Tu¶e
>::value>(),

8760 &
»suÉ
);

8761  
	g»suÉ
;

8766 #ià
GTEST_HAS_ABSL


8767 
Çme¥aû
 
	gš‹º®2
 {

8768 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8769 
	gTy³W™houtFÜm©‹r
<
	gT
, 
	gkCÚv”tibËToSŒšgV›w
>::
PrštV®ue
(

8770 cÚ¡ 
T
& 
v®ue
, ::
¡d
::
o¡»am
* 
os
) {

8771 
š‹º®
::
PrštTo
(
ab¦
::
¡ršg_v›w
(
v®ue
), 
os
);

8776 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8777 ::
¡d
::
¡ršg
 
	$PrštToSŒšg
(cÚ¡ 
T
& 
v®ue
) {

8778 ::
¡d
::
¡ršg¡»am
 
ss
;

8779 
š‹º®
::
Univ”§lT”£Prš‹r
<
T
>::
	`Pršt
(
v®ue
, &
ss
);

8780  
ss
.
	`¡r
();

8781 
	}
}

8826 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_CUSTOM_GTEST_PRINTERS_H_


8827 
	#GTEST_INCLUDE_GTEST_INTERNAL_CUSTOM_GTEST_PRINTERS_H_


	)

8834 #ià
defšed
(
_MSC_VER
) && _MSC_VER >= 1915

8835 
	#GTEST_MAYBE_5046_
 5046

	)

8837 
	#GTEST_MAYBE_5046_


	)

8840 
	$GTEST_DISABLE_MSC_WARNINGS_PUSH_
(

8841 4251 
GTEST_MAYBE_5046_


8845 
Çme¥aû
 
‹¡šg
 {

8862 şas 
	cM©chResuÉLi¡’”
 {

8863 
public
:

8867 
ex¶ic™
 
	`M©chResuÉLi¡’”
(::
¡d
::
o¡»am
* 
os
è: 
	`¡»am_
(os) {}

8868 
vœtu®
 ~
	`M©chResuÉLi¡’”
() = 0;

8872 
‹m¶©e
 <
ty³Çme
 
T
>

8873 
M©chResuÉLi¡’”
& 
İ”©Ü
<<(cÚ¡ 
T
& 
x
) {

8874 ià(
¡»am_
 !ğ
nuÎ±r
è*¡»am_ << 
x
;

8875  *
this
;

8879 ::
¡d
::
o¡»am
* 
	`¡»am
(è{  
¡»am_
; }

8885 
boŞ
 
	`IsIÁ”e¡ed
(ècÚ¡ {  
¡»am_
 !ğ
nuÎ±r
; }

8887 
´iv©e
:

8888 ::
¡d
::
o¡»am
* cÚ¡ 
¡»am_
;

8890 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
M©chResuÉLi¡’”
);

8891 
	}
};

8893 
šlše
 
	gM©chResuÉLi¡’”
::~
	$M©chResuÉLi¡’”
() {

8894 
	}
}

8898 şas 
	cM©ch”Desüib”IÁ”çû
 {

8899 
public
:

8900 
vœtu®
 ~
M©ch”Desüib”IÁ”çû
() {}

8907 
vœtu®
 
DesüibeTo
(::
¡d
::
o¡»am
* 
os
) const = 0;

8915 
vœtu®
 
DesüibeNeg©iÚTo
(::
¡d
::
o¡»am
* 
os
) const {

8916 *
os
 << "not (";

8917 
DesüibeTo
(
os
);

8918 *
	gos
 << ")";

8923 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8924 şas 
	cM©ch”IÁ”çû
 : 
public
 
M©ch”Desüib”IÁ”çû
 {

8925 
public
:

8957 
vœtu®
 
boŞ
 
M©chAndEx¶aš
(
T
 
x
, 
M©chResuÉLi¡’”
* 
li¡’”
) const = 0;

8964 
Çme¥aû
 
	gš‹º®
 {

8967 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8968 
şass
 
	gM©ch”IÁ”çûAd­‹r
 : 
public
 
M©ch”IÁ”çû
<cÚ¡ 
T
&> {

8969 
public
:

8970 
ex¶ic™
 
M©ch”IÁ”çûAd­‹r
(cÚ¡ 
M©ch”IÁ”çû
<
T
>* 
im¶
)

8971 : 
im¶_
(
im¶
) {}

8972 ~
M©ch”IÁ”çûAd­‹r
(è
ov”ride
 { 
d–‘e
 
im¶_
; }

8974 
DesüibeTo
(::
¡d
::
o¡»am
* 
os
ècÚ¡ 
ov”ride
 { 
im¶_
->DescribeTo(os); }

8976 
DesüibeNeg©iÚTo
(::
¡d
::
o¡»am
* 
os
ècÚ¡ 
ov”ride
 {

8977 
im¶_
->
DesüibeNeg©iÚTo
(
os
);

8980 
boŞ
 
M©chAndEx¶aš
(cÚ¡ 
T
& 
x
,

8981 
M©chResuÉLi¡’”
* 
li¡’”
ècÚ¡ 
	gov”ride
 {

8982  
	gim¶_
->
M©chAndEx¶aš
(
x
, 
li¡’”
);

8985 
	g´iv©e
:

8986 cÚ¡ 
M©ch”IÁ”çû
<
T
>* cÚ¡ 
im¶_
;

8988 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
M©ch”IÁ”çûAd­‹r
);

8991 
	sAnyEq
 {

8992 
	g‹m¶©e
 <
ty³Çme
 
	gA
,y³Çm
	gB
>

8993 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gA
& 
	ga
, cÚ¡ 
	gB
& 
	gb
ècÚ¡ { ‡ =ğ
b
; }

8995 
	sAnyNe
 {

8996 
	g‹m¶©e
 <
ty³Çme
 
	gA
,y³Çm
	gB
>

8997 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gA
& 
	ga
, cÚ¡ 
	gB
& 
	gb
ècÚ¡ { ‡ !ğ
b
; }

8999 
	sAnyLt
 {

9000 
	g‹m¶©e
 <
ty³Çme
 
	gA
,y³Çm
	gB
>

9001 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gA
& 
	ga
, cÚ¡ 
	gB
& 
	gb
) const { ‡ < b; }

9003 
	sAnyGt
 {

9004 
	g‹m¶©e
 <
ty³Çme
 
	gA
,y³Çm
	gB
>

9005 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gA
& 
	ga
, cÚ¡ 
	gB
& 
	gb
) const { ‡ > b; }

9007 
	sAnyLe
 {

9008 
	g‹m¶©e
 <
ty³Çme
 
	gA
,y³Çm
	gB
>

9009 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gA
& 
	ga
, cÚ¡ 
	gB
& 
	gb
ècÚ¡ { ‡ <ğ
b
; }

9011 
	sAnyGe
 {

9012 
	g‹m¶©e
 <
ty³Çme
 
	gA
,y³Çm
	gB
>

9013 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gA
& 
	ga
, cÚ¡ 
	gB
& 
	gb
ècÚ¡ { ‡ >ğ
b
; }

9017 şas 
	cDummyM©chResuÉLi¡’”
 : 
public
 
M©chResuÉLi¡’”
 {

9018 
public
:

9019 
DummyM©chResuÉLi¡’”
(è: 
M©chResuÉLi¡’”
(
nuÎ±r
) {}

9021 
´iv©e
:

9022 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
DummyM©chResuÉLi¡’”
);

9028 şas 
	cSŒ—mM©chResuÉLi¡’”
 : 
public
 
M©chResuÉLi¡’”
 {

9029 
public
:

9030 
ex¶ic™
 
SŒ—mM©chResuÉLi¡’”
(::
¡d
::
o¡»am
* 
os
)

9031 : 
M©chResuÉLi¡’”
(
os
) {}

9033 
´iv©e
:

9034 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
SŒ—mM©chResuÉLi¡’”
);

9040 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9041 şas 
	cM©ch”Ba£
 {

9042 
	gpublic
:

9045 
boŞ
 
M©chAndEx¶aš
(cÚ¡ 
T
& 
x
, 
M©chResuÉLi¡’”
* 
li¡’”
) const {

9046  
	gim¶_
->
M©chAndEx¶aš
(
x
, 
li¡’”
);

9050 
boŞ
 
M©ches
(cÚ¡ 
T
& 
x
) const {

9051 
DummyM©chResuÉLi¡’”
 
	gdummy
;

9052  
M©chAndEx¶aš
(
x
, &
dummy
);

9056 
DesüibeTo
(::
¡d
::
o¡»am
* 
os
ècÚ¡ { 
im¶_
->DescribeTo(os); }

9059 
DesüibeNeg©iÚTo
(::
¡d
::
o¡»am
* 
os
) const {

9060 
im¶_
->
DesüibeNeg©iÚTo
(
os
);

9064 
Ex¶ašM©chResuÉTo
(cÚ¡ 
T
& 
x
, ::
¡d
::
o¡»am
* 
os
) const {

9065 
SŒ—mM©chResuÉLi¡’”
 
li¡’”
(
os
);

9066 
M©chAndEx¶aš
(
x
, &
li¡’”
);

9072 cÚ¡ 
M©ch”Desüib”IÁ”çû
* 
G‘Desüib”
() const {

9073  
	gim¶_
.
g‘
();

9076 
	g´Ùeùed
:

9077 
M©ch”Ba£
() {}

9080 
ex¶ic™
 
M©ch”Ba£
(cÚ¡ 
M©ch”IÁ”çû
<cÚ¡ 
T
&>* 
im¶
è: 
im¶_
(impl) {}

9082 
‹m¶©e
 <
ty³Çme
 
U
>

9083 
ex¶ic™
 
M©ch”Ba£
(

9084 cÚ¡ 
M©ch”IÁ”çû
<
U
>* 
im¶
,

9085 
ty³Çme
 
¡d
::
’abË_if
<!¡d::
is_§me
<
U
, cÚ¡ U&>::
v®ue
>::
ty³
* =

9086 
nuÎ±r
)

9087 : 
im¶_
(
Ãw
 
š‹º®
::
M©ch”IÁ”çûAd­‹r
<
U
>(
im¶
)) {}

9089 
M©ch”Ba£
(const MatcherBase&) = ;

9090 
	gM©ch”Ba£
& 
	gİ”©Ü
=(cÚ¡ 
M©ch”Ba£
&) = ;

9091 
M©ch”Ba£
(MatcherBase&&) = ;

9092 
	gM©ch”Ba£
& 
	gİ”©Ü
=(
M©ch”Ba£
&&) = ;

9094 
	gvœtu®
 ~
M©ch”Ba£
() {}

9096 
	g´iv©e
:

9097 
¡d
::
sh¬ed_±r
<cÚ¡ 
M©ch”IÁ”çû
<cÚ¡ 
T
&>> 
im¶_
;

9106 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9107 
şass
 
	gM©ch”
 : 
public
 
š‹º®
::
M©ch”Ba£
<
T
> {

9108 
public
:

9112 
ex¶ic™
 
M©ch”
() {}

9115 
ex¶ic™
 
M©ch”
(cÚ¡ 
M©ch”IÁ”çû
<cÚ¡ 
T
&>* 
im¶
)

9116 : 
š‹º®
::
M©ch”Ba£
<
T
>(
im¶
) {}

9118 
‹m¶©e
 <
ty³Çme
 
U
>

9119 
ex¶ic™
 
M©ch”
(

9120 cÚ¡ 
M©ch”IÁ”çû
<
U
>* 
im¶
,

9121 
ty³Çme
 
¡d
::
’abË_if
<!¡d::
is_§me
<
U
, cÚ¡ U&>::
v®ue
>::
ty³
* =

9122 
nuÎ±r
)

9123 : 
š‹º®
::
M©ch”Ba£
<
T
>(
im¶
) {}

9127 
M©ch”
(
T
 
v®ue
);

9133 
	g‹m¶©e
 <>

9134 
şass
 
GTEST_API_
 
	gM©ch”
<cÚ¡ 
	g¡d
::
¡ršg
&>

9135 : 
public
 
š‹º®
::
M©ch”Ba£
<cÚ¡ 
¡d
::
¡ršg
&> {

9136 
public
:

9137 
M©ch”
() {}

9139 
ex¶ic™
 
M©ch”
(cÚ¡ 
M©ch”IÁ”çû
<cÚ¡ 
¡d
::
¡ršg
&>* 
im¶
)

9140 : 
š‹º®
::
M©ch”Ba£
<cÚ¡ 
¡d
::
¡ršg
&>(
im¶
) {}

9144 
M©ch”
(cÚ¡ 
¡d
::
¡ršg
& 
s
);

9147 
M©ch”
(cÚ¡ * 
s
);

9150 
	g‹m¶©e
 <>

9151 
şass
 
GTEST_API_
 
	gM©ch”
<
	g¡d
::
¡ršg
>

9152 : 
public
 
š‹º®
::
M©ch”Ba£
<
¡d
::
¡ršg
> {

9153 
public
:

9154 
M©ch”
() {}

9156 
ex¶ic™
 
M©ch”
(cÚ¡ 
M©ch”IÁ”çû
<cÚ¡ 
¡d
::
¡ršg
&>* 
im¶
)

9157 : 
š‹º®
::
M©ch”Ba£
<
¡d
::
¡ršg
>(
im¶
) {}

9158 
ex¶ic™
 
M©ch”
(cÚ¡ 
M©ch”IÁ”çû
<
¡d
::
¡ršg
>* 
im¶
)

9159 : 
š‹º®
::
M©ch”Ba£
<
¡d
::
¡ršg
>(
im¶
) {}

9163 
M©ch”
(cÚ¡ 
¡d
::
¡ršg
& 
s
);

9166 
M©ch”
(cÚ¡ * 
s
);

9169 #ià
GTEST_HAS_ABSL


9173 
	g‹m¶©e
 <>

9174 
şass
 
GTEST_API_
 
	gM©ch”
<cÚ¡ 
	gab¦
::
¡ršg_v›w
&>

9175 : 
public
 
š‹º®
::
M©ch”Ba£
<cÚ¡ 
ab¦
::
¡ršg_v›w
&> {

9176 
public
:

9177 
M©ch”
() {}

9179 
ex¶ic™
 
M©ch”
(cÚ¡ 
M©ch”IÁ”çû
<cÚ¡ 
ab¦
::
¡ršg_v›w
&>* 
im¶
)

9180 : 
š‹º®
::
M©ch”Ba£
<cÚ¡ 
ab¦
::
¡ršg_v›w
&>(
im¶
) {}

9184 
M©ch”
(cÚ¡ 
¡d
::
¡ršg
& 
s
);

9187 
M©ch”
(cÚ¡ * 
s
);

9190 
M©ch”
(
ab¦
::
¡ršg_v›w
 
s
);

9193 
	g‹m¶©e
 <>

9194 
şass
 
GTEST_API_
 
	gM©ch”
<
	gab¦
::
¡ršg_v›w
>

9195 : 
public
 
š‹º®
::
M©ch”Ba£
<
ab¦
::
¡ršg_v›w
> {

9196 
public
:

9197 
M©ch”
() {}

9199 
ex¶ic™
 
M©ch”
(cÚ¡ 
M©ch”IÁ”çû
<cÚ¡ 
ab¦
::
¡ršg_v›w
&>* 
im¶
)

9200 : 
š‹º®
::
M©ch”Ba£
<
ab¦
::
¡ršg_v›w
>(
im¶
) {}

9201 
ex¶ic™
 
M©ch”
(cÚ¡ 
M©ch”IÁ”çû
<
ab¦
::
¡ršg_v›w
>* 
im¶
)

9202 : 
š‹º®
::
M©ch”Ba£
<
ab¦
::
¡ršg_v›w
>(
im¶
) {}

9206 
M©ch”
(cÚ¡ 
¡d
::
¡ršg
& 
s
);

9209 
M©ch”
(cÚ¡ * 
s
);

9212 
M©ch”
(
ab¦
::
¡ršg_v›w
 
s
);

9217 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9218 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gM©ch”
<
	gT
>& 
	gm©ch”
) {

9219 
	gm©ch”
.
DesüibeTo
(&
os
);

9220  
	gos
;

9235 
	g‹m¶©e
 <
şass
 
	gIm¶
>

9236 şas 
	cPŞymÜphicM©ch”
 {

9237 
	gpublic
:

9238 
ex¶ic™
 
PŞymÜphicM©ch”
(cÚ¡ 
Im¶
& 
ª_im¶
è: 
im¶_
(an_impl) {}

9242 
Im¶
& 
mubË_im¶
(è{  
im¶_
; }

9246 cÚ¡ 
	gIm¶
& 
im¶
(ècÚ¡ {  
	gim¶_
; }

9248 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9249 
İ”©Ü
 
	gM©ch”
<
	gT
>() const {

9250  
	gM©ch”
<
	gT
>(
Ãw
 
	gMÚomÜphicIm¶
<cÚ¡ T&>(
	gim¶_
));

9253 
	g´iv©e
:

9254 
‹m¶©e
 <
ty³Çme
 
T
>

9255 
şass
 
MÚomÜphicIm¶
 : 
public
 
M©ch”IÁ”çû
<
T
> {

9256 
public
:

9257 
ex¶ic™
 
MÚomÜphicIm¶
(cÚ¡ 
Im¶
& 
im¶
è: 
im¶_
(impl) {}

9259 
vœtu®
 
DesüibeTo
(::
¡d
::
o¡»am
* 
os
ècÚ¡ { 
im¶_
.DescribeTo(os); }

9261 
vœtu®
 
DesüibeNeg©iÚTo
(::
¡d
::
o¡»am
* 
os
) const {

9262 
im¶_
.
DesüibeNeg©iÚTo
(
os
);

9265 
vœtu®
 
boŞ
 
M©chAndEx¶aš
(
T
 
x
, 
M©chResuÉLi¡’”
* 
li¡’”
) const {

9266  
	gim¶_
.
M©chAndEx¶aš
(
x
, 
li¡’”
);

9269 
	g´iv©e
:

9270 cÚ¡ 
Im¶
 
im¶_
;

9273 
Im¶
 
	gim¶_
;

9282 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9283 
šlše
 
	gM©ch”
<
	gT
> 
MakeM©ch”
(cÚ¡ 
M©ch”IÁ”çû
<
T
>* 
im¶
) {

9284  
	gM©ch”
<
	gT
>(
	gim¶
);

9294 
	g‹m¶©e
 <
şass
 
	gIm¶
>

9295 
šlše
 
	gPŞymÜphicM©ch”
<
	gIm¶
> 
	$MakePŞymÜphicM©ch”
(cÚ¡ 
Im¶
& 
im¶
) {

9296  
PŞymÜphicM©ch”
<
Im¶
>(
im¶
);

9297 
	}
}

9299 
Çme¥aû
 
	gš‹º®
 {

9310 
	g‹m¶©e
 <
ty³Çme
 
	gD
,y³Çm
	gRhs
,y³Çm
	gOp
>

9311 şas 
	cCom·risÚBa£
 {

9312 
	gpublic
:

9313 
ex¶ic™
 
Com·risÚBa£
(cÚ¡ 
Rhs
& 
rhs
è: 
rhs_
(rhs) {}

9314 
‹m¶©e
 <
ty³Çme
 
Lhs
>

9315 
İ”©Ü
 
M©ch”
<
Lhs
>() const {

9316  
M©ch”
<
Lhs
>(
Ãw
 
Im¶
<cÚ¡ Lhs&>(
rhs_
));

9319 
	g´iv©e
:

9320 
‹m¶©e
 <
ty³Çme
 
T
>

9321 cÚ¡ 
T
& 
Unw¿p
(cÚ¡ T& 
v
) {  v; }

9322 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9323 cÚ¡ 
	gT
& 
Unw¿p
(
¡d
::
»ã»nû_w¿µ”
<
T
> 
v
) {  v; }

9325 
	g‹m¶©e
 <
ty³Çme
 
	gLhs
, 
	gty³Çme
 = 
Rhs
>

9326 
şass
 
Im¶
 : 
public
 
M©ch”IÁ”çû
<
Lhs
> {

9327 
public
:

9328 
ex¶ic™
 
Im¶
(cÚ¡ 
Rhs
& 
rhs
è: 
rhs_
(rhs) {}

9329 
boŞ
 
M©chAndEx¶aš
(
Lhs
 
lhs
,

9330 
M©chResuÉLi¡’”
* ) cÚ¡ 
ov”ride
 {

9331  
Op
()(
lhs
, 
Unw¿p
(
rhs_
));

9333 
DesüibeTo
(::
¡d
::
o¡»am
* 
os
ècÚ¡ 
ov”ride
 {

9334 *
os
 << 
D
::
Desc
() << " ";

9335 
Univ”§lPršt
(
Unw¿p
(
rhs_
), 
os
);

9337 
DesüibeNeg©iÚTo
(::
¡d
::
o¡»am
* 
os
ècÚ¡ 
ov”ride
 {

9338 *
os
 << 
D
::
Neg©edDesc
() << " ";

9339 
Univ”§lPršt
(
Unw¿p
(
rhs_
), 
os
);

9342 
	g´iv©e
:

9343 
Rhs
 
rhs_
;

9345 
Rhs
 
	grhs_
;

9348 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9349 
şass
 
	gEqM©ch”
 : 
public
 
Com·risÚBa£
<
EqM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyEq
> {

9350 
	gpublic
:

9351 
ex¶ic™
 
EqM©ch”
(cÚ¡ 
Rhs
& 
rhs
)

9352 : 
Com·risÚBa£
<
EqM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyEq
>(
	grhs
) { }

9353 cÚ¡ * 
Desc
() {  "isƒqualo"; }

9354 cÚ¡ * 
Neg©edDesc
() {  "isn'tƒqualo"; }

9356 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9357 
şass
 
	gNeM©ch”
 : 
public
 
Com·risÚBa£
<
NeM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyNe
> {

9358 
	gpublic
:

9359 
ex¶ic™
 
NeM©ch”
(cÚ¡ 
Rhs
& 
rhs
)

9360 : 
Com·risÚBa£
<
NeM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyNe
>(
	grhs
) { }

9361 cÚ¡ * 
Desc
() {  "isn'tƒqualo"; }

9362 cÚ¡ * 
Neg©edDesc
() {  "isƒqualo"; }

9364 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9365 
şass
 
	gLtM©ch”
 : 
public
 
Com·risÚBa£
<
LtM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyLt
> {

9366 
	gpublic
:

9367 
ex¶ic™
 
LtM©ch”
(cÚ¡ 
Rhs
& 
rhs
)

9368 : 
Com·risÚBa£
<
LtM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyLt
>(
	grhs
) { }

9369 cÚ¡ * 
Desc
() {  "is <"; }

9370 cÚ¡ * 
Neg©edDesc
() {  "isn't <"; }

9372 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9373 
şass
 
	gGtM©ch”
 : 
public
 
Com·risÚBa£
<
GtM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyGt
> {

9374 
	gpublic
:

9375 
ex¶ic™
 
GtM©ch”
(cÚ¡ 
Rhs
& 
rhs
)

9376 : 
Com·risÚBa£
<
GtM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyGt
>(
	grhs
) { }

9377 cÚ¡ * 
Desc
() {  "is >"; }

9378 cÚ¡ * 
Neg©edDesc
() {  "isn't >"; }

9380 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9381 
şass
 
	gLeM©ch”
 : 
public
 
Com·risÚBa£
<
LeM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyLe
> {

9382 
	gpublic
:

9383 
ex¶ic™
 
LeM©ch”
(cÚ¡ 
Rhs
& 
rhs
)

9384 : 
Com·risÚBa£
<
LeM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyLe
>(
	grhs
) { }

9385 cÚ¡ * 
Desc
() {  "is <="; }

9386 cÚ¡ * 
Neg©edDesc
() {  "isn't <="; }

9388 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9389 
şass
 
	gGeM©ch”
 : 
public
 
Com·risÚBa£
<
GeM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyGe
> {

9390 
	gpublic
:

9391 
ex¶ic™
 
GeM©ch”
(cÚ¡ 
Rhs
& 
rhs
)

9392 : 
Com·risÚBa£
<
GeM©ch”
<
Rhs
>, 
	gRhs
, 
	gAnyGe
>(
	grhs
) { }

9393 cÚ¡ * 
Desc
() {  "is >="; }

9394 cÚ¡ * 
Neg©edDesc
() {  "isn't >="; }

9400 şas 
	cM©chesRegexM©ch”
 {

9401 
	gpublic
:

9402 
M©chesRegexM©ch”
(cÚ¡ 
RE
* 
»gex
, 
boŞ
 
fuÎ_m©ch
)

9403 : 
»gex_
(
»gex
), 
fuÎ_m©ch_
(
fuÎ_m©ch
) {}

9405 #ià
GTEST_HAS_ABSL


9406 
boŞ
 
M©chAndEx¶aš
(cÚ¡ 
ab¦
::
¡ršg_v›w
& 
s
,

9407 
M©chResuÉLi¡’”
* 
li¡’”
) const {

9408  
M©chAndEx¶aš
(
¡d
::
¡ršg
(
s
), 
li¡’”
);

9417 
	g‹m¶©e
 <
ty³Çme
 
	gCh¬Ty³
>

9418 
boŞ
 
M©chAndEx¶aš
(
Ch¬Ty³
* 
s
, 
M©chResuÉLi¡’”
* 
li¡’”
) const {

9419  
	gs
 !ğ
nuÎ±r
 && 
M©chAndEx¶aš
(
¡d
::
¡ršg
(
s
), 
li¡’”
);

9426 
	g‹m¶©e
 <
şass
 
	gM©ch“SŒšgTy³
>

9427 
boŞ
 
M©chAndEx¶aš
(cÚ¡ 
M©ch“SŒšgTy³
& 
s
,

9428 
M©chResuÉLi¡’”
* ) const {

9429 cÚ¡ 
	g¡d
::
¡ršg
& 
s2
(
s
);

9430  
	gfuÎ_m©ch_
 ? 
	gRE
::
FuÎM©ch
(
s2
, *
»gex_
)

9431 : 
RE
::
P¬tŸlM©ch
(
s2
, *
»gex_
);

9434 
DesüibeTo
(::
¡d
::
o¡»am
* 
os
) const {

9435 *
os
 << (
fuÎ_m©ch_
 ? "matches" : "contains") << "„egularƒxpression ";

9436 
	gUniv”§lPrš‹r
<
	g¡d
::
¡ršg
>::
Pršt
(
»gex_
->
·‰”n
(), 
os
);

9439 
DesüibeNeg©iÚTo
(::
¡d
::
o¡»am
* 
os
) const {

9440 *
os
 << "dÛ¢'ˆ" << (
fuÎ_m©ch_
 ? "match" : "contain")

9442 
	gUniv”§lPrš‹r
<
	g¡d
::
¡ršg
>::
Pršt
(
»gex_
->
·‰”n
(), 
os
);

9445 
	g´iv©e
:

9446 cÚ¡ 
¡d
::
sh¬ed_±r
<cÚ¡ 
RE
> 
»gex_
;

9447 cÚ¡ 
boŞ
 
	gfuÎ_m©ch_
;

9453 
šlše
 
	gPŞymÜphicM©ch”
<
	gš‹º®
::
M©chesRegexM©ch”
> 
	$M©chesRegex
(

9454 cÚ¡ 
š‹º®
::
RE
* 
»gex
) {

9455  
	`MakePŞymÜphicM©ch”
(
š‹º®
::
	`M©chesRegexM©ch”
(
»gex
, 
Œue
));

9456 
	}
}

9457 
šlše
 
	gPŞymÜphicM©ch”
<
	gš‹º®
::
M©chesRegexM©ch”
> 
	$M©chesRegex
(

9458 cÚ¡ 
¡d
::
¡ršg
& 
»gex
) {

9459  
	`M©chesRegex
(
Ãw
 
š‹º®
::
	`RE
(
»gex
));

9460 
	}
}

9464 
šlše
 
	gPŞymÜphicM©ch”
<
	gš‹º®
::
M©chesRegexM©ch”
> 
	$CÚšsRegex
(

9465 cÚ¡ 
š‹º®
::
RE
* 
»gex
) {

9466  
	`MakePŞymÜphicM©ch”
(
š‹º®
::
	`M©chesRegexM©ch”
(
»gex
, 
çl£
));

9467 
	}
}

9468 
šlše
 
	gPŞymÜphicM©ch”
<
	gš‹º®
::
M©chesRegexM©ch”
> 
	$CÚšsRegex
(

9469 cÚ¡ 
¡d
::
¡ršg
& 
»gex
) {

9470  
	`CÚšsRegex
(
Ãw
 
š‹º®
::
	`RE
(
»gex
));

9471 
	}
}

9476 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9477 
šlše
 
	gš‹º®
::
EqM©ch”
<
T
> 
	$Eq
(
T
 
x
è{  
š‹º®
::
EqM©ch”
<T>(x); 
	}
}

9481 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9482 
	gM©ch”
<
	gT
>::
	$M©ch”
(
T
 
v®ue
è{ *
this
 = 
	`Eq
(v®ue); 
	}
}

9496 
	g‹m¶©e
 <
ty³Çme
 
	gLhs
,y³Çm
	gRhs
>

9497 
šlše
 
	gM©ch”
<
	gLhs
> 
	$Ty³dEq
(cÚ¡ 
Rhs
& 
rhs
è{  
	`Eq
Ôhs); 
	}
}

9500 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9501 
šlše
 
	gš‹º®
::
GeM©ch”
<
Rhs
> 
	$Ge
(
Rhs
 
x
) {

9502  
š‹º®
::
GeM©ch”
<
Rhs
>(
x
);

9503 
	}
}

9506 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9507 
šlše
 
	gš‹º®
::
GtM©ch”
<
Rhs
> 
	$Gt
(
Rhs
 
x
) {

9508  
š‹º®
::
GtM©ch”
<
Rhs
>(
x
);

9509 
	}
}

9512 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9513 
šlše
 
	gš‹º®
::
LeM©ch”
<
Rhs
> 
	$Le
(
Rhs
 
x
) {

9514  
š‹º®
::
LeM©ch”
<
Rhs
>(
x
);

9515 
	}
}

9518 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9519 
šlše
 
	gš‹º®
::
LtM©ch”
<
Rhs
> 
	$Lt
(
Rhs
 
x
) {

9520  
š‹º®
::
LtM©ch”
<
Rhs
>(
x
);

9521 
	}
}

9524 
	g‹m¶©e
 <
ty³Çme
 
	gRhs
>

9525 
šlše
 
	gš‹º®
::
NeM©ch”
<
Rhs
> 
	$Ne
(
Rhs
 
x
) {

9526  
š‹º®
::
NeM©ch”
<
Rhs
>(
x
);

9527 
	}
}

9530 
	$GTEST_DISABLE_MSC_WARNINGS_POP_
()

9534 
	~<¡dio.h
>

9535 
	~<memÜy
>

9537 
Çme¥aû
 
‹¡šg
 {

9538 
Çme¥aû
 
š‹º®
 {

9540 
	`GTEST_DECLARE_¡ršg_
(
š‹º®_run_d—th_‹¡
);

9543 cÚ¡ 
kD—thTe¡StyËFÏg
[] = "death_test_style";

9544 cÚ¡ 
kD—thTe¡U£FÜk
[] = "death_test_use_fork";

9545 cÚ¡ 
kIÁ”ÇlRunD—thTe¡FÏg
[] = "internal_run_death_test";

9547 #ià
GTEST_HAS_DEATH_TEST


9549 
	`GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4251 \

9565 şas 
	cGTEST_API_
 
D—thTe¡
 {

9566 
public
:

9575 
boŞ
 
	`C»©e
(cÚ¡ * 
¡©em’t
, 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
,

9576 cÚ¡ * 
fe
, 
lše
, 
D—thTe¡
** 
‹¡
);

9577 
	`D—thTe¡
();

9578 
vœtu®
 ~
	`D—thTe¡
() { }

9581 şas 
	cR‘uºS’tš–
 {

9582 
public
:

9583 
ex¶ic™
 
	`R‘uºS’tš–
(
D—thTe¡
* 
‹¡
è: 
	`‹¡_
(test) { }

9584 ~
	`R‘uºS’tš–
(è{ 
‹¡_
->
	`AbÜt
(
TEST_ENCOUNTERED_RETURN_STATEMENT
); }

9585 
´iv©e
:

9586 
D—thTe¡
* cÚ¡ 
‹¡_
;

9587 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
R‘uºS’tš–
);

9588 } 
GTEST_ATTRIBUTE_UNUSED_
;

9595 
	eTe¡RŞe
 { 
OVERSEE_TEST
, 
EXECUTE_TEST
 };

9598 
	eAbÜtR—sÚ
 {

9599 
TEST_ENCOUNTERED_RETURN_STATEMENT
,

9600 
TEST_THREW_EXCEPTION
,

9601 
TEST_DID_NOT_DIE


9605 
vœtu®
 
Te¡RŞe
 
	`AssumeRŞe
() = 0;

9608 
vœtu®
 
	`Wa™
() = 0;

9617 
vœtu®
 
boŞ
 
	`Pas£d
(boŞ 
ex™_¡©us_ok
) = 0;

9620 
vœtu®
 
	`AbÜt
(
AbÜtR—sÚ
 
»asÚ
) = 0;

9624 cÚ¡ * 
	`La¡Mes§ge
();

9626 
	`£t_Ï¡_d—th_‹¡_mes§ge
(cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
);

9628 
´iv©e
:

9630 
¡d
::
¡ršg
 
Ï¡_d—th_‹¡_mes§ge_
;

9632 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
D—thTe¡
);

9635 
	`GTEST_DISABLE_MSC_WARNINGS_POP_
()

9638 şas 
	cD—thTe¡FaùÜy
 {

9639 
public
:

9640 
vœtu®
 ~
	`D—thTe¡FaùÜy
() { }

9641 
vœtu®
 
boŞ
 
	`C»©e
(cÚ¡ * 
¡©em’t
,

9642 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
, cÚ¡ * 
fe
,

9643 
lše
, 
D—thTe¡
** 
‹¡
) = 0;

9647 şas 
	cDeçuÉD—thTe¡FaùÜy
 : 
public
 
D—thTe¡FaùÜy
 {

9648 
public
:

9649 
boŞ
 
	`C»©e
(cÚ¡ * 
¡©em’t
, 
M©ch”
<cÚ¡ 
¡d
::
¡ršg
&> 
m©ch”
,

9650 cÚ¡ * 
fe
, 
lše
, 
D—thTe¡
** 
‹¡
è
ov”ride
;

9655 
GTEST_API_
 
boŞ
 
	`Ex™edUnsucûssfuÎy
(
ex™_¡©us
);

9660 
šlše
 
M©ch”
<cÚ¡ ::
¡d
::
¡ršg
&> 
	`MakeD—thTe¡M©ch”
(

9661 ::
‹¡šg
::
š‹º®
::
RE
 
»gex
) {

9662  
	`CÚšsRegex
(
»gex
.
	`·‰”n
());

9664 
šlše
 
M©ch”
<cÚ¡ ::
¡d
::
¡ršg
&> 
	`MakeD—thTe¡M©ch”
(cÚ¡ * 
»gex
) {

9665  
	`CÚšsRegex
(
»gex
);

9667 
šlše
 
M©ch”
<cÚ¡ ::
¡d
::
¡ršg
&> 
	`MakeD—thTe¡M©ch”
(

9668 cÚ¡ ::
¡d
::
¡ršg
& 
»gex
) {

9669  
	`CÚšsRegex
(
»gex
);

9674 
šlše
 
M©ch”
<cÚ¡ ::
¡d
::
¡ršg
&> 
	`MakeD—thTe¡M©ch”
(

9675 
M©ch”
<cÚ¡ ::
¡d
::
¡ršg
&> 
m©ch”
) {

9676  
m©ch”
;

9681 #ià
GTEST_HAS_EXCEPTIONS


9682 
	#GTEST_EXECUTE_DEATH_TEST_STATEMENT_
(
¡©em’t
, 
d—th_‹¡
) \

9683 
Œy
 { \

9684 
	`GTEST_SUPPRESS_UNREACHABLE_CODE_WARNING_BELOW_
(
¡©em’t
); \

9685 } 
	`ÿtch
 (cÚ¡ ::
¡d
::
exû±iÚ
& 
g‹¡_exû±iÚ
) { \

9686 
	`årštf
(\

9687 
¡d”r
, \

9690 ::
‹¡šg
::
š‹º®
::
	`FÜm©FeLoÿtiÚ
(
__FILE__
, 
__LINE__
).
	`c_¡r
(), \

9691 
g‹¡_exû±iÚ
.
	`wh©
()); \

9692 
	`fæush
(
¡d”r
); \

9693 
d—th_‹¡
->
	`AbÜt
(::
‹¡šg
::
š‹º®
::
D—thTe¡
::
TEST_THREW_EXCEPTION
); \

9694 } 
	`ÿtch
 (...) { \

9695 
d—th_‹¡
->
	`AbÜt
(::
‹¡šg
::
š‹º®
::
D—thTe¡
::
TEST_THREW_EXCEPTION
); \

9696 }

	)

9699 
	#GTEST_EXECUTE_DEATH_TEST_STATEMENT_
(
¡©em’t
, 
d—th_‹¡
) \

9700 
	`GTEST_SUPPRESS_UNREACHABLE_CODE_WARNING_BELOW_
(
¡©em’t
)

	)

9706 
	#GTEST_DEATH_TEST_
(
¡©em’t
, 
´ediÿ‹
, 
»gex_Ü_m©ch”
, 
ç
) \

9707 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

9708 ià(::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()) { \

9709 ::
‹¡šg
::
š‹º®
::
D—thTe¡
* 
g‹¡_dt
; \

9710 ià(!::
‹¡šg
::
š‹º®
::
D—thTe¡
::
	`C»©e
( \

9712 ::
‹¡šg
::
š‹º®
::
	`MakeD—thTe¡M©ch”
(
»gex_Ü_m©ch”
), \

9713 
__FILE__
, 
__LINE__
, &
g‹¡_dt
)) { \

9714 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_
, 
__LINE__
); \

9716 ià(
g‹¡_dt
 !ğ
nuÎ±r
) { \

9717 
¡d
::
unique_±r
< ::
‹¡šg
::
š‹º®
::
D—thTe¡
> 
	`g‹¡_dt_±r
(
g‹¡_dt
); \

9718 
g‹¡_dt
->
	`AssumeRŞe
()) { \

9719 ::
‹¡šg
::
š‹º®
::
D—thTe¡
::
OVERSEE_TEST
: \

9720 ià(!
g‹¡_dt
->
	`Pas£d
(
	`´ediÿ‹
(g‹¡_dt->
	`Wa™
()))) { \

9721 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_
, 
__LINE__
); \

9724 ::
‹¡šg
::
š‹º®
::
D—thTe¡
::
EXECUTE_TEST
: { \

9725 ::
‹¡šg
::
š‹º®
::
D—thTe¡
::
R‘uºS’tš–
 
	`g‹¡_£Áš–
( \

9726 
g‹¡_dt
); \

9727 
	`GTEST_EXECUTE_DEATH_TEST_STATEMENT_
(
¡©em’t
, 
g‹¡_dt
); \

9728 
g‹¡_dt
->
	`AbÜt
(::
‹¡šg
::
š‹º®
::
D—thTe¡
::
TEST_DID_NOT_DIE
); \

9736 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Ïb–_
, 
__LINE__
) \

9737 : 
	`ç
(::
‹¡šg
::
š‹º®
::
D—thTe¡
::
	`La¡Mes§ge
())

	)

9746 
	#GTEST_EXECUTE_STATEMENT_
(
¡©em’t
, 
»gex_Ü_m©ch”
) \

9747 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

9748 ià(::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()) { \

9749 
	`GTEST_SUPPRESS_UNREACHABLE_CODE_WARNING_BELOW_
(
¡©em’t
); \

9750 } ià(!::
‹¡šg
::
š‹º®
::
	`AlwaysTrue
()) { \

9751 ::
‹¡šg
::
š‹º®
::
	`MakeD—thTe¡M©ch”
(
»gex_Ü_m©ch”
); \

9753 ::
‹¡šg
::
	`Mes§ge
()

	)

9758 şas 
	cIÁ”ÇlRunD—thTe¡FÏg
 {

9759 
public
:

9760 
	`IÁ”ÇlRunD—thTe¡FÏg
(cÚ¡ 
¡d
::
¡ršg
& 
a_fe
,

9761 
a_lše
,

9762 
ª_šdex
,

9763 
a_wr™e_fd
)

9764 : 
	`fe_
(
a_fe
), 
	`lše_
(
a_lše
), 
	`šdex_
(
ª_šdex
),

9765 
	`wr™e_fd_
(
a_wr™e_fd
) {}

9767 ~
	`IÁ”ÇlRunD—thTe¡FÏg
() {

9768 ià(
wr™e_fd_
 >= 0)

9769 
posix
::
	`Clo£
(
wr™e_fd_
);

9772 cÚ¡ 
¡d
::
¡ršg
& 
	`fe
(ècÚ¡ {  
fe_
; }

9773 
	`lše
(ècÚ¡ {  
lše_
; }

9774 
	`šdex
(ècÚ¡ {  
šdex_
; }

9775 
	`wr™e_fd
(ècÚ¡ {  
wr™e_fd_
; }

9777 
´iv©e
:

9778 
¡d
::
¡ršg
 
fe_
;

9779 
lše_
;

9780 
šdex_
;

9781 
wr™e_fd_
;

9783 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
IÁ”ÇlRunD—thTe¡FÏg
);

9789 
IÁ”ÇlRunD—thTe¡FÏg
* 
	`P¬£IÁ”ÇlRunD—thTe¡FÏg
();

9793 
	}
}

9798 
Çme¥aû
 
	g‹¡šg
 {

9805 
GTEST_DECLARE_¡ršg_
(
d—th_‹¡_¡yË
);

9807 #ià
GTEST_HAS_DEATH_TEST


9809 
Çme¥aû
 
	gš‹º®
 {

9816 
GTEST_API_
 
boŞ
 
InD—thTe¡Chd
();

9923 
	#ASSERT_EXIT
(
¡©em’t
, 
´ediÿ‹
, 
»gex
) \

9924 
	`GTEST_DEATH_TEST_
(
¡©em’t
, 
´ediÿ‹
, 
»gex
, 
GTEST_FATAL_FAILURE_
)

	)

9928 
	#EXPECT_EXIT
(
¡©em’t
, 
´ediÿ‹
, 
»gex
) \

9929 
	`GTEST_DEATH_TEST_
(
¡©em’t
, 
´ediÿ‹
, 
»gex
, 
GTEST_NONFATAL_FAILURE_
)

	)

9934 
	#ASSERT_DEATH
(
¡©em’t
, 
»gex
) \

9935 
	`ASSERT_EXIT
(
¡©em’t
, ::
‹¡šg
::
š‹º®
::
Ex™edUnsucûssfuÎy
, 
»gex
)

	)

9939 
	#EXPECT_DEATH
(
¡©em’t
, 
»gex
) \

9940 
	`EXPECT_EXIT
(
¡©em’t
, ::
‹¡šg
::
š‹º®
::
Ex™edUnsucûssfuÎy
, 
»gex
)

	)

9945 şas 
	cGTEST_API_
 
	gEx™edW™hCode
 {

9946 
	gpublic
:

9947 
ex¶ic™
 
Ex™edW™hCode
(
ex™_code
);

9948 
boŞ
 
İ”©Ü
()(
	gex™_¡©us
) const;

9949 
	g´iv©e
:

9951 
İ”©Ü
=(cÚ¡ 
Ex™edW™hCode
& 
Ùh”
);

9953 cÚ¡ 
	gex™_code_
;

9956 #ià!
GTEST_OS_WINDOWS
 && !
GTEST_OS_FUCHSIA


9960 şas 
	cGTEST_API_
 
	gKËdBySigÇl
 {

9961 
	gpublic
:

9962 
ex¶ic™
 
KËdBySigÇl
(
signum
);

9963 
boŞ
 
İ”©Ü
()(
	gex™_¡©us
) const;

9964 
	g´iv©e
:

9965 cÚ¡ 
signum_
;

10012 #ifdeà
NDEBUG


10014 
	#EXPECT_DEBUG_DEATH
(
¡©em’t
, 
»gex
) \

10015 
	$GTEST_EXECUTE_STATEMENT_
(
¡©em’t
, 
»gex
)

	)

10017 
	#ASSERT_DEBUG_DEATH
(
¡©em’t
, 
»gex
) \

10018 
	$GTEST_EXECUTE_STATEMENT_
(
¡©em’t
, 
»gex
)

	)

10022 
	#EXPECT_DEBUG_DEATH
(
¡©em’t
, 
»gex
) \

10023 
	$EXPECT_DEATH
(
¡©em’t
, 
»gex
)

	)

10025 
	#ASSERT_DEBUG_DEATH
(
¡©em’t
, 
»gex
) \

10026 
	$ASSERT_DEATH
(
¡©em’t
, 
»gex
)

	)

10066 
	#GTEST_UNSUPPORTED_DEATH_TEST
(
¡©em’t
, 
»gex
, 
‹rmš©Ü
) \

10067 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

10068 ià(::
‹¡šg
::
š‹º®
::
	$AlwaysTrue
()) { \

10069 
	`GTEST_LOG_
(
WARNING
) \

10072 
	}
} ià(::
‹¡šg
::
š‹º®
::
	$AlwaysF®£
()) { \

10073 ::
‹¡šg
::
š‹º®
::
RE
::
	`P¬tŸlM©ch
(".*", (
»gex
)); \

10074 
	`GTEST_SUPPRESS_UNREACHABLE_CODE_WARNING_BELOW_
(
¡©em’t
); \

10075 
‹rmš©Ü
; \

10076 
	}
} \

10077 ::
‹¡šg
::
	$Mes§ge
()

	)

10084 #ià
GTEST_HAS_DEATH_TEST


10085 
	#EXPECT_DEATH_IF_SUPPORTED
(
¡©em’t
, 
»gex
) \

10086 
	$EXPECT_DEATH
(
¡©em’t
, 
»gex
)

	)

10087 
	#ASSERT_DEATH_IF_SUPPORTED
(
¡©em’t
, 
»gex
) \

10088 
	$ASSERT_DEATH
(
¡©em’t
, 
»gex
)

	)

10090 
	#EXPECT_DEATH_IF_SUPPORTED
(
¡©em’t
, 
»gex
) \

10091 
	$GTEST_UNSUPPORTED_DEATH_TEST
(
¡©em’t
, 
»gex
, )

	)

10092 
	#ASSERT_DEATH_IF_SUPPORTED
(
¡©em’t
, 
»gex
) \

10093 
	$GTEST_UNSUPPORTED_DEATH_TEST
(
¡©em’t
, 
»gex
, )

	)

10096 
	}
}

10134 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_PARAM_TEST_H_


10135 
	#GTEST_INCLUDE_GTEST_GTEST_PARAM_TEST_H_


	)

10153 
şass
 
	gFooTe¡
 : 
public
 ::
‹¡šg
::
Te¡W™hP¬am
<const *> {

10161 
	$TEST_P
(
FooTe¡
, 
DÛsBÏh
) {

10164 
	`EXPECT_TRUE
(
foo
.
	`BÏh
(
	`G‘P¬am
()));

10166 
	}
}

10168 
	$TEST_P
(
FooTe¡
, 
HasBÏhBÏh
) {

10170 
	}
}

10196 
INSTANTIATE_TEST_SUITE_P
(
In¡ªtŸtiÚName
,

10197 
FooTe¡
,

10198 
V®ues
("meeny", "miny", "moe"));

10219 cÚ¡ * 
	g³ts
[] = {"cat", "dog"};

10220 
INSTANTIATE_TEST_SUITE_P
(
AnÙh”In¡ªtŸtiÚName
, 
FooTe¡
, 
V®uesIn
(
³ts
));

10255 şas 
	cBa£Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

10260 
şass
 
	gD”ivedTe¡
 : 
public
 
Ba£Te¡
, 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<> {

10264 
	$TEST_F
(
Ba£Te¡
, 
HasFoo
) {

10266 
	}
}

10268 
	$TEST_P
(
D”ivedTe¡
, 
DÛsBÏh
) {

10270 
	`EXPECT_TRUE
(
foo
.
	`BÏh
(
	`G‘P¬am
()));

10271 
	}
}

10275 
	~<™”©Ü
>

10276 
	~<ut™y
>

10312 #iâdeà
GTEST_INCLUDE_GTEST_INTERNAL_GTEST_PARAM_UTIL_H_


10313 
	#GTEST_INCLUDE_GTEST_INTERNAL_GTEST_PARAM_UTIL_H_


	)

10315 
	~<ùy³.h
>

10317 
	~<ÿs£¹
>

10318 
	~<™”©Ü
>

10319 
	~<memÜy
>

10320 
	~<£t
>

10321 
	~<tu¶e
>

10322 
	~<ut™y
>

10323 
	~<veùÜ
>

10326 
Çme¥aû
 
	g‹¡šg
 {

10329 
	g‹m¶©e
 <
şass
 
	gP¬amTy³
>

10330 
	sTe¡P¬amInfo
 {

10331 
Te¡P¬amInfo
(cÚ¡ 
P¬amTy³
& 
a_·¿m
, 
size_t
 
ª_šdex
) :

10332 
·¿m
(
a_·¿m
),

10333 
šdex
(
ª_šdex
) {}

10334 
P¬amTy³
 
	g·¿m
;

10335 
size_t
 
	gšdex
;

10340 
	sPrštToSŒšgP¬amName
 {

10341 
	g‹m¶©e
 <
şass
 
	gP¬amTy³
>

10342 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
Te¡P¬amInfo
<
P¬amTy³
>& 
šfo
) const {

10343  
PrštToSŒšg
(
šfo
.
·¿m
);

10347 
Çme¥aû
 
	gš‹º®
 {

10356 
GTEST_API_
 
R•ÜtInv®idTe¡Su™eTy³
(cÚ¡ * 
‹¡_su™e_Çme
,

10357 
CodeLoÿtiÚ
 
code_loÿtiÚ
);

10359 
	g‹m¶©e
 <
	gty³Çme
> 
şass
 
	gP¬amG’”©ÜIÁ”çû
;

10360 
	g‹m¶©e
 <
	gty³Çme
> 
şass
 
	gP¬amG’”©Ü
;

10364 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

10365 şas 
	cP¬amI‹¿tÜIÁ”çû
 {

10366 
	gpublic
:

10367 
vœtu®
 ~
P¬amI‹¿tÜIÁ”çû
() {}

10371 
vœtu®
 cÚ¡ 
P¬amG’”©ÜIÁ”çû
<
T
>* 
Ba£G’”©Ü
() const = 0;

10376 
vœtu®
 
Advªû
() = 0;

10379 
vœtu®
 
P¬amI‹¿tÜIÁ”çû
* 
ClÚe
() const = 0;

10384 
vœtu®
 cÚ¡ 
T
* 
Cu¼’t
() const = 0;

10388 
vœtu®
 
boŞ
 
Equ®s
(cÚ¡ 
P¬amI‹¿tÜIÁ”çû
& 
Ùh”
) const = 0;

10394 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

10395 şas 
	cP¬amI‹¿tÜ
 {

10396 
	gpublic
:

10397 
T
 
	tv®ue_ty³
;

10398 cÚ¡ 
	tT
& 
	t»ã»nû
;

10399 
±rdiff_t
 
	tdifã»nû_ty³
;

10402 
P¬amI‹¿tÜ
(cÚ¡ P¬amI‹¿tÜ& 
Ùh”
è: 
im¶_
(Ùh”.im¶_->
ClÚe
()) {}

10403 
P¬amI‹¿tÜ
& 
İ”©Ü
=(cÚ¡ P¬amI‹¿tÜ& 
Ùh”
) {

10404 ià(
this
 !ğ&
Ùh”
)

10405 
im¶_
.
»£t
(
Ùh”
.im¶_->
ClÚe
());

10406  *
	gthis
;

10409 cÚ¡ 
	gT
& 
	gİ”©Ü
*(ècÚ¡ {  *
	gim¶_
->
Cu¼’t
(); }

10410 cÚ¡ 
T
* 
	gİ”©Ü
->(ècÚ¡ {  
	gim¶_
->
Cu¼’t
(); }

10412 
	gP¬amI‹¿tÜ
& 
	gİ”©Ü
++() {

10413 
	gim¶_
->
Advªû
();

10414  *
	gthis
;

10417 
P¬amI‹¿tÜ
 
	gİ”©Ü
++() {

10418 
	gP¬amI‹¿tÜIÁ”çû
<
	gT
>* 
	gşÚe
 = 
im¶_
->
ClÚe
();

10419 
	gim¶_
->
Advªû
();

10420  
P¬amI‹¿tÜ
(
şÚe
);

10422 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
P¬amI‹¿tÜ
& 
Ùh”
) const {

10423  
im¶_
.
g‘
(è=ğ
Ùh”
.im¶_.g‘(è|| im¶_->
Equ®s
(*other.impl_);

10425 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
P¬amI‹¿tÜ
& 
Ùh”
) const {

10426  !(*
this
 =ğ
Ùh”
);

10429 
	g´iv©e
:

10430 
ä›nd
 
şass
 
P¬amG’”©Ü
<
T
>;

10431 
ex¶ic™
 
P¬amI‹¿tÜ
(
P¬amI‹¿tÜIÁ”çû
<
T
>* 
im¶
è: 
im¶_
(impl) {}

10432 
¡d
::
unique_±r
<
P¬amI‹¿tÜIÁ”çû
<
T
> > 
im¶_
;

10437 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

10438 şas 
	cP¬amG’”©ÜIÁ”çû
 {

10439 
	gpublic
:

10440 
T
 
	tP¬amTy³
;

10442 
	gvœtu®
 ~
P¬amG’”©ÜIÁ”çû
() {}

10445 
vœtu®
 
	gP¬amI‹¿tÜIÁ”çû
<
	gT
>* 
Begš
() const = 0;

10446 
vœtu®
 
	gP¬amI‹¿tÜIÁ”çû
<
	gT
>* 
End
() const = 0;

10454 
	g‹m¶©e
<
ty³Çme
 
	gT
>

10455 şas 
	cP¬amG’”©Ü
 {

10456 
	gpublic
:

10457 
P¬amI‹¿tÜ
<
	tT
> 
	t™”©Ü
;

10459 
ex¶ic™
 
P¬amG’”©Ü
(
P¬amG’”©ÜIÁ”çû
<
T
>* 
im¶
è: 
im¶_
(impl) {}

10460 
P¬amG’”©Ü
(cÚ¡ P¬amG’”©Ü& 
Ùh”
è: 
im¶_
(other.impl_) {}

10462 
P¬amG’”©Ü
& 
İ”©Ü
=(cÚ¡ P¬amG’”©Ü& 
Ùh”
) {

10463 
im¶_
 = 
Ùh”
.impl_;

10464  *
	gthis
;

10467 
™”©Ü
 
begš
(ècÚ¡ {  i‹¿tÜ(
im¶_
->
Begš
()); }

10468 
™”©Ü
 
’d
(ècÚ¡ {  i‹¿tÜ(
im¶_
->
End
()); }

10470 
	g´iv©e
:

10471 
¡d
::
sh¬ed_±r
<cÚ¡ 
P¬amG’”©ÜIÁ”çû
<
T
> > 
im¶_
;

10478 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gInüem’tT
>

10479 
şass
 
	gRªgeG’”©Ü
 : 
public
 
P¬amG’”©ÜIÁ”çû
<
T
> {

10480 
public
:

10481 
RªgeG’”©Ü
(
T
 
begš
, T 
’d
, 
Inüem’tT
 
¡•
)

10482 : 
begš_
(
begš
), 
’d_
(
’d
),

10483 
¡•_
(
¡•
), 
’d_šdex_
(
C®cuÏ‹EndIndex
(
begš
, 
’d
, step)) {}

10484 ~
RªgeG’”©Ü
(è
	gov”ride
 {}

10486 
	gP¬amI‹¿tÜIÁ”çû
<
	gT
>* 
Begš
(ècÚ¡ 
	gov”ride
 {

10487  
Ãw
 
I‹¿tÜ
(
this
, 
begš_
, 0, 
¡•_
);

10489 
	gP¬amI‹¿tÜIÁ”çû
<
	gT
>* 
End
(ècÚ¡ 
	gov”ride
 {

10490  
Ãw
 
I‹¿tÜ
(
this
, 
’d_
, 
’d_šdex_
, 
¡•_
);

10493 
	g´iv©e
:

10494 
şass
 
I‹¿tÜ
 : 
public
 
P¬amI‹¿tÜIÁ”çû
<
T
> {

10495 
public
:

10496 
I‹¿tÜ
(cÚ¡ 
P¬amG’”©ÜIÁ”çû
<
T
>* 
ba£
, T 
v®ue
, 
šdex
,

10497 
Inüem’tT
 
¡•
)

10498 : 
ba£_
(
ba£
), 
v®ue_
(
v®ue
), 
šdex_
(
šdex
), 
¡•_
(
¡•
) {}

10499 ~
I‹¿tÜ
(è
	gov”ride
 {}

10501 cÚ¡ 
	gP¬amG’”©ÜIÁ”çû
<
	gT
>* 
Ba£G’”©Ü
(ècÚ¡ 
	gov”ride
 {

10502  
	gba£_
;

10504 
Advªû
(è
	gov”ride
 {

10505 
	gv®ue_
 = 
¡©ic_ÿ¡
<
T
>(
v®ue_
 + 
¡•_
);

10506 
	gšdex_
++;

10508 
	gP¬amI‹¿tÜIÁ”çû
<
	gT
>* 
ClÚe
(ècÚ¡ 
	gov”ride
 {

10509  
Ãw
 
I‹¿tÜ
(*
this
);

10511 cÚ¡ 
T
* 
Cu¼’t
(ècÚ¡ 
	gov”ride
 {  &
	gv®ue_
; }

10512 
boŞ
 
Equ®s
(cÚ¡ 
P¬amI‹¿tÜIÁ”çû
<
T
>& 
Ùh”
ècÚ¡ 
	gov”ride
 {

10515 
GTEST_CHECK_
(
Ba£G’”©Ü
(è=ğ
Ùh”
.BaseGenerator())

10517 << "äom difã»Á g’”©Üs." << 
¡d
::
’dl
;

10518 cÚ¡ 
	gÙh”_šdex
 =

10519 
CheckedDownÿ¡ToAùu®Ty³
<cÚ¡ 
I‹¿tÜ
>(&
Ùh”
)->
šdex_
;

10520  
	gšdex_
 =ğ
Ùh”_šdex
;

10523 
	g´iv©e
:

10524 
I‹¿tÜ
(cÚ¡ I‹¿tÜ& 
Ùh”
)

10525 : 
P¬amI‹¿tÜIÁ”çû
<
T
>(),

10526 
ba£_
(
Ùh”
.ba£_), 
v®ue_
(Ùh”.v®ue_), 
šdex_
(other.index_),

10527 
¡•_
(
Ùh”
.step_) {}

10530 
	gİ”©Ü
=(cÚ¡ 
I‹¿tÜ
& 
Ùh”
);

10532 cÚ¡ 
	gP¬amG’”©ÜIÁ”çû
<
	gT
>* cÚ¡ 
	gba£_
;

10533 
T
 
	gv®ue_
;

10534 
	gšdex_
;

10535 cÚ¡ 
Inüem’tT
 
	g¡•_
;

10538 
C®cuÏ‹EndIndex
(cÚ¡ 
T
& 
begš
,

10539 cÚ¡ 
T
& 
’d
,

10540 cÚ¡ 
Inüem’tT
& 
¡•
) {

10541 
	g’d_šdex
 = 0;

10542 
T
 
	gi
 = 
begš
; i < 
	g’d
; i = 
¡©ic_ÿ¡
<T>(
i
 + 
¡•
))

10543 
’d_šdex
++;

10544  
	g’d_šdex
;

10548 
	gİ”©Ü
=(cÚ¡ 
RªgeG’”©Ü
& 
Ùh”
);

10550 cÚ¡ 
T
 
	gbegš_
;

10551 cÚ¡ 
T
 
	g’d_
;

10552 cÚ¡ 
Inüem’tT
 
	g¡•_
;

10555 cÚ¡ 
	g’d_šdex_
;

10563 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

10564 
şass
 
	gV®uesInI‹¿tÜRªgeG’”©Ü
 : 
public
 
P¬amG’”©ÜIÁ”çû
<
T
> {

10565 
public
:

10566 
‹m¶©e
 <
ty³Çme
 
FÜw¬dI‹¿tÜ
>

10567 
V®uesInI‹¿tÜRªgeG’”©Ü
(
FÜw¬dI‹¿tÜ
 
begš
, FÜw¬dI‹¿tÜ 
’d
)

10568 : 
cÚš”_
(
begš
, 
’d
) {}

10569 ~
V®uesInI‹¿tÜRªgeG’”©Ü
(è
	gov”ride
 {}

10571 
	gP¬amI‹¿tÜIÁ”çû
<
	gT
>* 
Begš
(ècÚ¡ 
	gov”ride
 {

10572  
Ãw
 
I‹¿tÜ
(
this
, 
cÚš”_
.
begš
());

10574 
	gP¬amI‹¿tÜIÁ”çû
<
	gT
>* 
End
(ècÚ¡ 
	gov”ride
 {

10575  
Ãw
 
I‹¿tÜ
(
this
, 
cÚš”_
.
’d
());

10578 
	g´iv©e
:

10579 
ty³Çme
 ::
	t¡d
::
	tveùÜ
<
	tT
> 
	tCÚš”Ty³
;

10581 
şass
 
	gI‹¿tÜ
 : 
public
 
P¬amI‹¿tÜIÁ”çû
<
T
> {

10582 
public
:

10583 
I‹¿tÜ
(cÚ¡ 
P¬amG’”©ÜIÁ”çû
<
T
>* 
ba£
,

10584 
ty³Çme
 
CÚš”Ty³
::
cÚ¡_™”©Ü
 
™”©Ü
)

10585 : 
ba£_
(
ba£
), 
™”©Ü_
(
™”©Ü
) {}

10586 ~
I‹¿tÜ
(è
	gov”ride
 {}

10588 cÚ¡ 
	gP¬amG’”©ÜIÁ”çû
<
	gT
>* 
Ba£G’”©Ü
(ècÚ¡ 
	gov”ride
 {

10589  
	gba£_
;

10591 
Advªû
(è
	gov”ride
 {

10592 ++
	g™”©Ü_
;

10593 
	gv®ue_
.
»£t
();

10595 
	gP¬amI‹¿tÜIÁ”çû
<
	gT
>* 
ClÚe
(ècÚ¡ 
	gov”ride
 {

10596  
Ãw
 
I‹¿tÜ
(*
this
);

10605 cÚ¡ 
T
* 
Cu¼’t
(ècÚ¡ 
	gov”ride
 {

10606 ià(
	gv®ue_
.
g‘
(è=ğ
nuÎ±r
è
v®ue_
.
»£t
(
Ãw
 
T
(*
™”©Ü_
));

10607  
	gv®ue_
.
g‘
();

10609 
boŞ
 
Equ®s
(cÚ¡ 
P¬amI‹¿tÜIÁ”çû
<
T
>& 
Ùh”
ècÚ¡ 
	gov”ride
 {

10612 
GTEST_CHECK_
(
Ba£G’”©Ü
(è=ğ
Ùh”
.BaseGenerator())

10614 << "äom difã»Á g’”©Üs." << 
¡d
::
’dl
;

10615  
	g™”©Ü_
 ==

10616 
CheckedDownÿ¡ToAùu®Ty³
<cÚ¡ 
I‹¿tÜ
>(&
Ùh”
)->
™”©Ü_
;

10619 
	g´iv©e
:

10620 
I‹¿tÜ
(cÚ¡ I‹¿tÜ& 
Ùh”
)

10623 : 
P¬amI‹¿tÜIÁ”çû
<
T
>(),

10624 
ba£_
(
Ùh”
.base_),

10625 
™”©Ü_
(
Ùh”
.iterator_) {}

10627 cÚ¡ 
	gP¬amG’”©ÜIÁ”çû
<
	gT
>* cÚ¡ 
	gba£_
;

10628 
ty³Çme
 
	gCÚš”Ty³
::
cÚ¡_™”©Ü
 
™”©Ü_
;

10634 
mubË
 
	g¡d
::
unique_±r
<cÚ¡ 
T
> 
v®ue_
;

10638 
	gİ”©Ü
=(cÚ¡ 
V®uesInI‹¿tÜRªgeG’”©Ü
& 
Ùh”
);

10640 cÚ¡ 
CÚš”Ty³
 
	gcÚš”_
;

10647 
	g‹m¶©e
 <
şass
 
	gP¬amTy³
>

10648 
	g¡d
::
¡ršg
 
DeçuÉP¬amName
(cÚ¡ 
Te¡P¬amInfo
<
P¬amTy³
>& 
šfo
) {

10649 
Mes§ge
 
Çme_¡»am
;

10650 
	gÇme_¡»am
 << 
	gšfo
.
	gšdex
;

10651  
	gÇme_¡»am
.
G‘SŒšg
();

10654 
	g‹m¶©e
 <
ty³Çme
 
	gT
 = >

10655 
Te¡NÙEm±y
() {

10656 
¡©ic_as£¹
((
T
) == 0, "Empty‡rguments‡re‚ot‡llowed.");

10658 
	g‹m¶©e
 <
ty³Çme
 
	gT
 = >

10659 
Te¡NÙEm±y
(cÚ¡ 
T
&) {}

10665 
‹m¶©e
 <
şass
 
Te¡CÏss
>

10666 şas 
	cP¬am‘”izedTe¡FaùÜy
 : 
public
 
Te¡FaùÜyBa£
 {

10667 
public
:

10668 
ty³Çme
 
	tTe¡CÏss
::
	tP¬amTy³
 ParamType;

10669 
ex¶ic™
 
P¬am‘”izedTe¡FaùÜy
(
P¬amTy³
 
·¿m‘”
) :

10670 
·¿m‘”_
(
·¿m‘”
) {}

10671 
Te¡
* 
C»©eTe¡
(è
ov”ride
 {

10672 
Te¡CÏss
::
S‘P¬am
(&
·¿m‘”_
);

10673  
Ãw
 
Te¡CÏss
();

10676 
	g´iv©e
:

10677 cÚ¡ 
P¬amTy³
 
·¿m‘”_
;

10679 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
P¬am‘”izedTe¡FaùÜy
);

10686 
	g‹m¶©e
 <
şass
 
	gP¬amTy³
>

10687 şas 
	cTe¡M‘aFaùÜyBa£
 {

10688 
	gpublic
:

10689 
vœtu®
 ~
Te¡M‘aFaùÜyBa£
() {}

10691 
vœtu®
 
Te¡FaùÜyBa£
* 
C»©eTe¡FaùÜy
(
P¬amTy³
 
·¿m‘”
) = 0;

10702 
	g‹m¶©e
 <
şass
 
	gTe¡Su™e
>

10703 
şass
 
	gTe¡M‘aFaùÜy


10704 : 
public
 
Te¡M‘aFaùÜyBa£
<
ty³Çme
 
Te¡Su™e
::
P¬amTy³
> {

10705 
public
:

10706 
usšg
 
P¬amTy³
 = 
ty³Çme
 
Te¡Su™e
::ParamType;

10708 
Te¡M‘aFaùÜy
() {}

10710 
Te¡FaùÜyBa£
* 
C»©eTe¡FaùÜy
(
P¬amTy³
 
·¿m‘”
è
	gov”ride
 {

10711  
Ãw
 
	gP¬am‘”izedTe¡FaùÜy
<
	gTe¡Su™e
>(
	g·¿m‘”
);

10714 
	g´iv©e
:

10715 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Te¡M‘aFaùÜy
);

10728 şas 
	cP¬am‘”izedTe¡Su™eInfoBa£
 {

10729 
	gpublic
:

10730 
vœtu®
 ~
P¬am‘”izedTe¡Su™eInfoBa£
() {}

10733 
vœtu®
 cÚ¡ 
¡d
::
¡ršg
& 
G‘Te¡Su™eName
() const = 0;

10735 
vœtu®
 
Ty³Id
 
G‘Te¡Su™eTy³Id
() const = 0;

10740 
vœtu®
 
Regi¡”Te¡s
() = 0;

10742 
	g´Ùeùed
:

10743 
P¬am‘”izedTe¡Su™eInfoBa£
() {}

10745 
´iv©e
:

10746 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
P¬am‘”izedTe¡Su™eInfoBa£
);

10756 
	g‹m¶©e
 <
şass
 
	gTe¡Su™e
>

10757 şas 
	cP¬am‘”izedTe¡Su™eInfo
 : 
public
 
P¬am‘”izedTe¡Su™eInfoBa£
 {

10758 
public
:

10762 
usšg
 
P¬amTy³
 = 
ty³Çme
 
Te¡Su™e
::ParamType;

10764 
	gP¬amG’”©Ü
<
	tP¬amTy³
>(
	tG’”©ÜC»©iÚFunc
)();

10765 
usšg
 
	gP¬amNameG’”©ÜFunc
 = 
¡d
::
¡ršg
(cÚ¡ 
Te¡P¬amInfo
<
P¬amTy³
>&);

10767 
ex¶ic™
 
P¬am‘”izedTe¡Su™eInfo
(cÚ¡ * 
Çme
,

10768 
CodeLoÿtiÚ
 
code_loÿtiÚ
)

10769 : 
‹¡_su™e_Çme_
(
Çme
), 
code_loÿtiÚ_
(
code_loÿtiÚ
) {}

10772 cÚ¡ 
	g¡d
::
¡ršg
& 
G‘Te¡Su™eName
(ècÚ¡ 
ov”ride
 {

10773  
‹¡_su™e_Çme_
;

10776 
Ty³Id
 
G‘Te¡Su™eTy³Id
(ècÚ¡ 
	gov”ride
 {  
	gG‘Ty³Id
<
	gTe¡Su™e
>(); }

10783 
AddTe¡P©‹º
(cÚ¡ * 
‹¡_su™e_Çme
, cÚ¡ * 
‹¡_ba£_Çme
,

10784 
Te¡M‘aFaùÜyBa£
<
P¬amTy³
>* 
m‘a_çùÜy
) {

10785 
	g‹¡s_
.
push_back
(
¡d
::
sh¬ed_±r
<
Te¡Info
>(

10786 
Ãw
 
Te¡Info
(
‹¡_su™e_Çme
, 
‹¡_ba£_Çme
, 
m‘a_çùÜy
)));

10790 
AddTe¡Su™eIn¡ªtŸtiÚ
(cÚ¡ 
¡d
::
¡ršg
& 
š¡ªtŸtiÚ_Çme
,

10791 
G’”©ÜC»©iÚFunc
* 
func
,

10792 
P¬amNameG’”©ÜFunc
* 
Çme_func
,

10793 cÚ¡ * 
fe
, 
lše
) {

10794 
	gš¡ªtŸtiÚs_
.
push_back
(

10795 
In¡ªtŸtiÚInfo
(
š¡ªtŸtiÚ_Çme
, 
func
, 
Çme_func
, 
fe
, 
lše
));

10803 
Regi¡”Te¡s
(è
	gov”ride
 {

10804 
ty³Çme
 
	gTe¡InfoCÚš”
::
™”©Ü
 
‹¡_™
 = 
‹¡s_
.
begš
();

10805 
	g‹¡_™
 !ğ
‹¡s_
.
’d
(); ++test_it) {

10806 
	g¡d
::
sh¬ed_±r
<
Te¡Info
> 
‹¡_šfo
 = *
‹¡_™
;

10807 
ty³Çme
 
	gIn¡ªtŸtiÚCÚš”
::
™”©Ü
 
g’_™
 =

10808 
š¡ªtŸtiÚs_
.
begš
(); 
	gg’_™
 !ğš¡ªtŸtiÚs_.
’d
();

10809 ++
	gg’_™
) {

10810 cÚ¡ 
	g¡d
::
¡ršg
& 
š¡ªtŸtiÚ_Çme
 = 
g’_™
->
Çme
;

10811 
	gP¬amG’”©Ü
<
	gP¬amTy³
> 
g’”©Ü
((*
g’_™
->generator)());

10812 
P¬amNameG’”©ÜFunc
* 
	gÇme_func
 = 
g’_™
->
Çme_func
;

10813 cÚ¡ * 
	gfe
 = 
g’_™
->
fe
;

10814 
	glše
 = 
g’_™
->
lše
;

10816 
	g¡d
::
¡ršg
 
‹¡_su™e_Çme
;

10817 iàĞ!
	gš¡ªtŸtiÚ_Çme
.
em±y
() )

10818 
	g‹¡_su™e_Çme
 = 
š¡ªtŸtiÚ_Çme
 + "/";

10819 
	g‹¡_su™e_Çme
 +ğ
‹¡_šfo
->
‹¡_su™e_ba£_Çme
;

10821 
size_t
 
	gi
 = 0;

10822 
	g¡d
::
£t
<
¡d
::
¡ršg
> 
‹¡_·¿m_Çmes
;

10823 
ty³Çme
 
	gP¬amG’”©Ü
<
	gP¬amTy³
>::
™”©Ü
 
·¿m_™
 =

10824 
g’”©Ü
.
begš
();

10825 
	g·¿m_™
 !ğ
g’”©Ü
.
’d
(); ++·¿m_™, ++
	gi
) {

10826 
Mes§ge
 
	g‹¡_Çme_¡»am
;

10828 
	g¡d
::
¡ršg
 
·¿m_Çme
 = 
Çme_func
(

10829 
Te¡P¬amInfo
<
P¬amTy³
>(*
·¿m_™
, 
i
));

10831 
GTEST_CHECK_
(
IsV®idP¬amName
(
·¿m_Çme
))

10832 << "P¬am‘”izede¡‚am'" << 
	g·¿m_Çme


10833 << "' i šv®id, iÀ" << 
	gfe


10834 << "†š" << 
	glše
 << 
	g¡d
::
’dl
;

10836 
GTEST_CHECK_
(
‹¡_·¿m_Çmes
.
couÁ
(
·¿m_Çme
) == 0)

10837 << "Du¶iÿ‹…¬am‘”izede¡‚am'" << 
·¿m_Çme


10838 << "', iÀ" << 
fe
 << "†š" << 
lše
 << 
¡d
::
’dl
;

10840 
	g‹¡_·¿m_Çmes
.
š£¹
(
·¿m_Çme
);

10842 ià(!
	g‹¡_šfo
->
	g‹¡_ba£_Çme
.
em±y
()) {

10843 
	g‹¡_Çme_¡»am
 << 
	g‹¡_šfo
->
	g‹¡_ba£_Çme
 << "/";

10845 
	g‹¡_Çme_¡»am
 << 
	g·¿m_Çme
;

10846 
MakeAndRegi¡”Te¡Info
(

10847 
‹¡_su™e_Çme
.
c_¡r
(), 
‹¡_Çme_¡»am
.
G‘SŒšg
().c_str(),

10848 
nuÎ±r
,

10849 
PrštToSŒšg
(*
·¿m_™
).
c_¡r
(), 
code_loÿtiÚ_
,

10850 
G‘Te¡Su™eTy³Id
(),

10851 
Su™eApiResŞv”
<
Te¡Su™e
>::
G‘S‘UpCa£OrSu™e
(
fe
, 
lše
),

10852 
Su™eApiResŞv”
<
Te¡Su™e
>::
G‘T—rDownCa£OrSu™e
(
fe
, 
lše
),

10853 
‹¡_šfo
->
‹¡_m‘a_çùÜy
->
C»©eTe¡FaùÜy
(*
·¿m_™
));

10859 
	g´iv©e
:

10862 
	sTe¡Info
 {

10863 
Te¡Info
(cÚ¡ * 
a_‹¡_su™e_ba£_Çme
, cÚ¡ * 
a_‹¡_ba£_Çme
,

10864 
Te¡M‘aFaùÜyBa£
<
P¬amTy³
>* 
a_‹¡_m‘a_çùÜy
)

10865 : 
‹¡_su™e_ba£_Çme
(
a_‹¡_su™e_ba£_Çme
),

10866 
‹¡_ba£_Çme
(
a_‹¡_ba£_Çme
),

10867 
‹¡_m‘a_çùÜy
(
a_‹¡_m‘a_çùÜy
) {}

10869 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_su™e_ba£_Çme
;

10870 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_ba£_Çme
;

10871 cÚ¡ 
	g¡d
::
unique_±r
<
Te¡M‘aFaùÜyBa£
<
P¬amTy³
> > 
‹¡_m‘a_çùÜy
;

10873 
usšg
 
	gTe¡InfoCÚš”
 = ::
¡d
::
veùÜ
<¡d::
sh¬ed_±r
<
Te¡Info
> >;

10877 
	sIn¡ªtŸtiÚInfo
 {

10878 
In¡ªtŸtiÚInfo
(cÚ¡ 
¡d
::
¡ršg
 &
Çme_š
,

10879 
G’”©ÜC»©iÚFunc
* 
g’”©Ü_š
,

10880 
P¬amNameG’”©ÜFunc
* 
Çme_func_š
,

10881 cÚ¡ * 
fe_š
,

10882 
lše_š
)

10883 : 
Çme
(
Çme_š
),

10884 
g’”©Ü
(
g’”©Ü_š
),

10885 
Çme_func
(
Çme_func_š
),

10886 
fe
(
fe_š
),

10887 
lše
(
lše_š
) {}

10889 
	g¡d
::
¡ršg
 
Çme
;

10890 
G’”©ÜC»©iÚFunc
* 
	gg’”©Ü
;

10891 
P¬amNameG’”©ÜFunc
* 
	gÇme_func
;

10892 cÚ¡ * 
	gfe
;

10893 
	glše
;

10895 ::
¡d
::
	tveùÜ
<
	tIn¡ªtŸtiÚInfo
> 
	tIn¡ªtŸtiÚCÚš”
;

10897 
boŞ
 
IsV®idP¬amName
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
) {

10899 ià(
Çme
.
em±y
())

10900  
çl£
;

10903 
	g¡d
::
¡ršg
::
size_ty³
 
šdex
 = 0; 
	gšdex
 < 
	gÇme
.
size
(); ++index) {

10904 ià(!
i§Êum
(
Çme
[
šdex
]è&& 
	gÇme
[index] != '_')

10905  
çl£
;

10908  
	gŒue
;

10911 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_su™e_Çme_
;

10912 
CodeLoÿtiÚ
 
	gcode_loÿtiÚ_
;

10913 
Te¡InfoCÚš”
 
	g‹¡s_
;

10914 
In¡ªtŸtiÚCÚš”
 
	gš¡ªtŸtiÚs_
;

10916 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
P¬am‘”izedTe¡Su™eInfo
);

10920 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


10921 
	g‹m¶©e
 <
şass
 
	gTe¡Ca£
>

10922 
usšg
 
	gP¬am‘”izedTe¡Ca£Info
 = 
P¬am‘”izedTe¡Su™eInfo
<
Te¡Ca£
>;

10931 şas 
	cP¬am‘”izedTe¡Su™eRegi¡ry
 {

10932 
	gpublic
:

10933 
P¬am‘”izedTe¡Su™eRegi¡ry
() {}

10934 ~
P¬am‘”izedTe¡Su™eRegi¡ry
() {

10935 auto& 
‹¡_su™e_šfo
 : 
‹¡_su™e_šfos_
) {

10936 
d–‘e
 
‹¡_su™e_šfo
;

10942 
	g‹m¶©e
 <
şass
 
	gTe¡Su™e
>

10943 
	gP¬am‘”izedTe¡Su™eInfo
<
	gTe¡Su™e
>* 
G‘Te¡Su™eP©‹ºHŞd”
(

10944 cÚ¡ * 
‹¡_su™e_Çme
, 
CodeLoÿtiÚ
 
code_loÿtiÚ
) {

10945 
	gP¬am‘”izedTe¡Su™eInfo
<
	gTe¡Su™e
>* 
	gty³d_‹¡_šfo
 = 
nuÎ±r
;

10946 auto& 
	g‹¡_su™e_šfo
 : 
‹¡_su™e_šfos_
) {

10947 ià(
‹¡_su™e_šfo
->
G‘Te¡Su™eName
(è=ğ
‹¡_su™e_Çme
) {

10948 ià(
‹¡_su™e_šfo
->
G‘Te¡Su™eTy³Id
(è!ğ
G‘Ty³Id
<
Te¡Su™e
>()) {

10952 
R•ÜtInv®idTe¡Su™eTy³
(
‹¡_su™e_Çme
, 
code_loÿtiÚ
);

10953 
	gposix
::
AbÜt
();

10958 
	gty³d_‹¡_šfo
 = 
CheckedDownÿ¡ToAùu®Ty³
<

10959 
P¬am‘”izedTe¡Su™eInfo
<
Te¡Su™e
> >(
‹¡_su™e_šfo
);

10964 ià(
	gty³d_‹¡_šfo
 =ğ
nuÎ±r
) {

10965 
ty³d_‹¡_šfo
 = 
Ãw
 
P¬am‘”izedTe¡Su™eInfo
<
Te¡Su™e
>(

10966 
‹¡_su™e_Çme
, 
	gcode_loÿtiÚ
);

10967 
	g‹¡_su™e_šfos_
.
push_back
(
ty³d_‹¡_šfo
);

10969  
	gty³d_‹¡_šfo
;

10971 
Regi¡”Te¡s
() {

10972 auto& 
	g‹¡_su™e_šfo
 : 
‹¡_su™e_šfos_
) {

10973 
‹¡_su™e_šfo
->
Regi¡”Te¡s
();

10977 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


10978 
	g‹m¶©e
 <
şass
 
	gTe¡Ca£
>

10979 
	gP¬am‘”izedTe¡Ca£Info
<
	gTe¡Ca£
>* 
G‘Te¡Ca£P©‹ºHŞd”
(

10980 cÚ¡ * 
‹¡_ÿ£_Çme
, 
CodeLoÿtiÚ
 
code_loÿtiÚ
) {

10981  
	gG‘Te¡Su™eP©‹ºHŞd”
<
	gTe¡Ca£
>(
	g‹¡_ÿ£_Çme
, 
	gcode_loÿtiÚ
);

10986 
	g´iv©e
:

10987 
usšg
 
Te¡Su™eInfoCÚš”
 = ::
¡d
::
veùÜ
<
P¬am‘”izedTe¡Su™eInfoBa£
*>;

10989 
Te¡Su™eInfoCÚš”
 
	g‹¡_su™e_šfos_
;

10991 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
P¬am‘”izedTe¡Su™eRegi¡ry
);

10998 
	g‹m¶©e
 <
şass
 
	gCÚš”
>

10999 
	gš‹º®
::
P¬amG’”©Ü
<
ty³Çme
 
CÚš”
::
v®ue_ty³
> 
V®uesIn
(

11000 cÚ¡ 
CÚš”
& 
cÚš”
);

11002 
Çme¥aû
 
	gš‹º®
 {

11005 
	g‹m¶©e
 <
	gty³Çme
... 
	gTs
>

11006 şas 
	cV®ueA¼ay
 {

11007 
	gpublic
:

11008 
V®ueA¼ay
(
Ts
... 
v
è: 
v_
{
¡d
::
move
(v)...} {}

11010 
‹m¶©e
 <
ty³Çme
 
T
>

11011 
İ”©Ü
 
P¬amG’”©Ü
<
T
>() const {

11012  
V®uesIn
(
MakeVeùÜ
<
T
>(
MakeIndexSequ’û
<...(
Ts
)>()));

11015 
	g´iv©e
:

11016 
‹m¶©e
 <
ty³Çme
 
T
, 
	gsize_t
... 
	gI
>

11017 
	g¡d
::
veùÜ
<
T
> 
MakeVeùÜ
(
IndexSequ’û
<
I
...>) const {

11018  
¡d
::
veùÜ
<
T
>{
¡©ic_ÿ¡
<T>(
v_
.
‹m¶©e
 
G‘
<
I
>())...};

11021 
	gFÏtTu¶e
<
	gTs
...> 
	gv_
;

11024 
	g‹m¶©e
 <
	gty³Çme
... 
	gT
>

11025 
şass
 
	gC¬‹sŸnProduùG’”©Ü


11026 : 
public
 
P¬amG’”©ÜIÁ”çû
<::
¡d
::
tu¶e
<
T
...>> {

11027 
public
:

11028 ::
¡d
::
	ttu¶e
<
	tT
...> 
	tP¬amTy³
;

11030 
C¬‹sŸnProduùG’”©Ü
(cÚ¡ 
¡d
::
tu¶e
<
P¬amG’”©Ü
<
T
>...>& 
g
)

11031 : 
g’”©Üs_
(
g
) {}

11032 ~
C¬‹sŸnProduùG’”©Ü
(è
ov”ride
 {}

11034 
P¬amI‹¿tÜIÁ”çû
<
P¬amTy³
>* 
Begš
(ècÚ¡ 
ov”ride
 {

11035  
Ãw
 
I‹¿tÜ
(
this
, 
g’”©Üs_
, 
çl£
);

11037 
	gP¬amI‹¿tÜIÁ”çû
<
	gP¬amTy³
>* 
End
(ècÚ¡ 
	gov”ride
 {

11038  
Ãw
 
I‹¿tÜ
(
this
, 
g’”©Üs_
, 
Œue
);

11041 
	g´iv©e
:

11042 
‹m¶©e
 <
şass
 
I
>

11043 
şass
 
I‹¿tÜIm¶
;

11044 
	g‹m¶©e
 <
	gsize_t
... 
	gI
>

11045 
şass
 
	gI‹¿tÜIm¶
<
	gIndexSequ’û
<
	gI
...>>

11046 : 
public
 
P¬amI‹¿tÜIÁ”çû
<
P¬amTy³
> {

11047 
public
:

11048 
I‹¿tÜIm¶
(cÚ¡ 
P¬amG’”©ÜIÁ”çû
<
P¬amTy³
>* 
ba£
,

11049 cÚ¡ 
¡d
::
tu¶e
<
P¬amG’”©Ü
<
T
>...>& 
g’”©Üs
, 
boŞ
 
is_’d
)

11050 : 
ba£_
(
ba£
),

11051 
begš_
(
¡d
::
g‘
<
I
>(
g’”©Üs
).
begš
()...),

11052 
’d_
(
¡d
::
g‘
<
I
>(
g’”©Üs
).
’d
()...),

11053 
cu¼’t_
(
is_’d
 ? 
’d_
 : 
begš_
) {

11054 
Compu‹Cu¼’tV®ue
();

11056 ~
I‹¿tÜIm¶
(è
	gov”ride
 {}

11058 cÚ¡ 
	gP¬amG’”©ÜIÁ”çû
<
	gP¬amTy³
>* 
Ba£G’”©Ü
(ècÚ¡ 
	gov”ride
 {

11059  
	gba£_
;

11063 
Advªû
(è
	gov”ride
 {

11064 
as£¹
(!
AtEnd
());

11066 ++
	g¡d
::
g‘
<...(
T
è- 1>(
cu¼’t_
);

11068 
	gAdvªûIfEnd
<...(
	gT
) - 1>();

11069 
Compu‹Cu¼’tV®ue
();

11071 
	gP¬amI‹¿tÜIÁ”çû
<
	gP¬amTy³
>* 
ClÚe
(ècÚ¡ 
	gov”ride
 {

11072  
Ãw
 
I‹¿tÜIm¶
(*
this
);

11075 cÚ¡ 
P¬amTy³
* 
Cu¼’t
(ècÚ¡ 
	gov”ride
 {  
	gcu¼’t_v®ue_
.
g‘
(); }

11077 
boŞ
 
Equ®s
(cÚ¡ 
P¬amI‹¿tÜIÁ”çû
<
P¬amTy³
>& 
Ùh”
ècÚ¡ 
	gov”ride
 {

11080 
GTEST_CHECK_
(
Ba£G’”©Ü
(è=ğ
Ùh”
.BaseGenerator())

11082 << "äom difã»Á g’”©Üs." << 
¡d
::
’dl
;

11083 cÚ¡ 
I‹¿tÜIm¶
* 
	gty³d_Ùh”
 =

11084 
CheckedDownÿ¡ToAùu®Ty³
<cÚ¡ 
I‹¿tÜIm¶
>(&
Ùh”
);

11089 ià(
AtEnd
(è&& 
	gty³d_Ùh”
->AtEnd()è 
	gŒue
;

11091 
boŞ
 
	g§me
 = 
Œue
;

11092 
boŞ
 
	gdummy
[] = {

11093 (
§me
 = sam&& 
¡d
::
g‘
<
I
>(
cu¼’t_
) ==

11094 
¡d
::
g‘
<
I
>(
ty³d_Ùh”
->
cu¼’t_
))...};

11095 ()
	gdummy
;

11096  
	g§me
;

11099 
	g´iv©e
:

11100 
‹m¶©e
 <
size_t
 
ThisI
>

11101 
AdvªûIfEnd
() {

11102 ià(
¡d
::
g‘
<
ThisI
>(
cu¼’t_
è!ğ¡d::g‘<ThisI>(
’d_
)) ;

11104 
boŞ
 
	gÏ¡
 = 
ThisI
 == 0;

11105 ià(
	gÏ¡
) {

11110 
cÚ¡ex´
 
size_t
 
	gNextI
 = 
ThisI
 - (ThisI != 0);

11111 
	g¡d
::
g‘
<
ThisI
>(
cu¼’t_
èğ
¡d
::g‘<ThisI>(
begš_
);

11112 ++
	g¡d
::
g‘
<
NextI
>(
cu¼’t_
);

11113 
	gAdvªûIfEnd
<
	gNextI
>();

11116 
Compu‹Cu¼’tV®ue
() {

11117 ià(!
AtEnd
())

11118 
	gcu¼’t_v®ue_
 = 
¡d
::
make_sh¬ed
<
P¬amTy³
>(*¡d::
g‘
<
I
>(
cu¼’t_
)...);

11120 
boŞ
 
AtEnd
() const {

11121 
boŞ
 
	g©_’d
 = 
çl£
;

11122 
boŞ
 
	gdummy
[] = {

11123 (
©_’d
 =‡t_’d || 
¡d
::
g‘
<
I
>(
cu¼’t_
è=ğ¡d::g‘<I>(
’d_
))...};

11124 ()
	gdummy
;

11125  
	g©_’d
;

11128 cÚ¡ 
	gP¬amG’”©ÜIÁ”çû
<
	gP¬amTy³
>* cÚ¡ 
	gba£_
;

11129 
	g¡d
::
tu¶e
<
ty³Çme
 
P¬amG’”©Ü
<
T
>::
™”©Ü
...> 
begš_
;

11130 
	g¡d
::
tu¶e
<
ty³Çme
 
P¬amG’”©Ü
<
T
>::
™”©Ü
...> 
’d_
;

11131 
	g¡d
::
tu¶e
<
ty³Çme
 
P¬amG’”©Ü
<
T
>::
™”©Ü
...> 
cu¼’t_
;

11132 
	g¡d
::
sh¬ed_±r
<
P¬amTy³
> 
cu¼’t_v®ue_
;

11135 
usšg
 
	gI‹¿tÜ
 = 
I‹¿tÜIm¶
<
ty³Çme
 
MakeIndexSequ’û
<...(
T
)>::
ty³
>;

11137 
	g¡d
::
tu¶e
<
P¬amG’”©Ü
<
T
>...> 
g’”©Üs_
;

11140 
	g‹m¶©e
 <
	gşass
... 
	gG’
>

11141 şas 
	cC¬‹sŸnProduùHŞd”
 {

11142 
	gpublic
:

11143 
C¬‹sŸnProduùHŞd”
(cÚ¡ 
G’
&... 
g
è: 
g’”©Üs_
(g...) {}

11144 
‹m¶©e
 <
ty³Çme
... 
T
>

11145 
İ”©Ü
 
P¬amG’”©Ü
<::
¡d
::
tu¶e
<
T
...>>() const {

11146  
P¬amG’”©Ü
<::
¡d
::
tu¶e
<
T
...>>(

11147 
Ãw
 
C¬‹sŸnProduùG’”©Ü
<
T
...>(
g’”©Üs_
));

11150 
	g´iv©e
:

11151 
¡d
::
tu¶e
<
G’
...> 
g’”©Üs_
;

11159 
Çme¥aû
 
	g‹¡šg
 {

11203 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gInüem’tT
>

11204 
	gš‹º®
::
P¬amG’”©Ü
<
T
> 
Rªge
(T 
¡¬t
, T 
’d
, 
Inüem’tT
 
¡•
) {

11205  
	gš‹º®
::
P¬amG’”©Ü
<
T
>(

11206 
Ãw
 
š‹º®
::
RªgeG’”©Ü
<
T
, 
	gInüem’tT
>(
	g¡¬t
, 
	g’d
, 
	g¡•
));

11209 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

11210 
	gš‹º®
::
P¬amG’”©Ü
<
T
> 
Rªge
(T 
¡¬t
, T 
’d
) {

11211  
Rªge
(
¡¬t
, 
’d
, 1);

11269 
	g‹m¶©e
 <
ty³Çme
 
	gFÜw¬dI‹¿tÜ
>

11270 
	gš‹º®
::
P¬amG’”©Ü
<

11271 
ty³Çme
 
¡d
::
™”©Ü_Œa™s
<
FÜw¬dI‹¿tÜ
>::
v®ue_ty³
>

11272 
V®uesIn
(
FÜw¬dI‹¿tÜ
 
begš
, FÜw¬dI‹¿tÜ 
’d
) {

11273 
ty³Çme
 
	t¡d
::
	t™”©Ü_Œa™s
<
	tFÜw¬dI‹¿tÜ
>::
	tv®ue_ty³
 
	tP¬amTy³
;

11274  
	gš‹º®
::
P¬amG’”©Ü
<
P¬amTy³
>(

11275 
Ãw
 
š‹º®
::
V®uesInI‹¿tÜRªgeG’”©Ü
<
P¬amTy³
>(
begš
, 
	g’d
));

11278 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gN
>

11279 
	gš‹º®
::
P¬amG’”©Ü
<
T
> 
V®uesIn
(cÚ¡ T (&
¬¿y
)[
N
]) {

11280  
V®uesIn
(
¬¿y
,‡¼ay + 
N
);

11283 
	g‹m¶©e
 <
şass
 
	gCÚš”
>

11284 
	gš‹º®
::
P¬amG’”©Ü
<
ty³Çme
 
CÚš”
::
v®ue_ty³
> 
V®uesIn
(

11285 cÚ¡ 
CÚš”
& 
cÚš”
) {

11286  
V®uesIn
(
cÚš”
.
begš
(), cÚš”.
’d
());

11309 
	g‹m¶©e
 <
	gty³Çme
... 
	gT
>

11310 
	gš‹º®
::
V®ueA¼ay
<
T
...> 
V®ues
(T... 
v
) {

11311  
š‹º®
::
V®ueA¼ay
<
T
...>(
¡d
::
move
(
v
)...);

11334 
šlše
 
	gš‹º®
::
P¬amG’”©Ü
<
boŞ
> 
BoŞ
() {

11335  
V®ues
(
çl£
, 
Œue
);

11384 
	g‹m¶©e
 <
	gty³Çme
... 
	gG’”©Ü
>

11385 
	gš‹º®
::
C¬‹sŸnProduùHŞd”
<
G’”©Ü
...> 
Combše
(cÚ¡ G’”©Ü&... 
g
) {

11386  
š‹º®
::
C¬‹sŸnProduùHŞd”
<
G’”©Ü
...>(
g
...);

11389 
	#TEST_P
(
‹¡_su™e_Çme
, 
‹¡_Çme
) \

11390 
şass
 
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, 
‹¡_Çme
) \

11391 : 
public
 
‹¡_su™e_Çme
 { \

11392 
public
: \

11393 
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, 
‹¡_Çme
)() {} \

11394 
vœtu®
 
	`Te¡Body
(); \

11396 
´iv©e
: \

11397 
	`AddToRegi¡ry
() { \

11398 ::
‹¡šg
::
Un™Te¡
::
	`G‘In¡ªû
() \

11399 ->
	`·¿m‘”ized_‹¡_»gi¡ry
() \

11400 .
G‘Te¡Su™eP©‹ºHŞd”
<
‹¡_su™e_Çme
>( \

11402 ::
‹¡šg
::
š‹º®
::
	`CodeLoÿtiÚ
(
__FILE__
, 
__LINE__
)) \

11403 ->
	`AddTe¡P©‹º
( \

11404 
	`GTEST_STRINGIFY_
(
‹¡_su™e_Çme
), GTEST_STRINGIFY_(
‹¡_Çme
), \

11405 
Ãw
 ::
‹¡šg
::
š‹º®
::
Te¡M‘aFaùÜy
<
	`GTEST_TEST_CLASS_NAME_
( \

11406 
‹¡_su™e_Çme
, 
‹¡_Çme
)>()); \

11409 
g‹¡_»gi¡”šg_dummy_
 
GTEST_ATTRIBUTE_UNUSED_
; \

11410 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, \

11411 
‹¡_Çme
)); \

11413 
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, \

11414 
‹¡_Çme
)::
g‹¡_»gi¡”šg_dummy_
 = \

11415 
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, 
‹¡_Çme
)::
	`AddToRegi¡ry
(); \

11416 
	`GTEST_TEST_CLASS_NAME_
(
‹¡_su™e_Çme
, 
‹¡_Çme
)::
	`Te¡Body
()

	)

11431 
	#GTEST_EXPAND_
(
¬g
è
	)
arg

11432 
	#GTEST_GET_FIRST_
(
fœ¡
, ...è
	)
first

11433 
	#GTEST_GET_SECOND_
(
fœ¡
, 
£cÚd
, ...è
	)
second

11435 
	#INSTANTIATE_TEST_SUITE_P
(
´efix
, 
‹¡_su™e_Çme
, ...) \

11436 ::
‹¡šg
::
š‹º®
::
P¬amG’”©Ü
<
‹¡_su™e_Çme
::
P¬amTy³
> \

11437 
g‹¡_
##
´efix
##
‹¡_su™e_Çme
##
	`_Ev®G’”©Ü_
() { \

11438  
	`GTEST_EXPAND_
(
	`GTEST_GET_FIRST_
(
__VA_ARGS__
, 
DUMMY_PARAM_
)); \

11440 ::
¡d
::
¡ršg
 
g‹¡_
##
´efix
##
‹¡_su™e_Çme
##
	`_Ev®G’”©eName_
( \

11441 cÚ¡ ::
‹¡šg
::
Te¡P¬amInfo
<
‹¡_su™e_Çme
::
P¬amTy³
>& 
šfo
) { \

11442 ià(::
‹¡šg
::
š‹º®
::
	`AlwaysF®£
()) { \

11443 ::
‹¡šg
::
š‹º®
::
	`Te¡NÙEm±y
(
	`GTEST_EXPAND_
(
	`GTEST_GET_SECOND_
( \

11444 
__VA_ARGS__
, \

11445 ::
‹¡šg
::
š‹º®
::
DeçuÉP¬amName
<
‹¡_su™e_Çme
::
P¬amTy³
>, \

11446 
DUMMY_PARAM_
))); \

11447 autØ
t
 = 
¡d
::
	`make_tu¶e
(
__VA_ARGS__
); \

11448 
	`¡©ic_as£¹
(
¡d
::
tu¶e_size
<
	`deşty³
(
t
)>::
v®ue
 <= 2, \

11451  ((
	`GTEST_EXPAND_
(
	`GTEST_GET_SECOND_
( \

11452 
__VA_ARGS__
, \

11453 ::
‹¡šg
::
š‹º®
::
DeçuÉP¬amName
<
‹¡_su™e_Çme
::
P¬amTy³
>, \

11454 
DUMMY_PARAM_
))))(
šfo
); \

11456 
g‹¡_
##
´efix
##
‹¡_su™e_Çme
##
_dummy_
 \

11457 
GTEST_ATTRIBUTE_UNUSED_
 = \

11458 ::
‹¡šg
::
Un™Te¡
::
	`G‘In¡ªû
() \

11459 ->
	`·¿m‘”ized_‹¡_»gi¡ry
() \

11460 .
G‘Te¡Su™eP©‹ºHŞd”
<
‹¡_su™e_Çme
>( \

11462 ::
‹¡šg
::
š‹º®
::
	`CodeLoÿtiÚ
(
__FILE__
, 
__LINE__
)) \

11463 ->
	`AddTe¡Su™eIn¡ªtŸtiÚ
( \

11464 #´efix, &
g‹¡_
##
´efix
##
‹¡_su™e_Çme
##
_Ev®G’”©Ü_
, \

11465 &
g‹¡_
##
´efix
##
‹¡_su™e_Çme
##
_Ev®G’”©eName_
, \

11466 
__FILE__
, 
__LINE__
)

	)

11469 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


11470 
	#INSTANTIATE_TEST_CASE_P
 \

11471 
	`¡©ic_as£¹
(::
‹¡šg
::
š‹º®
::
	`In¡ªtŸ‹Te¡Ca£_P_IsD•»ÿ‹d
(), \

11473 
INSTANTIATE_TEST_SUITE_P


	)

11512 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_PROD_H_


11513 
	#GTEST_INCLUDE_GTEST_GTEST_PROD_H_


	)

11536 
	#FRIEND_TEST
(
‹¡_ÿ£_Çme
, 
‹¡_Çme
)\

11537 
ä›nd
 
şass
 
‹¡_ÿ£_Çme
##
_
##
‹¡_Çme
##
_Te¡


	)

11571 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_TEST_PART_H_


11572 
	#GTEST_INCLUDE_GTEST_GTEST_TEST_PART_H_


	)

11574 
	~<iosfwd
>

11575 
	~<veùÜ
>

11577 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4251 \

11580 
Çme¥aû
 
	g‹¡šg
 {

11586 şas 
	cGTEST_API_
 
	gTe¡P¬tResuÉ
 {

11587 
	gpublic
:

11590 
	eTy³
 {

11591 
kSucûss
,

11592 
	gkNÚF©®Fau»
,

11593 
	gkF©®Fau»
,

11594 
	gkSk


11600 
Te¡P¬tResuÉ
(
Ty³
 
a_ty³
, cÚ¡ * 
a_fe_Çme
, 
a_lše_numb”
,

11601 cÚ¡ * 
a_mes§ge
)

11602 : 
ty³_
(
a_ty³
),

11603 
fe_Çme_
(
a_fe_Çme
 =ğ
nuÎ±r
 ? "" :‡_file_name),

11604 
lše_numb”_
(
a_lše_numb”
),

11605 
summ¬y_
(
ExŒaùSumm¬y
(
a_mes§ge
)),

11606 
mes§ge_
(
a_mes§ge
) {}

11609 
Ty³
 
ty³
(ècÚ¡ {  
	gty³_
; }

11613 cÚ¡ * 
fe_Çme
() const {

11614  
	gfe_Çme_
.
em±y
(è? 
	gnuÎ±r
 : 
fe_Çme_
.
c_¡r
();

11619 
lše_numb”
(ècÚ¡ {  
	glše_numb”_
; }

11622 cÚ¡ * 
summ¬y
(ècÚ¡ {  
	gsumm¬y_
.
c_¡r
(); }

11625 cÚ¡ * 
mes§ge
(ècÚ¡ {  
	gmes§ge_
.
c_¡r
(); }

11628 
boŞ
 
sk³d
(ècÚ¡ {  
	gty³_
 =ğ
kSk
; }

11631 
boŞ
 
·s£d
(ècÚ¡ {  
	gty³_
 =ğ
kSucûss
; }

11634 
boŞ
 
nÚçÎy_çed
(ècÚ¡ {  
	gty³_
 =ğ
kNÚF©®Fau»
; }

11637 
boŞ
 
çÎy_çed
(ècÚ¡ {  
	gty³_
 =ğ
kF©®Fau»
; }

11640 
boŞ
 
çed
(ècÚ¡ {  
çÎy_çed
(è|| 
nÚçÎy_çed
(); }

11642 
	g´iv©e
:

11643 
Ty³
 
ty³_
;

11647 
	g¡d
::
¡ršg
 
ExŒaùSumm¬y
(cÚ¡ * 
mes§ge
);

11651 
	g¡d
::
¡ršg
 
fe_Çme_
;

11654 
	glše_numb”_
;

11655 
	g¡d
::
¡ršg
 
summ¬y_
;

11656 
	g¡d
::
¡ršg
 
mes§ge_
;

11660 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gTe¡P¬tResuÉ
& 
	g»suÉ
);

11666 şas 
	cGTEST_API_
 
	gTe¡P¬tResuÉA¼ay
 {

11667 
	gpublic
:

11668 
Te¡P¬tResuÉA¼ay
() {}

11671 
Aµ’d
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
);

11674 cÚ¡ 
	gTe¡P¬tResuÉ
& 
G‘Te¡P¬tResuÉ
(
šdex
) const;

11677 
size
() const;

11679 
	g´iv©e
:

11680 
¡d
::
veùÜ
<
Te¡P¬tResuÉ
> 
¬¿y_
;

11682 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Te¡P¬tResuÉA¼ay
);

11686 şas 
	cGTEST_API_
 
	gTe¡P¬tResuÉR•Ü‹rIÁ”çû
 {

11687 
	gpublic
:

11688 
vœtu®
 ~
Te¡P¬tResuÉR•Ü‹rIÁ”çû
() {}

11690 
vœtu®
 
R•ÜtTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
) = 0;

11693 
Çme¥aû
 
	gš‹º®
 {

11701 şas 
	cGTEST_API_
 
	gHasNewF©®Fau»H–³r


11702 : 
public
 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
 {

11703 
public
:

11704 
HasNewF©®Fau»H–³r
();

11705 ~
HasNewF©®Fau»H–³r
(è
	gov”ride
;

11706 
R•ÜtTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
è
	gov”ride
;

11707 
boŞ
 
has_Ãw_çl_çu»
(ècÚ¡ {  
	ghas_Ãw_çl_çu»_
; }

11708 
	g´iv©e
:

11709 
boŞ
 
has_Ãw_çl_çu»_
;

11710 
Te¡P¬tResuÉR•Ü‹rIÁ”çû
* 
	gÜigš®_»pÜ‹r_
;

11712 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
HasNewF©®Fau»H–³r
);

11719 
	$GTEST_DISABLE_MSC_WARNINGS_POP_
()

11754 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_TYPED_TEST_H_


11755 
	#GTEST_INCLUDE_GTEST_GTEST_TYPED_TEST_H_


	)

11767 
‹m¶©e
 <
ty³Çme
 
T
>

11768 şas 
	cFooTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

11769 
public
:

11771 
¡d
::
	tli¡
<
	tT
> 
	tLi¡
;

11772 
T
 
sh¬ed_
;

11773 
T
 
v®ue_
;

11779 
‹¡šg
::
	tTy³s
<, , > 
	tMyTy³s
;

11780 
	`TYPED_TEST_SUITE
(
FooTe¡
, 
MyTy³s
);

11788 
	$TYPED_TEST
(
FooTe¡
, 
DÛsBÏh
) {

11792 
Ty³P¬am
 
n
 = 
this
->
v®ue_
;

11796 
n
 +ğ
Te¡Fixtu»
::
sh¬ed_
;

11800 
ty³Çme
 
Te¡Fixtu»
::
Li¡
 
v®ues
;

11801 
v®ues
.
	`push_back
(
n
);

11803 
	}
}

11805 
	$TYPED_TEST
(
FooTe¡
, 
HasPrİ”tyA
è{ ... 
	}
}

11845 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

11846 şas 
	cFooTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

11853 
TYPED_TEST_SUITE_P
(
FooTe¡
);

11857 
	$TYPED_TEST_P
(
FooTe¡
, 
DÛsBÏh
) {

11859 
Ty³P¬am
 
n
 = 0;

11861 
	}
}

11863 
	$TYPED_TEST_P
(
FooTe¡
, 
HasPrİ”tyA
è{ ... 
	}
}

11869 
REGISTER_TYPED_TEST_SUITE_P
(
FooTe¡
,

11870 
DÛsBÏh
, 
HasPrİ”tyA
);

11880 
	g‹¡šg
::
	tTy³s
<, , > 
	tMyTy³s
;

11881 
INSTANTIATE_TYPED_TEST_SUITE_P
(
My
, 
FooTe¡
, 
MyTy³s
);

11897 #ià
GTEST_HAS_TYPED_TEST


11903 
	#GTEST_TYPE_PARAMS_
(
Te¡Su™eName
è
g‹¡_ty³_·¿ms_
##Te¡Su™eName##
_


	)

11907 
	#GTEST_NAME_GENERATOR_
(
Te¡Su™eName
) \

11908 
g‹¡_ty³_·¿ms_
##
Te¡Su™eName
##
_NameG’”©Ü


	)

11910 
	#TYPED_TEST_SUITE
(
Ca£Name
, 
Ty³s
, ...) \

11911 ::
‹¡šg
::
	tš‹º®
::
	tTy³Li¡
<
	tTy³s
>::
	tty³
 
	tGTEST_TYPE_PARAMS_
( \

11912 
	tCa£Name
); \

11913 ::
‹¡šg
::
	tš‹º®
::
	tNameG’”©ÜS–eùÜ
<
	t__VA_ARGS__
>::
	tty³
 \

11914 
	tGTEST_NAME_GENERATOR_
(
	tCa£Name
)

	)

11916 
	tTYPED_TEST
(
	tCa£Name
, 
	tTe¡Name
) \

11917 
	t‹m¶©e
 <
	tty³Çme
 
	tg‹¡_Ty³P¬am_
> \

11918 
	tşass
 
	tGTEST_TEST_CLASS_NAME_
(
	tCa£Name
, 
	tTe¡Name
) \

11919 : 
	tpublic
 
	tCa£Name
<
	tg‹¡_Ty³P¬am_
> { \

11920 
´iv©e
: \

11921 
Ca£Name
<
	tg‹¡_Ty³P¬am_
> 
	tTe¡Fixtu»
; \

11922 
g‹¡_Ty³P¬am_
 
	tTy³P¬am
; \

11923 
vœtu®
 
	`Te¡Body
(); \

11925 
boŞ
 
g‹¡_
##
Ca£Name
##
_
##
Te¡Name
##
_»gi¡”ed_
 \

11926 
GTEST_ATTRIBUTE_UNUSED_
 = \

11927 ::
‹¡šg
::
š‹º®
::
Ty³P¬am‘”izedTe¡
< \

11928 
Ca£Name
, \

11929 ::
‹¡šg
::
š‹º®
::
Tem¶©eS–
<
	`GTEST_TEST_CLASS_NAME_
(
Ca£Name
, \

11930 
Te¡Name
)>, \

11931 
	`GTEST_TYPE_PARAMS_
( \

11932 
Ca£Name
)>::
	`Regi¡”
("", \

11933 ::
‹¡šg
::
š‹º®
::
	`CodeLoÿtiÚ
( \

11934 
__FILE__
, 
__LINE__
), \

11936 ::
‹¡šg
::
š‹º®
::
G’”©eNames
< \

11937 
	`GTEST_NAME_GENERATOR_
(
Ca£Name
), \

11938 
	`GTEST_TYPE_PARAMS_
(
Ca£Name
)>()); \

11939 
‹m¶©e
 <
ty³Çme
 
g‹¡_Ty³P¬am_
> \

11940 
	`GTEST_TEST_CLASS_NAME_
(
Ca£Name
, \

11941 
Te¡Name
)<
g‹¡_Ty³P¬am_
>::
	`Te¡Body
()

	)

11944 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


11945 
	#TYPED_TEST_CASE
 \

11946 
	`¡©ic_as£¹
(::
‹¡šg
::
š‹º®
::
	`Ty³dTe¡Ca£IsD•»ÿ‹d
(), ""); \

11947 
TYPED_TEST_SUITE


	)

11954 #ià
GTEST_HAS_TYPED_TEST_P


11961 
	#GTEST_SUITE_NAMESPACE_
(
Te¡Su™eName
è
g‹¡_su™e_
##Te¡Su™eName##
_


	)

11967 
	#GTEST_TYPED_TEST_SUITE_P_STATE_
(
Te¡Su™eName
) \

11968 
g‹¡_ty³d_‹¡_su™e_p_¡©e_
##
Te¡Su™eName
##
_


	)

11974 
	#GTEST_REGISTERED_TEST_NAMES_
(
Te¡Su™eName
) \

11975 
g‹¡_»gi¡”ed_‹¡_Çmes_
##
Te¡Su™eName
##
_


	)

11980 
	#TYPED_TEST_SUITE_P
(
Su™eName
) \

11981 ::
‹¡šg
::
š‹º®
::
Ty³dTe¡Su™ePS‹
 \

11982 
	`GTEST_TYPED_TEST_SUITE_P_STATE_
(
Su™eName
)

	)

11985 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


11986 
	#TYPED_TEST_CASE_P
 \

11987 
	`¡©ic_as£¹
(::
‹¡šg
::
š‹º®
::
	`Ty³dTe¡Ca£_P_IsD•»ÿ‹d
(), ""); \

11988 
TYPED_TEST_SUITE_P


	)

11991 
	#TYPED_TEST_P
(
Su™eName
, 
Te¡Name
) \

11992 
Çme¥aû
 
	`GTEST_SUITE_NAMESPACE_
(
Su™eName
) { \

11993 
‹m¶©e
 <
ty³Çme
 
g‹¡_Ty³P¬am_
> \

11994 
şass
 
Te¡Name
 : 
public
 
Su™eName
<
g‹¡_Ty³P¬am_
> { \

11995 
´iv©e
: \

11996 
Su™eName
<
	tg‹¡_Ty³P¬am_
> 
	tTe¡Fixtu»
; \

11997 
g‹¡_Ty³P¬am_
 
	tTy³P¬am
; \

11998 
vœtu®
 
	`Te¡Body
(); \

12000 
boŞ
 
g‹¡_
##
Te¡Name
##
_defšed_
 
GTEST_ATTRIBUTE_UNUSED_
 = \

12001 
	`GTEST_TYPED_TEST_SUITE_P_STATE_
(
Su™eName
).
	`AddTe¡Name
( \

12002 
__FILE__
, 
__LINE__
, #SuiteName, #TestName); \

12004 
‹m¶©e
 <
ty³Çme
 
g‹¡_Ty³P¬am_
> \

12005 
	`GTEST_SUITE_NAMESPACE_
( \

12006 
Su™eName
)::
Te¡Name
<
g‹¡_Ty³P¬am_
>::
	`Te¡Body
()

	)

12008 
	#REGISTER_TYPED_TEST_SUITE_P
(
Su™eName
, ...) \

12009 
Çme¥aû
 
	`GTEST_SUITE_NAMESPACE_
(
Su™eName
) { \

12010 ::
‹¡šg
::
	tš‹º®
::
	tTem¶©es
<
	t__VA_ARGS__
>::
	tty³
 
	tg‹¡_AÎTe¡s_
; \

12012 cÚ¡ * cÚ¡ 
	`GTEST_REGISTERED_TEST_NAMES_
( \

12013 
Su™eName
è
GTEST_ATTRIBUTE_UNUSED_
 = \

12014 
	`GTEST_TYPED_TEST_SUITE_P_STATE_
(
Su™eName
).
	`V”ifyRegi¡”edTe¡Names
( \

12015 
__FILE__
, 
__LINE__
, #__VA_ARGS__)

	)

12018 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


12019 
	#REGISTER_TYPED_TEST_CASE_P
 \

12020 
	`¡©ic_as£¹
(::
‹¡šg
::
š‹º®
::
	`Regi¡”Ty³dTe¡Ca£_P_IsD•»ÿ‹d
(), \

12022 
REGISTER_TYPED_TEST_SUITE_P


	)

12025 
	#INSTANTIATE_TYPED_TEST_SUITE_P
(
P»fix
, 
Su™eName
, 
Ty³s
, ...) \

12026 
boŞ
 
g‹¡_
##
P»fix
##
_
##
Su™eName
 
GTEST_ATTRIBUTE_UNUSED_
 = \

12027 ::
‹¡šg
::
š‹º®
::
Ty³P¬am‘”izedTe¡Su™e
< \

12028 
Su™eName
, 
	`GTEST_SUITE_NAMESPACE_
(Su™eName)::
g‹¡_AÎTe¡s_
, \

12029 ::
‹¡šg
::
š‹º®
::
Ty³Li¡
<
Ty³s
>::
ty³
>:: \

12030 
	`Regi¡”
(#Prefix, \

12031 ::
‹¡šg
::
š‹º®
::
	`CodeLoÿtiÚ
(
__FILE__
, 
__LINE__
), \

12032 &
	`GTEST_TYPED_TEST_SUITE_P_STATE_
(
Su™eName
), #SuiteName, \

12033 
	`GTEST_REGISTERED_TEST_NAMES_
(
Su™eName
), \

12034 ::
‹¡šg
::
š‹º®
::
G’”©eNames
< \

12035 ::
‹¡šg
::
š‹º®
::
NameG’”©ÜS–eùÜ
< \

12036 
__VA_ARGS__
>::
ty³
, \

12037 ::
‹¡šg
::
š‹º®
::
Ty³Li¡
<
Ty³s
>::
ty³
>())

	)

12040 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


12041 
	#INSTANTIATE_TYPED_TEST_CASE_P
 \

12042 
	`¡©ic_as£¹
( \

12043 ::
‹¡šg
::
š‹º®
::
	`In¡ªtŸ‹Ty³dTe¡Ca£_P_IsD•»ÿ‹d
(), ""); \

12044 
INSTANTIATE_TYPED_TEST_SUITE_P


	)

12051 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4251 \

12054 
Çme¥aû
 
	g‹¡šg
 {

12058 #ifdeà
_MSC_VER


12059 #´agm¨
w¬nšg
(
push
)

12060 #´agm¨
w¬nšg
(
di§bË
:4805)

12061 #´agm¨
w¬nšg
(
di§bË
:4100)

12068 
GTEST_DECLARE_boŞ_
(
®so_run_di§bËd_‹¡s
);

12071 
GTEST_DECLARE_boŞ_
(
b»ak_Ú_çu»
);

12075 
GTEST_DECLARE_boŞ_
(
ÿtch_exû±iÚs
);

12080 
GTEST_DECLARE_¡ršg_
(
cŞÜ
);

12084 
GTEST_DECLARE_¡ršg_
(
f‹r
);

12088 
GTEST_DECLARE_boŞ_
(
š¡®l_çu»_sigÇl_hªdËr
);

12092 
GTEST_DECLARE_boŞ_
(
li¡_‹¡s
);

12096 
GTEST_DECLARE_¡ršg_
(
ouut
);

12100 
GTEST_DECLARE_boŞ_
(
´št_time
);

12103 
GTEST_DECLARE_boŞ_
(
´št_utf8
);

12106 
GTEST_DECLARE_št32_
(
¿ndom_£ed
);

12110 
GTEST_DECLARE_št32_
(
»³©
);

12114 
GTEST_DECLARE_boŞ_
(
show_š‹º®_¡ack_äames
);

12117 
GTEST_DECLARE_boŞ_
(
shufæe
);

12121 
GTEST_DECLARE_št32_
(
¡ack_Œaû_d•th
);

12126 
GTEST_DECLARE_boŞ_
(
throw_Ú_çu»
);

12130 
GTEST_DECLARE_boŞ_
(
´št_sk³d
);

12135 
GTEST_DECLARE_¡ršg_
(
¡»am_»suÉ_to
);

12137 #ià
GTEST_USE_OWN_FLAGFILE_FLAG_


12138 
GTEST_DECLARE_¡ršg_
(
æagfe
);

12142 cÚ¡ 
	gkMaxSckT¿ûD•th
 = 100;

12144 
Çme¥aû
 
	gš‹º®
 {

12146 
şass
 
	gAs£¹H–³r
;

12147 
şass
 
	gDeçuÉGlob®Te¡P¬tResuÉR•Ü‹r
;

12148 
şass
 
	gExecD—thTe¡
;

12149 
şass
 
	gNoExecD—thTe¡
;

12150 
şass
 
	gFš®SucûssCheck”
;

12151 
şass
 
	gGTe¡FÏgSav”
;

12152 
şass
 
	gSŒ—mšgLi¡’”Te¡
;

12153 
şass
 
	gTe¡ResuÉAcûssÜ
;

12154 
şass
 
	gTe¡Ev’tLi¡’”sAcûssÜ
;

12155 
şass
 
	gTe¡Ev’tR•—‹r
;

12156 
şass
 
	gUn™Te¡RecÜdPrİ”tyTe¡H–³r
;

12157 
şass
 
	gWšdowsD—thTe¡
;

12158 
şass
 
	gFuchsŸD—thTe¡
;

12159 
şass
 
Un™Te¡Im¶
* 
G‘Un™Te¡Im¶
();

12160 
R•ÜtFau»InUnknownLoÿtiÚ
(
Te¡P¬tResuÉ
::
Ty³
 
»suÉ_ty³
,

12161 cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
);

12168 
şass
 
	gTe¡
;

12169 
şass
 
	gTe¡Su™e
;

12172 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


12173 
usšg
 
	gTe¡Ca£
 = 
Te¡Su™e
;

12175 
şass
 
	gTe¡Info
;

12176 
şass
 
	gUn™Te¡
;

12257 şas 
	cGTEST_API_
 
	gAs£¹iÚResuÉ
 {

12258 
	gpublic
:

12261 
As£¹iÚResuÉ
(cÚ¡ As£¹iÚResuÉ& 
Ùh”
);

12263 #ià
defšed
(
_MSC_VER
) && _MSC_VER < 1910

12264 
GTEST_DISABLE_MSC_WARNINGS_PUSH_
(4800 )

12274 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

12275 
ex¶ic™
 
As£¹iÚResuÉ
(

12276 cÚ¡ 
T
& 
sucûss
,

12277 
ty³Çme
 
¡d
::
’abË_if
<

12278 !
¡d
::
is_cÚv”tibË
<
T
, 
As£¹iÚResuÉ
>::
v®ue
>::
ty³
*

12280 ğ
nuÎ±r
)

12281 : 
sucûss_
(
sucûss
) {}

12283 #ià
defšed
(
_MSC_VER
) && _MSC_VER < 1910

12284 
GTEST_DISABLE_MSC_WARNINGS_POP_
()

12288 
As£¹iÚResuÉ
& 
İ”©Ü
=(As£¹iÚResuÉ 
Ùh”
) {

12289 
sw­
(
Ùh”
);

12290  *
	gthis
;

12294 
İ”©Ü
 
boŞ
(ècÚ¡ {  
	gsucûss_
; }

12297 
As£¹iÚResuÉ
 
	gİ”©Ü
!() const;

12303 cÚ¡ * 
mes§ge
() const {

12304  
	gmes§ge_
.
g‘
(è!ğ
nuÎ±r
 ? 
mes§ge_
->
c_¡r
() : "";

12307 cÚ¡ * 
çu»_mes§ge
(ècÚ¡ {  
mes§ge
(); }

12310 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gAs£¹iÚResuÉ
& 
	gİ”©Ü
<<(cÚ¡ T& 
	gv®ue
) {

12311 
Aµ’dMes§ge
(
Mes§ge
(è<< 
v®ue
);

12312  *
	gthis
;

12317 
	gAs£¹iÚResuÉ
& 
	gİ”©Ü
<<(

12318 ::
¡d
::
o¡»am
& (*
basic_mªuÏtÜ
)(::¡d::o¡»am& 
¡»am
)) {

12319 
Aµ’dMes§ge
(
Mes§ge
(è<< 
basic_mªuÏtÜ
);

12320  *
	gthis
;

12323 
	g´iv©e
:

12325 
Aµ’dMes§ge
(cÚ¡ 
Mes§ge
& 
a_mes§ge
) {

12326 ià(
mes§ge_
.
g‘
(è=ğ
nuÎ±r
èmes§ge_.
»£t
(
Ãw
 ::
¡d
::
¡ršg
);

12327 
	gmes§ge_
->
­³nd
(
a_mes§ge
.
G‘SŒšg
().
c_¡r
());

12331 
sw­
(
As£¹iÚResuÉ
& 
Ùh”
);

12334 
boŞ
 
	gsucûss_
;

12339 
	g¡d
::
unique_±r
< ::
¡d
::
¡ršg
> 
mes§ge_
;

12343 
GTEST_API_
 
As£¹iÚResuÉ
 
As£¹iÚSucûss
();

12346 
GTEST_API_
 
As£¹iÚResuÉ
 
As£¹iÚFau»
();

12350 
GTEST_API_
 
As£¹iÚResuÉ
 
As£¹iÚFau»
(cÚ¡ 
Mes§ge
& 
msg
);

12392 #iâdeà
GTEST_INCLUDE_GTEST_GTEST_PRED_IMPL_H_


12393 
	#GTEST_INCLUDE_GTEST_GTEST_PRED_IMPL_H_


	)

12396 
Çme¥aû
 
	g‹¡šg
 {

12430 
	#GTEST_ASSERT_
(
ex´essiÚ
, 
Ú_çu»
) \

12431 
GTEST_AMBIGUOUS_ELSE_BLOCKER_
 \

12432 ià(cÚ¡ ::
‹¡šg
::
As£¹iÚResuÉ
 
g‹¡_¬
 = (
ex´essiÚ
)) \

12435 
	`Ú_çu»
(
g‹¡_¬
.
	`çu»_mes§ge
())

	)

12440 
	g‹m¶©e
 <
ty³Çme
 
	gP»d
,

12441 
ty³Çme
 
	gT1
>

12442 
As£¹iÚResuÉ
 
As£¹P»d1H–³r
(cÚ¡ * 
´ed_‹xt
,

12443 cÚ¡ * 
e1
,

12444 
P»d
 
´ed
,

12445 cÚ¡ 
T1
& 
v1
) {

12446 ià(
´ed
(
v1
)è 
As£¹iÚSucûss
();

12448  
As£¹iÚFau»
()

12449 << 
	g´ed_‹xt
 << "(" << 
	ge1
 << ")ƒvaluateso false, where"

12451 << 
	ge1
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v1
);

12456 
	#GTEST_PRED_FORMAT1_
(
´ed_fÜm©
, 
v1
, 
Ú_çu»
)\

12457 
	`GTEST_ASSERT_
(
	`´ed_fÜm©
(#v1, 
v1
), \

12458 
Ú_çu»
)

	)

12462 
	#GTEST_PRED1_
(
´ed
, 
v1
, 
Ú_çu»
)\

12463 
	`GTEST_ASSERT_
(::
‹¡šg
::
	`As£¹P»d1H–³r
(#pred, \

12465 
´ed
, \

12466 
v1
), 
Ú_çu»
)

	)

12469 
	#EXPECT_PRED_FORMAT1
(
´ed_fÜm©
, 
v1
) \

12470 
	`GTEST_PRED_FORMAT1_
(
´ed_fÜm©
, 
v1
, 
GTEST_NONFATAL_FAILURE_
)

	)

12471 
	#EXPECT_PRED1
(
´ed
, 
v1
) \

12472 
	`GTEST_PRED1_
(
´ed
, 
v1
, 
GTEST_NONFATAL_FAILURE_
)

	)

12473 
	#ASSERT_PRED_FORMAT1
(
´ed_fÜm©
, 
v1
) \

12474 
	`GTEST_PRED_FORMAT1_
(
´ed_fÜm©
, 
v1
, 
GTEST_FATAL_FAILURE_
)

	)

12475 
	#ASSERT_PRED1
(
´ed
, 
v1
) \

12476 
	`GTEST_PRED1_
(
´ed
, 
v1
, 
GTEST_FATAL_FAILURE_
)

	)

12482 
	g‹m¶©e
 <
ty³Çme
 
	gP»d
,

12483 
ty³Çme
 
	gT1
,

12484 
ty³Çme
 
	gT2
>

12485 
As£¹iÚResuÉ
 
As£¹P»d2H–³r
(cÚ¡ * 
´ed_‹xt
,

12486 cÚ¡ * 
e1
,

12487 cÚ¡ * 
e2
,

12488 
P»d
 
´ed
,

12489 cÚ¡ 
T1
& 
v1
,

12490 cÚ¡ 
T2
& 
v2
) {

12491 ià(
´ed
(
v1
, 
v2
)è 
As£¹iÚSucûss
();

12493  
As£¹iÚFau»
()

12494 << 
	g´ed_‹xt
 << "(" << 
	ge1
 << ", " << 
	ge2


12497 << 
	ge1
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v1
) << "\n"

12498 << 
e2
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v2
);

12503 
	#GTEST_PRED_FORMAT2_
(
´ed_fÜm©
, 
v1
, 
v2
, 
Ú_çu»
)\

12504 
	`GTEST_ASSERT_
(
	`´ed_fÜm©
(#v1, #v2, 
v1
, 
v2
), \

12505 
Ú_çu»
)

	)

12509 
	#GTEST_PRED2_
(
´ed
, 
v1
, 
v2
, 
Ú_çu»
)\

12510 
	`GTEST_ASSERT_
(::
‹¡šg
::
	`As£¹P»d2H–³r
(#pred, \

12513 
´ed
, \

12514 
v1
, \

12515 
v2
), 
Ú_çu»
)

	)

12518 
	#EXPECT_PRED_FORMAT2
(
´ed_fÜm©
, 
v1
, 
v2
) \

12519 
	`GTEST_PRED_FORMAT2_
(
´ed_fÜm©
, 
v1
, 
v2
, 
GTEST_NONFATAL_FAILURE_
)

	)

12520 
	#EXPECT_PRED2
(
´ed
, 
v1
, 
v2
) \

12521 
	`GTEST_PRED2_
(
´ed
, 
v1
, 
v2
, 
GTEST_NONFATAL_FAILURE_
)

	)

12522 
	#ASSERT_PRED_FORMAT2
(
´ed_fÜm©
, 
v1
, 
v2
) \

12523 
	`GTEST_PRED_FORMAT2_
(
´ed_fÜm©
, 
v1
, 
v2
, 
GTEST_FATAL_FAILURE_
)

	)

12524 
	#ASSERT_PRED2
(
´ed
, 
v1
, 
v2
) \

12525 
	`GTEST_PRED2_
(
´ed
, 
v1
, 
v2
, 
GTEST_FATAL_FAILURE_
)

	)

12531 
	g‹m¶©e
 <
ty³Çme
 
	gP»d
,

12532 
ty³Çme
 
	gT1
,

12533 
ty³Çme
 
	gT2
,

12534 
ty³Çme
 
	gT3
>

12535 
As£¹iÚResuÉ
 
As£¹P»d3H–³r
(cÚ¡ * 
´ed_‹xt
,

12536 cÚ¡ * 
e1
,

12537 cÚ¡ * 
e2
,

12538 cÚ¡ * 
e3
,

12539 
P»d
 
´ed
,

12540 cÚ¡ 
T1
& 
v1
,

12541 cÚ¡ 
T2
& 
v2
,

12542 cÚ¡ 
T3
& 
v3
) {

12543 ià(
´ed
(
v1
, 
v2
, 
v3
)è 
As£¹iÚSucûss
();

12545  
As£¹iÚFau»
()

12546 << 
	g´ed_‹xt
 << "(" << 
	ge1
 << ", " << 
	ge2
 << ", " << 
	ge3


12549 << 
	ge1
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v1
) << "\n"

12550 << 
e2
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v2
) << "\n"

12551 << 
e3
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v3
);

12556 
	#GTEST_PRED_FORMAT3_
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
Ú_çu»
)\

12557 
	`GTEST_ASSERT_
(
	`´ed_fÜm©
(#v1, #v2, #v3, 
v1
, 
v2
, 
v3
), \

12558 
Ú_çu»
)

	)

12562 
	#GTEST_PRED3_
(
´ed
, 
v1
, 
v2
, 
v3
, 
Ú_çu»
)\

12563 
	`GTEST_ASSERT_
(::
‹¡šg
::
	`As£¹P»d3H–³r
(#pred, \

12567 
´ed
, \

12568 
v1
, \

12569 
v2
, \

12570 
v3
), 
Ú_çu»
)

	)

12573 
	#EXPECT_PRED_FORMAT3
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
) \

12574 
	`GTEST_PRED_FORMAT3_
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
GTEST_NONFATAL_FAILURE_
)

	)

12575 
	#EXPECT_PRED3
(
´ed
, 
v1
, 
v2
, 
v3
) \

12576 
	`GTEST_PRED3_
(
´ed
, 
v1
, 
v2
, 
v3
, 
GTEST_NONFATAL_FAILURE_
)

	)

12577 
	#ASSERT_PRED_FORMAT3
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
) \

12578 
	`GTEST_PRED_FORMAT3_
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
GTEST_FATAL_FAILURE_
)

	)

12579 
	#ASSERT_PRED3
(
´ed
, 
v1
, 
v2
, 
v3
) \

12580 
	`GTEST_PRED3_
(
´ed
, 
v1
, 
v2
, 
v3
, 
GTEST_FATAL_FAILURE_
)

	)

12586 
	g‹m¶©e
 <
ty³Çme
 
	gP»d
,

12587 
ty³Çme
 
	gT1
,

12588 
ty³Çme
 
	gT2
,

12589 
ty³Çme
 
	gT3
,

12590 
ty³Çme
 
	gT4
>

12591 
As£¹iÚResuÉ
 
As£¹P»d4H–³r
(cÚ¡ * 
´ed_‹xt
,

12592 cÚ¡ * 
e1
,

12593 cÚ¡ * 
e2
,

12594 cÚ¡ * 
e3
,

12595 cÚ¡ * 
e4
,

12596 
P»d
 
´ed
,

12597 cÚ¡ 
T1
& 
v1
,

12598 cÚ¡ 
T2
& 
v2
,

12599 cÚ¡ 
T3
& 
v3
,

12600 cÚ¡ 
T4
& 
v4
) {

12601 ià(
´ed
(
v1
, 
v2
, 
v3
, 
v4
)è 
As£¹iÚSucûss
();

12603  
As£¹iÚFau»
()

12604 << 
	g´ed_‹xt
 << "(" << 
	ge1
 << ", " << 
	ge2
 << ", " << 
	ge3
 << ", " << 
	ge4


12607 << 
	ge1
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v1
) << "\n"

12608 << 
e2
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v2
) << "\n"

12609 << 
e3
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v3
) << "\n"

12610 << 
e4
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v4
);

12615 
	#GTEST_PRED_FORMAT4_
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
, 
Ú_çu»
)\

12616 
	`GTEST_ASSERT_
(
	`´ed_fÜm©
(#v1, #v2, #v3, #v4, 
v1
, 
v2
, 
v3
, 
v4
), \

12617 
Ú_çu»
)

	)

12621 
	#GTEST_PRED4_
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
, 
Ú_çu»
)\

12622 
	`GTEST_ASSERT_
(::
‹¡šg
::
	`As£¹P»d4H–³r
(#pred, \

12627 
´ed
, \

12628 
v1
, \

12629 
v2
, \

12630 
v3
, \

12631 
v4
), 
Ú_çu»
)

	)

12634 
	#EXPECT_PRED_FORMAT4
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
) \

12635 
	`GTEST_PRED_FORMAT4_
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
, 
GTEST_NONFATAL_FAILURE_
)

	)

12636 
	#EXPECT_PRED4
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
) \

12637 
	`GTEST_PRED4_
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
, 
GTEST_NONFATAL_FAILURE_
)

	)

12638 
	#ASSERT_PRED_FORMAT4
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
) \

12639 
	`GTEST_PRED_FORMAT4_
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
, 
GTEST_FATAL_FAILURE_
)

	)

12640 
	#ASSERT_PRED4
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
) \

12641 
	`GTEST_PRED4_
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
, 
GTEST_FATAL_FAILURE_
)

	)

12647 
	g‹m¶©e
 <
ty³Çme
 
	gP»d
,

12648 
ty³Çme
 
	gT1
,

12649 
ty³Çme
 
	gT2
,

12650 
ty³Çme
 
	gT3
,

12651 
ty³Çme
 
	gT4
,

12652 
ty³Çme
 
	gT5
>

12653 
As£¹iÚResuÉ
 
As£¹P»d5H–³r
(cÚ¡ * 
´ed_‹xt
,

12654 cÚ¡ * 
e1
,

12655 cÚ¡ * 
e2
,

12656 cÚ¡ * 
e3
,

12657 cÚ¡ * 
e4
,

12658 cÚ¡ * 
e5
,

12659 
P»d
 
´ed
,

12660 cÚ¡ 
T1
& 
v1
,

12661 cÚ¡ 
T2
& 
v2
,

12662 cÚ¡ 
T3
& 
v3
,

12663 cÚ¡ 
T4
& 
v4
,

12664 cÚ¡ 
T5
& 
v5
) {

12665 ià(
´ed
(
v1
, 
v2
, 
v3
, 
v4
, 
v5
)è 
As£¹iÚSucûss
();

12667  
As£¹iÚFau»
()

12668 << 
	g´ed_‹xt
 << "(" << 
	ge1
 << ", " << 
	ge2
 << ", " << 
	ge3
 << ", " << 
	ge4


12669 << ", " << 
	ge5
 << ")ƒvaluateso false, where"

12671 << 
	ge1
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v1
) << "\n"

12672 << 
e2
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v2
) << "\n"

12673 << 
e3
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v3
) << "\n"

12674 << 
e4
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v4
) << "\n"

12675 << 
e5
 << "ƒv®u©e tØ" << ::
‹¡šg
::
PrštToSŒšg
(
v5
);

12680 
	#GTEST_PRED_FORMAT5_
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
, 
Ú_çu»
)\

12681 
	`GTEST_ASSERT_
(
	`´ed_fÜm©
(#v1, #v2, #v3, #v4, #v5, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
), \

12682 
Ú_çu»
)

	)

12686 
	#GTEST_PRED5_
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
, 
Ú_çu»
)\

12687 
	`GTEST_ASSERT_
(::
‹¡šg
::
	`As£¹P»d5H–³r
(#pred, \

12693 
´ed
, \

12694 
v1
, \

12695 
v2
, \

12696 
v3
, \

12697 
v4
, \

12698 
v5
), 
Ú_çu»
)

	)

12701 
	#EXPECT_PRED_FORMAT5
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
) \

12702 
	`GTEST_PRED_FORMAT5_
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
, 
GTEST_NONFATAL_FAILURE_
)

	)

12703 
	#EXPECT_PRED5
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
) \

12704 
	`GTEST_PRED5_
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
, 
GTEST_NONFATAL_FAILURE_
)

	)

12705 
	#ASSERT_PRED_FORMAT5
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
) \

12706 
	`GTEST_PRED_FORMAT5_
(
´ed_fÜm©
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
, 
GTEST_FATAL_FAILURE_
)

	)

12707 
	#ASSERT_PRED5
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
) \

12708 
	`GTEST_PRED5_
(
´ed
, 
v1
, 
v2
, 
v3
, 
v4
, 
v5
, 
GTEST_FATAL_FAILURE_
)

	)

12716 
Çme¥aû
 
	g‹¡šg
 {

12741 şas 
	cGTEST_API_
 
	gTe¡
 {

12742 
	gpublic
:

12743 
ä›nd
 
şass
 
Te¡Info
;

12746 
	gvœtu®
 ~
Te¡
();

12756 
S‘UpTe¡Su™e
() {}

12766 
T—rDownTe¡Su™e
() {}

12769 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


12770 
T—rDownTe¡Ca£
() {}

12771 
S‘UpTe¡Ca£
() {}

12775 
boŞ
 
HasF©®Fau»
();

12778 
boŞ
 
HasNÚçlFau»
();

12781 
boŞ
 
IsSk³d
();

12785 
boŞ
 
HasFau»
(è{  
HasF©®Fau»
(è|| 
HasNÚçlFau»
(); }

12800 
RecÜdPrİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
key
, cÚ¡ std::¡ršg& 
v®ue
);

12801 
RecÜdPrİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
key
, 
v®ue
);

12803 
	g´Ùeùed
:

12805 
Te¡
();

12808 
vœtu®
 
S‘Up
();

12811 
vœtu®
 
T—rDown
();

12813 
	g´iv©e
:

12816 
boŞ
 
HasSameFixtu»CÏss
();

12824 
vœtu®
 
Te¡Body
() = 0;

12827 
Run
();

12831 
D–‘eS–f_
(è{ 
d–‘e
 
	gthis
; }

12833 cÚ¡ 
	g¡d
::
unique_±r
<
GTEST_FLAG_SAVER_
> 
g‹¡_æag_§v”_
;

12851 
	sS‘up_should_be_¥–Ëd_S‘Up
 {};

12852 
vœtu®
 
S‘up_should_be_¥–Ëd_S‘Up
* 
S‘up
(è{  
	gnuÎ±r
; }

12855 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Te¡
);

12858 
	gš‹º®
::
	tTimeInMlis
 TimeInMillis;

12864 şas 
	cTe¡Prİ”ty
 {

12865 
	gpublic
:

12869 
Te¡Prİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
a_key
, cÚ¡ std::¡ršg& 
a_v®ue
) :

12870 
key_
(
a_key
), 
v®ue_
(
a_v®ue
) {

12874 cÚ¡ * 
key
() const {

12875  
	gkey_
.
c_¡r
();

12879 cÚ¡ * 
v®ue
() const {

12880  
	gv®ue_
.
c_¡r
();

12884 
S‘V®ue
(cÚ¡ 
¡d
::
¡ršg
& 
Ãw_v®ue
) {

12885 
v®ue_
 = 
Ãw_v®ue
;

12888 
	g´iv©e
:

12890 
¡d
::
¡ršg
 
key_
;

12892 
	g¡d
::
¡ršg
 
v®ue_
;

12901 şas 
	cGTEST_API_
 
	gTe¡ResuÉ
 {

12902 
	gpublic
:

12904 
Te¡ResuÉ
();

12907 ~
Te¡ResuÉ
();

12911 
tÙ®_·¹_couÁ
() const;

12914 
‹¡_´İ”ty_couÁ
() const;

12917 
boŞ
 
Pas£d
(ècÚ¡ {  !
Sk³d
(è&& !
Faed
(); }

12920 
boŞ
 
Sk³d
() const;

12923 
boŞ
 
Faed
() const;

12926 
boŞ
 
HasF©®Fau»
() const;

12929 
boŞ
 
HasNÚçlFau»
() const;

12932 
TimeInMlis
 
–­£d_time
(ècÚ¡ {  
	g–­£d_time_
; }

12936 
TimeInMlis
 
¡¬t_time¡amp
(ècÚ¡ {  
	g¡¬t_time¡amp_
; }

12940 cÚ¡ 
	gTe¡P¬tResuÉ
& 
G‘Te¡P¬tResuÉ
(
i
) const;

12945 cÚ¡ 
	gTe¡Prİ”ty
& 
G‘Te¡Prİ”ty
(
i
) const;

12947 
	g´iv©e
:

12948 
ä›nd
 
şass
 
Te¡Info
;

12949 
ä›nd
 
şass
 
	gTe¡Su™e
;

12950 
ä›nd
 
şass
 
	gUn™Te¡
;

12951 
ä›nd
 
şass
 
	gš‹º®
::
DeçuÉGlob®Te¡P¬tResuÉR•Ü‹r
;

12952 
ä›nd
 
şass
 
	gš‹º®
::
ExecD—thTe¡
;

12953 
ä›nd
 
şass
 
	gš‹º®
::
Te¡ResuÉAcûssÜ
;

12954 
ä›nd
 
şass
 
	gš‹º®
::
Un™Te¡Im¶
;

12955 
ä›nd
 
şass
 
	gš‹º®
::
WšdowsD—thTe¡
;

12956 
ä›nd
 
şass
 
	gš‹º®
::
FuchsŸD—thTe¡
;

12959 cÚ¡ 
	g¡d
::
veùÜ
<
Te¡P¬tResuÉ
>& 
‹¡_·¹_»suÉs
() const {

12960  
‹¡_·¹_»suÉs_
;

12964 cÚ¡ 
	g¡d
::
veùÜ
<
Te¡Prİ”ty
>& 
‹¡_´İ”t›s
() const {

12965  
‹¡_´İ”t›s_
;

12969 
£t_¡¬t_time¡amp
(
TimeInMlis
 
¡¬t
è{ 
	g¡¬t_time¡amp_
 = start; }

12972 
£t_–­£d_time
(
TimeInMlis
 
–­£d
è{ 
	g–­£d_time_
 =ƒlapsed; }

12980 
RecÜdPrİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
xml_–em’t
,

12981 cÚ¡ 
Te¡Prİ”ty
& 
‹¡_´İ”ty
);

12986 
boŞ
 
V®id©eTe¡Prİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
xml_–em’t
,

12987 cÚ¡ 
Te¡Prİ”ty
& 
‹¡_´İ”ty
);

12990 
AddTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
‹¡_·¹_»suÉ
);

12993 
d—th_‹¡_couÁ
(ècÚ¡ {  
	gd—th_‹¡_couÁ_
; }

12996 
šüem’t_d—th_‹¡_couÁ
(è{  ++
	gd—th_‹¡_couÁ_
; }

12999 
CË¬Te¡P¬tResuÉs
();

13002 
CË¬
();

13006 
	gš‹º®
::
Mu‹x
 
‹¡_´İ”™es_mu‹x_
;

13009 
	g¡d
::
veùÜ
<
Te¡P¬tResuÉ
> 
‹¡_·¹_»suÉs_
;

13011 
	g¡d
::
veùÜ
<
Te¡Prİ”ty
> 
‹¡_´İ”t›s_
;

13013 
	gd—th_‹¡_couÁ_
;

13015 
TimeInMlis
 
	g¡¬t_time¡amp_
;

13017 
TimeInMlis
 
	g–­£d_time_
;

13020 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Te¡ResuÉ
);

13034 şas 
	cGTEST_API_
 
	gTe¡Info
 {

13035 
	gpublic
:

13038 ~
Te¡Info
();

13041 cÚ¡ * 
‹¡_su™e_Çme
(ècÚ¡ {  
	g‹¡_su™e_Çme_
.
c_¡r
(); }

13044 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


13045 cÚ¡ * 
‹¡_ÿ£_Çme
(ècÚ¡ {  
‹¡_su™e_Çme
(); }

13049 cÚ¡ * 
Çme
(ècÚ¡ {  
	gÇme_
.
c_¡r
(); }

13053 cÚ¡ * 
ty³_·¿m
() const {

13054 ià(
	gty³_·¿m_
.
g‘
(è!ğ
nuÎ±r
è 
ty³_·¿m_
->
c_¡r
();

13055  
	gnuÎ±r
;

13060 cÚ¡ * 
v®ue_·¿m
() const {

13061 ià(
	gv®ue_·¿m_
.
g‘
(è!ğ
nuÎ±r
è 
v®ue_·¿m_
->
c_¡r
();

13062  
	gnuÎ±r
;

13066 cÚ¡ * 
fe
(ècÚ¡ {  
	gloÿtiÚ_
.
	gfe
.
c_¡r
(); }

13069 
lše
(ècÚ¡ {  
	gloÿtiÚ_
.
	glše
; }

13072 
boŞ
 
is_š_ªÙh”_sh¬d
(ècÚ¡ {  
	gis_š_ªÙh”_sh¬d_
; }

13090 
boŞ
 
should_run
(ècÚ¡ {  
	gshould_run_
; }

13093 
boŞ
 
is_»pÜbË
() const {

13096  
	gm©ches_f‹r_
 && !
	gis_š_ªÙh”_sh¬d_
;

13100 cÚ¡ 
Te¡ResuÉ
* 
»suÉ
(ècÚ¡ {  &
	g»suÉ_
; }

13102 
	g´iv©e
:

13103 #ià
GTEST_HAS_DEATH_TEST


13104 
ä›nd
 
şass
 
š‹º®
::
DeçuÉD—thTe¡FaùÜy
;

13106 
ä›nd
 
şass
 
	gTe¡
;

13107 
ä›nd
 
şass
 
	gTe¡Su™e
;

13108 
ä›nd
 
şass
 
	gš‹º®
::
Un™Te¡Im¶
;

13109 
ä›nd
 
şass
 
	gš‹º®
::
SŒ—mšgLi¡’”Te¡
;

13110 
ä›nd
 
Te¡Info
* 
	gš‹º®
::
MakeAndRegi¡”Te¡Info
(

13111 cÚ¡ * 
‹¡_su™e_Çme
, cÚ¡ * 
Çme
, cÚ¡ * 
ty³_·¿m
,

13112 cÚ¡ * 
v®ue_·¿m
, 
š‹º®
::
CodeLoÿtiÚ
 
code_loÿtiÚ
,

13113 
š‹º®
::
Ty³Id
 
fixtu»_şass_id
, iÁ”Çl::
S‘UpTe¡Su™eFunc
 
£t_up_tc
,

13114 
š‹º®
::
T—rDownTe¡Su™eFunc
 
‹¬_down_tc
,

13115 
š‹º®
::
Te¡FaùÜyBa£
* 
çùÜy
);

13119 
Te¡Info
(cÚ¡ 
¡d
::
¡ršg
& 
‹¡_su™e_Çme
, cÚ¡ std::¡ršg& 
Çme
,

13120 cÚ¡ * 
a_ty³_·¿m
,

13121 cÚ¡ * 
a_v®ue_·¿m
,

13122 
š‹º®
::
CodeLoÿtiÚ
 
a_code_loÿtiÚ
,

13123 
š‹º®
::
Ty³Id
 
fixtu»_şass_id
,

13124 
š‹º®
::
Te¡FaùÜyBa£
* 
çùÜy
);

13128 
šüem’t_d—th_‹¡_couÁ
() {

13129  
	g»suÉ_
.
šüem’t_d—th_‹¡_couÁ
();

13134 
Run
();

13136 
CË¬Te¡ResuÉ
(
Te¡Info
* 
‹¡_šfo
) {

13137 
	g‹¡_šfo
->
	g»suÉ_
.
CË¬
();

13141 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_su™e_Çme_
;

13142 cÚ¡ 
	g¡d
::
¡ršg
 
Çme_
;

13145 cÚ¡ 
	g¡d
::
unique_±r
<cÚ¡ ::
¡d
::
¡ršg
> 
ty³_·¿m_
;

13148 cÚ¡ 
	g¡d
::
unique_±r
<cÚ¡ ::
¡d
::
¡ršg
> 
v®ue_·¿m_
;

13149 
	gš‹º®
::
CodeLoÿtiÚ
 
loÿtiÚ_
;

13150 cÚ¡ 
	gš‹º®
::
Ty³Id
 
fixtu»_şass_id_
;

13151 
boŞ
 
	gshould_run_
;

13152 
boŞ
 
	gis_di§bËd_
;

13153 
boŞ
 
	gm©ches_f‹r_
;

13155 
boŞ
 
	gis_š_ªÙh”_sh¬d_
;

13156 
	gš‹º®
::
Te¡FaùÜyBa£
* cÚ¡ 
çùÜy_
;

13161 
Te¡ResuÉ
 
	g»suÉ_
;

13163 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Te¡Info
);

13169 şas 
	cGTEST_API_
 
	gTe¡Su™e
 {

13170 
	gpublic
:

13183 
Te¡Su™e
(cÚ¡ * 
Çme
, cÚ¡ * 
a_ty³_·¿m
,

13184 
š‹º®
::
S‘UpTe¡Su™eFunc
 
£t_up_tc
,

13185 
š‹º®
::
T—rDownTe¡Su™eFunc
 
‹¬_down_tc
);

13188 
	gvœtu®
 ~
Te¡Su™e
();

13191 cÚ¡ * 
Çme
(ècÚ¡ {  
	gÇme_
.
c_¡r
(); }

13195 cÚ¡ * 
ty³_·¿m
() const {

13196 ià(
	gty³_·¿m_
.
g‘
(è!ğ
nuÎ±r
è 
ty³_·¿m_
->
c_¡r
();

13197  
	gnuÎ±r
;

13201 
boŞ
 
should_run
(ècÚ¡ {  
	gshould_run_
; }

13204 
sucûssful_‹¡_couÁ
() const;

13207 
sk³d_‹¡_couÁ
() const;

13210 
çed_‹¡_couÁ
() const;

13213 
»pÜbË_di§bËd_‹¡_couÁ
() const;

13216 
di§bËd_‹¡_couÁ
() const;

13219 
»pÜbË_‹¡_couÁ
() const;

13222 
‹¡_to_run_couÁ
() const;

13225 
tÙ®_‹¡_couÁ
() const;

13228 
boŞ
 
Pas£d
(ècÚ¡ {  !
Faed
(); }

13231 
boŞ
 
Faed
(ècÚ¡ {  
çed_‹¡_couÁ
() > 0; }

13234 
TimeInMlis
 
–­£d_time
(ècÚ¡ {  
	g–­£d_time_
; }

13238 
TimeInMlis
 
¡¬t_time¡amp
(ècÚ¡ {  
	g¡¬t_time¡amp_
; }

13242 cÚ¡ 
Te¡Info
* 
G‘Te¡Info
(
i
) const;

13246 cÚ¡ 
	gTe¡ResuÉ
& 
ad_hoc_‹¡_»suÉ
(ècÚ¡ {  
	gad_hoc_‹¡_»suÉ_
; }

13248 
	g´iv©e
:

13249 
ä›nd
 
şass
 
Te¡
;

13250 
ä›nd
 
şass
 
	gš‹º®
::
Un™Te¡Im¶
;

13253 
	g¡d
::
veùÜ
<
Te¡Info
*>& 
‹¡_šfo_li¡
(è{  
‹¡_šfo_li¡_
; }

13256 cÚ¡ 
	g¡d
::
veùÜ
<
Te¡Info
*>& 
‹¡_šfo_li¡
() const {

13257  
‹¡_šfo_li¡_
;

13262 
Te¡Info
* 
G‘MubËTe¡Info
(
i
);

13265 
£t_should_run
(
boŞ
 
should
è{ 
	gshould_run_
 = should; }

13269 
AddTe¡Info
(
Te¡Info
 * 
‹¡_šfo
);

13272 
CË¬ResuÉ
();

13275 
CË¬Te¡Su™eResuÉ
(
Te¡Su™e
* 
‹¡_su™e
) {

13276 
	g‹¡_su™e
->
CË¬ResuÉ
();

13280 
Run
();

13284 
RunS‘UpTe¡Su™e
() {

13285 ià(
	g£t_up_tc_
 !ğ
nuÎ±r
) {

13286 (*
£t_up_tc_
)();

13292 
RunT—rDownTe¡Su™e
() {

13293 ià(
	g‹¬_down_tc_
 !ğ
nuÎ±r
) {

13294 (*
‹¬_down_tc_
)();

13299 
boŞ
 
Te¡Pas£d
(cÚ¡ 
Te¡Info
* 
‹¡_šfo
) {

13300  
	g‹¡_šfo
->
should_run
(è&&e¡_šfo->
»suÉ
()->
Pas£d
();

13304 
boŞ
 
Te¡Sk³d
(cÚ¡ 
Te¡Info
* 
‹¡_šfo
) {

13305  
	g‹¡_šfo
->
should_run
(è&&e¡_šfo->
»suÉ
()->
Sk³d
();

13309 
boŞ
 
Te¡Faed
(cÚ¡ 
Te¡Info
* 
‹¡_šfo
) {

13310  
	g‹¡_šfo
->
should_run
(è&&e¡_šfo->
»suÉ
()->
Faed
();

13315 
boŞ
 
Te¡R•ÜbËDi§bËd
(cÚ¡ 
Te¡Info
* 
‹¡_šfo
) {

13316  
	g‹¡_šfo
->
is_»pÜbË
(è&&e¡_šfo->
	gis_di§bËd_
;

13320 
boŞ
 
Te¡Di§bËd
(cÚ¡ 
Te¡Info
* 
‹¡_šfo
) {

13321  
	g‹¡_šfo
->
	gis_di§bËd_
;

13325 
boŞ
 
Te¡R•ÜbË
(cÚ¡ 
Te¡Info
* 
‹¡_šfo
) {

13326  
	g‹¡_šfo
->
is_»pÜbË
();

13330 
boŞ
 
ShouldRunTe¡
(cÚ¡ 
Te¡Info
* 
‹¡_šfo
) {

13331  
	g‹¡_šfo
->
should_run
();

13335 
ShufæeTe¡s
(
š‹º®
::
Rªdom
* 
¿ndom
);

13338 
UnshufæeTe¡s
();

13341 
	g¡d
::
¡ršg
 
Çme_
;

13344 cÚ¡ 
	g¡d
::
unique_±r
<cÚ¡ ::
¡d
::
¡ršg
> 
ty³_·¿m_
;

13347 
	g¡d
::
veùÜ
<
Te¡Info
*> 
‹¡_šfo_li¡_
;

13351 
	g¡d
::
veùÜ
<> 
‹¡_šdiûs_
;

13353 
	gš‹º®
::
S‘UpTe¡Su™eFunc
 
£t_up_tc_
;

13355 
	gš‹º®
::
T—rDownTe¡Su™eFunc
 
‹¬_down_tc_
;

13357 
boŞ
 
	gshould_run_
;

13359 
TimeInMlis
 
	g¡¬t_time¡amp_
;

13361 
TimeInMlis
 
	g–­£d_time_
;

13364 
Te¡ResuÉ
 
	gad_hoc_‹¡_»suÉ_
;

13367 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Te¡Su™e
);

13384 şas 
	cEnvœÚm’t
 {

13385 
	gpublic
:

13387 
vœtu®
 ~
EnvœÚm’t
() {}

13390 
vœtu®
 
S‘Up
() {}

13393 
vœtu®
 
T—rDown
() {}

13394 
´iv©e
:

13397 
	sS‘up_should_be_¥–Ëd_S‘Up
 {};

13398 
vœtu®
 
S‘up_should_be_¥–Ëd_S‘Up
* 
S‘up
(è{  
	gnuÎ±r
; }

13401 #ià
GTEST_HAS_EXCEPTIONS


13404 şas 
	cGTEST_API_
 
	gAs£¹iÚExû±iÚ


13405 : 
public
 
š‹º®
::
GoogËTe¡Fau»Exû±iÚ
 {

13406 
public
:

13407 
ex¶ic™
 
As£¹iÚExû±iÚ
(cÚ¡ 
Te¡P¬tResuÉ
& 
»suÉ
)

13408 : 
GoogËTe¡Fau»Exû±iÚ
(
»suÉ
) {}

13415 şas 
	cTe¡Ev’tLi¡’”
 {

13416 
	gpublic
:

13417 
vœtu®
 ~
Te¡Ev’tLi¡’”
() {}

13420 
vœtu®
 
OnTe¡Prog¿mS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
) = 0;

13425 
vœtu®
 
OnTe¡I‹¿tiÚS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
,

13426 
™”©iÚ
) = 0;

13429 
vœtu®
 
OnEnvœÚm’tsS‘UpS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
) = 0;

13432 
vœtu®
 
OnEnvœÚm’tsS‘UpEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
) = 0;

13435 
vœtu®
 
OnTe¡Su™eS¹
(cÚ¡ 
Te¡Su™e
& ) {}

13438 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


13439 
vœtu®
 
OnTe¡Ca£S¹
(cÚ¡ 
Te¡Ca£
& ) {}

13443 
vœtu®
 
OnTe¡S¹
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
) = 0;

13448 
vœtu®
 
OnTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& 
‹¡_·¹_»suÉ
) = 0;

13451 
vœtu®
 
OnTe¡End
(cÚ¡ 
Te¡Info
& 
‹¡_šfo
) = 0;

13454 
vœtu®
 
OnTe¡Su™eEnd
(cÚ¡ 
Te¡Su™e
& ) {}

13457 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


13458 
vœtu®
 
OnTe¡Ca£End
(cÚ¡ 
Te¡Ca£
& ) {}

13462 
vœtu®
 
OnEnvœÚm’tsT—rDownS¹
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
) = 0;

13465 
vœtu®
 
OnEnvœÚm’tsT—rDownEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
) = 0;

13468 
vœtu®
 
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
,

13469 
™”©iÚ
) = 0;

13472 
vœtu®
 
OnTe¡Prog¿mEnd
(cÚ¡ 
Un™Te¡
& 
un™_‹¡
) = 0;

13480 şas 
	cEm±yTe¡Ev’tLi¡’”
 : 
public
 
Te¡Ev’tLi¡’”
 {

13481 
public
:

13482 
OnTe¡Prog¿mS¹
(cÚ¡ 
Un™Te¡
& ) 
ov”ride
 {}

13483 
OnTe¡I‹¿tiÚS¹
(cÚ¡ 
Un™Te¡
& ,

13484 è
	gov”ride
 {}

13485 
OnEnvœÚm’tsS‘UpS¹
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {}

13486 
OnEnvœÚm’tsS‘UpEnd
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {}

13487 
OnTe¡Su™eS¹
(cÚ¡ 
Te¡Su™e
& ) 
	gov”ride
 {}

13489 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


13490 
OnTe¡Ca£S¹
(cÚ¡ 
Te¡Ca£
& ) 
	gov”ride
 {}

13493 
OnTe¡S¹
(cÚ¡ 
Te¡Info
& ) 
	gov”ride
 {}

13494 
OnTe¡P¬tResuÉ
(cÚ¡ 
Te¡P¬tResuÉ
& ) 
	gov”ride
 {}

13495 
OnTe¡End
(cÚ¡ 
Te¡Info
& ) 
	gov”ride
 {}

13496 
OnTe¡Su™eEnd
(cÚ¡ 
Te¡Su™e
& ) 
	gov”ride
 {}

13497 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


13498 
OnTe¡Ca£End
(cÚ¡ 
Te¡Ca£
& ) 
	gov”ride
 {}

13501 
OnEnvœÚm’tsT—rDownS¹
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {}

13502 
OnEnvœÚm’tsT—rDownEnd
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {}

13503 
OnTe¡I‹¿tiÚEnd
(cÚ¡ 
Un™Te¡
& ,

13504 è
	gov”ride
 {}

13505 
OnTe¡Prog¿mEnd
(cÚ¡ 
Un™Te¡
& ) 
	gov”ride
 {}

13509 şas 
	cGTEST_API_
 
	gTe¡Ev’tLi¡’”s
 {

13510 
	gpublic
:

13511 
Te¡Ev’tLi¡’”s
();

13512 ~
Te¡Ev’tLi¡’”s
();

13517 
Aµ’d
(
Te¡Ev’tLi¡’”
* 
li¡’”
);

13522 
Te¡Ev’tLi¡’”
* 
R–—£
(Te¡Ev’tLi¡’”* 
li¡’”
);

13529 
Te¡Ev’tLi¡’”
* 
deçuÉ_»suÉ_´š‹r
() const {

13530  
	gdeçuÉ_»suÉ_´š‹r_
;

13540 
Te¡Ev’tLi¡’”
* 
deçuÉ_xml_g’”©Ü
() const {

13541  
	gdeçuÉ_xml_g’”©Ü_
;

13544 
	g´iv©e
:

13545 
ä›nd
 
şass
 
Te¡Su™e
;

13546 
ä›nd
 
şass
 
	gTe¡Info
;

13547 
ä›nd
 
şass
 
	gš‹º®
::
DeçuÉGlob®Te¡P¬tResuÉR•Ü‹r
;

13548 
ä›nd
 
şass
 
	gš‹º®
::
NoExecD—thTe¡
;

13549 
ä›nd
 
şass
 
	gš‹º®
::
Te¡Ev’tLi¡’”sAcûssÜ
;

13550 
ä›nd
 
şass
 
	gš‹º®
::
Un™Te¡Im¶
;

13554 
Te¡Ev’tLi¡’”
* 
»³©”
();

13561 
S‘DeçuÉResuÉPrš‹r
(
Te¡Ev’tLi¡’”
* 
li¡’”
);

13568 
S‘DeçuÉXmlG’”©Ü
(
Te¡Ev’tLi¡’”
* 
li¡’”
);

13572 
boŞ
 
Ev’tFÜw¬dšgEÇbËd
() const;

13573 
Suµ»ssEv’tFÜw¬dšg
();

13576 
	gš‹º®
::
Te¡Ev’tR•—‹r
* 
»³©”_
;

13578 
Te¡Ev’tLi¡’”
* 
	gdeçuÉ_»suÉ_´š‹r_
;

13580 
Te¡Ev’tLi¡’”
* 
	gdeçuÉ_xml_g’”©Ü_
;

13583 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Te¡Ev’tLi¡’”s
);

13596 şas 
	cGTEST_API_
 
	gUn™Te¡
 {

13597 
	gpublic
:

13601 
Un™Te¡
* 
G‘In¡ªû
();

13609 
Run
(è
	gGTEST_MUST_USE_RESULT_
;

13613 cÚ¡ * 
Üigš®_wÜkšg_dœ
() const;

13617 cÚ¡ 
Te¡Su™e
* 
cu¼’t_‹¡_su™e
(ècÚ¡ 
GTEST_LOCK_EXCLUDED_
(
mu‹x_
);

13620 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


13621 cÚ¡ 
Te¡Ca£
* 
cu¼’t_‹¡_ÿ£
(ècÚ¡ 
GTEST_LOCK_EXCLUDED_
(
mu‹x_
);

13626 cÚ¡ 
Te¡Info
* 
cu¼’t_‹¡_šfo
() const

13627 
GTEST_LOCK_EXCLUDED_
(
mu‹x_
);

13630 
¿ndom_£ed
() const;

13636 
	gš‹º®
::
P¬am‘”izedTe¡Su™eRegi¡ry
& 
·¿m‘”ized_‹¡_»gi¡ry
()

13637 
GTEST_LOCK_EXCLUDED_
(
mu‹x_
);

13640 
sucûssful_‹¡_su™e_couÁ
() const;

13643 
çed_‹¡_su™e_couÁ
() const;

13646 
tÙ®_‹¡_su™e_couÁ
() const;

13650 
‹¡_su™e_to_run_couÁ
() const;

13653 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


13654 
sucûssful_‹¡_ÿ£_couÁ
() const;

13655 
çed_‹¡_ÿ£_couÁ
() const;

13656 
tÙ®_‹¡_ÿ£_couÁ
() const;

13657 
‹¡_ÿ£_to_run_couÁ
() const;

13661 
sucûssful_‹¡_couÁ
() const;

13664 
sk³d_‹¡_couÁ
() const;

13667 
çed_‹¡_couÁ
() const;

13670 
»pÜbË_di§bËd_‹¡_couÁ
() const;

13673 
di§bËd_‹¡_couÁ
() const;

13676 
»pÜbË_‹¡_couÁ
() const;

13679 
tÙ®_‹¡_couÁ
() const;

13682 
‹¡_to_run_couÁ
() const;

13686 
TimeInMlis
 
¡¬t_time¡amp
() const;

13689 
TimeInMlis
 
–­£d_time
() const;

13693 
boŞ
 
Pas£d
() const;

13697 
boŞ
 
Faed
() const;

13701 cÚ¡ 
Te¡Su™e
* 
G‘Te¡Su™e
(
i
) const;

13704 #iâdeà
GTEST_REMOVE_LEGACY_TEST_CASEAPI_


13705 cÚ¡ 
Te¡Ca£
* 
G‘Te¡Ca£
(
i
) const;

13710 cÚ¡ 
	gTe¡ResuÉ
& 
ad_hoc_‹¡_»suÉ
() const;

13714 
	gTe¡Ev’tLi¡’”s
& 
li¡’”s
();

13716 
	g´iv©e
:

13726 
EnvœÚm’t
* 
AddEnvœÚm’t
(EnvœÚm’t* 
’v
);

13732 
AddTe¡P¬tResuÉ
(
Te¡P¬tResuÉ
::
Ty³
 
»suÉ_ty³
,

13733 cÚ¡ * 
fe_Çme
,

13734 
lše_numb”
,

13735 cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
,

13736 cÚ¡ 
¡d
::
¡ršg
& 
os_¡ack_Œaû
)

13737 
GTEST_LOCK_EXCLUDED_
(
mu‹x_
);

13744 
RecÜdPrİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
key
, cÚ¡ std::¡ršg& 
v®ue
);

13748 
Te¡Su™e
* 
G‘MubËTe¡Su™e
(
i
);

13751 
	gš‹º®
::
Un™Te¡Im¶
* 
im¶
(è{  
im¶_
; }

13752 cÚ¡ 
	gš‹º®
::
Un™Te¡Im¶
* 
im¶
(ècÚ¡ {  
im¶_
; }

13756 
ä›nd
 
şass
 
	gScİedT¿û
;

13757 
ä›nd
 
şass
 
	gTe¡
;

13758 
ä›nd
 
şass
 
	gš‹º®
::
As£¹H–³r
;

13759 
ä›nd
 
şass
 
	gš‹º®
::
SŒ—mšgLi¡’”Te¡
;

13760 
ä›nd
 
şass
 
	gš‹º®
::
Un™Te¡RecÜdPrİ”tyTe¡H–³r
;

13761 
ä›nd
 
EnvœÚm’t
* 
AddGlob®Te¡EnvœÚm’t
(EnvœÚm’t* 
’v
);

13762 
ä›nd
 
	gš‹º®
::
Un™Te¡Im¶
* 
š‹º®
::
G‘Un™Te¡Im¶
();

13763 
ä›nd
 
	gš‹º®
::
R•ÜtFau»InUnknownLoÿtiÚ
(

13764 
Te¡P¬tResuÉ
::
Ty³
 
»suÉ_ty³
,

13765 cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
);

13768 
Un™Te¡
();

13771 
	gvœtu®
 ~
Un™Te¡
();

13775 
PushGTe¡T¿û
(cÚ¡ 
š‹º®
::
T¿ûInfo
& 
Œaû
)

13776 
GTEST_LOCK_EXCLUDED_
(
mu‹x_
);

13779 
PİGTe¡T¿û
()

13780 
GTEST_LOCK_EXCLUDED_
(
mu‹x_
);

13784 
mubË
 
	gš‹º®
::
Mu‹x
 
mu‹x_
;

13790 
	gš‹º®
::
Un™Te¡Im¶
* 
im¶_
;

13793 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
Un™Te¡
);

13814 
šlše
 
EnvœÚm’t
* 
	$AddGlob®Te¡EnvœÚm’t
(
EnvœÚm’t
* 
’v
) {

13815  
Un™Te¡
::
	`G‘In¡ªû
()->
	`AddEnvœÚm’t
(
’v
);

13816 
	}
}

13827 
GTEST_API_
 
In™GoogËTe¡
(* 
¬gc
, ** 
¬gv
);

13831 
GTEST_API_
 
In™GoogËTe¡
(* 
¬gc
, 
wch¬_t
** 
¬gv
);

13835 
GTEST_API_
 
In™GoogËTe¡
();

13837 
Çme¥aû
 
	gš‹º®
 {

13842 
	g‹m¶©e
 <
ty³Çme
 
	gT1
,y³Çm
	gT2
>

13843 
As£¹iÚResuÉ
 
CmpH–³rEQFau»
(cÚ¡ * 
lhs_ex´essiÚ
,

13844 cÚ¡ * 
rhs_ex´essiÚ
,

13845 cÚ¡ 
T1
& 
lhs
, cÚ¡ 
T2
& 
rhs
) {

13846  
EqFau»
(
lhs_ex´essiÚ
,

13847 
rhs_ex´essiÚ
,

13848 
FÜm©FÜCom·risÚFau»Mes§ge
(
lhs
, 
rhs
),

13849 
FÜm©FÜCom·risÚFau»Mes§ge
(
rhs
, 
lhs
),

13850 
çl£
);

13856 
	sçk‘y³
 {};

13857 
šlše
 
boŞ
 
	gİ”©Ü
==(
çk‘y³
, 
	gçk‘y³
è{  
	gŒue
; }

13858 
šlše
 
boŞ
 
	gİ”©Ü
!=(
çk‘y³
, 
	gçk‘y³
è{  
	gçl£
; }

13861 
	g‹m¶©e
 <
ty³Çme
 
	gT1
,y³Çm
	gT2
>

13862 
As£¹iÚResuÉ
 
CmpH–³rEQ
(cÚ¡ * 
lhs_ex´essiÚ
,

13863 cÚ¡ * 
rhs_ex´essiÚ
,

13864 cÚ¡ 
T1
& 
lhs
,

13865 cÚ¡ 
T2
& 
rhs
) {

13866 ià(
	glhs
 =ğ
rhs
) {

13867  
As£¹iÚSucûss
();

13870  
CmpH–³rEQFau»
(
lhs_ex´essiÚ
, 
rhs_ex´essiÚ
, 
lhs
, 
rhs
);

13876 
GTEST_API_
 
As£¹iÚResuÉ
 
CmpH–³rEQ
(cÚ¡ * 
lhs_ex´essiÚ
,

13877 cÚ¡ * 
rhs_ex´essiÚ
,

13878 
Bigge¡IÁ
 
lhs
,

13879 
Bigge¡IÁ
 
rhs
);

13881 şas 
	cEqH–³r
 {

13882 
	gpublic
:

13884 
‹m¶©e
 <

13885 
ty³Çme
 
T1
,y³Çm
	gT2
,

13888 
ty³Çme
 
	g¡d
::
’abË_if
<!
¡d
::
is_š‹g¿l
<
T1
>::
v®ue
 ||

13889 !
¡d
::
is_poš‹r
<
T2
>::
v®ue
>::
ty³
* = 
nuÎ±r
>

13890 
As£¹iÚResuÉ
 
Com·»
(cÚ¡ * 
lhs_ex´essiÚ
,

13891 cÚ¡ * 
rhs_ex´essiÚ
, cÚ¡ 
T1
& 
lhs
,

13892 cÚ¡ 
T2
& 
rhs
) {

13893  
CmpH–³rEQ
(
lhs_ex´essiÚ
, 
rhs_ex´essiÚ
, 
lhs
, 
rhs
);

13902 
As£¹iÚResuÉ
 
Com·»
(cÚ¡ * 
lhs_ex´essiÚ
,

13903 cÚ¡ * 
rhs_ex´essiÚ
,

13904 
Bigge¡IÁ
 
lhs
,

13905 
Bigge¡IÁ
 
rhs
) {

13906  
CmpH–³rEQ
(
lhs_ex´essiÚ
, 
rhs_ex´essiÚ
, 
lhs
, 
rhs
);

13909 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

13910 
As£¹iÚResuÉ
 
Com·»
(

13911 cÚ¡ * 
lhs_ex´essiÚ
, cÚ¡ * 
rhs_ex´essiÚ
,

13913 
¡d
::
nuÎ±r_t
 , 
T
* 
rhs
) {

13915  
CmpH–³rEQ
(
lhs_ex´essiÚ
, 
rhs_ex´essiÚ
, 
¡©ic_ÿ¡
<
T
*>(
nuÎ±r
),

13916 
rhs
);

13923 
	g‹m¶©e
 <
ty³Çme
 
	gT1
,y³Çm
	gT2
>

13924 
As£¹iÚResuÉ
 
CmpH–³rOpFau»
(cÚ¡ * 
ex´1
, cÚ¡ * 
ex´2
,

13925 cÚ¡ 
T1
& 
v®1
, cÚ¡ 
T2
& 
v®2
,

13926 cÚ¡ * 
İ
) {

13927  
As£¹iÚFau»
()

13928 << "Ex³ùed: (" << 
	gex´1
 << "è" << 
	gİ
 << " (" << 
	gex´2


13929 << "),‡ùu®: " << 
FÜm©FÜCom·risÚFau»Mes§ge
(
v®1
, 
v®2
)

13930 << " v " << 
FÜm©FÜCom·risÚFau»Mes§ge
(
v®2
, 
v®1
);

13944 
	#GTEST_IMPL_CMP_HELPER_
(
İ_Çme
, 
İ
)\

13945 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
>\

13946 
As£¹iÚResuÉ
 
CmpH–³r
##
	`İ_Çme
(cÚ¡ * 
ex´1
, cÚ¡ * 
ex´2
, \

13947 cÚ¡ 
T1
& 
v®1
, cÚ¡ 
T2
& 
v®2
) {\

13948 ià(
v®1
 
İ
 
v®2
) {\

13949  
	`As£¹iÚSucûss
();\

13951  
	`CmpH–³rOpFau»
(
ex´1
, 
ex´2
, 
v®1
, 
v®2
, #op);\

13954 
GTEST_API_
 
As£¹iÚResuÉ
 
CmpH–³r
##
	`İ_Çme
(\

13955 cÚ¡ * 
ex´1
, cÚ¡ * 
ex´2
, 
Bigge¡IÁ
 
v®1
, Bigge¡IÁ 
v®2
)

	)

13960 
GTEST_IMPL_CMP_HELPER_
(
NE
, !=);

13962 
GTEST_IMPL_CMP_HELPER_
(
LE
, <=);

13964 
GTEST_IMPL_CMP_HELPER_
(
LT
, <);

13966 
GTEST_IMPL_CMP_HELPER_
(
GE
, >=);

13968 
GTEST_IMPL_CMP_HELPER_
(
GT
, >);

13970 #undeà
GTEST_IMPL_CMP_HELPER_


13975 
GTEST_API_
 
As£¹iÚResuÉ
 
CmpH–³rSTREQ
(cÚ¡ * 
s1_ex´essiÚ
,

13976 cÚ¡ * 
s2_ex´essiÚ
,

13977 cÚ¡ * 
s1
,

13978 cÚ¡ * 
s2
);

13983 
GTEST_API_
 
As£¹iÚResuÉ
 
CmpH–³rSTRCASEEQ
(cÚ¡ * 
s1_ex´essiÚ
,

13984 cÚ¡ * 
s2_ex´essiÚ
,

13985 cÚ¡ * 
s1
,

13986 cÚ¡ * 
s2
);

13991 
GTEST_API_
 
As£¹iÚResuÉ
 
CmpH–³rSTRNE
(cÚ¡ * 
s1_ex´essiÚ
,

13992 cÚ¡ * 
s2_ex´essiÚ
,

13993 cÚ¡ * 
s1
,

13994 cÚ¡ * 
s2
);

13999 
GTEST_API_
 
As£¹iÚResuÉ
 
CmpH–³rSTRCASENE
(cÚ¡ * 
s1_ex´essiÚ
,

14000 cÚ¡ * 
s2_ex´essiÚ
,

14001 cÚ¡ * 
s1
,

14002 cÚ¡ * 
s2
);

14008 
GTEST_API_
 
As£¹iÚResuÉ
 
CmpH–³rSTREQ
(cÚ¡ * 
s1_ex´essiÚ
,

14009 cÚ¡ * 
s2_ex´essiÚ
,

14010 cÚ¡ 
wch¬_t
* 
s1
,

14011 cÚ¡ 
wch¬_t
* 
s2
);

14016 
GTEST_API_
 
As£¹iÚResuÉ
 
CmpH–³rSTRNE
(cÚ¡ * 
s1_ex´essiÚ
,

14017 cÚ¡ * 
s2_ex´essiÚ
,

14018 cÚ¡ 
wch¬_t
* 
s1
,

14019 cÚ¡ 
wch¬_t
* 
s2
);

14031 
GTEST_API_
 
As£¹iÚResuÉ
 
IsSub¡ršg
(

14032 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

14033 cÚ¡ * 
ÃedË
, cÚ¡ * 
hay¡ack
);

14034 
GTEST_API_
 
As£¹iÚResuÉ
 
IsSub¡ršg
(

14035 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

14036 cÚ¡ 
wch¬_t
* 
ÃedË
, cÚ¡ wch¬_t* 
hay¡ack
);

14037 
GTEST_API_
 
As£¹iÚResuÉ
 
IsNÙSub¡ršg
(

14038 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

14039 cÚ¡ * 
ÃedË
, cÚ¡ * 
hay¡ack
);

14040 
GTEST_API_
 
As£¹iÚResuÉ
 
IsNÙSub¡ršg
(

14041 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

14042 cÚ¡ 
wch¬_t
* 
ÃedË
, cÚ¡ wch¬_t* 
hay¡ack
);

14043 
GTEST_API_
 
As£¹iÚResuÉ
 
IsSub¡ršg
(

14044 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

14045 cÚ¡ ::
¡d
::
¡ršg
& 
ÃedË
, cÚ¡ ::¡d::¡ršg& 
hay¡ack
);

14046 
GTEST_API_
 
As£¹iÚResuÉ
 
IsNÙSub¡ršg
(

14047 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

14048 cÚ¡ ::
¡d
::
¡ršg
& 
ÃedË
, cÚ¡ ::¡d::¡ršg& 
hay¡ack
);

14050 #ià
GTEST_HAS_STD_WSTRING


14051 
GTEST_API_
 
As£¹iÚResuÉ
 
IsSub¡ršg
(

14052 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

14053 cÚ¡ ::
¡d
::
w¡ršg
& 
ÃedË
, cÚ¡ ::¡d::w¡ršg& 
hay¡ack
);

14054 
GTEST_API_
 
As£¹iÚResuÉ
 
IsNÙSub¡ršg
(

14055 cÚ¡ * 
ÃedË_ex´
, cÚ¡ * 
hay¡ack_ex´
,

14056 cÚ¡ ::
¡d
::
w¡ršg
& 
ÃedË
, cÚ¡ ::¡d::w¡ršg& 
hay¡ack
);

14059 
Çme¥aû
 
	gš‹º®
 {

14068 
	g‹m¶©e
 <
ty³Çme
 
	gRawTy³
>

14069 
As£¹iÚResuÉ
 
CmpH–³rFlßtšgPoštEQ
(cÚ¡ * 
lhs_ex´essiÚ
,

14070 cÚ¡ * 
rhs_ex´essiÚ
,

14071 
RawTy³
 
lhs_v®ue
,

14072 
RawTy³
 
rhs_v®ue
) {

14073 cÚ¡ 
	gFlßtšgPošt
<
	gRawTy³
> 
lhs
(
lhs_v®ue
), 
rhs
(
rhs_v®ue
);

14075 ià(
	glhs
.
Almo¡Equ®s
(
rhs
)) {

14076  
As£¹iÚSucûss
();

14079 ::
¡d
::
¡ršg¡»am
 
lhs_ss
;

14080 
	glhs_ss
 << 
	g¡d
::
£»cisiÚ
(
¡d
::
num”ic_lim™s
<
RawTy³
>::
dig™s10
 + 2)

14081 << 
lhs_v®ue
;

14083 ::
¡d
::
¡ršg¡»am
 
rhs_ss
;

14084 
	grhs_ss
 << 
	g¡d
::
£»cisiÚ
(
¡d
::
num”ic_lim™s
<
RawTy³
>::
dig™s10
 + 2)

14085 << 
rhs_v®ue
;

14087  
EqFau»
(
lhs_ex´essiÚ
,

14088 
rhs_ex´essiÚ
,

14089 
SŒšgSŒ—mToSŒšg
(&
lhs_ss
),

14090 
SŒšgSŒ—mToSŒšg
(&
rhs_ss
),

14091 
çl£
);

14097 
GTEST_API_
 
As£¹iÚResuÉ
 
DoubËN—rP»dFÜm©
(cÚ¡ * 
ex´1
,

14098 cÚ¡ * 
ex´2
,

14099 cÚ¡ * 
abs_”rÜ_ex´
,

14100 
v®1
,

14101 
v®2
,

14102 
abs_”rÜ
);

14106 şas 
	cGTEST_API_
 
	gAs£¹H–³r
 {

14107 
	gpublic
:

14109 
As£¹H–³r
(
Te¡P¬tResuÉ
::
Ty³
 
ty³
,

14110 cÚ¡ * 
fe
,

14111 
lše
,

14112 cÚ¡ * 
mes§ge
);

14113 ~
As£¹H–³r
();

14117 
	gİ”©Ü
=(cÚ¡ 
Mes§ge
& 
mes§ge
) const;

14119 
	g´iv©e
:

14124 
	sAs£¹H–³rD©a
 {

14125 
As£¹H–³rD©a
(
Te¡P¬tResuÉ
::
Ty³
 
t
,

14126 cÚ¡ * 
¤cfe
,

14127 
lše_num
,

14128 cÚ¡ * 
msg
)

14129 : 
ty³
(
t
), 
fe
(
¤cfe
), 
lše
(
lše_num
), 
mes§ge
(
msg
) { }

14131 
	gTe¡P¬tResuÉ
::
Ty³
 cÚ¡ 
ty³
;

14132 cÚ¡ * cÚ¡ 
	gfe
;

14133 cÚ¡ 
	glše
;

14134 
	g¡d
::
¡ršg
 cÚ¡ 
mes§ge
;

14136 
	g´iv©e
:

14137 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
As£¹H–³rD©a
);

14140 
As£¹H–³rD©a
* cÚ¡ 
	gd©a_
;

14142 
GTEST_DISALLOW_COPY_AND_ASSIGN_
(
As£¹H–³r
);

14145 
	eGTe¡CŞÜ
 { 
	gCOLOR_DEFAULT
, 
	gCOLOR_RED
, 
	gCOLOR_GREEN
, 
	gCOLOR_YELLOW
 };

14147 
GTEST_API_
 
GTEST_ATTRIBUTE_PRINTF_
(2, 3è
CŞÜedPrštf
(
GTe¡CŞÜ
 
cŞÜ
,

14148 cÚ¡ * 
fmt
,

14187 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

14188 şas 
	cW™hP¬amIÁ”çû
 {

14189 
	gpublic
:

14190 
T
 
	tP¬amTy³
;

14191 
	gvœtu®
 ~
W™hP¬amIÁ”çû
() {}

14195 cÚ¡ 
	gP¬amTy³
& 
G‘P¬am
() {

14196 
GTEST_CHECK_
(
·¿m‘”_
 !ğ
nuÎ±r
)

14199  *
	g·¿m‘”_
;

14202 
	g´iv©e
:

14205 
S‘P¬am
(cÚ¡ 
P¬amTy³
* 
·¿m‘”
) {

14206 
·¿m‘”_
 = 
·¿m‘”
;

14210 cÚ¡ 
P¬amTy³
* 
	g·¿m‘”_
;

14213 
	g‹m¶©e
 <
şass
 
	gTe¡CÏss
> 
ä›nd
 cÏs 
	gš‹º®
::
P¬am‘”izedTe¡FaùÜy
;

14216 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

14217 cÚ¡ 
T
* 
	gW™hP¬amIÁ”çû
<
	gT
>::
·¿m‘”_
 = 
nuÎ±r
;

14222 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

14223 
şass
 
	gTe¡W™hP¬am
 : 
public
 
Te¡
,…ubliø
	gW™hP¬amIÁ”çû
<
	gT
> {

14231 
	#GTEST_SKIP
(è
	`GTEST_SKIP_
("Sk³d")

	)

14251 
	#ADD_FAILURE
(è
	`GTEST_NONFATAL_FAILURE_
("Faed")

	)

14255 
	#ADD_FAILURE_AT
(
fe
, 
lše
) \

14256 
	`GTEST_MESSAGE_AT_
(
fe
, 
lše
, "Failed", \

14257 ::
‹¡šg
::
Te¡P¬tResuÉ
::
kNÚF©®Fau»
)

	)

14260 
	#GTEST_FAIL
(è
	`GTEST_FATAL_FAILURE_
("Faed")

	)

14263 
	#GTEST_FAIL_AT
(
fe
, 
lše
) \

14264 
	`GTEST_MESSAGE_AT_
(
fe
, 
lše
, "Failed", \

14265 ::
‹¡šg
::
Te¡P¬tResuÉ
::
kF©®Fau»
)

	)

14269 #ià!
GTEST_DONT_DEFINE_FAIL


14270 
	#FAIL
(è
	$GTEST_FAIL
()

	)

14274 
	#GTEST_SUCCEED
(è
	`GTEST_SUCCESS_
("Sucûeded")

	)

14278 #ià!
GTEST_DONT_DEFINE_SUCCEED


14279 
	#SUCCEED
(è
	$GTEST_SUCCEED
()

	)

14291 
	#EXPECT_THROW
(
¡©em’t
, 
ex³ùed_exû±iÚ
) \

14292 
	$GTEST_TEST_THROW_
(
¡©em’t
, 
ex³ùed_exû±iÚ
, 
GTEST_NONFATAL_FAILURE_
)

	)

14293 
	#EXPECT_NO_THROW
(
¡©em’t
) \

14294 
	$GTEST_TEST_NO_THROW_
(
¡©em’t
, 
GTEST_NONFATAL_FAILURE_
)

	)

14295 
	#EXPECT_ANY_THROW
(
¡©em’t
) \

14296 
	$GTEST_TEST_ANY_THROW_
(
¡©em’t
, 
GTEST_NONFATAL_FAILURE_
)

	)

14297 
	#ASSERT_THROW
(
¡©em’t
, 
ex³ùed_exû±iÚ
) \

14298 
	$GTEST_TEST_THROW_
(
¡©em’t
, 
ex³ùed_exû±iÚ
, 
GTEST_FATAL_FAILURE_
)

	)

14299 
	#ASSERT_NO_THROW
(
¡©em’t
) \

14300 
	$GTEST_TEST_NO_THROW_
(
¡©em’t
, 
GTEST_FATAL_FAILURE_
)

	)

14301 
	#ASSERT_ANY_THROW
(
¡©em’t
) \

14302 
	$GTEST_TEST_ANY_THROW_
(
¡©em’t
, 
GTEST_FATAL_FAILURE_
)

	)

14307 
	#EXPECT_TRUE
(
cÚd™iÚ
) \

14308 
	`GTEST_TEST_BOOLEAN_
(
cÚd™iÚ
, #cÚd™iÚ, 
çl£
, 
Œue
, \

14309 
GTEST_NONFATAL_FAILURE_
)

	)

14310 
	#EXPECT_FALSE
(
cÚd™iÚ
) \

14311 
	`GTEST_TEST_BOOLEAN_
(!(
cÚd™iÚ
), #cÚd™iÚ, 
Œue
, 
çl£
, \

14312 
GTEST_NONFATAL_FAILURE_
)

	)

14313 
	#ASSERT_TRUE
(
cÚd™iÚ
) \

14314 
	`GTEST_TEST_BOOLEAN_
(
cÚd™iÚ
, #cÚd™iÚ, 
çl£
, 
Œue
, \

14315 
GTEST_FATAL_FAILURE_
)

	)

14316 
	#ASSERT_FALSE
(
cÚd™iÚ
) \

14317 
	`GTEST_TEST_BOOLEAN_
(!(
cÚd™iÚ
), #cÚd™iÚ, 
Œue
, 
çl£
, \

14318 
GTEST_FATAL_FAILURE_
)

	)

14366 
	#EXPECT_EQ
(
v®1
, 
v®2
) \

14367 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
EqH–³r
::
Com·»
, 
v®1
, 
v®2
)

	)

14368 
	#EXPECT_NE
(
v®1
, 
v®2
) \

14369 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rNE
, 
v®1
, 
v®2
)

	)

14370 
	#EXPECT_LE
(
v®1
, 
v®2
) \

14371 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rLE
, 
v®1
, 
v®2
)

	)

14372 
	#EXPECT_LT
(
v®1
, 
v®2
) \

14373 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rLT
, 
v®1
, 
v®2
)

	)

14374 
	#EXPECT_GE
(
v®1
, 
v®2
) \

14375 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rGE
, 
v®1
, 
v®2
)

	)

14376 
	#EXPECT_GT
(
v®1
, 
v®2
) \

14377 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rGT
, 
v®1
, 
v®2
)

	)

14379 
	#GTEST_ASSERT_EQ
(
v®1
, 
v®2
) \

14380 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
EqH–³r
::
Com·»
, 
v®1
, 
v®2
)

	)

14381 
	#GTEST_ASSERT_NE
(
v®1
, 
v®2
) \

14382 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rNE
, 
v®1
, 
v®2
)

	)

14383 
	#GTEST_ASSERT_LE
(
v®1
, 
v®2
) \

14384 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rLE
, 
v®1
, 
v®2
)

	)

14385 
	#GTEST_ASSERT_LT
(
v®1
, 
v®2
) \

14386 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rLT
, 
v®1
, 
v®2
)

	)

14387 
	#GTEST_ASSERT_GE
(
v®1
, 
v®2
) \

14388 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rGE
, 
v®1
, 
v®2
)

	)

14389 
	#GTEST_ASSERT_GT
(
v®1
, 
v®2
) \

14390 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rGT
, 
v®1
, 
v®2
)

	)

14395 #ià!
GTEST_DONT_DEFINE_ASSERT_EQ


14396 
	#ASSERT_EQ
(
v®1
, 
v®2
è
	$GTEST_ASSERT_EQ
(
v®1
, 
v®2
)

	)

14399 #ià!
GTEST_DONT_DEFINE_ASSERT_NE


14400 
	#ASSERT_NE
(
v®1
, 
v®2
è
	$GTEST_ASSERT_NE
(
v®1
, 
v®2
)

	)

14403 #ià!
GTEST_DONT_DEFINE_ASSERT_LE


14404 
	#ASSERT_LE
(
v®1
, 
v®2
è
	$GTEST_ASSERT_LE
(
v®1
, 
v®2
)

	)

14407 #ià!
GTEST_DONT_DEFINE_ASSERT_LT


14408 
	#ASSERT_LT
(
v®1
, 
v®2
è
	$GTEST_ASSERT_LT
(
v®1
, 
v®2
)

	)

14411 #ià!
GTEST_DONT_DEFINE_ASSERT_GE


14412 
	#ASSERT_GE
(
v®1
, 
v®2
è
	$GTEST_ASSERT_GE
(
v®1
, 
v®2
)

	)

14415 #ià!
GTEST_DONT_DEFINE_ASSERT_GT


14416 
	#ASSERT_GT
(
v®1
, 
v®2
è
	$GTEST_ASSERT_GT
(
v®1
, 
v®2
)

	)

14435 
	#EXPECT_STREQ
(
s1
, 
s2
) \

14436 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rSTREQ
, 
s1
, 
s2
)

	)

14437 
	#EXPECT_STRNE
(
s1
, 
s2
) \

14438 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rSTRNE
, 
s1
, 
s2
)

	)

14439 
	#EXPECT_STRCASEEQ
(
s1
, 
s2
) \

14440 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rSTRCASEEQ
, 
s1
, 
s2
)

	)

14441 
	#EXPECT_STRCASENE
(
s1
, 
s2
)\

14442 
	$EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rSTRCASENE
, 
s1
, 
s2
)

	)

14444 
	#ASSERT_STREQ
(
s1
, 
s2
) \

14445 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rSTREQ
, 
s1
, 
s2
)

	)

14446 
	#ASSERT_STRNE
(
s1
, 
s2
) \

14447 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rSTRNE
, 
s1
, 
s2
)

	)

14448 
	#ASSERT_STRCASEEQ
(
s1
, 
s2
) \

14449 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rSTRCASEEQ
, 
s1
, 
s2
)

	)

14450 
	#ASSERT_STRCASENE
(
s1
, 
s2
)\

14451 
	$ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rSTRCASENE
, 
s1
, 
s2
)

	)

14467 
	#EXPECT_FLOAT_EQ
(
v®1
, 
v®2
)\

14468 
	`EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

14469 
v®1
, 
v®2
)

	)

14471 
	#EXPECT_DOUBLE_EQ
(
v®1
, 
v®2
)\

14472 
	`EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

14473 
v®1
, 
v®2
)

	)

14475 
	#ASSERT_FLOAT_EQ
(
v®1
, 
v®2
)\

14476 
	`ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

14477 
v®1
, 
v®2
)

	)

14479 
	#ASSERT_DOUBLE_EQ
(
v®1
, 
v®2
)\

14480 
	`ASSERT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

14481 
v®1
, 
v®2
)

	)

14483 
	#EXPECT_NEAR
(
v®1
, 
v®2
, 
abs_”rÜ
)\

14484 
	`EXPECT_PRED_FORMAT3
(::
‹¡šg
::
š‹º®
::
DoubËN—rP»dFÜm©
, \

14485 
v®1
, 
v®2
, 
abs_”rÜ
)

	)

14487 
	#ASSERT_NEAR
(
v®1
, 
v®2
, 
abs_”rÜ
)\

14488 
	`ASSERT_PRED_FORMAT3
(::
‹¡šg
::
š‹º®
::
DoubËN—rP»dFÜm©
, \

14489 
v®1
, 
v®2
, 
abs_”rÜ
)

	)

14498 
GTEST_API_
 
As£¹iÚResuÉ
 
	`FlßtLE
(cÚ¡ * 
ex´1
, cÚ¡ * 
ex´2
,

14499 
v®1
, 
v®2
);

14500 
GTEST_API_
 
As£¹iÚResuÉ
 
	`DoubËLE
(cÚ¡ * 
ex´1
, cÚ¡ * 
ex´2
,

14501 
v®1
, 
v®2
);

14504 #ià
GTEST_OS_WINDOWS


14515 
	#EXPECT_HRESULT_SUCCEEDED
(
ex´
) \

14516 
	`EXPECT_PRED_FORMAT1
(::
‹¡šg
::
š‹º®
::
IsHRESULTSucûss
, (
ex´
))

	)

14518 
	#ASSERT_HRESULT_SUCCEEDED
(
ex´
) \

14519 
	`ASSERT_PRED_FORMAT1
(::
‹¡šg
::
š‹º®
::
IsHRESULTSucûss
, (
ex´
))

	)

14521 
	#EXPECT_HRESULT_FAILED
(
ex´
) \

14522 
	`EXPECT_PRED_FORMAT1
(::
‹¡šg
::
š‹º®
::
IsHRESULTFau»
, (
ex´
))

	)

14524 
	#ASSERT_HRESULT_FAILED
(
ex´
) \

14525 
	`ASSERT_PRED_FORMAT1
(::
‹¡šg
::
š‹º®
::
IsHRESULTFau»
, (
ex´
))

	)

14539 
	#ASSERT_NO_FATAL_FAILURE
(
¡©em’t
) \

14540 
	$GTEST_TEST_NO_FATAL_FAILURE_
(
¡©em’t
, 
GTEST_FATAL_FAILURE_
)

	)

14541 
	#EXPECT_NO_FATAL_FAILURE
(
¡©em’t
) \

14542 
	$GTEST_TEST_NO_FATAL_FAILURE_
(
¡©em’t
, 
GTEST_NONFATAL_FAILURE_
)

	)

14554 şas 
	cGTEST_API_
 
ScİedT¿û
 {

14555 
public
:

14561 
‹m¶©e
 <
ty³Çme
 
T
>

14562 
	`ScİedT¿û
(cÚ¡ * 
fe
, 
lše
, cÚ¡ 
T
& 
mes§ge
) {

14563 
	`PushT¿û
(
fe
, 
lše
, (
	`Mes§ge
(è<< 
mes§ge
).
	`G‘SŒšg
());

14567 
	`ScİedT¿û
(cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
mes§ge
) {

14568 
	`PushT¿û
(
fe
, 
lše
, 
mes§ge
 ? message : "(null)");

14571 
	`ScİedT¿û
(cÚ¡ * 
fe
, 
lše
, cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
) {

14572 
	`PushT¿û
(
fe
, 
lše
, 
mes§ge
);

14579 ~
	`ScİedT¿û
();

14581 
´iv©e
:

14582 
	`PushT¿û
(cÚ¡ * 
fe
, 
lše
, 
¡d
::
¡ršg
 
mes§ge
);

14584 
	`GTEST_DISALLOW_COPY_AND_ASSIGN_
(
ScİedT¿û
);

14585 
	}
} 
	gGTEST_ATTRIBUTE_UNUSED_
;

14604 
	#SCOPED_TRACE
(
mes§ge
) \

14605 ::
‹¡šg
::
ScİedT¿û
 
	`GTEST_CONCAT_TOKEN_
(
g‹¡_Œaû_
, 
__LINE__
)(\

14606 
__FILE__
, 
__LINE__
, (
mes§ge
))

	)

14638 
	g‹m¶©e
 <
ty³Çme
 
	gT1
,y³Çm
	gT2
>

14639 
cÚ¡ex´
 
boŞ
 
	$SticAs£¹Ty³Eq
(è
nÛxû±
 {

14640 
	`¡©ic_as£¹
(
¡d
::
is_§me
<
T1
, 
T2
>::
v®ue
,

14642  
Œue
;

14643 
	}
}

14670 
	#GTEST_TEST
(
‹¡_su™e_Çme
, 
‹¡_Çme
) \

14671 
	`GTEST_TEST_
(
‹¡_su™e_Çme
, 
‹¡_Çme
, ::
‹¡šg
::
Te¡
, \

14672 ::
‹¡šg
::
š‹º®
::
	$G‘Te¡Ty³Id
())

	)

14676 #ià!
GTEST_DONT_DEFINE_TEST


14677 
	#TEST
(
‹¡_su™e_Çme
, 
‹¡_Çme
è
	$GTEST_TEST
(
‹¡_su™e_Çme
, 
‹¡_Çme
)

	)

14707 
	#TEST_F
(
‹¡_fixtu»
, 
‹¡_Çme
)\

14708 
	`GTEST_TEST_
(
‹¡_fixtu»
, 
‹¡_Çme
,est_fixture, \

14709 ::
‹¡šg
::
š‹º®
::
G‘Ty³Id
<
‹¡_fixtu»
>())

	)

14713 
GTEST_API_
 
¡d
::
¡ršg
 
	`TempDœ
();

14715 #ifdeà
_MSC_VER


14716 #´agm¨
	$w¬nšg
(
pİ
)

14776 
‹m¶©e
 <&... 
Ex¶ic™P¬am‘”B¬r›r
, 
ty³Çme
 
FaùÜy
>

14777 
Te¡Info
* 
	$Regi¡”Te¡
(cÚ¡ * 
‹¡_su™e_Çme
, cÚ¡ * 
‹¡_Çme
,

14778 cÚ¡ * 
ty³_·¿m
, cÚ¡ * 
v®ue_·¿m
,

14779 cÚ¡ * 
fe
, 
lše
, 
FaùÜy
 
çùÜy
) {

14780 
usšg
 
Te¡T
 = 
ty³Çme
 
¡d
::
»move_poš‹r
<
	`deşty³
(
	`çùÜy
())>::
ty³
;

14782 şas 
	cFaùÜyIm¶
 : 
public
 
š‹º®
::
Te¡FaùÜyBa£
 {

14783 
public
:

14784 
ex¶ic™
 
	`FaùÜyIm¶
(
FaùÜy
 
f
è: 
	`çùÜy_
(
¡d
::
	`move
(f)) {}

14785 
Te¡
* 
	`C»©eTe¡
(è
ov”ride
 {  
	`çùÜy_
(); }

14787 
´iv©e
:

14788 
FaùÜy
 
çùÜy_
;

14791  
š‹º®
::
	`MakeAndRegi¡”Te¡Info
(

14792 
‹¡_su™e_Çme
, 
‹¡_Çme
, 
ty³_·¿m
, 
v®ue_·¿m
,

14793 
š‹º®
::
	`CodeLoÿtiÚ
(
fe
, 
lše
), iÁ”Çl::
G‘Ty³Id
<
Te¡T
>(),

14794 
š‹º®
::
Su™eApiResŞv”
<
Te¡T
>::
	`G‘S‘UpCa£OrSu™e
(
fe
, 
lše
),

14795 
š‹º®
::
Su™eApiResŞv”
<
Te¡T
>::
	`G‘T—rDownCa£OrSu™e
(
fe
, 
lše
),

14796 
Ãw
 
FaùÜyIm¶
{
¡d
::
	`move
(
çùÜy
)});

14797 
	}
}

14809 
	$RUN_ALL_TESTS
(è
GTEST_MUST_USE_RESULT_
;

14811 
šlše
 
	$RUN_ALL_TESTS
() {

14812  ::
‹¡šg
::
Un™Te¡
::
	`G‘In¡ªû
()->
	`Run
();

14813 
	}
}

14815 
	$GTEST_DISABLE_MSC_WARNINGS_POP_
()

	@test/gtest/common/main.cc

8 #ifdeà
HAVE_CONFIG_H


9 
	~"cÚfig.h
"

12 #ifdeà
HAVE_CUDA


13 
	~<cuda_ruÁime.h
>

16 
	~"‹¡_ucc.h
"

18 
	$maš
(
¬gc
, **
¬gv
)

20 
»t
;

22 #ifdeà
HAVE_CUDA


23 
	`cudaS‘Deviû
(0);

25 ::
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

27 
»t
 = 
	`RUN_ALL_TESTS
();

29 
UccJob
::
	`ş—nup
();

30  
»t
;

31 
	}
}

	@test/gtest/common/test.h

8 #iâdeà
UCC_TEST_BASE_H


9 
	#UCC_TEST_BASE_H


	)

14 
	~<com¶ex.h
>

15 #undeà
I


16 
	#_Imag
 
_Imagš¬y_I


	)

17 
	~"g‹¡.h
"

19 
	#UCC_CHECK
(
_ÿÎ
è
	`EXPECT_EQ
(
UCC_OK
, (_ÿÎ))

	)

21 
	#UCC_TEST_SKIP_R
(
_¡r
è
	`GTEST_SKIP_
(_¡r)

	)

23 
Çme¥aû
 
ucc
 {

25 şas 
	c‹¡
 : 
public
 
‹¡šg
::
Te¡
 {

28 
	#UCC_TEST_F
(...è
	$TEST_F
(
__VA_ARGS__
)

	)

29 
	#UCC_TEST_P
(...è
	`TEST_P
(
__VA_ARGS__
)

	)

30 
	}
}

32 
	#ASSERT_FLOAT32_COMPLEX_EQ
(
ex³ùed
, 
aùu®
) \

34 
ex³ùed_»®
 = 
	`ü—lf
(
ex³ùed
); \

35 
ex³ùed_imagš¬y
 = 
	`cimagf
(
ex³ùed
); \

36 
aùu®_»®
 = 
	`ü—lf
(
aùu®
); \

37 
aùu®_imagš¬y
 = 
	`cimagf
(
aùu®
); \

38 
	`ASSERT_PRED_FORMAT2
( \

39 ::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

40 
ex³ùed_»®
, 
aùu®_»®
); \

41 
	`ASSERT_PRED_FORMAT2
( \

42 ::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

43 
ex³ùed_imagš¬y
, 
aùu®_imagš¬y
); \

44 } 0)

	)

45 
	#ASSERT_FLOAT64_COMPLEX_EQ
(
ex³ùed
, 
aùu®
) \

47 
ex³ùed_»®
 = 
	`ü—l
(
ex³ùed
); \

48 
ex³ùed_imagš¬y
 = 
	`cimag
(
ex³ùed
); \

49 
aùu®_»®
 = 
	`ü—l
(
aùu®
); \

50 
aùu®_imagš¬y
 = 
	`cimag
(
aùu®
); \

51 
	`ASSERT_PRED_FORMAT2
( \

52 ::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

53 
ex³ùed_»®
, 
aùu®_»®
); \

54 
	`ASSERT_PRED_FORMAT2
( \

55 ::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

56 
ex³ùed_imagš¬y
, 
aùu®_imagš¬y
); \

57 } 0)

	)

58 
	#ASSERT_FLOAT128_COMPLEX_EQ
(
ex³ùed
, 
aùu®
) \

60 
ex³ùed_»®
 = 
	`ü—Î
(
ex³ùed
); \

61 
ex³ùed_imagš¬y
 = 
	`cimagl
(
ex³ùed
); \

62 
aùu®_»®
 = 
	`ü—Î
(
aùu®
); \

63 
aùu®_imagš¬y
 = 
	`cimagl
(
aùu®
); \

64 
	`ASSERT_PRED_FORMAT2
( \

65 ::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

66 
ex³ùed_»®
, 
aùu®_»®
); \

67 
	`ASSERT_PRED_FORMAT2
( \

68 ::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

69 
ex³ùed_imagš¬y
, 
aùu®_imagš¬y
); \

70 } 0)

	)

72 
	#EXPECT_FLOAT32_COMPLEX_EQ
(
ex³ùed
, 
aùu®
) \

73 
ex³ùed_»®
 = 
	`ü—lf
(
ex³ùed
); \

74 
ex³ùed_imagš¬y
 = 
	`cimagf
(
ex³ùed
); \

75 
aùu®_»®
 = 
	`ü—lf
(
aùu®
); \

76 
aùu®_imagš¬y
 = 
	`cimagf
(
aùu®
); \

77 
	`EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

78 
ex³ùed_»®
, 
aùu®_»®
) \

79 
	`EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

80 
ex³ùed_imagš¬y
, 
aùu®_imagš¬y
)

	)

81 
	#EXPECT_FLOAT64_COMPLEX_EQ
(
ex³ùed
, 
aùu®
) \

82 
ex³ùed_»®
 = 
	`ü—l
(
ex³ùed
); \

83 
ex³ùed_imagš¬y
 = 
	`cimag
(
ex³ùed
); \

84 
aùu®_»®
 = 
	`ü—l
(
aùu®
); \

85 
aùu®_imagš¬y
 = 
	`cimag
(
aùu®
); \

86 
	`EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

87 
ex³ùed_»®
, 
aùu®_»®
) \

88 
	`EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

89 
ex³ùed_imagš¬y
, 
aùu®_imagš¬y
)

	)

90 
	#EXPECT_FLOAT128_COMPLEX_EQ
(
ex³ùed
, 
aùu®
) \

91 
ex³ùed_»®
 = 
	`ü—Î
(
ex³ùed
); \

92 
ex³ùed_imagš¬y
 = 
	`cimagl
(
ex³ùed
); \

93 
aùu®_»®
 = 
	`ü—Î
(
aùu®
); \

94 
aùu®_imagš¬y
 = 
	`cimagl
(
aùu®
); \

95 
	`EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

96 
ex³ùed_»®
, 
aùu®_»®
) \

97 
	`EXPECT_PRED_FORMAT2
(::
‹¡šg
::
š‹º®
::
CmpH–³rFlßtšgPoštEQ
<>, \

98 
ex³ùed_imagš¬y
, 
aùu®_imagš¬y
)

	)

	@test/gtest/common/test_obj_size.cc

8 #ifdeà
HAVE_CONFIG_H


9 
	~"cÚfig.h
"

12 
	~<commÚ/‹¡.h
>

15 
	~<scheduË/ucc_scheduË.h
>

18 şas 
	c‹¡_obj_size
 : 
public
 
ucc
::
‹¡
 {

21 
	$UCC_TEST_F
(
‹¡_obj_size
, 
size
) {

24 
	`EXPECT_LT
((
ucc_cŞl_sk_t
), 64 * 8);

25 
	}
}

	@test/gtest/common/test_ucc.cc

5 
	~"‹¡_ucc.h
"

7 
	~"cÜe/ucc_‹am.h
"

8 
	~"compÚ’ts//ucc_.h
"

10 
cÚ¡ex´
 
ucc_lib_·¿ms_t
 
UccProûss
::
deçuÉ_lib_·¿ms
;

11 
cÚ¡ex´
 
ucc_cÚ‹xt_·¿ms_t
 
	gUccProûss
::
deçuÉ_ùx_·¿ms
;

12 
cÚ¡ex´
 
	gUccJob
::
¡©icT—mSizes
[];

14 
	gUccProûss
::
	$UccProûss
(
_job_¿nk
, cÚ¡ 
ucc_lib_·¿ms_t
 &
lib_·¿ms
,

15 cÚ¡ 
ucc_cÚ‹xt_·¿ms_t
 &
_ùx_·¿ms
)

17 
ucc_lib_cÚfig_h
 
lib_cÚfig
;

18 
ucc_¡©us_t
 
¡©us
;

19 
¡d
::
¡ršg¡»am
 
”r_msg
;

21 
job_¿nk
 = 
_job_¿nk
;

22 
ùx_·¿ms
 = 
_ùx_·¿ms
;

23 
¡©us
 = 
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
lib_cÚfig
);

24 ià(
¡©us
 !ğ
UCC_OK
) {

25 
”r_msg
 << "ucc_lib_config_read failed";

26 
ex™_”r
;

28 
¡©us
 = 
	`ucc_š™
(&
lib_·¿ms
, 
lib_cÚfig
, &
lib_h
);

29 
	`ucc_lib_cÚfig_»Ëa£
(
lib_cÚfig
);

30 ià(
¡©us
 !ğ
UCC_OK
) {

31 
”r_msg
 << "ucc_init failed";

32 
ex™_”r
;

36 
ex™_”r
:

37 
”r_msg
 << ": "<< 
	`ucc_¡©us_¡ršg
(
¡©us
) << " (" << status << ")";

38 
throw
 
¡d
::
	`ruÁime_”rÜ
(
”r_msg
.
	`¡r
());

39 
	}
}

41 
	gUccProûss
::~
	$UccProûss
()

43 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_de¡roy
(
ùx_h
));

44 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_fš®ize
(
lib_h
));

45 ià(
ùx_·¿ms
.
mask
 & 
UCC_CONTEXT_PARAM_FIELD_MEM_PARAMS
) {

46 autØ
i
 = 0; i < 
UCC_TEST_N_MEM_SEGMENTS
; i++) {

47 
	`ucc_ä“
(
Úesided_buf
[
i
]);

50 
	}
}

52 
ucc_¡©us_t
 
	gUccT—m
::
	$®lg©h”
(*
¤c_buf
, *
»cv_buf
, 
size_t
 
size
,

53 *
cŞl_šfo
, **
»que¡
)

55 
UccT—m
::
®lg©h”_cŞl_šfo_t
 *
ci
 =

56 (
UccT—m
::
®lg©h”_cŞl_šfo_t
 *)
cŞl_šfo
;

57 
my_¿nk
 = 
ci
->my_rank;

58 
ci
->
£lf
->
ag
[
my_¿nk
].
sbuf
 = 
¤c_buf
;

59 
ci
->
£lf
->
ag
[
my_¿nk
].
rbuf
 = 
»cv_buf
;

60 
ci
->
£lf
->
ag
[
my_¿nk
].
Ën
 = 
size
;

61 
ci
->
£lf
->
ag
[
my_¿nk
].
pha£
 = 
UccT—m
::
AG_READY
;

62 *
»que¡
 = (*)
ci
;

63  
UCC_OK
;

64 
	}
}

66 
	gUccT—m
::
	$‹¡_®lg©h”
(
size_t
 
msgËn
)

68 *
sbufs
[
n_´ocs
];

69 *
rbufs
[
n_´ocs
];

70 
size_t
 
couÁ
 = 
msgËn
/();

71 
¡d
::
veùÜ
<
®lg©h”_cŞl_šfo_t
> 
cis
;

72 
¡d
::
veùÜ
<*> 
»qs
;

73 
i
=0; i<
n_´ocs
; i++) {

74 
sbufs
[
i
] = 
Ãw
 [
couÁ
];

75 
rbufs
[
i
] = 
Ãw
 [
couÁ
*
n_´ocs
];

76 
	`mem£t
(
rbufs
[
i
], 0, 
couÁ
*
n_´ocs
);

77 
j
=0; j<
couÁ
; j++) {

78 
sbufs
[
i
][
j
] = i*
couÁ
 + j;

80 
cis
.
	`push_back
(
	`®lg©h”_cŞl_šfo_t
());

81 
cis
.
	`back
().
£lf
 = 
this
;

82 
cis
.
	`back
().
my_¿nk
 = 
i
;

84 
i
=0; i<
n_´ocs
; i++) {

85 *
»q
;

86 
	`®lg©h”
(
sbufs
[
i
], 
rbufs
[i], 
msgËn
, (*)&
cis
[i], &
»q
);

87 
»qs
.
	`push_back
(
»q
);

89 
®l_dÚe
 = 0;

90 !
®l_dÚe
) {

91 
®l_dÚe
 = 1;

92 
i
=0; i<
n_´ocs
; i++) {

93 ià(!
»qs
[
i
]) ;

94 ià(
UCC_OK
 !ğ
	`»q_‹¡
(
»qs
[
i
])) {

95 
®l_dÚe
 = 0;

97 
	`»q_ä“
(
»qs
[
i
]);

98 
»qs
[
i
] = 
NULL
;

102 
cÜ»ù
 = 1;

103 
k
=0; k<
n_´ocs
; k++) {

104 
i
=0; i<
n_´ocs
; i++) {

105 
j
=0; j<
couÁ
; j++) {

106 ià(
rbufs
[
k
][
i
*
couÁ
+
j
] != i*count + j) {

107 
cÜ»ù
 = 0;

112 
	`EXPECT_EQ
(1, 
cÜ»ù
);

113 
	}
}

115 
ucc_¡©us_t
 
	gUccT—m
::
	$»q_‹¡
(*
»que¡
)

117 
UccT—m
::
®lg©h”_cŞl_šfo_t
 *
ci
 =

118 (
UccT—m
::
®lg©h”_cŞl_šfo_t
 *)
»que¡
;

119 
n_´ocs
 = 
ci
->
£lf
->n_procs;

120 
ci
->
£lf
->
ag
[ci->
my_¿nk
].
pha£
) {

121 
UccT—m
::
AG_READY
:

122 
i
 = 0; i < 
n_´ocs
; i++) {

123 ià((
ci
->
£lf
->
ag
[
i
].
pha£
 =ğ
UccT—m
::
AG_INIT
) ||

124 (
ci
->
£lf
->
ag
[
i
].
pha£
 =ğ
UccT—m
::
AG_COMPLETE
)) {

125  
UCC_INPROGRESS
;

128 
i
 = 0; i < 
n_´ocs
; i++) {

129 
	`memıy
((*)((
±rdiff_t
)
ci
->
£lf
->
ag
[ci->
my_¿nk
].
rbuf
 +

130 
i
 * 
ci
->
£lf
->
ag
[i].
Ën
),

131 
ci
->
£lf
->
ag
[
i
].
sbuf
, ci->£lf->ag[i].
Ën
);

133 
ci
->
£lf
->
ag
[ci->
my_¿nk
].
pha£
 = 
UccT—m
::
AG_COPY_DONE
;

135 
ci
->
£lf
->
cİy_com¶‘e_couÁ
++;

137 
UccT—m
::
AG_COPY_DONE
:

138 ià(
ci
->
my_¿nk
 =ğ0 && ci->
£lf
->
cİy_com¶‘e_couÁ
 =ğ
n_´ocs
) {

139 
i
 = 0; i < 
n_´ocs
; i++) {

140 
ci
->
£lf
->
ag
[
i
].
pha£
 = 
UccT—m
::
AG_COMPLETE
;

142 
ci
->
£lf
->
cİy_com¶‘e_couÁ
 = 0;

145 
UccT—m
::
AG_COMPLETE
:

146  
UCC_OK
;

150  
UCC_INPROGRESS
;

151 
	}
}

153 
ucc_¡©us_t
 
	gUccT—m
::
	$»q_ä“
(*
»que¡
)

155 
UccT—m
::
®lg©h”_cŞl_šfo_t
 *
ci
 =

156 (
UccT—m
::
®lg©h”_cŞl_šfo_t
 *)
»que¡
;

157 
ci
->
£lf
->
ag
[ci->
my_¿nk
].
pha£
 = 
UccT—m
::
AG_INIT
;

158  
UCC_OK
;

159 
	}
}

161 
ušt64_t
 
	$¿nk_m­_cb
(
ušt64_t
 
•
, *
cb_ùx
) {

162 
UccT—m
 *
‹am
 = (UccT—m*)
cb_ùx
;

163  (
ušt64_t
)
‹am
->
´ocs
[()
•
].
p
.
	`g‘
()->
job_¿nk
;

164 
	}
}

166 
	gUccT—m
::
	$š™_‹am
(
boŞ
 
u£_‹am_•_m­
, boŞ 
u£_•_¿nge
,

167 
boŞ
 
is_Úesided
)

169 
ucc_‹am_·¿ms_t
 
‹am_·¿ms
;

170 
¡d
::
veùÜ
<
®lg©h”_cŞl_šfo_t
 *> 
cis
;

171 
ucc_¡©us_t
 
¡©us
;

172 
i
 = 0; i < 
n_´ocs
; i++) {

173 
cis
.
	`push_back
(
Ãw
 
®lg©h”_cŞl_šfo
);

174 
cis
.
	`back
()->
£lf
 = 
this
;

175 
cis
.
	`back
()->
my_¿nk
 = 
i
;

176 ià(
u£_•_¿nge
) {

177 
‹am_·¿ms
.
•
 = 
i
;

178 
‹am_·¿ms
.
•_¿nge
 = 
UCC_COLLECTIVE_EP_RANGE_CONTIG
;

179 
‹am_·¿ms
.
mask
 = 
UCC_TEAM_PARAM_FIELD_EP
 |

180 
UCC_TEAM_PARAM_FIELD_EP_RANGE
;

182 
‹am_·¿ms
.
mask
 = 0;

184 ià(
u£_‹am_•_m­
) {

185 
‹am_·¿ms
.
mask
 |ğ
UCC_TEAM_PARAM_FIELD_EP_MAP
;

186 
‹am_·¿ms
.
•_m­
.
ty³
 = 
UCC_EP_MAP_CB
;

187 
‹am_·¿ms
.
•_m­
.
•_num
 = 
n_´ocs
;

188 
‹am_·¿ms
.
•_m­
.
cb
.cb = 
¿nk_m­_cb
;

189 
‹am_·¿ms
.
•_m­
.
cb
.
cb_ùx
 = (*)
this
;

191 
‹am_·¿ms
.
oob
.
®lg©h”
 =‡llgather;

192 
‹am_·¿ms
.
oob
.
»q_‹¡
 =„eq_test;

193 
‹am_·¿ms
.
oob
.
»q_ä“
 =„eq_free;

194 
‹am_·¿ms
.
oob
.
cŞl_šfo
 = (*)
cis
.
	`back
();

195 
‹am_·¿ms
.
oob
.
n_oob_•s
 = 
n_´ocs
;

196 
‹am_·¿ms
.
oob
.
oob_•
 = 
i
;

197 
‹am_·¿ms
.
mask
 |ğ
UCC_TEAM_PARAM_FIELD_OOB
;

199 ià(
is_Úesided
) {

200 
‹am_·¿ms
.
mask
 |ğ
UCC_TEAM_PARAM_FIELD_FLAGS
;

201 
‹am_·¿ms
.
æags
 = 
UCC_TEAM_FLAG_COLL_WORK_BUFFER
;

203 
	`EXPECT_EQ
(
UCC_OK
,

204 
	`ucc_‹am_ü—‹_po¡
(&(
´ocs
[
i
].
p
.
	`g‘
()->
ùx_h
), 1, &
‹am_·¿ms
,

205 &(
´ocs
[
i
].
‹am
)));

208 
®l_dÚe
 = 0;

209 !
®l_dÚe
) {

210 
®l_dÚe
 = 1;

211 
i
 = 0; i < 
n_´ocs
; i++) {

212 
	`ucc_cÚ‹xt_´og»ss
(
´ocs
[
i
].
p
.
	`g‘
()->
ùx_h
);

213 
¡©us
 = 
	`ucc_‹am_ü—‹_‹¡
(
´ocs
[
i
].
‹am
);

214 
	`ASSERT_GE
(
¡©us
, 0);

215 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

216 
®l_dÚe
 = 0;

220 autØ
c
 : 
cis
) {

221 
d–‘e
 
c
;

223 
	}
}

225 
	gUccT—m
::
	$de¡roy_‹am
()

227 
ucc_¡©us_t
 
¡©us
;

228 
boŞ
 
®l_dÚe
;

230 
®l_dÚe
 = 
Œue
;

231 autØ&
p
 : 
´ocs
) {

232 ià(
p
.
‹am
) {

233 
¡©us
 = 
	`ucc_‹am_de¡roy
(
p
.
‹am
);

234 ià(
UCC_OK
 =ğ
¡©us
) {

235 
p
.
‹am
 = 
NULL
;

236 } ià(
¡©us
 < 0) {

239 
®l_dÚe
 = 
çl£
;

243 } !
®l_dÚe
);

244 
	}
}

246 
	gUccT—m
::
	$´og»ss
()

248 autØ&
p
 : 
´ocs
) {

249 
	`ucc_cÚ‹xt_´og»ss
(
p
.p->
ùx_h
);

251 
	}
}

253 
	gUccT—m
::
UccT—m
(
¡d
::
veùÜ
<
UccProûss_h
> &
_´ocs
, 
boŞ
 
u£_‹am_•_m­
,

254 
boŞ
 
u£_•_¿nge
, boŞ 
is_Úesided
)

256 
	gn_´ocs
 = 
_´ocs
.
size
();

257 
	gag
.
»size
(
n_´ocs
);

258 autØ&
	gp
 : 
_´ocs
) {

259 
´ocs
.
push_back
(
´oc
(
p
));

261 autØ&
	ga
 : 
ag
) {

262 
a
.
pha£
 = 
AG_INIT
;

264 
	gcİy_com¶‘e_couÁ
 = 0;

265 
š™_‹am
(
u£_‹am_•_m­
, 
u£_•_¿nge
, 
is_Úesided
);

269 
	gUccT—m
::~
	$UccT—m
()

271 
	`de¡roy_‹am
();

272 
	}
}

274 
	gUccJob
::
	$UccJob
(
_n_´ocs
, 
ucc_job_ùx_mode_t
 
_ùx_mode
, 
ucc_job_’v_t
 
v¬s
) :

275 
	`
(
_n_´ocs
), 
	`n_´ocs
(_n_´ocs), 
	$ùx_mode
(
_ùx_mode
)

278 
ucc_job_’v_t
 
’v_bkp
;

279 *
v¬
;

283 
v¬s
.
	`push_back
({"UCC_TL_NCCL_TUNE", "0"});

284 
v¬s
.
	`push_back
({"UCC_TL_RCCL_TUNE", "0"});

286 
v¬s
.
	`push_back
({"UCC_TL_CUDA_TUNE", "0"});

289 
v¬s
.
	`push_back
({"UCX_IB_GPU_DIRECT_RDMA", "no"});

291 autØ&
v
 : 
v¬s
) {

292 
v¬
 = 
¡d
::
	`g‘’v
(
v
.
fœ¡
.
	`c_¡r
());

293 ià(
v¬
) {

296 
’v_bkp
.
	`push_back
(
	`ucc_’v_v¬_t
(
v
.
fœ¡
, 
v¬
));

298 
	`£‹nv
(
v
.
fœ¡
.
	`c_¡r
(), v.
£cÚd
.c_str(), 1);

300 
i
 = 0; i < 
n_´ocs
; i++) {

301 
´ocs
.
	`push_back
(
¡d
::
make_sh¬ed
<
UccProûss
>(
i
));

304 
	`ü—‹_cÚ‹xt
();

305 autØ&
v
 : 
’v_bkp
) {

307 
	`£‹nv
(
v
.
fœ¡
.
	`c_¡r
(), v.
£cÚd
.c_str(), 1);

309 
	}
}

311 
	$th»ad_®lg©h”
(*
¤c_buf
, *
»cv_buf
, 
size_t
 
size
,

312 
Th»adAÎg©h”Req
 *
_»q
)

314 
Th»adAÎg©h”
 *

 = 
_»q
->ta;

315 

->
»ady_couÁ
 >a->
n_´ocs
) {

316 
¡d
::
this_th»ad
::
	`y›ld
();

318 

->
lock
.
	`lock
();

319 ià(!

->
bufãr
) {

320 
	`ucc_as£¹
(0 =ğ

->
»ady_couÁ
);

321 

->
bufãr
 = 
	`m®loc
(
size
 *a->
n_´ocs
);

322 

->
»ady_couÁ
 = 0;

324 
	`memıy
((*)((
±rdiff_t
)

->
bufãr
 + 
size
 * 
_»q
->
¿nk
),

325 
¤c_buf
, 
size
);

326 

->
»ady_couÁ
++;

327 

->
lock
.
	`uÆock
();

328 

->
»ady_couÁ
 <a->
n_´ocs
) {

329 
¡d
::
this_th»ad
::
	`y›ld
();

331 
	`memıy
(
»cv_buf
, 

->
bufãr
, 
size
 *a->
n_´ocs
);

333 

->
lock
.
	`lock
();

334 

->
»ady_couÁ
++;

335 ià(

->
»ady_couÁ
 =ğ2 *a->
n_´ocs
) {

336 
	`ä“
(

->
bufãr
);

337 

->
bufãr
 = 
NULL
;

338 

->
»ady_couÁ
 = 0;

340 

->
lock
.
	`uÆock
();

341 
_»q
->
¡©us
 = 
UCC_OK
;

342 
	}
}

344 
ucc_¡©us_t
 
	$th»ad_®lg©h”_¡¬t
(*
¤c_buf
, *
»cv_buf
, 
size_t
 
size
,

345 *
cŞl_šfo
, **
»que¡
)

347 
Th»adAÎg©h”Req
 *
_»q
 = (Th»adAÎg©h”Req*)
cŞl_šfo
;

348 *
»que¡
 = 
cŞl_šfo
;

349 
_»q
->
¡©us
 !ğ
UCC_OPERATION_INITIALIZED
) {

350 
¡d
::
this_th»ad
::
	`y›ld
();

353 
_»q
->
¡©us
 = 
UCC_INPROGRESS
;

354 
_»q
->
t
 = 
¡d
::
	`th»ad
(
th»ad_®lg©h”
, 
¤c_buf
,

355 
»cv_buf
, 
size
, 
_»q
);

356  
UCC_OK
;

357 
	}
}

359 
ucc_¡©us_t
 
	$th»ad_®lg©h”_»q_‹¡
(*
»que¡
)

361 
Th»adAÎg©h”Req
 *
_»q
 = (Th»adAÎg©h”Req*)
»que¡
;

362  
_»q
->
¡©us
;

363 
	}
}

365 
ucc_¡©us_t
 
	$th»ad_®lg©h”_»q_ä“
(*
»que¡
)

367 
Th»adAÎg©h”Req
 *
_»q
 = (Th»adAÎg©h”Req*)
»que¡
;

368 
_»q
->
t
.
	`još
();

369 
_»q
->
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

370  
UCC_OK
;

371 
	}
}

373 
	$´oc_cÚ‹xt_ü—‹
(
UccProûss_h
 
´oc
, 
id
, 
Th»adAÎg©h”
 *

, 
boŞ
 
is_glob®
)

375 cÚ¡ 
Âodes
 = 2;

376 cÚ¡ 
nsock‘s
 = 2;

377 cÚ¡ 
Âumas
 = 3;

378 
ucc_¡©us_t
 
¡©us
;

379 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

380 
¡d
::
¡ršg¡»am
 
”r_msg
;

381 
ucc_´oc_šfo_t
 
´oc_šfo
;

382 
node
, 
loÿl_µn
, 
loÿl_¿nk
, 
job_size
, 
block
;

384 
¡©us
 = 
	`ucc_cÚ‹xt_cÚfig_»ad
(
´oc
->
lib_h
, 
NULL
, &
ùx_cÚfig
);

385 ià(
¡©us
 !ğ
UCC_OK
) {

386 
”r_msg
 << "ucc_context_config_read failed";

387 
ex™_”r
;

389 ià(
is_glob®
) {

390 
´oc
->
ùx_·¿ms
.
mask
 |ğ
UCC_CONTEXT_PARAM_FIELD_OOB
;

391 
´oc
->
ùx_·¿ms
.
oob
.
®lg©h”
 = 
th»ad_®lg©h”_¡¬t
;

392 
´oc
->
ùx_·¿ms
.
oob
.
»q_‹¡
 = 
th»ad_®lg©h”_»q_‹¡
;

393 
´oc
->
ùx_·¿ms
.
oob
.
»q_ä“
 = 
th»ad_®lg©h”_»q_ä“
;

394 
´oc
->
ùx_·¿ms
.
oob
.
cŞl_šfo
 = (*è&

->
»qs
[
id
];

395 
´oc
->
ùx_·¿ms
.
oob
.
n_oob_•s
 = 

->
n_´ocs
;

396 
´oc
->
ùx_·¿ms
.
oob
.
oob_•
 = 
id
;

400 
job_size
 = 

->
n_´ocs
;

401 
block
 = 
	`ucc_bufãr_block_couÁ
(
job_size
, 
Âodes
, 0);

402 
node
 = 
id
 / 
block
;

403 
loÿl_µn
 = 
	`ucc_bufãr_block_couÁ
(
job_size
, 
Âodes
, 
node
);

404 
loÿl_¿nk
 = 
id
 - 
	`ucc_bufãr_block_off£t
(
job_size
, 
Âodes
, 
node
);

406 
´oc_šfo
.
ho¡_hash
 = 
node
 + 1;

407 
block
 = 
	`ucc_bufãr_block_couÁ
(
loÿl_µn
, 
nsock‘s
, 0);

408 
´oc_šfo
.
sock‘_id
 = 
loÿl_¿nk
 / 
block
;

410 
block
 = 
	`ucc_bufãr_block_couÁ
(
loÿl_µn
, 
Âumas
, 0);

411 
´oc_šfo
.
numa_id
 = 
loÿl_¿nk
 / 
block
;

413 
´oc_šfo
.
pid
 = 
id
 + 1;

415 
´oc_šfo
 = 
ucc_loÿl_´oc
;

417 
¡©us
 = 
	`ucc_cÚ‹xt_ü—‹_´oc_šfo
(
´oc
->
lib_h
, &´oc->
ùx_·¿ms
, 
ùx_cÚfig
, &´oc->
ùx_h
, &
´oc_šfo
);

418 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

419 ià(
¡©us
 !ğ
UCC_OK
) {

420 
”r_msg
 << "ucc_context_create failed";

421 
ex™_”r
;

425 
ex™_”r
:

426 
”r_msg
 << ": "<< 
	`ucc_¡©us_¡ršg
(
¡©us
) << " (" << status << ")";

427 
throw
 
¡d
::
	`ruÁime_”rÜ
(
”r_msg
.
	`¡r
());

428 
	}
}

430 
	$´oc_cÚ‹xt_ü—‹_mem_·¿ms
(
UccProûss_h
 
´oc
, 
id
,

431 
Th»adAÎg©h”
 *

)

433 
ucc_¡©us_t
 
¡©us
;

434 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

435 
¡d
::
¡ršg¡»am
 
”r_msg
;

436 
ucc_mem_m­_t
 
m­
[
UCC_TEST_N_MEM_SEGMENTS
];

438 
¡©us
 = 
	`ucc_cÚ‹xt_cÚfig_»ad
(
´oc
->
lib_h
, 
NULL
, &
ùx_cÚfig
);

439 ià(
¡©us
 !ğ
UCC_OK
) {

440 
”r_msg
 << "ucc_context_config_read failed";

441 
ex™_”r
;

443 autØ
i
 = 0; i < 
UCC_TEST_N_MEM_SEGMENTS
; i++) {

444 
´oc
->
Úesided_buf
[
i
] =

445 
	`ucc_ÿÎoc
(
UCC_TEST_MEM_SEGMENT_SIZE
, 1, "onesided_buffer");

446 
	`EXPECT_NE
(
´oc
->
Úesided_buf
[
i
], 
nuÎ±r
);

447 
m­
[
i
].
add»ss
 = 
´oc
->
Úesided_buf
[i];

448 
m­
[
i
].
Ën
 = 
UCC_TEST_MEM_SEGMENT_SIZE
;

450 
´oc
->
ùx_·¿ms
.
mask
 = 
UCC_CONTEXT_PARAM_FIELD_OOB
;

451 
´oc
->
ùx_·¿ms
.
mask
 |ğ
UCC_CONTEXT_PARAM_FIELD_MEM_PARAMS
;

452 
´oc
->
ùx_·¿ms
.
oob
.
®lg©h”
 = 
th»ad_®lg©h”_¡¬t
;

453 
´oc
->
ùx_·¿ms
.
oob
.
»q_‹¡
 = 
th»ad_®lg©h”_»q_‹¡
;

454 
´oc
->
ùx_·¿ms
.
oob
.
»q_ä“
 = 
th»ad_®lg©h”_»q_ä“
;

455 
´oc
->
ùx_·¿ms
.
oob
.
cŞl_šfo
 = (*)&

->
»qs
[
id
];

456 
´oc
->
ùx_·¿ms
.
oob
.
n_oob_•s
 = 

->
n_´ocs
;

457 
´oc
->
ùx_·¿ms
.
oob
.
oob_•
 = 
id
;

458 
´oc
->
ùx_·¿ms
.
mem_·¿ms
.
£gm’ts
 = 
m­
;

459 
´oc
->
ùx_·¿ms
.
mem_·¿ms
.
n_£gm’ts
 = 
UCC_TEST_N_MEM_SEGMENTS
;

460 
¡©us
 = 
	`ucc_cÚ‹xt_ü—‹
(
´oc
->
lib_h
, &´oc->
ùx_·¿ms
, 
ùx_cÚfig
,

461 &
´oc
->
ùx_h
);

462 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

463 ià(
¡©us
 !ğ
UCC_OK
) {

464 
”r_msg
 << "ucc_context_create for one-sided context failed";

465 
ex™_”r
;

469 
ex™_”r
:

470 
”r_msg
 << ": " << 
	`ucc_¡©us_¡ršg
(
¡©us
) << " (" << status << ")";

471 
throw
 
¡d
::
	`ruÁime_”rÜ
(
”r_msg
.
	`¡r
());

472 
	}
}

474 
	gUccJob
::
	$ü—‹_cÚ‹xt
()

476 
¡d
::
veùÜ
<¡d::
th»ad
> 
wÜk”s
;

477 autØ
i
 = 0; i < 
´ocs
.
	`size
(); i++) {

478 ià(
ùx_mode
 =ğ
UCC_JOB_CTX_GLOBAL_ONESIDED
) {

479 
wÜk”s
.
	`push_back
(

480 
¡d
::
	`th»ad
(
´oc_cÚ‹xt_ü—‹_mem_·¿ms
, 
´ocs
[
i
], i, &

));

482 
wÜk”s
.
	`push_back
(
¡d
::
	`th»ad
(
´oc_cÚ‹xt_ü—‹
, 
´ocs
[
i
], i, &

,

483 
ùx_mode
 =ğ
UCC_JOB_CTX_GLOBAL
));

486 autØ
i
 = 0; i < 
´ocs
.
	`size
(); i++) {

487 
wÜk”s
[
i
].
	`još
();

489 
	}
}

491 
th»ad_´oc_de¡ruù
(
¡d
::
veùÜ
<
UccProûss_h
> *
´ocs
, 
i
)

493 
ucc_as£¹
(
Œue
 =ğ(*
´ocs
)[
i
].
unique
());

494 (*
	g´ocs
)[
i
] = 
NULL
;

497 
	gUccJob
::~
	$UccJob
()

499 
¡d
::
veùÜ
<¡d::
th»ad
> 
wÜk”s
;

501 ià(
this
 =ğ
UccJob
::
¡©icUccJob
) {

502 
¡©icT—ms
.
	`ş—r
();

504 
i
 = 0; i < 
n_´ocs
; i++) {

505 
wÜk”s
.
	`push_back
(
¡d
::
	`th»ad
(
th»ad_´oc_de¡ruù
, &
´ocs
, 
i
));

507 
i
 = 0; i < 
n_´ocs
; i++) {

508 
wÜk”s
[
i
].
	`još
();

510 
	}
}

512 
UccJob
* 
	gUccJob
::
¡©icUccJob
 = 
NULL
;

514 
UccJob
* 
	gUccJob
::
	$g‘SticJob
()

516 ià(!
¡©icUccJob
) {

517 
¡©icUccJob
 = 
Ãw
 
	`UccJob
(
UccJob
::
¡©icUccJobSize
);

519  
¡©icUccJob
;

520 
	}
}

522 
	g¡d
::
veùÜ
<
UccT—m_h
> 
UccJob
::
¡©icT—ms
;

524 cÚ¡ 
	g¡d
::
veùÜ
<
UccT—m_h
> &
UccJob
::
	$g‘SticT—ms
()

526 
¡d
::
veùÜ
<> 
	`‹amSizes
(¡d::
	`begš
(
¡©icT—mSizes
),

527 
¡d
::
	`’d
(
¡©icT—mSizes
));

528 ià(0 =ğ
¡©icT—ms
.
	`size
()) {

529 autØ
ts
 : 
‹amSizes
) {

530 ià(
ts
 =ğ1 && !
	`_£lf_avaabË
()) {

534 
ts
 = 3;

536 
¡©icT—ms
.
	`push_back
(
	`g‘SticJob
()->
	`ü—‹_‹am
(
ts
));

539 
¡d
::
veùÜ
<> 
¿nks
;

540 autØ
r
 = 
¡©icUccJobSize
 - 1;„ >= 0;„--) {

541 
¿nks
.
	`push_back
(
r
);

543 
¡©icT—ms
.
	`push_back
(
	`g‘SticJob
()->
	`ü—‹_‹am
(
¿nks
, 
Œue
));

546  
¡©icT—ms
;

547 
	}
}

549 
	gUccJob
::
	$ş—nup
()

551 ià(
¡©icUccJob
) {

552 
d–‘e
 
¡©icUccJob
;

554 
	}
}

556 
UccT—m_h
 
	gUccJob
::
	$ü—‹_‹am
(
_n_´ocs
, 
boŞ
 
u£_‹am_•_m­
,

557 
boŞ
 
u£_•_¿nge
, boŞ 
is_Úesided
)

559 
	`EXPECT_GE
(
n_´ocs
, 
_n_´ocs
);

560 
¡d
::
veùÜ
<
UccProûss_h
> 
‹am_´ocs
;

561 
i
 = 0; i < 
_n_´ocs
; i++) {

562 
‹am_´ocs
.
	`push_back
(
´ocs
[
i
]);

564  
¡d
::
make_sh¬ed
<
UccT—m
>(
‹am_´ocs
, 
u£_‹am_•_m­
, 
u£_•_¿nge
,

565 
is_Úesided
);

566 
	}
}

568 
UccT—m_h
 
	gUccJob
::
ü—‹_‹am
(
¡d
::
veùÜ
<> &
¿nks
, 
boŞ
 
u£_‹am_•_m­
,

569 
boŞ
 
u£_•_¿nge
, boŞ 
is_Úesided
)

571 
EXPECT_GE
(
n_´ocs
, 
¿nks
.
size
());

572 
	g¡d
::
veùÜ
<
UccProûss_h
> 
‹am_´ocs
;

573 
	gi
 = 0; i < 
	g¿nks
.
size
(); i++) {

574 
	g‹am_´ocs
.
push_back
(
´ocs
[
¿nks
[
i
]]);

576  
	g¡d
::
make_sh¬ed
<
UccT—m
>(
‹am_´ocs
, 
	gu£_‹am_•_m­
, 
	gu£_•_¿nge
,

577 
	gis_Úesided
);

580 
	gUccReq
::
	$UccReq
(
UccT—m_h
 
_‹am
, 
ucc_cŞl_¬gs_t
 *
¬gs
) :

581 
	$‹am
(
_‹am
)

583 
ucc_cŞl_»q_h
 
»q
;

584 autØ&
p
 : 
‹am
->
´ocs
) {

585 ià(
UCC_OK
 !ğ
	`ucc_cŞËùive_š™
(
¬gs
, &
»q
, 
p
.
‹am
)) {

586 
”r
;

588 
»qs
.
	`push_back
(
»q
);

591 
”r
:

592 
»qs
.
	`ş—r
();

593 
	}
}

595 
	gUccReq
::
	$UccReq
(
UccT—m_h
 
_‹am
, 
UccCŞlCtxVec
 
ùxs
) :

596 
	$‹am
(
_‹am
)

598 
¡d
::
veùÜ
<
ucc_¡©us_t
> 
”r_¡
;

599 
ucc_cŞl_»q_h
 
»q
;

600 
ucc_¡©us_t
 
¡
;

602 
	`EXPECT_EQ
(
‹am
->
´ocs
.
	`size
(), 
ùxs
.size());

604 
¡©us
 = 
UCC_OK
;

605 autØ
i
 = 0; i < 
‹am
->
´ocs
.
	`size
(); i++) {

606 ià(!
ùxs
[
i
]) {

609 ià(
UCC_OK
 !=(
¡
 = 
	`ucc_cŞËùive_š™
(
ùxs
[
i
]->
¬gs
, &
»q
,

610 
‹am
->
´ocs
[
i
].team))) {

611 
”r_¡
.
	`push_back
(
¡
);

613 
»qs
.
	`push_back
(
»q
);

616 ià(
”r_¡
.
	`size
() > 0) {

621 ià(!
¡d
::
	`equ®
(
”r_¡
.
	`begš
(è+ 1,ƒ¼_¡.
	`’d
(),ƒrr_st.begin()) ||

622 
”r_¡
.
	`size
(è!ğ
‹am
->
´ocs
.size() ||

623 
”r_¡
[0] !ğ
UCC_ERR_NOT_SUPPORTED
) {

624 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

626 
	`ucc_as£¹
(
”r_¡
[0] = 
UCC_ERR_NOT_SUPPORTED
);

627 
¡©us
 = 
”r_¡
[0];

630 
	}
}

632 
	gUccReq
::~
	$UccReq
()

634 autØ
r
 : 
»qs
) {

635 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞËùive_fš®ize
(
r
));

637 
	}
}

639 
	gUccReq
::
	$¡¬t
()

641 
ucc_¡©us_t
 
¡
;

643 autØ
r
 : 
»qs
) {

644 
¡
 = 
	`ucc_cŞËùive_po¡
(
r
);

645 
	`ASSERT_EQ
(
UCC_OK
, 
¡
);

646 
¡
 = 
	`ucc_cŞËùive_‹¡
(
r
);

647 
	`ASSERT_NE
(
UCC_OPERATION_INITIALIZED
, 
¡
);

649 
	}
}

651 
ucc_¡©us_t
 
	gUccReq
::
	$‹¡
()

653 
ucc_¡©us_t
 
¡
 = 
UCC_OK
;

654 autØ
r
 : 
»qs
) {

655 
¡
 = 
	`ucc_cŞËùive_‹¡
(
r
);

656 ià(
UCC_OK
 !ğ
¡
) {

660  
¡
;

661 
	}
}

663 
ucc_¡©us_t
 
	gUccReq
::
	$wa™
()

665 
ucc_¡©us_t
 
¡
;

666 
UCC_OK
 !ğ(
¡
 = 
	`‹¡
())) {

667 ià(
¡
 < 0) {

670 
‹am
->
	`´og»ss
();

672  
¡
;

673 
	}
}

675 
	gUccReq
::
wa™®l
(
¡d
::
veùÜ
<
UccReq
> &
»qs
)

677 
boŞ
 
®ldÚe
 = 
çl£
;

678 
ucc_¡©us_t
 
	g¡©us
;

679 !
	g®ldÚe
) {

680 
	g®ldÚe
 = 
Œue
;

681 autØ&
	gr
 : 
»qs
) {

682 ià(
UCC_OK
 !ğ(
¡©us
 = 
r
.
‹¡
())) {

683 ià(
¡©us
 < 0) {

686 
	g®ldÚe
 = 
çl£
;

687 
	gr
.
	g‹am
->
´og»ss
();

693 
	gUccReq
::
¡¬Î
(
¡d
::
veùÜ
<
UccReq
> &
»qs
)

695 autØ&
r
 : 
»qs
) {

696 
r
.
¡¬t
();

700 
	gUccCŞlArgs
::
	$£t_mem_ty³
(
ucc_memÜy_ty³_t
 
_mt
)

702 
mem_ty³
 = 
_mt
;

703 
	}
}

705 
	gUccCŞlArgs
::
	$£t_š¶aû
(
g‹¡_ucc_š¶aû_t
 
_š¶aû
)

707 
š¶aû
 = 
_š¶aû
;

708 
	}
}

710 
	gUccCŞlArgs
::
	$£t_cÚtig
(
boŞ
 
_is_cÚtig
)

712 
is_cÚtig
 = 
_is_cÚtig
;

713 
	}
}

715 
	$ş—r_bufãr
(*
_buf
, 
size_t
 
size
, 
ucc_memÜy_ty³_t
 
mt
, 
ušt8_t
 
v®ue
)

717 *
buf
 = 
_buf
;

718 ià(
mt
 !ğ
UCC_MEMORY_TYPE_HOST
) {

719 
buf
 = 
	`ucc_m®loc
(
size
, "buf");

720 
	`ASSERT_NE
(0, (
ušŒ_t
)
buf
);

722 
	`mem£t
(
buf
, 
v®ue
, 
size
);

723 ià(
UCC_MEMORY_TYPE_HOST
 !ğ
mt
) {

724 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
_buf
, 
buf
, 
size
, 
mt
, 
UCC_MEMORY_TYPE_HOST
));

725 
	`ucc_ä“
(
buf
);

727 
	}
}

729 
boŞ
 
	$_£lf_avaabË
()

731 
ucc__cÚ‹xt_t
 *
_ùx
;

732 
ucc_¡©us_t
 
¡©us
;

734 
¡©us
 = 
	`ucc__cÚ‹xt_g‘
(
UccJob
::
	`g‘SticJob
()->
´ocs
[0]->
ùx_h
,

735 "£lf", &
_ùx
);

737 ià(
UCC_OK
 !ğ
¡©us
) {

738  
çl£
;

740 
	`ucc__cÚ‹xt_put
(
_ùx
);

741  
Œue
;

742 
	}
}

	@test/gtest/common/test_ucc.h

6 #iâdeà
TEST_UCC_H


7 
	#TEST_UCC_H


	)

8 
	~"‹¡.h
"

11 
	~"compÚ’ts/mc/ucc_mc.h
"

12 
	~"uts/ucc_m®loc.h
"

13 
	~<ucc/­i/ucc.h
>

14 
	~<cÜe/ucc_glob®_İts.h
>

16 
	~<veùÜ
>

17 
	~<tu¶e
>

18 
	~<memÜy
>

19 
	~<mu‹x
>

20 
	~<th»ad
>

21 
	~<©omic
>

22 
	~<¡ršg
>

25 
ucc_mc_bufãr_h—d”_t
 *
d¡_mc_h—d”
;

26 
ucc_mc_bufãr_h—d”_t
 *
¤c_mc_h—d”
;

27 *
š™_buf
;

28 
size_t
 
rbuf_size
;

29 
ucc_cŞl_¬gs_t
 *
¬gs
;

30 } 
	tg‹¡_ucc_cŞl_ùx_t
;

32 
	g¡d
::
	tveùÜ
<
	tg‹¡_ucc_cŞl_ùx_t
*> 
	tUccCŞlCtxVec
;

35 
	mTEST_NO_INPLACE
,

36 
	mTEST_INPLACE


37 } 
	tg‹¡_ucc_š¶aû_t
;

39 şas 
	cUccCŞlArgs
 {

40 
	m´Ùeùed
:

41 
ucc_memÜy_ty³_t
 
mem_ty³
;

42 
g‹¡_ucc_š¶aû_t
 
	mš¶aû
;

43 
boŞ
 
	mis_cÚtig
;

44 
	$®ÉßÎx_š™_buf
(
¤c_¿nk
, 
d¡_¿nk
, 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

46 
i
 = 0; i < 
Ën
; i++) {

47 
buf
[
i
] = (
ušt8_t
)(((
¤c_¿nk
 + 
Ën
 - i) *

48 (
d¡_¿nk
 + 1)è% 
UINT8_MAX
);

51 
	$®ÉßÎx_v®id©e_buf
(
¤c_¿nk
, 
d¡_¿nk
, 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

53 
”r
 = 0;

54 
i
 = 0; i < 
Ën
; i ++) {

55 
ušt8_t
 
ex³ùed
 = (uint8_t)

56 (((
d¡_¿nk
 + 
Ën
 - 
i
) *

57 (
¤c_¿nk
 + 1)è% 
UINT8_MAX
);

58 ià(
buf
[
i
] !ğ
ex³ùed
) {

59 
”r
++;

62  
”r
;

63 
	}
}

64 
	gpublic
:

65 
	$UccCŞlArgs
() {

67 
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

68 
š¶aû
 = 
TEST_NO_INPLACE
;

69 
	}
}

70 
	gvœtu®
 ~
	$UccCŞlArgs
(è{
	}
}

71 
vœtu®
 
d©a_š™
(
Årocs
, 
ucc_d©©y³_t
 
dty³
,

72 
size_t
 
couÁ
, 
UccCŞlCtxVec
 &
¬gs
,

73 
boŞ
 
³rsi¡’t
 = 
çl£
) = 0;

74 
vœtu®
 
d©a_fši
(
UccCŞlCtxVec
 
¬gs
) = 0;

75 
vœtu®
 
boŞ
 
d©a_v®id©e
(
UccCŞlCtxVec
 
¬gs
) = 0;

76 
£t_mem_ty³
(
ucc_memÜy_ty³_t
 
_mt
);

77 
£t_š¶aû
(
g‹¡_ucc_š¶aû_t
 
_š¶aû
);

78 
£t_cÚtig
(
boŞ
 
_cÚtig
);

81 
	#SET_MEM_TYPE
(
_mt
) do { \

82 ià(
UCC_OK
 !ğ
	`ucc_mc_avaabË
(
_mt
)) { \

83 
	`GTEST_SKIP
(); \

85 
this
->
mem_ty³
 = 
_mt
; \

86 } 0)

	)

88 
şass
 
	gTh»adAÎg©h”
;

89 şas 
	cTh»adAÎg©h”Req
 {

90 
	mpublic
:

91 
Th»adAÎg©h”
 *

;

92 
	m¿nk
;

93 
ucc_¡©us_t
 
	m¡©us
;

94 
	m¡d
::
th»ad
 
t
;

95 
	$Th»adAÎg©h”Req
(
Th»adAÎg©h”
 *
_
, 
_¿nk
) :

96 
	`
(
_
), 
	$¿nk
(
_¿nk
)

98 
¡©us
 = 
UCC_OPERATION_INITIALIZED
;

100 
	}
};

102 şas 
	cTh»adAÎg©h”
 {

103 
	mpublic
:

104 
n_´ocs
;

105 
	m¡d
::
©omic
<> 
»ady_couÁ
;

106 *
	mbufãr
;

107 
	m¡d
::
mu‹x
 
lock
;

108 
	m¡d
::
veùÜ
<
Th»adAÎg©h”Req
> 
»qs
;

109 
	$Th»adAÎg©h”
(
_n_´ocs
è: 
	`n_´ocs
(_n_´ocs), 
	`»ady_couÁ
(0), 
	$bufãr
(
NULL
) {

110 autØ
i
 = 0; i < 
_n_´ocs
; i++) {

111 
»qs
.
	`push_back
(
	`Th»adAÎg©h”Req
(
this
, 
i
));

114 ~
	$Th»adAÎg©h”
() {

115 
bufãr
 = 
NULL
;

116 
»ady_couÁ
 = 0;

117 
	}
}

123 şas 
	cUccProûss
 {

124 
	mpublic
:

125 
ucc_cÚ‹xt_·¿ms_t
 
ùx_·¿ms
;

126 
cÚ¡ex´
 
ucc_lib_·¿ms_t
 
	mdeçuÉ_lib_·¿ms
 = {

127 .
mask
 =

128 
UCC_LIB_PARAM_FIELD_THREAD_MODE
 | 
UCC_LIB_PARAM_FIELD_COLL_TYPES
,

129 .
	mth»ad_mode
 = 
UCC_THREAD_SINGLE
,

130 .
	mcŞl_ty³s
 = 
UCC_COLL_TYPE_BARRIER
 | 
UCC_COLL_TYPE_ALLTOALL
 |

131 
UCC_COLL_TYPE_ALLTOALLV
 | 
UCC_COLL_TYPE_ALLREDUCE
 |

132 
UCC_COLL_TYPE_ALLGATHER
 | 
UCC_COLL_TYPE_ALLGATHERV
 |

133 
UCC_COLL_TYPE_REDUCE
 | 
UCC_COLL_TYPE_BCAST
 |

134 
UCC_COLL_TYPE_GATHER
 | 
UCC_COLL_TYPE_SCATTER
};

135 
cÚ¡ex´
 
ucc_cÚ‹xt_·¿ms_t
 
	gdeçuÉ_ùx_·¿ms
 = {

136 .
mask
 = 
UCC_CONTEXT_PARAM_FIELD_TYPE
,

137 .
	gty³
 = 
UCC_CONTEXT_EXCLUSIVE


139 
ucc_lib_h
 
	glib_h
;

140 
ucc_cÚ‹xt_h
 
	gùx_h
;

141 * 
	gÚesided_buf
[3];

142 
	gjob_¿nk
;

143 
UccProûss
(
_job_¿nk
,

144 cÚ¡ 
ucc_lib_·¿ms_t
 &
Í
 = 
deçuÉ_lib_·¿ms
,

145 cÚ¡ 
ucc_cÚ‹xt_·¿ms_t
 &
ı
 = 
deçuÉ_ùx_·¿ms
);

146 ~
UccProûss
();

148 
	g¡d
::
	tsh¬ed_±r
<
	tUccProûss
> 
	tUccProûss_h
;

152 şas 
	cUccT—m
 {

153 
	s´oc
 {

154 
UccProûss_h
 
	mp
;

155 
ucc_‹am_h
 
	m‹am
;

156 
´oc
(){};

157 
´oc
(
UccProûss_h
 
_p
è: 
p
(_p) {};

160 
	gAG_INIT
,

161 
	gAG_READY
,

162 
	gAG_COPY_DONE
,

163 
	gAG_COMPLETE


164 } 
	t®lg©h”_pha£_t
;

165 
	s®lg©h”_d©a
 {

166 *
	gsbuf
;

167 *
	grbuf
;

168 
size_t
 
	gËn
;

169 
®lg©h”_pha£_t
 
	gpha£
;

171 
	s®lg©h”_cŞl_šfo
 {

172 
	gmy_¿nk
;

173 
UccT—m
 *
	g£lf
;

174 } 
	t®lg©h”_cŞl_šfo_t
;

175 
	g¡d
::
veùÜ
<
®lg©h”_d©a
> 
ag
;

176 
š™_‹am
(
boŞ
 
u£_‹am_•_m­
, boŞ 
u£_•_¿nge
, boŞ 
is_Úesided
);

177 
de¡roy_‹am
();

178 
‹¡_®lg©h”
(
size_t
 
msgËn
);

179 
ucc_¡©us_t
 
®lg©h”
(*
¤c_buf
, *
»cv_buf
, 
size_t
 
size
,

180 *
cŞl_šfo
, **
»que¡
);

181 
ucc_¡©us_t
 
»q_‹¡
(*
»que¡
);

182 
ucc_¡©us_t
 
»q_ä“
(*
»que¡
);

183 
	gcİy_com¶‘e_couÁ
;

184 
	gpublic
:

185 
n_´ocs
;

186 
´og»ss
();

187 
	g¡d
::
veùÜ
<
´oc
> 
´ocs
;

188 
UccT—m
(
¡d
::
veùÜ
<
UccProûss_h
> &
_´ocs
, 
boŞ
 
u£_‹am_•_m­
 = 
çl£
,

189 
boŞ
 
u£_•_¿nge
 = 
Œue
, boŞ 
is_Úesided
 = 
çl£
);

190 ~
UccT—m
();

192 
	g¡d
::
	tsh¬ed_±r
<
	tUccT—m
> 
	tUccT—m_h
;

193 
	g¡d
::
	t·œ
<
	t¡d
::
	t¡ršg
, std::¡ršg> 
	tucc_’v_v¬_t
;

194 
	g¡d
::
	tveùÜ
<
	tucc_’v_v¬_t
> 
	tucc_job_’v_t
;

197 şas 
	cUccJob
 {

198 
UccJob
* 
	m¡©icUccJob
;

199 
	m¡d
::
veùÜ
<
UccT—m_h
> 
¡©icT—ms
;

200 
Th»adAÎg©h”
 
	m
;

201 
	mpublic
:

203 
UCC_JOB_CTX_LOCAL
,

204 
	mUCC_JOB_CTX_GLOBAL
,

205 
	mUCC_JOB_CTX_GLOBAL_ONESIDED


206 } 
	tucc_job_ùx_mode_t
;

207 cÚ¡ 
	gnSticT—ms
 = 5;

208 cÚ¡ 
	g¡©icUccJobSize
 = 16;

209 
cÚ¡ex´
 
	g¡©icT—mSizes
[
nSticT—ms
] = {1, 2, 8, 11, 
¡©icUccJobSize
};

210 
ş—nup
();

211 
UccJob
* 
g‘SticJob
();

212 cÚ¡ 
	g¡d
::
veùÜ
<
UccT—m_h
> &
g‘SticT—ms
();

213 
	gn_´ocs
;

214 
UccJob
(
_n_´ocs
 = 2, 
ucc_job_ùx_mode_t
 
_ùx_mode
 = 
UCC_JOB_CTX_GLOBAL
,

215 
ucc_job_’v_t
 
v¬s
 = ucc_job_env_t());

216 ~
UccJob
();

217 
	g¡d
::
veùÜ
<
UccProûss_h
> 
´ocs
;

218 
UccT—m_h
 
ü—‹_‹am
(
n_´ocs
, 
boŞ
 
u£_‹am_•_m­
 = 
çl£
,

219 
boŞ
 
u£_•_¿nge
 = 
Œue
, boŞ 
is_Úesided
 = 
çl£
);

220 
UccT—m_h
 
ü—‹_‹am
(
¡d
::
veùÜ
<> &
¿nks
, 
boŞ
 
u£_‹am_•_m­
 = 
çl£
,

221 
boŞ
 
u£_•_¿nge
 = 
Œue
, boŞ 
is_Úesided
 = 
çl£
);

222 
ü—‹_cÚ‹xt
();

223 
ucc_job_ùx_mode_t
 
	gùx_mode
;

226 şas 
	cUccReq
 {

227 
UccT—m_h
 
	m‹am
;

230 
	mpublic
:

231 
ucc_¡©us_t
 
¡©us
;

232 
UccReq
(cÚ¡ UccReq&èğ
d–‘e
;

233 
	mUccReq
& 
	mİ”©Ü
=(cÚ¡ 
UccReq
&èğ
d–‘e
;

234 
	$UccReq
(
UccReq
&& 
sourû
è: 
	`‹am
(sourû.
‹am
), 
	$¡©us
(
sourû
.
¡©us
) {

235 
»qs
.
	`sw­
(
sourû
.reqs);

238 
¡d
::
veùÜ
<
ucc_cŞl_»q_h
> 
»qs
;

239 
	`UccReq
(
UccT—m_h
 
_‹am
, 
ucc_cŞl_¬gs_t
 *
¬gs
);

240 
	`UccReq
(
UccT—m_h
 
_‹am
, 
UccCŞlCtxVec
 
¬gs
);

241 ~
	`UccReq
();

242 
	`¡¬t
();

243 
ucc_¡©us_t
 
	`wa™
();

244 
ucc_¡©us_t
 
	`‹¡
();

245 
	`wa™®l
(
¡d
::
veùÜ
<
UccReq
> &
»qs
);

246 
	`¡¬Î
(
¡d
::
veùÜ
<
UccReq
> &
»qs
);

247 
	}
};

249 
	#DATA_FINI_ALL
(
_‹¡
, 
_ùx
èautØ&
c
 : 
ùxs
è{ _‹¡->
	`d©a_fši
(c); }

	)

251 
	#CHECK_REQ_NOT_SUPPORTED_SKIP
(
_UccReq
, 
_aùiÚ
) do{ \

252 ià((
_UccReq
).
¡©us
 =ğ
UCC_ERR_NOT_SUPPORTED
) { \

253 
_aùiÚ
; \

254 
	`GTEST_SKIP
(); \

256 
	`ASSERT_EQ
(
UCC_OK
, (
_UccReq
).
¡©us
); \

257 } 0)

	)

259 
ş—r_bufãr
(*
_buf
, 
size_t
 
size
, 
ucc_memÜy_ty³_t
 
mt
, 
ušt8_t
 
v®ue
);

261 
	#PREDEFINED_DTYPES
 \

262 ::
‹¡šg
::
	`V®ues
( \

263 
UCC_DT_INT8
, 
UCC_DT_INT16
, 
UCC_DT_INT32
, 
UCC_DT_INT64
, 
UCC_DT_INT128
, \

264 
UCC_DT_UINT8
, 
UCC_DT_UINT16
, 
UCC_DT_UINT32
, 
UCC_DT_UINT64
, \

265 
UCC_DT_UINT128
, 
UCC_DT_FLOAT16
, 
UCC_DT_FLOAT32
, 
UCC_DT_FLOAT64
, \

266 
UCC_DT_BFLOAT16
, 
UCC_DT_FLOAT128
, 
UCC_DT_FLOAT32_COMPLEX
, \

267 
UCC_DT_FLOAT64_COMPLEX
, 
UCC_DT_FLOAT128_COMPLEX
)

	)

269 
	#UCC_TEST_N_MEM_SEGMENTS
 3

	)

270 
	#UCC_TEST_MEM_SEGMENT_SIZE
 (1 << 20)

	)

272 
boŞ
 
_£lf_avaabË
();

	@test/gtest/core/test_context.cc

5 
	~"‹¡_cÚ‹xt.h
"

6 
	~"../commÚ/‹¡_ucc.h
"

7 
	~<veùÜ
>

8 
	~<®gÜ™hm
>

9 
	~<¿ndom
>

11 
	g‹¡_cÚ‹xt
::
	$‹¡_cÚ‹xt
()

13 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_cÚfig_»ad
(
lib_h
, 
NULL
, &
ùx_cÚfig
));

14 
	}
}

16 
	g‹¡_cÚ‹xt
::~
	$‹¡_cÚ‹xt
()

18 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

19 
	}
}

21 
	$UCC_TEST_F
(
‹¡_cÚ‹xt
, 
ü—‹_de¡roy
)

23 
ucc_cÚ‹xt_·¿ms_t
 
ùx_·¿ms
;

24 
ucc_cÚ‹xt_h
 
ùx_h
;

25 
ùx_·¿ms
.
mask
 = 
UCC_CONTEXT_PARAM_FIELD_TYPE
;

26 
ùx_·¿ms
.
ty³
 = 
UCC_CONTEXT_EXCLUSIVE
;

27 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_ü—‹
(
lib_h
, &
ùx_·¿ms
, 
ùx_cÚfig
, &
ùx_h
));

28 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_de¡roy
(
ùx_h
));

29 
	}
}

31 
	$UCC_TEST_F
(
‹¡_cÚ‹xt
, 
š™_muÉË
)

33 cÚ¡ 
n_ùxs
 = 8;

34 
ucc_cÚ‹xt_·¿ms_t
 
ùx_·¿ms
;

35 
ucc_cÚ‹xt_h
 
ùx_h
;

36 
¡d
::
veùÜ
<
ucc_cÚ‹xt_h
> 
ùxs
;

37 
ùx_·¿ms
.
mask
 = 
UCC_CONTEXT_PARAM_FIELD_TYPE
;

38 
ùx_·¿ms
.
ty³
 = 
UCC_CONTEXT_EXCLUSIVE
;

39 
i
 = 0; i < 
n_ùxs
; i++) {

40 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_ü—‹
(
lib_h
, &
ùx_·¿ms
, 
ùx_cÚfig
, &
ùx_h
));

41 
ùxs
.
	`push_back
(
ùx_h
);

44 
¡d
::
	`shufæe
(
ùxs
.
	`begš
(), ctxs.
	`’d
(), std::
	`deçuÉ_¿ndom_’gše
());

45 autØ
ùx_h
 : 
ùxs
) {

46 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_de¡roy
(
ùx_h
));

48 
	}
}

50 
	g‹¡_cÚ‹xt_g‘_©Œ
::
	$‹¡_cÚ‹xt_g‘_©Œ
()

52 
ucc_cÚ‹xt_·¿ms_t
 
ùx_·¿ms
;

53 
ùx_·¿ms
.
mask
 = 
UCC_CONTEXT_PARAM_FIELD_TYPE
;

54 
ùx_·¿ms
.
ty³
 = 
UCC_CONTEXT_EXCLUSIVE
;

55 
	`EXPECT_EQ
(
UCC_OK
,

56 
	`ucc_cÚ‹xt_ü—‹
(
lib_h
, &
ùx_·¿ms
, 
ùx_cÚfig
, &
ùx_h
));

57 
	}
}

59 
	g‹¡_cÚ‹xt_g‘_©Œ
::~
	$‹¡_cÚ‹xt_g‘_©Œ
()

61 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_de¡roy
(
ùx_h
));

62 
	}
}

64 
	$UCC_TEST_F
(
‹¡_cÚ‹xt_g‘_©Œ
, 
addr_Ën
)

66 
ucc_cÚ‹xt_©Œ_t
 
©Œ
;

67 
©Œ
.
mask
 = 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR_LEN
;

68 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_g‘_©Œ
(
ùx_h
, &
©Œ
));

69 
	}
}

71 
	$UCC_TEST_F
(
‹¡_cÚ‹xt_g‘_©Œ
, 
addr
)

73 
ucc_cÚ‹xt_©Œ_t
 
©Œ
;

74 
©Œ
.
mask
 = 
UCC_CONTEXT_ATTR_FIELD_CTX_ADDR
;

75 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_g‘_©Œ
(
ùx_h
, &
©Œ
));

76 
	`EXPECT_EQ
(
Œue
, ((
©Œ
.
ùx_addr_Ën
 =ğ0è|| (
NULL
 !ğ©Œ.
ùx_addr
)));

77 
	}
}

79 
	$UCC_TEST_F
(
‹¡_cÚ‹xt_g‘_©Œ
, 
wÜk_bufãr_size
)

81 
ucc_cÚ‹xt_©Œ_t
 
©Œ
;

82 
©Œ
.
mask
 = 
UCC_CONTEXT_ATTR_FIELD_WORK_BUFFER_SIZE
;

83 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_g‘_©Œ
(
ùx_h
, &
©Œ
));

84 
	`EXPECT_EQ
(5, 
©Œ
.
glob®_wÜk_bufãr_size
);

85 
	}
}

87 
	$UCC_TEST_F
(
‹¡_cÚ‹xt
, 
glob®
)

90 
UccJob
 
	`job1
(1, UccJob::
UCC_JOB_CTX_GLOBAL
);

91 
job1
.
	`ş—nup
();

93 
UccJob
 
	`job3
(3, UccJob::
UCC_JOB_CTX_GLOBAL
);

94 
job3
.
	`ş—nup
();

96 
UccJob
 
	`job11
(11, UccJob::
UCC_JOB_CTX_GLOBAL
);

97 
job11
.
	`ş—nup
();

99 
UccJob
 
	`job16
(16, UccJob::
UCC_JOB_CTX_GLOBAL
);

100 
job16
.
	`ş—nup
();

102 
	}
}

	@test/gtest/core/test_context.h

6 #iâdeà
UCC_TEST_CONTEXT_H


7 
	#UCC_TEST_CONTEXT_H


	)

8 
	~<commÚ/‹¡_ucc.h
>

9 şas 
	c‹¡_cÚ‹xt_cÚfig
 : 
public
 
ucc
::
‹¡


11 
public
:

12 
‹¡_cÚ‹xt_cÚfig
();

13 ~
‹¡_cÚ‹xt_cÚfig
();

14 
ucc_lib_cÚfig_h
 
	mlib_cÚfig
;

15 
ucc_lib_·¿ms_t
 
	mlib_·¿ms
;

16 
ucc_lib_h
 
	mlib_h
;

19 şas 
	c‹¡_cÚ‹xt
 : 
public
 
‹¡_cÚ‹xt_cÚfig


21 
public
:

22 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

23 
‹¡_cÚ‹xt
();

24 ~
‹¡_cÚ‹xt
();

27 şas 
	c‹¡_cÚ‹xt_g‘_©Œ
 : 
public
 
‹¡_cÚ‹xt
 {

28 
public
:

29 
ucc_cÚ‹xt_h
 
ùx_h
;

30 
‹¡_cÚ‹xt_g‘_©Œ
();

31 ~
‹¡_cÚ‹xt_g‘_©Œ
();

	@test/gtest/core/test_context_config.cc

5 
	~"‹¡_cÚ‹xt.h
"

7 
	g‹¡_cÚ‹xt_cÚfig
::
	$‹¡_cÚ‹xt_cÚfig
()

9 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
lib_cÚfig
));

10 
lib_·¿ms
.
mask
 = 
UCC_LIB_PARAM_FIELD_THREAD_MODE
;

11 
lib_·¿ms
.
th»ad_mode
 = 
UCC_THREAD_SINGLE
;

12 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_š™
(&
lib_·¿ms
, 
lib_cÚfig
, &
lib_h
));

13 
	`ucc_lib_cÚfig_»Ëa£
(
lib_cÚfig
);

14 
	}
}

16 
	g‹¡_cÚ‹xt_cÚfig
::~
	$‹¡_cÚ‹xt_cÚfig
()

18 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_fš®ize
(
lib_h
));

19 
	}
}

21 
	$UCC_TEST_F
(
‹¡_cÚ‹xt_cÚfig
, 
»ad_»Ëa£
)

23 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

24 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_cÚfig_»ad
(
lib_h
, 
NULL
, &
ùx_cÚfig
));

25 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

26 
	}
}

28 
	$UCC_TEST_F
(
‹¡_cÚ‹xt_cÚfig
, 
´št
)

30 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

31 
æags
;

32 
‹¡šg
::
š‹º®
::
	`C­tu»Stdout
();

34 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_cÚfig_»ad
(
lib_h
, 
NULL
, &
ùx_cÚfig
));

35 
æags
 = 
UCC_CONFIG_PRINT_CONFIG
 | 
UCC_CONFIG_PRINT_HEADER
 |

36 
UCC_CONFIG_PRINT_DOC
 | 
UCC_CONFIG_PRINT_HIDDEN
;

37 
	`ucc_cÚ‹xt_cÚfig_´št
(
ùx_cÚfig
, 
¡dout
, "TEST_TITLE",

38 (
ucc_cÚfig_´št_æags_t
)
æags
);

39 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

40 
¡d
::
¡ršg
 
ouut
 = 
‹¡šg
::
š‹º®
::
	`G‘C­tu»dStdout
();

41 
	`EXPECT_NE
(
¡d
::
¡ršg
::
Åos
, 
ouut
.
	`fšd
("# TEST_TITLE"));

42 
	`EXPECT_NE
(
¡d
::
¡ršg
::
Åos
, 
ouut
.
	`fšd
("# CL_BASIC"));

43 
	}
}

45 
	$UCC_TEST_F
(
‹¡_cÚ‹xt_cÚfig
, 
modify
)

47 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

48 
¡d
::
¡ršg
 
ouut
;

49 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_cÚfig_»ad
(
lib_h
, 
NULL
, &
ùx_cÚfig
));

52 
‹¡šg
::
š‹º®
::
	`C­tu»Stdout
();

53 
	`EXPECT_NE
(
UCC_OK
,

54 
	`ucc_cÚ‹xt_cÚfig_modify
(
ùx_cÚfig
, "cl/basic", "_UNKNOWN_FIELD", "_unknown_value"));

55 
ouut
 = 
‹¡šg
::
š‹º®
::
	`G‘C­tu»dStdout
();

56 
	`EXPECT_NE
(
¡d
::
¡ršg
::
Åos
, 
ouut
.
	`fšd
("failedo modify"));

59 
‹¡šg
::
š‹º®
::
	`C­tu»Stdout
();

60 
	`EXPECT_NE
(
UCC_OK
,

61 
	`ucc_cÚ‹xt_cÚfig_modify
(
ùx_cÚfig
, "_unknown_cl", "_UNKNOWN_FIELD", "_unknown_value"));

62 
ouut
 = 
‹¡šg
::
š‹º®
::
	`G‘C­tu»dStdout
();

63 
	`EXPECT_NE
(
¡d
::
¡ršg
::
Åos
, 
ouut
.
	`fšd
("invalid component‚ame"));

66 
	`EXPECT_EQ
(
UCC_OK
,

67 
	`ucc_cÚ‹xt_cÚfig_modify
(
ùx_cÚfig
, "tl/ucp", "NPOLLS", "123"));

69 
	`EXPECT_EQ
(
UCC_OK
,

70 
	`ucc_cÚ‹xt_cÚfig_modify
(
ùx_cÚfig
, "tl/ucp", "TUNE", "123"));

72 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

73 
	}
}

75 
	$UCC_TEST_F
(
‹¡_cÚ‹xt_cÚfig
, 
modify_cÜe
)

77 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

78 
æags
;

79 
¡d
::
¡ršg
 
ouut
;

80 
æags
 = 
UCC_CONFIG_PRINT_CONFIG
;

81 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_cÚfig_»ad
(
lib_h
, 
NULL
, &
ùx_cÚfig
));

84 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_cÚfig_modify
(
ùx_cÚfig
, 
NULL
, "ESTIMATED_NUM_EPS", "12345"));

85 
‹¡šg
::
š‹º®
::
	`C­tu»Stdout
();

86 
	`ucc_cÚ‹xt_cÚfig_´št
(
ùx_cÚfig
, 
¡dout
, "", (
ucc_cÚfig_´št_æags_t
)
æags
);

87 
ouut
 = 
‹¡šg
::
š‹º®
::
	`G‘C­tu»dStdout
();

88 
	`EXPECT_NE
(
¡d
::
¡ršg
::
Åos
, 
ouut
.
	`fšd
("UCC_ESTIMATED_NUM_EPS=12345"));

91 
‹¡šg
::
š‹º®
::
	`C­tu»Stdout
();

92 
	`EXPECT_NE
(
UCC_OK
,

93 
	`ucc_cÚ‹xt_cÚfig_modify
(
ùx_cÚfig
, 
NULL
, "_UNKNOWN_FIELD", "_unknown_value"));

94 
ouut
 = 
‹¡šg
::
š‹º®
::
	`G‘C­tu»dStdout
();

95 
	`EXPECT_NE
(
¡d
::
¡ršg
::
Åos
, 
ouut
.
	`fšd
("failedo modify"));

96 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

97 
	}
}

	@test/gtest/core/test_ec_cuda.cc

7 
	~<compÚ’ts/ec/ucc_ec.h
>

8 
	~<±h»ad.h
>

10 
	~<commÚ/‹¡.h
>

11 
	~<commÚ/‹¡_ucc.h
>

12 
	~<cuda_ruÁime.h
>

14 şas 
	c‹¡_ec_cuda
 : 
public
 
ucc
::
‹¡
 {

15 
	$Te¡ECCudaS‘Up
(
ucc_ec_·¿ms_t
 
ec_·¿ms
)

17 
ucc
::
‹¡
::
	`S‘Up
();

18 
	`ucc_cÚ¡ruùÜ
();

19 
	`ucc_ec_š™
(&
ec_·¿ms
);

22 
vœtu®
 
	$S‘Up
(è
ov”ride


24 
ucc_ec_·¿ms_t
 
ec_·¿ms
 = {

25 .
th»ad_mode
 = 
UCC_THREAD_SINGLE
,

28 
	`Te¡ECCudaS‘Up
(
ec_·¿ms
);

29 ià(
UCC_OK
 !ğ
	`ucc_ec_avaabË
(
UCC_EE_CUDA_STREAM
)) {

30 
	`GTEST_SKIP
();

32 
	}
}

34 
vœtu®
 
	$T—rDown
(è
ov”ride


36 
	`ucc_ec_fš®ize
();

37 
ucc
::
‹¡
::
	`T—rDown
();

38 
	}
}

40 
public
:

41 
ucc_¡©us_t
 
	$g‘_cuda_executÜ
(
ucc_“_executÜ_t
 **
executÜ
)

43 
ucc_“_executÜ_·¿ms_t
 
•¬ams
;

45 
•¬ams
.
mask
 = 
UCC_EE_EXECUTOR_PARAM_FIELD_TYPE
;

46 
•¬ams
.
“_ty³
 = 
UCC_EE_CUDA_STREAM
;

48  
	`ucc_“_executÜ_š™
(&
•¬ams
, 
executÜ
);

49 
	}
}

51 
ucc_¡©us_t
 
	$put_cuda_executÜ
(
ucc_“_executÜ_t
 *
executÜ
)

53  
	`ucc_“_executÜ_fš®ize
(
executÜ
);

54 
	}
}

58 
	$UCC_TEST_F
(
‹¡_ec_cuda
, 
ec_cuda_lßd
)

60 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_ec_avaabË
(
UCC_EE_CUDA_STREAM
));

61 
	}
}

63 
	$UCC_TEST_F
(
‹¡_ec_cuda
, 
ec_cuda_executÜ_š™_fš®ize
)

65 
ucc_“_executÜ_t
 *
executÜ
;

67 
	`ASSERT_EQ
(
UCC_OK
, 
	`g‘_cuda_executÜ
(&
executÜ
));

68 
	`ASSERT_EQ
(
UCC_OK
, 
	`put_cuda_executÜ
(
executÜ
));

69 
	}
}

71 
	$UCC_TEST_F
(
‹¡_ec_cuda
, 
ec_cuda_executÜ_š‹¼u±ibË_¡¬t
)

73 
ucc_“_executÜ_t
 *
executÜ
;

74 
ucc_¡©us_t
 
¡©us
;

76 
	`ASSERT_EQ
(
UCC_OK
, 
	`g‘_cuda_executÜ
(&
executÜ
));

78 
¡©us
 = 
	`ucc_“_executÜ_¡¬t
(
executÜ
, 
nuÎ±r
);

79 
	`EXPECT_EQ
(
UCC_OK
, 
¡©us
);

80 ià(
¡©us
 =ğ
UCC_OK
) {

81 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_“_executÜ_¡İ
(
executÜ
));

83 
	`ASSERT_EQ
(
UCC_OK
, 
	`put_cuda_executÜ
(
executÜ
));

84 
	}
}

87 
	$UCC_TEST_F
(
‹¡_ec_cuda
, 
ec_cuda_executÜ_š‹¼u±ibË_cİy
)

89 
ucc_“_executÜ_t
 *
executÜ
;

90 
ucc_¡©us_t
 
¡©us
;

91 
cudaE¼Ü_t
 
cuda_¡
;

92 *
¤c_ho¡
, *
d¡_ho¡
, *
¤c
, *
d¡
;

93 cÚ¡ 
size_t
 
size
 = 4850;

94 
ucc_“_executÜ_sk_t
 *
sk
;

96 
	`ASSERT_EQ
(
UCC_OK
, 
	`g‘_cuda_executÜ
(&
executÜ
));

98 
¡©us
 = 
	`ucc_“_executÜ_¡¬t
(
executÜ
, 
nuÎ±r
);

99 
	`EXPECT_EQ
(
UCC_OK
, 
¡©us
);

100 ià(
¡©us
 !ğ
UCC_OK
) {

101 
ex™
;

104 
¤c_ho¡
 = (*)
	`m®loc
(
size
 * ());

105 
	`EXPECT_NE
(
nuÎ±r
, 
¤c_ho¡
);

106 ià(!
¤c_ho¡
) {

107 
ex™
;

110 
d¡_ho¡
 = (*)
	`m®loc
(
size
 * ());

111 
	`EXPECT_NE
(
nuÎ±r
, 
d¡_ho¡
);

112 ià(!
d¡_ho¡
) {

113 
ex™
;

116 
cuda_¡
 = 
	`cudaM®loc
(&
¤c
, 
size
 * ());

117 
	`EXPECT_EQ
(
cudaSucûss
, 
cuda_¡
);

118 ià(
cuda_¡
 !ğ
cudaSucûss
) {

119 
ex™
;

122 
cuda_¡
 = 
	`cudaM®loc
(&
d¡
, 
size
 * ());

123 
	`EXPECT_EQ
(
cudaSucûss
, 
cuda_¡
);

124 ià(
cuda_¡
 !ğ
cudaSucûss
) {

125 
ex™
;

128 
i
 = 0; i < 
size
; i++) {

129 
¤c_ho¡
[
i
] = i;

132 
cuda_¡
 = 
	`cudaMemıy
(
¤c
, 
¤c_ho¡
, 
size
 * (), 
cudaMemıyDeçuÉ
);

133 
	`EXPECT_EQ
(
cudaSucûss
, 
cuda_¡
);

134 ià(
cuda_¡
 !ğ
cudaSucûss
) {

135 
ex™
;

138 
ucc_“_executÜ_sk_¬gs_t
 
¬gs
;

139 
¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

140 
¬gs
.
cİy
.
¤c
 = src;

141 
¬gs
.
cİy
.
d¡
 = dst;

142 
¬gs
.
cİy
.
Ën
 = 
size
 * ();

144 
¡©us
 = 
	`ucc_“_executÜ_sk_po¡
(
executÜ
, &
¬gs
, &
sk
);

145 
	`EXPECT_EQ
(
UCC_OK
, 
¡©us
);

146 ià(
¡©us
 !ğ
UCC_OK
) {

147 
ex™
;

151 
¡©us
 = 
	`ucc_“_executÜ_sk_‹¡
(
sk
);

152 } 
¡©us
 > 0);

154 
	`EXPECT_EQ
(
UCC_OK
, 
¡©us
);

155 ià(
¡©us
 !ğ
UCC_OK
) {

156 
ex™
;

159 
cuda_¡
 = 
	`cudaMemıy
(
d¡_ho¡
, 
d¡
, 
size
 * (), 
cudaMemıyDeçuÉ
);

160 
	`EXPECT_EQ
(
cudaSucûss
, 
cuda_¡
);

161 ià(
cuda_¡
 !ğ
cudaSucûss
) {

162 
ex™
;

165 
i
 = 0; i < 
size
; i++) {

166 ià(
d¡_ho¡
[
i
] !ğ
¤c_ho¡
[i]) {

167 
	`EXPECT_EQ
(
d¡_ho¡
[
i
], 
¤c_ho¡
[i]);

168 
ex™
;

172 
ex™
:

173 ià(
sk
) {

174 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_“_executÜ_sk_fš®ize
(
sk
));

176 ià(
¤c_ho¡
) {

177 
	`ä“
(
¤c_ho¡
);

180 ià(
d¡_ho¡
) {

181 
	`ä“
(
d¡_ho¡
);

184 ià(
¤c
) {

185 
	`cudaF»e
(
¤c
);

188 ià(
d¡
) {

189 
	`cudaF»e
(
d¡
);

191 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_“_executÜ_¡İ
(
executÜ
));

192 
	`ASSERT_EQ
(
UCC_OK
, 
	`put_cuda_executÜ
(
executÜ
));

193 
	}
}

	@test/gtest/core/test_lib.cc

6 
	~<commÚ/‹¡_ucc.h
>

7 
	~<®gÜ™hm
>

8 
	~<¿ndom
>

10 şas 
	c‹¡_lib
 : 
public
 
ucc
::
‹¡
 {

13 
	$UCC_TEST_F
(
‹¡_lib
, 
š™_fš®ize
)

15 
ucc_lib_cÚfig_h
 
cfg
;

16 
ucc_lib_·¿ms_t
 
lib_·¿ms
;

17 
ucc_lib_h
 
lib
;

18 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
cfg
));

19 
lib_·¿ms
.
mask
 = 
UCC_LIB_PARAM_FIELD_THREAD_MODE
;

20 
lib_·¿ms
.
th»ad_mode
 = 
UCC_THREAD_SINGLE
;

21 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_š™
(&
lib_·¿ms
, 
cfg
, &
lib
));

22 
	`ucc_lib_cÚfig_»Ëa£
(
cfg
);

23 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_fš®ize
(
lib
));

24 
	}
}

26 
	$UCC_TEST_F
(
‹¡_lib
, 
š™_muÉË
)

28 cÚ¡ 
n_libs
 = 8;

29 
ucc_lib_cÚfig_h
 
cfg
;

30 
ucc_lib_·¿ms_t
 
lib_·¿ms
;

31 
ucc_lib_h
 
lib_h
;

32 
¡d
::
veùÜ
<
ucc_lib_h
> 
libs
;

33 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
cfg
));

34 
lib_·¿ms
.
mask
 = 
UCC_LIB_PARAM_FIELD_THREAD_MODE
;

35 
lib_·¿ms
.
th»ad_mode
 = 
UCC_THREAD_SINGLE
;

36 
i
 = 0; i < 
n_libs
; i++) {

37 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_š™
(&
lib_·¿ms
, 
cfg
, &
lib_h
));

38 
libs
.
	`push_back
(
lib_h
);

40 
	`ucc_lib_cÚfig_»Ëa£
(
cfg
);

41 
¡d
::
	`shufæe
(
libs
.
	`begš
(),†ibs.
	`’d
(), std::
	`deçuÉ_¿ndom_’gše
());

43 autØ
lib_h
 : 
libs
) {

44 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_fš®ize
(
lib_h
));

46 
	}
}

	@test/gtest/core/test_lib_config.cc

6 
	~<commÚ/‹¡_ucc.h
>

8 şas 
	c‹¡_lib_cÚfig
 : 
public
 
ucc
::
‹¡
 {

11 
	$UCC_TEST_F
(
‹¡_lib_cÚfig
, 
»ad_»Ëa£
)

13 
ucc_lib_cÚfig_h
 
cfg
;

14 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
cfg
));

15 
	`ucc_lib_cÚfig_»Ëa£
(
cfg
);

16 
	}
}

18 
	$UCC_TEST_F
(
‹¡_lib_cÚfig
, 
´št
)

20 
ucc_lib_cÚfig_h
 
cfg
;

21 
æags
;

22 
‹¡šg
::
š‹º®
::
	`C­tu»Stdout
();

23 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
cfg
));

24 
æags
 = 
UCC_CONFIG_PRINT_CONFIG
 | 
UCC_CONFIG_PRINT_HEADER
 |

25 
UCC_CONFIG_PRINT_DOC
 | 
UCC_CONFIG_PRINT_HIDDEN
;

26 
	`ucc_lib_cÚfig_´št
(
cfg
, 
¡dout
, "TEST_TITLE",

27 (
ucc_cÚfig_´št_æags_t
)
æags
);

28 
	`ucc_lib_cÚfig_»Ëa£
(
cfg
);

29 
¡d
::
¡ršg
 
ouut
 = 
‹¡šg
::
š‹º®
::
	`G‘C­tu»dStdout
();

30 
	`EXPECT_NE
(
¡d
::
¡ršg
::
Åos
, 
ouut
.
	`fšd
("# TEST_TITLE"));

31 
	`EXPECT_NE
(
¡d
::
¡ršg
::
Åos
, 
ouut
.
	`fšd
("UCC_CLS="));

32 
	}
}

34 
	$UCC_TEST_F
(
‹¡_lib_cÚfig
, 
modify
)

36 
ucc_lib_cÚfig_h
 
cfg
;

37 
æags
;

38 
‹¡šg
::
š‹º®
::
	`C­tu»Stdout
();

39 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
cfg
));

42 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_lib_cÚfig_modify
(
cfg
, "CLS", "basic"));

43 
æags
 = 
UCC_CONFIG_PRINT_CONFIG
;

44 
	`ucc_lib_cÚfig_´št
(
cfg
, 
¡dout
, "", (
ucc_cÚfig_´št_æags_t
)
æags
);

45 
¡d
::
¡ršg
 
ouut
 = 
‹¡šg
::
š‹º®
::
	`G‘C­tu»dStdout
();

46 
	`EXPECT_NE
(
¡d
::
¡ršg
::
Åos
, 
ouut
.
	`fšd
("UCC_CLS=basic"));

53 
	`EXPECT_NE
(
UCC_OK
,

54 
	`ucc_lib_cÚfig_modify
(
cfg
, "_UNKNOWN_FIELD", "_unknown_value"));

55 
	`ucc_lib_cÚfig_»Ëa£
(
cfg
);

56 
	}
}

	@test/gtest/core/test_mc.cc

7 
	~<compÚ’ts/mc/ucc_mc.h
>

8 
	~<±h»ad.h
>

10 
	~<commÚ/‹¡.h
>

11 
	~<veùÜ
>

13 *
	$mt_ucc_mc_ıu_®locs
(*
¬gs
)

20 
size_t
 
size
 = 4;

21 
quªtif›r
 = 2;

22 
num_of_®locs
 = 40;

23 
¡d
::
veùÜ
<
ucc_mc_bufãr_h—d”_t
 *> 
h—d”s
;

24 
¡d
::
veùÜ
<*> 
poš‹rs
;

25 
h—d”s
.
	`»size
(
num_of_®locs
);

26 
poš‹rs
.
	`»size
(
num_of_®locs
);

28 
i
 = 0; i < 
num_of_®locs
; i++) {

29 
	`EXPECT_EQ
(
UCC_OK
,

30 
	`ucc_mc_®loc
(&
h—d”s
[
i
], 
size
, 
UCC_MEMORY_TYPE_HOST
));

31 
poš‹rs
[
i
] = 
h—d”s
[i]->
addr
;

32 
	`mem£t
(
poš‹rs
[
i
], 0, 
size
);

33 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_ä“
(
h—d”s
[
i
]));

34 ià(
i
 % 2) {

35 
size
 *ğ
quªtif›r
;

39 
	}
}

41 şas 
	c‹¡_mc
 : 
public
 
ucc
::
‹¡
 {

44 
	$UCC_TEST_F
(
‹¡_mc
, 
š™_fš®ize
)

46 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ¡ruùÜ
());

47 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

48 .
th»ad_mode
 = 
UCC_THREAD_SINGLE
,

50 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_š™
(&
mc_·¿ms
));

51 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_fš®ize
());

52 
	}
}

54 
	$UCC_TEST_F
(
‹¡_mc
, 
š™_is_»quœed
)

56 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cÚ¡ruùÜ
());

57 
	`EXPECT_NE
(
UCC_OK
, 
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_HOST
));

58 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

59 .
th»ad_mode
 = 
UCC_THREAD_SINGLE
,

61 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_š™
(&
mc_·¿ms
));

62 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_HOST
));

63 
	`ucc_mc_fš®ize
();

64 
	}
}

66 
	$UCC_TEST_F
(
‹¡_mc
, 
ÿn_®loc_ªd_ä“_ho¡_mem
)

69 
size_t
 
size
 = 4096;

70 
ucc_mc_bufãr_h—d”_t
 *
h
;

71 *
±r
 = 
NULL
;

73 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cÚ¡ruùÜ
());

74 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

75 .
th»ad_mode
 = 
UCC_THREAD_SINGLE
,

77 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_mc_š™
(&
mc_·¿ms
));

78 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_®loc
(&
h
, 
size
, 
UCC_MEMORY_TYPE_HOST
));

79 
±r
 = 
h
->
addr
;

80 
	`mem£t
(
±r
, 0, 
size
);

81 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_ä“
(
h
));

82 
	`ucc_mc_fš®ize
();

83 
	}
}

86 
	$UCC_TEST_F
(
‹¡_mc
, 
DISABLED_ÿn_®loc_ªd_ä“_ho¡_mem_mt
)

89 
num_of_th»ads
 = 10;

90 
¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

91 
th»ads
.
	`»size
(
num_of_th»ads
);

93 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cÚ¡ruùÜ
());

94 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

95 .
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
,

97 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_mc_š™
(&
mc_·¿ms
));

98 
i
 = 0; i < 
num_of_th»ads
; i++) {

99 
	`±h»ad_ü—‹
(&
th»ads
[
i
], 
NULL
, &
mt_ucc_mc_ıu_®locs
, NULL);

101 
i
 = 0; i < 
num_of_th»ads
; i++) {

102 
	`±h»ad_još
(
th»ads
[
i
], 
NULL
);

104 
	`ucc_mc_fš®ize
();

105 
	}
}

107 
	$UCC_TEST_F
(
‹¡_mc
, 
š™_twiû
)

109 
ucc_lib_cÚfig_h
 
cfg
;

110 
ucc_lib_·¿ms_t
 
lib_·¿ms
;

111 
ucc_lib_h
 
lib1
, 
lib2
;

112 
ucc_mc_ba£_t
 *
mc
;

114 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
cfg
));

115 
lib_·¿ms
.
mask
 = 
UCC_LIB_PARAM_FIELD_THREAD_MODE
;

116 
lib_·¿ms
.
th»ad_mode
 = 
UCC_THREAD_SINGLE
;

117 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_š™
(&
lib_·¿ms
, 
cfg
, &
lib1
));

118 
mc
 = 
	`ucc_d”ived_of
(
ucc_glob®_cÚfig
.
mc_äamewÜk
.
compÚ’ts
[0],

119 
ucc_mc_ba£_t
);

120 
	`EXPECT_EQ
(1, 
mc
->
»f_út
);

121 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_š™
(&
lib_·¿ms
, 
cfg
, &
lib2
));

122 
	`EXPECT_EQ
(2, 
mc
->
»f_út
);

123 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_fš®ize
(
lib1
));

124 
	`EXPECT_EQ
(1, 
mc
->
»f_út
);

125 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_fš®ize
(
lib2
));

126 
	`EXPECT_EQ
(0, 
mc
->
»f_út
);

128 
	`ucc_lib_cÚfig_»Ëa£
(
cfg
);

129 
	}
}

	@test/gtest/core/test_mc_cuda.cc

7 
	~<compÚ’ts/mc/ucc_mc.h
>

8 
	~<±h»ad.h
>

10 
	~<commÚ/‹¡.h
>

11 
	~<commÚ/‹¡_ucc.h
>

12 
	~<cuda_ruÁime.h
>

13 
	~<veùÜ
>

15 *
	$mt_ucc_mc_cuda_®locs
(*
¬gs
)

22 
quªtif›r
 = 2;

23 
size_t
 
size
 = 4;

24 
num_of_®locs
 = 40;

25 
¡d
::
veùÜ
<
ucc_mc_bufãr_h—d”_t
 *> 
h—d”s
;

26 
¡d
::
veùÜ
<*> 
poš‹rs
;

27 
h—d”s
.
	`»size
(
num_of_®locs
);

28 
poš‹rs
.
	`»size
(
num_of_®locs
);

30 
i
 = 0; i < 
num_of_®locs
; i++) {

31 
	`EXPECT_EQ
(
UCC_OK
,

32 
	`ucc_mc_®loc
(&
h—d”s
[
i
], 
size
, 
UCC_MEMORY_TYPE_CUDA
));

33 
poš‹rs
[
i
] = 
h—d”s
[i]->
addr
;

34 
	`EXPECT_EQ
(
cudaSucûss
, 
	`cudaMem£t
(
poš‹rs
[
i
], 0, 
size
));

35 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_ä“
(
h—d”s
[
i
]));

36 ià(
i
 % 2) {

37 
size
 *ğ
quªtif›r
;

41 
	}
}

43 şas 
	c‹¡_mc_cuda
 : 
public
 
ucc
::
‹¡
 {

44 
´Ùeùed
:

45 cÚ¡ 
TEST_ALLOC_SIZE
 = 1024;

46 
ucc_mc_bufãr_h—d”_t
 *
mc_h—d”
;

47 * 
‹¡_±r
;

48 
ucc_memÜy_ty³_t
 
‹¡_mty³
;

49 
	$Te¡MCCudaS‘Up
(
ucc_mc_·¿ms_t
 
mc_·¿ms
)

51 
ucc
::
‹¡
::
	`S‘Up
();

52 
	`ucc_cÚ¡ruùÜ
();

53 
	`ucc_mc_š™
(&
mc_·¿ms
);

54 
‹¡_±r
 = 
NULL
;

55 
‹¡_mty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

58 
vœtu®
 
	$S‘Up
(è
ov”ride


60 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

61 .
th»ad_mode
 = 
UCC_THREAD_SINGLE
,

64 ià(
UCC_OK
 !ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) {

65 
	`GTEST_SKIP
();

68 
	`Te¡MCCudaS‘Up
(
mc_·¿ms
);

69 
	}
}

70 
vœtu®
 
	$T—rDown
(è
ov”ride


72 
	`ucc_mc_fš®ize
();

73 
ucc
::
‹¡
::
	`T—rDown
();

74 
	}
}

77 şas 
	c‹¡_mc_cuda_mt
 : 
public
 
‹¡_mc_cuda
 {

78 
´Ùeùed
:

79 
vœtu®
 
	$S‘Up
(è
ov”ride


81 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

82 .
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
,

85 ià(
UCC_OK
 !ğ
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
)) {

86 
	`GTEST_SKIP
();

89 
	`Te¡MCCudaS‘Up
(
mc_·¿ms
);

91 
	}
};

93 
	$UCC_TEST_F
(
‹¡_mc_cuda
, 
mc_cuda_lßd
)

95 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_CUDA
));

96 
	}
}

98 
	$UCC_TEST_F
(
‹¡_mc_cuda
, 
ÿn_®loc_ªd_ä“_mem
)

101 
	`EXPECT_EQ
(
UCC_OK
,

102 
	`ucc_mc_®loc
(&
mc_h—d”
, 
TEST_ALLOC_SIZE
, 
UCC_MEMORY_TYPE_CUDA
));

103 
‹¡_±r
 = 
mc_h—d”
->
addr
;

104 
	`EXPECT_EQ
(
cudaSucûss
, 
	`cudaMem£t
(
‹¡_±r
, 0, 
TEST_ALLOC_SIZE
));

105 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_ä“
(
mc_h—d”
));

106 
	}
}

109 
	$UCC_TEST_F
(
‹¡_mc_cuda_mt
, 
DISABLED_ÿn_®loc_ªd_ä“_mem_mt
)

112 
num_of_th»ads
 = 10;

113 
¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

114 
th»ads
.
	`»size
(
num_of_th»ads
);

116 
i
 = 0; i < 
num_of_th»ads
; i++) {

117 
	`±h»ad_ü—‹
(&
th»ads
[
i
], 
NULL
, &
mt_ucc_mc_cuda_®locs
, NULL);

119 
i
 = 0; i < 
num_of_th»ads
; i++) {

120 
	`±h»ad_još
(
th»ads
[
i
], 
NULL
);

122 
	}
}

124 
	$UCC_TEST_F
(
‹¡_mc_cuda
, 
ÿn_d‘eù_ho¡_mem
)

126 
ucc_mem_©Œ_t
 
mem_©Œ
;

128 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

129 
‹¡_±r
 = 
	`m®loc
(
TEST_ALLOC_SIZE
);

130 ià(
‹¡_±r
 =ğ
NULL
) {

131 
	`ADD_FAILURE
() << "failedo‡llocate host memory";

133 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

134 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_HOST
, 
mem_©Œ
.
mem_ty³
);

135 
	`ä“
(
‹¡_±r
);

136 
	}
}

138 
	$UCC_TEST_F
(
‹¡_mc_cuda
, 
ÿn_d‘eù_cuda_mem
)

140 
ucc_mem_©Œ_t
 
mem_©Œ
;

141 
cudaE¼Ü_t
 
¡
;

143 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

144 
¡
 = 
	`cudaM®loc
(&
‹¡_±r
, 
TEST_ALLOC_SIZE
);

145 ià(
¡
 !ğ
cudaSucûss
) {

146 
	`ADD_FAILURE
() << "failedo‡llocate device memory";

148 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

149 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_CUDA
, 
mem_©Œ
.
mem_ty³
);

150 
	`cudaF»e
(
‹¡_±r
);

151 
	`ucc_mc_fš®ize
();

152 
	}
}

154 
	$UCC_TEST_F
(
‹¡_mc_cuda
, 
ÿn_qu”y_cuda_mem
)

156 
ucc_mem_©Œ_t
 
mem_©Œ
;

157 
cudaE¼Ü_t
 
¡
;

158 *
±r
;

160 
¡
 = 
	`cudaM®loc
(&
‹¡_±r
, 
TEST_ALLOC_SIZE
);

161 ià(
¡
 !ğ
cudaSucûss
) {

162 
	`ADD_FAILURE
() << "failedo‡llocate device memory";

165 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

166 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

167 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_CUDA
, 
mem_©Œ
.
mem_ty³
);

170 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
 |

171 
UCC_MEM_ATTR_FIELD_BASE_ADDRESS
 |

172 
UCC_MEM_ATTR_FIELD_ALLOC_LENGTH
;

173 
mem_©Œ
.
®loc_Ëngth
 = 1;

174 
±r
 = (*)
‹¡_±r
 + 
TEST_ALLOC_SIZE
/2;

175 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
±r
, &
mem_©Œ
));

176 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_CUDA
, 
mem_©Œ
.
mem_ty³
);

177 
	`EXPECT_EQ
(
‹¡_±r
, 
mem_©Œ
.
ba£_add»ss
);

178 
	`EXPECT_EQ
(
TEST_ALLOC_SIZE
, 
mem_©Œ
.
®loc_Ëngth
);

180 
	`cudaF»e
(
‹¡_±r
);

181 
	`ucc_mc_fš®ize
();

182 
	}
}

184 
	$UCC_TEST_F
(
‹¡_mc_cuda
, 
ÿn_d‘eù_mªaged_mem
)

186 
cudaE¼Ü_t
 
¡
;

187 
ucc_mem_©Œ_t
 
mem_©Œ
;

189 
¡
 = 
	`cudaM®locMªaged
(&
‹¡_±r
, 
TEST_ALLOC_SIZE
);

190 ià(
¡
 !ğ
cudaSucûss
) {

191 
	`ADD_FAILURE
() << "failedo‡llocate managed memory";

193 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

194 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

195 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_CUDA_MANAGED
, 
mem_©Œ
.
mem_ty³
);

196 
	`cudaF»e
(
‹¡_±r
);

197 
	}
}

199 
	$UCC_TEST_F
(
‹¡_mc_cuda
, 
ÿn_d‘eù_ho¡_®loc_mem
)

201 
cudaE¼Ü_t
 
¡
;

202 
ucc_mem_©Œ_t
 
mem_©Œ
;

204 
¡
 = 
	`cudaHo¡AÎoc
(&
‹¡_±r
, 
TEST_ALLOC_SIZE
, 
cudaHo¡AÎocDeçuÉ
);

205 ià(
¡
 !ğ
cudaSucûss
) {

206 
	`ADD_FAILURE
() << "failedo‡llocate host mapped memory";

208 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

209 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

210 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_HOST
, 
mem_©Œ
.
mem_ty³
);

211 
	`cudaF»eHo¡
(
‹¡_±r
);

212 
	}
}

	@test/gtest/core/test_mc_reduce.cc

6 
	~"‹¡_mc_»duû.h
"

8 
	~"compÚ’ts/ec/ucc_ec.h
"

11 #ifdeà
HAVE_CUDA


12 
	~<cuda_ruÁime.h
>

15 
‹m¶©e
 <
ty³Çme
 
T
, 
boŞ
 
Œigg”ed
>

16 şas 
	c‹¡_mc_»duû
 : 
public
 
‹¡šg
::
Te¡
 {

17 
´Ùeùed
:

18 cÚ¡ 
COUNT
 = 1024;

19 
ucc_memÜy_ty³_t
 
mem_ty³
;

20 
ucc_“_executÜ_t
 *
executÜ
;

21 *
“_cÚ‹xt
 = 
NULL
;

23 
vœtu®
 
	$S‘Up
(è
ov”ride


25 
	`ucc_cÚ¡ruùÜ
();

26 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

27 .
th»ad_mode
 = 
UCC_THREAD_SINGLE
,

29 
ucc_ec_·¿ms_t
 
ec_·¿ms
 = {

30 .
th»ad_mode
 = 
UCC_THREAD_SINGLE
,

32 
	`ucc_mc_š™
(&
mc_·¿ms
);

33 
	`ucc_ec_š™
(&
ec_·¿ms
);

34 
buf1_h
 = 
buf2_h
 = 
»s_h
 = 
nuÎ±r
;

35 
buf1_d
 = 
buf2_d
 = 
»s_d
 = 
nuÎ±r
;

36 
executÜ
 = 
nuÎ±r
;

39 
ucc_¡©us_t
 
	$®loc_executÜ
(
ucc_memÜy_ty³_t
 
mty³
)

41 
ucc_“_executÜ_·¿ms_t
 
·¿ms
;

42 
ucc_“_ty³_t
 
cŞl_“_ty³
;

43 
ucc_¡©us_t
 
¡©us
;

45 
mty³
) {

46 
UCC_MEMORY_TYPE_CUDA
:

47 
cŞl_“_ty³
 = 
UCC_EE_CUDA_STREAM
;

48 #ifdeà
HAVE_CUDA


49 ià(
Œigg”ed
) {

50 
cudaSŒ—m_t
 
¡»am
;

51 ià(
	`cudaSŒ—mC»©eW™hFÏgs
(&
¡»am
, 
cudaSŒ—mNÚBlockšg
) !=

52 
cudaSucûss
) {

53 
¡d
::
û¼
 << "çedØü—‹ cud¨¡»am" << std::
’dl
;

54  
UCC_ERR_NO_RESOURCE
;

56 
“_cÚ‹xt
 = (*)
¡»am
;

60 
UCC_MEMORY_TYPE_CUDA_MANAGED
:

61 
cŞl_“_ty³
 = 
UCC_EE_CUDA_STREAM
;

63 
UCC_MEMORY_TYPE_HOST
:

64 
cŞl_“_ty³
 = 
UCC_EE_CPU_THREAD
;

67 
¡d
::
û¼
 << "invalidƒxecutor memype\n";

68  
UCC_ERR_INVALID_PARAM
;

71 
·¿ms
.
mask
 = 
UCC_EE_EXECUTOR_PARAM_FIELD_TYPE
;

72 
·¿ms
.
“_ty³
 = 
cŞl_“_ty³
;

73 
¡©us
 = 
	`ucc_“_executÜ_š™
(&
·¿ms
, &
executÜ
);

74 ià(
UCC_OK
 !ğ
¡©us
) {

75 
¡d
::
û¼
 << "failedo initƒxecutor: "

76 << 
	`ucc_¡©us_¡ršg
(
¡©us
è<< 
¡d
::
’dl
;

77  
¡©us
;

79 
¡©us
 = 
	`ucc_“_executÜ_¡¬t
(
executÜ
, 
“_cÚ‹xt
);

80 ià(
UCC_OK
 !ğ
¡©us
) {

81 
¡d
::
û¼
 << "failedo startƒxecutor: "

82 << 
	`ucc_¡©us_¡ršg
(
¡©us
è<< 
¡d
::
’dl
;

83 
	`ucc_“_executÜ_fš®ize
(
executÜ
);

85  
¡©us
;

86 
	}
}

88 
ucc_¡©us_t
 
	$ä“_executÜ
()

90 
ucc_¡©us_t
 
¡©us
;

92 
¡©us
 = 
	`ucc_“_executÜ_¡İ
(
executÜ
);

93 ià(
UCC_OK
 !ğ
¡©us
) {

94 
¡d
::
û¼
 << "failedo stopƒxecutor: "

95 << 
	`ucc_¡©us_¡ršg
(
¡©us
è<< 
¡d
::
’dl
;

97 
	`ucc_“_executÜ_fš®ize
(
executÜ
);

98 #ifdeà
HAVE_CUDA


99 ià(
Œigg”ed
) {

100 ià(
	`cudaSŒ—mDe¡roy
((
cudaSŒ—m_t
)
“_cÚ‹xt
è!ğ
cudaSucûss
) {

101 
¡d
::
û¼
 << "çedØde¡Üy cud¨¡»am" << std::
’dl
;

102  
UCC_ERR_NO_MESSAGE
;

104 
“_cÚ‹xt
 = 
NULL
;

107  
¡©us
;

108 
	}
}

110 
ucc_¡©us_t
 
	$£tup
(
ucc_memÜy_ty³_t
 
mty³
, 
size_t
 
n
)

112 
ucc_¡©us_t
 
¡©us
;

114 
¡©us
 = 
	`®loc_bufs
(
mty³
, 
n
);

115 ià(
UCC_OK
 !ğ
¡©us
) {

116  
¡©us
;

118  
	`®loc_executÜ
(
mty³
);

119 
	}
}

121 
ucc_¡©us_t
 
	$®loc_bufs
(
ucc_memÜy_ty³_t
 
mty³
, 
size_t
 
n
)

123 
size_t
 
n_by‹s
 = 
COUNT
*(
ty³Çme
 
T
::
ty³
);

124 
mem_ty³
 = 
mty³
;

126 
	`ucc_mc_®loc
(&
»s_h_mc_h—d”
, 
n_by‹s
, 
UCC_MEMORY_TYPE_HOST
);

127 
»s_h
 = (
ty³Çme
 
T
::
ty³
 *)
»s_h_mc_h—d”
->
addr
;

128 
	`ucc_mc_®loc
(&
buf1_h_mc_h—d”
, 
n_by‹s
, 
UCC_MEMORY_TYPE_HOST
);

129 
buf1_h
 = (
ty³Çme
 
T
::
ty³
 *)
buf1_h_mc_h—d”
->
addr
;

130 
	`ucc_mc_®loc
(&
buf2_h_mc_h—d”
, 
n
 * 
n_by‹s
, 
UCC_MEMORY_TYPE_HOST
);

131 
buf2_h
 = (
ty³Çme
 
T
::
ty³
 *)
buf2_h_mc_h—d”
->
addr
;

133 
i
 = 0; i < 
COUNT
; i++) {

134 
»s_h
[
i
] = (
ty³Çme
 
T
::
ty³
)(0);

136 
i
 = 0; i < 
COUNT
; i++) {

139 
buf1_h
[
i
] = (
ty³Çme
 
T
::
ty³
)(i + 1);

141 
j
 = 0; j < 
n
; j++) {

142 
i
 = 0; i < 
COUNT
; i++) {

143 
buf2_h
[
i
 + 
j
 * 
COUNT
] = (
ty³Çme
 
T
::
ty³
)(2 * i + j + 1);

146 ià(
mty³
 !ğ
UCC_MEMORY_TYPE_HOST
) {

147 
	`ucc_mc_®loc
(&
»s_d_mc_h—d”
, 
n_by‹s
, 
mty³
);

148 
»s_d
 = (
ty³Çme
 
T
::
ty³
 *)
»s_d_mc_h—d”
->
addr
;

149 
	`ucc_mc_®loc
(&
buf1_d_mc_h—d”
, 
n_by‹s
, 
mty³
);

150 
buf1_d
 = (
ty³Çme
 
T
::
ty³
 *)
buf1_d_mc_h—d”
->
addr
;

151 
	`ucc_mc_®loc
(&
buf2_d_mc_h—d”
, 
n
 * 
n_by‹s
, 
mty³
);

152 
buf2_d
 = (
ty³Çme
 
T
::
ty³
 *)
buf2_d_mc_h—d”
->
addr
;

153 
	`ucc_mc_memıy
(
»s_d
, 
»s_h
, 
n_by‹s
, 
mty³
, 
UCC_MEMORY_TYPE_HOST
);

154 
	`ucc_mc_memıy
(
buf1_d
, 
buf1_h
, 
n_by‹s
, 
mty³
, 
UCC_MEMORY_TYPE_HOST
);

155 
	`ucc_mc_memıy
(
buf2_d
, 
buf2_h
, 
n
 * 
n_by‹s
, 
mty³
,

156 
UCC_MEMORY_TYPE_HOST
);

157 
buf1
 = 
buf1_d
;

158 
buf2
 = 
buf2_d
;

159 
»s
 = 
»s_d
;

161 
buf1
 = 
buf1_h
;

162 
buf2
 = 
buf2_h
;

163 
»s
 = 
»s_h
;

166  
UCC_OK
;

167 
	}
}

169 
ucc_¡©us_t
 
	$ä“_bufs
(
ucc_memÜy_ty³_t
 
mty³
)

171 ià(
buf1_h
 !ğ
nuÎ±r
) {

172 
	`ucc_mc_ä“
(
buf1_h_mc_h—d”
);

174 ià(
buf2_h
 !ğ
nuÎ±r
) {

175 
	`ucc_mc_ä“
(
buf2_h_mc_h—d”
);

177 ià(
»s_h
 !ğ
nuÎ±r
) {

178 
	`ucc_mc_ä“
(
»s_h_mc_h—d”
);

180 ià(
buf1_d
 !ğ
nuÎ±r
) {

181 
	`ucc_mc_ä“
(
buf1_d_mc_h—d”
);

183 ià(
buf2_d
 !ğ
nuÎ±r
) {

184 
	`ucc_mc_ä“
(
buf2_d_mc_h—d”
);

186 ià(
»s_d
 !ğ
nuÎ±r
) {

187 
	`ucc_mc_ä“
(
»s_d_mc_h—d”
);

190  
UCC_OK
;

191 
	}
}

193 
vœtu®
 
	$T—rDown
(è
ov”ride


195 
	`ä“_bufs
(
mem_ty³
);

196 
	`ucc_mc_fš®ize
();

197 
	}
}

199 
ucc_¡©us_t
 
	$do_»duû
(*
¤c1
, *
¤c2
, *
d¡
, 
size_t
 
couÁ
,

200 
ušt16_t
 
n_¤c2
, 
size_t
 
¡ride
, 
ucc_d©©y³_t
 
dt
,

201 
ucc_»duùiÚ_İ_t
 
İ
, 
boŞ
 
w™h_®pha
, 
®pha
)

203 
ucc_“_executÜ_sk_¬gs_t
 
—rgs
;

204 
ucc_¡©us_t
 
¡©us
;

205 
ucc_“_executÜ_sk_t
 * 
sk
;

207 
—rgs
.
æags
 = 
w™h_®pha
 ? 
UCC_EEE_TASK_FLAG_REDUCE_WITH_ALPHA
 : 0;

208 
—rgs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
;

209 
—rgs
.
»duû_¡rided
.
couÁ
 = count;

210 
—rgs
.
»duû_¡rided
.
dt
 = dt;

211 
—rgs
.
»duû_¡rided
.
İ
 = op;

212 
—rgs
.
»duû_¡rided
.
n_¤c2
 =‚_src2;

213 
—rgs
.
»duû_¡rided
.
d¡
 = dst;

214 
—rgs
.
»duû_¡rided
.
¤c1
 = src1;

215 
—rgs
.
»duû_¡rided
.
¤c2
 = src2;

216 
—rgs
.
»duû_¡rided
.
¡ride
 = stride;

217 
—rgs
.
»duû_¡rided
.
®pha
 =‡lpha;

219 
¡©us
 = 
	`ucc_“_executÜ_sk_po¡
(
executÜ
, &
—rgs
, &
sk
);

220 ià(
UCC_OK
 !ğ
¡©us
) {

221 
¡d
::
û¼
 << "failedo…ostƒxecutorask: "

222 << 
	`ucc_¡©us_¡ršg
(
¡©us
è<< 
¡d
::
’dl
;

223  
¡©us
;

226 0 < (
¡©us
 = 
	`ucc_“_executÜ_sk_‹¡
(
sk
))) {

229 
	`ucc_“_executÜ_sk_fš®ize
(
sk
);

231  
¡©us
;

232 
	}
}

234 
	$‹¡_»duû
(
ucc_memÜy_ty³_t
 
mt
) {

235 
ucc_¡©us_t
 
¡©us
;

237 ià(
UCC_OK
 !ğ
	`ucc_mc_avaabË
(
mt
)) {

238 
	`GTEST_SKIP
();

240 
	`ASSERT_EQ
(
this
->
	`£tup
(
mt
, 1), 
UCC_OK
);

241 
¡©us
 = 
	`do_»duû
(
this
->
buf1
,his->
buf2
,his->
»s
,his->
COUNT
, 1, 0,

242 
T
::
dt
, T::
»dİ
, 
çl£
, 0);

243 ià(
UCC_ERR_NOT_SUPPORTED
 =ğ
¡©us
) {

244 
	`GTEST_SKIP
();

246 
	`ASSERT_EQ
(
¡©us
, 
UCC_OK
);

247 ià(
executÜ
) {

248 
	`ä“_executÜ
();

251 ià(
mt
 !ğ
UCC_MEMORY_TYPE_HOST
) {

252 
	`ucc_mc_memıy
(
this
->
»s_h
,his->
»s_d
,his->
COUNT
 * (*this->res_d),

253 
UCC_MEMORY_TYPE_HOST
, 
mt
);

255 
i
 = 0; i < 
this
->
COUNT
; i++) {

256 
T
::
	`as£¹_equ®
(T::
	`do_İ
(
this
->
buf1_h
[
i
],

257 
this
->
buf2_h
[
i
]),his->
»s_h
[i]);

259 
	}
};

261 
	$‹¡_»duû_muÉi
(
ucc_memÜy_ty³_t
 
mt
) {

262 cÚ¡ 
num_vec
 = 3;

263 
ucc_¡©us_t
 
¡©us
;

265 ià(
UCC_OK
 !ğ
	`ucc_mc_avaabË
(
mt
)) {

266 
	`GTEST_SKIP
();

268 
	`ASSERT_EQ
(
this
->
	`£tup
(
mt
, 
num_vec
), 
UCC_OK
);

269 
¡©us
 = 
	`do_»duû
(
this
->
buf1
,his->
buf2
,his->
»s
,his->
COUNT
,

270 
num_vec
, 
this
->
COUNT
 * (*this->
buf2
), 
T
::
dt
,

271 
T
::
»dİ
, 
çl£
, 0);

272 ià(
UCC_ERR_NOT_SUPPORTED
 =ğ
¡©us
) {

273 
	`GTEST_SKIP
();

275 
	`ASSERT_EQ
(
¡©us
, 
UCC_OK
);

276 ià(
executÜ
) {

277 
	`ä“_executÜ
();

280 ià(
mt
 !ğ
UCC_MEMORY_TYPE_HOST
) {

281 
	`ucc_mc_memıy
(
this
->
»s_h
,his->
»s_d
,his->
COUNT
 * (*this->res_d),

282 
UCC_MEMORY_TYPE_HOST
, 
mt
);

284 
i
 = 0; i < 
this
->
COUNT
; i++) {

285 
ty³Çme
 
T
::
ty³
 
»s
 = T::
	`do_İ
(
this
->
buf1_h
[
i
],

286 
this
->
buf2_h
[
i
]);

287 
j
 = 1; j < 
num_vec
; j++) {

288 
»s
 = 
T
::
	`do_İ
(
this
->
buf2_h
[
i
 + 
j
 *his->
COUNT
],„es);

290 
T
::
	`as£¹_equ®
(
»s
, 
this
->
»s_h
[
i
]);

292 
	}
};

294 
	$‹¡_»duû_muÉi_®pha
(
ucc_memÜy_ty³_t
 
mt
) {

295 cÚ¡ 
num_vec
 = 20;

296 cÚ¡ 
®pha
 = 0.7;

297 
ucc_¡©us_t
 
¡©us
;

299 ià(
UCC_OK
 !ğ
	`ucc_mc_avaabË
(
mt
)) {

300 
	`GTEST_SKIP
();

303 
	`ASSERT_EQ
(
UCC_OK
, 
this
->
	`£tup
(
mt
, 
num_vec
));

304 
¡©us
 = 
	`do_»duû
(
this
->
buf1
,his->
buf2
,his->
»s
,his->
COUNT
,

305 
num_vec
, 
this
->
COUNT
 * (*this->
buf2
), 
T
::
dt
,

306 
T
::
»dİ
, 
Œue
, 
®pha
);

308 ià(
UCC_ERR_NOT_SUPPORTED
 =ğ
¡©us
) {

309 
	`GTEST_SKIP
();

311 
	`ASSERT_EQ
(
¡©us
, 
UCC_OK
);

312 ià(
executÜ
) {

313 
	`ä“_executÜ
();

316 ià(
mt
 !ğ
UCC_MEMORY_TYPE_HOST
) {

317 
	`ucc_mc_memıy
(
this
->
»s_h
,his->
»s_d
,his->
COUNT
 * (*this->res_d),

318 
UCC_MEMORY_TYPE_HOST
, 
mt
);

320 
i
 = 0; i < 
this
->
COUNT
; i++) {

321 
ty³Çme
 
T
::
ty³
 
»s
 = T::
	`do_İ
(
this
->
buf1_h
[
i
],his->
buf2_h
[i]);

322 
j
 = 1; j < 
num_vec
; j++) {

323 
»s
 = 
T
::
	`do_İ
(
this
->
buf2_h
[
i
 + 
j
 *his->
COUNT
],„es);

325 ià(
T
::
dt
 =ğ
UCC_DT_BFLOAT16
) {

326 
	`æßt32tobæßt16
(
	`bæßt16toæßt32
(&
»s
)*()
®pha
, &res);

328 
»s
 *ğ(
ty³Çme
 
T
::
ty³
)
®pha
;

330 
T
::
	`as£¹_equ®
(
»s
, 
this
->
»s_h
[
i
]);

332 
	}
}

333 
ucc_mc_bufãr_h—d”_t
 *
buf1_h_mc_h—d”
, *
buf2_h_mc_h—d”
,

334 *
»s_h_mc_h—d”
, *
buf1_d_mc_h—d”
, *
buf2_d_mc_h—d”
,

335 *
»s_d_mc_h—d”
;

336 
ty³Çme
 
T
::
ty³
 *
buf1_h
;

337 
ty³Çme
 
T
::
ty³
 *
buf2_h
;

338 
ty³Çme
 
T
::
ty³
 *
»s_h
;

339 
ty³Çme
 
T
::
ty³
 *
buf1_d
;

340 
ty³Çme
 
T
::
ty³
 *
buf2_d
;

341 
ty³Çme
 
T
::
ty³
 *
»s_d
;

342 
ty³Çme
 
T
::
ty³
 *
buf1
;

343 
ty³Çme
 
T
::
ty³
 *
buf2
;

344 
ty³Çme
 
T
::
ty³
 *
»s
;

347 
	#INT_OP_PAIRS
(
_TYPE
è
	`ARITHMETIC_OP_PAIRS
(_TYPE), \

348 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
Ïnd
>, \

349 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
lÜ
>, \

350 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
lxÜ
>, \

351 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
bªd
>, \

352 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
bÜ
>, \

353 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
bxÜ
>

	)

355 
usšg
 
	gTy³OpPaœsIÁ
 = ::
‹¡šg
::
Ty³s
<
INT_OP_PAIRS
(
INT8
), INT_OP_PAIRS(
INT16
),

356 
INT_OP_PAIRS
(
INT32
), INT_OP_PAIRS(
INT64
)>;

358 
usšg
 
	gTy³OpPaœsUšt
 = ::
‹¡šg
::
Ty³s
<
INT_OP_PAIRS
(
UINT8
), INT_OP_PAIRS(
UINT16
),

359 
INT_OP_PAIRS
(
UINT32
), INT_OP_PAIRS(
UINT64
)>;

361 
usšg
 
	gTy³OpPaœsFlßt
 = ::
‹¡šg
::
Ty³s
<
ARITHMETIC_OP_PAIRS
(
FLOAT32
),

362 
ARITHMETIC_OP_PAIRS
(
FLOAT64
),

363 
ARITHMETIC_OP_PAIRS
(
FLOAT128
),

364 
ARITHMETIC_OP_PAIRS
(
BFLOAT16
),

365 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT32_COMPLEX
, 
	gsum
>,

366 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT32_COMPLEX
, 
	g´od
>,

367 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64_COMPLEX
, 
	gsum
>,

368 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64_COMPLEX
, 
	g´od
>,

369 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT128_COMPLEX
, 
	gsum
>,

370 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT128_COMPLEX
, 
	g´od
>,

371 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT32
, 
	gavg
>,

372 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64
, 
	gavg
>,

373 
	gTy³OpPaœ
<
	gUCC_DT_BFLOAT16
, 
	gavg
>>;

375 
usšg
 
	gTy³OpPaœsFlßtCuda
 = ::
‹¡šg
::
Ty³s
<

376 
ARITHMETIC_OP_PAIRS
(
FLOAT32
), ARITHMETIC_OP_PAIRS(
FLOAT64
),

377 
ARITHMETIC_OP_PAIRS
(
BFLOAT16
), 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT32_COMPLEX
, 
	gsum
>,

378 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT32_COMPLEX
, 
	g´od
>,

379 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64_COMPLEX
, 
	gsum
>,

380 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64_COMPLEX
, 
	g´od
>, Ty³OpPaœ<
	gUCC_DT_FLOAT32
, 
	gavg
>,

381 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64
, 
	gavg
>, Ty³OpPaœ<
	gUCC_DT_BFLOAT16
,‡vg>>;

383 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

384 
şass
 
	g‹¡_mc_»duû_št
 : 
public
 
‹¡_mc_»duû
<
T
, 
	gçl£
> {};

385 
TYPED_TEST_CASE
(
‹¡_mc_»duû_št
, 
Ty³OpPaœsIÁ
);

387 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

388 
şass
 
	g‹¡_mc_»duû_ušt
 : 
public
 
‹¡_mc_»duû
<
T
, 
	gçl£
> {};

389 
TYPED_TEST_CASE
(
‹¡_mc_»duû_ušt
, 
Ty³OpPaœsUšt
);

391 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

392 
şass
 
	g‹¡_mc_»duû_æßt
 : 
public
 
‹¡_mc_»duû
<
T
, 
	gçl£
> {};

393 
TYPED_TEST_CASE
(
‹¡_mc_»duû_æßt
, 
Ty³OpPaœsFlßt
);

395 
	#DECLARE_REDUCE_TEST
(
_ty³
, 
_mt
) \

396 
	`TYPED_TEST
(
‹¡_mc_»duû_
 ## 
_ty³
, 
_mt
) { \

397 
this
->
	`‹¡_»duû
(
UCC_MEMORY_TYPE_
 ## 
_mt
); \

399 

	)

400 
	#DECLARE_REDUCE_MULTI_TEST
(
_ty³
, 
_mt
) \

401 
	`TYPED_TEST
(
‹¡_mc_»duû_
 ## 
_ty³
, 
muÉi_
 ## 
_mt
) { \

402 
this
->
	`‹¡_»duû_muÉi
(
UCC_MEMORY_TYPE_
 ## 
_mt
); \

404 

	)

405 
	#DECLARE_REDUCE_MULTI_ALPHA_TEST
(
_ty³
, 
_mt
) \

406 
	`TYPED_TEST
(
‹¡_mc_»duû_
 ## 
_ty³
, 
muÉi_®pha_
 ## 
_mt
) { \

407 
this
->
	`‹¡_»duû_muÉi_®pha
(
UCC_MEMORY_TYPE_
 ## 
_mt
); \

409 

	)

410 
DECLARE_REDUCE_TEST
(, 
HOST
);

411 
DECLARE_REDUCE_TEST
(
ušt
, 
HOST
);

412 
DECLARE_REDUCE_TEST
(, 
HOST
);

414 
DECLARE_REDUCE_MULTI_TEST
(, 
HOST
);

415 
DECLARE_REDUCE_MULTI_TEST
(
ušt
, 
HOST
);

416 
DECLARE_REDUCE_MULTI_TEST
(, 
HOST
);

418 
DECLARE_REDUCE_MULTI_ALPHA_TEST
(, 
HOST
);

420 #ifdeà
HAVE_CUDA


421 
DECLARE_REDUCE_TEST
(, 
CUDA
);

422 
DECLARE_REDUCE_TEST
(
ušt
, 
CUDA
);

423 
DECLARE_REDUCE_TEST
(, 
CUDA
);

425 
DECLARE_REDUCE_MULTI_TEST
(, 
CUDA
);

426 
DECLARE_REDUCE_MULTI_TEST
(
ušt
, 
CUDA
);

427 
DECLARE_REDUCE_MULTI_TEST
(, 
CUDA
);

429 
DECLARE_REDUCE_MULTI_ALPHA_TEST
(, 
CUDA
);

431 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

432 
şass
 
	g‹¡_mc_»duû_št_Œigg”ed
 : 
public
 
‹¡_mc_»duû
<
T
, 
	gŒue
> {};

433 
TYPED_TEST_CASE
(
‹¡_mc_»duû_št_Œigg”ed
, 
Ty³OpPaœsIÁ
);

435 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

436 
şass
 
	g‹¡_mc_»duû_ušt_Œigg”ed
 : 
public
 
‹¡_mc_»duû
<
T
, 
	gŒue
> {};

437 
TYPED_TEST_CASE
(
‹¡_mc_»duû_ušt_Œigg”ed
, 
Ty³OpPaœsUšt
);

439 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

440 
şass
 
	g‹¡_mc_»duû_æßt_Œigg”ed
 : 
public
 
‹¡_mc_»duû
<
T
, 
	gŒue
> {};

441 
TYPED_TEST_CASE
(
‹¡_mc_»duû_æßt_Œigg”ed
, 
Ty³OpPaœsFlßtCuda
);

443 
DECLARE_REDUCE_TEST
(
št_Œigg”ed
, 
CUDA
);

444 
DECLARE_REDUCE_TEST
(
ušt_Œigg”ed
, 
CUDA
);

445 
DECLARE_REDUCE_TEST
(
æßt_Œigg”ed
, 
CUDA
);

447 
DECLARE_REDUCE_MULTI_TEST
(
št_Œigg”ed
, 
CUDA
);

448 
DECLARE_REDUCE_MULTI_TEST
(
ušt_Œigg”ed
, 
CUDA
);

449 
DECLARE_REDUCE_MULTI_TEST
(
æßt_Œigg”ed
, 
CUDA
);

451 
DECLARE_REDUCE_MULTI_ALPHA_TEST
(
æßt_Œigg”ed
, 
CUDA
);

	@test/gtest/core/test_mc_reduce.h

7 
	~<compÚ’ts/mc/ucc_mc.h
>

8 
	~<uts/ucc_m©h.h
>

10 
	~<commÚ/‹¡.h
>

12 
‹m¶©e
<
ucc_d©©y³_t
,em¶©<
ty³Çme
 
P
> 
şass
 
İ
>

13 
Ty³OpPaœ
;

15 
	#DECLARE_TYPE_OP_PAIR
(
_ty³
, 
_TYPE
, 
_EQ
) \

16 
‹m¶©e
<‹m¶©<
ty³Çme
 
P
> 
şass
 
İ
> \

17 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
İ
> \

19 
usšg
 
ty³
 = 
_ty³
; \

20 cÚ¡ 
ucc_d©©y³_t
 
dt
 = 
UCC_DT_
 ## 
_TYPE
; \

21 cÚ¡ 
ucc_»duùiÚ_İ_t
 
»dİ
 = 
İ
<
ty³
>::redop; \

22 
	`as£¹_equ®
(
ty³
 
¬g1
,y³ 
¬g2
) { \

23 
	`_EQ
(
¬g1
, 
¬g2
); \

25 
ty³
 
	`do_İ
Ñy³ 
¬g1
,y³ 
¬g2
) { \

26 
İ
<
ty³
> 
_İ
; \

27  
	`_İ
(
¬g1
, 
¬g2
); \

29 };

	)

31 
DECLARE_TYPE_OP_PAIR
(
št8_t
, 
INT8
, 
ASSERT_EQ
);

32 
DECLARE_TYPE_OP_PAIR
(
št16_t
, 
INT16
, 
ASSERT_EQ
);

33 
DECLARE_TYPE_OP_PAIR
(
št32_t
, 
INT32
, 
ASSERT_EQ
);

34 
DECLARE_TYPE_OP_PAIR
(
št64_t
, 
INT64
, 
ASSERT_EQ
);

35 
DECLARE_TYPE_OP_PAIR
(
ušt8_t
, 
UINT8
, 
ASSERT_EQ
);

36 
DECLARE_TYPE_OP_PAIR
(
ušt16_t
, 
UINT16
, 
ASSERT_EQ
);

37 
DECLARE_TYPE_OP_PAIR
(
ušt32_t
, 
UINT32
, 
ASSERT_EQ
);

38 
DECLARE_TYPE_OP_PAIR
(
ušt64_t
, 
UINT64
, 
ASSERT_EQ
);

41 
DECLARE_TYPE_OP_PAIR
(, 
FLOAT32
, 
ASSERT_FLOAT_EQ
);

42 
DECLARE_TYPE_OP_PAIR
(, 
FLOAT64
, 
ASSERT_FLOAT_EQ
);

43 
DECLARE_TYPE_OP_PAIR
(, 
FLOAT128
, 
ASSERT_FLOAT_EQ
);

45 
DECLARE_TYPE_OP_PAIR
(
_Com¶ex
, 
FLOAT32_COMPLEX
,

46 
ASSERT_FLOAT32_COMPLEX_EQ
);

47 
DECLARE_TYPE_OP_PAIR
(
_Com¶ex
, 
FLOAT64_COMPLEX
,

48 
ASSERT_FLOAT64_COMPLEX_EQ
);

49 
DECLARE_TYPE_OP_PAIR
(
_Com¶ex
, 
FLOAT128_COMPLEX
,

50 
ASSERT_FLOAT128_COMPLEX_EQ
);

52 
	g‹m¶©e
 <‹m¶©<
ty³Çme
 
	gP
> 
şass
 
	gİ
>

53 
	gTy³OpPaœ
<
	gUCC_DT_BFLOAT16
, 
	gİ
> {

54 
usšg
 
	gty³
 = 
ušt16_t
;

55 cÚ¡ 
ucc_d©©y³_t
 
	gdt
 = 
UCC_DT_BFLOAT16
;

56 cÚ¡ 
ucc_»duùiÚ_İ_t
 
	g»dİ
 = 
İ
<>::
»dİ
;

57 
as£¹_equ®
(
ty³
 
¬g1
,y³ 
¬g2
)

64 
ASSERT_NEAR
(
bæßt16toæßt32
(&
¬g1
), bæßt16toæßt32(&
¬g2
),

67 
ty³
 
do_İ
Ñy³ 
¬g1
,y³ 
¬g2
)

69 
	gİ
<> 
	g_İ
;

70 
ušt16_t
 
	g»s
;

71 
æßt32tobæßt16
(

72 
_İ
(
bæßt16toæßt32
(&
¬g1
), bæßt16toæßt32(&
¬g2
)), &
»s
);

73  
	g»s
;

77 
	#DECLARE_OP_
(
_İ
, 
_UCC_OP
, 
_OP
) \

78 
‹m¶©e
<
ty³Çme
 
T
> \

79 şas 
	c_İ
 { \

80 
public
: \

81 cÚ¡ 
ucc_»duùiÚ_İ_t
 
»dİ
 = 
UCC_OP_
 ## 
_UCC_OP
; \

82 
T
 
	$İ”©Ü
()(
T
 
¬g1
, T 
¬g2
) { \

83  
DO_OP_
 ## 
	`_OP
(
¬g1
, 
¬g2
); \

85 
	}
}; \

86 

	)

87 
	#DECLARE_OP
(
_İ
, 
_OP
è
	`DECLARE_OP_
(_İ, _OP, _OP)

	)

89 
DECLARE_OP
(
sum
, 
SUM
);

90 
DECLARE_OP
(
´od
, 
PROD
);

91 
DECLARE_OP
(
mš
, 
MIN
);

92 
DECLARE_OP
(
max
, 
MAX
);

93 
DECLARE_OP
(
Ïnd
, 
LAND
);

94 
DECLARE_OP
(
lÜ
, 
LOR
);

95 
DECLARE_OP
(
lxÜ
, 
LXOR
);

96 
DECLARE_OP
(
bªd
, 
BAND
);

97 
DECLARE_OP
(
bÜ
, 
BOR
);

98 
DECLARE_OP
(
bxÜ
, 
BXOR
);

99 
DECLARE_OP_
(
avg
, 
AVG
, 
SUM
);

101 
	#ARITHMETIC_OP_PAIRS
(
_TYPE
è
Ty³OpPaœ
<
UCC_DT_
 ## _TYPE, 
sum
>, \

102 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
´od
>, \

103 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
mš
>, \

104 
Ty³OpPaœ
<
UCC_DT_
 ## 
_TYPE
, 
max
>

	)

107 
	#CUDA_OP_PAIRS
 \

108 
Ty³OpPaœ
<
UCC_DT_INT16
, 
lÜ
>, Ty³OpPaœ<UCC_DT_INT16, 
sum
>, \

109 
Ty³OpPaœ
<
UCC_DT_INT32
, 
´od
>, Ty³OpPaœ<
UCC_DT_INT64
, 
bxÜ
>, \

110 
Ty³OpPaœ
<
UCC_DT_UINT16
, 
lÜ
>, Ty³OpPaœ<UCC_DT_UINT16, 
sum
>, \

111 
Ty³OpPaœ
<
UCC_DT_UINT32
, 
´od
>, Ty³OpPaœ<
UCC_DT_UINT64
, 
bxÜ
>, \

112 
Ty³OpPaœ
<
UCC_DT_FLOAT32
, 
avg
>, Ty³OpPaœ<
UCC_DT_FLOAT64
,‡vg>, \

113 
	`ARITHMETIC_OP_PAIRS
(
INT32
), ARITHMETIC_OP_PAIRS(
FLOAT32
), \

114 
	`ARITHMETIC_OP_PAIRS
(
FLOAT64
), ARITHMETIC_OP_PAIRS(
BFLOAT16
), \

115 
Ty³OpPaœ
<
UCC_DT_FLOAT32_COMPLEX
, 
sum
>, \

116 
Ty³OpPaœ
<
UCC_DT_FLOAT32_COMPLEX
, 
´od
>, \

117 
Ty³OpPaœ
<
UCC_DT_FLOAT32_COMPLEX
, 
avg
>, \

118 
Ty³OpPaœ
<
UCC_DT_FLOAT64_COMPLEX
, 
sum
>, \

119 
Ty³OpPaœ
<
UCC_DT_FLOAT64_COMPLEX
, 
´od
>, \

120 
Ty³OpPaœ
<
UCC_DT_FLOAT64_COMPLEX
, 
avg
>

	)

122 
usšg
 
	gCŞlReduûTy³OpsCuda
 = ::
‹¡šg
::
Ty³s
<
CUDA_OP_PAIRS
>;

125 
usšg
 
	gCŞlReduûTy³OpsHo¡
 = ::
‹¡šg
::
Ty³s
<

126 
CUDA_OP_PAIRS
, 
	gTy³OpPaœ
<
	gUCC_DT_UINT16
, 
	gbªd
>,

127 
	gTy³OpPaœ
<
	gUCC_DT_UINT32
, 
	gbÜ
>, Ty³OpPaœ<
	gUCC_DT_UINT64
, 
	gÏnd
>,

128 
	gTy³OpPaœ
<
	gUCC_DT_UINT8
, 
	glxÜ
>, Ty³OpPaœ<
	gUCC_DT_INT8
, 
	glÜ
>,

129 
ARITHMETIC_OP_PAIRS
(
FLOAT128
), 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT128_COMPLEX
, 
	gsum
>,

130 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT128_COMPLEX
, 
	g´od
>>;

132 
usšg
 
	gCŞlReduûTy³OpsAvg
 = ::
‹¡šg
::
Ty³s
<

133 
Ty³OpPaœ
<
UCC_DT_FLOAT32
, 
	gavg
>, 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64
,‡vg>,

134 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT128
, 
	gavg
>, Ty³OpPaœ<
	gUCC_DT_FLOAT32_COMPLEX
,‡vg>,

135 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT64_COMPLEX
, 
	gavg
>,

136 
	gTy³OpPaœ
<
	gUCC_DT_FLOAT128_COMPLEX
, 
	gavg
>, Ty³OpPaœ<
	gUCC_DT_BFLOAT16
,‡vg>>;

138 
šlše
 
boŞ
 
	$ucc_»duùiÚ_is_suµÜ‹d
(
ucc_d©©y³_t
 
dt
,

139 
ucc_»duùiÚ_İ_t
 
İ
,

140 
ucc_memÜy_ty³_t
 
mt
)

142 ià((
mt
 !ğ
UCC_MEMORY_TYPE_HOST
) &&

143 ((
dt
 =ğ
UCC_DT_FLOAT128
è|| (dˆ=ğ
UCC_DT_FLOAT128_COMPLEX
))) {

144  
çl£
;

146 
İ
) {

147 
UCC_OP_MIN
:

148 
UCC_OP_MAX
:

149 
dt
) {

150 
UCC_DT_FLOAT32_COMPLEX
:

151 
UCC_DT_FLOAT64_COMPLEX
:

152 
UCC_DT_FLOAT128_COMPLEX
:

153  
çl£
;

157 
UCC_OP_AVG
:

158 
dt
) {

159 
UCC_DT_FLOAT32
:

160 
UCC_DT_FLOAT64
:

161 
UCC_DT_FLOAT32_COMPLEX
:

162 
UCC_DT_FLOAT64_COMPLEX
:

163 
UCC_DT_BFLOAT16
:

164 
UCC_DT_FLOAT128
:

165 
UCC_DT_FLOAT128_COMPLEX
:

168  
çl£
;

174  
Œue
;

175 
	}
}

177 
	#CHECK_TYPE_OP_SKIP
(
_dt
, 
_İ
, 
_mt
) do { \

178 ià(!
	`ucc_»duùiÚ_is_suµÜ‹d
(
_dt
, 
_İ
, 
_mt
)) { \

179 
	`GTEST_SKIP
(); \

181 } 0)

	)

	@test/gtest/core/test_mc_rocm.cc

8 
	~<compÚ’ts/mc/ucc_mc.h
>

9 
	~<±h»ad.h
>

11 
	~<commÚ/‹¡.h
>

12 
	~<h/h_ruÁime.h
>

13 
	~<veùÜ
>

15 *
	$mt_ucc_mc_rocm_®locs
(*
¬gs
)

22 
quªtif›r
 = 2;

23 
size_t
 
size
 = 4;

24 
num_of_®locs
 = 40;

25 
¡d
::
veùÜ
<
ucc_mc_bufãr_h—d”_t
 *> 
h—d”s
;

26 
¡d
::
veùÜ
<*> 
poš‹rs
;

27 
h—d”s
.
	`»size
(
num_of_®locs
);

28 
poš‹rs
.
	`»size
(
num_of_®locs
);

30 
i
 = 0; i < 
num_of_®locs
; i++) {

31 
	`EXPECT_EQ
(
UCC_OK
,

32 
	`ucc_mc_®loc
(&
h—d”s
[
i
], 
size
, 
UCC_MEMORY_TYPE_ROCM
));

33 
poš‹rs
[
i
] = 
h—d”s
[i]->
addr
;

34 
	`EXPECT_EQ
(
hSucûss
, 
	`hMem£t
(
poš‹rs
[
i
], 0, 
size
));

35 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_ä“
(
h—d”s
[
i
]));

36 ià(
i
 % 2) {

37 
size
 *ğ
quªtif›r
;

41 
	}
}

43 şas 
	c‹¡_mc_rocm
 : 
public
 
ucc
::
‹¡
 {

44 
´Ùeùed
:

45 cÚ¡ 
TEST_ALLOC_SIZE
 = 1024;

46 
ucc_mc_bufãr_h—d”_t
 *
mc_h—d”
;

47 * 
‹¡_±r
;

48 
ucc_memÜy_ty³_t
 
‹¡_mty³
;

49 
	$Te¡MCRocmS‘Up
(
ucc_mc_·¿ms_t
 
mc_·¿ms
)

51 
ucc
::
‹¡
::
	`S‘Up
();

52 
	`ucc_cÚ¡ruùÜ
();

53 
	`ucc_mc_š™
(&
mc_·¿ms
);

54 
‹¡_±r
 = 
NULL
;

55 
‹¡_mty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

57 
vœtu®
 
	$S‘Up
(è
ov”ride


59 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

60 .
th»ad_mode
 = 
UCC_THREAD_SINGLE
,

62 
	`Te¡MCRocmS‘Up
(
mc_·¿ms
);

63 
	}
}

64 
vœtu®
 
	$T—rDown
(è
ov”ride


66 
	`ucc_mc_fš®ize
();

67 
ucc
::
‹¡
::
	`T—rDown
();

68 
	}
}

71 şas 
	c‹¡_mc_rocm_mt
 : 
public
 
‹¡_mc_rocm
 {

72 
´Ùeùed
:

73 
vœtu®
 
	$S‘Up
(è
ov”ride


75 
ucc_mc_·¿ms_t
 
mc_·¿ms
 = {

76 .
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
,

78 
	`Te¡MCRocmS‘Up
(
mc_·¿ms
);

80 
	}
};

82 
	$UCC_TEST_F
(
‹¡_mc_rocm
, 
mc_rocm_lßd
)

84 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_avaabË
(
UCC_MEMORY_TYPE_ROCM
));

85 
	}
}

87 
	$UCC_TEST_F
(
‹¡_mc_rocm
, 
ÿn_®loc_ªd_ä“_mem
)

90 
	`EXPECT_EQ
(
UCC_OK
,

91 
	`ucc_mc_®loc
(&
mc_h—d”
, 
TEST_ALLOC_SIZE
, 
UCC_MEMORY_TYPE_ROCM
));

92 
‹¡_±r
 = 
mc_h—d”
->
addr
;

93 
	`EXPECT_EQ
(
hSucûss
, 
	`hMem£t
(
‹¡_±r
, 0, 
TEST_ALLOC_SIZE
));

94 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_ä“
(
mc_h—d”
));

95 
	}
}

98 
	$UCC_TEST_F
(
‹¡_mc_rocm_mt
, 
DISABLED_ÿn_®loc_ªd_ä“_mem_mt
)

101 
num_of_th»ads
 = 10;

102 
¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

103 
th»ads
.
	`»size
(
num_of_th»ads
);

105 
i
 = 0; i < 
num_of_th»ads
; i++) {

106 
	`±h»ad_ü—‹
(&
th»ads
[
i
], 
NULL
, &
mt_ucc_mc_rocm_®locs
, NULL);

108 
i
 = 0; i < 
num_of_th»ads
; i++) {

109 
	`±h»ad_još
(
th»ads
[
i
], 
NULL
);

111 
	}
}

113 
	$UCC_TEST_F
(
‹¡_mc_rocm
, 
ÿn_d‘eù_ho¡_mem
)

115 
ucc_mem_©Œ_t
 
mem_©Œ
;

117 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

118 
‹¡_±r
 = 
	`m®loc
(
TEST_ALLOC_SIZE
);

119 ià(
‹¡_±r
 =ğ
NULL
) {

120 
	`ADD_FAILURE
() << "failedo‡llocate host memory";

122 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

123 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_HOST
, 
mem_©Œ
.
mem_ty³
);

124 
	`ä“
(
‹¡_±r
);

125 
	}
}

127 
	$UCC_TEST_F
(
‹¡_mc_rocm
, 
ÿn_d‘eù_rocm_mem
)

129 
ucc_mem_©Œ_t
 
mem_©Œ
;

130 
hE¼Ü_t
 
¡
;

132 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

133 
¡
 = 
	`hM®loc
(&
‹¡_±r
, 
TEST_ALLOC_SIZE
);

134 ià(
¡
 !ğ
hSucûss
) {

135 
	`ADD_FAILURE
() << "failedo‡llocate device memory";

137 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

138 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_ROCM
, 
mem_©Œ
.
mem_ty³
);

139 
¡
 = 
	`hF»e
(
‹¡_±r
);

140 ià(
¡
 !ğ
hSucûss
) {

141 
	`ADD_FAILURE
() << "failedo free device memory";

143 
	`ucc_mc_fš®ize
();

144 
	}
}

146 
	$UCC_TEST_F
(
‹¡_mc_rocm
, 
ÿn_qu”y_rocm_mem
)

148 
ucc_mem_©Œ_t
 
mem_©Œ
;

149 
hE¼Ü_t
 
¡
;

150 *
±r
;

152 
¡
 = 
	`hM®loc
(&
‹¡_±r
, 
TEST_ALLOC_SIZE
);

153 ià(
¡
 !ğ
hSucûss
) {

154 
	`ADD_FAILURE
() << "failedo‡llocate device memory";

157 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

158 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

159 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_ROCM
, 
mem_©Œ
.
mem_ty³
);

162 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
 |

163 
UCC_MEM_ATTR_FIELD_BASE_ADDRESS
 |

164 
UCC_MEM_ATTR_FIELD_ALLOC_LENGTH
;

165 
mem_©Œ
.
®loc_Ëngth
 = 1;

166 
±r
 = (*)
‹¡_±r
 + 
TEST_ALLOC_SIZE
/2;

167 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
±r
, &
mem_©Œ
));

168 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_ROCM
, 
mem_©Œ
.
mem_ty³
);

169 
	`EXPECT_EQ
(
‹¡_±r
, 
mem_©Œ
.
ba£_add»ss
);

170 
	`EXPECT_EQ
(
TEST_ALLOC_SIZE
, 
mem_©Œ
.
®loc_Ëngth
);

172 
¡
 = 
	`hF»e
(
‹¡_±r
);

173 ià(
¡
 !ğ
hSucûss
) {

174 
	`ADD_FAILURE
() << "failedo free device memory";

176 
	`ucc_mc_fš®ize
();

177 
	}
}

179 
	$UCC_TEST_F
(
‹¡_mc_rocm
, 
ÿn_d‘eù_mªaged_mem
)

181 
hE¼Ü_t
 
¡
;

182 
ucc_mem_©Œ_t
 
mem_©Œ
;

184 
¡
 = 
	`hM®locMªaged
(&
‹¡_±r
, 
TEST_ALLOC_SIZE
);

185 ià(
¡
 !ğ
hSucûss
) {

186 
	`ADD_FAILURE
() << "failedo‡llocate managed memory";

188 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

189 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

190 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_ROCM_MANAGED
, 
mem_©Œ
.
mem_ty³
);

191 
¡
 = 
	`hF»e
(
‹¡_±r
);

192 ià(
¡
 !ğ
hSucûss
) {

193 
	`ADD_FAILURE
() << "failedo free managed memory";

195 
	}
}

197 
	$UCC_TEST_F
(
‹¡_mc_rocm
, 
ÿn_d‘eù_ho¡_®loc_mem
)

199 
hE¼Ü_t
 
¡
;

200 
ucc_mem_©Œ_t
 
mem_©Œ
;

202 
¡
 = 
	`hHo¡M®loc
(&
‹¡_±r
, 
TEST_ALLOC_SIZE
, 
hHo¡M®locDeçuÉ
);

203 ià(
¡
 !ğ
hSucûss
) {

204 
	`ADD_FAILURE
() << "failedo‡llocate host mapped memory";

206 
mem_©Œ
.
f›ld_mask
 = 
UCC_MEM_ATTR_FIELD_MEM_TYPE
;

207 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_mc_g‘_mem_©Œ
(
‹¡_±r
, &
mem_©Œ
));

208 
	`EXPECT_EQ
(
UCC_MEMORY_TYPE_HOST
, 
mem_©Œ
.
mem_ty³
);

209 
¡
 = 
	`hF»eHo¡
(
‹¡_±r
);

210 ià(
¡
 !ğ
hSucûss
) {

211 
	`ADD_FAILURE
() << "failedo free host mapped memory";

213 
	}
}

	@test/gtest/core/test_schedule.cc

6 
	~<commÚ/‹¡.h
>

8 
	~"scheduË/ucc_scheduË.h
"

11 şas 
	c‹¡_cŞl_sk
 : 
public
 
ucc_cŞl_sk_t
 {

12 
public
:

13 
	$‹¡_cŞl_sk
() {

14 
	`ucc_cŞl_sk_cÚ¡ruù
(
this
);

15 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cŞl_sk_š™
((
ucc_cŞl_sk_t
 *)
this
, 
NULL
, NULL));

17 ~
	$‹¡_cŞl_sk
() {

18 
	`ucc_cŞl_sk_de¡ruù
(
this
);

19 
	}
}

22 
	g¡d
::
	ttu¶e
<
	t‹¡_cŞl_sk
*, > 
	tr¡_t
;

25 
şass
 
	g‹¡_scheduË
 : 
public
 
‹¡_cŞl_sk
,…ubliø
	gucc
::
‹¡


27 
public
:

28 
¡d
::
veùÜ
<
r¡_t
> 
r¡
;

29 
ucc_¡©us_t
 
hªdËr_1
(
ucc_cŞl_sk_t
 *
·»Á
,

30 
ucc_cŞl_sk_t
 *
sk
) {

31 
‹¡_scheduË
 *
	gts
 = (‹¡_scheduË*)
sk
;

32 
	gts
->
	gr¡
.
push_back
(
r¡_t
((
‹¡_cŞl_sk
*)
·»Á
, 1));

33  
	gUCC_OK
;

35 
ucc_¡©us_t
 
hªdËr_2
(
ucc_cŞl_sk_t
 *
·»Á
,

36 
ucc_cŞl_sk_t
 *
sk
) {

37 
‹¡_scheduË
 *
	gts
 = (‹¡_scheduË*)
sk
;

38 
	gts
->
	gr¡
.
push_back
(
r¡_t
((
‹¡_cŞl_sk
*)
·»Á
, 2));

39  
	gUCC_OK
;

45 
	$UCC_TEST_F
(
‹¡_scheduË
, 
sšgË_hªdËr
)

47 
¡d
::
veùÜ
<
‹¡_cŞl_sk
> 
	`sks
(2);

49 autØ&
t
 : 
sks
) {

50 
	`ucc_ev’t_mªag”_subsüibe
(&
t
, 
UCC_EVENT_COMPLETED
,

51 (
ucc_cŞl_sk_t
*)
this
,

52 
‹¡_scheduË
::
hªdËr_1
);

55 autØ&
t
 : 
sks
) {

56 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_ev’t_mªag”_nÙify
(&
t
, 
UCC_EVENT_COMPLETED
));

58 
	`EXPECT_EQ
(2, 
r¡
.
	`size
());

59 
	`EXPECT_EQ
(
Œue
, (
¡d
::
g‘
<0>(
r¡
[0]è=ğ&
sks
[0]) &&

60 (
¡d
::
g‘
<1>(
r¡
[0]) == 1));

61 
	`EXPECT_EQ
(
Œue
, (
¡d
::
g‘
<0>(
r¡
[1]è=ğ&
sks
[1]) &&

62 (
¡d
::
g‘
<1>(
r¡
[1]) == 1));

63 
	}
}

67 
	$UCC_TEST_F
(
‹¡_scheduË
, 
difã»Á_hªdËrs
)

69 
¡d
::
veùÜ
<
‹¡_cŞl_sk
> 
	`sks
(2);

71 
	`ucc_ev’t_mªag”_subsüibe
(&
sks
[0], 
UCC_EVENT_COMPLETED
,

72 (
ucc_cŞl_sk_t
*)
this
,

73 
‹¡_scheduË
::
hªdËr_1
);

74 
	`ucc_ev’t_mªag”_subsüibe
(&
sks
[1], 
UCC_EVENT_COMPLETED
,

75 (
ucc_cŞl_sk_t
*)
this
,

76 
‹¡_scheduË
::
hªdËr_2
);

78 autØ&
t
 : 
sks
) {

79 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_ev’t_mªag”_nÙify
(&
t
, 
UCC_EVENT_COMPLETED
));

82 
	`EXPECT_EQ
(2, 
r¡
.
	`size
());

83 
	`EXPECT_EQ
(
Œue
, (
¡d
::
g‘
<0>(
r¡
[0]è=ğ&
sks
[0]) &&

84 (
¡d
::
g‘
<1>(
r¡
[0]) == 1));

85 
	`EXPECT_EQ
(
Œue
, (
¡d
::
g‘
<0>(
r¡
[1]è=ğ&
sks
[1]) &&

86 (
¡d
::
g‘
<1>(
r¡
[1]) == 2));

87 
	}
}

90 
	$UCC_TEST_F
(
‹¡_scheduË
, 
muÉË
)

92 cÚ¡ 
n_subsüib”s
 = 16;

93 
¡d
::
veùÜ
<
‹¡_cŞl_sk
> 
	`sks
(
n_subsüib”s
);

95 
i
 = 0; i < 
n_subsüib”s
; i++) {

96 
	`ucc_ev’t_mªag”_subsüibe
(&
sks
[
i
], 
UCC_EVENT_COMPLETED
,

97 (
ucc_cŞl_sk_t
*)
this
,

98 ((
i
 % 2è=ğ0 ? 
‹¡_scheduË
::
hªdËr_1


99 : 
‹¡_scheduË
::
hªdËr_2
));

102 autØ&
t
 : 
sks
) {

103 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_ev’t_mªag”_nÙify
(&
t
, 
UCC_EVENT_COMPLETED
));

106 
	`EXPECT_EQ
(
n_subsüib”s
, 
r¡
.
	`size
());

107 
i
 = 0; i < 
n_subsüib”s
; i++) {

108 
	`EXPECT_EQ
(
Œue
, (
¡d
::
g‘
<0>(
r¡
[
i
]è=ğ&
sks
[i]) &&

109 (
¡d
::
g‘
<1>(
r¡
[
i
]) == ((i % 2) + 1)));

111 
	}
}

	@test/gtest/core/test_service_coll.cc

5 
	~<commÚ/‹¡.h
>

6 
	~<commÚ/‹¡_ucc.h
>

7 
	~<veùÜ
>

10 
	~"cÜe/ucc_‹am.h
"

11 
	~"cÜe/ucc_£rviû_cŞl.h
"

14 şas 
	c‹¡_£rviû_cŞl
 {

15 
public
:

16 * 
¬¿y
;

17 
UccT—m_h
 
‹am
;

18 
¡d
::
veùÜ
<
ucc_sub£t_t
> 
sub£ts
;

19 
¡d
::
veùÜ
<
ucc_£rviû_cŞl_»q_t
 *> 
»qs
;

20 
‹¡_£rviû_cŞl
(
¡d
::
veùÜ
<> 
_sub£t
, 
UccT—m_h
 
_‹am
)

22 
‹am
 = 
_‹am
;

23 
¬¿y
 = 
Ãw
 [
_sub£t
.
size
()];

24 
memıy
(
¬¿y
, 
_sub£t
.
d©a
(), (è* _sub£t.
size
());

25 
sub£ts
.
»size
(
_sub£t
.
size
());

26 
»qs
.
»size
(
_sub£t
.
size
());

27 autØ
i
 = 0; i < 
_sub£t
.
size
(); i++) {

28 
sub£ts
[
i
].
my¿nk
 = i;

29 
sub£ts
[
i
].
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

30 
sub£ts
[
i
].
m­
.
¬¿y
.map = (*)array;

31 
sub£ts
[
i
].
m­
.
¬¿y
.
–em_size
 = ();

32 
sub£ts
[
i
].
m­
.
•_num
 = 
_sub£t
.
size
();

35 ~
	$‹¡_£rviû_cŞl
()

37 
d–‘e
[] 
¬¿y
;

38 
	}
}

39 
	$´og»ss
()

41 autØ
i
 = 0; i < 
»qs
.
	`size
(); i++) {

42 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
	`g‘
()->
´ocs
[
¬¿y
[
i
]].
p
->
ùx_h
);

44 
	}
}

45 
	$wa™
()

47 
ucc_¡©us_t
 
¡©us
;

48 
boŞ
 
»ady
;

50 
»ady
 = 
Œue
;

51 
	`´og»ss
();

52 autØ&
r
 : 
»qs
) {

53 
¡©us
 = 
	`ucc_£rviû_cŞl_‹¡
(
r
);

54 
	`EXPECT_GE
(
¡©us
, 0);

55 ià(
UCC_INPROGRESS
 =ğ
¡©us
) {

56 
»ady
 = 
çl£
;

59 } !
»ady
);

60 autØ&
r
 : 
»qs
) {

61 
	`ucc_£rviû_cŞl_fš®ize
(
r
);

63 
	}
}

66 şas 
	c‹¡_£rviû_®Ìeduû
 : 
public
 
‹¡_£rviû_cŞl
 {

67 
¡d
::
veùÜ
<¡d::veùÜ<>> 
sbuf
;

68 
	m¡d
::
veùÜ
<
¡d
::veùÜ<>> 
rbuf
;

70 
	mpublic
:

71 
‹¡_£rviû_®Ìeduû
(
¡d
::
veùÜ
<> 
_sub£t
, 
size_t
 
couÁ
,

72 
UccT—m_h
 
_‹am
)

73 : 
	$‹¡_£rviû_cŞl
(
_sub£t
, 
_‹am
)

75 
sbuf
.
	`»size
(
_sub£t
.
	`size
());

76 
rbuf
.
	`»size
(
_sub£t
.
	`size
());

77 autØ
i
 = 0; i < 
_sub£t
.
	`size
(); i++) {

78 
sbuf
[
i
].
	`»size
(
couÁ
);

79 
rbuf
[
i
].
	`»size
(
couÁ
);

80 autØ
j
 = 0; j < 
couÁ
; j++) {

81 
sbuf
[
i
][
j
] = i + j + 1;

82 
rbuf
[
i
][
j
] = 0;

86 
	$¡¬t
()

88 
ucc_¡©us_t
 
¡©us
;

89 autØ
i
 = 0; i < 
»qs
.
	`size
(); i++) {

90 autØ
r
 = 
¬¿y
[
i
];

91 
¡©us
 = 
	`ucc_£rviû_®Ìeduû
(

92 
‹am
.
	`g‘
()->
´ocs
[
r
].‹am, 
sbuf
[
i
].
	`d©a
(), 
rbuf
[i].data(),

93 
UCC_DT_INT32
, 
sbuf
[
i
].
	`size
(), 
UCC_OP_SUM
, 
sub£ts
[i], &
»qs
[i]);

94 
	`EXPECT_EQ
(
UCC_OK
, 
¡©us
);

96 
	}
}

97 
	$check
()

99 
size
 = 
»qs
.
	`size
();

100 autØ
i
 = 0; i < 
size
; i++) {

101 autØ
j
 = 0; j < 
sbuf
[
i
].
	`size
(); j++) {

102 
check
 = 
size
 * (siz+ 1è/ 2 + 
j
 * size;

103 
	`EXPECT_EQ
(
check
, 
rbuf
[
i
][
j
]);

106 
	}
}

109 
şass
 
	g‹¡_scŞl_®Ìeduû


110 : 
public
 
ucc
::
‹¡
,

111 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
¡d
::
veùÜ
<>> {

114 
	$UCC_TEST_P
(
‹¡_scŞl_®Ìeduû
, 
®Ìeduû
)

117 autØ
‹am
 = 
UccJob
::
	`g‘SticT—ms
().
	`back
();

118 
	`ASSERT_EQ
(
‹am
.
	`g‘
()->
´ocs
.
	`size
(), 16);

119 
¡d
::
veùÜ
<> 
sub£t
 = 
	`G‘P¬am
();

120 
‹¡_£rviû_®Ìeduû
 
	`t
(
sub£t
, 4, 
‹am
);

121 
t
.
	`¡¬t
();

122 
t
.
	`wa™
();

123 
t
.
	`check
();

124 
	}
}

126 
INSTANTIATE_TEST_CASE_P
(

127 , 
‹¡_scŞl_®Ìeduû
,

128 ::
‹¡šg
::
V®ues
(
¡d
::
veùÜ
<>({1, 0}), std::vector<>({2, 3}),

129 
¡d
::
veùÜ
<>({0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,

131 
¡d
::
veùÜ
<>({0, 1, 2, 3, 4, 5, 6, 7, 8}),

132 
¡d
::
veùÜ
<>({15, 14, 13, 12, 11, 10, 9}),

133 
¡d
::
veùÜ
<>({0, 2, 4, 6, 8})));

135 şas 
	c‹¡_£rviû_®lg©h”
 : 
public
 
‹¡_£rviû_cŞl
 {

136 
¡d
::
veùÜ
<¡d::veùÜ<>> 
sbuf
;

137 
	m¡d
::
veùÜ
<
¡d
::veùÜ<>> 
rbuf
;

139 
	mpublic
:

140 
‹¡_£rviû_®lg©h”
(
¡d
::
veùÜ
<> 
_sub£t
, 
size_t
 
couÁ
,

141 
UccT—m_h
 
_‹am
)

142 : 
	$‹¡_£rviû_cŞl
(
_sub£t
, 
_‹am
)

144 
sbuf
.
	`»size
(
_sub£t
.
	`size
());

145 
rbuf
.
	`»size
(
_sub£t
.
	`size
());

146 autØ
i
 = 0; i < 
_sub£t
.
	`size
(); i++) {

147 
sbuf
[
i
].
	`»size
(
couÁ
);

148 
rbuf
[
i
].
	`»size
(
couÁ
 * 
_sub£t
.
	`size
());

149 autØ
j
 = 0; j < 
couÁ
; j++) {

150 
sbuf
[
i
][
j
] = i + j + 1;

152 autØ
j
 = 0; j < 
couÁ
 * 
_sub£t
.
	`size
(); j++) {

153 
rbuf
[
i
][
j
] = 0;

157 
	$¡¬t
()

159 
ucc_¡©us_t
 
¡©us
;

160 autØ
i
 = 0; i < 
»qs
.
	`size
(); i++) {

161 autØ
r
 = 
¬¿y
[
i
];

162 
¡©us
 = 
	`ucc_£rviû_®lg©h”
(

163 
‹am
.
	`g‘
()->
´ocs
[
r
].‹am, 
sbuf
[
i
].
	`d©a
(), 
rbuf
[i].data(),

164 
sbuf
[
i
].
	`size
(è* (), 
sub£ts
[i], &
»qs
[i]);

165 
	`EXPECT_EQ
(
UCC_OK
, 
¡©us
);

167 
	}
}

168 
	$check
()

170 
size
 = 
»qs
.
	`size
();

171 
couÁ
 = 
sbuf
[0].
	`size
();

172 autØ
i
 = 0; i < 
size
; i++) {

173 autØ
j
 = 0; j < 
rbuf
[
i
].
	`size
(); j++) {

174 
check
 = (
j
 % 
couÁ
) + 1 + (j / count);

175 
	`EXPECT_EQ
(
check
, 
rbuf
[
i
][
j
]);

178 
	}
}

181 
şass
 
	g‹¡_scŞl_®lg©h”


182 : 
public
 
ucc
::
‹¡
,

183 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
¡d
::
veùÜ
<>> {

186 
	$UCC_TEST_P
(
‹¡_scŞl_®lg©h”
, 
®lg©h”
)

189 autØ
‹am
 = 
UccJob
::
	`g‘SticT—ms
().
	`back
();

190 
	`ASSERT_EQ
(
‹am
.
	`g‘
()->
´ocs
.
	`size
(), 16);

191 
¡d
::
veùÜ
<> 
sub£t
 = 
	`G‘P¬am
();

192 
‹¡_£rviû_®lg©h”
 
	`t
(
sub£t
, 4, 
‹am
);

193 
t
.
	`¡¬t
();

194 
t
.
	`wa™
();

195 
t
.
	`check
();

196 
	}
}

198 
INSTANTIATE_TEST_CASE_P
(

199 , 
‹¡_scŞl_®lg©h”
,

200 ::
‹¡šg
::
V®ues
(
¡d
::
veùÜ
<>({1, 0}), std::vector<>({2, 3}),

201 
¡d
::
veùÜ
<>({0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,

203 
¡d
::
veùÜ
<>({0, 1, 2, 3, 4, 5, 6, 7, 8}),

204 
¡d
::
veùÜ
<>({15, 14, 13, 12, 11, 10, 9}),

205 
¡d
::
veùÜ
<>({0, 2, 4, 6, 8})));

	@test/gtest/core/test_team.cc

5 
	~"commÚ/‹¡_ucc.h
"

7 
	~"cÜe/ucc_‹am.h
"

9 
	~<®gÜ™hm
>

10 
	~<¿ndom
>

12 
şass
 
‹¡_‹am
 : 
public
 
ucc
::
‹¡
,…ublic::
‹¡šg
::
W™hP¬amIÁ”çû
<> {

16 
	$UCC_TEST_P
(
‹¡_‹am
, 
‹am_ü—‹_de¡roy_ùx_glob®
)

19 
‹am_size
 = 
	`G‘P¬am
();

21 ià(
‹am_size
 =ğ1 && !
	`_£lf_avaabË
()) {

22 
	`GTEST_SKIP
();

24 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticJob
()->
	`ü—‹_‹am
(
‹am_size
);

25 
	}
}

27 
	$UCC_TEST_P
(
‹¡_‹am
, 
‹am_ü—‹_de¡roy_ùx_loÿl
)

29 
‹am_size
 = 
	`G‘P¬am
();

31 ià(
‹am_size
 =ğ1 && !
	`_£lf_avaabË
()) {

32 
	`GTEST_SKIP
();

35 
UccJob
 
	`job
(8, UccJob::
UCC_JOB_CTX_LOCAL
);

36 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(
‹am_size
);

37 
	}
}

39 
INSTANTIATE_TEST_CASE_P
(, 
‹¡_‹am
,

40 ::
‹¡šg
::
V®ues
(

48 
	$UCC_TEST_F
(
‹¡_‹am
, 
‹am_ü—‹_muÉË
)

50 
UccJob
 *
job
 = UccJob::
	`g‘SticJob
();

51 
job_size
 = 
job
->
n_´ocs
;

52 
n_‹ams
 = 4;

53 
¡d
::
veùÜ
<
UccT—m_h
> 
‹ams
;

54 
i
 = 0; i < 
n_‹ams
; i++) {

55 
‹am_size
 = 2 + (
	`¿nd
(è% (
job_size
 - 2 + 1));

56 
‹ams
.
	`push_back
(
job
->
	`ü—‹_‹am
(
‹am_size
));

59 
¡d
::
	`shufæe
(
‹ams
.
	`begš
(),—ms.
	`’d
(), std::
	`deçuÉ_¿ndom_’gše
());

60 
	}
}

63 
	$UCC_TEST_F
(
‹¡_‹am
, 
‹am_ü—‹_muÉË_´ecÚÃù_ùx_loÿl
)

65 
job_size
 = 16;

66 
UccJob
 
	`job
(
job_size
, UccJob::
UCC_JOB_CTX_LOCAL
,

67 {
	`ucc_’v_v¬_t
("UCC_TL_UCP_PRECONNECT", "inf")});

68 
n_‹ams
 = 4;

69 
¡d
::
veùÜ
<
UccT—m_h
> 
‹ams
;

70 
i
 = 0; i < 
n_‹ams
; i++) {

71 
‹am_size
 = 2 + (
	`¿nd
(è% (
job_size
 - 2 + 1));

72 
‹ams
.
	`push_back
(
job
.
	`ü—‹_‹am
(
‹am_size
));

75 
¡d
::
	`shufæe
(
‹ams
.
	`begš
(),—ms.
	`’d
(), std::
	`deçuÉ_¿ndom_’gše
());

76 
	}
}

79 
	$UCC_TEST_F
(
‹¡_‹am
, 
‹am_ü—‹_muÉË_´ecÚÃù_ùx_glob®
)

81 
job_size
 = 16;

82 
UccJob
 
	`job
(
job_size
, UccJob::
UCC_JOB_CTX_GLOBAL
,

83 {
	`ucc_’v_v¬_t
("UCC_TL_UCP_PRECONNECT", "inf")});

84 
n_‹ams
 = 4;

85 
¡d
::
veùÜ
<
UccT—m_h
> 
‹ams
;

86 
i
 = 0; i < 
n_‹ams
; i++) {

87 
‹am_size
 = 2 + (
	`¿nd
(è% (
job_size
 - 2 + 1));

88 
‹ams
.
	`push_back
(
job
.
	`ü—‹_‹am
(
‹am_size
));

91 
¡d
::
	`shufæe
(
‹ams
.
	`begš
(),—ms.
	`’d
(), std::
	`deçuÉ_¿ndom_’gše
());

92 
	}
}

94 
	$UCC_TEST_F
(
‹¡_‹am
, 
‹am_ü—‹_no_•
)

96 
UccT—m_h
 
‹am
 = 
UccJob
::
	`g‘SticJob
()->
	`ü—‹_‹am
(

97 
UccJob
::
¡©icUccJobSize
, 
çl£
, false);

98 
	}
}

100 
	$UCC_TEST_F
(
‹¡_‹am
, 
‹am_g‘_©Œ
)

102 
UccJob
 *
job
 = UccJob::
	`g‘SticJob
();

103 
job_size
 = 
job
->
n_´ocs
;

104 
n_‹ams
 = 4;

105 
‹¡_¿nk
 = 1;

106 
¡d
::
veùÜ
<
UccT—m_h
> 
‹ams
;

107 
¡d
::
veùÜ
<> 
‹am_sizes
;

108 
i
 = 0; i < 
n_‹ams
; i++) {

109 
‹am_size
 = 2 + (
	`¿nd
(è% (
job_size
 - 2 + 1));

110 
‹am_sizes
.
	`push_back
(
‹am_size
);

111 
‹ams
.
	`push_back
(
job
->
	`ü—‹_‹am
(
‹am_size
));

113 
i
 = 0; i < 
n_‹ams
; i++) {

114 
ucc_‹am_h
 
‹am
 = 
‹ams
[
i
].
	`g‘
()->
´ocs
[
‹¡_¿nk
].team;

115 
ucc_‹am_©Œ_t
 
©Œ
 = {.
mask
 = 
UCC_TEAM_ATTR_FIELD_SIZE
 |

116 
UCC_TEAM_ATTR_FIELD_EP
};

117 
	`EXPECT_EQ
(
	`ucc_‹am_g‘_©Œ
(
‹am
, &
©Œ
), 
UCC_OK
);

118 
	`EXPECT_EQ
(
©Œ
.
size
, 
‹am_sizes
[
i
]);

119 
	`EXPECT_EQ
(
©Œ
.
•
, 
‹¡_¿nk
);

122 
¡d
::
	`shufæe
(
‹ams
.
	`begš
(),—ms.
	`’d
(), std::
	`deçuÉ_¿ndom_’gše
());

123 
	}
}

	@test/gtest/core/test_timeout.cc

7 
	~"commÚ/‹¡_ucc.h
"

8 
	~<chrÚo
>

12 şas 
	cDISABLED_‹¡_timeout
 : 
public
 
ucc
::
‹¡


14 
public
:

15 
ucc_cŞl_¬gs_t
 
cŞl
;

16 
	$DISABLED_‹¡_timeout
() {

17 
cŞl
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

18 
cŞl
.
cŞl_ty³
 = 
UCC_COLL_TYPE_BARRIER
;

19 
cŞl
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_TIMEOUT
;

20 
cŞl
.
timeout
 = 3;

22 
	}
};

24 
	$UCC_TEST_F
(
DISABLED_‹¡_timeout
, 
sšgË_sk
)

26 
UccJob
 
	`job
(4);

27 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(4);

28 
UccReq
 
	`»q
(
‹am
, &
cŞl
);

29 
i
;

33 
i
 = 1; i < 
»q
.
»qs
.
	`size
(); i++) {

34 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞËùive_po¡
(
»q
.
»qs
[
i
]));

37 
	`EXPECT_EQ
(
UCC_ERR_TIMED_OUT
, 
»q
.
	`wa™
());

38 
	}
}

40 
	$UCC_TEST_F
(
DISABLED_‹¡_timeout
, 
timeout_nÙ_exûeded
)

42 
UccJob
 
	`job
(4);

43 
UccT—m_h
 
‹am
 = 
job
.
	`ü—‹_‹am
(4);

44 
UccReq
 
	`»q
(
‹am
, &
cŞl
);

45 
ucc_¡©us_t
 
¡©us
;

46 
i
;

47 
®l_po¡ed
;

51 
i
 = 1; i < 
»q
.
»qs
.
	`size
(); i++) {

52 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞËùive_po¡
(
»q
.
»qs
[
i
]));

54 autØ
¡¬t
 = 
¡d
::
chrÚo
::
high_»sŞutiÚ_şock
::
	`now
();

55 
®l_po¡ed
 = 0;

57 
UCC_OK
 !ğ(
¡©us
 = 
»q
.
	`‹¡
())) {

58 ià(
¡©us
 < 0) {

61 
‹am
->
	`´og»ss
();

62 autØ
now
 = 
¡d
::
chrÚo
::
high_»sŞutiÚ_şock
::
	`now
();

63 autØ
–­£d
 = 
¡d
::
chrÚo
::
du¿tiÚ_ÿ¡
<¡d::chrÚo::
£cÚds
>(
now
 - 
¡¬t
);

64 ià(!
®l_po¡ed
 && (
–­£d
 > 
¡d
::
chrÚo
::
	`£cÚds
(1))) {

65 
®l_po¡ed
 = 1;

67 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cŞËùive_po¡
(
»q
.
»qs
[0]));

71 
	`EXPECT_EQ
(
UCC_OK
, 
¡©us
);

72 
	}
}

	@test/gtest/core/test_topo.cc

6 
	~<cÜe/ucc_cÚ‹xt.h
>

7 
	~<cÜe/ucc_‹am.h
>

8 
	~<cÜe/ucc_glob®_İts.h
>

11 
	~<commÚ/‹¡.h
>

12 
	~<veùÜ
>

13 
	~<®gÜ™hm
>

14 
	~<¿ndom
>

16 şas 
	caddr_¡Üage
 {

17 
public
:

18 
ucc_addr_¡Üage_t
 
¡Üage
;

19 
¡d
::
veùÜ
<
ucc_cÚ‹xt_addr_h—d”_t
> 
h
;

20 
	$addr_¡Üage
(
size
)

22 
h
.
	`»size
(
size
);

23 
¡Üage
.¡Üagğ
h
.
	`d©a
();

24 
¡Üage
.
size
 = size;

25 
¡Üage
.
addr_Ën
 = (
ucc_cÚ‹xt_addr_h—d”_t
);

27 
	}
};

29 şas 
	c‹¡_tİo
 : 
public
 
ucc
::
‹¡
 {

30 
public
:

31 
ucc_cÚ‹xt_tİo_t
 *
ùx_tİo
;

32 
ucc_tİo_t
 * 
	mtİo
;

33 
	$‹¡_tİo
()

35 
	`ucc_cÚ¡ruùÜ
();

37 ~
	$‹¡_tİo
()

39 
	`ucc_tİo_ş—nup
(
tİo
);

40 
	`ucc_cÚ‹xt_tİo_ş—nup
(
ùx_tİo
);

41 
	}
}

42 
boŞ
 
check_sbgp
(
ucc_sbgp_t
 *
sbgp
, 
¡d
::
veùÜ
<
ucc_¿nk_t
> 
r
)

44 
EXPECT_EQ
(
sbgp
->
group_size
, 
r
.
size
());

45 
	gi
 = 0; i < 
	gr
.
size
(); i++) {

46 ià(
ucc_•_m­_ev®
(
sbgp
->
m­
, 
i
è!ğ
r
[i]) {

47  
çl£
;

50  
	gŒue
;

54 
	#SET_PI
(
_s
, 
_i
, 
_ho¡
, 
_sock
, 
_pid
) \

55 
_s
.
h
[
_i
].
ùx_id
.
pi
.
ho¡_hash
 = 
_ho¡
; \

56 
_s
.
h
[
_i
].
ùx_id
.
pi
.
sock‘_id
 = 
_sock
; \

57 
_s
.
h
[
_i
].
ùx_id
.
pi
.
pid
 = 
_pid
;

	)

59 
	$UCC_TEST_F
(
‹¡_tİo
, 
sšgË_node
)

61 cÚ¡ 
ucc_¿nk_t
 
ùx_size
 = 4;

62 
addr_¡Üage
 
	`s
(
ùx_size
);

63 
ucc_sbgp_t
 * 
sbgp
;

64 
ucc_sub£t_t
 
£t
;

67 
	`SET_PI
(
s
, 0, 0xabcd, 0, 0);

68 
	`SET_PI
(
s
, 1, 0xabcd, 0, 1);

69 
	`SET_PI
(
s
, 2, 0xabcd, 0, 2);

70 
	`SET_PI
(
s
, 3, 0xabcd, 0, 3);

73 
£t
.
m­
.
•_num
 = 
ùx_size
;

74 
£t
.
my¿nk
 = 0;

75 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

78 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_tİo_š™
(&
s
.
¡Üage
, &
ùx_tİo
));

79 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

84 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

85 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

86 
	`EXPECT_EQ
(
sbgp
->
group_size
, 
ùx_size
);

87 
	`EXPECT_EQ
(
sbgp
->
group_¿nk
, 0);

88 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_FULL
);

91 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

92 
	`EXPECT_EQ
(
UCC_SBGP_NOT_EXISTS
, 
sbgp
->
¡©us
);

95 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET
);

96 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

97 
	`EXPECT_EQ
(
sbgp
->
group_size
, 
ùx_size
);

98 
	`EXPECT_EQ
(
sbgp
->
group_¿nk
, 0);

99 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_FULL
);

102 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET_LEADERS
);

103 
	`EXPECT_EQ
(
UCC_SBGP_NOT_EXISTS
, 
sbgp
->
¡©us
);

104 
	}
}

106 
	$UCC_TEST_F
(
‹¡_tİo
, 
node_»Üd”ed
)

108 cÚ¡ 
ucc_¿nk_t
 
ùx_size
 = 4;

109 cÚ¡ 
ucc_¿nk_t
 
‹am_size
 = 3;

110 
ucc_¿nk_t
 
‹am_¿nks
[
‹am_size
] = {2, 3, 1};

111 
addr_¡Üage
 
	`s
(
ùx_size
);

112 
ucc_sbgp_t
 * 
sbgp
;

113 
ucc_sub£t_t
 
£t
;

116 
	`SET_PI
(
s
, 0, 0xabcd, 0, 0);

117 
	`SET_PI
(
s
, 1, 0xabcd, 0, 1);

118 
	`SET_PI
(
s
, 2, 0xabcd, 0, 2);

119 
	`SET_PI
(
s
, 3, 0xabcd, 0, 3);

122 
£t
.
m­
.
•_num
 = 
‹am_size
;

123 
£t
.
my¿nk
 = 2;

124 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

125 
£t
.
m­
.
¬¿y
.m­ = 
‹am_¿nks
;

126 
£t
.
m­
.
¬¿y
.
–em_size
 = (
ucc_¿nk_t
);

129 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_tİo_š™
(&
s
.
¡Üage
, &
ùx_tİo
));

130 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

135 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

136 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

137 
	`EXPECT_EQ
(
‹am_size
, 
sbgp
->
group_size
);

138 
	`EXPECT_EQ
(2, 
sbgp
->
group_¿nk
);

139 
	}
}

141 
	$UCC_TEST_F
(
‹¡_tİo
, 1
node_2sock‘s
)

143 cÚ¡ 
ucc_¿nk_t
 
ùx_size
 = 6;

144 cÚ¡ 
ucc_¿nk_t
 
‹am_size
 = 6;

145 
addr_¡Üage
 
	`s
(
ùx_size
);

146 
ucc_sbgp_t
 * 
sbgp
;

147 
ucc_sub£t_t
 
£t
;

150 
	`SET_PI
(
s
, 0, 0xabcd, 0, 0);

151 
	`SET_PI
(
s
, 1, 0xabcd, 1, 1);

152 
	`SET_PI
(
s
, 2, 0xabcd, 0, 2);

153 
	`SET_PI
(
s
, 3, 0xabcd, 1, 3);

154 
	`SET_PI
(
s
, 4, 0xabcd, 0, 4);

155 
	`SET_PI
(
s
, 5, 0xabcd, 1, 5);

158 
£t
.
m­
.
•_num
 = 
‹am_size
;

159 
£t
.
my¿nk
 = 3;

160 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

163 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_tİo_š™
(&
s
.
¡Üage
, &
ùx_tİo
));

164 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

169 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

170 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

171 
	`EXPECT_EQ
(
‹am_size
, 
sbgp
->
group_size
);

172 
	`EXPECT_EQ
(3, 
sbgp
->
group_¿nk
);

175 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET
);

176 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

177 
	`EXPECT_EQ
(
sbgp
->
group_size
, 
ùx_size
 / 2);

178 
	`EXPECT_EQ
(
sbgp
->
group_¿nk
, 1);

179 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

180 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 1);

181 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 2);

185 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET_LEADERS
);

186 
	`EXPECT_EQ
(
UCC_SBGP_DISABLED
, 
sbgp
->
¡©us
);

188 
	`ucc_tİo_ş—nup
(
tİo
);

189 
£t
.
my¿nk
 = 1;

190 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

193 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET_LEADERS
);

194 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

195 
	`EXPECT_EQ
(
sbgp
->
group_size
, 2);

196 
	`EXPECT_EQ
(
sbgp
->
group_¿nk
, 1);

197 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

198 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 0);

199 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 1);

200 
	}
}

202 
	$UCC_TEST_F
(
‹¡_tİo
, 2
nodes
)

204 cÚ¡ 
ucc_¿nk_t
 
ùx_size
 = 8;

205 cÚ¡ 
ucc_¿nk_t
 
‹am_size
 = 8;

206 
addr_¡Üage
 
	`s
(
ùx_size
);

207 
ucc_sbgp_t
 * 
sbgp
;

208 
ucc_sub£t_t
 
£t
;

212 
	`SET_PI
(
s
, 0, 0xaaa, 0, 0);

213 
	`SET_PI
(
s
, 1, 0xaaa, 1, 1);

214 
	`SET_PI
(
s
, 2, 0xaaa, 0, 2);

215 
	`SET_PI
(
s
, 3, 0xaaa, 1, 3);

216 
	`SET_PI
(
s
, 4, 0xaaa, 0, 4);

218 
	`SET_PI
(
s
, 5, 0xbbb, 0, 5);

219 
	`SET_PI
(
s
, 6, 0xbbb, 1, 6);

220 
	`SET_PI
(
s
, 7, 0xbbb, 0, 7);

223 
£t
.
m­
.
•_num
 = 
‹am_size
;

224 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

225 
£t
.
my¿nk
 = 3;

228 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_tİo_š™
(&
s
.
¡Üage
, &
ùx_tİo
));

229 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

232 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

233 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

234 
	`EXPECT_EQ
(5, 
sbgp
->
group_size
);

235 
	`EXPECT_EQ
(3, 
sbgp
->
group_¿nk
);

236 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

237 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 0);

238 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 1);

241 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET
);

242 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

243 
	`EXPECT_EQ
(
sbgp
->
group_size
, 2);

244 
	`EXPECT_EQ
(
sbgp
->
group_¿nk
, 1);

245 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

246 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 1);

247 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 2);

251 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET_LEADERS
);

252 
	`EXPECT_EQ
(
UCC_SBGP_DISABLED
, 
sbgp
->
¡©us
);

256 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

257 
	`EXPECT_EQ
(
UCC_SBGP_DISABLED
, 
sbgp
->
¡©us
);

260 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NET
);

261 
	`EXPECT_EQ
(
UCC_SBGP_NOT_EXISTS
, 
sbgp
->
¡©us
);

264 
	`ucc_tİo_ş—nup
(
tİo
);

265 
£t
.
my¿nk
 = 6;

266 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

268 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

269 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

270 
	`EXPECT_EQ
(3, 
sbgp
->
group_size
);

271 
	`EXPECT_EQ
(1, 
sbgp
->
group_¿nk
);

272 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

273 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 5);

274 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 1);

277 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET
);

278 
	`EXPECT_EQ
(
UCC_SBGP_NOT_EXISTS
, 
sbgp
->
¡©us
);

281 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET_LEADERS
);

282 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

283 
	`EXPECT_EQ
(2, 
sbgp
->
group_size
);

284 
	`EXPECT_EQ
(1, 
sbgp
->
group_¿nk
);

285 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

286 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 5);

287 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 1);

291 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

292 
	`EXPECT_EQ
(
UCC_SBGP_DISABLED
, 
sbgp
->
¡©us
);

295 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NET
);

296 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

297 
	`EXPECT_EQ
(2, 
sbgp
->
group_size
);

298 
	`EXPECT_EQ
(1, 
sbgp
->
group_¿nk
);

299 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

300 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 1);

301 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 5);

302 
	}
}

304 
	$UCC_TEST_F
(
‹¡_tİo
, 4
nodes_h®f
)

306 cÚ¡ 
ucc_¿nk_t
 
ùx_size
 = 8;

307 
addr_¡Üage
 
	`s
(
ùx_size
);

308 
ucc_sbgp_t
 * 
sbgp
;

309 
ucc_sub£t_t
 
£t
;

312 
	`SET_PI
(
s
, 0, 0xaaa, 0, 0);

313 
	`SET_PI
(
s
, 1, 0xaaa, 1, 1);

314 
	`SET_PI
(
s
, 2, 0xbbb, 0, 2);

315 
	`SET_PI
(
s
, 3, 0xbbb, 1, 3);

316 
	`SET_PI
(
s
, 4, 0xccc, 0, 4);

317 
	`SET_PI
(
s
, 5, 0xccc, 1, 5);

318 
	`SET_PI
(
s
, 6, 0xddd, 0, 6);

319 
	`SET_PI
(
s
, 7, 0xddd, 1, 7);

322 
£t
.
m­
.
•_num
 = 4;

323 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_STRIDED
;

324 
£t
.
m­
.
¡rided
.
¡¬t
 = 0;

325 
£t
.
m­
.
¡rided
.
¡ride
 = 1;

327 
£t
.
my¿nk
 = 1;

329 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_tİo_š™
(&
s
.
¡Üage
, &
ùx_tİo
));

330 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

333 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

334 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

335 
	`EXPECT_EQ
(2, 
sbgp
->
group_size
);

336 
	`EXPECT_EQ
(1, 
sbgp
->
group_¿nk
);

337 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

338 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 0);

339 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 1);

343 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

344 
	`EXPECT_EQ
(
UCC_SBGP_DISABLED
, 
sbgp
->
¡©us
);

347 
	`ucc_tİo_ş—nup
(
tİo
);

348 
£t
.
my¿nk
 = 2;

349 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

350 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE_LEADERS
);

351 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

352 
	`EXPECT_EQ
(2, 
sbgp
->
group_size
);

353 
	`EXPECT_EQ
(1, 
sbgp
->
group_¿nk
);

354 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

355 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 0);

356 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 2);

357 
	}
}

359 
	$UCC_TEST_F
(
‹¡_tİo
, 4
sock‘s_h®f
)

361 cÚ¡ 
ucc_¿nk_t
 
ùx_size
 = 8;

362 
addr_¡Üage
 
	`s
(
ùx_size
);

363 
ucc_sbgp_t
 * 
sbgp
;

364 
ucc_sub£t_t
 
£t
;

367 
	`SET_PI
(
s
, 0, 0xaaa, 0, 0);

368 
	`SET_PI
(
s
, 1, 0xaaa, 0, 1);

369 
	`SET_PI
(
s
, 2, 0xaaa, 2, 2);

370 
	`SET_PI
(
s
, 3, 0xaaa, 2, 3);

371 
	`SET_PI
(
s
, 4, 0xaaa, 3, 4);

372 
	`SET_PI
(
s
, 5, 0xaaa, 3, 5);

373 
	`SET_PI
(
s
, 6, 0xaaa, 4, 6);

374 
	`SET_PI
(
s
, 7, 0xaaa, 4, 7);

378 
£t
.
m­
.
•_num
 = 4;

379 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_STRIDED
;

380 
£t
.
m­
.
¡rided
.
¡¬t
 = 0;

381 
£t
.
m­
.
¡rided
.
¡ride
 = 1;

383 
£t
.
my¿nk
 = 1;

385 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_tİo_š™
(&
s
.
¡Üage
, &
ùx_tİo
));

386 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

389 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET
);

390 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

391 
	`EXPECT_EQ
(2, 
sbgp
->
group_size
);

392 
	`EXPECT_EQ
(1, 
sbgp
->
group_¿nk
);

393 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

394 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 0);

395 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 1);

399 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET_LEADERS
);

400 
	`EXPECT_EQ
(
UCC_SBGP_DISABLED
, 
sbgp
->
¡©us
);

403 
	`ucc_tİo_ş—nup
(
tİo
);

404 
£t
.
my¿nk
 = 2;

405 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

406 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_SOCKET_LEADERS
);

407 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgp
->
¡©us
);

408 
	`EXPECT_EQ
(2, 
sbgp
->
group_size
);

409 
	`EXPECT_EQ
(1, 
sbgp
->
group_¿nk
);

410 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
UCC_EP_MAP_STRIDED
);

411 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡¬t
, 0);

412 
	`EXPECT_EQ
(
sbgp
->
m­
.
¡rided
.
¡ride
, 2);

413 
	}
}

415 
	$UCC_TEST_F
(
‹¡_tİo
, 4
sock‘s_®l
)

417 cÚ¡ 
ucc_¿nk_t
 
ùx_size
 = 16;

418 
addr_¡Üage
 
	`s
(
ùx_size
);

419 
ucc_sbgp_t
 * 
sbgps
;

420 
ucc_sub£t_t
 
£t
;

421 
n_sbgps
;

424 
	`SET_PI
(
s
, 0, 0xaaa, 0, 0);

425 
	`SET_PI
(
s
, 1, 0xaaa, 0, 1);

426 
	`SET_PI
(
s
, 2, 0xaaa, 2, 2);

427 
	`SET_PI
(
s
, 3, 0xaaa, 2, 3);

428 
	`SET_PI
(
s
, 4, 0xaaa, 3, 4);

429 
	`SET_PI
(
s
, 5, 0xaaa, 3, 5);

430 
	`SET_PI
(
s
, 6, 0xaaa, 4, 6);

431 
	`SET_PI
(
s
, 7, 0xaaa, 4, 7);

432 
	`SET_PI
(
s
, 8, 0xaaa, 0, 8);

433 
	`SET_PI
(
s
, 9, 0xaaa, 0, 9);

434 
	`SET_PI
(
s
, 10, 0xaaa, 2, 10);

435 
	`SET_PI
(
s
, 11, 0xaaa, 2, 11);

436 
	`SET_PI
(
s
, 12, 0xaaa, 3, 12);

437 
	`SET_PI
(
s
, 13, 0xaaa, 3, 13);

438 
	`SET_PI
(
s
, 14, 0xaaa, 4, 14);

439 
	`SET_PI
(
s
, 15, 0xaaa, 4, 15);

441 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_tİo_š™
(&
s
.
¡Üage
, &
ùx_tİo
));

444 
£t
.
m­
.
•_num
 = 16;

445 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

447 
£t
.
my¿nk
 = 1;

450 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

452 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_®l_sock‘s
(
tİo
, &
sbgps
, &
n_sbgps
));

453 
	`EXPECT_EQ
(4, 
n_sbgps
);

454 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[0], {0, 1, 8, 9}));

455 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[1], {2, 3, 10, 11}));

456 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[2], {4, 5, 12, 13}));

457 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[3], {6, 7, 14, 15}));

460 
	`ucc_tİo_ş—nup
(
tİo
);

461 
ucc_¿nk_t
 
¿nks
[] = {1, 9, 8, 3, 2, 11, 4, 13, 12, 7, 14, 15};

462 
£t
.
m­
.
•_num
 = 12;

463 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

464 
£t
.
m­
.
¬¿y
.m­ = (*)
¿nks
;

465 
£t
.
m­
.
¬¿y
.
–em_size
 = (
ucc_¿nk_t
);

467 
£t
.
my¿nk
 = 1;

469 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

472 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_®l_sock‘s
(
tİo
, &
sbgps
, &
n_sbgps
));

473 
	`EXPECT_EQ
(4, 
n_sbgps
);

474 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[0], {0, 1, 2}));

475 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[1], {3, 4, 5}));

476 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[2], {6, 7, 8}));

477 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[3], {9, 10, 11}));

480 
	`ucc_tİo_ş—nup
(
tİo
);

481 
ucc_¿nk_t
 
¿nks2
[] = {1, 2, 13, 7};

482 
£t
.
m­
.
•_num
 = 4;

483 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

484 
£t
.
m­
.
¬¿y
.m­ = (*)
¿nks2
;

485 
£t
.
m­
.
¬¿y
.
–em_size
 = (
ucc_¿nk_t
);

487 
£t
.
my¿nk
 = 1;

489 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

491 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_®l_sock‘s
(
tİo
, &
sbgps
, &
n_sbgps
));

492 
	`EXPECT_EQ
(4, 
n_sbgps
);

493 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[0], {0}));

494 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[1], {1}));

495 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[2], {2}));

496 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[3], {3}));

499 
	`ucc_tİo_ş—nup
(
tİo
);

500 
ucc_¿nk_t
 
¿nks3
[] = {0, 1, 2, 8, 9};

501 
£t
.
m­
.
•_num
 = 5;

502 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

503 
£t
.
m­
.
¬¿y
.m­ = (*)
¿nks3
;

504 
£t
.
m­
.
¬¿y
.
–em_size
 = (
ucc_¿nk_t
);

506 
£t
.
my¿nk
 = 1;

508 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

510 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_®l_sock‘s
(
tİo
, &
sbgps
, &
n_sbgps
));

511 
	`EXPECT_EQ
(2, 
n_sbgps
);

512 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[0], {0, 1, 3, 4}));

513 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[1], {2}));

514 
	}
}

516 
	$UCC_TEST_F
(
‹¡_tİo
, 
®l_nodes
)

518 cÚ¡ 
ucc_¿nk_t
 
ùx_size
 = 16;

519 
addr_¡Üage
 
	`s
(
ùx_size
);

520 
ucc_sbgp_t
 *
sbgps
, *
sbgp
;

521 
ucc_sub£t_t
 
£t
;

522 
n_sbgps
;

526 
	`SET_PI
(
s
, 0, 0xaaa, 0, 0);

527 
	`SET_PI
(
s
, 1, 0xaaa, 1, 1);

528 
	`SET_PI
(
s
, 2, 0xaaa, 0, 2);

529 
	`SET_PI
(
s
, 3, 0xaaa, 1, 3);

531 
	`SET_PI
(
s
, 4, 0xbbb, 0, 4);

532 
	`SET_PI
(
s
, 5, 0xbbb, 1, 5);

533 
	`SET_PI
(
s
, 6, 0xbbb, 0, 6);

535 
	`SET_PI
(
s
, 7, 0xccc, 0, 7);

536 
	`SET_PI
(
s
, 8, 0xccc, 1, 8);

537 
	`SET_PI
(
s
, 9, 0xccc, 0, 9);

538 
	`SET_PI
(
s
, 10, 0xccc, 1, 10);

540 
	`SET_PI
(
s
, 11, 0xddd, 0, 11);

541 
	`SET_PI
(
s
, 12, 0xddd, 1, 12);

542 
	`SET_PI
(
s
, 13, 0xddd, 0, 13);

543 
	`SET_PI
(
s
, 14, 0xddd, 1, 14);

544 
	`SET_PI
(
s
, 15, 0xddd, 0, 15);

546 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_tİo_š™
(&
s
.
¡Üage
, &
ùx_tİo
));

549 
£t
.
m­
.
•_num
 = 16;

550 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

551 
£t
.
my¿nk
 = 1;

553 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

555 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_®l_nodes
(
tİo
, &
sbgps
, &
n_sbgps
));

556 
	`EXPECT_EQ
(4, 
n_sbgps
);

557 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[0], {0, 1, 2, 3}));

558 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[1], {4, 5, 6}));

559 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[2], {7, 8, 9, 10}));

560 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[3], {11, 12, 13, 14, 15}));

564 
sbgp
 = 
	`ucc_tİo_g‘_sbgp
(
tİo
, 
UCC_SBGP_NODE
);

565 
	`EXPECT_EQ
(
sbgp
->
¡©us
, 
sbgps
[0].status);

566 
	`EXPECT_EQ
(
sbgp
->
group_size
, 
sbgps
[0].group_size);

567 
	`EXPECT_EQ
(
sbgp
->
m­
.
ty³
, 
sbgps
[0].map.type);

570 
	`ucc_tİo_ş—nup
(
tİo
);

571 
ucc_¿nk_t
 
¿nks
[] = {9, 12, 13, 14};

572 
£t
.
m­
.
•_num
 = 4;

573 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

574 
£t
.
m­
.
¬¿y
.m­ = (*)
¿nks
;

575 
£t
.
m­
.
¬¿y
.
–em_size
 = (
ucc_¿nk_t
);

576 
£t
.
my¿nk
 = 2;

578 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

579 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_®l_nodes
(
tİo
, &
sbgps
, &
n_sbgps
));

580 
	`EXPECT_EQ
(2, 
n_sbgps
);

581 
	`EXPECT_EQ
(
UCC_SBGP_NOT_EXISTS
, 
sbgps
[0].
¡©us
);

582 
	`EXPECT_EQ
(
UCC_SBGP_ENABLED
, 
sbgps
[1].
¡©us
);

585 
	`ucc_tİo_ş—nup
(
tİo
);

586 
ucc_¿nk_t
 
¿nks1
[] = {2, 0, 5, 6, 7, 10, 14, 12};

587 
£t
.
m­
.
•_num
 = 8;

588 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

589 
£t
.
m­
.
¬¿y
.m­ = (*)
¿nks1
;

590 
£t
.
m­
.
¬¿y
.
–em_size
 = (
ucc_¿nk_t
);

591 
£t
.
my¿nk
 = 0;

593 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

594 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_®l_nodes
(
tİo
, &
sbgps
, &
n_sbgps
));

595 
	`EXPECT_EQ
(4, 
n_sbgps
);

596 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[0], {0, 1}));

597 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[1], {2, 3}));

598 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[2], {4, 5}));

599 
	`EXPECT_EQ
(
Œue
, 
	`check_sbgp
(&
sbgps
[3], {6, 7}));

603 
	`ucc_tİo_ş—nup
(
tİo
);

604 
ucc_¿nk_t
 
¿nks2
[] = {11, 12, 13, 14, 15};

605 
£t
.
m­
.
•_num
 = 5;

606 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

607 
£t
.
m­
.
¬¿y
.m­ = (*)
¿nks2
;

608 
£t
.
m­
.
¬¿y
.
–em_size
 = (
ucc_¿nk_t
);

609 
£t
.
my¿nk
 = 0;

611 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

612 
	`EXPECT_EQ
(
UCC_ERR_INVALID_PARAM
, 
	`ucc_tİo_g‘_®l_nodes
(
tİo
, &
sbgps
, &
n_sbgps
));

613 
	}
}

615 
	$UCC_TEST_F
(
‹¡_tİo
, 
node_Ëad”s
)

617 cÚ¡ 
ucc_¿nk_t
 
ùx_size
 = 8;

618 
addr_¡Üage
 
	`s
(
ùx_size
);

619 
ucc_sub£t_t
 
£t
;

620 
ucc_¿nk_t
 
i
;

621 
ucc_¿nk_t
 *
node_Ëad”s
;

623 
	`SET_PI
(
s
, 0, 0xaaa, 0, 0);

624 
	`SET_PI
(
s
, 1, 0xaaa, 1, 1);

625 
	`SET_PI
(
s
, 2, 0xaaa, 0, 2);

626 
	`SET_PI
(
s
, 3, 0xaaa, 1, 3);

627 
	`SET_PI
(
s
, 4, 0xbbb, 0, 4);

628 
	`SET_PI
(
s
, 5, 0xbbb, 1, 5);

629 
	`SET_PI
(
s
, 6, 0xbbb, 0, 6);

630 
	`SET_PI
(
s
, 7, 0xbbb, 1, 7);

633 
£t
.
m­
.
•_num
 = 
ùx_size
;

634 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

635 
£t
.
my¿nk
 = 0;

638 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_cÚ‹xt_tİo_š™
(&
s
.
¡Üage
, &
ùx_tİo
));

639 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

640 
tİo
->
node_Ëad”_¿nk_id
 = 0;

641 
	`EXPECT_EQ
(2, 
tİo
->tİo->
Âodes
);

642 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_node_Ëad”s
(
tİo
, &
node_Ëad”s
));

646 
i
 = 0; i < 4; i++) {

647 
	`EXPECT_EQ
(0, 
node_Ëad”s
[
i
]);

650 
i
 = 4; i < 8; i++) {

651 
	`EXPECT_EQ
(4, 
node_Ëad”s
[
i
]);

655 
	`ucc_tİo_ş—nup
(
tİo
);

656 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

657 
tİo
->
node_Ëad”_¿nk_id
 = 1;

658 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_node_Ëad”s
(
tİo
, &
node_Ëad”s
));

662 
i
 = 0; i < 4; i++) {

663 
	`EXPECT_EQ
(1, 
node_Ëad”s
[
i
]);

666 
i
 = 4; i < 8; i++) {

667 
	`EXPECT_EQ
(5, 
node_Ëad”s
[
i
]);

671 
	`ucc_tİo_ş—nup
(
tİo
);

672 
ucc_¿nk_t
 
¿nks
[] = {1, 2, 5, 6};

673 
£t
.
m­
.
•_num
 = 4;

674 
£t
.
m­
.
ty³
 = 
UCC_EP_MAP_ARRAY
;

675 
£t
.
m­
.
¬¿y
.m­ = (*)
¿nks
;

676 
£t
.
m­
.
¬¿y
.
–em_size
 = (
ucc_¿nk_t
);

677 
£t
.
my¿nk
 = 0;

680 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

681 
tİo
->
node_Ëad”_¿nk_id
 = 0;

682 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_node_Ëad”s
(
tİo
, &
node_Ëad”s
));

686 
	`EXPECT_EQ
(0, 
node_Ëad”s
[0]);

687 
	`EXPECT_EQ
(0, 
node_Ëad”s
[1]);

689 
	`EXPECT_EQ
(2, 
node_Ëad”s
[2]);

690 
	`EXPECT_EQ
(2, 
node_Ëad”s
[3]);

693 
	`ucc_tİo_ş—nup
(
tİo
);

694 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_š™
(
£t
, 
ùx_tİo
, &
tİo
));

695 
tİo
->
node_Ëad”_¿nk_id
 = 1;

696 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_tİo_g‘_node_Ëad”s
(
tİo
, &
node_Ëad”s
));

700 
	`EXPECT_EQ
(1, 
node_Ëad”s
[0]);

701 
	`EXPECT_EQ
(1, 
node_Ëad”s
[1]);

703 
	`EXPECT_EQ
(3, 
node_Ëad”s
[2]);

704 
	`EXPECT_EQ
(3, 
node_Ëad”s
[3]);

705 
	}
}

	@test/gtest/core/test_utils.cc

6 
	~<cÜe/ucc_‹am.h
>

7 
	~<uts/ucc_cŞl_uts.h
>

10 
	~<commÚ/‹¡.h
>

11 
usšg
 
P¬am
 = 
¡d
::
tu¶e
<, 
ucc_d©©y³_t
, >;

13 
şass
 
	g‹¡_cŞl_¬gs_msgsize
 : 
public
 
ucc
::
‹¡
, 
	gpublic
::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am
> {

14 
public
:

15 
ucc_‹am_t
 
‹am
;

16 
ucc_ba£_cŞl_¬gs_t
 
	g¬gs
;

17 
	g¡d
::
veùÜ
<> 
couÁs
;

18 
ucc_couÁ_t
 
	gtÙ®
;

19 
ucc_d©©y³_t
 
	gdt
;

20 
_š™
(
‹am_size
, 
ucc_d©©y³_t
 
_dt
, 
c
) {

21 
	g‹am
.
	gsize
 = 
‹am_size
;

22 
	g‹am
.
	g¿nk
 = 1;

23 
	g¬gs
.
	g‹am
 = &
‹am
;

24 
	gtÙ®
 = 0;

25 
	gdt
 = 
_dt
;

26 
	gcouÁs
.
»size
(
‹am
.
size
);

27 
	gi
 = 0; i < 
	g‹am
.
	gsize
; i++) {

28 
	gcouÁs
[
i
] = 
c
 + i;

29 
	gtÙ®
 +ğ
couÁs
[
i
];

31 
mem£t
(&
¬gs
.args, 0x1, (args.args));

33 
size_t
 
tÙ®_size
() {

34  
ucc_dt_size
(
dt
è* 
	gtÙ®
;

38 
	$UCC_TEST_P
(
‹¡_cŞl_¬gs_msgsize
, 
d¡_veùÜ
)

40 autØ
cŞls
 = {
UCC_COLL_TYPE_ALLGATHERV
, 
UCC_COLL_TYPE_REDUCE_SCATTERV
};

41 autØ
p
 = 
	`G‘P¬am
();

43 
	`_š™
(
¡d
::
g‘
<0>(
p
), std::get<1>(p), std::get<2>(p));

44 
¬gs
.¬gs.
d¡
.
šfo_v
.
couÁs
 = (
ucc_couÁ_t
*)couÁs.
	`d©a
();

45 
¬gs
.¬gs.
d¡
.
šfo_v
.
d©©y³
 = 
dt
;

47 autØ
c
 : 
cŞls
) {

48 
¬gs
.¬gs.
cŞl_ty³
 = 
c
;

49 
	`EXPECT_EQ
(
	`tÙ®_size
(), 
	`ucc_cŞl_¬gs_msgsize
(&
¬gs
.¬gs, 
‹am
.
¿nk
,

50 
‹am
.
size
));

52 
	}
}

54 
	$UCC_TEST_P
(
‹¡_cŞl_¬gs_msgsize
, 
®ways_z”o
)

56 autØ
cŞls
 = {
UCC_COLL_TYPE_BARRIER
, 
UCC_COLL_TYPE_FANIN
,

57 
UCC_COLL_TYPE_FANOUT
};

58 autØ
p
 = 
	`G‘P¬am
();

60 
	`_š™
(
¡d
::
g‘
<0>(
p
), std::get<1>(p), std::get<2>(p));

61 autØ
c
 : 
cŞls
) {

62 
¬gs
.¬gs.
cŞl_ty³
 = 
c
;

63 
	`EXPECT_EQ
(0, 
	`ucc_cŞl_¬gs_msgsize
(&
¬gs
.¬gs, 
‹am
.
¿nk
,—m.
size
));

65 
	}
}

67 
	$UCC_TEST_P
(
‹¡_cŞl_¬gs_msgsize
, 
sÿÏr
)

69 autØ
cŞls
 = {
UCC_COLL_TYPE_ALLREDUCE
, 
UCC_COLL_TYPE_REDUCE_SCATTER
,

70 
UCC_COLL_TYPE_ALLTOALL
, 
UCC_COLL_TYPE_ALLGATHER
};

71 autØ
p
 = 
	`G‘P¬am
();

73 
	`_š™
(
¡d
::
g‘
<0>(
p
), std::get<1>(p), std::get<2>(p));

75 
¬gs
.¬gs.
d¡
.
šfo
.
couÁ
 = 
tÙ®
;

76 
¬gs
.¬gs.
d¡
.
šfo
.
d©©y³
 = 
dt
;

78 autØ
c
 : 
cŞls
) {

79 
¬gs
.¬gs.
cŞl_ty³
 = 
c
;

80 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLREDUCE
;

81 
	`EXPECT_EQ
(
	`tÙ®_size
(), 
	`ucc_cŞl_¬gs_msgsize
(&
¬gs
.¬gs, 
‹am
.
¿nk
,

82 
‹am
.
size
));

84 
	}
}

86 
	$UCC_TEST_P
(
‹¡_cŞl_¬gs_msgsize
, 
»duû
)

88 autØ
p
 = 
	`G‘P¬am
();

90 
r
 = 0;„ < 2;„++) {

91 
	`_š™
(
¡d
::
g‘
<0>(
p
), std::get<1>(p), std::get<2>(p));

92 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_REDUCE
;

93 
¬gs
.¬gs.
roÙ
 = 
r
;

94 ià(
‹am
.
¿nk
 !ğ
r
) {

95 
¬gs
.¬gs.
¤c
.
šfo
.
couÁ
 = 
tÙ®
;

96 
¬gs
.¬gs.
¤c
.
šfo
.
d©©y³
 = 
dt
;

98 
¬gs
.¬gs.
d¡
.
šfo
.
couÁ
 = 
tÙ®
;

99 
¬gs
.¬gs.
d¡
.
šfo
.
d©©y³
 = 
dt
;

101 
	`EXPECT_EQ
(
	`tÙ®_size
(), 
	`ucc_cŞl_¬gs_msgsize
(&
¬gs
.¬gs, 
‹am
.
¿nk
,

102 
‹am
.
size
));

105 
	}
}

107 
	$UCC_TEST_P
(
‹¡_cŞl_¬gs_msgsize
, 
sÿ‰”
)

109 autØ
p
 = 
	`G‘P¬am
();

111 
r
 = 0;„ < 2;„++) {

112 
	`_š™
(
¡d
::
g‘
<0>(
p
), std::get<1>(p), std::get<2>(p));

113 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_SCATTER
;

114 
¬gs
.¬gs.
roÙ
 = 
r
;

115 ià(
‹am
.
¿nk
 !ğ
r
) {

116 
¬gs
.¬gs.
d¡
.
šfo
.
couÁ
 = 
tÙ®
;

117 
¬gs
.¬gs.
d¡
.
šfo
.
d©©y³
 = 
dt
;

119 
¬gs
.¬gs.
¤c
.
šfo
.
couÁ
 = 
tÙ®
 * 
‹am
.
size
;

120 
¬gs
.¬gs.
¤c
.
šfo
.
d©©y³
 = 
dt
;

122 
	`EXPECT_EQ
(
	`tÙ®_size
(è* 
‹am
.
size
,

123 
	`ucc_cŞl_¬gs_msgsize
(&
¬gs
.¬gs, 
‹am
.
¿nk
,—m.
size
));

125 
	}
}

127 
	$UCC_TEST_P
(
‹¡_cŞl_¬gs_msgsize
, 
g©h”
)

129 autØ
p
 = 
	`G‘P¬am
();

131 
r
 = 0;„ < 2;„++) {

132 
	`_š™
(
¡d
::
g‘
<0>(
p
), std::get<1>(p), std::get<2>(p));

133 
¬gs
.¬gs.
cŞl_ty³
 = 
UCC_COLL_TYPE_GATHER
;

134 
¬gs
.¬gs.
roÙ
 = 
r
;

135 ià(
‹am
.
¿nk
 !ğ
r
) {

136 
¬gs
.¬gs.
¤c
.
šfo
.
couÁ
 = 
tÙ®
;

137 
¬gs
.¬gs.
¤c
.
šfo
.
d©©y³
 = 
dt
;

139 
¬gs
.¬gs.
d¡
.
šfo
.
couÁ
 = 
tÙ®
 * 
‹am
.
size
;

140 
¬gs
.¬gs.
d¡
.
šfo
.
d©©y³
 = 
dt
;

142 
	`EXPECT_EQ
(
	`tÙ®_size
(è* 
‹am
.
size
,

143 
	`ucc_cŞl_¬gs_msgsize
(&
¬gs
.¬gs, 
‹am
.
¿nk
,—m.
size
));

146 
	}
}

148 
INSTANTIATE_TEST_CASE_P
(

149 , 
‹¡_cŞl_¬gs_msgsize
,

150 ::
‹¡šg
::
Combše
(

151 ::
‹¡šg
::
V®ues
(2, 8, 11),

152 ::
‹¡šg
::
V®ues
(
UCC_DT_INT32
, 
UCC_DT_UINT128
, 
UCC_DT_FLOAT64
),

153 ::
‹¡šg
::
V®ues
(32, 4096, 65533)));

	@test/gtest/tl/mlx5/test_tl_mlx5.cc

6 
	~"‹¡__mlx5.h
"

8 
	g‹¡__mlx5
::
	$‹¡__mlx5
()

10 
_mlx5_so_hªdË
 = 
NULL
;

11 
ùx
 = 
NULL
;

12 
pd
 = 
NULL
;

13 
cq
 = 
NULL
;

14 
	}
}

16 
	g‹¡__mlx5
::
	$S‘Up
()

18 * 
devÇme
 = 
NULL
;

19 
ucc_¡©us_t
 
¡©us
;

21 
	`ASSERT_EQ
(
UCC_OK
, 
	`ucc_cÚ¡ruùÜ
());

22 
	`ucc_¡ºıy_§ã
(
lib
.
log_compÚ’t
.
Çme
, "GTEST_MLX5",

23 (
lib
.
log_compÚ’t
.
Çme
));

24 
lib
.
log_compÚ’t
.
log_Ëv–
 = 
UCC_LOG_LEVEL_ERROR
;

26 
¡d
::
¡ršg
 
·th
 =

27 
¡d
::
	`¡ršg
(
ucc_glob®_cÚfig
.
compÚ’t_·th
) + "/libucc_tl_mlx5.so";

28 
_mlx5_so_hªdË
 = 
	`dlİ’
(
·th
.
	`c_¡r
(), 
RTLD_NOW
);

29 ià(!
_mlx5_so_hªdË
) {

30 
	`GTEST_SKIP
() << "cannot open ucc_tl_mlx5†ibrary" ;

33 
ü—‹_ibv_ùx
 = (
ucc__mlx5_ü—‹_ibv_ùx_â_t
)
	`dlsym
(

34 
_mlx5_so_hªdË
, "ucc_tl_mlx5_create_ibv_ctx");

35 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

37 
g‘_aùive_pÜt
 = (
ucc__mlx5_g‘_aùive_pÜt_â_t
)
	`dlsym
(

38 
_mlx5_so_hªdË
, "ucc_tl_mlx5_get_active_port");

39 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

41 
¡©us
 = 
	`ü—‹_ibv_ùx
(&
devÇme
, &
ùx
, &
lib
);

42 ià(
UCC_OK
 !ğ
¡©us
) {

43 
	`GTEST_SKIP
() << "no ib devices";

45 
pÜt
 = 
	`g‘_aùive_pÜt
(
ùx
);

46 
	`ASSERT_GE
(
pÜt
, 0);

48 
	`ASSERT_EQ
(
	`ibv_qu”y_pÜt
(
ùx
, 
pÜt
, &
pÜt_©Œ
), 0);

50 
pd
 = 
	`ibv_®loc_pd
(
ùx
);

51 
	`ASSERT_NE
(
nuÎ±r
, 
pd
);

53 
cq
 = 
	`ibv_ü—‹_cq
(
ùx
, 8, 
NULL
, NULL, 0);

54 
	`ASSERT_NE
(
nuÎ±r
, 
cq
);

55 
	}
}

57 
	g‹¡__mlx5
::~
	$‹¡__mlx5
()

59 ià(
cq
) {

60 
	`ibv_de¡roy_cq
(
cq
);

62 ià(
pd
) {

63 
	`ibv_d—Îoc_pd
(
pd
);

65 ià(
ùx
) {

66 
	`ibv_şo£_deviû
(
ùx
);

68 ià(
_mlx5_so_hªdË
) {

69 
	`dlşo£
(
_mlx5_so_hªdË
);

71 
	}
}

	@test/gtest/tl/mlx5/test_tl_mlx5.h

5 #iâdeà
TEST_TL_MLX5_H


6 
	#TEST_TL_MLX5_H


	)

8 
	~<dlfú.h
>

9 
	~"commÚ/‹¡_ucc.h
"

10 
	~"compÚ’ts//mlx5/_mlx5.h
"

11 
	~"compÚ’ts//mlx5/_mlx5_dm.h
"

12 
	~"compÚ’ts//mlx5/_mlx5_ib.h
"

14 
	#CHECK_TEST_STATUS
() \

15 ià(
Te¡
::
	`HasF©®Fau»
(è|| Te¡::
	`IsSk³d
()) { \

17 }

	)

19 
	$ucc_¡©us_t
 (*
	tucc__mlx5_ü—‹_ibv_ùx_â_t
)(

20 **
	tib_devÇme
, 
	tibv_cÚ‹xt
 **
	tùx
, 
	tucc_ba£_lib_t
 *
	tlib
);

22 (*
	tucc__mlx5_g‘_aùive_pÜt_â_t
)(
	tibv_cÚ‹xt
 *
	tùx
);

26 şas 
	c‹¡__mlx5
 : 
public
 
ucc
::
‹¡
 {

27 
´Ùeùed
:

28 *
_mlx5_so_hªdË
;

29 
public
:

30 
ucc_ba£_lib_t
 
lib
;

31 
ucc__mlx5_ü—‹_ibv_ùx_â_t
 
ü—‹_ibv_ùx
;

32 
ucc__mlx5_g‘_aùive_pÜt_â_t
 
g‘_aùive_pÜt
;

33 
ibv_pÜt_©Œ
 
pÜt_©Œ
;

34 
ibv_cÚ‹xt
 * 
ùx
;

35 
ibv_pd
 * 
pd
;

36 
ibv_cq
 * 
cq
;

37 
pÜt
;

38 
	`‹¡__mlx5
();

39 
vœtu®
 ~
	`‹¡__mlx5
();

40 
vœtu®
 
	$S‘Up
(è
ov”ride
;

	@test/gtest/tl/mlx5/test_tl_mlx5_qps.cc

6 
	~"‹¡__mlx5_qps.h
"

8 
	$UCC_TEST_F
(
‹¡__mlx5_rc_qp
, 
ü—‹
)

10 
	`ü—‹_qp
();

11 
	}
}

13 
	$UCC_TEST_F
(
‹¡__mlx5_rc_qp
, 
ü—‹_umr
)

15 
	`ü—‹_umr_qp
();

16 
	}
}

18 
	$UCC_TEST_F
(
‹¡__mlx5_rc_qp
, 
cÚÃù_loİback
)

20 
	`ü—‹_qp
();

21 
	`CHECK_TEST_STATUS
();

22 
	`cÚÃù_qp_loİback
();

23 
	}
}

25 
	$UCC_TEST_F
(
‹¡__mlx5_dc
, 
š™_dù
)

27 
ucc_¡©us_t
 
¡©us
;

29 
¡©us
 =

30 
	`š™_dù
(
pd
, 
ùx
, 
cq
, 
¤q
, 
pÜt
, &
dù_qp
, &
dù_q²
, &
qp_cÚf
, &
lib
);

31 
	`GTEST_ASSERT_EQ
(
UCC_OK
, 
¡©us
);

32 
	}
}

34 
	$UCC_TEST_F
(
‹¡__mlx5_dc
, 
š™_dci
)

36 
ucc_¡©us_t
 
¡©us
;

38 
¡©us
 = 
	`š™_dci
(&
dci
, 
pd
, 
ùx
, 
cq
, 
pÜt
, 4, &
qp_cÚf
, &
lib
);

39 
	`GTEST_ASSERT_EQ
(
UCC_OK
, 
¡©us
);

40 
	}
}

42 
	$UCC_TEST_F
(
‹¡__mlx5_dc
, 
ü—‹_ah
)

44 
ucc_¡©us_t
 
¡©us
;

46 
¡©us
 = 
	`ü—‹_ah
(
pd
, 
pÜt_©Œ
.
lid
, 
pÜt
, &
ah
, &
lib
);

47 
	`GTEST_ASSERT_EQ
(
UCC_OK
, 
¡©us
);

48 
	}
}

	@test/gtest/tl/mlx5/test_tl_mlx5_qps.h

6 
	~"‹¡__mlx5.h
"

8 şas 
	c‹¡__mlx5_qp
 : 
public
 
‹¡__mlx5
 {

9 
public
:

10 
ucc__mlx5_ib_qp_cÚf_t
 
qp_cÚf
;

12 
vœtu®
 
	$S‘Up
()

14 
‹¡__mlx5
::
	`S‘Up
();

15 
	`CHECK_TEST_STATUS
();

17 
qp_cÚf
.
qp_ºr_»Œy
 = 7;

18 
qp_cÚf
.
qp_ºr_tim”
 = 20;

19 
qp_cÚf
.
qp_»Œy_út
 = 7;

20 
qp_cÚf
.
qp_timeout
 = 18;

21 
qp_cÚf
.
qp_max_©omic
 = 1;

22 
qp_cÚf
.
qp_¦
 = 1;

24 
	}
};

26 
	$ucc_¡©us_t
 (*
	tucc__mlx5_ü—‹_umr_qp_â_t
)(

27 
	tibv_cÚ‹xt
 *
	tùx
, 
	tibv_pd
 *
	tpd
, 
	tibv_cq
 *
	tcq
, 
	tib_pÜt
,

28 
	tibv_qp
 **
	tqp
, 
	tucc__mlx5_ib_qp_cÚf_t
 *
	tqp_cÚf
, 
	tucc_ba£_lib_t
 *
	tlib
);

30 
	$ucc_¡©us_t
 (*
	tucc__mlx5_qp_cÚÃù_â_t
)(

31 
	tibv_qp
 *
	tqp
, 
	tušt32_t
 
	tqp_num
, 
	tušt16_t
 
	tlid
, 
	tpÜt
,

32 
	tucc__mlx5_ib_qp_cÚf_t
 *
	tqp_cÚf
, 
	tucc_ba£_lib_t
 *
	tlib
);

34 
	$ucc_¡©us_t
 (*
	tucc__mlx5_ü—‹_rc_qp_â_t
)(

35 
	tibv_cÚ‹xt
 *
	tùx
, 
	tibv_pd
 *
	tpd
, 
	tibv_cq
 *
	tcq
, 
	ttx_d•th
,

36 
	tucc__mlx5_qp_t
 *
	tqp
, 
	tušt32_t
 *
	tq²
, 
	tucc_ba£_lib_t
 *
	tlib
);

38 şas 
	c‹¡__mlx5_rc_qp
 : 
public
 
‹¡__mlx5_qp
 {

39 
public
:

40 
ucc__mlx5_qp_t
 
qp
 = {};

41 
ucc__mlx5_qp_t
 
umr_qp
 = {
	}
};

42 
ušt32_t
 
	gq²
;

43 
ucc__mlx5_ib_qp_cÚf_t
 
	gumr_qp_cÚf
;

44 
	gtx_d•th
;

45 
ucc__mlx5_ü—‹_rc_qp_â_t
 
	gü—‹_rc_qp
;

46 
ucc__mlx5_qp_cÚÃù_â_t
 
	gqp_cÚÃù
;

47 
ucc__mlx5_ü—‹_umr_qp_â_t
 
	gü—‹_rc_umr_qp
;

49 
vœtu®
 
	$S‘Up
()

51 
qp
.q°ğ
NULL
;

52 
umr_qp
.
qp
 = 
NULL
;

53 
tx_d•th
 = 4;

55 
‹¡__mlx5_qp
::
	`S‘Up
();

56 
	`CHECK_TEST_STATUS
();

58 
umr_qp_cÚf
 = 
qp_cÚf
;

60 
ü—‹_rc_qp
 = (
ucc__mlx5_ü—‹_rc_qp_â_t
)
	`dlsym
(

61 
_mlx5_so_hªdË
, "ucc_tl_mlx5_create_rc_qp");

62 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

64 
qp_cÚÃù
 = (
ucc__mlx5_qp_cÚÃù_â_t
)
	`dlsym
(

65 
_mlx5_so_hªdË
, "ucc_tl_mlx5_qp_connect");

66 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

68 
ü—‹_rc_umr_qp
 = (
ucc__mlx5_ü—‹_umr_qp_â_t
)
	`dlsym
(

69 
_mlx5_so_hªdË
, "ucc_tl_mlx5_create_umr_qp");

70 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

72 
	}
}

74 ~
	$‹¡__mlx5_rc_qp
()

76 ià(
qp
.qp) {

77 
	`ibv_de¡roy_qp
(
qp
.qp);

79 ià(
umr_qp
.
qp
) {

80 
	`ibv_de¡roy_qp
(
umr_qp
.
qp
);

82 
	}
}

84 
	$ü—‹_qp
()

86 
	`GTEST_ASSERT_EQ
(
	`ü—‹_rc_qp
(
ùx
, 
pd
, 
cq
, 
tx_d•th
, &
qp
, &
q²
, &
lib
),

87 
UCC_OK
);

88 
	}
}

90 
	$ü—‹_umr_qp
()

92 
	`GTEST_ASSERT_EQ
(

93 
	`ü—‹_rc_umr_qp
(
ùx
, 
pd
, 
cq
, 
pÜt
, &
umr_qp
.
qp
, &
umr_qp_cÚf
, &
lib
),

94 
UCC_OK
);

95 
	}
}

97 
	$cÚÃù_qp_loİback
()

99 
	`GTEST_ASSERT_EQ
(

100 
	`qp_cÚÃù
(
qp
.qp, 
q²
, 
pÜt_©Œ
.
lid
, 
pÜt
, &
qp_cÚf
, &
lib
),

101 
UCC_OK
);

102 
	}
};

105 
	$ucc_¡©us_t
 (*
	tucc__mlx5_š™_dù_â_t
)(

106 
	tibv_pd
 *
	tpd
, 
	tibv_cÚ‹xt
 *
	tùx
, 
	tibv_cq
 *
	tcq
,

107 
	tibv_¤q
 *
	t¤q
, 
	tušt8_t
 
	tpÜt_num
, 
	tibv_qp
 **
	tdù_qp
,

108 
	tušt32_t
 *
	tq²
, 
	tucc__mlx5_ib_qp_cÚf_t
 *
	tqp_cÚf
, 
	tucc_ba£_lib_t
 *
	tlib
);

110 
	$ucc_¡©us_t
 (*
	tucc__mlx5_š™_dci_â_t
)(

111 
	tucc__mlx5_dci_t
 *
	tdci
, 
	tibv_pd
 *
	tpd
, 
	tibv_cÚ‹xt
 *
	tùx
,

112 
	tibv_cq
 *
	tcq
, 
	tušt8_t
 
	tpÜt_num
, 
	ttx_d•th
,

113 
	tucc__mlx5_ib_qp_cÚf_t
 *
	tqp_cÚf
, 
	tucc_ba£_lib_t
 *
	tlib
);

115 
	$ucc_¡©us_t
 (*
	tucc__mlx5_ü—‹_ah_â_t
)(
	tibv_pd
 * 
	tpd
,

116 
	tušt16_t
 
	tlid
,

117 
	tušt8_t
 
	tpÜt_num
,

118 
	tibv_ah
 **
	tah_±r
,

119 
	tucc_ba£_lib_t
 *
	tlib
);

121 şas 
	c‹¡__mlx5_dc
 : 
public
 
‹¡__mlx5_qp
 {

122 
public
:

123 
ibv_qp
 *
dù_qp
 = 
nuÎ±r
;

124 
ibv_ah
 *
ah
 = 
nuÎ±r
;

125 
ibv_¤q
 *
¤q
 = 
nuÎ±r
;

126 
ucc__mlx5_dci_t
 
dci
 = {};

127 
ušt32_t
 
dù_q²
;

128 
ucc__mlx5_š™_dù_â_t
 
š™_dù
;

129 
ucc__mlx5_š™_dci_â_t
 
š™_dci
;

130 
ucc__mlx5_ü—‹_ah_â_t
 
ü—‹_ah
;

132 
vœtu®
 
	$S‘Up
()

134 
ibv_¤q_š™_©Œ
 
¤q_©Œ
;

136 
‹¡__mlx5_qp
::
	`S‘Up
();

137 
	`CHECK_TEST_STATUS
();

139 
š™_dù
 = (
ucc__mlx5_š™_dù_â_t
)
	`dlsym
(
_mlx5_so_hªdË
,

141 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

143 
š™_dci
 = (
ucc__mlx5_š™_dci_â_t
)
	`dlsym
(
_mlx5_so_hªdË
,

145 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

147 
ü—‹_ah
 = (
ucc__mlx5_ü—‹_ah_â_t
)
	`dlsym
(
_mlx5_so_hªdË
,

149 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

151 
	`mem£t
(&
¤q_©Œ
, 0, (
ibv_¤q_š™_©Œ
));

152 
¤q_©Œ
.
©Œ
.
max_wr
 = 1;

153 
¤q_©Œ
.
©Œ
.
max_sge
 = 1;

155 
¤q
 = 
	`ibv_ü—‹_¤q
(
pd
, &
¤q_©Œ
);

156 
	`EXPECT_NE
(
nuÎ±r
, 
¤q
);

157 
dù_qp
 = 
NULL
;

158 
	}
}

160 ~
	$‹¡__mlx5_dc
()

162 ià(
ah
) {

163 
	`ibv_de¡roy_ah
(
ah
);

165 ià(
dù_qp
) {

166 
	`ibv_de¡roy_qp
(
dù_qp
);

168 ià(
dci
.
dci_qp
) {

169 
	`ibv_de¡roy_qp
(
dci
.
dci_qp
);

172 ià(
¤q
) {

173 
	`ibv_de¡roy_¤q
(
¤q
);

175 
	}
}

	@test/gtest/tl/mlx5/test_tl_mlx5_wqe.cc

6 
	~"‹¡__mlx5_wqe.h
"

7 
	~"uts/¬ch/ıu.h
"

8 
	~<tu¶e
>

9 
	~<cm©h
>

12 
	$roundUpToPow”OfTwo
(
a
)

14 
b
 = 1;

15 
b
 < 
a
) {

16 
b
 *= 2;

18  
b
;

19 
	}
}

22 
boŞ
 
	$dÛsM©rixF™
(
Äows
, 
ncŞs
, 
–em_size
)

25 
m©rix_size
 =

26 
Äows
 * 
¡d
::
	`max
(128, 
	`roundUpToPow”OfTwo
(
ncŞs
) *

27 
	`roundUpToPow”OfTwo
(
¡d
::
	`max
(
–em_size
, 8)));

28  
m©rix_size
 <ğ
	`pow
(2, 13)

29 && 
–em_size
 <ğ128 && 
Äows
 <ğ64 && 
ncŞs
 <= 64;

30 
	}
}

32 
	$UCC_TEST_P
(
‹¡__mlx5_Œª¥o£
, 
Œª¥o£Wqe
)

34 
Äows
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

35 
ncŞs
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

36 
–em_size
 = (
DT
è* 
¡d
::
g‘
<2>(
	`G‘P¬am
());

37 
com¶‘iÚs_num
 = 0;

38 
DT
 
¤c
[
Äows
][
ncŞs
 * 
–em_size
], 
d¡
[ncols][nrows *ƒlem_size];

39 
ibv_wc
 
wcs
[1];

40 
ibv_mr
 *
¤c_mr
, *
d¡_mr
;

41 
i
, 
j
, 
k
;

42 
ibv_deviû_©Œ
 
deviû_©Œ
;

44 
	`GTEST_ASSERT_EQ
(
	`ibv_qu”y_deviû
(
ùx
, &
deviû_©Œ
), 0);

46 ià(
deviû_©Œ
.
v’dÜ_id
 !ğ0x02c9 || deviû_©Œ.
v’dÜ_·¹_id
 != 4129) {

47 
	`GTEST_SKIP
() << "Theest‚eeds CX7 but got vendor_id="

48 << 
deviû_©Œ
.
v’dÜ_id


49 << ", v’dÜ_·¹_id=" << 
deviû_©Œ
.
v’dÜ_·¹_id
;

53 ià(!
	`dÛsM©rixF™
(
Äows
, 
ncŞs
, 
–em_size
)) {

54 
	`GTEST_SKIP
();

57 
i
 = 0; i < 
Äows
; i++) {

58 
j
 = 0; j < 
ncŞs
; j++) {

59 
k
 = 0; k < 
–em_size
; k++) {

60 
¤c
[
i
][
j
 * 
–em_size
 + 
k
] =

61 (
i
 * 
Äows
 * 
–em_size
 + 
j
 *ƒËm_siz+ 
k
) % 256;

62 
d¡
[
j
][
i
 * 
–em_size
 + 
k
] = 0;

67 
¤c_mr
 =

68 
	`ibv_»g_mr
(
pd
, 
¤c
, 
Äows
 * 
ncŞs
 * 
–em_size
, 
IBV_ACCESS_LOCAL_WRITE
);

69 
	`GTEST_ASSERT_NE
(
nuÎ±r
, 
¤c_mr
);

70 
d¡_mr
 =

71 
	`ibv_»g_mr
(
pd
, 
d¡
, 
Äows
 * 
ncŞs
 * 
–em_size
, 
IBV_ACCESS_LOCAL_WRITE
);

72 
	`GTEST_ASSERT_NE
(
nuÎ±r
, 
d¡_mr
);

74 
	`ibv_wr_¡¬t
(
qp
.
qp_ex
);

75 
	`po¡_Œª¥o£
(
qp
.qp, 
¤c_mr
->
lkey
, 
d¡_mr
->
rkey
, (
ušŒ_t
)
¤c
,

76 (
ušŒ_t
)
d¡
, 
–em_size
, 
ncŞs
, 
Äows
, 
IBV_SEND_SIGNALED
);

77 
	`GTEST_ASSERT_EQ
(
	`ibv_wr_com¶‘e
(
qp
.
qp_ex
), 0);

79 !
com¶‘iÚs_num
) {

80 
com¶‘iÚs_num
 = 
	`ibv_pŞl_cq
(
cq
, 1, 
wcs
);

82 
	`GTEST_ASSERT_EQ
(
com¶‘iÚs_num
, 1);

83 
	`GTEST_ASSERT_EQ
(
wcs
[0].
¡©us
, 
IBV_WC_SUCCESS
);

85 
i
 = 0; i < 
Äows
; i++) {

86 
j
 = 0; j < 
ncŞs
; j++) {

87 
k
 = 0; k < 
–em_size
; k++) {

88 
	`GTEST_ASSERT_EQ
(
¤c
[
i
][
j
 * 
–em_size
 + 
k
],

89 
d¡
[
j
][
i
 * 
–em_size
 + 
k
]);

94 
	`GTEST_ASSERT_EQ
(
	`ibv_d”eg_mr
(
¤c_mr
), 
UCC_OK
);

95 
	`GTEST_ASSERT_EQ
(
	`ibv_d”eg_mr
(
d¡_mr
), 
UCC_OK
);

96 
	}
}

98 
INSTANTIATE_TEST_SUITE_P
(, 
‹¡__mlx5_Œª¥o£
,

99 ::
‹¡šg
::
Combše
(::‹¡šg::
V®ues
(1, 7, 32, 64),

100 ::
‹¡šg
::
V®ues
(1, 5, 32, 64),

101 ::
‹¡šg
::
V®ues
(1, 3, 8, 128)));

103 
	$UCC_TEST_P
(
‹¡__mlx5_rdma_wr™e
, 
RdmaWr™eWqe
)

105 
ibv_sge
 
sg
;

106 
ibv_£nd_wr
 
wr
;

108 
bufsize
 = 
	`G‘P¬am
();

109 
	`bufãrs_š™
();

110 
	`CHECK_TEST_STATUS
();

112 
	`mem£t
(&
sg
, 0, (sg));

113 
sg
.
addr
 = (
ušŒ_t
)
¤c
;

114 
sg
.
Ëngth
 = 
bufsize
;

115 
sg
.
lkey
 = 
¤c_mr
->lkey;

117 
	`mem£t
(&
wr
, 0, (wr));

118 
wr
.
wr_id
 = 0;

119 
wr
.
sg_li¡
 = &
sg
;

120 
wr
.
num_sge
 = 1;

121 
wr
.
İcode
 = 
IBV_WR_RDMA_WRITE
;

122 
wr
.
£nd_æags
 = 
IBV_SEND_SIGNALED
 | 
IBV_SEND_FENCE
;

123 
wr
.
Ãxt
 = 
NULL
;

124 
wr
.wr.
rdma
.
»mÙe_addr
 = (
ušŒ_t
)
d¡
;

125 
wr
.wr.
rdma
.
rkey
 = 
d¡_mr
->rkey;

128 
	`GTEST_ASSERT_EQ
(
	`ibv_po¡_£nd
(
qp
.qp, &
wr
, 
NULL
), 0);

129 
	`wa™_fÜ_com¶‘iÚ
();

130 
	`CHECK_TEST_STATUS
();

132 
	`v®id©e_bufãrs
();

133 
	}
}

135 
	$UCC_TEST_P
(
‹¡__mlx5_rdma_wr™e
, 
Cu¡omRdmaWr™eWqe
)

137 
bufsize
 = 
	`G‘P¬am
();

138 
	`bufãrs_š™
();

139 
	`CHECK_TEST_STATUS
();

141 
	`ibv_wr_¡¬t
(
qp
.
qp_ex
);

142 
	`po¡_rdma_wr™e
(
qp
.qp, 
q²
, 
nuÎ±r
, (
ušŒ_t
)
¤c
, 
bufsize
, 
¤c_mr
->
lkey
,

143 (
ušŒ_t
)
d¡
, 
d¡_mr
->
rkey
,

144 
IBV_SEND_SIGNALED
 | 
IBV_SEND_FENCE
, 0);

145 
	`GTEST_ASSERT_EQ
(
	`ibv_wr_com¶‘e
(
qp
.
qp_ex
), 0);

146 
	`wa™_fÜ_com¶‘iÚ
();

147 
	`CHECK_TEST_STATUS
();

149 
	`v®id©e_bufãrs
();

150 
	}
}

152 
INSTANTIATE_TEST_SUITE_P
(, 
‹¡__mlx5_rdma_wr™e
,

153 ::
‹¡šg
::
V®ues
(1, 31, 128, 1024));

155 
	$UCC_TEST_P
(
‹¡__mlx5_dm
, 
MemıyToDeviûMemÜy
)

157 
bufsize
 = 
	`G‘P¬am
();

158 
	`bufãrs_š™
();

159 
	`CHECK_TEST_STATUS
();

160 ià(!
dm_±r
) {

164 ià(
bufsize
 % 4 != 0) {

165 
	`GTEST_SKIP
() << "for memcpy involving device memory, buffer size "

169 
	`GTEST_ASSERT_EQ
(
	`ibv_memıy_to_dm
(
dm_±r
, 0, (*)
¤c
, 
bufsize
), 0);

170 
	`GTEST_ASSERT_EQ
(
	`ibv_memıy_äom_dm
((*)
d¡
, 
dm_±r
, 0, 
bufsize
), 0);

172 
	`v®id©e_bufãrs
();

173 
	}
}

175 
	$UCC_TEST_P
(
‹¡__mlx5_dm
, 
RdmaToDeviûMemÜy
)

177 
ibv_sge
 
sg
;

178 
ibv_£nd_wr
 
wr
;

180 
bufsize
 = 
	`G‘P¬am
();

181 
	`bufãrs_š™
();

182 
	`CHECK_TEST_STATUS
();

183 ià(!
dm_±r
) {

188 
	`mem£t
(&
sg
, 0, (sg));

189 
sg
.
addr
 = (
ušŒ_t
)
¤c
;

190 
sg
.
Ëngth
 = 
bufsize
;

191 
sg
.
lkey
 = 
¤c_mr
->lkey;

193 
	`mem£t
(&
wr
, 0, (wr));

194 
wr
.
wr_id
 = 0;

195 
wr
.
sg_li¡
 = &
sg
;

196 
wr
.
num_sge
 = 1;

197 
wr
.
İcode
 = 
IBV_WR_RDMA_WRITE
;

198 
wr
.
£nd_æags
 = 
IBV_SEND_SIGNALED
 | 
IBV_SEND_FENCE
;

199 
wr
.
Ãxt
 = 
NULL
;

200 
wr
.wr.
rdma
.
»mÙe_addr
 = (
ušŒ_t
)0;

201 
wr
.wr.
rdma
.
rkey
 = 
dm_mr
->rkey;

203 
	`GTEST_ASSERT_EQ
(
	`ibv_po¡_£nd
(
qp
.qp, &
wr
, 
NULL
), 0);

204 
	`wa™_fÜ_com¶‘iÚ
();

205 
	`CHECK_TEST_STATUS
();

208 
	`mem£t
(&
sg
, 0, (sg));

209 
sg
.
addr
 = (
ušŒ_t
)0;

210 
sg
.
Ëngth
 = 
bufsize
;

211 
sg
.
lkey
 = 
dm_mr
->lkey;

213 
	`mem£t
(&
wr
, 0, (wr));

214 
wr
.
wr_id
 = 0;

215 
wr
.
sg_li¡
 = &
sg
;

216 
wr
.
num_sge
 = 1;

217 
wr
.
İcode
 = 
IBV_WR_RDMA_WRITE
;

218 
wr
.
£nd_æags
 = 
IBV_SEND_SIGNALED
 | 
IBV_SEND_FENCE
;

219 
wr
.
Ãxt
 = 
NULL
;

220 
wr
.wr.
rdma
.
»mÙe_addr
 = (
ušŒ_t
)
d¡
;

221 
wr
.wr.
rdma
.
rkey
 = 
d¡_mr
->rkey;

223 
	`GTEST_ASSERT_EQ
(
	`ibv_po¡_£nd
(
qp
.qp, &
wr
, 
NULL
), 0);

224 
	`wa™_fÜ_com¶‘iÚ
();

225 
	`CHECK_TEST_STATUS
();

227 
	`v®id©e_bufãrs
();

228 
	}
}

230 
	$UCC_TEST_P
(
‹¡__mlx5_dm
, 
Cu¡omRdmaToDeviûMemÜy
)

232 
bufsize
 = 
	`G‘P¬am
();

233 
	`bufãrs_š™
();

234 
	`CHECK_TEST_STATUS
();

235 ià(!
dm_±r
) {

240 
	`ibv_wr_¡¬t
(
qp
.
qp_ex
);

241 
	`po¡_rdma_wr™e
(
qp
.qp, 
q²
, 
nuÎ±r
, (
ušŒ_t
)
¤c
, 
bufsize
, 
¤c_mr
->
lkey
,

242 (
ušŒ_t
)0, 
dm_mr
->
rkey
,

243 
IBV_SEND_SIGNALED
 | 
IBV_SEND_FENCE
, 0);

244 
	`GTEST_ASSERT_EQ
(
	`ibv_wr_com¶‘e
(
qp
.
qp_ex
), 0);

245 
	`wa™_fÜ_com¶‘iÚ
();

246 
	`CHECK_TEST_STATUS
();

249 
	`ibv_wr_¡¬t
(
qp
.
qp_ex
);

250 
	`po¡_rdma_wr™e
(
qp
.qp, 
q²
, 
nuÎ±r
, (
ušŒ_t
)0, 
bufsize
, 
dm_mr
->
lkey
,

251 (
ušŒ_t
)
d¡
, 
d¡_mr
->
rkey
,

252 
IBV_SEND_SIGNALED
 | 
IBV_SEND_FENCE
, 0);

253 
	`GTEST_ASSERT_EQ
(
	`ibv_wr_com¶‘e
(
qp
.
qp_ex
), 0);

254 
	`wa™_fÜ_com¶‘iÚ
();

255 
	`CHECK_TEST_STATUS
();

257 
	`v®id©e_bufãrs
();

258 
	}
}

260 
INSTANTIATE_TEST_SUITE_P
(, 
‹¡__mlx5_dm
,

261 ::
‹¡šg
::
V®ues
(1, 12, 31, 32, 8192, 8193, 32768,

264 
	$UCC_TEST_P
(
‹¡__mlx5_wa™_Ú_d©a
, 
wa™OnD©aWqe
)

266 
ušt64_t
 
wa™_Ú_v®ue
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

267 
ušt64_t
 
š™_ù¾_v®ue
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

268 
ušt64_t
 
bufãr
[3];

269 vŞ©
ušt64_t
 *
ù¾
, *
¤c
, *
d¡
;

270 
com¶‘iÚs_num
;

271 
ibv_wc
 
wcs
[1];

272 
ibv_mr
 * 
bufãr_mr
;

273 
ibv_sge
 
sg
;

274 
ibv_£nd_wr
 
wr
;

276 
	`mem£t
(
bufãr
, 0, 3 * (
ušt64_t
));

277 
bufãr_mr
 = 
	`ibv_»g_mr
(
pd
, 
bufãr
, 3 * (
ušt64_t
),

278 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
);

279 
	`GTEST_ASSERT_NE
(
nuÎ±r
, 
bufãr_mr
);

280 
ù¾
 = &
bufãr
[0];

281 
¤c
 = &
bufãr
[1];

282 
d¡
 = &
bufãr
[2];

284 *
ù¾
 = 
š™_ù¾_v®ue
;

286 
	`mem£t
(&
sg
, 0, (sg));

287 
sg
.
addr
 = (
ušŒ_t
)
¤c
;

288 
sg
.
Ëngth
 = (
ušt64_t
);

289 
sg
.
lkey
 = 
bufãr_mr
->lkey;

291 
	`mem£t
(&
wr
, 0, (wr));

292 
wr
.
wr_id
 = 0;

293 
wr
.
sg_li¡
 = &
sg
;

294 
wr
.
num_sge
 = 1;

295 
wr
.
İcode
 = 
IBV_WR_RDMA_WRITE
;

296 
wr
.
£nd_æags
 = 
IBV_SEND_SIGNALED
 | 
IBV_SEND_FENCE
;

297 
wr
.
Ãxt
 = 
NULL
;

298 
wr
.wr.
rdma
.
»mÙe_addr
 = (
ušŒ_t
)
d¡
;

299 
wr
.wr.
rdma
.
rkey
 = 
bufãr_mr
->rkey;

302 
	`GTEST_ASSERT_EQ
(
	`po¡_wa™_Ú_d©a
(
qp
.qp, 
wa™_Ú_v®ue
, 
bufãr_mr
->
lkey
,

303 (
ušŒ_t
)
ù¾
, 
nuÎ±r
),

304 
UCC_OK
);

306 
	`GTEST_ASSERT_EQ
(
	`ibv_po¡_£nd
(
qp
.qp, &
wr
, 
NULL
), 0);

308 
	`¦“p
(1);

310 *
¤c
 = 0xdeadbeef;

312 
	`ucc_memÜy_ıu_ãnû
();

313 *
ù¾
 = 
wa™_Ú_v®ue
;

316 
com¶‘iÚs_num
 = 
	`ibv_pŞl_cq
(
cq
, 1, 
wcs
);

317 ià(
com¶‘iÚs_num
 != 0) {

318 
	`GTEST_ASSERT_EQ
(
com¶‘iÚs_num
, 1);

319 
	`GTEST_ASSERT_EQ
(
wcs
[0].
¡©us
, 
IBV_WC_SUCCESS
);

320 ià(
wcs
[0].
wr_id
 == 0) {

327 
	`GTEST_ASSERT_EQ
(*
d¡
, *
¤c
);

329 
	`GTEST_ASSERT_EQ
(
	`ibv_d”eg_mr
(
bufãr_mr
), 
UCC_OK
);

330 
	}
}

332 
INSTANTIATE_TEST_SUITE_P
(

333 , 
‹¡__mlx5_wa™_Ú_d©a
,

334 ::
‹¡šg
::
Combše
(::‹¡šg::
V®ues
(1, 1024, 1025, 0xF0F30F00, 0xFFFFFFFF),

335 ::
‹¡šg
::
V®ues
(0, 0xF0F30F01)));

337 
	$UCC_TEST_P
(
‹¡__mlx5_umr_wqe
, 
umrWqe
)

339 
ušt16_t
 
nbr_¤cs
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

340 
ušt32_t
 
by‹s_couÁ
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

341 
ušt32_t
 
»³©_couÁ
 = 
¡d
::
g‘
<2>(
	`G‘P¬am
());

342 
ušt32_t
 
by‹s_sk
 = 
¡d
::
g‘
<3>(
	`G‘P¬am
());

343 
¤c_size
 = (
by‹s_couÁ
 + 
by‹s_sk
è* 
»³©_couÁ
;

344 
d¡_size
 = 
by‹s_couÁ
 * 
nbr_¤cs
 * 
»³©_couÁ
;

345 
£nd_mem_acûss_æags
 = 0;

346 
»cv_mem_acûss_æags
 =

347 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
;

348 
DT
 
¤c
[
nbr_¤cs
][
¤c_size
], 
d¡
[
d¡_size
];

349 
ibv_mr
 * 
¤c_mr
[
nbr_¤cs
], *
d¡_mr
, *
umr_’Œ›s_mr
;

350 
mlx5dv_mkey
 * 
umr_mkey
;

351 
mlx5dv_mkey_š™_©Œ
 
umr_mkey_š™_©Œ
;

352 * 
umr_’Œ›s_buf
;

353 
size_t
 
umr_buf_size
;

354 
mlx5dv_mr_š‹¾—ved
 
mkey_’Œ›s
[
nbr_¤cs
];

355 
ibv_wc
 
wcs
[1];

356 
i
, 
j
, 
com¶‘iÚs_num
, 
¤c_šdex
, 
»³t™iÚ_couÁ
, 
off£t
;

359 
i
 = 0; i < 
nbr_¤cs
; i++) {

360 
j
 = 0; j < 
¤c_size
; j++) {

361 
¤c
[
i
][
j
] = (˜* (
¤c_size
 + 7) + j) % 255;

363 
¤c_mr
[
i
] = 
	`ibv_»g_mr
(
pd
, 
¤c
[i], 
¤c_size
, 
£nd_mem_acûss_æags
);

364 
	`GTEST_ASSERT_NE
(
nuÎ±r
, 
¤c_mr
[
i
]);

367 
	`mem£t
(
d¡
, 0, 
d¡_size
);

368 
d¡_mr
 = 
	`ibv_»g_mr
(
pd
, 
d¡
, 
d¡_size
, 
»cv_mem_acûss_æags
);

369 
	`GTEST_ASSERT_NE
(
nuÎ±r
, 
d¡_mr
);

372 
umr_buf_size
 = 
	`ucc_®ign_up
(

373 (
mlx5_wqe_umr_»³©_’t_£g
è* (
nbr_¤cs
 + 1), 64);

374 
	`GTEST_ASSERT_EQ
(
	`ucc_posix_mem®ign
(&
umr_’Œ›s_buf
, 2048, 
umr_buf_size
),

377 
umr_’Œ›s_mr
 =

378 
	`ibv_»g_mr
(
pd
, 
umr_’Œ›s_buf
, 
umr_buf_size
, 
£nd_mem_acûss_æags
);

379 
	`GTEST_ASSERT_NE
(
nuÎ±r
, 
umr_’Œ›s_mr
);

381 
	`mem£t
(&
umr_mkey_š™_©Œ
, 0, (umr_mkey_init_attr));

382 
umr_mkey_š™_©Œ
.
pd
 =…d;

383 
umr_mkey_š™_©Œ
.
ü—‹_æags
 = 
MLX5DV_MKEY_INIT_ATTR_FLAGS_INDIRECT
;

384 
umr_mkey_š™_©Œ
.
max_’Œ›s
 = 
nbr_¤cs
 + 1;

386 
umr_mkey
 = 
	`mlx5dv_ü—‹_mkey
(&
umr_mkey_š™_©Œ
);

387 
	`GTEST_ASSERT_NE
(
nuÎ±r
, 
umr_mkey
);

388 
	`GTEST_ASSERT_GE
(
umr_mkey_š™_©Œ
.
max_’Œ›s
, 
nbr_¤cs
 + 1);

390 
i
 = 0; i < 
nbr_¤cs
; i++) {

391 
mkey_’Œ›s
[
i
].
addr
 = (
ušŒ_t
)
¤c
[i];

392 
mkey_’Œ›s
[
i
].
by‹s_couÁ
 = bytes_count;

393 
mkey_’Œ›s
[
i
].
by‹s_sk
 = bytes_skip;

394 
mkey_’Œ›s
[
i
].
lkey
 = 
¤c_mr
[i]->lkey;

397 
	`po¡_umr
(
umr_qp
.
qp
, 
umr_mkey
, 
£nd_mem_acûss_æags
, 
»³©_couÁ
, 
nbr_¤cs
,

398 
mkey_’Œ›s
, (
ušt32_t
)
umr_’Œ›s_mr
->
lkey
, 
umr_’Œ›s_buf
);

400 
com¶‘iÚs_num
 = 0;

401 !
com¶‘iÚs_num
) {

402 
com¶‘iÚs_num
 = 
	`ibv_pŞl_cq
(
cq
, 1, 
wcs
);

404 
	`GTEST_ASSERT_EQ
(
com¶‘iÚs_num
, 1);

405 
	`GTEST_ASSERT_EQ
(
wcs
[0].
¡©us
, 
IBV_WC_SUCCESS
);

406 
	`GTEST_ASSERT_EQ
(
wcs
[0].
wr_id
, 0);

409 
	`ibv_wr_¡¬t
(
qp
.
qp_ex
);

410 
	`po¡_rdma_wr™e
(
qp
.qp, 
q²
, 
nuÎ±r
, (
ušŒ_t
)0, 
d¡_size
, 
umr_mkey
->
lkey
,

411 (
ušŒ_t
)
d¡
, 
d¡_mr
->
rkey
,

412 
IBV_SEND_SIGNALED
 | 
IBV_SEND_FENCE
, 0);

413 
	`GTEST_ASSERT_EQ
(
	`ibv_wr_com¶‘e
(
qp
.
qp_ex
), 0);

415 
com¶‘iÚs_num
 = 0;

416 !
com¶‘iÚs_num
) {

417 
com¶‘iÚs_num
 = 
	`ibv_pŞl_cq
(
cq
, 1, 
wcs
);

419 
	`GTEST_ASSERT_EQ
(
com¶‘iÚs_num
, 1);

420 
	`GTEST_ASSERT_EQ
(
wcs
[0].
¡©us
, 
IBV_WC_SUCCESS
);

421 
	`GTEST_ASSERT_EQ
(
wcs
[0].
wr_id
, 0);

424 
i
 = 0; i < 
d¡_size
; i++) {

425 
¤c_šdex
 = (
i
 / 
by‹s_couÁ
è% 
nbr_¤cs
;

426 
»³t™iÚ_couÁ
 = (
i
 / 
by‹s_couÁ
è/ 
nbr_¤cs
;

427 
off£t
 =

428 
»³t™iÚ_couÁ
 * (
by‹s_couÁ
 + 
by‹s_sk
è+ (
i
 % bytes_count);

429 
	`GTEST_ASSERT_EQ
(
d¡
[
i
], 
¤c
[
¤c_šdex
][
off£t
]);

433 
	`GTEST_ASSERT_EQ
(0, 
	`mlx5dv_de¡roy_mkey
(
umr_mkey
));

434 
	`GTEST_ASSERT_EQ
(
	`ibv_d”eg_mr
(
umr_’Œ›s_mr
), 
UCC_OK
);

435 
	`ucc_ä“
(
umr_’Œ›s_buf
);

436 
i
 = 0; i < 
nbr_¤cs
; i++) {

437 
	`GTEST_ASSERT_EQ
(
	`ibv_d”eg_mr
(
¤c_mr
[
i
]), 
UCC_OK
);

439 
	`GTEST_ASSERT_EQ
(
	`ibv_d”eg_mr
(
d¡_mr
), 
UCC_OK
);

440 
	}
}

442 
INSTANTIATE_TEST_SUITE_P
(, 
‹¡__mlx5_umr_wqe
,

443 ::
‹¡šg
::
Combše
(::‹¡šg::
V®ues
(1, 129, 1024),

444 ::
‹¡šg
::
V®ues
(5, 64),

445 ::
‹¡šg
::
V®ues
(1, 3, 16),

446 ::
‹¡šg
::
V®ues
(0, 7)));

448 
	$UCC_TEST_P
(
‹¡__mlx5_dm_®loc_»g
, 
DeviûMemÜyAÎoÿtiÚ
)

450 
size_t
 
buf_size
 = 
¡d
::
g‘
<0>(
	`G‘P¬am
());

451 
size_t
 
buf_num
 = 
¡d
::
g‘
<1>(
	`G‘P¬am
());

452 
ibv_dm
 *
±r
 = 
nuÎ±r
;

453 
ibv_mr
 *
mr
 = 
nuÎ±r
;

454 
ucc_¡©us_t
 
¡©us
;

456 
¡©us
 = 
	`dm_®loc_»g
(
ùx
, 
pd
, 0, 
buf_size
, &
buf_num
, &
±r
, &
mr
, &
lib
);

457 ià(
¡©us
 =ğ
UCC_ERR_NO_MEMORY
 || stu =ğ
UCC_ERR_NO_RESOURCE
) {

458 
	`GTEST_SKIP
(è<< "ÿÂÙ‡Îoÿ‹ " << 
buf_num
 << " chunk(s) of size "

459 << 
buf_size
 << " in device memory";

461 
	`GTEST_ASSERT_EQ
(
¡©us
, 
UCC_OK
);

463 
	`ibv_d”eg_mr
(
mr
);

464 
	`ibv_ä“_dm
(
±r
);

465 
	}
}

467 
INSTANTIATE_TEST_SUITE_P
(

468 , 
‹¡__mlx5_dm_®loc_»g
,

469 ::
‹¡šg
::
Combše
(::‹¡šg::
V®ues
(1, 2, 1024, 8191, 8192, 8193, 32768,

471 ::
‹¡šg
::
V®ues
(
UCC_ULUNITS_AUTO
, 1, 3, 8)));

	@test/gtest/tl/mlx5/test_tl_mlx5_wqe.h

6 
	~"‹¡__mlx5.h
"

7 
	~"‹¡__mlx5_qps.h
"

8 
	~"compÚ’ts//mlx5/_mlx5_wqe.h
"

10 
	#DT
 
ušt8_t


	)

12 
	$ucc_¡©us_t
 (*
	tucc__mlx5_po¡_rdma_â_t
)(

13 
	tibv_qp
 *
	tqp
, 
	tušt32_t
 
	tq²
, 
	tibv_ah
 *
	tah
, 
	tušŒ_t
 
	t¤c_mkey_addr
,

14 
	tsize_t
 
	tËn
, 
	tušt32_t
 
	t¤c_mr_lkey
, 
	tušŒ_t
 
	td¡_addr
, ušt32_ˆ
	td¡_mr_key
,

15 
	t£nd_æags
, 
	tušt64_t
 
	twr_id
);

16 
	$ucc_¡©us_t
 (*
	tucc__mlx5_po¡_Œª¥o£_â_t
)(

17 
	tibv_qp
 *
	tqp
, 
	tušt32_t
 
	t¤c_mr_lkey
, ušt32_ˆ
	td¡_mr_key
,

18 
	tušŒ_t
 
	t¤c_mkey_addr
, ušŒ_ˆ
	td¡_addr
, 
	tušt32_t
 
	t–em’t_size
,

19 
	tušt16_t
 
	tncŞs
, ušt16_ˆ
	tÄows
, 
	t£nd_æags
);

21 
	$ucc_¡©us_t
 (*
	tucc__mlx5_po¡_wa™_Ú_d©a_â_t
)(
	tibv_qp
 *
	tqp
,

22 
	tušt64_t
 
	tv®ue
,

23 
	tušt32_t
 
	tlkey
,

24 
	tušŒ_t
 
	taddr
,

25 *
	tsk_±r
);

27 
	$ucc_¡©us_t
 (*
	tucc__mlx5_po¡_umr_â_t
)(

28 
	tibv_qp
 *
	tqp
, 
	tmlx5dv_mkey
 *
	tdv_mkey
, 
	tušt32_t
 
	tacûss_æags
,

29 
	tušt32_t
 
	t»³©_couÁ
, 
	tušt16_t
 
	tnum_’Œ›s
,

30 
	tmlx5dv_mr_š‹¾—ved
 *
	td©a
, 
	tušt32_t
 
	t±r_mkey
, *
	t±r_add»ss
);

32 
	$ucc_¡©us_t
 (*
	tucc__mlx5_dm_®loc_»g_â_t
)(

33 
	tibv_cÚ‹xt
 *
	tib_ùx
, 
	tibv_pd
 *
	tpd
, 
	tdm_ho¡
, 
	tsize_t
 
	tbuf_size
,

34 
	tsize_t
 *
	tbuf_num_p
, 
	tibv_dm
 **
	t±r
, 
	tibv_mr
 **
	tmr
,

35 
	tucc_ba£_lib_t
 *
	tlib
);

38 
usšg
 
RdmaWr™eP¬ams
 = ;

40 
usšg
 
DmP¬ams
 = ;

42 
usšg
 
T¿n¥o£P¬ams
 = 
¡d
::
tu¶e
<, , >;

44 
usšg
 
UmrP¬ams
 = 
¡d
::
tu¶e
<, , , >;

46 
usšg
 
AÎocDmP¬ams
 = 
¡d
::
tu¶e
<, >;

48 
usšg
 
Wa™OnD©aP¬ams
 = 
¡d
::
tu¶e
<
ušt64_t
, uint64_t>;

50 şas 
	c‹¡__mlx5_wqe
 : 
public
 
‹¡__mlx5_rc_qp
 {

51 
public
:

52 
ucc__mlx5_po¡_rdma_â_t
 
po¡_rdma_wr™e
;

53 
ucc__mlx5_po¡_Œª¥o£_â_t
 
po¡_Œª¥o£
;

54 
ucc__mlx5_po¡_wa™_Ú_d©a_â_t
 
po¡_wa™_Ú_d©a
;

55 
ucc__mlx5_po¡_umr_â_t
 
po¡_umr
;

57 
	$S‘Up
()

59 
‹¡__mlx5_rc_qp
::
	`S‘Up
();

60 
	`CHECK_TEST_STATUS
();

62 
po¡_rdma_wr™e
 = (
ucc__mlx5_po¡_rdma_â_t
)
	`dlsym
(

63 
_mlx5_so_hªdË
, "ucc_tl_mlx5_post_rdma");

64 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

66 
po¡_Œª¥o£
 = (
ucc__mlx5_po¡_Œª¥o£_â_t
)
	`dlsym
(

67 
_mlx5_so_hªdË
, "ucc_tl_mlx5_post_transpose");

68 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

70 
po¡_wa™_Ú_d©a
 = (
ucc__mlx5_po¡_wa™_Ú_d©a_â_t
)
	`dlsym
(

71 
_mlx5_so_hªdË
, "ucc_tl_mlx5_post_wait_on_data");

72 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

74 
po¡_umr
 = (
ucc__mlx5_po¡_umr_â_t
)
	`dlsym
(
_mlx5_so_hªdË
,

76 
	`ASSERT_EQ
(
nuÎ±r
, 
	`dË¼Ü
());

78 
	`ü—‹_qp
();

79 
	`CHECK_TEST_STATUS
();

80 
	`cÚÃù_qp_loİback
();

81 
	`CHECK_TEST_STATUS
();

82 
	`ü—‹_umr_qp
();

84 
	}
};

86 
şass
 
	g‹¡__mlx5_Œª¥o£


87 : 
public
 
‹¡__mlx5_wqe
,

88 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
T¿n¥o£P¬ams
> {

91 
şass
 
	g‹¡__mlx5_wa™_Ú_d©a


92 : 
public
 
‹¡__mlx5_wqe
,

93 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
Wa™OnD©aP¬ams
> {

96 
şass
 
	g‹¡__mlx5_umr_wqe
 : 
public
 
‹¡__mlx5_wqe
,

97 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
UmrP¬ams
> {

100 
şass
 
	g‹¡__mlx5_rdma_wr™e


101 : 
public
 
‹¡__mlx5_wqe
,

102 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
RdmaWr™eP¬ams
> {

103 
public
:

104 
DT
 *
¤c
 = 
nuÎ±r
;

105 
DT
 *
	gd¡
 = 
nuÎ±r
;

106 
ibv_mr
 *
	g¤c_mr
 = 
nuÎ±r
;

107 
ibv_mr
 *
	gd¡_mr
 = 
nuÎ±r
;

108 
	gbufsize
;

110 
bufãrs_š™
()

112 
	g¤c
 = (
DT
 *)
m®loc
(
bufsize
);

113 
GTEST_ASSERT_NE
(
¤c
, 
nuÎ±r
);

114 
	gd¡
 = (
DT
 *)
m®loc
(
bufsize
);

115 
GTEST_ASSERT_NE
(
d¡
, 
nuÎ±r
);

117 
	gi
 = 0; i < 
	gbufsize
; i++) {

118 
	g¤c
[
i
] = i % 256;

119 
	gd¡
[
i
] = 0;

122 
	g¤c_mr
 = 
ibv_»g_mr
(
pd
, 
¤c
, 
bufsize
,

123 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
);

124 
GTEST_ASSERT_NE
(
nuÎ±r
, 
¤c_mr
);

125 
	gd¡_mr
 = 
ibv_»g_mr
(
pd
, 
d¡
, 
bufsize
,

126 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
);

127 
GTEST_ASSERT_NE
(
nuÎ±r
, 
d¡_mr
);

130 
wa™_fÜ_com¶‘iÚ
()

132 
	gcom¶‘iÚs_num
 = 0;

133 
ibv_wc
 
	gwcs
[1];

135 !
	gcom¶‘iÚs_num
) {

136 
	gcom¶‘iÚs_num
 = 
ibv_pŞl_cq
(
cq
, 1, 
wcs
);

139 
GTEST_ASSERT_EQ
(
com¶‘iÚs_num
, 1);

140 
GTEST_ASSERT_EQ
(
wcs
[0].
¡©us
, 
IBV_WC_SUCCESS
);

143 
v®id©e_bufãrs
()

145 
	gi
 = 0; i < 
	gbufsize
; i++) {

146 
GTEST_ASSERT_EQ
(
¤c
[
i
], 
d¡
[i]);

150 
T—rDown
()

152 ià(
	g¤c_mr
 !ğ
nuÎ±r
) {

153 
GTEST_ASSERT_EQ
(
ibv_d”eg_mr
(
¤c_mr
), 
UCC_OK
);

155 ià(
	gd¡_mr
 !ğ
nuÎ±r
) {

156 
GTEST_ASSERT_EQ
(
ibv_d”eg_mr
(
d¡_mr
), 
UCC_OK
);

158 ià(
	g¤c
 !ğ
nuÎ±r
) {

159 
ä“
(
¤c
);

161 ià(
	gd¡
 !ğ
nuÎ±r
) {

162 
ä“
(
d¡
);

167 şas 
	c‹¡__mlx5_dm
 : 
public
 
‹¡__mlx5_rdma_wr™e
 {

168 
public
:

169 
ibv_dm
 *
dm_±r
 = 
nuÎ±r
;

170 
ibv_mr
 *
	mdm_mr
 = 
nuÎ±r
;

171 
ibv_®loc_dm_©Œ
 
	mdm_©Œ
;

173 
	$bufãrs_š™
()

175 
‹¡__mlx5_rdma_wr™e
::
	`bufãrs_š™
();

176 
	`CHECK_TEST_STATUS
();

178 
ibv_deviû_©Œ_ex
 
©Œ
;

179 
	`mem£t
(&
©Œ
, 0, (attr));

180 
	`GTEST_ASSERT_EQ
(
	`ibv_qu”y_deviû_ex
(
ùx
, 
NULL
, &
©Œ
), 0);

181 ià(
©Œ
.
max_dm_size
 < 
bufsize
) {

182 ià(!
©Œ
.
max_dm_size
) {

183 
	`GTEST_SKIP
() << "device doesn't support dm‡llocation";

185 
	`GTEST_SKIP
(è<< "th»que¡ed bufã¸siz(=" << 
bufsize


187 << 
©Œ
.
max_dm_size
;

191 
	`mem£t
(&
dm_©Œ
, 0, (dm_attr));

192 
dm_©Œ
.
Ëngth
 = 
bufsize
;

193 
dm_±r
 = 
	`ibv_®loc_dm
(
ùx
, &
dm_©Œ
);

194 ià(!
dm_±r
) {

195 
	`GTEST_SKIP
() << "device cannot‡llocate‡ buffer of size "

196 << 
bufsize
;

199 
dm_mr
 = 
	`ibv_»g_dm_mr
(
pd
, 
dm_±r
, 0, 
dm_©Œ
.
Ëngth
,

200 
IBV_ACCESS_LOCAL_WRITE
 | 
IBV_ACCESS_REMOTE_WRITE
 |

201 
IBV_ACCESS_ZERO_BASED
);

202 
	`GTEST_ASSERT_NE
(
dm_mr
, 
nuÎ±r
);

205 
	$T—rDown
()

207 ià(
dm_mr
) {

208 
	`ibv_d”eg_mr
(
dm_mr
);

210 ià(
dm_±r
) {

211 
	`ibv_ä“_dm
(
dm_±r
);

213 
‹¡__mlx5_rdma_wr™e
::
	`T—rDown
();

214 
	}
}

217 
şass
 
	g‹¡__mlx5_dm_®loc_»g


218 : 
public
 
‹¡__mlx5_wqe
,

219 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
AÎocDmP¬ams
> {

220 
public
:

221 
ucc__mlx5_dm_®loc_»g_â_t
 
dm_®loc_»g
;

222 
S‘Up
()

224 
	g‹¡__mlx5_wqe
::
S‘Up
();

225 
CHECK_TEST_STATUS
();

227 
	gdm_®loc_»g
 = (
ucc__mlx5_dm_®loc_»g_â_t
)
dlsym
(

228 
_mlx5_so_hªdË
, "ucc_tl_mlx5_dm_alloc_reg");

229 
ASSERT_EQ
(
nuÎ±r
, 
dË¼Ü
());

	@test/gtest/tl/tl_test.cc

6 
	~<commÚ/‹¡.h
>

8 şas 
	c‹¡_
 : 
public
 
ucc
::
‹¡
 {};

10 
	$UCC_TEST_F
(
‹¡_
, 
dummy_‹¡
è{ 
	}
}

	@test/gtest/utils/test_cfg_file.cc

8 
	~"uts/ucc_·r£r.h
"

9 
	~"cÜe/ucc_glob®_İts.h
"

11 
	~<commÚ/‹¡.h
>

13 
	succ_g‹¡_cÚfig_ba£
 {

14 
foo
;

15 } 
	tucc_g‹¡_cÚfig_ba£_t
;

17 
	succ_g‹¡_cÚfig
 {

18 
ucc_g‹¡_cÚfig_ba£_t
 
	msu³r
;

19 
	mb¬
;

20 
	mboo
;

21 } 
	tucc_g‹¡_cÚfig_t
;

24 
ucc_cÚfig_f›ld_t
 
	gucc_g‹¡_cÚfig_bË_ba£
[] = {

26 
ucc_off£tof
(
ucc_g‹¡_cÚfig_ba£_t
, 
foo
),

27 
UCC_CONFIG_TYPE_INT
},

29 {
NULL
}

32 
ucc_cÚfig_f›ld_t
 
	gucc_g‹¡_cÚfig_bË
[] = {

33 {"", "", 
NULL
, 
ucc_off£tof
(
ucc_g‹¡_cÚfig_t
, 
su³r
),

34 
UCC_CONFIG_TYPE_TABLE
(
ucc_g‹¡_cÚfig_bË_ba£
)},

37 
ucc_off£tof
(
ucc_g‹¡_cÚfig_t
, 
b¬
),

38 
UCC_CONFIG_TYPE_INT
},

41 
ucc_off£tof
(
ucc_g‹¡_cÚfig_t
, 
boo
),

42 
UCC_CONFIG_TYPE_INT
},

44 {
NULL
}

47 
UCC_CONFIG_DECLARE_TABLE
(
ucc_g‹¡_cÚfig_bË
, "GTEST TABLE", "CFG_",

48 
ucc_g‹¡_cÚfig_t
);

50 şas 
	c‹¡_cfg_fe
 : 
public
 
ucc
::
‹¡
 {

51 
public
:

52 
ucc_fe_cÚfig_t
 *
fe_cfg
;

53 
ucc_g‹¡_cÚfig_t
 
	mcfg
;

54 
	m¡d
::
¡ršg
 
‹¡_dœ
;

55 
	$‹¡_cfg_fe
() {

56 
fe_cfg
 = 
NULL
;

57 
‹¡_dœ
 = 
¡d
::
	`¡ršg
(
GTEST_UCC_TOP_SRCDIR
) +

60 ~
	$‹¡_cfg_fe
() {

61 ià(
fe_cfg
) {

62 
	`ucc_»Ëa£_fe_cÚfig
(
fe_cfg
);

64 
	`ucc_cÚfig_·r£r_»Ëa£_İts
(&
cfg
, 
ucc_g‹¡_cÚfig_bË
);

65 
	}
}

66 
	$š™_cfg
() {

67 
ucc_¡©us_t
 
¡©us
;

68 
¡d
::
	`sw­
(
ucc_glob®_cÚfig
.
fe_cfg
, file_cfg);

69 
¡©us
 = 
	`ucc_cÚfig_·r£r_fl_İts
(

70 &
cfg
, 
	`UCC_CONFIG_GET_TABLE
(
ucc_g‹¡_cÚfig_bË
),

72 
¡d
::
	`sw­
(
ucc_glob®_cÚfig
.
fe_cfg
, file_cfg);

73 
	`EXPECT_EQ
(
UCC_OK
, 
¡©us
);

74 
	}
};

77 
	$UCC_TEST_F
(
‹¡_cfg_fe
, 
·r£_exi¡šg
) {

78 
¡d
::
¡ršg
 
f’ame
 = 
‹¡_dœ
 + "ucc_test.conf";

80 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_·r£_fe_cÚfig
(
f’ame
.
	`c_¡r
(), &
fe_cfg
));

81 
	}
}

83 
	$UCC_TEST_F
(
‹¡_cfg_fe
, 
·r£_nÚ_exi¡šg
) {

84 
¡d
::
¡ršg
 
f’ame
 = 
‹¡_dœ
 + "ucc_test_nonexisting.conf";

86 
	`EXPECT_EQ
(
UCC_ERR_NOT_FOUND
, 
	`ucc_·r£_fe_cÚfig
(
f’ame
.
	`c_¡r
(),

87 &
fe_cfg
));

88 
	}
}

91 
	$UCC_TEST_F
(
‹¡_cfg_fe
, 
İts_­¶›d
) {

92 
¡d
::
¡ršg
 
f’ame
 = 
‹¡_dœ
 + "ucc_test.conf";

94 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_·r£_fe_cÚfig
(
f’ame
.
	`c_¡r
(), &
fe_cfg
));

95 
	`š™_cfg
();

96 
	`EXPECT_EQ
(10, 
cfg
.
su³r
.
foo
);

97 
	`EXPECT_EQ
(20, 
cfg
.
b¬
);

98 
	`EXPECT_EQ
(1, 
cfg
.
boo
);

99 
	}
}

103 
	$UCC_TEST_F
(
‹¡_cfg_fe
, 
’v_´eã»nû
) {

104 
¡d
::
¡ršg
 
f’ame
 = 
‹¡_dœ
 + "ucc_test.conf";

106 
	`£‹nv
("GTEST_UCC_CFG_BAR", "123", 1);

107 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_·r£_fe_cÚfig
(
f’ame
.
	`c_¡r
(), &
fe_cfg
));

108 
	`š™_cfg
();

109 
	`un£‹nv
("GTEST_UCC_CFG_BAR");

110 
	`EXPECT_EQ
(10, 
cfg
.
su³r
.
foo
);

112 
	`EXPECT_EQ
(123, 
cfg
.
b¬
);

113 
	`EXPECT_EQ
(1, 
cfg
.
boo
);

114 
	}
}

	@test/gtest/utils/test_ep_map.cc

7 
	~"uts/ucc_cŞl_uts.h
"

9 
	~<commÚ/‹¡.h
>

10 
	~<¡ršg
>

11 
	~<veùÜ
>

13 şas 
	cEpM­
 {

14 
public
:

15 
ucc_•_m­_t
 
m­
;

16 
ucc_¿nk_t
 * 
¬¿y
;

17 
	$EpM­
(){};

18 
	$EpM­
(
ucc_•_m­_t
 
_m­
)

20 
¬¿y
 = 
NULL
;

21 
m­
 = 
_m­
;

22 
	}
};

23 
	$EpM­
(
ušt64_t
 
fuÎ
, 
boŞ
 
»v”£
 = 
çl£
)

25 
¬¿y
 = 
NULL
;

26 ià(
»v”£
) {

27 
m­
 = 
	`ucc_•_m­_ü—‹_»v”£
(
fuÎ
);

29 
m­
.
ty³
 = 
UCC_EP_MAP_FULL
;

30 
m­
.
•_num
 = 
fuÎ
;

32 
	}
};

33 
	$EpM­
(
ušt64_t
 
¡¬t
, 
št64_t
 
¡ride
, ušt64_ˆ
num
, ušt64_ˆ
fuÎ
) {

34 
m­
.
ty³
 = ((
num
 =ğ
fuÎ
è&& (
¡ride
 == 1)) ?

35 
UCC_EP_MAP_FULL
 : 
UCC_EP_MAP_STRIDED
;

36 
m­
.
•_num
 = 
num
;

37 
m­
.
¡rided
.
¡¬t
 = start;

38 
m­
.
¡rided
.
¡ride
 = stride;

39 
¬¿y
 = 
NULL
;

40 
	}
};

41 
EpM­
(cÚ¡ 
¡d
::
veùÜ
<
ucc_¿nk_t
> &
¿nks
, 
ušt64_t
 
fuÎ
,

42 
Ãed_ä“
 = 0) {

43 
¬¿y
 = (
ucc_¿nk_t
*)
m®loc
((ucc_¿nk_tè* 
¿nks
.
size
());

44 
memıy
(
¬¿y
, 
¿nks
.
d©a
(),„ªks.
size
(è* (
ucc_¿nk_t
));

45 
m­
 = 
ucc_•_m­_äom_¬¿y
(&
¬¿y
, 
¿nks
.
size
(),

46 
fuÎ
, 
Ãed_ä“
);

48 ~
	$EpM­
() {

49 ià(
¬¿y
) {

50 
	`ä“
(
¬¿y
);

52 
	}
}

53 
ä›nd
 
boŞ
 
İ”©Ü
==(cÚ¡ 
EpM­
 &
lhs
, cÚ¡ EpM­ &
rhs
) {

54 ià((
lhs
.
m­
.
ty³
 !ğ
rhs
.map.type) ||

55 (
lhs
.
m­
.
•_num
 !ğ
rhs
.map.ep_num)) {

56  
çl£
;

58 
lhs
.
m­
.
ty³
) {

59 
UCC_EP_MAP_FULL
:

60  
Œue
;

61 
UCC_EP_MAP_STRIDED
:

62  (
lhs
.
m­
.
¡rided
.
¡¬t
 =ğ
rhs
.map.strided.start) &&

63 (
lhs
.
m­
.
¡rided
.
¡ride
 =ğ
rhs
.map.strided.stride);

67  
çl£
;

71 şas 
	c‹¡_•_m­
 : 
public
 
ucc
::
‹¡
 {};

73 
	$UCC_TEST_F
(
‹¡_•_m­
, 
äom_¬¿y
)

76 
	`EXPECT_EQ
(
	`EpM­
({1,2,3,4,5,6,7,8,9,10}, 10), EpMap(10));

79 
	`EXPECT_EQ
(
	`EpM­
({1,31,61,91,121}, 150), EpMap(1, 30, 5, 150));

82 
	`EXPECT_EQ
(
	`EpM­
({100,90,80,70,60}, 150), EpMap(100, -10, 5, 150));

83 
	}
}

85 
	$UCC_TEST_F
(
‹¡_•_m­
, 
äom_¬¿y_ä“
)

88 
	`EXPECT_NE
((*)
NULL
, 
	`EpM­
({1, 5, 6, 8, 11}, 10, 1).
¬¿y
);

91 
	`EXPECT_EQ
((*)
NULL
, 
	`EpM­
({2, 4, 6, 8, 10}, 10, 1).
¬¿y
);

94 
	`EXPECT_EQ
((*)
NULL
, 
	`EpM­
({1, 2, 3, 4, 5}, 5, 1).
¬¿y
);

95 
	}
}

97 
	$UCC_TEST_F
(
‹¡_•_m­
, 
»v”£
)

99 cÚ¡ 
size
 = 10;

100 
ucc_•_m­_t
 
m­
 = 
	`ucc_•_m­_ü—‹_»v”£
(
size
);

102 
i
 = 0; i < 
size
; i++) {

103 
	`EXPECT_EQ
(
size
 - 1 - 
i
, 
	`ucc_•_m­_ev®
(
m­
, i));

105 
	}
}

107 
	$UCC_TEST_F
(
‹¡_•_m­
, 
Ã¡ed
)

109 autØ
m­1
 = 
	`EpM­
(100);

110 autØ
m­2
 = 
	`EpM­
(0, 2, 50, 100);

111 autØ
m­3
 = 
	`EpM­
(1, 2, 25, 50);

112 
ucc_•_m­_t
 
Ã¡ed1
, 
Ã¡ed2
;

114 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_•_m­_ü—‹_Ã¡ed
(&
m­1
.
m­
, &
m­2
.m­, &
Ã¡ed1
));

115 
	`EXPECT_EQ
(50, 
Ã¡ed1
.
•_num
);

116 
i
 = 0; i < 
Ã¡ed1
.
•_num
; i++) {

117 
	`EXPECT_EQ
(0 + 
i
 * 2, 
	`ucc_•_m­_ev®
(
Ã¡ed1
, i));

120 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_•_m­_ü—‹_Ã¡ed
(&
Ã¡ed1
, &
m­3
.
m­
, &
Ã¡ed2
));

121 
	`EXPECT_EQ
(25, 
Ã¡ed2
.
•_num
);

122 
i
 = 0; i < 
Ã¡ed2
.
•_num
; i++) {

123 
	`EXPECT_EQ
(2 + 
i
 * 4, 
	`ucc_•_m­_ev®
(
Ã¡ed2
, i));

126 
	`ucc_•_m­_de¡roy_Ã¡ed
(&
Ã¡ed1
);

127 
	`ucc_•_m­_de¡roy_Ã¡ed
(&
Ã¡ed2
);

128 
	}
}

130 şas 
	c‹¡_•_m­_šv
 : 
public
 
‹¡_•_m­
 {

131 
public
:

132 
	$check_šv
(
EpM­
 
m­
)

134 
ucc_•_m­_t
 
šv
;

135 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_•_m­_ü—‹_šv”£
(
m­
.m­, &
šv
, 0));

136 
i
 = 0; i < 
m­
.m­.
•_num
; i++) {

137 
	`EXPECT_EQ
(
i
, 
	`ucc_•_m­_ev®
(
šv
, ucc_•_m­_ev®(
m­
.map, i)));

139 
	`ucc_•_m­_de¡roy
(&
šv
);

141 
	}
};

143 
	$UCC_TEST_F
(
‹¡_•_m­_šv
, 
cÚtig
)

146 
	`check_šv
(
	`EpM­
(10));

149 
	`check_šv
(
	`EpM­
(10, 
Œue
));

150 
	}
}

152 
	$UCC_TEST_F
(
‹¡_•_m­_šv
, 
¡rided
)

155 
	`check_šv
(
	`EpM­
(1, 30, 5, 150));

158 
	`check_šv
(
	`EpM­
(100, -10, 5, 150));

159 
	}
}

161 
	$UCC_TEST_F
(
‹¡_•_m­_šv
, 
¿ndom
)

163 
	`check_šv
(
	`EpM­
({4, 0, 1, 2, 3}, 5));

164 
	}
}

	@test/gtest/utils/test_lock_free_queue.cc

8 
	~"uts/ucc_lock_ä“_queue.h
"

9 
	~"uts/ucc_©omic.h
"

10 
	~"uts/ucc_m®loc.h
"

11 
	~<±h»ad.h
>

12 
	~<¡dio.h
>

14 
	~<commÚ/‹¡.h
>

15 
	~<veùÜ
>

17 
	#NUM_ITERS
 5000000

	)

19 
	succ_‹¡_queue
 {

20 
ucc_lf_queue_t
 
lf_queue
;

21 
št64_t
 
‹¡_sum
;

22 
ušt32_t
 
–ems_num
;

23 
ušt32_t
 
aùive_´oduûrs_th»ads
;

24 
ušt32_t
 
memÜy_”r
;

25 } 
	tucc_‹¡_queue_t
;

27 *
	$´oduûr_th»ad
(*
¬g
)

29 
ucc_‹¡_queue_t
 *
‹¡
 = (ucc_‹¡_queue_ˆ*)
¬g
;

30 
j
 = 0; j < 
NUM_ITERS
; j++) {

31 
ucc_lf_queue_–em_t
 *
–em
 =

32 (
ucc_lf_queue_–em_t
 *)
	`ucc_m®loc
((ucc_lf_queue_elem_t));

33 
	`ucc_lf_queue_š™_–em
(
–em
);

34 ià(!
–em
) {

35 
	`ucc_©omic_add32
(&
‹¡
->
memÜy_”r
, 1);

36 
ex™
;

38 
	`ucc_lf_queue_’queue
(&
‹¡
->
lf_queue
, 
–em
);

39 
	`ucc_©omic_add64
((
ušt64_t
 *)&
‹¡
->
‹¡_sum
, (ušt64_t)
–em
);

40 
	`ucc_©omic_add32
(&
‹¡
->
–ems_num
, 1);

42 
ex™
:

43 
	`ucc_©omic_sub32
(&
‹¡
->
aùive_´oduûrs_th»ads
,1);

45 
	}
}

47 *
	$cÚsum”_th»ad
(*
¬g
)

49 
ucc_‹¡_queue_t
 *
‹¡
 = (ucc_‹¡_queue_ˆ*)
¬g
;

50 
‹¡
->
aùive_´oduûrs_th»ads
 ||e¡->
–ems_num
){

51 
ucc_lf_queue_–em_t
 *
–em
 = 
	`ucc_lf_queue_dequeue
(&
‹¡
->
lf_queue
, 1);

52 ià(
–em
) {

53 
	`ucc_©omic_sub64
((
ušt64_t
 *)&
‹¡
->
‹¡_sum
, (ušt64_t)
–em
);

54 
	`ucc_©omic_sub32
(&
‹¡
->
–ems_num
, 1);

55 
	`ucc_ä“
(
–em
);

59 
	}
}

61 şas 
	c‹¡_lf_queue
 : 
public
 
ucc
::
‹¡


63 
public
:

64 
ucc_‹¡_queue_t
 
‹¡
;

65 
	mi
;

66 
	m¡d
::
veùÜ
<
±h»ad_t
> 
´oduûrs_th»ads
;

67 
	m¡d
::
veùÜ
<
±h»ad_t
> 
cÚsum”s_th»ads
;

68 
lf_‹¡
(
num_of_´oduûrs
, 
num_of_cÚsum”s
);

71 
	g‹¡_lf_queue
::
	$lf_‹¡
(
num_of_´oduûrs
, 
num_of_cÚsum”s
){

72 
´oduûrs_th»ads
.
	`»size
(
num_of_´oduûrs
);

73 
cÚsum”s_th»ads
.
	`»size
(
num_of_cÚsum”s
);

74 
	`mem£t
(&
‹¡
, 0, (
ucc_‹¡_queue_t
));

75 
	`ucc_lf_queue_š™
(&
‹¡
.
lf_queue
);

76 
i
 = 0; i < 
num_of_´oduûrs
; i++) {

77 
	`ucc_©omic_add32
(&
‹¡
.
aùive_´oduûrs_th»ads
, 1);

78 
	`±h»ad_ü—‹
(&
´oduûrs_th»ads
[
i
], 
NULL
, &
´oduûr_th»ad
,

79 (*)&
‹¡
);

81 
i
 = 0; i < 
num_of_cÚsum”s
; i++) {

82 
	`±h»ad_ü—‹
(&
cÚsum”s_th»ads
[
i
], 
NULL
, &
cÚsum”_th»ad
,

83 (*)&
‹¡
);

85 
i
 = 0; i < 
num_of_´oduûrs
; i++) {

86 
	`±h»ad_još
(
´oduûrs_th»ads
[
i
], 
NULL
);

88 
i
 = 0; i < 
num_of_cÚsum”s
; i++) {

89 
	`±h»ad_još
(
cÚsum”s_th»ads
[
i
], 
NULL
);

91 
	`ucc_lf_queue_de¡roy
(&
‹¡
.
lf_queue
);

92 ià(
‹¡
.
memÜy_”r
) {

95 ià(
‹¡
.
‹¡_sum
) {

99 
	}
}

102 
	$UCC_TEST_F
(
‹¡_lf_queue
, 
ÚeProduûrOÃCÚsum”
)

104 
	`EXPECT_EQ
(
	`lf_‹¡
(1, 1), 0);

105 
	}
}

107 
	$UCC_TEST_F
(
‹¡_lf_queue
, 
ÚeProduûrMªyCÚsum”s
)

109 
	`EXPECT_EQ
(
	`lf_‹¡
(1, 7), 0);

110 
	}
}

112 
	$UCC_TEST_F
(
‹¡_lf_queue
, 
mªyProduûrsMªyCÚsum”s
)

114 
	`EXPECT_EQ
(
	`lf_‹¡
(7, 7), 0);

115 
	}
}

	@test/gtest/utils/test_math.cc

6 
	~"uts/ucc_m©h.h
"

8 
	~<commÚ/‹¡.h
>

10 
usšg
 
æßtP¬ams
 = ;

11 
şass
 
	g‹¡_æßts_ÿ¡
 : 
public
 
ucc
::
‹¡
,

12 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
æßtP¬ams
> {

15 
	$UCC_TEST_P
(
‹¡_æßts_ÿ¡
, 
¡¬t_w™h_æßt
)

17 
p
 = 
	`G‘P¬am
();

18 
ušt16_t
 
bæßt16V®
;

19 
	`æßt32tobæßt16
(
p
, &
bæßt16V®
);

21 
	`EXPECT_EQ
(
p
, 
	`bæßt16toæßt32
(&
bæßt16V®
));

22 
	}
}

24 
INSTANTIATE_TEST_CASE_P
(, 
‹¡_æßts_ÿ¡
,

25 ::
‹¡šg
::
V®ues
(-4.26941244675e+18,

28 
usšg
 
	gbæßt16P¬ams
 = 
ušt16_t
;

29 
şass
 
	g‹¡_bæßts16_ÿ¡


30 : 
public
 
ucc
::
‹¡
,

31 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
bæßt16P¬ams
> {

34 
	$UCC_TEST_P
(
‹¡_bæßts16_ÿ¡
, 
¡¬t_w™h_bæßt16
)

36 
ušt16_t
 
p
 = 
	`G‘P¬am
();

37 
ušt16_t
 
»s
;

38 
	`æßt32tobæßt16
(
	`bæßt16toæßt32
(&
p
), &
»s
);

39 
	`EXPECT_EQ
(
p
, 
»s
);

40 
	}
}

42 
INSTANTIATE_TEST_CASE_P
(, 
‹¡_bæßts16_ÿ¡
,

43 ::
‹¡šg
::
V®ues
(31000, 400, 17, 13569, 0));

	@test/gtest/utils/test_parser.cc

7 
	~"uts/ucc_·r£r.h
"

8 
	~"uts/ucc_d©a¡ruù.h
"

10 
	~<commÚ/‹¡.h
>

11 
	~<commÚ/‹¡_ucc.h
>

13 şas 
	c‹¡_·r£_m¿nge
 : 
public
 
ucc
::
‹¡
 {

14 
public
:

15 
ucc_m¿nge_ušt_t
 *
p
;

16 
	$‹¡_·r£_m¿nge
() {

17 
p
 = (
ucc_m¿nge_ušt_t
 *è
	`ucc_m®loc
((ucc_mrange_uint_t));

19 ~
	$‹¡_·r£_m¿nge
() {

20 
	`ucc_ä“
(
p
);

21 
	}
}

24 
	$UCC_TEST_F
(
‹¡_·r£_m¿nge
, 
check_v®id
) {

25 
¡d
::
¡ršg
 
¡r
 = "0-4K:host:8,auto";

26 
size_t
 
msgsize1
 = 1024, 
msgsize2
 = 8192;

28 
	`EXPECT_EQ
(1, 
	`ucc_cÚfig_ssÿnf_ušt_¿nged
(
¡r
.
	`c_¡r
(), 
p
, 
NULL
));

29 
	`EXPECT_EQ
(8, 
	`ucc_m¿nge_ušt_g‘
(
p
, 
msgsize1
, 
UCC_MEMORY_TYPE_HOST
));

30 
	`EXPECT_EQ
(
UCC_UUNITS_AUTO
, 
	`ucc_m¿nge_ušt_g‘
(
p
, 
msgsize2
,

31 
UCC_MEMORY_TYPE_HOST
));

32 
	`ucc_m¿nge_ušt_de¡roy
(
p
);

33 
	}
}

35 
	$UCC_TEST_F
(
‹¡_·r£_m¿nge
, 
check_šv®id
) {

36 
¡d
::
¡ršg
 
¡r
 = "0-4K:host:8:8";

38 
	`EXPECT_EQ
(0, 
	`ucc_cÚfig_ssÿnf_ušt_¿nged
(
¡r
.
	`c_¡r
(), 
p
, 
NULL
));

39 
	`ucc_m¿nge_ušt_de¡roy
(
p
);

41 
¡r
 = "0-4K:host:a";

42 
	`EXPECT_EQ
(0, 
	`ucc_cÚfig_ssÿnf_ušt_¿nged
(
¡r
.
	`c_¡r
(), 
p
, 
NULL
));

43 
	`ucc_m¿nge_ušt_de¡roy
(
p
);

45 
¡r
 = "0-4K:gpu:8";

46 
	`EXPECT_EQ
(0, 
	`ucc_cÚfig_ssÿnf_ušt_¿nged
(
¡r
.
	`c_¡r
(), 
p
, 
NULL
));

47 
	`ucc_m¿nge_ušt_de¡roy
(
p
);

49 
¡r
 = "0-f:host:8";

50 
	`EXPECT_EQ
(0, 
	`ucc_cÚfig_ssÿnf_ušt_¿nged
(
¡r
.
	`c_¡r
(), 
p
, 
NULL
));

51 
	`ucc_m¿nge_ušt_de¡roy
(
p
);

52 
	}
}

54 
	$UCC_TEST_F
(
‹¡_·r£_m¿nge
, 
check_¿nge_muÉË
) {

55 
¡d
::
¡ršg
 
¡r
 =

57 
size_t
 
msgsize1
 = 1024, 
msgsize2
 = 8192;

59 
	`EXPECT_EQ
(1, 
	`ucc_cÚfig_ssÿnf_ušt_¿nged
(
¡r
.
	`c_¡r
(), 
p
, 
NULL
));

60 
	`EXPECT_EQ
(8, 
	`ucc_m¿nge_ušt_g‘
(
p
, 
msgsize1
, 
UCC_MEMORY_TYPE_HOST
));

61 
	`EXPECT_EQ
(10, 
	`ucc_m¿nge_ušt_g‘
(
p
, 
msgsize2
, 
UCC_MEMORY_TYPE_HOST
));

62 
	`EXPECT_EQ
(7, 
	`ucc_m¿nge_ušt_g‘
(
p
, 
msgsize1
, 
UCC_MEMORY_TYPE_CUDA
));

63 
	`EXPECT_EQ
(
UCC_UUNITS_AUTO
, 
	`ucc_m¿nge_ušt_g‘
(
p
, 
msgsize2
,

64 
UCC_MEMORY_TYPE_CUDA
));

65 
	`EXPECT_EQ
(6, 
	`ucc_m¿nge_ušt_g‘
(
p
, 
msgsize1
,

66 
UCC_MEMORY_TYPE_CUDA_MANAGED
));

67 
	`EXPECT_EQ
(
UCC_UUNITS_AUTO
,

68 
	`ucc_m¿nge_ušt_g‘
(
p
, 
msgsize2
, 
UCC_MEMORY_TYPE_CUDA_MANAGED
));

69 
	`ucc_m¿nge_ušt_de¡roy
(
p
);

70 
	}
}

	@test/gtest/utils/test_string.cc

6 
	~"uts/ucc_¡ršg.h
"

7 
	~"uts/ucc_m®loc.h
"

9 
	~<commÚ/‹¡.h
>

10 
	~<¡ršg
>

11 
	~<veùÜ
>

13 
usšg
 
P¬am
 = 
¡d
::
veùÜ
<¡d::
¡ršg
>;

14 
şass
 
	g‹¡_¡ršg
 : 
public
 
ucc
::
‹¡
,

15 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
P¬am
> {

16 
public
:

17 
¡d
::
¡ršg
 
¡r
;

18 
make_¡r
(
P¬am
 &
p
);

21 
	g‹¡_¡ršg
::
	$make_¡r
(
P¬am
 &
p
)

23 
i
;

24 
¡r
 = "";

25 
i
 = 1; i < 
p
.
	`size
() - 1; i++) {

26 
¡r
 +ğ
p
[
i
] +…[0];

28 
¡r
 +ğ
p
[
i
];

29 
	}
}

31 
	$UCC_TEST_P
(
‹¡_¡ršg
, 
¥l™
)

33 autØ
p
 = 
	`G‘P¬am
();

34 cÚ¡ *
d–im
 = 
p
[0].
	`c_¡r
();

35 
	`make_¡r
(
p
);

36 **
¥l™
 = 
	`ucc_¡r_¥l™
(
¡r
.
	`c_¡r
(), 
d–im
);

37 
	`EXPECT_NE
(
nuÎ±r
, 
¥l™
);

38 
	`EXPECT_EQ
(
	`ucc_¡r_¥l™_couÁ
(
¥l™
), 
p
.
	`size
() - 1);

39 autØ
i
 = 0; i < 
	`ucc_¡r_¥l™_couÁ
(
¥l™
); i++) {

40 
	`EXPECT_EQ
(
p
[
i
 + 1], 
¥l™
[i]);

42 
	`ucc_¡r_¥l™_ä“
(
¥l™
);

43 
	}
}

45 
INSTANTIATE_TEST_CASE_P
(

46 , 
‹¡_¡ršg
,

47 ::
‹¡šg
::
V®ues
(
¡d
::
veùÜ
<¡d::
¡ršg
>({",", "aaa", "bbb", "ccc"}),

48 
¡d
::
veùÜ
<¡d::
¡ršg
>({":", "a", "b", "c", "d", "e"}),

49 
¡d
::
veùÜ
<¡d::
¡ršg
>({" ", "a", "bb"}),

50 
¡d
::
veùÜ
<¡d::
¡ršg
>({"...", "aaaaaa", "b",

53 
	$UCC_TEST_F
(
‹¡_¡ršg
, 
¥l™_no_d–im
)

55 
¡d
::
¡ršg
 
d–im
 = ":";

56 
¡d
::
¡ršg
 
s
 = "string with‚o delimiter";

57 ** 
¥l™
 = 
	`ucc_¡r_¥l™
(
s
.
	`c_¡r
(), 
d–im
.c_str());

58 
	`EXPECT_NE
(
nuÎ±r
, 
¥l™
);

59 
	`EXPECT_EQ
(
	`ucc_¡r_¥l™_couÁ
(
¥l™
), 1);

60 
	`EXPECT_EQ
(
s
, 
¥l™
[0]);

61 
	`ucc_¡r_¥l™_ä“
(
¥l™
);

62 
	}
}

64 
	$UCC_TEST_F
(
‹¡_¡ršg
, 
fšd_Ï¡
)

66 cÚ¡ * 
¡r1
 = "aaa bbb‡aa ccc‡aa ddd";

67 cÚ¡ * 
¡r2
 = "/tmp/build/ucc_tl_ucp/install/lib/ucc_tl_ucp.so";

68 cÚ¡ *
s
;

70 
s
 = 
	`ucc_¡r¡r_Ï¡
(
¡r1
, "aaa");

71 
	`EXPECT_EQ
(16, (
±rdiff_t
)
s
 - (±rdiff_t)
¡r1
);

73 
s
 = 
	`ucc_¡r¡r_Ï¡
(
¡r2
, "ucc_tl_ucp");

74 
	`EXPECT_EQ
(
	`¡¾’
(
¡r2
) - strlen("ucc_tl_ucp.so"),

75 (
±rdiff_t
)
s
 - (±rdiff_t)
¡r2
);

77 
s
 = 
	`ucc_¡r¡r_Ï¡
(
¡r1
, "fff");

78 
	`EXPECT_EQ
(
NULL
, 
s
);

80 
s
 = 
	`ucc_¡r¡r_Ï¡
(
¡r2
, "/tmp");

81 
	`EXPECT_EQ
(
¡r2
, 
s
);

82 
	}
}

84 
	$UCC_TEST_F
(
‹¡_¡ršg
, 
cÚÿt
)

86 *
r¡
;

88 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_¡r_cÚÿt
("¯a", "bbb", &
r¡
));

89 
	`EXPECT_EQ
("¯abbb", 
¡d
::
	`¡ršg
(
r¡
));

90 
	`ucc_ä“
(
r¡
);

92 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_¡r_cÚÿt
("¯abbbccc", "d", &
r¡
));

93 
	`EXPECT_EQ
("¯abbbcccd", 
¡d
::
	`¡ršg
(
r¡
));

94 
	`ucc_ä“
(
r¡
);

96 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_¡r_cÚÿt
("¯a", "", &
r¡
));

97 
	`EXPECT_EQ
("¯a", 
¡d
::
	`¡ršg
(
r¡
));

98 
	`ucc_ä“
(
r¡
);

100 
	`EXPECT_EQ
(
UCC_OK
, 
	`ucc_¡r_cÚÿt
("", "¯a", &
r¡
));

101 
	`EXPECT_EQ
("¯a", 
¡d
::
	`¡ršg
(
r¡
));

102 
	`ucc_ä“
(
r¡
);

103 
	}
}

	@test/mpi/buffer.cc

6 
	~<io¡»am
>

7 
	~<mpi.h
>

8 
	~<ucc/­i/ucc.h
>

9 
	gBEGIN_C_DECLS


10 
	~"compÚ’ts/mc/ucc_mc.h
"

11 
	~"uts/ucc_m©h.h
"

12 
	gEND_C_DECLS


13 
	~"‹¡_mpi.h
"

14 
	~<com¶ex.h
>

16 
	#TEST_MPI_FP_EPSILON
 1e-5

	)

18 
	g‹m¶©e
<
ty³Çme
 
	gT
>

19 
	$š™_bufãr_ho¡
(*
buf
, 
size_t
 
couÁ
, 
_v®ue
)

21 
T
 *
±r
 = (T *)
buf
;

22 
size_t
 
i
 = 0; i < 
couÁ
; i++) {

23 
±r
[
i
] = (
T
)((
_v®ue
 + i + 1) % 128);

25 
	}
}

27 
	$š™_bufãr
(*
_buf
, 
size_t
 
couÁ
, 
ucc_d©©y³_t
 
dt
,

28 
ucc_memÜy_ty³_t
 
mt
, 
v®ue
, 
off£t
)

30 *
buf
 = 
NULL
;

31 ià(
mt
 =ğ
UCC_MEMORY_TYPE_CUDA
 || mˆ=ğ
UCC_MEMORY_TYPE_ROCM
) {

32 
buf
 = 
	`ucc_m®loc
(
couÁ
 * 
	`ucc_dt_size
(
dt
), "buf");

33 
	`UCC_MALLOC_CHECK
(
buf
);

34 } ià(
mt
 =ğ
UCC_MEMORY_TYPE_HOST
 || mˆ=ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
) {

35 
buf
 = 
_buf
;

37 
¡d
::
û¼
 << "Unsupported mt\n";

38 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

41 
v®ue
 +ğ
off£t
;

42 
dt
) {

43 
UCC_DT_INT8
:

44 
š™_bufãr_ho¡
<
št8_t
>(
buf
, 
couÁ
, 
v®ue
);

46 
UCC_DT_UINT8
:

47 
š™_bufãr_ho¡
<
ušt8_t
>(
buf
, 
couÁ
, 
v®ue
);

49 
UCC_DT_INT16
:

50 
š™_bufãr_ho¡
<
št16_t
>(
buf
, 
couÁ
, 
v®ue
);

52 
UCC_DT_UINT16
:

53 
š™_bufãr_ho¡
<
ušt16_t
>(
buf
, 
couÁ
, 
v®ue
);

55 
UCC_DT_INT32
:

56 
š™_bufãr_ho¡
<
št32_t
>(
buf
, 
couÁ
, 
v®ue
);

58 
UCC_DT_UINT32
:

59 
š™_bufãr_ho¡
<
ušt32_t
>(
buf
, 
couÁ
, 
v®ue
);

61 
UCC_DT_INT64
:

62 
š™_bufãr_ho¡
<
št64_t
>(
buf
, 
couÁ
, 
v®ue
);

64 
UCC_DT_UINT64
:

65 
š™_bufãr_ho¡
<
ušt64_t
>(
buf
, 
couÁ
, 
v®ue
);

67 
UCC_DT_FLOAT32
:

68 
š™_bufãr_ho¡
<>(
buf
, 
couÁ
, 
v®ue
);

70 
UCC_DT_FLOAT64
:

71 
š™_bufãr_ho¡
<>(
buf
, 
couÁ
, 
v®ue
);

73 
UCC_DT_FLOAT128
:

74 
š™_bufãr_ho¡
<>(
buf
, 
couÁ
, 
v®ue
);

76 
UCC_DT_FLOAT32_COMPLEX
:

77 
š™_bufãr_ho¡
<
_Com¶ex
>(
buf
, 
couÁ
, 
v®ue
);

79 
UCC_DT_FLOAT64_COMPLEX
:

80 
š™_bufãr_ho¡
<
_Com¶ex
>(
buf
, 
couÁ
, 
v®ue
);

82 
UCC_DT_FLOAT128_COMPLEX
:

83 
š™_bufãr_ho¡
<
_Com¶ex
>(
buf
, 
couÁ
, 
v®ue
);

86 
¡d
::
û¼
 << "Unsupported dt\n";

87 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

90 ià(
UCC_MEMORY_TYPE_HOST
 !ğ
mt
 && 
UCC_MEMORY_TYPE_CUDA_MANAGED
 != mt) {

91 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
_buf
, 
buf
, 
couÁ
 * 
	`ucc_dt_size
(
dt
),

92 
mt
, 
UCC_MEMORY_TYPE_HOST
));

93 
	`ucc_ä“
(
buf
);

95 
	}
}

97 
	g‹m¶©e
<
ty³Çme
 
	gT
>

98 
šlše
 
boŞ
 
	$is_equ®
(
T
 
a
, T 
b
, T 
•sÚ
)

100  
	`çbs
(
a
 - 
b
è<ğ((çbs×è< fabs(bè? fabs(bè: fabs×)è* 
•sÚ
);

101 
	}
}

103 
šlše
 
boŞ
 
	$is_equ®_com¶ex
(
_Com¶ex
 
a
, _Com¶ex 
b
,

104 
•sÚ
)

106  (
	`is_equ®
(
	`ü—lf
(
a
), c»®f(
b
), ()
•sÚ
) &&

107 
	`is_equ®
(
	`cimagf
(
a
), cimagf(
b
), ()
•sÚ
));

108 
	}
}

110 
šlše
 
boŞ
 
	$is_equ®_com¶ex
(
_Com¶ex
 
a
, _Com¶ex 
b
,

111 
•sÚ
)

113  (
	`is_equ®
(
	`ü—l
(
a
), c»®(
b
), 
•sÚ
) &&

114 
	`is_equ®
(
	`cimag
(
a
), cimag(
b
), 
•sÚ
));

115 
	}
}

116 
šlše
 
boŞ
 
	$is_equ®_com¶ex
(
_Com¶ex
 
a
,

117 
_Com¶ex
 
b
, 
•sÚ
)

119  (
	`is_equ®
(
	`ü—Î
(
a
), c»®l(
b
), ()
•sÚ
) &&

120 
	`is_equ®
(
	`cimagl
(
a
), cimagl(
b
), ()
•sÚ
));

121 
	}
}

123 
	g‹m¶©e
<
ty³Çme
 
	gT
>

124 
ucc_¡©us_t
 
	$com·»_bufãrs_å
(
T
 *
b1
, T *
b2
, 
size_t
 
couÁ
) {

125 
T
 
•sÚ
 = (T)
TEST_MPI_FP_EPSILON
;

126 
size_t
 
i
 = 0; i < 
couÁ
; i++) {

127 ià(!
	`is_equ®
(
b1
[
i
], 
b2
[i], 
•sÚ
)) {

128  
UCC_ERR_NO_MESSAGE
;

131  
UCC_OK
;

132 
	}
}

134 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

135 
ucc_¡©us_t
 
	$com·»_bufãrs_com¶ex
(
T
 *
b1
, T *
b2
, 
size_t
 
couÁ
)

137 
•sÚ
 = ()
TEST_MPI_FP_EPSILON
;

138 
size_t
 
i
 = 0; i < 
couÁ
; i++) {

139 ià(!
	`is_equ®_com¶ex
(
b1
[
i
], 
b2
[i], 
•sÚ
)) {

140  
UCC_ERR_NO_MESSAGE
;

143  
UCC_OK
;

144 
	}
}

146 
ucc_¡©us_t
 
	$com·»_bufãrs
(*
_r¡
, *
ex³ùed
, 
size_t
 
couÁ
,

147 
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³_t
 
mt
)

149 
ucc_¡©us_t
 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

150 
ucc_mc_bufãr_h—d”_t
 *
r¡_mc_h—d”
;

151 *
r¡
 = 
NULL
;

153 ià(
UCC_MEMORY_TYPE_HOST
 =ğ
mt
 || mˆ=ğ
UCC_MEMORY_TYPE_CUDA_MANAGED
) {

154 
r¡
 = 
_r¡
;

155 } ià(
UCC_MEMORY_TYPE_CUDA
 =ğ
mt
 || 
UCC_MEMORY_TYPE_ROCM
 == mt) {

156 
	`UCC_ALLOC_COPY_BUF
(
r¡_mc_h—d”
, 
UCC_MEMORY_TYPE_HOST
, 
_r¡
, 
mt
,

157 
couÁ
 * 
	`ucc_dt_size
(
dt
));

158 
r¡
 = 
r¡_mc_h—d”
->
addr
;

160 
¡d
::
û¼
 << "Unsupported mt\n";

161 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

164 ià(
dt
 =ğ
UCC_DT_FLOAT32
) {

165 
¡©us
 = 
com·»_bufãrs_å
<>((*)
r¡
, (*)
ex³ùed
, 
couÁ
);

166 } ià(
dt
 =ğ
UCC_DT_FLOAT64
) {

167 
¡©us
 = 
com·»_bufãrs_å
<>((*)
r¡
, (*)
ex³ùed
,

168 
couÁ
);

169 } ià(
dt
 =ğ
UCC_DT_FLOAT128
) {

170 
¡©us
 = 
com·»_bufãrs_å
<>(

171 (*)
r¡
, (*)
ex³ùed
, 
couÁ
);

172 } ià(
dt
 =ğ
UCC_DT_FLOAT32_COMPLEX
) {

173 
¡©us
 = 
com·»_bufãrs_com¶ex
<
_Com¶ex
>(

174 (
_Com¶ex
 *)
r¡
, (_Com¶ex *)
ex³ùed
, 
couÁ
);

175 } ià(
dt
 =ğ
UCC_DT_FLOAT64_COMPLEX
) {

176 
¡©us
 = 
com·»_bufãrs_com¶ex
<
_Com¶ex
>(

177 (
_Com¶ex
 *)
r¡
, (_Com¶ex *)
ex³ùed
, 
couÁ
);

178 } ià(
dt
 =ğ
UCC_DT_FLOAT128_COMPLEX
) {

179 
¡©us
 = 
com·»_bufãrs_com¶ex
<
_Com¶ex
>(

180 (
_Com¶ex
 *)
r¡
, (_Com¶ex *)
ex³ùed
,

181 
couÁ
);

183 
¡©us
 = 
	`memcmp
(
r¡
, 
ex³ùed
, 
couÁ
*
	`ucc_dt_size
(
dt
)) ?

184 
UCC_ERR_NO_MESSAGE
 : 
UCC_OK
;

187 ià(
UCC_MEMORY_TYPE_HOST
 !ğ
mt
 && 
UCC_MEMORY_TYPE_CUDA_MANAGED
 != mt) {

188 
	`UCC_CHECK
(
	`ucc_mc_ä“
(
r¡_mc_h—d”
));

191  
¡©us
;

192 
	}
}

194 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	$divide_bufãrs_å
(
T
 *
b
, 
size_t
 
divid”
, size_ˆ
couÁ
)

196 
size_t
 
i
 = 0; i < 
couÁ
; i++) {

197 
b
[
i
] = b[i] / ()
divid”
;

199 
	}
}

201 
ucc_¡©us_t
 
	$divide_bufãr
(*
ex³ùed
, 
size_t
 
divid”
, size_ˆ
couÁ
,

202 
ucc_d©©y³_t
 
dt
)

204 ià(
dt
 =ğ
UCC_DT_FLOAT32
) {

205 
divide_bufãrs_å
<>((*)
ex³ùed
, 
divid”
, 
couÁ
);

207 ià(
dt
 =ğ
UCC_DT_FLOAT64
) {

208 
divide_bufãrs_å
<>((*)
ex³ùed
, 
divid”
, 
couÁ
);

209 } ià(
dt
 =ğ
UCC_DT_FLOAT128
) {

210 
divide_bufãrs_å
<>((*)
ex³ùed
, 
divid”
, 
couÁ
);

211 } ià(
dt
 =ğ
UCC_DT_FLOAT32_COMPLEX
) {

212 
divide_bufãrs_å
<
_Com¶ex
>((_Com¶ex *)
ex³ùed
, 
divid”
,

213 
couÁ
);

214 } ià(
dt
 =ğ
UCC_DT_FLOAT64_COMPLEX
) {

215 
divide_bufãrs_å
<
_Com¶ex
>((_Com¶ex *)
ex³ùed
, 
divid”
,

216 
couÁ
);

217 } ià(
dt
 =ğ
UCC_DT_FLOAT128_COMPLEX
) {

218 
divide_bufãrs_å
<
_Com¶ex
>(

219 (
_Com¶ex
 *)
ex³ùed
, 
divid”
, 
couÁ
);

221 
¡d
::
û¼
 << "Unsupported dt for‡vg\n";

222  
UCC_ERR_NO_MESSAGE
;

224  
UCC_OK
;

225 
	}
}

	@test/mpi/main.cc

8 
	~<g‘İt.h
>

9 
	~<s¡»am
>

10 
	~<®gÜ™hm
>

11 
	~<chrÚo
>

12 
	~<iomª
>

13 
	~"‹¡_mpi.h
"

15 
	g‹¡_¿nd_£ed
 = -1;

16 
size_t
 
	g‹¡_max_size
 = 
TEST_UCC_RANK_BUF_SIZE_MAX
;

17 
ucc_‹¡_mpi_d©a_t
 
	gucc_‹¡_mpi_d©a
;

19 
	g¡d
::
veùÜ
<
ucc_cŞl_ty³_t
> 
cŞls
 = {

20 
UCC_COLL_TYPE_BARRIER
, 
UCC_COLL_TYPE_BCAST
,

21 
UCC_COLL_TYPE_REDUCE
, 
UCC_COLL_TYPE_ALLREDUCE
,

22 
UCC_COLL_TYPE_ALLGATHER
, 
UCC_COLL_TYPE_ALLGATHERV
,

23 
UCC_COLL_TYPE_ALLTOALL
, 
UCC_COLL_TYPE_ALLTOALLV
,

24 
UCC_COLL_TYPE_REDUCE_SCATTER
, 
UCC_COLL_TYPE_REDUCE_SCATTERV
,

25 
UCC_COLL_TYPE_GATHER
, 
UCC_COLL_TYPE_GATHERV
,

26 
UCC_COLL_TYPE_SCATTER
, 
UCC_COLL_TYPE_SCATTERV
};

28 
	g¡d
::
veùÜ
<
ucc_cŞl_ty³_t
> 
Úesided_cŞls
 = {

29 
UCC_COLL_TYPE_ALLTOALL
, 
UCC_COLL_TYPE_ALLTOALLV
};

31 
	g¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mty³s
 = {

32 
UCC_MEMORY_TYPE_HOST
};

34 
	g¡d
::
veùÜ
<
ucc_d©©y³_t
> 
dty³s
 = {

35 
UCC_DT_INT16
, 
UCC_DT_INT32
, 
UCC_DT_INT64
,

36 
UCC_DT_UINT16
, 
UCC_DT_UINT32
, 
UCC_DT_UINT64
,

37 
UCC_DT_FLOAT32
, 
UCC_DT_FLOAT64
, 
UCC_DT_FLOAT64_COMPLEX
};

39 
	g¡d
::
veùÜ
<
ucc_»duùiÚ_İ_t
> 
İs
 = {

40 
UCC_OP_SUM
, 
UCC_OP_MAX
, 
UCC_OP_AVG
};

42 
	g¡d
::
veùÜ
<
ucc_‹¡_mpi_‹am_t
> 
‹ams
 = {

43 
TEAM_WORLD
, 
TEAM_REVERSE
, 
TEAM_SPLIT_HALF
, 
TEAM_SPLIT_ODD_EVEN
};

45 
	g¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> 
couÁs_vsize
 = {

46 
TEST_FLAG_VSIZE_32BIT
, 
TEST_FLAG_VSIZE_64BIT
};

48 
	g¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> 
di¥ls_vsize
 = {

49 
TEST_FLAG_VSIZE_32BIT
, 
TEST_FLAG_VSIZE_64BIT
};

51 
size_t
 
	gmsg¿nge
[3] = {

54 
	g¡d
::
veùÜ
<
boŞ
> 
š¶aû
 = {
çl£
};

55 
	g¡d
::
veùÜ
<
boŞ
> 
³rsi¡’t
 = {
çl£
};

56 
	g¡d
::
veùÜ
<
boŞ
> 
Œigg”ed
 = {
çl£
};

57 
ucc_‹¡_mpi_roÙ_t
 
	groÙ_ty³
 = 
ROOT_RANDOM
;

58 
	groÙ_v®ue
 = 10;

59 
ucc_th»ad_mode_t
 
	gth»ad_mode
 = 
UCC_THREAD_SINGLE
;

60 
	g™”©iÚs
 = 1;

61 
	gshow_h–p
 = 0;

62 
	gnum_‹¡s
 = 1;

63 
boŞ
 
	ghas_Úesided
 = 
Œue
;

64 
boŞ
 
	gv”bo£
 = 
çl£
;

66 #ià
defšed
(
HAVE_CUDA
è|| defšed(
HAVE_HIP
)

67 
‹¡_£t_gpu_deviû_t
 
‹¡_gpu_£t_deviû
;

70 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
	$¡r_¥l™
(cÚ¡ *
v®ue
, cÚ¡ *
d–im™”
)

72 
¡d
::
veùÜ
<¡d::
¡ršg
> 
r¡
;

73 
¡d
::
¡ršg
 
	`¡r
(
v®ue
);

74 
¡d
::
¡ršg
 
	`d–im
(
d–im™”
);

75 
size_t
 
pos
 = 0;

76 
¡d
::
¡ršg
 
tok’
;

77 (
pos
 = 
¡r
.
	`fšd
(
d–im
)è!ğ
¡d
::
¡ršg
::
Åos
) {

78 
tok’
 = 
¡r
.
	`sub¡r
(0, 
pos
);

79 
r¡
.
	`push_back
(
tok’
);

80 
¡r
.
	`”a£
(0, 
pos
 + 
d–im
.
	`Ëngth
());

82 
r¡
.
	`push_back
(
¡r
);

83  
r¡
;

84 
	}
}

86 
	$´št_h–p
()

88 
¡d
::
cout
 <<

112 
	}
}

115 
	g‹m¶©e
<
ty³Çme
 
	gT
>

116 
	g¡d
::
veùÜ
<
T
> 
´oûss_¬g
(cÚ¡ *
v®ue
, 
	$T
 (*
¡r_to_ty³
)(
¡d
::
¡ršg
 
v®ue
))

118 
¡d
::
veùÜ
<
T
> 
r¡
;

119 autØ&
c
 : 
	`¡r_¥l™
(
v®ue
, ",")) {

120 
r¡
.
	`push_back
(
	`¡r_to_ty³
(
c
));

122  
r¡
;

123 
	}
}

125 
ucc_‹¡_mpi_‹am_t
 
	$‹am_¡r_to_ty³
(
¡d
::
¡ršg
 
‹am
)

127 ià(
‹am
 == "world") {

128  
TEAM_WORLD
;

129 } ià(
‹am
 == "half") {

130  
TEAM_SPLIT_HALF
;

131 } ià(
‹am
 == "odd_even") {

132  
TEAM_SPLIT_ODD_EVEN
;

133 } ià(
‹am
 == "reverse") {

134  
TEAM_REVERSE
;

136 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù—my³: "è+ 
‹am
;

137 
	}
}

139 
	g¡d
::
¡ršg
 
	$‹am_ty³_to_¡r
(
ucc_‹¡_mpi_‹am_t
 
‹am
)

141 
‹am
) {

142 
TEAM_WORLD
:

144 
TEAM_SPLIT_HALF
:

146 
TEAM_SPLIT_ODD_EVEN
:

148 
TEAM_REVERSE
:

153 
throw
 
¡d
::
	`¡ršg
("incorrecteamype: ");

154 
	}
}

156 
ucc_cŞl_ty³_t
 
	$cŞl_¡r_to_ty³
(
¡d
::
¡ršg
 
cŞl
)

158 ià(
cŞl
 == "barrier") {

159  
UCC_COLL_TYPE_BARRIER
;

160 } ià(
cŞl
 == "allreduce") {

161  
UCC_COLL_TYPE_ALLREDUCE
;

162 } ià(
cŞl
 == "allgather") {

163  
UCC_COLL_TYPE_ALLGATHER
;

164 } ià(
cŞl
 == "allgatherv") {

165  
UCC_COLL_TYPE_ALLGATHERV
;

166 } ià(
cŞl
 == "bcast") {

167  
UCC_COLL_TYPE_BCAST
;

168 } ià(
cŞl
 == "reduce") {

169  
UCC_COLL_TYPE_REDUCE
;

170 } ià(
cŞl
 == "alltoall") {

171  
UCC_COLL_TYPE_ALLTOALL
;

172 } ià(
cŞl
 == "alltoallv") {

173  
UCC_COLL_TYPE_ALLTOALLV
;

174 } ià(
cŞl
 == "reduce_scatter") {

175  
UCC_COLL_TYPE_REDUCE_SCATTER
;

176 } ià(
cŞl
 == "reduce_scatterv") {

177  
UCC_COLL_TYPE_REDUCE_SCATTERV
;

178 } ià(
cŞl
 == "reduce") {

179  
UCC_COLL_TYPE_REDUCE
;

180 } ià(
cŞl
 == "gather") {

181  
UCC_COLL_TYPE_GATHER
;

182 } ià(
cŞl
 == "gatherv") {

183  
UCC_COLL_TYPE_GATHERV
;

184 } ià(
cŞl
 == "scatter") {

185  
UCC_COLL_TYPE_SCATTER
;

186 } ià(
cŞl
 == "scatterv") {

187  
UCC_COLL_TYPE_SCATTERV
;

189 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù cŞÈty³: "è+ 
cŞl
;

191 
	}
}

193 
ucc_memÜy_ty³_t
 
	$mty³_¡r_to_ty³
(
¡d
::
¡ršg
 
mty³
)

195 ià(
mty³
 == "host") {

196  
UCC_MEMORY_TYPE_HOST
;

197 } ià(
mty³
 == "cuda") {

198  
UCC_MEMORY_TYPE_CUDA
;

199 } ià(
mty³
 == "cudaManaged") {

200  
UCC_MEMORY_TYPE_CUDA_MANAGED
;

201 } ià(
mty³
 == "rocm") {

202  
UCC_MEMORY_TYPE_ROCM
;

204 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù memÜyy³: "è+ 
mty³
;

205 
	}
}

207 
ucc_d©©y³_t
 
	$dty³_¡r_to_ty³
(
¡d
::
¡ršg
 
dty³
)

209 ià(
dty³
 == "int8") {

210  
UCC_DT_INT8
;

211 } ià(
dty³
 == "uint8") {

212  
UCC_DT_UINT8
;

213 } ià(
dty³
 == "int16") {

214  
UCC_DT_INT16
;

215 } ià(
dty³
 == "uint16") {

216  
UCC_DT_UINT16
;

217 } ià(
dty³
 == "int32") {

218  
UCC_DT_INT32
;

219 } ià(
dty³
 == "uint32") {

220  
UCC_DT_UINT32
;

221 } ià(
dty³
 == "int64") {

222  
UCC_DT_INT64
;

223 } ià(
dty³
 == "uint64") {

224  
UCC_DT_UINT64
;

225 } ià(
dty³
 == "float32") {

226  
UCC_DT_FLOAT32
;

227 } ià(
dty³
 == "float64") {

228  
UCC_DT_FLOAT64
;

229 } ià(
dty³
 == "float128") {

230  
UCC_DT_FLOAT128
;

231 } ià(
dty³
 == "bfloat16") {

232  
UCC_DT_BFLOAT16
;

233 } ià(
dty³
 == "float16") {

234  
UCC_DT_FLOAT16
;

235 } ià(
dty³
 == "int128") {

236  
UCC_DT_INT128
;

237 } ià(
dty³
 == "uint128") {

238  
UCC_DT_UINT128
;

239 } ià(
dty³
 == "float32_complex") {

240  
UCC_DT_FLOAT32_COMPLEX
;

241 } ià(
dty³
 == "float64_complex") {

242  
UCC_DT_FLOAT64_COMPLEX
;

243 } ià(
dty³
 == "float128_complex") {

244  
UCC_DT_FLOAT128_COMPLEX
;

246 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù dty³: "è+ 
dty³
;

247 
	}
}

249 
ucc_»duùiÚ_İ_t
 
	$İ_¡r_to_ty³
(
¡d
::
¡ršg
 
İ
)

251 ià(
İ
 == "sum") {

252  
UCC_OP_SUM
;

253 } ià(
İ
 == "prod") {

254  
UCC_OP_PROD
;

255 } ià(
İ
 == "max") {

256  
UCC_OP_MAX
;

257 } ià(
İ
 == "min") {

258  
UCC_OP_MIN
;

259 } ià(
İ
 == "land") {

260  
UCC_OP_LAND
;

261 } ià(
İ
 == "lor") {

262  
UCC_OP_LOR
;

263 } ià(
İ
 == "lxor") {

264  
UCC_OP_LXOR
;

265 } ià(
İ
 == "band") {

266  
UCC_OP_BAND
;

267 } ià(
İ
 == "bor") {

268  
UCC_OP_BOR
;

269 } ià(
İ
 == "bxor") {

270  
UCC_OP_BXOR
;

271 } ià(
İ
 == "avg") {

272  
UCC_OP_AVG
;

274 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù op: "è+ 
İ
;

275 
	}
}

277 
ucc_‹¡_vsize_æag_t
 
	$b™s_¡r_to_ty³
(
¡d
::
¡ršg
 
vsize
)

279 ià(
vsize
 == "32") {

280  
TEST_FLAG_VSIZE_32BIT
;

281 } ià(
vsize
 == "64") {

282  
TEST_FLAG_VSIZE_64BIT
;

284 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù vsize"è+ 
vsize
;

285 
	}
}

287 
	$´oûss_msg¿nge
(cÚ¡ *
¬g
)

289 autØ
tok’s
 = 
	`¡r_¥l™
(
¬g
, ":");

291 
Œy
 {

292 ià(
tok’s
.
	`size
() == 1) {

293 
msg¿nge
[0] = 
¡d
::
	`¡Ş
(
tok’s
[0]);

294 
msg¿nge
[1] = msgrange[0];

295 
msg¿nge
[2] = 0;

296 } ià(
tok’s
.
	`size
() >= 2) {

297 
msg¿nge
[0] = 
¡d
::
	`¡Ş
(
tok’s
[0]);

298 
msg¿nge
[1] = 
¡d
::
	`¡Ş
(
tok’s
[1]);

299 
msg¿nge
[2] = 2;

300 ià(
tok’s
.
	`size
() == 3) {

301 
msg¿nge
[2] = 
¡d
::
	`¡Ş
(
tok’s
[2]);

304 } 
	`ÿtch
 (
¡d
::
exû±iÚ
 &
e
) {

305 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù msg¿nge: "è+ 
¬g
;

307 
	}
}

309 
	$´oûss_š¶aû
(cÚ¡ *
¬g
)

311 
v®ue
 = 
¡d
::
	`¡oi
(
¬g
);

312 
v®ue
) {

314 
š¶aû
 = {
çl£
};

317 
š¶aû
 = {
Œue
};

320 
š¶aû
 = {
çl£
, 
Œue
};

325 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù iÅÏû: "è+ 
¬g
;

326 
	}
}

328 
	$´oûss_³rsi¡’t
(cÚ¡ *
¬g
)

330 
v®ue
 = 
¡d
::
	`¡oi
(
¬g
);

331 
v®ue
) {

333 
³rsi¡’t
 = {
çl£
};

336 
³rsi¡’t
 = {
Œue
};

339 
³rsi¡’t
 = {
çl£
, 
Œue
};

344 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù…”si¡’t: "è+ 
¬g
;

345 
	}
}

347 
	$´oûss_Œigg”ed
(cÚ¡ *
¬g
)

349 
v®ue
 = 
¡d
::
	`¡oi
(
¬g
);

350 
v®ue
) {

352 
Œigg”ed
 = {
çl£
};

355 
Œigg”ed
 = {
Œue
};

358 
Œigg”ed
 = {
çl£
, 
Œue
};

363 
throw
 
¡d
::
	`¡ršg
("šcÜ»ùrigg”ed: "è+ 
¬g
;

364 
	}
}

366 
	$´oûss_roÙ
(cÚ¡ *
¬g
)

368 autØ
tok’s
 = 
	`¡r_¥l™
(
¬g
, ":");

369 
¡d
::
¡ršg
 
roÙ_ty³_¡r
 = 
tok’s
[0];

370 ià(
roÙ_ty³_¡r
 == "all") {

371 ià(
tok’s
.
	`size
() != 1) {

372 
”r
;

374 
roÙ_ty³
 = 
ROOT_ALL
;

375 } ià(
roÙ_ty³_¡r
 == "random") {

376 ià(
tok’s
.
	`size
() != 2) {

377 
”r
;

379 
roÙ_ty³
 = 
ROOT_RANDOM
;

380 
roÙ_v®ue
 = 
¡d
::
	`©oi
(
tok’s
[1].
	`c_¡r
());

381 } ià(
roÙ_ty³_¡r
 == "single") {

382 ià(
tok’s
.
	`size
() != 2) {

383 
”r
;

385 
roÙ_ty³
 = 
ROOT_SINGLE
;

386 
roÙ_v®ue
 = 
¡d
::
	`©oi
(
tok’s
[1].
	`c_¡r
());

388 
”r
;

391 
”r
:

392 
throw
 
¡d
::
	`¡ršg
("šcÜ»ù„oÙ: "è+ 
¬g
;

393 
	}
}

395 
	$š™_¿nd_£ed
(
u£r_£ed
)

397 
¿nk
, 
£ed
;

398 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
¿nk
);

399 ià(0 > 
u£r_£ed
) {

400 ià(0 =ğ
¿nk
) {

401 
£ed
 = 
	`time
(
NULL
) % 32768;

404 
£ed
 = 
u£r_£ed
;

406 
	`MPI_Bÿ¡
(&
£ed
, 1, 
MPI_INT
, 0, 
MPI_COMM_WORLD
);

407 ià(0 !ğ
¿nk
) {

408 
£ed
 +ğ
¿nk
;

410  
£ed
;

411 
	}
}

413 
	$´št_šfo
()

415 
wÜld_¿nk
;

417 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
wÜld_¿nk
);

418 ià(
wÜld_¿nk
) {

422 
¡d
::
cout
 << "====ğUCC MPI TEST INFO =======" << std::
’dl
;

423 
¡d
::
cout
 <<"£ed: " << std::
	`to_¡ršg
(
‹¡_¿nd_£ed
è<< std::
’dl
;

424 
¡d
::
cout
 <<"collectives: ";

425 cÚ¡‡utØ&
c
 : 
cŞls
) {

426 
¡d
::
cout
 << 
	`ucc_cŞl_ty³_¡r
(
c
);

427 ià(
c
 !ğ
cŞls
.
	`back
()) {

428 
¡d
::
cout
 << ", ";

430 
¡d
::
cout
 << std::
’dl
;

433 
¡d
::
cout
 <<"dataypes: ";

434 cÚ¡‡utØ&
d
 : 
dty³s
) {

435 
¡d
::
cout
 << 
	`ucc_d©©y³_¡r
(
d
);

436 ià(
d
 !ğ
dty³s
.
	`back
()) {

437 
¡d
::
cout
 << ", ";

439 
¡d
::
cout
 << std::
’dl
;

443 
¡d
::
cout
 <<"memoryypes: ";

444 cÚ¡‡utØ&
m
 : 
mty³s
) {

445 
¡d
::
cout
 << 
	`ucc_mem_ty³_¡r
(
m
);

446 ià(
m
 !ğ
mty³s
.
	`back
()) {

447 
¡d
::
cout
 << ", ";

449 
¡d
::
cout
 << std::
’dl
;

453 
¡d
::
cout
 <<"teams: ";

454 cÚ¡‡utØ&
t
 : 
‹ams
) {

455 
¡d
::
cout
 << 
	`‹am_ty³_to_¡r
(
t
);

456 ià(
t
 !ğ
‹ams
.
	`back
()) {

457 
¡d
::
cout
 << ", ";

459 
¡d
::
cout
 << std::
’dl
;

462 
	}
}

464 
	$ProûssArgs
(
¬gc
, ** 
¬gv
)

466 cÚ¡ *cÚ¡ 
shÜt_İts
 = "c:t:m:d:o:M:I:P:N:r:s:C:D:i:Z:G:ThvS:O:";

467 cÚ¡ 
İtiÚ
 
lÚg_İts
[] = {

468 {"cŞls", 
»quœed_¬gum’t
, 
nuÎ±r
, 'c'},

469 {"‹ams", 
»quœed_¬gum’t
, 
nuÎ±r
, 't'},

470 {"mty³s", 
»quœed_¬gum’t
, 
nuÎ±r
, 'M'},

471 {"dty³s", 
»quœed_¬gum’t
, 
nuÎ±r
, 'd'},

472 {"İs", 
»quœed_¬gum’t
, 
nuÎ±r
, 'o'},

473 {"msgsize", 
»quœed_¬gum’t
, 
nuÎ±r
, 'm'},

474 {"š¶aû", 
»quœed_¬gum’t
, 
nuÎ±r
, 'I'},

475 {"³rsi¡’t", 
»quœed_¬gum’t
, 
nuÎ±r
, 'P'},

476 {"roÙ", 
»quœed_¬gum’t
, 
nuÎ±r
, 'r'},

477 {"£ed", 
»quœed_¬gum’t
, 
nuÎ±r
, 's'},

478 {"max_size", 
»quœed_¬gum’t
, 
nuÎ±r
, 'Z'},

479 {"couÁ_b™s", 
»quœed_¬gum’t
, 
nuÎ±r
, 'C'},

480 {"di¥l_b™s", 
»quœed_¬gum’t
, 
nuÎ±r
, 'D'},

481 {"™”", 
»quœed_¬gum’t
, 
nuÎ±r
, 'i'},

482 {"th»ad-muÉË", 
no_¬gum’t
, 
nuÎ±r
, 'T'},

483 {"num_‹¡s", 
»quœed_¬gum’t
, 
nuÎ±r
, 'N'},

484 {"Œigg”ed", 
»quœed_¬gum’t
, 
nuÎ±r
, 'G'},

485 {"v”bo£", 
no_¬gum’t
, 
nuÎ±r
, 'v'},

486 #ià
	`defšed
(
HAVE_CUDA
è|| defšed(
HAVE_HIP
)

487 {"£t_deviû", 
»quœed_¬gum’t
, 
nuÎ±r
, 'S'},

489 {"Úesided", 
»quœed_¬gum’t
, 
nuÎ±r
, 'O'},

490 {"h–p", 
no_¬gum’t
, 
nuÎ±r
, 'h'},

491 {
nuÎ±r
, 
no_¬gum’t
,‚ullptr, 0}

494 
Œue
)

496 cÚ¡‡utØ
İt
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İts
, 
lÚg_İts
, 
nuÎ±r
);

498 ià(-1 =ğ
İt
)

501 
İt
)

504 
cŞls
 = 
´oûss_¬g
<
ucc_cŞl_ty³_t
>(
İrg
, 
cŞl_¡r_to_ty³
);

507 
‹ams
 = 
´oûss_¬g
<
ucc_‹¡_mpi_‹am_t
>(
İrg
, 
‹am_¡r_to_ty³
);

510 
mty³s
 = 
´oûss_¬g
<
ucc_memÜy_ty³_t
>(
İrg
, 
mty³_¡r_to_ty³
);

513 
dty³s
 = 
´oûss_¬g
<
ucc_d©©y³_t
>(
İrg
, 
dty³_¡r_to_ty³
);

516 
İs
 = 
´oûss_¬g
<
ucc_»duùiÚ_İ_t
>(
İrg
, 
İ_¡r_to_ty³
);

519 
	`´oûss_msg¿nge
(
İrg
);

522 
	`´oûss_š¶aû
(
İrg
);

525 
	`´oûss_³rsi¡’t
(
İrg
);

528 
	`´oûss_Œigg”ed
(
İrg
);

531 
	`´oûss_roÙ
(
İrg
);

534 
‹¡_¿nd_£ed
 = 
¡d
::
	`¡oi
(
İrg
);

537 
‹¡_max_size
 = 
¡d
::
	`¡oi
(
İrg
);

540 
couÁs_vsize
 = 
´oûss_¬g
<
ucc_‹¡_vsize_æag_t
>(
İrg
, 
b™s_¡r_to_ty³
);

543 
di¥ls_vsize
 = 
´oûss_¬g
<
ucc_‹¡_vsize_æag_t
>(
İrg
, 
b™s_¡r_to_ty³
);

546 
th»ad_mode
 = 
UCC_THREAD_MULTIPLE
;

549 
™”©iÚs
 = 
¡d
::
	`¡oi
(
İrg
);

552 
num_‹¡s
 = 
¡d
::
	`¡oi
(
İrg
);

554 #ià
	`defšed
(
HAVE_CUDA
è|| defšed(
HAVE_HIP
)

556 
‹¡_gpu_£t_deviû
 = (
‹¡_£t_gpu_deviû_t
)
¡d
::
	`¡oi
(
İrg
);

560 
has_Úesided
 = 
¡d
::
	`¡oi
(
İrg
);

563 
v”bo£
 = 
Œue
;

566 
show_h–p
 = 1;

570 
throw
 
¡d
::
	`¡ršg
("unrecognized option");

573 
	}
}

575 
	$maš
(
¬gc
, *
¬gv
[])

577 
çed
 = 0;

578 
tÙ®_dÚe_sk³d_çed
[
	`ucc_og2
(
UCC_COLL_TYPE_LAST
) + 1][4];

579 
¡d
::
chrÚo
::
¡—dy_şock
::
time_pošt
 
begš
;

580 
size
, 
»quœed
, 
´ovided
, 
com¶‘ed
, 
¿nk
;

581 
UccTe¡Mpi
 *
‹¡
;

582 
MPI_Reque¡
 
»q
;

583 
¡d
::
¡ršg
 
”r
;

585 
begš
 = 
¡d
::
chrÚo
::
¡—dy_şock
::
	`now
();

586 
	`mem£t
(
tÙ®_dÚe_sk³d_çed
, 0,

587 (
tÙ®_dÚe_sk³d_çed
));

588 
Œy
 {

589 
	`ProûssArgs
(
¬gc
, 
¬gv
);

590 } 
	`ÿtch
 (cÚ¡ 
¡d
::
¡ršg
 &
s
) {

591 
çed
 = 1;

592 
”r
 = 
s
;

594 
»quœed
 = (
th»ad_mode
 =ğ
UCC_THREAD_SINGLE
è? 
MPI_THREAD_SINGLE


595 : 
MPI_THREAD_MULTIPLE
;

596 
	`MPI_In™_th»ad
(&
¬gc
, &
¬gv
, 
»quœed
, &
´ovided
);

597 ià(
´ovided
 !ğ
»quœed
) {

598 
¡d
::
û¼
 << "could‚ot initialize MPI inhread multiple\n";

601 
	`MPI_Comm_size
(
MPI_COMM_WORLD
, &
size
);

602 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
¿nk
);

604 ià(!
”r
.
	`em±y
(è|| 
show_h–p
) {

605 ià(
¿nk
 == 0) {

606 
¡d
::
û¼
 << "P¬£Arg ”rÜ:" << 
”r
 << "\n\n";

607 
	`´št_h–p
();

609 
mpi_ex™
;

612 ià(
size
 < 2) {

613 
¡d
::
û¼
 << "test„equires‡t†east 2„anks\n";

614 
mpi_ex™
;

617 
	`š™_‹¡_mpi_d©a
();

618 #ià
	`defšed
(
HAVE_CUDA
è|| defšed(
HAVE_HIP
)

619 
	`£t_gpu_deviû
(
‹¡_gpu_£t_deviû
);

621 
‹¡
 = 
Ãw
 
	`UccTe¡Mpi
(
¬gc
, 
¬gv
, 
th»ad_mode
, 0, 
has_Úesided
);

622 autØ&
m
 : 
mty³s
) {

623 ià(
UCC_MEMORY_TYPE_HOST
 !ğ
m
 && 
UCC_OK
 !ğ
	`ucc_mc_avaabË
(m)) {

624 
¡d
::
û¼
 << "»que¡ed memÜyy³ " << 
ucc_memÜy_ty³_Çmes
[
m
]

625 << " i nÙ suµÜ‹d " << 
¡d
::
’dl
;

626 
çed
 = -1;

627 
‹¡_ex™
;

630 
‹¡
->
	`ü—‹_‹ams
(
‹ams
);

631 ià(
has_Úesided
) {

632 
‹¡
->
	`ü—‹_‹ams
(
‹ams
, 
Œue
);

634 
‹¡
->
	`£t_v”bo£
(
v”bo£
);

635 
‹¡
->
	`£t_™”
(
™”©iÚs
);

636 
‹¡
->
	`£t_num_‹¡s
(
num_‹¡s
);

637 
‹¡
->
	`£t_cŞls
(
cŞls
);

638 
‹¡
->
	`£t_dty³s
(
dty³s
);

639 
‹¡
->
	`£t_mty³s
(
mty³s
);

640 
‹¡
->
	`£t_İs
(
İs
);

641 
‹¡
->
	`£t_roÙ
(
roÙ_ty³
, 
roÙ_v®ue
);

642 
‹¡
->
	`£t_couÁ_vsizes
(
couÁs_vsize
);

643 
‹¡
->
	`£t_di¥l_vsizes
(
di¥ls_vsize
);

644 
‹¡
->
	`£t_msgsizes
(
msg¿nge
[0],msgrange[1],msgrange[2]);

645 
‹¡
->
	`£t_max_size
(
‹¡_max_size
);

646 
‹¡_¿nd_£ed
 = 
	`š™_¿nd_£ed
(test_rand_seed);

648 
	`´št_šfo
();

650 autØ
š¶
 : 
š¶aû
) {

651 autØ
³rs
 : 
³rsi¡’t
) {

652 autØ
Œig
: 
Œigg”ed
) {

653 
‹¡
->
	`£t_Œigg”ed
(
Œig
);

654 
‹¡
->
	`£t_š¶aû
(
š¶
);

655 
‹¡
->
	`£t_³rsi¡’t
(
³rs
);

656 
‹¡
->
	`run_®l
();

661 ià(
has_Úesided
) {

662 
¡d
::
veùÜ
<
ucc_cŞl_ty³_t
> 
	`os_cŞls
(
Úesided_cŞls
.
	`size
());

663 
¡d
::
veùÜ
<
ucc_cŞl_ty³_t
>::
™”©Ü
 
™_¡¬t
;

665 
¡d
::
	`sÜt
(
cŞls
.
	`begš
(), cŞls.
	`’d
());

666 
¡d
::
	`sÜt
(
Úesided_cŞls
.
	`begš
(), oÃsided_cŞls.
	`’d
());

668 
™_¡¬t
 = 
¡d
::
	`£t_š‹r£ùiÚ
(

669 
cŞls
.
	`begš
(), cŞls.
	`’d
(), 
Úesided_cŞls
.begin(),

670 
Úesided_cŞls
.
	`’d
(), 
os_cŞls
.
	`begš
());

671 
os_cŞls
.
	`»size
(
™_¡¬t
 - os_cŞls.
	`begš
());

672 
‹¡
->
	`£t_cŞls
(
os_cŞls
);

673 autØ
š¶
 : 
š¶aû
) {

674 autØ
³rs
 : 
³rsi¡’t
) {

675 
‹¡
->
	`£t_Œigg”ed
(
çl£
);

676 
‹¡
->
	`£t_š¶aû
(
š¶
);

677 
‹¡
->
	`£t_³rsi¡’t
(
³rs
);

678 
‹¡
->
	`run_®l
(
Œue
);

682 
¡d
::
cout
 << std::
æush
;

684 autØ
s
 : 
‹¡
->
»suÉs
) {

685 
cŞl_num
 = 
	`ucc_og2
(
¡d
::
g‘
<0>(
s
));

686 
¡d
::
g‘
<1>(
s
)) {

687 
UCC_OK
:

688 
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][1]++;

690 
UCC_ERR_NOT_IMPLEMENTED
:

691 
UCC_ERR_LAST
:

692 
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][2]++;

695 
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][3]++;

697 
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][0]++;

699 
	`MPI_I®Ìeduû
(
MPI_IN_PLACE
, 
tÙ®_dÚe_sk³d_çed
,

700 (
tÙ®_dÚe_sk³d_çed
)/(),

701 
MPI_INT
, 
MPI_MAX
, 
MPI_COMM_WORLD
, &
»q
);

703 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

704 
‹¡
->
	`´og»ss_ùx
();

705 } !
com¶‘ed
);

707 ià(0 =ğ
¿nk
) {

708 
¡d
::
chrÚo
::
¡—dy_şock
::
time_pošt
 
’d
 =

709 
¡d
::
chrÚo
::
¡—dy_şock
::
	`now
();

710 
ucc_cŞl_ty³_t
 
cŞl_ty³
;

711 
num_®l
 = 0, 
num_sk³d
 = 0, 
num_dÚe
 =0, 
num_çed
 = 0;

712 
¡d
::
ios
 
	`io¡©e
(
nuÎ±r
);

714 
io¡©e
.
	`cİyfmt
(
¡d
::
cout
);

715 
¡d
::
cout
 << "\n===== UCC MPI TEST REPORT =====\n" <<

716 
¡d
::
	`£tw
(22è<< std::
Ëá
 << "collective" <<

717 
¡d
::
	`£tw
(10è<< std::
right
 << "tests" <<

718 
¡d
::
	`£tw
(10è<< std::
right
 << "passed" <<

719 
¡d
::
	`£tw
(10è<< std::
right
 << "failed" <<

720 
¡d
::
	`£tw
(10è<< std::
right
 << "sk³d" << std::
’dl
;

722 
cŞl_ty³
 = (
ucc_cŞl_ty³_t
)1;

723 
cŞl_ty³
 < 
UCC_COLL_TYPE_LAST
;

724 
cŞl_ty³
 = (
ucc_cŞl_ty³_t
)(coll_type << 1))

726 
cŞl_num
 = 
	`ucc_og2
(
cŞl_ty³
);

727 ià(
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][0] == 0) {

730 
num_®l
 +ğ
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][0];

731 
num_dÚe
 +ğ
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][1];

732 
num_sk³d
 +ğ
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][2];

733 
num_çed
 +ğ
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][3];

734 
¡d
::
cout
 <<

735 
¡d
::
	`£tw
(22è<< std::
Ëá
 << 
	`ucc_cŞl_ty³_¡r
(
cŞl_ty³
) <<

736 
¡d
::
	`£tw
(10è<< std::
right
 << 
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][0] <<

737 
¡d
::
	`£tw
(10è<< std::
right
 << 
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][1] <<

738 
¡d
::
	`£tw
(10è<< std::
right
 << 
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][3] <<

739 
¡d
::
	`£tw
(10è<< std::
right
 << 
tÙ®_dÚe_sk³d_çed
[
cŞl_num
][2] <<

740 
¡d
::
’dl
;

743 
¡d
::
cout
 <<

745 "tÙ®e¡s: " << 
num_®l
 << "\n" <<

746 "·s£d: " << 
num_dÚe
 << "\n" <<

747 "sk³d: " << 
num_sk³d
 << "\n" <<

748 "çed: " << 
num_çed
 << "\n" <<

750 
¡d
::
chrÚo
::
du¿tiÚ_ÿ¡
<¡d::chrÚo::
£cÚds
>(
’d
 - 
begš
).
	`couÁ
()

751 << "s" << 
¡d
::
’dl
;

752 
¡d
::
cout
.
	`cİyfmt
(
io¡©e
);

755 ià(
num_®l
 =ğ
num_sk³d
) {

756 
¡d
::
cout
 << "\n Allests have been skipped, indicating most†ikely "

758 
çed
 = 1;

761 ià(
num_çed
 != 0) {

762 
çed
 = 1;

766 
‹¡_ex™
:

767 
d–‘e
 
‹¡
;

768 
mpi_ex™
:

769 
	`MPI_Fš®ize
();

770  
çed
;

771 
	}
}

773 
	$š™_‹¡_mpi_d©a
()

775 
MPI_Comm
 
loÿl_comm
;

777 
	`MPI_Comm_¥l™_ty³
(
MPI_COMM_WORLD
, 
MPI_COMM_TYPE_SHARED
, 0, 
MPI_INFO_NULL
,

778 &
loÿl_comm
);

779 
	`MPI_Comm_¿nk
(
loÿl_comm
, &
ucc_‹¡_mpi_d©a
.
loÿl_node_¿nk
);

780 
	`MPI_Comm_ä“
(&
loÿl_comm
);

782 
	}
}

	@test/mpi/mpi_util.cc

7 
	~"mpi_ut.h
"

9 
MPI_Comm
 
	$ü—‹_h®f_comm
()

11 
wÜld_¿nk
, 
wÜld_size
;

12 
MPI_Comm
 
Ãw_comm
;

13 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
wÜld_¿nk
);

14 
	`MPI_Comm_size
(
MPI_COMM_WORLD
, &
wÜld_size
);

15 
	`MPI_Comm_¥l™
(
MPI_COMM_WORLD
, 
wÜld_¿nk
 < 
wÜld_size
 / 2,

16 
wÜld_¿nk
, &
Ãw_comm
);

17  
Ãw_comm
;

18 
	}
}

20 
MPI_Comm
 
	$ü—‹_odd_ev’_comm
()

22 
wÜld_¿nk
;

23 
MPI_Comm
 
Ãw_comm
;

24 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
wÜld_¿nk
);

25 
	`MPI_Comm_¥l™
(
MPI_COMM_WORLD
, 
wÜld_¿nk
 % 2,

26 
wÜld_¿nk
, &
Ãw_comm
);

27  
Ãw_comm
;

28 
	}
}

30 
MPI_Comm
 
	$ü—‹_»v”£_comm
()

32 
wÜld_¿nk
, 
wÜld_size
;

33 
MPI_Comm
 
Ãw_comm
;

34 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
wÜld_¿nk
);

35 
	`MPI_Comm_size
(
MPI_COMM_WORLD
, &
wÜld_size
);

36 
	`MPI_Comm_¥l™
(
MPI_COMM_WORLD
, 0,

37 
wÜld_size
 - 
wÜld_¿nk
 - 1, &
Ãw_comm
);

38  
Ãw_comm
;

39 
	}
}

41 
MPI_Comm
 
	$ü—‹_mpi_comm
(
ucc_‹¡_mpi_‹am_t
 
t
)

43 
MPI_Comm
 
comm
 = 
MPI_COMM_NULL
;

45 
t
) {

46 
TEAM_WORLD
:

47 
	`MPI_Comm_dup
(
MPI_COMM_WORLD
, &
comm
);

49 
TEAM_REVERSE
:

50 
comm
 = 
	`ü—‹_»v”£_comm
();

52 
TEAM_SPLIT_HALF
:

53 
comm
 = 
	`ü—‹_h®f_comm
();

55 
TEAM_SPLIT_ODD_EVEN
:

56 
comm
 = 
	`ü—‹_odd_ev’_comm
();

61  
comm
;

62 
	}
}

	@test/mpi/mpi_util.h

7 #iâdeà
MPI_UTIL_H


8 
	#MPI_UTIL_H


	)

9 
	~"‹¡_mpi.h
"

12 
šlše
 
MPI_D©©y³
 
	$ucc_dt_to_mpi
(
ucc_d©©y³_t
 
dt
) {

13 
dt
) {

14 
UCC_DT_INT8
:

15  
MPI_INT8_T
;

16 
UCC_DT_UINT8
:

17  
MPI_UINT8_T
;

18 
UCC_DT_INT16
:

19  
MPI_INT16_T
;

20 
UCC_DT_UINT16
:

21  
MPI_UINT16_T
;

22 
UCC_DT_INT32
:

23  
MPI_INT32_T
;

24 
UCC_DT_UINT32
:

25  
MPI_UINT32_T
;

26 
UCC_DT_FLOAT32
:

27  
MPI_FLOAT
;

28 
UCC_DT_INT64
:

29  
MPI_INT64_T
;

30 
UCC_DT_UINT64
:

31  
MPI_UINT64_T
;

32 
UCC_DT_FLOAT64
:

33  
MPI_DOUBLE
;

34 
UCC_DT_FLOAT128
:

35  
MPI_LONG_DOUBLE
;

36 
UCC_DT_FLOAT32_COMPLEX
:

37  
MPI_C_FLOAT_COMPLEX
;

38 
UCC_DT_FLOAT64_COMPLEX
:

39  
MPI_C_DOUBLE_COMPLEX
;

40 
UCC_DT_FLOAT128_COMPLEX
:

41  
MPI_C_LONG_DOUBLE_COMPLEX
;

42 
UCC_DT_FLOAT16
:

43 
UCC_DT_INT128
:

44 
UCC_DT_UINT128
:

45 
UCC_DT_BFLOAT16
:

47 
¡d
::
û¼
 << "Unsupported dt\n";

48 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

50  
MPI_DATATYPE_NULL
;

51 
	}
}

53 
šlše
 
MPI_Op
 
	$ucc_İ_to_mpi
(
ucc_»duùiÚ_İ_t
 
İ
)

55 
İ
) {

56 
UCC_OP_SUM
:

57  
MPI_SUM
;

58 
UCC_OP_PROD
:

59  
MPI_PROD
;

60 
UCC_OP_MAX
:

61  
MPI_MAX
;

62 
UCC_OP_MIN
:

63  
MPI_MIN
;

64 
UCC_OP_LAND
:

65  
MPI_LAND
;

66 
UCC_OP_LOR
:

67  
MPI_LOR
;

68 
UCC_OP_LXOR
:

69  
MPI_LXOR
;

70 
UCC_OP_BAND
:

71  
MPI_BAND
;

72 
UCC_OP_BOR
:

73  
MPI_BOR
;

74 
UCC_OP_BXOR
:

75  
MPI_BXOR
;

76 
UCC_OP_MAXLOC
:

77  
MPI_MAXLOC
;

78 
UCC_OP_MINLOC
:

79  
MPI_MINLOC
;

81 
¡d
::
û¼
 << "Unsupported op\n";

82 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

84  
MPI_OP_NULL
;

85 
	}
}

87 
MPI_Comm
 
ü—‹_mpi_comm
(
ucc_‹¡_mpi_‹am_t
 
t
);

	@test/mpi/test_allgather.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	gTe¡AÎg©h”
::
	$Te¡AÎg©h”
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

11 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_ALLGATHER
, 
·¿ms
)

13 
¿nk
, 
size
;

14 
size_t
 
dt_size
, 
sšgË_¿nk_couÁ
;

16 
dt
 = 
·¿ms
.dt;

17 
dt_size
 = 
	`ucc_dt_size
(
dt
);

18 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
dt_size
;

20 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

21 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

23 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_max_size
 < (
msgsize
*
size
),

24 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

28 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
 * 
size
, 
mem_ty³
));

29 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

30 
check_buf
 = 
	`ucc_m®loc
(
msgsize
 * 
size
, "check buf");

31 
	`UCC_MALLOC_CHECK
(
check_buf
);

32 ià(!
š¶aû
) {

33 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

34 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

35 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

36 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
;

37 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

38 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

40 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

41 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
 * 
size
;

42 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

43 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

44 
	`UCC_CHECK
(
	`£t_šput
());

45 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

46 
	}
}

48 
ucc_¡©us_t
 
	gTe¡AÎg©h”
::
	$£t_šput
(
™”_³rsi¡’t
)

50 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

51 
size_t
 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
dt_size
;

52 
size_t
 
sšgË_¿nk_size
 = 
sšgË_¿nk_couÁ
 * 
dt_size
;

53 
¿nk
;

54 *
buf
;

56 
this
->
™”_³rsi¡’t
 = iter_persistent;

57 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

58 ià(
š¶aû
) {

59 
buf
 = 
	`PTR_OFFSET
(
rbuf
, 
¿nk
 * 
sšgË_¿nk_size
);

61 
buf
 = 
sbuf
;

64 
	`š™_bufãr
(
buf
, 
sšgË_¿nk_couÁ
, 
dt
, 
mem_ty³
,

65 
¿nk
 * (
™”_³rsi¡’t
 + 1));

66  
UCC_OK
;

67 
	}
}

69 
ucc_¡©us_t
 
	gTe¡AÎg©h”
::
	$check
()

71 
size_t
 
dt_size
, 
sšgË_¿nk_couÁ
;

72 
size
, 
i
;

74 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

75 
sšgË_¿nk_couÁ
 = 
¬gs
.
d¡
.
šfo
.
couÁ
 / 
size
;

76 
dt_size
 = 
	`ucc_dt_size
(
dt
);

77 
i
 = 0; i < 
size
; i++) {

78 
	`š™_bufãr
(
	`PTR_OFFSET
(
check_buf
, 
i
 * 
sšgË_¿nk_couÁ
 * 
dt_size
),

79 
sšgË_¿nk_couÁ
, 
dt
, 
UCC_MEMORY_TYPE_HOST
,

80 
i
 * (
™”_³rsi¡’t
 + 1));

83  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
sšgË_¿nk_couÁ
 * 
size
, 
dt
,

84 
mem_ty³
);

85 
	}
}

	@test/mpi/test_allgatherv.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	$fl_couÁs_ªd_di¥Ïûm’ts
(
size
, 
couÁ
,

11 *
couÁs
, *
di¥ls
)

13 
bŸs
 = 
couÁ
 / 2;

14 
i
;

16 
couÁs
[0] = 
couÁ
 - 
bŸs
;

17 
di¥ls
[0] = 0;

18 
i
 = 1; i < 
size
 - 1; i++) {

19 ià(
i
 % 2 == 0) {

20 
couÁs
[
i
] = 
couÁ
 - 
bŸs
;

22 
couÁs
[
i
] = 
couÁ
 + 
bŸs
;

24 
di¥ls
[
i
] = di¥ls[˜- 1] + 
couÁs
[i - 1];

26 ià(
size
 % 2 == 0) {

27 
couÁs
[
size
 - 1] = 
couÁ
 + 
bŸs
;

29 
couÁs
[
size
 - 1] = 
couÁ
;

31 
di¥ls
[
size
 - 1] = di¥ls[siz- 2] + 
couÁs
[size - 2];

32 
	}
}

34 
	gTe¡AÎg©h”v
::
	$Te¡AÎg©h”v
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

35 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_ALLGATHERV
, 
·¿ms
)

37 
¿nk
, 
size
;

38 
size_t
 
dt_size
, 
couÁ
;

40 
dt
 = 
·¿ms
.dt;

41 
dt_size
 = 
	`ucc_dt_size
(
dt
);

42 
couÁ
 = 
msgsize
 / 
dt_size
;

43 
couÁs
 = 
NULL
;

44 
di¥Ïûm’ts
 = 
NULL
;

46 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

47 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

49 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_max_size
 < (
msgsize
 * 
size
),

50 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

54 
couÁs
 = (*è
	`ucc_m®loc
(
size
 * (
ušt32_t
), "counts buf");

55 
	`UCC_MALLOC_CHECK
(
couÁs
);

56 
di¥Ïûm’ts
 = (*è
	`ucc_m®loc
(
size
 * (
ušt32_t
), "displacements buf");

57 
	`UCC_MALLOC_CHECK
(
di¥Ïûm’ts
);

58 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
 * 
size
, 
mem_ty³
));

59 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

60 
check_buf
 = 
	`ucc_m®loc
(
msgsize
 * 
size
, "check buf");

61 
	`UCC_MALLOC_CHECK
(
check_buf
);

62 
	`fl_couÁs_ªd_di¥Ïûm’ts
(
size
, 
couÁ
, 
couÁs
, 
di¥Ïûm’ts
);

64 
¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

65 
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
;

66 ià(!
š¶aû
) {

67 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
couÁs
[
¿nk
] * 
dt_size
, 
mem_ty³
));

68 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

69 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

70 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

71 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

72 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
couÁs
[
¿nk
];

74 
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
rbuf
;

75 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = (
ucc_couÁ_t
*)counts;

76 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = (
ucc_ašt_t
*)displacements;

77 
¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
dt
;

78 
¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = mem_type;

80 
	`UCC_CHECK
(
	`£t_šput
());

81 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

82 
	}
}

84 
ucc_¡©us_t
 
	gTe¡AÎg©h”v
::
	$£t_šput
(
™”_³rsi¡’t
)

86 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

87 
¿nk
;

88 *
buf
;

90 
this
->
™”_³rsi¡’t
 = iter_persistent;

91 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

92 ià(
š¶aû
) {

93 
buf
 = 
	`PTR_OFFSET
(
rbuf
, 
di¥Ïûm’ts
[
¿nk
] * 
dt_size
);

95 
buf
 = 
sbuf
;

97 
	`š™_bufãr
(
buf
, 
couÁs
[
¿nk
], 
dt
, 
mem_ty³
,„ªk * (
™”_³rsi¡’t
 + 1));

99  
UCC_OK
;

100 
	}
}

102 
	gTe¡AÎg©h”v
::~
	$Te¡AÎg©h”v
() {

103 ià(
couÁs
) {

104 
	`ucc_ä“
(
couÁs
);

106 ià(
di¥Ïûm’ts
) {

107 
	`ucc_ä“
(
di¥Ïûm’ts
);

109 
	}
}

111 
ucc_¡©us_t
 
	gTe¡AÎg©h”v
::
	$check
()

113 
tÙ®_couÁ
 = 0;

114 
size
, 
i
;

116 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

117 
i
 = 0 ; i < 
size
; i++) {

118 
tÙ®_couÁ
 +ğ
couÁs
[
i
];

121 
i
 = 0; i < 
size
; i++) {

122 
	`š™_bufãr
(
	`PTR_OFFSET
(
check_buf
, 
di¥Ïûm’ts
[
i
] * 
	`ucc_dt_size
(
dt
)),

123 
couÁs
[
i
], 
dt
, 
UCC_MEMORY_TYPE_HOST
,

124 
i
 * (
™”_³rsi¡’t
 + 1));

127  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
tÙ®_couÁ
, 
dt
, 
mem_ty³
);

128 
	}
}

	@test/mpi/test_allreduce.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	gTe¡AÎ»duû
::
	$Te¡AÎ»duû
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

11 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_ALLREDUCE
, 
·¿ms
)

13 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
·¿ms
.
dt
);

14 
size_t
 
couÁ
 = 
msgsize
/
dt_size
;

15 
¿nk
;

17 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

18 
İ
 = 
·¿ms
.op;

19 
dt
 = 
·¿ms
.dt;

21 ià(
	`sk_»duû
(
‹¡_max_size
 < 
msgsize
, 
TEST_SKIP_MEM_LIMIT
,

22 
‹am
.
comm
)) {

26 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

27 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

28 
check_buf
 = 
	`ucc_m®loc
(
msgsize
, "check buf");

29 
	`UCC_MALLOC_CHECK
(
check_buf
);

30 ià(!
š¶aû
) {

31 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

32 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

33 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

34 
¬gs
.
¤c
.
šfo
.
couÁ
 = count;

35 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

36 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

38 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
NULL
;

39 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
SIZE_MAX
;

40 
¬gs
.
¤c
.
šfo
.
d©©y³
 = (
ucc_d©©y³_t
)-1;

41 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
UCC_MEMORY_TYPE_UNKNOWN
;

44 
¬gs
.
İ
 = op;

45 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

46 
¬gs
.
d¡
.
šfo
.
couÁ
 = count;

47 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

48 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

49 
	`UCC_CHECK
(
	`£t_šput
());

50 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

51 
	}
}

53 
ucc_¡©us_t
 
	gTe¡AÎ»duû
::
	$£t_šput
(
™”_³rsi¡’t
)

55 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

56 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

57 
¿nk
;

58 *
buf
;

60 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

61 ià(
š¶aû
) {

62 
buf
 = 
rbuf
;

64 
buf
 = 
sbuf
;

66 
	`š™_bufãr
(
buf
, 
couÁ
, 
dt
, 
mem_ty³
, 
¿nk
 * (
™”_³rsi¡’t
 + 1));

67 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
check_buf
, 
buf
, 
couÁ
 * 
dt_size
,

68 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

69  
UCC_OK
;

70 
	}
}

72 
ucc_¡©us_t
 
	gTe¡AÎ»duû
::
	$check
()

74 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

75 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

76 
MPI_Reque¡
 
»q
;

77 
com¶‘ed
;

78 
ucc_¡©us_t
 
¡©us
;

80 
	`MPI_I®Ìeduû
(
MPI_IN_PLACE
, 
check_buf
, 
couÁ
, 
	`ucc_dt_to_mpi
(
dt
),

81 
İ
 =ğ
UCC_OP_AVG
 ? 
MPI_SUM
 : 
	`ucc_İ_to_mpi
(İ), 
‹am
.
comm
,

82 &
»q
);

84 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

85 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

86 } !
com¶‘ed
);

88 ià(
İ
 =ğ
UCC_OP_AVG
) {

89 
¡©us
 = 
	`divide_bufãr
(
check_buf
, 
‹am
.‹am->
size
, 
couÁ
, 
dt
);

90 ià(
¡©us
 !ğ
UCC_OK
) {

91  
¡©us
;

95  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
couÁ
, 
dt
, 
mem_ty³
);

96 
	}
}

98 
	g¡d
::
¡ršg
 
Te¡AÎ»duû
::
	$¡r
() {

99  
¡d
::
	`¡ršg
("tc="è+ 
	`ucc_cŞl_ty³_¡r
(
¬gs
.
cŞl_ty³
) +

100 "—m=" + 
	`‹am_¡r
(
‹am
.
ty³
) +

101 " msgsize=" + 
¡d
::
	`to_¡ršg
(
msgsize
) +

102 " iÅÏû=" + (
š¶aû
 ? "1" : "0") +

103 "…”si¡’t=" + (
³rsi¡’t
 ? "1" : "0") +

104 " dt=" + 
	`ucc_d©©y³_¡r
(
dt
) +

105 " op=" + 
	`ucc_»duùiÚ_İ_¡r
(
İ
);

106 
	}
}

	@test/mpi/test_alltoall.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	gTe¡AÎtßÎ
::
	$Te¡AÎtßÎ
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

11 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_ALLTOALL
, 
·¿ms
)

13 * 
wÜk_buf
 = 
nuÎ±r
;

14 
¿nk
, 
Årocs
;

15 
size_t
 
dt_size
, 
sšgË_¿nk_couÁ
;

17 
dt
 = 
·¿ms
.dt;

18 
dt_size
 = 
	`ucc_dt_size
(
dt
);

19 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
dt_size
;

20 
is_Úesided
 = (
·¿ms
.
bufãrs
 !ğ
nuÎ±r
);

22 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

23 
	`MPI_Comm_size
(
‹am
.
comm
, &
Årocs
);

25 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_max_size
 < (
msgsize
 * 
Årocs
),

26 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

30 ià(!
is_Úesided
) {

31 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
 * 
Årocs
, 
mem_ty³
));

32 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

34 
sbuf
 = 
·¿ms
.
bufãrs
[
MEM_SEND_SEGMENT
];

35 
rbuf
 = 
·¿ms
.
bufãrs
[
MEM_RECV_SEGMENT
];

36 
wÜk_buf
 = 
·¿ms
.
bufãrs
[
MEM_WORK_SEGMENT
];

39 
check_buf
 = 
	`ucc_m®loc
(
msgsize
 * 
Årocs
, "check buf");

40 
	`UCC_MALLOC_CHECK
(
check_buf
);

41 ià(!
š¶aû
) {

42 ià(!
is_Úesided
) {

43 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
 * 
Årocs
, 
mem_ty³
));

44 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

47 ià(
is_Úesided
) {

48 
¬gs
.
mask
 |=

49 
UCC_COLL_ARGS_FIELD_FLAGS
 | 
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
;

50 
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
;

51 
¬gs
.
glob®_wÜk_bufãr
 = 
wÜk_buf
;

54 ià(!
š¶aû
) {

55 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

56 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
 * 
Årocs
;

57 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

58 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

61 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

62 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
 * 
Årocs
;

63 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

64 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

65 
	`UCC_CHECK
(
	`£t_šput
());

66 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

67 
	}
}

69 
ucc_¡©us_t
 
	gTe¡AÎtßÎ
::
	$£t_šput
(
™”_³rsi¡’t
)

71 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

72 
size_t
 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
dt_size
;

73 
MPI_Reque¡
 
»q
;

74 * 
buf
;

75 
¿nk
, 
Årocs
, 
com¶‘ed
;

77 
this
->
™”_³rsi¡’t
 = iter_persistent;

78 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

79 
	`MPI_Comm_size
(
‹am
.
comm
, &
Årocs
);

80 ià(
š¶aû
) {

81 
buf
 = 
rbuf
;

83 
buf
 = 
sbuf
;

85 
	`š™_bufãr
(
buf
, 
sšgË_¿nk_couÁ
 * 
Årocs
, 
dt
, 
mem_ty³
,

86 
¿nk
 * (
™”_³rsi¡’t
 + 1));

87 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
check_buf
, 
buf
,

88 
sšgË_¿nk_couÁ
 * 
Årocs
 * 
dt_size
,

89 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

91 ià(
is_Úesided
 && 
³rsi¡’t
) {

92 
	`MPI_Ib¬r›r
(
‹am
.
comm
, &
»q
);

94 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

95 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

96 } !
com¶‘ed
);

98  
UCC_OK
;

99 
	}
}

101 
ucc_¡©us_t
 
	gTe¡AÎtßÎ
::
	$check
()

103 
size
, 
¿nk
, 
i
;

104 
size_t
 
sšgË_¿nk_couÁ
;

106 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

107 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

108 
sšgË_¿nk_couÁ
 = 
¬gs
.
¤c
.
šfo
.
couÁ
 / 
size
;

110 
i
 = 0; i < 
size
; i++) {

111 
	`š™_bufãr
(
	`PTR_OFFSET
(
check_buf
, 
i
 * 
sšgË_¿nk_couÁ
 * 
	`ucc_dt_size
(
dt
)),

112 
sšgË_¿nk_couÁ
, 
dt
, 
UCC_MEMORY_TYPE_HOST
,

113 
i
 * (
™”_³rsi¡’t
 + 1), 
sšgË_¿nk_couÁ
 * 
¿nk
);

116  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
sšgË_¿nk_couÁ
 * 
size
, 
dt
,

117 
mem_ty³
);

118 
	}
}

	@test/mpi/test_alltoallv.cc

6 
	~<¿ndom
>

7 
	~<as£¹.h
>

9 
	~"‹¡_mpi.h
"

10 
	~"mpi_ut.h
"

12 
	g‹m¶©e
<
ty³Çme
 
	gT
>

13 * 
	gTe¡AÎtßÎv
::
	$mpi_couÁs_to_ucc
(*
mpi_couÁs
, 
size_t
 
_ncouÁ
)

15 *
ucc_couÁs
 = (
T
*)
	`m®loc
((Tè* 
_ncouÁ
);

16 
size_t
 
i
 = 0; i < 
_ncouÁ
; i++) {

17 ((
T
*)
ucc_couÁs
)[
i
] = 
mpi_couÁs
[i];

19  
ucc_couÁs
;

20 
	}
}

22 
	gTe¡AÎtßÎv
::
	$Te¡AÎtßÎv
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

23 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_ALLTOALLV
, 
·¿ms
)

25 
¡d
::
deçuÉ_¿ndom_’gše
 
’g
;

26 
size_t
 
dt_size
, 
couÁ
;

27 
¿nk
, 
Årocs
, 
¿nk_couÁ
;

28 
boŞ
 
is_Úesided
;

29 *
wÜk_buf
;

31 
dt
 = 
·¿ms
.dt;

32 
dt_size
 = 
	`ucc_dt_size
(
dt
);

33 
couÁ
 = 
msgsize
 / 
dt_size
;

34 
¢couÁs
 = 0;

35 
ºcouÁs
 = 0;

36 
scouÁs
 = 
NULL
;

37 
sdi¥ls
 = 
NULL
;

38 
rcouÁs
 = 
NULL
;

39 
rdi¥ls
 = 
NULL
;

40 
scouÁs64
 = 
NULL
;

41 
sdi¥ls64
 = 
NULL
;

42 
rcouÁs64
 = 
NULL
;

43 
rdi¥ls64
 = 
NULL
;

44 
couÁ_b™s
 = 
·¿ms
.count_bits;

45 
di¥l_b™s
 = 
·¿ms
.displ_bits;

46 
is_Úesided
 = (
·¿ms
.
bufãrs
 !ğ
NULL
);

47 
wÜk_buf
 = 
NULL
;

49 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`urd
(
couÁ
 / 2, count);

50 
’g
.
	`£ed
(
‹¡_¿nd_£ed
);

52 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

53 
	`MPI_Comm_size
(
‹am
.
comm
, &
Årocs
);

55 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_max_size
 < (
msgsize
 * 
Årocs
),

56 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

60 
¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

61 
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_CONTIG_SRC_BUFFER
 |

62 
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
;

63 ià(
is_Úesided
) {

64 
¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_GLOBAL_WORK_BUFFER
;

65 
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
;

67 ià(
couÁ_b™s
 =ğ
TEST_FLAG_VSIZE_64BIT
) {

68 
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_COUNT_64BIT
;

70 ià(
di¥l_b™s
 =ğ
TEST_FLAG_VSIZE_64BIT
) {

71 
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_DISPLACEMENTS_64BIT
;

74 
scouÁs
 = (*)
	`m®loc
((*scouÁsè* 
Årocs
);

75 
sdi¥ls
 = (*)
	`m®loc
((*sdi¥lsè* 
Årocs
);

76 
rcouÁs
 = (*)
	`m®loc
((*rcouÁsè* 
Årocs
);

77 
rdi¥ls
 = (*)
	`m®loc
((*rdi¥lsè* 
Årocs
);

79 autØ
i
 = 0; i < 
Årocs
; i++) {

80 
¿nk_couÁ
 = 
	`urd
(
’g
);

81 
scouÁs
[
i
] = 
¿nk_couÁ
;

84 
	`MPI_AÎtßÎ
((*)
scouÁs
, 1, 
MPI_INT
,

85 (*)
rcouÁs
, 1, 
MPI_INT
, 
‹am
.
comm
);

87 
¢couÁs
 = 0;

88 
ºcouÁs
 = 0;

89 autØ
i
 = 0; i < 
Årocs
; i++) {

90 
	`as£¹
((
size_t
)
rcouÁs
[
i
] <ğ
couÁ
);

91 
sdi¥ls
[
i
] = 
¢couÁs
;

92 
rdi¥ls
[
i
] = 
ºcouÁs
;

93 
¢couÁs
 +ğ
scouÁs
[
i
];

94 
ºcouÁs
 +ğ
rcouÁs
[
i
];

96 ià((
‹¡_max_size
 < (
¢couÁs
 * 
dt_size
)) ||

97 (
‹¡_max_size
 < (
ºcouÁs
 * 
dt_size
))) {

98 
‹¡_sk
 = 
TEST_SKIP_MEM_LIMIT
;

100 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_sk
, 
‹am
.
comm
)) {

103 
check_buf
 = 
	`ucc_m®loc
(
ºcouÁs
 * 
dt_size
, "check buf");

104 
	`UCC_MALLOC_CHECK
(
check_buf
);

106 ià(!
is_Úesided
) {

107 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
¢couÁs
 * 
dt_size
, 
mem_ty³
));

108 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
ºcouÁs
 * 
dt_size
, 
mem_ty³
));

109 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

110 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

112 
sbuf
 = 
·¿ms
.
bufãrs
[
MEM_SEND_SEGMENT
];

113 
rbuf
 = 
·¿ms
.
bufãrs
[
MEM_RECV_SEGMENT
];

114 
wÜk_buf
 = 
·¿ms
.
bufãrs
[
MEM_WORK_SEGMENT
];

115 
¬gs
.
glob®_wÜk_bufãr
 = 
wÜk_buf
;

118 
¬gs
.
¤c
.
šfo_v
.
bufãr
 = 
sbuf
;

119 
¬gs
.
¤c
.
šfo_v
.
d©©y³
 = 
dt
;

120 
¬gs
.
¤c
.
šfo_v
.
mem_ty³
 = mem_type;

122 
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
rbuf
;

123 
¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
dt
;

124 
¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = mem_type;

126 ià(
TEST_FLAG_VSIZE_64BIT
 =ğ
couÁ_b™s
 ||

127 
TEST_FLAG_VSIZE_64BIT
 =ğ
di¥l_b™s
) {

128 ià(
msgsize
 % 64 != 0) {

129 
‹¡_sk
 = 
TEST_SKIP_NOT_SUPPORTED
;

132 ià(
msgsize
 % 32 != 0) {

133 
‹¡_sk
 = 
TEST_SKIP_NOT_SUPPORTED
;

136 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_sk
, 
‹am
.
comm
)) {

140 ià(
TEST_FLAG_VSIZE_64BIT
 =ğ
couÁ_b™s
) {

141 
¬gs
.
¤c
.
šfo_v
.
couÁs
 = 
scouÁs64
 =

142 (
ucc_couÁ_t
*)
mpi_couÁs_to_ucc
<
ušt64_t
>(
scouÁs
, 
Årocs
);

143 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = 
rcouÁs64
 =

144 (
ucc_couÁ_t
*)
mpi_couÁs_to_ucc
<
ušt64_t
>(
rcouÁs
, 
Årocs
);

146 
¬gs
.
¤c
.
šfo_v
.
couÁs
 = (
ucc_couÁ_t
*)
scouÁs
;

147 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = (
ucc_couÁ_t
*)
rcouÁs
;

149 ià(
TEST_FLAG_VSIZE_64BIT
 =ğ
di¥l_b™s
) {

150 
¬gs
.
¤c
.
šfo_v
.
di¥Ïûm’ts
 = 
sdi¥ls64
 =

151 (
ucc_ašt_t
*)
mpi_couÁs_to_ucc
<
ušt64_t
>(
sdi¥ls
, 
Årocs
);

152 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = 
rdi¥ls64
 =

153 (
ucc_ašt_t
*)
mpi_couÁs_to_ucc
<
ušt64_t
>(
rdi¥ls
, 
Årocs
);

155 
¬gs
.
¤c
.
šfo_v
.
di¥Ïûm’ts
 = (
ucc_ašt_t
*)
sdi¥ls
;

156 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = (
ucc_ašt_t
*)
rdi¥ls
;

158 ià(
is_Úesided
) {

159 
MPI_D©©y³
 
d©©y³
;

160 
size_t
 
di¥_size
;

161 *
ldi¥
;

162 
®ÉßÎ_¡©us
;

164 ià(
TEST_FLAG_VSIZE_64BIT
 =ğ
di¥l_b™s
) {

165 
d©©y³
 = 
MPI_LONG
;

166 
di¥_size
 = (
ušt64_t
);

168 
d©©y³
 = 
MPI_INT
;

169 
di¥_size
 = (
ušt32_t
);

171 
ldi¥
 = 
	`ucc_ÿÎoc
(
Årocs
, 
di¥_size
, "displacements");

172 
	`UCC_MALLOC_CHECK
(
ldi¥
);

173 
®ÉßÎ_¡©us
 = 
	`MPI_AÎtßÎ
(
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
, 1,

174 
d©©y³
, 
ldi¥
, 1, d©©y³, 
‹am
.
comm
);

175 ià(
MPI_SUCCESS
 !ğ
®ÉßÎ_¡©us
) {

176 
¡d
::
û¼
 << "*** MPI ALLTOALL FAILED" << std::
’dl
;

177 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

179 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = (
ucc_ašt_t
 *)
ldi¥
;

181 
	`UCC_CHECK
(
	`£t_šput
());

182 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

183 
	}
}

185 
ucc_¡©us_t
 
	gTe¡AÎtßÎv
::
	$£t_šput
(
™”_³rsi¡’t
)

187 
¿nk
;

189 
this
->
™”_³rsi¡’t
 = iter_persistent;

190 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

191 
	`š™_bufãr
(
sbuf
, 
¢couÁs
, 
dt
, 
mem_ty³
, 
¿nk
 * (
™”_³rsi¡’t
 + 1));

193  
UCC_OK
;

194 
	}
}

196 
	gTe¡AÎtßÎv
::~
	$Te¡AÎtßÎv
()

198 
	`ä“
(
scouÁs
);

199 
	`ä“
(
sdi¥ls
);

200 
	`ä“
(
rcouÁs
);

201 
	`ä“
(
rdi¥ls
);

202 
	`ä“
(
scouÁs64
);

203 
	`ä“
(
sdi¥ls64
);

204 
	`ä“
(
rcouÁs64
);

205 
	`ä“
(
rdi¥ls64
);

206 
	}
}

208 
ucc_¡©us_t
 
	gTe¡AÎtßÎv
::
	$check
()

210 
MPI_Reque¡
 
»q
;

211 
i
, 
size
, 
¿nk
, 
com¶‘ed
;

213 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

214 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

216 
	`MPI_I®ÉßÎ
(
sdi¥ls
, 1, 
MPI_INT
, 
scouÁs
, 1, MPI_INT, 
‹am
.
comm
, &
»q
);

218 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

219 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

220 } !
com¶‘ed
);

222 
i
 = 0; i < 
size
; i++) {

223 
	`š™_bufãr
(
	`PTR_OFFSET
(
check_buf
, 
rdi¥ls
[
i
] * 
	`ucc_dt_size
(
dt
)),

224 
rcouÁs
[
i
], 
dt
, 
UCC_MEMORY_TYPE_HOST
,

225 
i
 * (
™”_³rsi¡’t
 + 1), 
scouÁs
[i]);

228  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
ºcouÁs
, 
dt
, 
mem_ty³
);

229 
	}
}

231 
	g¡d
::
¡ršg
 
Te¡AÎtßÎv
::
	$¡r
()

233  
Te¡Ca£
::
	`¡r
() +

234 " couÁs=" + (
couÁ_b™s
 =ğ
TEST_FLAG_VSIZE_64BIT
 ? "64" : "32") +

235 " di¥ls=" + (
di¥l_b™s
 =ğ
TEST_FLAG_VSIZE_64BIT
 ? "64" : "32");

236 
	}
}

	@test/mpi/test_barrier.cc

7 
	~"‹¡_mpi.h
"

9 
	gTe¡B¬r›r
::
	$Te¡B¬r›r
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

10 
	$Te¡Ca£
(
‹am
, 
UCC_COLL_TYPE_BARRIER
, 
·¿ms
)

12 
¡©us
 = 
UCC_OK
;

13 
	`UCC_CHECK
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.team));

14 
	}
}

16 
ucc_¡©us_t
 
	gTe¡B¬r›r
::
	$£t_šput
(
™”_³rsi¡’t
)

18  
UCC_OK
;

19 
	}
}

21 
ucc_¡©us_t
 
	gTe¡B¬r›r
::
	$check
()

23  
¡©us
;

24 
	}
}

26 
	g¡d
::
¡ršg
 
Te¡B¬r›r
::
	$¡r
() {

27  
¡d
::
	`¡ršg
("tc=")+¡d::¡ršg(
	`ucc_cŞl_ty³_¡r
(
¬gs
.
cŞl_ty³
)) +

28 
¡d
::
	`¡ršg
("—m="è+ std::¡ršg(
	`‹am_¡r
(
‹am
.
ty³
));

29 
	}
}

31 
ucc_¡©us_t
 
	gTe¡B¬r›r
::
	$‹¡
()

33  
UCC_OK
;

34 
	}
}

36 
	gTe¡B¬r›r
::
	$run
(
boŞ
 
Œigg”ed
)

38 
com¶‘ed
 = 1;

39 *
»cv
 = 
NULL
;

40 
¿nk
, 
size
;

41 
MPI_Reque¡
 
¼eq
;

43 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

44 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

45 ià(0 =ğ
¿nk
) {

46 
»cv
 = 
Ãw
 [
size
];

48 
	`¤ªd
(
¿nk
+1);

50 
	`u¦“p
((
	`¿nd
() % 500)*1000);

51 
i
 = 0; i < 
size
; i++) {

52 ià(0 =ğ
¿nk
) {

53 
»cv
[
i
] = -1;

54 
com¶‘ed
 = 0;

55 
	`MPI_I»cv
(&
»cv
[
i
], 1, 
MPI_INT
, 
MPI_ANY_SOURCE
, 123, 
‹am
.
comm
, &
¼eq
);

57 ià(
¿nk
 =ğ
i
) {

58 
	`MPI_S£nd
(&
¿nk
, 1, 
MPI_INT
, 0, 123, 
‹am
.
comm
);

60 
	`UCC_CHECK
(
	`ucc_cŞËùive_po¡
(
»q
));

62 
¡©us
 = 
	`ucc_cŞËùive_‹¡
(
»q
);

63 ià(
¡©us
 < 0) {

64 
¡d
::
û¼
 << "failure in collectiveest\n";

65 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

67 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

68 ià(0 =ğ
¿nk
 && !
com¶‘ed
) {

69 
	`MPI_Te¡
(&
¼eq
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

71 
	`mpi_´og»ss
();

72 } 
UCC_OK
 !ğ
¡©us
);

73 0 =ğ
¿nk
 && !
com¶‘ed
) {

74 
	`MPI_Te¡
(&
¼eq
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

75 
	`mpi_´og»ss
();

77 ià(!
³rsi¡’t
 && 
i
 < 
size
 - 1) {

78 
	`UCC_CHECK
(
	`ucc_cŞËùive_fš®ize
(
»q
));

79 
	`UCC_CHECK
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.team));

82 
	`MPI_B¬r›r
(
‹am
.
comm
);

83 ià(0 =ğ
¿nk
) {

84 
i
 = 0; i < 
size
; i++) {

85 ià(
»cv
[
i
] != i) {

86 
¡©us
 = 
UCC_ERR_NO_MESSAGE
;

91 ià(0 =ğ
¿nk
) {

92 
d–‘e
[] 
»cv
;

94 
	}
}

	@test/mpi/test_bcast.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	gTe¡Bÿ¡
::
	$Te¡Bÿ¡
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

11 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_BCAST
, 
·¿ms
)

13 
¿nk
, 
size
;

14 
size_t
 
dt_size
, 
couÁ
;

16 
dt
 = 
·¿ms
.dt;

17 
dt_size
 = 
	`ucc_dt_size
(
dt
);

18 
couÁ
 = 
msgsize
 / 
dt_size
;

19 
roÙ
 = 
·¿ms
.root;

21 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

22 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

24 ià(
	`sk_»duû
(
‹¡_max_size
 < 
msgsize
, 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

28 
check_buf
 = 
	`ucc_m®loc
(
msgsize
, "check buf");

29 
	`UCC_MALLOC_CHECK
(
check_buf
);

30 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

31 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

33 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

34 
¬gs
.
¤c
.
šfo
.
couÁ
 = count;

35 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

36 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

37 
¬gs
.
roÙ
 =„oot;

38 
	`UCC_CHECK
(
	`£t_šput
());

39 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

40 
	}
}

42 
ucc_¡©us_t
 
	gTe¡Bÿ¡
::
	$£t_šput
(
™”_³rsi¡’t
)

44 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

45 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

46 
¿nk
;

48 
this
->
™”_³rsi¡’t
 = iter_persistent;

49 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

50 ià(
¿nk
 =ğ
roÙ
) {

51 
	`š™_bufãr
(
sbuf
, 
couÁ
, 
dt
, 
mem_ty³
, 
¿nk
 * (
™”_³rsi¡’t
 + 1));

53  
UCC_OK
;

54 
	}
}

56 
ucc_¡©us_t
 
	gTe¡Bÿ¡
::
	$check
()

58 
size_t
 
couÁ
 = 
¬gs
.
¤c
.
šfo
.count;

59 
¿nk
;

61 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

62 ià(
¿nk
 =ğ
roÙ
) {

63  
UCC_OK
;

66 
	`š™_bufãr
(
check_buf
, 
couÁ
, 
dt
, 
UCC_MEMORY_TYPE_HOST
,

67 
roÙ
 * (
™”_³rsi¡’t
 + 1));

68  
	`com·»_bufãrs
(
sbuf
, 
check_buf
, 
couÁ
, 
dt
, 
mem_ty³
);

69 
	}
}

	@test/mpi/test_case.cc

7 
	~"‹¡_mpi.h
"

9 
	g¡d
::
veùÜ
<
¡d
::
sh¬ed_±r
<
Te¡Ca£
>>

10 
Te¡Ca£
::
	$š™
(
ucc_‹¡_‹am_t
 &
_‹am
, 
ucc_cŞl_ty³_t
 
_ty³
, 
num_‹¡s
,

11 
Te¡Ca£P¬ams
 
·¿ms
)

13 
¡d
::
veùÜ
<¡d::
sh¬ed_±r
<
Te¡Ca£
>> 
tcs
;

15 
i
 = 0; i < 
num_‹¡s
; i++) {

16 autØ
tc
 =

17 
	`š™_sšgË
(
_‹am
, 
_ty³
, 
·¿ms
);

18 ià(!
tc
) {

19 
tcs
.
	`ş—r
();

20  
tcs
;

22 
tcs
.
	`push_back
(
tc
);

24  
tcs
;

25 
	}
}

27 
	g¡d
::
sh¬ed_±r
<
Te¡Ca£
> Te¡Ca£::
	$š™_sšgË
(
ucc_‹¡_‹am_t
 &
_‹am
,

28 
ucc_cŞl_ty³_t
 
_ty³
,

29 
Te¡Ca£P¬ams
 
·¿ms
)

31 
_ty³
) {

32 
UCC_COLL_TYPE_ALLGATHER
:

33  
¡d
::
make_sh¬ed
<
Te¡AÎg©h”
>(
_‹am
, 
·¿ms
);

34 
UCC_COLL_TYPE_ALLGATHERV
:

35  
¡d
::
make_sh¬ed
<
Te¡AÎg©h”v
>(
_‹am
, 
·¿ms
);

36 
UCC_COLL_TYPE_ALLREDUCE
:

37  
¡d
::
make_sh¬ed
<
Te¡AÎ»duû
>(
_‹am
, 
·¿ms
);

38 
UCC_COLL_TYPE_ALLTOALL
:

39  
¡d
::
make_sh¬ed
<
Te¡AÎtßÎ
>(
_‹am
, 
·¿ms
);

40 
UCC_COLL_TYPE_ALLTOALLV
:

41  
¡d
::
make_sh¬ed
<
Te¡AÎtßÎv
>(
_‹am
, 
·¿ms
);

42 
UCC_COLL_TYPE_BARRIER
:

43  
¡d
::
make_sh¬ed
<
Te¡B¬r›r
>(
_‹am
, 
·¿ms
);

44 
UCC_COLL_TYPE_BCAST
:

45  
¡d
::
make_sh¬ed
<
Te¡Bÿ¡
>(
_‹am
, 
·¿ms
);

46 
UCC_COLL_TYPE_GATHER
:

47  
¡d
::
make_sh¬ed
<
Te¡G©h”
>(
_‹am
, 
·¿ms
);

48 
UCC_COLL_TYPE_GATHERV
:

49  
¡d
::
make_sh¬ed
<
Te¡G©h”v
>(
_‹am
, 
·¿ms
);

50 
UCC_COLL_TYPE_REDUCE
:

51  
¡d
::
make_sh¬ed
<
Te¡Reduû
>(
_‹am
, 
·¿ms
);

52 
UCC_COLL_TYPE_REDUCE_SCATTER
:

53  
¡d
::
make_sh¬ed
<
Te¡ReduûSÿ‰”
>(
_‹am
, 
·¿ms
);

54 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

55  
¡d
::
make_sh¬ed
<
Te¡ReduûSÿ‰”v
>(
_‹am
, 
·¿ms
);

56 
UCC_COLL_TYPE_SCATTER
:

57  
¡d
::
make_sh¬ed
<
Te¡Sÿ‰”
>(
_‹am
, 
·¿ms
);

58 
UCC_COLL_TYPE_SCATTERV
:

59  
¡d
::
make_sh¬ed
<
Te¡Sÿ‰”v
>(
_‹am
, 
·¿ms
);

61 
¡d
::
û¼
 << "cŞËùivty³ i nÙ suµÜ‹d" << std::
’dl
;

64  
NULL
;

65 
	}
}

67 
	gTe¡Ca£
::
	$run
(
boŞ
 
Œigg”ed
)

69 ià(
Œigg”ed
) {

70 
ucc_“_h
 
“
 = 
nuÎ±r
;

71 
ucc_ev_t
 
comp_ev
, *
po¡_ev
;

72 
ucc_“_ty³_t
 
“_ty³
;

74 ià(
mem_ty³
 =ğ
UCC_MEMORY_TYPE_CUDA
) {

75 
“_ty³
 = 
UCC_EE_CUDA_STREAM
;

77 
	`UCC_CHECK
(
UCC_ERR_NOT_SUPPORTED
);

80 
	`UCC_CHECK
(
‹am
.
	`g‘_“
(
“_ty³
, &
“
));

81 
comp_ev
.
ev_ty³
 = 
UCC_EVENT_COMPUTE_COMPLETE
;

82 
comp_ev
.
ev_cÚ‹xt
 = 
nuÎ±r
;

83 
comp_ev
.
ev_cÚ‹xt_size
 = 0;

84 
comp_ev
.
»q
 =„eq;

87 
	`UCC_CHECK
(
	`ucc_cŞËùive_Œigg”ed_po¡
(
“
, &
comp_ev
));

88 
	`UCC_CHECK
(
	`ucc_“_g‘_ev’t
(
“
, &
po¡_ev
));

89 
	`UCC_CHECK
(
	`ucc_“_ack_ev’t
(
“
, 
po¡_ev
));

91 
	`UCC_CHECK
(
	`ucc_cŞËùive_po¡
(
»q
));

93 
	}
}

95 
ucc_¡©us_t
 
	gTe¡Ca£
::
	$‹¡
()

97  
	`ucc_cŞËùive_‹¡
(
»q
);

98 
	}
}

100 
	gTe¡Ca£
::
	$wa™
()

102 
ucc_¡©us_t
 
¡©us
;

104 
	`mpi_´og»ss
();

105 
¡©us
 = 
	`‹¡
();

106 ià(
¡©us
 < 0) {

107 
¡d
::
û¼
 << "error during collest: "

108 << 
	`ucc_¡©us_¡ršg
(
¡©us
)

109 << " ("<<
¡©us
<<")" << 
¡d
::
’dl
;

110 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

112 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

113 } 
UCC_OK
 !ğ
¡©us
);

114 
	}
}

116 
	gTe¡Ca£
::
	$mpi_´og»ss
()

118 
MPI_Stus
 
¡©us
;

119 
æag
 = 0;

120 
	`MPI_Te¡
(&
´og»ss_»que¡
, &
æag
, &
¡©us
);

121 
	}
}

123 
	g¡d
::
¡ršg
 
Te¡Ca£
::
	$¡r
() {

124 
¡d
::
¡ršg
 
_¡r
 = std::
	`¡ršg
("tc=");

125 ià(
¬gs
.
æags
 & 
UCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
) {

126 
_¡r
 +ğ
¡d
::
	`¡ršg
("Onesided ");

129 
_¡r
 +ğ
¡d
::
	`¡ršg
(
	`ucc_cŞl_ty³_¡r
(
¬gs
.
cŞl_ty³
)) +

130 "—m=" + 
	`‹am_¡r
(
‹am
.
ty³
) +

131 " mty³=" + 
ucc_memÜy_ty³_Çmes
[
mem_ty³
] +

132 " msgsize=" + 
¡d
::
	`to_¡ršg
(
msgsize
) +

133 "…”si¡’t=" + (
³rsi¡’t
 ? "1" : "0");

134 ià(
	`ucc_cŞl_š¶aû_suµÜ‹d
(
¬gs
.
cŞl_ty³
)) {

135 
_¡r
 +ğ
¡d
::
	`¡ršg
(" iÅÏû="è+ (
š¶aû
 ? "1" : "0");

137 ià(
	`ucc_cŞl_is_roÙed
(
¬gs
.
cŞl_ty³
)) {

138 
_¡r
 +ğ
¡d
::
	`¡ršg
("„oÙ="è+ std::
	`to_¡ršg
(
roÙ
);

140 ià(
	`ucc_cŞl_has_d©©y³
(
¬gs
.
cŞl_ty³
)) {

141 
_¡r
 +ğ
¡d
::
	`¡ršg
(" dt="è+ 
	`ucc_d©©y³_¡r
(
dt
);

144  
_¡r
;

145 
	}
}

147 
‹¡_sk_ÿu£_t
 
	gTe¡Ca£
::
	$sk_»duû
(
sk_cÚd
, 
‹¡_sk_ÿu£_t
 
ÿu£
,

148 
MPI_Comm
 
comm
)

150 
‹¡_sk_ÿu£_t
 
‹¡_sk
;

151 
‹¡_sk_ÿu£_t
 
sk
 = 
sk_cÚd
 ? 
ÿu£
 : 
Te¡Ca£
::
‹¡_sk
;

152 
MPI_Reque¡
 
»q
;

153 
com¶‘ed
;

155 
	`MPI_I®Ìeduû
((*)&
sk
, (*)&
‹¡_sk
, 1, 
MPI_INT
, 
MPI_MAX
, 
comm
, &
»q
);

157 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

158 
	`tc_´og»ss_ùx
();

159 } !
com¶‘ed
);

160 
Te¡Ca£
::
‹¡_sk
 =est_skip;

161  
‹¡_sk
;

162 
	}
}

164 
‹¡_sk_ÿu£_t
 
	gTe¡Ca£
::
	$sk_»duû
(
‹¡_sk_ÿu£_t
 
ÿu£
, 
MPI_Comm
 
comm
)

166  
	`sk_»duû
(1, 
ÿu£
, 
comm
);

167 
	}
}

169 
	gTe¡Ca£
::
	$tc_´og»ss_ùx
()

171 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

172 
	}
}

174 
	gTe¡Ca£
::
	$Te¡Ca£
(
ucc_‹¡_‹am_t
 &
_‹am
, 
ucc_cŞl_ty³_t
 
ù
,

175 
Te¡Ca£P¬ams
 
·¿ms
) :

176 
	`‹am
(
_‹am
), 
	`mem_ty³
(
·¿ms
.
mt
), 
	`msgsize
Õ¬ams.
msgsize
),

177 
	`š¶aû
(
·¿ms
.
š¶aû
), 
	`³rsi¡’t
Õ¬ams.
³rsi¡’t
),

178 
	`‹¡_max_size
(
·¿ms
.
max_size
), 
	$dt
(
·¿ms
.
dt
)

180 
¿nk
;

182 
sbuf
 = 
NULL
;

183 
rbuf
 = 
NULL
;

184 
check_buf
 = 
NULL
;

185 
sbuf_mc_h—d”
 = 
NULL
;

186 
rbuf_mc_h—d”
 = 
NULL
;

187 
‹¡_sk
 = 
TEST_SKIP_NONE
;

188 
¬gs
.
æags
 = 0;

189 
¬gs
.
mask
 = 0;

190 
¬gs
.
cŞl_ty³
 = 
ù
;

192 ià(
š¶aû
) {

193 
¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

194 
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

197 ià(
³rsi¡’t
) {

198 
¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

199 
¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

202 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
¿nk
);

203 
	`MPI_I»cv
((*)
´og»ss_buf
, 1, 
MPI_CHAR
, 
¿nk
, 0, 
MPI_COMM_WORLD
,

204 &
´og»ss_»que¡
);

205 
	}
}

207 
	gTe¡Ca£
::~
	$Te¡Ca£
()

209 
MPI_Stus
 
¡©us
;

210 
	`MPI_Cªûl
(&
´og»ss_»que¡
);

211 
	`MPI_Wa™
(&
´og»ss_»que¡
, &
¡©us
);

213 ià(
TEST_SKIP_NONE
 =ğ
‹¡_sk
) {

214 
	`UCC_CHECK
(
	`ucc_cŞËùive_fš®ize
(
»q
));

216 ià(
sbuf_mc_h—d”
) {

217 
	`UCC_CHECK
(
	`ucc_mc_ä“
(
sbuf_mc_h—d”
));

219 ià(
rbuf_mc_h—d”
) {

220 
	`UCC_CHECK
(
	`ucc_mc_ä“
(
rbuf_mc_h—d”
));

222 ià(
check_buf
) {

223 
	`ucc_ä“
(
check_buf
);

225 
	}
}

	@test/mpi/test_gather.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	gTe¡G©h”
::
	$Te¡G©h”
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

11 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_GATHER
, 
·¿ms
)

13 
¿nk
, 
size
;

14 
size_t
 
dt_size
, 
sšgË_¿nk_couÁ
;

16 
dt
 = 
·¿ms
.dt;

17 
dt_size
 = 
	`ucc_dt_size
(
dt
);

18 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
dt_size
;

19 
roÙ
 = 
·¿ms
.root;

21 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

22 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

24 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_max_size
 < (
msgsize
 * 
size
),

25 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

29 ià(
¿nk
 =ğ
roÙ
) {

30 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
 * 
size
, 
mem_ty³
));

31 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

32 ià(
š¶aû
) {

33 
sbuf_mc_h—d”
 = 
NULL
;

34 
sbuf
 = 
NULL
;

36 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

37 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

40 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

41 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

42 
rbuf_mc_h—d”
 = 
NULL
;

43 
rbuf
 = 
NULL
;

46 
check_buf
 = 
	`ucc_m®loc
(
msgsize
*
size
, "check buf");

47 
	`UCC_MALLOC_CHECK
(
check_buf
);

49 
¬gs
.
roÙ
 =„oot;

50 ià(
¿nk
 =ğ
roÙ
) {

51 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

52 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
 * 
size
;

53 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

54 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

55 ià(!
š¶aû
) {

56 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

57 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
;

58 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

59 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

62 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

63 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
;

64 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

65 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

68 
	`UCC_CHECK
(
	`£t_šput
());

69 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

70 
	}
}

72 
ucc_¡©us_t
 
	gTe¡G©h”
::
	$£t_šput
(
™”_³rsi¡’t
)

74 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

75 
size_t
 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
dt_size
;

76 
size_t
 
sšgË_¿nk_size
 = 
sšgË_¿nk_couÁ
 * 
dt_size
;

77 
¿nk
;

78 *
buf
;

80 
this
->
™”_³rsi¡’t
 = iter_persistent;

81 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

82 ià(
¿nk
 =ğ
roÙ
) {

83 ià(
š¶aû
) {

84 
buf
 = 
	`PTR_OFFSET
(
rbuf
, 
¿nk
 * 
sšgË_¿nk_size
);

86 
buf
 = 
sbuf
;

89 
buf
 = 
sbuf
;

91 
	`š™_bufãr
(
buf
, 
sšgË_¿nk_couÁ
, 
dt
, 
mem_ty³
,

92 
¿nk
 * (
™”_³rsi¡’t
 + 1));

93  
UCC_OK
;

94 
	}
}

96 
ucc_¡©us_t
 
	gTe¡G©h”
::
	$check
()

98 
size
, 
¿nk
, 
i
;

99 
size_t
 
dt_size
, 
sšgË_¿nk_couÁ
;

101 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

102 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

103 ià(
¿nk
 !ğ
roÙ
) {

104  
UCC_OK
;

107 
dt_size
 = 
	`ucc_dt_size
(
dt
);

108 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
dt_size
;

109 
i
 = 0; i < 
size
; i++) {

110 
	`š™_bufãr
(
	`PTR_OFFSET
(
check_buf
, 
i
 * 
sšgË_¿nk_couÁ
 * 
dt_size
),

111 
sšgË_¿nk_couÁ
, 
dt
, 
UCC_MEMORY_TYPE_HOST
,

112 
i
 * (
™”_³rsi¡’t
 + 1));

115  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
sšgË_¿nk_couÁ
 * 
size
, 
dt
,

116 
mem_ty³
);

117 
	}
}

	@test/mpi/test_gatherv.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	$fl_couÁs_ªd_di¥Ïûm’ts
(
size
, 
couÁ
,

11 
ušt32_t
 *
couÁs
, ušt32_ˆ*
di¥ls
)

13 
bŸs
 = 
couÁ
 / 2;

14 
i
;

16 
couÁs
[0] = 
couÁ
 - 
bŸs
;

17 
di¥ls
[0] = 0;

18 
i
 = 1; i < 
size
 - 1; i++) {

19 ià(
i
 % 2 == 0) {

20 
couÁs
[
i
] = 
couÁ
 - 
bŸs
;

22 
couÁs
[
i
] = 
couÁ
 + 
bŸs
;

24 
di¥ls
[
i
] = di¥ls[˜- 1] + 
couÁs
[i - 1];

26 ià(
size
 % 2 == 0) {

27 
couÁs
[
size
 - 1] = 
couÁ
 + 
bŸs
;

29 
couÁs
[
size
 - 1] = 
couÁ
;

31 
di¥ls
[
size
 - 1] = di¥ls[siz- 2] + 
couÁs
[size - 2];

32 
	}
}

34 
	gTe¡G©h”v
::
	$Te¡G©h”v
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

35 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_GATHERV
, 
·¿ms
)

37 
¿nk
, 
size
;

38 
size_t
 
dt_size
, 
couÁ
;

40 
dt
 = 
·¿ms
.dt;

41 
dt_size
 = 
	`ucc_dt_size
(
dt
);

42 
couÁ
 = 
msgsize
 / 
dt_size
;

43 
roÙ
 = 
·¿ms
.root;

44 
couÁs
 = 
NULL
;

45 
di¥Ïûm’ts
 = 
NULL
;

47 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

48 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

50 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_max_size
 < (
msgsize
 * 
size
),

51 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

54 
couÁs
 = (
ušt32_t
 *è
	`ucc_m®loc
(
size
 * (uint32_t),

56 
di¥Ïûm’ts
 = (
ušt32_t
 *è
	`ucc_m®loc
(
size
 * (uint32_t),

58 
	`fl_couÁs_ªd_di¥Ïûm’ts
(
size
, 
couÁ
, 
couÁs
, 
di¥Ïûm’ts
);

60 ià(
¿nk
 =ğ
roÙ
) {

61 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
couÁ
 * 
size
 * 
dt_size
, 
mem_ty³
));

62 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

63 ià(
š¶aû
) {

64 
sbuf_mc_h—d”
 = 
NULL
;

65 
sbuf
 = 
NULL
;

67 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
couÁs
[
¿nk
] * 
dt_size
,

68 
mem_ty³
));

69 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

72 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
couÁs
[
¿nk
] * 
dt_size
, 
mem_ty³
));

73 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

74 
rbuf_mc_h—d”
 = 
NULL
;

75 
rbuf
 = 
NULL
;

78 
check_buf
 = 
	`ucc_m®loc
(
couÁ
 * 
size
 * 
dt_size
, "check buf");

79 
	`UCC_MALLOC_CHECK
(
check_buf
);

81 
¬gs
.
roÙ
 =„oot;

82 ià(
¿nk
 =ğ
roÙ
) {

83 
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
rbuf
;

84 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = (
ucc_couÁ_t
*)counts;

85 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = (
ucc_ašt_t
*)displacements;

86 
¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
dt
;

87 
¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = mem_type;

88 ià(!
š¶aû
) {

89 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

90 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
couÁs
[
¿nk
];

91 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

92 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

95 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

96 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
couÁs
[
¿nk
];

97 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

98 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

101 
	`UCC_CHECK
(
	`£t_šput
());

102 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

103 
	}
}

105 
ucc_¡©us_t
 
	gTe¡G©h”v
::
	$£t_šput
(
™”_³rsi¡’t
)

107 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

108 
¿nk
;

109 *
buf
;

111 
this
->
™”_³rsi¡’t
 = iter_persistent;

112 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

113 ià(
¿nk
 =ğ
roÙ
) {

114 ià(
š¶aû
) {

115 
buf
 = 
	`PTR_OFFSET
(
rbuf
, 
di¥Ïûm’ts
[
¿nk
] * 
dt_size
);

117 
buf
 = 
sbuf
;

120 
buf
 = 
sbuf
;

122 
	`š™_bufãr
(
buf
, 
couÁs
[
¿nk
], 
dt
, 
mem_ty³
,„ªk * (
™”_³rsi¡’t
 + 1));

124  
UCC_OK
;

125 
	}
}

127 
	gTe¡G©h”v
::~
	$Te¡G©h”v
()

129 ià(
couÁs
) {

130 
	`ucc_ä“
(
couÁs
);

132 ià(
di¥Ïûm’ts
) {

133 
	`ucc_ä“
(
di¥Ïûm’ts
);

135 
	}
}

137 
ucc_¡©us_t
 
	gTe¡G©h”v
::
	$check
()

139 
size_t
 
couÁ
 = 
msgsize
 / 
	`ucc_dt_size
(
dt
);

140 
size
, 
¿nk
, 
i
;

142 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

143 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

145 ià(
¿nk
 !ğ
roÙ
) {

146  
UCC_OK
;

149 
i
 = 0; i < 
size
; i++) {

150 
	`š™_bufãr
(
	`PTR_OFFSET
(
check_buf
, 
di¥Ïûm’ts
[
i
] * 
	`ucc_dt_size
(
dt
)),

151 
couÁs
[
i
], 
dt
, 
UCC_MEMORY_TYPE_HOST
,

152 
i
 * (
™”_³rsi¡’t
 + 1));

155  (
¿nk
 !ğ
roÙ
)

156 ? 
UCC_OK


157 : 
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
couÁ
 * 
size
, 
dt
, 
mem_ty³
);

158 
	}
}

	@test/mpi/test_mpi.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

9 
	gBEGIN_C_DECLS


10 
	~"uts/ucc_m©h.h
"

11 
	gEND_C_DECLS


12 
	~<®gÜ™hm
>

13 
	~<as£¹.h
>

14 
	~<¿ndom
>

15 
	~<±h»ad.h
>

17 
ucc_¡©us_t
 
	$oob_®lg©h”
(*
sbuf
, *
rbuf
, 
size_t
 
msgËn
,

18 *
cŞl_šfo
, **
»q
)

20 
MPI_Comm
 
comm
 = (MPI_Comm)(
ušŒ_t
)
cŞl_šfo
;

21 
MPI_Reque¡
 
»que¡
;

22 
	`MPI_I®lg©h”
(
sbuf
, 
msgËn
, 
MPI_BYTE
, 
rbuf
, msgËn, MPI_BYTE, 
comm
,

23 &
»que¡
);

24 *
»q
 = (*)(
ušŒ_t
)
»que¡
;

25  
UCC_OK
;

26 
	}
}

28 
ucc_¡©us_t
 
	$oob_®lg©h”_‹¡
(*
»q
)

30 
MPI_Reque¡
 
»que¡
 = (MPI_Reque¡)(
ušŒ_t
)
»q
;

31 
com¶‘ed
;

32 
	`MPI_Te¡
(&
»que¡
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

33  
com¶‘ed
 ? 
UCC_OK
 : 
UCC_INPROGRESS
;

34 
	}
}

36 
ucc_¡©us_t
 
	$oob_®lg©h”_ä“
(*
»q
)

38  
UCC_OK
;

39 
	}
}

41 
	gUccTe¡Mpi
::
	$UccTe¡Mpi
(
¬gc
, *
¬gv
[], 
ucc_th»ad_mode_t
 
_tm
,

42 
is_loÿl
, 
boŞ
 
w™h_Úesided
)

44 
ucc_lib_cÚfig_h
 
lib_cÚfig
;

45 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

46 
size
, 
¿nk
;

47 *
´ev_’v
;

48 
ucc_mem_m­_t
 
£gm’ts
[
UCC_TEST_N_MEM_SEGMENTS
];

50 
	`MPI_Comm_size
(
MPI_COMM_WORLD
, &
size
);

51 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
¿nk
);

54 
ucc_lib_·¿ms_t
 
lib_·¿ms
 = {

55 .
mask
 = 
UCC_LIB_PARAM_FIELD_THREAD_MODE
,

56 .
th»ad_mode
 = 
_tm
,

59 
tm
 = 
_tm
;

61 
ucc_cÚ‹xt_·¿ms_t
 
ùx_·¿ms
 = {};

62 
ucc_cÚ‹xt_·¿ms_t
 
Úesided_ùx_·¿ms
 = {};

63 ià(!
is_loÿl
) {

64 
ùx_·¿ms
.
mask
 |ğ
UCC_CONTEXT_PARAM_FIELD_OOB
;

65 
ùx_·¿ms
.
oob
.
®lg©h”
 = 
oob_®lg©h”
;

66 
ùx_·¿ms
.
oob
.
»q_‹¡
 = 
oob_®lg©h”_‹¡
;

67 
ùx_·¿ms
.
oob
.
»q_ä“
 = 
oob_®lg©h”_ä“
;

68 
ùx_·¿ms
.
oob
.
cŞl_šfo
 = (*)(
ušŒ_t
)
MPI_COMM_WORLD
;

69 
ùx_·¿ms
.
oob
.
n_oob_•s
 = 
size
;

70 
ùx_·¿ms
.
oob
.
oob_•
 = 
¿nk
;

72 ià(
w™h_Úesided
) {

73 
Úesided_ùx_·¿ms
 = 
ùx_·¿ms
;

74 autØ
i
 = 0; i < 
UCC_TEST_N_MEM_SEGMENTS
; i++) {

75 
Úesided_bufãrs
[
i
] = 
	`ucc_ÿÎoc
(
UCC_TEST_MEM_SEGMENT_SIZE
,

76 
size
, "onesided buffers");

77 
	`UCC_MALLOC_CHECK
(
Úesided_bufãrs
[
i
]);

78 
£gm’ts
[
i
].
add»ss
 = 
Úesided_bufãrs
[i];

79 
£gm’ts
[
i
].
Ën
 = 
UCC_TEST_MEM_SEGMENT_SIZE
 * 
size
;

81 
Úesided_ùx_·¿ms
.
mask
 |ğ
UCC_CONTEXT_PARAM_FIELD_MEM_PARAMS
;

82 
Úesided_ùx_·¿ms
.
mem_·¿ms
.
£gm’ts
 = segments;

83 
Úesided_ùx_·¿ms
.
mem_·¿ms
.
n_£gm’ts
 = 
UCC_TEST_N_MEM_SEGMENTS
;

86 ià(!
w™h_Úesided
) {

87 autØ
i
 = 0; i < 
UCC_TEST_N_MEM_SEGMENTS
; i++) {

88 
Úesided_bufãrs
[
i
] = 
NULL
;

91 
	`UCC_CHECK
(
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
lib_cÚfig
));

92 
	`UCC_CHECK
(
	`ucc_š™
(&
lib_·¿ms
, 
lib_cÚfig
, &
lib
));

93 
	`ucc_lib_cÚfig_»Ëa£
(
lib_cÚfig
);

94 
	`UCC_CHECK
(
	`ucc_cÚ‹xt_cÚfig_»ad
(
lib
, 
NULL
, &
ùx_cÚfig
));

95 
	`UCC_CHECK
(
	`ucc_cÚ‹xt_ü—‹
(
lib
, &
ùx_·¿ms
, 
ùx_cÚfig
, &
ùx
));

96 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

97 ià(
w™h_Úesided
) {

98 
´ev_’v
 = 
	`g‘’v
("UCC_TL_UCP_TUNE");

99 
	`£‹nv
("UCC_TL_UCP_TUNE", "alltoall:0-inf:@onesided#alltoallv:0-inf:@onesided", 1);

100 
	`UCC_CHECK
(
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
lib_cÚfig
));

101 
	`UCC_CHECK
(
	`ucc_š™
(&
lib_·¿ms
, 
lib_cÚfig
, &
Úesided_lib
));

102 
	`ucc_lib_cÚfig_»Ëa£
(
lib_cÚfig
);

103 
	`UCC_CHECK
(
	`ucc_cÚ‹xt_cÚfig_»ad
(
Úesided_lib
, 
NULL
, &
ùx_cÚfig
));

104 
	`UCC_CHECK
(
	`ucc_cÚ‹xt_ü—‹
(
Úesided_lib
, &
Úesided_ùx_·¿ms
,

105 
ùx_cÚfig
, &
Úesided_ùx
));

106 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

107 ià(
´ev_’v
) {

108 
	`pu‹nv
(
´ev_’v
);

110 
	`un£‹nv
("UCC_TL_UCP_TUNE");

113 
Úesided_lib
 = 
nuÎ±r
;

114 
Úesided_ùx
 = 
nuÎ±r
;

116 
	`£t_msgsizes
(8, ((1ULL) << 21), 8);

117 
dty³s
 = {
UCC_DT_INT16
, 
UCC_DT_INT32
,

118 
UCC_DT_INT64
, 
UCC_DT_UINT16
,

119 
UCC_DT_UINT32
, 
UCC_DT_UINT64
,

120 
UCC_DT_FLOAT32
, 
UCC_DT_FLOAT64
,

121 
UCC_DT_FLOAT128
, 
UCC_DT_FLOAT32_COMPLEX
,

122 
UCC_DT_FLOAT64_COMPLEX
, 
UCC_DT_FLOAT128_COMPLEX
};

123 
İs
 = {
UCC_OP_SUM
, 
UCC_OP_MAX
};

124 
cŞls
 = {
UCC_COLL_TYPE_BARRIER
, 
UCC_COLL_TYPE_ALLREDUCE
};

125 
mty³s
 = {
UCC_MEMORY_TYPE_HOST
};

126 
š¶aû
 = 
çl£
;

127 
³rsi¡’t
 = 
çl£
;

128 
roÙ_ty³
 = 
ROOT_RANDOM
;

129 
roÙ_v®ue
 = 10;

130 
™”©iÚs
 = 1;

131 
Œigg”ed
 = 
çl£
;

132 
	}
}

134 
	gUccTe¡Mpi
::
	$£t_™”
(
™”
)

136 
™”©iÚs
 = 
™”
;

137 
	}
}

139 
	gUccTe¡Mpi
::
	$£t_v”bo£
(
boŞ
 
_v”bo£
)

141 
v”bo£
 = 
_v”bo£
;

142 
	}
}

144 
	gUccTe¡Mpi
::
ü—‹_‹ams
(
¡d
::
veùÜ
<
ucc_‹¡_mpi_‹am_t
> &
‹¡_‹ams
,

145 
boŞ
 
is_Úesided
)

147 
	g¿nk
, 
	gsize
;

148 
MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
¿nk
);

149 
MPI_Comm_size
(
MPI_COMM_WORLD
, &
size
);

150 autØ&
	gt
 : 
‹¡_‹ams
) {

151 ià(
size
 < 4 && (
t
 =ğ
TEAM_SPLIT_HALF
 || =ğ
TEAM_SPLIT_ODD_EVEN
)) {

152 ià(
¿nk
 == 0) {

153 
¡d
::
cout
 << "sizoàthwÜld=" << 
size
 <<

154 " i toØsm®ÈtØü—‹—m " << 
‹am_¡r
(
t
) <<

159 
ü—‹_‹am
(
t
, 
is_Úesided
);

163 
	gUccTe¡Mpi
::~
	$UccTe¡Mpi
()

165 autØ&
t
 : 
‹ams
) {

166 
	`de¡roy_‹am
(
t
);

168 autØ&
t
 : 
Úesided_‹ams
) {

169 
	`de¡roy_‹am
(
t
);

171 ià(
Úesided_bufãrs
[0]) {

172 autØ
i
 = 0; i < 
UCC_TEST_N_MEM_SEGMENTS
; i++) {

173 
	`ucc_ä“
(
Úesided_bufãrs
[
i
]);

175 
	`UCC_CHECK
(
	`ucc_cÚ‹xt_de¡roy
(
Úesided_ùx
));

176 
	`UCC_CHECK
(
	`ucc_fš®ize
(
Úesided_lib
));

178 
	`UCC_CHECK
(
	`ucc_cÚ‹xt_de¡roy
(
ùx
));

179 
	`UCC_CHECK
(
	`ucc_fš®ize
(
lib
));

180 
	}
}

182 
ucc_‹am_h
 
	gUccTe¡Mpi
::
	$ü—‹_ucc_‹am
(
MPI_Comm
 
comm
, 
boŞ
 
is_Úesided
)

184 
ucc_cÚ‹xt_h
 
‹am_ùx
 = 
ùx
;

185 
¿nk
, 
size
;

186 
ucc_‹am_h
 
‹am
;

187 
ucc_‹am_·¿ms_t
 
‹am_·¿ms
;

188 
ucc_¡©us_t
 
¡©us
;

189 
	`MPI_Comm_¿nk
(
comm
, &
¿nk
);

190 
	`MPI_Comm_size
(
comm
, &
size
);

193 
‹am_·¿ms
.
mask
 = 
UCC_TEAM_PARAM_FIELD_EP
 |

194 
UCC_TEAM_PARAM_FIELD_EP_RANGE
 |

195 
UCC_TEAM_PARAM_FIELD_OOB
;

196 
‹am_·¿ms
.
oob
.
®lg©h”
 = 
oob_®lg©h”
;

197 
‹am_·¿ms
.
oob
.
»q_‹¡
 = 
oob_®lg©h”_‹¡
;

198 
‹am_·¿ms
.
oob
.
»q_ä“
 = 
oob_®lg©h”_ä“
;

199 
‹am_·¿ms
.
oob
.
cŞl_šfo
 = (*)(
ušŒ_t
)
comm
;

200 
‹am_·¿ms
.
oob
.
n_oob_•s
 = 
size
;

201 
‹am_·¿ms
.
oob
.
oob_•
 = 
¿nk
;

202 
‹am_·¿ms
.
•
 = 
¿nk
;

203 
‹am_·¿ms
.
•_¿nge
 = 
UCC_COLLECTIVE_EP_RANGE_CONTIG
;

205 ià(
is_Úesided
) {

206 
‹am_·¿ms
.
mask
 |ğ
UCC_TEAM_PARAM_FIELD_FLAGS
;

207 
‹am_·¿ms
.
æags
 = 
UCC_TEAM_FLAG_COLL_WORK_BUFFER
;

208 
‹am_ùx
 = 
Úesided_ùx
;

210 
	`UCC_CHECK
(
	`ucc_‹am_ü—‹_po¡
(&
‹am_ùx
, 1, &
‹am_·¿ms
, &
‹am
));

212 
MPI_Reque¡
 
»q
;

213 
tmp
;

214 
com¶‘ed
;

215 
	`MPI_I»cv
(&
tmp
, 1, 
MPI_INT
, 
¿nk
, 123, 
comm
, &
»q
);

216 
UCC_INPROGRESS
 =ğ(
¡©us
 = 
	`ucc_‹am_ü—‹_‹¡
(
‹am
))) {

217 
	`ucc_cÚ‹xt_´og»ss
(
‹am_ùx
);

218 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

220 
	`MPI_S’d
(&
tmp
, 1, 
MPI_INT
, 
¿nk
, 123, 
comm
);

221 
	`MPI_Wa™
(&
»q
, 
MPI_STATUS_IGNORE
);

222 ià(
¡©us
 < 0) {

223 
¡d
::
û¼
 << "*** UCC TEST FAIL: ucc_team_create_test failed\n";

224 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

226  
‹am
;

227 
	}
}

229 
	gUccTe¡Mpi
::
	$ü—‹_‹am
(
ucc_‹¡_mpi_‹am_t
 
t
, 
boŞ
 
is_Úesided
)

231 
ucc_‹am_h
 
‹am
;

232 
MPI_Comm
 
comm
 = 
	`ü—‹_mpi_comm
(
t
);

233 ià(
is_Úesided
) {

234 
MPI_Comm
 
comm_dup
;

235 
	`MPI_Comm_dup
(
comm
, &
comm_dup
);

236 
‹am
 = 
	`ü—‹_ucc_‹am
(
comm_dup
, 
Œue
);

237 
Úesided_‹ams
.
	`push_back
(
	`ucc_‹¡_‹am_t
(
t
, 
comm_dup
, 
‹am
, 
Úesided_ùx
));

239 
‹am
 = 
	`ü—‹_ucc_‹am
(
comm
);

240 
‹ams
.
	`push_back
(
	`ucc_‹¡_‹am_t
(
t
, 
comm
, 
‹am
, 
ùx
));

242 
	}
}

244 
	gUccTe¡Mpi
::
	$de¡roy_‹am
(
ucc_‹¡_‹am_t
 &
‹am
)

246 
ucc_¡©us_t
 
¡©us
;

248 
‹am
.
	`ä“_“
();

249 
UCC_INPROGRESS
 =ğ(
¡©us
 = 
	`ucc_‹am_de¡roy
(
‹am
.team))) {}

250 ià(
UCC_OK
 !ğ
¡©us
) {

251 
¡d
::
û¼
 << "ucc_team_destroy failed\n";

253 ià(
‹am
.
comm
 !ğ
MPI_COMM_WORLD
) {

254 
	`MPI_Comm_ä“
(&
‹am
.
comm
);

256 
	}
}

258 
	gUccTe¡Mpi
::
	$£t_msgsizes
(
size_t
 
mš
, size_ˆ
max
, size_ˆ
pow”
)

260 
size_t
 
m
 = 
mš
;

261 
msgsizes
.
	`ş—r
();

262 
m
 < 
max
) {

263 
msgsizes
.
	`push_back
(
m
);

264 
m
 *ğ
pow”
;

266 
msgsizes
.
	`push_back
(
max
);

267 
	}
}

269 
	gUccTe¡Mpi
::
£t_dty³s
(
¡d
::
veùÜ
<
ucc_d©©y³_t
> &
_dty³s
)

271 
dty³s
 = 
_dty³s
;

274 
	gUccTe¡Mpi
::
£t_mty³s
(
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> &
_mty³s
)

276 
mty³s
 = 
_mty³s
;

279 
	gUccTe¡Mpi
::
£t_cŞls
(
¡d
::
veùÜ
<
ucc_cŞl_ty³_t
> &
_cŞls
)

281 
cŞls
 = 
_cŞls
;

284 
	gUccTe¡Mpi
::
£t_İs
(
¡d
::
veùÜ
<
ucc_»duùiÚ_İ_t
> &
_İs
)

286 
İs
 = 
_İs
;

289 
	$ucc_cŞl_»duû_suµÜ‹d
(
ucc_»duùiÚ_İ_t
 
İ
, 
ucc_d©©y³_t
 
dt
)

291 
dt
) {

292 
UCC_DT_INT8
:

293 
UCC_DT_INT16
:

294 
UCC_DT_INT32
:

295 
UCC_DT_INT64
:

296 
UCC_DT_INT128
:

297 
UCC_DT_UINT8
:

298 
UCC_DT_UINT16
:

299 
UCC_DT_UINT32
:

300 
UCC_DT_UINT64
:

301 
UCC_DT_UINT128
:

302  (
İ
 !ğ
UCC_OP_AVG
);

303 
UCC_DT_FLOAT16
:

304 
UCC_DT_FLOAT32
:

305 
UCC_DT_FLOAT64
:

306 
UCC_DT_BFLOAT16
:

307 
UCC_DT_FLOAT128
:

308  (
İ
 =ğ
UCC_OP_SUM
 || o°=ğ
UCC_OP_PROD
 || o°=ğ
UCC_OP_MAX
 ||

309 
İ
 =ğ
UCC_OP_MIN
 || o°=ğ
UCC_OP_AVG
);

310 
UCC_DT_FLOAT32_COMPLEX
:

311 
UCC_DT_FLOAT64_COMPLEX
:

312 
UCC_DT_FLOAT128_COMPLEX
:

313  (
İ
 =ğ
UCC_OP_SUM
 || o°=ğ
UCC_OP_PROD
 || o°=ğ
UCC_OP_AVG
);

317 
	}
}

319 
	$ucc_cŞl_š¶aû_suµÜ‹d
(
ucc_cŞl_ty³_t
 
c
)

321 
c
) {

322 
UCC_COLL_TYPE_BARRIER
:

323 
UCC_COLL_TYPE_BCAST
:

324 
UCC_COLL_TYPE_FANIN
:

325 
UCC_COLL_TYPE_FANOUT
:

327 
UCC_COLL_TYPE_ALLTOALL
:

328 
UCC_COLL_TYPE_ALLTOALLV
:

334 
	}
}

336 
boŞ
 
	$ucc_cŞl_Œigg”ed_suµÜ‹d
(
ucc_memÜy_ty³_t
 
mt
)

338 ià(
mt
 =ğ
UCC_MEMORY_TYPE_CUDA
) {

339  
Œue
;

342  
çl£
;

343 
	}
}

345 
	$ucc_cŞl_is_roÙed
(
ucc_cŞl_ty³_t
 
c
)

347 
c
) {

348 
UCC_COLL_TYPE_ALLREDUCE
:

349 
UCC_COLL_TYPE_ALLGATHER
:

350 
UCC_COLL_TYPE_ALLGATHERV
:

351 
UCC_COLL_TYPE_ALLTOALL
:

352 
UCC_COLL_TYPE_ALLTOALLV
:

353 
UCC_COLL_TYPE_BARRIER
:

354 
UCC_COLL_TYPE_REDUCE_SCATTER
:

355 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

360 
	}
}

362 
boŞ
 
	$ucc_cŞl_has_memty³
(
ucc_cŞl_ty³_t
 
c
)

364 
c
) {

365 
UCC_COLL_TYPE_BARRIER
:

366 
UCC_COLL_TYPE_FANIN
:

367 
UCC_COLL_TYPE_FANOUT
:

368  
çl£
;

370  
Œue
;

372 
	}
}

374 
boŞ
 
	$ucc_cŞl_has_msg¿nge
(
ucc_cŞl_ty³_t
 
c
)

376 
c
) {

377 
UCC_COLL_TYPE_BARRIER
:

378 
UCC_COLL_TYPE_FANIN
:

379 
UCC_COLL_TYPE_FANOUT
:

380  
çl£
;

382  
Œue
;

384 
	}
}

386 
boŞ
 
	$ucc_cŞl_has_d©©y³
(
ucc_cŞl_ty³_t
 
c
)

388 
c
) {

389 
UCC_COLL_TYPE_BARRIER
:

390 
UCC_COLL_TYPE_FANIN
:

391 
UCC_COLL_TYPE_FANOUT
:

392  
çl£
;

394  
Œue
;

396 
	}
}

398 
boŞ
 
	$ucc_cŞl_has_İ
(
ucc_cŞl_ty³_t
 
c
)

400 
c
) {

401 
UCC_COLL_TYPE_ALLREDUCE
:

402 
UCC_COLL_TYPE_REDUCE
:

403 
UCC_COLL_TYPE_REDUCE_SCATTER
:

404 
UCC_COLL_TYPE_REDUCE_SCATTERV
:

405  
Œue
;

407  
çl£
;

409 
	}
}

411 
boŞ
 
	$ucc_cŞl_has_b™s
(
ucc_cŞl_ty³_t
 
c
)

413 
c
) {

414 
UCC_COLL_TYPE_ALLTOALLV
:

415  
Œue
;

417  
çl£
;

419 
	}
}

421 
	gUccTe¡Mpi
::
£t_couÁ_vsizes
(
¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> &
_couÁs_vsize
)

423 
couÁs_vsize
 = 
_couÁs_vsize
;

426 
	gUccTe¡Mpi
::
£t_di¥l_vsizes
(
¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> &
_di¥ls_vsize
)

428 
di¥ls_vsize
 = 
_di¥ls_vsize
;

431 #ià
defšed
(
HAVE_CUDA
è|| defšed(
HAVE_HIP
)

432 
‹¡_£t_gpu_deviû_t
 
	g‹¡_gpu_£t_deviû
 = 
TEST_SET_DEV_NONE
;

435 #ià
defšed
(
HAVE_CUDA
è|| defšed(
HAVE_HIP
)

436 
	$£t_gpu_deviû
(
‹¡_£t_gpu_deviû_t
 
£t_deviû
)

438 
loÿl_¿nk
 = 
ucc_‹¡_mpi_d©a
.
loÿl_node_¿nk
;

439 
gpu_dev_couÁ
;

440 
deviû_id
;

442 ià(
£t_deviû
 =ğ
TEST_SET_DEV_NONE
) {

446 #ià
	`defšed
(
HAVE_CUDA
)

447 
	`CUDA_CHECK
(
	`cudaG‘DeviûCouÁ
(&
gpu_dev_couÁ
));

448 #–ià
	`defšed
(
HAVE_HIP
)

449 
	`HIP_CHECK
(
	`hG‘DeviûCouÁ
(&
gpu_dev_couÁ
));

451 
£t_deviû
) {

452 
TEST_SET_DEV_LRANK
:

453 if(
loÿl_¿nk
 >ğ
gpu_dev_couÁ
) {

454 
¡d
::
û¼
 << "*** UCC TEST FAIL: "

456 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

458 
deviû_id
 = 
loÿl_¿nk
;

460 
TEST_SET_DEV_LRANK_ROUND
:

461 
deviû_id
 = 
loÿl_¿nk
 % 
gpu_dev_couÁ
;

463 
TEST_SET_DEV_NONE
:

467 #ià
	`defšed
(
HAVE_CUDA
)

468 
	`CUDA_CHECK
(
	`cudaS‘Deviû
(
deviû_id
));

469 #–ià
	`defšed
(
HAVE_HIP
)

470 
	`HIP_CHECK
(
	`hS‘Deviû
(
deviû_id
));

473 
	}
}

477 
	g¡d
::
veùÜ
<
ucc_‹¡_mpi_»suÉ_t
> 
UccTe¡Mpi
::
exec_‹¡s
(

478 
¡d
::
veùÜ
<¡d::
sh¬ed_±r
<
Te¡Ca£
>> 
tcs
, 
boŞ
 
Œigg”ed
,

479 
boŞ
 
³rsi¡’t
)

481 
	gn_³rsi¡’t
 = 
³rsi¡’t
 ? 
UCC_TEST_N_PERSISTENT
 : 1;

482 
	gwÜld_¿nk
, 
	gnum_dÚe
, 
	gi
;

483 
ucc_¡©us_t
 
	g¡©us
;

485 
MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
wÜld_¿nk
);

486 
	g¡d
::
veùÜ
<
ucc_‹¡_mpi_»suÉ_t
> 
r¡
;

488 
	gi
 = 0; i < 
	gn_³rsi¡’t
; i++) {

489 autØ
	gtc
: 
tcs
) {

490 ià(
TEST_SKIP_NONE
 =ğ
tc
->
‹¡_sk
) {

491 ià(
v”bo£
 && 0 =ğ
wÜld_¿nk
) {

492 ià(
Œigg”ed
) {

493 
¡d
::
cout
 << "Trigg”ed "<<
tc
->
¡r
(è<< std::
’dl
;

495 
	g¡d
::
cout
 << 
tc
->
¡r
(è<< 
¡d
::
’dl
;

498 ià(
	gtc
->
	g¬gs
.
	gæags
 & 
	gUCC_COLL_ARGS_FLAG_MEM_MAPPED_BUFFERS
) {

499 
MPI_B¬r›r
(
MPI_COMM_WORLD
);

501 
	gtc
->
run
(
Œigg”ed
);

503 ià(
	gv”bo£
 && 0 =ğ
wÜld_¿nk
) {

504 
¡d
::
cout
 << "SKIPPED: " << 
sk_¡r
(
tc
->
‹¡_sk
) << ": "

505 << 
tc
->
¡r
(è<< " " << 
¡d
::
’dl
;

507 
	gr¡
.
push_back
(
¡d
::
make_tu¶e
(
tc
->
¬gs
.
cŞl_ty³
, 
UCC_ERR_LAST
));

508  
	gr¡
;

512 
	gnum_dÚe
 = 0;

513 autØ
	gtc
: 
tcs
) {

514 
tc
->
mpi_´og»ss
();

515 
	g¡©us
 = 
tc
->
‹¡
();

516 ià(
	g¡©us
 < 0) {

517 
	g¡d
::
û¼
 << "error during collest: "

518 << 
ucc_¡©us_¡ršg
(
¡©us
)

519 << " ("<<
¡©us
<<")" << 
¡d
::
’dl
;

520 
MPI_AbÜt
(
MPI_COMM_WORLD
, -1);

522 ià(
	g¡©us
 =ğ
UCC_OK
) {

523 
num_dÚe
++;

525 
	gtc
->
tc_´og»ss_ùx
();

527 } 
	gnum_dÚe
 !ğ
tcs
.
size
());

528 autØ
	gtc
: 
tcs
) {

529 
¡©us
 = 
tc
->
check
();

530 
	gtc
->
£t_šput
(
i
 + 1);

531 ià(
	gUCC_OK
 !ğ
¡©us
) {

532 
¡d
::
û¼
 << "FAILURE in: " << 
tc
->
¡r
(è<< std::
’dl
;

534 
	gr¡
.
push_back
(
¡d
::
make_tu¶e
(
tc
->
¬gs
.
cŞl_ty³
, 
¡©us
));

537  
	gr¡
;

540 
	gUccTe¡Mpi
::
run_®l_©_‹am
(
ucc_‹¡_‹am_t
 &
‹am
,

541 
¡d
::
veùÜ
<
ucc_‹¡_mpi_»suÉ_t
> &
r¡
)

543 
Te¡Ca£P¬ams
 
·¿ms
;

545 
	g·¿ms
.
	gmax_size
 = 
‹¡_max_size
;

546 
	g·¿ms
.
	gš¶aû
 = 
š¶aû
;

547 
	g·¿ms
.
	g³rsi¡’t
 = 
³rsi¡’t
;

549 autØ
	gi
 = 0; i < 
	g™”©iÚs
; i++) {

550 autØ&
	gc
 : 
cŞls
) {

551 
¡d
::
veùÜ
<> 
roÙs
 = {0};

552 
	g¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
‹¡_memty³s
 = {
UCC_MEMORY_TYPE_LAST
};

553 
	g¡d
::
veùÜ
<
size_t
> 
‹¡_msgsizes
 = {0};

554 
	g¡d
::
veùÜ
<
ucc_d©©y³_t
> 
‹¡_dty³s
 = {(ucc_datatype_t)-1};

555 
	g¡d
::
veùÜ
<
ucc_»duùiÚ_İ_t
> 
‹¡_İs
 = {(ucc_reduction_op_t)-1};

556 
	g¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> 
‹¡_couÁs_vsize
 = {
TEST_FLAG_VSIZE_64BIT
};

557 
	g¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> 
‹¡_di¥l_vsize
 = {
TEST_FLAG_VSIZE_64BIT
};

558 **
	gÚesided_bufs
;

560 ià(
	gš¶aû
 && !
ucc_cŞl_š¶aû_suµÜ‹d
(
c
)) {

564 ià(
ucc_cŞl_is_roÙed
(
c
)) {

565 
	groÙs
 = 
g’_roÙs
(
‹am
);

568 ià(
ucc_cŞl_has_memty³
(
c
)) {

569 
	g‹¡_memty³s
 = 
mty³s
;

572 ià(
ucc_cŞl_has_msg¿nge
(
c
)) {

573 
	g‹¡_msgsizes
 = 
msgsizes
;

576 ià(
ucc_cŞl_has_d©©y³
(
c
)) {

577 
	g‹¡_dty³s
 = 
dty³s
;

580 ià(
ucc_cŞl_has_İ
(
c
)) {

581 
	g‹¡_İs
 = 
İs
;

584 ià(
ucc_cŞl_has_b™s
(
c
)) {

585 
	g‹¡_couÁs_vsize
 = 
couÁs_vsize
;

586 
	g‹¡_di¥l_vsize
 = 
di¥ls_vsize
;

589 autØ
	gr
 : 
roÙs
) {

590 autØ
mt
: 
‹¡_memty³s
) {

591 ià(
Œigg”ed
 && !
ucc_cŞl_Œigg”ed_suµÜ‹d
(
mt
)) {

592 
r¡
.
push_back
(
¡d
::
make_tu¶e
(
c
, 
UCC_ERR_NOT_IMPLEMENTED
));

596 ià((
	gc
 =ğ
UCC_COLL_TYPE_ALLTOALL
 ||

597 
c
 =ğ
UCC_COLL_TYPE_ALLTOALLV
) &&

598 
‹am
.
ùx
 != ctx) {

600 ià(
mt
 !ğ
UCC_MEMORY_TYPE_HOST
) {

603 
	gÚesided_bufs
 = 
Úesided_bufãrs
;

606 
	gÚesided_bufs
 = 
nuÎ±r
;

609 autØ
	gm
: 
‹¡_msgsizes
) {

610 autØ
dt
: 
‹¡_dty³s
) {

611 autØ
İ
: 
‹¡_İs
) {

612 ià(
ucc_cŞl_¬gs_is_»duùiÚ
(
c
) &&

613 !
ucc_cŞl_»duû_suµÜ‹d
(
İ
, 
dt
)) {

617 ià(
	gmt
 !ğ
UCC_MEMORY_TYPE_HOST
 &&

618 (
dt
 =ğ
UCC_DT_FLOAT128
 ||

619 
dt
 =ğ
UCC_DT_FLOAT128_COMPLEX
)) {

622 autØ
	gcouÁ_b™s
: 
‹¡_couÁs_vsize
) {

623 autØ
di¥l_b™s
: 
‹¡_di¥l_vsize
) {

624 
·¿ms
.
roÙ
 = 
r
;

625 
	g·¿ms
.
	gmt
 = 
mt
;

626 
	g·¿ms
.
	gmsgsize
 = 
m
;

627 
	g·¿ms
.
	gdt
 = 
dt
;

628 
	g·¿ms
.
	gİ
 = 
İ
;

629 
	g·¿ms
.
	gcouÁ_b™s
 = 
couÁ_b™s
;

630 
	g·¿ms
.
	gdi¥l_b™s
 = 
di¥l_b™s
;

631 
	g·¿ms
.
	gbufãrs
 = 
Úesided_bufs
;

633 autØ
	gtcs
 = 
Te¡Ca£
::
š™
(
‹am
, 
c
, 
Á
, 
·¿ms
);

634 autØ
	g»s
 = 
exec_‹¡s
(
tcs
, 
Œigg”ed
, 
³rsi¡’t
);

635 
	gr¡
.
š£¹
(
r¡
.
’d
(), 
»s
.
begš
(),„es.end());

647 
	succ_‹¡_th»ad
 {

648 
±h»ad_t
 
	mth»ad
;

649 
	mid
;

650 
UccTe¡Mpi
 * 
	m‹¡
;

651 
	m¡d
::
veùÜ
<
ucc_‹¡_mpi_»suÉ_t
> 
r¡
;

652 } 
	tucc_‹¡_th»ad_t
;

654 *
	$th»ad_¡¬t
(*
¬g
)

656 
ucc_‹¡_th»ad_t
 *
t
 = (ucc_‹¡_th»ad_ˆ*)
¬g
;

658 #ià
	`defšed
(
HAVE_CUDA
è|| defšed(
HAVE_HIP
)

659 
	`£t_gpu_deviû
(
‹¡_gpu_£t_deviû
);

661 
t
->
‹¡
->
	`run_®l_©_‹am
Ñ->‹¡->
‹ams
[t->
id
],->
r¡
);

663 
	}
}

665 
	gUccTe¡Mpi
::
	$run_®l
(
boŞ
 
is_Úesided
)

667 ià(
UCC_THREAD_MULTIPLE
 =ğ
tm
) {

668 
n_th»ads
 = 
‹ams
.
	`size
();

669 
¡d
::
veùÜ
<
ucc_‹¡_th»ad_t
> 
	`th»ads
(
n_th»ads
);

670 * 
»t
;

671 
i
 = 0; i < 
n_th»ads
; i++) {

672 
th»ads
[
i
].
id
 = i;

673 
th»ads
[
i
].
‹¡
 = 
this
;

674 
	`±h»ad_ü—‹
(&
th»ads
[
i
].
th»ad
, 
NULL
, 
th»ad_¡¬t
,

675 (*)&
th»ads
[
i
]);

677 
i
 = 0; i < 
n_th»ads
; i++) {

678 
	`±h»ad_još
(
th»ads
[
i
].
th»ad
, &
»t
);

679 
»suÉs
.
	`š£¹
ÔesuÉs.
	`’d
(), 
th»ads
[
i
].
r¡
.
	`begš
(),

680 
th»ads
[
i
].
r¡
.
	`’d
());

683 ià(!
is_Úesided
) {

684 autØ&
t
 : 
‹ams
) {

685 
	`run_®l_©_‹am
(
t
, 
»suÉs
);

688 autØ&
t
 : 
Úesided_‹ams
) {

689 
	`run_®l_©_‹am
(
t
, 
»suÉs
);

693 
	}
}

695 
	g¡d
::
veùÜ
<> 
UccTe¡Mpi
::
	$g’_roÙs
(
ucc_‹¡_‹am_t
 &
‹am
)

697 
size
;

698 
¡d
::
veùÜ
<> 
_roÙs
;

699 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

700 
¡d
::
deçuÉ_¿ndom_’gše
 
’g
;

701 
’g
.
	`£ed
(123);

702 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`urd
(0, 
size
-1);

704 
roÙ_ty³
) {

705 
ROOT_SINGLE
:

706 
_roÙs
 = 
¡d
::
veùÜ
<>({
	`ucc_mš
(
roÙ_v®ue
, 
size
-1)});

708 
ROOT_RANDOM
:

709 
_roÙs
.
	`»size
(
roÙ_v®ue
);

710 
i
 = 0; i < 
_roÙs
.
	`size
(); i++) {

711 
_roÙs
[
i
] = 
	`urd
(
’g
);

714 
ROOT_ALL
:

715 
_roÙs
.
	`»size
(
size
);

716 
¡d
::
	`iÙa
(
_roÙs
.
	`begš
(), _roÙs.
	`’d
(), 0);

719 
	`as£¹
(0);

721  
_roÙs
;

722 
	}
}

	@test/mpi/test_mpi.h

7 #iâdeà
TEST_MPI_H


8 
	#TEST_MPI_H


	)

9 
	~<io¡»am
>

10 
	~<¡ršg
>

11 
	~<veùÜ
>

12 
	~<memÜy
>

13 
	~<uni¡d.h
>

14 
	~<mpi.h
>

15 
	~<ucc/­i/ucc.h
>

17 
	~"uts/ucc_m®loc.h
"

19 
BEGIN_C_DECLS


20 
	~"compÚ’ts/mc/ucc_mc.h
"

21 
	~"cÜe/ucc_‹am.h
"

22 
	~"uts/ucc_m©h.h
"

23 
END_C_DECLS


24 #ifdeà
HAVE_CUDA


25 
	~<cuda.h
>

26 
	~<cuda_ruÁime.h
>

28 #ifdeà
HAVE_HIP


29 
	~<h/h_ruÁime_­i.h
>

32 
	#STR
(
x
è#x

	)

33 
	#UCC_CHECK
(
_ÿÎ
) \

34 ià(
UCC_OK
 !ğ(
_ÿÎ
)) { \

35 
¡d
::
û¼
 << "*** UCC TEST FAIL: " << 
	`STR
(
_ÿÎ
) << "\n"; \

36 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1); \

37 }

	)

39 
	#UCC_MALLOC_CHECK
(
_obj
) \

40 ià(!(
_obj
)) { \

41 
¡d
::
û¼
 << "*** UCC MALLOC FAIL \n"; \

42 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1); \

43 }

	)

45 
	#UCC_CHECK_SKIP
(
_ÿÎ
, 
_sk_ÿu£
) \

47 
ucc_¡©us_t
 
¡©us
; \

48 
¡©us
 = (
_ÿÎ
); \

49 if(
UCC_ERR_NOT_SUPPORTED
 =ğ
¡©us
) { \

50 
_sk_ÿu£
 = 
TEST_SKIP_NOT_SUPPORTED
; \

51 } ià(
UCC_ERR_NOT_IMPLEMENTED
 =ğ
¡©us
) { \

52 
_sk_ÿu£
 = 
TEST_SKIP_NOT_IMPLEMENTED
; \

53 } ià(
UCC_OK
 !ğ
¡©us
) { \

54 
¡d
::
û¼
 << "*** UCC TEST FAIL: " << 
	`STR
(
_ÿÎ
) << "\n"; \

55 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1); \

57 }

	)

59 
	#TEST_UCC_RANK_BUF_SIZE_MAX
 (8*1024*1024)

	)

61 
‹¡_¿nd_£ed
;

63 
	#UCC_ALLOC_COPY_BUF
(
_Ãw_buf
, 
_Ãw_mty³
, 
_Şd_buf
, 
_Şd_mty³
, 
_size
) \

65 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&(
_Ãw_buf
), 
_size
, 
_Ãw_mty³
)); \

66 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
_Ãw_buf
->
addr
, 
_Şd_buf
, 
_size
, 
_Ãw_mty³
, \

67 
_Şd_mty³
)); \

68 }

	)

70 #ifdeà
HAVE_CUDA


71 
	#CUDA_CHECK
(
_ÿÎ
) { \

72 
cudaE¼Ü_t
 
cuda_”r
 = (
_ÿÎ
); \

73 ià(
cudaSucûss
 !ğ(
cuda_”r
)) { \

74 
¡d
::
û¼
 << "*** UCC TEST FAIL: " << 
	`STR
(
_ÿÎ
) << ": " \

75 << 
	`cudaG‘E¼ÜSŒšg
(
cuda_”r
) << "\n" ; \

76 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1); \

78 }

	)

81 #ifdeà
HAVE_HIP


82 
	#HIP_CHECK
(
_ÿÎ
) { \

83 
hE¼Ü_t
 
h_”r
 = (
_ÿÎ
); \

84 ià(
hSucûss
 !ğ(
h_”r
)) { \

85 
¡d
::
û¼
 << "*** UCC TEST FAIL: " << 
	`STR
(
_ÿÎ
) << ": " \

86 << 
	`hG‘E¼ÜSŒšg
(
h_”r
) << "\n" ; \

87 
	`MPI_AbÜt
(
MPI_COMM_WORLD
, -1); \

89 }

	)

92 
	#UCC_TEST_N_PERSISTENT
 4

	)

93 
	#UCC_TEST_N_MEM_SEGMENTS
 3

	)

94 
	#UCC_TEST_MEM_SEGMENT_SIZE
 (1 << 21)

	)

97 
	mMEM_SEND_SEGMENT
,

98 
	mMEM_RECV_SEGMENT
,

99 
	mMEM_WORK_SEGMENT


100 } 
	tucc_‹¡_mem_£gm’ts
;

103 
	mTEAM_WORLD
,

104 
	mTEAM_REVERSE
,

105 
	mTEAM_SPLIT_HALF
,

106 
	mTEAM_SPLIT_ODD_EVEN
,

107 
	mTEAM_LAST


108 } 
	tucc_‹¡_mpi_‹am_t
;

111 
	mROOT_SINGLE
,

112 
	mROOT_RANDOM
,

113 
	mROOT_ALL


114 } 
	tucc_‹¡_mpi_roÙ_t
;

117 
	mTEST_FLAG_VSIZE_32BIT
,

118 
	mTEST_FLAG_VSIZE_64BIT


119 } 
	tucc_‹¡_vsize_æag_t
;

122 
	mTEST_SKIP_NONE
,

123 
	mTEST_SKIP_NOT_SUPPORTED
,

124 
	mTEST_SKIP_NOT_IMPLEMENTED
,

125 
	mTEST_SKIP_MEM_LIMIT
,

126 
	mTEST_SKIP_LAST


127 } 
	t‹¡_sk_ÿu£_t
;

129 #ià
defšed
(
HAVE_CUDA
è|| defšed(
HAVE_HIP
)

131 
	mTEST_SET_DEV_NONE
,

132 
	mTEST_SET_DEV_LRANK
,

133 
	mTEST_SET_DEV_LRANK_ROUND


134 } 
	t‹¡_£t_gpu_deviû_t
;

137 
šlše
 cÚ¡ * 
	$sk_¡r
(
‹¡_sk_ÿu£_t
 
s
) {

138 
s
) {

139 
TEST_SKIP_MEM_LIMIT
:

141 
TEST_SKIP_NOT_SUPPORTED
:

143 
TEST_SKIP_NOT_IMPLEMENTED
:

148 
	}
}

150 
šlše
 cÚ¡ * 
	$‹am_¡r
(
ucc_‹¡_mpi_‹am_t
 
t
) {

151 
t
) {

152 
TEAM_WORLD
:

154 
TEAM_REVERSE
:

156 
TEAM_SPLIT_HALF
:

158 
TEAM_SPLIT_ODD_EVEN
:

163  
NULL
;

164 
	}
}

166 
	succ_‹¡_mpi_d©a
 {

167 
	mloÿl_node_¿nk
;

168 } 
	tucc_‹¡_mpi_d©a_t
;

169 
ucc_‹¡_mpi_d©a_t
 
ucc_‹¡_mpi_d©a
;

171 
š™_‹¡_mpi_d©a
();

173 #ià
defšed
(
HAVE_CUDA
è|| defšed(
HAVE_HIP
)

174 
£t_gpu_deviû
(
‹¡_£t_gpu_deviû_t
 
£t_deviû
);

176 
ucc_cŞl_š¶aû_suµÜ‹d
(
ucc_cŞl_ty³_t
 
c
);

177 
ucc_cŞl_is_roÙed
(
ucc_cŞl_ty³_t
 
c
);

178 
boŞ
 
ucc_cŞl_has_d©©y³
(
ucc_cŞl_ty³_t
 
c
);

180 
	succ_‹¡_‹am
 {

181 #ifdeà
HAVE_CUDA


182 
ucc_“_h
 
	mcuda_“
;

183 
cudaSŒ—m_t
 
	mcuda_¡»am
;

185 
ucc_‹¡_mpi_‹am_t
 
	mty³
;

186 
MPI_Comm
 
	mcomm
;

187 
ucc_‹am_h
 
	m‹am
;

188 
ucc_cÚ‹xt_h
 
	mùx
;

189 
ucc_‹¡_‹am
(
ucc_‹¡_mpi_‹am_t
 
_ty³
, 
MPI_Comm
 
_comm
,

190 
ucc_‹am_h
 
_‹am
, 
ucc_cÚ‹xt_h
 
_ùx
) :

191 
ty³
(
_ty³
), 
comm
(
_comm
), 
‹am
(
_‹am
), 
ùx
(
_ùx
)

193 #ifdeà
HAVE_CUDA


194 
	mcuda_¡»am
 = 
nuÎ±r
;

195 
	mcuda_“
 = 
nuÎ±r
;

199 #ifdeà
HAVE_CUDA


200 
ucc_¡©us_t
 
g‘_cuda_“
(
ucc_“_h
 *
“
)

202 
ucc_“_·¿ms_t
 
	m“_·¿ms
;

204 ià(!
	mcuda_“
) {

205 
CUDA_CHECK
(
cudaSŒ—mC»©eW™hFÏgs
(&
cuda_¡»am
,

206 
cudaSŒ—mNÚBlockšg
));

207 
	m“_·¿ms
.
	m“_ty³
 = 
UCC_EE_CUDA_STREAM
;

208 
	m“_·¿ms
.
	m“_cÚ‹xt_size
 = (
cudaSŒ—m_t
);

209 
	m“_·¿ms
.
	m“_cÚ‹xt
 = 
cuda_¡»am
;

210 
UCC_CHECK
(
ucc_“_ü—‹
(
‹am
, &
“_·¿ms
, &
cuda_“
));

213 *
	m“
 = 
cuda_“
;

214  
	mUCC_OK
;

217 
ä“_cuda_“
()

219 ià(
	mcuda_“
) {

220 
UCC_CHECK
(
ucc_“_de¡roy
(
cuda_“
));

221 
CUDA_CHECK
(
cudaSŒ—mDe¡roy
(
cuda_¡»am
));

226 
ucc_¡©us_t
 
g‘_“
(
ucc_“_ty³_t
 
“_ty³
, 
ucc_“_h
 *
“
)

228 
	m“_ty³
) {

229 #ifdeà
HAVE_CUDA


230 
	mUCC_EE_CUDA_STREAM
:

231  
g‘_cuda_“
(
“
);

234  
UCC_ERR_NOT_SUPPORTED
;

239 
ä“_“
()

241 #ifdeà
HAVE_CUDA


242 
ä“_cuda_“
();

246 } 
	tucc_‹¡_‹am_t
;

248 
	sTe¡Ca£P¬ams
 {

249 
size_t
 
	mmsgsize
;

250 
boŞ
 
	mš¶aû
;

251 
boŞ
 
	m³rsi¡’t
;

252 
ucc_d©©y³_t
 
	mdt
;

253 
ucc_»duùiÚ_İ_t
 
	mİ
;

254 
ucc_memÜy_ty³_t
 
	mmt
;

255 
size_t
 
	mmax_size
;

256 
	mroÙ
;

257 **
	mbufãrs
;

258 
ucc_‹¡_vsize_æag_t
 
	mcouÁ_b™s
;

259 
ucc_‹¡_vsize_æag_t
 
	mdi¥l_b™s
;

262 şas 
	cTe¡Ca£
 {

263 
	m´Ùeùed
:

264 
ucc_‹¡_‹am_t
 
‹am
;

265 
ucc_memÜy_ty³_t
 
	mmem_ty³
;

266 
	mroÙ
;

267 
size_t
 
	mmsgsize
;

268 
boŞ
 
	mš¶aû
;

269 
boŞ
 
	m³rsi¡’t
;

270 
ucc_cŞl_»q_h
 
	m»q
;

271 
ucc_mc_bufãr_h—d”_t
 *
	msbuf_mc_h—d”
, *
	mrbuf_mc_h—d”
;

272 *
	msbuf
;

273 *
	mrbuf
;

274 *
	mcheck_buf
;

275 
MPI_Reque¡
 
	m´og»ss_»que¡
;

276 
ušt8_t
 
	m´og»ss_buf
[1];

277 
size_t
 
	m‹¡_max_size
;

278 
ucc_d©©y³_t
 
	mdt
;

279 
	m™”_³rsi¡’t
;

280 
	mpublic
:

281 
ucc_cŞl_¬gs_t
 
¬gs
;

282 
mpi_´og»ss
();

283 
‹¡_sk_ÿu£_t
 
	m‹¡_sk
;

284 
	m¡d
::
sh¬ed_±r
<
Te¡Ca£
> 
š™_sšgË
(

285 
ucc_‹¡_‹am_t
 &
_‹am
,

286 
ucc_cŞl_ty³_t
 
_ty³
,

287 
Te¡Ca£P¬ams
 
·¿ms
);

288 
	m¡d
::
veùÜ
<
¡d
::
sh¬ed_±r
<
Te¡Ca£
>> 
š™
(

289 
ucc_‹¡_‹am_t
 &
_‹am
,

290 
ucc_cŞl_ty³_t
 
_ty³
,

291 
num_‹¡s
,

292 
Te¡Ca£P¬ams
 
·¿ms
);

293 
Te¡Ca£
(
ucc_‹¡_‹am_t
 &
_‹am
, 
ucc_cŞl_ty³_t
 
ù
, 
Te¡Ca£P¬ams
 
·¿ms
);

294 
	mvœtu®
 ~
Te¡Ca£
();

295 
vœtu®
 
run
(
boŞ
 
Œigg”ed
);

296 
vœtu®
 
ucc_¡©us_t
 
£t_šput
(
™”_³rsi¡’t
 = 0) = 0;

297 
vœtu®
 
ucc_¡©us_t
 
check
() = 0;

298 
vœtu®
 
	m¡d
::
¡ršg
 
¡r
();

299 
vœtu®
 
ucc_¡©us_t
 
‹¡
();

300 
wa™
();

301 
tc_´og»ss_ùx
();

302 
‹¡_sk_ÿu£_t
 
sk_»duû
Ñe¡_sk_ÿu£_ˆ
ÿu£
, 
MPI_Comm
 
comm
);

303 
‹¡_sk_ÿu£_t
 
sk_»duû
(
sk_cÚd
,e¡_sk_ÿu£_ˆ
ÿu£
,

304 
MPI_Comm
 
comm
);

307 
	g¡d
::
	ttu¶e
<
	tucc_cŞl_ty³_t
, 
	tucc_¡©us_t
> 
	tucc_‹¡_mpi_»suÉ_t
;

308 şas 
	cUccTe¡Mpi
 {

309 
ucc_th»ad_mode_t
 
	mtm
;

310 
ucc_cÚ‹xt_h
 
	mùx
;

311 
ucc_cÚ‹xt_h
 
	mÚesided_ùx
;

312 
ucc_lib_h
 
	mlib
;

313 
	mÁ
;

314 
ucc_lib_h
 
	mÚesided_lib
;

315 
boŞ
 
	mš¶aû
;

316 
boŞ
 
	m³rsi¡’t
;

317 
ucc_‹¡_mpi_roÙ_t
 
	mroÙ_ty³
;

318 
	mroÙ_v®ue
;

319 
	m™”©iÚs
;

320 
boŞ
 
	mv”bo£
;

321 * 
	mÚesided_bufãrs
[3];

322 
size_t
 
	m‹¡_max_size
;

323 
boŞ
 
	mŒigg”ed
;

324 
ü—‹_‹am
(
ucc_‹¡_mpi_‹am_t
 
t
, 
boŞ
 
is_Úesided
 = 
çl£
);

325 
de¡roy_‹am
(
ucc_‹¡_‹am_t
 &
‹am
);

326 
ucc_‹am_h
 
ü—‹_ucc_‹am
(
MPI_Comm
 
comm
, 
boŞ
 
is_Úesided
 = 
çl£
);

327 
	m¡d
::
veùÜ
<
size_t
> 
msgsizes
;

328 
	m¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> 
mty³s
;

329 
	m¡d
::
veùÜ
<
ucc_d©©y³_t
> 
dty³s
;

330 
	m¡d
::
veùÜ
<
ucc_»duùiÚ_İ_t
> 
İs
;

331 
	m¡d
::
veùÜ
<
ucc_cŞl_ty³_t
> 
cŞls
;

332 
	m¡d
::
veùÜ
<> 
g’_roÙs
(
ucc_‹¡_‹am_t
 &
‹am
);

333 
	m¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> 
couÁs_vsize
;

334 
	m¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> 
di¥ls_vsize
;

335 
	m¡d
::
veùÜ
<
ucc_‹¡_mpi_»suÉ_t
> 
exec_‹¡s
(

336 
¡d
::
veùÜ
<¡d::
sh¬ed_±r
<
Te¡Ca£
>> 
tcs
,

337 
boŞ
 
Œigg”ed
, boŞ 
³rsi¡’t
);

338 
	mpublic
:

339 
¡d
::
veùÜ
<
ucc_‹¡_‹am_t
> 
‹ams
;

340 
	m¡d
::
veùÜ
<
ucc_‹¡_‹am_t
> 
Úesided_‹ams
;

341 
run_®l_©_‹am
(
ucc_‹¡_‹am_t
 &
‹am
,

342 
¡d
::
veùÜ
<
ucc_‹¡_mpi_»suÉ_t
> &
r¡
);

343 
	m¡d
::
veùÜ
<
ucc_‹¡_mpi_»suÉ_t
> 
»suÉs
;

344 
UccTe¡Mpi
(
¬gc
, *
¬gv
[], 
ucc_th»ad_mode_t
 
tm
, 
is_loÿl
,

345 
boŞ
 
w™h_Úesided
);

346 ~
UccTe¡Mpi
();

347 
£t_msgsizes
(
size_t
 
mš
, size_ˆ
max
, size_ˆ
pow”
);

348 
£t_dty³s
(
¡d
::
veùÜ
<
ucc_d©©y³_t
> &
_dty³s
);

349 
£t_cŞls
(
¡d
::
veùÜ
<
ucc_cŞl_ty³_t
> &
_cŞls
);

350 
£t_™”
(
™”
);

351 
£t_v”bo£
(
boŞ
 
v”bo£
);

352 
£t_İs
(
¡d
::
veùÜ
<
ucc_»duùiÚ_İ_t
> &
_İs
);

353 
£t_mty³s
(
¡d
::
veùÜ
<
ucc_memÜy_ty³_t
> &
_mty³s
);

354 
	$£t_š¶aû
(
boŞ
 
_š¶aû
)

356 
š¶aû
 = 
_š¶aû
;

358 
	$£t_³rsi¡’t
(
boŞ
 
_³rsi¡’t
)

360 
³rsi¡’t
 = 
_³rsi¡’t
;

361 
	}
}

362 
	$£t_Œigg”ed
(
boŞ
 
_Œigg”ed
)

364 
Œigg”ed
 = 
_Œigg”ed
;

365 
	}
}

366 
£t_couÁ_vsizes
(
¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> &
_couÁs_vsize
);

367 
£t_di¥l_vsizes
(
¡d
::
veùÜ
<
ucc_‹¡_vsize_æag_t
> &
_di¥ls_vsize
);

368 
run_®l
(
boŞ
 
is_Úesided
 = 
çl£
);

369 
	$£t_roÙ
(
ucc_‹¡_mpi_roÙ_t
 
_roÙ_ty³
, 
_roÙ_v®ue
) {

370 
roÙ_ty³
 = 
_roÙ_ty³
;

371 
roÙ_v®ue
 = 
_roÙ_v®ue
;

372 
	}
};

373 
	$£t_max_size
(
size_t
 
_max_size
) {

374 
‹¡_max_size
 = 
_max_size
;

375 
	}
}

376 
	$£t_num_‹¡s
(
num_‹¡s
) {

377 
Á
 = 
num_‹¡s
;

378 
	}
}

379 
ü—‹_‹ams
(
¡d
::
veùÜ
<
ucc_‹¡_mpi_‹am_t
> &
‹¡_‹ams
,

380 
boŞ
 
is_Úesided
 = 
çl£
);

381 
	$´og»ss_ùx
() {

382 
	`ucc_cÚ‹xt_´og»ss
(
ùx
);

383 ià(
Úesided_ùx
) {

384 
	`ucc_cÚ‹xt_´og»ss
(
Úesided_ùx
);

386 
	}
}

389 şas 
	cTe¡AÎg©h”
 : 
public
 
Te¡Ca£
 {

390 
public
:

391 
Te¡AÎg©h”
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

392 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

393 
ucc_¡©us_t
 
	`check
();

396 şas 
	cTe¡AÎg©h”v
 : 
public
 
Te¡Ca£
 {

397 *
couÁs
;

398 *
di¥Ïûm’ts
;

399 
public
:

400 
	`Te¡AÎg©h”v
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

401 ~
	`Te¡AÎg©h”v
();

402 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

403 
ucc_¡©us_t
 
	$check
(è
ov”ride
;

406 şas 
	cTe¡AÎ»duû
 : 
public
 
Te¡Ca£
 {

407 
ucc_»duùiÚ_İ_t
 
İ
;

408 
public
:

409 
	`Te¡AÎ»duû
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

410 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

411 
ucc_¡©us_t
 
	`check
();

412 
¡d
::
¡ršg
 
	`¡r
();

415 şas 
	cTe¡AÎtßÎ
 : 
public
 
Te¡Ca£
 {

416 
boŞ
 
is_Úesided
;

417 
public
:

418 
	`Te¡AÎtßÎ
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

419 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

420 
ucc_¡©us_t
 
	`check
();

423 şas 
	cTe¡AÎtßÎv
 : 
public
 
Te¡Ca£
 {

424 
size_t
 
¢couÁs
;

425 
size_t
 
ºcouÁs
;

426 *
scouÁs
;

427 *
sdi¥ls
;

428 *
rcouÁs
;

429 *
rdi¥ls
;

430 
ucc_couÁ_t
 *
scouÁs64
;

431 
ucc_couÁ_t
 *
sdi¥ls64
;

432 
ucc_couÁ_t
 *
rcouÁs64
;

433 
ucc_couÁ_t
 *
rdi¥ls64
;

434 
ucc_‹¡_vsize_æag_t
 
couÁ_b™s
;

435 
ucc_‹¡_vsize_æag_t
 
di¥l_b™s
;

437 
‹m¶©e
<
ty³Çme
 
T
>

438 * 
	`mpi_couÁs_to_ucc
(*
mpi_couÁs
, 
size_t
 
_ncouÁ
);

439 
public
:

440 
	`Te¡AÎtßÎv
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

441 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

442 
ucc_¡©us_t
 
	`check
();

443 
¡d
::
¡ršg
 
	`¡r
();

444 ~
	`Te¡AÎtßÎv
();

447 şas 
	cTe¡B¬r›r
 : 
public
 
Te¡Ca£
 {

448 
ucc_¡©us_t
 
¡©us
;

449 
public
:

450 
	`Te¡B¬r›r
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

451 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

452 
ucc_¡©us_t
 
	`check
();

453 
¡d
::
¡ršg
 
	`¡r
();

454 
	`run
(
boŞ
 
Œigg”ed
);

455 
ucc_¡©us_t
 
	`‹¡
();

458 şas 
	cTe¡Bÿ¡
 : 
public
 
Te¡Ca£
 {

459 
public
:

460 
	`Te¡Bÿ¡
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

461 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

462 
ucc_¡©us_t
 
	`check
();

465 şas 
	cTe¡G©h”
 : 
public
 
Te¡Ca£
 {

466 
public
:

467 
	`Te¡G©h”
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

468 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

469 
ucc_¡©us_t
 
	`check
();

472 şas 
	cTe¡G©h”v
 : 
public
 
Te¡Ca£
 {

473 
ušt32_t
 *
couÁs
;

474 
ušt32_t
 *
di¥Ïûm’ts
;

475 
public
:

476 
	`Te¡G©h”v
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

477 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

478 
ucc_¡©us_t
 
	`check
();

479 ~
	`Te¡G©h”v
();

482 şas 
	cTe¡Reduû
 : 
public
 
Te¡Ca£
 {

483 
ucc_»duùiÚ_İ_t
 
İ
;

484 
public
:

485 
	`Te¡Reduû
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

486 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

487 
ucc_¡©us_t
 
	`check
();

488 
¡d
::
¡ršg
 
	`¡r
();

491 şas 
	cTe¡ReduûSÿ‰”
 : 
public
 
Te¡Ca£
 {

492 
ucc_»duùiÚ_İ_t
 
İ
;

493 
public
:

494 
	`Te¡ReduûSÿ‰”
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

495 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

496 ~
	`Te¡ReduûSÿ‰”
();

497 
ucc_¡©us_t
 
	`check
();

498 
¡d
::
¡ršg
 
	`¡r
();

501 şas 
	cTe¡ReduûSÿ‰”v
 : 
public
 
Te¡Ca£
 {

502 
ucc_»duùiÚ_İ_t
 
İ
;

503 * 
couÁs
;

504 
public
:

505 
	`Te¡ReduûSÿ‰”v
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

506 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

507 ~
	`Te¡ReduûSÿ‰”v
();

508 
ucc_¡©us_t
 
	`check
();

509 
¡d
::
¡ršg
 
	`¡r
();

512 şas 
	cTe¡Sÿ‰”
 : 
public
 
Te¡Ca£
 {

513 
public
:

514 
	`Te¡Sÿ‰”
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

515 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

516 
ucc_¡©us_t
 
	`check
();

519 şas 
	cTe¡Sÿ‰”v
 : 
public
 
Te¡Ca£
 {

520 
ušt32_t
 *
couÁs
;

521 
ušt32_t
 *
di¥Ïûm’ts
;

522 
public
:

523 
	`Te¡Sÿ‰”v
(
ucc_‹¡_‹am_t
 &
‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
);

524 
ucc_¡©us_t
 
	$£t_šput
(
™”_³rsi¡’t
 = 0è
ov”ride
;

525 
ucc_¡©us_t
 
	`check
();

526 ~
	`Te¡Sÿ‰”v
();

529 
	`š™_bufãr
(*
buf
, 
size_t
 
couÁ
, 
ucc_d©©y³_t
 
dt
,

530 
ucc_memÜy_ty³_t
 
mt
, 
v®ue
, 
off£t
 = 0);

532 
ucc_¡©us_t
 
	`com·»_bufãrs
(*
r¡
, *
ex³ùed
, 
size_t
 
couÁ
,

533 
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³_t
 
mt
);

535 
ucc_¡©us_t
 
	`divide_bufãr
(*
ex³ùed
, 
size_t
 
divid”
, size_ˆ
couÁ
,

536 
ucc_d©©y³_t
 
dt
);

	@test/mpi/test_reduce.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	gTe¡Reduû
::
	$Te¡Reduû
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

11 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_REDUCE
, 
·¿ms
)

13 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
·¿ms
.
dt
);

14 
size_t
 
couÁ
 = 
msgsize
/
dt_size
;

15 
¿nk
;

17 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

18 
dt
 = 
·¿ms
.dt;

19 
İ
 = 
·¿ms
.op;

20 
roÙ
 = 
·¿ms
.root;

22 ià(
	`sk_»duû
(
‹¡_max_size
 < 
msgsize
, 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

25 
check_buf
 = 
	`ucc_m®loc
(
msgsize
, "check buf");

26 
	`UCC_MALLOC_CHECK
(
check_buf
);

28 ià(
¿nk
 =ğ
roÙ
) {

29 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

30 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

31 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

32 
¬gs
.
d¡
.
šfo
.
couÁ
 = count;

33 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

34 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

36 ià((
¿nk
 !ğ
roÙ
è|| (!
š¶aû
)) {

37 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

38 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

41 
¬gs
.
İ
 = op;

42 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

43 
¬gs
.
¤c
.
šfo
.
couÁ
 = count;

44 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

45 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

46 
¬gs
.
roÙ
 =„oot;

47 
	`UCC_CHECK
(
	`£t_šput
());

48 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

49 
	}
}

51 
ucc_¡©us_t
 
	gTe¡Reduû
::
	$£t_šput
(
™”_³rsi¡’t
)

53 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

54 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

55 
¿nk
;

56 *
buf
;

58 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

59 ià(
š¶aû
 && 
¿nk
 =ğ
roÙ
) {

60 
buf
 = 
rbuf
;

62 
buf
 = 
sbuf
;

65 
	`š™_bufãr
(
buf
, 
couÁ
, 
dt
, 
mem_ty³
, 
¿nk
 * (
™”_³rsi¡’t
 + 1));

66 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
check_buf
, 
buf
, 
couÁ
 * 
dt_size
,

67 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

68  
UCC_OK
;

69 
	}
}

71 
ucc_¡©us_t
 
	gTe¡Reduû
::
	$check
()

73 
ucc_¡©us_t
 
¡©us
;

74 
size_t
 
couÁ
 = 
¬gs
.
¤c
.
šfo
.count;

75 
¿nk
, 
com¶‘ed
;

76 
MPI_Reque¡
 
»q
;

78 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

79 
	`MPI_I»duû
((
roÙ
 =ğ
¿nk
è? 
MPI_IN_PLACE
 : 
check_buf
, check_buf,

80 
couÁ
, 
	`ucc_dt_to_mpi
(
dt
),

81 
İ
 =ğ
UCC_OP_AVG
 ? 
MPI_SUM
 : 
	`ucc_İ_to_mpi
(İ), 
roÙ
, 
‹am
.
comm
,

82 &
»q
);

84 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

85 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

86 } !
com¶‘ed
);

88 ià(
¿nk
 =ğ
roÙ
 && 
İ
 =ğ
UCC_OP_AVG
) {

89 
¡©us
 = 
	`divide_bufãr
(
check_buf
, 
‹am
.‹am->
size
, 
couÁ
, 
dt
);

90 ià(
¡©us
 !ğ
UCC_OK
) {

91  
¡©us
;

94  (
¿nk
 !ğ
roÙ
è? 
UCC_OK
 :

95 
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
couÁ
, 
dt
, 
mem_ty³
);

96 
	}
}

98 
	g¡d
::
¡ršg
 
Te¡Reduû
::
	$¡r
() {

99  
¡d
::
	`¡ršg
("tc=")+
	`ucc_cŞl_ty³_¡r
(
¬gs
.
cŞl_ty³
) +

100 "—m=" + 
	`‹am_¡r
(
‹am
.
ty³
) +

101 " msgsize=" + 
¡d
::
	`to_¡ršg
(
msgsize
) +

102 " iÅÏû=" + (
š¶aû
 ? "1" : "0") +

103 "…”si¡’t=" + (
³rsi¡’t
 ? "1" : "0") +

104 " dt=" + 
	`ucc_d©©y³_¡r
(
dt
) +

105 " op=" + 
	`ucc_»duùiÚ_İ_¡r
(
İ
) +

106 "„oÙ=" + 
¡d
::
	`to_¡ršg
(
roÙ
);

107 
	}
}

	@test/mpi/test_reduce_scatter.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	gTe¡ReduûSÿ‰”
::
	$Te¡ReduûSÿ‰”
(
ucc_‹¡_‹am_t
 &
_‹am
,

11 
Te¡Ca£P¬ams
 &
·¿ms
) :

12 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_REDUCE_SCATTER
, 
·¿ms
)

14 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
·¿ms
.
dt
);

15 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

16 
¿nk
, 
comm_size
;

18 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

19 
	`MPI_Comm_size
(
‹am
.
comm
, &
comm_size
);

20 
İ
 = 
·¿ms
.op;

21 
dt
 = 
·¿ms
.dt;

23 ià(
	`sk_»duû
(
‹¡_max_size
 < 
msgsize
, 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
) ||

24 
	`sk_»duû
((
couÁ
 < 
comm_size
), 
TEST_SKIP_NOT_SUPPORTED
, 
‹am
.
comm
)) {

27 
check_buf
 = 
	`ucc_m®loc
(
msgsize
, "check buf");

28 
	`UCC_MALLOC_CHECK
(
check_buf
);

30 
couÁ
 = couÁ - (couÁ % 
comm_size
);

31 
msgsize
 = 
couÁ
 * 
dt_size
;

33 ià(
š¶aû
) {

34 
¬gs
.
d¡
.
šfo
.
couÁ
 = count;

35 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

36 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

38 
¬gs
.
d¡
.
šfo
.
couÁ
 = couÁ / 
comm_size
;

39 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
 / 
comm_size
, 
mem_ty³
));

40 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

41 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

42 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

43 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

44 
¬gs
.
¤c
.
šfo
.
couÁ
 = count;

45 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

46 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

49 
¬gs
.
İ
 = op;

50 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

51 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

52 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

53 
	`UCC_CHECK
(
	`£t_šput
());

54 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

55 
	}
}

57 
ucc_¡©us_t
 
	gTe¡ReduûSÿ‰”
::
	$£t_šput
(
™”_³rsi¡’t
)

59 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

60 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

61 *
buf
;

62 
¿nk
;

64 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

65 ià(
š¶aû
) {

66 
buf
 = 
rbuf
;

68 
buf
 = 
sbuf
;

70 
	`š™_bufãr
(
buf
, 
couÁ
, 
dt
, 
mem_ty³
, 
¿nk
 * (
™”_³rsi¡’t
 + 1));

71 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
check_buf
, 
buf
, 
couÁ
 * 
dt_size
,

72 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

73  
UCC_OK
;

74 
	}
}

76 
ucc_¡©us_t
 
	gTe¡ReduûSÿ‰”
::
	$check
()

78 
ucc_¡©us_t
 
¡©us
;

79 
comm_¿nk
, 
comm_size
, 
com¶‘ed
;

80 
size_t
 
block_size
, 
block_couÁ
;

81 
MPI_Reque¡
 
»q
;

83 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
comm_¿nk
);

84 
	`MPI_Comm_size
(
‹am
.
comm
, &
comm_size
);

85 
block_size
 = 
msgsize
 / 
comm_size
;

86 
block_couÁ
 = 
block_size
 / 
	`ucc_dt_size
(
dt
);

88 
	`MPI_I»duû_sÿ‰”_block
(
MPI_IN_PLACE
, 
check_buf
,

89 
block_couÁ
, 
	`ucc_dt_to_mpi
(
dt
),

90 
İ
 =ğ
UCC_OP_AVG
 ? 
MPI_SUM
 : 
	`ucc_İ_to_mpi
(op),

91 
‹am
.
comm
, &
»q
);

93 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

94 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

95 } !
com¶‘ed
);

97 ià(
İ
 =ğ
UCC_OP_AVG
) {

98 
¡©us
 = 
	`divide_bufãr
(
check_buf
, 
‹am
.‹am->
size
, 
block_couÁ
, 
dt
);

99 ià(
¡©us
 !ğ
UCC_OK
) {

100  
¡©us
;

103 ià(
š¶aû
) {

104  
	`com·»_bufãrs
(
	`PTR_OFFSET
(
rbuf
, 
comm_¿nk
 * 
block_size
),

105 
check_buf
, 
block_couÁ
, 
dt
, 
mem_ty³
);

107  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
block_couÁ
, 
dt
, 
mem_ty³
);

108 
	}
}

110 
	gTe¡ReduûSÿ‰”
::~
	$Te¡ReduûSÿ‰”
(è{
	}
}

112 
¡d
::
¡ršg
 
Te¡ReduûSÿ‰”
::
	$¡r
() {

113  
¡d
::
	`¡ršg
("tc=")+
	`ucc_cŞl_ty³_¡r
(
¬gs
.
cŞl_ty³
) +

114 "—m=" + 
	`‹am_¡r
(
‹am
.
ty³
) +

115 " msgsize=" + 
¡d
::
	`to_¡ršg
(
msgsize
) +

116 " iÅÏû=" + (
š¶aû
 ? "1" : "0") +

117 "…”si¡’t=" + (
³rsi¡’t
 ? "1" : "0") +

118 " dt=" + 
	`ucc_d©©y³_¡r
(
dt
) +

119 " op=" + 
	`ucc_»duùiÚ_İ_¡r
(
İ
);

120 
	}
}

	@test/mpi/test_reduce_scatterv.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	gTe¡ReduûSÿ‰”v
::
	$Te¡ReduûSÿ‰”v
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
)

11 : 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_REDUCE_SCATTERV
, 
·¿ms
)

13 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
·¿ms
.
dt
);

14 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

15 
¿nk
, 
comm_size
;

16 
couÁs
 = 
NULL
;

18 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

19 
	`MPI_Comm_size
(
‹am
.
comm
, &
comm_size
);

20 
İ
 = 
·¿ms
.op;

21 
dt
 = 
·¿ms
.dt;

23 ià(
	`sk_»duû
(
‹¡_max_size
 < 
msgsize
, 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

26 
couÁs
 = (*)
	`ucc_m®loc
(
comm_size
 * (
ušt32_t
), "counts buf");

27 
	`UCC_MALLOC_CHECK
(
couÁs
);

29 
size_t
 
Ëá
 = 
couÁ
;

30 
size_t
 
tÙ®
 = 0;

31 
i
 = 0; i < 
comm_size
; i++) {

32 
size_t
 
c
 = 2 + 
i
 * 2;

33 ià(
Ëá
 < 
c
) {

34 
c
 = 
Ëá
;

36 ià(
i
 =ğ
comm_size
 - 1) {

37 
couÁs
[
i
] = 
Ëá
;

39 
couÁs
[
i
] = 
c
;

42 ià(
Ëá
 > 0) {

43 
Ëá
 -ğ
c
;

45 
tÙ®
 +ğ
couÁs
[
i
];

47 
	`ucc_as£¹
(
tÙ®
 =ğ
couÁ
);

48 
check_buf
 = 
	`ucc_m®loc
(
msgsize
, "check buf");

49 
	`UCC_MALLOC_CHECK
(
check_buf
);

50 ià(
š¶aû
) {

51 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

52 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

54 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
couÁs
[
¿nk
] * 
dt_size
, 
mem_ty³
));

55 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

56 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

57 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

58 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

59 
¬gs
.
¤c
.
šfo
.
couÁ
 = count;

60 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

61 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

64 
¬gs
.
İ
 = op;

65 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = (
ucc_couÁ_t
 *)counts;

66 
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
rbuf
;

67 
¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
dt
;

68 
¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = mem_type;

69 
	`UCC_CHECK
(
	`£t_šput
());

70 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

71 
	}
}

73 
ucc_¡©us_t
 
	gTe¡ReduûSÿ‰”v
::
	$£t_šput
(
™”_³rsi¡’t
)

75 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

76 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

77 * 
buf
;

78 
¿nk
;

80 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

81 ià(
š¶aû
) {

82 
buf
 = 
rbuf
;

84 
buf
 = 
sbuf
;

86 
	`š™_bufãr
(
buf
, 
couÁ
, 
dt
, 
mem_ty³
, 
¿nk
 * (
™”_³rsi¡’t
 + 1));

87 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
check_buf
, 
buf
, 
couÁ
 * 
dt_size
,

88 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

89  
UCC_OK
;

90 
	}
}

92 
ucc_¡©us_t
 
	gTe¡ReduûSÿ‰”v
::
	$check
()

94 
ucc_¡©us_t
 
¡©us
;

95 
comm_¿nk
, 
comm_size
, 
com¶‘ed
;

96 
MPI_Reque¡
 
»q
;

97 
size_t
 
off£t
;

99 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
comm_¿nk
);

100 
	`MPI_Comm_size
(
‹am
.
comm
, &
comm_size
);

101 
	`MPI_I»duû_sÿ‰”
(
MPI_IN_PLACE
, 
check_buf
, 
couÁs
, 
	`ucc_dt_to_mpi
(
dt
),

102 
İ
 =ğ
UCC_OP_AVG
 ? 
MPI_SUM
 : 
	`ucc_İ_to_mpi
(op),

103 
‹am
.
comm
, &
»q
);

106 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

107 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

108 } !
com¶‘ed
);

110 ià(
İ
 =ğ
UCC_OP_AVG
) {

111 
¡©us
 =

112 
	`divide_bufãr
(
check_buf
, 
‹am
.‹am->
size
, 
couÁs
[
comm_¿nk
], 
dt
);

113 ià(
¡©us
 !ğ
UCC_OK
) {

114  
¡©us
;

117 ià(
š¶aû
) {

118 
off£t
 = 0;

119 
i
 = 0; i < 
comm_¿nk
; i++) {

120 
off£t
 +ğ
couÁs
[
i
];

122  
	`com·»_bufãrs
(
	`PTR_OFFSET
(
rbuf
, 
off£t
 * 
	`ucc_dt_size
(
dt
)),

123 
check_buf
, 
couÁs
[
comm_¿nk
], 
dt
, 
mem_ty³
);

125  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
couÁs
[
comm_¿nk
], 
dt
, 
mem_ty³
);

126 
	}
}

128 
	gTe¡ReduûSÿ‰”v
::~
	$Te¡ReduûSÿ‰”v
()

130 ià(
couÁs
) {

131 
	`ucc_ä“
(
couÁs
);

133 
	}
}

135 
	g¡d
::
¡ršg
 
Te¡ReduûSÿ‰”v
::
	$¡r
()

137  
¡d
::
	`¡ršg
("tc="è+ 
	`ucc_cŞl_ty³_¡r
(
¬gs
.
cŞl_ty³
) +

138 "—m=" + 
	`‹am_¡r
(
‹am
.
ty³
) +

139 " msgsize=" + 
¡d
::
	`to_¡ršg
(
msgsize
) +

140 " iÅÏû=" + (
š¶aû
 ? "1" : "0") +

141 "…”si¡’t=" + (
³rsi¡’t
 ? "1" : "0") +

142 " dt=" + 
	`ucc_d©©y³_¡r
(
dt
è+ " op=" + 
	`ucc_»duùiÚ_İ_¡r
(
İ
);

143 
	}
}

	@test/mpi/test_scatter.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	gTe¡Sÿ‰”
::
	$Te¡Sÿ‰”
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

11 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_SCATTER
, 
·¿ms
)

13 
¿nk
, 
size
;

14 
size_t
 
dt_size
, 
sšgË_¿nk_couÁ
;

16 
dt
 = 
·¿ms
.dt;

17 
dt_size
 = 
	`ucc_dt_size
(
dt
);

18 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
dt_size
;

19 
roÙ
 = 
·¿ms
.root;

21 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

22 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

24 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_max_size
 < (
msgsize
 * 
size
),

25 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

28 ià(
¿nk
 =ğ
roÙ
) {

29 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
msgsize
 * 
size
, 
mem_ty³
));

30 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

31 ià(
š¶aû
) {

32 
rbuf_mc_h—d”
 = 
NULL
;

33 
rbuf
 = 
NULL
;

35 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

36 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

39 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
msgsize
, 
mem_ty³
));

40 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

41 
sbuf_mc_h—d”
 = 
NULL
;

42 
sbuf
 = 
NULL
;

45 
check_buf
 = 
	`ucc_m®loc
(
msgsize
 * 
size
, "check buf");

46 
	`UCC_MALLOC_CHECK
(
check_buf
);

47 
¬gs
.
roÙ
 =„oot;

48 ià(
¿nk
 =ğ
roÙ
) {

49 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
sbuf
;

50 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
 * 
size
;

51 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

52 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = mem_type;

53 ià(!
š¶aû
) {

54 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

55 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
;

56 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

57 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

60 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

61 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
;

62 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

63 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

66 
	`UCC_CHECK
(
	`£t_šput
());

67 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

68 
	}
}

70 
ucc_¡©us_t
 
	gTe¡Sÿ‰”
::
	$£t_šput
(
™”_³rsi¡’t
)

72 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

73 
size_t
 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
dt_size
;

74 
size_t
 
sšgË_¿nk_size
 = 
sšgË_¿nk_couÁ
 * 
dt_size
;

75 
¿nk
, 
size
;

77 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

78 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

80 ià(
¿nk
 =ğ
roÙ
) {

81 
	`š™_bufãr
(
sbuf
, 
sšgË_¿nk_couÁ
 * 
size
, 
dt
, 
mem_ty³
,

82 
¿nk
 * (
™”_³rsi¡’t
 + 1));

83 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
check_buf
, 
sbuf
, 
sšgË_¿nk_size
 * 
size
,

84 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

86  
UCC_OK
;

87 
	}
}

89 
ucc_¡©us_t
 
	gTe¡Sÿ‰”
::
	$check
()

91 
size_t
 
sšgË_¿nk_couÁ
 = 
msgsize
 / 
	`ucc_dt_size
(
dt
);

92 
size_t
 
sšgË_¿nk_size
 = 
sšgË_¿nk_couÁ
 * 
	`ucc_dt_size
(
dt
);

93 
MPI_D©©y³
 
mpi_dt
 = 
	`ucc_dt_to_mpi
(
dt
);

94 
MPI_Reque¡
 
»q
;

95 
size
, 
¿nk
, 
com¶‘ed
;

96 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

97 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

99 
	`MPI_Isÿ‰”
(
check_buf
, 
sšgË_¿nk_couÁ
, 
mpi_dt
,

100 (
¿nk
 =ğ
roÙ
è? 
MPI_IN_PLACE
 : 
check_buf
, 
sšgË_¿nk_couÁ
,

101 
mpi_dt
, 
roÙ
, 
‹am
.
comm
, &
»q
);

103 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

104 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

105 } !
com¶‘ed
);

107 ià(
¿nk
 =ğ
roÙ
) {

108 ià(
š¶aû
) {

109  
	`com·»_bufãrs
(
sbuf
, 
check_buf
, 
sšgË_¿nk_couÁ
 * 
size
,

110 
dt
, 
mem_ty³
);

112  
	`com·»_bufãrs
(

113 
rbuf
, 
	`PTR_OFFSET
(
check_buf
, 
sšgË_¿nk_size
 * 
¿nk
),

114 
sšgË_¿nk_couÁ
, 
dt
, 
mem_ty³
);

117  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
sšgË_¿nk_couÁ
, 
dt
,

118 
mem_ty³
);

120 
	}
}

	@test/mpi/test_scatterv.cc

7 
	~"‹¡_mpi.h
"

8 
	~"mpi_ut.h
"

10 
	$fl_couÁs_ªd_di¥Ïûm’ts
(
size
, 
couÁ
,

11 
ušt32_t
 *
couÁs
, ušt32_ˆ*
di¥ls
)

13 
bŸs
 = 
couÁ
 / 2;

14 
i
;

16 
couÁs
[0] = 
couÁ
 - 
bŸs
;

17 
di¥ls
[0] = 0;

18 
i
 = 1; i < 
size
 - 1; i++) {

19 ià(
i
 % 2 == 0) {

20 
couÁs
[
i
] = 
couÁ
 - 
bŸs
;

22 
couÁs
[
i
] = 
couÁ
 + 
bŸs
;

24 
di¥ls
[
i
] = di¥ls[˜- 1] + 
couÁs
[i - 1];

26 ià(
size
 % 2 == 0) {

27 
couÁs
[
size
 - 1] = 
couÁ
 + 
bŸs
;

29 
couÁs
[
size
 - 1] = 
couÁ
;

31 
di¥ls
[
size
 - 1] = di¥ls[siz- 2] + 
couÁs
[size - 2];

32 
	}
}

34 
	gTe¡Sÿ‰”v
::
	$Te¡Sÿ‰”v
(
ucc_‹¡_‹am_t
 &
_‹am
, 
Te¡Ca£P¬ams
 &
·¿ms
) :

35 
	$Te¡Ca£
(
_‹am
, 
UCC_COLL_TYPE_SCATTERV
, 
·¿ms
)

37 
¿nk
, 
size
;

38 
size_t
 
dt_size
, 
couÁ
;

40 
dt
 = 
·¿ms
.dt;

41 
dt_size
 = 
	`ucc_dt_size
(
dt
);

42 
couÁ
 = 
msgsize
 / 
dt_size
;

43 
roÙ
 = 
·¿ms
.root;

44 
couÁs
 = 
NULL
;

45 
di¥Ïûm’ts
 = 
NULL
;

47 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

48 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

50 ià(
TEST_SKIP_NONE
 !ğ
	`sk_»duû
(
‹¡_max_size
 < (
msgsize
 * 
size
),

51 
TEST_SKIP_MEM_LIMIT
, 
‹am
.
comm
)) {

55 
couÁs
 = (
ušt32_t
 *è
	`ucc_m®loc
(
size
 * (uint32_t),

57 
	`UCC_MALLOC_CHECK
(
couÁs
);

58 
di¥Ïûm’ts
 = (
ušt32_t
 *è
	`ucc_m®loc
(
size
 * (uint32_t),

60 
	`UCC_MALLOC_CHECK
(
di¥Ïûm’ts
);

61 
	`fl_couÁs_ªd_di¥Ïûm’ts
(
size
, 
couÁ
, 
couÁs
, 
di¥Ïûm’ts
);

63 ià(
¿nk
 =ğ
roÙ
) {

64 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
sbuf_mc_h—d”
, 
couÁ
 * 
size
 * 
dt_size
, 
mem_ty³
));

65 
sbuf
 = 
sbuf_mc_h—d”
->
addr
;

66 ià(
š¶aû
) {

67 
rbuf_mc_h—d”
 = 
NULL
;

68 
rbuf
 = 
NULL
;

70 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
couÁs
[
¿nk
] * 
dt_size
,

71 
mem_ty³
));

72 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

75 
	`UCC_CHECK
(
	`ucc_mc_®loc
(&
rbuf_mc_h—d”
, 
couÁs
[
¿nk
] * 
dt_size
, 
mem_ty³
));

76 
rbuf
 = 
rbuf_mc_h—d”
->
addr
;

77 
sbuf_mc_h—d”
 = 
NULL
;

78 
sbuf
 = 
NULL
;

81 
check_buf
 = 
	`ucc_m®loc
(
couÁ
 * 
size
 * 
dt_size
, "check buf");

82 
	`UCC_MALLOC_CHECK
(
check_buf
);

83 
¬gs
.
roÙ
 =„oot;

84 ià(
¿nk
 =ğ
roÙ
) {

85 
¬gs
.
¤c
.
šfo_v
.
bufãr
 = 
sbuf
;

86 
¬gs
.
¤c
.
šfo_v
.
couÁs
 = (
ucc_couÁ_t
*)counts;

87 
¬gs
.
¤c
.
šfo_v
.
di¥Ïûm’ts
 = (
ucc_ašt_t
*)displacements;

88 
¬gs
.
¤c
.
šfo_v
.
d©©y³
 = 
dt
;

89 
¬gs
.
¤c
.
šfo_v
.
mem_ty³
 = mem_type;

90 ià(!
š¶aû
) {

91 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

92 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
couÁs
[
¿nk
];

93 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

94 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

97 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
rbuf
;

98 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
couÁs
[
¿nk
];

99 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

100 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = mem_type;

103 
	`UCC_CHECK
(
	`£t_šput
());

104 
	`UCC_CHECK_SKIP
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
.‹am), 
‹¡_sk
);

105 
	}
}

107 
ucc_¡©us_t
 
	gTe¡Sÿ‰”v
::
	$£t_šput
(
™”_³rsi¡’t
)

109 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

110 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

111 
¿nk
, 
size
;

113 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

114 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

116 ià(
¿nk
 =ğ
roÙ
) {

117 
	`š™_bufãr
(
sbuf
, 
couÁ
 * 
size
, 
dt
, 
mem_ty³
,

118 
¿nk
 * (
™”_³rsi¡’t
 + 1));

119 
	`UCC_CHECK
(
	`ucc_mc_memıy
(
check_buf
, 
sbuf
, 
couÁ
 * 
size
 * 
dt_size
,

120 
UCC_MEMORY_TYPE_HOST
, 
mem_ty³
));

122  
UCC_OK
;

123 
	}
}

125 
	gTe¡Sÿ‰”v
::~
	$Te¡Sÿ‰”v
()

127 ià(
couÁs
) {

128 
	`ucc_ä“
(
couÁs
);

130 ià(
di¥Ïûm’ts
) {

131 
	`ucc_ä“
(
di¥Ïûm’ts
);

133 
	}
}

135 
ucc_¡©us_t
 
	gTe¡Sÿ‰”v
::
	$check
()

137 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
dt
);

138 
size_t
 
couÁ
 = 
msgsize
 / 
dt_size
;

139 
MPI_D©©y³
 
mpi_dt
 = 
	`ucc_dt_to_mpi
(
dt
);

140 
MPI_Reque¡
 
»q
;

141 
size
, 
¿nk
, 
com¶‘ed
;

143 
	`MPI_Comm_size
(
‹am
.
comm
, &
size
);

144 
	`MPI_Comm_¿nk
(
‹am
.
comm
, &
¿nk
);

146 
	`MPI_Isÿ‰”v
(
check_buf
, (*)
couÁs
, (*)
di¥Ïûm’ts
, 
mpi_dt
,

147 (
¿nk
 =ğ
roÙ
è? 
MPI_IN_PLACE
 : 
check_buf
, 
couÁs
[rank],

148 
mpi_dt
, 
roÙ
, 
‹am
.
comm
, &
»q
);

150 
	`MPI_Te¡
(&
»q
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

151 
	`ucc_cÚ‹xt_´og»ss
(
‹am
.
ùx
);

152 } !
com¶‘ed
);

154 ià(
¿nk
 =ğ
roÙ
) {

155 ià(
š¶aû
) {

156  
	`com·»_bufãrs
(
sbuf
, 
check_buf
, 
couÁ
 * 
size
, 
dt
, 
mem_ty³
);

158  
	`com·»_bufãrs
(

159 
rbuf
, 
	`PTR_OFFSET
(
check_buf
, 
di¥Ïûm’ts
[
¿nk
] * 
dt_size
),

160 
couÁs
[
¿nk
], 
dt
, 
mem_ty³
);

163  
	`com·»_bufãrs
(
rbuf
, 
check_buf
, 
couÁs
[
¿nk
], 
dt
, 
mem_ty³
);

165 
	}
}

	@tools/info/build_info.c

7 
	~"cÚfig.h
"

8 
	~"ucc_šfo.h
"

9 
	~"uts/ucc_comp”_def.h
"

11 
	$´št_v”siÚ
()

13 
	`´štf
("# UCC v”siÚ=% »visiÚ %s\n", 
UCC_VERSION_STRING
,

14 
UCC_GIT_REVISION
);

15 
	`´štf
("# CÚfigu»d w™h: %s\n", 
UCC_CONFIGURE_FLAGS
);

16 
	}
}

18 
	$´št_bud_cÚfig
()

21 cÚ¡ *
Çme
;

22 cÚ¡ *
v®ue
;

23 } 
	tcÚfig_v¬_t
;

24 
cÚfig_v¬_t
 
cÚfig_v¬s
[] = {

25 
	~<bud_cÚfig.h
>

26 {
NULL
, NULL}

28 
cÚfig_v¬_t
 *
v¬
;

30 
v¬
 = 
cÚfig_v¬s
; v¬->
Çme
 !ğ
NULL
; ++var) {

31 
	`´štf
("#defš%-25 %s\n", 
v¬
->
Çme
, v¬->
v®ue
);

33 
	}
}

	@tools/info/ucc_info.c

7 
	~"cÚfig.h
"

9 
	~"ucc_šfo.h
"

10 
	~"cÜe/ucc_glob®_İts.h
"

11 
	~"uts/ucc_·r£r.h
"

12 
	~"uts/ucc_log.h
"

13 
	~"uts/ucc_d©a¡ruù.h
"

14 
	~"compÚ’ts//ucc_.h
"

15 
	~"compÚ’ts/ş/ucc_ş.h
"

16 
	~<g‘İt.h
>

17 
	~<¡dlib.h
>

19 
	$u§ge
()

21 
	`´štf
("Usage: ucc_info [options]\n");

22 
	`´štf
("At†east one ofhe following options haso be set:\n");

23 
	`´štf
(" -v Show version information\n");

24 
	`´štf
(" -b Show build configuration\n");

25 
	`´štf
(" -c Show UCC configuration\n");

26 
	`´štf
(" -a Show‡lso hidden configuration\n");

27 
	`´štf
(" -f Show fully decorated output\n");

28 
	`´štf
(" -s Show default components scores\n");

29 
	`´štf
(" -A Show collective‡lgorithms‡vailable for selection\n");

30 
	`´štf
(" -h Showhis help message\n");

32 
	`´štf
("\n");

33 
	}
}

34 
ucc_li¡_lšk_t
 
ucc_cÚfig_glob®_li¡
;

36 
	$´št_®gÜ™hm_šfo
(
ucc_ba£_cŞl_®g_šfo_t
 *
šfo
)

38 
šfo
->
Çme
) {

39 
	`´štf
(" %u : %16 : %s\n", 
šfo
->
id
, info->
Çme
, info->
desc
);

40 
šfo
++;

42 
	}
}

44 
	$´št_compÚ’t_®gs
(
ucc_ba£_cŞl_®g_šfo_t
 **
®g_šfo
,

45 cÚ¡ *
compÚ’t
,

46 cÚ¡ *
compÚ’t_Çme
)

48 
have_®gs
 = 0;

49 
i
;

51 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

52 ià(
®g_šfo
[
i
]) {

53 
have_®gs
 = 1;

57 ià(
have_®gs
) {

58 
	`´štf
("%s/% ®gÜ™hms:\n", 
compÚ’t
, 
compÚ’t_Çme
);

59 
i
 = 0; i < 
UCC_COLL_TYPE_NUM
; i++) {

60 ià(
®g_šfo
[
i
]) {

61 
	`´štf
(" %s\n",

62 
	`ucc_cŞl_ty³_¡r
((
ucc_cŞl_ty³_t
)
	`UCC_BIT
(
i
)));

63 
	`´št_®gÜ™hm_šfo
(
®g_šfo
[
i
]);

66 
	`´štf
("\n");

68 
	}
}

70 
	$maš
(
¬gc
, **
¬gv
)

72 
ucc_glob®_cÚfig_t
 *
cfg
 = &
ucc_glob®_cÚfig
;

73 
ucc_cÚfig_´št_æags_t
 
´št_æags
;

74 
´št_İts
;

75 
c
, 
show_scÜes
, 
show_®gs
;

76 
ucc_lib_h
 
lib
;

77 
ucc_lib_cÚfig_h
 
cÚfig
;

78 
ucc_lib_·¿ms_t
 
·¿ms
;

79 
ucc_¡©us_t
 
¡©us
;

80 
ucc__içû_t
 * 

;

81 
ucc_ş_içû_t
 * 
ş
;

83 
´št_æags
 = (
ucc_cÚfig_´št_æags_t
)0;

84 
´št_İts
 = 0;

85 
show_scÜes
 = 0;

86 
show_®gs
 = 0;

87 (
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "vbcafhsA")) != -1) {

88 
c
) {

90 
´št_æags
 |ğ(
ucc_cÚfig_´št_æags_t
)(
UCC_CONFIG_PRINT_CONFIG
 |

91 
UCC_CONFIG_PRINT_HEADER
 |

92 
UCC_CONFIG_PRINT_DOC
);

95 
´št_æags
 |ğ(
ucc_cÚfig_´št_æags_t
)
UCC_CONFIG_PRINT_CONFIG
;

98 
´št_æags
 |ğ(
ucc_cÚfig_´št_æags_t
)
UCC_CONFIG_PRINT_HIDDEN
;

101 
´št_İts
 |ğ
PRINT_VERSION
;

104 
´št_İts
 |ğ
PRINT_BUILD_CONFIG
;

107 
show_scÜes
 = 1;

110 
show_®gs
 = 1;

113 
	`u§ge
();

116 
	`u§ge
();

121 ià((
´št_İts
 =ğ0è&& (
´št_æags
 =ğ0è&& (!
show_scÜes
) &&

122 (!
show_®gs
)) {

123 
	`u§ge
();

129 
·¿ms
.
mask
 = 
UCC_LIB_PARAM_FIELD_THREAD_MODE
;

130 
·¿ms
.
th»ad_mode
 = 
UCC_THREAD_SINGLE
;

131 ià(
UCC_OK
 !ğ
	`ucc_lib_cÚfig_»ad
(
NULL
, NULL, &
cÚfig
)) {

135 
¡©us
 = 
	`ucc_š™
(&
·¿ms
, 
cÚfig
, &
lib
);

136 
	`ucc_lib_cÚfig_»Ëa£
(
cÚfig
);

137 ià(
UCC_OK
 !ğ
¡©us
) {

141 ià(
´št_İts
 & 
PRINT_VERSION
) {

142 
	`´št_v”siÚ
();

145 ià(
´št_İts
 & 
PRINT_BUILD_CONFIG
) {

146 
	`´št_bud_cÚfig
();

149 ià(
´št_æags
 & 
UCC_CONFIG_PRINT_CONFIG
) {

150 
	`ucc_cÚfig_·r£r_´št_®l_İts
(
¡dout
, "UCC_", 
´št_æags
,

151 &
ucc_cÚfig_glob®_li¡
);

153 ià(
show_scÜes
) {

154 ià(
cfg
->
ş_äamewÜk
.
n_compÚ’ts
) {

155 
	`´štf
("Default CLs scores:");

156 
c
 = 0; c < 
cfg
->
ş_äamewÜk
.
n_compÚ’ts
; c++) {

157 
	`´štf
(" %s=%d", 
cfg
->
ş_äamewÜk
.
compÚ’ts
[
c
]->
Çme
,

158 
cfg
->
ş_äamewÜk
.
compÚ’ts
[
c
]->
scÜe
);

160 
	`´štf
("\n");

162 ià(
cfg
->
_äamewÜk
.
n_compÚ’ts
) {

163 
	`´štf
("Default TLs scores:");

164 
c
 = 0; c < 
cfg
->
_äamewÜk
.
n_compÚ’ts
; c++) {

165 
	`´štf
(" %s=%d", 
cfg
->
_äamewÜk
.
compÚ’ts
[
c
]->
Çme
,

166 
cfg
->
_äamewÜk
.
compÚ’ts
[
c
]->
scÜe
);

168 
	`´štf
("\n");

171 ià(
show_®gs
) {

172 
c
 = 0; c < 
cfg
->
ş_äamewÜk
.
n_compÚ’ts
; c++) {

173 
ş
 =

174 
	`ucc_d”ived_of
(
cfg
->
ş_äamewÜk
.
compÚ’ts
[
c
], 
ucc_ş_içû_t
);

175 
	`´št_compÚ’t_®gs
(
ş
->
®g_šfo
, "ş", cl->
su³r
.
Çme
);

178 
c
 = 0; c < 
cfg
->
_äamewÜk
.
n_compÚ’ts
; c++) {

179 

 =

180 
	`ucc_d”ived_of
(
cfg
->
_äamewÜk
.
compÚ’ts
[
c
], 
ucc__içû_t
);

181 
	`´št_compÚ’t_®gs
(

->
®g_šfo
, "",l->
su³r
.
Çme
);

184 
	`ucc_fš®ize
(
lib
);

186 
	}
}

	@tools/info/ucc_info.h

7 #iâdeà
UCC_INFO_H


8 
	#UCC_INFO_H


	)

10 
	~"ucc/­i/ucc.h
"

13 
	mPRINT_VERSION
 = 
UCC_BIT
(0),

14 
	mPRINT_BUILD_CONFIG
 = 
UCC_BIT
(1),

17 
´št_v”siÚ
();

19 
´št_bud_cÚfig
();

	@tools/perf/generator/ucc_pt_generator.h

7 #iâdeà
UCC_PT_GENERATOR_H


8 
	#UCC_PT_GENERATOR_H


	)

10 
	~<c¡ddef
>

11 
	~<veùÜ
>

12 
	~<c¡dšt
>

13 
	~<¡ršg
>

14 
	~"ucc_±_cÚfig.h
"

16 şas 
	cucc_±_g’”©Ü_ba£


18 
	mpublic
:

19 
vœtu®
 
boŞ
 
has_Ãxt
() = 0;

20 
vœtu®
 
Ãxt
() = 0;

21 
vœtu®
 
size_t
 
g‘_¤c_couÁ
() = 0;

22 
vœtu®
 
size_t
 
g‘_d¡_couÁ
() = 0;

23 
vœtu®
 
size_t
 
g‘_couÁ_max
() = 0;

24 
vœtu®
 
ucc_couÁ_t
 *
g‘_¤c_couÁs
() = 0;

25 
vœtu®
 
ucc_ašt_t
 *
g‘_¤c_di¥ls
() = 0;

26 
vœtu®
 
ucc_couÁ_t
 *
g‘_d¡_couÁs
() = 0;

27 
vœtu®
 
ucc_ašt_t
 *
g‘_d¡_di¥ls
() = 0;

28 
vœtu®
 
size_t
 
g‘_¤c_couÁ_max
() = 0;

29 
vœtu®
 
size_t
 
g‘_d¡_couÁ_max
() = 0;

30 
vœtu®
 
»£t
() = 0;

31 
	mvœtu®
 ~
	$ucc_±_g’”©Ü_ba£
() {}

32 
	}
};

34 şas 
	cucc_±_g’”©Ü_expÚ’tŸl
 : 
public
 
ucc_±_g’”©Ü_ba£


36 
´iv©e
:

37 
ušt32_t
 
comm_size
;

38 
size_t
 
	mmš_couÁ
;

39 
size_t
 
	mmax_couÁ
;

40 
size_t
 
	mmuÉ_çùÜ
;

41 
size_t
 
	mcu¼’t_couÁ
;

42 
	m¡d
::
veùÜ
<
ušt32_t
> 
¤c_couÁs
;

43 
	m¡d
::
veùÜ
<
ušt32_t
> 
¤c_di¥ls
;

44 
	m¡d
::
veùÜ
<
ušt32_t
> 
d¡_couÁs
;

45 
	m¡d
::
veùÜ
<
ušt32_t
> 
d¡_di¥ls
;

46 
ucc_±_İ_ty³_t
 
	mİ_ty³
;

47 
	mpublic
:

48 
ucc_±_g’”©Ü_expÚ’tŸl
(
size_t
 
mš
, size_ˆ
max
, size_ˆ
çùÜ
,

49 
ušt32_t
 
gsize
, 
ucc_±_İ_ty³_t
 
ty³
);

50 
boŞ
 
	$has_Ãxt
(è
ov”ride
;

51 
	$Ãxt
(è
ov”ride
;

52 
	$»£t
(è
ov”ride
;

53 
size_t
 
	$g‘_¤c_couÁ
(è
ov”ride
;

54 
size_t
 
	$g‘_d¡_couÁ
(è
ov”ride
;

55 
ucc_couÁ_t
 *
	$g‘_¤c_couÁs
(è
ov”ride
;

56 
ucc_ašt_t
 *
	$g‘_¤c_di¥ls
(è
ov”ride
;

57 
ucc_couÁ_t
 *
	$g‘_d¡_couÁs
(è
ov”ride
;

58 
ucc_ašt_t
 *
	$g‘_d¡_di¥ls
(è
ov”ride
;

59 
size_t
 
	$g‘_¤c_couÁ_max
(è
ov”ride
;

60 
size_t
 
	$g‘_d¡_couÁ_max
(è
ov”ride
;

61 
size_t
 
	$g‘_couÁ_max
(è
ov”ride
;

64 şas 
	cucc_±_g’”©Ü_fe
 : 
public
 
ucc_±_g’”©Ü_ba£


66 
´iv©e
:

67 
ušt32_t
 
comm_size
;

68 
ušt32_t
 
¿nk_id
;

69 
¡d
::
¡ršg
 
šput_fe
;

70 
size_t
 
Ä•
;

71 
size_t
 
cu¼’t_·‰”n
;

72 
size_t
 
cu¼’t_»p
;

73 
¡d
::
veùÜ
<¡d::veùÜ<
ušt32_t
>> 
·‰”n_couÁs
;

74 
¡d
::
veùÜ
<
ušt32_t
> 
¤c_couÁs
;

75 
¡d
::
veùÜ
<
ušt32_t
> 
¤c_di¥ls
;

76 
¡d
::
veùÜ
<
ušt32_t
> 
d¡_couÁs
;

77 
¡d
::
veùÜ
<
ušt32_t
> 
d¡_di¥ls
;

78 
ucc_±_İ_ty³_t
 
İ_ty³
;

79 * 
couÁs_¡©e_±r
 = 
nuÎ±r
;

80 
	`£tup_couÁs_di¥ls
();

81 
public
:

82 
	`ucc_±_g’”©Ü_fe
(cÚ¡ 
¡d
::
¡ršg
 &
fe_·th
, 
ušt32_t
 
gsize
,

83 
ušt32_t
 
¿nk
, 
ucc_±_İ_ty³_t
 
ty³
, 
size_t
 
Ä•
);

84 
boŞ
 
	$has_Ãxt
(è
ov”ride
;

85 
	$Ãxt
(è
ov”ride
;

86 
	$»£t
(è
ov”ride
;

87 
size_t
 
	$g‘_¤c_couÁ
(è
ov”ride
;

88 
size_t
 
	$g‘_d¡_couÁ
(è
ov”ride
;

89 
ucc_couÁ_t
 *
	$g‘_¤c_couÁs
(è
ov”ride
;

90 
ucc_ašt_t
 *
	$g‘_¤c_di¥ls
(è
ov”ride
;

91 
ucc_couÁ_t
 *
	$g‘_d¡_couÁs
(è
ov”ride
;

92 
ucc_ašt_t
 *
	$g‘_d¡_di¥ls
(è
ov”ride
;

93 
size_t
 
	$g‘_¤c_couÁ_max
(è
ov”ride
;

94 
size_t
 
	$g‘_d¡_couÁ_max
(è
ov”ride
;

95 
size_t
 
	$g‘_couÁ_max
(è
ov”ride
;

	@tools/perf/generator/ucc_pt_generator_exp.cc

1 
	~"ucc_±_g’”©Ü.h
"

3 
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$ucc_±_g’”©Ü_expÚ’tŸl
(
size_t
 
mš
, size_ˆ
max
,

4 
size_t
 
çùÜ
,

5 
ušt32_t
 
gsize
,

6 
ucc_±_İ_ty³_t
 
ty³
)

8 
mš_couÁ
 = 
mš
;

9 
max_couÁ
 = 
max
;

10 
muÉ_çùÜ
 = 
çùÜ
;

11 
cu¼’t_couÁ
 = 
mš
;

12 
comm_size
 = 
gsize
;

13 
İ_ty³
 = 
ty³
;

14 
	}
}

16 
boŞ
 
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$has_Ãxt
()

18  
cu¼’t_couÁ
 <ğ
max_couÁ
;

19 
	}
}

21 
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$Ãxt
()

23 ià(!
	`has_Ãxt
()) {

26 
cu¼’t_couÁ
 *ğ
muÉ_çùÜ
;

27 
	}
}

29 
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$»£t
()

31 
cu¼’t_couÁ
 = 
mš_couÁ
;

32 
	}
}

34 
size_t
 
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$g‘_¤c_couÁ
()

36 
İ_ty³
) {

37 
UCC_PT_OP_TYPE_ALLGATHER
:

38 
UCC_PT_OP_TYPE_ALLGATHERV
:

39 
UCC_PT_OP_TYPE_ALLREDUCE
:

40 
UCC_PT_OP_TYPE_BCAST
:

41 
UCC_PT_OP_TYPE_GATHER
:

42 
UCC_PT_OP_TYPE_GATHERV
:

43 
UCC_PT_OP_TYPE_REDUCE
:

44 
UCC_PT_OP_TYPE_MEMCPY
:

45 
UCC_PT_OP_TYPE_REDUCEDT
:

46 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

47  
cu¼’t_couÁ
;

48 
UCC_PT_OP_TYPE_ALLTOALL
:

49 
UCC_PT_OP_TYPE_ALLTOALLV
:

50 
UCC_PT_OP_TYPE_REDUCE_SCATTER
:

51 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
:

52 
UCC_PT_OP_TYPE_SCATTER
:

53 
UCC_PT_OP_TYPE_SCATTERV
:

54  
cu¼’t_couÁ
 * 
comm_size
;

55 
UCC_PT_OP_TYPE_BARRIER
:

56 
UCC_PT_OP_TYPE_FANIN
:

57 
UCC_PT_OP_TYPE_FANOUT
:

60 
throw
 
¡d
::
	`ruÁime_”rÜ
("Operationype‚ot supported");

62 
	}
}

64 
size_t
 
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$g‘_d¡_couÁ
()

66 
İ_ty³
) {

67 
UCC_PT_OP_TYPE_ALLGATHER
:

68 
UCC_PT_OP_TYPE_ALLGATHERV
:

69 
UCC_PT_OP_TYPE_GATHER
:

70 
UCC_PT_OP_TYPE_GATHERV
:

71 
UCC_PT_OP_TYPE_ALLTOALL
:

72 
UCC_PT_OP_TYPE_ALLTOALLV
:

73  
cu¼’t_couÁ
 * 
comm_size
;

74 
UCC_PT_OP_TYPE_ALLREDUCE
:

75 
UCC_PT_OP_TYPE_REDUCE
:

76 
UCC_PT_OP_TYPE_MEMCPY
:

77 
UCC_PT_OP_TYPE_REDUCEDT
:

78 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

79 
UCC_PT_OP_TYPE_REDUCE_SCATTER
:

80 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
:

81 
UCC_PT_OP_TYPE_SCATTER
:

82 
UCC_PT_OP_TYPE_SCATTERV
:

83  
cu¼’t_couÁ
;

84 
UCC_PT_OP_TYPE_BARRIER
:

85 
UCC_PT_OP_TYPE_BCAST
:

86 
UCC_PT_OP_TYPE_FANIN
:

87 
UCC_PT_OP_TYPE_FANOUT
:

90 
throw
 
¡d
::
	`ruÁime_”rÜ
("Operationype‚ot supported");

92 
	}
}

94 
size_t
 *
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$g‘_¤c_couÁs
()

96 
İ_ty³
) {

97 
UCC_PT_OP_TYPE_ALLTOALLV
:

98 
UCC_PT_OP_TYPE_SCATTERV
:

99 
¤c_couÁs
 = 
¡d
::
veùÜ
<
ušt32_t
>(
comm_size
, 
cu¼’t_couÁ
);

100  (
ucc_couÁ_t
 *)
¤c_couÁs
.
	`d©a
();

101 
UCC_PT_OP_TYPE_ALLGATHER
:

102 
UCC_PT_OP_TYPE_ALLGATHERV
:

103 
UCC_PT_OP_TYPE_ALLREDUCE
:

104 
UCC_PT_OP_TYPE_ALLTOALL
:

105 
UCC_PT_OP_TYPE_BARRIER
:

106 
UCC_PT_OP_TYPE_BCAST
:

107 
UCC_PT_OP_TYPE_FANIN
:

108 
UCC_PT_OP_TYPE_FANOUT
:

109 
UCC_PT_OP_TYPE_GATHER
:

110 
UCC_PT_OP_TYPE_GATHERV
:

111 
UCC_PT_OP_TYPE_REDUCE
:

112 
UCC_PT_OP_TYPE_REDUCE_SCATTER
:

113 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
:

114 
UCC_PT_OP_TYPE_SCATTER
:

115 
UCC_PT_OP_TYPE_MEMCPY
:

116 
UCC_PT_OP_TYPE_REDUCEDT
:

117 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

119 
throw
 
¡d
::
	`ruÁime_”rÜ
("Operationype‚ot supported");

121 
	}
}

123 
size_t
 *
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$g‘_¤c_di¥ls
()

125 
İ_ty³
) {

126 
UCC_PT_OP_TYPE_ALLTOALLV
:

127 
UCC_PT_OP_TYPE_SCATTERV
:

128 
¤c_di¥ls
 = 
¡d
::
veùÜ
<
ušt32_t
>(
comm_size
, 0);

129 
size_t
 
i
 = 0; i < 
comm_size
; i++) {

130 
¤c_di¥ls
[
i
] = 
cu¼’t_couÁ
 * i;

132  (
ucc_ašt_t
 *)
¤c_di¥ls
.
	`d©a
();

133 
UCC_PT_OP_TYPE_ALLGATHER
:

134 
UCC_PT_OP_TYPE_ALLGATHERV
:

135 
UCC_PT_OP_TYPE_ALLREDUCE
:

136 
UCC_PT_OP_TYPE_ALLTOALL
:

137 
UCC_PT_OP_TYPE_BARRIER
:

138 
UCC_PT_OP_TYPE_BCAST
:

139 
UCC_PT_OP_TYPE_FANIN
:

140 
UCC_PT_OP_TYPE_FANOUT
:

141 
UCC_PT_OP_TYPE_GATHER
:

142 
UCC_PT_OP_TYPE_GATHERV
:

143 
UCC_PT_OP_TYPE_REDUCE
:

144 
UCC_PT_OP_TYPE_REDUCE_SCATTER
:

145 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
:

146 
UCC_PT_OP_TYPE_SCATTER
:

147 
UCC_PT_OP_TYPE_MEMCPY
:

148 
UCC_PT_OP_TYPE_REDUCEDT
:

149 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

151 
throw
 
¡d
::
	`ruÁime_”rÜ
("Operationype‚ot supported");

153 
	}
}

155 
size_t
 *
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$g‘_d¡_couÁs
()

157 
İ_ty³
) {

158 
UCC_PT_OP_TYPE_ALLGATHERV
:

159 
UCC_PT_OP_TYPE_ALLTOALLV
:

160 
UCC_PT_OP_TYPE_GATHERV
:

161 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
:

162 
d¡_couÁs
 = 
¡d
::
veùÜ
<
ušt32_t
>(
comm_size
, 
cu¼’t_couÁ
);

163  (
ucc_couÁ_t
 *)
d¡_couÁs
.
	`d©a
();

164 
UCC_PT_OP_TYPE_ALLGATHER
:

165 
UCC_PT_OP_TYPE_ALLTOALL
:

166 
UCC_PT_OP_TYPE_ALLREDUCE
:

167 
UCC_PT_OP_TYPE_BARRIER
:

168 
UCC_PT_OP_TYPE_BCAST
:

169 
UCC_PT_OP_TYPE_FANIN
:

170 
UCC_PT_OP_TYPE_FANOUT
:

171 
UCC_PT_OP_TYPE_GATHER
:

172 
UCC_PT_OP_TYPE_REDUCE
:

173 
UCC_PT_OP_TYPE_REDUCE_SCATTER
:

174 
UCC_PT_OP_TYPE_SCATTER
:

175 
UCC_PT_OP_TYPE_MEMCPY
:

176 
UCC_PT_OP_TYPE_REDUCEDT
:

177 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

178 
UCC_PT_OP_TYPE_SCATTERV
:

180 
throw
 
¡d
::
	`ruÁime_”rÜ
("Operationype‚ot supported");

182 
	}
}

184 
size_t
 *
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$g‘_d¡_di¥ls
()

186 
İ_ty³
) {

187 
UCC_PT_OP_TYPE_ALLGATHERV
:

188 
UCC_PT_OP_TYPE_ALLTOALLV
:

189 
UCC_PT_OP_TYPE_GATHERV
:

190 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
:

191 
d¡_di¥ls
 = 
¡d
::
veùÜ
<
ušt32_t
>(
comm_size
, 0);

192 
size_t
 
i
 = 0; i < 
comm_size
; i++) {

193 
d¡_di¥ls
[
i
] = 
cu¼’t_couÁ
 * i;

195  (
ucc_ašt_t
 *)
d¡_di¥ls
.
	`d©a
();

196 
UCC_PT_OP_TYPE_ALLGATHER
:

197 
UCC_PT_OP_TYPE_ALLTOALL
:

198 
UCC_PT_OP_TYPE_ALLREDUCE
:

199 
UCC_PT_OP_TYPE_BARRIER
:

200 
UCC_PT_OP_TYPE_BCAST
:

201 
UCC_PT_OP_TYPE_FANIN
:

202 
UCC_PT_OP_TYPE_FANOUT
:

203 
UCC_PT_OP_TYPE_GATHER
:

204 
UCC_PT_OP_TYPE_REDUCE
:

205 
UCC_PT_OP_TYPE_REDUCE_SCATTER
:

206 
UCC_PT_OP_TYPE_SCATTER
:

207 
UCC_PT_OP_TYPE_MEMCPY
:

208 
UCC_PT_OP_TYPE_REDUCEDT
:

209 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

210 
UCC_PT_OP_TYPE_SCATTERV
:

212 
throw
 
¡d
::
	`ruÁime_”rÜ
("Operationype‚ot supported");

214 
	}
}

216 
size_t
 
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$g‘_¤c_couÁ_max
()

218 
İ_ty³
) {

219 
UCC_PT_OP_TYPE_ALLGATHER
:

220 
UCC_PT_OP_TYPE_ALLGATHERV
:

221 
UCC_PT_OP_TYPE_ALLREDUCE
:

222 
UCC_PT_OP_TYPE_BCAST
:

223 
UCC_PT_OP_TYPE_GATHER
:

224 
UCC_PT_OP_TYPE_GATHERV
:

225 
UCC_PT_OP_TYPE_REDUCE
:

226 
UCC_PT_OP_TYPE_MEMCPY
:

227 
UCC_PT_OP_TYPE_REDUCEDT
:

228 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

229  
max_couÁ
;

230 
UCC_PT_OP_TYPE_ALLTOALL
:

231 
UCC_PT_OP_TYPE_ALLTOALLV
:

232 
UCC_PT_OP_TYPE_REDUCE_SCATTER
:

233 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
:

234 
UCC_PT_OP_TYPE_SCATTER
:

235 
UCC_PT_OP_TYPE_SCATTERV
:

236  
max_couÁ
 * 
comm_size
;

237 
UCC_PT_OP_TYPE_BARRIER
:

238 
UCC_PT_OP_TYPE_FANIN
:

239 
UCC_PT_OP_TYPE_FANOUT
:

242 
throw
 
¡d
::
	`ruÁime_”rÜ
("Operationype‚ot supported");

244 
	}
}

246 
size_t
 
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$g‘_d¡_couÁ_max
()

248 
İ_ty³
) {

249 
UCC_PT_OP_TYPE_ALLGATHER
:

250 
UCC_PT_OP_TYPE_ALLGATHERV
:

251 
UCC_PT_OP_TYPE_GATHER
:

252 
UCC_PT_OP_TYPE_GATHERV
:

253 
UCC_PT_OP_TYPE_ALLTOALL
:

254 
UCC_PT_OP_TYPE_ALLTOALLV
:

255  
max_couÁ
 * 
comm_size
;

256 
UCC_PT_OP_TYPE_ALLREDUCE
:

257 
UCC_PT_OP_TYPE_REDUCE
:

258 
UCC_PT_OP_TYPE_MEMCPY
:

259 
UCC_PT_OP_TYPE_REDUCEDT
:

260 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

261 
UCC_PT_OP_TYPE_REDUCE_SCATTER
:

262 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
:

263 
UCC_PT_OP_TYPE_SCATTER
:

264 
UCC_PT_OP_TYPE_SCATTERV
:

265  
max_couÁ
;

266 
UCC_PT_OP_TYPE_BARRIER
:

267 
UCC_PT_OP_TYPE_BCAST
:

268 
UCC_PT_OP_TYPE_FANIN
:

269 
UCC_PT_OP_TYPE_FANOUT
:

272 
throw
 
¡d
::
	`ruÁime_”rÜ
("Operationype‚ot supported");

274 
	}
}

276 
size_t
 
	gucc_±_g’”©Ü_expÚ’tŸl
::
	$g‘_couÁ_max
()

278  
¡d
::
	`max
(
	`g‘_¤c_couÁ
(), 
	`g‘_d¡_couÁ
());

279 
	}
}

	@tools/perf/generator/ucc_pt_generator_file.cc

1 
	~"ucc_±_g’”©Ü.h
"

2 
	~"uts/ši.h
"

3 
	~<¡ršg
>

4 
	~<veùÜ
>

5 
	~<c¡ršg
>

6 
	~<s¡»am
>

8 
	gucc_±_g’”©Ü_fe
::
	$ucc_±_g’”©Ü_fe
(cÚ¡ 
¡d
::
¡ršg
 &
fe_·th
,

9 
ušt32_t
 
gsize
,

10 
ušt32_t
 
¿nk
,

11 
ucc_±_İ_ty³_t
 
ty³
,

12 
size_t
 
Ä•—ts
)

14 
šput_fe
 = 
fe_·th
;

15 
comm_size
 = 
gsize
;

16 
¿nk_id
 = 
¿nk
;

17 
İ_ty³
 = 
ty³
;

18 
cu¼’t_·‰”n
 = 0;

19 
cu¼’t_»p
 = 0;

20 
Ä•
 = 
Ä•—ts
;

23 
FILE
* 
fe
 = 
	`fİ’
(
fe_·th
.
	`c_¡r
(), "r");

24 ià(!
fe
) {

25 
throw
 
¡d
::
	`ruÁime_”rÜ
("FaedØİ’…©‹º fe: " + 
fe_·th
);

28 
	scouÁs_¡©e_t
 {

29 
¡d
::
¡ršg
 
couÁs_accum
;

30 
boŞ
 
š_couÁs
 = 
çl£
;

31 } 
couÁs_¡©e
;

33 
ši_hªdËr
 
hªdËr
 = [](* 
u£r
, cÚ¡ * 
£ùiÚ
,

34 cÚ¡ * 
Çme
, cÚ¡ * 
v®ue
) -> {

35 auto* 
£lf
 = 
¡©ic_ÿ¡
<
ucc_±_g’”©Ü_fe
*>(
u£r
);

36 auto* 
¡©e
 = 
¡©ic_ÿ¡
<
couÁs_¡©e_t
*>(
£lf
->
couÁs_¡©e_±r
);

37 ià(
	`¡rcmp
(
£ùiÚ
, "cŞËùive"è=ğ0 && sŒcmp(
Çme
, "type") == 0) {

38 ià(
¡©e
->
š_couÁs
 && !¡©e->
couÁs_accum
.
	`em±y
()) {

39 
¡d
::
¡ršg¡»am
 
	`ss
(
¡©e
->
couÁs_accum
);

40 
¡d
::
¡ršg
 
™em
;

41 
¡d
::
veùÜ
<
ušt32_t
> 
·‰”n
;

42 
¡d
::
	`g‘lše
(
ss
, 
™em
, ',')) {

43 
™em
.
	`”a£
(0, i‹m.
	`fšd_fœ¡_nÙ_of
(" \t\n\r"));

44 
™em
.
	`”a£
(™em.
	`fšd_Ï¡_nÙ_of
(" \t\n\r") + 1);

45 ià(!
™em
.
	`em±y
()) {

46 
·‰”n
.
	`push_back
(
¡d
::
	`¡ouÎ
(
™em
));

49 
£lf
->
·‰”n_couÁs
.
	`push_back
(
·‰”n
);

50 
¡©e
->
couÁs_accum
.
	`ş—r
();

51 
¡©e
->
š_couÁs
 = 
çl£
;

53 ià(
	`¡rcmp
(
v®ue
, "ALLTOALLV") != 0) {

54 
throw
 
¡d
::
	`ruÁime_”rÜ
("UnsuµÜ‹d cŞËùivty³: " + std::
	`¡ršg
(
v®ue
) +

57 } ià(
	`¡rcmp
(
£ùiÚ
, "cŞËùive"è=ğ0 && sŒcmp(
Çme
, "counts") == 0) {

58 
¡d
::
¡ršg
 
lše
 = 
v®ue
;

59 
lše
.
	`”a£
(0,†še.
	`fšd_fœ¡_nÙ_of
(" \t\n\r"));

60 
lše
.
	`”a£
Öše.
	`fšd_Ï¡_nÙ_of
(" \t\n\r") + 1);

61 
size_t
 
İ’
 = 
lše
.
	`fšd
('{');

62 ià(
İ’
 !ğ
¡d
::
¡ršg
::
Åos
) {

63 
¡©e
->
š_couÁs
 = 
Œue
;

64 
¡©e
->
couÁs_accum
.
	`ş—r
();

65 
lše
 =†še.
	`sub¡r
(
İ’
 + 1);

66 
lše
.
	`”a£
(0,†še.
	`fšd_fœ¡_nÙ_of
(" \t\n\r"));

67 
lše
.
	`”a£
Öše.
	`fšd_Ï¡_nÙ_of
(" \t\n\r") + 1);

69 
size_t
 
şo£
 = 
lše
.
	`fšd
('}');

70 ià(
şo£
 !ğ
¡d
::
¡ršg
::
Åos
) {

71 
¡d
::
¡ršg
 
befÜe_b¿û
 = 
lše
.
	`sub¡r
(0, 
şo£
);

72 
befÜe_b¿û
.
	`”a£
(0, befÜe_b¿û.
	`fšd_fœ¡_nÙ_of
(" \t\n\r"));

73 
befÜe_b¿û
.
	`”a£
(befÜe_b¿û.
	`fšd_Ï¡_nÙ_of
(" \t\n\r") + 1);

74 ià(!
befÜe_b¿û
.
	`em±y
()) {

75 ià(!
¡©e
->
couÁs_accum
.
	`em±y
())

76 
¡©e
->
couÁs_accum
 += ",";

77 
¡©e
->
couÁs_accum
 +ğ
befÜe_b¿û
;

79 ià(
¡©e
->
š_couÁs
 && !¡©e->
couÁs_accum
.
	`em±y
()) {

80 
¡d
::
¡ršg¡»am
 
	`ss
(
¡©e
->
couÁs_accum
);

81 
¡d
::
¡ršg
 
™em
;

82 
¡d
::
veùÜ
<
ušt32_t
> 
·‰”n
;

83 
¡d
::
	`g‘lše
(
ss
, 
™em
, ',')) {

84 
™em
.
	`”a£
(0, i‹m.
	`fšd_fœ¡_nÙ_of
(" \t\n\r"));

85 
™em
.
	`”a£
(™em.
	`fšd_Ï¡_nÙ_of
(" \t\n\r") + 1);

86 ià(!
™em
.
	`em±y
()) {

87 
·‰”n
.
	`push_back
(
¡d
::
	`¡ouÎ
(
™em
));

90 
£lf
->
·‰”n_couÁs
.
	`push_back
(
·‰”n
);

91 
¡©e
->
couÁs_accum
.
	`ş—r
();

93 
¡©e
->
š_couÁs
 = 
çl£
;

96 ià(!
lše
.
	`em±y
()) {

97 ià(!
¡©e
->
couÁs_accum
.
	`em±y
())

98 
¡©e
->
couÁs_accum
 += ",";

99 
¡©e
->
couÁs_accum
 +ğ
lše
;

105 
this
->
couÁs_¡©e_±r
 = &
couÁs_¡©e
;

106 ià(
	`ucc_ši_·r£_fe
(
fe
, 
hªdËr
, 
this
) < 0) {

107 
	`fşo£
(
fe
);

108 
throw
 
¡d
::
	`ruÁime_”rÜ
("FaedØ·r£…©‹º fe: " + 
fe_·th
);

111 
this
->
couÁs_¡©e_±r
 = 
nuÎ±r
;

112 
	`fşo£
(
fe
);

115 ià(!
couÁs_¡©e
.
couÁs_accum
.
	`em±y
()) {

116 
¡d
::
¡ršg¡»am
 
	`ss
(
couÁs_¡©e
.
couÁs_accum
);

117 
¡d
::
¡ršg
 
™em
;

118 
¡d
::
veùÜ
<
ušt32_t
> 
·‰”n
;

119 
¡d
::
	`g‘lše
(
ss
, 
™em
, ',')) {

120 
™em
.
	`”a£
(0, i‹m.
	`fšd_fœ¡_nÙ_of
(" \t\n\r"));

121 
™em
.
	`”a£
(™em.
	`fšd_Ï¡_nÙ_of
(" \t\n\r") + 1);

122 ià(!
™em
.
	`em±y
()) {

123 
·‰”n
.
	`push_back
(
¡d
::
	`¡ouÎ
(
™em
));

126 
·‰”n_couÁs
.
	`push_back
(
·‰”n
);

129 ià(
·‰”n_couÁs
.
	`em±y
()) {

130 
throw
 
¡d
::
	`ruÁime_”rÜ
("NØcŞËùiv·‰”n found iÀfe: " + 
fe_·th
);

133 
size_t
 
i
 = 0; i < 
·‰”n_couÁs
.
	`size
(); i++) {

134 ià(
·‰”n_couÁs
[
i
].
	`size
(è!ğ
comm_size
 * comm_size) {

135 
throw
 
¡d
::
	`ruÁime_”rÜ
("P©‹º siz(" + std::
	`to_¡ršg
(
·‰”n_couÁs
[
i
].
	`size
()) +

137 
¡d
::
	`to_¡ršg
(
comm_size
 * comm_size) + "). "

143 
¤c_couÁs
.
	`»size
(
comm_size
);

144 
¤c_di¥ls
.
	`»size
(
comm_size
);

145 
d¡_couÁs
.
	`»size
(
comm_size
);

146 
d¡_di¥ls
.
	`»size
(
comm_size
);

147 
	}
}

149 
boŞ
 
	gucc_±_g’”©Ü_fe
::
	$has_Ãxt
()

151  
cu¼’t_»p
 < 
Ä•
;

152 
	}
}

154 
	gucc_±_g’”©Ü_fe
::
	$Ãxt
()

156 
cu¼’t_·‰”n
++;

157 ià(
cu¼’t_·‰”n
 >ğ
·‰”n_couÁs
.
	`size
()) {

158 
cu¼’t_·‰”n
 = 0;

159 
cu¼’t_»p
++;

161 ià(
	`has_Ãxt
()) {

162 
	`£tup_couÁs_di¥ls
();

164 
	}
}

166 
	gucc_±_g’”©Ü_fe
::
	$»£t
()

168 
cu¼’t_·‰”n
 = 0;

169 
cu¼’t_»p
 = 0;

170 
	`£tup_couÁs_di¥ls
();

171 
	}
}

173 
size_t
 
	gucc_±_g’”©Ü_fe
::
	$g‘_¤c_couÁ
()

175 
size_t
 
tÙ®
 = 0;

176 
i
 = 0; i < 
comm_size
; i++) {

177 
tÙ®
 +ğ
¤c_couÁs
[
i
];

179  
tÙ®
;

180 
	}
}

182 
size_t
 
	gucc_±_g’”©Ü_fe
::
	$g‘_d¡_couÁ
()

184 
size_t
 
tÙ®
 = 0;

185 
i
 = 0; i < 
comm_size
; i++) {

186 
tÙ®
 +ğ
d¡_couÁs
[
i
];

188  
tÙ®
;

189 
	}
}

191 
ucc_couÁ_t
 *
	gucc_±_g’”©Ü_fe
::
	$g‘_¤c_couÁs
()

193  (
ucc_couÁ_t
 *)
¤c_couÁs
.
	`d©a
();

194 
	}
}

196 
ucc_ašt_t
 *
	gucc_±_g’”©Ü_fe
::
	$g‘_¤c_di¥ls
()

198  (
ucc_ašt_t
 *)
¤c_di¥ls
.
	`d©a
();

199 
	}
}

201 
ucc_couÁ_t
 *
	gucc_±_g’”©Ü_fe
::
	$g‘_d¡_couÁs
()

203  (
ucc_couÁ_t
 *)
d¡_couÁs
.
	`d©a
();

204 
	}
}

206 
ucc_ašt_t
 *
	gucc_±_g’”©Ü_fe
::
	$g‘_d¡_di¥ls
()

208  (
ucc_ašt_t
 *)
d¡_di¥ls
.
	`d©a
();

209 
	}
}

211 
	gucc_±_g’”©Ü_fe
::
	$£tup_couÁs_di¥ls
()

213 cÚ¡‡uto& 
couÁs
 = 
·‰”n_couÁs
[
cu¼’t_·‰”n
];

215 ià(
couÁs
.
	`size
(è< 
comm_size
 * comm_size) {

216 
throw
 
¡d
::
	`ruÁime_”rÜ
("P©‹º siz(" + std::
	`to_¡ršg
(
couÁs
.
	`size
()) +

218 
¡d
::
	`to_¡ršg
(
comm_size
 * comm_size) + ")");

221 
i
 = 0; i < 
comm_size
; i++) {

222 
¤c_couÁs
[
i
] = 
couÁs
[
¿nk_id
 * 
comm_size
 + i];

225 
size_t
 
di¥l
 = 0;

226 
i
 = 0; i < 
comm_size
; i++) {

227 
¤c_di¥ls
[
i
] = 
di¥l
;

228 
di¥l
 +ğ
¤c_couÁs
[
i
];

231 
i
 = 0; i < 
comm_size
; i++) {

232 
d¡_couÁs
[
i
] = 
couÁs
[˜* 
comm_size
 + 
¿nk_id
];

235 
di¥l
 = 0;

236 
i
 = 0; i < 
comm_size
; i++) {

237 
d¡_di¥ls
[
i
] = 
di¥l
;

238 
di¥l
 +ğ
d¡_couÁs
[
i
];

241 
	}
}

243 
size_t
 
	gucc_±_g’”©Ü_fe
::
	$g‘_¤c_couÁ_max
()

245 
size_t
 
max_¤c_couÁ
 = 0;

247 
size_t
 
i
 = 0; i < 
·‰”n_couÁs
.
	`size
(); i++) {

248 cÚ¡‡uto& 
couÁs
 = 
·‰”n_couÁs
[
i
];

249 
size_t
 
tÙ®_¤c
 = 0;

250 
j
 = 0; j < 
comm_size
; j++) {

251 
tÙ®_¤c
 +ğ
couÁs
[
¿nk_id
 * 
comm_size
 + 
j
];

253 ià(
tÙ®_¤c
 > 
max_¤c_couÁ
) {

254 
max_¤c_couÁ
 = 
tÙ®_¤c
;

257  
max_¤c_couÁ
;

258 
	}
}

260 
size_t
 
	gucc_±_g’”©Ü_fe
::
	$g‘_d¡_couÁ_max
()

262 
size_t
 
max_d¡_couÁ
 = 0;

264 
size_t
 
i
 = 0; i < 
·‰”n_couÁs
.
	`size
(); i++) {

265 cÚ¡‡uto& 
couÁs
 = 
·‰”n_couÁs
[
i
];

266 
size_t
 
tÙ®_d¡
 = 0;

267 
j
 = 0; j < 
comm_size
; j++) {

268 
tÙ®_d¡
 +ğ
couÁs
[
j
 * 
comm_size
 + 
¿nk_id
];

270 ià(
tÙ®_d¡
 > 
max_d¡_couÁ
) {

271 
max_d¡_couÁ
 = 
tÙ®_d¡
;

274  
max_d¡_couÁ
;

275 
	}
}

277 
size_t
 
	gucc_±_g’”©Ü_fe
::
	$g‘_couÁ_max
()

279 autØ
m©rix
 = 
·‰”n_couÁs
[
cu¼’t_·‰”n
];

280 
size_t
 
max_couÁ
 = 0;

281 
size_t
 
cur_row_cŞ
;

283 
i
 = 0; i < 
comm_size
; i++) {

284 
cur_row_cŞ
 = 0;

285 
j
 = 0; j < 
comm_size
; j++) {

286 
cur_row_cŞ
 +ğ
m©rix
[
i
 * 
comm_size
 + 
j
];

288 ià(
cur_row_cŞ
 > 
max_couÁ
) {

289 
max_couÁ
 = 
cur_row_cŞ
;

293 
i
 = 0; i < 
comm_size
; i++) {

294 
cur_row_cŞ
 = 0;

295 
j
 = 0; j < 
comm_size
; j++) {

296 
cur_row_cŞ
 +ğ
m©rix
[
j
 * 
comm_size
 + 
i
];

298 ià(
cur_row_cŞ
 > 
max_couÁ
) {

299 
max_couÁ
 = 
cur_row_cŞ
;

302  
max_couÁ
;

303 
	}
}

	@tools/perf/ucc_perftest.cc

1 
	~<ucc/­i/ucc.h
>

2 
	~"ucc_±_comm.h
"

3 
	~"ucc_±_cÚfig.h
"

4 
	~"ucc_±_cŞl.h
"

5 
	~"ucc_±_cuda.h
"

6 
	~"ucc_±_rocm.h
"

7 
	~"ucc_±_b’chm¬k.h
"

9 
	$maš
(
¬gc
, *
¬gv
[])

11 
ucc_±_cÚfig
 
±_cÚfig
;

12 
ucc_±_comm
 *
comm
;

13 
ucc_±_b’chm¬k
 *
b’ch
;

14 
ucc_¡©us_t
 
¡
;

16 
±_cÚfig
.
	`´oûss_¬gs
(
¬gc
, 
¬gv
);

17 
	`ucc_±_cuda_š™
();

18 
	`ucc_±_rocm_š™
();

19 
Œy
 {

20 
comm
 = 
Ãw
 
	`ucc_±_comm
(
±_cÚfig
.comm);

21 } 
	`ÿtch
(
¡d
::
exû±iÚ
 &
e
) {

22 
¡d
::
û¼
 << 
e
.
	`wh©
(è<< std::
’dl
;

23 
¡d
::
	`ex™
(1);

25 
¡
 = 
comm
->
	`š™
();

26 ià(
¡
 !ğ
UCC_OK
) {

27 
d–‘e
 
comm
;

28 
¡d
::
	`ex™
(1);

30 
Œy
 {

31 
b’ch
 = 
Ãw
 
	`ucc_±_b’chm¬k
(
±_cÚfig
.b’ch, 
comm
);

32 } 
	`ÿtch
(
¡d
::
exû±iÚ
 &
e
) {

33 
¡d
::
û¼
 << 
e
.
	`wh©
(è<< std::
’dl
;

34 
comm
->
	`fš®ize
();

35 
d–‘e
 
comm
;

36 
¡d
::
	`ex™
(1);

38 
¡
 = 
b’ch
->
	`run_b’ch
();

39 ià(
¡
 !ğ
UCC_OK
) {

40 
¡d
::
û¼
 << "B’chm¬k faed w™h stu " << 
¡
 << " "

41 << 
	`ucc_¡©us_¡ršg
(
¡
è<< 
¡d
::
’dl
;

42 
d–‘e
 
b’ch
;

43 
comm
->
	`fš®ize
();

44 
d–‘e
 
comm
;

45 
¡d
::
	`ex™
(1);

47 
d–‘e
 
b’ch
;

48 
comm
->
	`fš®ize
();

49 
d–‘e
 
comm
;

51 
	}
}

	@tools/perf/ucc_perftest.h

7 
	~<ucc/­i/ucc.h
>

8 
	~<io¡»am
>

9 
	~"cÚfig.h
"

11 
	~"uts/ucc_m®loc.h
"

14 
	#STR
(
x
è#x

	)

15 
	#UCCCHECK_GOTO
(
_ÿÎ
, 
_Ïb–
, 
_¡©us
) \

17 
_¡©us
 = (
_ÿÎ
); \

18 ià(
UCC_OK
 !ğ
_¡©us
) { \

19 
¡d
::
û¼
 << "UCC…”áe¡ƒ¼Ü: " << 
	`ucc_¡©us_¡ršg
(
_¡©us
) \

20 << " iÀ" << 
	`STR
(
_ÿÎ
è<< 
__FILE__
 << ":" \

21 << 
__LINE__
<< "\n"; \

22 
_Ïb–
; \

24 } 0)

	)

26 
	#UCC_MALLOC_CHECK_GOTO
(
_obj
, 
_Ïb–
, 
_¡©us
) \

28 ià(!(
_obj
)) { \

29 
_¡©us
 = 
UCC_ERR_NO_MEMORY
; \

30 
¡d
::
û¼
 << "UCC…”áe¡ƒ¼Ü: " << 
	`ucc_¡©us_¡ršg
(
_¡©us
) \

32 
_Ïb–
; \

34 } 0)

	)

	@tools/perf/ucc_pt_benchmark.cc

7 
	~<iomª
>

8 
	~"ucc_±_b’chm¬k.h
"

9 
	~"compÚ’ts/mc/ucc_mc.h
"

10 
	~"ucc_³ráe¡.h
"

11 
	~"uts/ucc_cŞl_uts.h
"

12 
	~"cÜe/ucc_“.h
"

13 
	~"ucc_±_cŞl.h
"

14 
	~"g’”©Ü/ucc_±_g’”©Ü.h
"

16 
	gucc_±_b’chm¬k
::
	$ucc_±_b’chm¬k
(
ucc_±_b’chm¬k_cÚfig
 
cfg
,

17 
ucc_±_comm
 *
communiÿtÜ
):

18 
	`cÚfig
(
cfg
),

19 
	$comm
(
communiÿtÜ
)

21 ià(
cfg
.
g’
.
ty³
 =ğ
UCC_PT_GEN_TYPE_EXP
) {

22 
g’”©Ü
 = 
Ãw
 
	`ucc_±_g’”©Ü_expÚ’tŸl
(
cfg
.
mš_couÁ
, cfg.
max_couÁ
, 2,

23 
communiÿtÜ
->
	`g‘_size
(),

24 
cfg
.
İ_ty³
);

25 } ià(
cfg
.
g’
.
ty³
 =ğ
UCC_PT_GEN_TYPE_FILE
) {

26 
g’”©Ü
 = 
Ãw
 
	`ucc_±_g’”©Ü_fe
(
cfg
.
g’
.
fe_Çme
,

27 
communiÿtÜ
->
	`g‘_size
(),

28 
communiÿtÜ
->
	`g‘_¿nk
(),

29 
cfg
.
İ_ty³
, cfg.
g’
.
Ä•
);

30 ià(
cfg
.
İ_ty³
 !ğ
UCC_PT_OP_TYPE_ALLTOALLV
) {

31 
throw
 
¡d
::
	`ruÁime_”rÜ
("Only ALLTOALLV is supported for file generator");

35 
g’”©Ü
 = 
Ãw
 
	`ucc_±_g’”©Ü_expÚ’tŸl
(
cfg
.
mš_couÁ
, cfg.
max_couÁ
, 2,

36 
communiÿtÜ
->
	`g‘_size
(),

37 
cfg
.
İ_ty³
);

40 
cfg
.
İ_ty³
) {

41 
UCC_PT_OP_TYPE_ALLGATHER
:

42 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_®lg©h”
(
cfg
.
dt
, cfg.
mt
, cfg.
š¶aû
,

43 
cfg
.
³rsi¡’t
, 
comm
, 
g’”©Ü
);

45 
UCC_PT_OP_TYPE_ALLGATHERV
:

46 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_®lg©h”v
(
cfg
.
dt
, cfg.
mt
, cfg.
š¶aû
,

47 
cfg
.
³rsi¡’t
, 
comm
, 
g’”©Ü
);

49 
UCC_PT_OP_TYPE_ALLREDUCE
:

50 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_®Ìeduû
(
cfg
.
dt
, cfg.
mt
, cfg.
İ
, cfg.
š¶aû
,

51 
cfg
.
³rsi¡’t
, 
comm
, 
g’”©Ü
);

53 
UCC_PT_OP_TYPE_ALLTOALL
:

54 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_®ÉßÎ
(
cfg
.
dt
, cfg.
mt
, cfg.
š¶aû
,

55 
cfg
.
³rsi¡’t
, 
comm
, 
g’”©Ü
);

57 
UCC_PT_OP_TYPE_ALLTOALLV
:

58 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_®ÉßÎv
(
cfg
.
dt
, cfg.
mt
, cfg.
š¶aû
,

59 
cfg
.
³rsi¡’t
, 
comm
, 
g’”©Ü
);

61 
UCC_PT_OP_TYPE_BARRIER
:

62 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_b¬r›r
(
comm
, 
g’”©Ü
);

64 
UCC_PT_OP_TYPE_BCAST
:

65 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_bÿ¡
(
cfg
.
dt
, cfg.
mt
, cfg.
roÙ_shiá
,

66 
cfg
.
³rsi¡’t
, 
comm
, 
g’”©Ü
);

68 
UCC_PT_OP_TYPE_GATHER
:

69 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_g©h”
(
cfg
.
dt
, cfg.
mt
, cfg.
š¶aû
,

70 
cfg
.
³rsi¡’t
, cfg.
roÙ_shiá
, 
comm
, 
g’”©Ü
);

72 
UCC_PT_OP_TYPE_GATHERV
:

73 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_g©h”v
(
cfg
.
dt
, cfg.
mt
, cfg.
š¶aû
,

74 
cfg
.
³rsi¡’t
, cfg.
roÙ_shiá
, 
comm
, 
g’”©Ü
);

76 
UCC_PT_OP_TYPE_REDUCE
:

77 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_»duû
(
cfg
.
dt
, cfg.
mt
, cfg.
İ
, cfg.
š¶aû
,

78 
cfg
.
³rsi¡’t
, cfg.
roÙ_shiá
, 
comm
, 
g’”©Ü
);

80 
UCC_PT_OP_TYPE_REDUCE_SCATTER
:

81 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_»duû_sÿ‰”
(
cfg
.
dt
, cfg.
mt
, cfg.
İ
,

82 
cfg
.
š¶aû
,

83 
cfg
.
³rsi¡’t
, 
comm
, 
g’”©Ü
);

85 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
:

86 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_»duû_sÿ‰”v
(
cfg
.
dt
, cfg.
mt
, cfg.
İ
,

87 
cfg
.
š¶aû
, cfg.
³rsi¡’t
,

88 
comm
, 
g’”©Ü
);

90 
UCC_PT_OP_TYPE_SCATTER
:

91 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_sÿ‰”
(
cfg
.
dt
, cfg.
mt
, cfg.
š¶aû
,

92 
cfg
.
³rsi¡’t
, cfg.
roÙ_shiá
, 
comm
, 
g’”©Ü
);

94 
UCC_PT_OP_TYPE_SCATTERV
:

95 
cŞl
 = 
Ãw
 
	`ucc_±_cŞl_sÿ‰”v
(
cfg
.
dt
, cfg.
mt
, cfg.
š¶aû
,

96 
cfg
.
³rsi¡’t
, cfg.
roÙ_shiá
, 
comm
, 
g’”©Ü
);

98 
UCC_PT_OP_TYPE_MEMCPY
:

99 
cŞl
 = 
Ãw
 
	`ucc_±_İ_memıy
(
cfg
.
dt
, cfg.
mt
, cfg.
n_bufs
, 
comm
, 
g’”©Ü
);

101 
UCC_PT_OP_TYPE_REDUCEDT
:

102 
cŞl
 = 
Ãw
 
	`ucc_±_İ_»duû
(
cfg
.
dt
, cfg.
mt
, cfg.
İ
, cfg.
n_bufs
, 
comm
, 
g’”©Ü
);

104 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

105 
cŞl
 = 
Ãw
 
	`ucc_±_İ_»duû_¡rided
(
cfg
.
dt
, cfg.
mt
, cfg.
İ
, cfg.
n_bufs
,

106 
comm
, 
g’”©Ü
);

109 
throw
 
¡d
::
	`ruÁime_”rÜ
("not supported collective");

111 
	}
}

113 
ucc_¡©us_t
 
	gucc_±_b’chm¬k
::
	$run_b’ch
(è
nÛxû±


115 
ucc_¡©us_t
 
¡
;

116 
ucc_±_‹¡_¬gs_t
 
¬gs
;

117 
time
;

118 
time_mš
, 
time_max
, 
time_avg
;

119 
tÙ®_time
 = 0;

121 
g’”©Ü
->
	`»£t
();

122 
	`´št_h—d”
();

125 
g’”©Ü
->
	`»£t
(); g’”©Ü->
	`has_Ãxt
(); g’”©Ü->
	`Ãxt
()) {

126 
™”
 = 
cÚfig
.
n_™”_sm®l
;

127 
w¬mup
 = 
cÚfig
.
n_w¬mup_sm®l
;

129 ià(
g’”©Ü
->
	`g‘_couÁ_max
(è>ğ
cÚfig
.
Ïrge_th»sh
) {

130 
™”
 = 
cÚfig
.
n_™”_Ïrge
;

131 
w¬mup
 = 
cÚfig
.
n_w¬mup_Ïrge
;

133 
¬gs
.
cŞl_¬gs
.
roÙ
 = 
cÚfig
.root;

134 
	`UCCCHECK_GOTO
(
cŞl
->
	`š™_¬gs
(
¬gs
), 
ex™_”r
, 
¡
);

135 ià((
ušt64_t
)
cÚfig
.
İ_ty³
 < (ušt64_t)
UCC_COLL_TYPE_LAST
) {

136 
	`UCCCHECK_GOTO
(
	`run_sšgË_cŞl_‹¡
(
¬gs
.
cŞl_¬gs
, 
w¬mup
, 
™”
, 
time
),

137 
ä“_cŞl
, 
¡
);

139 
	`UCCCHECK_GOTO
(
	`run_sšgË_executÜ_‹¡
(
¬gs
.
executÜ_¬gs
,

140 
w¬mup
, 
™”
, 
time
),

141 
ä“_cŞl
, 
¡
);

144 
comm
->
	`®Ìeduû
(&
time
, &
time_mš
, 1, 
UCC_OP_MIN
);

145 
comm
->
	`®Ìeduû
(&
time
, &
time_max
, 1, 
UCC_OP_MAX
);

146 
comm
->
	`®Ìeduû
(&
time
, &
time_avg
, 1, 
UCC_OP_SUM
);

147 
time_avg
 /ğ
comm
->
	`g‘_size
();

148 
tÙ®_time
 +ğ
time_max
;

150 
	`´št_time
(
g’”©Ü
->
	`g‘_¤c_couÁ
(), 
¬gs
, 
time_avg
, 
time_mš
, 
time_max
);

151 
cŞl
->
	`ä“_¬gs
(
¬gs
);

152 ià(!
cŞl
->
	`has_¿nge
()) {

158 ià(
comm
->
	`g‘_¿nk
() == 0) {

159 
¡d
::
cout
 << "TÙ®ime: " << 
tÙ®_time
 / 1000 << " ms" << std::
’dl
;

162  
UCC_OK
;

163 
ä“_cŞl
:

164 
cŞl
->
	`ä“_¬gs
(
¬gs
);

165 
ex™_”r
:

166  
¡
;

167 
	}
}

169 
šlše
 
	$g‘_time_us
()

171 
timev®
 
t
;

173 
	`g‘timeofday
(&
t
, 
NULL
);

174  
t
.
tv_£c
 * 1e6 +.
tv_u£c
;

175 
	}
}

177 
ucc_¡©us_t
 
	gucc_±_b’chm¬k
::
	$run_sšgË_cŞl_‹¡
(
ucc_cŞl_¬gs_t
 
¬gs
,

178 
nw¬mup
, 
n™”
,

179 &
time
)

180 
nÛxû±


182 cÚ¡ 
boŞ
 
Œigg”ed
 = 
cÚfig
.triggered;

183 cÚ¡ 
boŞ
 
³rsi¡’t
 = 
cÚfig
.persistent;

184 
ucc_‹am_h
 
‹am
 = 
comm
->
	`g‘_‹am
();

185 
ucc_cÚ‹xt_h
 
ùx
 = 
comm
->
	`g‘_cÚ‹xt
();

186 
ucc_¡©us_t
 
¡
 = 
UCC_OK
;

187 
ucc_cŞl_»q_h
 
»q
;

188 
ucc_“_h
 
“
;

189 
ucc_ev_t
 
comp_ev
, *
po¡_ev
;

191 
	`UCCCHECK_GOTO
(
comm
->
	`b¬r›r
(), 
ex™_”r
, 
¡
);

192 
time
 = 0;

194 ià(
Œigg”ed
) {

195 
Œy
 {

196 
“
 = 
comm
->
	`g‘_“
();

197 } 
	`ÿtch
(
¡d
::
exû±iÚ
 &
e
) {

198 
¡d
::
û¼
 << 
e
.
	`wh©
(è<< std::
’dl
;

199  
UCC_ERR_NO_MESSAGE
;

202 
comp_ev
.
ev_ty³
 = 
UCC_EVENT_COMPUTE_COMPLETE
;

203 
comp_ev
.
ev_cÚ‹xt
 = 
nuÎ±r
;

204 
comp_ev
.
ev_cÚ‹xt_size
 = 0;

207 ià(
³rsi¡’t
) {

208 
	`UCCCHECK_GOTO
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
), 
ex™_”r
, 
¡
);

211 
¬gs
.
roÙ
 = 
cÚfig
.roÙ % 
comm
->
	`g‘_size
();

212 
i
 = 0; i < 
nw¬mup
 + 
n™”
; i++) {

213 
s
 = 
	`g‘_time_us
();

215 ià(!
³rsi¡’t
) {

216 
	`UCCCHECK_GOTO
(
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
), 
ex™_”r
, 
¡
);

219 ià(
Œigg”ed
) {

220 
comp_ev
.
»q
 =„eq;

221 
	`UCCCHECK_GOTO
(
	`ucc_cŞËùive_Œigg”ed_po¡
(
“
, &
comp_ev
),

222 
ä“_»q
, 
¡
);

223 
	`UCCCHECK_GOTO
(
	`ucc_“_g‘_ev’t
(
“
, &
po¡_ev
), 
ä“_»q
, 
¡
);

224 
	`ucc_as£¹
(
po¡_ev
->
ev_ty³
 =ğ
UCC_EVENT_COLLECTIVE_POST
);

225 
	`UCCCHECK_GOTO
(
	`ucc_“_ack_ev’t
(
“
, 
po¡_ev
), 
ä“_»q
, 
¡
);

227 
	`UCCCHECK_GOTO
(
	`ucc_cŞËùive_po¡
(
»q
), 
ä“_»q
, 
¡
);

230 
¡
 = 
	`ucc_cŞËùive_‹¡
(
»q
);

231 
¡
 > 0) {

232 
	`UCCCHECK_GOTO
(
	`ucc_cÚ‹xt_´og»ss
(
ùx
), 
ä“_»q
, 
¡
);

233 
¡
 = 
	`ucc_cŞËùive_‹¡
(
»q
);

236 ià(!
³rsi¡’t
) {

237 
	`ucc_cŞËùive_fš®ize
(
»q
);

239 
f
 = 
	`g‘_time_us
();

240 ià(
¡
 !ğ
UCC_OK
) {

241 
ex™_”r
;

243 ià(
i
 >ğ
nw¬mup
) {

244 
time
 +ğ
f
 - 
s
;

246 
¬gs
.
roÙ
 = (¬gs.roÙ + 
cÚfig
.
roÙ_shiá
è% 
comm
->
	`g‘_size
();

247 
	`UCCCHECK_GOTO
(
comm
->
	`b¬r›r
(), 
ex™_”r
, 
¡
);

250 ià(
³rsi¡’t
) {

251 
	`ucc_cŞËùive_fš®ize
(
»q
);

254 ià(
n™”
 != 0) {

255 
time
 /ğ
n™”
;

257  
UCC_OK
;

258 
ä“_»q
:

259 
	`ucc_cŞËùive_fš®ize
(
»q
);

260 
ex™_”r
:

261  
¡
;

262 
	}
}

264 
ucc_¡©us_t


265 
	gucc_±_b’chm¬k
::
	$run_sšgË_executÜ_‹¡
(
ucc_“_executÜ_sk_¬gs_t
 
¬gs
,

266 
nw¬mup
, 
n™”
,

267 &
time
è
nÛxû±


269 cÚ¡ 
boŞ
 
Œigg”ed
 = 
cÚfig
.triggered;

270 
ucc_“_executÜ_t
 *
executÜ
 = 
comm
->
	`g‘_executÜ
();

271 
ucc_¡©us_t
 
¡
 = 
UCC_OK
;

272 
ucc_“_h
 
“
;

273 
ucc_“_executÜ_sk_t
 *
sk
;

275 
time
 = 0;

276 ià(
Œigg”ed
) {

277 
Œy
 {

278 
“
 = 
comm
->
	`g‘_“
();

279 } 
	`ÿtch
(
¡d
::
exû±iÚ
 &
e
) {

280 
¡d
::
û¼
 << 
e
.
	`wh©
(è<< std::
’dl
;

281  
UCC_ERR_NO_MESSAGE
;

283 
	`UCCCHECK_GOTO
(
	`ucc_“_executÜ_¡¬t
(
executÜ
, 
“
->
“_cÚ‹xt
),

284 
ex™_”r
, 
¡
);

286 
	`UCCCHECK_GOTO
(
	`ucc_“_executÜ_¡¬t
(
executÜ
, 
nuÎ±r
), 
ex™_”r
, 
¡
);

289 
i
 = 0; i < 
nw¬mup
 + 
n™”
; i++) {

290 
s
 = 
	`g‘_time_us
();

292 
	`UCCCHECK_GOTO
(
	`ucc_“_executÜ_sk_po¡
(
executÜ
, &
¬gs
, &
sk
),

293 
¡İ_exec
, 
¡
);

294 
¡
 = 
	`ucc_“_executÜ_sk_‹¡
(
sk
);

295 
¡
 > 0) {

296 
¡
 = 
	`ucc_“_executÜ_sk_‹¡
(
sk
);

298 
	`ucc_“_executÜ_sk_fš®ize
(
sk
);

299 
f
 = 
	`g‘_time_us
();

300 ià(
¡
 !ğ
UCC_OK
) {

301 
ex™_”r
;

303 ià(
i
 >ğ
nw¬mup
) {

304 
time
 +ğ
f
 - 
s
;

308 
	`UCCCHECK_GOTO
(
	`ucc_“_executÜ_¡İ
(
executÜ
), 
ex™_”r
, 
¡
);

309 ià(
n™”
 != 0) {

310 
time
 /ğ
n™”
;

312  
UCC_OK
;

314 
¡İ_exec
:

315 
	`ucc_“_executÜ_¡İ
(
executÜ
);

316 
ex™_”r
:

317  
¡
;

318 
	}
}

320 
	gucc_±_b’chm¬k
::
	$´št_h—d”
()

322 ià(
comm
->
	`g‘_¿nk
() == 0) {

323 
¡d
::
ios
 
	`io¡©e
(
nuÎ±r
);

324 
io¡©e
.
	`cİyfmt
(
¡d
::
cout
);

325 
¡d
::
cout
 << std::
Ëá
 << std::
	`£tw
(24)

326 << "CŞËùive: " << 
	`ucc_±_İ_ty³_¡r
(
cÚfig
.
İ_ty³
)

327 << 
¡d
::
’dl
;

328 
¡d
::
cout
 << std::
Ëá
 << std::
	`£tw
(24)

329 << "MemÜyy³: " << 
ucc_memÜy_ty³_Çmes
[
cÚfig
.
mt
]

330 << 
¡d
::
’dl
;

331 
¡d
::
cout
 << std::
Ëá
 << std::
	`£tw
(24)

332 << "D©©y³: " << 
	`ucc_d©©y³_¡r
(
cÚfig
.
dt
)

333 << 
¡d
::
’dl
;

334 
¡d
::
cout
 << std::
Ëá
 << std::
	`£tw
(24)

336 << (
cŞl
->
	`has_»duùiÚ
() ?

337 
	`ucc_»duùiÚ_İ_¡r
(
cÚfig
.
İ
):

339 << 
¡d
::
’dl
;

340 
¡d
::
cout
 << std::
Ëá
 << std::
	`£tw
(24)

342 << (
cŞl
->
	`has_š¶aû
() ?

343 
¡d
::
	`to_¡ršg
(
cÚfig
.
š¶aû
):

345 << 
¡d
::
’dl
;

346 
¡d
::
cout
 << std::
Ëá
 << std::
	`£tw
(24)

347 << "W¬mup:" << 
¡d
::
’dl


348 << 
¡d
::
Ëá
 << std::
	`£tw
(24)

349 << " sm®l" << 
cÚfig
.
n_w¬mup_sm®l
 << 
¡d
::
’dl


350 << 
¡d
::
Ëá
 << std::
	`£tw
(24)

351 << "†¬ge" << 
cÚfig
.
n_w¬mup_Ïrge
 << 
¡d
::
’dl
;

352 
¡d
::
cout
 << std::
Ëá
 << std::
	`£tw
(24)

353 << "I‹¿tiÚs:" << 
¡d
::
’dl


354 << 
¡d
::
Ëá
 << std::
	`£tw
(24)

355 << " sm®l" << 
cÚfig
.
n_™”_sm®l
 << 
¡d
::
’dl


356 << 
¡d
::
Ëá
 << std::
	`£tw
(24)

357 << "†¬ge" << 
cÚfig
.
n_™”_Ïrge
 << 
¡d
::
’dl
;

358 
¡d
::
cout
.
	`cİyfmt
(
io¡©e
);

359 
¡d
::
cout
 << std::
’dl
;

360 
¡d
::
cout
 << std::
	`£tw
(12) << "Count"

361 << 
¡d
::
	`£tw
(12) << "Size"

362 << 
¡d
::
	`£tw
(24) << "Time, us";

363 ià(
cÚfig
.
fuÎ_´št
) {

364 
¡d
::
cout
 << std::
	`£tw
(42) << "Bandwidth, GB/s";

366 
¡d
::
cout
 << std::
’dl
;

367 
¡d
::
cout
 << std::
	`£tw
(36) << "avg"

368 << 
¡d
::
	`£tw
(12) << "min"

369 << 
¡d
::
	`£tw
(12) << "max";

370 ià(
cÚfig
.
fuÎ_´št
) {

371 
¡d
::
cout
 << std::
	`£tw
(12) << "avg"

372 << 
¡d
::
	`£tw
(12) << "max"

373 << 
¡d
::
	`£tw
(12) << "min";

375 
¡d
::
cout
 << std::
’dl
;

377 
	}
}

379 
	gucc_±_b’chm¬k
::
	$´št_time
(
size_t
 
couÁ
, 
ucc_±_‹¡_¬gs_t
 
¬gs
,

380 
time_avg
,

381 
time_mš
,

382 
time_max
)

384 
size_t
 
size
 = 
couÁ
 * 
	`ucc_dt_size
(
cÚfig
.
dt
);

385 
gsize
 = 
comm
->
	`g‘_size
();

387 ià(
comm
->
	`g‘_¿nk
() == 0) {

388 
¡d
::
ios
 
	`io¡©e
(
nuÎ±r
);

389 
io¡©e
.
	`cİyfmt
(
¡d
::
cout
);

390 
¡d
::
cout
 << std::
	`£»cisiÚ
(2è<< std::
fixed
;

391 
¡d
::
cout
 << std::
	`£tw
(12è<< (
cŞl
->
	`has_¿nge
() ?

392 
¡d
::
	`to_¡ršg
(
couÁ
):

394 << 
¡d
::
	`£tw
(12è<< (
cŞl
->
	`has_¿nge
() ?

395 
¡d
::
	`to_¡ršg
(
size
):

397 << 
¡d
::
	`£tw
(12è<< 
time_avg


398 << 
¡d
::
	`£tw
(12è<< 
time_mš


399 << 
¡d
::
	`£tw
(12è<< 
time_max
;

401 ià(
cÚfig
.
fuÎ_´št
) {

402 ià(!
cŞl
->
	`has_bw
()) {

403 
¡d
::
cout
 << std::
	`£tw
(12) << "N/A"

404 << 
¡d
::
	`£tw
(12) << "N/A"

405 << 
¡d
::
	`£tw
(12) << "N/A";

407 ià(
cÚfig
.
İ_ty³
 =ğ
UCC_PT_OP_TYPE_GATHER
 ||

408 
cÚfig
.
İ_ty³
 =ğ
UCC_PT_OP_TYPE_SCATTER
) {

409 
¡d
::
cout
 << std::
	`£tw
(12) << "N/A"

410 << 
¡d
::
	`£tw
(12) << "N/A"

411 << 
¡d
::
	`£tw
(12è<< 
cŞl
->
	`g‘_bw
(
time_max
, 
gsize
,

412 
¬gs
);

414 
¡d
::
cout
 << std::
	`£tw
(12è<< 
cŞl
->
	`g‘_bw
(
time_avg
, 
gsize
,

415 
¬gs
)

416 << 
¡d
::
	`£tw
(12è<< 
cŞl
->
	`g‘_bw
(
time_mš
, 
gsize
,

417 
¬gs
)

418 << 
¡d
::
	`£tw
(12è<< 
cŞl
->
	`g‘_bw
(
time_max
, 
gsize
,

419 
¬gs
);

423 
¡d
::
cout
 << std::
’dl
;

424 
¡d
::
cout
.
	`cİyfmt
(
io¡©e
);

426 
	}
}

428 
	gucc_±_b’chm¬k
::~
	$ucc_±_b’chm¬k
()

430 
d–‘e
 
cŞl
;

431 
d–‘e
 
g’”©Ü
;

432 
	}
}

	@tools/perf/ucc_pt_benchmark.h

7 #iâdeà
UCC_PT_BENCH_H


8 
	#UCC_PT_BENCH_H


	)

10 
	~"ucc_±_cÚfig.h
"

11 
	~"ucc_±_cŞl.h
"

12 
	~"g’”©Ü/ucc_±_g’”©Ü.h
"

13 
	~"ucc_±_comm.h
"

14 
	~"uts/ucc_cŞl_uts.h
"

15 
	~<ucc/­i/ucc.h
>

17 şas 
	cucc_±_b’chm¬k
 {

18 
ucc_±_b’chm¬k_cÚfig
 
	mcÚfig
;

19 
ucc_±_comm
 *
	mcomm
;

20 
ucc_±_cŞl
 *
	mcŞl
;

21 
ucc_±_g’”©Ü_ba£
 *
	mg’”©Ü
;

23 
´št_h—d”
();

24 
´št_time
(
size_t
 
couÁ
, 
ucc_±_‹¡_¬gs_t
 
¬gs
, 
time_avg
,

25 
time_mš
, 
time_max
);

26 
	mpublic
:

27 
ucc_±_b’chm¬k
(
ucc_±_b’chm¬k_cÚfig
 
cfg
, 
ucc_±_comm
 *
communiÿtÜ
);

28 
ucc_¡©us_t
 
	$run_b’ch
(è
nÛxû±
;

29 
ucc_¡©us_t
 
	$run_sšgË_cŞl_‹¡
(
ucc_cŞl_¬gs_t
 
¬gs
,

30 
nw¬mup
, 
n™”
,

31 &
time
è
nÛxû±
;

32 
ucc_¡©us_t
 
	$run_sšgË_executÜ_‹¡
(
ucc_“_executÜ_sk_¬gs_t
 
¬gs
,

33 
nw¬mup
, 
n™”
,

34 &
time
è
nÛxû±
;

35 ~
	`ucc_±_b’chm¬k
();

	@tools/perf/ucc_pt_bootstrap.h

7 #iâdeà
UCC_PT_BOOTSTRAP_H


8 
	#UCC_PT_BOOTSTRAP_H


	)

10 
	~<ucc/­i/ucc.h
>

11 
	~<uni¡d.h
>

12 
	~<funùiÚ®
>

13 
	~<¡ršg
>

14 
	~<io¡»am
>

16 şas 
	cucc_±_boÙ¡¿p
 {

17 
	m´Ùeùed
:

18 
size_t
 
node_hash
;

19 
ucc_cÚ‹xt_oob_cŞl_t
 
	mcÚ‹xt_oob
;

20 
ucc_‹am_oob_cŞl_t
 
	m‹am_oob
;

21 
	mµn
;

22 
	mloÿl_¿nk
;

23 
	$fšd_µn
()

25 
comm_size
 = 
	`g‘_size
();

26 
comm_¿nk
 = 
	`g‘_¿nk
();

27 
size_t
 *
hashes
 = 
Ãw
 size_t[
comm_size
];

28 
ucc_¡©us_t
 
¡
;

29 *
»q
;

31 
µn
 = 0;

32 
loÿl_¿nk
 = 0;

33 
¡
 = 
‹am_oob
.
	`®lg©h”
(&
node_hash
, 
hashes
, (node_hash),

34 
‹am_oob
.
cŞl_šfo
, &
»q
);

35 ià(
¡
 !ğ
UCC_OK
) {

36 
ex™_”r
;

39 
¡
 = 
‹am_oob
.
	`»q_‹¡
(
»q
);

40 } 
¡
 =ğ
UCC_INPROGRESS
);

41 ià(
¡
 !ğ
UCC_OK
) {

42 
ex™_”r
;

44 
‹am_oob
.
	`»q_ä“
(
»q
);

45 
i
 = 0; i < 
comm_size
; i++) {

46 ià(
i
 =ğ
comm_¿nk
) {

49 ià(
node_hash
 =ğ
hashes
[
i
]) {

50 
loÿl_¿nk
++;

53 
i
 = 0; i < 
comm_size
; i++) {

54 ià(
node_hash
 =ğ
hashes
[
i
]) {

55 
µn
++;

58 
d–‘e
[] 
hashes
;

60 
ex™_”r
:

61 
¡d
::
û¼
 <<"çedØfšd…²" <<¡d::
’dl
;

62 
d–‘e
[] 
hashes
;

64 
public
:

65 
	$ucc_±_boÙ¡¿p
()

67 
ho¡Çme
[256];

68 
	`g‘ho¡Çme
(
ho¡Çme
, (hostname));

69 
node_hash
 = 
¡d
::
hash
<¡d::
¡ršg
>{}(¡d::
	`¡ršg
(
ho¡Çme
));

70 
µn
 = -1;

71 
loÿl_¿nk
 = -1;

72 
	}
}

73 
vœtu®
 
g‘_¿nk
() = 0;

74 
vœtu®
 
g‘_size
() = 0;

75 
	$g‘_µn
()

77 ià(
µn
 == -1) {

78 
	`fšd_µn
();

80  
µn
;

81 
	}
}

82 
	$g‘_loÿl_¿nk
()

84 ià(
loÿl_¿nk
 == -1) {

85 
	`fšd_µn
();

87  
loÿl_¿nk
;

88 
	}
}

89 
	gvœtu®
 ~
	$ucc_±_boÙ¡¿p
(è{
	}
};

90 
ucc_cÚ‹xt_oob_cŞl_t
 
	$g‘_cÚ‹xt_oob
()

92  
cÚ‹xt_oob
;

93 
	}
}

95 
ucc_‹am_oob_cŞl_t
 
	$g‘_‹am_oob
() {

96  
‹am_oob
;

97 
	}
}

	@tools/perf/ucc_pt_bootstrap_mpi.cc

1 
	~"ucc_±_boÙ¡¿p_mpi.h
"

3 
ucc_¡©us_t
 
	$mpi_oob_®lg©h”
(*
sbuf
, *
rbuf
, 
size_t
 
msgËn
,

4 *
cŞl_šfo
, **
»q
)

6 
MPI_Comm
 
comm
 = (MPI_Comm)(
ušŒ_t
)
cŞl_šfo
;

7 
MPI_Reque¡
 
»que¡
;

8 
	`MPI_I®lg©h”
(
sbuf
, 
msgËn
, 
MPI_BYTE
, 
rbuf
, msgËn, MPI_BYTE, 
comm
,

9 &
»que¡
);

10 *
»q
 = (*)(
ušŒ_t
)
»que¡
;

11  
UCC_OK
;

12 
	}
}

14 
ucc_¡©us_t
 
	$mpi_oob_®lg©h”_‹¡
(*
»q
)

16 
MPI_Reque¡
 
»que¡
 = (MPI_Reque¡)(
ušŒ_t
)
»q
;

17 
com¶‘ed
;

18 
	`MPI_Te¡
(&
»que¡
, &
com¶‘ed
, 
MPI_STATUS_IGNORE
);

19  
com¶‘ed
 ? 
UCC_OK
 : 
UCC_INPROGRESS
;

20 
	}
}

22 
ucc_¡©us_t
 
	$mpi_oob_®lg©h”_ä“
(*
»q
)

24  
UCC_OK
;

25 
	}
}

27 
	gucc_±_boÙ¡¿p_mpi
::
	$ucc_±_boÙ¡¿p_mpi
()

29 
	`MPI_In™
(
NULL
, NULL);

31 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
¿nk
);

32 
	`MPI_Comm_size
(
MPI_COMM_WORLD
, &
size
);

33 
cÚ‹xt_oob
.
cŞl_šfo
 = (*)(
ušŒ_t
)
MPI_COMM_WORLD
;

34 
cÚ‹xt_oob
.
®lg©h”
 = 
mpi_oob_®lg©h”
;

35 
cÚ‹xt_oob
.
»q_‹¡
 = 
mpi_oob_®lg©h”_‹¡
;

36 
cÚ‹xt_oob
.
»q_ä“
 = 
mpi_oob_®lg©h”_ä“
;

37 
cÚ‹xt_oob
.
n_oob_•s
 = 
size
;

38 
cÚ‹xt_oob
.
oob_•
 = 
¿nk
;

40 
‹am_oob
.
cŞl_šfo
 = (*)(
ušŒ_t
)
MPI_COMM_WORLD
;

41 
‹am_oob
.
®lg©h”
 = 
mpi_oob_®lg©h”
;

42 
‹am_oob
.
»q_‹¡
 = 
mpi_oob_®lg©h”_‹¡
;

43 
‹am_oob
.
»q_ä“
 = 
mpi_oob_®lg©h”_ä“
;

44 
‹am_oob
.
n_oob_•s
 = 
size
;

45 
‹am_oob
.
oob_•
 = 
¿nk
;

46 
	}
}

48 
	gucc_±_boÙ¡¿p_mpi
::
	$g‘_¿nk
()

50  
¿nk
;

51 
	}
}

53 
	gucc_±_boÙ¡¿p_mpi
::
	$g‘_size
()

55  
size
;

56 
	}
}

58 
	gucc_±_boÙ¡¿p_mpi
::~
	$ucc_±_boÙ¡¿p_mpi
()

60 
	`MPI_Fš®ize
();

61 
	}
}

	@tools/perf/ucc_pt_bootstrap_mpi.h

7 #iâdeà
UCC_PT_BOOTSTRAP_MPI_H


8 
	#UCC_PT_BOOTSTRAP_MPI_H


	)

10 
	~<mpi.h
>

11 
	~"ucc_±_boÙ¡¿p.h
"

13 şas 
	cucc_±_boÙ¡¿p_mpi
: 
public
 
ucc_±_boÙ¡¿p
 {

14 
public
:

15 
ucc_±_boÙ¡¿p_mpi
();

16 ~
ucc_±_boÙ¡¿p_mpi
();

17 
	$g‘_¿nk
(è
ov”ride
;

18 
	$g‘_size
(è
ov”ride
;

19 
´Ùeùed
:

20 
¿nk
;

21 
size
;

22 
µn
;

	@tools/perf/ucc_pt_coll.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_±_cuda.h
"

9 
	~"uts/ucc_m®loc.h
"

11 
ucc_¡©us_t
 
	$ucc_±_®loc
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
, 
size_t
 
Ën
,

12 
ucc_memÜy_ty³_t
 
mem_ty³
)

14 
ucc_¡©us_t
 
¡©us
;

15 
cuda_¡
;

17 
mem_ty³
) {

18 
UCC_MEMORY_TYPE_CUDA
:

19 *
h_±r
 = 
Ãw
 
ucc_mc_bufãr_h—d”_t
;

20 (*
h_±r
)->
mt
 = 
UCC_MEMORY_TYPE_CUDA
;

21 
cuda_¡
 = 
	`ucc_±_cudaM®loc
(&((*
h_±r
)->
addr
), 
Ën
);

22 ià(
cuda_¡
 != 0) {

23  
UCC_ERR_NO_MEMORY
;

25 
cuda_¡
 = 
	`ucc_±_cudaMem£t
((*
h_±r
)->
addr
, 0, 
Ën
);

26 ià(
cuda_¡
 != 0) {

27 
	`ucc_±_cudaF»e
((*
h_±r
)->
addr
);

28 
d–‘e
 *
h_±r
;

29  
UCC_ERR_NO_MEMORY
;

31  
UCC_OK
;

32 
UCC_MEMORY_TYPE_CUDA_MANAGED
:

33 *
h_±r
 = 
Ãw
 
ucc_mc_bufãr_h—d”_t
;

34 (*
h_±r
)->
mt
 = 
UCC_MEMORY_TYPE_CUDA_MANAGED
;

35 
cuda_¡
 = 
	`ucc_±_cudaM®locMªaged
(&((*
h_±r
)->
addr
), 
Ën
);

36 ià(
cuda_¡
 != 0) {

37  
UCC_ERR_NO_MEMORY
;

39 
cuda_¡
 = 
	`ucc_±_cudaMem£t
((*
h_±r
)->
addr
, 0, 
Ën
);

40 ià(
cuda_¡
 != 0) {

41 
	`ucc_±_cudaF»e
((*
h_±r
)->
addr
);

42 
d–‘e
 *
h_±r
;

43  
UCC_ERR_NO_MEMORY
;

45  
UCC_OK
;

46 
UCC_MEMORY_TYPE_HOST
:

47 *
h_±r
 = 
Ãw
 
ucc_mc_bufãr_h—d”_t
;

48 (*
h_±r
)->
mt
 = 
UCC_MEMORY_TYPE_HOST
;

49 (*
h_±r
)->
addr
 = 
	`ucc_m®loc
(
Ën
, "perftest data");

50 ià(!((*
h_±r
)->
addr
)) {

51  
UCC_ERR_NO_MEMORY
;

53 
	`mem£t
((*
h_±r
)->
addr
, 0, 
Ën
);

54  
UCC_OK
;

59 
¡©us
 = 
	`ucc_mc_®loc
(
h_±r
, 
Ën
, 
mem_ty³
);

60 ià(
¡©us
 !ğ
UCC_OK
) {

61  
¡©us
;

64 
¡©us
 = 
	`ucc_mc_mem£t
((*
h_±r
)->
addr
, 0, 
Ën
, 
mem_ty³
);

65 ià(
¡©us
 !ğ
UCC_OK
) {

66 
	`ucc_mc_ä“
(*
h_±r
);

67  
¡©us
;

69  
UCC_OK
;

70 
	}
}

72 
ucc_¡©us_t
 
	$ucc_±_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
)

74 
h_±r
->
mt
) {

75 
UCC_MEMORY_TYPE_CUDA
:

76 
UCC_MEMORY_TYPE_CUDA_MANAGED
:

77 
	`ucc_±_cudaF»e
(
h_±r
->
addr
);

78 
d–‘e
 
h_±r
;

79  
UCC_OK
;

80 
UCC_MEMORY_TYPE_HOST
:

81 
	`ucc_ä“
(
h_±r
->
addr
);

82 
d–‘e
 
h_±r
;

83  
UCC_OK
;

88  
	`ucc_mc_ä“
(
h_±r
);

89 
	}
}

91 
boŞ
 
	gucc_±_cŞl
::
	$has_»duùiÚ
()

93  
has_»duùiÚ_
;

94 
	}
}

96 
boŞ
 
	gucc_±_cŞl
::
	$has_š¶aû
()

98  
has_š¶aû_
;

99 
	}
}

101 
boŞ
 
	gucc_±_cŞl
::
	$has_¿nge
()

103  
has_¿nge_
;

104 
	}
}

106 
boŞ
 
	gucc_±_cŞl
::
	$has_bw
()

108  
has_bw_
;

109 
	}
}

	@tools/perf/ucc_pt_coll.h

7 #iâdeà
UCC_PT_COLL_H


8 
	#UCC_PT_COLL_H


	)

10 
	~"ucc_±_comm.h
"

11 
	~"g’”©Ü/ucc_±_g’”©Ü.h
"

12 
	~<ucc/­i/ucc.h
>

14 
	~<compÚ’ts/ec/ucc_ec.h
>

15 
	~<compÚ’ts/mc/ucc_mc.h
>

18 
ucc_¡©us_t
 
ucc_±_®loc
(
ucc_mc_bufãr_h—d”_t
 **
h_±r
, 
size_t
 
Ën
,

19 
ucc_memÜy_ty³_t
 
mem_ty³
);

21 
ucc_¡©us_t
 
ucc_±_ä“
(
ucc_mc_bufãr_h—d”_t
 *
h_±r
);

24 
ucc_cŞl_¬gs_t
 
	mcŞl_¬gs
;

25 
ucc_“_executÜ_sk_¬gs_t
 
	mexecutÜ_¬gs
;

26 } 
	tucc_±_‹¡_¬gs_t
;

28 şas 
	cucc_±_cŞl
 {

29 
	m´Ùeùed
:

30 
boŞ
 
has_š¶aû_
;

31 
boŞ
 
	mhas_»duùiÚ_
;

32 
boŞ
 
	mhas_¿nge_
;

33 
boŞ
 
	mhas_bw_
;

34 
	mroÙ_shiá_
;

35 
ucc_±_comm
 *
	mcomm
;

36 
ucc_±_g’”©Ü_ba£
 *
	mg’”©Ü
;

37 
ucc_cŞl_¬gs_t
 
	mcŞl_¬gs
;

38 
ucc_“_executÜ_sk_¬gs_t
 
	mexecutÜ_¬gs
;

39 
ucc_mc_bufãr_h—d”_t
 *
	md¡_h—d”
;

40 
ucc_mc_bufãr_h—d”_t
 *
	m¤c_h—d”
;

41 
	mpublic
:

42 
	$ucc_±_cŞl
(
ucc_±_comm
 *
communiÿtÜ
, 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
)

44 
this
->
comm
 = 
communiÿtÜ
;

45 
this
->
g’”©Ü
 = generator;

46 
¤c_h—d”
 = 
nuÎ±r
;

47 
d¡_h—d”
 = 
nuÎ±r
;

49 
vœtu®
 
ucc_¡©us_t
 
	`š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
) = 0;

50 
vœtu®
 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è{
	}
}

51 
vœtu®
 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
)

54 
	}
}

55 
boŞ
 
has_»duùiÚ
();

56 
boŞ
 
has_š¶aû
();

57 
boŞ
 
has_¿nge
();

58 
boŞ
 
has_bw
();

59 
	gvœtu®
 ~
	$ucc_±_cŞl
(è{
	}
};

62 şas 
	cucc_±_cŞl_®lg©h”
: 
public
 
ucc_±_cŞl
 {

63 
public
:

64 
ucc_±_cŞl_®lg©h”
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

65 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
,

66 
ucc_±_comm
 *
communiÿtÜ
,

67 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

68 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

69 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

70 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

73 şas 
	cucc_±_cŞl_®lg©h”v
: 
public
 
ucc_±_cŞl
 {

74 
public
:

75 
	`ucc_±_cŞl_®lg©h”v
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

76 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
,

77 
ucc_±_comm
 *
communiÿtÜ
,

78 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

79 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

80 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

83 şas 
	cucc_±_cŞl_®Ìeduû
: 
public
 
ucc_±_cŞl
 {

84 
public
:

85 
	`ucc_±_cŞl_®Ìeduû
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

86 
ucc_»duùiÚ_İ_t
 
İ
, 
boŞ
 
is_š¶aû
,

87 
boŞ
 
is_³rsi¡’t
, 
ucc_±_comm
 *
communiÿtÜ
,

88 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

89 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

90 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

91 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

94 şas 
	cucc_±_cŞl_®ÉßÎ
: 
public
 
ucc_±_cŞl
 {

95 
public
:

96 
	`ucc_±_cŞl_®ÉßÎ
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

97 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
,

98 
ucc_±_comm
 *
communiÿtÜ
,

99 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

100 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

101 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

102 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

105 şas 
	cucc_±_cŞl_®ÉßÎv
: 
public
 
ucc_±_cŞl
 {

106 
public
:

107 
	`ucc_±_cŞl_®ÉßÎv
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

108 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
,

109 
ucc_±_comm
 *
communiÿtÜ
,

110 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

111 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

112 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

115 şas 
	cucc_±_cŞl_b¬r›r
: 
public
 
ucc_±_cŞl
 {

116 
public
:

117 
	`ucc_±_cŞl_b¬r›r
(
ucc_±_comm
 *
communiÿtÜ
,

118 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

119 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

120 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

123 şas 
	cucc_±_cŞl_bÿ¡
: 
public
 
ucc_±_cŞl
 {

124 
public
:

125 
	`ucc_±_cŞl_bÿ¡
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
, 
roÙ_shiá
,

126 
boŞ
 
is_³rsi¡’t
, 
ucc_±_comm
 *
communiÿtÜ
,

127 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

128 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

129 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

130 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

133 şas 
	cucc_±_cŞl_g©h”
: 
public
 
ucc_±_cŞl
 {

134 
public
:

135 
	`ucc_±_cŞl_g©h”
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

136 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
, 
roÙ_shiá
,

137 
ucc_±_comm
 *
communiÿtÜ
,

138 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

139 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

140 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

141 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

144 şas 
	cucc_±_cŞl_g©h”v
: 
public
 
ucc_±_cŞl
 {

145 
public
:

146 
	`ucc_±_cŞl_g©h”v
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

147 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
, 
roÙ_shiá
,

148 
ucc_±_comm
 *
communiÿtÜ
,

149 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

150 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

151 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

154 şas 
	cucc_±_cŞl_»duû
: 
public
 
ucc_±_cŞl
 {

155 
public
:

156 
	`ucc_±_cŞl_»duû
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

157 
ucc_»duùiÚ_İ_t
 
İ
, 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
,

158 
roÙ_shiá
, 
ucc_±_comm
 *
communiÿtÜ
,

159 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

160 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

161 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

162 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

165 şas 
	cucc_±_cŞl_»duû_sÿ‰”
: 
public
 
ucc_±_cŞl
 {

166 
public
:

167 
	`ucc_±_cŞl_»duû_sÿ‰”
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

168 
ucc_»duùiÚ_İ_t
 
İ
, 
boŞ
 
is_š¶aû
,

169 
boŞ
 
is_³rsi¡’t
, 
ucc_±_comm
 *
communiÿtÜ
,

170 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

171 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

172 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

173 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

176 şas 
	cucc_±_cŞl_»duû_sÿ‰”v
: 
public
 
ucc_±_cŞl
 {

177 
public
:

178 
	`ucc_±_cŞl_»duû_sÿ‰”v
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

179 
ucc_»duùiÚ_İ_t
 
İ
, 
boŞ
 
is_š¶aû
,

180 
boŞ
 
is_³rsi¡’t
, 
ucc_±_comm
 *
communiÿtÜ
,

181 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

182 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

183 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

186 şas 
	cucc_±_cŞl_sÿ‰”
: 
public
 
ucc_±_cŞl
 {

187 
public
:

188 
	`ucc_±_cŞl_sÿ‰”
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

189 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
, 
roÙ_shiá
,

190 
ucc_±_comm
 *
communiÿtÜ
,

191 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

192 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

193 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

194 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

197 şas 
	cucc_±_cŞl_sÿ‰”v
: 
public
 
ucc_±_cŞl
 {

198 
public
:

199 
	`ucc_±_cŞl_sÿ‰”v
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

200 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
, 
roÙ_shiá
,

201 
ucc_±_comm
 *
communiÿtÜ
,

202 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

203 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

204 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

207 şas 
	cucc_±_İ_memıy
: 
public
 
ucc_±_cŞl
 {

208 
ucc_memÜy_ty³_t
 
mem_ty³
;

209 
ucc_d©©y³_t
 
d©a_ty³
;

210 
num_bufs
;

211 
public
:

212 
	`ucc_±_İ_memıy
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
, 
nbufs
,

213 
ucc_±_comm
 *
communiÿtÜ
,

214 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

215 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

216 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

217 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

220 şas 
	cucc_±_İ_»duû
: 
public
 
ucc_±_cŞl
 {

221 
ucc_memÜy_ty³_t
 
mem_ty³
;

222 
ucc_d©©y³_t
 
d©a_ty³
;

223 
ucc_»duùiÚ_İ_t
 
»duû_İ
;

224 
num_bufs
;

225 
public
:

226 
	`ucc_±_İ_»duû
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

227 
ucc_»duùiÚ_İ_t
 
İ
, 
nbufs
,

228 
ucc_±_comm
 *
communiÿtÜ
,

229 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

230 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

231 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

232 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

235 şas 
	cucc_±_İ_»duû_¡rided
: 
public
 
ucc_±_cŞl
 {

236 
ucc_memÜy_ty³_t
 
mem_ty³
;

237 
ucc_d©©y³_t
 
d©a_ty³
;

238 
ucc_»duùiÚ_İ_t
 
»duû_İ
;

239 
num_bufs
;

240 
public
:

241 
	`ucc_±_İ_»duû_¡rided
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

242 
ucc_»duùiÚ_İ_t
 
İ
, 
nbufs
,

243 
ucc_±_comm
 *
communiÿtÜ
,

244 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
);

245 
ucc_¡©us_t
 
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

246 
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
¬gs
è
ov”ride
;

247 
	$g‘_bw
(
time_ms
, 
grsize
, 
ucc_±_‹¡_¬gs_t
 
¬gs
è
ov”ride
;

	@tools/perf/ucc_pt_coll_allgather.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_®lg©h”
::
	$ucc_±_cŞl_®lg©h”
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
, 
boŞ
 
is_š¶aû
,

15 
boŞ
 
is_³rsi¡’t
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
è: 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

20 
has_š¶aû_
 = 
Œue
;

21 
has_»duùiÚ_
 = 
çl£
;

22 
has_¿nge_
 = 
Œue
;

23 
has_bw_
 = 
Œue
;

24 
roÙ_shiá_
 = 0;

26 
cŞl_¬gs
.
mask
 = 0;

27 
cŞl_¬gs
.
æags
 = 0;

28 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLGATHER
;

29 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

30 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

31 
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

32 
cŞl_¬gs
.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

34 ià(
is_š¶aû
) {

35 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

36 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

39 ià(
is_³rsi¡’t
) {

40 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

41 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

43 
	}
}

45 
ucc_¡©us_t
 
	gucc_±_cŞl_®lg©h”
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

47 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

48 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
);

49 
size_t
 
sšgË_¿nk_couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

50 
size_t
 
size_¤c
 = 
sšgË_¿nk_couÁ
 * 
dt_size
;

51 
size_t
 
size_d¡
 = 
comm
->
	`g‘_size
(è* 
sšgË_¿nk_couÁ
 * 
dt_size
;

52 
ucc_¡©us_t
 
¡
;

54 
¬gs
 = 
cŞl_¬gs
;

55 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
 * 
comm
->
	`g‘_size
();

56 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
, 
size_d¡
, 
¬gs
.
d¡
.
šfo
.
mem_ty³
),

57 
ex™
, 
¡
);

58 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
d¡_h—d”
->
addr
;

59 ià(!
	`UCC_IS_INPLACE
(
¬gs
)) {

60 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
sšgË_¿nk_couÁ
;

61 
	`UCCCHECK_GOTO
(

62 
	`ucc_±_®loc
(&
¤c_h—d”
, 
size_¤c
, 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

63 
ä“_d¡
, 
¡
);

64 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

66  
UCC_OK
;

67 
ä“_d¡
:

68 
	`ucc_±_ä“
(
d¡_h—d”
);

69 
ex™
:

70  
¡
;

71 
	}
}

73 
	gucc_±_cŞl_®lg©h”
::
	$g‘_bw
(
time_ms
, 
grsize
,

74 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

76 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

77 
N
 = 
grsize
;

78 
S
 = 
¬gs
.
d¡
.
šfo
.
couÁ
 *

79 
	`ucc_dt_size
(
¬gs
.
d¡
.
šfo
.
d©©y³
);

81  (
S
 / 
time_ms
è* ((
N
 - 1) / N) / 1000.0;

82 
	}
}

84 
	gucc_±_cŞl_®lg©h”
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

86 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

88 ià(!
	`UCC_IS_INPLACE
(
¬gs
)) {

89 
	`ucc_±_ä“
(
¤c_h—d”
);

91 
	`ucc_±_ä“
(
d¡_h—d”
);

92 
	}
}

	@tools/perf/ucc_pt_coll_allgatherv.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_®lg©h”v
::
	$ucc_±_cŞl_®lg©h”v
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
, 
boŞ
 
is_š¶aû
,

15 
boŞ
 
is_³rsi¡’t
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
è: 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

19 
has_š¶aû_
 = 
Œue
;

20 
has_»duùiÚ_
 = 
çl£
;

21 
has_¿nge_
 = 
Œue
;

22 
has_bw_
 = 
çl£
;

23 
roÙ_shiá_
 = 0;

25 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

26 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
;

27 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLGATHERV
;

28 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

29 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

30 
cŞl_¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
dt
;

31 
cŞl_¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = 
mt
;

33 ià(
is_š¶aû
) {

34 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

35 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

38 ià(
is_³rsi¡’t
) {

39 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

40 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

42 
	}
}

44 
ucc_¡©us_t
 
	gucc_±_cŞl_®lg©h”v
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

46 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

47 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
);

48 
ucc_¡©us_t
 
¡
;

50 
¬gs
 = 
cŞl_¬gs
;

51 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = 
g’”©Ü
->
	`g‘_d¡_couÁs
();

52 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = 
g’”©Ü
->
	`g‘_d¡_di¥ls
();

53 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

54 
g’”©Ü
->
	`g‘_d¡_couÁ
(è* 
dt_size
,

55 
¬gs
.
d¡
.
šfo_v
.
mem_ty³
),

56 
ex™
, 
¡
);

57 
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
d¡_h—d”
->
addr
;

58 ià(!
	`UCC_IS_INPLACE
(
¬gs
)) {

59 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

60 
	`UCCCHECK_GOTO
(

61 
	`ucc_±_®loc
(&
¤c_h—d”
,

62 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
,

63 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

64 
ä“_d¡
, 
¡
);

65 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

67  
UCC_OK
;

68 
ä“_d¡
:

69 
	`ucc_±_ä“
(
d¡_h—d”
);

70 
ex™
:

71  
¡
;

72 
	}
}

74 
	gucc_±_cŞl_®lg©h”v
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

76 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

78 ià(!
	`UCC_IS_INPLACE
(
¬gs
)) {

79 
	`ucc_±_ä“
(
¤c_h—d”
);

81 
	`ucc_±_ä“
(
d¡_h—d”
);

82 
	}
}

	@tools/perf/ucc_pt_coll_allreduce.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_®Ìeduû
::
	$ucc_±_cŞl_®Ìeduû
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
, 
ucc_»duùiÚ_İ_t
 
İ
,

15 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
è: 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

19 
has_š¶aû_
 = 
Œue
;

20 
has_»duùiÚ_
 = 
Œue
;

21 
has_¿nge_
 = 
Œue
;

22 
has_bw_
 = 
Œue
;

23 
roÙ_shiá_
 = 0;

25 
cŞl_¬gs
.
mask
 = 0;

26 
cŞl_¬gs
.
æags
 = 0;

27 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLREDUCE
;

28 
cŞl_¬gs
.
İ
 = op;

29 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

30 
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

31 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

32 
cŞl_¬gs
.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

34 ià(
is_š¶aû
) {

35 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

36 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

39 ià(
is_³rsi¡’t
) {

40 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

41 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

44 
	}
}

46 
ucc_¡©us_t
 
	gucc_±_cŞl_®Ìeduû
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

48 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

49 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
);

50 
ucc_¡©us_t
 
¡
 = 
UCC_OK
;

52 
¬gs
 = 
cŞl_¬gs
;

53 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

54 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_d¡_couÁ
();

55 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

56 
g’”©Ü
->
	`g‘_d¡_couÁ
(è* 
dt_size
,

57 
¬gs
.
d¡
.
šfo
.
mem_ty³
),

58 
ex™
, 
¡
);

59 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
d¡_h—d”
->
addr
;

60 ià(!
	`UCC_IS_INPLACE
(
¬gs
)) {

61 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
¤c_h—d”
,

62 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
,

63 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

64 
ä“_d¡
, 
¡
);

65 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

67  
UCC_OK
;

68 
ä“_d¡
:

69 
	`ucc_±_ä“
(
d¡_h—d”
);

70 
ex™
:

71  
¡
;

72 
	}
}

74 
	gucc_±_cŞl_®Ìeduû
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

76 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

78 ià(!
	`UCC_IS_INPLACE
(
¬gs
)) {

79 
	`ucc_±_ä“
(
¤c_h—d”
);

81 
	`ucc_±_ä“
(
d¡_h—d”
);

82 
	}
}

84 
	gucc_±_cŞl_®Ìeduû
::
	$g‘_bw
(
time_ms
, 
grsize
,

85 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

87 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

88 
N
 = 
grsize
;

89 
S
 = 
¬gs
.
¤c
.
šfo
.
couÁ
 *

90 
	`ucc_dt_size
(
¬gs
.
¤c
.
šfo
.
d©©y³
);

92  (
S
 / 
time_ms
è* (2 * (
N
 - 1) / N) / 1000.0;

93 
	}
}

	@tools/perf/ucc_pt_coll_alltoall.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_®ÉßÎ
::
	$ucc_±_cŞl_®ÉßÎ
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
, 
boŞ
 
is_š¶aû
,

15 
boŞ
 
is_³rsi¡’t
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
è: 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

19 
has_š¶aû_
 = 
Œue
;

20 
has_»duùiÚ_
 = 
çl£
;

21 
has_¿nge_
 = 
Œue
;

22 
has_bw_
 = 
Œue
;

23 
roÙ_shiá_
 = 0;

25 
cŞl_¬gs
.
mask
 = 0;

26 
cŞl_¬gs
.
æags
 = 0;

27 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLTOALL
;

28 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

29 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

30 
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

31 
cŞl_¬gs
.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

33 ià(
is_š¶aû
) {

34 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

35 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

38 ià(
is_³rsi¡’t
) {

39 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

40 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

42 
	}
}

44 
ucc_¡©us_t
 
	gucc_±_cŞl_®ÉßÎ
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

46 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

47 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
);

48 
ucc_¡©us_t
 
¡
 = 
UCC_OK
;

50 
¬gs
 = 
cŞl_¬gs
;

51 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_d¡_couÁ
();

52 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

53 
¬gs
.
d¡
.
šfo
.
couÁ
 * 
dt_size
,

54 
¬gs
.
d¡
.
šfo
.
mem_ty³
),

55 
ex™
, 
¡
);

56 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
d¡_h—d”
->
addr
;

57 ià(!
	`UCC_IS_INPLACE
(
¬gs
)) {

58 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

59 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
¤c_h—d”
,

60 
¬gs
.
¤c
.
šfo
.
couÁ
 * 
dt_size
,

61 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

62 
ä“_d¡
, 
¡
);

63 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

65  
UCC_OK
;

66 
ä“_d¡
:

67 
	`ucc_±_ä“
(
d¡_h—d”
);

68 
ex™
:

69  
¡
;

70 
	}
}

72 
	gucc_±_cŞl_®ÉßÎ
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

74 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

76 ià(!
	`UCC_IS_INPLACE
(
¬gs
)) {

77 
	`ucc_±_ä“
(
¤c_h—d”
);

79 
	`ucc_±_ä“
(
d¡_h—d”
);

80 
	}
}

82 
	gucc_±_cŞl_®ÉßÎ
::
	$g‘_bw
(
time_ms
, 
grsize
,

83 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

85 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

86 
N
 = 
grsize
;

87 
S
 = 
¬gs
.
¤c
.
šfo
.
couÁ
 *

88 
	`ucc_dt_size
(
¬gs
.
¤c
.
šfo
.
d©©y³
);

90  (
S
 / 
time_ms
è* ((
N
 - 1) / N) / 1000.0;

91 
	}
}

	@tools/perf/ucc_pt_coll_alltoallv.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_®ÉßÎv
::
	$ucc_±_cŞl_®ÉßÎv
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
,

15 
boŞ
 
is_š¶aû
,

16 
boŞ
 
is_³rsi¡’t
,

17 
ucc_±_comm
 *
communiÿtÜ
,

18 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
)

19 : 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

21 
size_t
 
¤c_couÁ_max
 = 
g’”©Ü
->
	`g‘_¤c_couÁ_max
();

22 
size_t
 
d¡_couÁ_max
 = 
g’”©Ü
->
	`g‘_d¡_couÁ_max
();

23 
ucc_¡©us_t
 
¡
;

25 
has_š¶aû_
 = 
Œue
;

26 
has_»duùiÚ_
 = 
çl£
;

27 
has_¿nge_
 = 
Œue
;

28 
has_bw_
 = 
Œue
;

29 
roÙ_shiá_
 = 0;

32 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

33 
d¡_couÁ_max
 * 
	`ucc_dt_size
(
dt
),

34 
mt
),

35 
ex™
, 
¡
);

37 ià(!
is_š¶aû
) {

38 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
¤c_h—d”
,

39 
¤c_couÁ_max
 * 
	`ucc_dt_size
(
dt
),

40 
mt
),

41 
ex™
, 
¡
);

44 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

45 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLTOALLV
;

46 
cŞl_¬gs
.
¤c
.
šfo_v
.
d©©y³
 = 
dt
;

47 
cŞl_¬gs
.
¤c
.
šfo_v
.
mem_ty³
 = 
mt
;

48 
cŞl_¬gs
.
¤c
.
šfo_v
.
bufãr
 = 
¤c_h—d”
->
addr
;

49 
cŞl_¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
dt
;

50 
cŞl_¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = 
mt
;

51 
cŞl_¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
d¡_h—d”
->
addr
;

52 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_CONTIG_SRC_BUFFER
 |

53 
UCC_COLL_ARGS_FLAG_CONTIG_DST_BUFFER
;

54 ià(
is_š¶aû
) {

55 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_IN_PLACE
;

58 ià(
is_³rsi¡’t
) {

59 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

63 
ex™
:

64 ià(
d¡_h—d”
) {

65 
	`ucc_±_ä“
(
d¡_h—d”
);

67 ià(
¤c_h—d”
) {

68 
	`ucc_±_ä“
(
¤c_h—d”
);

70 
throw
 
¡d
::
	`ruÁime_”rÜ
("failedo initialize‡lltoallv‡rguments");

71 
	}
}

73 
ucc_¡©us_t
 
	gucc_±_cŞl_®ÉßÎv
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

75 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

77 
¬gs
 = 
cŞl_¬gs
;

78 
¬gs
.
¤c
.
šfo_v
.
couÁs
 = (
ucc_couÁ_t
 *è
g’”©Ü
->
	`g‘_¤c_couÁs
();

79 
¬gs
.
¤c
.
šfo_v
.
di¥Ïûm’ts
 = (
ucc_ašt_t
 *è
g’”©Ü
->
	`g‘_¤c_di¥ls
();

80 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = (
ucc_couÁ_t
 *è
g’”©Ü
->
	`g‘_d¡_couÁs
();

81 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = (
ucc_ašt_t
 *è
g’”©Ü
->
	`g‘_d¡_di¥ls
();

83  
UCC_OK
;

84 
	}
}

86 
	gucc_±_cŞl_®ÉßÎv
::
	$g‘_bw
(
time_ms
, 
grsize
,

87 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

89 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

90 
N
 = 
grsize
;

91 
S
 = 0;

92 
size_t
 
¤c_size
 = 0, 
d¡_size
 = 0;

95 
i
 = 0; i < 
grsize
; i++) {

96 
¤c_size
 +ğ
	`ucc_cŞl_¬gs_g‘_couÁ
(&
¬gs
,‡rgs.
¤c
.
šfo_v
.
couÁs
, 
i
);

97 
d¡_size
 +ğ
	`ucc_cŞl_¬gs_g‘_couÁ
(&
¬gs
,‡rgs.
d¡
.
šfo_v
.
couÁs
, 
i
);

99 
¤c_size
 *ğ
	`ucc_dt_size
(
¬gs
.
¤c
.
šfo_v
.
d©©y³
);

100 
d¡_size
 *ğ
	`ucc_dt_size
(
¬gs
.
d¡
.
šfo_v
.
d©©y³
);

101 
S
 = 
¤c_size
 > 
d¡_size
 ? src_size : dst_size;

103  (
S
 / 
time_ms
è* ((
N
 - 1) / N) / 1000.0;

104 
	}
}

	@tools/perf/ucc_pt_coll_barrier.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_b¬r›r
::
	$ucc_±_cŞl_b¬r›r
(
ucc_±_comm
 *
communiÿtÜ
,

14 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
) :

15 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

17 
has_š¶aû_
 = 
çl£
;

18 
has_»duùiÚ_
 = 
çl£
;

19 
has_¿nge_
 = 
çl£
;

20 
has_bw_
 = 
çl£
;

21 
roÙ_shiá_
 = 0;

23 
cŞl_¬gs
.
mask
 = 0;

24 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_BARRIER
;

25 
	}
}

27 
ucc_¡©us_t
 
	gucc_±_cŞl_b¬r›r
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

29 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

31 
¬gs
 = 
cŞl_¬gs
;

32  
UCC_OK
;

33 
	}
}

35 
	gucc_±_cŞl_b¬r›r
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

38 
	}
}

	@tools/perf/ucc_pt_coll_bcast.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_bÿ¡
::
	$ucc_±_cŞl_bÿ¡
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

14 
roÙ_shiá
, 
boŞ
 
is_³rsi¡’t
,

15 
ucc_±_comm
 *
communiÿtÜ
,

16 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
)

17 : 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

19 
has_š¶aû_
 = 
çl£
;

20 
has_»duùiÚ_
 = 
çl£
;

21 
has_¿nge_
 = 
Œue
;

22 
has_bw_
 = 
Œue
;

23 
roÙ_shiá_
 = 
roÙ_shiá
;

25 
cŞl_¬gs
.
mask
 = 0;

26 
cŞl_¬gs
.
æags
 = 0;

27 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_BCAST
;

28 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

29 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

31 ià(
is_³rsi¡’t
) {

32 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

33 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

35 
	}
}

37 
ucc_¡©us_t
 
	gucc_±_cŞl_bÿ¡
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

39 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

40 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
);

41 
ucc_¡©us_t
 
¡
;

43 
cŞl_¬gs
.
roÙ
 = 
‹¡_¬gs
.coll_args.root;

44 
¬gs
 = 
cŞl_¬gs
;

45 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

46 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
¤c_h—d”
,

47 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
,

48 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

49 
ex™
, 
¡
);

50 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

51 
ex™
:

52  
¡
;

53 
	}
}

55 
	gucc_±_cŞl_bÿ¡
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

57 
	`ucc_±_ä“
(
¤c_h—d”
);

58 
	}
}

60 
	gucc_±_cŞl_bÿ¡
::
	$g‘_bw
(
time_ms
, 
grsize
,

61 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

63 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

64 
S
 = 
¬gs
.
¤c
.
šfo
.
couÁ
 *

65 
	`ucc_dt_size
(
¬gs
.
¤c
.
šfo
.
d©©y³
);

67  
S
 / 
time_ms
 / 1000.0;

68 
	}
}

	@tools/perf/ucc_pt_coll_gather.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_g©h”
::
	$ucc_±_cŞl_g©h”
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

14 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
, 
roÙ_shiá
,

15 
ucc_±_comm
 *
communiÿtÜ
,

16 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
):

17 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

19 
has_š¶aû_
 = 
Œue
;

20 
has_»duùiÚ_
 = 
çl£
;

21 
has_¿nge_
 = 
Œue
;

22 
has_bw_
 = 
Œue
;

23 
roÙ_shiá_
 = 
roÙ_shiá
;

25 
cŞl_¬gs
.
mask
 = 0;

26 
cŞl_¬gs
.
æags
 = 0;

27 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_GATHER
;

28 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

29 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

30 
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

31 
cŞl_¬gs
.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

33 ià(
is_š¶aû
) {

34 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

35 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

38 ià(
is_³rsi¡’t
) {

39 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

40 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

42 
	}
}

44 
ucc_¡©us_t
 
	gucc_±_cŞl_g©h”
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

46 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

47 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
);

48 
ucc_¡©us_t
 
¡_¤c
, 
¡_d¡
;

49 
boŞ
 
is_roÙ
;

51 
cŞl_¬gs
.
roÙ
 = 
‹¡_¬gs
.coll_args.root;

52 
¬gs
 = 
cŞl_¬gs
;

53 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_d¡_couÁ
();

54 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

55 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

56 ià(
is_roÙ
 || 
roÙ_shiá_
) {

57 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

58 
g’”©Ü
->
	`g‘_d¡_couÁ
(è* 
dt_size
,

59 
¬gs
.
d¡
.
šfo
.
mem_ty³
),

60 
ex™
, 
¡_d¡
);

61 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
d¡_h—d”
->
addr
;

64 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

65 
	`UCCCHECK_GOTO
(

66 
	`ucc_±_®loc
(&
¤c_h—d”
,

67 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
,

68 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

69 
ä“_d¡
, 
¡_¤c
);

70 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

72  
UCC_OK
;

73 
ä“_d¡
:

74 ià((
is_roÙ
 || 
roÙ_shiá_
è&& 
¡_d¡
 =ğ
UCC_OK
) {

75 
	`ucc_±_ä“
(
d¡_h—d”
);

77  
¡_¤c
;

78 
ex™
:

79  
¡_d¡
;

80 
	}
}

82 
	gucc_±_cŞl_g©h”
::
	$g‘_bw
(
time_ms
, 
grsize
,

83 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

85 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

86 
N
 = 
grsize
 - 1;

87 
S
 = 
¬gs
.
¤c
.
šfo
.
couÁ
 *

88 
	`ucc_dt_size
(
¬gs
.
¤c
.
šfo
.
d©©y³
);

90  (
S
 * 
N
è/ 
time_ms
 / 1000.0;

91 
	}
}

93 
	gucc_±_cŞl_g©h”
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

95 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

96 
boŞ
 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

98 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

99 
	`ucc_±_ä“
(
¤c_h—d”
);

101 ià(
is_roÙ
 || 
roÙ_shiá_
) {

102 
	`ucc_±_ä“
(
d¡_h—d”
);

104 
	}
}

	@tools/perf/ucc_pt_coll_gatherv.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_g©h”v
::
	$ucc_±_cŞl_g©h”v
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
, 
boŞ
 
is_š¶aû
,

15 
boŞ
 
is_³rsi¡’t
, 
roÙ_shiá
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
)

18 : 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

20 
has_š¶aû_
 = 
Œue
;

21 
has_»duùiÚ_
 = 
çl£
;

22 
has_¿nge_
 = 
Œue
;

23 
has_bw_
 = 
çl£
;

24 
roÙ_shiá_
 = 
roÙ_shiá
;

26 
cŞl_¬gs
.
mask
 = 0;

27 
cŞl_¬gs
.
æags
 = 0;

28 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_GATHERV
;

29 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

30 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

31 
cŞl_¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
dt
;

32 
cŞl_¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = 
mt
;

34 ià(
is_š¶aû
) {

35 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

36 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

39 ià(
is_³rsi¡’t
) {

40 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

41 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

43 
	}
}

45 
ucc_¡©us_t
 
	gucc_±_cŞl_g©h”v
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

47 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

48 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
);

49 
ucc_¡©us_t
 
¡
;

50 
boŞ
 
is_roÙ
;

52 
cŞl_¬gs
.
roÙ
 = 
‹¡_¬gs
.coll_args.root;

53 
¬gs
 = 
cŞl_¬gs
;

54 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

55 ià(
is_roÙ
 || 
roÙ_shiá_
) {

56 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = 
g’”©Ü
->
	`g‘_d¡_couÁs
();

57 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = 
g’”©Ü
->
	`g‘_d¡_di¥ls
();

58 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

59 
g’”©Ü
->
	`g‘_d¡_couÁ
(è* 
dt_size
,

60 
¬gs
.
d¡
.
šfo_v
.
mem_ty³
),

61 
ex™
, 
¡
);

62 
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
d¡_h—d”
->
addr
;

65 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

66 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

67 
¡
 = 
	`ucc_±_®loc
(&
¤c_h—d”
,

68 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
,

69 
¬gs
.
¤c
.
šfo
.
mem_ty³
);

70 ià(
UCC_OK
 !ğ
¡
) {

71 
¡d
::
û¼
 << "UCC…”áe¡ƒ¼Ü: " << 
	`ucc_¡©us_¡ršg
(
¡
)

72 << " iÀ" << 
	`STR
(
_ÿÎ
) << "\n";

73 ià(
is_roÙ
 || 
roÙ_shiá_
) {

74 
ä“_d¡
;

76 
ex™
;

79 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

81  
UCC_OK
;

82 
ä“_d¡
:

83 
	`ucc_±_ä“
(
d¡_h—d”
);

84 
ex™
:

85  
¡
;

86 
	}
}

88 
	gucc_±_cŞl_g©h”v
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

90 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

91 
boŞ
 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

93 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

94 
	`ucc_±_ä“
(
¤c_h—d”
);

96 ià(
is_roÙ
 || 
roÙ_shiá_
) {

97 
	`ucc_±_ä“
(
d¡_h—d”
);

99 
	}
}

	@tools/perf/ucc_pt_coll_reduce.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_»duû
::
	$ucc_±_cŞl_»duû
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

14 
ucc_»duùiÚ_İ_t
 
İ
, 
boŞ
 
is_š¶aû
,

15 
boŞ
 
is_³rsi¡’t
, 
roÙ_shiá
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
)

18 : 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

20 
has_š¶aû_
 = 
Œue
;

21 
has_»duùiÚ_
 = 
Œue
;

22 
has_¿nge_
 = 
Œue
;

23 
has_bw_
 = 
Œue
;

24 
roÙ_shiá_
 = 
roÙ_shiá
;

26 
cŞl_¬gs
.
mask
 = 0;

27 
cŞl_¬gs
.
æags
 = 0;

28 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_REDUCE
;

29 
cŞl_¬gs
.
İ
 = op;

30 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

31 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

32 
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

33 
cŞl_¬gs
.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

35 ià(
is_š¶aû
) {

36 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

37 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

40 ià(
is_³rsi¡’t
) {

41 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

42 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

44 
	}
}

46 
ucc_¡©us_t
 
	gucc_±_cŞl_»duû
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

48 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

49 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
);

50 
ucc_¡©us_t
 
¡_¤c
, 
¡_d¡
;

52 
cŞl_¬gs
.
roÙ
 = 
‹¡_¬gs
.coll_args.root;

53 
¬gs
 = 
cŞl_¬gs
;

54 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

55 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_d¡_couÁ
();

56 
boŞ
 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

57 ià(
is_roÙ
 || 
roÙ_shiá_
) {

58 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

59 
g’”©Ü
->
	`g‘_d¡_couÁ
(è* 
dt_size
,

60 
¬gs
.
d¡
.
šfo
.
mem_ty³
),

61 
ex™
, 
¡_d¡
);

62 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
d¡_h—d”
->
addr
;

64 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

65 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
¤c_h—d”
,

66 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
,

67 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

68 
ä“_d¡
, 
¡_¤c
);

69 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

71  
UCC_OK
;

72 
ä“_d¡
:

73 ià((
is_roÙ
 || 
roÙ_shiá_
è&& 
¡_d¡
 =ğ
UCC_OK
) {

74 
	`ucc_±_ä“
(
d¡_h—d”
);

76  
¡_¤c
;

77 
ex™
:

78  
¡_d¡
;

79 
	}
}

81 
	gucc_±_cŞl_»duû
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

83 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

84 
boŞ
 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

86 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

87 
	`ucc_±_ä“
(
¤c_h—d”
);

89 ià(
is_roÙ
 || 
roÙ_shiá_
) {

90 
	`ucc_±_ä“
(
d¡_h—d”
);

92 
	}
}

94 
	gucc_±_cŞl_»duû
::
	$g‘_bw
(
time_ms
, 
grsize
,

95 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

97 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

98 
S
 = 
¬gs
.
¤c
.
šfo
.
couÁ
 *

99 
	`ucc_dt_size
(
¬gs
.
¤c
.
šfo
.
d©©y³
);

101  
S
 / 
time_ms
 / 1000.0;

102 
	}
}

	@tools/perf/ucc_pt_coll_reduce_scatter.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_»duû_sÿ‰”
::
	$ucc_±_cŞl_»duû_sÿ‰”
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
, 
ucc_»duùiÚ_İ_t
 
İ
,

15 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
)

18 : 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

20 
has_š¶aû_
 = 
Œue
;

21 
has_»duùiÚ_
 = 
Œue
;

22 
has_¿nge_
 = 
Œue
;

23 
has_bw_
 = 
Œue
;

24 
roÙ_shiá_
 = 0;

26 
cŞl_¬gs
.
mask
 = 0;

27 
cŞl_¬gs
.
æags
 = 0;

28 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_REDUCE_SCATTER
;

29 
cŞl_¬gs
.
İ
 = op;

30 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

31 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

32 
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

33 
cŞl_¬gs
.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

35 ià(
is_š¶aû
) {

36 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

37 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

40 ià(
is_³rsi¡’t
) {

41 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

42 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

44 
	}
}

46 
ucc_¡©us_t
 
	gucc_±_cŞl_»duû_sÿ‰”
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

48 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

49 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
);

50 
ucc_¡©us_t
 
¡
;

52 
¬gs
 = 
cŞl_¬gs
;

53 
¤c_h—d”
 = 
nuÎ±r
;

54 
d¡_h—d”
 = 
nuÎ±r
;

55 ià(
	`UCC_IS_INPLACE
(
¬gs
)) {

56 
¬gs
.
¤c
.
šfo
.
couÁ
 = 0;

57 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_d¡_couÁ
();

59 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

60 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_d¡_couÁ
();

63 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

64 
g’”©Ü
->
	`g‘_d¡_couÁ
(è* 
dt_size
,

65 
¬gs
.
d¡
.
šfo
.
mem_ty³
),

66 
ex™
, 
¡
);

67 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
d¡_h—d”
->
addr
;

68 ià(
¬gs
.
¤c
.
šfo
.
couÁ
 != 0) {

69 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
¤c_h—d”
,

70 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
,

71 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

72 
ä“_d¡
, 
¡
);

73 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

75  
UCC_OK
;

76 
ä“_d¡
:

77 
	`ucc_±_ä“
(
d¡_h—d”
);

78 
ex™
:

79  
¡
;

80 
	}
}

82 
	gucc_±_cŞl_»duû_sÿ‰”
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

84 ià(
d¡_h—d”
) {

85 
	`ucc_±_ä“
(
d¡_h—d”
);

86 
d¡_h—d”
 = 
nuÎ±r
;

88 ià(
¤c_h—d”
) {

89 
	`ucc_±_ä“
(
¤c_h—d”
);

90 
¤c_h—d”
 = 
nuÎ±r
;

92 
	}
}

94 
	gucc_±_cŞl_»duû_sÿ‰”
::
	$g‘_bw
(
time_ms
, 
grsize
,

95 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

97 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

98 
N
 = 
grsize
;

99 
size_t
 
couÁ
 = 
	`UCC_IS_INPLACE
(
¬gs
è?‡rgs.
d¡
.
šfo
.count :

100 
¬gs
.
¤c
.
šfo
.
couÁ
;

101 
S
 = 
couÁ
 * 
	`ucc_dt_size
(
¬gs
.
d¡
.
šfo
.
d©©y³
);

103  (
S
 / 
time_ms
è* ((
N
 - 1) / N) / 1000.0;

104 
	}
}

	@tools/perf/ucc_pt_coll_reduce_scatterv.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_»duû_sÿ‰”v
::
	$ucc_±_cŞl_»duû_sÿ‰”v
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
, 
ucc_»duùiÚ_İ_t
 
İ
,

15 
boŞ
 
is_š¶aû
, boŞ 
is_³rsi¡’t
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
)

18 : 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

20 
has_š¶aû_
 = 
Œue
;

21 
has_»duùiÚ_
 = 
Œue
;

22 
has_¿nge_
 = 
Œue
;

23 
has_bw_
 = 
çl£
;

24 
roÙ_shiá_
 = 0;

26 
cŞl_¬gs
.
mask
 = 0;

27 
cŞl_¬gs
.
æags
 = 0;

28 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_REDUCE_SCATTERV
;

29 
cŞl_¬gs
.
İ
 = op;

30 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

31 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

32 
cŞl_¬gs
.
d¡
.
šfo_v
.
d©©y³
 = 
dt
;

33 
cŞl_¬gs
.
d¡
.
šfo_v
.
mem_ty³
 = 
mt
;

35 ià(
is_š¶aû
) {

36 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

37 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

40 ià(
is_³rsi¡’t
) {

41 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

42 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

44 
	}
}

46 
ucc_¡©us_t
 
	gucc_±_cŞl_»duû_sÿ‰”v
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

48 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

49 
tsize
 = 
comm
->
	`g‘_size
();

50 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
d¡
.
šfo_v
.
d©©y³
);

51 
ucc_couÁ_t
 *
couÁs
;

52 
ucc_ašt_t
 *
di¥ls
;

53 
ucc_¡©us_t
 
¡
;

54 
size_t
 
size_¤c
, 
size_d¡
;

57 
¬gs
 = 
cŞl_¬gs
;

58 
¤c_h—d”
 = 
nuÎ±r
;

59 
d¡_h—d”
 = 
nuÎ±r
;

60 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = 
nuÎ±r
;

61 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = 
nuÎ±r
;

63 ià(
	`UCC_IS_INPLACE
(
¬gs
)) {

64 
size_¤c
 = 0;

65 
size_d¡
 = 
tsize
 * 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
;

67 
size_¤c
 = 
tsize
 * 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
;

68 
size_d¡
 = 
g’”©Ü
->
	`g‘_d¡_couÁ
(è* 
dt_size
;

70 
couÁs
 = 
g’”©Ü
->
	`g‘_d¡_couÁs
();

71 
di¥ls
 = 
g’”©Ü
->
	`g‘_d¡_di¥ls
();

73 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
, 
size_d¡
, 
¬gs
.
d¡
.
šfo_v
.
mem_ty³
),

74 
ex™
, 
¡
);

75 
¬gs
.
d¡
.
šfo_v
.
bufãr
 = 
d¡_h—d”
->
addr
;

76 ià(!
	`UCC_IS_INPLACE
(
¬gs
)) {

77 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

78 
	`UCCCHECK_GOTO
(

79 
	`ucc_±_®loc
(&
¤c_h—d”
, 
size_¤c
, 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

80 
ä“_d¡
, 
¡
);

81 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

84 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = counts;

85 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = 
di¥ls
;

87  
UCC_OK
;

89 
ä“_d¡
:

90 
	`ucc_±_ä“
(
d¡_h—d”
);

91 
ex™
:

92 
¤c_h—d”
 = 
nuÎ±r
;

93 
d¡_h—d”
 = 
nuÎ±r
;

94 
¬gs
.
d¡
.
šfo_v
.
couÁs
 = 
nuÎ±r
;

95 
¬gs
.
d¡
.
šfo_v
.
di¥Ïûm’ts
 = 
nuÎ±r
;

96  
¡
;

97 
	}
}

99 
	gucc_±_cŞl_»duû_sÿ‰”v
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

101 ià(
d¡_h—d”
) {

102 
	`ucc_±_ä“
(
d¡_h—d”
);

103 
d¡_h—d”
 = 
nuÎ±r
;

105 ià(
¤c_h—d”
) {

106 
	`ucc_±_ä“
(
¤c_h—d”
);

107 
¤c_h—d”
 = 
nuÎ±r
;

109 
	}
}

	@tools/perf/ucc_pt_coll_scatter.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_sÿ‰”
::
	$ucc_±_cŞl_sÿ‰”
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
, 
boŞ
 
is_š¶aû
,

15 
boŞ
 
is_³rsi¡’t
, 
roÙ_shiá
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
)

18 : 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

20 
has_š¶aû_
 = 
Œue
;

21 
has_»duùiÚ_
 = 
çl£
;

22 
has_¿nge_
 = 
Œue
;

23 
has_bw_
 = 
Œue
;

24 
roÙ_shiá_
 = 
roÙ_shiá
;

26 
cŞl_¬gs
.
mask
 = 0;

27 
cŞl_¬gs
.
æags
 = 0;

28 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_SCATTER
;

29 
cŞl_¬gs
.
¤c
.
šfo
.
d©©y³
 = 
dt
;

30 
cŞl_¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
mt
;

31 
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

32 
cŞl_¬gs
.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

34 ià(
is_š¶aû
) {

35 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

36 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

39 ià(
is_³rsi¡’t
) {

40 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

41 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

43 
	}
}

45 
ucc_¡©us_t
 
	gucc_±_cŞl_sÿ‰”
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

47 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

48 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
);

49 
ucc_¡©us_t
 
¡_¤c
 = 
UCC_OK
, 
¡_d¡
 = UCC_OK;

50 
boŞ
 
is_roÙ
;

52 
cŞl_¬gs
.
roÙ
 = 
‹¡_¬gs
.coll_args.root;

53 
¬gs
 = 
cŞl_¬gs
;

54 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_d¡_couÁ
();

55 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

56 ià(
is_roÙ
 || 
roÙ_shiá_
) {

57 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

58 
	`UCCCHECK_GOTO
(

59 
	`ucc_±_®loc
(&
¤c_h—d”
,

60 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
,

61 
¬gs
.
¤c
.
šfo
.
mem_ty³
),

62 
ex™
, 
¡_¤c
);

63 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
¤c_h—d”
->
addr
;

65 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

66 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

67 
g’”©Ü
->
	`g‘_d¡_couÁ
(è* 
dt_size
,

68 
¬gs
.
d¡
.
šfo
.
mem_ty³
),

69 
ä“_¤c
, 
¡_d¡
);

70 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
d¡_h—d”
->
addr
;

72  
UCC_OK
;

73 
ä“_¤c
:

74 ià((
is_roÙ
 || 
roÙ_shiá_
è&& 
¡_¤c
 =ğ
UCC_OK
) {

75 
	`ucc_±_ä“
(
¤c_h—d”
);

77  
¡_d¡
;

78 
ex™
:

79  
¡_¤c
;

80 
	}
}

82 
	gucc_±_cŞl_sÿ‰”
::
	$g‘_bw
(
time_ms
, 
grsize
,

83 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

85 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

86 
S
 = 
¬gs
.
d¡
.
šfo
.
couÁ
 * 
	`ucc_dt_size
×rgs.d¡.šfo.
d©©y³
);

87 
N
 = 
grsize
 - 1;

89  (
S
 * 
N
è/ 
time_ms
 / 1000.0;

90 
	}
}

92 
	gucc_±_cŞl_sÿ‰”
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

94 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

95 
boŞ
 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

97 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

98 
	`ucc_±_ä“
(
d¡_h—d”
);

100 ià(
is_roÙ
 || 
roÙ_shiá_
) {

101 
	`ucc_±_ä“
(
¤c_h—d”
);

103 
	}
}

	@tools/perf/ucc_pt_coll_scatterv.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_cŞl_sÿ‰”v
::
	$ucc_±_cŞl_sÿ‰”v
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
, 
boŞ
 
is_š¶aû
,

15 
boŞ
 
is_³rsi¡’t
, 
roÙ_shiá
,

16 
ucc_±_comm
 *
communiÿtÜ
,

17 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
)

18 : 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

20 
has_š¶aû_
 = 
Œue
;

21 
has_»duùiÚ_
 = 
çl£
;

22 
has_¿nge_
 = 
Œue
;

23 
has_bw_
 = 
çl£
;

24 
roÙ_shiá_
 = 
roÙ_shiá
;

26 
cŞl_¬gs
.
mask
 = 0;

27 
cŞl_¬gs
.
æags
 = 0;

28 
cŞl_¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_SCATTERV
;

29 
cŞl_¬gs
.
¤c
.
šfo_v
.
d©©y³
 = 
dt
;

30 
cŞl_¬gs
.
¤c
.
šfo_v
.
mem_ty³
 = 
mt
;

31 
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
 = 
dt
;

32 
cŞl_¬gs
.
d¡
.
šfo
.
mem_ty³
 = 
mt
;

34 ià(
is_š¶aû
) {

35 
cŞl_¬gs
.
mask
 = 
UCC_COLL_ARGS_FIELD_FLAGS
;

36 
cŞl_¬gs
.
æags
 = 
UCC_COLL_ARGS_FLAG_IN_PLACE
;

39 ià(
is_³rsi¡’t
) {

40 
cŞl_¬gs
.
mask
 |ğ
UCC_COLL_ARGS_FIELD_FLAGS
;

41 
cŞl_¬gs
.
æags
 |ğ
UCC_COLL_ARGS_FLAG_PERSISTENT
;

43 
	}
}

45 
ucc_¡©us_t
 
	gucc_±_cŞl_sÿ‰”v
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

47 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

48 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
cŞl_¬gs
.
d¡
.
šfo
.
d©©y³
);

49 
ucc_¡©us_t
 
¡
;

50 
boŞ
 
is_roÙ
;

52 
cŞl_¬gs
.
roÙ
 = 
‹¡_¬gs
.coll_args.root;

53 
¬gs
 = 
cŞl_¬gs
;

54 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

55 ià(
is_roÙ
 || 
roÙ_shiá_
) {

56 
¬gs
.
¤c
.
šfo_v
.
couÁs
 = 
g’”©Ü
->
	`g‘_¤c_couÁs
();

57 
¬gs
.
¤c
.
šfo_v
.
di¥Ïûm’ts
 = 
g’”©Ü
->
	`g‘_¤c_di¥ls
();

58 
	`UCCCHECK_GOTO
(

59 
	`ucc_±_®loc
(&
¤c_h—d”
,

60 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
,

61 
¬gs
.
¤c
.
šfo_v
.
mem_ty³
),

62 
ex™
, 
¡
);

63 
¬gs
.
¤c
.
šfo_v
.
bufãr
 = 
¤c_h—d”
->
addr
;

65 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

66 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
g’”©Ü
->
	`g‘_d¡_couÁ
();

67 
¡
 = 
	`ucc_±_®loc
(&
d¡_h—d”
,

68 
g’”©Ü
->
	`g‘_d¡_couÁ
(è* 
dt_size
,

69 
¬gs
.
d¡
.
šfo
.
mem_ty³
);

70 ià(
UCC_OK
 !ğ
¡
) {

71 
¡d
::
û¼
 << "UCC…”áe¡ƒ¼Ü: " << 
	`ucc_¡©us_¡ršg
(
¡
)

72 << " iÀ" << 
	`STR
(
_ÿÎ
) << "\n";

73 ià(
is_roÙ
 || 
roÙ_shiá_
) {

74 
ä“_¤c
;

76 
ex™
;

79 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
d¡_h—d”
->
addr
;

80  
UCC_OK
;

82 
ä“_¤c
:

83 
	`ucc_±_ä“
(
¤c_h—d”
);

84 
ex™
:

85  
¡
;

86 
	}
}

88 
	gucc_±_cŞl_sÿ‰”v
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

90 
ucc_cŞl_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
cŞl_¬gs
;

91 
boŞ
 
is_roÙ
 = (
comm
->
	`g‘_¿nk
(è=ğ
¬gs
.
roÙ
);

93 ià(!
is_roÙ
 || !
	`UCC_IS_INPLACE
(
¬gs
è|| 
roÙ_shiá_
) {

94 
	`ucc_±_ä“
(
d¡_h—d”
);

96 ià(
is_roÙ
 || 
roÙ_shiá_
) {

97 
	`ucc_±_ä“
(
¤c_h—d”
);

99 
	}
}

	@tools/perf/ucc_pt_comm.cc

1 
	~<ios
>

2 
	~<io¡»am
>

3 
	~<c¡ršg
>

4 
	~<iomª
>

5 
	~"ucc_±_comm.h
"

6 
	~"ucc_±_boÙ¡¿p_mpi.h
"

7 
	~"ucc_³ráe¡.h
"

8 
	~"ucc_±_cuda.h
"

9 
	~"ucc_±_rocm.h
"

11 
	~"uts/ucc_cŞl_uts.h
"

12 
	~"compÚ’ts/mc/ucc_mc.h
"

15 
ucc_±_comm
::
	$ucc_±_comm
(
ucc_±_comm_cÚfig
 
cÚfig
)

17 
cfg
 = 
cÚfig
;

18 
boÙ¡¿p
 = 
Ãw
 
	`ucc_±_boÙ¡¿p_mpi
();

19 
	}
}

21 
ucc_±_comm
::~
	$ucc_±_comm
()

23 
d–‘e
 
boÙ¡¿p
;

24 
	}
}

26 
ucc_±_comm
::
	$£t_gpu_deviû
()

28 
dev_couÁ
 = 0;

30 ià(
	`ucc_±_cudaG‘DeviûCouÁ
(&
dev_couÁ
) == 0 && dev_count != 0) {

31 
dev
 = 
boÙ¡¿p
->
	`g‘_loÿl_¿nk
(è% 
dev_couÁ
;

32 
	`ucc_±_cudaS‘Deviû
(
dev
);

33 
¡d
::
¡ršg
 
šfo
;

34 
	`ucc_±_cudaG‘DeviûInfo
(
dev
, 
šfo
);

35 
¡d
::
cout
 << std::
Ëá
 << std::
	`£tw
(8) << "Rank "

36 << 
¡d
::
	`£tw
(8è<< 
boÙ¡¿p
->
	`g‘_¿nk
(è<< ": " << 
šfo


37 << 
¡d
::
’dl
;

38 
¡d
::
cout
 << std::
right
;

42 ià(
	`ucc_±_rocmG‘DeviûCouÁ
(&
dev_couÁ
) == 0 && dev_count != 0) {

43 
	`ucc_±_rocmS‘Deviû
(
boÙ¡¿p
->
	`g‘_loÿl_¿nk
(è% 
dev_couÁ
);

47 
	}
}

49 
ucc_±_comm
::
	$g‘_¿nk
()

51  
boÙ¡¿p
->
	`g‘_¿nk
();

52 
	}
}

54 
ucc_±_comm
::
	$g‘_size
()

56  
boÙ¡¿p
->
	`g‘_size
();

57 
	}
}

59 
ucc_“_h
 
ucc_±_comm
::
	$g‘_“
()

61 
ucc_“_·¿ms_t
 
“_·¿ms
;

62 
ucc_¡©us_t
 
¡©us
;

64 ià(!
“
) {

65 ià(
cfg
.
mt
 =ğ
UCC_MEMORY_TYPE_CUDA
) {

66 ià(
	`ucc_±_cudaSŒ—mC»©eW™hFÏgs
((
cudaSŒ—m_t
*)&
¡»am
,

67 
cudaSŒ—mNÚBlockšg
)) {

68 
throw
 
¡d
::
	`ruÁime_”rÜ
("failedo create CUDA stream");

70 
“_·¿ms
.
“_ty³
 = 
UCC_EE_CUDA_STREAM
;

71 
“_·¿ms
.
“_cÚ‹xt_size
 = (
cudaSŒ—m_t
);

72 
“_·¿ms
.
“_cÚ‹xt
 = 
¡»am
;

73 
¡©us
 = 
	`ucc_“_ü—‹
(
‹am
, &
“_·¿ms
, &
“
);

74 ià(
¡©us
 !ğ
UCC_OK
) {

75 
¡d
::
û¼
 << "failedo create UCC EE: "

76 << 
	`ucc_¡©us_¡ršg
(
¡©us
);

77 
	`ucc_±_cudaSŒ—mDe¡roy
((
cudaSŒ—m_t
)
¡»am
);

78 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`ucc_¡©us_¡ršg
(
¡©us
));

81 
¡d
::
û¼
 << "executionƒngine is‚ot supported for given memoryype"

82 << 
¡d
::
’dl
;

83 
throw
 
¡d
::
	`ruÁime_”rÜ
("not supported");

87  
“
;

88 
	}
}

90 
ucc_“_executÜ_t
* 
ucc_±_comm
::
	$g‘_executÜ
()

92 
ucc_“_executÜ_·¿ms_t
 
executÜ_·¿ms
;

93 
ucc_¡©us_t
 
¡©us
;

95 ià(!
executÜ
) {

96 
executÜ_·¿ms
.
mask
 = 
UCC_EE_EXECUTOR_PARAM_FIELD_TYPE
;

97 ià(
cfg
.
mt
 =ğ
UCC_MEMORY_TYPE_HOST
) {

98 
executÜ_·¿ms
.
“_ty³
 = 
UCC_EE_CPU_THREAD
;

99 } ià(
cfg
.
mt
 =ğ
UCC_MEMORY_TYPE_CUDA
) {

100 
executÜ_·¿ms
.
“_ty³
 = 
UCC_EE_CUDA_STREAM
;

101 } ià(
cfg
.
mt
 =ğ
UCC_MEMORY_TYPE_ROCM
) {

102 
executÜ_·¿ms
.
“_ty³
 = 
UCC_EE_ROCM_STREAM
;

104 
¡d
::
û¼
 << "executor is‚ot supported for given memoryype"

105 << 
¡d
::
’dl
;

106 
throw
 
¡d
::
	`ruÁime_”rÜ
("not supported");

108 
¡©us
 = 
	`ucc_“_executÜ_š™
(&
executÜ_·¿ms
, &
executÜ
);

109 ià(
¡©us
 !ğ
UCC_OK
) {

110 
throw
 
¡d
::
	`ruÁime_”rÜ
("failedo initƒxecutor");

113  
executÜ
;

114 
	}
}

116 
ucc_‹am_h
 
ucc_±_comm
::
	$g‘_‹am
()

118  
‹am
;

119 
	}
}

121 
ucc_cÚ‹xt_h
 
ucc_±_comm
::
	$g‘_cÚ‹xt
()

123  
cÚ‹xt
;

124 
	}
}

126 
ucc_¡©us_t
 
ucc_±_comm
::
	$š™
()

128 
ucc_lib_cÚfig_h
 
lib_cÚfig
;

129 
ucc_cÚ‹xt_cÚfig_h
 
ùx_cÚfig
;

130 
ucc_lib_·¿ms_t
 
lib_·¿ms
;

131 
ucc_cÚ‹xt_·¿ms_t
 
ùx_·¿ms
;

132 
ucc_‹am_·¿ms_t
 
‹am_·¿ms
;

133 
ucc_¡©us_t
 
¡
;

134 
¡d
::
¡ršg
 
cfg_mod
;

136 
“
 = 
nuÎ±r
;

137 
executÜ
 = 
nuÎ±r
;

138 
¡»am
 = 
nuÎ±r
;

140 ià(
cfg
.
mt
 !ğ
UCC_MEMORY_TYPE_HOST
) {

141 
	`£t_gpu_deviû
();

143 
	`UCCCHECK_GOTO
(
	`ucc_lib_cÚfig_»ad
("PERFTEST", 
nuÎ±r
, &
lib_cÚfig
),

144 
ex™_”r
, 
¡
);

145 
¡d
::
	`mem£t
(&
lib_·¿ms
, 0, (
ucc_lib_·¿ms_t
));

146 
lib_·¿ms
.
mask
 = 
UCC_LIB_PARAM_FIELD_THREAD_MODE
;

147 
lib_·¿ms
.
th»ad_mode
 = 
UCC_THREAD_SINGLE
;

148 
	`UCCCHECK_GOTO
(
	`ucc_š™
(&
lib_·¿ms
, 
lib_cÚfig
, &
lib
), 
ä“_lib_cÚfig
, 
¡
);

150 ià(
UCC_OK
 !ğ
	`ucc_mc_avaabË
(
cfg
.
mt
)) {

151 
¡d
::
û¼
 << "£Ëùed memÜyy³ " << 
	`ucc_mem_ty³_¡r
(
cfg
.
mt
) <<

152 " i nÙ‡vaabË" << 
¡d
::
’dl
;

153  
UCC_ERR_INVALID_PARAM
;

156 
	`UCCCHECK_GOTO
(
	`ucc_cÚ‹xt_cÚfig_»ad
(
lib
, 
NULL
, &
ùx_cÚfig
),

157 
ä“_lib
, 
¡
);

158 
cfg_mod
 = 
¡d
::
	`to_¡ršg
(
boÙ¡¿p
->
	`g‘_size
());

159 
	`UCCCHECK_GOTO
(
	`ucc_cÚ‹xt_cÚfig_modify
(
ùx_cÚfig
, 
NULL
,

160 "ESTIMATED_NUM_EPS", 
cfg_mod
.
	`c_¡r
()), 
ä“_ùx_cÚfig
, 
¡
);

161 
cfg_mod
 = 
¡d
::
	`to_¡ršg
(
boÙ¡¿p
->
	`g‘_µn
());

162 
	`UCCCHECK_GOTO
(
	`ucc_cÚ‹xt_cÚfig_modify
(
ùx_cÚfig
, 
NULL
,

163 "ESTIMATED_NUM_PPN", 
cfg_mod
.
	`c_¡r
()), 
ä“_ùx_cÚfig
, 
¡
);

164 
¡d
::
	`mem£t
(&
ùx_·¿ms
, 0, (
ucc_cÚ‹xt_·¿ms_t
));

165 
ùx_·¿ms
.
mask
 = 
UCC_CONTEXT_PARAM_FIELD_TYPE
 |

166 
UCC_CONTEXT_PARAM_FIELD_OOB
;

167 
ùx_·¿ms
.
ty³
 = 
UCC_CONTEXT_SHARED
;

168 
ùx_·¿ms
.
oob
 = 
boÙ¡¿p
->
	`g‘_cÚ‹xt_oob
();

169 
	`UCCCHECK_GOTO
(
	`ucc_cÚ‹xt_ü—‹
(
lib
, &
ùx_·¿ms
, 
ùx_cÚfig
, &
cÚ‹xt
),

170 
ä“_ùx_cÚfig
, 
¡
);

171 
‹am_·¿ms
.
mask
 = 
UCC_TEAM_PARAM_FIELD_EP
 |

172 
UCC_TEAM_PARAM_FIELD_EP_RANGE
 |

173 
UCC_TEAM_PARAM_FIELD_OOB
;

174 
‹am_·¿ms
.
oob
 = 
boÙ¡¿p
->
	`g‘_‹am_oob
();

175 
‹am_·¿ms
.
•
 = 
boÙ¡¿p
->
	`g‘_¿nk
();

176 
‹am_·¿ms
.
•_¿nge
 = 
UCC_COLLECTIVE_EP_RANGE_CONTIG
;

177 
	`UCCCHECK_GOTO
(
	`ucc_‹am_ü—‹_po¡
(&
cÚ‹xt
, 1, &
‹am_·¿ms
, &
‹am
),

178 
ä“_ùx
, 
¡
);

180 
¡
 = 
	`ucc_‹am_ü—‹_‹¡
(
‹am
);

181 ià(
¡
 =ğ
UCC_INPROGRESS
) {

182 
	`ucc_cÚ‹xt_´og»ss
(
cÚ‹xt
);

184 } 
¡
 =ğ
UCC_INPROGRESS
);

185 
	`UCCCHECK_GOTO
(
¡
, 
ä“_ùx
, st);

186 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

187 
	`ucc_lib_cÚfig_»Ëa£
(
lib_cÚfig
);

188  
UCC_OK
;

189 
ä“_ùx
:

190 
	`ucc_cÚ‹xt_de¡roy
(
cÚ‹xt
);

191 
ä“_ùx_cÚfig
:

192 
	`ucc_cÚ‹xt_cÚfig_»Ëa£
(
ùx_cÚfig
);

193 
ä“_lib
:

194 
	`ucc_fš®ize
(
lib
);

195 
ä“_lib_cÚfig
:

196 
	`ucc_lib_cÚfig_»Ëa£
(
lib_cÚfig
);

197 
ex™_”r
:

198  
¡
;

199 
	}
}

201 
ucc_¡©us_t
 
ucc_±_comm
::
	$fš®ize
()

203 
ucc_¡©us_t
 
¡©us
;

205 ià(
“
) {

206 
¡©us
 = 
	`ucc_“_de¡roy
(
“
);

207 ià(
¡©us
 !ğ
UCC_OK
) {

208 
¡d
::
û¼
 << "ucø“ de¡royƒ¼Ü: " << 
	`ucc_¡©us_¡ršg
(
¡©us
);

211 ià(
cfg
.
mt
 =ğ
UCC_MEMORY_TYPE_CUDA
) {

212 
	`ucc_±_cudaSŒ—mDe¡roy
((
cudaSŒ—m_t
)
¡»am
);

214 
¡d
::
û¼
 << "executionƒngine is‚ot supported for given memoryype"

215 << 
¡d
::
’dl
;

216 
throw
 
¡d
::
	`ruÁime_”rÜ
("not supported");

220 ià(
executÜ
) {

221 
¡©us
 = 
	`ucc_“_executÜ_fš®ize
(
executÜ
);

222 ià(
¡©us
 !ğ
UCC_OK
) {

223 
¡d
::
û¼
 << "uccƒxecutor finalizeƒrror: "

224 << 
	`ucc_¡©us_¡ršg
(
¡©us
);

229 
¡©us
 = 
	`ucc_‹am_de¡roy
(
‹am
);

230 ià(
¡©us
 =ğ
UCC_INPROGRESS
) {

231 
	`ucc_cÚ‹xt_´og»ss
(
cÚ‹xt
);

233 } 
¡©us
 =ğ
UCC_INPROGRESS
);

234 ià(
¡©us
 !ğ
UCC_OK
) {

235 
¡d
::
û¼
 << "ucø‹am de¡royƒ¼Ü: " << 
	`ucc_¡©us_¡ršg
(
¡©us
);

237 
	`ucc_cÚ‹xt_de¡roy
(
cÚ‹xt
);

238 
	`ucc_fš®ize
(
lib
);

239  
UCC_OK
;

240 
	}
}

242 
ucc_¡©us_t
 
ucc_±_comm
::
	$b¬r›r
()

244 
ucc_cŞl_¬gs_t
 
¬gs
;

245 
ucc_cŞl_»q_h
 
»q
;

247 
¬gs
.
mask
 = 0;

248 
¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_BARRIER
;

249 
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
);

250 
	`ucc_cŞËùive_po¡
(
»q
);

252 
	`ucc_cÚ‹xt_´og»ss
(
cÚ‹xt
);

253 } 
	`ucc_cŞËùive_‹¡
(
»q
è=ğ
UCC_INPROGRESS
);

254 
	`ucc_cŞËùive_fš®ize
(
»q
);

255  
UCC_OK
;

256 
	}
}

258 
ucc_¡©us_t
 
ucc_±_comm
::
	$®Ìeduû
(* 
š
, * 
out
, 
size_t
 
size
,

259 
ucc_»duùiÚ_İ_t
 
İ
)

261 
ucc_cŞl_¬gs_t
 
¬gs
;

262 
ucc_cŞl_»q_h
 
»q
;

264 
¬gs
.
mask
 = 0;

265 
¬gs
.
cŞl_ty³
 = 
UCC_COLL_TYPE_ALLREDUCE
;

266 
¬gs
.
İ
 = op;

267 
¬gs
.
¤c
.
šfo
.
bufãr
 = 
š
;

268 
¬gs
.
¤c
.
šfo
.
couÁ
 = 
size
;

269 
¬gs
.
¤c
.
šfo
.
d©©y³
 = 
UCC_DT_FLOAT64
;

270 
¬gs
.
¤c
.
šfo
.
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

271 
¬gs
.
d¡
.
šfo
.
bufãr
 = 
out
;

272 
¬gs
.
d¡
.
šfo
.
couÁ
 = 
size
;

273 
¬gs
.
d¡
.
šfo
.
d©©y³
 = 
UCC_DT_FLOAT64
;

274 
¬gs
.
d¡
.
šfo
.
mem_ty³
 = 
UCC_MEMORY_TYPE_HOST
;

275 
	`ucc_cŞËùive_š™
(&
¬gs
, &
»q
, 
‹am
);

276 
	`ucc_cŞËùive_po¡
(
»q
);

278 
	`ucc_cÚ‹xt_´og»ss
(
cÚ‹xt
);

279 } 
	`ucc_cŞËùive_‹¡
(
»q
è=ğ
UCC_INPROGRESS
);

280 
	`ucc_cŞËùive_fš®ize
(
»q
);

281  
UCC_OK
;

282 
	}
}

	@tools/perf/ucc_pt_comm.h

7 #iâdeà
UCC_PT_COMM_H


8 
	#UCC_PT_COMM_H


	)

10 
	~<ucc/­i/ucc.h
>

11 
	~"ucc_±_cÚfig.h
"

12 
	~"ucc_±_boÙ¡¿p.h
"

13 
	~"ucc_±_boÙ¡¿p_mpi.h
"

15 
	~"compÚ’ts/ec/ucc_ec.h
"

18 şas 
	cucc_±_comm
 {

19 
ucc_±_comm_cÚfig
 
cfg
;

20 
ucc_lib_h
 
lib
;

21 
ucc_cÚ‹xt_h
 
cÚ‹xt
;

22 
ucc_‹am_h
 
‹am
;

23 *
¡»am
;

24 
ucc_“_h
 
“
;

25 
ucc_“_executÜ_t
 *
executÜ
;

26 
ucc_±_boÙ¡¿p
 *
boÙ¡¿p
;

27 
£t_gpu_deviû
();

28 
public
:

29 
ucc_±_comm
(
ucc_±_comm_cÚfig
 
cÚfig
);

30 
g‘_¿nk
();

31 
g‘_size
();

32 
ucc_“_executÜ_t
* 
g‘_executÜ
();

33 
ucc_“_h
 
g‘_“
();

34 
ucc_‹am_h
 
g‘_‹am
();

35 
ucc_cÚ‹xt_h
 
g‘_cÚ‹xt
();

36 ~
ucc_±_comm
();

37 
ucc_¡©us_t
 
š™
();

38 
ucc_¡©us_t
 
b¬r›r
();

39 
ucc_¡©us_t
 
®Ìeduû
(* 
š
, *
out
, 
size_t
 
size
,

40 
ucc_»duùiÚ_İ_t
 
İ
);

41 
ucc_¡©us_t
 
fš®ize
();

	@tools/perf/ucc_pt_config.cc

7 
	~"ucc_±_cÚfig.h
"

8 
	gBEGIN_C_DECLS


9 
	~"uts/ucc_¡ršg.h
"

10 
	~<g‘İt.h
>

11 
END_C_DECLS


13 
	gucc_±_cÚfig
::
	$ucc_±_cÚfig
() {

14 
boÙ¡¿p
.boÙ¡¿°ğ
UCC_PT_BOOTSTRAP_MPI
;

15 
b’ch
.
İ_ty³
 = 
UCC_PT_OP_TYPE_ALLREDUCE
;

16 
b’ch
.
mš_couÁ
 = 128;

17 
b’ch
.
max_couÁ
 = 128;

18 
b’ch
.
dt
 = 
UCC_DT_FLOAT32
;

19 
b’ch
.
mt
 = 
UCC_MEMORY_TYPE_HOST
;

20 
b’ch
.
İ
 = 
UCC_OP_SUM
;

21 
b’ch
.
š¶aû
 = 
çl£
;

22 
b’ch
.
³rsi¡’t
 = 
çl£
;

23 
b’ch
.
Œigg”ed
 = 
çl£
;

24 
b’ch
.
n_™”_sm®l
 = 1000;

25 
b’ch
.
n_w¬mup_sm®l
 = 100;

26 
b’ch
.
n_™”_Ïrge
 = 200;

27 
b’ch
.
n_w¬mup_Ïrge
 = 20;

28 
b’ch
.
Ïrge_th»sh
 = 64 * 1024;

29 
b’ch
.
fuÎ_´št
 = 
çl£
;

30 
b’ch
.
n_bufs
 = 
UCC_PT_DEFAULT_N_BUFS
;

31 
b’ch
.
roÙ
 = 0;

32 
b’ch
.
roÙ_shiá
 = 0;

33 
b’ch
.
muÉ_çùÜ
 = 2;

34 
comm
.
mt
 = 
b’ch
.mt;

35 
	}
}

37 cÚ¡ 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gucc_»duùiÚ_İ_t
> 
	gucc_±_»duùiÚ_İ_m­
 = {

38 {"sum", 
UCC_OP_SUM
}, {"´od", 
UCC_OP_PROD
}, {"mš", 
UCC_OP_MIN
},

39 {"max", 
UCC_OP_MAX
}, {"avg", 
UCC_OP_AVG
},

42 cÚ¡ 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gucc_±_İ_ty³_t
> 
	gucc_±_İ_m­
 = {

43 {"®lg©h”", 
UCC_PT_OP_TYPE_ALLGATHER
},

44 {"®lg©h”v", 
UCC_PT_OP_TYPE_ALLGATHERV
},

45 {"®Ìeduû", 
UCC_PT_OP_TYPE_ALLREDUCE
},

46 {"®ÉßÎ", 
UCC_PT_OP_TYPE_ALLTOALL
},

47 {"®ÉßÎv", 
UCC_PT_OP_TYPE_ALLTOALLV
},

48 {"b¬r›r", 
UCC_PT_OP_TYPE_BARRIER
},

49 {"bÿ¡", 
UCC_PT_OP_TYPE_BCAST
},

50 {"g©h”", 
UCC_PT_OP_TYPE_GATHER
},

51 {"g©h”v", 
UCC_PT_OP_TYPE_GATHERV
},

52 {"»duû", 
UCC_PT_OP_TYPE_REDUCE
},

53 {"»duû_sÿ‰”", 
UCC_PT_OP_TYPE_REDUCE_SCATTER
},

54 {"»duû_sÿ‰”v", 
UCC_PT_OP_TYPE_REDUCE_SCATTERV
},

55 {"sÿ‰”", 
UCC_PT_OP_TYPE_SCATTER
},

56 {"sÿ‰”v", 
UCC_PT_OP_TYPE_SCATTERV
},

57 {"memıy", 
UCC_PT_OP_TYPE_MEMCPY
},

58 {"»duûdt", 
UCC_PT_OP_TYPE_REDUCEDT
},

59 {"»duûdt_¡rided", 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
},

62 cÚ¡ 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gucc_memÜy_ty³_t
> 
	gucc_±_memty³_m­
 = {

63 {"ho¡", 
UCC_MEMORY_TYPE_HOST
},

64 {"cuda", 
UCC_MEMORY_TYPE_CUDA
},

65 {"rocm", 
UCC_MEMORY_TYPE_ROCM
},

66 {"cuda-mng", 
UCC_MEMORY_TYPE_CUDA_MANAGED
},

69 cÚ¡ 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gucc_d©©y³_t
> 
	gucc_±_d©©y³_m­
 = {

70 {"št8", 
UCC_DT_INT8
},

71 {"ušt8", 
UCC_DT_UINT8
},

72 {"št16", 
UCC_DT_INT16
},

73 {"ušt16", 
UCC_DT_UINT16
},

74 {"æßt16", 
UCC_DT_FLOAT16
},

75 {"bæßt16", 
UCC_DT_BFLOAT16
},

76 {"št32", 
UCC_DT_INT32
},

77 {"ušt32", 
UCC_DT_UINT32
},

78 {"æßt32", 
UCC_DT_FLOAT32
},

79 {"æßt32_com¶ex", 
UCC_DT_FLOAT32_COMPLEX
},

80 {"št64", 
UCC_DT_INT64
},

81 {"ušt64", 
UCC_DT_UINT64
},

82 {"æßt64", 
UCC_DT_FLOAT64
},

83 {"æßt64_com¶ex", 
UCC_DT_FLOAT64_COMPLEX
},

84 {"št128", 
UCC_DT_INT128
},

85 {"ušt128", 
UCC_DT_UINT128
},

86 {"æßt128", 
UCC_DT_FLOAT64
},

87 {"æßt128_com¶ex", 
UCC_DT_FLOAT128_COMPLEX
},

90 
ucc_¡©us_t
 
	gucc_±_cÚfig
::
	$´oûss_¬gs
(
¬gc
, *
¬gv
[])

92 
c
;

93 
ucc_¡©us_t
 
¡
;

94 
İtiÚ_šdex
 = 0;

95 
İtiÚ
 
lÚg_İtiÚs
[] = {

96 {"g’", 
»quœed_¬gum’t
, 0, 0},

101 
İtšd
 = 1;

104 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, "c:b:e:d:f:m:n:w:o:N:r:S:hFT", 
lÚg_İtiÚs
, &
İtiÚ_šdex
);

105 ià(
c
 == -1)

107 ià(
c
 == 0) {

108 ià(
	`¡rcmp
(
lÚg_İtiÚs
[
İtiÚ_šdex
].
Çme
, "gen") == 0) {

109 
¡d
::
¡ršg
 
	`g’_¬g
(
İrg
);

110 ià(
g’_¬g
.
	`rfšd
("exp:", 0) == 0) {

111 
b’ch
.
g’
.
ty³
 = 
UCC_PT_GEN_TYPE_EXP
;

112 autØ
mš_pos
 = 
g’_¬g
.
	`fšd
("min=", 4);

113 ià(
mš_pos
 =ğ
¡d
::
¡ršg
::
Åos
) {

114 
¡d
::
û¼
 << "Inv®id fÜm© fÜ --g’ƒxp:mš=N[@max=M]" << std::
’dl
;

115  
UCC_ERR_INVALID_PARAM
;

117 autØ
©_pos
 = 
g’_¬g
.
	`fšd
("@", 
mš_pos
);

118 ià(
©_pos
 !ğ
¡d
::
¡ršg
::
Åos
) {

119 autØ
max_pos
 = 
g’_¬g
.
	`fšd
("max=", 
©_pos
);

120 ià(
max_pos
 =ğ
¡d
::
¡ršg
::
Åos
) {

121 
¡d
::
û¼
 << "Inv®id fÜm© fÜ --g’ƒxp:mš=N@max=M" << std::
’dl
;

122  
UCC_ERR_INVALID_PARAM
;

124 
Œy
 {

125 
ucc_¡©us_t
 
¡
 = 
	`ucc_¡r_to_memun™s
(
g’_¬g
.
	`sub¡r
(
mš_pos
 + 4, 
©_pos
 - (mš_po + 4)).
	`c_¡r
(),

126 (*)&
b’ch
.
g’
.
exp_mš
);

127 ià(
¡
 !ğ
UCC_OK
) {

128 
¡d
::
û¼
 << "FaedØ·r£ mš v®ue" << std::
’dl
;

129  
¡
;

131 
¡
 = 
	`ucc_¡r_to_memun™s
(
g’_¬g
.
	`sub¡r
(
max_pos
 + 4).
	`c_¡r
(),

132 (*)&
b’ch
.
g’
.
exp_max
);

133 ià(
¡
 !ğ
UCC_OK
) {

134 
¡d
::
û¼
 << "FaedØ·r£ max v®ue" << std::
’dl
;

135  
¡
;

137 } 
	`ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

138 
¡d
::
û¼
 << "Inv®id v®ue š --g’ƒxp:mš=N@max=M" << std::
’dl
;

139  
UCC_ERR_INVALID_PARAM
;

142 
Œy
 {

143 
ucc_¡©us_t
 
¡
 = 
	`ucc_¡r_to_memun™s
(
g’_¬g
.
	`sub¡r
(
mš_pos
 + 4).
	`c_¡r
(),

144 (*)&
b’ch
.
g’
.
exp_mš
);

145 ià(
¡
 !ğ
UCC_OK
) {

146 
¡d
::
û¼
 << "FaedØ·r£ mš v®ue" << std::
’dl
;

147  
¡
;

149 
b’ch
.
g’
.
exp_max
 = b’ch.g’.
exp_mš
;

150 } 
	`ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

151 
¡d
::
û¼
 << "Inv®id v®uš --g’ƒxp:mš=N" << std::
’dl
;

152  
UCC_ERR_INVALID_PARAM
;

155 
b’ch
.
mš_couÁ
 = b’ch.
g’
.
exp_mš
;

156 
b’ch
.
max_couÁ
 = b’ch.
g’
.
exp_max
;

157 } ià(
g’_¬g
.
	`rfšd
("file:", 0) == 0) {

158 
b’ch
.
g’
.
ty³
 = 
UCC_PT_GEN_TYPE_FILE
;

159 autØ
Çme_pos
 = 
g’_¬g
.
	`fšd
("name=", 5);

160 ià(
Çme_pos
 =ğ
¡d
::
¡ršg
::
Åos
) {

161 
¡d
::
û¼
 << "Inv®id fÜm© fÜ --g’ fe:Çme=f’ame[@Ä•=N]" << std::
’dl
;

162  
UCC_ERR_INVALID_PARAM
;

164 autØ
©_pos
 = 
g’_¬g
.
	`fšd
("@", 
Çme_pos
);

165 ià(
©_pos
 !ğ
¡d
::
¡ršg
::
Åos
) {

166 
b’ch
.
g’
.
fe_Çme
 = 
g’_¬g
.
	`sub¡r
(
Çme_pos
 + 5, 
©_pos
 - (name_pos + 5));

167 autØ
Ä•_¡r
 = 
g’_¬g
.
	`sub¡r
(
©_pos
 + 1);

168 ià(
Ä•_¡r
.
	`rfšd
("nrep=", 0) == 0) {

169 
Œy
 {

170 
b’ch
.
g’
.
Ä•
 = 
¡d
::
	`¡ouÎ
(
Ä•_¡r
.
	`sub¡r
(5));

171 } 
	`ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

172 
¡d
::
û¼
 << "Inv®id‚»°v®uš --g’ fe:Çme=f’ame@Ä•=N" << std::
’dl
;

173  
UCC_ERR_INVALID_PARAM
;

176 
¡d
::
û¼
 << "Inv®id fÜm© fÜ --g’ fe:Çme=f’ame@Ä•=N" << std::
’dl
;

177  
UCC_ERR_INVALID_PARAM
;

180 
b’ch
.
g’
.
fe_Çme
 = 
g’_¬g
.
	`sub¡r
(
Çme_pos
 + 5);

181 
b’ch
.
g’
.
Ä•
 = 1;

184 
¡d
::
û¼
 << "Inv®id v®ufÜ --g’. U£ƒxp:mš=N[@max=M] o¸fe:Çme=f’ame[@Ä•=N]" << std::
’dl
;

185  
UCC_ERR_INVALID_PARAM
;

190 
c
) {

192 ià(
ucc_±_İ_m­
.
	`couÁ
(
İrg
) == 0) {

193 
¡d
::
û¼
 << "šv®id o³¿tiÚ: " << 
İrg


194 << 
¡d
::
’dl
;

195  
UCC_ERR_INVALID_PARAM
;

197 
b’ch
.
İ_ty³
 = 
ucc_±_İ_m­
.
	`©
(
İrg
);

200 ià(
ucc_±_»duùiÚ_İ_m­
.
	`couÁ
(
İrg
) == 0) {

201 
¡d
::
û¼
 << "šv®id„eduùiÚ o³¿tiÚ: " << 
İrg


202 << 
¡d
::
’dl
;

203  
UCC_ERR_INVALID_PARAM
;

205 
b’ch
.
İ
 = 
ucc_±_»duùiÚ_İ_m­
.
	`©
(
İrg
);

208 ià(
ucc_±_memty³_m­
.
	`couÁ
(
İrg
) == 0) {

209 
¡d
::
û¼
 << "šv®id memÜyy³: " << 
İrg


210 <<
¡d
::
’dl
;

211  
UCC_ERR_INVALID_PARAM
;

213 
b’ch
.
mt
 = 
ucc_±_memty³_m­
.
	`©
(
İrg
);

214 
comm
.
mt
 = 
b’ch
.mt;

217 ià(
ucc_±_d©©y³_m­
.
	`couÁ
(
İrg
) == 0) {

218 
¡d
::
û¼
 << "šv®id d©©y³:" << 
İrg


219 << 
¡d
::
’dl
;

220  
UCC_ERR_INVALID_PARAM
;

222 
b’ch
.
dt
 = 
ucc_±_d©©y³_m­
.
	`©
(
İrg
);

225 
¡
 = 
	`ucc_¡r_to_memun™s
(
İrg
, (*)&
b’ch
.
mš_couÁ
);

226 ià(
¡
 !ğ
UCC_OK
) {

227 
¡d
::
û¼
 << "çedØ·r£ mš couÁ" << std::
’dl
;

228  
¡
;

232 
¡
 = 
	`ucc_¡r_to_memun™s
(
İrg
, (*)&
b’ch
.
max_couÁ
);

233 ià(
¡
 !ğ
UCC_OK
) {

234 
¡d
::
û¼
 << "çedØ·r£ max couÁ" << std::
’dl
;

235  
¡
;

239 
¡d
::
	`¡ršg¡»am
(
İrg
è>> 
b’ch
.
roÙ
;

242 
¡d
::
	`¡ršg¡»am
(
İrg
è>> 
b’ch
.
roÙ_shiá
;

245 
¡d
::
	`¡ršg¡»am
(
İrg
è>> 
b’ch
.
n_™”_sm®l
;

246 
b’ch
.
n_™”_Ïrge
 = b’ch.
n_™”_sm®l
;

249 
¡d
::
	`¡ršg¡»am
(
İrg
è>> 
b’ch
.
n_w¬mup_sm®l
;

250 
b’ch
.
n_w¬mup_Ïrge
 = b’ch.
n_w¬mup_sm®l
;

253 
¡d
::
	`¡ršg¡»am
(
İrg
è>> 
b’ch
.
muÉ_çùÜ
;

256 
¡d
::
	`¡ršg¡»am
(
İrg
è>> 
b’ch
.
n_bufs
;

259 
b’ch
.
š¶aû
 = 
Œue
;

262 
b’ch
.
³rsi¡’t
 = 
Œue
;

265 
b’ch
.
Œigg”ed
 = 
Œue
;

268 
b’ch
.
fuÎ_´št
 = 
Œue
;

272 
	`´št_h–p
();

273 
¡d
::
	`ex™
(0);

276  
UCC_OK
;

277 
	}
}

279 
	gucc_±_cÚfig
::
	$´št_h–p
()

281 
¡d
::
cout
 << "U§ge: ucc_³ráe¡ [İtiÚs]"<<¡d::
’dl
;

282 
¡d
::
cout
 << " -ø<cŞËùivÇme>: CŞËùivty³"<<¡d::
’dl
;

283 
¡d
::
cout
 << " -b <couÁ>: Mš‚umb” oà–em’ts"<<¡d::
’dl
;

284 
¡d
::
cout
 << " -<couÁ>: Max‚umb” oà–em’ts"<<¡d::
’dl
;

285 
¡d
::
cout
 << " -i: iÅÏû cŞËùive"<<¡d::
’dl
;

286 
¡d
::
cout
 << " -p:…”si¡’ˆcŞËùive"<<¡d::
’dl
;

287 
¡d
::
cout
 << " -d <dˆÇme>: d©©y³"<<¡d::
’dl
;

288 
¡d
::
cout
 << " -Ø<İ‚ame>:„eduùiÚ o³¿tiÚy³"<<¡d::
’dl
;

289 
¡d
::
cout
 << " -¸<numb”>:„oÙ fÜ„oÙed cŞËùives"<<¡d::
’dl
;

290 
¡d
::
cout
 << " -m <mty³‚ame>: memÜyy³"<<¡d::
’dl
;

291 
¡d
::
cout
 << " -À<numb”>:‚umb” oà™”©iÚs"<<¡d::
’dl
;

292 
¡d
::
cout
 << " -w <numb”>:‚umb” oàw¬mu°™”©iÚs"<<¡d::
’dl
;

293 
¡d
::
cout
 << " -à<numb”>: muÉliÿtiÚ faùÜ b‘w“Àsizes. DeçuÉ : 2."<<¡d::
’dl
;

294 
¡d
::
cout
 << " -N <numb”>:‚umb” oàbufãrs"<<¡d::
’dl
;

295 
¡d
::
cout
 << " -T:rigg”ed cŞËùive"<<¡d::
’dl
;

296 
¡d
::
cout
 << " -F:ƒÇbË fuÎ…ršt"<<¡d::
’dl
;

297 
¡d
::
cout
 << " -S: <numb”>:„oÙ shiá fÜ„oÙed cŞËùives"<<¡d::
’dl
;

298 
¡d
::
cout
 << " --g’ <exp:mš=N[@max=M]|fe:Çme=f’ame[@Ä•=N]>: P©‹º g’”©Ü (expÚ’tŸÈÜ fe-ba£d)" << std::
’dl
;

299 
¡d
::
cout
 << " -h: showhi h–°mes§ge"<<¡d::
’dl
;

300 
¡d
::
cout
 << std::
’dl
;

301 
	}
}

	@tools/perf/ucc_pt_config.h

7 #iâdeà
UCC_PT_CONFIG_H


8 
	#UCC_PT_CONFIG_H


	)

10 
	~<io¡»am
>

11 
	~<s¡»am
>

12 
	~<¡ršg
>

13 
	~<m­
>

14 
	~<g‘İt.h
>

15 
	~<ucc/­i/ucc.h
>

16 
	~"uts/ucc_log.h
"

18 
	#UCC_PT_DEFAULT_N_BUFS
 0

	)

20 
	eucc_±_boÙ¡¿p_ty³_t
 {

21 
	mUCC_PT_BOOTSTRAP_MPI
,

22 
	mUCC_PT_BOOTSTRAP_UCX


25 
	succ_±_boÙ¡¿p_cÚfig
 {

26 
ucc_±_boÙ¡¿p_ty³_t
 
	mboÙ¡¿p
;

29 
	succ_±_comm_cÚfig
 {

30 
ucc_memÜy_ty³_t
 
	mmt
;

34 
	mUCC_PT_OP_TYPE_ALLGATHER
 = 
UCC_COLL_TYPE_ALLGATHER
,

35 
	mUCC_PT_OP_TYPE_ALLGATHERV
 = 
UCC_COLL_TYPE_ALLGATHERV
,

36 
	mUCC_PT_OP_TYPE_ALLREDUCE
 = 
UCC_COLL_TYPE_ALLREDUCE
,

37 
	mUCC_PT_OP_TYPE_ALLTOALL
 = 
UCC_COLL_TYPE_ALLTOALL
,

38 
	mUCC_PT_OP_TYPE_ALLTOALLV
 = 
UCC_COLL_TYPE_ALLTOALLV
,

39 
	mUCC_PT_OP_TYPE_BARRIER
 = 
UCC_COLL_TYPE_BARRIER
,

40 
	mUCC_PT_OP_TYPE_BCAST
 = 
UCC_COLL_TYPE_BCAST
,

41 
	mUCC_PT_OP_TYPE_FANIN
 = 
UCC_COLL_TYPE_FANIN
,

42 
	mUCC_PT_OP_TYPE_FANOUT
 = 
UCC_COLL_TYPE_FANOUT
,

43 
	mUCC_PT_OP_TYPE_GATHER
 = 
UCC_COLL_TYPE_GATHER
,

44 
	mUCC_PT_OP_TYPE_GATHERV
 = 
UCC_COLL_TYPE_GATHERV
,

45 
	mUCC_PT_OP_TYPE_REDUCE
 = 
UCC_COLL_TYPE_REDUCE
,

46 
	mUCC_PT_OP_TYPE_REDUCE_SCATTER
 = 
UCC_COLL_TYPE_REDUCE_SCATTER
,

47 
	mUCC_PT_OP_TYPE_REDUCE_SCATTERV
 = 
UCC_COLL_TYPE_REDUCE_SCATTERV
,

48 
	mUCC_PT_OP_TYPE_SCATTER
 = 
UCC_COLL_TYPE_SCATTER
,

49 
	mUCC_PT_OP_TYPE_SCATTERV
 = 
UCC_COLL_TYPE_SCATTERV
,

50 
	mUCC_PT_OP_TYPE_MEMCPY
 = 
UCC_COLL_TYPE_LAST
 + 1,

51 
	mUCC_PT_OP_TYPE_REDUCEDT
,

52 
	mUCC_PT_OP_TYPE_REDUCEDT_STRIDED
,

53 
	mUCC_PT_OP_TYPE_LAST


54 } 
	tucc_±_İ_ty³_t
;

56 
šlše
 cÚ¡ * 
	$ucc_±_İ_ty³_¡r
(
ucc_±_İ_ty³_t
 
İ
)

58 ià((
ušt64_t
)
İ
 < (ušt64_t)
UCC_COLL_TYPE_LAST
) {

59  
	`ucc_cŞl_ty³_¡r
((
ucc_cŞl_ty³_t
)
İ
);

61 
İ
) {

62 
UCC_PT_OP_TYPE_MEMCPY
:

64 
UCC_PT_OP_TYPE_REDUCEDT
:

66 
UCC_PT_OP_TYPE_REDUCEDT_STRIDED
:

71  
NULL
;

72 
	}
}

75 
	mUCC_PT_GEN_TYPE_EXP
,

76 
	mUCC_PT_GEN_TYPE_FILE


77 } 
	tucc_±_g’_ty³_t
;

79 
	succ_±_g’_cÚfig
 {

80 
ucc_±_g’_ty³_t
 
	mty³
;

81 
size_t
 
	mexp_mš
;

82 
size_t
 
	mexp_max
;

83 
	m¡d
::
¡ršg
 
fe_Çme
;

84 
size_t
 
	mÄ•
;

87 
	succ_±_b’chm¬k_cÚfig
 {

88 
ucc_±_İ_ty³_t
 
	mİ_ty³
;

89 
size_t
 
	mmš_couÁ
;

90 
size_t
 
	mmax_couÁ
;

91 
ucc_d©©y³_t
 
	mdt
;

92 
ucc_memÜy_ty³_t
 
	mmt
;

93 
ucc_»duùiÚ_İ_t
 
	mİ
;

94 
boŞ
 
	mš¶aû
;

95 
boŞ
 
	m³rsi¡’t
;

96 
boŞ
 
	mŒigg”ed
;

97 
size_t
 
	mÏrge_th»sh
;

98 
	mn_™”_sm®l
;

99 
	mn_w¬mup_sm®l
;

100 
	mn_™”_Ïrge
;

101 
	mn_w¬mup_Ïrge
;

102 
	mn_bufs
;

103 
boŞ
 
	mfuÎ_´št
;

104 
	mroÙ
;

105 
	mroÙ_shiá
;

106 
	mmuÉ_çùÜ
;

107 
ucc_±_g’_cÚfig
 
	mg’
;

110 
	succ_±_cÚfig
 {

111 
ucc_±_boÙ¡¿p_cÚfig
 
	mboÙ¡¿p
;

112 
ucc_±_comm_cÚfig
 
	mcomm
;

113 
ucc_±_b’chm¬k_cÚfig
 
	mb’ch
;

115 
ucc_±_cÚfig
();

116 
ucc_¡©us_t
 
´oûss_¬gs
(
¬gc
, *
¬gv
[]);

117 
´št_h–p
();

	@tools/perf/ucc_pt_cuda.cc

7 
	~"ucc_±_cuda.h
"

8 
	~<io¡»am
>

9 
	~<dlfú.h
>

10 
	~<¡dlib.h
>

12 
ucc_±_cuda_içû_t
 
	gucc_±_cuda_içû
 = {

13 .
avaabË
 = 0,

16 
	#LOAD_CUDA_SYM
(
_sym
, 
_±_sym
) ({ \

17 *
h
 = 
	`dlsym
(
hªdË
, 
_sym
); \

18 ià(
	`dË¼Ü
(è!ğ
NULL
) { \

21 
ucc_±_cuda_içû
. 
_±_sym
 = \

22 
»š‹½»t_ÿ¡
<
	`deşty³
(
ucc_±_cuda_içû
. 
_±_sym
)>(
h
); \

23 })

	)

26 
	$ucc_±_cuda_š™
()

28 *
hªdË
;

30 
hªdË
 = 
	`dlİ’
 ("libcud¬t.so", 
RTLD_LAZY
);

31 ià(!
hªdË
) {

35 
	`LOAD_CUDA_SYM
("cudaG‘DeviûCouÁ", 
g‘DeviûCouÁ
);

36 
	`LOAD_CUDA_SYM
("cudaS‘Deviû", 
£tDeviû
);

37 
	`LOAD_CUDA_SYM
("cudaG‘E¼ÜSŒšg", 
g‘E¼ÜSŒšg
);

38 
	`LOAD_CUDA_SYM
("cudaSŒ—mC»©eW™hFÏgs", 
¡»amC»©eW™hFÏgs
);

39 
	`LOAD_CUDA_SYM
("cudaSŒ—mDe¡roy", 
¡»amDe¡roy
);

40 
	`LOAD_CUDA_SYM
("cudaM®loc", 
cudaM®loc
);

41 
	`LOAD_CUDA_SYM
("cudaF»e", 
cudaF»e
);

42 
	`LOAD_CUDA_SYM
("cudaMem£t", 
cudaMem£t
);

43 
	`LOAD_CUDA_SYM
("cudaM®locMªaged", 
cudaM®locMªaged
);

44 
	`LOAD_CUDA_SYM
("cudaG‘DeviûPrİ”t›s", 
cudaG‘DeviûPrİ”t›s
);

45 
	`LOAD_CUDA_SYM
("cudaDeviûG‘PCIBusId", 
cudaDeviûG‘PCIBusId
);

47 
ucc_±_cuda_içû
.
avaabË
 = 1;

48 
	}
}

	@tools/perf/ucc_pt_cuda.h

7 #iâdeà
UCC_PT_CUDA_H


8 
	#UCC_PT_CUDA_H


	)

9 
	~<io¡»am
>

10 
	~<uni¡d.h
>

12 
	#cudaSucûss
 0

	)

13 
	#cudaSŒ—mNÚBlockšg
 0x01

	)

14 
	#cudaMemA‰achGlob®
 0x01

	)

15 
CUSŒ—m_¡
 *
	tcudaSŒ—m_t
;

16 
	scudaDeviûPrİ
 {

17 
	mÇme
[256];

18 
	m·ddšg
[2048];

19 } 
	tcudaDeviûPrİ
;

21 
	#STR
(
x
è#x

	)

22 
	#CUDA_CHECK
(
_ÿÎ
) \

24 
_¡©us
 = (
_ÿÎ
); \

25 ià(
cudaSucûss
 !ğ
_¡©us
) { \

26 
¡d
::
û¼
 << "UCC…erftestƒrror: " << \

27 
ucc_±_cuda_içû
.
	`g‘E¼ÜSŒšg
(
_¡©us
) \

28 << " iÀ" << 
	`STR
(
_ÿÎ
) << "\n"; \

29  
_¡©us
; \

31 } 0)

	)

33 
	succ_±_cuda_içû
 {

34 
	mavaabË
;

35 (*
	mg‘DeviûCouÁ
)(* 
	mcouÁ
);

36 (*
	m£tDeviû
)(
	mdeviû
);

37 (*
	mg‘DeviûInfo
)(
	m¡d
::
¡ršg
 &
šfo
);

38 (*
	m¡»amC»©eW™hFÏgs
)(
cudaSŒ—m_t
 *
	m¡»am
, 
	mæags
);

39 (*
	m¡»amDe¡roy
)(
cudaSŒ—m_t
 
	m¡»am
);

40 * (*
	mg‘E¼ÜSŒšg
)(
	m”r
);

41 (*
	mcudaM®loc
)(**
	mdev±r
, 
size_t
 
	msize
);

42 (*
	mcudaM®locMªaged
)(**
	m±r
, 
size_t
 
	msize
, 
	mæags
);

43 (*
	mcudaF»e
)(*
	mdev±r
);

44 (*
	mcudaMem£t
)(*
	mdev±r
, 
	mv®ue
, 
size_t
 
	mcouÁ
);

45 (*
	mcudaG‘DeviûPrİ”t›s
)(*
	m´İ
, 
	mdeviû
);

46 (*
	mcudaDeviûG‘PCIBusId
)(*
	mpciBusId
, 
	mËn
, 
	mdeviû
);

47 } 
	tucc_±_cuda_içû_t
;

49 
ucc_±_cuda_içû_t
 
ucc_±_cuda_içû
;

51 
ucc_±_cuda_š™
();

53 
šlše
 
	$ucc_±_cudaG‘DeviûCouÁ
(*
couÁ
)

55 ià(!
ucc_±_cuda_içû
.
avaabË
) {

58 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`g‘DeviûCouÁ
(
couÁ
));

60 
	}
}

62 
šlše
 
	$ucc_±_cudaS‘Deviû
(
deviû
)

64 ià(!
ucc_±_cuda_içû
.
avaabË
) {

67 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`£tDeviû
(
deviû
));

69 
	}
}

71 
šlše
 
	$ucc_±_cudaSŒ—mC»©eW™hFÏgs
(
cudaSŒ—m_t
 *
¡»am
,

72 
æags
)

74 ià(!
ucc_±_cuda_içû
.
avaabË
) {

77 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`¡»amC»©eW™hFÏgs
(
¡»am
, 
æags
));

79 
	}
}

81 
šlše
 
	$ucc_±_cudaSŒ—mDe¡roy
(
cudaSŒ—m_t
 
¡»am
)

83 ià(!
ucc_±_cuda_içû
.
avaabË
) {

86 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`¡»amDe¡roy
(
¡»am
));

88 
	}
}

90 
šlše
 
	$ucc_±_cudaM®loc
(**
dev±r
, 
size_t
 
size
)

92 ià(!
ucc_±_cuda_içû
.
avaabË
) {

95 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`cudaM®loc
(
dev±r
, 
size
));

97 
	}
}

99 
šlše
 
	$ucc_±_cudaM®locMªaged
(**
±r
, 
size_t
 
size
)

101 ià(!
ucc_±_cuda_içû
.
avaabË
) {

104 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`cudaM®locMªaged
(
±r
, 
size
,

105 
cudaMemA‰achGlob®
));

107 
	}
}

109 
šlše
 
	$ucc_±_cudaF»e
(*
dev±r
)

111 ià(!
ucc_±_cuda_içû
.
avaabË
) {

114 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`cudaF»e
(
dev±r
));

116 
	}
}

118 
šlše
 
	$ucc_±_cudaMem£t
(*
dev±r
, 
v®ue
, 
size_t
 
couÁ
)

120 ià(!
ucc_±_cuda_içû
.
avaabË
) {

123 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`cudaMem£t
(
dev±r
, 
v®ue
, 
couÁ
));

125 
	}
}

127 
šlše
 
	$ucc_±_cudaG‘DeviûInfo
(
deviû
, 
¡d
::
¡ršg
 &
šfo
)

129 
pciBusId
[256];

130 
ho¡Çme
[256];

131 
cudaDeviûPrİ
 
´İ
;

133 ià(!
ucc_±_cuda_içû
.
avaabË
) {

137 ià(
	`g‘ho¡Çme
(
ho¡Çme
, (hostname)) == 0) {

138 
šfo
.
	`­³nd
(
ho¡Çme
);

139 
šfo
.
	`­³nd
(" - ");

142 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`cudaG‘DeviûPrİ”t›s
(&
´İ
, 
deviû
));

143 
šfo
.
	`­³nd
(
´İ
.
Çme
);

144 
šfo
.
	`­³nd
(" ");

145 
	`CUDA_CHECK
(
ucc_±_cuda_içû
.
	`cudaDeviûG‘PCIBusId
(
pciBusId
,

146 (
pciBusId
), 
deviû
));

147 
šfo
.
	`­³nd
(
pciBusId
);

150 
	}
}

	@tools/perf/ucc_pt_op_memcpy.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_İ_memıy
::
	$ucc_±_İ_memıy
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

14 
nbufs
,

15 
ucc_±_comm
 *
communiÿtÜ
,

16 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
) :

17 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

19 
has_š¶aû_
 = 
çl£
;

20 
has_»duùiÚ_
 = 
çl£
;

21 
has_¿nge_
 = 
Œue
;

22 
has_bw_
 = 
Œue
;

24 ià(
nbufs
 =ğ
UCC_PT_DEFAULT_N_BUFS
) {

25 
nbufs
 = 1;

28 ià(
nbufs
 > 
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
) {

29 
throw
 
¡d
::
	`ruÁime_”rÜ
("max supported‚umber of copy buffer is "

30 
	`STR
(
UCC_EE_EXECUTOR_MULTI_OP_NUM_BUFS
));

33 
d©a_ty³
 = 
dt
;

34 
mem_ty³
 = 
mt
;

35 
num_bufs
 = 
nbufs
;

36 
	}
}

38 
ucc_¡©us_t
 
	gucc_±_İ_memıy
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

40 
ucc_“_executÜ_sk_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
executÜ_¬gs
;

41 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
d©a_ty³
);

42 
size_t
 
size
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
;

43 
ucc_¡©us_t
 
¡
;

44 
i
;

46 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
,

47 
num_bufs
 * 
size
,

48 
mem_ty³
),

49 
ex™
, 
¡
);

50 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
¤c_h—d”
,

51 
num_bufs
 * 
size
,

52 
mem_ty³
),

53 
ä“_d¡
, 
¡
);

55 ià(
num_bufs
 == 1) {

56 
¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY
;

57 
¬gs
.
cİy
.
d¡
 = 
d¡_h—d”
->
addr
;

58 
¬gs
.
cİy
.
¤c
 = 
¤c_h—d”
->
addr
;

59 
¬gs
.
cİy
.
Ën
 = 
size
;

61 
¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_COPY_MULTI
;

62 
¬gs
.
cİy_muÉi
.
num_veùÜs
 = 
num_bufs
;

63 
i
 = 0; i < 
num_bufs
; i++) {

64 
¬gs
.
cİy_muÉi
.
¤c
[
i
] = 
	`PTR_OFFSET
(
¤c_h—d”
->
addr
,

65 
size
 * 
i
);

66 
¬gs
.
cİy_muÉi
.
d¡
[
i
] = 
	`PTR_OFFSET
(
d¡_h—d”
->
addr
,

67 
size
 * 
i
);

68 
¬gs
.
cİy_muÉi
.
couÁs
[
i
] = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

72  
UCC_OK
;

73 
ä“_d¡
:

74 
	`ucc_±_ä“
(
d¡_h—d”
);

75 
ex™
:

76  
¡
;

77 
	}
}

79 
	gucc_±_İ_memıy
::
	$g‘_bw
(
time_ms
, 
grsize
,

80 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

82 
ucc_“_executÜ_sk_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
executÜ_¬gs
;

83 
S
;

84 
i
;

86 ià(
¬gs
.
sk_ty³
 =ğ
UCC_EE_EXECUTOR_TASK_COPY
) {

87 
S
 = 
¬gs
.
cİy
.
Ën
;

89 
S
 = 0;

90 
i
 = 0; i < 
¬gs
.
cİy_muÉi
.
num_veùÜs
; i++) {

91 
S
 +ğ
¬gs
.
cİy_muÉi
.
couÁs
[
i
];

95  2 * (
S
 / 
time_ms
) / 1000.0;

96 
	}
}

98 
	gucc_±_İ_memıy
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

100 
	`ucc_±_ä“
(
¤c_h—d”
);

101 
	`ucc_±_ä“
(
d¡_h—d”
);

102 
	}
}

	@tools/perf/ucc_pt_op_reduce.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_İ_»duû
::
	$ucc_±_İ_»duû
(
ucc_d©©y³_t
 
dt
, 
ucc_memÜy_ty³
 
mt
,

14 
ucc_»duùiÚ_İ_t
 
İ
, 
nbufs
,

15 
ucc_±_comm
 *
communiÿtÜ
,

16 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
) :

17 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

19 
has_š¶aû_
 = 
çl£
;

20 
has_»duùiÚ_
 = 
Œue
;

21 
has_¿nge_
 = 
Œue
;

22 
has_bw_
 = 
Œue
;

24 ià(
nbufs
 =ğ
UCC_PT_DEFAULT_N_BUFS
) {

25 
nbufs
 = 2;

28 ià(
nbufs
 < 2) {

29 
throw
 
¡d
::
	`ruÁime_”rÜ
("dt„educe op„equires‡t†east 2 bufs");

32 ià(
nbufs
 > 
UCC_EE_EXECUTOR_NUM_BUFS
) {

33 
throw
 
¡d
::
	`ruÁime_”rÜ
("dt„educe op supports upo " +

34 
¡d
::
	`to_¡ršg
(
UCC_EE_EXECUTOR_NUM_BUFS
) +

38 
d©a_ty³
 = 
dt
;

39 
mem_ty³
 = 
mt
;

40 
»duû_İ
 = 
İ
;

41 
num_bufs
 = 
nbufs
;

42 
	}
}

44 
ucc_¡©us_t
 
	gucc_±_İ_»duû
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

46 
ucc_“_executÜ_sk_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
executÜ_¬gs
;

47 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
d©a_ty³
);

48 
size_t
 
size
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
;

49 
ucc_¡©us_t
 
¡
;

50 
i
;

52 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
, 
size
, 
mem_ty³
), 
ex™
, 
¡
);

53 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
¤c_h—d”
, 
size
 * 
num_bufs
, 
mem_ty³
),

54 
ä“_d¡
, 
¡
);

56 
¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_REDUCE
;

57 
¬gs
.
»duû
.
d¡
 = 
d¡_h—d”
->
addr
;

58 
¬gs
.
»duû
.
n_¤cs
 = 
num_bufs
;

59 
¬gs
.
»duû
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

60 
¬gs
.
»duû
.
dt
 = 
d©a_ty³
;

61 
¬gs
.
»duû
.
İ
 = 
»duû_İ
;

62 
¬gs
.
æags
 = 0;

63 
i
 = 0; i < 
num_bufs
; i++) {

64 
¬gs
.
»duû
.
¤cs
[
i
] = 
	`PTR_OFFSET
(
¤c_h—d”
->
addr
, i * 
size
);

67  
UCC_OK
;

68 
ä“_d¡
:

69 
	`ucc_±_ä“
(
d¡_h—d”
);

70 
ex™
:

71  
¡
;

72 
	}
}

74 
	gucc_±_İ_»duû
::
	$g‘_bw
(
time_ms
, 
grsize
,

75 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

77 
ucc_“_executÜ_sk_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
executÜ_¬gs
;

78 
S
 = 
¬gs
.
»duû
.
couÁ
 * 
	`ucc_dt_size
(
d©a_ty³
);

80  (
num_bufs
 + 1è* (
S
 / 
time_ms
) / 1000.0;

81 
	}
}

83 
	gucc_±_İ_»duû
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

85 
	`ucc_±_ä“
(
¤c_h—d”
);

86 
	`ucc_±_ä“
(
d¡_h—d”
);

87 
	}
}

	@tools/perf/ucc_pt_op_reduce_strided.cc

7 
	~"ucc_±_cŞl.h
"

8 
	~"ucc_³ráe¡.h
"

9 
	~<ucc/­i/ucc.h
>

10 
	~<uts/ucc_m©h.h
>

11 
	~<uts/ucc_cŞl_uts.h
>

13 
	gucc_±_İ_»duû_¡rided
::
	$ucc_±_İ_»duû_¡rided
(
ucc_d©©y³_t
 
dt
,

14 
ucc_memÜy_ty³
 
mt
,

15 
ucc_»duùiÚ_İ_t
 
İ
,

16 
nbufs
,

17 
ucc_±_comm
 *
communiÿtÜ
,

18 
ucc_±_g’”©Ü_ba£
 *
g’”©Ü
) :

19 
	$ucc_±_cŞl
(
communiÿtÜ
, 
g’”©Ü
)

21 
has_š¶aû_
 = 
çl£
;

22 
has_»duùiÚ_
 = 
Œue
;

23 
has_¿nge_
 = 
Œue
;

24 
has_bw_
 = 
Œue
;

26 ià(
nbufs
 =ğ
UCC_PT_DEFAULT_N_BUFS
) {

27 
nbufs
 = 2;

30 ià(
nbufs
 < 2) {

31 
throw
 
¡d
::
	`ruÁime_”rÜ
("dt„educe op„equires‡t†east 2 bufs");

34 
d©a_ty³
 = 
dt
;

35 
mem_ty³
 = 
mt
;

36 
»duû_İ
 = 
İ
;

37 
num_bufs
 = 
nbufs
;

38 
	}
}

40 
ucc_¡©us_t
 
	gucc_±_İ_»duû_¡rided
::
	$š™_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

42 
ucc_“_executÜ_sk_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
executÜ_¬gs
;

43 
size_t
 
dt_size
 = 
	`ucc_dt_size
(
d©a_ty³
);

44 
size_t
 
size
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
;

45 
size_t
 
¡ride
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
(è* 
dt_size
;

46 
ucc_¡©us_t
 
¡
;

48 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
d¡_h—d”
, 
size
, 
mem_ty³
), 
ex™
, 
¡
);

49 
	`UCCCHECK_GOTO
(
	`ucc_±_®loc
(&
¤c_h—d”
, 
size
 * 
num_bufs
, 
mem_ty³
),

50 
ä“_d¡
, 
¡
);

52 
¬gs
.
sk_ty³
 = 
UCC_EE_EXECUTOR_TASK_REDUCE_STRIDED
;

53 
¬gs
.
»duû_¡rided
.
d¡
 = 
d¡_h—d”
->
addr
;

54 
¬gs
.
»duû_¡rided
.
¤c1
 = 
¤c_h—d”
->
addr
;

55 
¬gs
.
»duû_¡rided
.
¤c2
 = 
	`PTR_OFFSET
(
¤c_h—d”
->
addr
, 
size
);

56 
¬gs
.
»duû_¡rided
.
n_¤c2
 = 
num_bufs
 - 1;

57 
¬gs
.
»duû_¡rided
.
¡ride
 = stride;

58 
¬gs
.
»duû_¡rided
.
couÁ
 = 
g’”©Ü
->
	`g‘_¤c_couÁ
();

59 
¬gs
.
»duû_¡rided
.
dt
 = 
d©a_ty³
;

60 
¬gs
.
»duû_¡rided
.
İ
 = 
»duû_İ
;

61 
¬gs
.
æags
 = 0;

63  
UCC_OK
;

64 
ä“_d¡
:

65 
	`ucc_±_ä“
(
d¡_h—d”
);

66 
ex™
:

67  
¡
;

68 
	}
}

70 
	gucc_±_İ_»duû_¡rided
::
	$g‘_bw
(
time_ms
, 
grsize
,

71 
ucc_±_‹¡_¬gs_t
 
‹¡_¬gs
)

73 
ucc_“_executÜ_sk_¬gs_t
 &
¬gs
 = 
‹¡_¬gs
.
executÜ_¬gs
;

74 
S
 = 
¬gs
.
»duû_¡rided
.
couÁ
 *

75 
	`ucc_dt_size
(
d©a_ty³
);

77  (
num_bufs
 + 1è* (
S
 / 
time_ms
) / 1000.0;

78 
	}
}

80 
	gucc_±_İ_»duû_¡rided
::
	$ä“_¬gs
(
ucc_±_‹¡_¬gs_t
 &
‹¡_¬gs
)

82 
	`ucc_±_ä“
(
¤c_h—d”
);

83 
	`ucc_±_ä“
(
d¡_h—d”
);

84 
	}
}

	@tools/perf/ucc_pt_rocm.cc

8 
	~"ucc_±_rocm.h
"

9 
	~<io¡»am
>

10 
	~<dlfú.h
>

11 
	~<¡dlib.h
>

13 
ucc_±_rocm_içû_t
 
	gucc_±_rocm_içû
 = {

14 .
avaabË
 = 0,

17 
	#LOAD_ROCM_SYM
(
_sym
, 
_±_sym
) ({ \

18 *
h
 = 
	`dlsym
(
hªdË
, 
_sym
); \

19 ià(
	`dË¼Ü
(è!ğ
NULL
) { \

22 
ucc_±_rocm_içû
. 
_±_sym
 = \

23 
»š‹½»t_ÿ¡
<
	`deşty³
(
ucc_±_rocm_içû
. 
_±_sym
)>(
h
); \

24 })

	)

26 
	$ucc_±_rocm_š™
()

28 *
hªdË
;

30 
hªdË
 = 
	`dlİ’
 ("libamdh64.so", 
RTLD_LAZY
);

31 ià(!
hªdË
) {

34 
	`LOAD_ROCM_SYM
("hG‘DeviûCouÁ", 
g‘DeviûCouÁ
);

35 
	`LOAD_ROCM_SYM
("hS‘Deviû", 
£tDeviû
);

36 
	`LOAD_ROCM_SYM
("hG‘E¼ÜSŒšg", 
g‘E¼ÜSŒšg
);

37 
ucc_±_rocm_içû
.
avaabË
 = 1;

38 
	}
}

	@tools/perf/ucc_pt_rocm.h

8 #iâdeà
UCC_PT_ROCM_H


9 
	#UCC_PT_ROCM_H


	)

10 
	~<io¡»am
>

12 
	succ_±_rocm_içû
 {

13 
	mavaabË
;

14 (*
	mg‘DeviûCouÁ
)(* 
	mcouÁ
);

15 (*
	m£tDeviû
)(
	mdeviû
);

16 * (*
	mg‘E¼ÜSŒšg
)(
	m”r
);

17 } 
	tucc_±_rocm_içû_t
;

19 
ucc_±_rocm_içû_t
 
ucc_±_rocm_içû
;

20 
ucc_±_rocm_š™
();

22 
	#hSucûss
 0

	)

24 
	#STR
(
x
è#x

	)

25 
	#HIP_CHECK
(
_ÿÎ
) \

27 
_¡©us
 = (
_ÿÎ
); \

28 ià(
hSucûss
 !ğ
_¡©us
) { \

29 
¡d
::
û¼
 << "UCC…erftestƒrror: " << \

30 
ucc_±_rocm_içû
.
	`g‘E¼ÜSŒšg
(
_¡©us
) \

31 << " iÀ" << 
	`STR
(
_ÿÎ
) << "\n"; \

32  
_¡©us
; \

34 } 0)

	)

36 
šlše
 
	$ucc_±_rocmG‘DeviûCouÁ
(*
couÁ
)

38 ià(!
ucc_±_rocm_içû
.
avaabË
) {

41 
	`HIP_CHECK
(
ucc_±_rocm_içû
.
	`g‘DeviûCouÁ
(
couÁ
));

43 
	}
}

45 
šlše
 
	$ucc_±_rocmS‘Deviû
(
deviû
)

47 ià(!
ucc_±_rocm_içû
.
avaabË
) {

50 
	`HIP_CHECK
(
ucc_±_rocm_içû
.
	`£tDeviû
(
deviû
));

52 
	}
}

	@
1
.
0
514
19326
contrib/doca_urom_ucc_plugin/common/urom_ucc.h
contrib/doca_urom_ucc_plugin/dpu/worker_ucc.c
contrib/doca_urom_ucc_plugin/dpu/worker_ucc.h
contrib/doca_urom_ucc_plugin/dpu/worker_ucc_p2p.c
src/coll_patterns/bruck_alltoall.h
src/coll_patterns/double_binary_tree.h
src/coll_patterns/recursive_knomial.h
src/coll_patterns/sra_knomial.h
src/coll_score/ucc_coll_score.c
src/coll_score/ucc_coll_score.h
src/coll_score/ucc_coll_score_map.c
src/components/base/ucc_base_iface.c
src/components/base/ucc_base_iface.h
src/components/cl/basic/cl_basic.c
src/components/cl/basic/cl_basic.h
src/components/cl/basic/cl_basic_coll.c
src/components/cl/basic/cl_basic_context.c
src/components/cl/basic/cl_basic_lib.c
src/components/cl/basic/cl_basic_team.c
src/components/cl/doca_urom/cl_doca_urom.c
src/components/cl/doca_urom/cl_doca_urom.h
src/components/cl/doca_urom/cl_doca_urom_coll.c
src/components/cl/doca_urom/cl_doca_urom_coll.h
src/components/cl/doca_urom/cl_doca_urom_common.c
src/components/cl/doca_urom/cl_doca_urom_common.h
src/components/cl/doca_urom/cl_doca_urom_context.c
src/components/cl/doca_urom/cl_doca_urom_lib.c
src/components/cl/doca_urom/cl_doca_urom_team.c
src/components/cl/doca_urom/cl_doca_urom_worker_ucc.c
src/components/cl/doca_urom/cl_doca_urom_worker_ucc.h
src/components/cl/hier/allgatherv/allgatherv.c
src/components/cl/hier/allgatherv/allgatherv.h
src/components/cl/hier/allgatherv/unpack.c
src/components/cl/hier/allgatherv/unpack.h
src/components/cl/hier/allreduce/allreduce.c
src/components/cl/hier/allreduce/allreduce.h
src/components/cl/hier/allreduce/allreduce_rab.c
src/components/cl/hier/allreduce/allreduce_split_rail.c
src/components/cl/hier/alltoall/alltoall.c
src/components/cl/hier/alltoall/alltoall.h
src/components/cl/hier/alltoallv/alltoallv.c
src/components/cl/hier/alltoallv/alltoallv.h
src/components/cl/hier/barrier/barrier.c
src/components/cl/hier/barrier/barrier.h
src/components/cl/hier/bcast/bcast.c
src/components/cl/hier/bcast/bcast.h
src/components/cl/hier/bcast/bcast_2step.c
src/components/cl/hier/cl_hier.c
src/components/cl/hier/cl_hier.h
src/components/cl/hier/cl_hier_coll.c
src/components/cl/hier/cl_hier_coll.h
src/components/cl/hier/cl_hier_context.c
src/components/cl/hier/cl_hier_lib.c
src/components/cl/hier/cl_hier_team.c
src/components/cl/hier/reduce/reduce.c
src/components/cl/hier/reduce/reduce.h
src/components/cl/hier/reduce/reduce_2step.c
src/components/cl/ucc_cl.c
src/components/cl/ucc_cl.h
src/components/cl/ucc_cl_log.h
src/components/cl/ucc_cl_type.h
src/components/ec/base/ucc_ec_base.c
src/components/ec/base/ucc_ec_base.h
src/components/ec/cpu/ec_cpu.c
src/components/ec/cpu/ec_cpu.h
src/components/ec/cpu/ec_cpu_reduce.c
src/components/ec/cuda/ec_cuda.c
src/components/ec/cuda/ec_cuda.h
src/components/ec/cuda/ec_cuda_executor.c
src/components/ec/cuda/ec_cuda_executor.h
src/components/ec/cuda/ec_cuda_executor_interruptible.c
src/components/ec/cuda/ec_cuda_executor_persistent.c
src/components/ec/cuda/ec_cuda_executor_persistent_wait.c
src/components/ec/cuda/ec_cuda_resources.c
src/components/ec/cuda/ec_cuda_resources.h
src/components/ec/cuda/kernel/ec_cuda_half_sm52.h
src/components/ec/cuda/kernel/ec_cuda_reduce_ops.h
src/components/ec/rocm/ec_rocm.c
src/components/ec/rocm/ec_rocm.h
src/components/ec/rocm/ec_rocm_executor.c
src/components/ec/rocm/ec_rocm_executor.h
src/components/ec/rocm/ec_rocm_executor_interruptible.c
src/components/ec/rocm/ec_rocm_executor_persistent.c
src/components/ec/ucc_ec.c
src/components/ec/ucc_ec.h
src/components/ec/ucc_ec_log.h
src/components/mc/base/ucc_mc_base.c
src/components/mc/base/ucc_mc_base.h
src/components/mc/cpu/mc_cpu.c
src/components/mc/cpu/mc_cpu.h
src/components/mc/cuda/mc_cuda.c
src/components/mc/cuda/mc_cuda.h
src/components/mc/cuda/mc_cuda_resources.c
src/components/mc/cuda/mc_cuda_resources.h
src/components/mc/rocm/mc_rocm.c
src/components/mc/rocm/mc_rocm.h
src/components/mc/ucc_mc.c
src/components/mc/ucc_mc.h
src/components/mc/ucc_mc_log.h
src/components/tl/cuda/allgather/allgather.c
src/components/tl/cuda/allgather/allgather.h
src/components/tl/cuda/allgather/allgather_linear.c
src/components/tl/cuda/allgather/allgather_ring.c
src/components/tl/cuda/allgatherv/allgatherv.c
src/components/tl/cuda/allgatherv/allgatherv.h
src/components/tl/cuda/allgatherv/allgatherv_linear.c
src/components/tl/cuda/allgatherv/allgatherv_ring.c
src/components/tl/cuda/allreduce/allreduce.c
src/components/tl/cuda/allreduce/allreduce.h
src/components/tl/cuda/allreduce/allreduce_nvls.c
src/components/tl/cuda/alltoall/alltoall.c
src/components/tl/cuda/alltoall/alltoall.h
src/components/tl/cuda/alltoall/alltoall_ce.c
src/components/tl/cuda/alltoallv/alltoallv.c
src/components/tl/cuda/alltoallv/alltoallv.h
src/components/tl/cuda/alltoallv/alltoallv_ce.c
src/components/tl/cuda/bcast/bcast.c
src/components/tl/cuda/bcast/bcast.h
src/components/tl/cuda/bcast/bcast_linear.c
src/components/tl/cuda/kernels/allreduce_kernel.h
src/components/tl/cuda/kernels/reduce_scatter_kernel.h
src/components/tl/cuda/reduce_scatter/reduce_scatter.c
src/components/tl/cuda/reduce_scatter/reduce_scatter.h
src/components/tl/cuda/reduce_scatter/reduce_scatter_linear.c
src/components/tl/cuda/reduce_scatter/reduce_scatter_nvls.c
src/components/tl/cuda/reduce_scatter/reduce_scatter_ring.c
src/components/tl/cuda/reduce_scatterv/reduce_scatterv.c
src/components/tl/cuda/reduce_scatterv/reduce_scatterv.h
src/components/tl/cuda/reduce_scatterv/reduce_scatterv_linear.c
src/components/tl/cuda/reduce_scatterv/reduce_scatterv_ring.c
src/components/tl/cuda/tl_cuda.c
src/components/tl/cuda/tl_cuda.h
src/components/tl/cuda/tl_cuda_cache.c
src/components/tl/cuda/tl_cuda_cache.h
src/components/tl/cuda/tl_cuda_coll.c
src/components/tl/cuda/tl_cuda_coll.h
src/components/tl/cuda/tl_cuda_context.c
src/components/tl/cuda/tl_cuda_ep_hash.h
src/components/tl/cuda/tl_cuda_lib.c
src/components/tl/cuda/tl_cuda_nvls.c
src/components/tl/cuda/tl_cuda_nvls.h
src/components/tl/cuda/tl_cuda_ring.h
src/components/tl/cuda/tl_cuda_team.c
src/components/tl/cuda/tl_cuda_team_topo.c
src/components/tl/cuda/tl_cuda_team_topo.h
src/components/tl/cuda/tl_cuda_topo.c
src/components/tl/cuda/tl_cuda_topo.h
src/components/tl/mlx5/alltoall/alltoall.c
src/components/tl/mlx5/alltoall/alltoall.h
src/components/tl/mlx5/alltoall/alltoall_coll.c
src/components/tl/mlx5/alltoall/alltoall_inline.h
src/components/tl/mlx5/alltoall/alltoall_mkeys.c
src/components/tl/mlx5/alltoall/alltoall_mkeys.h
src/components/tl/mlx5/mcast/p2p/ucc_tl_mlx5_mcast_p2p.c
src/components/tl/mlx5/mcast/p2p/ucc_tl_mlx5_mcast_p2p.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_allgather.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_allgather.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_coll.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_coll.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_context.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_hca_copy.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_hca_copy.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_helper.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_helper.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_one_sided_progress.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_one_sided_progress.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_one_sided_reliability.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_one_sided_reliability.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_progress.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_progress.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_rcache.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_rcache.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_service_coll.c
src/components/tl/mlx5/mcast/tl_mlx5_mcast_service_coll.h
src/components/tl/mlx5/mcast/tl_mlx5_mcast_team.c
src/components/tl/mlx5/tl_mlx5.c
src/components/tl/mlx5/tl_mlx5.h
src/components/tl/mlx5/tl_mlx5_coll.c
src/components/tl/mlx5/tl_mlx5_coll.h
src/components/tl/mlx5/tl_mlx5_context.c
src/components/tl/mlx5/tl_mlx5_dm.c
src/components/tl/mlx5/tl_mlx5_dm.h
src/components/tl/mlx5/tl_mlx5_ib.c
src/components/tl/mlx5/tl_mlx5_ib.h
src/components/tl/mlx5/tl_mlx5_lib.c
src/components/tl/mlx5/tl_mlx5_pd.c
src/components/tl/mlx5/tl_mlx5_pd.h
src/components/tl/mlx5/tl_mlx5_rcache.c
src/components/tl/mlx5/tl_mlx5_team.c
src/components/tl/mlx5/tl_mlx5_wqe.c
src/components/tl/mlx5/tl_mlx5_wqe.h
src/components/tl/nccl/allgatherv/allgatherv.c
src/components/tl/nccl/allgatherv/allgatherv.h
src/components/tl/nccl/tl_nccl.c
src/components/tl/nccl/tl_nccl.h
src/components/tl/nccl/tl_nccl_coll.c
src/components/tl/nccl/tl_nccl_coll.h
src/components/tl/nccl/tl_nccl_context.c
src/components/tl/nccl/tl_nccl_lib.c
src/components/tl/nccl/tl_nccl_team.c
src/components/tl/rccl/allgatherv/allgatherv.c
src/components/tl/rccl/allgatherv/allgatherv.h
src/components/tl/rccl/tl_rccl.c
src/components/tl/rccl/tl_rccl.h
src/components/tl/rccl/tl_rccl_coll.c
src/components/tl/rccl/tl_rccl_coll.h
src/components/tl/rccl/tl_rccl_context.c
src/components/tl/rccl/tl_rccl_lib.c
src/components/tl/rccl/tl_rccl_team.c
src/components/tl/self/tl_self.c
src/components/tl/self/tl_self.h
src/components/tl/self/tl_self_coll.c
src/components/tl/self/tl_self_context.c
src/components/tl/self/tl_self_lib.c
src/components/tl/self/tl_self_team.c
src/components/tl/sharp/tl_sharp.c
src/components/tl/sharp/tl_sharp.h
src/components/tl/sharp/tl_sharp_coll.c
src/components/tl/sharp/tl_sharp_coll.h
src/components/tl/sharp/tl_sharp_context.c
src/components/tl/sharp/tl_sharp_lib.c
src/components/tl/sharp/tl_sharp_team.c
src/components/tl/ucc_tl.c
src/components/tl/ucc_tl.h
src/components/tl/ucc_tl_log.h
src/components/tl/ucp/allgather/allgather.c
src/components/tl/ucp/allgather/allgather.h
src/components/tl/ucp/allgather/allgather_bruck.c
src/components/tl/ucp/allgather/allgather_knomial.c
src/components/tl/ucp/allgather/allgather_linear.c
src/components/tl/ucp/allgather/allgather_neighbor.c
src/components/tl/ucp/allgather/allgather_ring.c
src/components/tl/ucp/allgather/allgather_sparbit.c
src/components/tl/ucp/allgatherv/allgatherv.c
src/components/tl/ucp/allgatherv/allgatherv.h
src/components/tl/ucp/allgatherv/allgatherv_knomial.c
src/components/tl/ucp/allgatherv/allgatherv_ring.c
src/components/tl/ucp/allreduce/allreduce.c
src/components/tl/ucp/allreduce/allreduce.h
src/components/tl/ucp/allreduce/allreduce_dbt.c
src/components/tl/ucp/allreduce/allreduce_knomial.c
src/components/tl/ucp/allreduce/allreduce_sliding_window.c
src/components/tl/ucp/allreduce/allreduce_sliding_window.h
src/components/tl/ucp/allreduce/allreduce_sliding_window_setup.c
src/components/tl/ucp/allreduce/allreduce_sra_knomial.c
src/components/tl/ucp/alltoall/alltoall.c
src/components/tl/ucp/alltoall/alltoall.h
src/components/tl/ucp/alltoall/alltoall_bruck.c
src/components/tl/ucp/alltoall/alltoall_onesided.c
src/components/tl/ucp/alltoall/alltoall_pairwise.c
src/components/tl/ucp/alltoallv/alltoallv.c
src/components/tl/ucp/alltoallv/alltoallv.h
src/components/tl/ucp/alltoallv/alltoallv_hybrid.c
src/components/tl/ucp/alltoallv/alltoallv_onesided.c
src/components/tl/ucp/alltoallv/alltoallv_pairwise.c
src/components/tl/ucp/barrier/barrier.c
src/components/tl/ucp/barrier/barrier.h
src/components/tl/ucp/barrier/barrier_knomial.c
src/components/tl/ucp/bcast/bcast.c
src/components/tl/ucp/bcast/bcast.h
src/components/tl/ucp/bcast/bcast_dbt.c
src/components/tl/ucp/bcast/bcast_knomial.c
src/components/tl/ucp/bcast/bcast_sag_knomial.c
src/components/tl/ucp/coll_plugins/example/example.c
src/components/tl/ucp/fanin/fanin.c
src/components/tl/ucp/fanin/fanin.h
src/components/tl/ucp/fanout/fanout.c
src/components/tl/ucp/fanout/fanout.h
src/components/tl/ucp/gather/gather.c
src/components/tl/ucp/gather/gather.h
src/components/tl/ucp/gather/gather_knomial.c
src/components/tl/ucp/gatherv/gatherv.c
src/components/tl/ucp/gatherv/gatherv.h
src/components/tl/ucp/gatherv/gatherv_linear.c
src/components/tl/ucp/reduce/reduce.c
src/components/tl/ucp/reduce/reduce.h
src/components/tl/ucp/reduce/reduce_dbt.c
src/components/tl/ucp/reduce/reduce_knomial.c
src/components/tl/ucp/reduce/reduce_srg_knomial.c
src/components/tl/ucp/reduce_scatter/reduce_scatter.c
src/components/tl/ucp/reduce_scatter/reduce_scatter.h
src/components/tl/ucp/reduce_scatter/reduce_scatter_knomial.c
src/components/tl/ucp/reduce_scatter/reduce_scatter_ring.c
src/components/tl/ucp/reduce_scatterv/reduce_scatterv.c
src/components/tl/ucp/reduce_scatterv/reduce_scatterv.h
src/components/tl/ucp/reduce_scatterv/reduce_scatterv_ring.c
src/components/tl/ucp/scatter/scatter.h
src/components/tl/ucp/scatter/scatter_knomial.c
src/components/tl/ucp/scatterv/scatterv.c
src/components/tl/ucp/scatterv/scatterv.h
src/components/tl/ucp/scatterv/scatterv_linear.c
src/components/tl/ucp/tl_ucp.c
src/components/tl/ucp/tl_ucp.h
src/components/tl/ucp/tl_ucp_coll.c
src/components/tl/ucp/tl_ucp_coll.h
src/components/tl/ucp/tl_ucp_context.c
src/components/tl/ucp/tl_ucp_copy.c
src/components/tl/ucp/tl_ucp_copy.h
src/components/tl/ucp/tl_ucp_dpu_offload.c
src/components/tl/ucp/tl_ucp_dpu_offload.h
src/components/tl/ucp/tl_ucp_ep.c
src/components/tl/ucp/tl_ucp_ep.h
src/components/tl/ucp/tl_ucp_ep_hash.h
src/components/tl/ucp/tl_ucp_lib.c
src/components/tl/ucp/tl_ucp_reduce.h
src/components/tl/ucp/tl_ucp_sendrecv.h
src/components/tl/ucp/tl_ucp_service_coll.c
src/components/tl/ucp/tl_ucp_tag.h
src/components/tl/ucp/tl_ucp_team.c
src/components/topo/ucc_sbgp.c
src/components/topo/ucc_sbgp.h
src/components/topo/ucc_topo.c
src/components/topo/ucc_topo.h
src/core/ucc_coll.c
src/core/ucc_constructor.c
src/core/ucc_context.c
src/core/ucc_context.h
src/core/ucc_dt.c
src/core/ucc_dt.h
src/core/ucc_ee.c
src/core/ucc_ee.h
src/core/ucc_global_opts.c
src/core/ucc_global_opts.h
src/core/ucc_lib.c
src/core/ucc_lib.h
src/core/ucc_progress_queue.c
src/core/ucc_progress_queue.h
src/core/ucc_progress_queue_mt.c
src/core/ucc_progress_queue_st.c
src/core/ucc_service_coll.c
src/core/ucc_service_coll.h
src/core/ucc_team.c
src/core/ucc_team.h
src/schedule/ucc_schedule.c
src/schedule/ucc_schedule.h
src/schedule/ucc_schedule_pipelined.c
src/schedule/ucc_schedule_pipelined.h
src/ucc/api/ucc.h
src/ucc/api/ucc_def.h
src/ucc/api/ucc_status.h
src/utils/arch/aarch64/cpu.c
src/utils/arch/aarch64/cpu.h
src/utils/arch/cpu.h
src/utils/arch/cuda_def.h
src/utils/arch/ppc64/cpu.h
src/utils/arch/riscv64/cpu.h
src/utils/arch/rocm_def.h
src/utils/arch/x86_64/cpu.c
src/utils/arch/x86_64/cpu.h
src/utils/ini.c
src/utils/ini.h
src/utils/khash.h
src/utils/profile/ucc_profile.c
src/utils/profile/ucc_profile.h
src/utils/profile/ucc_profile_core.h
src/utils/profile/ucc_profile_off.h
src/utils/profile/ucc_profile_on.h
src/utils/ucc_assert.c
src/utils/ucc_assert.h
src/utils/ucc_atomic.h
src/utils/ucc_class.h
src/utils/ucc_coll_utils.c
src/utils/ucc_coll_utils.h
src/utils/ucc_compiler_def.h
src/utils/ucc_component.c
src/utils/ucc_component.h
src/utils/ucc_datastruct.c
src/utils/ucc_datastruct.h
src/utils/ucc_dt_reduce.h
src/utils/ucc_list.h
src/utils/ucc_lock_free_queue.h
src/utils/ucc_log.h
src/utils/ucc_malloc.h
src/utils/ucc_math.c
src/utils/ucc_math.h
src/utils/ucc_math_op.h
src/utils/ucc_mpool.c
src/utils/ucc_mpool.h
src/utils/ucc_parser.c
src/utils/ucc_parser.h
src/utils/ucc_proc_info.c
src/utils/ucc_proc_info.h
src/utils/ucc_queue.h
src/utils/ucc_rcache.h
src/utils/ucc_spinlock.h
src/utils/ucc_status.c
src/utils/ucc_string.c
src/utils/ucc_string.h
src/utils/ucc_sys.c
src/utils/ucc_sys.h
src/utils/ucc_time.h
test/cmake/main.cpp
test/gtest/active_set/test_active_set.cc
test/gtest/asym_mem/test_asymmetric_memory.cc
test/gtest/coll/test_allgather.cc
test/gtest/coll/test_allgatherv.cc
test/gtest/coll/test_allreduce.cc
test/gtest/coll/test_allreduce_sliding_window.cc
test/gtest/coll/test_allreduce_sliding_window.h
test/gtest/coll/test_alltoall.cc
test/gtest/coll/test_alltoallv.cc
test/gtest/coll/test_barrier.cc
test/gtest/coll/test_bcast.cc
test/gtest/coll/test_gather.cc
test/gtest/coll/test_gatherv.cc
test/gtest/coll/test_reduce.cc
test/gtest/coll/test_reduce_scatter.cc
test/gtest/coll/test_reduce_scatterv.cc
test/gtest/coll/test_scatter.cc
test/gtest/coll/test_scatterv.cc
test/gtest/coll_score/test_score.cc
test/gtest/coll_score/test_score.h
test/gtest/coll_score/test_score_str.cc
test/gtest/coll_score/test_score_update.cc
test/gtest/coll_score/test_update_score.cc
test/gtest/common/gtest-all.cc
test/gtest/common/gtest.h
test/gtest/common/main.cc
test/gtest/common/test.h
test/gtest/common/test_obj_size.cc
test/gtest/common/test_ucc.cc
test/gtest/common/test_ucc.h
test/gtest/core/test_context.cc
test/gtest/core/test_context.h
test/gtest/core/test_context_config.cc
test/gtest/core/test_ec_cuda.cc
test/gtest/core/test_lib.cc
test/gtest/core/test_lib_config.cc
test/gtest/core/test_mc.cc
test/gtest/core/test_mc_cuda.cc
test/gtest/core/test_mc_reduce.cc
test/gtest/core/test_mc_reduce.h
test/gtest/core/test_mc_rocm.cc
test/gtest/core/test_schedule.cc
test/gtest/core/test_service_coll.cc
test/gtest/core/test_team.cc
test/gtest/core/test_timeout.cc
test/gtest/core/test_topo.cc
test/gtest/core/test_utils.cc
test/gtest/tl/mlx5/test_tl_mlx5.cc
test/gtest/tl/mlx5/test_tl_mlx5.h
test/gtest/tl/mlx5/test_tl_mlx5_qps.cc
test/gtest/tl/mlx5/test_tl_mlx5_qps.h
test/gtest/tl/mlx5/test_tl_mlx5_wqe.cc
test/gtest/tl/mlx5/test_tl_mlx5_wqe.h
test/gtest/tl/tl_test.cc
test/gtest/utils/test_cfg_file.cc
test/gtest/utils/test_ep_map.cc
test/gtest/utils/test_lock_free_queue.cc
test/gtest/utils/test_math.cc
test/gtest/utils/test_parser.cc
test/gtest/utils/test_string.cc
test/mpi/buffer.cc
test/mpi/main.cc
test/mpi/mpi_util.cc
test/mpi/mpi_util.h
test/mpi/test_allgather.cc
test/mpi/test_allgatherv.cc
test/mpi/test_allreduce.cc
test/mpi/test_alltoall.cc
test/mpi/test_alltoallv.cc
test/mpi/test_barrier.cc
test/mpi/test_bcast.cc
test/mpi/test_case.cc
test/mpi/test_gather.cc
test/mpi/test_gatherv.cc
test/mpi/test_mpi.cc
test/mpi/test_mpi.h
test/mpi/test_reduce.cc
test/mpi/test_reduce_scatter.cc
test/mpi/test_reduce_scatterv.cc
test/mpi/test_scatter.cc
test/mpi/test_scatterv.cc
tools/info/build_info.c
tools/info/ucc_info.c
tools/info/ucc_info.h
tools/perf/generator/ucc_pt_generator.h
tools/perf/generator/ucc_pt_generator_exp.cc
tools/perf/generator/ucc_pt_generator_file.cc
tools/perf/ucc_perftest.cc
tools/perf/ucc_perftest.h
tools/perf/ucc_pt_benchmark.cc
tools/perf/ucc_pt_benchmark.h
tools/perf/ucc_pt_bootstrap.h
tools/perf/ucc_pt_bootstrap_mpi.cc
tools/perf/ucc_pt_bootstrap_mpi.h
tools/perf/ucc_pt_coll.cc
tools/perf/ucc_pt_coll.h
tools/perf/ucc_pt_coll_allgather.cc
tools/perf/ucc_pt_coll_allgatherv.cc
tools/perf/ucc_pt_coll_allreduce.cc
tools/perf/ucc_pt_coll_alltoall.cc
tools/perf/ucc_pt_coll_alltoallv.cc
tools/perf/ucc_pt_coll_barrier.cc
tools/perf/ucc_pt_coll_bcast.cc
tools/perf/ucc_pt_coll_gather.cc
tools/perf/ucc_pt_coll_gatherv.cc
tools/perf/ucc_pt_coll_reduce.cc
tools/perf/ucc_pt_coll_reduce_scatter.cc
tools/perf/ucc_pt_coll_reduce_scatterv.cc
tools/perf/ucc_pt_coll_scatter.cc
tools/perf/ucc_pt_coll_scatterv.cc
tools/perf/ucc_pt_comm.cc
tools/perf/ucc_pt_comm.h
tools/perf/ucc_pt_config.cc
tools/perf/ucc_pt_config.h
tools/perf/ucc_pt_cuda.cc
tools/perf/ucc_pt_cuda.h
tools/perf/ucc_pt_op_memcpy.cc
tools/perf/ucc_pt_op_reduce.cc
tools/perf/ucc_pt_op_reduce_strided.cc
tools/perf/ucc_pt_rocm.cc
tools/perf/ucc_pt_rocm.h
